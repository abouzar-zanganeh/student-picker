(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))l(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&l(r)}).observe(document,{childList:!0,subtree:!0});function e(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function l(a){if(a.ep)return;a.ep=!0;const n=e(a);fetch(a.href,n)}})();const Ra={ili:{id:"ili",label:"کانون زبان ایران",levels:["Primer 1","Primer 2","Step Up 1","Step Up 2","Step Up 3","Step Up 4","Move Up 1","Move Up 2","Move Up 3","Move Up 4","Jump Up 1","Jump Up 2","Jump Up 3","Jump Up 4","Start 1","Run 1","Run 2","Run 3","Run 4","Race 1","Race 2","Race 3","Reach 1","Reach 2","Reach 3","Reach 4","Basic 1","Basic 2","Basic 3","Elementary 1","Elementary 2","Elementary 3","Pre-intermediate 1","Pre-intermediate 2","Pre-intermediate 3","Intermediate 1","Intermediate 2","Intermediate 3","High-intermediate 1","High-intermediate 2","High-intermediate 3","Advanced 1","Advanced 2","Advanced 3"]},school:{id:"school",label:"آموزش و پرورش",levels:["کلاس اول","کلاس دوم","کلاس سوم","کلاس چهارم","کلاس پنجم","کلاس ششم","کلاس هفتم","کلاس هشتم","کلاس نهم","کلاس دهم","کلاس یازدهم","کلاس دوازدهم"]},custom:{id:"custom",label:"سایر / آزاد",levels:[]}};class Bn{constructor(i){this.identity={name:i.name,firstName:i.firstName||null,lastName:i.lastName||null,studentId:i.studentId||`id_${new Date().getTime()}_${Math.random()}`,branchName:i.branchName||null,ageGroup:i.ageGroup||"adult",level:i.level||null,contact:{social:i.socialContact||null,parent:i.parentContact||null}},this.isDeleted=!1,this.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0,outOfClassCount:0},this.categoryCounts={},this.categoryIssues={},this.qualitativeStats={},this.logs={parentContacts:[],scores:{},discipline:{},sessionHistory:{}},this.profile={notes:[],tags:[]},this.finalClassActivityScore=null,this.onboardingSession=null}addScore(i,e,l){if(e>100||e<0){console.log("نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}const a=i.toLowerCase();this.logs.scores[a]||(this.logs.scores[a]=[]);const n=new cr(i,e,l);this.logs.scores[a].push(n)}addNote(i,e=null){const l=new lr(i,e);this.profile.notes.push(l)}getOverallAverageScore(){let i=0,e=0;for(const a in this.logs.scores)this.logs.scores[a].forEach(n=>{n.isDeleted||(i+=n.value,e++)});if(e===0)return null;const l=i/e;return Math.trunc(l*10)/10}}class cr{constructor(i,e,l=""){this.id=`score_${new Date().getTime()}`,this.skill=i,this.value=e,this.timestamp=new Date,this.comment=l,this.isDeleted=!1}}class lr{constructor(i,e=null){this.id=`note_${new Date().getTime()}`,this.timestamp=new Date,this.content=i,this.isDeleted=!1,this.source=e}}class xs{constructor(i="complete",e=""){this.status=i,this.comment=e,this.timestamp=new Date}}class Ua{constructor(i){this.sessionNumber=i,this.startTime=new Date,this.createdAt=new Date,this.note="",this.isDeleted=!1,this.endTime=null,this.isFinished=!1,this.isMakeup=!1,this.isCancelled=!1,this.studentRecords={},this.lastWinnerByCategory={},this.lastUsedCategoryId=null,this.lastSelectedWinnerId=null,this.winnerHistory=[]}end(){this.isFinished=!0,this.endTime=new Date}markAsMakeup(){this.isMakeup=!this.isMakeup}initializeStudentRecord(i){this.studentRecords[i]||(this.studentRecords[i]={attendance:"present",homework:new xs,selections:{},hadIssue:!1,wasOutOfClass:!1,performanceRatings:{}})}setAttendance(i,e){this.initializeStudentRecord(i),this.studentRecords[i].attendance=e}setHomeworkStatus(i,e){this.initializeStudentRecord(i),this.studentRecords[i].homework.status=e}selectNextWinner(i,e,l){if(!e||e.length===0)return console.log("هیچ دانش‌آموزی در کلاس برای انتخاب وجود ندارد."),null;const a=this.lastWinnerByCategory[i];let n=e.filter(u=>u.identity.studentId!==a&&!u.isDeleted);if(n.length===0&&(n=e),n.length===0)return null;const r=(u,h)=>u.categoryCounts[h]||0,s=Math.min(...n.map(u=>r(u,i))),o=n.filter(u=>r(u,i)===s);let c;if(o.length===1)c=o[0];else if(o.length>1){const u=l.filter(v=>!v.isDeleted&&v.name!==i).map(v=>v.name),h=o.map(v=>{const b=u.reduce((C,E)=>C+r(v,E),0);return{student:v,otherCategoriesTotal:b}}),y=Math.min(...h.map(v=>v.otherCategoriesTotal)),f=h.filter(v=>v.otherCategoriesTotal===y).map(v=>v.student);f.length===1?c=f[0]:c=f[Math.floor(Math.random()*f.length)]}else c=n[Math.floor(Math.random()*n.length)];const m=c.identity.studentId;this.initializeStudentRecord(m);const p=(this.studentRecords[m].selections[i]||0)+1;return this.studentRecords[m].selections[i]=p,c.statusCounters.totalSelections++,c.categoryCounts[i]=(c.categoryCounts[i]||0)+1,this.lastWinnerByCategory[i]=m,c}}class Ls{constructor(i){this.info={name:i.name||"NotNamed",teacherName:i.teacherName||null,type:i.type||"in-person",educationalSystem:i.educationalSystem||"custom",term:i.term||null,scheduleText:i.scheduleText||null,level:i.level||null,creationDate:i.creationDate?new Date(i.creationDate):new Date,scheduleCode:i.scheduleCode||`code_${new Date().getTime()}`,scheduleDays:i.scheduleDays||[],scheduleStartTime:i.scheduleStartTime||null,scheduleEndTime:i.scheduleEndTime||null},this.students=[],this.sessions=[],this.note="",this.isDeleted=!1,this.categories=[new yt("Vocabulary","Questions about words and meanings."),new yt("Grammar","Questions about sentence structure and rules."),new yt("Listening",void 0,!0),new yt("Speaking",void 0,!0),new yt("Reading",void 0,!0),new yt("Writing",void 0,!0)],this.futurePlans={}}addStudent(i){this.students.push(i)}startNewSession(){const e=this.sessions.reduce((a,n)=>Math.max(a,n.sessionNumber),0)+1,l=new Ua(e);return this.sessions.push(l),l}endSpecificSession(i){const e=this.getSession(i);return e&&!e.isFinished?(e.end(),!0):!1}getSession(i){return this.sessions.find(e=>e.sessionNumber===i)}markAsMakeup(i){const e=this.getSession(i);e&&e.markAsMakeup()}planForSession(i,e){this.futurePlans[i]=e}hasSessionToday(){const i=new Date().toDateString();return this.sessions.some(e=>!e.isDeleted&&e.startTime.toDateString()===i)}selectNextWinner(i,e){return e?e.selectNextWinner(i,this.students,this.categories):null}get liveSession(){for(let i=this.sessions.length-1;i>=0;i--)if(!this.sessions[i].isFinished)return this.sessions[i];return null}calculateFinalStudentScore(i){var r;const e=this.categories.filter(s=>s.isGradedCategory&&!s.isDeleted);if(e.length===0)return null;let l=0,a=0;for(const s of e){const o=s.name.toLowerCase(),c=((r=i.logs.scores[o])==null?void 0:r.filter(p=>!p.isDeleted))||[];if(c.length===0)return null;const m=c.reduce((p,u)=>p+u.value,0)/c.length;l+=m*(s.weight||1),a+=s.weight||1}if(a===0)return null;const n=l/a;return Math.trunc(n*10)/10}}class yt{constructor(i,e="",l=!1,a=1){this.id=`cat_${new Date().getTime()}_${Math.random()}`,this.name=i,this.description=e,this.isDeleted=!1,this.isGradedCategory=l,this.weight=a,this.isDeleted=!1}}var Ln=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ja(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function Tn(t){throw new Error('Could not dynamically require "'+t+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var qa={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/(function(t,i){(function(e){t.exports=e()})(function(){return function e(l,a,n){function r(c,m){if(!a[c]){if(!l[c]){var p=typeof Tn=="function"&&Tn;if(!m&&p)return p(c,!0);if(s)return s(c,!0);var u=new Error("Cannot find module '"+c+"'");throw u.code="MODULE_NOT_FOUND",u}var h=a[c]={exports:{}};l[c][0].call(h.exports,function(y){var f=l[c][1][y];return r(f||y)},h,h.exports,e,l,a,n)}return a[c].exports}for(var s=typeof Tn=="function"&&Tn,o=0;o<n.length;o++)r(n[o]);return r}({1:[function(e,l,a){var n=e("./utils"),r=e("./support"),s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";a.encode=function(o){for(var c,m,p,u,h,y,f,v=[],b=0,C=o.length,E=C,k=n.getTypeOf(o)!=="string";b<o.length;)E=C-b,p=k?(c=o[b++],m=b<C?o[b++]:0,b<C?o[b++]:0):(c=o.charCodeAt(b++),m=b<C?o.charCodeAt(b++):0,b<C?o.charCodeAt(b++):0),u=c>>2,h=(3&c)<<4|m>>4,y=1<E?(15&m)<<2|p>>6:64,f=2<E?63&p:64,v.push(s.charAt(u)+s.charAt(h)+s.charAt(y)+s.charAt(f));return v.join("")},a.decode=function(o){var c,m,p,u,h,y,f=0,v=0,b="data:";if(o.substr(0,b.length)===b)throw new Error("Invalid base64 input, it looks like a data url.");var C,E=3*(o=o.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(o.charAt(o.length-1)===s.charAt(64)&&E--,o.charAt(o.length-2)===s.charAt(64)&&E--,E%1!=0)throw new Error("Invalid base64 input, bad content length.");for(C=r.uint8array?new Uint8Array(0|E):new Array(0|E);f<o.length;)c=s.indexOf(o.charAt(f++))<<2|(u=s.indexOf(o.charAt(f++)))>>4,m=(15&u)<<4|(h=s.indexOf(o.charAt(f++)))>>2,p=(3&h)<<6|(y=s.indexOf(o.charAt(f++))),C[v++]=c,h!==64&&(C[v++]=m),y!==64&&(C[v++]=p);return C}},{"./support":30,"./utils":32}],2:[function(e,l,a){var n=e("./external"),r=e("./stream/DataWorker"),s=e("./stream/Crc32Probe"),o=e("./stream/DataLengthProbe");function c(m,p,u,h,y){this.compressedSize=m,this.uncompressedSize=p,this.crc32=u,this.compression=h,this.compressedContent=y}c.prototype={getContentWorker:function(){var m=new r(n.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new o("data_length")),p=this;return m.on("end",function(){if(this.streamInfo.data_length!==p.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),m},getCompressedWorker:function(){return new r(n.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},c.createWorkerFrom=function(m,p,u){return m.pipe(new s).pipe(new o("uncompressedSize")).pipe(p.compressWorker(u)).pipe(new o("compressedSize")).withStreamInfo("compression",p)},l.exports=c},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,l,a){var n=e("./stream/GenericWorker");a.STORE={magic:"\0\0",compressWorker:function(){return new n("STORE compression")},uncompressWorker:function(){return new n("STORE decompression")}},a.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,l,a){var n=e("./utils"),r=function(){for(var s,o=[],c=0;c<256;c++){s=c;for(var m=0;m<8;m++)s=1&s?3988292384^s>>>1:s>>>1;o[c]=s}return o}();l.exports=function(s,o){return s!==void 0&&s.length?n.getTypeOf(s)!=="string"?function(c,m,p,u){var h=r,y=u+p;c^=-1;for(var f=u;f<y;f++)c=c>>>8^h[255&(c^m[f])];return-1^c}(0|o,s,s.length,0):function(c,m,p,u){var h=r,y=u+p;c^=-1;for(var f=u;f<y;f++)c=c>>>8^h[255&(c^m.charCodeAt(f))];return-1^c}(0|o,s,s.length,0):0}},{"./utils":32}],5:[function(e,l,a){a.base64=!1,a.binary=!1,a.dir=!1,a.createFolders=!0,a.date=null,a.compression=null,a.compressionOptions=null,a.comment=null,a.unixPermissions=null,a.dosPermissions=null},{}],6:[function(e,l,a){var n=null;n=typeof Promise<"u"?Promise:e("lie"),l.exports={Promise:n}},{lie:37}],7:[function(e,l,a){var n=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",r=e("pako"),s=e("./utils"),o=e("./stream/GenericWorker"),c=n?"uint8array":"array";function m(p,u){o.call(this,"FlateWorker/"+p),this._pako=null,this._pakoAction=p,this._pakoOptions=u,this.meta={}}a.magic="\b\0",s.inherits(m,o),m.prototype.processChunk=function(p){this.meta=p.meta,this._pako===null&&this._createPako(),this._pako.push(s.transformTo(c,p.data),!1)},m.prototype.flush=function(){o.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},m.prototype.cleanUp=function(){o.prototype.cleanUp.call(this),this._pako=null},m.prototype._createPako=function(){this._pako=new r[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var p=this;this._pako.onData=function(u){p.push({data:u,meta:p.meta})}},a.compressWorker=function(p){return new m("Deflate",p)},a.uncompressWorker=function(){return new m("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(e,l,a){function n(h,y){var f,v="";for(f=0;f<y;f++)v+=String.fromCharCode(255&h),h>>>=8;return v}function r(h,y,f,v,b,C){var E,k,_=h.file,x=h.compression,L=C!==c.utf8encode,N=s.transformTo("string",C(_.name)),R=s.transformTo("string",c.utf8encode(_.name)),U=_.comment,ee=s.transformTo("string",C(U)),I=s.transformTo("string",c.utf8encode(U)),$=R.length!==_.name.length,g=I.length!==U.length,W="",fe="",q="",me=_.dir,P=_.date,se={crc32:0,compressedSize:0,uncompressedSize:0};y&&!f||(se.crc32=h.crc32,se.compressedSize=h.compressedSize,se.uncompressedSize=h.uncompressedSize);var O=0;y&&(O|=8),L||!$&&!g||(O|=2048);var M=0,le=0;me&&(M|=16),b==="UNIX"?(le=798,M|=function(Q,Le){var Oe=Q;return Q||(Oe=Le?16893:33204),(65535&Oe)<<16}(_.unixPermissions,me)):(le=20,M|=function(Q){return 63&(Q||0)}(_.dosPermissions)),E=P.getUTCHours(),E<<=6,E|=P.getUTCMinutes(),E<<=5,E|=P.getUTCSeconds()/2,k=P.getUTCFullYear()-1980,k<<=4,k|=P.getUTCMonth()+1,k<<=5,k|=P.getUTCDate(),$&&(fe=n(1,1)+n(m(N),4)+R,W+="up"+n(fe.length,2)+fe),g&&(q=n(1,1)+n(m(ee),4)+I,W+="uc"+n(q.length,2)+q);var te="";return te+=`
\0`,te+=n(O,2),te+=x.magic,te+=n(E,2),te+=n(k,2),te+=n(se.crc32,4),te+=n(se.compressedSize,4),te+=n(se.uncompressedSize,4),te+=n(N.length,2),te+=n(W.length,2),{fileRecord:p.LOCAL_FILE_HEADER+te+N+W,dirRecord:p.CENTRAL_FILE_HEADER+n(le,2)+te+n(ee.length,2)+"\0\0\0\0"+n(M,4)+n(v,4)+N+W+ee}}var s=e("../utils"),o=e("../stream/GenericWorker"),c=e("../utf8"),m=e("../crc32"),p=e("../signature");function u(h,y,f,v){o.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=y,this.zipPlatform=f,this.encodeFileName=v,this.streamFiles=h,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}s.inherits(u,o),u.prototype.push=function(h){var y=h.meta.percent||0,f=this.entriesCount,v=this._sources.length;this.accumulate?this.contentBuffer.push(h):(this.bytesWritten+=h.data.length,o.prototype.push.call(this,{data:h.data,meta:{currentFile:this.currentFile,percent:f?(y+100*(f-v-1))/f:100}}))},u.prototype.openedSource=function(h){this.currentSourceOffset=this.bytesWritten,this.currentFile=h.file.name;var y=this.streamFiles&&!h.file.dir;if(y){var f=r(h,y,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:f.fileRecord,meta:{percent:0}})}else this.accumulate=!0},u.prototype.closedSource=function(h){this.accumulate=!1;var y=this.streamFiles&&!h.file.dir,f=r(h,y,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(f.dirRecord),y)this.push({data:function(v){return p.DATA_DESCRIPTOR+n(v.crc32,4)+n(v.compressedSize,4)+n(v.uncompressedSize,4)}(h),meta:{percent:100}});else for(this.push({data:f.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},u.prototype.flush=function(){for(var h=this.bytesWritten,y=0;y<this.dirRecords.length;y++)this.push({data:this.dirRecords[y],meta:{percent:100}});var f=this.bytesWritten-h,v=function(b,C,E,k,_){var x=s.transformTo("string",_(k));return p.CENTRAL_DIRECTORY_END+"\0\0\0\0"+n(b,2)+n(b,2)+n(C,4)+n(E,4)+n(x.length,2)+x}(this.dirRecords.length,f,h,this.zipComment,this.encodeFileName);this.push({data:v,meta:{percent:100}})},u.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},u.prototype.registerPrevious=function(h){this._sources.push(h);var y=this;return h.on("data",function(f){y.processChunk(f)}),h.on("end",function(){y.closedSource(y.previous.streamInfo),y._sources.length?y.prepareNextSource():y.end()}),h.on("error",function(f){y.error(f)}),this},u.prototype.resume=function(){return!!o.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},u.prototype.error=function(h){var y=this._sources;if(!o.prototype.error.call(this,h))return!1;for(var f=0;f<y.length;f++)try{y[f].error(h)}catch{}return!0},u.prototype.lock=function(){o.prototype.lock.call(this);for(var h=this._sources,y=0;y<h.length;y++)h[y].lock()},l.exports=u},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,l,a){var n=e("../compressions"),r=e("./ZipFileWorker");a.generateWorker=function(s,o,c){var m=new r(o.streamFiles,c,o.platform,o.encodeFileName),p=0;try{s.forEach(function(u,h){p++;var y=function(C,E){var k=C||E,_=n[k];if(!_)throw new Error(k+" is not a valid compression method !");return _}(h.options.compression,o.compression),f=h.options.compressionOptions||o.compressionOptions||{},v=h.dir,b=h.date;h._compressWorker(y,f).withStreamInfo("file",{name:u,dir:v,date:b,comment:h.comment||"",unixPermissions:h.unixPermissions,dosPermissions:h.dosPermissions}).pipe(m)}),m.entriesCount=p}catch(u){m.error(u)}return m}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,l,a){function n(){if(!(this instanceof n))return new n;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var r=new n;for(var s in this)typeof this[s]!="function"&&(r[s]=this[s]);return r}}(n.prototype=e("./object")).loadAsync=e("./load"),n.support=e("./support"),n.defaults=e("./defaults"),n.version="3.10.1",n.loadAsync=function(r,s){return new n().loadAsync(r,s)},n.external=e("./external"),l.exports=n},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,l,a){var n=e("./utils"),r=e("./external"),s=e("./utf8"),o=e("./zipEntries"),c=e("./stream/Crc32Probe"),m=e("./nodejsUtils");function p(u){return new r.Promise(function(h,y){var f=u.decompressed.getContentWorker().pipe(new c);f.on("error",function(v){y(v)}).on("end",function(){f.streamInfo.crc32!==u.decompressed.crc32?y(new Error("Corrupted zip : CRC32 mismatch")):h()}).resume()})}l.exports=function(u,h){var y=this;return h=n.extend(h||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:s.utf8decode}),m.isNode&&m.isStream(u)?r.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):n.prepareContent("the loaded zip file",u,!0,h.optimizedBinaryString,h.base64).then(function(f){var v=new o(h);return v.load(f),v}).then(function(f){var v=[r.Promise.resolve(f)],b=f.files;if(h.checkCRC32)for(var C=0;C<b.length;C++)v.push(p(b[C]));return r.Promise.all(v)}).then(function(f){for(var v=f.shift(),b=v.files,C=0;C<b.length;C++){var E=b[C],k=E.fileNameStr,_=n.resolve(E.fileNameStr);y.file(_,E.decompressed,{binary:!0,optimizedBinaryString:!0,date:E.date,dir:E.dir,comment:E.fileCommentStr.length?E.fileCommentStr:null,unixPermissions:E.unixPermissions,dosPermissions:E.dosPermissions,createFolders:h.createFolders}),E.dir||(y.file(_).unsafeOriginalName=k)}return v.zipComment.length&&(y.comment=v.zipComment),y})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,l,a){var n=e("../utils"),r=e("../stream/GenericWorker");function s(o,c){r.call(this,"Nodejs stream input adapter for "+o),this._upstreamEnded=!1,this._bindStream(c)}n.inherits(s,r),s.prototype._bindStream=function(o){var c=this;(this._stream=o).pause(),o.on("data",function(m){c.push({data:m,meta:{percent:0}})}).on("error",function(m){c.isPaused?this.generatedError=m:c.error(m)}).on("end",function(){c.isPaused?c._upstreamEnded=!0:c.end()})},s.prototype.pause=function(){return!!r.prototype.pause.call(this)&&(this._stream.pause(),!0)},s.prototype.resume=function(){return!!r.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},l.exports=s},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,l,a){var n=e("readable-stream").Readable;function r(s,o,c){n.call(this,o),this._helper=s;var m=this;s.on("data",function(p,u){m.push(p)||m._helper.pause(),c&&c(u)}).on("error",function(p){m.emit("error",p)}).on("end",function(){m.push(null)})}e("../utils").inherits(r,n),r.prototype._read=function(){this._helper.resume()},l.exports=r},{"../utils":32,"readable-stream":16}],14:[function(e,l,a){l.exports={isNode:typeof Buffer<"u",newBufferFrom:function(n,r){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(n,r);if(typeof n=="number")throw new Error('The "data" argument must not be a number');return new Buffer(n,r)},allocBuffer:function(n){if(Buffer.alloc)return Buffer.alloc(n);var r=new Buffer(n);return r.fill(0),r},isBuffer:function(n){return Buffer.isBuffer(n)},isStream:function(n){return n&&typeof n.on=="function"&&typeof n.pause=="function"&&typeof n.resume=="function"}}},{}],15:[function(e,l,a){function n(_,x,L){var N,R=s.getTypeOf(x),U=s.extend(L||{},m);U.date=U.date||new Date,U.compression!==null&&(U.compression=U.compression.toUpperCase()),typeof U.unixPermissions=="string"&&(U.unixPermissions=parseInt(U.unixPermissions,8)),U.unixPermissions&&16384&U.unixPermissions&&(U.dir=!0),U.dosPermissions&&16&U.dosPermissions&&(U.dir=!0),U.dir&&(_=b(_)),U.createFolders&&(N=v(_))&&C.call(this,N,!0);var ee=R==="string"&&U.binary===!1&&U.base64===!1;L&&L.binary!==void 0||(U.binary=!ee),(x instanceof p&&x.uncompressedSize===0||U.dir||!x||x.length===0)&&(U.base64=!1,U.binary=!0,x="",U.compression="STORE",R="string");var I=null;I=x instanceof p||x instanceof o?x:y.isNode&&y.isStream(x)?new f(_,x):s.prepareContent(_,x,U.binary,U.optimizedBinaryString,U.base64);var $=new u(_,I,U);this.files[_]=$}var r=e("./utf8"),s=e("./utils"),o=e("./stream/GenericWorker"),c=e("./stream/StreamHelper"),m=e("./defaults"),p=e("./compressedObject"),u=e("./zipObject"),h=e("./generate"),y=e("./nodejsUtils"),f=e("./nodejs/NodejsStreamInputAdapter"),v=function(_){_.slice(-1)==="/"&&(_=_.substring(0,_.length-1));var x=_.lastIndexOf("/");return 0<x?_.substring(0,x):""},b=function(_){return _.slice(-1)!=="/"&&(_+="/"),_},C=function(_,x){return x=x!==void 0?x:m.createFolders,_=b(_),this.files[_]||n.call(this,_,null,{dir:!0,createFolders:x}),this.files[_]};function E(_){return Object.prototype.toString.call(_)==="[object RegExp]"}var k={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(_){var x,L,N;for(x in this.files)N=this.files[x],(L=x.slice(this.root.length,x.length))&&x.slice(0,this.root.length)===this.root&&_(L,N)},filter:function(_){var x=[];return this.forEach(function(L,N){_(L,N)&&x.push(N)}),x},file:function(_,x,L){if(arguments.length!==1)return _=this.root+_,n.call(this,_,x,L),this;if(E(_)){var N=_;return this.filter(function(U,ee){return!ee.dir&&N.test(U)})}var R=this.files[this.root+_];return R&&!R.dir?R:null},folder:function(_){if(!_)return this;if(E(_))return this.filter(function(R,U){return U.dir&&_.test(R)});var x=this.root+_,L=C.call(this,x),N=this.clone();return N.root=L.name,N},remove:function(_){_=this.root+_;var x=this.files[_];if(x||(_.slice(-1)!=="/"&&(_+="/"),x=this.files[_]),x&&!x.dir)delete this.files[_];else for(var L=this.filter(function(R,U){return U.name.slice(0,_.length)===_}),N=0;N<L.length;N++)delete this.files[L[N].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(_){var x,L={};try{if((L=s.extend(_||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:r.utf8encode})).type=L.type.toLowerCase(),L.compression=L.compression.toUpperCase(),L.type==="binarystring"&&(L.type="string"),!L.type)throw new Error("No output type specified.");s.checkSupport(L.type),L.platform!=="darwin"&&L.platform!=="freebsd"&&L.platform!=="linux"&&L.platform!=="sunos"||(L.platform="UNIX"),L.platform==="win32"&&(L.platform="DOS");var N=L.comment||this.comment||"";x=h.generateWorker(this,L,N)}catch(R){(x=new o("error")).error(R)}return new c(x,L.type||"string",L.mimeType)},generateAsync:function(_,x){return this.generateInternalStream(_).accumulate(x)},generateNodeStream:function(_,x){return(_=_||{}).type||(_.type="nodebuffer"),this.generateInternalStream(_).toNodejsStream(x)}};l.exports=k},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,l,a){l.exports=e("stream")},{stream:void 0}],17:[function(e,l,a){var n=e("./DataReader");function r(s){n.call(this,s);for(var o=0;o<this.data.length;o++)s[o]=255&s[o]}e("../utils").inherits(r,n),r.prototype.byteAt=function(s){return this.data[this.zero+s]},r.prototype.lastIndexOfSignature=function(s){for(var o=s.charCodeAt(0),c=s.charCodeAt(1),m=s.charCodeAt(2),p=s.charCodeAt(3),u=this.length-4;0<=u;--u)if(this.data[u]===o&&this.data[u+1]===c&&this.data[u+2]===m&&this.data[u+3]===p)return u-this.zero;return-1},r.prototype.readAndCheckSignature=function(s){var o=s.charCodeAt(0),c=s.charCodeAt(1),m=s.charCodeAt(2),p=s.charCodeAt(3),u=this.readData(4);return o===u[0]&&c===u[1]&&m===u[2]&&p===u[3]},r.prototype.readData=function(s){if(this.checkOffset(s),s===0)return[];var o=this.data.slice(this.zero+this.index,this.zero+this.index+s);return this.index+=s,o},l.exports=r},{"../utils":32,"./DataReader":18}],18:[function(e,l,a){var n=e("../utils");function r(s){this.data=s,this.length=s.length,this.index=0,this.zero=0}r.prototype={checkOffset:function(s){this.checkIndex(this.index+s)},checkIndex:function(s){if(this.length<this.zero+s||s<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+s+"). Corrupted zip ?")},setIndex:function(s){this.checkIndex(s),this.index=s},skip:function(s){this.setIndex(this.index+s)},byteAt:function(){},readInt:function(s){var o,c=0;for(this.checkOffset(s),o=this.index+s-1;o>=this.index;o--)c=(c<<8)+this.byteAt(o);return this.index+=s,c},readString:function(s){return n.transformTo("string",this.readData(s))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var s=this.readInt(4);return new Date(Date.UTC(1980+(s>>25&127),(s>>21&15)-1,s>>16&31,s>>11&31,s>>5&63,(31&s)<<1))}},l.exports=r},{"../utils":32}],19:[function(e,l,a){var n=e("./Uint8ArrayReader");function r(s){n.call(this,s)}e("../utils").inherits(r,n),r.prototype.readData=function(s){this.checkOffset(s);var o=this.data.slice(this.zero+this.index,this.zero+this.index+s);return this.index+=s,o},l.exports=r},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,l,a){var n=e("./DataReader");function r(s){n.call(this,s)}e("../utils").inherits(r,n),r.prototype.byteAt=function(s){return this.data.charCodeAt(this.zero+s)},r.prototype.lastIndexOfSignature=function(s){return this.data.lastIndexOf(s)-this.zero},r.prototype.readAndCheckSignature=function(s){return s===this.readData(4)},r.prototype.readData=function(s){this.checkOffset(s);var o=this.data.slice(this.zero+this.index,this.zero+this.index+s);return this.index+=s,o},l.exports=r},{"../utils":32,"./DataReader":18}],21:[function(e,l,a){var n=e("./ArrayReader");function r(s){n.call(this,s)}e("../utils").inherits(r,n),r.prototype.readData=function(s){if(this.checkOffset(s),s===0)return new Uint8Array(0);var o=this.data.subarray(this.zero+this.index,this.zero+this.index+s);return this.index+=s,o},l.exports=r},{"../utils":32,"./ArrayReader":17}],22:[function(e,l,a){var n=e("../utils"),r=e("../support"),s=e("./ArrayReader"),o=e("./StringReader"),c=e("./NodeBufferReader"),m=e("./Uint8ArrayReader");l.exports=function(p){var u=n.getTypeOf(p);return n.checkSupport(u),u!=="string"||r.uint8array?u==="nodebuffer"?new c(p):r.uint8array?new m(n.transformTo("uint8array",p)):new s(n.transformTo("array",p)):new o(p)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,l,a){a.LOCAL_FILE_HEADER="PK",a.CENTRAL_FILE_HEADER="PK",a.CENTRAL_DIRECTORY_END="PK",a.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",a.ZIP64_CENTRAL_DIRECTORY_END="PK",a.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(e,l,a){var n=e("./GenericWorker"),r=e("../utils");function s(o){n.call(this,"ConvertWorker to "+o),this.destType=o}r.inherits(s,n),s.prototype.processChunk=function(o){this.push({data:r.transformTo(this.destType,o.data),meta:o.meta})},l.exports=s},{"../utils":32,"./GenericWorker":28}],25:[function(e,l,a){var n=e("./GenericWorker"),r=e("../crc32");function s(){n.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}e("../utils").inherits(s,n),s.prototype.processChunk=function(o){this.streamInfo.crc32=r(o.data,this.streamInfo.crc32||0),this.push(o)},l.exports=s},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,l,a){var n=e("../utils"),r=e("./GenericWorker");function s(o){r.call(this,"DataLengthProbe for "+o),this.propName=o,this.withStreamInfo(o,0)}n.inherits(s,r),s.prototype.processChunk=function(o){if(o){var c=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=c+o.data.length}r.prototype.processChunk.call(this,o)},l.exports=s},{"../utils":32,"./GenericWorker":28}],27:[function(e,l,a){var n=e("../utils"),r=e("./GenericWorker");function s(o){r.call(this,"DataWorker");var c=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,o.then(function(m){c.dataIsReady=!0,c.data=m,c.max=m&&m.length||0,c.type=n.getTypeOf(m),c.isPaused||c._tickAndRepeat()},function(m){c.error(m)})}n.inherits(s,r),s.prototype.cleanUp=function(){r.prototype.cleanUp.call(this),this.data=null},s.prototype.resume=function(){return!!r.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,n.delay(this._tickAndRepeat,[],this)),!0)},s.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(n.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},s.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var o=null,c=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":o=this.data.substring(this.index,c);break;case"uint8array":o=this.data.subarray(this.index,c);break;case"array":case"nodebuffer":o=this.data.slice(this.index,c)}return this.index=c,this.push({data:o,meta:{percent:this.max?this.index/this.max*100:0}})},l.exports=s},{"../utils":32,"./GenericWorker":28}],28:[function(e,l,a){function n(r){this.name=r||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}n.prototype={push:function(r){this.emit("data",r)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(r){this.emit("error",r)}return!0},error:function(r){return!this.isFinished&&(this.isPaused?this.generatedError=r:(this.isFinished=!0,this.emit("error",r),this.previous&&this.previous.error(r),this.cleanUp()),!0)},on:function(r,s){return this._listeners[r].push(s),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(r,s){if(this._listeners[r])for(var o=0;o<this._listeners[r].length;o++)this._listeners[r][o].call(this,s)},pipe:function(r){return r.registerPrevious(this)},registerPrevious:function(r){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=r.streamInfo,this.mergeStreamInfo(),this.previous=r;var s=this;return r.on("data",function(o){s.processChunk(o)}),r.on("end",function(){s.end()}),r.on("error",function(o){s.error(o)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var r=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),r=!0),this.previous&&this.previous.resume(),!r},flush:function(){},processChunk:function(r){this.push(r)},withStreamInfo:function(r,s){return this.extraStreamInfo[r]=s,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var r in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,r)&&(this.streamInfo[r]=this.extraStreamInfo[r])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var r="Worker "+this.name;return this.previous?this.previous+" -> "+r:r}},l.exports=n},{}],29:[function(e,l,a){var n=e("../utils"),r=e("./ConvertWorker"),s=e("./GenericWorker"),o=e("../base64"),c=e("../support"),m=e("../external"),p=null;if(c.nodestream)try{p=e("../nodejs/NodejsStreamOutputAdapter")}catch{}function u(y,f){return new m.Promise(function(v,b){var C=[],E=y._internalType,k=y._outputType,_=y._mimeType;y.on("data",function(x,L){C.push(x),f&&f(L)}).on("error",function(x){C=[],b(x)}).on("end",function(){try{var x=function(L,N,R){switch(L){case"blob":return n.newBlob(n.transformTo("arraybuffer",N),R);case"base64":return o.encode(N);default:return n.transformTo(L,N)}}(k,function(L,N){var R,U=0,ee=null,I=0;for(R=0;R<N.length;R++)I+=N[R].length;switch(L){case"string":return N.join("");case"array":return Array.prototype.concat.apply([],N);case"uint8array":for(ee=new Uint8Array(I),R=0;R<N.length;R++)ee.set(N[R],U),U+=N[R].length;return ee;case"nodebuffer":return Buffer.concat(N);default:throw new Error("concat : unsupported type '"+L+"'")}}(E,C),_);v(x)}catch(L){b(L)}C=[]}).resume()})}function h(y,f,v){var b=f;switch(f){case"blob":case"arraybuffer":b="uint8array";break;case"base64":b="string"}try{this._internalType=b,this._outputType=f,this._mimeType=v,n.checkSupport(b),this._worker=y.pipe(new r(b)),y.lock()}catch(C){this._worker=new s("error"),this._worker.error(C)}}h.prototype={accumulate:function(y){return u(this,y)},on:function(y,f){var v=this;return y==="data"?this._worker.on(y,function(b){f.call(v,b.data,b.meta)}):this._worker.on(y,function(){n.delay(f,arguments,v)}),this},resume:function(){return n.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(y){if(n.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new p(this,{objectMode:this._outputType!=="nodebuffer"},y)}},l.exports=h},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,l,a){if(a.base64=!0,a.array=!0,a.string=!0,a.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",a.nodebuffer=typeof Buffer<"u",a.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")a.blob=!1;else{var n=new ArrayBuffer(0);try{a.blob=new Blob([n],{type:"application/zip"}).size===0}catch{try{var r=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);r.append(n),a.blob=r.getBlob("application/zip").size===0}catch{a.blob=!1}}}try{a.nodestream=!!e("readable-stream").Readable}catch{a.nodestream=!1}},{"readable-stream":16}],31:[function(e,l,a){for(var n=e("./utils"),r=e("./support"),s=e("./nodejsUtils"),o=e("./stream/GenericWorker"),c=new Array(256),m=0;m<256;m++)c[m]=252<=m?6:248<=m?5:240<=m?4:224<=m?3:192<=m?2:1;c[254]=c[254]=1;function p(){o.call(this,"utf-8 decode"),this.leftOver=null}function u(){o.call(this,"utf-8 encode")}a.utf8encode=function(h){return r.nodebuffer?s.newBufferFrom(h,"utf-8"):function(y){var f,v,b,C,E,k=y.length,_=0;for(C=0;C<k;C++)(64512&(v=y.charCodeAt(C)))==55296&&C+1<k&&(64512&(b=y.charCodeAt(C+1)))==56320&&(v=65536+(v-55296<<10)+(b-56320),C++),_+=v<128?1:v<2048?2:v<65536?3:4;for(f=r.uint8array?new Uint8Array(_):new Array(_),C=E=0;E<_;C++)(64512&(v=y.charCodeAt(C)))==55296&&C+1<k&&(64512&(b=y.charCodeAt(C+1)))==56320&&(v=65536+(v-55296<<10)+(b-56320),C++),v<128?f[E++]=v:(v<2048?f[E++]=192|v>>>6:(v<65536?f[E++]=224|v>>>12:(f[E++]=240|v>>>18,f[E++]=128|v>>>12&63),f[E++]=128|v>>>6&63),f[E++]=128|63&v);return f}(h)},a.utf8decode=function(h){return r.nodebuffer?n.transformTo("nodebuffer",h).toString("utf-8"):function(y){var f,v,b,C,E=y.length,k=new Array(2*E);for(f=v=0;f<E;)if((b=y[f++])<128)k[v++]=b;else if(4<(C=c[b]))k[v++]=65533,f+=C-1;else{for(b&=C===2?31:C===3?15:7;1<C&&f<E;)b=b<<6|63&y[f++],C--;1<C?k[v++]=65533:b<65536?k[v++]=b:(b-=65536,k[v++]=55296|b>>10&1023,k[v++]=56320|1023&b)}return k.length!==v&&(k.subarray?k=k.subarray(0,v):k.length=v),n.applyFromCharCode(k)}(h=n.transformTo(r.uint8array?"uint8array":"array",h))},n.inherits(p,o),p.prototype.processChunk=function(h){var y=n.transformTo(r.uint8array?"uint8array":"array",h.data);if(this.leftOver&&this.leftOver.length){if(r.uint8array){var f=y;(y=new Uint8Array(f.length+this.leftOver.length)).set(this.leftOver,0),y.set(f,this.leftOver.length)}else y=this.leftOver.concat(y);this.leftOver=null}var v=function(C,E){var k;for((E=E||C.length)>C.length&&(E=C.length),k=E-1;0<=k&&(192&C[k])==128;)k--;return k<0||k===0?E:k+c[C[k]]>E?k:E}(y),b=y;v!==y.length&&(r.uint8array?(b=y.subarray(0,v),this.leftOver=y.subarray(v,y.length)):(b=y.slice(0,v),this.leftOver=y.slice(v,y.length))),this.push({data:a.utf8decode(b),meta:h.meta})},p.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:a.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},a.Utf8DecodeWorker=p,n.inherits(u,o),u.prototype.processChunk=function(h){this.push({data:a.utf8encode(h.data),meta:h.meta})},a.Utf8EncodeWorker=u},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,l,a){var n=e("./support"),r=e("./base64"),s=e("./nodejsUtils"),o=e("./external");function c(f){return f}function m(f,v){for(var b=0;b<f.length;++b)v[b]=255&f.charCodeAt(b);return v}e("setimmediate"),a.newBlob=function(f,v){a.checkSupport("blob");try{return new Blob([f],{type:v})}catch{try{var b=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return b.append(f),b.getBlob(v)}catch{throw new Error("Bug : can't construct the Blob.")}}};var p={stringifyByChunk:function(f,v,b){var C=[],E=0,k=f.length;if(k<=b)return String.fromCharCode.apply(null,f);for(;E<k;)v==="array"||v==="nodebuffer"?C.push(String.fromCharCode.apply(null,f.slice(E,Math.min(E+b,k)))):C.push(String.fromCharCode.apply(null,f.subarray(E,Math.min(E+b,k)))),E+=b;return C.join("")},stringifyByChar:function(f){for(var v="",b=0;b<f.length;b++)v+=String.fromCharCode(f[b]);return v},applyCanBeUsed:{uint8array:function(){try{return n.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}}(),nodebuffer:function(){try{return n.nodebuffer&&String.fromCharCode.apply(null,s.allocBuffer(1)).length===1}catch{return!1}}()}};function u(f){var v=65536,b=a.getTypeOf(f),C=!0;if(b==="uint8array"?C=p.applyCanBeUsed.uint8array:b==="nodebuffer"&&(C=p.applyCanBeUsed.nodebuffer),C)for(;1<v;)try{return p.stringifyByChunk(f,b,v)}catch{v=Math.floor(v/2)}return p.stringifyByChar(f)}function h(f,v){for(var b=0;b<f.length;b++)v[b]=f[b];return v}a.applyFromCharCode=u;var y={};y.string={string:c,array:function(f){return m(f,new Array(f.length))},arraybuffer:function(f){return y.string.uint8array(f).buffer},uint8array:function(f){return m(f,new Uint8Array(f.length))},nodebuffer:function(f){return m(f,s.allocBuffer(f.length))}},y.array={string:u,array:c,arraybuffer:function(f){return new Uint8Array(f).buffer},uint8array:function(f){return new Uint8Array(f)},nodebuffer:function(f){return s.newBufferFrom(f)}},y.arraybuffer={string:function(f){return u(new Uint8Array(f))},array:function(f){return h(new Uint8Array(f),new Array(f.byteLength))},arraybuffer:c,uint8array:function(f){return new Uint8Array(f)},nodebuffer:function(f){return s.newBufferFrom(new Uint8Array(f))}},y.uint8array={string:u,array:function(f){return h(f,new Array(f.length))},arraybuffer:function(f){return f.buffer},uint8array:c,nodebuffer:function(f){return s.newBufferFrom(f)}},y.nodebuffer={string:u,array:function(f){return h(f,new Array(f.length))},arraybuffer:function(f){return y.nodebuffer.uint8array(f).buffer},uint8array:function(f){return h(f,new Uint8Array(f.length))},nodebuffer:c},a.transformTo=function(f,v){if(v=v||"",!f)return v;a.checkSupport(f);var b=a.getTypeOf(v);return y[b][f](v)},a.resolve=function(f){for(var v=f.split("/"),b=[],C=0;C<v.length;C++){var E=v[C];E==="."||E===""&&C!==0&&C!==v.length-1||(E===".."?b.pop():b.push(E))}return b.join("/")},a.getTypeOf=function(f){return typeof f=="string"?"string":Object.prototype.toString.call(f)==="[object Array]"?"array":n.nodebuffer&&s.isBuffer(f)?"nodebuffer":n.uint8array&&f instanceof Uint8Array?"uint8array":n.arraybuffer&&f instanceof ArrayBuffer?"arraybuffer":void 0},a.checkSupport=function(f){if(!n[f.toLowerCase()])throw new Error(f+" is not supported by this platform")},a.MAX_VALUE_16BITS=65535,a.MAX_VALUE_32BITS=-1,a.pretty=function(f){var v,b,C="";for(b=0;b<(f||"").length;b++)C+="\\x"+((v=f.charCodeAt(b))<16?"0":"")+v.toString(16).toUpperCase();return C},a.delay=function(f,v,b){setImmediate(function(){f.apply(b||null,v||[])})},a.inherits=function(f,v){function b(){}b.prototype=v.prototype,f.prototype=new b},a.extend=function(){var f,v,b={};for(f=0;f<arguments.length;f++)for(v in arguments[f])Object.prototype.hasOwnProperty.call(arguments[f],v)&&b[v]===void 0&&(b[v]=arguments[f][v]);return b},a.prepareContent=function(f,v,b,C,E){return o.Promise.resolve(v).then(function(k){return n.blob&&(k instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(k))!==-1)&&typeof FileReader<"u"?new o.Promise(function(_,x){var L=new FileReader;L.onload=function(N){_(N.target.result)},L.onerror=function(N){x(N.target.error)},L.readAsArrayBuffer(k)}):k}).then(function(k){var _=a.getTypeOf(k);return _?(_==="arraybuffer"?k=a.transformTo("uint8array",k):_==="string"&&(E?k=r.decode(k):b&&C!==!0&&(k=function(x){return m(x,n.uint8array?new Uint8Array(x.length):new Array(x.length))}(k))),k):o.Promise.reject(new Error("Can't read the data of '"+f+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(e,l,a){var n=e("./reader/readerFor"),r=e("./utils"),s=e("./signature"),o=e("./zipEntry"),c=e("./support");function m(p){this.files=[],this.loadOptions=p}m.prototype={checkSignature:function(p){if(!this.reader.readAndCheckSignature(p)){this.reader.index-=4;var u=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+r.pretty(u)+", expected "+r.pretty(p)+")")}},isSignature:function(p,u){var h=this.reader.index;this.reader.setIndex(p);var y=this.reader.readString(4)===u;return this.reader.setIndex(h),y},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var p=this.reader.readData(this.zipCommentLength),u=c.uint8array?"uint8array":"array",h=r.transformTo(u,p);this.zipComment=this.loadOptions.decodeFileName(h)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var p,u,h,y=this.zip64EndOfCentralSize-44;0<y;)p=this.reader.readInt(2),u=this.reader.readInt(4),h=this.reader.readData(u),this.zip64ExtensibleData[p]={id:p,length:u,value:h}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var p,u;for(p=0;p<this.files.length;p++)u=this.files[p],this.reader.setIndex(u.localHeaderOffset),this.checkSignature(s.LOCAL_FILE_HEADER),u.readLocalPart(this.reader),u.handleUTF8(),u.processAttributes()},readCentralDir:function(){var p;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(s.CENTRAL_FILE_HEADER);)(p=new o({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(p);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var p=this.reader.lastIndexOfSignature(s.CENTRAL_DIRECTORY_END);if(p<0)throw this.isSignature(0,s.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(p);var u=p;if(this.checkSignature(s.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===r.MAX_VALUE_16BITS||this.diskWithCentralDirStart===r.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===r.MAX_VALUE_16BITS||this.centralDirRecords===r.MAX_VALUE_16BITS||this.centralDirSize===r.MAX_VALUE_32BITS||this.centralDirOffset===r.MAX_VALUE_32BITS){if(this.zip64=!0,(p=this.reader.lastIndexOfSignature(s.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(p),this.checkSignature(s.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,s.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(s.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(s.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var h=this.centralDirOffset+this.centralDirSize;this.zip64&&(h+=20,h+=12+this.zip64EndOfCentralSize);var y=u-h;if(0<y)this.isSignature(u,s.CENTRAL_FILE_HEADER)||(this.reader.zero=y);else if(y<0)throw new Error("Corrupted zip: missing "+Math.abs(y)+" bytes.")},prepareReader:function(p){this.reader=n(p)},load:function(p){this.prepareReader(p),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},l.exports=m},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(e,l,a){var n=e("./reader/readerFor"),r=e("./utils"),s=e("./compressedObject"),o=e("./crc32"),c=e("./utf8"),m=e("./compressions"),p=e("./support");function u(h,y){this.options=h,this.loadOptions=y}u.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(h){var y,f;if(h.skip(22),this.fileNameLength=h.readInt(2),f=h.readInt(2),this.fileName=h.readData(this.fileNameLength),h.skip(f),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((y=function(v){for(var b in m)if(Object.prototype.hasOwnProperty.call(m,b)&&m[b].magic===v)return m[b];return null}(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+r.pretty(this.compressionMethod)+" unknown (inner file : "+r.transformTo("string",this.fileName)+")");this.decompressed=new s(this.compressedSize,this.uncompressedSize,this.crc32,y,h.readData(this.compressedSize))},readCentralPart:function(h){this.versionMadeBy=h.readInt(2),h.skip(2),this.bitFlag=h.readInt(2),this.compressionMethod=h.readString(2),this.date=h.readDate(),this.crc32=h.readInt(4),this.compressedSize=h.readInt(4),this.uncompressedSize=h.readInt(4);var y=h.readInt(2);if(this.extraFieldsLength=h.readInt(2),this.fileCommentLength=h.readInt(2),this.diskNumberStart=h.readInt(2),this.internalFileAttributes=h.readInt(2),this.externalFileAttributes=h.readInt(4),this.localHeaderOffset=h.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");h.skip(y),this.readExtraFields(h),this.parseZIP64ExtraField(h),this.fileComment=h.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var h=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),h==0&&(this.dosPermissions=63&this.externalFileAttributes),h==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var h=n(this.extraFields[1].value);this.uncompressedSize===r.MAX_VALUE_32BITS&&(this.uncompressedSize=h.readInt(8)),this.compressedSize===r.MAX_VALUE_32BITS&&(this.compressedSize=h.readInt(8)),this.localHeaderOffset===r.MAX_VALUE_32BITS&&(this.localHeaderOffset=h.readInt(8)),this.diskNumberStart===r.MAX_VALUE_32BITS&&(this.diskNumberStart=h.readInt(4))}},readExtraFields:function(h){var y,f,v,b=h.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});h.index+4<b;)y=h.readInt(2),f=h.readInt(2),v=h.readData(f),this.extraFields[y]={id:y,length:f,value:v};h.setIndex(b)},handleUTF8:function(){var h=p.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=c.utf8decode(this.fileName),this.fileCommentStr=c.utf8decode(this.fileComment);else{var y=this.findExtraFieldUnicodePath();if(y!==null)this.fileNameStr=y;else{var f=r.transformTo(h,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(f)}var v=this.findExtraFieldUnicodeComment();if(v!==null)this.fileCommentStr=v;else{var b=r.transformTo(h,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(b)}}},findExtraFieldUnicodePath:function(){var h=this.extraFields[28789];if(h){var y=n(h.value);return y.readInt(1)!==1||o(this.fileName)!==y.readInt(4)?null:c.utf8decode(y.readData(h.length-5))}return null},findExtraFieldUnicodeComment:function(){var h=this.extraFields[25461];if(h){var y=n(h.value);return y.readInt(1)!==1||o(this.fileComment)!==y.readInt(4)?null:c.utf8decode(y.readData(h.length-5))}return null}},l.exports=u},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(e,l,a){function n(y,f,v){this.name=y,this.dir=v.dir,this.date=v.date,this.comment=v.comment,this.unixPermissions=v.unixPermissions,this.dosPermissions=v.dosPermissions,this._data=f,this._dataBinary=v.binary,this.options={compression:v.compression,compressionOptions:v.compressionOptions}}var r=e("./stream/StreamHelper"),s=e("./stream/DataWorker"),o=e("./utf8"),c=e("./compressedObject"),m=e("./stream/GenericWorker");n.prototype={internalStream:function(y){var f=null,v="string";try{if(!y)throw new Error("No output type specified.");var b=(v=y.toLowerCase())==="string"||v==="text";v!=="binarystring"&&v!=="text"||(v="string"),f=this._decompressWorker();var C=!this._dataBinary;C&&!b&&(f=f.pipe(new o.Utf8EncodeWorker)),!C&&b&&(f=f.pipe(new o.Utf8DecodeWorker))}catch(E){(f=new m("error")).error(E)}return new r(f,v,"")},async:function(y,f){return this.internalStream(y).accumulate(f)},nodeStream:function(y,f){return this.internalStream(y||"nodebuffer").toNodejsStream(f)},_compressWorker:function(y,f){if(this._data instanceof c&&this._data.compression.magic===y.magic)return this._data.getCompressedWorker();var v=this._decompressWorker();return this._dataBinary||(v=v.pipe(new o.Utf8EncodeWorker)),c.createWorkerFrom(v,y,f)},_decompressWorker:function(){return this._data instanceof c?this._data.getContentWorker():this._data instanceof m?this._data:new s(this._data)}};for(var p=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],u=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},h=0;h<p.length;h++)n.prototype[p[h]]=u;l.exports=n},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(e,l,a){(function(n){var r,s,o=n.MutationObserver||n.WebKitMutationObserver;if(o){var c=0,m=new o(y),p=n.document.createTextNode("");m.observe(p,{characterData:!0}),r=function(){p.data=c=++c%2}}else if(n.setImmediate||n.MessageChannel===void 0)r="document"in n&&"onreadystatechange"in n.document.createElement("script")?function(){var f=n.document.createElement("script");f.onreadystatechange=function(){y(),f.onreadystatechange=null,f.parentNode.removeChild(f),f=null},n.document.documentElement.appendChild(f)}:function(){setTimeout(y,0)};else{var u=new n.MessageChannel;u.port1.onmessage=y,r=function(){u.port2.postMessage(0)}}var h=[];function y(){var f,v;s=!0;for(var b=h.length;b;){for(v=h,h=[],f=-1;++f<b;)v[f]();b=h.length}s=!1}l.exports=function(f){h.push(f)!==1||s||r()}}).call(this,typeof Ln<"u"?Ln:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(e,l,a){var n=e("immediate");function r(){}var s={},o=["REJECTED"],c=["FULFILLED"],m=["PENDING"];function p(b){if(typeof b!="function")throw new TypeError("resolver must be a function");this.state=m,this.queue=[],this.outcome=void 0,b!==r&&f(this,b)}function u(b,C,E){this.promise=b,typeof C=="function"&&(this.onFulfilled=C,this.callFulfilled=this.otherCallFulfilled),typeof E=="function"&&(this.onRejected=E,this.callRejected=this.otherCallRejected)}function h(b,C,E){n(function(){var k;try{k=C(E)}catch(_){return s.reject(b,_)}k===b?s.reject(b,new TypeError("Cannot resolve promise with itself")):s.resolve(b,k)})}function y(b){var C=b&&b.then;if(b&&(typeof b=="object"||typeof b=="function")&&typeof C=="function")return function(){C.apply(b,arguments)}}function f(b,C){var E=!1;function k(L){E||(E=!0,s.reject(b,L))}function _(L){E||(E=!0,s.resolve(b,L))}var x=v(function(){C(_,k)});x.status==="error"&&k(x.value)}function v(b,C){var E={};try{E.value=b(C),E.status="success"}catch(k){E.status="error",E.value=k}return E}(l.exports=p).prototype.finally=function(b){if(typeof b!="function")return this;var C=this.constructor;return this.then(function(E){return C.resolve(b()).then(function(){return E})},function(E){return C.resolve(b()).then(function(){throw E})})},p.prototype.catch=function(b){return this.then(null,b)},p.prototype.then=function(b,C){if(typeof b!="function"&&this.state===c||typeof C!="function"&&this.state===o)return this;var E=new this.constructor(r);return this.state!==m?h(E,this.state===c?b:C,this.outcome):this.queue.push(new u(E,b,C)),E},u.prototype.callFulfilled=function(b){s.resolve(this.promise,b)},u.prototype.otherCallFulfilled=function(b){h(this.promise,this.onFulfilled,b)},u.prototype.callRejected=function(b){s.reject(this.promise,b)},u.prototype.otherCallRejected=function(b){h(this.promise,this.onRejected,b)},s.resolve=function(b,C){var E=v(y,C);if(E.status==="error")return s.reject(b,E.value);var k=E.value;if(k)f(b,k);else{b.state=c,b.outcome=C;for(var _=-1,x=b.queue.length;++_<x;)b.queue[_].callFulfilled(C)}return b},s.reject=function(b,C){b.state=o,b.outcome=C;for(var E=-1,k=b.queue.length;++E<k;)b.queue[E].callRejected(C);return b},p.resolve=function(b){return b instanceof this?b:s.resolve(new this(r),b)},p.reject=function(b){var C=new this(r);return s.reject(C,b)},p.all=function(b){var C=this;if(Object.prototype.toString.call(b)!=="[object Array]")return this.reject(new TypeError("must be an array"));var E=b.length,k=!1;if(!E)return this.resolve([]);for(var _=new Array(E),x=0,L=-1,N=new this(r);++L<E;)R(b[L],L);return N;function R(U,ee){C.resolve(U).then(function(I){_[ee]=I,++x!==E||k||(k=!0,s.resolve(N,_))},function(I){k||(k=!0,s.reject(N,I))})}},p.race=function(b){var C=this;if(Object.prototype.toString.call(b)!=="[object Array]")return this.reject(new TypeError("must be an array"));var E=b.length,k=!1;if(!E)return this.resolve([]);for(var _=-1,x=new this(r);++_<E;)L=b[_],C.resolve(L).then(function(N){k||(k=!0,s.resolve(x,N))},function(N){k||(k=!0,s.reject(x,N))});var L;return x}},{immediate:36}],38:[function(e,l,a){var n={};(0,e("./lib/utils/common").assign)(n,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),l.exports=n},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(e,l,a){var n=e("./zlib/deflate"),r=e("./utils/common"),s=e("./utils/strings"),o=e("./zlib/messages"),c=e("./zlib/zstream"),m=Object.prototype.toString,p=0,u=-1,h=0,y=8;function f(b){if(!(this instanceof f))return new f(b);this.options=r.assign({level:u,method:y,chunkSize:16384,windowBits:15,memLevel:8,strategy:h,to:""},b||{});var C=this.options;C.raw&&0<C.windowBits?C.windowBits=-C.windowBits:C.gzip&&0<C.windowBits&&C.windowBits<16&&(C.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new c,this.strm.avail_out=0;var E=n.deflateInit2(this.strm,C.level,C.method,C.windowBits,C.memLevel,C.strategy);if(E!==p)throw new Error(o[E]);if(C.header&&n.deflateSetHeader(this.strm,C.header),C.dictionary){var k;if(k=typeof C.dictionary=="string"?s.string2buf(C.dictionary):m.call(C.dictionary)==="[object ArrayBuffer]"?new Uint8Array(C.dictionary):C.dictionary,(E=n.deflateSetDictionary(this.strm,k))!==p)throw new Error(o[E]);this._dict_set=!0}}function v(b,C){var E=new f(C);if(E.push(b,!0),E.err)throw E.msg||o[E.err];return E.result}f.prototype.push=function(b,C){var E,k,_=this.strm,x=this.options.chunkSize;if(this.ended)return!1;k=C===~~C?C:C===!0?4:0,typeof b=="string"?_.input=s.string2buf(b):m.call(b)==="[object ArrayBuffer]"?_.input=new Uint8Array(b):_.input=b,_.next_in=0,_.avail_in=_.input.length;do{if(_.avail_out===0&&(_.output=new r.Buf8(x),_.next_out=0,_.avail_out=x),(E=n.deflate(_,k))!==1&&E!==p)return this.onEnd(E),!(this.ended=!0);_.avail_out!==0&&(_.avail_in!==0||k!==4&&k!==2)||(this.options.to==="string"?this.onData(s.buf2binstring(r.shrinkBuf(_.output,_.next_out))):this.onData(r.shrinkBuf(_.output,_.next_out)))}while((0<_.avail_in||_.avail_out===0)&&E!==1);return k===4?(E=n.deflateEnd(this.strm),this.onEnd(E),this.ended=!0,E===p):k!==2||(this.onEnd(p),!(_.avail_out=0))},f.prototype.onData=function(b){this.chunks.push(b)},f.prototype.onEnd=function(b){b===p&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=r.flattenChunks(this.chunks)),this.chunks=[],this.err=b,this.msg=this.strm.msg},a.Deflate=f,a.deflate=v,a.deflateRaw=function(b,C){return(C=C||{}).raw=!0,v(b,C)},a.gzip=function(b,C){return(C=C||{}).gzip=!0,v(b,C)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(e,l,a){var n=e("./zlib/inflate"),r=e("./utils/common"),s=e("./utils/strings"),o=e("./zlib/constants"),c=e("./zlib/messages"),m=e("./zlib/zstream"),p=e("./zlib/gzheader"),u=Object.prototype.toString;function h(f){if(!(this instanceof h))return new h(f);this.options=r.assign({chunkSize:16384,windowBits:0,to:""},f||{});var v=this.options;v.raw&&0<=v.windowBits&&v.windowBits<16&&(v.windowBits=-v.windowBits,v.windowBits===0&&(v.windowBits=-15)),!(0<=v.windowBits&&v.windowBits<16)||f&&f.windowBits||(v.windowBits+=32),15<v.windowBits&&v.windowBits<48&&!(15&v.windowBits)&&(v.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new m,this.strm.avail_out=0;var b=n.inflateInit2(this.strm,v.windowBits);if(b!==o.Z_OK)throw new Error(c[b]);this.header=new p,n.inflateGetHeader(this.strm,this.header)}function y(f,v){var b=new h(v);if(b.push(f,!0),b.err)throw b.msg||c[b.err];return b.result}h.prototype.push=function(f,v){var b,C,E,k,_,x,L=this.strm,N=this.options.chunkSize,R=this.options.dictionary,U=!1;if(this.ended)return!1;C=v===~~v?v:v===!0?o.Z_FINISH:o.Z_NO_FLUSH,typeof f=="string"?L.input=s.binstring2buf(f):u.call(f)==="[object ArrayBuffer]"?L.input=new Uint8Array(f):L.input=f,L.next_in=0,L.avail_in=L.input.length;do{if(L.avail_out===0&&(L.output=new r.Buf8(N),L.next_out=0,L.avail_out=N),(b=n.inflate(L,o.Z_NO_FLUSH))===o.Z_NEED_DICT&&R&&(x=typeof R=="string"?s.string2buf(R):u.call(R)==="[object ArrayBuffer]"?new Uint8Array(R):R,b=n.inflateSetDictionary(this.strm,x)),b===o.Z_BUF_ERROR&&U===!0&&(b=o.Z_OK,U=!1),b!==o.Z_STREAM_END&&b!==o.Z_OK)return this.onEnd(b),!(this.ended=!0);L.next_out&&(L.avail_out!==0&&b!==o.Z_STREAM_END&&(L.avail_in!==0||C!==o.Z_FINISH&&C!==o.Z_SYNC_FLUSH)||(this.options.to==="string"?(E=s.utf8border(L.output,L.next_out),k=L.next_out-E,_=s.buf2string(L.output,E),L.next_out=k,L.avail_out=N-k,k&&r.arraySet(L.output,L.output,E,k,0),this.onData(_)):this.onData(r.shrinkBuf(L.output,L.next_out)))),L.avail_in===0&&L.avail_out===0&&(U=!0)}while((0<L.avail_in||L.avail_out===0)&&b!==o.Z_STREAM_END);return b===o.Z_STREAM_END&&(C=o.Z_FINISH),C===o.Z_FINISH?(b=n.inflateEnd(this.strm),this.onEnd(b),this.ended=!0,b===o.Z_OK):C!==o.Z_SYNC_FLUSH||(this.onEnd(o.Z_OK),!(L.avail_out=0))},h.prototype.onData=function(f){this.chunks.push(f)},h.prototype.onEnd=function(f){f===o.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=r.flattenChunks(this.chunks)),this.chunks=[],this.err=f,this.msg=this.strm.msg},a.Inflate=h,a.inflate=y,a.inflateRaw=function(f,v){return(v=v||{}).raw=!0,y(f,v)},a.ungzip=y},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(e,l,a){var n=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";a.assign=function(o){for(var c=Array.prototype.slice.call(arguments,1);c.length;){var m=c.shift();if(m){if(typeof m!="object")throw new TypeError(m+"must be non-object");for(var p in m)m.hasOwnProperty(p)&&(o[p]=m[p])}}return o},a.shrinkBuf=function(o,c){return o.length===c?o:o.subarray?o.subarray(0,c):(o.length=c,o)};var r={arraySet:function(o,c,m,p,u){if(c.subarray&&o.subarray)o.set(c.subarray(m,m+p),u);else for(var h=0;h<p;h++)o[u+h]=c[m+h]},flattenChunks:function(o){var c,m,p,u,h,y;for(c=p=0,m=o.length;c<m;c++)p+=o[c].length;for(y=new Uint8Array(p),c=u=0,m=o.length;c<m;c++)h=o[c],y.set(h,u),u+=h.length;return y}},s={arraySet:function(o,c,m,p,u){for(var h=0;h<p;h++)o[u+h]=c[m+h]},flattenChunks:function(o){return[].concat.apply([],o)}};a.setTyped=function(o){o?(a.Buf8=Uint8Array,a.Buf16=Uint16Array,a.Buf32=Int32Array,a.assign(a,r)):(a.Buf8=Array,a.Buf16=Array,a.Buf32=Array,a.assign(a,s))},a.setTyped(n)},{}],42:[function(e,l,a){var n=e("./common"),r=!0,s=!0;try{String.fromCharCode.apply(null,[0])}catch{r=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{s=!1}for(var o=new n.Buf8(256),c=0;c<256;c++)o[c]=252<=c?6:248<=c?5:240<=c?4:224<=c?3:192<=c?2:1;function m(p,u){if(u<65537&&(p.subarray&&s||!p.subarray&&r))return String.fromCharCode.apply(null,n.shrinkBuf(p,u));for(var h="",y=0;y<u;y++)h+=String.fromCharCode(p[y]);return h}o[254]=o[254]=1,a.string2buf=function(p){var u,h,y,f,v,b=p.length,C=0;for(f=0;f<b;f++)(64512&(h=p.charCodeAt(f)))==55296&&f+1<b&&(64512&(y=p.charCodeAt(f+1)))==56320&&(h=65536+(h-55296<<10)+(y-56320),f++),C+=h<128?1:h<2048?2:h<65536?3:4;for(u=new n.Buf8(C),f=v=0;v<C;f++)(64512&(h=p.charCodeAt(f)))==55296&&f+1<b&&(64512&(y=p.charCodeAt(f+1)))==56320&&(h=65536+(h-55296<<10)+(y-56320),f++),h<128?u[v++]=h:(h<2048?u[v++]=192|h>>>6:(h<65536?u[v++]=224|h>>>12:(u[v++]=240|h>>>18,u[v++]=128|h>>>12&63),u[v++]=128|h>>>6&63),u[v++]=128|63&h);return u},a.buf2binstring=function(p){return m(p,p.length)},a.binstring2buf=function(p){for(var u=new n.Buf8(p.length),h=0,y=u.length;h<y;h++)u[h]=p.charCodeAt(h);return u},a.buf2string=function(p,u){var h,y,f,v,b=u||p.length,C=new Array(2*b);for(h=y=0;h<b;)if((f=p[h++])<128)C[y++]=f;else if(4<(v=o[f]))C[y++]=65533,h+=v-1;else{for(f&=v===2?31:v===3?15:7;1<v&&h<b;)f=f<<6|63&p[h++],v--;1<v?C[y++]=65533:f<65536?C[y++]=f:(f-=65536,C[y++]=55296|f>>10&1023,C[y++]=56320|1023&f)}return m(C,y)},a.utf8border=function(p,u){var h;for((u=u||p.length)>p.length&&(u=p.length),h=u-1;0<=h&&(192&p[h])==128;)h--;return h<0||h===0?u:h+o[p[h]]>u?h:u}},{"./common":41}],43:[function(e,l,a){l.exports=function(n,r,s,o){for(var c=65535&n|0,m=n>>>16&65535|0,p=0;s!==0;){for(s-=p=2e3<s?2e3:s;m=m+(c=c+r[o++]|0)|0,--p;);c%=65521,m%=65521}return c|m<<16|0}},{}],44:[function(e,l,a){l.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(e,l,a){var n=function(){for(var r,s=[],o=0;o<256;o++){r=o;for(var c=0;c<8;c++)r=1&r?3988292384^r>>>1:r>>>1;s[o]=r}return s}();l.exports=function(r,s,o,c){var m=n,p=c+o;r^=-1;for(var u=c;u<p;u++)r=r>>>8^m[255&(r^s[u])];return-1^r}},{}],46:[function(e,l,a){var n,r=e("../utils/common"),s=e("./trees"),o=e("./adler32"),c=e("./crc32"),m=e("./messages"),p=0,u=4,h=0,y=-2,f=-1,v=4,b=2,C=8,E=9,k=286,_=30,x=19,L=2*k+1,N=15,R=3,U=258,ee=U+R+1,I=42,$=113,g=1,W=2,fe=3,q=4;function me(d,j){return d.msg=m[j],j}function P(d){return(d<<1)-(4<d?9:0)}function se(d){for(var j=d.length;0<=--j;)d[j]=0}function O(d){var j=d.state,z=j.pending;z>d.avail_out&&(z=d.avail_out),z!==0&&(r.arraySet(d.output,j.pending_buf,j.pending_out,z,d.next_out),d.next_out+=z,j.pending_out+=z,d.total_out+=z,d.avail_out-=z,j.pending-=z,j.pending===0&&(j.pending_out=0))}function M(d,j){s._tr_flush_block(d,0<=d.block_start?d.block_start:-1,d.strstart-d.block_start,j),d.block_start=d.strstart,O(d.strm)}function le(d,j){d.pending_buf[d.pending++]=j}function te(d,j){d.pending_buf[d.pending++]=j>>>8&255,d.pending_buf[d.pending++]=255&j}function Q(d,j){var z,S,w=d.max_chain_length,T=d.strstart,Z=d.prev_length,G=d.nice_match,D=d.strstart>d.w_size-ee?d.strstart-(d.w_size-ee):0,Y=d.window,ae=d.w_mask,X=d.prev,ue=d.strstart+U,xe=Y[T+Z-1],ve=Y[T+Z];d.prev_length>=d.good_match&&(w>>=2),G>d.lookahead&&(G=d.lookahead);do if(Y[(z=j)+Z]===ve&&Y[z+Z-1]===xe&&Y[z]===Y[T]&&Y[++z]===Y[T+1]){T+=2,z++;do;while(Y[++T]===Y[++z]&&Y[++T]===Y[++z]&&Y[++T]===Y[++z]&&Y[++T]===Y[++z]&&Y[++T]===Y[++z]&&Y[++T]===Y[++z]&&Y[++T]===Y[++z]&&Y[++T]===Y[++z]&&T<ue);if(S=U-(ue-T),T=ue-U,Z<S){if(d.match_start=j,G<=(Z=S))break;xe=Y[T+Z-1],ve=Y[T+Z]}}while((j=X[j&ae])>D&&--w!=0);return Z<=d.lookahead?Z:d.lookahead}function Le(d){var j,z,S,w,T,Z,G,D,Y,ae,X=d.w_size;do{if(w=d.window_size-d.lookahead-d.strstart,d.strstart>=X+(X-ee)){for(r.arraySet(d.window,d.window,X,X,0),d.match_start-=X,d.strstart-=X,d.block_start-=X,j=z=d.hash_size;S=d.head[--j],d.head[j]=X<=S?S-X:0,--z;);for(j=z=X;S=d.prev[--j],d.prev[j]=X<=S?S-X:0,--z;);w+=X}if(d.strm.avail_in===0)break;if(Z=d.strm,G=d.window,D=d.strstart+d.lookahead,Y=w,ae=void 0,ae=Z.avail_in,Y<ae&&(ae=Y),z=ae===0?0:(Z.avail_in-=ae,r.arraySet(G,Z.input,Z.next_in,ae,D),Z.state.wrap===1?Z.adler=o(Z.adler,G,ae,D):Z.state.wrap===2&&(Z.adler=c(Z.adler,G,ae,D)),Z.next_in+=ae,Z.total_in+=ae,ae),d.lookahead+=z,d.lookahead+d.insert>=R)for(T=d.strstart-d.insert,d.ins_h=d.window[T],d.ins_h=(d.ins_h<<d.hash_shift^d.window[T+1])&d.hash_mask;d.insert&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[T+R-1])&d.hash_mask,d.prev[T&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=T,T++,d.insert--,!(d.lookahead+d.insert<R)););}while(d.lookahead<ee&&d.strm.avail_in!==0)}function Oe(d,j){for(var z,S;;){if(d.lookahead<ee){if(Le(d),d.lookahead<ee&&j===p)return g;if(d.lookahead===0)break}if(z=0,d.lookahead>=R&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,z=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),z!==0&&d.strstart-z<=d.w_size-ee&&(d.match_length=Q(d,z)),d.match_length>=R)if(S=s._tr_tally(d,d.strstart-d.match_start,d.match_length-R),d.lookahead-=d.match_length,d.match_length<=d.max_lazy_match&&d.lookahead>=R){for(d.match_length--;d.strstart++,d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,z=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart,--d.match_length!=0;);d.strstart++}else d.strstart+=d.match_length,d.match_length=0,d.ins_h=d.window[d.strstart],d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+1])&d.hash_mask;else S=s._tr_tally(d,0,d.window[d.strstart]),d.lookahead--,d.strstart++;if(S&&(M(d,!1),d.strm.avail_out===0))return g}return d.insert=d.strstart<R-1?d.strstart:R-1,j===u?(M(d,!0),d.strm.avail_out===0?fe:q):d.last_lit&&(M(d,!1),d.strm.avail_out===0)?g:W}function he(d,j){for(var z,S,w;;){if(d.lookahead<ee){if(Le(d),d.lookahead<ee&&j===p)return g;if(d.lookahead===0)break}if(z=0,d.lookahead>=R&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,z=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),d.prev_length=d.match_length,d.prev_match=d.match_start,d.match_length=R-1,z!==0&&d.prev_length<d.max_lazy_match&&d.strstart-z<=d.w_size-ee&&(d.match_length=Q(d,z),d.match_length<=5&&(d.strategy===1||d.match_length===R&&4096<d.strstart-d.match_start)&&(d.match_length=R-1)),d.prev_length>=R&&d.match_length<=d.prev_length){for(w=d.strstart+d.lookahead-R,S=s._tr_tally(d,d.strstart-1-d.prev_match,d.prev_length-R),d.lookahead-=d.prev_length-1,d.prev_length-=2;++d.strstart<=w&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,z=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),--d.prev_length!=0;);if(d.match_available=0,d.match_length=R-1,d.strstart++,S&&(M(d,!1),d.strm.avail_out===0))return g}else if(d.match_available){if((S=s._tr_tally(d,0,d.window[d.strstart-1]))&&M(d,!1),d.strstart++,d.lookahead--,d.strm.avail_out===0)return g}else d.match_available=1,d.strstart++,d.lookahead--}return d.match_available&&(S=s._tr_tally(d,0,d.window[d.strstart-1]),d.match_available=0),d.insert=d.strstart<R-1?d.strstart:R-1,j===u?(M(d,!0),d.strm.avail_out===0?fe:q):d.last_lit&&(M(d,!1),d.strm.avail_out===0)?g:W}function Ee(d,j,z,S,w){this.good_length=d,this.max_lazy=j,this.nice_length=z,this.max_chain=S,this.func=w}function Te(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=C,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new r.Buf16(2*L),this.dyn_dtree=new r.Buf16(2*(2*_+1)),this.bl_tree=new r.Buf16(2*(2*x+1)),se(this.dyn_ltree),se(this.dyn_dtree),se(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new r.Buf16(N+1),this.heap=new r.Buf16(2*k+1),se(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new r.Buf16(2*k+1),se(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function Me(d){var j;return d&&d.state?(d.total_in=d.total_out=0,d.data_type=b,(j=d.state).pending=0,j.pending_out=0,j.wrap<0&&(j.wrap=-j.wrap),j.status=j.wrap?I:$,d.adler=j.wrap===2?0:1,j.last_flush=p,s._tr_init(j),h):me(d,y)}function st(d){var j=Me(d);return j===h&&function(z){z.window_size=2*z.w_size,se(z.head),z.max_lazy_match=n[z.level].max_lazy,z.good_match=n[z.level].good_length,z.nice_match=n[z.level].nice_length,z.max_chain_length=n[z.level].max_chain,z.strstart=0,z.block_start=0,z.lookahead=0,z.insert=0,z.match_length=z.prev_length=R-1,z.match_available=0,z.ins_h=0}(d.state),j}function at(d,j,z,S,w,T){if(!d)return y;var Z=1;if(j===f&&(j=6),S<0?(Z=0,S=-S):15<S&&(Z=2,S-=16),w<1||E<w||z!==C||S<8||15<S||j<0||9<j||T<0||v<T)return me(d,y);S===8&&(S=9);var G=new Te;return(d.state=G).strm=d,G.wrap=Z,G.gzhead=null,G.w_bits=S,G.w_size=1<<G.w_bits,G.w_mask=G.w_size-1,G.hash_bits=w+7,G.hash_size=1<<G.hash_bits,G.hash_mask=G.hash_size-1,G.hash_shift=~~((G.hash_bits+R-1)/R),G.window=new r.Buf8(2*G.w_size),G.head=new r.Buf16(G.hash_size),G.prev=new r.Buf16(G.w_size),G.lit_bufsize=1<<w+6,G.pending_buf_size=4*G.lit_bufsize,G.pending_buf=new r.Buf8(G.pending_buf_size),G.d_buf=1*G.lit_bufsize,G.l_buf=3*G.lit_bufsize,G.level=j,G.strategy=T,G.method=z,st(d)}n=[new Ee(0,0,0,0,function(d,j){var z=65535;for(z>d.pending_buf_size-5&&(z=d.pending_buf_size-5);;){if(d.lookahead<=1){if(Le(d),d.lookahead===0&&j===p)return g;if(d.lookahead===0)break}d.strstart+=d.lookahead,d.lookahead=0;var S=d.block_start+z;if((d.strstart===0||d.strstart>=S)&&(d.lookahead=d.strstart-S,d.strstart=S,M(d,!1),d.strm.avail_out===0)||d.strstart-d.block_start>=d.w_size-ee&&(M(d,!1),d.strm.avail_out===0))return g}return d.insert=0,j===u?(M(d,!0),d.strm.avail_out===0?fe:q):(d.strstart>d.block_start&&(M(d,!1),d.strm.avail_out),g)}),new Ee(4,4,8,4,Oe),new Ee(4,5,16,8,Oe),new Ee(4,6,32,32,Oe),new Ee(4,4,16,16,he),new Ee(8,16,32,32,he),new Ee(8,16,128,128,he),new Ee(8,32,128,256,he),new Ee(32,128,258,1024,he),new Ee(32,258,258,4096,he)],a.deflateInit=function(d,j){return at(d,j,C,15,8,0)},a.deflateInit2=at,a.deflateReset=st,a.deflateResetKeep=Me,a.deflateSetHeader=function(d,j){return d&&d.state?d.state.wrap!==2?y:(d.state.gzhead=j,h):y},a.deflate=function(d,j){var z,S,w,T;if(!d||!d.state||5<j||j<0)return d?me(d,y):y;if(S=d.state,!d.output||!d.input&&d.avail_in!==0||S.status===666&&j!==u)return me(d,d.avail_out===0?-5:y);if(S.strm=d,z=S.last_flush,S.last_flush=j,S.status===I)if(S.wrap===2)d.adler=0,le(S,31),le(S,139),le(S,8),S.gzhead?(le(S,(S.gzhead.text?1:0)+(S.gzhead.hcrc?2:0)+(S.gzhead.extra?4:0)+(S.gzhead.name?8:0)+(S.gzhead.comment?16:0)),le(S,255&S.gzhead.time),le(S,S.gzhead.time>>8&255),le(S,S.gzhead.time>>16&255),le(S,S.gzhead.time>>24&255),le(S,S.level===9?2:2<=S.strategy||S.level<2?4:0),le(S,255&S.gzhead.os),S.gzhead.extra&&S.gzhead.extra.length&&(le(S,255&S.gzhead.extra.length),le(S,S.gzhead.extra.length>>8&255)),S.gzhead.hcrc&&(d.adler=c(d.adler,S.pending_buf,S.pending,0)),S.gzindex=0,S.status=69):(le(S,0),le(S,0),le(S,0),le(S,0),le(S,0),le(S,S.level===9?2:2<=S.strategy||S.level<2?4:0),le(S,3),S.status=$);else{var Z=C+(S.w_bits-8<<4)<<8;Z|=(2<=S.strategy||S.level<2?0:S.level<6?1:S.level===6?2:3)<<6,S.strstart!==0&&(Z|=32),Z+=31-Z%31,S.status=$,te(S,Z),S.strstart!==0&&(te(S,d.adler>>>16),te(S,65535&d.adler)),d.adler=1}if(S.status===69)if(S.gzhead.extra){for(w=S.pending;S.gzindex<(65535&S.gzhead.extra.length)&&(S.pending!==S.pending_buf_size||(S.gzhead.hcrc&&S.pending>w&&(d.adler=c(d.adler,S.pending_buf,S.pending-w,w)),O(d),w=S.pending,S.pending!==S.pending_buf_size));)le(S,255&S.gzhead.extra[S.gzindex]),S.gzindex++;S.gzhead.hcrc&&S.pending>w&&(d.adler=c(d.adler,S.pending_buf,S.pending-w,w)),S.gzindex===S.gzhead.extra.length&&(S.gzindex=0,S.status=73)}else S.status=73;if(S.status===73)if(S.gzhead.name){w=S.pending;do{if(S.pending===S.pending_buf_size&&(S.gzhead.hcrc&&S.pending>w&&(d.adler=c(d.adler,S.pending_buf,S.pending-w,w)),O(d),w=S.pending,S.pending===S.pending_buf_size)){T=1;break}T=S.gzindex<S.gzhead.name.length?255&S.gzhead.name.charCodeAt(S.gzindex++):0,le(S,T)}while(T!==0);S.gzhead.hcrc&&S.pending>w&&(d.adler=c(d.adler,S.pending_buf,S.pending-w,w)),T===0&&(S.gzindex=0,S.status=91)}else S.status=91;if(S.status===91)if(S.gzhead.comment){w=S.pending;do{if(S.pending===S.pending_buf_size&&(S.gzhead.hcrc&&S.pending>w&&(d.adler=c(d.adler,S.pending_buf,S.pending-w,w)),O(d),w=S.pending,S.pending===S.pending_buf_size)){T=1;break}T=S.gzindex<S.gzhead.comment.length?255&S.gzhead.comment.charCodeAt(S.gzindex++):0,le(S,T)}while(T!==0);S.gzhead.hcrc&&S.pending>w&&(d.adler=c(d.adler,S.pending_buf,S.pending-w,w)),T===0&&(S.status=103)}else S.status=103;if(S.status===103&&(S.gzhead.hcrc?(S.pending+2>S.pending_buf_size&&O(d),S.pending+2<=S.pending_buf_size&&(le(S,255&d.adler),le(S,d.adler>>8&255),d.adler=0,S.status=$)):S.status=$),S.pending!==0){if(O(d),d.avail_out===0)return S.last_flush=-1,h}else if(d.avail_in===0&&P(j)<=P(z)&&j!==u)return me(d,-5);if(S.status===666&&d.avail_in!==0)return me(d,-5);if(d.avail_in!==0||S.lookahead!==0||j!==p&&S.status!==666){var G=S.strategy===2?function(D,Y){for(var ae;;){if(D.lookahead===0&&(Le(D),D.lookahead===0)){if(Y===p)return g;break}if(D.match_length=0,ae=s._tr_tally(D,0,D.window[D.strstart]),D.lookahead--,D.strstart++,ae&&(M(D,!1),D.strm.avail_out===0))return g}return D.insert=0,Y===u?(M(D,!0),D.strm.avail_out===0?fe:q):D.last_lit&&(M(D,!1),D.strm.avail_out===0)?g:W}(S,j):S.strategy===3?function(D,Y){for(var ae,X,ue,xe,ve=D.window;;){if(D.lookahead<=U){if(Le(D),D.lookahead<=U&&Y===p)return g;if(D.lookahead===0)break}if(D.match_length=0,D.lookahead>=R&&0<D.strstart&&(X=ve[ue=D.strstart-1])===ve[++ue]&&X===ve[++ue]&&X===ve[++ue]){xe=D.strstart+U;do;while(X===ve[++ue]&&X===ve[++ue]&&X===ve[++ue]&&X===ve[++ue]&&X===ve[++ue]&&X===ve[++ue]&&X===ve[++ue]&&X===ve[++ue]&&ue<xe);D.match_length=U-(xe-ue),D.match_length>D.lookahead&&(D.match_length=D.lookahead)}if(D.match_length>=R?(ae=s._tr_tally(D,1,D.match_length-R),D.lookahead-=D.match_length,D.strstart+=D.match_length,D.match_length=0):(ae=s._tr_tally(D,0,D.window[D.strstart]),D.lookahead--,D.strstart++),ae&&(M(D,!1),D.strm.avail_out===0))return g}return D.insert=0,Y===u?(M(D,!0),D.strm.avail_out===0?fe:q):D.last_lit&&(M(D,!1),D.strm.avail_out===0)?g:W}(S,j):n[S.level].func(S,j);if(G!==fe&&G!==q||(S.status=666),G===g||G===fe)return d.avail_out===0&&(S.last_flush=-1),h;if(G===W&&(j===1?s._tr_align(S):j!==5&&(s._tr_stored_block(S,0,0,!1),j===3&&(se(S.head),S.lookahead===0&&(S.strstart=0,S.block_start=0,S.insert=0))),O(d),d.avail_out===0))return S.last_flush=-1,h}return j!==u?h:S.wrap<=0?1:(S.wrap===2?(le(S,255&d.adler),le(S,d.adler>>8&255),le(S,d.adler>>16&255),le(S,d.adler>>24&255),le(S,255&d.total_in),le(S,d.total_in>>8&255),le(S,d.total_in>>16&255),le(S,d.total_in>>24&255)):(te(S,d.adler>>>16),te(S,65535&d.adler)),O(d),0<S.wrap&&(S.wrap=-S.wrap),S.pending!==0?h:1)},a.deflateEnd=function(d){var j;return d&&d.state?(j=d.state.status)!==I&&j!==69&&j!==73&&j!==91&&j!==103&&j!==$&&j!==666?me(d,y):(d.state=null,j===$?me(d,-3):h):y},a.deflateSetDictionary=function(d,j){var z,S,w,T,Z,G,D,Y,ae=j.length;if(!d||!d.state||(T=(z=d.state).wrap)===2||T===1&&z.status!==I||z.lookahead)return y;for(T===1&&(d.adler=o(d.adler,j,ae,0)),z.wrap=0,ae>=z.w_size&&(T===0&&(se(z.head),z.strstart=0,z.block_start=0,z.insert=0),Y=new r.Buf8(z.w_size),r.arraySet(Y,j,ae-z.w_size,z.w_size,0),j=Y,ae=z.w_size),Z=d.avail_in,G=d.next_in,D=d.input,d.avail_in=ae,d.next_in=0,d.input=j,Le(z);z.lookahead>=R;){for(S=z.strstart,w=z.lookahead-(R-1);z.ins_h=(z.ins_h<<z.hash_shift^z.window[S+R-1])&z.hash_mask,z.prev[S&z.w_mask]=z.head[z.ins_h],z.head[z.ins_h]=S,S++,--w;);z.strstart=S,z.lookahead=R-1,Le(z)}return z.strstart+=z.lookahead,z.block_start=z.strstart,z.insert=z.lookahead,z.lookahead=0,z.match_length=z.prev_length=R-1,z.match_available=0,d.next_in=G,d.input=D,d.avail_in=Z,z.wrap=T,h},a.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(e,l,a){l.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(e,l,a){l.exports=function(n,r){var s,o,c,m,p,u,h,y,f,v,b,C,E,k,_,x,L,N,R,U,ee,I,$,g,W;s=n.state,o=n.next_in,g=n.input,c=o+(n.avail_in-5),m=n.next_out,W=n.output,p=m-(r-n.avail_out),u=m+(n.avail_out-257),h=s.dmax,y=s.wsize,f=s.whave,v=s.wnext,b=s.window,C=s.hold,E=s.bits,k=s.lencode,_=s.distcode,x=(1<<s.lenbits)-1,L=(1<<s.distbits)-1;e:do{E<15&&(C+=g[o++]<<E,E+=8,C+=g[o++]<<E,E+=8),N=k[C&x];t:for(;;){if(C>>>=R=N>>>24,E-=R,(R=N>>>16&255)===0)W[m++]=65535&N;else{if(!(16&R)){if(!(64&R)){N=k[(65535&N)+(C&(1<<R)-1)];continue t}if(32&R){s.mode=12;break e}n.msg="invalid literal/length code",s.mode=30;break e}U=65535&N,(R&=15)&&(E<R&&(C+=g[o++]<<E,E+=8),U+=C&(1<<R)-1,C>>>=R,E-=R),E<15&&(C+=g[o++]<<E,E+=8,C+=g[o++]<<E,E+=8),N=_[C&L];n:for(;;){if(C>>>=R=N>>>24,E-=R,!(16&(R=N>>>16&255))){if(!(64&R)){N=_[(65535&N)+(C&(1<<R)-1)];continue n}n.msg="invalid distance code",s.mode=30;break e}if(ee=65535&N,E<(R&=15)&&(C+=g[o++]<<E,(E+=8)<R&&(C+=g[o++]<<E,E+=8)),h<(ee+=C&(1<<R)-1)){n.msg="invalid distance too far back",s.mode=30;break e}if(C>>>=R,E-=R,(R=m-p)<ee){if(f<(R=ee-R)&&s.sane){n.msg="invalid distance too far back",s.mode=30;break e}if($=b,(I=0)===v){if(I+=y-R,R<U){for(U-=R;W[m++]=b[I++],--R;);I=m-ee,$=W}}else if(v<R){if(I+=y+v-R,(R-=v)<U){for(U-=R;W[m++]=b[I++],--R;);if(I=0,v<U){for(U-=R=v;W[m++]=b[I++],--R;);I=m-ee,$=W}}}else if(I+=v-R,R<U){for(U-=R;W[m++]=b[I++],--R;);I=m-ee,$=W}for(;2<U;)W[m++]=$[I++],W[m++]=$[I++],W[m++]=$[I++],U-=3;U&&(W[m++]=$[I++],1<U&&(W[m++]=$[I++]))}else{for(I=m-ee;W[m++]=W[I++],W[m++]=W[I++],W[m++]=W[I++],2<(U-=3););U&&(W[m++]=W[I++],1<U&&(W[m++]=W[I++]))}break}}break}}while(o<c&&m<u);o-=U=E>>3,C&=(1<<(E-=U<<3))-1,n.next_in=o,n.next_out=m,n.avail_in=o<c?c-o+5:5-(o-c),n.avail_out=m<u?u-m+257:257-(m-u),s.hold=C,s.bits=E}},{}],49:[function(e,l,a){var n=e("../utils/common"),r=e("./adler32"),s=e("./crc32"),o=e("./inffast"),c=e("./inftrees"),m=1,p=2,u=0,h=-2,y=1,f=852,v=592;function b(I){return(I>>>24&255)+(I>>>8&65280)+((65280&I)<<8)+((255&I)<<24)}function C(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new n.Buf16(320),this.work=new n.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function E(I){var $;return I&&I.state?($=I.state,I.total_in=I.total_out=$.total=0,I.msg="",$.wrap&&(I.adler=1&$.wrap),$.mode=y,$.last=0,$.havedict=0,$.dmax=32768,$.head=null,$.hold=0,$.bits=0,$.lencode=$.lendyn=new n.Buf32(f),$.distcode=$.distdyn=new n.Buf32(v),$.sane=1,$.back=-1,u):h}function k(I){var $;return I&&I.state?(($=I.state).wsize=0,$.whave=0,$.wnext=0,E(I)):h}function _(I,$){var g,W;return I&&I.state?(W=I.state,$<0?(g=0,$=-$):(g=1+($>>4),$<48&&($&=15)),$&&($<8||15<$)?h:(W.window!==null&&W.wbits!==$&&(W.window=null),W.wrap=g,W.wbits=$,k(I))):h}function x(I,$){var g,W;return I?(W=new C,(I.state=W).window=null,(g=_(I,$))!==u&&(I.state=null),g):h}var L,N,R=!0;function U(I){if(R){var $;for(L=new n.Buf32(512),N=new n.Buf32(32),$=0;$<144;)I.lens[$++]=8;for(;$<256;)I.lens[$++]=9;for(;$<280;)I.lens[$++]=7;for(;$<288;)I.lens[$++]=8;for(c(m,I.lens,0,288,L,0,I.work,{bits:9}),$=0;$<32;)I.lens[$++]=5;c(p,I.lens,0,32,N,0,I.work,{bits:5}),R=!1}I.lencode=L,I.lenbits=9,I.distcode=N,I.distbits=5}function ee(I,$,g,W){var fe,q=I.state;return q.window===null&&(q.wsize=1<<q.wbits,q.wnext=0,q.whave=0,q.window=new n.Buf8(q.wsize)),W>=q.wsize?(n.arraySet(q.window,$,g-q.wsize,q.wsize,0),q.wnext=0,q.whave=q.wsize):(W<(fe=q.wsize-q.wnext)&&(fe=W),n.arraySet(q.window,$,g-W,fe,q.wnext),(W-=fe)?(n.arraySet(q.window,$,g-W,W,0),q.wnext=W,q.whave=q.wsize):(q.wnext+=fe,q.wnext===q.wsize&&(q.wnext=0),q.whave<q.wsize&&(q.whave+=fe))),0}a.inflateReset=k,a.inflateReset2=_,a.inflateResetKeep=E,a.inflateInit=function(I){return x(I,15)},a.inflateInit2=x,a.inflate=function(I,$){var g,W,fe,q,me,P,se,O,M,le,te,Q,Le,Oe,he,Ee,Te,Me,st,at,d,j,z,S,w=0,T=new n.Buf8(4),Z=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!I||!I.state||!I.output||!I.input&&I.avail_in!==0)return h;(g=I.state).mode===12&&(g.mode=13),me=I.next_out,fe=I.output,se=I.avail_out,q=I.next_in,W=I.input,P=I.avail_in,O=g.hold,M=g.bits,le=P,te=se,j=u;e:for(;;)switch(g.mode){case y:if(g.wrap===0){g.mode=13;break}for(;M<16;){if(P===0)break e;P--,O+=W[q++]<<M,M+=8}if(2&g.wrap&&O===35615){T[g.check=0]=255&O,T[1]=O>>>8&255,g.check=s(g.check,T,2,0),M=O=0,g.mode=2;break}if(g.flags=0,g.head&&(g.head.done=!1),!(1&g.wrap)||(((255&O)<<8)+(O>>8))%31){I.msg="incorrect header check",g.mode=30;break}if((15&O)!=8){I.msg="unknown compression method",g.mode=30;break}if(M-=4,d=8+(15&(O>>>=4)),g.wbits===0)g.wbits=d;else if(d>g.wbits){I.msg="invalid window size",g.mode=30;break}g.dmax=1<<d,I.adler=g.check=1,g.mode=512&O?10:12,M=O=0;break;case 2:for(;M<16;){if(P===0)break e;P--,O+=W[q++]<<M,M+=8}if(g.flags=O,(255&g.flags)!=8){I.msg="unknown compression method",g.mode=30;break}if(57344&g.flags){I.msg="unknown header flags set",g.mode=30;break}g.head&&(g.head.text=O>>8&1),512&g.flags&&(T[0]=255&O,T[1]=O>>>8&255,g.check=s(g.check,T,2,0)),M=O=0,g.mode=3;case 3:for(;M<32;){if(P===0)break e;P--,O+=W[q++]<<M,M+=8}g.head&&(g.head.time=O),512&g.flags&&(T[0]=255&O,T[1]=O>>>8&255,T[2]=O>>>16&255,T[3]=O>>>24&255,g.check=s(g.check,T,4,0)),M=O=0,g.mode=4;case 4:for(;M<16;){if(P===0)break e;P--,O+=W[q++]<<M,M+=8}g.head&&(g.head.xflags=255&O,g.head.os=O>>8),512&g.flags&&(T[0]=255&O,T[1]=O>>>8&255,g.check=s(g.check,T,2,0)),M=O=0,g.mode=5;case 5:if(1024&g.flags){for(;M<16;){if(P===0)break e;P--,O+=W[q++]<<M,M+=8}g.length=O,g.head&&(g.head.extra_len=O),512&g.flags&&(T[0]=255&O,T[1]=O>>>8&255,g.check=s(g.check,T,2,0)),M=O=0}else g.head&&(g.head.extra=null);g.mode=6;case 6:if(1024&g.flags&&(P<(Q=g.length)&&(Q=P),Q&&(g.head&&(d=g.head.extra_len-g.length,g.head.extra||(g.head.extra=new Array(g.head.extra_len)),n.arraySet(g.head.extra,W,q,Q,d)),512&g.flags&&(g.check=s(g.check,W,Q,q)),P-=Q,q+=Q,g.length-=Q),g.length))break e;g.length=0,g.mode=7;case 7:if(2048&g.flags){if(P===0)break e;for(Q=0;d=W[q+Q++],g.head&&d&&g.length<65536&&(g.head.name+=String.fromCharCode(d)),d&&Q<P;);if(512&g.flags&&(g.check=s(g.check,W,Q,q)),P-=Q,q+=Q,d)break e}else g.head&&(g.head.name=null);g.length=0,g.mode=8;case 8:if(4096&g.flags){if(P===0)break e;for(Q=0;d=W[q+Q++],g.head&&d&&g.length<65536&&(g.head.comment+=String.fromCharCode(d)),d&&Q<P;);if(512&g.flags&&(g.check=s(g.check,W,Q,q)),P-=Q,q+=Q,d)break e}else g.head&&(g.head.comment=null);g.mode=9;case 9:if(512&g.flags){for(;M<16;){if(P===0)break e;P--,O+=W[q++]<<M,M+=8}if(O!==(65535&g.check)){I.msg="header crc mismatch",g.mode=30;break}M=O=0}g.head&&(g.head.hcrc=g.flags>>9&1,g.head.done=!0),I.adler=g.check=0,g.mode=12;break;case 10:for(;M<32;){if(P===0)break e;P--,O+=W[q++]<<M,M+=8}I.adler=g.check=b(O),M=O=0,g.mode=11;case 11:if(g.havedict===0)return I.next_out=me,I.avail_out=se,I.next_in=q,I.avail_in=P,g.hold=O,g.bits=M,2;I.adler=g.check=1,g.mode=12;case 12:if($===5||$===6)break e;case 13:if(g.last){O>>>=7&M,M-=7&M,g.mode=27;break}for(;M<3;){if(P===0)break e;P--,O+=W[q++]<<M,M+=8}switch(g.last=1&O,M-=1,3&(O>>>=1)){case 0:g.mode=14;break;case 1:if(U(g),g.mode=20,$!==6)break;O>>>=2,M-=2;break e;case 2:g.mode=17;break;case 3:I.msg="invalid block type",g.mode=30}O>>>=2,M-=2;break;case 14:for(O>>>=7&M,M-=7&M;M<32;){if(P===0)break e;P--,O+=W[q++]<<M,M+=8}if((65535&O)!=(O>>>16^65535)){I.msg="invalid stored block lengths",g.mode=30;break}if(g.length=65535&O,M=O=0,g.mode=15,$===6)break e;case 15:g.mode=16;case 16:if(Q=g.length){if(P<Q&&(Q=P),se<Q&&(Q=se),Q===0)break e;n.arraySet(fe,W,q,Q,me),P-=Q,q+=Q,se-=Q,me+=Q,g.length-=Q;break}g.mode=12;break;case 17:for(;M<14;){if(P===0)break e;P--,O+=W[q++]<<M,M+=8}if(g.nlen=257+(31&O),O>>>=5,M-=5,g.ndist=1+(31&O),O>>>=5,M-=5,g.ncode=4+(15&O),O>>>=4,M-=4,286<g.nlen||30<g.ndist){I.msg="too many length or distance symbols",g.mode=30;break}g.have=0,g.mode=18;case 18:for(;g.have<g.ncode;){for(;M<3;){if(P===0)break e;P--,O+=W[q++]<<M,M+=8}g.lens[Z[g.have++]]=7&O,O>>>=3,M-=3}for(;g.have<19;)g.lens[Z[g.have++]]=0;if(g.lencode=g.lendyn,g.lenbits=7,z={bits:g.lenbits},j=c(0,g.lens,0,19,g.lencode,0,g.work,z),g.lenbits=z.bits,j){I.msg="invalid code lengths set",g.mode=30;break}g.have=0,g.mode=19;case 19:for(;g.have<g.nlen+g.ndist;){for(;Ee=(w=g.lencode[O&(1<<g.lenbits)-1])>>>16&255,Te=65535&w,!((he=w>>>24)<=M);){if(P===0)break e;P--,O+=W[q++]<<M,M+=8}if(Te<16)O>>>=he,M-=he,g.lens[g.have++]=Te;else{if(Te===16){for(S=he+2;M<S;){if(P===0)break e;P--,O+=W[q++]<<M,M+=8}if(O>>>=he,M-=he,g.have===0){I.msg="invalid bit length repeat",g.mode=30;break}d=g.lens[g.have-1],Q=3+(3&O),O>>>=2,M-=2}else if(Te===17){for(S=he+3;M<S;){if(P===0)break e;P--,O+=W[q++]<<M,M+=8}M-=he,d=0,Q=3+(7&(O>>>=he)),O>>>=3,M-=3}else{for(S=he+7;M<S;){if(P===0)break e;P--,O+=W[q++]<<M,M+=8}M-=he,d=0,Q=11+(127&(O>>>=he)),O>>>=7,M-=7}if(g.have+Q>g.nlen+g.ndist){I.msg="invalid bit length repeat",g.mode=30;break}for(;Q--;)g.lens[g.have++]=d}}if(g.mode===30)break;if(g.lens[256]===0){I.msg="invalid code -- missing end-of-block",g.mode=30;break}if(g.lenbits=9,z={bits:g.lenbits},j=c(m,g.lens,0,g.nlen,g.lencode,0,g.work,z),g.lenbits=z.bits,j){I.msg="invalid literal/lengths set",g.mode=30;break}if(g.distbits=6,g.distcode=g.distdyn,z={bits:g.distbits},j=c(p,g.lens,g.nlen,g.ndist,g.distcode,0,g.work,z),g.distbits=z.bits,j){I.msg="invalid distances set",g.mode=30;break}if(g.mode=20,$===6)break e;case 20:g.mode=21;case 21:if(6<=P&&258<=se){I.next_out=me,I.avail_out=se,I.next_in=q,I.avail_in=P,g.hold=O,g.bits=M,o(I,te),me=I.next_out,fe=I.output,se=I.avail_out,q=I.next_in,W=I.input,P=I.avail_in,O=g.hold,M=g.bits,g.mode===12&&(g.back=-1);break}for(g.back=0;Ee=(w=g.lencode[O&(1<<g.lenbits)-1])>>>16&255,Te=65535&w,!((he=w>>>24)<=M);){if(P===0)break e;P--,O+=W[q++]<<M,M+=8}if(Ee&&!(240&Ee)){for(Me=he,st=Ee,at=Te;Ee=(w=g.lencode[at+((O&(1<<Me+st)-1)>>Me)])>>>16&255,Te=65535&w,!(Me+(he=w>>>24)<=M);){if(P===0)break e;P--,O+=W[q++]<<M,M+=8}O>>>=Me,M-=Me,g.back+=Me}if(O>>>=he,M-=he,g.back+=he,g.length=Te,Ee===0){g.mode=26;break}if(32&Ee){g.back=-1,g.mode=12;break}if(64&Ee){I.msg="invalid literal/length code",g.mode=30;break}g.extra=15&Ee,g.mode=22;case 22:if(g.extra){for(S=g.extra;M<S;){if(P===0)break e;P--,O+=W[q++]<<M,M+=8}g.length+=O&(1<<g.extra)-1,O>>>=g.extra,M-=g.extra,g.back+=g.extra}g.was=g.length,g.mode=23;case 23:for(;Ee=(w=g.distcode[O&(1<<g.distbits)-1])>>>16&255,Te=65535&w,!((he=w>>>24)<=M);){if(P===0)break e;P--,O+=W[q++]<<M,M+=8}if(!(240&Ee)){for(Me=he,st=Ee,at=Te;Ee=(w=g.distcode[at+((O&(1<<Me+st)-1)>>Me)])>>>16&255,Te=65535&w,!(Me+(he=w>>>24)<=M);){if(P===0)break e;P--,O+=W[q++]<<M,M+=8}O>>>=Me,M-=Me,g.back+=Me}if(O>>>=he,M-=he,g.back+=he,64&Ee){I.msg="invalid distance code",g.mode=30;break}g.offset=Te,g.extra=15&Ee,g.mode=24;case 24:if(g.extra){for(S=g.extra;M<S;){if(P===0)break e;P--,O+=W[q++]<<M,M+=8}g.offset+=O&(1<<g.extra)-1,O>>>=g.extra,M-=g.extra,g.back+=g.extra}if(g.offset>g.dmax){I.msg="invalid distance too far back",g.mode=30;break}g.mode=25;case 25:if(se===0)break e;if(Q=te-se,g.offset>Q){if((Q=g.offset-Q)>g.whave&&g.sane){I.msg="invalid distance too far back",g.mode=30;break}Le=Q>g.wnext?(Q-=g.wnext,g.wsize-Q):g.wnext-Q,Q>g.length&&(Q=g.length),Oe=g.window}else Oe=fe,Le=me-g.offset,Q=g.length;for(se<Q&&(Q=se),se-=Q,g.length-=Q;fe[me++]=Oe[Le++],--Q;);g.length===0&&(g.mode=21);break;case 26:if(se===0)break e;fe[me++]=g.length,se--,g.mode=21;break;case 27:if(g.wrap){for(;M<32;){if(P===0)break e;P--,O|=W[q++]<<M,M+=8}if(te-=se,I.total_out+=te,g.total+=te,te&&(I.adler=g.check=g.flags?s(g.check,fe,te,me-te):r(g.check,fe,te,me-te)),te=se,(g.flags?O:b(O))!==g.check){I.msg="incorrect data check",g.mode=30;break}M=O=0}g.mode=28;case 28:if(g.wrap&&g.flags){for(;M<32;){if(P===0)break e;P--,O+=W[q++]<<M,M+=8}if(O!==(4294967295&g.total)){I.msg="incorrect length check",g.mode=30;break}M=O=0}g.mode=29;case 29:j=1;break e;case 30:j=-3;break e;case 31:return-4;case 32:default:return h}return I.next_out=me,I.avail_out=se,I.next_in=q,I.avail_in=P,g.hold=O,g.bits=M,(g.wsize||te!==I.avail_out&&g.mode<30&&(g.mode<27||$!==4))&&ee(I,I.output,I.next_out,te-I.avail_out)?(g.mode=31,-4):(le-=I.avail_in,te-=I.avail_out,I.total_in+=le,I.total_out+=te,g.total+=te,g.wrap&&te&&(I.adler=g.check=g.flags?s(g.check,fe,te,I.next_out-te):r(g.check,fe,te,I.next_out-te)),I.data_type=g.bits+(g.last?64:0)+(g.mode===12?128:0)+(g.mode===20||g.mode===15?256:0),(le==0&&te===0||$===4)&&j===u&&(j=-5),j)},a.inflateEnd=function(I){if(!I||!I.state)return h;var $=I.state;return $.window&&($.window=null),I.state=null,u},a.inflateGetHeader=function(I,$){var g;return I&&I.state&&2&(g=I.state).wrap?((g.head=$).done=!1,u):h},a.inflateSetDictionary=function(I,$){var g,W=$.length;return I&&I.state?(g=I.state).wrap!==0&&g.mode!==11?h:g.mode===11&&r(1,$,W,0)!==g.check?-3:ee(I,$,W,W)?(g.mode=31,-4):(g.havedict=1,u):h},a.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(e,l,a){var n=e("../utils/common"),r=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],s=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],o=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],c=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];l.exports=function(m,p,u,h,y,f,v,b){var C,E,k,_,x,L,N,R,U,ee=b.bits,I=0,$=0,g=0,W=0,fe=0,q=0,me=0,P=0,se=0,O=0,M=null,le=0,te=new n.Buf16(16),Q=new n.Buf16(16),Le=null,Oe=0;for(I=0;I<=15;I++)te[I]=0;for($=0;$<h;$++)te[p[u+$]]++;for(fe=ee,W=15;1<=W&&te[W]===0;W--);if(W<fe&&(fe=W),W===0)return y[f++]=20971520,y[f++]=20971520,b.bits=1,0;for(g=1;g<W&&te[g]===0;g++);for(fe<g&&(fe=g),I=P=1;I<=15;I++)if(P<<=1,(P-=te[I])<0)return-1;if(0<P&&(m===0||W!==1))return-1;for(Q[1]=0,I=1;I<15;I++)Q[I+1]=Q[I]+te[I];for($=0;$<h;$++)p[u+$]!==0&&(v[Q[p[u+$]]++]=$);if(L=m===0?(M=Le=v,19):m===1?(M=r,le-=257,Le=s,Oe-=257,256):(M=o,Le=c,-1),I=g,x=f,me=$=O=0,k=-1,_=(se=1<<(q=fe))-1,m===1&&852<se||m===2&&592<se)return 1;for(;;){for(N=I-me,U=v[$]<L?(R=0,v[$]):v[$]>L?(R=Le[Oe+v[$]],M[le+v[$]]):(R=96,0),C=1<<I-me,g=E=1<<q;y[x+(O>>me)+(E-=C)]=N<<24|R<<16|U|0,E!==0;);for(C=1<<I-1;O&C;)C>>=1;if(C!==0?(O&=C-1,O+=C):O=0,$++,--te[I]==0){if(I===W)break;I=p[u+v[$]]}if(fe<I&&(O&_)!==k){for(me===0&&(me=fe),x+=g,P=1<<(q=I-me);q+me<W&&!((P-=te[q+me])<=0);)q++,P<<=1;if(se+=1<<q,m===1&&852<se||m===2&&592<se)return 1;y[k=O&_]=fe<<24|q<<16|x-f|0}}return O!==0&&(y[x+O]=I-me<<24|64<<16|0),b.bits=fe,0}},{"../utils/common":41}],51:[function(e,l,a){l.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(e,l,a){var n=e("../utils/common"),r=0,s=1;function o(w){for(var T=w.length;0<=--T;)w[T]=0}var c=0,m=29,p=256,u=p+1+m,h=30,y=19,f=2*u+1,v=15,b=16,C=7,E=256,k=16,_=17,x=18,L=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],N=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],R=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],U=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],ee=new Array(2*(u+2));o(ee);var I=new Array(2*h);o(I);var $=new Array(512);o($);var g=new Array(256);o(g);var W=new Array(m);o(W);var fe,q,me,P=new Array(h);function se(w,T,Z,G,D){this.static_tree=w,this.extra_bits=T,this.extra_base=Z,this.elems=G,this.max_length=D,this.has_stree=w&&w.length}function O(w,T){this.dyn_tree=w,this.max_code=0,this.stat_desc=T}function M(w){return w<256?$[w]:$[256+(w>>>7)]}function le(w,T){w.pending_buf[w.pending++]=255&T,w.pending_buf[w.pending++]=T>>>8&255}function te(w,T,Z){w.bi_valid>b-Z?(w.bi_buf|=T<<w.bi_valid&65535,le(w,w.bi_buf),w.bi_buf=T>>b-w.bi_valid,w.bi_valid+=Z-b):(w.bi_buf|=T<<w.bi_valid&65535,w.bi_valid+=Z)}function Q(w,T,Z){te(w,Z[2*T],Z[2*T+1])}function Le(w,T){for(var Z=0;Z|=1&w,w>>>=1,Z<<=1,0<--T;);return Z>>>1}function Oe(w,T,Z){var G,D,Y=new Array(v+1),ae=0;for(G=1;G<=v;G++)Y[G]=ae=ae+Z[G-1]<<1;for(D=0;D<=T;D++){var X=w[2*D+1];X!==0&&(w[2*D]=Le(Y[X]++,X))}}function he(w){var T;for(T=0;T<u;T++)w.dyn_ltree[2*T]=0;for(T=0;T<h;T++)w.dyn_dtree[2*T]=0;for(T=0;T<y;T++)w.bl_tree[2*T]=0;w.dyn_ltree[2*E]=1,w.opt_len=w.static_len=0,w.last_lit=w.matches=0}function Ee(w){8<w.bi_valid?le(w,w.bi_buf):0<w.bi_valid&&(w.pending_buf[w.pending++]=w.bi_buf),w.bi_buf=0,w.bi_valid=0}function Te(w,T,Z,G){var D=2*T,Y=2*Z;return w[D]<w[Y]||w[D]===w[Y]&&G[T]<=G[Z]}function Me(w,T,Z){for(var G=w.heap[Z],D=Z<<1;D<=w.heap_len&&(D<w.heap_len&&Te(T,w.heap[D+1],w.heap[D],w.depth)&&D++,!Te(T,G,w.heap[D],w.depth));)w.heap[Z]=w.heap[D],Z=D,D<<=1;w.heap[Z]=G}function st(w,T,Z){var G,D,Y,ae,X=0;if(w.last_lit!==0)for(;G=w.pending_buf[w.d_buf+2*X]<<8|w.pending_buf[w.d_buf+2*X+1],D=w.pending_buf[w.l_buf+X],X++,G===0?Q(w,D,T):(Q(w,(Y=g[D])+p+1,T),(ae=L[Y])!==0&&te(w,D-=W[Y],ae),Q(w,Y=M(--G),Z),(ae=N[Y])!==0&&te(w,G-=P[Y],ae)),X<w.last_lit;);Q(w,E,T)}function at(w,T){var Z,G,D,Y=T.dyn_tree,ae=T.stat_desc.static_tree,X=T.stat_desc.has_stree,ue=T.stat_desc.elems,xe=-1;for(w.heap_len=0,w.heap_max=f,Z=0;Z<ue;Z++)Y[2*Z]!==0?(w.heap[++w.heap_len]=xe=Z,w.depth[Z]=0):Y[2*Z+1]=0;for(;w.heap_len<2;)Y[2*(D=w.heap[++w.heap_len]=xe<2?++xe:0)]=1,w.depth[D]=0,w.opt_len--,X&&(w.static_len-=ae[2*D+1]);for(T.max_code=xe,Z=w.heap_len>>1;1<=Z;Z--)Me(w,Y,Z);for(D=ue;Z=w.heap[1],w.heap[1]=w.heap[w.heap_len--],Me(w,Y,1),G=w.heap[1],w.heap[--w.heap_max]=Z,w.heap[--w.heap_max]=G,Y[2*D]=Y[2*Z]+Y[2*G],w.depth[D]=(w.depth[Z]>=w.depth[G]?w.depth[Z]:w.depth[G])+1,Y[2*Z+1]=Y[2*G+1]=D,w.heap[1]=D++,Me(w,Y,1),2<=w.heap_len;);w.heap[--w.heap_max]=w.heap[1],function(ve,Je){var bt,Qe,$t,De,Pe,zt,ut=Je.dyn_tree,Qt=Je.max_code,kn=Je.stat_desc.static_tree,gs=Je.stat_desc.has_stree,ys=Je.stat_desc.extra_bits,_n=Je.stat_desc.extra_base,It=Je.stat_desc.max_length,Pt=0;for(De=0;De<=v;De++)ve.bl_count[De]=0;for(ut[2*ve.heap[ve.heap_max]+1]=0,bt=ve.heap_max+1;bt<f;bt++)It<(De=ut[2*ut[2*(Qe=ve.heap[bt])+1]+1]+1)&&(De=It,Pt++),ut[2*Qe+1]=De,Qt<Qe||(ve.bl_count[De]++,Pe=0,_n<=Qe&&(Pe=ys[Qe-_n]),zt=ut[2*Qe],ve.opt_len+=zt*(De+Pe),gs&&(ve.static_len+=zt*(kn[2*Qe+1]+Pe)));if(Pt!==0){do{for(De=It-1;ve.bl_count[De]===0;)De--;ve.bl_count[De]--,ve.bl_count[De+1]+=2,ve.bl_count[It]--,Pt-=2}while(0<Pt);for(De=It;De!==0;De--)for(Qe=ve.bl_count[De];Qe!==0;)Qt<($t=ve.heap[--bt])||(ut[2*$t+1]!==De&&(ve.opt_len+=(De-ut[2*$t+1])*ut[2*$t],ut[2*$t+1]=De),Qe--)}}(w,T),Oe(Y,xe,w.bl_count)}function d(w,T,Z){var G,D,Y=-1,ae=T[1],X=0,ue=7,xe=4;for(ae===0&&(ue=138,xe=3),T[2*(Z+1)+1]=65535,G=0;G<=Z;G++)D=ae,ae=T[2*(G+1)+1],++X<ue&&D===ae||(X<xe?w.bl_tree[2*D]+=X:D!==0?(D!==Y&&w.bl_tree[2*D]++,w.bl_tree[2*k]++):X<=10?w.bl_tree[2*_]++:w.bl_tree[2*x]++,Y=D,xe=(X=0)===ae?(ue=138,3):D===ae?(ue=6,3):(ue=7,4))}function j(w,T,Z){var G,D,Y=-1,ae=T[1],X=0,ue=7,xe=4;for(ae===0&&(ue=138,xe=3),G=0;G<=Z;G++)if(D=ae,ae=T[2*(G+1)+1],!(++X<ue&&D===ae)){if(X<xe)for(;Q(w,D,w.bl_tree),--X!=0;);else D!==0?(D!==Y&&(Q(w,D,w.bl_tree),X--),Q(w,k,w.bl_tree),te(w,X-3,2)):X<=10?(Q(w,_,w.bl_tree),te(w,X-3,3)):(Q(w,x,w.bl_tree),te(w,X-11,7));Y=D,xe=(X=0)===ae?(ue=138,3):D===ae?(ue=6,3):(ue=7,4)}}o(P);var z=!1;function S(w,T,Z,G){te(w,(c<<1)+(G?1:0),3),function(D,Y,ae,X){Ee(D),le(D,ae),le(D,~ae),n.arraySet(D.pending_buf,D.window,Y,ae,D.pending),D.pending+=ae}(w,T,Z)}a._tr_init=function(w){z||(function(){var T,Z,G,D,Y,ae=new Array(v+1);for(D=G=0;D<m-1;D++)for(W[D]=G,T=0;T<1<<L[D];T++)g[G++]=D;for(g[G-1]=D,D=Y=0;D<16;D++)for(P[D]=Y,T=0;T<1<<N[D];T++)$[Y++]=D;for(Y>>=7;D<h;D++)for(P[D]=Y<<7,T=0;T<1<<N[D]-7;T++)$[256+Y++]=D;for(Z=0;Z<=v;Z++)ae[Z]=0;for(T=0;T<=143;)ee[2*T+1]=8,T++,ae[8]++;for(;T<=255;)ee[2*T+1]=9,T++,ae[9]++;for(;T<=279;)ee[2*T+1]=7,T++,ae[7]++;for(;T<=287;)ee[2*T+1]=8,T++,ae[8]++;for(Oe(ee,u+1,ae),T=0;T<h;T++)I[2*T+1]=5,I[2*T]=Le(T,5);fe=new se(ee,L,p+1,u,v),q=new se(I,N,0,h,v),me=new se(new Array(0),R,0,y,C)}(),z=!0),w.l_desc=new O(w.dyn_ltree,fe),w.d_desc=new O(w.dyn_dtree,q),w.bl_desc=new O(w.bl_tree,me),w.bi_buf=0,w.bi_valid=0,he(w)},a._tr_stored_block=S,a._tr_flush_block=function(w,T,Z,G){var D,Y,ae=0;0<w.level?(w.strm.data_type===2&&(w.strm.data_type=function(X){var ue,xe=4093624447;for(ue=0;ue<=31;ue++,xe>>>=1)if(1&xe&&X.dyn_ltree[2*ue]!==0)return r;if(X.dyn_ltree[18]!==0||X.dyn_ltree[20]!==0||X.dyn_ltree[26]!==0)return s;for(ue=32;ue<p;ue++)if(X.dyn_ltree[2*ue]!==0)return s;return r}(w)),at(w,w.l_desc),at(w,w.d_desc),ae=function(X){var ue;for(d(X,X.dyn_ltree,X.l_desc.max_code),d(X,X.dyn_dtree,X.d_desc.max_code),at(X,X.bl_desc),ue=y-1;3<=ue&&X.bl_tree[2*U[ue]+1]===0;ue--);return X.opt_len+=3*(ue+1)+5+5+4,ue}(w),D=w.opt_len+3+7>>>3,(Y=w.static_len+3+7>>>3)<=D&&(D=Y)):D=Y=Z+5,Z+4<=D&&T!==-1?S(w,T,Z,G):w.strategy===4||Y===D?(te(w,2+(G?1:0),3),st(w,ee,I)):(te(w,4+(G?1:0),3),function(X,ue,xe,ve){var Je;for(te(X,ue-257,5),te(X,xe-1,5),te(X,ve-4,4),Je=0;Je<ve;Je++)te(X,X.bl_tree[2*U[Je]+1],3);j(X,X.dyn_ltree,ue-1),j(X,X.dyn_dtree,xe-1)}(w,w.l_desc.max_code+1,w.d_desc.max_code+1,ae+1),st(w,w.dyn_ltree,w.dyn_dtree)),he(w),G&&Ee(w)},a._tr_tally=function(w,T,Z){return w.pending_buf[w.d_buf+2*w.last_lit]=T>>>8&255,w.pending_buf[w.d_buf+2*w.last_lit+1]=255&T,w.pending_buf[w.l_buf+w.last_lit]=255&Z,w.last_lit++,T===0?w.dyn_ltree[2*Z]++:(w.matches++,T--,w.dyn_ltree[2*(g[Z]+p+1)]++,w.dyn_dtree[2*M(T)]++),w.last_lit===w.lit_bufsize-1},a._tr_align=function(w){te(w,2,3),Q(w,E,ee),function(T){T.bi_valid===16?(le(T,T.bi_buf),T.bi_buf=0,T.bi_valid=0):8<=T.bi_valid&&(T.pending_buf[T.pending++]=255&T.bi_buf,T.bi_buf>>=8,T.bi_valid-=8)}(w)}},{"../utils/common":41}],53:[function(e,l,a){l.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(e,l,a){(function(n){(function(r,s){if(!r.setImmediate){var o,c,m,p,u=1,h={},y=!1,f=r.document,v=Object.getPrototypeOf&&Object.getPrototypeOf(r);v=v&&v.setTimeout?v:r,o={}.toString.call(r.process)==="[object process]"?function(k){process.nextTick(function(){C(k)})}:function(){if(r.postMessage&&!r.importScripts){var k=!0,_=r.onmessage;return r.onmessage=function(){k=!1},r.postMessage("","*"),r.onmessage=_,k}}()?(p="setImmediate$"+Math.random()+"$",r.addEventListener?r.addEventListener("message",E,!1):r.attachEvent("onmessage",E),function(k){r.postMessage(p+k,"*")}):r.MessageChannel?((m=new MessageChannel).port1.onmessage=function(k){C(k.data)},function(k){m.port2.postMessage(k)}):f&&"onreadystatechange"in f.createElement("script")?(c=f.documentElement,function(k){var _=f.createElement("script");_.onreadystatechange=function(){C(k),_.onreadystatechange=null,c.removeChild(_),_=null},c.appendChild(_)}):function(k){setTimeout(C,0,k)},v.setImmediate=function(k){typeof k!="function"&&(k=new Function(""+k));for(var _=new Array(arguments.length-1),x=0;x<_.length;x++)_[x]=arguments[x+1];var L={callback:k,args:_};return h[u]=L,o(u),u++},v.clearImmediate=b}function b(k){delete h[k]}function C(k){if(y)setTimeout(C,0,k);else{var _=h[k];if(_){y=!0;try{(function(x){var L=x.callback,N=x.args;switch(N.length){case 0:L();break;case 1:L(N[0]);break;case 2:L(N[0],N[1]);break;case 3:L(N[0],N[1],N[2]);break;default:L.apply(s,N)}})(_)}finally{b(k),y=!1}}}}function E(k){k.source===r&&typeof k.data=="string"&&k.data.indexOf(p)===0&&C(+k.data.slice(p.length))}})(typeof self>"u"?n===void 0?this:n:self)}).call(this,typeof Ln<"u"?Ln:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(qa);var dr=qa.exports;const Gs=ja(dr);var Za={exports:{}};(function(t){var i=function(){var e=String.fromCharCode,l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",n={};function r(o,c){if(!n[o]){n[o]={};for(var m=0;m<o.length;m++)n[o][o.charAt(m)]=m}return n[o][c]}var s={compressToBase64:function(o){if(o==null)return"";var c=s._compress(o,6,function(m){return l.charAt(m)});switch(c.length%4){default:case 0:return c;case 1:return c+"===";case 2:return c+"==";case 3:return c+"="}},decompressFromBase64:function(o){return o==null?"":o==""?null:s._decompress(o.length,32,function(c){return r(l,o.charAt(c))})},compressToUTF16:function(o){return o==null?"":s._compress(o,15,function(c){return e(c+32)})+" "},decompressFromUTF16:function(o){return o==null?"":o==""?null:s._decompress(o.length,16384,function(c){return o.charCodeAt(c)-32})},compressToUint8Array:function(o){for(var c=s.compress(o),m=new Uint8Array(c.length*2),p=0,u=c.length;p<u;p++){var h=c.charCodeAt(p);m[p*2]=h>>>8,m[p*2+1]=h%256}return m},decompressFromUint8Array:function(o){if(o==null)return s.decompress(o);for(var c=new Array(o.length/2),m=0,p=c.length;m<p;m++)c[m]=o[m*2]*256+o[m*2+1];var u=[];return c.forEach(function(h){u.push(e(h))}),s.decompress(u.join(""))},compressToEncodedURIComponent:function(o){return o==null?"":s._compress(o,6,function(c){return a.charAt(c)})},decompressFromEncodedURIComponent:function(o){return o==null?"":o==""?null:(o=o.replace(/ /g,"+"),s._decompress(o.length,32,function(c){return r(a,o.charAt(c))}))},compress:function(o){return s._compress(o,16,function(c){return e(c)})},_compress:function(o,c,m){if(o==null)return"";var p,u,h={},y={},f="",v="",b="",C=2,E=3,k=2,_=[],x=0,L=0,N;for(N=0;N<o.length;N+=1)if(f=o.charAt(N),Object.prototype.hasOwnProperty.call(h,f)||(h[f]=E++,y[f]=!0),v=b+f,Object.prototype.hasOwnProperty.call(h,v))b=v;else{if(Object.prototype.hasOwnProperty.call(y,b)){if(b.charCodeAt(0)<256){for(p=0;p<k;p++)x=x<<1,L==c-1?(L=0,_.push(m(x)),x=0):L++;for(u=b.charCodeAt(0),p=0;p<8;p++)x=x<<1|u&1,L==c-1?(L=0,_.push(m(x)),x=0):L++,u=u>>1}else{for(u=1,p=0;p<k;p++)x=x<<1|u,L==c-1?(L=0,_.push(m(x)),x=0):L++,u=0;for(u=b.charCodeAt(0),p=0;p<16;p++)x=x<<1|u&1,L==c-1?(L=0,_.push(m(x)),x=0):L++,u=u>>1}C--,C==0&&(C=Math.pow(2,k),k++),delete y[b]}else for(u=h[b],p=0;p<k;p++)x=x<<1|u&1,L==c-1?(L=0,_.push(m(x)),x=0):L++,u=u>>1;C--,C==0&&(C=Math.pow(2,k),k++),h[v]=E++,b=String(f)}if(b!==""){if(Object.prototype.hasOwnProperty.call(y,b)){if(b.charCodeAt(0)<256){for(p=0;p<k;p++)x=x<<1,L==c-1?(L=0,_.push(m(x)),x=0):L++;for(u=b.charCodeAt(0),p=0;p<8;p++)x=x<<1|u&1,L==c-1?(L=0,_.push(m(x)),x=0):L++,u=u>>1}else{for(u=1,p=0;p<k;p++)x=x<<1|u,L==c-1?(L=0,_.push(m(x)),x=0):L++,u=0;for(u=b.charCodeAt(0),p=0;p<16;p++)x=x<<1|u&1,L==c-1?(L=0,_.push(m(x)),x=0):L++,u=u>>1}C--,C==0&&(C=Math.pow(2,k),k++),delete y[b]}else for(u=h[b],p=0;p<k;p++)x=x<<1|u&1,L==c-1?(L=0,_.push(m(x)),x=0):L++,u=u>>1;C--,C==0&&(C=Math.pow(2,k),k++)}for(u=2,p=0;p<k;p++)x=x<<1|u&1,L==c-1?(L=0,_.push(m(x)),x=0):L++,u=u>>1;for(;;)if(x=x<<1,L==c-1){_.push(m(x));break}else L++;return _.join("")},decompress:function(o){return o==null?"":o==""?null:s._decompress(o.length,32768,function(c){return o.charCodeAt(c)})},_decompress:function(o,c,m){var p=[],u=4,h=4,y=3,f="",v=[],b,C,E,k,_,x,L,N={val:m(0),position:c,index:1};for(b=0;b<3;b+=1)p[b]=b;for(E=0,_=Math.pow(2,2),x=1;x!=_;)k=N.val&N.position,N.position>>=1,N.position==0&&(N.position=c,N.val=m(N.index++)),E|=(k>0?1:0)*x,x<<=1;switch(E){case 0:for(E=0,_=Math.pow(2,8),x=1;x!=_;)k=N.val&N.position,N.position>>=1,N.position==0&&(N.position=c,N.val=m(N.index++)),E|=(k>0?1:0)*x,x<<=1;L=e(E);break;case 1:for(E=0,_=Math.pow(2,16),x=1;x!=_;)k=N.val&N.position,N.position>>=1,N.position==0&&(N.position=c,N.val=m(N.index++)),E|=(k>0?1:0)*x,x<<=1;L=e(E);break;case 2:return""}for(p[3]=L,C=L,v.push(L);;){if(N.index>o)return"";for(E=0,_=Math.pow(2,y),x=1;x!=_;)k=N.val&N.position,N.position>>=1,N.position==0&&(N.position=c,N.val=m(N.index++)),E|=(k>0?1:0)*x,x<<=1;switch(L=E){case 0:for(E=0,_=Math.pow(2,8),x=1;x!=_;)k=N.val&N.position,N.position>>=1,N.position==0&&(N.position=c,N.val=m(N.index++)),E|=(k>0?1:0)*x,x<<=1;p[h++]=e(E),L=h-1,u--;break;case 1:for(E=0,_=Math.pow(2,16),x=1;x!=_;)k=N.val&N.position,N.position>>=1,N.position==0&&(N.position=c,N.val=m(N.index++)),E|=(k>0?1:0)*x,x<<=1;p[h++]=e(E),L=h-1,u--;break;case 2:return v.join("")}if(u==0&&(u=Math.pow(2,y),y++),p[L])f=p[L];else if(L===h)f=C+C.charAt(0);else return null;v.push(f),p[h++]=C+f.charAt(0),u--,C=f,u==0&&(u=Math.pow(2,y),y++)}}};return s}();t!=null?t.exports=i:typeof angular<"u"&&angular!=null&&angular.module("LZString",[]).factory("LZString",function(){return i})})(Za);var ur=Za.exports;const Ga=ja(ur);function fr(t){return new Worker("/assets/compression.worker-B3kqe_bR.js",{name:t==null?void 0:t.name})}let re={},A=null,Vs=null,J=null,_e=null,mn=null,ls=null,Js=[],jn=null,Ks=null,Re=null,rt={},qn=0,Ys=0,Zn=0,Xs=0,Qs=null,ea=null,Gn=null,St=null,Ve=-1,ta=null,Vn=null,Jn=null,Kn=null,Va=null,Ja=null,mt=!1,Ze=[],it=[],Mt=[],Fe={isScreenSaverEnabled:!0,isSoundEnabled:!0,isVibrationEnabled:!0,lastRestoreTimestamp:null,lastBackupTimestamp:null},Ka=new Set,Tt=!1;function Ya(t){Tt=t}let Ft=null;const na=new fr;na.onmessage=t=>{const i=t.data;try{localStorage.setItem("teacherAssistantData_v2",i),console.log("Background save complete.")}catch(e){console.error("Background storage failed:",e)}};na.onerror=t=>{console.error("❌ Worker Communication Error:",t.message,t)};function oe(t=!1){if(mt)return;const e=JSON.stringify({classrooms:re,trashBin:Ze,userSettings:Fe});if(t){Ft&&clearTimeout(Ft);try{const l=Ga.compressToUTF16(e);localStorage.setItem("teacherAssistantData_v2",l),console.log("Immediate save complete.")}catch(l){console.error("Immediate save failed:",l)}return}Ft&&clearTimeout(Ft),Ft=setTimeout(()=>{na.postMessage(e),Ft=null},500)}function mr(t){return new Promise((i,e)=>{const l=new FileReader;l.onerror=e,l.onload=()=>{i(l.result.split(",")[1])},l.readAsDataURL(t)})}async function Xa(t=[]){const i={};if(t.length>0)t.forEach(c=>{re[c]&&(i[c]=re[c])});else for(const c in re)re[c].isDeleted||(i[c]=re[c]);const e={metadata:{version:"2.0-b64",createdAt:new Date().toISOString()},data:{classrooms:i,trashBin:Ze,userSettings:Fe}},l=JSON.stringify(e),a=new Date,n=new Intl.DateTimeFormat("fa-IR-u-nu-latn",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(a).reduce((c,m)=>(c[m.type]=m.value,c),{}),s=`${n.year.slice(-2)}-${n.month}-${n.day}_${n.hour}-${n.minute}`;let o;t.length===0?o=`SP_Full_${s}.txt`:t.length===1?o=`SP_${t[0].replace(/[<>:"/\\|?*]/g,"").replace(/\s+/g,"_")}_${s}.txt`:o=`SP_Selected-${t.length}_${s}.txt`;try{const c=new Gs;c.file("backup.json",l);const m=await c.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:9}}),p=await mr(m);return new File([p],o,{type:"text/plain"})}catch(c){return console.error("Error creating base64 backup file:",c),null}}function Yn(){const t=localStorage.getItem("teacherAssistantData_v2");if(!t)return;let i;try{const e=Ga.decompressFromUTF16(t);e?i=JSON.parse(e):i=JSON.parse(t)}catch{console.log("Migration: Parsing legacy uncompressed data..."),i=JSON.parse(t)}i.classrooms!==void 0&&i.trashBin!==void 0?(Rt(i.classrooms),Ze=i.trashBin||[],Fe={...Fe,...i.userSettings}):(Rt(i),hr())}function hr(){const t=[];Object.values(re).forEach(i=>{i.isDeleted?t.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:i.info.creationDate,type:"classroom",description:`کلاس «${i.info.name}»`,restoreData:{name:i.info.name}}):i.students.forEach(e=>{e.isDeleted&&t.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:e.identity.studentId.split("_")[1],type:"student",description:`دانش‌آموز «${e.identity.name}»`,restoreData:{studentId:e.identity.studentId,classroomName:i.info.name}})})}),Ze.length===0&&t.length>0&&(Ze=t,console.log(`Migrated ${t.length} previously deleted item(s) to the new trash bin.`),oe())}function Qa(t){const i=new Bn(t.identity);return i.isDeleted=t.isDeleted,i.statusCounters=t.statusCounters,i.logs=t.logs,i.logs.scores||(i.logs.scores={}),i.profile=t.profile,i.finalClassActivityScore=t.finalClassActivityScore,i.categoryCounts=t.categoryCounts||{},i.categoryIssues=t.categoryIssues||{},i.qualitativeStats=t.qualitativeStats||{},i.onboardingSession=t.onboardingSession||null,i}function Rt(t){re={};for(const i in t){const e=t[i];let l;e.info?l=e.info:l={...e,name:i};const a=new Ls(l);a.isDeleted=e.isDeleted,a.note=e.note||"",a.students=(e.students||[]).map(Qa),a.sessions=(e.sessions||[]).map(n=>{const r=new Ua(n.sessionNumber);r.isDeleted=n.isDeleted,r.note=n.note||"",r.startTime=new Date(n.startTime),r.createdAt=n.createdAt?new Date(n.createdAt):new Date(n.startTime),r.endTime=n.endTime?new Date(n.endTime):null,r.isFinished=n.isFinished,r.isMakeup=n.isMakeup,r.isCancelled=n.isCancelled||!1,r.studentRecords=n.studentRecords;for(const o in r.studentRecords){const c=r.studentRecords[o];c.homework&&!(c.homework instanceof xs)&&(r.studentRecords[o].homework=new xs(c.homework.status,c.homework.comment))}r.lastWinnerByCategory=n.lastWinnerByCategory,r.lastUsedCategoryId=n.lastUsedCategoryId,r.lastSelectedWinnerId=n.lastSelectedWinnerId;const s=n.winnerHistory||[];return r.winnerHistory=s.filter(o=>o&&o.winner).map(o=>({winner:a.students.find(m=>m.identity.studentId===o.winner.identity.studentId),categoryName:o.categoryName,rating:o.rating||null})).filter(o=>o.winner),r}),a.categories=(e.categories||[]).map(n=>{const r=new yt(n.name,n.description,n.isGradedCategory,n.weight||1);return r.id=n.id,r.isDeleted=n.isDeleted,r}),a.futurePlans=e.futurePlans,re[i]=a}}function ei(t,i){if(i)Rt(t.data.classrooms),da(t.data.trashBin||[]);else{const e=t.data.classrooms,l=t.data.trashBin||[],a=new Map;for(const r in re){const s=re[r];s.info&&s.info.scheduleCode&&a.set(s.info.scheduleCode,r)}for(const r in e){const s=e[r],o=s.info.scheduleCode;if(a.has(o)){const c=a.get(o);c!==s.info.name&&delete re[c],re[s.info.name]=s}else{let c=s.info.name;for(;re[c];)c=`${c} (Imported)`;c!==s.info.name&&(s.info.name=c),re[c]=s}}const n=new Set(Ze.map(r=>r.id));l.forEach(r=>{n.has(r.id)||Ze.push(r)}),Rt(re)}t.data.userSettings&&wt(t.data.userSettings),wt({lastRestoreTimestamp:new Date().toISOString()}),oe()}function ti(t,i){if(re[i])return{success:!1,message:"کلاسی با این نام از قبل وجود دارد."};const e=re[t];return e?(e.info.name=i,re[i]=e,delete re[t],A===e&&qe(e),{success:!0}):{success:!1,message:"کلاس مورد نظر یافت نشد."}}function ni(t,i,e){const l=e.trim();if(!l)return{success:!1,message:"نام دسته‌بندی نمی‌تواند خالی باشد."};if(t.categories.some(o=>o.id!==i.id&&!o.isDeleted&&o.name.toLowerCase()===l.toLowerCase()))return{success:!1,message:"دسته‌بندی دیگری با این نام وجود دارد."};const n=i.name,r=n.toLowerCase(),s=l.toLowerCase();return i.name=l,t.students.forEach(o=>{o.categoryCounts&&o.categoryCounts[n]!==void 0&&(o.categoryCounts[l]=o.categoryCounts[n],delete o.categoryCounts[n]),o.categoryIssues&&o.categoryIssues[n]!==void 0&&(o.categoryIssues[l]=o.categoryIssues[n],delete o.categoryIssues[n]),o.logs.scores&&o.logs.scores[r]&&(o.logs.scores[r].forEach(c=>c.skill=l),r!==s&&(o.logs.scores[s]=o.logs.scores[r],delete o.logs.scores[r]))}),t.sessions.forEach(o=>{o.lastWinnerByCategory&&o.lastWinnerByCategory[n]&&(o.lastWinnerByCategory[l]=o.lastWinnerByCategory[n],delete o.lastWinnerByCategory[n]),o.winnerHistory&&o.winnerHistory.forEach(c=>{c.categoryName===n&&(c.categoryName=l)})}),{success:!0}}function si(t,i,e){if(we(e.students).some(c=>c.identity.name.toLowerCase()===t.identity.name.toLowerCase()))return{success:!1,message:`دانش‌آموزی با نام «${t.identity.name}» از قبل در کلاس «${e.info.name}» وجود دارد.`};const a=JSON.parse(JSON.stringify(t)),n=Qa(a),r=new Map;i.sessions.forEach(c=>{const m=c.studentRecords[t.identity.studentId];m&&r.set(c.sessionNumber,JSON.parse(JSON.stringify(m)))}),e.addStudent(n);try{const c=we(e.sessions).filter(v=>!v.isCancelled).sort((v,b)=>b.sessionNumber-v.sessionNumber),m=c.length>0?c[0]:null;let p="؟",u={type:"system",description:"Student Move"};m&&(p=ot(e).get(m.sessionNumber)||m.sessionNumber,u={type:"fromSession",sessionNumber:m.sessionNumber});const h=new Date().toLocaleDateString("fa-IR"),y=i.info.name,f=`این دانش آموز در جلسه ${p} و در تاریخ ${h} از کلاس «${y}» به این کلاس انتقال پیدا کرد`;n.addNote(f,u)}catch(c){console.error("Failed to add automated move note:",c)}r.size>0&&e.sessions.forEach(c=>{const m=r.get(c.sessionNumber);m&&!c.isDeleted&&!c.isCancelled&&(c.studentRecords[n.identity.studentId]=m)});const s={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`(انتقال) دانش‌آموز «${t.identity.name}» از کلاس «${i.info.name}»`,restoreData:{studentId:t.identity.studentId,classId:i.info.scheduleCode}};lt(s);const o=i.students.find(c=>c.identity.studentId===t.identity.studentId);return o&&(o.isDeleted=!0),{success:!0}}function ai(){for(const t in re){const i=re[t];i.students.forEach(e=>{e.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0},e.categoryCounts={},e.categoryIssues={},i.sessions.forEach(l=>{const a=e.identity.studentId;l.studentRecords[a]&&(l.studentRecords[a].attendance="present")})})}oe()}function we(t){return Array.isArray(t)?t.filter(i=>!i.isDeleted):[]}function ot(t){const i=new Map;return t&&we(t.sessions).filter(l=>!l.isCancelled).sort((l,a)=>l.sessionNumber-a.sessionNumber).forEach((l,a)=>{i.set(l.sessionNumber,a+1)}),i}function vt(t){Ve=t}function dt(t){ta=t}function ds(t,i){if(!t||!i)return;const e=t.identity.studentId,l=i.students.findIndex(a=>a.identity.studentId===e);l>-1&&i.students.splice(l,1),i.sessions.forEach(a=>{a.studentRecords[e]&&delete a.studentRecords[e];for(const n in a.lastWinnerByCategory)a.lastWinnerByCategory[n]===e&&delete a.lastWinnerByCategory[n];a.lastSelectedWinnerId===e&&(a.lastSelectedWinnerId=null),a.winnerHistory=a.winnerHistory.filter(n=>n.winner&&n.winner.identity.studentId!==e)})}function sa(t,i){const e=re[t];if(!e)return;const l=e.sessions.findIndex(a=>a.sessionNumber===i);l>-1&&(e.students.forEach(a=>{a.profile.notes&&a.profile.notes.length>0&&(a.profile.notes=a.profile.notes.filter(n=>!n.source||n.source.type!=="fromAttendance"||n.source.sessionNumber!==i)),a.onboardingSession===i&&(a.onboardingSession=null)}),e.sessions.splice(l,1))}function aa(t,i){const e=re[t];if(!e)return;const l=e.categories.findIndex(s=>s.id===i);if(l===-1)return;const n=e.categories[l].name,r=n.toLowerCase();e.students.forEach(s=>{s.categoryCounts&&delete s.categoryCounts[n],s.categoryIssues&&delete s.categoryIssues[n],s.logs.scores&&delete s.logs.scores[r]}),e.sessions.forEach(s=>{s.lastWinnerByCategory[n]&&delete s.lastWinnerByCategory[n],s.winnerHistory=s.winnerHistory.filter(o=>o.categoryName!==n)}),e.categories.splice(l,1)}function ia(t,i,e,l){const a=re[t];if(!a)return;const n=a.students.find(o=>o.identity.studentId===i);if(!n||!n.logs.scores[e.toLowerCase()])return;const r=n.logs.scores[e.toLowerCase()],s=r.findIndex(o=>o.id===l);s>-1&&r.splice(s,1)}function ra(t,i,e){const l=re[t];if(!l)return;const a=l.students.find(r=>r.identity.studentId===i);if(!a||!a.profile.notes)return;const n=a.profile.notes.findIndex(r=>r.id===e);n>-1&&a.profile.notes.splice(n,1)}function ii(){JSON.parse(JSON.stringify({classrooms:re,trashBin:Ze})),mt=!0}function ri(){mt=!1,Yn()}function lt(t){for(Ze.unshift(t);Ze.length>50;){const i=Ze.pop();oi(i)}oe()}function oi(t){var i;if(!(!t||!t.restoreData))switch(console.log(`🗑️ Auto-cleaning overflow item: ${t.description}`),t.type){case"classroom":t.restoreData.name&&re[t.restoreData.name]&&delete re[t.restoreData.name];break;case"student":(i=t.restoreData.identity)!=null&&i.studentId&&ds(t.restoreData.identity.studentId);break;case"session":t.restoreData.id&&sa(t.restoreData.id);break;case"category":t.restoreData.id&&aa(t.restoreData.id);break;case"score":ia(t.restoreData);break;case"note":t.restoreData.id&&ra(t.restoreData.id);break}}function qe(t){A=t}function hn(t){Vs=t}function Xe(t){J=t}function et(t){_e=t}function Xn(t){mn=t}function ci(t){ls=t}function tn(t){Js=t}function Nn(t){jn=t}function li(t){Ks=t}function Qn(t){Re=t}function Dn(t){qn=t}function di(t){Ys=t}function An(t){Zn=t}function ui(t){Xs=t}function oa(t){Qs=t}function ca(t){ea=t}function pn(t){Gn=t}function la(t){St=t}function Gt(t){Jn=t}function fi(t){Va=t}function mi(t){Ja=t}function da(t){Ze=t}function gn(t){Vn=t}function yn(t){Mt=t}function wt(t){Fe={...Fe,...t},oe()}function On(t){it=t}function ua(){Fe.lastBackupTimestamp=new Date().toISOString(),oe()}function es(t){Kn=t}function pr(){Ka.clear()}function gr(t){rt=t}function yr(){rt={}}function fa(t,i){rt[t]||(rt[t]={toBeScored:[],scoredThisSession:[]}),rt[t].scoredThisSession.includes(i)||rt[t].scoredThisSession.push(i)}const $a=Object.freeze(Object.defineProperty({__proto__:null,get activeModal(){return St},addToTrashBin:lt,get assessmentPools(){return rt},assessmentSessionExclusions:Ka,get cancelCallback(){return ea},get classrooms(){return re},get confirmCallback(){return Qs},get currentClassroom(){return A},get datePickerCallback(){return Kn},get easterEggClickCount(){return qn},get easterEggLastClickTime(){return Ys},enterDemoMode:ii,exitDemoMode:ri,getActiveItems:we,getSessionDisplayMap:ot,get importedFileContent(){return jn},get isAssessmentModeActive(){return Tt},get isDemoMode(){return mt},get liveSession(){return Vs},loadData:Yn,get manualSelection(){return Jn},markStudentAsScoredInSession:fa,moveStudent:si,get namesToImport(){return Js},get notificationTimeout(){return Ks},permanentlyDeleteCategory:aa,permanentlyDeleteFromTrash:oi,permanentlyDeleteNote:ra,permanentlyDeleteScore:ia,permanentlyDeleteSession:sa,permanentlyDeleteStudent:ds,prepareBackupData:Xa,get previousState(){return mn},processRestore:ei,rehydrateData:Rt,renameCategory:ni,renameClassroom:ti,resetAllStudentCounters:ai,resetAssessmentExclusions:pr,resetAssessmentPools:yr,get resetEasterEggClickCount(){return Zn},get resetEasterEggLastClickTime(){return Xs},get saveCategoryCallback(){return Vn},saveData:oe,get saveNoteCallback(){return ta},get secureConfirmCallback(){return Gn},get selectedCategory(){return Re},get selectedClassIds(){return it},get selectedSession(){return J},get selectedStudentForProfile(){return _e},get selectedStudentsForMassComment(){return Mt},setActiveModal:la,setAssessmentPools:gr,setCancelCallback:ca,setConfirmCallback:oa,setCurrentClassroom:qe,setDatePickerCallback:es,setEasterEggClickCount:Dn,setEasterEggLastClickTime:di,setImportedFileContent:Nn,setIsAssessmentModeActive:Ya,setLastBackupTimestamp:ua,setLiveSession:hn,setManualSelection:Gt,setNamesToImport:tn,setNotificationTimeout:li,setPreviousState:Xn,setResetEasterEggClickCount:An,setResetEasterEggLastClickTime:ui,setSaveCategoryCallback:gn,setSaveNoteCallback:dt,setSecureConfirmCallback:pn,setSelectedCategory:Qn,setSelectedClassIds:On,setSelectedSession:Xe,setSelectedStudentForProfile:et,setSelectedStudentsForMassComment:yn,setSourceClassForMove:mi,setStudentToMove:fi,setTrashBin:da,setUndoTimeout:ci,setUserSettings:wt,setWinnerHistoryIndex:vt,get sourceClassForMove(){return Ja},get studentToMove(){return Va},get trashBin(){return Ze},get undoTimeout(){return ls},get userSettings(){return Fe},get winnerHistoryIndex(){return Ve}},Symbol.toStringTag,{value:"Module"})),vr="TeacherAssistantDB",br=1,ht="backups";function ma(){return new Promise((t,i)=>{const e=indexedDB.open(vr,br);e.onupgradeneeded=l=>{const a=l.target.result;a.objectStoreNames.contains(ht)||a.createObjectStore(ht,{keyPath:"id"})},e.onsuccess=l=>t(l.target.result),e.onerror=l=>i(l.target.error)})}async function hi(t,i){const e=await ma(),l=e.transaction(ht,"readwrite"),a=l.objectStore(ht),n={id:Date.now(),file:t,metadata:i,timestamp:new Date().toISOString()};a.add(n),l.oncomplete=()=>{const s=e.transaction(ht,"readwrite").objectStore(ht),o=s.count();o.onsuccess=()=>{if(o.result>10){const c=s.getAllKeys();c.onsuccess=()=>{const m=c.result;for(;m.length>10;){const p=m.shift();s.delete(p),console.log(`♻️ Auto-deleted old backup snapshot: ${p}`)}}}}}}async function pi(){const t=await ma();return new Promise((i,e)=>{const n=t.transaction(ht,"readonly").objectStore(ht).getAll();n.onsuccess=()=>{const r=n.result.sort((s,o)=>o.id-s.id);i(r)},n.onerror=()=>e(n.error)})}async function Cr(t){(await ma()).transaction(ht,"readwrite").objectStore(ht).delete(t)}const wr=Object.freeze(Object.defineProperty({__proto__:null,addBackupSnapshot:hi,deleteBackupSnapshot:Cr,getBackupSnapshots:pi},Symbol.toStringTag,{value:"Module"}));function je(t){return typeof t!="string"?"":t.replace(/ي/g,"ی").replace(/ك/g,"ک").replace(/[\s\u200c]/g,"")}function us(t){return typeof t!="string"||t.length===0?"ltr":/[\u0590-\u07FF]/.test(t)?"rtl":"ltr"}function ha(t){return!t||!t.trim()?"":t.split(`
`).map(l=>`<div dir="${us(l)}">${l||"&nbsp;"}</div>`).join("")}function Mn(t){if(typeof t!="string")return"";const i={q:"ض",w:"ص",e:"ث",r:"ق",t:"ف",y:"غ",u:"ع",i:"ه",o:"خ",p:"ح","[":"ج","]":"چ",a:"ش",s:"س",d:"ی",f:"ب",g:"ل",h:"ا",j:"ت",k:"ن",l:"م",";":"ک","'":"گ",z:"ظ",x:"ط",c:"ز",v:"ر",b:"ذ",n:"د",m:"پ",",":"و"};let e="";for(let l=0;l<t.length;l++){const a=t[l].toLowerCase();e+=i[a]||t[l]}return e}function cn(t){if(!t||typeof t!="string")return{name:"",firstName:"",lastName:""};const i=t.split(".").map(e=>e.trim());if(i.length>1){const e=i[0],l=i.slice(1).join(" ");return{firstName:e,lastName:l,name:`${e} ${l}`.trim()}}return{name:t.trim(),firstName:"",lastName:""}}let _s=null;function Ts(){if(!Fe.isSoundEnabled)return;const t=window.AudioContext||window.webkitAudioContext;if(!t)return;_s||(_s=new t);const i=_s,e=()=>{const l=i.createOscillator(),a=i.createGain();l.connect(a),a.connect(i.destination),l.type="sine";const n=i.currentTime;l.frequency.setValueAtTime(450,n),a.gain.setValueAtTime(0,n),a.gain.linearRampToValueAtTime(.3,n+.002),a.gain.exponentialRampToValueAtTime(.001,n+.025),a.gain.linearRampToValueAtTime(0,n+.03),l.start(n),l.stop(n+.04)};i.state==="suspended"?i.resume().then(()=>{e()}).catch(l=>console.error("Audio resume failed:",l)):e()}function En(t){const i=t.filter(a=>a.identity.firstName&&a.identity.lastName),e=t.filter(a=>(!a.identity.firstName||!a.identity.lastName)&&typeof a.identity.name=="string"),l=t.filter(a=>(!a.identity.firstName||!a.identity.lastName)&&!a.identity.name);return i.sort((a,n)=>{const r=a.identity.lastName.localeCompare(n.identity.lastName,"fa");return r!==0?r:a.identity.firstName.localeCompare(n.identity.firstName,"fa")}),e.sort((a,n)=>a.identity.name.localeCompare(n.identity.name,"fa")),[...i,...e,...l]}function gi(t,i){let e=0;t.addEventListener("dblclick",i),t.addEventListener("touchend",l=>{const a=new Date().getTime(),n=a-e;n<400&&n>0&&(l.preventDefault(),i(l)),e=a})}const Er=Object.freeze(Object.defineProperty({__proto__:null,detectTextDirection:us,normalizeKeyboard:Mn,normalizeText:je,parseStudentName:cn,playSuccessSound:Ts,renderMultiLineText:ha,setupDoubleAction:gi,sortStudents:En},Symbol.toStringTag,{value:"Module"})),yi="teacherAssistantLogs_v2",Sr=100;function pa(){try{const t=localStorage.getItem(yi);return t?JSON.parse(t):{}}catch(t){return console.error("Error reading logs from localStorage:",t),{}}}function vi(t){try{localStorage.setItem(yi,JSON.stringify(t))}catch(i){console.error("Error saving logs to localStorage:",i)}}function ke(t,i,e=null){if(!t)return;const l=pa();l[t]||(l[t]=[]);const a={timestamp:new Date().toISOString(),message:i,action:e,classroomName:t};l[t].unshift(a),l[t].length>Sr&&l[t].pop(),vi(l)}function kr(t){return pa()[t]||[]}function _r(t,i){const e=pa();e[t]&&!e[i]&&(e[i]=e[t],delete e[t],vi(e))}var za={toJalaali:Ir,toGregorian:bi,isValidJalaaliDate:xr,isLeapJalaaliYear:Ci,jalaaliMonthLength:wi,jalCal:ga,j2d:ts,d2j:ns,g2d:fs,d2g:ya,jalaaliToDateObject:Ei,jalaaliWeek:Tr},Et=[-61,9,38,199,426,686,756,818,1111,1181,1210,1635,2060,2097,2192,2262,2324,2394,2456,3178];function Ir(t,i,e){return Object.prototype.toString.call(t)==="[object Date]"&&(e=t.getDate(),i=t.getMonth()+1,t=t.getFullYear()),ns(fs(t,i,e))}function bi(t,i,e){return ya(ts(t,i,e))}function xr(t,i,e){return t>=-61&&t<=3177&&i>=1&&i<=12&&e>=1&&e<=wi(t,i)}function Ci(t){return Lr(t)===0}function wi(t,i){return i<=6?31:i<=11||Ci(t)?30:29}function Lr(t){var i=Et.length,e=Et[0],l,a,n,r,s;if(t<e||t>=Et[i-1])throw new Error("Invalid Jalaali year "+t);for(s=1;s<i&&(l=Et[s],a=l-e,!(t<l));s+=1)e=l;return r=t-e,a-r<6&&(r=r-a+Ne(a+4,33)*33),n=tt(tt(r+1,33)-1,4),n===-1&&(n=4),n}function ga(t,i){var e=Et.length,l=t+621,a=-14,n=Et[0],r,s,o,c,m,p,u;if(t<n||t>=Et[e-1])throw new Error("Invalid Jalaali year "+t);for(u=1;u<e&&(r=Et[u],s=r-n,!(t<r));u+=1)a=a+Ne(s,33)*8+Ne(tt(s,33),4),n=r;return p=t-n,a=a+Ne(p,33)*8+Ne(tt(p,33)+3,4),tt(s,33)===4&&s-p===4&&(a+=1),c=Ne(l,4)-Ne((Ne(l,100)+1)*3,4)-150,m=20+a-c,i?{gy:l,march:m}:(s-p<6&&(p=p-s+Ne(s+4,33)*33),o=tt(tt(p+1,33)-1,4),o===-1&&(o=4),{leap:o,gy:l,march:m})}function ts(t,i,e){var l=ga(t,!0);return fs(l.gy,3,l.march)+(i-1)*31-Ne(i,7)*(i-7)+e-1}function ns(t){var i=ya(t).gy,e=i-621,l=ga(e,!1),a=fs(i,3,l.march),n,r,s;if(s=t-a,s>=0){if(s<=185)return r=1+Ne(s,31),n=tt(s,31)+1,{jy:e,jm:r,jd:n};s-=186}else e-=1,s+=179,l.leap===1&&(s+=1);return r=7+Ne(s,30),n=tt(s,30)+1,{jy:e,jm:r,jd:n}}function fs(t,i,e){var l=Ne((t+Ne(i-8,6)+100100)*1461,4)+Ne(153*tt(i+9,12)+2,5)+e-34840408;return l=l-Ne(Ne(t+100100+Ne(i-8,6),100)*3,4)+752,l}function ya(t){var i,e,l,a,n;return i=4*t+139361631,i=i+Ne(Ne(4*t+183187720,146097)*3,4)*4-3908,e=Ne(tt(i,1461),4)*5+308,l=Ne(tt(e,153),5)+1,a=tt(Ne(e,153),12)+1,n=Ne(i,1461)-100100+Ne(8-a,6),{gy:n,gm:a,gd:l}}function Tr(t,i,e){var l=Ei(t,i,e).getDay(),a=l==6?0:-(l+1),n=6+a;return{saturday:ns(ts(t,i,e+a)),friday:ns(ts(t,i,e+n))}}function Ei(t,i,e,l,a,n,r){var s=bi(t,i,e);return new Date(s.gy,s.gm-1,s.gd,l||0,a||0,n||0,r||0)}function Ne(t,i){return~~(t/i)}function tt(t,i){return t-~~(t/i)*i}const Si=document.getElementById("class-management-page"),Br=document.getElementById("open-add-class-modal-btn"),Nr=document.getElementById("add-class-modal"),vn=document.getElementById("modal-new-class-name"),ss=document.getElementById("modal-add-class-system"),va=document.getElementById("modal-add-class-level"),Bs=document.getElementById("confirm-add-class-btn"),Ns=document.getElementById("cancel-add-class-btn"),Nt=document.getElementById("class-list"),as=document.getElementById("undo-toast"),ki=document.getElementById("undo-message"),Dr=document.getElementById("undo-btn"),Ar=document.getElementById("settings-page"),_i=document.getElementById("settings-class-name-header"),Ds=document.getElementById("settings-student-list"),As=document.getElementById("category-list"),Or=document.getElementById("back-to-sessions-btn"),Mr=document.getElementById("new-student-name"),Rr=document.getElementById("add-student-btn"),Ii=document.getElementById("paste-area"),$r=document.getElementById("process-paste-btn"),zr=document.getElementById("csv-preview-page"),Os=document.getElementById("csv-preview-list"),Pr=document.getElementById("csv-confirm-btn"),Fr=document.getElementById("csv-cancel-btn"),Hr=document.getElementById("import-csv-btn"),Wr=document.getElementById("csv-file-input"),Ur=document.getElementById("column-mapping-page"),Ms=document.getElementById("column-select-dropdown"),jr=document.getElementById("confirm-column-btn"),qr=document.getElementById("cancel-import-btn"),Rs=document.querySelector(".app-header"),Ye=document.getElementById("select-student-btn"),Dt=document.getElementById("select-student-btn-wrapper"),Zr=document.getElementById("assessment-mode-label"),Rn=document.getElementById("category-weight-label"),Gr=document.getElementById("attendance-page"),ln=document.getElementById("attendance-list"),Vr=document.getElementById("finish-attendance-btn"),Jr=document.querySelector("#class-management-page h2"),$s=document.getElementById("student-stats-header"),Kr=document.getElementById("hamburger-menu-btn"),Yr=document.getElementById("side-nav-menu"),Xr=document.getElementById("close-nav-btn"),Qr=document.getElementById("overlay"),eo=document.getElementById("backup-data-btn"),to=document.getElementById("restore-data-btn"),xi=document.getElementById("restore-file-input"),no=document.getElementById("custom-confirm-modal"),Li=document.getElementById("confirm-modal-message"),zs=document.getElementById("confirm-modal-cancel-btn"),nn=document.getElementById("confirm-modal-confirm-btn"),so=document.getElementById("secure-confirm-modal"),Ti=document.getElementById("secure-confirm-message"),Bi=document.getElementById("secure-confirm-code"),Ht=document.getElementById("secure-confirm-input"),ao=document.getElementById("secure-confirm-cancel-btn"),$n=document.getElementById("secure-confirm-confirm-btn"),io=document.getElementById("add-note-modal"),Se=document.getElementById("new-note-content"),ro=document.getElementById("class-save-note-btn"),oo=document.getElementById("cancel-note-btn"),Ps=document.getElementById("student-search-input"),Ct=document.getElementById("student-search-results"),co=document.getElementById("back-to-student-page-btn"),lo=document.getElementById("graded-category-pills-container"),uo=document.getElementById("new-score-value"),Ni=document.getElementById("new-score-comment"),fo=document.getElementById("add-score-btn"),mo=document.getElementById("profile-stats-summary"),ho=document.getElementById("profile-scores-list"),sn=document.getElementById("global-student-search-input"),ft=document.getElementById("global-student-search-results"),po=document.getElementById("trashed-classes-list"),go=document.getElementById("trashed-students-list"),yo=document.getElementById("trashed-sessions-list"),vo=document.getElementById("trashed-categories-list"),bo=document.getElementById("trashed-notes-list"),Co=document.getElementById("trashed-scores-list"),Ut=document.getElementById("quick-grade-form-wrapper"),pt=document.getElementById("quick-score-input"),ct=document.getElementById("quick-note-textarea"),At=document.getElementById("quick-grade-submit-btn"),dn=document.getElementById("category-selection-container"),Fs=document.getElementById("selected-student-result"),Ot=document.getElementById("custom-context-menu"),Wt=document.getElementById("breadcrumb-container"),wo=document.getElementById("report-config-modal"),Di=document.getElementById("report-columns-container"),Ai=document.getElementById("report-print-btn"),Oi=document.getElementById("report-cancel-btn");let en=null,qt=null;const Eo=document.getElementById("category-modal"),Mi=document.getElementById("category-modal-title"),Zt=document.getElementById("new-category-modal-name"),ms=document.getElementById("new-category-modal-is-graded"),So=document.getElementById("category-modal-cancel-btn"),Ri=document.getElementById("category-modal-save-btn"),ko=document.getElementById("mass-comment-modal"),_o=document.getElementById("mass-comment-modal-title"),$i=document.getElementById("mass-comment-student-count-message"),un=document.getElementById("mass-comment-content"),ba=document.getElementById("mass-comment-append-checkbox"),Io=document.getElementById("mass-comment-cancel-btn"),xo=document.getElementById("mass-comment-save-btn"),Hs=document.getElementById("mass-comment-btn"),zn=document.getElementById("attendance-mass-actions-container"),Lt=document.createElement("input"),Lo=document.getElementById("session-dashboard-page"),Vt=document.getElementById("attendance-pane"),Pn=document.getElementById("settings-edu-system"),an=document.getElementById("settings-level"),zi=document.getElementById("modal-schedule-text"),is=document.getElementById("modal-schedule-days"),Pi=document.getElementById("modal-schedule-start-time"),Fi=document.getElementById("modal-schedule-end-time"),rn=document.getElementById("modal-schedule-toggle"),Hi=document.getElementById("modal-schedule-content"),rs=document.getElementById("new-category-modal-weight"),To=document.getElementById("category-modal"),Wi=document.getElementById("new-category-modal-weight-group"),Bo=document.getElementById("open-add-category-btn");function jt(t,i,e=800){let l,a=e;const n=s=>{l=setTimeout(()=>{Fe.isVibrationEnabled&&navigator.vibrate&&navigator.vibrate(50),i(s)},a)},r=()=>{clearTimeout(l)};t.addEventListener("touchstart",n,{passive:!0}),t.addEventListener("touchend",r),t.addEventListener("touchmove",r),t.addEventListener("mousedown",n),t.addEventListener("mouseup",r),t.addEventListener("mouseleave",r)}function Jt(t="selector"){if(!A||!J){ye("class-management-page");return}Mo(),Hn(),$e(),nt(),ye("session-dashboard-page",{tab:t}),Ui(),Kt(t),Ro()}function Kt(t){const i=document.getElementById("selector-tab-btn"),e=document.getElementById("attendance-tab-btn"),l=document.getElementById("selector-pane"),a=t==="selector";i.classList.toggle("active",a),e.classList.toggle("active",!a),l.classList.toggle("active",a),Vt.classList.toggle("active",!a)}function Ui(){const t=document.getElementById("selector-tab-btn"),i=document.getElementById("attendance-tab-btn"),e=document.getElementById("selector-pane");t.addEventListener("click",()=>{$e(),Ae(),t.classList.add("active"),i.classList.remove("active"),e.classList.add("active"),Vt.classList.remove("active"),ye("session-dashboard-page",{tab:"selector"})}),i.addEventListener("click",()=>{nt(),i.classList.add("active"),t.classList.remove("active"),Vt.classList.add("active"),e.classList.remove("active"),ye("session-dashboard-page",{tab:"attendance"})}),gi(i,l=>{Kt("attendance"),nt(),setTimeout(()=>{const a=document.getElementById("attendance-search-input");a&&a.focus()},100)})}function No(t){clearTimeout(ls),mn||Xn(JSON.stringify(re)),ki.textContent=t,as.classList.add("show"),ci(setTimeout(()=>{as.classList.remove("show"),Xn(null)},5e3))}function ji(){if(mn){const t=A?A.info.name:null,i=JSON.parse(mn);Rt(i),t&&re[t]?qe(re[t]):qe(null),A?(_t(),Xt(),Ge()):We(),as.classList.remove("show"),clearTimeout(ls),Xn(null)}}function V(t,i=3e3){const e=document.getElementById("notification-toast");e&&(e.textContent=t,e.classList.add("show"),clearTimeout(Ks),li(setTimeout(()=>{e.classList.remove("show")},i)))}function os(t){var v;const i=document.getElementById("restore-confirm-modal"),e=document.getElementById("restore-modal-message"),l=document.getElementById("restore-append-checkbox"),a=document.querySelector('label[for="restore-append-checkbox"]'),n=document.getElementById("restore-confirm-cancel-btn"),r=document.getElementById("restore-confirm-confirm-btn"),s=document.getElementById("restore-modal-warning");s.style.display="none";const o=((v=t.metadata)==null?void 0:v.createdAt)||0;if(Fe.lastRestoreTimestamp&&o<Fe.lastRestoreTimestamp){const b=new Date(o).toLocaleDateString("fa-IR"),C=new Date(Fe.lastRestoreTimestamp).toLocaleDateString("fa-IR");s.textContent=`⚠️ هشدار: این فایل پشتیبان (${b}) قدیمی‌تر از آخرین بازیابی شما (${C}) است.`,s.style.display="block"}const c=t.data.classrooms||{},m=Object.values(c).map(b=>b.info.name),p=m.length,u="کلاس",h=m.map(b=>`<li style="margin-bottom: 4px;">🔹 ${b}</li>`).join("");e.innerHTML=`
        <div style="margin-bottom: 10px;">
            فایل پشتیبان شامل <strong>${p} ${u}</strong> زیر است:
        </div>
        <ul style="
            margin: 0; 
            padding: 10px; 
            background-color: #f8f9fa; 
            border-radius: 5px; 
            border: 1px solid #e9ecef;
            list-style: none; 
            max-height: 150px; 
            overflow-y: auto;
            text-align: right;
        ">
            ${h}
        </ul>
        <div style="margin-top: 15px;">
            لطفاً نحوه بازیابی را مشخص کنید.
        </div>
    `,l.checked=!1,a&&(a.textContent="جایگزینی کامل (حذف داده‌های فعلی)");const y=()=>{const b=l.checked;ei(t,b),r.onclick=null,n.onclick=null,i.removeEventListener("click",y),ge(),We(),ye("class-management-page"),V(`✅ اطلاعات با موفقیت بازیابی شد (${b?"پاک‌سازی و بازیابی":"همگام‌سازی هوشمند"}).`)},f=()=>{r.onclick=null,n.onclick=null,ge()};r.onclick=y,n.onclick=f,ze("restore-confirm-modal")}function be(t,i,e={}){const{confirmText:l="تایید",cancelText:a="لغو",confirmClass:n="btn-success",onCancel:r=()=>{},isDelete:s=!1}=e,o=s?()=>qi(t,i):i;Li.innerHTML=t.replace(/\n/g,"<br>"),nn.textContent=l,zs.textContent=a,nn.className="modal-action-btn",nn.classList.add(n),oa(o),ca(r);const c=nn.parentElement;zs.style.display=r===null?"none":"inline-block",c.style.justifyContent=r===null?"center":"space-between",ze("custom-confirm-modal")}function qi(t,i){const e=Math.floor(1e4+Math.random()*9e4).toString();Ti.textContent=t,Bi.textContent=e,Ht.value="",$n.disabled=!0,pn(i),ze("secure-confirm-modal"),Ht.focus();const l=()=>{Ht.value===e?$n.disabled=!1:$n.disabled=!0};return Ht.addEventListener("input",l),()=>{Ht.removeEventListener("input",l)}}function Ws(t,i={}){const{title:e="ایجاد دسته‌بندی جدید",initialName:l="",initialIsGraded:a=!1,initialWeight:n=1,saveButtonText:r="ذخیره"}=i;Mi.textContent=e,Zt.value=l,ms.checked=a,rs.value=n,Ri.textContent=r,gn((s,o)=>{const c=parseFloat(rs.value)||1;if(!s){V("⚠️ لطفاً نام دسته‌بندی را وارد کنید.");return}t(s,o,c),ge()}),ze("category-modal"),Zt.focus(),l&&Zt.select()}function Ca(t,i){const e=Object.values(re).filter(r=>!r.isDeleted&&r.info.name!==i.info.name),l=document.getElementById("move-student-modal-title"),a=document.getElementById("move-student-class-select"),n=document.getElementById("move-student-confirm-btn");l.textContent=`انتقال دانش‌آموز: ${t.identity.name}`,a.innerHTML="",e.length===0?(a.innerHTML='<option value="">کلاس دیگری برای انتقال وجود ندارد</option>',n.disabled=!0):(e.forEach(r=>{const s=document.createElement("option");s.value=r.info.name,s.textContent=r.info.name,a.appendChild(s)}),n.disabled=!1),fi(t),mi(i),ze("move-student-modal")}function wa(t,i){if(!t||!i)return;const e=t.identity.name,l=t.identity.firstName||"";t.identity.lastName;const a=document.getElementById("add-note-modal-title");a.textContent="تغییر نام دانش‌ آموز";const n=t.identity.firstName&&t.identity.lastName?`${t.identity.firstName} . ${t.identity.lastName}`:e;Se.value=n,Se.rows=1,Se.dispatchEvent(new Event("input",{bubbles:!0})),dt(r=>{const s=r.indexOf(".");if(s<=0||s>=r.length-1)return V("لطفا نام و نام خانوادگی شخص را با یک نقطه از هم جدا کنید. مثال: علی . احمدی"),!1;const o=cn(r),c=o.name,m=o.firstName||"";if(t.identity.firstName&&t.identity.lastName&&!o.firstName)return V("⚠️ این دانش‌آموز دارای نام و نام‌خانوادگی تفکیک شده است. لطفاً حتماً از نقطه (.) بین نام و نام‌خانوادگی استفاده کنید."),!1;if(c&&(c!==e||m!==l)){if(we(i.students).some(f=>f.identity.studentId!==t.identity.studentId&&f.identity.name.toLowerCase()===c.toLowerCase()))return V("دانش‌آموزی با این نام از قبل در این کلاس وجود دارد."),!1;{t.identity.name=c,t.identity.firstName=o.firstName,t.identity.lastName=o.lastName,ke(i.info.name,`نام دانش‌آموز «${e}» به «${c}» تغییر یافت.`,{type:"VIEW_STUDENT_PROFILE",studentId:t.identity.studentId}),oe(),_t(),$e(),nt(),Ae(),_e&&_e.identity.studentId===t.identity.studentId&&He(t);const f=document.querySelector(`#settings-student-list li[data-student-id="${t.identity.studentId}"]`);f&&(f.classList.add("recently-updated"),setTimeout(()=>{f&&f.classList.remove("recently-updated")},1e4),f.scrollIntoView({behavior:"smooth",block:"center"})),V(`✅ نام دانش‌آموز به «${c}» تغییر یافت.`)}}else if(!c)return V("⚠️ نام نمی‌تواند خالی باشد."),!1;const h=document.getElementById("add-note-modal-title");h.textContent="ثبت یادداشت جدید",Se.rows=4}),ze("add-note-modal"),Se.focus(),Se.select()}function ze(t){const i=document.getElementById(t);if(i){if(St)return;i.classList.add("modal-visible"),la(t),history.pushState(null,"",location.href)}}function ge(t,i=!1){if(!St)return;const e=document.getElementById(St),l=St;la(null),l==="student-profile-modal"&&et(null),i||history.back(),e&&(e.classList.add("modal-closing"),setTimeout(()=>{e.classList.remove("modal-visible"),e.classList.remove("modal-closing"),l==="custom-confirm-modal"&&(oa(null),ca(null)),l==="secure-confirm-modal"&&pn(null),l==="category-modal"&&gn(null),l==="mass-comment-modal"&&(un.value=""),l==="add-note-modal"&&dt(null),typeof t=="function"&&t()},300))}function Ea(){if(!Vt||!Vt.classList.contains("active")){zn.style.display="none";return}const t=Mt.length;t<1?zn.style.display="none":zn.style.display="block",Hs.disabled=t<1,Hs.textContent=`📝 ثبت یادداشت گروهی (${t} نفر)`}function Sa(){const t=Mt,i=t.length;let e=!1;i>0&&(e=t.some(a=>{var n;return(n=J.studentRecords[a])==null?void 0:n.homework.comment})),$i.textContent=`یادداشت برای ${i} دانش‌آموز ثبت خواهد شد.`,un.value="",un.dispatchEvent(new Event("input",{bubbles:!0})),ba.checked=!0;const l=document.querySelector("#mass-comment-modal .modal-options");l.style.display=e?"flex":"none",ze("mass-comment-modal"),un.focus()}function Us(t,i){if(!A||!J)return;let e=0;const l=Mt,a=J;l.forEach(n=>{const r=a.studentRecords[n];if(r&&r.homework){const s=r.homework.comment||"";let o=t;i&&s.length>0?o=s+`
---
`+t:o=t,r.homework.comment=o.trim();const c=A.students.find(m=>m.identity.studentId===n);c&&Do(c,a,o.trim()),e++}}),yn([]),oe(),nt(),ke(A.info.name,`${e} دانش‌آموز به صورت گروهی یادداشت تکلیف گرفتند.`,{type:"VIEW_SESSIONS"}),V(`✅ یادداشت برای ${e} دانش‌آموز ثبت شد.`)}function Do(t,i,e){const a=ot(A).get(i.sessionNumber),n={type:"fromAttendance",sessionNumber:i.sessionNumber},r=`یادداشت جلسه ${a}:
`,s=t.profile.notes.find(o=>!o.isDeleted&&o.source&&o.source.type==="fromAttendance"&&o.source.sessionNumber===n.sessionNumber);s?e?(s.content=r+e,s.isDeleted=!1):s.isDeleted=!0:e&&t.addNote(r+e,n)}function hs(t){Se.value=t.note||"",dt(i=>{t.note=i,oe(),ke(t.info.name,"یادداشت کلاس ذخیره شد.",{type:"VIEW_CLASS_NOTE"}),We(),V("✅ یادداشت کلاس ذخیره شد.")}),ze("add-note-modal"),Se.focus()}function ka(t,i){Se.value=t.note||"",Se.dispatchEvent(new Event("input",{bubbles:!0})),dt(e=>{t.note=e,oe(),ke(A.info.name,`یادداشت جلسه ${i} ذخیره شد.`,{type:"VIEW_SESSIONS"}),Ge(),V("✅یادداشت جلسه ذخیره شد.")}),ze("add-note-modal"),Se.focus()}function kt(t){qe(t),_i.textContent=`تنظیمات کلاس: ${t.info.name}`,_t(),Xt(),Qi(),ye("settings-page")}function Zi(t){const i=document.getElementById("log-modal-title"),e=document.getElementById("log-list");i.textContent=`گزارش فعالیت‌های کلاس: ${t}`,e.innerHTML="";const l=kr(t);l.length===0?e.innerHTML='<li class="no-content-message">هنوز فعالیتی برای این کلاس ثبت نشده است.</li>':l.forEach(a=>{const n=document.createElement("li");n.className="log-entry";const r=new Date(a.timestamp),s=`${r.toLocaleDateString("fa-IR")} - ${r.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}`,o=document.createElement("span");o.className="log-timestamp",o.textContent=s;const c=document.createElement("span");c.className="log-message",c.textContent=a.message,a.action&&(c.classList.add("log-action-link"),c.dataset.action=JSON.stringify({...a.action,classroomName:a.classroomName})),n.appendChild(o),n.appendChild(c),e.appendChild(n)}),ze("log-modal")}document.getElementById("log-modal-close-btn").addEventListener("click",()=>{ge()});function js(t){const i=URL.createObjectURL(t),e=document.createElement("a");e.href=i,e.download=t.name,document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(i),setTimeout(()=>{be("آیا فایل پشتیبان با موفقیت ذخیره شد؟",()=>{ua(),ps(),V("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله، ذخیره شد",cancelText:"خیر",confirmClass:"btn-success"})},500)}async function bn(t=[]){const i=await Xa(t);if(!i){V("❌ خطا در ایجاد فایل پشتیبان.");return}let e="پشتیبان کامل سیستم";if(t.length>0){const a=t.join("، ");e=`${t.length===1?"پشتیبان کلاس:":"پشتیبان کلاس‌های:"} ${a}`}hi(i,{name:i.name,description:e,version:"2.0-b64"}).catch(a=>console.error("Failed to save local snapshot:",a)),("ontouchstart"in window||navigator.maxTouchPoints>0)&&navigator.share&&navigator.canShare&&navigator.canShare({files:[i]})?be("فایل پشتیبان شما آماده است. آیا مایل به اشتراک‌گذاری آن هستید؟",()=>{try{navigator.share({title:i.name,text:"فایل پشتیبان داده‌های برنامه",files:[i]}).then(()=>{be("آیا فایل پشتیبان با موفقیت ارسال/ذخیره شد؟",()=>{ua(),ps(),V("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}catch(a){console.error("Error during sharing process:",a),js(i),V("⚠️خطا در فرآیند اشتراک‌گذاری. فایل در حال دانلود است.")}},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"}):(js(i),V("✅پشتیبان‌گیری با موفقیت انجام شد."))}function Sn(t,i){t.preventDefault(),Bt(),qt=t.target.closest("li"),qt&&qt.classList.add("context-menu-target"),setTimeout(()=>{const e=Ot,l=e.querySelector("ul");l.innerHTML="",i.forEach(c=>{const m=document.createElement("li");c.isSeparator?m.className="separator":(m.innerHTML=`
                    <span class="icon">${c.icon||""}</span>
                    <span class="label">${c.label}</span>
                `,c.className&&m.classList.add(c.className),m.addEventListener("click",()=>{c.action(),Bt()})),l.appendChild(m)}),e.classList.add("visible");const{offsetWidth:a,offsetHeight:n}=e,{innerHeight:r}=window,s=document.body.getBoundingClientRect();e.style.top=`${(r-n)/2}px`;const o=s.left+s.width/2;e.style.left=`${o-a/2}px`},50)}function Bt(){Ot.classList.contains("visible")&&Ot.classList.remove("visible"),qt&&(qt.classList.remove("context-menu-target"),qt=null)}function Gi(){var e;Wt.innerHTML="";const t=document.getElementById("header-settings-btn");if(!t)return;const i=[];if(i.push({label:"کلاس‌ها",handler:()=>{qe(null),Xe(null),et(null),ye("class-management-page")}}),A){i.push({label:A.info.name,handler:()=>{Xe(null),et(null),Ge(),ye("session-page")}});const l=(e=document.querySelector(".page.active"))==null?void 0:e.id;if(l==="session-page"?t.style.visibility="visible":t.style.visibility="hidden",l==="settings-page")i.push({label:"تنظیمات"});else if(J){const n=ot(A).get(J.sessionNumber)||` (#${J.sessionNumber})`;i.push({label:`جلسه ${n}`,handler:()=>{et(null),Jt("selector")}}),_e&&i.push({label:`پروفایل: ${_e.identity.name}`})}}else t.style.visibility="hidden";if(i.length<=1){Wt.style.display="none";return}Wt.style.display="flex",i.forEach((l,a)=>{const n=document.createElement("a");if(n.textContent=l.label,n.className="breadcrumb-item",a===i.length-1||!l.handler?n.classList.add("active"):n.addEventListener("click",l.handler),Wt.appendChild(n),a<i.length-1){const r=document.createElement("span");r.className="breadcrumb-separator",r.textContent="/",Wt.appendChild(r)}})}function Pa(t,i,e){e.innerHTML="";const l=A.sessions.filter(a=>{var n;return!a.isDeleted&&!a.isCancelled&&((n=a.studentRecords[t.identity.studentId])==null?void 0:n.attendance)==="absent"}).map(a=>({number:i.get(a.sessionNumber),isMakeup:a.isMakeup})).filter(a=>a.number!==void 0);l.length>0?(e.appendChild(document.createTextNode("جلسات غایب: ")),l.forEach((a,n)=>{const r=document.createElement("span");r.textContent=a.number,a.isMakeup&&r.classList.add("makeup-absence"),e.appendChild(r),n<l.length-1&&e.appendChild(document.createTextNode("، "))})):e.textContent="جلسات غایب: بدون غیبت"}function Fn(t,i,e,l={}){const{includePrefix:a=!0}=l;e.innerHTML="";const n=A.sessions.filter(r=>{if(r.isDeleted||r.isCancelled)return!1;const s=r.studentRecords[t.identity.studentId];return s&&s.homework&&(s.homework.status==="incomplete"||s.homework.status==="none")}).map(r=>({number:i.get(r.sessionNumber),status:r.studentRecords[t.identity.studentId].homework.status})).filter(r=>r.number!==void 0);n.length>0?(a&&e.appendChild(document.createTextNode("تکالیف ناقص: ")),n.forEach((r,s)=>{const o=document.createElement("span");o.textContent=r.number,r.status==="incomplete"&&o.classList.add("incomplete-homework"),e.appendChild(o),s<n.length-1&&e.appendChild(document.createTextNode("،"))})):a?e.textContent="تکالیف ناقص: ندارد":e.textContent="ندارد"}function Ao(t,i){var L,N,R;const e=document.createElement("li");e.className="attendance-list-item";const l=document.createElement("span");l.className="absence-info";const a=document.createElement("span");a.className="homework-info";const n=document.createElement("div");n.className="att-row-1";let r=!1;n.addEventListener("mousedown",()=>r=!1),n.addEventListener("touchstart",()=>r=!1,{passive:!0});const s=document.createElement("input");s.type="checkbox",s.className="mass-comment-checkbox",s.checked=Mt.includes(t.identity.studentId),s.addEventListener("change",()=>{const U=t.identity.studentId,ee=Mt;if(s.checked)ee.includes(U)||ee.push(U);else{const $=ee.indexOf(U);$>-1&&ee.splice($,1)}Ea();const I=document.getElementById("attendance-list");ee.length===0&&I.classList.contains("selection-mode-active")&&I.classList.remove("selection-mode-active")});const o=document.createElement("span");o.className="student-name",o.textContent=t.identity.firstName&&t.identity.lastName?`${t.identity.lastName}، ${t.identity.firstName}`:t.identity.name,o.addEventListener("click",U=>{if(r){U.stopPropagation(),U.preventDefault(),r=!1;return}He(t)}),jt(n,U=>{r=!0;const ee=document.getElementById("attendance-list");ee.classList.contains("selection-mode-active")||ee.classList.add("selection-mode-active"),s.checked||(s.checked=!0,s.dispatchEvent(new Event("change")))}),n.appendChild(s),n.appendChild(o);const c=document.createElement("div");c.className="att-row-2";const m=document.createElement("button");let p=!1;m.addEventListener("mousedown",()=>p=!1),m.addEventListener("touchstart",()=>p=!1,{passive:!0});const u=((L=J.studentRecords[t.identity.studentId])==null?void 0:L.attendance)||"present",h=U=>{U==="present"?(m.textContent="حاضر",m.className="attendance-status-btn present active"):(m.textContent="غایب",m.className="attendance-status-btn absent active")};h(u),m.addEventListener("click",U=>{var $;if(p){U.stopPropagation();return}const I=((($=J.studentRecords[t.identity.studentId])==null?void 0:$.attendance)||"present")==="present"?"absent":"present";J.setAttendance(t.identity.studentId,I),I==="absent"&&(J.studentRecords[t.identity.studentId].hadIssue=!1),oe(),h(I),Pa(t,i,l),$e(),er()}),jt(m,()=>{p=!0;const U=u==="present"?"absent":"present",ee=U==="present"?"حاضر":"غایب";be(`آیا مطمئن هستید که می‌خواهید وضعیت حضور تمام دانش‌آموزان را به «${ee}» تغییر دهید؟`,()=>{we(A.students).forEach(I=>{J.setAttendance(I.identity.studentId,U),U==="absent"&&(J.studentRecords[I.identity.studentId].hadIssue=!1)}),oe(),nt(),V(`✅ وضعیت تمام دانش‌آموزان به «${ee}» تغییر یافت.`)},{confirmText:"بله، اعمال کن",confirmClass:"btn-warning"})});const y=document.createElement("div");y.className="homework-controls";const f={none:"بدون تکلیف",complete:"تکلیف کامل",incomplete:"تکلیف ناقص"},v=document.createElement("button");let b=!1;v.addEventListener("mousedown",()=>b=!1),v.addEventListener("touchstart",()=>b=!1,{passive:!0});const C=((N=J.studentRecords[t.identity.studentId])==null?void 0:N.homework.status)||"none";v.className=`homework-status-btn ${C}`,v.title=f[C],v.addEventListener("click",U=>{if(b){U.stopPropagation();return}const ee=J.studentRecords[t.identity.studentId].homework,$={none:"incomplete",incomplete:"complete",complete:"none"}[ee.status];J.setHomeworkStatus(t.identity.studentId,$),oe(),v.className=`homework-status-btn ${$}`,v.title=f[$],Fn(t,i,a)}),jt(v,()=>{b=!0;const ee={none:"incomplete",incomplete:"complete",complete:"none"}[C],I=f[ee];be(`آیا از تغییر وضعیت تکلیف تمام دانش‌آموزان به «${I}» مطمئن هستید؟`,()=>{we(A.students).forEach($=>{J.setHomeworkStatus($.identity.studentId,ee)}),oe(),nt(),V(`✅ وضعیت تکلیف همه به «${I}» تغییر یافت.`)},{confirmText:"بله",confirmClass:"btn-warning"})});const E=document.createElement("button");let k=!1;E.addEventListener("mousedown",()=>k=!1),E.addEventListener("touchstart",()=>k=!1,{passive:!0}),E.className="btn-icon",E.innerHTML="📝",E.title="افزودن یادداشت برای تکلیف",((R=J.studentRecords[t.identity.studentId])==null?void 0:R.homework.comment)||(E.style.opacity="0.3"),E.addEventListener("click",U=>{if(k){U.stopPropagation();return}const ee=J.studentRecords[t.identity.studentId].homework;Se.value=ee.comment||"",Se.dispatchEvent(new Event("input",{bubbles:!0})),dt(I=>{ee.comment=I;const $=ot(A),g=$.get(J.sessionNumber),W={type:"fromAttendance",sessionNumber:J.sessionNumber},fe=`یادداشت جلسه ${g}:
`,q=t.profile.notes.find(me=>!me.isDeleted&&me.source&&me.source.type==="fromAttendance"&&me.source.sessionNumber===W.sessionNumber);q?I?q.content=fe+I:q.isDeleted=!0:I&&t.addNote(fe+I,W),oe(),V("✅یادداشت تکلیف ذخیره شد."),E.style.opacity=I?"1":"0.3",Fn(t,$,a)}),ze("add-note-modal"),Se.focus()}),jt(E,()=>{k=!0,be("آیا می‌خواهید برای **تمام** دانش‌آموزان کلاس یادداشت تکلیف ثبت کنید؟",()=>{const U=we(A.students).map(ee=>ee.identity.studentId);yn(U),Sa()},{confirmText:"بله",confirmClass:"btn-primary"})}),c.appendChild(m),y.appendChild(E),y.appendChild(v),c.appendChild(y);const x=document.createElement("div");return x.className="att-row-3",Pa(t,i,l),Fn(t,i,a),x.appendChild(l),x.appendChild(a),e.appendChild(n),e.appendChild(c),e.appendChild(x),e}function Oo(){return ot(A).get(J.sessionNumber)}function nt(){const t=we(A.students),i=En(t);if(!A||!J)return;i.forEach(r=>{J.initializeStudentRecord(r.identity.studentId)}),yn([]);const e=ot(A);qo(),ln.innerHTML="";const l=document.createElement("li");l.className="attendance-list-header",Lt.id="attendance-search-input",Lt.type="text",Lt.className="inline-search-input",Lt.placeholder="جستجو...",Lt.value="";const a=document.createElement("div");a.className="student-search-container",a.appendChild(Lt);const n=document.createElement("div");n.className="header-labels-container",n.innerHTML=`
    <span class="header-label">تکلیف</span>
    <span class="header-label">حضور</span>
`,l.appendChild(a),l.appendChild(n),ln.appendChild(l),i.forEach(r=>{const s=Ao(r,e);ln.appendChild(s)}),yn([]),Ea(),Zo(),er()}function $e(){const t=document.getElementById("student-stats-table-container");if(!t||(t.innerHTML="",!A))return;we(A.students).length,$s.textContent="آمار عملکرد";const i=["نام"],e=["کل انتخاب ها","غیبت","خروج","فرصت ازدست‌رفته","مشکل","میانگین","نمره نهایی"],l=A.categories.filter(h=>h.isGradedCategory&&!h.isDeleted).map(h=>h.name),a=[...i,...l,...e],n=document.createElement("table");n.className="student-stats-table";const s=n.createTHead().insertRow();a.forEach((h,y)=>{const f=document.createElement("th");y===0?(f.innerHTML=`${h} <span style="opacity: 0.6;">🔗</span>`,f.title="ردیف‌های این ستون قابل کلیک هستند"):f.textContent=h,s.appendChild(f)});const o=n.createTBody(),c=En(we(A.students)),m=h=>{let y=0;return A.sessions.forEach(f=>{if(f.isDeleted||f.isCancelled)return;const v=f.studentRecords[h.identity.studentId];v&&v.attendance==="absent"&&y++}),y};c.forEach(h=>{const y=o.insertRow();if(y.dataset.studentId=h.identity.studentId,J){const k=J.studentRecords[h.identity.studentId];k&&k.attendance==="absent"&&y.classList.add("absent-row-highlight")}const f=y.insertCell(),v=document.createElement("span");v.textContent=`${h.identity.lastName}، ${h.identity.firstName}`,v.className="student-name-link",v.addEventListener("click",()=>{He(h)}),f.appendChild(v),l.forEach(k=>{var N;const _=y.insertCell();_.style.direction="ltr";const x=k.toLowerCase(),L=((N=h.logs.scores[x])==null?void 0:N.filter(R=>!R.isDeleted))||[];L.length>0?L.forEach((R,U)=>{const ee=document.createElement("span");ee.textContent=R.value+(R.comment?"'":""),ee.style.position="relative",R.comment&&(ee.dataset.tooltip=R.comment),_.appendChild(ee),U<L.length-1&&_.appendChild(document.createTextNode(","))}):_.textContent="",_.style.cursor="pointer",_.addEventListener("click",()=>{Ae(h,k);const R=document.getElementById("category-selection-container");R&&R.scrollIntoView({behavior:"smooth",block:"center"})})}),y.insertCell().textContent=h.statusCounters.totalSelections||0,y.insertCell().textContent=m(h),y.insertCell().textContent=h.statusCounters.outOfClassCount||0,y.insertCell().textContent=h.statusCounters.missedChances||0;const b=Object.values(h.categoryIssues||{}).reduce((k,_)=>k+_,0);y.insertCell().textContent=b;const C=h.getOverallAverageScore();y.insertCell().textContent=C!==null?C:"-";const E=A.calculateFinalStudentScore(h);y.insertCell().textContent=E!==null?E:"-"}),we(A.students),$s.setAttribute("data-student-count",c.length),t.appendChild(n);const p=t.querySelector(".student-stats-table"),u=p==null?void 0:p.querySelector("thead th:first-child");u&&u.addEventListener("click",()=>{p.classList.toggle("name-column-expanded")})}function Ae(t=null,i=null){const e=document.getElementById("selected-student-result");e.innerHTML="";const l=document.querySelector(".current-winner-highlight");l&&l.classList.remove("current-winner-highlight"),e.classList.remove("absent");let a,n;if(t&&i)a=t,n=i,Gt({student:t,categoryName:i}),vt(-1);else{if(Gt(null),Yt(null),!J||Ve<0||!J.winnerHistory[Ve])return;const P=J.winnerHistory[Ve];a=P.winner,n=P.categoryName}if(a){const P=document.querySelector(`.student-stats-table tr[data-student-id="${a.identity.studentId}"]`);P&&P.classList.add("current-winner-highlight")}const r=A.categories.find(P=>P.name===n);if(r){Qn(r),Ia(r),Vi(r);const P=document.querySelectorAll("#category-selection-container .pill");P.forEach(O=>O.classList.remove("active"));const se=Array.from(P).find(O=>O.textContent===n);se&&se.classList.add("active"),Cn(r),Yt(r.name)}const s=J.studentRecords[a.identity.studentId],o=(s==null?void 0:s.attendance)==="absent",c=document.createElement("div");c.className="winner-name-container";const m=document.createElement("button");m.className="btn-icon",m.innerHTML="˅",m.title="برنده قبلی";const p=!t;m.classList.toggle("is-disabled",!p||Ve<=0),m.addEventListener("click",()=>{m.classList.contains("is-disabled")?(m.classList.add("shake-animation"),setTimeout(()=>m.classList.remove("shake-animation"),200)):(vt(Ve-1),Ae())});const u=document.createElement("div");u.className="winner-name",u.innerHTML=`✨ <strong>${a.identity.name}</strong>✨`,u.classList.add("heartbeat-animation"),o&&(u.style.textDecoration="line-through",u.style.opacity="0.6",u.style.color="var(--color-secondary)"),(s==null?void 0:s.hadIssue)&&!o&&(u.style.color="var(--color-warning)",u.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"),(s==null?void 0:s.wasOutOfClass)&&!o&&(u.style.color="var(--color-strong-warning)",u.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود");const f=1e3,v=P=>{en=setTimeout(()=>{Qo(a,n),en=null},f)},b=()=>{en&&(clearTimeout(en),en=null)};u.addEventListener("mousedown",v),u.addEventListener("mouseup",b),u.addEventListener("mouseout",b),u.addEventListener("touchstart",v),u.addEventListener("touchmove",b),u.addEventListener("touchend",b),u.addEventListener("touchcancel",b);const C=document.createElement("button");if(C.className="btn-icon",C.innerHTML="˄",C.title="برنده بعدی",C.classList.toggle("is-disabled",!p||Ve>=J.winnerHistory.length-1),C.addEventListener("click",()=>{C.classList.contains("is-disabled")?(C.classList.add("shake-animation"),setTimeout(()=>C.classList.remove("shake-animation"),200)):(vt(Ve+1),Ae())}),c.appendChild(C),c.appendChild(u),a.onboardingSession===J.sessionNumber){const P=document.createElement("div");P.className="new-student-badge",P.textContent="دانش آموز جدید",c.appendChild(P)}c.appendChild(m),e.appendChild(c),Ye.disabled=p&&!C.classList.contains("is-disabled");const E=document.createElement("div");E.className="status-button-container";const k=document.createElement("button");k.textContent="غایب",k.classList.add("status-button","absent-btn"),o&&k.classList.add("active");const _=document.createElement("button");_.textContent="مشکل",_.classList.add("status-button","issue-btn"),s!=null&&s.hadIssue&&_.classList.add("active");const x=document.createElement("button");x.textContent="خروج",x.classList.add("status-button","exit-btn"),s!=null&&s.wasOutOfClass&&x.classList.add("active");const L=document.createElement("button");if(L.textContent="پروفایل",L.className="status-button profile-btn",J.isFinished?k.disabled=!0:k.addEventListener("click",()=>{const P=k.classList.contains("active");x.classList.contains("active")&&(x.classList.remove("active"),s.wasOutOfClass=!1,a.statusCounters.outOfClassCount=Math.max(0,(a.statusCounters.outOfClassCount||0)-1),a.statusCounters.missedChances=Math.max(0,a.statusCounters.missedChances-1)),P?(k.classList.remove("active"),J.setAttendance(a.identity.studentId,"present"),a.statusCounters.missedChances=Math.max(0,a.statusCounters.missedChances-1),u.style.textDecoration="",u.style.opacity="",u.style.color=""):(_.classList.contains("active")&&(_.classList.remove("active"),s.hadIssue=!1,a.statusCounters.otherIssues=Math.max(0,a.statusCounters.otherIssues-1),a.statusCounters.missedChances=Math.max(0,a.statusCounters.missedChances-1)),k.classList.add("active"),J.setAttendance(a.identity.studentId,"absent"),a.statusCounters.missedChances++,u.style.textDecoration="line-through",u.style.opacity="0.6",u.style.color="var(--color-secondary)",u.title=""),$e(),setTimeout(()=>{Ve!==-1?Ae():Ae(a,n)},0),oe()}),J.isFinished?_.disabled=!0:_.addEventListener("click",()=>{const P=_.classList.contains("active");if(x.classList.contains("active")&&(x.classList.remove("active"),s.wasOutOfClass=!1,a.statusCounters.outOfClassCount=Math.max(0,(a.statusCounters.outOfClassCount||0)-1),a.statusCounters.missedChances=Math.max(0,a.statusCounters.missedChances-1)),P){_.classList.remove("active"),s.hadIssue=!1;const se=Re.name;a.categoryIssues[se]&&(a.categoryIssues[se]=Math.max(0,a.categoryIssues[se]-1)),a.statusCounters.missedChances=Math.max(0,a.statusCounters.missedChances-1),u.style.color="",u.title=""}else{k.classList.contains("active")&&(k.classList.remove("active"),J.setAttendance(a.identity.studentId,"present"),a.statusCounters.missedChances=Math.max(0,a.statusCounters.missedChances-1)),_.classList.add("active"),s.hadIssue=!0;const se=Re.name;a.categoryIssues[se]=(a.categoryIssues[se]||0)+1,a.statusCounters.missedChances++,u.style.textDecoration="",u.style.opacity="",u.style.color="var(--color-warning)",u.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"}$e(),setTimeout(()=>{Ve!==-1?Ae():Ae(a,n)},0),oe()}),J.isFinished?x.disabled=!0:x.addEventListener("click",()=>{if(x.classList.contains("active"))x.classList.remove("active"),s.wasOutOfClass=!1,a.statusCounters.outOfClassCount=Math.max(0,(a.statusCounters.outOfClassCount||0)-1),a.statusCounters.missedChances=Math.max(0,a.statusCounters.missedChances-1),u.style.color="",u.title="";else{if(k.classList.contains("active")&&(k.classList.remove("active"),J.setAttendance(a.identity.studentId,"present"),a.statusCounters.missedChances=Math.max(0,a.statusCounters.missedChances-1)),_.classList.contains("active")){_.classList.remove("active"),s.hadIssue=!1;const se=Re.name;a.categoryIssues[se]&&(a.categoryIssues[se]=Math.max(0,a.categoryIssues[se]-1)),a.statusCounters.missedChances=Math.max(0,a.statusCounters.missedChances-1)}x.classList.add("active"),s.wasOutOfClass=!0,a.statusCounters.outOfClassCount=(a.statusCounters.outOfClassCount||0)+1,a.statusCounters.missedChances++,u.style.textDecoration="",u.style.opacity="",u.style.color="var(--color-strong-warning)",u.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود"}$e(),setTimeout(()=>{Ve!==-1?Ae():Ae(a,n)},0),oe()}),J.isFinished?L.disabled=!0:L.addEventListener("click",()=>{He(a)}),E.appendChild(k),E.appendChild(x),E.appendChild(_),E.appendChild(L),e.appendChild(E),n){const P=Yo(a,n);e.appendChild(P)}const N=document.createElement("div");N.className="student-details-container";const R=document.createElement("div");R.className="student-details-scores",R.innerHTML="<h4>آخرین نمرات</h4>";const U=document.createElement("ul");U.className="scores-list";const ee=A.categories.filter(P=>P.isGradedCategory&&!P.isDeleted);let I=!1;const $=a.logs.scores||{};ee.forEach(P=>{var Le;const se=P.name,O=se.toLowerCase(),M=document.createElement("li"),le=document.createElement("span");le.className="skill-name",le.textContent=`${se}:`;const te=document.createElement("span");te.className="skill-scores";const Q=(Le=$[O])==null?void 0:Le.filter(Oe=>!Oe.isDeleted);if(Q&&Q.length>0){I=!0;const Oe=Q.slice(-3);Oe.forEach((he,Ee)=>{const Te=document.createElement("span");Te.textContent=he.value+(he.comment?"'":""),he.comment&&(Te.dataset.tooltip=he.comment,Te.style.position="relative",Te.style.cursor="help",Te.classList.add("tooltip-container")),te.appendChild(Te),Ee<Oe.length-1&&te.appendChild(document.createTextNode(","))})}else te.textContent="none";M.appendChild(le),M.appendChild(te),U.appendChild(M)}),I||(U.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>'),R.appendChild(U),N.appendChild(R);const g=document.createElement("div");g.className="student-details-notes";const W=document.createElement("div");W.className="history-section-header";const fe=document.createElement("h4");fe.textContent="یادداشت‌ها";const q=document.createElement("button");q.className="btn-icon",q.innerHTML="📝",q.title="افزودن یادداشت جدید",J.isFinished?q.disabled=!0:q.addEventListener("click",()=>{Se.value="",Se.dispatchEvent(new Event("input",{bubbles:!0})),dt(P=>{P&&(a.addNote(P),oe(),Ae(),V("✅ یادداشت با موفقیت ثبت شد."))}),ze("add-note-modal"),Se.focus()}),W.appendChild(fe),W.appendChild(q),g.appendChild(W);const me=document.createElement("ul");me.className="notes-list",a.profile.notes&&a.profile.notes.length>0?[...a.profile.notes].sort((se,O)=>new Date(O.timestamp)-new Date(se.timestamp)).forEach(se=>{const O=document.createElement("li");O.dir=us(se.content),O.textContent=se.content,me.appendChild(O)}):me.innerHTML='<div class="no-content-message">یادداشتی وجود ندارد.</div>',g.appendChild(me),N.appendChild(g),e.appendChild(N)}function _a(t){t.addEventListener("input",()=>{const i=t.value,e=us(i);t.setAttribute("dir",e)})}function Mo(){Ia(null),dn.innerHTML="",Fs.innerHTML="",Ut.classList.add("tooltip-container"),pt.disabled=!0,ct.disabled=!0,At.disabled=!0,pt.value="",ct.value="",Dt.classList.add("disabled-wrapper"),Ye.disabled=!0}function Hn(){dn.innerHTML="",A.categories.filter(e=>!e.isDeleted).forEach(e=>{const l=document.createElement("span");l.className="pill",l.textContent=e.name,l.dataset.categoryId=e.id,e.description&&(l.dataset.tooltip=e.description),J.isFinished?l.classList.add("disabled"):l.addEventListener("click",()=>{document.querySelectorAll("#category-selection-container .pill").forEach(n=>n.classList.remove("active")),l.classList.add("active"),Qn(e),Ia(e),Vi(e),Cn(e),Yt(e.name),Dt.classList.remove("disabled-wrapper"),Ye.disabled=J.isFinished;const a=J.lastWinnerByCategory[e.name];if(a){const n=A.students.find(r=>r.identity.studentId===a);n&&Ae(n,e.name)}else{Fs.innerHTML="",Gt(null),vt(-1),Ye.disabled=!1;const n=document.querySelector(".current-winner-highlight");n&&n.classList.remove("current-winner-highlight")}}),J.isFinished||l.addEventListener("contextmenu",a=>{Sn(a,[{label:"تغییر نام",icon:"✏️",action:()=>{Ws((r,s,o)=>{const c=ni(A,e,r);c.success?(e.isGradedCategory=s,e.weight=o,oe(),ke(A.info.name,`نام دسته‌بندی «${e.name}» به «${r}» تغییر یافت.`),Hn(),$e(),V(`✅ نام دسته‌بندی به «${r}» تغییر یافت.`)):V(`⚠️ ${c.message}`)},{title:"ویرایش دسته‌بندی",initialName:e.name,initialIsGraded:e.isGradedCategory,initialWeight:e.weight||1,saveButtonText:"ذخیره تغییرات"})}},{label:"حذف دسته‌بندی",icon:"🗑️",className:"danger",action:()=>{be(`آیا از انتقال دسته‌بندی «${e.name}» به سطل زباله مطمئن هستید؟`,()=>{const r={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${e.name}» از کلاس «${A.info.name}»`,restoreData:{categoryId:e.id,classId:A.info.scheduleCode}};lt(r);const s=e.name.toLowerCase();if(A.students.forEach(o=>{o.logs.scores&&o.logs.scores[s]&&o.logs.scores[s].forEach(c=>{c.isDeleted=!0})}),Re&&Re.id===e.id){Qn(null),Fs.innerHTML="",Cn(null),Yt(null),Dt.classList.add("disabled-wrapper"),Ye.disabled=!0;const o=document.querySelector(".current-winner-highlight");o&&o.classList.remove("current-winner-highlight")}e.isDeleted=!0,ke(A.info.name,`دسته‌بندی «${e.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),Hn(),$e(),V(`✅ دسته‌بندی «${e.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}}])}),dn.appendChild(l)});const i=document.createElement("span");i.className="pill add-category-pill",i.textContent="+",i.title="افزودن دسته‌بندی جدید",J.isFinished?i.classList.add("disabled"):i.addEventListener("click",()=>{ms.checked=!1,document.getElementById("new-category-modal-weight-group").style.display="none",Ws((e,l,a)=>{if(A.categories.find(s=>s.name.toLowerCase()===e.toLowerCase()&&!s.isDeleted)){V("⚠️ این دسته‌بندی از قبل وجود دارد.");return}const r=new yt(e,"",l,a);A.categories.push(r),oe(),ke(A.info.name,`دسته‌بندی جدید «${e}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),Hn(),V(`✅ دسته‌بندی «${e}» اضافه شد.`)},{initialWeight:1})}),dn.appendChild(i)}function Ro(){if(J.lastUsedCategoryId){if(J.isFinished)return;const t=dn.querySelector(`.pill[data-category-id="${J.lastUsedCategoryId}"]`);t&&t.click()}J.winnerHistory&&J.winnerHistory.length>0&&(vt(J.winnerHistory.length-1),Ae())}function Ia(t){t?Ye.textContent=`نفر بعدی در ${t.name}`:Ye.textContent="نفر بعدی"}function Vi(t){t&&t.isGradedCategory?(Rn.textContent=`ضریب: ${t.weight||1}`,Rn.style.display="block"):Rn.style.display="none"}function Cn(t){if(J.isFinished){pt.disabled=!0,ct.disabled=!0,At.disabled=!0,Ut.setAttribute("title","جلسه خاتمه یافته است");return}t&&t.isGradedCategory?(pt.disabled=!1,ct.disabled=!1,At.disabled=!1,Ut.removeAttribute("title")):(pt.disabled=!0,ct.disabled=!0,At.disabled=!0,t?Ut.setAttribute("title","برای این دسته‌بندی قابلیت نمره دهی تعریف نشده است"):Ut.setAttribute("title","ابتدا یک دسته‌بندی را انتخاب کنید"))}function Yt(t){const i=document.querySelector(".student-stats-table");if(!i||(i.querySelectorAll(".current-category-highlight").forEach(r=>{r.classList.remove("current-category-highlight")}),!t))return;let l=-1;const a=i.querySelectorAll("thead th");if(a.forEach((r,s)=>{r.textContent.trim()===t&&(l=s)}),l===-1)return;a[l].classList.add("current-category-highlight"),i.querySelectorAll("tbody tr").forEach(r=>{const s=r.cells[l];s&&s.classList.add("current-category-highlight")})}function He(t){et(t);const i=document.getElementById("student-profile-modal"),e=document.getElementById("modal-profile-student-name"),l=document.getElementById("modal-profile-content-container"),a=document.getElementById("modal-profile-close-btn");if(!i||!e||!l||!a)return;e.textContent=`پروفایل: ${t.identity.name}`,e.style.cursor="pointer",e.onclick=()=>{const c=_e,m=A;ge(()=>{wa(c,m)})},l.innerHTML="";const n=document.createElement("div");n.className="profile-header-actions";const r=document.createElement("button");r.className="btn-icon btn-icon-label",r.title="انتقال دانش‌آموز",r.innerHTML="<span>➡️</span><span>انتقال</span>",r.addEventListener("click",()=>{const c=_e,m=A;ge(()=>{Ca(c,m)})});const s=document.createElement("button");s.className="btn-icon btn-icon-label",s.title="حذف دانش‌آموز",s.innerHTML="<span>🗑️</span><span>حذف</span>",s.style.color="var(--color-strong-warning)",s.addEventListener("click",()=>{const c=_e,m=A;ge(()=>{be(`آیا از انتقال دانش‌آموز «${c.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const p={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${c.identity.name}» از کلاس «${m.info.name}»`,restoreData:{studentId:c.identity.studentId,classId:m.info.scheduleCode}};lt(p),c.isDeleted=!0,ke(m.info.name,`دانش‌آموز «${c.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),_t(),$e(),nt(),V(`✅ دانش‌آموز «${c.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0,onCancel:()=>{He(c)}})})});const o=document.createElement("button");o.className="btn-icon btn-icon-label",o.title="افزودن یادداشت جدید",o.innerHTML="<span>📝</span><span>یادداشت</span>",o.addEventListener("click",()=>{const c=_e;Se.value="",Se.dispatchEvent(new Event("input",{bubbles:!0})),dt(m=>{if(m)return c.addNote(m),oe(),ke(A.info.name,`یادداشت جدیدی برای دانش‌آموز «${c.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:c.identity.studentId}),Ae(),V("✅ یادداشت با موفقیت ثبت شد."),()=>He(c)}),ge(()=>{ze("add-note-modal"),Se.focus()})}),n.appendChild(r),n.appendChild(s),n.appendChild(o),l.appendChild(n),$o(l),Ji(l),a.onclick=()=>ge(),ze("student-profile-modal")}function $o(t){if(!_e||!A)return;const i=document.createElement("div");i.className="scoring-section",i.innerHTML=`
    <h3>ثبت نمره جدید</h3>
    <div id="modal-graded-pills" class="category-pills"></div>
    <div class="input-group" style="margin-top: 15px; display: flex; gap: 10px;">
        <input type="number" id="modal-new-score-value" placeholder="نمره" style="width: 70px; text-align: center;">
        <input type="text" id="modal-new-score-comment" placeholder="توضیحات (اختیاری)..." style="flex-grow: 1;">
    </div>
    <button id="modal-add-score-btn" class="btn-success" style="width: 100%; margin-top: 10px;">ثبت نمره</button>
`,_a(i.querySelector("#modal-new-score-comment"));const e=i.querySelector("#modal-graded-pills");we(A.categories).filter(n=>n.isGradedCategory).forEach(n=>{const r=document.createElement("span");r.className="pill",r.textContent=n.name,r.dataset.skillName=n.name,r.addEventListener("click",()=>{e.querySelectorAll(".pill").forEach(s=>s.classList.remove("active")),r.classList.add("active")}),e.appendChild(r)}),i.querySelector("#modal-add-score-btn").addEventListener("click",()=>{const n=e.querySelector(".pill.active");if(!n){V("⚠️لطفاً یک مهارت را برای نمره‌دهی انتخاب کنید.");return}const r=n.dataset.skillName,s=i.querySelector("#modal-new-score-value"),o=i.querySelector("#modal-new-score-comment"),c=s.value,m=o.value.trim();if(!c){V("لطفاً مقدار نمره را وارد کنید.");return}_e.addScore(r,parseFloat(c),m),oe(),ke(A.info.name,`نمره ${c} در ${r} برای «${_e.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:_e.identity.studentId}),$e(),Ae(),s.value="",o.value="";const p=document.getElementById("modal-profile-content-container"),u=p.querySelector(".history-section");u&&u.remove(),Ji(p),V(`✅ نمره برای مهارت ${r} با موفقیت ثبت شد.`)}),t.appendChild(i)}function Ji(t){if(!_e)return;const i=document.createElement("div");i.className="history-section";const e=document.createElement("div");e.className="history-section-header";const l=document.createElement("h3");l.textContent="سوابق دانش‌آموز",e.appendChild(l),i.appendChild(e),zo(i),Ki(i),Yi(i),t.appendChild(i)}function zo(t){if(!_e)return;const i=_e,e=A.sessions.reduce((k,_)=>{const x=_.studentRecords[i.identity.studentId];return k+(x&&x.attendance==="absent"?1:0)},0),l=Object.values(i.categoryIssues||{}).reduce((k,_)=>k+_,0);let a=0,n=0,r=0;const s=i.qualitativeStats||{};Object.values(s).forEach(k=>{a+=k.effort||0,n+=k.good||0,r+=k.excellent||0});const o=a+n+r,c=document.createElement("div");c.className="stats-summary-box",c.innerHTML=`
        <p><strong>کل انتخاب:</strong> ${i.statusCounters.totalSelections}</p>
        <p><strong>غیبت:</strong> ${e}</p>
        <p><strong>فرصت از دست رفته:</strong> ${i.statusCounters.missedChances||0}</p>
        <p><strong>مشکل:</strong> ${l}</p>
        <p><strong>عملکرد کیفی:</strong> ${o}</p>
    `,t.appendChild(c),c.querySelector("p:nth-child(1)");const m=c.querySelector("p:nth-child(4)"),p=c.querySelector("p:nth-child(5)");t.appendChild(c);const u=we(A.categories),h=document.createElement("div");if(h.className="stats-breakdown",u.length>0){u.forEach(_=>{var R;const x=_.name,L=((R=i.categoryCounts)==null?void 0:R[x])||0,N=document.createElement("p");N.className="stats-breakdown-item",N.innerHTML=`<strong>${x}:</strong> ${L}`,h.appendChild(N)});const k=c.querySelector("p:first-child");k&&(k.classList.add("collapsible-toggle"),k.onclick=()=>{h.classList.toggle("open"),k.classList.toggle("open")},k.after(h))}const y=document.createElement("div");y.className="stats-breakdown",u.length>0&&(u.forEach(k=>{var N;const _=k.name,x=((N=i.categoryIssues)==null?void 0:N[_])||0,L=document.createElement("p");L.className="stats-breakdown-item",L.innerHTML=`<strong>${_}:</strong> ${x}`,y.appendChild(L)}),m&&l>0&&(m.classList.add("collapsible-toggle"),m.onclick=()=>{y.classList.toggle("open"),m.classList.toggle("open")},m.after(y)));const f=document.createElement("div");if(f.className="stats-breakdown",o>0){for(const k in s){const _=s[k];if((_.effort||0)+(_.good||0)+(_.excellent||0)>0){const L=document.createElement("p");L.className="stats-breakdown-item",L.innerHTML=`<strong>${k}:</strong> <span style="color:var(--color-primary)">عالی:${_.excellent}</span> | <span style="color:var(--color-success)">خوب:${_.good}</span> | <span style="color:#fd7e14">تلاش:${_.effort}</span>`,f.appendChild(L)}}p&&o>0&&(p.classList.add("collapsible-toggle"),p.onclick=()=>{f.classList.toggle("open"),p.classList.toggle("open")},p.after(f))}const v=document.createElement("p"),b=document.createElement("strong");b.textContent="تکالیف ناقص:";const C=document.createElement("span");C.style.marginRight="5px";const E=ot(A);Fn(i,E,C,{includePrefix:!1}),v.appendChild(b),v.appendChild(C),c.appendChild(v)}function Ki(t){if(!_e)return;const i=_e,e=document.createElement("h4");e.textContent="تاریخچه نمرات:",e.style.marginTop="20px";const l=i.getOverallAverageScore(),a=document.createElement("span");a.className="profile-avg-badge",a.textContent=` (میانگین: ${l!==null?l:"-"})`,e.appendChild(a);const n=A.calculateFinalStudentScore(i),r=document.createElement("span");r.className="profile-avg-badge",r.textContent=` (نمره نهایی: ${n!==null?n:"-"})`,e.appendChild(r);const s=document.createElement("ul");s.className="list-container";const o=Object.values(i.logs.scores||{}).flat().filter(c=>!c.isDeleted).sort((c,m)=>new Date(m.timestamp)-new Date(c.timestamp));o.length===0?s.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>':o.forEach(c=>{const m=document.createElement("li");m.className="score-history-item";const p=document.createElement("div");p.className="item-content";const u=document.createElement("div");u.className="score-info";const h=document.createElement("span");h.className="score-skill-badge",h.textContent=c.skill;const y=document.createElement("span");y.className="score-value",y.textContent=`نمره: ${c.value}`;const f=document.createElement("span");if(f.className="score-date",f.textContent=new Date(c.timestamp).toLocaleDateString("fa-IR"),u.appendChild(h),u.appendChild(y),u.appendChild(f),p.appendChild(u),c.comment){const b=document.createElement("p");b.className="score-comment",b.innerHTML=ha(c.comment),b.addEventListener("click",()=>{Se.value=c.comment,Se.dispatchEvent(new Event("input",{bubbles:!0})),dt(C=>{c.comment=C,oe(),ke(A.info.name,`توضیحات نمره ${c.value} (${c.skill}) برای دانش‌آموز «${i.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:i.identity.studentId}),He(i),V("✅ توضیحات نمره با موفقیت ویرایش شد.")}),ge(()=>{ze("add-note-modal"),Se.focus()})}),p.appendChild(b)}const v=document.createElement("button");v.className="btn-icon delete-item-btn",v.innerHTML="🗑️",v.title="حذف این نمره",v.addEventListener("click",()=>{ge(()=>{be(`آیا از انتقال نمره ${c.value} در مهارت «${c.skill}» به سطل زباله مطمئن هستید؟`,()=>{const b={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"score",description:`نمره ${c.value} (${c.skill}) برای «${i.identity.name}»`,restoreData:{scoreId:c.id,skill:c.skill,studentId:i.identity.studentId,classId:A.info.scheduleCode}};lt(b),c.isDeleted=!0,oe(),ke(A.info.name,`نمره ${c.value} (${c.skill}) دانش‌آموز «${i.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),He(i),V("✅ نمره به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{He(i)}})})}),m.appendChild(p),m.appendChild(v),s.appendChild(m)}),t.appendChild(e),t.appendChild(s)}function Yi(t){if(!_e)return;const i=document.createElement("h4");i.textContent="تاریخچه یادداشت‌ها:",i.style.marginTop="20px";const e=document.createElement("ul");e.className="list-container",!_e.profile.notes||_e.profile.notes.length===0?e.innerHTML='<div class="no-content-message">هنوز یادداشتی ثبت نشده است.</div>':[..._e.profile.notes].filter(a=>!a.isDeleted).sort((a,n)=>new Date(n.timestamp)-new Date(a.timestamp)).forEach(a=>{const n=document.createElement("li");n.className="note-history-item";const r=document.createElement("div");r.className="item-content";const s=document.createElement("div");s.className="note-info";const o=document.createElement("span");o.className="note-date",o.textContent=new Date(a.timestamp).toLocaleDateString("fa-IR");const c=document.createElement("button");c.className="btn-icon delete-item-btn",c.innerHTML="🗑️",c.title="حذف این یادداشت",c.addEventListener("click",()=>{const p=_e;ge(()=>{be("آیا از انتقال این یادداشت به سطل زباله مطمئن هستید؟",()=>{const u={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"note",description:`یادداشت برای دانش‌آموز «${p.identity.name}»`,restoreData:{noteId:a.id,studentId:p.identity.studentId,classId:A.info.scheduleCode}};lt(u),a.isDeleted=!0,ke(A.info.name,`یادداشت دانش‌آموز «${p.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),He(p),V("✅ یادداشت به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{He(p)}})})}),s.appendChild(o),s.appendChild(c);const m=document.createElement("p");m.className="note-content",m.innerHTML=ha(a.content),m.addEventListener("click",()=>{const p=_e;Se.value=a.content,Se.dispatchEvent(new Event("input",{bubbles:!0})),dt(u=>{a.content=u,oe(),ke(A.info.name,`یادداشت دانش‌آموز «${p.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:p.identity.studentId}),He(p),V("✅یادداشت با موفقیت ویرایش شد.")}),ge(()=>{ze("add-note-modal"),Se.focus()})}),r.appendChild(s),r.appendChild(m),n.appendChild(r),e.appendChild(n)}),t.appendChild(i),t.appendChild(e)}function Xi(t){Ms.innerHTML="",t.forEach((i,e)=>{const l=document.createElement("option");l.value=e,l.textContent=i.trim(),Ms.appendChild(l)})}function qs(){Os.innerHTML="",Js.forEach(t=>{const i=document.createElement("li");i.className="preview-item";const e=document.createElement("input");e.type="checkbox",e.checked=!0,e.dataset.name=t;const l=document.createElement("label");l.textContent=t,i.appendChild(e),i.appendChild(l),Os.appendChild(i)})}function Po(t){const i=document.createElement("div");i.className="list-item-buttons";const e=document.createElement("button");return e.className="btn-icon",e.innerHTML="📝",e.title="ویرایش یادداشت کلاس",t.note||(e.style.display="none"),e.addEventListener("click",l=>{l.stopPropagation(),hs(t)}),i.appendChild(e),i}function Fo(t){const i=document.createElement("div");i.style.flexGrow="1",i.style.display="flex",i.style.flexDirection="column",i.style.alignItems="flex-start";const e=document.createElement("span");e.textContent=t.info.name,e.classList.add("class-name-display"),i.appendChild(e);const l=we(t.students).length,a=we(t.sessions).filter(c=>c.isFinished).length,n=Vo(t.info.scheduleDays),r=document.createElement("div");r.classList.add("class-stats-row");const s=document.createElement("span");s.textContent=`${l} نفر`,s.classList.add("student-count-badge"),r.appendChild(s);const o=document.createElement("span");if(o.textContent=`${a} جلسه`,o.classList.add("session-count-badge"),r.appendChild(o),n){const c=document.createElement("span");c.textContent=n,c.classList.add("schedule-days-badge"),r.appendChild(c)}return i.appendChild(r),i.addEventListener("click",()=>{qe(t),Xe(null),hn(A.liveSession),Ge(),ye("session-page")}),i}function Ho(t){const i=document.createElement("li");cs(t).type==="active"&&(i.classList.add("active-class-card"),i.title="این کلاس هم‌اکنون در حال برگزاری است");const l=document.createElement("input");l.type="checkbox",l.className="mass-selection-checkbox",l.checked=it.includes(t.info.name),l.addEventListener("click",m=>{m.stopPropagation()}),l.addEventListener("change",()=>{const m=t.info.name;if(l.checked)it.includes(m)||it.push(m);else{const p=it.indexOf(m);p>-1&&it.splice(p,1)}}),i.appendChild(l);const a=Fo(t);i.appendChild(a);const n=document.createElement("div");n.style.display="flex",n.style.flexDirection="column",n.style.gap="5px",n.style.alignItems="flex-end",n.style.marginLeft="10px";const r=document.createElement("div");if(r.className="list-item-badges",t.liveSession&&!t.liveSession.isCancelled&&!t.liveSession.isDeleted){const m=document.createElement("span");m.className="warning-badge",m.textContent="جلسه باز",r.appendChild(m),i.classList.add("has-unfinished-session")}const s=document.createElement("span");if(s.className=`type-badge ${t.info.type}`,s.textContent=t.info.type==="online"?"آنلاین":"حضوری",s.title="نوع کلاس",r.appendChild(s),cs(t).type==="incomplete"){const m=document.createElement("span");m.className="type-badge cancelled-badge",m.textContent="زمان‌بندی ناقص",m.style.cursor="pointer",m.title="برای تکمیل زمان‌بندی کلیک کنید",m.addEventListener("click",p=>{p.stopPropagation(),be("زمان‌بندی این کلاس کامل نیست. برای نمایش صحیح در لیست، لطفاً روزها و ساعت برگزاری را مشخص کنید.",()=>{kt(t)},{confirmText:"تنظیمات",confirmClass:"btn-primary"})}),r.appendChild(m)}else{const m=Go(t,re);if(m){const p=document.createElement("span");p.className="type-badge conflict-badge",p.textContent="تداخل زمانی",p.style.cursor="pointer",p.title=`تداخل با کلاس: ${m}`,p.addEventListener("click",u=>{u.stopPropagation(),be(`زمان برگزاری این کلاس با کلاس «${m}» تداخل دارد. لطفاً زمان‌بندی را بررسی کنید.`,()=>{kt(t)},{confirmText:"تنظیمات",confirmClass:"btn-primary"})}),r.appendChild(p)}}n.appendChild(r);const c=Po(t);return n.appendChild(c),i.appendChild(n),i.addEventListener("contextmenu",m=>{const p={label:"پشتیبان‌گیری از این کلاس",icon:"📤",action:()=>{bn([t.info.name])}},u=it.length;u>1&&it.includes(t.info.name)&&(p.label=`پشتیبان‌گیری از ${u} کلاس`,p.action=()=>{bn(it),On([]),We()});const h={label:"حذف کلاس",icon:"🗑️",className:"danger",action:()=>{be(`آیا از انتقال کلاس «${t.info.name}» به سطل زباله مطمئن هستید؟`,()=>{const f={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"classroom",description:`کلاس «${t.info.name}»`,restoreData:{name:t.info.name}};lt(f),t.isDeleted=!0,ke(t.info.name,`کلاس «${t.info.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),We(),V(`✅ کلاس «${t.info.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}};u>1&&it.includes(t.info.name)&&(h.label=`حذف ${u} کلاس`,h.action=()=>{be(`آیا از انتقال ${u} کلاس انتخاب شده به سطل زباله مطمئن هستید؟`,()=>{it.forEach(f=>{const v=re[f];if(v&&!v.isDeleted){const b={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"classroom",description:`کلاس «${v.info.name}»`,restoreData:{name:v.info.name}};lt(b),v.isDeleted=!0,ke(v.info.name,`کلاس «${v.info.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"})}}),On([]),oe(),We(),V(`✅ ${u} کلاس به سطل زباله منتقل شدند.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})});const y=[{label:"چاپ گزارش کلاس",icon:"🖨️",action:()=>{Ko(t)}},{label:Nt.classList.contains("selection-mode-active")?"لغو انتخاب":"انتخاب چند کلاس",icon:"✔️",action:()=>{const f=Nt.classList.contains("selection-mode-active");Nt.classList.toggle("selection-mode-active"),f&&(On([]),We())}},p,{label:"یادداشت کلاس",icon:"📝",action:()=>{hs(t)}},{label:"تنظیمات کلاس",icon:"⚙️",action:()=>{kt(t)}},{label:"گزارش فعالیت‌ها",icon:"📋",action:()=>{Zi(t.info.name)}},{label:"تغییر نام",icon:"✏️",action:()=>{const f=t.info.name,v=document.getElementById("add-note-modal-title");v.textContent="تغییر نام کلاس",Se.value=f,Se.rows=1,dt(b=>{const C=b.trim();if(C&&C!==f){const E=ti(f,C);E.success?(_r(f,C),ke(C,`نام کلاس از «${f}» به «${C}» تغییر یافت.`,{type:"VIEW_SESSIONS"}),oe(),We(),V(`✅نام کلاس به «${C}» تغییر یافت.`)):V(E.message)}v.textContent="ثبت یادداشت جدید",Se.rows=4}),ze("add-note-modal"),Se.focus(),Se.select()}},h];Sn(m,y)}),i}function ps(){const t=document.getElementById("class-management-stats");if(!t)return;const i=Object.values(re).filter(n=>!n.isDeleted),e=i.length,l=i.reduce((n,r)=>n+we(r.students).length,0);let a="";Fe.lastBackupTimestamp&&(a=`
            <div class="stats-row backup-stat">
                <span>آخرین پشتیبان: <strong>${new Date(Fe.lastBackupTimestamp).toLocaleString("fa-IR",{year:"numeric",month:"numeric",day:"numeric",weekday:"long",hour:"2-digit",minute:"2-digit"})}</strong></span>
            </div>
        `),t.innerHTML=`
        <div class="stats-row main-stats">
            <span>کل کلاس‌ها: <strong>${e}</strong></span>
            <span>|</span>
            <span>کل دانش‌آموزان: <strong>${l}</strong></span>
        </div>
        ${a} 
    `}function We(){ps(),Nt.innerHTML="";const t=Object.values(re).filter(a=>!a.isDeleted),i=document.querySelector(".fab-container"),e=document.querySelector(".global-search-container");if(t.length===0){i&&i.classList.add("center-empty-state"),e&&(e.style.display="none"),Nt.innerHTML='<li class="no-content-message" style="text-align:center; margin-top:20px;">هنوز کلاسی ایجاد نشده است.</li>';return}else i&&i.classList.remove("center-empty-state"),e&&(e.style.display="");t.sort((a,n)=>{const r=cs(a),s=cs(n);return r.sortIndex!==s.sortIndex?r.sortIndex-s.sortIndex:r.type==="upcoming"?r.nextTimestamp-s.nextTimestamp:new Date(a.info.creationDate)-new Date(n.info.creationDate)}).forEach(a=>{const n=Ho(a);Nt.appendChild(n)})}function _t(){if(!A)return;Ds.innerHTML="";const t=we(A.students);En(t).forEach(e=>{const l=document.createElement("li");l.dataset.studentId=e.identity.studentId;const a=document.createElement("span");a.className="student-name-link",a.style.flexGrow="1",e.identity.firstName&&e.identity.lastName?a.textContent=`${e.identity.lastName}، ${e.identity.firstName}`:a.textContent=e.identity.name,a.addEventListener("click",()=>{He(e)}),l.addEventListener("contextmenu",n=>{Sn(n,[{label:"تغییر نام",icon:"✏️",action:()=>{wa(e,A)}},{label:"انتقال دانش‌آموز",icon:"➡️",action:()=>{Ca(e,A)}},{label:"حذف دانش‌آموز",icon:"🗑️",className:"danger",action:()=>{be(`آیا از انتقال دانش‌آموز «${e.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const s={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${e.identity.name}» از کلاس «${A.info.name}»`,restoreData:{studentId:e.identity.studentId,classId:A.info.scheduleCode}};lt(s),e.isDeleted=!0,ke(A.info.name,`دانش‌آموز «${e.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),_t(),$e(),nt(),V(`✅ دانش‌آموز «${e.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}}])}),l.appendChild(a),Ds.appendChild(l)})}function Xt(){if(As.innerHTML="",!A)return;A.categories.filter(i=>!i.isDeleted).forEach(i=>{const e=document.createElement("li"),l=document.createElement("div");l.className="name-and-badge-container";const a=document.createElement("span");if(a.textContent=i.name,l.appendChild(a),i.isGradedCategory){const r=document.createElement("span");r.className="category-badge",r.textContent="نمره‌دار",l.appendChild(r)}if(i.isGradedCategory){const r=document.createElement("span");r.className="category-badge weight-badge",r.textContent=`ضریب: ${i.weight||1}`,l.appendChild(r)}const n=document.createElement("button");n.className="btn-icon",n.innerHTML="🗑️",n.style.color="var(--color-warning)",n.addEventListener("click",()=>{be(`آیا از انتقال دسته‌بندی «${i.name}» به سطل زباله مطمئن هستید؟`,()=>{const r={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${i.name}» از کلاس «${A.info.name}»`,restoreData:{categoryId:i.id,classId:A.info.scheduleCode}};lt(r),i.isDeleted=!0,ke(A.info.name,`دسته‌بندی «${i.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),Xt(),V(`✅ دسته‌بندی «${i.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}),e.appendChild(l),e.appendChild(n),As.appendChild(e)})}function Qi(){if(!A)return;const t=A;xa(Pn,an,t.info.educationalSystem,t.info.level),Pn.addEventListener("change",()=>{t.info.educationalSystem=Pn.value,t.info.level=an.value,oe()}),an.addEventListener("change",()=>{t.info.level=an.value,oe()});const i=t.info.type||"in-person",e=document.querySelector(`#settings-page input[name="class-type-setting"][value="${i}"]`);e&&(e.checked=!0);const l=t.info.scheduleDays||[];document.querySelectorAll('input[name="schedule-day"]').forEach(a=>{a.checked=l.includes(parseInt(a.value))}),document.getElementById("settings-schedule-start").value=t.info.scheduleStartTime||"",document.getElementById("settings-schedule-end").value=t.info.scheduleEndTime||""}function fn(t){document.querySelectorAll(".page").forEach(e=>{e.classList.remove("active")});const i=document.getElementById(t);i&&i.classList.add("active"),t==="class-management-page"?(qe(null),Xe(null),et(null),We(),Rs.style.display="flex"):Rs.style.display="none",Gi()}function ye(t,i={}){const{tab:e}=i,l={pageId:t,currentClassName:A?A.info.name:null,selectedSessionNumber:J?J.sessionNumber:null,selectedStudentId:_e?_e.identity.studentId:null};let a=`#${t}`;const n=new URLSearchParams(window.location.hash.split("?")[1]||"");A?n.set("class",A.info.name):n.delete("class"),J?n.set("session",J.sessionNumber):n.delete("session"),_e?n.set("student",_e.identity.studentId):n.delete("student"),t==="session-dashboard-page"&&e?n.set("tab",e):t!=="session-dashboard-page"&&n.delete("tab");const r=n.toString();r&&(a+=`?${r}`),window.location.hash!==a&&history.pushState(l,"",a),fn(t)}function Wo(t,i){const e=document.createElement("div");e.className="list-item-buttons",e.style.gap="10px";const l=document.createElement("button");if(l.className="btn-icon",l.innerHTML="📝",l.title="ویرایش یادداشت جلسه",t.note||(l.style.display="none"),l.addEventListener("click",a=>{a.stopPropagation(),ka(t,i)}),!t.isFinished&&!t.isCancelled){const a=document.createElement("button");a.className="btn-success",a.textContent="پایان جلسه",a.style.fontSize="12px",a.style.padding="4px 10px",a.style.whiteSpace="nowrap",a.addEventListener("click",n=>{n.stopPropagation(),be(`جلسه شماره ${i} خاتمه پیدا خواهد کرد!`,()=>{A.endSpecificSession(t.sessionNumber),oe(),ke(A.info.name,`جلسه ${i} خاتمه یافت.`,{type:"VIEW_SESSIONS"}),Ge(),be("جلسه با موفقیت خاتمه یافت. آیا مایل به ایجاد فایل پشتیبان هستید؟",()=>{if(mt){V("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است.");return}bn(),V("✅فایل پشتیبان با موفقیت ایجاد شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}),e.appendChild(a)}return e.appendChild(l),e}function Uo(t,i){const e=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="flex-start",e.style.flexGrow="1";const l=new Date(t.startTime).toLocaleDateString("fa-IR"),a=document.createElement("span");a.className="session-list-title";const n=document.createElement("div");n.style.display="flex",n.style.gap="5px",n.style.marginTop="5px";const r=new Date(t.startTime).toLocaleDateString("fa-IR",{weekday:"long"}),s=document.createElement("span");if(s.className="type-badge day-badge",s.textContent=r,n.appendChild(s),t.isCancelled){a.textContent=`لغو شده - تاریخ: ${l}`,e.style.cursor="default";const o=document.createElement("span");o.className="type-badge cancelled-badge",o.textContent="لغو شده",n.appendChild(o)}else a.textContent=`جلسه ${i} - تاریخ: ${l}`,e.style.cursor="pointer",e.addEventListener("click",()=>{Xe(t),Jt()});if(e.appendChild(a),t.isFinished){const o=document.createElement("span");o.className="type-badge finished-badge",o.textContent="خاتمه یافته",n.appendChild(o)}if(t.isMakeup){const o=document.createElement("span");o.className="type-badge makeup-badge",o.textContent="جبرانی",n.appendChild(o)}return e.appendChild(n),e}function jo(t,i){const e=document.createElement("li"),l=i.get(t.sessionNumber),a=Uo(t,l);e.appendChild(a);const n=Wo(t,l);return e.appendChild(n),e.addEventListener("contextmenu",r=>{const s=[{label:"یادداشت جلسه",icon:"📝",action:()=>{ka(t,l)}},{label:t.isCancelled?"بازگردانی جلسه":"لغو جلسه",icon:"❌",action:()=>{const o=t.isCancelled?"بازگردانی جلسه":"لغو جلسه",c=t.isCancelled?"آیا از بازگردانی این جلسه مطمئن هستید؟":"آیا از لغو این جلسه مطمئن هستید؟ جلسه لغو شده در آمار تاثیری ندارد اما قابل بازگردانی است.";be(c,()=>{t.isCancelled=!t.isCancelled;const m=t.isCancelled?`جلسه ${l} لغو شد.`:`جلسه لغو شده (تاریخ: ${new Date(t.startTime).toLocaleDateString("fa-IR")}) بازگردانی شد.`;ke(A.info.name,m,{type:"VIEW_SESSIONS"}),oe(),Ge(),V(t.isCancelled?"✅جلسه لغو شد.":"✅جلسه بازگردانی شد.")},{confirmText:o,confirmClass:"btn-warning"})}},{label:"تغییر وضعیت جبرانی",icon:"🔄",action:()=>{A.markAsMakeup(t.sessionNumber),oe();const o=t.isMakeup?`جلسه ${l} به عنوان جبرانی علامت‌گذاری شد.`:`جلسه ${l} از حالت جبرانی خارج شد.`;ke(A.info.name,o,{type:"VIEW_SESSIONS"}),Ge()}},{label:"حذف جلسه",icon:"🗑️",className:"danger",action:()=>{const o=t.isCancelled?"لغو شده":l;be(`آیا از انتقال جلسه ${o} به سطل زباله مطمئن هستید؟`,()=>{const c={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"session",description:`جلسه ${o} از کلاس «${A.info.name}»`,restoreData:{sessionNumber:t.sessionNumber,classId:A.info.scheduleCode}};lt(c),t.isDeleted=!0,ke(A.info.name,`جلسه ${o} به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),Ge(),V(`✅ جلسه ${o} به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}},{label:"تغییر تاریخ",icon:"📅",action:()=>{const o=document.getElementById("dp-day"),c=document.getElementById("dp-month"),m=document.getElementById("dp-year"),p=za.toJalaali(t.startTime);o.innerHTML="";for(let y=1;y<=31;y++){const f=document.createElement("option");f.value=y,f.textContent=y.toLocaleString("fa-IR"),y===p.jd&&(f.selected=!0),o.appendChild(f)}const u=["فروردین","اردیبهشت","خرداد","تیر","مرداد","شهریور","مهر","آبان","آذر","دی","بهمن","اسفند"];c.innerHTML="",u.forEach((y,f)=>{const v=document.createElement("option");v.value=f+1,v.textContent=y,f+1===p.jm&&(v.selected=!0),c.appendChild(v)}),m.innerHTML="";const h=p.jy;for(let y=h-5;y<=h+5;y++){const f=document.createElement("option");f.value=y,f.textContent=y.toString().replace(/\d/g,v=>"۰۱۲۳۴۵۶۷۸۹"[v]),y===p.jy&&(f.selected=!0),m.appendChild(f)}es(y=>{if(!y)return;const f=za.toGregorian(parseInt(y.jy),parseInt(y.jm),parseInt(y.jd)),v=new Date(f.gy,f.gm-1,f.gd);v.setHours(t.startTime.getHours()),v.setMinutes(t.startTime.getMinutes()),v.setSeconds(t.startTime.getSeconds());const b=t.startTime.toLocaleDateString("fa-IR");t.startTime=v;const C=t.startTime.toLocaleDateString("fa-IR");ke(A.info.name,`تاریخ جلسه ${l} از ${b} به ${C} تغییر یافت.`,{type:"VIEW_SESSIONS"}),oe(),Ge(),V(`✅ تاریخ جلسه به ${C} تغییر یافت.`)}),ze("date-picker-modal")}}];Sn(r,s)}),e}function Ge(){const t=document.getElementById("session-list");if(!A)return;if(t.innerHTML="",A.sessions.length===0){t.innerHTML="<li>هنوز جلسه‌ای شروع نشده است.</li>";return}const i=ot(A);[...we(A.sessions)].reverse().forEach(l=>{const a=jo(l,i);t.appendChild(a)})}function on(t){if(Ct.innerHTML="",t.length>0)t.forEach(i=>{const e=document.createElement("div");e.textContent=i.identity.name,e.addEventListener("click",()=>{He(i),Ct.style.display="none",Ps.value=""}),Ct.appendChild(e)}),Ct.style.display="block";else if(Ps.value.trim()!==""){const i=document.createElement("div");i.className="no-results",i.textContent="پیدا نشد",Ct.appendChild(i),Ct.style.display="block"}else Ct.style.display="none"}function Wn(t){if(ft.innerHTML="",t.length>0)t.forEach(i=>{const e=document.createElement("div");if(e.className="global-search-result",i.type==="student"){const l=document.createElement("span");l.className="student-name",l.textContent=i.student.identity.name;const a=document.createElement("span");a.className="class-name",a.textContent=`کلاس: ${i.classroom.info.name}`,e.addEventListener("click",()=>{qe(i.classroom),He(i.student),ft.style.display="none",sn.value=""}),a.addEventListener("click",n=>{n.stopPropagation(),qe(i.classroom),Xe(null),hn(i.classroom.liveSession),Ge(),ye("session-page"),ft.style.display="none",sn.value=""}),e.appendChild(l),e.appendChild(a)}else if(i.type==="classroom"){const l=document.createElement("span");l.className="student-name",l.textContent=`[کلاس] ${i.classroom.info.name}`,e.addEventListener("click",()=>{qe(i.classroom),Xe(null),hn(i.classroom.liveSession),Ge(),ye("session-page"),ft.style.display="none",sn.value=""}),e.appendChild(l)}ft.appendChild(e)}),ft.style.display="block";else if(sn.value.trim()!==""){const i=document.createElement("div");i.className="no-results",i.textContent="پیدا نشد",ft.appendChild(i),ft.style.display="block"}else ft.style.display="none"}function wn(){const t=document.getElementById("trashed-items-list");if(t.innerHTML="",Ze.length===0){t.innerHTML='<li style="text-align: center; padding: 20px;">سطل زباله خالی است.</li>';return}Ze.forEach((i,e)=>{const l=document.createElement("li"),a=document.createElement("span");a.textContent=i.description,a.style.flexGrow="1";const n=document.createElement("div");n.className="list-item-buttons";const r=document.createElement("button");r.className="btn-icon",r.innerHTML="🔄",r.title="بازیابی",r.addEventListener("click",()=>{var p;let o=!1,c=null;const m=i.restoreData;switch(i.type){case"classroom":{const u=re[m.name];u&&!u.isDeleted?c=`کلاسی با نام «${m.name}» از قبل فعال است.`:u&&u.isDeleted&&(u.isDeleted=!1,o=!0);break}case"student":{const u=Object.values(re).find(y=>y.info.scheduleCode===m.classId),h=u==null?void 0:u.students.find(y=>y.identity.studentId===m.studentId);h&&(h.isDeleted=!1,o=!0);break}case"session":{const u=Object.values(re).find(y=>y.info.scheduleCode===m.classId),h=u==null?void 0:u.sessions.find(y=>y.sessionNumber===m.sessionNumber);h&&(h.isDeleted=!1,o=!0);break}case"category":{const u=Object.values(re).find(y=>y.info.scheduleCode===m.classId),h=u==null?void 0:u.categories.find(y=>y.id===m.categoryId);h&&(h.isDeleted=!1,o=!0);break}case"score":{const u=Object.values(re).find(f=>f.info.scheduleCode===m.classId),h=u==null?void 0:u.students.find(f=>f.identity.studentId===m.studentId),y=(p=h==null?void 0:h.logs.scores[m.skill.toLowerCase()])==null?void 0:p.find(f=>f.id===m.scoreId);y&&(y.isDeleted=!1,o=!0);break}case"note":{const u=Object.values(re).find(f=>f.info.scheduleCode===m.classId),h=u==null?void 0:u.students.find(f=>f.identity.studentId===m.studentId),y=h==null?void 0:h.profile.notes.find(f=>f.id===m.noteId);y&&(y.isDeleted=!1,o=!0);break}}o?(Ze.splice(e,1),oe(),wn(),i.type==="classroom"&&We(),V("✅ آیتم با موفقیت بازیابی شد.")):V(c?`⚠️ ${c}`:"⚠️ آیتم اصلی برای بازیابی یافت نشد.")});const s=document.createElement("button");s.className="btn-icon",s.innerHTML="🔥",s.title="حذف دائمی",s.addEventListener("click",()=>{be("آیا از حذف دائمی این آیتم مطمئن هستید؟ این عمل غیرقابل بازgشت است.",()=>{const o=i.restoreData,c=p=>Object.values(re).find(u=>u.info.scheduleCode===p);let m;switch(i.type){case"classroom":delete re[o.name];break;case"student":m=c(o.classId),ds({identity:{studentId:o.studentId}},m);break;case"session":m=c(o.classId),m&&sa(m.info.name,o.sessionNumber);break;case"category":m=c(o.classId),m&&aa(m.info.name,o.categoryId);break;case"score":m=c(o.classId),m&&ia(m.info.name,o.studentId,o.skill,o.scoreId);break;case"note":m=c(o.classId),m&&ra(m.info.name,o.studentId,o.noteId);break}Ze.splice(e,1),oe(),wn(),V("✅ آیتم برای همیشه حذف شد.")},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),n.appendChild(r),n.appendChild(s),l.appendChild(a),l.appendChild(n),t.appendChild(l)})}function qo(){const t=document.getElementById("absentees-summary-container");t&&(t.innerHTML=`
        <div id="absentees-summary-box" class="absentees-summary">
            <div class="absentees-summary-header">
                <h4>لیست غایبین جلسه شماره <span id="absentee-summary-session-number"></span></h4>
                <button id="copy-absentees-btn" class="btn-icon" title="کپی لیست غایبین">📋</button>
            </div>
            <div id="absentees-summary-list" class="summary-list"></div>
            <div class="attendance-counters">
                <span>تعداد حاضرین: <strong id="present-count">0</strong></span>
                <span>تعداد غایبین: <strong id="absent-count">0</strong></span>
            </div>
        </div>
    `)}function er(){const t=document.getElementById("absentees-summary-box"),i=document.getElementById("absentees-summary-list"),e=document.getElementById("absentee-summary-session-number");if(!t||!i||!e){console.error("Could not find all absentee summary elements.");return}if(!A||!J){t.classList.remove("visible");return}const l=we(A.students).filter(m=>{const p=J.studentRecords[m.identity.studentId];return p&&p.attendance==="absent"}),a=we(A.students),n=l.length,r=a.length-n,s=document.getElementById("present-count"),o=document.getElementById("absent-count");s&&(s.textContent=r.toLocaleString("fa-IR")),o&&(o.textContent=n.toLocaleString("fa-IR"));const c=ot(A);e.textContent=c.get(J.sessionNumber),l.length>0?t.classList.add("visible"):t.classList.remove("visible"),i.innerHTML="",l.forEach(m=>{const u=(y=>A.sessions.reduce((f,v)=>{if(v.isDeleted||v.isCancelled)return f;const b=v.studentRecords[y.identity.studentId];return f+(b&&b.attendance==="absent"?1:0)},0))(m),h=document.createElement("span");h.className="summary-name",h.textContent=`${m.identity.name} (غیبت: ${u})`,h.addEventListener("click",()=>{h.classList.add("fading-out"),setTimeout(()=>{J.setAttendance(m.identity.studentId,"present"),oe(),nt()},200)}),i.appendChild(h)})}function Zo(){const t=document.getElementById("copy-absentees-btn");if(!t){console.error("Could not find the copy absentees button to attach listener.");return}t.addEventListener("click",()=>{if(!A||!J)return;const i=we(A.students).filter(s=>{const o=J.studentRecords[s.identity.studentId];return o&&o.attendance==="absent"});if(i.length===0){V("⚠️لیست غایبین خالی است.");return}const e=s=>A.sessions.reduce((o,c)=>{if(c.isDeleted||c.isCancelled)return o;const m=c.studentRecords[s.identity.studentId];return o+(m&&m.attendance==="absent"?1:0)},0),l=we(A.students),a=i.length,n=l.length-a;let r=`گزارش حضور و غیاب جلسه شماره ${Oo()}:
`;r+=`✅ حاضرین: ${n.toLocaleString("fa-IR")}
`,r+=`❌ غایبین: ${a.toLocaleString("fa-IR")}

`,r+=`لیست اسامی غایبین:
`,i.forEach(s=>{const o=e(s);r+=`- ${s.identity.name} (تعداد غیبت‌ها: ${o})
`}),navigator.clipboard.writeText(r).then(()=>{V("✅لیست غایبین با موفقیت کپی شد.")}).catch(s=>{console.error("Failed to copy text: ",s),V("❌خطا در کپی کردن لیست.")})})}function Un(){const t=document.getElementById("demo-mode-banner");t&&(mt?(t.classList.add("visible"),document.body.classList.add("demo-mode-active")):(t.classList.remove("visible"),document.body.classList.remove("demo-mode-active")))}function cs(t){const{scheduleDays:i,scheduleStartTime:e,scheduleEndTime:l}=t.info,a=i&&i.length>0,n=e&&l;if(!a&&!n)return{type:"unscheduled",sortIndex:3};if(!a||!n)return{type:"incomplete",sortIndex:2};const r=new Date,s=r.getDay(),o=r.getHours()*60+r.getMinutes(),[c,m]=e.split(":").map(Number),[p,u]=l.split(":").map(Number),h=c*60+m,y=p*60+u;if(i.includes(s)&&o>=h&&o<y)return{type:"active",sortIndex:0};for(let f=0;f<=7;f++){const v=(s+f)%7;if(i.includes(v)){if(f===0&&o>=h)continue;const b=new Date(r);return b.setDate(r.getDate()+f),b.setHours(c,m,0,0),{type:"upcoming",sortIndex:1,nextTimestamp:b.getTime()}}}return{type:"upcoming",sortIndex:1,nextTimestamp:9999999999999}}function Go(t,i){const{scheduleDays:e,scheduleStartTime:l,scheduleEndTime:a}=t.info;if(!e||!e.length||!l||!a)return null;const[n,r]=l.split(":").map(Number),[s,o]=a.split(":").map(Number),c=n*60+r,m=s*60+o;for(const p of Object.values(i)){if(p===t||p.isDeleted||p.info.name===t.info.name)continue;const u=p.info;if(!u.scheduleDays||!u.scheduleDays.length||!u.scheduleStartTime||!u.scheduleEndTime||!e.some(k=>u.scheduleDays.includes(k)))continue;const[y,f]=u.scheduleStartTime.split(":").map(Number),[v,b]=u.scheduleEndTime.split(":").map(Number),C=y*60+f,E=v*60+b;if(c<E&&m>C)return p.info.name}return null}function Vo(t){if(!t||t.length===0)return"";const i={6:"شنبه",0:"۱شنبه",1:"۲شنبه",2:"۳شنبه",3:"۴شنبه",4:"۵شنبه",5:"جمعه"};return[...t].sort((l,a)=>{const n={6:0,0:1,1:2,2:3,3:4,4:5,5:6};return n[l]-n[a]}).map(l=>i[l]).join("، ")}async function tr(){const t=document.getElementById("restore-points-list");t.innerHTML='<li style="text-align:center; padding:20px;">در حال بارگذاری...</li>';try{const i=await pi();if(i.length===0){t.innerHTML='<li style="text-align:center; padding:20px;">هیچ فایل پشتیبانی یافت نشد.</li>';return}t.innerHTML="",i.forEach(e=>{const l=document.createElement("li");l.className="restore-point-card";const a=new Date(e.timestamp).toLocaleString("fa-IR",{weekday:"long",year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"}),n=(e.file.size/1024).toFixed(1)+" KB";l.innerHTML=`
                <div class="restore-card-header">
                    <span class="restore-date">${a}</span>
                    <span class="restore-size">${n}</span>
                </div>
                <div class="restore-desc">${e.metadata.description||"بدون توضیحات"}</div>
                <div class="restore-actions">
                    <button class="btn-restore-action">بازگردانی</button>
                </div>
            `,l.querySelector(".btn-restore-action").addEventListener("click",async()=>{try{const s=await e.file.text(),m=(await new Gs().loadAsync(s,{base64:!0})).file("backup.json");if(!m)throw new Error("فایل backup.json یافت نشد.");const p=await m.async("string"),u=JSON.parse(p);os(u)}catch(s){console.error("Restore failed:",s),V("❌ فایل پشتیبان معتبر نیست.")}}),t.appendChild(l)})}catch(i){console.error("Failed to load snapshots:",i),t.innerHTML='<li style="text-align:center; color:red;">خطا در بارگذاری اطلاعات.</li>'}}function Jo(t,i,e="default",l=!1){let a=[...we(t.students)];const n=new Date().toLocaleDateString("fa-IR",{year:"numeric",month:"long",day:"numeric",weekday:"long"});e==="alpha"&&(a=En(a));let r="<tr>";i.forEach(u=>{r+=`<th>${u.label}</th>`}),r+="</tr>";let s="";a.forEach((u,h)=>{s+="<tr>",i.forEach(y=>{var C;let f="-";if(y.id==="row_num")f=h+1;else if(y.id==="name")u.identity.firstName&&u.identity.lastName?f=`${u.identity.lastName}، ${u.identity.firstName}`:f=u.identity.name;else if(y.id==="total_selections")f=u.statusCounters.totalSelections;else if(y.id==="absences")f=t.sessions.reduce((E,k)=>{if(k.isDeleted||k.isCancelled)return E;const _=k.studentRecords[u.identity.studentId];return E+(_&&_.attendance==="absent"?1:0)},0);else if(y.id==="exit_count")f=u.statusCounters.outOfClassCount||0;else if(y.id==="missed_chances")f=u.statusCounters.missedChances;else if(y.id==="issues")f=Object.values(u.categoryIssues||{}).reduce((E,k)=>E+k,0);else if(y.id==="avg_score")f=u.getOverallAverageScore()||"-";else if(y.id==="final_score")f=t.calculateFinalStudentScore(u)||"-";else if(y.type==="category")f=u.categoryCounts[y.id]||0;else if(y.type==="category_scores"){const E=y.id.toLowerCase(),k=((C=u.logs.scores[E])==null?void 0:C.filter(_=>!_.isDeleted))||[];f=k.length>0?k.map(_=>_.value).join("، "):"-"}let v="text-align: center;";y.id==="name"?v="text-align: right; white-space: nowrap;":y.type==="category_scores"&&(v="text-align: center; white-space: nowrap;");const b=`style="${v}"`;s+=`<td ${b}>${f}</td>`}),s+="</tr>"});let o="";l&&(o=`
            <div class="warning-footnote">
                ⚠️ <strong>توجه:</strong> ترتیب الفبایی این لیست ممکن است دقیق نباشد. (نام خانوادگی برخی دانش‌آموزان در سیستم تفکیک نشده است)
            </div>
        `);const c=Array.from(document.querySelectorAll('link[rel="stylesheet"]')).map(u=>u.outerHTML).join(""),m=window.open("","_blank");if(!m){V("⚠️ مرورگر شما پنجره جدید را مسدود کرد. لطفاً اجازه دهید.","error");return}const p=`
        <!DOCTYPE html>
        <html lang="fa" dir="rtl">
        <head>
            <title>گزارش کلاس ${t.info.name}</title>
            ${c} <style>
                @media print {
                    @page { size: A4; margin: 10mm; }
                    /* Updated Font Family */
                    body { font-family: 'Vazirmatn', 'Vazir', Tahoma, sans-serif; color: #000; }
                }
                /* Updated Font Family */
                body { font-family: 'Vazirmatn', 'Vazir', Tahoma, sans-serif; padding: 20px; direction: rtl; }
                h1 { text-align: center; margin-bottom: 5px; font-size: 24px; }
                .meta { text-align: center; margin-bottom: 30px; font-size: 14px; color: #444; }
                table { width: 100%; border-collapse: collapse; font-size: 12px; }
                th, td { border: 1px solid #333; padding: 6px 8px; text-align: center; }
                th { background-color: #eee; font-weight: bold; }
                tr:nth-child(even) { background-color: #f9f9f9; }
                .signature { margin-top: 50px; display: flex; justify-content: space-between; padding: 0 50px; }
                
                .warning-footnote {
                    margin-top: 20px;
                    font-size: 11px;
                    color: #555;
                    font-style: italic;
                    border-top: 1px solid #ccc;
                    padding-top: 10px;
                }
            </style>
        </head>
        <body>
            <h1>گزارش وضعیت کلاس ${t.info.name}</h1>
            <div class="meta">
                تاریخ گزارش: ${n} | تعداد دانش‌آموزان: ${a.length}
            </div>
            <table>
                <thead>${r}</thead>
                <tbody>${s}</tbody>
            </table>
            ${o}
            <div class="signature">
                <div>امضای معلم</div>
                <div>مهر و امضای مدرسه</div>
            </div>
            <script>
                window.onload = function() { window.print(); }
            <\/script>
        </body>
        </html>
    `;m.document.write(p),m.document.close()}function Ko(t){const i=Di;i.innerHTML="";const l=we(t.students).filter(u=>!u.identity.lastName).length,a=[{id:"row_num",label:"ردیف",checked:!0},{id:"name",label:"نام دانش‌آموز",checked:!0},{id:"total_selections",label:"کل انتخاب‌ها",checked:!0},{id:"absences",label:"تعداد غیبت",checked:!0},{id:"exit_count",label:"تعداد خروج",checked:!1},{id:"missed_chances",label:"فرصت سوخته",checked:!1},{id:"issues",label:"مشکل‌پاسخگویی",checked:!1},{id:"avg_score",label:"میانگین نمرات",checked:!0},{id:"final_score",label:"نمره نهایی (کانون)",checked:!0}];t.categories.forEach(u=>{u.isDeleted||(a.push({id:u.name,label:`تعداد ${u.name}`,type:"category",checked:!1}),u.isGradedCategory&&a.push({id:u.name,label:`نمرات ${u.name}`,type:"category_scores",checked:!1}))}),a.forEach(u=>{const h=document.createElement("label");h.className="report-column-item";const y=document.createElement("input");y.type="checkbox",y.checked=u.checked,y.dataset.colId=u.id,y.dataset.colLabel=u.label,u.type&&(y.dataset.colType=u.type);const f=document.createElement("span");f.textContent=u.label,h.appendChild(y),h.appendChild(f),i.appendChild(h)});const n=i.parentElement,r=n.querySelector("#report-sort-options");r&&r.remove();const s=document.createElement("div");s.id="report-sort-options",s.style.marginTop="20px",s.style.padding="15px",s.style.backgroundColor="#f8f9fa",s.style.borderRadius="5px",s.style.border="1px solid #e9ecef",s.innerHTML=`
        <div style="margin-bottom: 10px; font-weight: bold; color: #333;">ترتیب نمایش لیست:</div>
        
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <label style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <input type="radio" name="report-sort" value="alpha" checked style="accent-color: var(--color-primary);">
                <span>بر اساس نام خانوادگی</span>
            </label>

            <label style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <input type="radio" name="report-sort" value="default" style="accent-color: var(--color-primary);">
                <span>بر اساس زمان ورود به کلاس</span>
            </label>
        </div>

        <div id="sort-warning" style="
            display: none; 
            margin-top: 12px; 
            background-color: #fff3cd; 
            color: #856404; 
            padding: 10px; 
            border-radius: 4px; 
            font-size: 13px; 
            border: 1px solid #ffeeba;
            line-height: 1.5;
        ">
            ⚠️ <strong>توجه:</strong> نام خانوادگی ${l} دانش‌آموز هنوز تفکیک نشده است. مرتب‌سازی این موارد ممکن است کاملاً دقیق نباشد.
        </div>
    `;const o=n.querySelector(".modal-actions");n.insertBefore(s,o);const c=s.querySelectorAll('input[name="report-sort"]'),m=s.querySelector("#sort-warning"),p=()=>{const u=s.querySelector('input[value="alpha"]').checked;m.style.display=u&&l>0?"block":"none"};c.forEach(u=>u.addEventListener("change",p)),p(),Ai.onclick=()=>{const u=[];if(i.querySelectorAll('input[type="checkbox"]:checked').forEach(v=>{u.push({id:v.dataset.colId,label:v.dataset.colLabel,type:v.dataset.colType})}),u.length===0){V("⚠️ لطفاً حداقل یک ستون را انتخاب کنید.");return}const y=s.querySelector('input[name="report-sort"]:checked').value,f=y==="alpha"&&l>0;ge(),Jo(t,u,y,f)},Oi.onclick=()=>{ge()},ze("report-config-modal")}function Yo(t,i){const e=document.createElement("div");e.className="qualitative-button-container";const l=Ve,a=l!==-1&&J.winnerHistory[l],n=a?J.winnerHistory[l]:null,r=J.studentRecords[t.identity.studentId];t.qualitativeStats||(t.qualitativeStats={}),t.qualitativeStats[i]||(t.qualitativeStats[i]={effort:0,good:0,excellent:0}),r.performanceRatings||(r.performanceRatings={});const s=a?n.rating:r.performanceRatings[i],o=J.isFinished||r.attendance==="absent"||r.hadIssue||r.wasOutOfClass;return[{key:"effort",label:"تلاش",className:"effort-btn"},{key:"good",label:"خوب",className:"good-btn"},{key:"excellent",label:"عالی",className:"excellent-btn"}].forEach(m=>{const p=document.createElement("button");p.className=`qualitative-btn ${m.className}`,p.textContent=m.label,p.disabled=o,s===m.key&&p.classList.add("active"),p.addEventListener("click",()=>{const u=m.key;s&&t.qualitativeStats[i][s]>0&&t.qualitativeStats[i][s]--,s!==u&&(t.qualitativeStats[i][u]=(t.qualitativeStats[i][u]||0)+1);const h=s===u?null:u;a?n.rating=h:h?r.performanceRatings[i]=h:delete r.performanceRatings[i],oe(),Ae()}),e.appendChild(p)}),e}function xa(t,i,e="custom",l=null){t.innerHTML="",Object.values(Ra).forEach(n=>{const r=document.createElement("option");r.value=n.id,r.textContent=n.label,t.appendChild(r)}),t.value=e;const a=n=>{i.innerHTML="";const r=Ra[n];if(r&&r.levels.length>0)r.levels.forEach(s=>{const o=document.createElement("option");o.value=s,o.textContent=s,i.appendChild(o)}),i.disabled=!1;else{const s=document.createElement("option");s.value="",s.textContent="---",i.appendChild(s),i.disabled=!0}};a(e),l&&(i.value=l),t.onchange=()=>{a(t.value),i.dispatchEvent(new Event("change"))}}function nr(){vn.value="",xa(ss,va,"custom"),ze("add-class-modal");const t=[{label:"شنبه",value:6},{label:"یکشنبه",value:0},{label:"دوشنبه",value:1},{label:"سه‌شنبه",value:2},{label:"چهارشنبه",value:3},{label:"پنج‌شنبه",value:4},{label:"جمعه",value:5}];is.innerHTML="",t.forEach(i=>{const e=document.createElement("label"),l=document.createElement("input");l.type="checkbox",l.value=i.value,e.appendChild(l),e.appendChild(document.createTextNode(i.label)),is.appendChild(e)}),rn.addEventListener("click",()=>{rn.classList.toggle("open"),Hi.classList.toggle("open");const i=rn.querySelector(".arrow");i.textContent=rn.classList.contains("open")?"▼":"▶"}),vn.focus()}function sr(){Zt.value="",ms.checked=!1,rs.value=1,Wi.style.display="none",ze("category-modal"),Zt.focus()}function Zs(){ge()}const Fa=Object.freeze(Object.defineProperty({__proto__:null,_internalShowPage:fn,addClassModal:Nr,addNoteModal:io,addScoreBtn:fo,addStudentBtn:Rr,appHeader:Rs,assessmentModeLabel:Zr,attendanceListUl:ln,attendanceMassActionsContainer:zn,attendancePage:Gr,attendancePane:Vt,attendanceSearchInput:Lt,backToSessionsBtn:Or,backToStudentPageBtn:co,backupDataBtn:eo,breadcrumbContainer:Wt,cancelAddClassBtn:Ns,cancelImportBtn:qr,cancelNoteBtn:oo,categoryListUl:As,categoryModal:Eo,categoryModalCancelBtn:So,categoryModalSaveBtn:Ri,categoryModalTitle:Mi,categoryWeightLabel:Rn,classListHeader:Jr,classListUl:Nt,classManagementPage:Si,classSaveNoteBtn:ro,closeActiveModal:ge,closeAddClassModal:Zs,closeContextMenu:Bt,closeNavBtn:Xr,columnMappingPage:Ur,columnSelectDropdown:Ms,confirmAddClassBtn:Bs,confirmColumnBtn:jr,confirmModalCancelBtn:zs,confirmModalConfirmBtn:nn,confirmModalMessage:Li,contextMenu:Ot,csvCancelBtn:Fr,csvConfirmBtn:Pr,csvFileInput:Wr,csvPreviewList:Os,csvPreviewPage:zr,customConfirmModal:no,displayWinner:Ae,finishAttendanceBtn:Vr,globalStudentSearchInput:sn,globalStudentSearchResultsDiv:ft,gradedCategoryPillsContainer:lo,hamburgerMenuBtn:Kr,handleUndo:ji,importCsvBtn:Hr,initiateBackupProcess:bn,massCommentAppendCheckbox:ba,massCommentBtn:Hs,massCommentCancelBtn:Io,massCommentContent:un,massCommentModal:ko,massCommentModalTitle:_o,massCommentSaveBtn:xo,massCommentStudentCountMessage:$i,modalAddClassLevelSelect:va,modalAddClassSystemSelect:ss,modalNewClassNameInput:vn,modalScheduleContent:Hi,modalScheduleDaysContainer:is,modalScheduleEndTimeInput:Fi,modalScheduleStartTimeInput:Pi,modalScheduleTextInput:zi,modalScheduleToggle:rn,newCategoryModal:To,newCategoryModalIsGradedCheckbox:ms,newCategoryModalNameInput:Zt,newCategoryModalWeightGroup:Wi,newCategoryModalWeightInput:rs,newNoteContent:Se,newScoreCommentTextarea:Ni,newScoreValueInput:uo,newStudentNameInput:Mr,openAddCategoryBtn:Bo,openAddCategoryModal:sr,openAddClassModal:nr,openAddClassModalBtn:Br,openContextMenu:Sn,openModal:ze,overlay:Qr,pasteArea:Ii,populateSystemLevelSelects:xa,processMassHomeworkComment:Us,processPasteBtn:$r,profileScoresListUl:ho,profileStatsSummaryDiv:mo,quickGradeFormWrapper:Ut,quickGradeSubmitBtn:At,quickNoteTextarea:ct,quickScoreInput:pt,renderAttendancePage:nt,renderBreadcrumbs:Gi,renderClassList:We,renderClassManagementStats:ps,renderColumnSelector:Xi,renderGlobalSearchResults:Wn,renderImportPreview:qs,renderLogModal:Zi,renderMassCommentControls:Ea,renderRestorePointsPage:tr,renderScoresHistory:Ki,renderSearchResults:on,renderSessionDashboard:Jt,renderSessions:Ge,renderSettingsCategories:Xt,renderSettingsOther:Qi,renderSettingsStudentList:_t,renderStudentNotes:Yi,renderStudentStatsList:$e,renderTrashPage:wn,reportCancelBtn:Oi,reportColumnsContainer:Di,reportConfigModal:wo,reportPrintBtn:Ai,restoreDataBtn:to,restoreFileInput:xi,secureConfirmCancelBtn:ao,secureConfirmCode:Bi,secureConfirmConfirmBtn:$n,secureConfirmInput:Ht,secureConfirmMessage:Ti,secureConfirmModal:so,selectStudentBtn:Ye,selectStudentBtnWrapper:Dt,sessionDashboardPage:Lo,setAutoDirectionOnInput:_a,settingsClassNameHeader:_i,settingsEduSystemSelect:Pn,settingsLevelSelect:an,settingsPage:Ar,settingsStudentListUl:Ds,setupDashboardTabs:Ui,setupLongPress:jt,showCategoryModal:Ws,showClassNoteModal:hs,showCustomConfirm:be,showMassCommentModal:Sa,showMoveStudentModal:Ca,showNotification:V,showPage:ye,showRenameStudentModal:wa,showRestoreConfirmModal:os,showSecureConfirm:qi,showSessionNoteModal:ka,showSettingsPage:kt,showStudentProfile:He,showUndoToast:No,sideNavMenu:Yr,studentSearchInput:Ps,studentSearchResultsDiv:Ct,studentStatsHeader:$s,switchDashboardTab:Kt,trashedCategoriesList:vo,trashedClassesList:po,trashedNotesList:bo,trashedScoresList:Co,trashedSessionsList:yo,trashedStudentsList:go,triggerFileDownload:js,undoBtn:Dr,undoMessage:ki,undoToast:as,updateCategoryColumnHighlight:Yt,updateDemoModeBanner:Un,updateQuickGradeUIForCategory:Cn},Symbol.toStringTag,{value:"Module"}));let Ha=0,Is=!1;function Xo(){const t=window.location.hash;if(!t||t==="#")return!1;const[i,e]=t.split("?"),l=i.substring(1),a=new URLSearchParams(e),n=a.get("class"),r=parseInt(a.get("session"),10),s=a.get("student"),o=a.get("tab")||"selector";if(n&&re[n])qe(re[n]),r&&A.getSession(r)&&Xe(A.getSession(r)),s&&A.students.find(c=>c.identity.studentId===s)&&et(A.students.find(c=>c.identity.studentId===s));else return!1;switch(l){case"session-page":Ge(),ye("session-page");break;case"session-dashboard-page":Jt(l==="attendance-page"?"attendance":o);break;case"settings-page":kt(A);break;case"student-profile-page":Jt(o),He(_e);break;default:return!1}return!0}document.addEventListener("DOMContentLoaded",()=>{const{globalStudentSearchInput:t,undoBtn:i,newStudentNameInput:e,addStudentBtn:l,pasteArea:a,processPasteBtn:n,csvPreviewList:r,csvConfirmBtn:s,csvCancelBtn:o,importCsvBtn:c,csvFileInput:m,columnSelectDropdown:p,confirmColumnBtn:u,cancelImportBtn:h,selectStudentBtn:y,attendancePage:f,finishAttendanceBtn:v,classListHeader:b,studentStatsHeader:C,hamburgerMenuBtn:E,sideNavMenu:k,closeNavBtn:_,overlay:x,backupDataBtn:L,restoreDataBtn:N,restoreFileInput:R,confirmModalCancelBtn:U,confirmModalConfirmBtn:ee,secureConfirmCancelBtn:I,secureConfirmConfirmBtn:$,newNoteContent:g,classSaveNoteBtn:W,cancelNoteBtn:fe,studentSearchInput:q,studentSearchResultsDiv:me,categoryModalSaveBtn:P,categoryModalCancelBtn:se,massCommentBtn:O,massCommentCancelBtn:M,massCommentSaveBtn:le,massCommentContent:te,massCommentAppendCheckbox:Q,attendanceSearchInput:Le,newCategoryModalNameInput:Oe,newCategoryModalIsGradedCheckbox:he,newCategoryModalWeightInput:Ee,newCategoryModalWeightGroup:Te,openAddCategoryBtn:Me}=Fa,st=document.getElementById("trash-nav-btn");document.querySelector(".global-search-container .search-icon"),Yn(),Un(),Xo()||(We(),ye("class-management-page"));function d(B,F){const H=document.querySelector(B);if(!H)return;const K=H.querySelector(".search-icon"),ie=H.querySelector(".animated-search-input");!K||!ie||(K.addEventListener("mousedown",de=>{de.preventDefault()}),K.addEventListener("click",()=>{H.classList.contains("search-active")||(H.classList.add("search-active"),ie.focus())}),ie.addEventListener("blur",()=>{setTimeout(()=>{H.classList.remove("search-active"),ie.value="",F&&F([])},150)}))}Le.addEventListener("input",()=>{const B=Le.value.toLowerCase().trim(),F=Mn(B);ln.querySelectorAll(".attendance-list-item").forEach(K=>{const ie=K.querySelector(".student-name");if(ie){const de=ie.textContent,ne=je(de.toLowerCase()),ce=ne.includes(je(B)),pe=ne.includes(je(F));ce||pe?K.style.display="flex":K.style.display="none"}})}),se.addEventListener("click",()=>{ge(),gn(null)}),P.addEventListener("click",()=>{const B=Oe.value.trim(),F=he.checked,H=parseInt(Ee.value,10)||1;if(!B){V("⚠️ نام دسته‌بندی نمی‌تواند خالی باشد.");return}typeof Vn=="function"&&Vn(B,F,H),ge(),V(`✅ دسته‌بندی جدید ${B} با موفقیت اضافه شد.`),Xt()}),window.addEventListener("scroll",Bt),document.addEventListener("click",B=>{Ot.classList.contains("visible")&&!Ot.contains(B.target)&&Bt(),q.contains(B.target)||(me.style.display="none");const F=B.target.closest(".log-action-link");if(F&&F.dataset.action)try{const H=JSON.parse(F.dataset.action);ar(H)}catch(H){console.error("Could not parse log action:",H)}}),Dt.addEventListener("click",()=>{(Dt.classList.contains("disabled-wrapper")||Ye.disabled)&&(Ye.classList.add("shake-animation"),setTimeout(()=>{Ye.classList.remove("shake-animation")},200))}),C.addEventListener("click",()=>{const B=new Date().getTime();B-Xs>500?An(1):An(Zn+1),ui(B),Zn===5&&(An(0),be("آیا از صفر کردن تمام شمارنده‌های دانش‌آموزان مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{ai(),$e(),V("تمام آمارها صفر شدند ✅.")},{confirmText:"بله",confirmClass:"btn-warning"}))}),b.addEventListener("click",()=>{const B=new Date().getTime();B-Ys>500?Dn(1):Dn(qn+1),di(B),qn===5&&(Dn(0),be("آیا از ساخت یک کلاس تستی تصادفی مطمئن هستید؟",()=>{function F(){const H=`کلاس تستی ${Object.keys(re).length+1}`,K=new Ls({name:H,type:"online"});["علی رضایی","مریم حسینی","زهرا احمدی","رضا محمدی","فاطمه کریمی"].forEach(de=>K.addStudent(new Bn({name:de}))),re[H]=K,oe(),We()}F(),V("کلاس تستی با موفقیت ساخته شد ✅!")},{confirmText:"بساز",confirmClass:"btn-success"}))}),document.querySelector(".app-header h1").addEventListener("click",()=>{Ha++,Ha===10&&(window.dev={state:$a,ui:Fa,utils:Er,db:wr},console.log("🛠️ Developer Mode Activated! Access modules via the 'dev' object (e.g., dev.state.currentClassroom)"),V("🛠️ حالت توسعه‌دهنده فعال شد."),document.querySelector(".app-header h1").style.color="var(--color-primary)",document.querySelector(".app-header h1").classList.add("dev-mode-tilt"))}),I.addEventListener("click",()=>{ge(),pn(null)});const j=document.getElementById("date-picker-confirm-btn"),z=document.getElementById("date-picker-cancel-btn"),S=document.getElementById("dp-day"),w=document.getElementById("dp-month"),T=document.getElementById("dp-year");j.addEventListener("click",()=>{const B=T.value,F=w.value,H=S.value;B&&F&&H&&typeof Kn=="function"?(Kn({jy:B,jm:F,jd:H}),ge()):V("⚠️ خطا در انتخاب تاریخ."),es(null)}),z&&z.addEventListener("click",()=>{ge(),es(null)}),$.addEventListener("click",()=>{typeof Gn=="function"&&Gn(),ge(),pn(null)}),U.addEventListener("click",()=>{ge(ea)}),ee.addEventListener("click",()=>{ge(Qs)}),Ye.addEventListener("click",()=>{if(Is){Is=!1;return}if(pt.value.trim()!==""||ct.value.trim()!==""){V("⚠️لطفاً ابتدا با دکمه «ثبت»، تغییرات را ذخیره کنید و یا نمره و یادداشت را پاک کنید.");return}if(Tt){const B=nc(A,Re);B?($e(),Ae(B,Re.name),Yt(Re.name),oe()):be("برای تمام دانش‌آموزان در این جلسه یک بار فرصت نمره‌گیری فراهم شده؛ آیا می‌خواهید برای بار دوم این کار را تکرار کنید؟",()=>{const F=Re.id;rt[F].scoredThisSession=[],Ye.click()},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})}else{if(!A||!J||!Re)return;const B=A.selectNextWinner(Re.name,J);if(B){Ts();const F=J.studentRecords[B.identity.studentId];(F==null?void 0:F.attendance)==="absent"&&B.statusCounters.missedChances++,F!=null&&F.hadIssue&&(B.statusCounters.missedChances++,B.categoryIssues[Re.name]=(B.categoryIssues[Re.name]||0)+1),F!=null&&F.wasOutOfClass&&(B.statusCounters.outOfClassCount=(B.statusCounters.outOfClassCount||0)+1,B.statusCounters.missedChances++);const H={winner:B,categoryName:Re.name};J.winnerHistory.push(H),J.winnerHistory.length>10&&J.winnerHistory.shift(),vt(J.winnerHistory.length-1),J.lastUsedCategoryId=Re.id,J.lastSelectedWinnerId=B.identity.studentId,$e(),setTimeout(()=>Ae(),0),oe()}else V("❌دانش‌آموز واجد شرایطی برای انتخاب یافت نشد.")}}),document.querySelectorAll('#settings-page input[name="class-type-setting"]').forEach(B=>{B.addEventListener("change",()=>{if(!A)return;const F=B.value,H=A.info.type||"in-person";if(F===H)return;const K=ne=>ne==="online"?"آنلاین":"حضوری",ie=K(H),de=K(F);be(`آیا از تغییر نوع کلاس از «${ie}» به «${de}» مطمئن هستید؟`,()=>{A.info.type=F,oe(),ke(A.info.name,`نوع کلاس به «${de}» تغییر یافت.`,{type:"VIEW_CLASS_SETTINGS"}),We(),V(`✅ نوع کلاس به «${de}» تغییر یافت.`)},{confirmText:"بله",confirmClass:"btn-warning",onCancel:()=>{const ne=document.querySelector(`#settings-page input[name="class-type-setting"][value="${H}"]`);ne&&(ne.checked=!0)}})})});const G=document.querySelectorAll('input[name="schedule-day"]'),D=document.getElementById("settings-schedule-start"),Y=document.getElementById("settings-schedule-end");G.forEach(B=>{B.addEventListener("change",()=>{if(!A)return;const F=Array.from(G).filter(H=>H.checked).map(H=>parseInt(H.value));A.info.scheduleDays=F,oe()})});const ae=()=>{A&&(A.info.scheduleStartTime=D.value,A.info.scheduleEndTime=Y.value,oe())};D.addEventListener("change",ae),Y.addEventListener("change",ae),u.addEventListener("click",()=>{if(!jn){alert("❌خطایی رخ داده است. لطفاً فایل را دوباره انتخاب کنید."),ye("settings-page");return}const B=parseInt(p.value,10),K=jn.split(`
`).slice(1).map(ie=>{var ne;return(ne=ie.split(",")[B])==null?void 0:ne.trim()}).filter(ie=>ie&&ie.length>0);K.length>0?(tn(K),qs(),ye("csv-preview-page")):alert("هیچ نامی در ستون انتخاب شده پیدا نشد. لطفاً ستون دیگری را امتحان کنید یا فایل خود را بررسی کنید."),Nn(null)}),c.addEventListener("click",()=>{m.click()}),m.addEventListener("change",B=>{const F=B.target.files[0];if(!F)return;const H=new FileReader;H.onload=K=>{const ie=K.target.result;Nn(ie);const ne=ie.split(`
`)[0].split(",");Xi(ne),ye("column-mapping-page")},H.readAsText(F),B.target.value=null}),h.addEventListener("click",()=>{Nn(null),ye("settings-page")}),s.addEventListener("click",()=>{const B=r.querySelectorAll('input[type="checkbox"]:checked');let F=0,H=[],K=!1;B.forEach(de=>{const ne=de.dataset.name,ce=cn(ne),pe=je(ce.name),Ce=A.students.find(Ke=>je(Ke.identity.name)===pe&&pe!=="");if(Ce)if(Ce.isDeleted)ds(Ce,A);else{H.push(ce.name);return}const Be=new Bn(ce);A.addStudent(Be),A.sessions.length>0&&(we(A.sessions).filter(Ke=>Ke.isFinished&&!Ke.isCancelled).forEach(Ke=>{Ke.setAttendance(Be.identity.studentId,"absent")}),Qt(Be,A),K=!0),F++}),oe(),F>0&&ke(A.info.name,`${F} دانش‌آموز جدید از لیست ورودی به کلاس اضافه شدند.`,{type:"VIEW_SESSIONS"}),kt(A);let ie=H.length>0?`⚠️ موارد زیر به دلیل تکراری بودن نادیده گرفته شدند:
- ${H.join(`
- `)}`:"";if(K)kn(F,ie);else if(H.length>0||F>0){const de=F>0?`✅ ${F} دانش‌آموز با موفقیت اضافه شدند.
${ie}`:ie;be(de,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}a.value="",tn([])}),o.addEventListener("click",()=>{tn([]),ye("settings-page")}),a.addEventListener("keydown",B=>{if(B.key==="Enter"){const F=a.value,H=a.selectionStart,K=F.lastIndexOf(`
`,H-1),ie=F.substring(K+1,H).trim(),de=ie.indexOf(".");ie&&(de<=0||de>=ie.length-1)&&(B.preventDefault(),V("لطفا یک نقطه بین نام و نام خانوادگی قرار دهید. مثال: علی . احمدی"))}}),n.addEventListener("click",()=>{const B=a.value.trim();if(!B){V("کادر متنی خالی است. لطفاً اسامی را وارد کنید.");return}const F=B.split(`
`).map(K=>K.trim()).filter(K=>K.length>0),H=F.find(K=>{const ie=K.indexOf(".");return ie<=0||ie>=K.length-1});if(H){V(`فرمت نام «${H}» صحیح نیست. لطفا نام و نام خانوادگی را با نقطه جدا کنید.`);return}F.length>0?(tn(F),qs(),ye("csv-preview-page")):V("هیچ نام معتبری برای ورود پیدا نشد.")}),e.addEventListener("keyup",B=>{B.key==="Enter"&&l.click()}),l.addEventListener("click",()=>{if(!A)return;const B=e.value.trim();if(!B){alert("لطفاً نام دانش‌آموز را وارد کنید.");return}const F=B.indexOf(".");if(F<=0||F>=B.length-1){V("لطفا یک نقطه بین نام و نام خانوادگی قرار دهید. مثال: علی . احمدی");return}const H=cn(e.value),K=je(H.name);if(we(A.students).some(ce=>je(ce.identity.name)===K)){alert(`دانش‌آموز «${H.name}» قبلاً در لیست وجود دارد.`);return}const de=cn(B),ne=new Bn(de);A.addStudent(ne),A.sessions.length>0&&(we(A.sessions).filter(ce=>ce.isFinished&&!ce.isCancelled).forEach(ce=>{ce.setAttendance(ne.identity.studentId,"absent")}),Qt(ne,A),kn(1)),oe(),ke(A.info.name,`دانش‌آموز «${B}» به کلاس اضافه شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:ne.identity.studentId}),_t(),$e(),e.value="",e.focus()}),document.getElementById("new-session-btn").addEventListener("click",()=>{if(A){const B=A.sessions.find(H=>!H.isFinished&&!H.isCancelled&&!H.isDeleted);if(B){V(`⚠️ جلسه ${B.sessionNumber} هنوز تمام نشده است. لطفاً ابتدا با دکمه ✅ آن را خاتمه دهید.`);return}const F=()=>{const H=K=>{const ie=A.startNewSession();hn(ie),Xe(ie),A.students.forEach(ce=>{Vs.setAttendance(ce.identity.studentId,"present")}),oe();const ne=ot(A).get(ie.sessionNumber);ke(A.info.name,`جلسه ${ne} شروع شد.`,{type:"VIEW_SESSIONS"}),Jt(K?"attendance":"selector")};be("آیا تمایل به انجام فرآیند حضور و غیاب دارید؟",()=>H(!0),{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success",onCancel:()=>H(!1)})};A.hasSessionToday()?be("شما امروز یک جلسه برای این کلاس ثبت کرده‌اید. آیا از شروع یک جلسه جدید دیگر مطمئن هستید؟",F,{confirmText:"بله",confirmClass:"btn-warning"}):F()}});const X=document.getElementById("open-add-class-modal-btn");X&&X.addEventListener("click",()=>{nr()}),Ns&&Ns.addEventListener("click",()=>{Zs()}),Bs?Bs.addEventListener("click",()=>{var H;const B=vn;if(!B){console.error("❌ DEBUG: Name Input element is missing!");return}const F=B.value.trim();if(!F){alert("لطفاً نام کلاس را وارد کنید.");return}if(re[F]){alert("کلاسی با این نام قبلاً ایجاد شده است.");return}try{const K=document.querySelector('input[name="modal-class-type"]:checked');if(!K){console.error("❌ DEBUG: Class Type radio not selected or found!");return}const ie=K.value,de=ss.value,ne=vn.value.trim();if(!ne){V("⚠️ لطفاً نام کلاس را وارد کنید.");return}if(re[ne]){V("⚠️ کلاسی با این نام وجود دارد.");return}const ce=((H=document.querySelector('input[name="modal-class-type"]:checked'))==null?void 0:H.value)||"in-person",pe=ss.value,Ce=va.value||null,Be=zi.value.trim()||null,Ke=Array.from(is.querySelectorAll("input:checked")).map(Ie=>parseInt(Ie.value,10)),Cs=Pi.value||null,ws=Fi.value||null,gt=new Ls({name:ne,type:ce,educationalSystem:pe,level:Ce,scheduleText:Be,scheduleDays:Ke,scheduleStartTime:Cs,scheduleEndTime:ws});re[ne]=gt,oe(),ge(),We(),V(`✅ کلاس «${ne}» ایجاد شد.`),re[F]=gt,oe(),We(),Zs()}catch(K){console.error("❌ CRASH ERROR:",K),alert("خطایی رخ داد: "+K.message)}}):console.error("❌ DEBUG: Create Button (ui.confirmAddClassBtn) is NOT found!"),t.addEventListener("input",B=>{const F=B.target.value;if(F.length<2){Wn([]);return}const H=F.toLowerCase(),K=Mn(H),ie=[];for(const de in re){const ne=re[de];if(ne.isDeleted)continue;const ce=je(de.toLowerCase()),pe=ce.includes(je(H)),Ce=ce.includes(je(K));(pe||Ce)&&ie.push({type:"classroom",classroom:ne})}for(const de in re){const ne=re[de];if(ne.isDeleted)continue;we(ne.students).filter(pe=>{const Ce=je(pe.identity.name.toLowerCase()),Be=Ce.includes(je(H)),Ke=Ce.includes(je(K));return Be||Ke}).forEach(pe=>{ie.push({type:"student",student:pe,classroom:ne})})}Wn(ie)}),i.addEventListener("click",ji),v.addEventListener("click",()=>{Kt("selector")}),q.addEventListener("input",B=>{const F=B.target.value;if(!F){on([]);return}const H=F.toLowerCase(),K=Mn(H),de=we(A.students).filter(ne=>{const ce=je(ne.identity.name.toLowerCase()),pe=ce.includes(je(H)),Ce=ce.includes(je(K));return pe||Ce});on(de)}),q.addEventListener("focus",()=>{q.value&&on(q.value)}),At.addEventListener("click",()=>{const B=pt.value,F=ct.value.trim();let H;if(Jn)H=Jn.student;else{const ie=J==null?void 0:J.winnerHistory[Ve];H=ie==null?void 0:ie.winner}if(!H){V("❌خطا: دانش‌آموز معتبری برای ثبت نمره یافت نشد.");return}const K=Re;if(!H||!K){V("⚠️لطفاً ابتدا یک دانش‌آموز و یک دسته‌بندی را انتخاب کنید.");return}if(!B){V("⚠️لطفاً مقدار نمره را وارد کنید.");return}if(B>100||B<0){V("❌نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}H&&(H.addScore(K.name,parseFloat(B),F),ke(A.info.name,`نمره ${B} در ${K.name} برای «${H.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:H.identity.studentId}),oe(),$e(),V(`✅نمره برای ${H.identity.name} در مهارت ${K.name} ثبت شد.`),fa(Re.id,H.identity.studentId),pt.value="",ct.value="",Ae())});const ue=B=>{B.key==="Enter"&&B.ctrlKey&&(B.preventDefault(),At.click())};pt.addEventListener("keydown",ue),ct.addEventListener("keydown",ue),fe.addEventListener("click",()=>{ge()}),W.addEventListener("click",()=>{const B=g.value.trim(),F=ta;if(typeof F=="function"){const H=F(B);if(H===!1)return;ge(()=>{typeof H=="function"&&H()})}else ge()});const xe=document.getElementById("move-student-confirm-btn"),ve=document.getElementById("move-student-cancel-btn"),Je=document.getElementById("move-student-class-select");ve.addEventListener("click",()=>{ge()}),xe.addEventListener("click",()=>{const B=Je.value,F=re[B],{studentToMove:H,sourceClassForMove:K}=$a;if(!H||!K||!F){V("خطایی رخ داد. لطفاً دوباره امتحان کنید⚠️.","error"),ge();return}const ie=si(H,K,F);ie.success?(ke(K.info.name,`دانش‌آموز «${H.identity.name}» به کلاس «${B}» منتقل شد.`,{type:"VIEW_SESSIONS"}),ke(B,`دانش‌آموز «${H.identity.name}» از کلاس «${K.info.name}» به این کلاس منتقل شد.`,{type:"VIEW_SESSIONS"}),oe(),_t(),$e(),nt(),V(`دانش‌آموز «${H.identity.name}» با موفقیت به کلاس «${B}» منتقل شد✅.`)):V(ie.message,"error"),ge()}),E.addEventListener("click",()=>{k.style.width="300px",x.classList.add("modal-visible")}),E.addEventListener("click",()=>{k.style.width="300px",x.classList.add("modal-visible")});const bt=document.getElementById("header-settings-btn");bt&&bt.addEventListener("click",()=>{A&&kt(A)}),_.addEventListener("click",Pe),_.addEventListener("click",Pe),x.addEventListener("click",Pe),st.addEventListener("click",()=>{wn(),ye("trash-page"),Pe()});const Qe=document.getElementById("restore-points-nav-btn");Qe&&Qe.addEventListener("click",()=>{tr(),ye("restore-points-page"),Pe()}),document.getElementById("demo-mode-btn").addEventListener("click",()=>{mt?zt():(Pe(),be("شما در حال ورود به حالت نمایش (Demo) هستید. در این حالت، هیچ‌کدام از تغییرات شما ذخیره نخواهد شد. آیا ادامه می‌دهید؟",()=>{ii(),Un(),Pe()},{confirmText:"تایید",confirmClass:"btn-warning",onCancel:Pe}))});const De=document.getElementById("exit-demo-btn");De&&De.addEventListener("click",()=>{mt&&zt()}),L.addEventListener("click",()=>{if(mt){V("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است."),Pe();return}Pe(),bn()}),N.addEventListener("click",()=>{if(mt){V("⚠️ بازیابی اطلاعات در حالت نمایش (Demo) غیرفعال است."),Pe();return}R.click(),Pe()}),R.addEventListener("change",B=>{const F=B.target.files[0];if(!F)return;const H=new FileReader;H.onload=async K=>{const ie=K.target.result;try{const de=JSON.parse(ie);if(de.metadata&&de.data)os(de);else{const ne=de.classrooms||de,ce=de.trashBin||[];be("آیا از بازیابی اطلاعات مطمئن هستید؟ تمام داده‌های فعلی شما بازنویسی خواهد شد.",()=>{Rt(ne),da(ce),wt({lastRestoreTimestamp:new Date().toISOString()}),oe(),We(),ye("class-management-page"),V("✅اطلاعات با موفقیت بازیابی شد.")},{confirmText:"بازیابی کن",confirmClass:"btn-warning"})}}catch{try{const pe=(await new Gs().loadAsync(ie,{base64:!0})).file("backup.json");if(!pe)throw new Error("فایل backup.json در فایل پشتیبان یافت نشد.");const Ce=await pe.async("string"),Be=JSON.parse(Ce);if(Be.metadata&&Be.metadata.version==="2.0-b64")os(Be);else throw new Error("فایل پشتیبان معتبر نیست (نسخه نامشخص).")}catch(ne){V("❌خطا در خواندن فایل. لطفاً فایل پشتیبان معتبر انتخاب کنید."),console.error("Restore error (zip/base64):",ne)}}},H.readAsText(F),B.target.value=null}),window.addEventListener("popstate",B=>{if(St){ge(null,!0);return}if(Bt(),B.state){const{pageId:F,currentClassName:H,selectedSessionNumber:K,selectedStudentId:ie}=B.state;H&&(qe(re[H]),K&&Xe(A.getSession(K)),ie&&et(A.students.find(de=>de.identity.studentId===ie))),F==="session-page"?(Ge(),fn(F)):F==="student-profile-page"?(Ge(),ye("session-page"),He(_e)):fn(F)}else qe(null),Xe(null),et(null),fn("class-management-page")}),document.addEventListener("keydown",B=>{var K;const F=document.activeElement;if(!["INPUT","TEXTAREA","SELECT"].includes(F.tagName)){if(B.key.toLowerCase()==="o"&&B.shiftKey&&Si.classList.contains("active")&&(B.preventDefault(),xi.click()),B.key==="Escape"){if(Ot.classList.contains("visible")){Bt();return}if(St){ge();return}switch((K=document.querySelector(".page.active"))==null?void 0:K.id){case"csv-preview-page":case"column-mapping-page":ye("settings-page");break;case"student-profile-page":et(null),ye(J?"student-page":"session-page");break;case"attendance-page":ye("student-page");break;case"student-page":Xe(null),Ge(),ye("session-page");break;case"settings-page":case"session-page":qe(null),ye("class-management-page");break}return}if(J){const ie=B.key.toLowerCase();switch(" ascfg".includes(ie)&&B.preventDefault(),ie){case" ":y.click();break;case"a":f.classList.contains("active")?history.back():(nt(),ye("attendance-page"));break;case"s":document.getElementById("session-page").classList.contains("active")&&history.back();break;case"c":document.querySelector(".back-to-classes-btn").click();break;case"f":const de=document.querySelector(".action-column .search-icon");de&&de.click();break;case"g":if(studentProfilePage.classList.contains("active"))history.back();else{const ne=J.lastSelectedWinnerId;if(ne){const ce=A.students.find(pe=>pe.identity.studentId===ne);ce&&(et(ce),(void 0)(),ye("student-profile-page"))}else V("⚠️ابتدا یک نفر را انتخاب کنید تا پروفایل او نمایش داده شود.")}break;case"arrowleft":{const ne=document.querySelector('button[title="برنده قبلی"]');ne&&!ne.disabled&&(B.preventDefault(),ne.click());break}case"arrowright":{const ne=document.querySelector('button[title="برنده بعدی"]');ne&&!ne.disabled&&(B.preventDefault(),ne.click());break}}}}});function Pe(){k.style.width="0",x.classList.add("modal-closing"),setTimeout(()=>{x.classList.remove("modal-visible","modal-closing")},300)}function zt(){be("آیا از خروج از حالت نمایش (Demo) مطمئن هستید؟ با خروج، تمام تغییرات آزمایشی شما حذف شده و داده‌های اصلی شما بازیابی خواهند شد.",()=>{ri(),qe(null),Xe(null),et(null),We(),ye("class-management-page"),Un(),Pe()},{confirmText:"خروج",confirmClass:"btn-success"})}d(".global-search-container .animated-search-container",Wn),d(".action-column-header .animated-search-container",on),ec(),[Se,Ni,ct,Ii].forEach(B=>{B&&_a(B)});function Qt(B,F){const H=we(F.students).filter(Ie=>Ie.identity.studentId!==B.identity.studentId);if(H.length===0)return;const K=H.reduce((Ie,Ue)=>Ue.statusCounters.totalSelections>Ie.statusCounters.totalSelections?Ue:Ie,H[0]);if(!K||K.statusCounters.totalSelections===0)return;B.categoryCounts=JSON.parse(JSON.stringify(K.categoryCounts)),B.statusCounters.totalSelections=K.statusCounters.totalSelections;const ie=H.reduce((Ie,Ue)=>Ie+Ue.statusCounters.totalSelections,0),de=H.reduce((Ie,Ue)=>Ie+(Ue.statusCounters.missedChances||0),0),ne=ie>0?de/ie:0;B.statusCounters.missedChances=Math.round(B.statusCounters.totalSelections*ne);const ce=we(F.categories),pe={};ce.forEach(Ie=>{const Ue=H.reduce((Ss,ks)=>Ss+(ks.categoryCounts[Ie.name]||0),0),Es=H.reduce((Ss,ks)=>Ss+(ks.categoryIssues[Ie.name]||0),0);pe[Ie.name]=Ue>0?Es/Ue:0}),ce.forEach(Ie=>{const Ue=B.categoryCounts[Ie.name]||0,Es=pe[Ie.name]||0;B.categoryIssues[Ie.name]=Math.round(Ue*Es)});const Ce=F.liveSession;Ce?B.onboardingSession=Ce.sessionNumber:B.onboardingSession=F.sessions.length+1;const Be=we(F.sessions).filter(Ie=>Ie.isFinished&&!Ie.isCancelled),Ke="📝 یادداشت خودکار سیستم",ws=`این دانش‌آموز  از جلسه شماره ${Be.length} به کلاس اضافه شد. آمار مشارکت او بر اساس فعال‌ترین دانش‌آموز و آمار «فرصت از دست رفته» او بر اساس میانگین کلاس ثبت گردید:`,gt=[];B.statusCounters.totalSelections>0&&gt.push(`کل انتخاب‌ها: ${B.statusCounters.totalSelections}`),B.statusCounters.missedChances>0&&gt.push(`فرصت‌های از دست رفته: ${B.statusCounters.missedChances}`);for(const Ie in B.categoryCounts){const Ue=B.categoryCounts[Ie];Ue>0&&gt.push(`انتخاب در «${Ie}»: ${Ue}`)}for(const Ie in B.categoryIssues){const Ue=B.categoryIssues[Ie];Ue>0&&gt.push(`مشکل در «${Ie}»: ${Ue}`)}if(gt.length>0){const Ie=`${Ke}
${ws}

- ${gt.join(`
- `)}`;B.addNote(Ie)}}function kn(B,F=""){const H=B>1?"دانش‌آموزان جدید":"دانش‌آموز جدید";let K=`✅ ${B} ${H} با موفقیت اضافه شدند.
`;K+="💡 چون این کلاس جلسات برگزار شده دارد، برای این افراد آمار پایه‌ای (متناسب با کلاس) ثبت شد تا در فرایند انتخاب اختلالی ایجاد نشود.",F&&(K+=`
${F}`),be(K,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}const gs="22.1.5",ys="915";{const B=` (ساخت ${ys})`;document.getElementById("app-version").textContent=`نسخه ${gs}${B}`}function _n(){console.log("Starting universal backfill for writing scores...");let B=0;for(const F in re){const H=re[F];if(H.isDeleted)continue;let K=0;we(H.students).forEach(de=>{const ne=de.logs.scores;if(!(ne&&ne.writing&&ne.writing.length>0)){let pe=-1;for(const Ce in ne)Ce!=="writing"&&ne[Ce].forEach(Be=>{Be.value>pe&&(pe=Be.value)});if(pe>-1){const Ce=`Automatically assigned based on the highest score (${pe}) from other skills.`;de.addScore("Writing",pe,Ce),K++}}}),K>0&&(console.log(`Updated ${K} student(s) in class: ${H.info.name}.`),B+=K)}B>0?(oe(),console.log(`Update complete. A total of ${B} student(s) were updated across all classes. Data saved.`),document.getElementById("student-page").classList.contains("active")&&$e()):console.log("No students needed updating in any class.")}window.backfillWritingScoresForAll=_n;function It(){console.log("Starting backfill for 'outOfClassCount' and 'wasOutOfClass' properties...");let B=0,F=0;const H=localStorage.getItem("teacherAssistantData_v2");if(!H){console.log("No data found in localStorage. Nothing to do.");return}const K=JSON.parse(H);for(const ie in K){const de=K[ie];de.students&&de.students.forEach(ne=>{ne.statusCounters&&typeof ne.statusCounters.outOfClassCount>"u"&&(ne.statusCounters.outOfClassCount=0,B++)}),de.sessions&&de.sessions.forEach(ne=>{if(ne.studentRecords)for(const ce in ne.studentRecords){const pe=ne.studentRecords[ce];typeof pe.wasOutOfClass>"u"&&(pe.wasOutOfClass=!1,F++)}})}localStorage.setItem("teacherAssistantData_v2",JSON.stringify(K)),console.log(`Backfill complete. Updated ${B} students and ${F} session records. Data saved.`),Yn(),A&&$e()}window.backfillExitCounters=It;function Pt(){console.log("🧹 Starting orphaned data cleanup...");let B=0;for(const F in re){const H=re[F];if(H.isDeleted)continue;let K=!1;const ie=new Set(H.students.filter(ce=>!ce.isDeleted).map(ce=>ce.identity.studentId)),de=new Map(H.students.map(ce=>[ce.identity.studentId,ce.identity.name])),ne=[];H.sessions.forEach(ce=>{if(ce.isDeleted)return;const pe=[];for(const Ce in ce.studentRecords)if(!ie.has(Ce)){const Be=de.get(Ce)||"Unknown/Deleted";pe.push(`  - Removed student record for: ${Be} (ID: ${Ce})`),delete ce.studentRecords[Ce],B++,K=!0}for(const Ce in ce.lastWinnerByCategory){const Be=ce.lastWinnerByCategory[Ce];if(!ie.has(Be)){const Ke=de.get(Be)||"Unknown/Deleted";pe.push(`  - Removed '${Ce}' last winner: ${Ke} (ID: ${Be})`),delete ce.lastWinnerByCategory[Ce],B++,K=!0}}if(ce.lastSelectedWinnerId&&!ie.has(ce.lastSelectedWinnerId)){const Ce=ce.lastSelectedWinnerId,Be=de.get(Ce)||"Unknown/Deleted";pe.push(`  - Cleared 'lastSelectedWinnerId': ${Be} (ID: ${Ce})`),ce.lastSelectedWinnerId=null,B++,K=!0}if(pe.length>0){const Be=ot(H).get(ce.sessionNumber)||`(#${ce.sessionNumber})`;ne.push({sessionDisplayNumber:Be,logs:pe})}}),K&&(console.group(`➡️ Class: ${F}`),ne.forEach(ce=>{console.groupCollapsed(`  Session ${ce.sessionDisplayNumber}`),ce.logs.forEach(pe=>console.warn(pe)),console.groupEnd()}),console.groupEnd())}B>0?(oe(),console.log(`✅ Cleanup complete! Found and removed ${B} orphaned references. Data saved.`)):console.log("✅ No orphaned data found. Your data is clean!")}window.cleanupOrphanedData=Pt;function ar(B){if(!B||!B.classroomName)return;const F=re[B.classroomName];if(!F){V("⚠️ کلاس مربوط به این گزارش یافت نشد.");return}qe(F),ge(),setTimeout(()=>{switch(B.type){case"VIEW_STUDENT_PROFILE":{const H=F.students.find(K=>K.identity.studentId===B.studentId);H?He(H):V("⚠️ دانش‌آموز مورد نظر یافت نشد.");break}case"VIEW_TRASH":wn(),ye("trash-page");break;case"VIEW_SESSIONS":Ge(),ye("session-page");break;case"VIEW_CLASS_NOTE":hs(F);break;case"VIEW_CLASS_SETTINGS":kt(F);break}},300)}O.addEventListener("click",()=>{Sa()}),M.addEventListener("click",()=>{ge()}),le.addEventListener("click",()=>{const B=te.value.trim(),F=Q.checked;if(!B){ba.style.display==="flex"?be("کادر یادداشت خالی است. آیا مطمئنید که می‌خواهید یادداشت‌های قبلی دانش‌آموزان انتخاب‌شده را پاک کنید؟",()=>{ge(),Us("",!1)},{confirmText:"پاک کردن",confirmClass:"btn-warning"}):V("⚠️ لطفاً متن یادداشت را وارد کنید.");return}ge(()=>{Us(B,F)})});const xt=document.getElementById("screen-saver-overlay");let vs;const ir=2*60*1e3,La=["mousemove","keypress","scroll","click","touchstart"];function rr(){xt.classList.add("visible")}function Ta(){xt.classList.contains("visible")&&xt.classList.remove("visible")}function In(){Ta(),clearTimeout(vs),vs=setTimeout(rr,ir)}function xn(B){B.preventDefault(),B.stopPropagation(),setTimeout(In,0)}function Ba(){In(),La.forEach(F=>window.addEventListener(F,In)),xt.addEventListener("click",xn),xt.addEventListener("touchstart",xn);const B="22.1.5";{const F=document.getElementById("screen-saver-version");F&&(F.textContent=`v${B}`)}}function or(){clearTimeout(vs),Ta(),La.forEach(B=>window.removeEventListener(B,In)),xt.removeEventListener("click",xn),xt.removeEventListener("touchstart",xn)}document.getElementById("app-settings-modal");const Na=document.getElementById("app-settings-nav-btn"),Da=document.getElementById("close-settings-btn"),Aa=document.getElementById("setting-sound-toggle"),Oa=document.getElementById("setting-vibration-toggle"),Ma=document.getElementById("setting-screensaver-toggle");Na&&Na.addEventListener("click",()=>{Pe(),Aa.checked=Fe.isSoundEnabled,Oa.checked=Fe.isVibrationEnabled,Ma.checked=Fe.isScreenSaverEnabled,ze("app-settings-modal")}),Da&&Da.addEventListener("click",()=>{ge()}),Aa.addEventListener("change",B=>{wt({isSoundEnabled:B.target.checked}),B.target.checked&&Ts()}),Oa.addEventListener("change",B=>{wt({isVibrationEnabled:B.target.checked}),B.target.checked&&navigator.vibrate&&navigator.vibrate(50)}),Fe.isScreenSaverEnabled&&Ba(),Ma.addEventListener("change",B=>{B.target.checked?(wt({isScreenSaverEnabled:!0}),Ba()):(wt({isScreenSaverEnabled:!1}),or())}),jt(Ye,()=>{if(Is=!0,!Re){V("⚠️ ابتدا یک دسته‌بندی انتخاب کنید.");return}if(!Re.isGradedCategory){V("⚠️ این دسته‌بندی نمره‌دار نیست.");return}Ya(!Tt),vt(-1),Gt(null),Ae(),Cn(Re),Dt.classList.toggle("assessment-mode-active",Tt),V(Tt?"حالت انتخاب برای نمره‌دهی فعال شد.":"حالت انتخاب معمولی فعال شد.")});const bs=document.getElementById("new-category-modal-weight-group");if(he&&bs){he.addEventListener("change",F=>{bs.style.display=F.target.checked?"flex":"none"});const B=he.checked;bs.style.display=B?"flex":"none"}Me.addEventListener("click",()=>{gn((B,F,H)=>{if(B){if(A.categories.some(K=>K.name.toLowerCase()===B.toLowerCase())){V("⚠️ این دسته‌بندی قبلاً اضافه شده است.");return}A.categories.push(new yt(B,"",F,H)),oe(),Xt()}}),sr()}),he.addEventListener("change",B=>{Te.style.display=B.target.checked?"flex":"none"})});function Qo(t,i){if(!J||J.isFinished){V("⚠️ امکان لغو انتخاب در جلسه خاتمه یافته وجود ندارد.");return}if(Tt){be(`آیا از لغو وضعیت نمره‌دهی «${t.identity.name}» مطمئن هستید؟ این دانش‌آموز به لیست انتظار بازمی‌گردد.`,()=>{const a=Re.id,n=rt[a];n&&(n.scoredThisSession=n.scoredThisSession.filter(r=>r!==t.identity.studentId)),Gt(null),$e(),Ae(),oe(),V(`✅ «${t.identity.name}» به لیست انتظار نمره بازگشت.`)});return}const e=J.winnerHistory;if(!(Ve===e.length-1)||e.length===0){V("⚠️ فقط آخرین انتخاب قابل لغو است.");return}if(e[e.length-1].winner.identity.studentId!==t.identity.studentId){console.error("Undo mismatch!");return}be(`آیا از حذف انتخاب «${t.identity.name}» برای «${i}» مطمئن هستید؟ آمار این انتخاب بازگردانی خواهد شد.`,()=>{const a=J.winnerHistory,n=a.pop();if(!n)return;const r=n.winner,s=n.categoryName,o=r.identity.studentId;r.statusCounters.totalSelections=Math.max(0,r.statusCounters.totalSelections-1),r.categoryCounts[s]&&(r.categoryCounts[s]=Math.max(0,r.categoryCounts[s]-1));const c=J.studentRecords[o];if(c&&c.selections[s]&&(c.selections[s]=Math.max(0,c.selections[s]-1)),n.rating){const p=n.rating;r.qualitativeStats&&r.qualitativeStats[s]&&r.qualitativeStats[s][p]>0&&r.qualitativeStats[s][p]--}let m=null;for(let p=a.length-1;p>=0;p--)if(a[p].categoryName===s){m=a[p].winner.identity.studentId;break}m?J.lastWinnerByCategory[s]=m:delete J.lastWinnerByCategory[s],vt(a.length-1),$e(),Ae(),oe(),V(`✅ انتخاب «${r.identity.name}» لغو شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}function ec(){const t=document.getElementById("session-dashboard-page"),i=document.getElementById("student-stats-table-container");if(!t)return;let e=0,l=0;t.addEventListener("touchstart",n=>{if(i&&i.contains(n.target)){const r=n.target.closest("td, th");r&&r.parentElement.firstElementChild===r?e=n.changedTouches[0].screenX:e=0}else e=n.changedTouches[0].screenX},{passive:!0}),t.addEventListener("touchend",n=>{e!==0&&(l=n.changedTouches[0].screenX,a())});function a(){const r=e-l;Math.abs(r)>150&&(document.getElementById("selector-tab-btn").classList.contains("active")?(ye("session-dashboard-page",{tab:"attendance"}),Kt("attendance")):(ye("session-dashboard-page",{tab:"selector"}),Kt("selector"))),e=0,l=0}}function Wa(t,i){const e=i.toLowerCase();return(t.logs.scores[e]||[]).filter(a=>!a.isDeleted).length}function tc(t,i){const e=i.id;rt[e]||(rt[e]={toBeScored:[],scoredThisSession:[]});const l=rt[e],n=we(t.students).filter(o=>!l.scoredThisSession.includes(o.identity.studentId));if(n.length===0)return l.toBeScored=[],[];const r=n.map(o=>Wa(o,i.name)),s=Math.min(...r);return l.toBeScored=n.filter(o=>Wa(o,i.name)===s).map(o=>o.identity.studentId),l.toBeScored}function nc(t,i){const e=tc(t,i);if(e.length===0)return null;const l=Math.floor(Math.random()*e.length),a=e[l];return fa(i.id,a),t.students.find(n=>n.identity.studentId===a)}
