(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))c(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&c(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function c(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();const Fa={ili:{id:"ili",label:"کانون زبان ایران",levels:["Primer 1","Primer 2","Step Up 1","Step Up 2","Step Up 3","Step Up 4","Move Up 1","Move Up 2","Move Up 3","Move Up 4","Jump Up 1","Jump Up 2","Jump Up 3","Jump Up 4","Start 1","Run 1","Run 2","Run 3","Run 4","Race 1","Race 2","Race 3","Reach 1","Reach 2","Reach 3","Reach 4","Basic 1","Basic 2","Basic 3","Elementary 1","Elementary 2","Elementary 3","Pre-intermediate 1","Pre-intermediate 2","Pre-intermediate 3","Intermediate 1","Intermediate 2","Intermediate 3","High-intermediate 1","High-intermediate 2","High-intermediate 3","Advanced 1","Advanced 2","Advanced 3"]},school:{id:"school",label:"آموزش و پرورش",levels:["کلاس اول","کلاس دوم","کلاس سوم","کلاس چهارم","کلاس پنجم","کلاس ششم","کلاس هفتم","کلاس هشتم","کلاس نهم","کلاس دهم","کلاس یازدهم","کلاس دوازدهم"]},custom:{id:"custom",label:"سایر / آزاد",levels:[]}};class Dn{constructor(s){this.identity={name:s.name,firstName:s.firstName||null,lastName:s.lastName||null,studentId:s.studentId||`id_${new Date().getTime()}_${Math.random()}`,branchName:s.branchName||null,ageGroup:s.ageGroup||"adult",level:s.level||null,contact:{social:s.socialContact||null,parent:s.parentContact||null}},this.isDeleted=!1,this.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0,outOfClassCount:0},this.categoryCounts={},this.categoryIssues={},this.qualitativeStats={},this.logs={parentContacts:[],scores:{},discipline:{},sessionHistory:{}},this.profile={notes:[],tags:[]},this.finalClassActivityScore=null,this.onboardingSession=null}addScore(s,t,c){if(t>100||t<0){console.log("نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}const i=s.toLowerCase();this.logs.scores[i]||(this.logs.scores[i]=[]);const n=new fo(s,t,c);this.logs.scores[i].push(n)}addNote(s,t=null){const c=new mo(s,t);this.profile.notes.push(c)}getOverallAverageScore(){let s=0,t=0;for(const i in this.logs.scores)this.logs.scores[i].forEach(n=>{n.isDeleted||(s+=n.value,t++)});if(t===0)return null;const c=s/t;return Math.trunc(c*10)/10}}class fo{constructor(s,t,c=""){this.id=`score_${new Date().getTime()}`,this.skill=s,this.value=t,this.timestamp=new Date,this.comment=c,this.isDeleted=!1}}class mo{constructor(s,t=null){this.id=`note_${new Date().getTime()}`,this.timestamp=new Date,this.content=s,this.isDeleted=!1,this.source=t}}class Ls{constructor(s="complete",t=""){this.status=s,this.comment=t,this.timestamp=new Date}}class Ja{constructor(s){this.sessionNumber=s,this.startTime=new Date,this.createdAt=new Date,this.note="",this.isDeleted=!1,this.endTime=null,this.isFinished=!1,this.isMakeup=!1,this.isCancelled=!1,this.studentRecords={},this.lastWinnerByCategory={},this.lastUsedCategoryId=null,this.lastSelectedWinnerId=null,this.winnerHistory=[]}end(){this.isFinished=!0,this.endTime=new Date}markAsMakeup(){this.isMakeup=!this.isMakeup}initializeStudentRecord(s){this.studentRecords[s]||(this.studentRecords[s]={attendance:"present",homework:new Ls,selections:{},hadIssue:!1,wasOutOfClass:!1,performanceRatings:{}})}setAttendance(s,t){this.initializeStudentRecord(s),this.studentRecords[s].attendance=t}setHomeworkStatus(s,t){this.initializeStudentRecord(s),this.studentRecords[s].homework.status=t}selectNextWinner(s,t,c){if(!t||t.length===0)return console.log("هیچ دانش‌آموزی در کلاس برای انتخاب وجود ندارد."),null;const i=this.lastWinnerByCategory[s];let n=t.filter(h=>h.identity.studentId!==i&&!h.isDeleted);if(n.length===0&&(n=t),n.length===0)return null;const o=(h,m)=>h.categoryCounts[m]||0,a=Math.min(...n.map(h=>o(h,s))),r=n.filter(h=>o(h,s)===a);let l;if(r.length===1)l=r[0];else if(r.length>1){const h=c.filter(v=>!v.isDeleted&&v.name!==s).map(v=>v.name),m=r.map(v=>{const b=h.reduce((C,S)=>C+o(v,S),0);return{student:v,otherCategoriesTotal:b}}),y=Math.min(...m.map(v=>v.otherCategoriesTotal)),u=m.filter(v=>v.otherCategoriesTotal===y).map(v=>v.student);u.length===1?l=u[0]:l=u[Math.floor(Math.random()*u.length)]}else l=n[Math.floor(Math.random()*n.length)];const f=l.identity.studentId;this.initializeStudentRecord(f);const p=(this.studentRecords[f].selections[s]||0)+1;return this.studentRecords[f].selections[s]=p,l.statusCounters.totalSelections++,l.categoryCounts[s]=(l.categoryCounts[s]||0)+1,this.lastWinnerByCategory[s]=f,l}}class Ts{constructor(s){this.info={name:s.name||"NotNamed",teacherName:s.teacherName||null,type:s.type||"in-person",educationalSystem:s.educationalSystem||"custom",term:s.term||null,scheduleText:s.scheduleText||null,level:s.level||null,creationDate:s.creationDate?new Date(s.creationDate):new Date,scheduleCode:s.scheduleCode||`code_${new Date().getTime()}`,scheduleDays:s.scheduleDays||[],scheduleStartTime:s.scheduleStartTime||null,scheduleEndTime:s.scheduleEndTime||null},this.students=[],this.sessions=[],this.note="",this.isDeleted=!1,this.categories=[new pt("Vocabulary","Questions about words and meanings."),new pt("Grammar","Questions about sentence structure and rules."),new pt("Listening",void 0,!0),new pt("Speaking",void 0,!0),new pt("Reading",void 0,!0),new pt("Writing",void 0,!0)],this.futurePlans={}}addStudent(s){this.students.push(s)}startNewSession(){const t=this.sessions.reduce((i,n)=>Math.max(i,n.sessionNumber),0)+1,c=new Ja(t);return this.sessions.push(c),c}endSpecificSession(s){const t=this.getSession(s);return t&&!t.isFinished?(t.end(),!0):!1}getSession(s){return this.sessions.find(t=>t.sessionNumber===s)}markAsMakeup(s){const t=this.getSession(s);t&&t.markAsMakeup()}planForSession(s,t){this.futurePlans[s]=t}hasSessionToday(){const s=new Date().toDateString();return this.sessions.some(t=>!t.isDeleted&&t.startTime.toDateString()===s)}selectNextWinner(s,t){return t?t.selectNextWinner(s,this.students,this.categories):null}get liveSession(){for(let s=this.sessions.length-1;s>=0;s--)if(!this.sessions[s].isFinished)return this.sessions[s];return null}calculateFinalStudentScore(s){var o;const t=this.categories.filter(a=>a.isGradedCategory&&!a.isDeleted);if(t.length===0)return null;let c=0,i=0;for(const a of t){const r=a.name.toLowerCase(),l=((o=s.logs.scores[r])==null?void 0:o.filter(p=>!p.isDeleted))||[];if(l.length===0)return null;const f=l.reduce((p,h)=>p+h.value,0)/l.length;c+=f*(a.weight||1),i+=a.weight||1}if(i===0)return null;const n=c/i;return Math.trunc(n*10)/10}}class pt{constructor(s,t="",c=!1,i=1){this.id=`cat_${new Date().getTime()}_${Math.random()}`,this.name=s,this.description=t,this.isDeleted=!1,this.isGradedCategory=c,this.weight=i,this.isDeleted=!1}}var Tn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Ka(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function Bn(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Ya={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/(function(e,s){(function(t){e.exports=t()})(function(){return function t(c,i,n){function o(l,f){if(!i[l]){if(!c[l]){var p=typeof Bn=="function"&&Bn;if(!f&&p)return p(l,!0);if(a)return a(l,!0);var h=new Error("Cannot find module '"+l+"'");throw h.code="MODULE_NOT_FOUND",h}var m=i[l]={exports:{}};c[l][0].call(m.exports,function(y){var u=c[l][1][y];return o(u||y)},m,m.exports,t,c,i,n)}return i[l].exports}for(var a=typeof Bn=="function"&&Bn,r=0;r<n.length;r++)o(n[r]);return o}({1:[function(t,c,i){var n=t("./utils"),o=t("./support"),a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";i.encode=function(r){for(var l,f,p,h,m,y,u,v=[],b=0,C=r.length,S=C,_=n.getTypeOf(r)!=="string";b<r.length;)S=C-b,p=_?(l=r[b++],f=b<C?r[b++]:0,b<C?r[b++]:0):(l=r.charCodeAt(b++),f=b<C?r.charCodeAt(b++):0,b<C?r.charCodeAt(b++):0),h=l>>2,m=(3&l)<<4|f>>4,y=1<S?(15&f)<<2|p>>6:64,u=2<S?63&p:64,v.push(a.charAt(h)+a.charAt(m)+a.charAt(y)+a.charAt(u));return v.join("")},i.decode=function(r){var l,f,p,h,m,y,u=0,v=0,b="data:";if(r.substr(0,b.length)===b)throw new Error("Invalid base64 input, it looks like a data url.");var C,S=3*(r=r.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(r.charAt(r.length-1)===a.charAt(64)&&S--,r.charAt(r.length-2)===a.charAt(64)&&S--,S%1!=0)throw new Error("Invalid base64 input, bad content length.");for(C=o.uint8array?new Uint8Array(0|S):new Array(0|S);u<r.length;)l=a.indexOf(r.charAt(u++))<<2|(h=a.indexOf(r.charAt(u++)))>>4,f=(15&h)<<4|(m=a.indexOf(r.charAt(u++)))>>2,p=(3&m)<<6|(y=a.indexOf(r.charAt(u++))),C[v++]=l,m!==64&&(C[v++]=f),y!==64&&(C[v++]=p);return C}},{"./support":30,"./utils":32}],2:[function(t,c,i){var n=t("./external"),o=t("./stream/DataWorker"),a=t("./stream/Crc32Probe"),r=t("./stream/DataLengthProbe");function l(f,p,h,m,y){this.compressedSize=f,this.uncompressedSize=p,this.crc32=h,this.compression=m,this.compressedContent=y}l.prototype={getContentWorker:function(){var f=new o(n.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new r("data_length")),p=this;return f.on("end",function(){if(this.streamInfo.data_length!==p.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),f},getCompressedWorker:function(){return new o(n.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},l.createWorkerFrom=function(f,p,h){return f.pipe(new a).pipe(new r("uncompressedSize")).pipe(p.compressWorker(h)).pipe(new r("compressedSize")).withStreamInfo("compression",p)},c.exports=l},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(t,c,i){var n=t("./stream/GenericWorker");i.STORE={magic:"\0\0",compressWorker:function(){return new n("STORE compression")},uncompressWorker:function(){return new n("STORE decompression")}},i.DEFLATE=t("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(t,c,i){var n=t("./utils"),o=function(){for(var a,r=[],l=0;l<256;l++){a=l;for(var f=0;f<8;f++)a=1&a?3988292384^a>>>1:a>>>1;r[l]=a}return r}();c.exports=function(a,r){return a!==void 0&&a.length?n.getTypeOf(a)!=="string"?function(l,f,p,h){var m=o,y=h+p;l^=-1;for(var u=h;u<y;u++)l=l>>>8^m[255&(l^f[u])];return-1^l}(0|r,a,a.length,0):function(l,f,p,h){var m=o,y=h+p;l^=-1;for(var u=h;u<y;u++)l=l>>>8^m[255&(l^f.charCodeAt(u))];return-1^l}(0|r,a,a.length,0):0}},{"./utils":32}],5:[function(t,c,i){i.base64=!1,i.binary=!1,i.dir=!1,i.createFolders=!0,i.date=null,i.compression=null,i.compressionOptions=null,i.comment=null,i.unixPermissions=null,i.dosPermissions=null},{}],6:[function(t,c,i){var n=null;n=typeof Promise<"u"?Promise:t("lie"),c.exports={Promise:n}},{lie:37}],7:[function(t,c,i){var n=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",o=t("pako"),a=t("./utils"),r=t("./stream/GenericWorker"),l=n?"uint8array":"array";function f(p,h){r.call(this,"FlateWorker/"+p),this._pako=null,this._pakoAction=p,this._pakoOptions=h,this.meta={}}i.magic="\b\0",a.inherits(f,r),f.prototype.processChunk=function(p){this.meta=p.meta,this._pako===null&&this._createPako(),this._pako.push(a.transformTo(l,p.data),!1)},f.prototype.flush=function(){r.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},f.prototype.cleanUp=function(){r.prototype.cleanUp.call(this),this._pako=null},f.prototype._createPako=function(){this._pako=new o[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var p=this;this._pako.onData=function(h){p.push({data:h,meta:p.meta})}},i.compressWorker=function(p){return new f("Deflate",p)},i.uncompressWorker=function(){return new f("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(t,c,i){function n(m,y){var u,v="";for(u=0;u<y;u++)v+=String.fromCharCode(255&m),m>>>=8;return v}function o(m,y,u,v,b,C){var S,_,k=m.file,x=m.compression,L=C!==l.utf8encode,D=a.transformTo("string",C(k.name)),M=a.transformTo("string",l.utf8encode(k.name)),U=k.comment,Q=a.transformTo("string",C(U)),I=a.transformTo("string",l.utf8encode(U)),$=M.length!==k.name.length,g=I.length!==U.length,H="",ue="",Z="",me=k.dir,V=k.date,fe={crc32:0,compressedSize:0,uncompressedSize:0};y&&!u||(fe.crc32=m.crc32,fe.compressedSize=m.compressedSize,fe.uncompressedSize=m.uncompressedSize);var R=0;y&&(R|=8),L||!$&&!g||(R|=2048);var O=0,de=0;me&&(O|=16),b==="UNIX"?(de=798,O|=function(ee,De){var Pe=ee;return ee||(Pe=De?16893:33204),(65535&Pe)<<16}(k.unixPermissions,me)):(de=20,O|=function(ee){return 63&(ee||0)}(k.dosPermissions)),S=V.getUTCHours(),S<<=6,S|=V.getUTCMinutes(),S<<=5,S|=V.getUTCSeconds()/2,_=V.getUTCFullYear()-1980,_<<=4,_|=V.getUTCMonth()+1,_<<=5,_|=V.getUTCDate(),$&&(ue=n(1,1)+n(f(D),4)+M,H+="up"+n(ue.length,2)+ue),g&&(Z=n(1,1)+n(f(Q),4)+I,H+="uc"+n(Z.length,2)+Z);var ne="";return ne+=`
\0`,ne+=n(R,2),ne+=x.magic,ne+=n(S,2),ne+=n(_,2),ne+=n(fe.crc32,4),ne+=n(fe.compressedSize,4),ne+=n(fe.uncompressedSize,4),ne+=n(D.length,2),ne+=n(H.length,2),{fileRecord:p.LOCAL_FILE_HEADER+ne+D+H,dirRecord:p.CENTRAL_FILE_HEADER+n(de,2)+ne+n(Q.length,2)+"\0\0\0\0"+n(O,4)+n(v,4)+D+H+Q}}var a=t("../utils"),r=t("../stream/GenericWorker"),l=t("../utf8"),f=t("../crc32"),p=t("../signature");function h(m,y,u,v){r.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=y,this.zipPlatform=u,this.encodeFileName=v,this.streamFiles=m,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}a.inherits(h,r),h.prototype.push=function(m){var y=m.meta.percent||0,u=this.entriesCount,v=this._sources.length;this.accumulate?this.contentBuffer.push(m):(this.bytesWritten+=m.data.length,r.prototype.push.call(this,{data:m.data,meta:{currentFile:this.currentFile,percent:u?(y+100*(u-v-1))/u:100}}))},h.prototype.openedSource=function(m){this.currentSourceOffset=this.bytesWritten,this.currentFile=m.file.name;var y=this.streamFiles&&!m.file.dir;if(y){var u=o(m,y,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:u.fileRecord,meta:{percent:0}})}else this.accumulate=!0},h.prototype.closedSource=function(m){this.accumulate=!1;var y=this.streamFiles&&!m.file.dir,u=o(m,y,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(u.dirRecord),y)this.push({data:function(v){return p.DATA_DESCRIPTOR+n(v.crc32,4)+n(v.compressedSize,4)+n(v.uncompressedSize,4)}(m),meta:{percent:100}});else for(this.push({data:u.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},h.prototype.flush=function(){for(var m=this.bytesWritten,y=0;y<this.dirRecords.length;y++)this.push({data:this.dirRecords[y],meta:{percent:100}});var u=this.bytesWritten-m,v=function(b,C,S,_,k){var x=a.transformTo("string",k(_));return p.CENTRAL_DIRECTORY_END+"\0\0\0\0"+n(b,2)+n(b,2)+n(C,4)+n(S,4)+n(x.length,2)+x}(this.dirRecords.length,u,m,this.zipComment,this.encodeFileName);this.push({data:v,meta:{percent:100}})},h.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},h.prototype.registerPrevious=function(m){this._sources.push(m);var y=this;return m.on("data",function(u){y.processChunk(u)}),m.on("end",function(){y.closedSource(y.previous.streamInfo),y._sources.length?y.prepareNextSource():y.end()}),m.on("error",function(u){y.error(u)}),this},h.prototype.resume=function(){return!!r.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},h.prototype.error=function(m){var y=this._sources;if(!r.prototype.error.call(this,m))return!1;for(var u=0;u<y.length;u++)try{y[u].error(m)}catch{}return!0},h.prototype.lock=function(){r.prototype.lock.call(this);for(var m=this._sources,y=0;y<m.length;y++)m[y].lock()},c.exports=h},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(t,c,i){var n=t("../compressions"),o=t("./ZipFileWorker");i.generateWorker=function(a,r,l){var f=new o(r.streamFiles,l,r.platform,r.encodeFileName),p=0;try{a.forEach(function(h,m){p++;var y=function(C,S){var _=C||S,k=n[_];if(!k)throw new Error(_+" is not a valid compression method !");return k}(m.options.compression,r.compression),u=m.options.compressionOptions||r.compressionOptions||{},v=m.dir,b=m.date;m._compressWorker(y,u).withStreamInfo("file",{name:h,dir:v,date:b,comment:m.comment||"",unixPermissions:m.unixPermissions,dosPermissions:m.dosPermissions}).pipe(f)}),f.entriesCount=p}catch(h){f.error(h)}return f}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(t,c,i){function n(){if(!(this instanceof n))return new n;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var o=new n;for(var a in this)typeof this[a]!="function"&&(o[a]=this[a]);return o}}(n.prototype=t("./object")).loadAsync=t("./load"),n.support=t("./support"),n.defaults=t("./defaults"),n.version="3.10.1",n.loadAsync=function(o,a){return new n().loadAsync(o,a)},n.external=t("./external"),c.exports=n},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(t,c,i){var n=t("./utils"),o=t("./external"),a=t("./utf8"),r=t("./zipEntries"),l=t("./stream/Crc32Probe"),f=t("./nodejsUtils");function p(h){return new o.Promise(function(m,y){var u=h.decompressed.getContentWorker().pipe(new l);u.on("error",function(v){y(v)}).on("end",function(){u.streamInfo.crc32!==h.decompressed.crc32?y(new Error("Corrupted zip : CRC32 mismatch")):m()}).resume()})}c.exports=function(h,m){var y=this;return m=n.extend(m||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:a.utf8decode}),f.isNode&&f.isStream(h)?o.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):n.prepareContent("the loaded zip file",h,!0,m.optimizedBinaryString,m.base64).then(function(u){var v=new r(m);return v.load(u),v}).then(function(u){var v=[o.Promise.resolve(u)],b=u.files;if(m.checkCRC32)for(var C=0;C<b.length;C++)v.push(p(b[C]));return o.Promise.all(v)}).then(function(u){for(var v=u.shift(),b=v.files,C=0;C<b.length;C++){var S=b[C],_=S.fileNameStr,k=n.resolve(S.fileNameStr);y.file(k,S.decompressed,{binary:!0,optimizedBinaryString:!0,date:S.date,dir:S.dir,comment:S.fileCommentStr.length?S.fileCommentStr:null,unixPermissions:S.unixPermissions,dosPermissions:S.dosPermissions,createFolders:m.createFolders}),S.dir||(y.file(k).unsafeOriginalName=_)}return v.zipComment.length&&(y.comment=v.zipComment),y})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(t,c,i){var n=t("../utils"),o=t("../stream/GenericWorker");function a(r,l){o.call(this,"Nodejs stream input adapter for "+r),this._upstreamEnded=!1,this._bindStream(l)}n.inherits(a,o),a.prototype._bindStream=function(r){var l=this;(this._stream=r).pause(),r.on("data",function(f){l.push({data:f,meta:{percent:0}})}).on("error",function(f){l.isPaused?this.generatedError=f:l.error(f)}).on("end",function(){l.isPaused?l._upstreamEnded=!0:l.end()})},a.prototype.pause=function(){return!!o.prototype.pause.call(this)&&(this._stream.pause(),!0)},a.prototype.resume=function(){return!!o.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},c.exports=a},{"../stream/GenericWorker":28,"../utils":32}],13:[function(t,c,i){var n=t("readable-stream").Readable;function o(a,r,l){n.call(this,r),this._helper=a;var f=this;a.on("data",function(p,h){f.push(p)||f._helper.pause(),l&&l(h)}).on("error",function(p){f.emit("error",p)}).on("end",function(){f.push(null)})}t("../utils").inherits(o,n),o.prototype._read=function(){this._helper.resume()},c.exports=o},{"../utils":32,"readable-stream":16}],14:[function(t,c,i){c.exports={isNode:typeof Buffer<"u",newBufferFrom:function(n,o){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(n,o);if(typeof n=="number")throw new Error('The "data" argument must not be a number');return new Buffer(n,o)},allocBuffer:function(n){if(Buffer.alloc)return Buffer.alloc(n);var o=new Buffer(n);return o.fill(0),o},isBuffer:function(n){return Buffer.isBuffer(n)},isStream:function(n){return n&&typeof n.on=="function"&&typeof n.pause=="function"&&typeof n.resume=="function"}}},{}],15:[function(t,c,i){function n(k,x,L){var D,M=a.getTypeOf(x),U=a.extend(L||{},f);U.date=U.date||new Date,U.compression!==null&&(U.compression=U.compression.toUpperCase()),typeof U.unixPermissions=="string"&&(U.unixPermissions=parseInt(U.unixPermissions,8)),U.unixPermissions&&16384&U.unixPermissions&&(U.dir=!0),U.dosPermissions&&16&U.dosPermissions&&(U.dir=!0),U.dir&&(k=b(k)),U.createFolders&&(D=v(k))&&C.call(this,D,!0);var Q=M==="string"&&U.binary===!1&&U.base64===!1;L&&L.binary!==void 0||(U.binary=!Q),(x instanceof p&&x.uncompressedSize===0||U.dir||!x||x.length===0)&&(U.base64=!1,U.binary=!0,x="",U.compression="STORE",M="string");var I=null;I=x instanceof p||x instanceof r?x:y.isNode&&y.isStream(x)?new u(k,x):a.prepareContent(k,x,U.binary,U.optimizedBinaryString,U.base64);var $=new h(k,I,U);this.files[k]=$}var o=t("./utf8"),a=t("./utils"),r=t("./stream/GenericWorker"),l=t("./stream/StreamHelper"),f=t("./defaults"),p=t("./compressedObject"),h=t("./zipObject"),m=t("./generate"),y=t("./nodejsUtils"),u=t("./nodejs/NodejsStreamInputAdapter"),v=function(k){k.slice(-1)==="/"&&(k=k.substring(0,k.length-1));var x=k.lastIndexOf("/");return 0<x?k.substring(0,x):""},b=function(k){return k.slice(-1)!=="/"&&(k+="/"),k},C=function(k,x){return x=x!==void 0?x:f.createFolders,k=b(k),this.files[k]||n.call(this,k,null,{dir:!0,createFolders:x}),this.files[k]};function S(k){return Object.prototype.toString.call(k)==="[object RegExp]"}var _={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(k){var x,L,D;for(x in this.files)D=this.files[x],(L=x.slice(this.root.length,x.length))&&x.slice(0,this.root.length)===this.root&&k(L,D)},filter:function(k){var x=[];return this.forEach(function(L,D){k(L,D)&&x.push(D)}),x},file:function(k,x,L){if(arguments.length!==1)return k=this.root+k,n.call(this,k,x,L),this;if(S(k)){var D=k;return this.filter(function(U,Q){return!Q.dir&&D.test(U)})}var M=this.files[this.root+k];return M&&!M.dir?M:null},folder:function(k){if(!k)return this;if(S(k))return this.filter(function(M,U){return U.dir&&k.test(M)});var x=this.root+k,L=C.call(this,x),D=this.clone();return D.root=L.name,D},remove:function(k){k=this.root+k;var x=this.files[k];if(x||(k.slice(-1)!=="/"&&(k+="/"),x=this.files[k]),x&&!x.dir)delete this.files[k];else for(var L=this.filter(function(M,U){return U.name.slice(0,k.length)===k}),D=0;D<L.length;D++)delete this.files[L[D].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(k){var x,L={};try{if((L=a.extend(k||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:o.utf8encode})).type=L.type.toLowerCase(),L.compression=L.compression.toUpperCase(),L.type==="binarystring"&&(L.type="string"),!L.type)throw new Error("No output type specified.");a.checkSupport(L.type),L.platform!=="darwin"&&L.platform!=="freebsd"&&L.platform!=="linux"&&L.platform!=="sunos"||(L.platform="UNIX"),L.platform==="win32"&&(L.platform="DOS");var D=L.comment||this.comment||"";x=m.generateWorker(this,L,D)}catch(M){(x=new r("error")).error(M)}return new l(x,L.type||"string",L.mimeType)},generateAsync:function(k,x){return this.generateInternalStream(k).accumulate(x)},generateNodeStream:function(k,x){return(k=k||{}).type||(k.type="nodebuffer"),this.generateInternalStream(k).toNodejsStream(x)}};c.exports=_},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(t,c,i){c.exports=t("stream")},{stream:void 0}],17:[function(t,c,i){var n=t("./DataReader");function o(a){n.call(this,a);for(var r=0;r<this.data.length;r++)a[r]=255&a[r]}t("../utils").inherits(o,n),o.prototype.byteAt=function(a){return this.data[this.zero+a]},o.prototype.lastIndexOfSignature=function(a){for(var r=a.charCodeAt(0),l=a.charCodeAt(1),f=a.charCodeAt(2),p=a.charCodeAt(3),h=this.length-4;0<=h;--h)if(this.data[h]===r&&this.data[h+1]===l&&this.data[h+2]===f&&this.data[h+3]===p)return h-this.zero;return-1},o.prototype.readAndCheckSignature=function(a){var r=a.charCodeAt(0),l=a.charCodeAt(1),f=a.charCodeAt(2),p=a.charCodeAt(3),h=this.readData(4);return r===h[0]&&l===h[1]&&f===h[2]&&p===h[3]},o.prototype.readData=function(a){if(this.checkOffset(a),a===0)return[];var r=this.data.slice(this.zero+this.index,this.zero+this.index+a);return this.index+=a,r},c.exports=o},{"../utils":32,"./DataReader":18}],18:[function(t,c,i){var n=t("../utils");function o(a){this.data=a,this.length=a.length,this.index=0,this.zero=0}o.prototype={checkOffset:function(a){this.checkIndex(this.index+a)},checkIndex:function(a){if(this.length<this.zero+a||a<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+a+"). Corrupted zip ?")},setIndex:function(a){this.checkIndex(a),this.index=a},skip:function(a){this.setIndex(this.index+a)},byteAt:function(){},readInt:function(a){var r,l=0;for(this.checkOffset(a),r=this.index+a-1;r>=this.index;r--)l=(l<<8)+this.byteAt(r);return this.index+=a,l},readString:function(a){return n.transformTo("string",this.readData(a))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var a=this.readInt(4);return new Date(Date.UTC(1980+(a>>25&127),(a>>21&15)-1,a>>16&31,a>>11&31,a>>5&63,(31&a)<<1))}},c.exports=o},{"../utils":32}],19:[function(t,c,i){var n=t("./Uint8ArrayReader");function o(a){n.call(this,a)}t("../utils").inherits(o,n),o.prototype.readData=function(a){this.checkOffset(a);var r=this.data.slice(this.zero+this.index,this.zero+this.index+a);return this.index+=a,r},c.exports=o},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(t,c,i){var n=t("./DataReader");function o(a){n.call(this,a)}t("../utils").inherits(o,n),o.prototype.byteAt=function(a){return this.data.charCodeAt(this.zero+a)},o.prototype.lastIndexOfSignature=function(a){return this.data.lastIndexOf(a)-this.zero},o.prototype.readAndCheckSignature=function(a){return a===this.readData(4)},o.prototype.readData=function(a){this.checkOffset(a);var r=this.data.slice(this.zero+this.index,this.zero+this.index+a);return this.index+=a,r},c.exports=o},{"../utils":32,"./DataReader":18}],21:[function(t,c,i){var n=t("./ArrayReader");function o(a){n.call(this,a)}t("../utils").inherits(o,n),o.prototype.readData=function(a){if(this.checkOffset(a),a===0)return new Uint8Array(0);var r=this.data.subarray(this.zero+this.index,this.zero+this.index+a);return this.index+=a,r},c.exports=o},{"../utils":32,"./ArrayReader":17}],22:[function(t,c,i){var n=t("../utils"),o=t("../support"),a=t("./ArrayReader"),r=t("./StringReader"),l=t("./NodeBufferReader"),f=t("./Uint8ArrayReader");c.exports=function(p){var h=n.getTypeOf(p);return n.checkSupport(h),h!=="string"||o.uint8array?h==="nodebuffer"?new l(p):o.uint8array?new f(n.transformTo("uint8array",p)):new a(n.transformTo("array",p)):new r(p)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(t,c,i){i.LOCAL_FILE_HEADER="PK",i.CENTRAL_FILE_HEADER="PK",i.CENTRAL_DIRECTORY_END="PK",i.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",i.ZIP64_CENTRAL_DIRECTORY_END="PK",i.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(t,c,i){var n=t("./GenericWorker"),o=t("../utils");function a(r){n.call(this,"ConvertWorker to "+r),this.destType=r}o.inherits(a,n),a.prototype.processChunk=function(r){this.push({data:o.transformTo(this.destType,r.data),meta:r.meta})},c.exports=a},{"../utils":32,"./GenericWorker":28}],25:[function(t,c,i){var n=t("./GenericWorker"),o=t("../crc32");function a(){n.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}t("../utils").inherits(a,n),a.prototype.processChunk=function(r){this.streamInfo.crc32=o(r.data,this.streamInfo.crc32||0),this.push(r)},c.exports=a},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(t,c,i){var n=t("../utils"),o=t("./GenericWorker");function a(r){o.call(this,"DataLengthProbe for "+r),this.propName=r,this.withStreamInfo(r,0)}n.inherits(a,o),a.prototype.processChunk=function(r){if(r){var l=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=l+r.data.length}o.prototype.processChunk.call(this,r)},c.exports=a},{"../utils":32,"./GenericWorker":28}],27:[function(t,c,i){var n=t("../utils"),o=t("./GenericWorker");function a(r){o.call(this,"DataWorker");var l=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,r.then(function(f){l.dataIsReady=!0,l.data=f,l.max=f&&f.length||0,l.type=n.getTypeOf(f),l.isPaused||l._tickAndRepeat()},function(f){l.error(f)})}n.inherits(a,o),a.prototype.cleanUp=function(){o.prototype.cleanUp.call(this),this.data=null},a.prototype.resume=function(){return!!o.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,n.delay(this._tickAndRepeat,[],this)),!0)},a.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(n.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},a.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var r=null,l=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":r=this.data.substring(this.index,l);break;case"uint8array":r=this.data.subarray(this.index,l);break;case"array":case"nodebuffer":r=this.data.slice(this.index,l)}return this.index=l,this.push({data:r,meta:{percent:this.max?this.index/this.max*100:0}})},c.exports=a},{"../utils":32,"./GenericWorker":28}],28:[function(t,c,i){function n(o){this.name=o||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}n.prototype={push:function(o){this.emit("data",o)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(o){this.emit("error",o)}return!0},error:function(o){return!this.isFinished&&(this.isPaused?this.generatedError=o:(this.isFinished=!0,this.emit("error",o),this.previous&&this.previous.error(o),this.cleanUp()),!0)},on:function(o,a){return this._listeners[o].push(a),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(o,a){if(this._listeners[o])for(var r=0;r<this._listeners[o].length;r++)this._listeners[o][r].call(this,a)},pipe:function(o){return o.registerPrevious(this)},registerPrevious:function(o){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=o.streamInfo,this.mergeStreamInfo(),this.previous=o;var a=this;return o.on("data",function(r){a.processChunk(r)}),o.on("end",function(){a.end()}),o.on("error",function(r){a.error(r)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var o=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),o=!0),this.previous&&this.previous.resume(),!o},flush:function(){},processChunk:function(o){this.push(o)},withStreamInfo:function(o,a){return this.extraStreamInfo[o]=a,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var o in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,o)&&(this.streamInfo[o]=this.extraStreamInfo[o])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var o="Worker "+this.name;return this.previous?this.previous+" -> "+o:o}},c.exports=n},{}],29:[function(t,c,i){var n=t("../utils"),o=t("./ConvertWorker"),a=t("./GenericWorker"),r=t("../base64"),l=t("../support"),f=t("../external"),p=null;if(l.nodestream)try{p=t("../nodejs/NodejsStreamOutputAdapter")}catch{}function h(y,u){return new f.Promise(function(v,b){var C=[],S=y._internalType,_=y._outputType,k=y._mimeType;y.on("data",function(x,L){C.push(x),u&&u(L)}).on("error",function(x){C=[],b(x)}).on("end",function(){try{var x=function(L,D,M){switch(L){case"blob":return n.newBlob(n.transformTo("arraybuffer",D),M);case"base64":return r.encode(D);default:return n.transformTo(L,D)}}(_,function(L,D){var M,U=0,Q=null,I=0;for(M=0;M<D.length;M++)I+=D[M].length;switch(L){case"string":return D.join("");case"array":return Array.prototype.concat.apply([],D);case"uint8array":for(Q=new Uint8Array(I),M=0;M<D.length;M++)Q.set(D[M],U),U+=D[M].length;return Q;case"nodebuffer":return Buffer.concat(D);default:throw new Error("concat : unsupported type '"+L+"'")}}(S,C),k);v(x)}catch(L){b(L)}C=[]}).resume()})}function m(y,u,v){var b=u;switch(u){case"blob":case"arraybuffer":b="uint8array";break;case"base64":b="string"}try{this._internalType=b,this._outputType=u,this._mimeType=v,n.checkSupport(b),this._worker=y.pipe(new o(b)),y.lock()}catch(C){this._worker=new a("error"),this._worker.error(C)}}m.prototype={accumulate:function(y){return h(this,y)},on:function(y,u){var v=this;return y==="data"?this._worker.on(y,function(b){u.call(v,b.data,b.meta)}):this._worker.on(y,function(){n.delay(u,arguments,v)}),this},resume:function(){return n.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(y){if(n.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new p(this,{objectMode:this._outputType!=="nodebuffer"},y)}},c.exports=m},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(t,c,i){if(i.base64=!0,i.array=!0,i.string=!0,i.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",i.nodebuffer=typeof Buffer<"u",i.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")i.blob=!1;else{var n=new ArrayBuffer(0);try{i.blob=new Blob([n],{type:"application/zip"}).size===0}catch{try{var o=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);o.append(n),i.blob=o.getBlob("application/zip").size===0}catch{i.blob=!1}}}try{i.nodestream=!!t("readable-stream").Readable}catch{i.nodestream=!1}},{"readable-stream":16}],31:[function(t,c,i){for(var n=t("./utils"),o=t("./support"),a=t("./nodejsUtils"),r=t("./stream/GenericWorker"),l=new Array(256),f=0;f<256;f++)l[f]=252<=f?6:248<=f?5:240<=f?4:224<=f?3:192<=f?2:1;l[254]=l[254]=1;function p(){r.call(this,"utf-8 decode"),this.leftOver=null}function h(){r.call(this,"utf-8 encode")}i.utf8encode=function(m){return o.nodebuffer?a.newBufferFrom(m,"utf-8"):function(y){var u,v,b,C,S,_=y.length,k=0;for(C=0;C<_;C++)(64512&(v=y.charCodeAt(C)))==55296&&C+1<_&&(64512&(b=y.charCodeAt(C+1)))==56320&&(v=65536+(v-55296<<10)+(b-56320),C++),k+=v<128?1:v<2048?2:v<65536?3:4;for(u=o.uint8array?new Uint8Array(k):new Array(k),C=S=0;S<k;C++)(64512&(v=y.charCodeAt(C)))==55296&&C+1<_&&(64512&(b=y.charCodeAt(C+1)))==56320&&(v=65536+(v-55296<<10)+(b-56320),C++),v<128?u[S++]=v:(v<2048?u[S++]=192|v>>>6:(v<65536?u[S++]=224|v>>>12:(u[S++]=240|v>>>18,u[S++]=128|v>>>12&63),u[S++]=128|v>>>6&63),u[S++]=128|63&v);return u}(m)},i.utf8decode=function(m){return o.nodebuffer?n.transformTo("nodebuffer",m).toString("utf-8"):function(y){var u,v,b,C,S=y.length,_=new Array(2*S);for(u=v=0;u<S;)if((b=y[u++])<128)_[v++]=b;else if(4<(C=l[b]))_[v++]=65533,u+=C-1;else{for(b&=C===2?31:C===3?15:7;1<C&&u<S;)b=b<<6|63&y[u++],C--;1<C?_[v++]=65533:b<65536?_[v++]=b:(b-=65536,_[v++]=55296|b>>10&1023,_[v++]=56320|1023&b)}return _.length!==v&&(_.subarray?_=_.subarray(0,v):_.length=v),n.applyFromCharCode(_)}(m=n.transformTo(o.uint8array?"uint8array":"array",m))},n.inherits(p,r),p.prototype.processChunk=function(m){var y=n.transformTo(o.uint8array?"uint8array":"array",m.data);if(this.leftOver&&this.leftOver.length){if(o.uint8array){var u=y;(y=new Uint8Array(u.length+this.leftOver.length)).set(this.leftOver,0),y.set(u,this.leftOver.length)}else y=this.leftOver.concat(y);this.leftOver=null}var v=function(C,S){var _;for((S=S||C.length)>C.length&&(S=C.length),_=S-1;0<=_&&(192&C[_])==128;)_--;return _<0||_===0?S:_+l[C[_]]>S?_:S}(y),b=y;v!==y.length&&(o.uint8array?(b=y.subarray(0,v),this.leftOver=y.subarray(v,y.length)):(b=y.slice(0,v),this.leftOver=y.slice(v,y.length))),this.push({data:i.utf8decode(b),meta:m.meta})},p.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:i.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},i.Utf8DecodeWorker=p,n.inherits(h,r),h.prototype.processChunk=function(m){this.push({data:i.utf8encode(m.data),meta:m.meta})},i.Utf8EncodeWorker=h},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(t,c,i){var n=t("./support"),o=t("./base64"),a=t("./nodejsUtils"),r=t("./external");function l(u){return u}function f(u,v){for(var b=0;b<u.length;++b)v[b]=255&u.charCodeAt(b);return v}t("setimmediate"),i.newBlob=function(u,v){i.checkSupport("blob");try{return new Blob([u],{type:v})}catch{try{var b=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return b.append(u),b.getBlob(v)}catch{throw new Error("Bug : can't construct the Blob.")}}};var p={stringifyByChunk:function(u,v,b){var C=[],S=0,_=u.length;if(_<=b)return String.fromCharCode.apply(null,u);for(;S<_;)v==="array"||v==="nodebuffer"?C.push(String.fromCharCode.apply(null,u.slice(S,Math.min(S+b,_)))):C.push(String.fromCharCode.apply(null,u.subarray(S,Math.min(S+b,_)))),S+=b;return C.join("")},stringifyByChar:function(u){for(var v="",b=0;b<u.length;b++)v+=String.fromCharCode(u[b]);return v},applyCanBeUsed:{uint8array:function(){try{return n.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}}(),nodebuffer:function(){try{return n.nodebuffer&&String.fromCharCode.apply(null,a.allocBuffer(1)).length===1}catch{return!1}}()}};function h(u){var v=65536,b=i.getTypeOf(u),C=!0;if(b==="uint8array"?C=p.applyCanBeUsed.uint8array:b==="nodebuffer"&&(C=p.applyCanBeUsed.nodebuffer),C)for(;1<v;)try{return p.stringifyByChunk(u,b,v)}catch{v=Math.floor(v/2)}return p.stringifyByChar(u)}function m(u,v){for(var b=0;b<u.length;b++)v[b]=u[b];return v}i.applyFromCharCode=h;var y={};y.string={string:l,array:function(u){return f(u,new Array(u.length))},arraybuffer:function(u){return y.string.uint8array(u).buffer},uint8array:function(u){return f(u,new Uint8Array(u.length))},nodebuffer:function(u){return f(u,a.allocBuffer(u.length))}},y.array={string:h,array:l,arraybuffer:function(u){return new Uint8Array(u).buffer},uint8array:function(u){return new Uint8Array(u)},nodebuffer:function(u){return a.newBufferFrom(u)}},y.arraybuffer={string:function(u){return h(new Uint8Array(u))},array:function(u){return m(new Uint8Array(u),new Array(u.byteLength))},arraybuffer:l,uint8array:function(u){return new Uint8Array(u)},nodebuffer:function(u){return a.newBufferFrom(new Uint8Array(u))}},y.uint8array={string:h,array:function(u){return m(u,new Array(u.length))},arraybuffer:function(u){return u.buffer},uint8array:l,nodebuffer:function(u){return a.newBufferFrom(u)}},y.nodebuffer={string:h,array:function(u){return m(u,new Array(u.length))},arraybuffer:function(u){return y.nodebuffer.uint8array(u).buffer},uint8array:function(u){return m(u,new Uint8Array(u.length))},nodebuffer:l},i.transformTo=function(u,v){if(v=v||"",!u)return v;i.checkSupport(u);var b=i.getTypeOf(v);return y[b][u](v)},i.resolve=function(u){for(var v=u.split("/"),b=[],C=0;C<v.length;C++){var S=v[C];S==="."||S===""&&C!==0&&C!==v.length-1||(S===".."?b.pop():b.push(S))}return b.join("/")},i.getTypeOf=function(u){return typeof u=="string"?"string":Object.prototype.toString.call(u)==="[object Array]"?"array":n.nodebuffer&&a.isBuffer(u)?"nodebuffer":n.uint8array&&u instanceof Uint8Array?"uint8array":n.arraybuffer&&u instanceof ArrayBuffer?"arraybuffer":void 0},i.checkSupport=function(u){if(!n[u.toLowerCase()])throw new Error(u+" is not supported by this platform")},i.MAX_VALUE_16BITS=65535,i.MAX_VALUE_32BITS=-1,i.pretty=function(u){var v,b,C="";for(b=0;b<(u||"").length;b++)C+="\\x"+((v=u.charCodeAt(b))<16?"0":"")+v.toString(16).toUpperCase();return C},i.delay=function(u,v,b){setImmediate(function(){u.apply(b||null,v||[])})},i.inherits=function(u,v){function b(){}b.prototype=v.prototype,u.prototype=new b},i.extend=function(){var u,v,b={};for(u=0;u<arguments.length;u++)for(v in arguments[u])Object.prototype.hasOwnProperty.call(arguments[u],v)&&b[v]===void 0&&(b[v]=arguments[u][v]);return b},i.prepareContent=function(u,v,b,C,S){return r.Promise.resolve(v).then(function(_){return n.blob&&(_ instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(_))!==-1)&&typeof FileReader<"u"?new r.Promise(function(k,x){var L=new FileReader;L.onload=function(D){k(D.target.result)},L.onerror=function(D){x(D.target.error)},L.readAsArrayBuffer(_)}):_}).then(function(_){var k=i.getTypeOf(_);return k?(k==="arraybuffer"?_=i.transformTo("uint8array",_):k==="string"&&(S?_=o.decode(_):b&&C!==!0&&(_=function(x){return f(x,n.uint8array?new Uint8Array(x.length):new Array(x.length))}(_))),_):r.Promise.reject(new Error("Can't read the data of '"+u+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(t,c,i){var n=t("./reader/readerFor"),o=t("./utils"),a=t("./signature"),r=t("./zipEntry"),l=t("./support");function f(p){this.files=[],this.loadOptions=p}f.prototype={checkSignature:function(p){if(!this.reader.readAndCheckSignature(p)){this.reader.index-=4;var h=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+o.pretty(h)+", expected "+o.pretty(p)+")")}},isSignature:function(p,h){var m=this.reader.index;this.reader.setIndex(p);var y=this.reader.readString(4)===h;return this.reader.setIndex(m),y},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var p=this.reader.readData(this.zipCommentLength),h=l.uint8array?"uint8array":"array",m=o.transformTo(h,p);this.zipComment=this.loadOptions.decodeFileName(m)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var p,h,m,y=this.zip64EndOfCentralSize-44;0<y;)p=this.reader.readInt(2),h=this.reader.readInt(4),m=this.reader.readData(h),this.zip64ExtensibleData[p]={id:p,length:h,value:m}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var p,h;for(p=0;p<this.files.length;p++)h=this.files[p],this.reader.setIndex(h.localHeaderOffset),this.checkSignature(a.LOCAL_FILE_HEADER),h.readLocalPart(this.reader),h.handleUTF8(),h.processAttributes()},readCentralDir:function(){var p;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(a.CENTRAL_FILE_HEADER);)(p=new r({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(p);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var p=this.reader.lastIndexOfSignature(a.CENTRAL_DIRECTORY_END);if(p<0)throw this.isSignature(0,a.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(p);var h=p;if(this.checkSignature(a.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===o.MAX_VALUE_16BITS||this.diskWithCentralDirStart===o.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===o.MAX_VALUE_16BITS||this.centralDirRecords===o.MAX_VALUE_16BITS||this.centralDirSize===o.MAX_VALUE_32BITS||this.centralDirOffset===o.MAX_VALUE_32BITS){if(this.zip64=!0,(p=this.reader.lastIndexOfSignature(a.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(p),this.checkSignature(a.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,a.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(a.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(a.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var m=this.centralDirOffset+this.centralDirSize;this.zip64&&(m+=20,m+=12+this.zip64EndOfCentralSize);var y=h-m;if(0<y)this.isSignature(h,a.CENTRAL_FILE_HEADER)||(this.reader.zero=y);else if(y<0)throw new Error("Corrupted zip: missing "+Math.abs(y)+" bytes.")},prepareReader:function(p){this.reader=n(p)},load:function(p){this.prepareReader(p),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},c.exports=f},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(t,c,i){var n=t("./reader/readerFor"),o=t("./utils"),a=t("./compressedObject"),r=t("./crc32"),l=t("./utf8"),f=t("./compressions"),p=t("./support");function h(m,y){this.options=m,this.loadOptions=y}h.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(m){var y,u;if(m.skip(22),this.fileNameLength=m.readInt(2),u=m.readInt(2),this.fileName=m.readData(this.fileNameLength),m.skip(u),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((y=function(v){for(var b in f)if(Object.prototype.hasOwnProperty.call(f,b)&&f[b].magic===v)return f[b];return null}(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+o.pretty(this.compressionMethod)+" unknown (inner file : "+o.transformTo("string",this.fileName)+")");this.decompressed=new a(this.compressedSize,this.uncompressedSize,this.crc32,y,m.readData(this.compressedSize))},readCentralPart:function(m){this.versionMadeBy=m.readInt(2),m.skip(2),this.bitFlag=m.readInt(2),this.compressionMethod=m.readString(2),this.date=m.readDate(),this.crc32=m.readInt(4),this.compressedSize=m.readInt(4),this.uncompressedSize=m.readInt(4);var y=m.readInt(2);if(this.extraFieldsLength=m.readInt(2),this.fileCommentLength=m.readInt(2),this.diskNumberStart=m.readInt(2),this.internalFileAttributes=m.readInt(2),this.externalFileAttributes=m.readInt(4),this.localHeaderOffset=m.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");m.skip(y),this.readExtraFields(m),this.parseZIP64ExtraField(m),this.fileComment=m.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var m=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),m==0&&(this.dosPermissions=63&this.externalFileAttributes),m==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var m=n(this.extraFields[1].value);this.uncompressedSize===o.MAX_VALUE_32BITS&&(this.uncompressedSize=m.readInt(8)),this.compressedSize===o.MAX_VALUE_32BITS&&(this.compressedSize=m.readInt(8)),this.localHeaderOffset===o.MAX_VALUE_32BITS&&(this.localHeaderOffset=m.readInt(8)),this.diskNumberStart===o.MAX_VALUE_32BITS&&(this.diskNumberStart=m.readInt(4))}},readExtraFields:function(m){var y,u,v,b=m.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});m.index+4<b;)y=m.readInt(2),u=m.readInt(2),v=m.readData(u),this.extraFields[y]={id:y,length:u,value:v};m.setIndex(b)},handleUTF8:function(){var m=p.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=l.utf8decode(this.fileName),this.fileCommentStr=l.utf8decode(this.fileComment);else{var y=this.findExtraFieldUnicodePath();if(y!==null)this.fileNameStr=y;else{var u=o.transformTo(m,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(u)}var v=this.findExtraFieldUnicodeComment();if(v!==null)this.fileCommentStr=v;else{var b=o.transformTo(m,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(b)}}},findExtraFieldUnicodePath:function(){var m=this.extraFields[28789];if(m){var y=n(m.value);return y.readInt(1)!==1||r(this.fileName)!==y.readInt(4)?null:l.utf8decode(y.readData(m.length-5))}return null},findExtraFieldUnicodeComment:function(){var m=this.extraFields[25461];if(m){var y=n(m.value);return y.readInt(1)!==1||r(this.fileComment)!==y.readInt(4)?null:l.utf8decode(y.readData(m.length-5))}return null}},c.exports=h},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(t,c,i){function n(y,u,v){this.name=y,this.dir=v.dir,this.date=v.date,this.comment=v.comment,this.unixPermissions=v.unixPermissions,this.dosPermissions=v.dosPermissions,this._data=u,this._dataBinary=v.binary,this.options={compression:v.compression,compressionOptions:v.compressionOptions}}var o=t("./stream/StreamHelper"),a=t("./stream/DataWorker"),r=t("./utf8"),l=t("./compressedObject"),f=t("./stream/GenericWorker");n.prototype={internalStream:function(y){var u=null,v="string";try{if(!y)throw new Error("No output type specified.");var b=(v=y.toLowerCase())==="string"||v==="text";v!=="binarystring"&&v!=="text"||(v="string"),u=this._decompressWorker();var C=!this._dataBinary;C&&!b&&(u=u.pipe(new r.Utf8EncodeWorker)),!C&&b&&(u=u.pipe(new r.Utf8DecodeWorker))}catch(S){(u=new f("error")).error(S)}return new o(u,v,"")},async:function(y,u){return this.internalStream(y).accumulate(u)},nodeStream:function(y,u){return this.internalStream(y||"nodebuffer").toNodejsStream(u)},_compressWorker:function(y,u){if(this._data instanceof l&&this._data.compression.magic===y.magic)return this._data.getCompressedWorker();var v=this._decompressWorker();return this._dataBinary||(v=v.pipe(new r.Utf8EncodeWorker)),l.createWorkerFrom(v,y,u)},_decompressWorker:function(){return this._data instanceof l?this._data.getContentWorker():this._data instanceof f?this._data:new a(this._data)}};for(var p=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],h=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},m=0;m<p.length;m++)n.prototype[p[m]]=h;c.exports=n},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(t,c,i){(function(n){var o,a,r=n.MutationObserver||n.WebKitMutationObserver;if(r){var l=0,f=new r(y),p=n.document.createTextNode("");f.observe(p,{characterData:!0}),o=function(){p.data=l=++l%2}}else if(n.setImmediate||n.MessageChannel===void 0)o="document"in n&&"onreadystatechange"in n.document.createElement("script")?function(){var u=n.document.createElement("script");u.onreadystatechange=function(){y(),u.onreadystatechange=null,u.parentNode.removeChild(u),u=null},n.document.documentElement.appendChild(u)}:function(){setTimeout(y,0)};else{var h=new n.MessageChannel;h.port1.onmessage=y,o=function(){h.port2.postMessage(0)}}var m=[];function y(){var u,v;a=!0;for(var b=m.length;b;){for(v=m,m=[],u=-1;++u<b;)v[u]();b=m.length}a=!1}c.exports=function(u){m.push(u)!==1||a||o()}}).call(this,typeof Tn<"u"?Tn:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(t,c,i){var n=t("immediate");function o(){}var a={},r=["REJECTED"],l=["FULFILLED"],f=["PENDING"];function p(b){if(typeof b!="function")throw new TypeError("resolver must be a function");this.state=f,this.queue=[],this.outcome=void 0,b!==o&&u(this,b)}function h(b,C,S){this.promise=b,typeof C=="function"&&(this.onFulfilled=C,this.callFulfilled=this.otherCallFulfilled),typeof S=="function"&&(this.onRejected=S,this.callRejected=this.otherCallRejected)}function m(b,C,S){n(function(){var _;try{_=C(S)}catch(k){return a.reject(b,k)}_===b?a.reject(b,new TypeError("Cannot resolve promise with itself")):a.resolve(b,_)})}function y(b){var C=b&&b.then;if(b&&(typeof b=="object"||typeof b=="function")&&typeof C=="function")return function(){C.apply(b,arguments)}}function u(b,C){var S=!1;function _(L){S||(S=!0,a.reject(b,L))}function k(L){S||(S=!0,a.resolve(b,L))}var x=v(function(){C(k,_)});x.status==="error"&&_(x.value)}function v(b,C){var S={};try{S.value=b(C),S.status="success"}catch(_){S.status="error",S.value=_}return S}(c.exports=p).prototype.finally=function(b){if(typeof b!="function")return this;var C=this.constructor;return this.then(function(S){return C.resolve(b()).then(function(){return S})},function(S){return C.resolve(b()).then(function(){throw S})})},p.prototype.catch=function(b){return this.then(null,b)},p.prototype.then=function(b,C){if(typeof b!="function"&&this.state===l||typeof C!="function"&&this.state===r)return this;var S=new this.constructor(o);return this.state!==f?m(S,this.state===l?b:C,this.outcome):this.queue.push(new h(S,b,C)),S},h.prototype.callFulfilled=function(b){a.resolve(this.promise,b)},h.prototype.otherCallFulfilled=function(b){m(this.promise,this.onFulfilled,b)},h.prototype.callRejected=function(b){a.reject(this.promise,b)},h.prototype.otherCallRejected=function(b){m(this.promise,this.onRejected,b)},a.resolve=function(b,C){var S=v(y,C);if(S.status==="error")return a.reject(b,S.value);var _=S.value;if(_)u(b,_);else{b.state=l,b.outcome=C;for(var k=-1,x=b.queue.length;++k<x;)b.queue[k].callFulfilled(C)}return b},a.reject=function(b,C){b.state=r,b.outcome=C;for(var S=-1,_=b.queue.length;++S<_;)b.queue[S].callRejected(C);return b},p.resolve=function(b){return b instanceof this?b:a.resolve(new this(o),b)},p.reject=function(b){var C=new this(o);return a.reject(C,b)},p.all=function(b){var C=this;if(Object.prototype.toString.call(b)!=="[object Array]")return this.reject(new TypeError("must be an array"));var S=b.length,_=!1;if(!S)return this.resolve([]);for(var k=new Array(S),x=0,L=-1,D=new this(o);++L<S;)M(b[L],L);return D;function M(U,Q){C.resolve(U).then(function(I){k[Q]=I,++x!==S||_||(_=!0,a.resolve(D,k))},function(I){_||(_=!0,a.reject(D,I))})}},p.race=function(b){var C=this;if(Object.prototype.toString.call(b)!=="[object Array]")return this.reject(new TypeError("must be an array"));var S=b.length,_=!1;if(!S)return this.resolve([]);for(var k=-1,x=new this(o);++k<S;)L=b[k],C.resolve(L).then(function(D){_||(_=!0,a.resolve(x,D))},function(D){_||(_=!0,a.reject(x,D))});var L;return x}},{immediate:36}],38:[function(t,c,i){var n={};(0,t("./lib/utils/common").assign)(n,t("./lib/deflate"),t("./lib/inflate"),t("./lib/zlib/constants")),c.exports=n},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(t,c,i){var n=t("./zlib/deflate"),o=t("./utils/common"),a=t("./utils/strings"),r=t("./zlib/messages"),l=t("./zlib/zstream"),f=Object.prototype.toString,p=0,h=-1,m=0,y=8;function u(b){if(!(this instanceof u))return new u(b);this.options=o.assign({level:h,method:y,chunkSize:16384,windowBits:15,memLevel:8,strategy:m,to:""},b||{});var C=this.options;C.raw&&0<C.windowBits?C.windowBits=-C.windowBits:C.gzip&&0<C.windowBits&&C.windowBits<16&&(C.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new l,this.strm.avail_out=0;var S=n.deflateInit2(this.strm,C.level,C.method,C.windowBits,C.memLevel,C.strategy);if(S!==p)throw new Error(r[S]);if(C.header&&n.deflateSetHeader(this.strm,C.header),C.dictionary){var _;if(_=typeof C.dictionary=="string"?a.string2buf(C.dictionary):f.call(C.dictionary)==="[object ArrayBuffer]"?new Uint8Array(C.dictionary):C.dictionary,(S=n.deflateSetDictionary(this.strm,_))!==p)throw new Error(r[S]);this._dict_set=!0}}function v(b,C){var S=new u(C);if(S.push(b,!0),S.err)throw S.msg||r[S.err];return S.result}u.prototype.push=function(b,C){var S,_,k=this.strm,x=this.options.chunkSize;if(this.ended)return!1;_=C===~~C?C:C===!0?4:0,typeof b=="string"?k.input=a.string2buf(b):f.call(b)==="[object ArrayBuffer]"?k.input=new Uint8Array(b):k.input=b,k.next_in=0,k.avail_in=k.input.length;do{if(k.avail_out===0&&(k.output=new o.Buf8(x),k.next_out=0,k.avail_out=x),(S=n.deflate(k,_))!==1&&S!==p)return this.onEnd(S),!(this.ended=!0);k.avail_out!==0&&(k.avail_in!==0||_!==4&&_!==2)||(this.options.to==="string"?this.onData(a.buf2binstring(o.shrinkBuf(k.output,k.next_out))):this.onData(o.shrinkBuf(k.output,k.next_out)))}while((0<k.avail_in||k.avail_out===0)&&S!==1);return _===4?(S=n.deflateEnd(this.strm),this.onEnd(S),this.ended=!0,S===p):_!==2||(this.onEnd(p),!(k.avail_out=0))},u.prototype.onData=function(b){this.chunks.push(b)},u.prototype.onEnd=function(b){b===p&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=o.flattenChunks(this.chunks)),this.chunks=[],this.err=b,this.msg=this.strm.msg},i.Deflate=u,i.deflate=v,i.deflateRaw=function(b,C){return(C=C||{}).raw=!0,v(b,C)},i.gzip=function(b,C){return(C=C||{}).gzip=!0,v(b,C)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(t,c,i){var n=t("./zlib/inflate"),o=t("./utils/common"),a=t("./utils/strings"),r=t("./zlib/constants"),l=t("./zlib/messages"),f=t("./zlib/zstream"),p=t("./zlib/gzheader"),h=Object.prototype.toString;function m(u){if(!(this instanceof m))return new m(u);this.options=o.assign({chunkSize:16384,windowBits:0,to:""},u||{});var v=this.options;v.raw&&0<=v.windowBits&&v.windowBits<16&&(v.windowBits=-v.windowBits,v.windowBits===0&&(v.windowBits=-15)),!(0<=v.windowBits&&v.windowBits<16)||u&&u.windowBits||(v.windowBits+=32),15<v.windowBits&&v.windowBits<48&&!(15&v.windowBits)&&(v.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new f,this.strm.avail_out=0;var b=n.inflateInit2(this.strm,v.windowBits);if(b!==r.Z_OK)throw new Error(l[b]);this.header=new p,n.inflateGetHeader(this.strm,this.header)}function y(u,v){var b=new m(v);if(b.push(u,!0),b.err)throw b.msg||l[b.err];return b.result}m.prototype.push=function(u,v){var b,C,S,_,k,x,L=this.strm,D=this.options.chunkSize,M=this.options.dictionary,U=!1;if(this.ended)return!1;C=v===~~v?v:v===!0?r.Z_FINISH:r.Z_NO_FLUSH,typeof u=="string"?L.input=a.binstring2buf(u):h.call(u)==="[object ArrayBuffer]"?L.input=new Uint8Array(u):L.input=u,L.next_in=0,L.avail_in=L.input.length;do{if(L.avail_out===0&&(L.output=new o.Buf8(D),L.next_out=0,L.avail_out=D),(b=n.inflate(L,r.Z_NO_FLUSH))===r.Z_NEED_DICT&&M&&(x=typeof M=="string"?a.string2buf(M):h.call(M)==="[object ArrayBuffer]"?new Uint8Array(M):M,b=n.inflateSetDictionary(this.strm,x)),b===r.Z_BUF_ERROR&&U===!0&&(b=r.Z_OK,U=!1),b!==r.Z_STREAM_END&&b!==r.Z_OK)return this.onEnd(b),!(this.ended=!0);L.next_out&&(L.avail_out!==0&&b!==r.Z_STREAM_END&&(L.avail_in!==0||C!==r.Z_FINISH&&C!==r.Z_SYNC_FLUSH)||(this.options.to==="string"?(S=a.utf8border(L.output,L.next_out),_=L.next_out-S,k=a.buf2string(L.output,S),L.next_out=_,L.avail_out=D-_,_&&o.arraySet(L.output,L.output,S,_,0),this.onData(k)):this.onData(o.shrinkBuf(L.output,L.next_out)))),L.avail_in===0&&L.avail_out===0&&(U=!0)}while((0<L.avail_in||L.avail_out===0)&&b!==r.Z_STREAM_END);return b===r.Z_STREAM_END&&(C=r.Z_FINISH),C===r.Z_FINISH?(b=n.inflateEnd(this.strm),this.onEnd(b),this.ended=!0,b===r.Z_OK):C!==r.Z_SYNC_FLUSH||(this.onEnd(r.Z_OK),!(L.avail_out=0))},m.prototype.onData=function(u){this.chunks.push(u)},m.prototype.onEnd=function(u){u===r.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=o.flattenChunks(this.chunks)),this.chunks=[],this.err=u,this.msg=this.strm.msg},i.Inflate=m,i.inflate=y,i.inflateRaw=function(u,v){return(v=v||{}).raw=!0,y(u,v)},i.ungzip=y},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(t,c,i){var n=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";i.assign=function(r){for(var l=Array.prototype.slice.call(arguments,1);l.length;){var f=l.shift();if(f){if(typeof f!="object")throw new TypeError(f+"must be non-object");for(var p in f)f.hasOwnProperty(p)&&(r[p]=f[p])}}return r},i.shrinkBuf=function(r,l){return r.length===l?r:r.subarray?r.subarray(0,l):(r.length=l,r)};var o={arraySet:function(r,l,f,p,h){if(l.subarray&&r.subarray)r.set(l.subarray(f,f+p),h);else for(var m=0;m<p;m++)r[h+m]=l[f+m]},flattenChunks:function(r){var l,f,p,h,m,y;for(l=p=0,f=r.length;l<f;l++)p+=r[l].length;for(y=new Uint8Array(p),l=h=0,f=r.length;l<f;l++)m=r[l],y.set(m,h),h+=m.length;return y}},a={arraySet:function(r,l,f,p,h){for(var m=0;m<p;m++)r[h+m]=l[f+m]},flattenChunks:function(r){return[].concat.apply([],r)}};i.setTyped=function(r){r?(i.Buf8=Uint8Array,i.Buf16=Uint16Array,i.Buf32=Int32Array,i.assign(i,o)):(i.Buf8=Array,i.Buf16=Array,i.Buf32=Array,i.assign(i,a))},i.setTyped(n)},{}],42:[function(t,c,i){var n=t("./common"),o=!0,a=!0;try{String.fromCharCode.apply(null,[0])}catch{o=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{a=!1}for(var r=new n.Buf8(256),l=0;l<256;l++)r[l]=252<=l?6:248<=l?5:240<=l?4:224<=l?3:192<=l?2:1;function f(p,h){if(h<65537&&(p.subarray&&a||!p.subarray&&o))return String.fromCharCode.apply(null,n.shrinkBuf(p,h));for(var m="",y=0;y<h;y++)m+=String.fromCharCode(p[y]);return m}r[254]=r[254]=1,i.string2buf=function(p){var h,m,y,u,v,b=p.length,C=0;for(u=0;u<b;u++)(64512&(m=p.charCodeAt(u)))==55296&&u+1<b&&(64512&(y=p.charCodeAt(u+1)))==56320&&(m=65536+(m-55296<<10)+(y-56320),u++),C+=m<128?1:m<2048?2:m<65536?3:4;for(h=new n.Buf8(C),u=v=0;v<C;u++)(64512&(m=p.charCodeAt(u)))==55296&&u+1<b&&(64512&(y=p.charCodeAt(u+1)))==56320&&(m=65536+(m-55296<<10)+(y-56320),u++),m<128?h[v++]=m:(m<2048?h[v++]=192|m>>>6:(m<65536?h[v++]=224|m>>>12:(h[v++]=240|m>>>18,h[v++]=128|m>>>12&63),h[v++]=128|m>>>6&63),h[v++]=128|63&m);return h},i.buf2binstring=function(p){return f(p,p.length)},i.binstring2buf=function(p){for(var h=new n.Buf8(p.length),m=0,y=h.length;m<y;m++)h[m]=p.charCodeAt(m);return h},i.buf2string=function(p,h){var m,y,u,v,b=h||p.length,C=new Array(2*b);for(m=y=0;m<b;)if((u=p[m++])<128)C[y++]=u;else if(4<(v=r[u]))C[y++]=65533,m+=v-1;else{for(u&=v===2?31:v===3?15:7;1<v&&m<b;)u=u<<6|63&p[m++],v--;1<v?C[y++]=65533:u<65536?C[y++]=u:(u-=65536,C[y++]=55296|u>>10&1023,C[y++]=56320|1023&u)}return f(C,y)},i.utf8border=function(p,h){var m;for((h=h||p.length)>p.length&&(h=p.length),m=h-1;0<=m&&(192&p[m])==128;)m--;return m<0||m===0?h:m+r[p[m]]>h?m:h}},{"./common":41}],43:[function(t,c,i){c.exports=function(n,o,a,r){for(var l=65535&n|0,f=n>>>16&65535|0,p=0;a!==0;){for(a-=p=2e3<a?2e3:a;f=f+(l=l+o[r++]|0)|0,--p;);l%=65521,f%=65521}return l|f<<16|0}},{}],44:[function(t,c,i){c.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(t,c,i){var n=function(){for(var o,a=[],r=0;r<256;r++){o=r;for(var l=0;l<8;l++)o=1&o?3988292384^o>>>1:o>>>1;a[r]=o}return a}();c.exports=function(o,a,r,l){var f=n,p=l+r;o^=-1;for(var h=l;h<p;h++)o=o>>>8^f[255&(o^a[h])];return-1^o}},{}],46:[function(t,c,i){var n,o=t("../utils/common"),a=t("./trees"),r=t("./adler32"),l=t("./crc32"),f=t("./messages"),p=0,h=4,m=0,y=-2,u=-1,v=4,b=2,C=8,S=9,_=286,k=30,x=19,L=2*_+1,D=15,M=3,U=258,Q=U+M+1,I=42,$=113,g=1,H=2,ue=3,Z=4;function me(d,F){return d.msg=f[F],F}function V(d){return(d<<1)-(4<d?9:0)}function fe(d){for(var F=d.length;0<=--F;)d[F]=0}function R(d){var F=d.state,z=F.pending;z>d.avail_out&&(z=d.avail_out),z!==0&&(o.arraySet(d.output,F.pending_buf,F.pending_out,z,d.next_out),d.next_out+=z,F.pending_out+=z,d.total_out+=z,d.avail_out-=z,F.pending-=z,F.pending===0&&(F.pending_out=0))}function O(d,F){a._tr_flush_block(d,0<=d.block_start?d.block_start:-1,d.strstart-d.block_start,F),d.block_start=d.strstart,R(d.strm)}function de(d,F){d.pending_buf[d.pending++]=F}function ne(d,F){d.pending_buf[d.pending++]=F>>>8&255,d.pending_buf[d.pending++]=255&F}function ee(d,F){var z,E,w=d.max_chain_length,T=d.strstart,j=d.prev_length,G=d.nice_match,N=d.strstart>d.w_size-Q?d.strstart-(d.w_size-Q):0,J=d.window,te=d.w_mask,X=d.prev,le=d.strstart+U,xe=J[T+j-1],ye=J[T+j];d.prev_length>=d.good_match&&(w>>=2),G>d.lookahead&&(G=d.lookahead);do if(J[(z=F)+j]===ye&&J[z+j-1]===xe&&J[z]===J[T]&&J[++z]===J[T+1]){T+=2,z++;do;while(J[++T]===J[++z]&&J[++T]===J[++z]&&J[++T]===J[++z]&&J[++T]===J[++z]&&J[++T]===J[++z]&&J[++T]===J[++z]&&J[++T]===J[++z]&&J[++T]===J[++z]&&T<le);if(E=U-(le-T),T=le-U,j<E){if(d.match_start=F,G<=(j=E))break;xe=J[T+j-1],ye=J[T+j]}}while((F=X[F&te])>N&&--w!=0);return j<=d.lookahead?j:d.lookahead}function De(d){var F,z,E,w,T,j,G,N,J,te,X=d.w_size;do{if(w=d.window_size-d.lookahead-d.strstart,d.strstart>=X+(X-Q)){for(o.arraySet(d.window,d.window,X,X,0),d.match_start-=X,d.strstart-=X,d.block_start-=X,F=z=d.hash_size;E=d.head[--F],d.head[F]=X<=E?E-X:0,--z;);for(F=z=X;E=d.prev[--F],d.prev[F]=X<=E?E-X:0,--z;);w+=X}if(d.strm.avail_in===0)break;if(j=d.strm,G=d.window,N=d.strstart+d.lookahead,J=w,te=void 0,te=j.avail_in,J<te&&(te=J),z=te===0?0:(j.avail_in-=te,o.arraySet(G,j.input,j.next_in,te,N),j.state.wrap===1?j.adler=r(j.adler,G,te,N):j.state.wrap===2&&(j.adler=l(j.adler,G,te,N)),j.next_in+=te,j.total_in+=te,te),d.lookahead+=z,d.lookahead+d.insert>=M)for(T=d.strstart-d.insert,d.ins_h=d.window[T],d.ins_h=(d.ins_h<<d.hash_shift^d.window[T+1])&d.hash_mask;d.insert&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[T+M-1])&d.hash_mask,d.prev[T&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=T,T++,d.insert--,!(d.lookahead+d.insert<M)););}while(d.lookahead<Q&&d.strm.avail_in!==0)}function Pe(d,F){for(var z,E;;){if(d.lookahead<Q){if(De(d),d.lookahead<Q&&F===p)return g;if(d.lookahead===0)break}if(z=0,d.lookahead>=M&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+M-1])&d.hash_mask,z=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),z!==0&&d.strstart-z<=d.w_size-Q&&(d.match_length=ee(d,z)),d.match_length>=M)if(E=a._tr_tally(d,d.strstart-d.match_start,d.match_length-M),d.lookahead-=d.match_length,d.match_length<=d.max_lazy_match&&d.lookahead>=M){for(d.match_length--;d.strstart++,d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+M-1])&d.hash_mask,z=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart,--d.match_length!=0;);d.strstart++}else d.strstart+=d.match_length,d.match_length=0,d.ins_h=d.window[d.strstart],d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+1])&d.hash_mask;else E=a._tr_tally(d,0,d.window[d.strstart]),d.lookahead--,d.strstart++;if(E&&(O(d,!1),d.strm.avail_out===0))return g}return d.insert=d.strstart<M-1?d.strstart:M-1,F===h?(O(d,!0),d.strm.avail_out===0?ue:Z):d.last_lit&&(O(d,!1),d.strm.avail_out===0)?g:H}function pe(d,F){for(var z,E,w;;){if(d.lookahead<Q){if(De(d),d.lookahead<Q&&F===p)return g;if(d.lookahead===0)break}if(z=0,d.lookahead>=M&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+M-1])&d.hash_mask,z=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),d.prev_length=d.match_length,d.prev_match=d.match_start,d.match_length=M-1,z!==0&&d.prev_length<d.max_lazy_match&&d.strstart-z<=d.w_size-Q&&(d.match_length=ee(d,z),d.match_length<=5&&(d.strategy===1||d.match_length===M&&4096<d.strstart-d.match_start)&&(d.match_length=M-1)),d.prev_length>=M&&d.match_length<=d.prev_length){for(w=d.strstart+d.lookahead-M,E=a._tr_tally(d,d.strstart-1-d.prev_match,d.prev_length-M),d.lookahead-=d.prev_length-1,d.prev_length-=2;++d.strstart<=w&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+M-1])&d.hash_mask,z=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),--d.prev_length!=0;);if(d.match_available=0,d.match_length=M-1,d.strstart++,E&&(O(d,!1),d.strm.avail_out===0))return g}else if(d.match_available){if((E=a._tr_tally(d,0,d.window[d.strstart-1]))&&O(d,!1),d.strstart++,d.lookahead--,d.strm.avail_out===0)return g}else d.match_available=1,d.strstart++,d.lookahead--}return d.match_available&&(E=a._tr_tally(d,0,d.window[d.strstart-1]),d.match_available=0),d.insert=d.strstart<M-1?d.strstart:M-1,F===h?(O(d,!0),d.strm.avail_out===0?ue:Z):d.last_lit&&(O(d,!1),d.strm.avail_out===0)?g:H}function Se(d,F,z,E,w){this.good_length=d,this.max_lazy=F,this.nice_length=z,this.max_chain=E,this.func=w}function Me(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=C,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new o.Buf16(2*L),this.dyn_dtree=new o.Buf16(2*(2*k+1)),this.bl_tree=new o.Buf16(2*(2*x+1)),fe(this.dyn_ltree),fe(this.dyn_dtree),fe(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new o.Buf16(D+1),this.heap=new o.Buf16(2*_+1),fe(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new o.Buf16(2*_+1),fe(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function Ne(d){var F;return d&&d.state?(d.total_in=d.total_out=0,d.data_type=b,(F=d.state).pending=0,F.pending_out=0,F.wrap<0&&(F.wrap=-F.wrap),F.status=F.wrap?I:$,d.adler=F.wrap===2?0:1,F.last_flush=p,a._tr_init(F),m):me(d,y)}function it(d){var F=Ne(d);return F===m&&function(z){z.window_size=2*z.w_size,fe(z.head),z.max_lazy_match=n[z.level].max_lazy,z.good_match=n[z.level].good_length,z.nice_match=n[z.level].nice_length,z.max_chain_length=n[z.level].max_chain,z.strstart=0,z.block_start=0,z.lookahead=0,z.insert=0,z.match_length=z.prev_length=M-1,z.match_available=0,z.ins_h=0}(d.state),F}function Ge(d,F,z,E,w,T){if(!d)return y;var j=1;if(F===u&&(F=6),E<0?(j=0,E=-E):15<E&&(j=2,E-=16),w<1||S<w||z!==C||E<8||15<E||F<0||9<F||T<0||v<T)return me(d,y);E===8&&(E=9);var G=new Me;return(d.state=G).strm=d,G.wrap=j,G.gzhead=null,G.w_bits=E,G.w_size=1<<G.w_bits,G.w_mask=G.w_size-1,G.hash_bits=w+7,G.hash_size=1<<G.hash_bits,G.hash_mask=G.hash_size-1,G.hash_shift=~~((G.hash_bits+M-1)/M),G.window=new o.Buf8(2*G.w_size),G.head=new o.Buf16(G.hash_size),G.prev=new o.Buf16(G.w_size),G.lit_bufsize=1<<w+6,G.pending_buf_size=4*G.lit_bufsize,G.pending_buf=new o.Buf8(G.pending_buf_size),G.d_buf=1*G.lit_bufsize,G.l_buf=3*G.lit_bufsize,G.level=F,G.strategy=T,G.method=z,it(d)}n=[new Se(0,0,0,0,function(d,F){var z=65535;for(z>d.pending_buf_size-5&&(z=d.pending_buf_size-5);;){if(d.lookahead<=1){if(De(d),d.lookahead===0&&F===p)return g;if(d.lookahead===0)break}d.strstart+=d.lookahead,d.lookahead=0;var E=d.block_start+z;if((d.strstart===0||d.strstart>=E)&&(d.lookahead=d.strstart-E,d.strstart=E,O(d,!1),d.strm.avail_out===0)||d.strstart-d.block_start>=d.w_size-Q&&(O(d,!1),d.strm.avail_out===0))return g}return d.insert=0,F===h?(O(d,!0),d.strm.avail_out===0?ue:Z):(d.strstart>d.block_start&&(O(d,!1),d.strm.avail_out),g)}),new Se(4,4,8,4,Pe),new Se(4,5,16,8,Pe),new Se(4,6,32,32,Pe),new Se(4,4,16,16,pe),new Se(8,16,32,32,pe),new Se(8,16,128,128,pe),new Se(8,32,128,256,pe),new Se(32,128,258,1024,pe),new Se(32,258,258,4096,pe)],i.deflateInit=function(d,F){return Ge(d,F,C,15,8,0)},i.deflateInit2=Ge,i.deflateReset=it,i.deflateResetKeep=Ne,i.deflateSetHeader=function(d,F){return d&&d.state?d.state.wrap!==2?y:(d.state.gzhead=F,m):y},i.deflate=function(d,F){var z,E,w,T;if(!d||!d.state||5<F||F<0)return d?me(d,y):y;if(E=d.state,!d.output||!d.input&&d.avail_in!==0||E.status===666&&F!==h)return me(d,d.avail_out===0?-5:y);if(E.strm=d,z=E.last_flush,E.last_flush=F,E.status===I)if(E.wrap===2)d.adler=0,de(E,31),de(E,139),de(E,8),E.gzhead?(de(E,(E.gzhead.text?1:0)+(E.gzhead.hcrc?2:0)+(E.gzhead.extra?4:0)+(E.gzhead.name?8:0)+(E.gzhead.comment?16:0)),de(E,255&E.gzhead.time),de(E,E.gzhead.time>>8&255),de(E,E.gzhead.time>>16&255),de(E,E.gzhead.time>>24&255),de(E,E.level===9?2:2<=E.strategy||E.level<2?4:0),de(E,255&E.gzhead.os),E.gzhead.extra&&E.gzhead.extra.length&&(de(E,255&E.gzhead.extra.length),de(E,E.gzhead.extra.length>>8&255)),E.gzhead.hcrc&&(d.adler=l(d.adler,E.pending_buf,E.pending,0)),E.gzindex=0,E.status=69):(de(E,0),de(E,0),de(E,0),de(E,0),de(E,0),de(E,E.level===9?2:2<=E.strategy||E.level<2?4:0),de(E,3),E.status=$);else{var j=C+(E.w_bits-8<<4)<<8;j|=(2<=E.strategy||E.level<2?0:E.level<6?1:E.level===6?2:3)<<6,E.strstart!==0&&(j|=32),j+=31-j%31,E.status=$,ne(E,j),E.strstart!==0&&(ne(E,d.adler>>>16),ne(E,65535&d.adler)),d.adler=1}if(E.status===69)if(E.gzhead.extra){for(w=E.pending;E.gzindex<(65535&E.gzhead.extra.length)&&(E.pending!==E.pending_buf_size||(E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),R(d),w=E.pending,E.pending!==E.pending_buf_size));)de(E,255&E.gzhead.extra[E.gzindex]),E.gzindex++;E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),E.gzindex===E.gzhead.extra.length&&(E.gzindex=0,E.status=73)}else E.status=73;if(E.status===73)if(E.gzhead.name){w=E.pending;do{if(E.pending===E.pending_buf_size&&(E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),R(d),w=E.pending,E.pending===E.pending_buf_size)){T=1;break}T=E.gzindex<E.gzhead.name.length?255&E.gzhead.name.charCodeAt(E.gzindex++):0,de(E,T)}while(T!==0);E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),T===0&&(E.gzindex=0,E.status=91)}else E.status=91;if(E.status===91)if(E.gzhead.comment){w=E.pending;do{if(E.pending===E.pending_buf_size&&(E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),R(d),w=E.pending,E.pending===E.pending_buf_size)){T=1;break}T=E.gzindex<E.gzhead.comment.length?255&E.gzhead.comment.charCodeAt(E.gzindex++):0,de(E,T)}while(T!==0);E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),T===0&&(E.status=103)}else E.status=103;if(E.status===103&&(E.gzhead.hcrc?(E.pending+2>E.pending_buf_size&&R(d),E.pending+2<=E.pending_buf_size&&(de(E,255&d.adler),de(E,d.adler>>8&255),d.adler=0,E.status=$)):E.status=$),E.pending!==0){if(R(d),d.avail_out===0)return E.last_flush=-1,m}else if(d.avail_in===0&&V(F)<=V(z)&&F!==h)return me(d,-5);if(E.status===666&&d.avail_in!==0)return me(d,-5);if(d.avail_in!==0||E.lookahead!==0||F!==p&&E.status!==666){var G=E.strategy===2?function(N,J){for(var te;;){if(N.lookahead===0&&(De(N),N.lookahead===0)){if(J===p)return g;break}if(N.match_length=0,te=a._tr_tally(N,0,N.window[N.strstart]),N.lookahead--,N.strstart++,te&&(O(N,!1),N.strm.avail_out===0))return g}return N.insert=0,J===h?(O(N,!0),N.strm.avail_out===0?ue:Z):N.last_lit&&(O(N,!1),N.strm.avail_out===0)?g:H}(E,F):E.strategy===3?function(N,J){for(var te,X,le,xe,ye=N.window;;){if(N.lookahead<=U){if(De(N),N.lookahead<=U&&J===p)return g;if(N.lookahead===0)break}if(N.match_length=0,N.lookahead>=M&&0<N.strstart&&(X=ye[le=N.strstart-1])===ye[++le]&&X===ye[++le]&&X===ye[++le]){xe=N.strstart+U;do;while(X===ye[++le]&&X===ye[++le]&&X===ye[++le]&&X===ye[++le]&&X===ye[++le]&&X===ye[++le]&&X===ye[++le]&&X===ye[++le]&&le<xe);N.match_length=U-(xe-le),N.match_length>N.lookahead&&(N.match_length=N.lookahead)}if(N.match_length>=M?(te=a._tr_tally(N,1,N.match_length-M),N.lookahead-=N.match_length,N.strstart+=N.match_length,N.match_length=0):(te=a._tr_tally(N,0,N.window[N.strstart]),N.lookahead--,N.strstart++),te&&(O(N,!1),N.strm.avail_out===0))return g}return N.insert=0,J===h?(O(N,!0),N.strm.avail_out===0?ue:Z):N.last_lit&&(O(N,!1),N.strm.avail_out===0)?g:H}(E,F):n[E.level].func(E,F);if(G!==ue&&G!==Z||(E.status=666),G===g||G===ue)return d.avail_out===0&&(E.last_flush=-1),m;if(G===H&&(F===1?a._tr_align(E):F!==5&&(a._tr_stored_block(E,0,0,!1),F===3&&(fe(E.head),E.lookahead===0&&(E.strstart=0,E.block_start=0,E.insert=0))),R(d),d.avail_out===0))return E.last_flush=-1,m}return F!==h?m:E.wrap<=0?1:(E.wrap===2?(de(E,255&d.adler),de(E,d.adler>>8&255),de(E,d.adler>>16&255),de(E,d.adler>>24&255),de(E,255&d.total_in),de(E,d.total_in>>8&255),de(E,d.total_in>>16&255),de(E,d.total_in>>24&255)):(ne(E,d.adler>>>16),ne(E,65535&d.adler)),R(d),0<E.wrap&&(E.wrap=-E.wrap),E.pending!==0?m:1)},i.deflateEnd=function(d){var F;return d&&d.state?(F=d.state.status)!==I&&F!==69&&F!==73&&F!==91&&F!==103&&F!==$&&F!==666?me(d,y):(d.state=null,F===$?me(d,-3):m):y},i.deflateSetDictionary=function(d,F){var z,E,w,T,j,G,N,J,te=F.length;if(!d||!d.state||(T=(z=d.state).wrap)===2||T===1&&z.status!==I||z.lookahead)return y;for(T===1&&(d.adler=r(d.adler,F,te,0)),z.wrap=0,te>=z.w_size&&(T===0&&(fe(z.head),z.strstart=0,z.block_start=0,z.insert=0),J=new o.Buf8(z.w_size),o.arraySet(J,F,te-z.w_size,z.w_size,0),F=J,te=z.w_size),j=d.avail_in,G=d.next_in,N=d.input,d.avail_in=te,d.next_in=0,d.input=F,De(z);z.lookahead>=M;){for(E=z.strstart,w=z.lookahead-(M-1);z.ins_h=(z.ins_h<<z.hash_shift^z.window[E+M-1])&z.hash_mask,z.prev[E&z.w_mask]=z.head[z.ins_h],z.head[z.ins_h]=E,E++,--w;);z.strstart=E,z.lookahead=M-1,De(z)}return z.strstart+=z.lookahead,z.block_start=z.strstart,z.insert=z.lookahead,z.lookahead=0,z.match_length=z.prev_length=M-1,z.match_available=0,d.next_in=G,d.input=N,d.avail_in=j,z.wrap=T,m},i.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(t,c,i){c.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(t,c,i){c.exports=function(n,o){var a,r,l,f,p,h,m,y,u,v,b,C,S,_,k,x,L,D,M,U,Q,I,$,g,H;a=n.state,r=n.next_in,g=n.input,l=r+(n.avail_in-5),f=n.next_out,H=n.output,p=f-(o-n.avail_out),h=f+(n.avail_out-257),m=a.dmax,y=a.wsize,u=a.whave,v=a.wnext,b=a.window,C=a.hold,S=a.bits,_=a.lencode,k=a.distcode,x=(1<<a.lenbits)-1,L=(1<<a.distbits)-1;e:do{S<15&&(C+=g[r++]<<S,S+=8,C+=g[r++]<<S,S+=8),D=_[C&x];t:for(;;){if(C>>>=M=D>>>24,S-=M,(M=D>>>16&255)===0)H[f++]=65535&D;else{if(!(16&M)){if(!(64&M)){D=_[(65535&D)+(C&(1<<M)-1)];continue t}if(32&M){a.mode=12;break e}n.msg="invalid literal/length code",a.mode=30;break e}U=65535&D,(M&=15)&&(S<M&&(C+=g[r++]<<S,S+=8),U+=C&(1<<M)-1,C>>>=M,S-=M),S<15&&(C+=g[r++]<<S,S+=8,C+=g[r++]<<S,S+=8),D=k[C&L];n:for(;;){if(C>>>=M=D>>>24,S-=M,!(16&(M=D>>>16&255))){if(!(64&M)){D=k[(65535&D)+(C&(1<<M)-1)];continue n}n.msg="invalid distance code",a.mode=30;break e}if(Q=65535&D,S<(M&=15)&&(C+=g[r++]<<S,(S+=8)<M&&(C+=g[r++]<<S,S+=8)),m<(Q+=C&(1<<M)-1)){n.msg="invalid distance too far back",a.mode=30;break e}if(C>>>=M,S-=M,(M=f-p)<Q){if(u<(M=Q-M)&&a.sane){n.msg="invalid distance too far back",a.mode=30;break e}if($=b,(I=0)===v){if(I+=y-M,M<U){for(U-=M;H[f++]=b[I++],--M;);I=f-Q,$=H}}else if(v<M){if(I+=y+v-M,(M-=v)<U){for(U-=M;H[f++]=b[I++],--M;);if(I=0,v<U){for(U-=M=v;H[f++]=b[I++],--M;);I=f-Q,$=H}}}else if(I+=v-M,M<U){for(U-=M;H[f++]=b[I++],--M;);I=f-Q,$=H}for(;2<U;)H[f++]=$[I++],H[f++]=$[I++],H[f++]=$[I++],U-=3;U&&(H[f++]=$[I++],1<U&&(H[f++]=$[I++]))}else{for(I=f-Q;H[f++]=H[I++],H[f++]=H[I++],H[f++]=H[I++],2<(U-=3););U&&(H[f++]=H[I++],1<U&&(H[f++]=H[I++]))}break}}break}}while(r<l&&f<h);r-=U=S>>3,C&=(1<<(S-=U<<3))-1,n.next_in=r,n.next_out=f,n.avail_in=r<l?l-r+5:5-(r-l),n.avail_out=f<h?h-f+257:257-(f-h),a.hold=C,a.bits=S}},{}],49:[function(t,c,i){var n=t("../utils/common"),o=t("./adler32"),a=t("./crc32"),r=t("./inffast"),l=t("./inftrees"),f=1,p=2,h=0,m=-2,y=1,u=852,v=592;function b(I){return(I>>>24&255)+(I>>>8&65280)+((65280&I)<<8)+((255&I)<<24)}function C(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new n.Buf16(320),this.work=new n.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function S(I){var $;return I&&I.state?($=I.state,I.total_in=I.total_out=$.total=0,I.msg="",$.wrap&&(I.adler=1&$.wrap),$.mode=y,$.last=0,$.havedict=0,$.dmax=32768,$.head=null,$.hold=0,$.bits=0,$.lencode=$.lendyn=new n.Buf32(u),$.distcode=$.distdyn=new n.Buf32(v),$.sane=1,$.back=-1,h):m}function _(I){var $;return I&&I.state?(($=I.state).wsize=0,$.whave=0,$.wnext=0,S(I)):m}function k(I,$){var g,H;return I&&I.state?(H=I.state,$<0?(g=0,$=-$):(g=1+($>>4),$<48&&($&=15)),$&&($<8||15<$)?m:(H.window!==null&&H.wbits!==$&&(H.window=null),H.wrap=g,H.wbits=$,_(I))):m}function x(I,$){var g,H;return I?(H=new C,(I.state=H).window=null,(g=k(I,$))!==h&&(I.state=null),g):m}var L,D,M=!0;function U(I){if(M){var $;for(L=new n.Buf32(512),D=new n.Buf32(32),$=0;$<144;)I.lens[$++]=8;for(;$<256;)I.lens[$++]=9;for(;$<280;)I.lens[$++]=7;for(;$<288;)I.lens[$++]=8;for(l(f,I.lens,0,288,L,0,I.work,{bits:9}),$=0;$<32;)I.lens[$++]=5;l(p,I.lens,0,32,D,0,I.work,{bits:5}),M=!1}I.lencode=L,I.lenbits=9,I.distcode=D,I.distbits=5}function Q(I,$,g,H){var ue,Z=I.state;return Z.window===null&&(Z.wsize=1<<Z.wbits,Z.wnext=0,Z.whave=0,Z.window=new n.Buf8(Z.wsize)),H>=Z.wsize?(n.arraySet(Z.window,$,g-Z.wsize,Z.wsize,0),Z.wnext=0,Z.whave=Z.wsize):(H<(ue=Z.wsize-Z.wnext)&&(ue=H),n.arraySet(Z.window,$,g-H,ue,Z.wnext),(H-=ue)?(n.arraySet(Z.window,$,g-H,H,0),Z.wnext=H,Z.whave=Z.wsize):(Z.wnext+=ue,Z.wnext===Z.wsize&&(Z.wnext=0),Z.whave<Z.wsize&&(Z.whave+=ue))),0}i.inflateReset=_,i.inflateReset2=k,i.inflateResetKeep=S,i.inflateInit=function(I){return x(I,15)},i.inflateInit2=x,i.inflate=function(I,$){var g,H,ue,Z,me,V,fe,R,O,de,ne,ee,De,Pe,pe,Se,Me,Ne,it,Ge,d,F,z,E,w=0,T=new n.Buf8(4),j=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!I||!I.state||!I.output||!I.input&&I.avail_in!==0)return m;(g=I.state).mode===12&&(g.mode=13),me=I.next_out,ue=I.output,fe=I.avail_out,Z=I.next_in,H=I.input,V=I.avail_in,R=g.hold,O=g.bits,de=V,ne=fe,F=h;e:for(;;)switch(g.mode){case y:if(g.wrap===0){g.mode=13;break}for(;O<16;){if(V===0)break e;V--,R+=H[Z++]<<O,O+=8}if(2&g.wrap&&R===35615){T[g.check=0]=255&R,T[1]=R>>>8&255,g.check=a(g.check,T,2,0),O=R=0,g.mode=2;break}if(g.flags=0,g.head&&(g.head.done=!1),!(1&g.wrap)||(((255&R)<<8)+(R>>8))%31){I.msg="incorrect header check",g.mode=30;break}if((15&R)!=8){I.msg="unknown compression method",g.mode=30;break}if(O-=4,d=8+(15&(R>>>=4)),g.wbits===0)g.wbits=d;else if(d>g.wbits){I.msg="invalid window size",g.mode=30;break}g.dmax=1<<d,I.adler=g.check=1,g.mode=512&R?10:12,O=R=0;break;case 2:for(;O<16;){if(V===0)break e;V--,R+=H[Z++]<<O,O+=8}if(g.flags=R,(255&g.flags)!=8){I.msg="unknown compression method",g.mode=30;break}if(57344&g.flags){I.msg="unknown header flags set",g.mode=30;break}g.head&&(g.head.text=R>>8&1),512&g.flags&&(T[0]=255&R,T[1]=R>>>8&255,g.check=a(g.check,T,2,0)),O=R=0,g.mode=3;case 3:for(;O<32;){if(V===0)break e;V--,R+=H[Z++]<<O,O+=8}g.head&&(g.head.time=R),512&g.flags&&(T[0]=255&R,T[1]=R>>>8&255,T[2]=R>>>16&255,T[3]=R>>>24&255,g.check=a(g.check,T,4,0)),O=R=0,g.mode=4;case 4:for(;O<16;){if(V===0)break e;V--,R+=H[Z++]<<O,O+=8}g.head&&(g.head.xflags=255&R,g.head.os=R>>8),512&g.flags&&(T[0]=255&R,T[1]=R>>>8&255,g.check=a(g.check,T,2,0)),O=R=0,g.mode=5;case 5:if(1024&g.flags){for(;O<16;){if(V===0)break e;V--,R+=H[Z++]<<O,O+=8}g.length=R,g.head&&(g.head.extra_len=R),512&g.flags&&(T[0]=255&R,T[1]=R>>>8&255,g.check=a(g.check,T,2,0)),O=R=0}else g.head&&(g.head.extra=null);g.mode=6;case 6:if(1024&g.flags&&(V<(ee=g.length)&&(ee=V),ee&&(g.head&&(d=g.head.extra_len-g.length,g.head.extra||(g.head.extra=new Array(g.head.extra_len)),n.arraySet(g.head.extra,H,Z,ee,d)),512&g.flags&&(g.check=a(g.check,H,ee,Z)),V-=ee,Z+=ee,g.length-=ee),g.length))break e;g.length=0,g.mode=7;case 7:if(2048&g.flags){if(V===0)break e;for(ee=0;d=H[Z+ee++],g.head&&d&&g.length<65536&&(g.head.name+=String.fromCharCode(d)),d&&ee<V;);if(512&g.flags&&(g.check=a(g.check,H,ee,Z)),V-=ee,Z+=ee,d)break e}else g.head&&(g.head.name=null);g.length=0,g.mode=8;case 8:if(4096&g.flags){if(V===0)break e;for(ee=0;d=H[Z+ee++],g.head&&d&&g.length<65536&&(g.head.comment+=String.fromCharCode(d)),d&&ee<V;);if(512&g.flags&&(g.check=a(g.check,H,ee,Z)),V-=ee,Z+=ee,d)break e}else g.head&&(g.head.comment=null);g.mode=9;case 9:if(512&g.flags){for(;O<16;){if(V===0)break e;V--,R+=H[Z++]<<O,O+=8}if(R!==(65535&g.check)){I.msg="header crc mismatch",g.mode=30;break}O=R=0}g.head&&(g.head.hcrc=g.flags>>9&1,g.head.done=!0),I.adler=g.check=0,g.mode=12;break;case 10:for(;O<32;){if(V===0)break e;V--,R+=H[Z++]<<O,O+=8}I.adler=g.check=b(R),O=R=0,g.mode=11;case 11:if(g.havedict===0)return I.next_out=me,I.avail_out=fe,I.next_in=Z,I.avail_in=V,g.hold=R,g.bits=O,2;I.adler=g.check=1,g.mode=12;case 12:if($===5||$===6)break e;case 13:if(g.last){R>>>=7&O,O-=7&O,g.mode=27;break}for(;O<3;){if(V===0)break e;V--,R+=H[Z++]<<O,O+=8}switch(g.last=1&R,O-=1,3&(R>>>=1)){case 0:g.mode=14;break;case 1:if(U(g),g.mode=20,$!==6)break;R>>>=2,O-=2;break e;case 2:g.mode=17;break;case 3:I.msg="invalid block type",g.mode=30}R>>>=2,O-=2;break;case 14:for(R>>>=7&O,O-=7&O;O<32;){if(V===0)break e;V--,R+=H[Z++]<<O,O+=8}if((65535&R)!=(R>>>16^65535)){I.msg="invalid stored block lengths",g.mode=30;break}if(g.length=65535&R,O=R=0,g.mode=15,$===6)break e;case 15:g.mode=16;case 16:if(ee=g.length){if(V<ee&&(ee=V),fe<ee&&(ee=fe),ee===0)break e;n.arraySet(ue,H,Z,ee,me),V-=ee,Z+=ee,fe-=ee,me+=ee,g.length-=ee;break}g.mode=12;break;case 17:for(;O<14;){if(V===0)break e;V--,R+=H[Z++]<<O,O+=8}if(g.nlen=257+(31&R),R>>>=5,O-=5,g.ndist=1+(31&R),R>>>=5,O-=5,g.ncode=4+(15&R),R>>>=4,O-=4,286<g.nlen||30<g.ndist){I.msg="too many length or distance symbols",g.mode=30;break}g.have=0,g.mode=18;case 18:for(;g.have<g.ncode;){for(;O<3;){if(V===0)break e;V--,R+=H[Z++]<<O,O+=8}g.lens[j[g.have++]]=7&R,R>>>=3,O-=3}for(;g.have<19;)g.lens[j[g.have++]]=0;if(g.lencode=g.lendyn,g.lenbits=7,z={bits:g.lenbits},F=l(0,g.lens,0,19,g.lencode,0,g.work,z),g.lenbits=z.bits,F){I.msg="invalid code lengths set",g.mode=30;break}g.have=0,g.mode=19;case 19:for(;g.have<g.nlen+g.ndist;){for(;Se=(w=g.lencode[R&(1<<g.lenbits)-1])>>>16&255,Me=65535&w,!((pe=w>>>24)<=O);){if(V===0)break e;V--,R+=H[Z++]<<O,O+=8}if(Me<16)R>>>=pe,O-=pe,g.lens[g.have++]=Me;else{if(Me===16){for(E=pe+2;O<E;){if(V===0)break e;V--,R+=H[Z++]<<O,O+=8}if(R>>>=pe,O-=pe,g.have===0){I.msg="invalid bit length repeat",g.mode=30;break}d=g.lens[g.have-1],ee=3+(3&R),R>>>=2,O-=2}else if(Me===17){for(E=pe+3;O<E;){if(V===0)break e;V--,R+=H[Z++]<<O,O+=8}O-=pe,d=0,ee=3+(7&(R>>>=pe)),R>>>=3,O-=3}else{for(E=pe+7;O<E;){if(V===0)break e;V--,R+=H[Z++]<<O,O+=8}O-=pe,d=0,ee=11+(127&(R>>>=pe)),R>>>=7,O-=7}if(g.have+ee>g.nlen+g.ndist){I.msg="invalid bit length repeat",g.mode=30;break}for(;ee--;)g.lens[g.have++]=d}}if(g.mode===30)break;if(g.lens[256]===0){I.msg="invalid code -- missing end-of-block",g.mode=30;break}if(g.lenbits=9,z={bits:g.lenbits},F=l(f,g.lens,0,g.nlen,g.lencode,0,g.work,z),g.lenbits=z.bits,F){I.msg="invalid literal/lengths set",g.mode=30;break}if(g.distbits=6,g.distcode=g.distdyn,z={bits:g.distbits},F=l(p,g.lens,g.nlen,g.ndist,g.distcode,0,g.work,z),g.distbits=z.bits,F){I.msg="invalid distances set",g.mode=30;break}if(g.mode=20,$===6)break e;case 20:g.mode=21;case 21:if(6<=V&&258<=fe){I.next_out=me,I.avail_out=fe,I.next_in=Z,I.avail_in=V,g.hold=R,g.bits=O,r(I,ne),me=I.next_out,ue=I.output,fe=I.avail_out,Z=I.next_in,H=I.input,V=I.avail_in,R=g.hold,O=g.bits,g.mode===12&&(g.back=-1);break}for(g.back=0;Se=(w=g.lencode[R&(1<<g.lenbits)-1])>>>16&255,Me=65535&w,!((pe=w>>>24)<=O);){if(V===0)break e;V--,R+=H[Z++]<<O,O+=8}if(Se&&!(240&Se)){for(Ne=pe,it=Se,Ge=Me;Se=(w=g.lencode[Ge+((R&(1<<Ne+it)-1)>>Ne)])>>>16&255,Me=65535&w,!(Ne+(pe=w>>>24)<=O);){if(V===0)break e;V--,R+=H[Z++]<<O,O+=8}R>>>=Ne,O-=Ne,g.back+=Ne}if(R>>>=pe,O-=pe,g.back+=pe,g.length=Me,Se===0){g.mode=26;break}if(32&Se){g.back=-1,g.mode=12;break}if(64&Se){I.msg="invalid literal/length code",g.mode=30;break}g.extra=15&Se,g.mode=22;case 22:if(g.extra){for(E=g.extra;O<E;){if(V===0)break e;V--,R+=H[Z++]<<O,O+=8}g.length+=R&(1<<g.extra)-1,R>>>=g.extra,O-=g.extra,g.back+=g.extra}g.was=g.length,g.mode=23;case 23:for(;Se=(w=g.distcode[R&(1<<g.distbits)-1])>>>16&255,Me=65535&w,!((pe=w>>>24)<=O);){if(V===0)break e;V--,R+=H[Z++]<<O,O+=8}if(!(240&Se)){for(Ne=pe,it=Se,Ge=Me;Se=(w=g.distcode[Ge+((R&(1<<Ne+it)-1)>>Ne)])>>>16&255,Me=65535&w,!(Ne+(pe=w>>>24)<=O);){if(V===0)break e;V--,R+=H[Z++]<<O,O+=8}R>>>=Ne,O-=Ne,g.back+=Ne}if(R>>>=pe,O-=pe,g.back+=pe,64&Se){I.msg="invalid distance code",g.mode=30;break}g.offset=Me,g.extra=15&Se,g.mode=24;case 24:if(g.extra){for(E=g.extra;O<E;){if(V===0)break e;V--,R+=H[Z++]<<O,O+=8}g.offset+=R&(1<<g.extra)-1,R>>>=g.extra,O-=g.extra,g.back+=g.extra}if(g.offset>g.dmax){I.msg="invalid distance too far back",g.mode=30;break}g.mode=25;case 25:if(fe===0)break e;if(ee=ne-fe,g.offset>ee){if((ee=g.offset-ee)>g.whave&&g.sane){I.msg="invalid distance too far back",g.mode=30;break}De=ee>g.wnext?(ee-=g.wnext,g.wsize-ee):g.wnext-ee,ee>g.length&&(ee=g.length),Pe=g.window}else Pe=ue,De=me-g.offset,ee=g.length;for(fe<ee&&(ee=fe),fe-=ee,g.length-=ee;ue[me++]=Pe[De++],--ee;);g.length===0&&(g.mode=21);break;case 26:if(fe===0)break e;ue[me++]=g.length,fe--,g.mode=21;break;case 27:if(g.wrap){for(;O<32;){if(V===0)break e;V--,R|=H[Z++]<<O,O+=8}if(ne-=fe,I.total_out+=ne,g.total+=ne,ne&&(I.adler=g.check=g.flags?a(g.check,ue,ne,me-ne):o(g.check,ue,ne,me-ne)),ne=fe,(g.flags?R:b(R))!==g.check){I.msg="incorrect data check",g.mode=30;break}O=R=0}g.mode=28;case 28:if(g.wrap&&g.flags){for(;O<32;){if(V===0)break e;V--,R+=H[Z++]<<O,O+=8}if(R!==(4294967295&g.total)){I.msg="incorrect length check",g.mode=30;break}O=R=0}g.mode=29;case 29:F=1;break e;case 30:F=-3;break e;case 31:return-4;case 32:default:return m}return I.next_out=me,I.avail_out=fe,I.next_in=Z,I.avail_in=V,g.hold=R,g.bits=O,(g.wsize||ne!==I.avail_out&&g.mode<30&&(g.mode<27||$!==4))&&Q(I,I.output,I.next_out,ne-I.avail_out)?(g.mode=31,-4):(de-=I.avail_in,ne-=I.avail_out,I.total_in+=de,I.total_out+=ne,g.total+=ne,g.wrap&&ne&&(I.adler=g.check=g.flags?a(g.check,ue,ne,I.next_out-ne):o(g.check,ue,ne,I.next_out-ne)),I.data_type=g.bits+(g.last?64:0)+(g.mode===12?128:0)+(g.mode===20||g.mode===15?256:0),(de==0&&ne===0||$===4)&&F===h&&(F=-5),F)},i.inflateEnd=function(I){if(!I||!I.state)return m;var $=I.state;return $.window&&($.window=null),I.state=null,h},i.inflateGetHeader=function(I,$){var g;return I&&I.state&&2&(g=I.state).wrap?((g.head=$).done=!1,h):m},i.inflateSetDictionary=function(I,$){var g,H=$.length;return I&&I.state?(g=I.state).wrap!==0&&g.mode!==11?m:g.mode===11&&o(1,$,H,0)!==g.check?-3:Q(I,$,H,H)?(g.mode=31,-4):(g.havedict=1,h):m},i.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(t,c,i){var n=t("../utils/common"),o=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],a=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],r=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],l=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];c.exports=function(f,p,h,m,y,u,v,b){var C,S,_,k,x,L,D,M,U,Q=b.bits,I=0,$=0,g=0,H=0,ue=0,Z=0,me=0,V=0,fe=0,R=0,O=null,de=0,ne=new n.Buf16(16),ee=new n.Buf16(16),De=null,Pe=0;for(I=0;I<=15;I++)ne[I]=0;for($=0;$<m;$++)ne[p[h+$]]++;for(ue=Q,H=15;1<=H&&ne[H]===0;H--);if(H<ue&&(ue=H),H===0)return y[u++]=20971520,y[u++]=20971520,b.bits=1,0;for(g=1;g<H&&ne[g]===0;g++);for(ue<g&&(ue=g),I=V=1;I<=15;I++)if(V<<=1,(V-=ne[I])<0)return-1;if(0<V&&(f===0||H!==1))return-1;for(ee[1]=0,I=1;I<15;I++)ee[I+1]=ee[I]+ne[I];for($=0;$<m;$++)p[h+$]!==0&&(v[ee[p[h+$]]++]=$);if(L=f===0?(O=De=v,19):f===1?(O=o,de-=257,De=a,Pe-=257,256):(O=r,De=l,-1),I=g,x=u,me=$=R=0,_=-1,k=(fe=1<<(Z=ue))-1,f===1&&852<fe||f===2&&592<fe)return 1;for(;;){for(D=I-me,U=v[$]<L?(M=0,v[$]):v[$]>L?(M=De[Pe+v[$]],O[de+v[$]]):(M=96,0),C=1<<I-me,g=S=1<<Z;y[x+(R>>me)+(S-=C)]=D<<24|M<<16|U|0,S!==0;);for(C=1<<I-1;R&C;)C>>=1;if(C!==0?(R&=C-1,R+=C):R=0,$++,--ne[I]==0){if(I===H)break;I=p[h+v[$]]}if(ue<I&&(R&k)!==_){for(me===0&&(me=ue),x+=g,V=1<<(Z=I-me);Z+me<H&&!((V-=ne[Z+me])<=0);)Z++,V<<=1;if(fe+=1<<Z,f===1&&852<fe||f===2&&592<fe)return 1;y[_=R&k]=ue<<24|Z<<16|x-u|0}}return R!==0&&(y[x+R]=I-me<<24|64<<16|0),b.bits=ue,0}},{"../utils/common":41}],51:[function(t,c,i){c.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(t,c,i){var n=t("../utils/common"),o=0,a=1;function r(w){for(var T=w.length;0<=--T;)w[T]=0}var l=0,f=29,p=256,h=p+1+f,m=30,y=19,u=2*h+1,v=15,b=16,C=7,S=256,_=16,k=17,x=18,L=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],D=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],M=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],U=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Q=new Array(2*(h+2));r(Q);var I=new Array(2*m);r(I);var $=new Array(512);r($);var g=new Array(256);r(g);var H=new Array(f);r(H);var ue,Z,me,V=new Array(m);function fe(w,T,j,G,N){this.static_tree=w,this.extra_bits=T,this.extra_base=j,this.elems=G,this.max_length=N,this.has_stree=w&&w.length}function R(w,T){this.dyn_tree=w,this.max_code=0,this.stat_desc=T}function O(w){return w<256?$[w]:$[256+(w>>>7)]}function de(w,T){w.pending_buf[w.pending++]=255&T,w.pending_buf[w.pending++]=T>>>8&255}function ne(w,T,j){w.bi_valid>b-j?(w.bi_buf|=T<<w.bi_valid&65535,de(w,w.bi_buf),w.bi_buf=T>>b-w.bi_valid,w.bi_valid+=j-b):(w.bi_buf|=T<<w.bi_valid&65535,w.bi_valid+=j)}function ee(w,T,j){ne(w,j[2*T],j[2*T+1])}function De(w,T){for(var j=0;j|=1&w,w>>>=1,j<<=1,0<--T;);return j>>>1}function Pe(w,T,j){var G,N,J=new Array(v+1),te=0;for(G=1;G<=v;G++)J[G]=te=te+j[G-1]<<1;for(N=0;N<=T;N++){var X=w[2*N+1];X!==0&&(w[2*N]=De(J[X]++,X))}}function pe(w){var T;for(T=0;T<h;T++)w.dyn_ltree[2*T]=0;for(T=0;T<m;T++)w.dyn_dtree[2*T]=0;for(T=0;T<y;T++)w.bl_tree[2*T]=0;w.dyn_ltree[2*S]=1,w.opt_len=w.static_len=0,w.last_lit=w.matches=0}function Se(w){8<w.bi_valid?de(w,w.bi_buf):0<w.bi_valid&&(w.pending_buf[w.pending++]=w.bi_buf),w.bi_buf=0,w.bi_valid=0}function Me(w,T,j,G){var N=2*T,J=2*j;return w[N]<w[J]||w[N]===w[J]&&G[T]<=G[j]}function Ne(w,T,j){for(var G=w.heap[j],N=j<<1;N<=w.heap_len&&(N<w.heap_len&&Me(T,w.heap[N+1],w.heap[N],w.depth)&&N++,!Me(T,G,w.heap[N],w.depth));)w.heap[j]=w.heap[N],j=N,N<<=1;w.heap[j]=G}function it(w,T,j){var G,N,J,te,X=0;if(w.last_lit!==0)for(;G=w.pending_buf[w.d_buf+2*X]<<8|w.pending_buf[w.d_buf+2*X+1],N=w.pending_buf[w.l_buf+X],X++,G===0?ee(w,N,T):(ee(w,(J=g[N])+p+1,T),(te=L[J])!==0&&ne(w,N-=H[J],te),ee(w,J=O(--G),j),(te=D[J])!==0&&ne(w,G-=V[J],te)),X<w.last_lit;);ee(w,S,T)}function Ge(w,T){var j,G,N,J=T.dyn_tree,te=T.stat_desc.static_tree,X=T.stat_desc.has_stree,le=T.stat_desc.elems,xe=-1;for(w.heap_len=0,w.heap_max=u,j=0;j<le;j++)J[2*j]!==0?(w.heap[++w.heap_len]=xe=j,w.depth[j]=0):J[2*j+1]=0;for(;w.heap_len<2;)J[2*(N=w.heap[++w.heap_len]=xe<2?++xe:0)]=1,w.depth[N]=0,w.opt_len--,X&&(w.static_len-=te[2*N+1]);for(T.max_code=xe,j=w.heap_len>>1;1<=j;j--)Ne(w,J,j);for(N=le;j=w.heap[1],w.heap[1]=w.heap[w.heap_len--],Ne(w,J,1),G=w.heap[1],w.heap[--w.heap_max]=j,w.heap[--w.heap_max]=G,J[2*N]=J[2*j]+J[2*G],w.depth[N]=(w.depth[j]>=w.depth[G]?w.depth[j]:w.depth[G])+1,J[2*j+1]=J[2*G+1]=N,w.heap[1]=N++,Ne(w,J,1),2<=w.heap_len;);w.heap[--w.heap_max]=w.heap[1],function(ye,qe){var vt,ot,bt,ve,It,kn,et=qe.dyn_tree,Xt=qe.max_code,ys=qe.stat_desc.static_tree,vs=qe.stat_desc.has_stree,bs=qe.stat_desc.extra_bits,In=qe.stat_desc.extra_base,xt=qe.stat_desc.max_length,zt=0;for(ve=0;ve<=v;ve++)ye.bl_count[ve]=0;for(et[2*ye.heap[ye.heap_max]+1]=0,vt=ye.heap_max+1;vt<u;vt++)xt<(ve=et[2*et[2*(ot=ye.heap[vt])+1]+1]+1)&&(ve=xt,zt++),et[2*ot+1]=ve,Xt<ot||(ye.bl_count[ve]++,It=0,In<=ot&&(It=bs[ot-In]),kn=et[2*ot],ye.opt_len+=kn*(ve+It),vs&&(ye.static_len+=kn*(ys[2*ot+1]+It)));if(zt!==0){do{for(ve=xt-1;ye.bl_count[ve]===0;)ve--;ye.bl_count[ve]--,ye.bl_count[ve+1]+=2,ye.bl_count[xt]--,zt-=2}while(0<zt);for(ve=xt;ve!==0;ve--)for(ot=ye.bl_count[ve];ot!==0;)Xt<(bt=ye.heap[--vt])||(et[2*bt+1]!==ve&&(ye.opt_len+=(ve-et[2*bt+1])*et[2*bt],et[2*bt+1]=ve),ot--)}}(w,T),Pe(J,xe,w.bl_count)}function d(w,T,j){var G,N,J=-1,te=T[1],X=0,le=7,xe=4;for(te===0&&(le=138,xe=3),T[2*(j+1)+1]=65535,G=0;G<=j;G++)N=te,te=T[2*(G+1)+1],++X<le&&N===te||(X<xe?w.bl_tree[2*N]+=X:N!==0?(N!==J&&w.bl_tree[2*N]++,w.bl_tree[2*_]++):X<=10?w.bl_tree[2*k]++:w.bl_tree[2*x]++,J=N,xe=(X=0)===te?(le=138,3):N===te?(le=6,3):(le=7,4))}function F(w,T,j){var G,N,J=-1,te=T[1],X=0,le=7,xe=4;for(te===0&&(le=138,xe=3),G=0;G<=j;G++)if(N=te,te=T[2*(G+1)+1],!(++X<le&&N===te)){if(X<xe)for(;ee(w,N,w.bl_tree),--X!=0;);else N!==0?(N!==J&&(ee(w,N,w.bl_tree),X--),ee(w,_,w.bl_tree),ne(w,X-3,2)):X<=10?(ee(w,k,w.bl_tree),ne(w,X-3,3)):(ee(w,x,w.bl_tree),ne(w,X-11,7));J=N,xe=(X=0)===te?(le=138,3):N===te?(le=6,3):(le=7,4)}}r(V);var z=!1;function E(w,T,j,G){ne(w,(l<<1)+(G?1:0),3),function(N,J,te,X){Se(N),de(N,te),de(N,~te),n.arraySet(N.pending_buf,N.window,J,te,N.pending),N.pending+=te}(w,T,j)}i._tr_init=function(w){z||(function(){var T,j,G,N,J,te=new Array(v+1);for(N=G=0;N<f-1;N++)for(H[N]=G,T=0;T<1<<L[N];T++)g[G++]=N;for(g[G-1]=N,N=J=0;N<16;N++)for(V[N]=J,T=0;T<1<<D[N];T++)$[J++]=N;for(J>>=7;N<m;N++)for(V[N]=J<<7,T=0;T<1<<D[N]-7;T++)$[256+J++]=N;for(j=0;j<=v;j++)te[j]=0;for(T=0;T<=143;)Q[2*T+1]=8,T++,te[8]++;for(;T<=255;)Q[2*T+1]=9,T++,te[9]++;for(;T<=279;)Q[2*T+1]=7,T++,te[7]++;for(;T<=287;)Q[2*T+1]=8,T++,te[8]++;for(Pe(Q,h+1,te),T=0;T<m;T++)I[2*T+1]=5,I[2*T]=De(T,5);ue=new fe(Q,L,p+1,h,v),Z=new fe(I,D,0,m,v),me=new fe(new Array(0),M,0,y,C)}(),z=!0),w.l_desc=new R(w.dyn_ltree,ue),w.d_desc=new R(w.dyn_dtree,Z),w.bl_desc=new R(w.bl_tree,me),w.bi_buf=0,w.bi_valid=0,pe(w)},i._tr_stored_block=E,i._tr_flush_block=function(w,T,j,G){var N,J,te=0;0<w.level?(w.strm.data_type===2&&(w.strm.data_type=function(X){var le,xe=4093624447;for(le=0;le<=31;le++,xe>>>=1)if(1&xe&&X.dyn_ltree[2*le]!==0)return o;if(X.dyn_ltree[18]!==0||X.dyn_ltree[20]!==0||X.dyn_ltree[26]!==0)return a;for(le=32;le<p;le++)if(X.dyn_ltree[2*le]!==0)return a;return o}(w)),Ge(w,w.l_desc),Ge(w,w.d_desc),te=function(X){var le;for(d(X,X.dyn_ltree,X.l_desc.max_code),d(X,X.dyn_dtree,X.d_desc.max_code),Ge(X,X.bl_desc),le=y-1;3<=le&&X.bl_tree[2*U[le]+1]===0;le--);return X.opt_len+=3*(le+1)+5+5+4,le}(w),N=w.opt_len+3+7>>>3,(J=w.static_len+3+7>>>3)<=N&&(N=J)):N=J=j+5,j+4<=N&&T!==-1?E(w,T,j,G):w.strategy===4||J===N?(ne(w,2+(G?1:0),3),it(w,Q,I)):(ne(w,4+(G?1:0),3),function(X,le,xe,ye){var qe;for(ne(X,le-257,5),ne(X,xe-1,5),ne(X,ye-4,4),qe=0;qe<ye;qe++)ne(X,X.bl_tree[2*U[qe]+1],3);F(X,X.dyn_ltree,le-1),F(X,X.dyn_dtree,xe-1)}(w,w.l_desc.max_code+1,w.d_desc.max_code+1,te+1),it(w,w.dyn_ltree,w.dyn_dtree)),pe(w),G&&Se(w)},i._tr_tally=function(w,T,j){return w.pending_buf[w.d_buf+2*w.last_lit]=T>>>8&255,w.pending_buf[w.d_buf+2*w.last_lit+1]=255&T,w.pending_buf[w.l_buf+w.last_lit]=255&j,w.last_lit++,T===0?w.dyn_ltree[2*j]++:(w.matches++,T--,w.dyn_ltree[2*(g[j]+p+1)]++,w.dyn_dtree[2*O(T)]++),w.last_lit===w.lit_bufsize-1},i._tr_align=function(w){ne(w,2,3),ee(w,S,Q),function(T){T.bi_valid===16?(de(T,T.bi_buf),T.bi_buf=0,T.bi_valid=0):8<=T.bi_valid&&(T.pending_buf[T.pending++]=255&T.bi_buf,T.bi_buf>>=8,T.bi_valid-=8)}(w)}},{"../utils/common":41}],53:[function(t,c,i){c.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(t,c,i){(function(n){(function(o,a){if(!o.setImmediate){var r,l,f,p,h=1,m={},y=!1,u=o.document,v=Object.getPrototypeOf&&Object.getPrototypeOf(o);v=v&&v.setTimeout?v:o,r={}.toString.call(o.process)==="[object process]"?function(_){process.nextTick(function(){C(_)})}:function(){if(o.postMessage&&!o.importScripts){var _=!0,k=o.onmessage;return o.onmessage=function(){_=!1},o.postMessage("","*"),o.onmessage=k,_}}()?(p="setImmediate$"+Math.random()+"$",o.addEventListener?o.addEventListener("message",S,!1):o.attachEvent("onmessage",S),function(_){o.postMessage(p+_,"*")}):o.MessageChannel?((f=new MessageChannel).port1.onmessage=function(_){C(_.data)},function(_){f.port2.postMessage(_)}):u&&"onreadystatechange"in u.createElement("script")?(l=u.documentElement,function(_){var k=u.createElement("script");k.onreadystatechange=function(){C(_),k.onreadystatechange=null,l.removeChild(k),k=null},l.appendChild(k)}):function(_){setTimeout(C,0,_)},v.setImmediate=function(_){typeof _!="function"&&(_=new Function(""+_));for(var k=new Array(arguments.length-1),x=0;x<k.length;x++)k[x]=arguments[x+1];var L={callback:_,args:k};return m[h]=L,r(h),h++},v.clearImmediate=b}function b(_){delete m[_]}function C(_){if(y)setTimeout(C,0,_);else{var k=m[_];if(k){y=!0;try{(function(x){var L=x.callback,D=x.args;switch(D.length){case 0:L();break;case 1:L(D[0]);break;case 2:L(D[0],D[1]);break;case 3:L(D[0],D[1],D[2]);break;default:L.apply(a,D)}})(k)}finally{b(_),y=!1}}}}function S(_){_.source===o&&typeof _.data=="string"&&_.data.indexOf(p)===0&&C(+_.data.slice(p.length))}})(typeof self>"u"?n===void 0?this:n:self)}).call(this,typeof Tn<"u"?Tn:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(Ya);var ho=Ya.exports;const Js=Ka(ho);var Xa={exports:{}};(function(e){var s=function(){var t=String.fromCharCode,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",n={};function o(r,l){if(!n[r]){n[r]={};for(var f=0;f<r.length;f++)n[r][r.charAt(f)]=f}return n[r][l]}var a={compressToBase64:function(r){if(r==null)return"";var l=a._compress(r,6,function(f){return c.charAt(f)});switch(l.length%4){default:case 0:return l;case 1:return l+"===";case 2:return l+"==";case 3:return l+"="}},decompressFromBase64:function(r){return r==null?"":r==""?null:a._decompress(r.length,32,function(l){return o(c,r.charAt(l))})},compressToUTF16:function(r){return r==null?"":a._compress(r,15,function(l){return t(l+32)})+" "},decompressFromUTF16:function(r){return r==null?"":r==""?null:a._decompress(r.length,16384,function(l){return r.charCodeAt(l)-32})},compressToUint8Array:function(r){for(var l=a.compress(r),f=new Uint8Array(l.length*2),p=0,h=l.length;p<h;p++){var m=l.charCodeAt(p);f[p*2]=m>>>8,f[p*2+1]=m%256}return f},decompressFromUint8Array:function(r){if(r==null)return a.decompress(r);for(var l=new Array(r.length/2),f=0,p=l.length;f<p;f++)l[f]=r[f*2]*256+r[f*2+1];var h=[];return l.forEach(function(m){h.push(t(m))}),a.decompress(h.join(""))},compressToEncodedURIComponent:function(r){return r==null?"":a._compress(r,6,function(l){return i.charAt(l)})},decompressFromEncodedURIComponent:function(r){return r==null?"":r==""?null:(r=r.replace(/ /g,"+"),a._decompress(r.length,32,function(l){return o(i,r.charAt(l))}))},compress:function(r){return a._compress(r,16,function(l){return t(l)})},_compress:function(r,l,f){if(r==null)return"";var p,h,m={},y={},u="",v="",b="",C=2,S=3,_=2,k=[],x=0,L=0,D;for(D=0;D<r.length;D+=1)if(u=r.charAt(D),Object.prototype.hasOwnProperty.call(m,u)||(m[u]=S++,y[u]=!0),v=b+u,Object.prototype.hasOwnProperty.call(m,v))b=v;else{if(Object.prototype.hasOwnProperty.call(y,b)){if(b.charCodeAt(0)<256){for(p=0;p<_;p++)x=x<<1,L==l-1?(L=0,k.push(f(x)),x=0):L++;for(h=b.charCodeAt(0),p=0;p<8;p++)x=x<<1|h&1,L==l-1?(L=0,k.push(f(x)),x=0):L++,h=h>>1}else{for(h=1,p=0;p<_;p++)x=x<<1|h,L==l-1?(L=0,k.push(f(x)),x=0):L++,h=0;for(h=b.charCodeAt(0),p=0;p<16;p++)x=x<<1|h&1,L==l-1?(L=0,k.push(f(x)),x=0):L++,h=h>>1}C--,C==0&&(C=Math.pow(2,_),_++),delete y[b]}else for(h=m[b],p=0;p<_;p++)x=x<<1|h&1,L==l-1?(L=0,k.push(f(x)),x=0):L++,h=h>>1;C--,C==0&&(C=Math.pow(2,_),_++),m[v]=S++,b=String(u)}if(b!==""){if(Object.prototype.hasOwnProperty.call(y,b)){if(b.charCodeAt(0)<256){for(p=0;p<_;p++)x=x<<1,L==l-1?(L=0,k.push(f(x)),x=0):L++;for(h=b.charCodeAt(0),p=0;p<8;p++)x=x<<1|h&1,L==l-1?(L=0,k.push(f(x)),x=0):L++,h=h>>1}else{for(h=1,p=0;p<_;p++)x=x<<1|h,L==l-1?(L=0,k.push(f(x)),x=0):L++,h=0;for(h=b.charCodeAt(0),p=0;p<16;p++)x=x<<1|h&1,L==l-1?(L=0,k.push(f(x)),x=0):L++,h=h>>1}C--,C==0&&(C=Math.pow(2,_),_++),delete y[b]}else for(h=m[b],p=0;p<_;p++)x=x<<1|h&1,L==l-1?(L=0,k.push(f(x)),x=0):L++,h=h>>1;C--,C==0&&(C=Math.pow(2,_),_++)}for(h=2,p=0;p<_;p++)x=x<<1|h&1,L==l-1?(L=0,k.push(f(x)),x=0):L++,h=h>>1;for(;;)if(x=x<<1,L==l-1){k.push(f(x));break}else L++;return k.join("")},decompress:function(r){return r==null?"":r==""?null:a._decompress(r.length,32768,function(l){return r.charCodeAt(l)})},_decompress:function(r,l,f){var p=[],h=4,m=4,y=3,u="",v=[],b,C,S,_,k,x,L,D={val:f(0),position:l,index:1};for(b=0;b<3;b+=1)p[b]=b;for(S=0,k=Math.pow(2,2),x=1;x!=k;)_=D.val&D.position,D.position>>=1,D.position==0&&(D.position=l,D.val=f(D.index++)),S|=(_>0?1:0)*x,x<<=1;switch(S){case 0:for(S=0,k=Math.pow(2,8),x=1;x!=k;)_=D.val&D.position,D.position>>=1,D.position==0&&(D.position=l,D.val=f(D.index++)),S|=(_>0?1:0)*x,x<<=1;L=t(S);break;case 1:for(S=0,k=Math.pow(2,16),x=1;x!=k;)_=D.val&D.position,D.position>>=1,D.position==0&&(D.position=l,D.val=f(D.index++)),S|=(_>0?1:0)*x,x<<=1;L=t(S);break;case 2:return""}for(p[3]=L,C=L,v.push(L);;){if(D.index>r)return"";for(S=0,k=Math.pow(2,y),x=1;x!=k;)_=D.val&D.position,D.position>>=1,D.position==0&&(D.position=l,D.val=f(D.index++)),S|=(_>0?1:0)*x,x<<=1;switch(L=S){case 0:for(S=0,k=Math.pow(2,8),x=1;x!=k;)_=D.val&D.position,D.position>>=1,D.position==0&&(D.position=l,D.val=f(D.index++)),S|=(_>0?1:0)*x,x<<=1;p[m++]=t(S),L=m-1,h--;break;case 1:for(S=0,k=Math.pow(2,16),x=1;x!=k;)_=D.val&D.position,D.position>>=1,D.position==0&&(D.position=l,D.val=f(D.index++)),S|=(_>0?1:0)*x,x<<=1;p[m++]=t(S),L=m-1,h--;break;case 2:return v.join("")}if(h==0&&(h=Math.pow(2,y),y++),p[L])u=p[L];else if(L===m)u=C+C.charAt(0);else return null;v.push(u),p[m++]=C+u.charAt(0),h--,C=u,h==0&&(h=Math.pow(2,y),y++)}}};return a}();e!=null?e.exports=s:typeof angular<"u"&&angular!=null&&angular.module("LZString",[]).factory("LZString",function(){return s})})(Xa);var po=Xa.exports;const Qa=Ka(po);function go(e){return new Worker("/assets/compression.worker-B3kqe_bR.js",{name:e==null?void 0:e.name})}let se={},A=null,Ks=null,Y=null,Le=null,un=null,us=null,Ys=[],qn=null,Xs=null,Re=null,nt={},Zn=0,Qs=0,Gn=0,ea=0,ta=null,na=null,Vn=null,gt=null,Xe=-1,sa=null,Jn=null,Kn=null,Yn=null,ei=null,ti=null,ut=!1,Ue=[],tt=[],Rt=[],ze={isScreenSaverEnabled:!0,isSoundEnabled:!0,isVibrationEnabled:!0,lastRestoreTimestamp:null,lastBackupTimestamp:null},ni=new Set,Bt=!1;function si(e){Bt=e}let aa=!1;function ia(e){aa=e}let Pt=null;const oa=new go;oa.onmessage=e=>{const s=e.data;try{localStorage.setItem("teacherAssistantData_v2",s),console.log("Background save complete.")}catch(t){console.error("Background storage failed:",t)}};oa.onerror=e=>{console.error("❌ Worker Communication Error:",e.message,e)};function ie(e=!1){if(ut)return;const t=JSON.stringify({classrooms:se,trashBin:Ue,userSettings:ze});if(e){Pt&&clearTimeout(Pt);try{const c=Qa.compressToUTF16(t);localStorage.setItem("teacherAssistantData_v2",c),console.log("Immediate save complete.")}catch(c){console.error("Immediate save failed:",c)}return}Pt&&clearTimeout(Pt),Pt=setTimeout(()=>{oa.postMessage(t),Pt=null},500)}function yo(e){return new Promise((s,t)=>{const c=new FileReader;c.onerror=t,c.onload=()=>{s(c.result.split(",")[1])},c.readAsDataURL(e)})}async function ai(e=[]){const s={};if(e.length>0)e.forEach(l=>{se[l]&&(s[l]=se[l])});else for(const l in se)se[l].isDeleted||(s[l]=se[l]);const t={metadata:{version:"2.0-b64",createdAt:new Date().toISOString()},data:{classrooms:s,trashBin:Ue,userSettings:ze}},c=JSON.stringify(t),i=new Date,n=new Intl.DateTimeFormat("fa-IR-u-nu-latn",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(i).reduce((l,f)=>(l[f.type]=f.value,l),{}),a=`${n.year.slice(-2)}-${n.month}-${n.day}_${n.hour}-${n.minute}`;let r;e.length===0?r=`SP_Full_${a}.txt`:e.length===1?r=`SP_${e[0].replace(/[<>:"/\\|?*]/g,"").replace(/\s+/g,"_")}_${a}.txt`:r=`SP_Selected-${e.length}_${a}.txt`;try{const l=new Js;l.file("backup.json",c);const f=await l.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:9}}),p=await yo(f);return new File([p],r,{type:"text/plain"})}catch(l){return console.error("Error creating base64 backup file:",l),null}}function Xn(){const e=localStorage.getItem("teacherAssistantData_v2");if(!e)return;let s;try{const t=Qa.decompressFromUTF16(e);t?s=JSON.parse(t):s=JSON.parse(e)}catch{console.log("Migration: Parsing legacy uncompressed data..."),s=JSON.parse(e)}s.classrooms!==void 0&&s.trashBin!==void 0?($t(s.classrooms),Ue=s.trashBin||[],ze={...ze,...s.userSettings}):($t(s),vo())}function vo(){const e=[];Object.values(se).forEach(s=>{s.isDeleted?e.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:s.info.creationDate,type:"classroom",description:`کلاس «${s.info.name}»`,restoreData:{name:s.info.name}}):s.students.forEach(t=>{t.isDeleted&&e.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:t.identity.studentId.split("_")[1],type:"student",description:`دانش‌آموز «${t.identity.name}»`,restoreData:{studentId:t.identity.studentId,classroomName:s.info.name}})})}),Ue.length===0&&e.length>0&&(Ue=e,console.log(`Migrated ${e.length} previously deleted item(s) to the new trash bin.`),ie())}function ii(e){const s=new Dn(e.identity);return s.isDeleted=e.isDeleted,s.statusCounters=e.statusCounters,s.logs=e.logs,s.logs.scores||(s.logs.scores={}),s.profile=e.profile,s.finalClassActivityScore=e.finalClassActivityScore,s.categoryCounts=e.categoryCounts||{},s.categoryIssues=e.categoryIssues||{},s.qualitativeStats=e.qualitativeStats||{},s.onboardingSession=e.onboardingSession||null,s}function $t(e){se={};for(const s in e){const t=e[s];let c;t.info?c=t.info:c={...t,name:s};const i=new Ts(c);i.isDeleted=t.isDeleted,i.note=t.note||"",i.students=(t.students||[]).map(ii),i.sessions=(t.sessions||[]).map(n=>{const o=new Ja(n.sessionNumber);o.isDeleted=n.isDeleted,o.note=n.note||"",o.startTime=new Date(n.startTime),o.createdAt=n.createdAt?new Date(n.createdAt):new Date(n.startTime),o.endTime=n.endTime?new Date(n.endTime):null,o.isFinished=n.isFinished,o.isMakeup=n.isMakeup,o.isCancelled=n.isCancelled||!1,o.studentRecords=n.studentRecords;for(const r in o.studentRecords){const l=o.studentRecords[r];l.homework&&!(l.homework instanceof Ls)&&(o.studentRecords[r].homework=new Ls(l.homework.status,l.homework.comment))}o.lastWinnerByCategory=n.lastWinnerByCategory,o.lastUsedCategoryId=n.lastUsedCategoryId,o.lastSelectedWinnerId=n.lastSelectedWinnerId;const a=n.winnerHistory||[];return o.winnerHistory=a.filter(r=>r&&r.winner).map(r=>({winner:i.students.find(f=>f.identity.studentId===r.winner.identity.studentId),categoryName:r.categoryName,rating:r.rating||null})).filter(r=>r.winner),o}),i.categories=(t.categories||[]).map(n=>{const o=new pt(n.name,n.description,n.isGradedCategory,n.weight||1);return o.id=n.id,o.isDeleted=n.isDeleted,o}),i.futurePlans=t.futurePlans,se[s]=i}}function oi(e,s){if(s)$t(e.data.classrooms),ha(e.data.trashBin||[]);else{const t=e.data.classrooms,c=e.data.trashBin||[],i=new Map;for(const o in se){const a=se[o];a.info&&a.info.scheduleCode&&i.set(a.info.scheduleCode,o)}for(const o in t){const a=t[o],r=a.info.scheduleCode;if(i.has(r)){const l=i.get(r);l!==a.info.name&&delete se[l],se[a.info.name]=a}else{let l=a.info.name;for(;se[l];)l=`${l} (Imported)`;l!==a.info.name&&(a.info.name=l),se[l]=a}}const n=new Set(Ue.map(o=>o.id));c.forEach(o=>{n.has(o.id)||Ue.push(o)}),$t(se)}e.data.userSettings&&wt(e.data.userSettings),wt({lastRestoreTimestamp:new Date().toISOString()}),ie()}function ri(e,s){if(se[s])return{success:!1,message:"کلاسی با این نام از قبل وجود دارد."};const t=se[e];return t?(t.info.name=s,se[s]=t,delete se[e],A===t&&Je(t),{success:!0}):{success:!1,message:"کلاس مورد نظر یافت نشد."}}function ci(e,s,t){const c=t.trim();if(!c)return{success:!1,message:"نام دسته‌بندی نمی‌تواند خالی باشد."};if(e.categories.some(r=>r.id!==s.id&&!r.isDeleted&&r.name.toLowerCase()===c.toLowerCase()))return{success:!1,message:"دسته‌بندی دیگری با این نام وجود دارد."};const n=s.name,o=n.toLowerCase(),a=c.toLowerCase();return s.name=c,e.students.forEach(r=>{r.categoryCounts&&r.categoryCounts[n]!==void 0&&(r.categoryCounts[c]=r.categoryCounts[n],delete r.categoryCounts[n]),r.categoryIssues&&r.categoryIssues[n]!==void 0&&(r.categoryIssues[c]=r.categoryIssues[n],delete r.categoryIssues[n]),r.logs.scores&&r.logs.scores[o]&&(r.logs.scores[o].forEach(l=>l.skill=c),o!==a&&(r.logs.scores[a]=r.logs.scores[o],delete r.logs.scores[o]))}),e.sessions.forEach(r=>{r.lastWinnerByCategory&&r.lastWinnerByCategory[n]&&(r.lastWinnerByCategory[c]=r.lastWinnerByCategory[n],delete r.lastWinnerByCategory[n]),r.winnerHistory&&r.winnerHistory.forEach(l=>{l.categoryName===n&&(l.categoryName=c)})}),{success:!0}}function li(e,s,t){if(we(t.students).some(l=>l.identity.name.toLowerCase()===e.identity.name.toLowerCase()))return{success:!1,message:`دانش‌آموزی با نام «${e.identity.name}» از قبل در کلاس «${t.info.name}» وجود دارد.`};const i=JSON.parse(JSON.stringify(e)),n=ii(i),o=new Map;s.sessions.forEach(l=>{const f=l.studentRecords[e.identity.studentId];f&&o.set(l.sessionNumber,JSON.parse(JSON.stringify(f)))}),t.addStudent(n);try{const l=we(t.sessions).filter(v=>!v.isCancelled).sort((v,b)=>b.sessionNumber-v.sessionNumber),f=l.length>0?l[0]:null;let p="؟",h={type:"system",description:"Student Move"};f&&(p=st(t).get(f.sessionNumber)||f.sessionNumber,h={type:"fromSession",sessionNumber:f.sessionNumber});const m=new Date().toLocaleDateString("fa-IR"),y=s.info.name,u=`این دانش آموز در جلسه ${p} و در تاریخ ${m} از کلاس «${y}» به این کلاس انتقال پیدا کرد`;n.addNote(u,h)}catch(l){console.error("Failed to add automated move note:",l)}o.size>0&&t.sessions.forEach(l=>{const f=o.get(l.sessionNumber);f&&!l.isDeleted&&!l.isCancelled&&(l.studentRecords[n.identity.studentId]=f)});const a={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`(انتقال) دانش‌آموز «${e.identity.name}» از کلاس «${s.info.name}»`,restoreData:{studentId:e.identity.studentId,classId:s.info.scheduleCode}};ct(a);const r=s.students.find(l=>l.identity.studentId===e.identity.studentId);return r&&(r.isDeleted=!0),{success:!0}}function di(){for(const e in se){const s=se[e];s.students.forEach(t=>{t.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0},t.categoryCounts={},t.categoryIssues={},s.sessions.forEach(c=>{const i=t.identity.studentId;c.studentRecords[i]&&(c.studentRecords[i].attendance="present")})})}ie()}function we(e){return Array.isArray(e)?e.filter(s=>!s.isDeleted):[]}function st(e){const s=new Map;return e&&we(e.sessions).filter(c=>!c.isCancelled).sort((c,i)=>c.sessionNumber-i.sessionNumber).forEach((c,i)=>{s.set(c.sessionNumber,i+1)}),s}function yt(e){Xe=e}function lt(e){sa=e}function fs(e,s){if(!e||!s)return;const t=e.identity.studentId,c=s.students.findIndex(i=>i.identity.studentId===t);c>-1&&s.students.splice(c,1),s.sessions.forEach(i=>{i.studentRecords[t]&&delete i.studentRecords[t];for(const n in i.lastWinnerByCategory)i.lastWinnerByCategory[n]===t&&delete i.lastWinnerByCategory[n];i.lastSelectedWinnerId===t&&(i.lastSelectedWinnerId=null),i.winnerHistory=i.winnerHistory.filter(n=>n.winner&&n.winner.identity.studentId!==t)})}function ra(e,s){const t=se[e];if(!t)return;const c=t.sessions.findIndex(i=>i.sessionNumber===s);c>-1&&(t.students.forEach(i=>{i.profile.notes&&i.profile.notes.length>0&&(i.profile.notes=i.profile.notes.filter(n=>!n.source||n.source.type!=="fromAttendance"||n.source.sessionNumber!==s)),i.onboardingSession===s&&(i.onboardingSession=null)}),t.sessions.splice(c,1))}function ca(e,s){const t=se[e];if(!t)return;const c=t.categories.findIndex(a=>a.id===s);if(c===-1)return;const n=t.categories[c].name,o=n.toLowerCase();t.students.forEach(a=>{a.categoryCounts&&delete a.categoryCounts[n],a.categoryIssues&&delete a.categoryIssues[n],a.logs.scores&&delete a.logs.scores[o]}),t.sessions.forEach(a=>{a.lastWinnerByCategory[n]&&delete a.lastWinnerByCategory[n],a.winnerHistory=a.winnerHistory.filter(r=>r.categoryName!==n)}),t.categories.splice(c,1)}function la(e,s,t,c){const i=se[e];if(!i)return;const n=i.students.find(r=>r.identity.studentId===s);if(!n||!n.logs.scores[t.toLowerCase()])return;const o=n.logs.scores[t.toLowerCase()],a=o.findIndex(r=>r.id===c);a>-1&&o.splice(a,1)}function da(e,s,t){const c=se[e];if(!c)return;const i=c.students.find(o=>o.identity.studentId===s);if(!i||!i.profile.notes)return;const n=i.profile.notes.findIndex(o=>o.id===t);n>-1&&i.profile.notes.splice(n,1)}function ui(){JSON.parse(JSON.stringify({classrooms:se,trashBin:Ue})),ut=!0}function fi(){ut=!1,Xn()}function ct(e){for(Ue.unshift(e);Ue.length>50;){const s=Ue.pop();mi(s)}ie()}function mi(e){var s;if(!(!e||!e.restoreData))switch(console.log(`🗑️ Auto-cleaning overflow item: ${e.description}`),e.type){case"classroom":e.restoreData.name&&se[e.restoreData.name]&&delete se[e.restoreData.name];break;case"student":(s=e.restoreData.identity)!=null&&s.studentId&&fs(e.restoreData.identity.studentId);break;case"session":e.restoreData.id&&ra(e.restoreData.id);break;case"category":e.restoreData.id&&ca(e.restoreData.id);break;case"score":la(e.restoreData);break;case"note":e.restoreData.id&&da(e.restoreData.id);break}}function Je(e){A=e}function fn(e){Ks=e}function at(e){Y=e}function St(e){Le=e}function Qn(e){un=e}function hi(e){us=e}function en(e){Ys=e}function Nn(e){qn=e}function pi(e){Xs=e}function es(e){Re=e}function An(e){Zn=e}function gi(e){Qs=e}function On(e){Gn=e}function yi(e){ea=e}function ua(e){ta=e}function fa(e){na=e}function mn(e){Vn=e}function ma(e){gt=e}function Gt(e){Kn=e}function vi(e){ei=e}function bi(e){ti=e}function ha(e){Ue=e}function hn(e){Jn=e}function pn(e){Rt=e}function wt(e){ze={...ze,...e},ie()}function Mn(e){tt=e}function pa(){ze.lastBackupTimestamp=new Date().toISOString(),ie()}function ts(e){Yn=e}function bo(){ni.clear()}function Co(e){nt=e}function wo(){nt={}}function ga(e,s){nt[e]||(nt[e]={toBeScored:[],scoredThisSession:[]}),nt[e].scoredThisSession.includes(s)||nt[e].scoredThisSession.push(s)}const Ha=Object.freeze(Object.defineProperty({__proto__:null,get activeModal(){return gt},addToTrashBin:ct,get assessmentPools(){return nt},assessmentSessionExclusions:ni,get cancelCallback(){return na},get classrooms(){return se},get confirmCallback(){return ta},get currentClassroom(){return A},get datePickerCallback(){return Yn},get easterEggClickCount(){return Zn},get easterEggLastClickTime(){return Qs},enterDemoMode:ui,exitDemoMode:fi,getActiveItems:we,getSessionDisplayMap:st,get importedFileContent(){return qn},get isAssessmentModeActive(){return Bt},get isDemoMode(){return ut},get isModalTransitioning(){return aa},get liveSession(){return Ks},loadData:Xn,get manualSelection(){return Kn},markStudentAsScoredInSession:ga,moveStudent:li,get namesToImport(){return Ys},get notificationTimeout(){return Xs},permanentlyDeleteCategory:ca,permanentlyDeleteFromTrash:mi,permanentlyDeleteNote:da,permanentlyDeleteScore:la,permanentlyDeleteSession:ra,permanentlyDeleteStudent:fs,prepareBackupData:ai,get previousState(){return un},processRestore:oi,rehydrateData:$t,renameCategory:ci,renameClassroom:ri,resetAllStudentCounters:di,resetAssessmentExclusions:bo,resetAssessmentPools:wo,get resetEasterEggClickCount(){return Gn},get resetEasterEggLastClickTime(){return ea},get saveCategoryCallback(){return Jn},saveData:ie,get saveNoteCallback(){return sa},get secureConfirmCallback(){return Vn},get selectedCategory(){return Re},get selectedClassIds(){return tt},get selectedSession(){return Y},get selectedStudentForProfile(){return Le},get selectedStudentsForMassComment(){return Rt},setActiveModal:ma,setAssessmentPools:Co,setCancelCallback:fa,setConfirmCallback:ua,setCurrentClassroom:Je,setDatePickerCallback:ts,setEasterEggClickCount:An,setEasterEggLastClickTime:gi,setImportedFileContent:Nn,setIsAssessmentModeActive:si,setIsModalTransitioning:ia,setLastBackupTimestamp:pa,setLiveSession:fn,setManualSelection:Gt,setNamesToImport:en,setNotificationTimeout:pi,setPreviousState:Qn,setResetEasterEggClickCount:On,setResetEasterEggLastClickTime:yi,setSaveCategoryCallback:hn,setSaveNoteCallback:lt,setSecureConfirmCallback:mn,setSelectedCategory:es,setSelectedClassIds:Mn,setSelectedSession:at,setSelectedStudentForProfile:St,setSelectedStudentsForMassComment:pn,setSourceClassForMove:bi,setStudentToMove:vi,setTrashBin:ha,setUndoTimeout:hi,setUserSettings:wt,setWinnerHistoryIndex:yt,get sourceClassForMove(){return ti},get studentToMove(){return ei},get trashBin(){return Ue},get undoTimeout(){return us},get userSettings(){return ze},get winnerHistoryIndex(){return Xe}},Symbol.toStringTag,{value:"Module"})),Eo="TeacherAssistantDB",So=1,ft="backups";function ya(){return new Promise((e,s)=>{const t=indexedDB.open(Eo,So);t.onupgradeneeded=c=>{const i=c.target.result;i.objectStoreNames.contains(ft)||i.createObjectStore(ft,{keyPath:"id"})},t.onsuccess=c=>e(c.target.result),t.onerror=c=>s(c.target.error)})}async function Ci(e,s){const t=await ya(),c=t.transaction(ft,"readwrite"),i=c.objectStore(ft),n={id:Date.now(),file:e,metadata:s,timestamp:new Date().toISOString()};i.add(n),c.oncomplete=()=>{const a=t.transaction(ft,"readwrite").objectStore(ft),r=a.count();r.onsuccess=()=>{if(r.result>10){const l=a.getAllKeys();l.onsuccess=()=>{const f=l.result;for(;f.length>10;){const p=f.shift();a.delete(p),console.log(`♻️ Auto-deleted old backup snapshot: ${p}`)}}}}}}async function wi(){const e=await ya();return new Promise((s,t)=>{const n=e.transaction(ft,"readonly").objectStore(ft).getAll();n.onsuccess=()=>{const o=n.result.sort((a,r)=>r.id-a.id);s(o)},n.onerror=()=>t(n.error)})}async function _o(e){(await ya()).transaction(ft,"readwrite").objectStore(ft).delete(e)}const ko=Object.freeze(Object.defineProperty({__proto__:null,addBackupSnapshot:Ci,deleteBackupSnapshot:_o,getBackupSnapshots:wi},Symbol.toStringTag,{value:"Module"}));function We(e){return typeof e!="string"?"":e.replace(/ي/g,"ی").replace(/ك/g,"ک").replace(/[\s\u200c]/g,"")}function ms(e){return typeof e!="string"||e.length===0?"ltr":/[\u0590-\u07FF]/.test(e)?"rtl":"ltr"}function va(e){return!e||!e.trim()?"":e.split(`
`).map(c=>`<div dir="${ms(c)}">${c||"&nbsp;"}</div>`).join("")}function Rn(e){if(typeof e!="string")return"";const s={q:"ض",w:"ص",e:"ث",r:"ق",t:"ف",y:"غ",u:"ع",i:"ه",o:"خ",p:"ح","[":"ج","]":"چ",a:"ش",s:"س",d:"ی",f:"ب",g:"ل",h:"ا",j:"ت",k:"ن",l:"م",";":"ک","'":"گ",z:"ظ",x:"ط",c:"ز",v:"ر",b:"ذ",n:"د",m:"پ",",":"و"};let t="";for(let c=0;c<e.length;c++){const i=e[c].toLowerCase();t+=s[i]||e[c]}return t}function Wt(e){if(!e||typeof e!="string")return{name:"",firstName:"",lastName:""};const s=e.split(".").map(t=>t.trim());if(s.length>1){const t=s[0],c=s.slice(1).join(" ");return{firstName:t,lastName:c,name:`${t} ${c}`.trim()}}return{name:e.trim(),firstName:"",lastName:""}}let Is=null;function Bs(){if(!ze.isSoundEnabled)return;const e=window.AudioContext||window.webkitAudioContext;if(!e)return;Is||(Is=new e);const s=Is,t=()=>{const c=s.createOscillator(),i=s.createGain();c.connect(i),i.connect(s.destination),c.type="sine";const n=s.currentTime;c.frequency.setValueAtTime(450,n),i.gain.setValueAtTime(0,n),i.gain.linearRampToValueAtTime(.3,n+.002),i.gain.exponentialRampToValueAtTime(.001,n+.025),i.gain.linearRampToValueAtTime(0,n+.03),c.start(n),c.stop(n+.04)};s.state==="suspended"?s.resume().then(()=>{t()}).catch(c=>console.error("Audio resume failed:",c)):t()}function En(e){const s=e.filter(i=>i.identity.firstName&&i.identity.lastName),t=e.filter(i=>(!i.identity.firstName||!i.identity.lastName)&&typeof i.identity.name=="string"),c=e.filter(i=>(!i.identity.firstName||!i.identity.lastName)&&!i.identity.name);return s.sort((i,n)=>{const o=i.identity.lastName.localeCompare(n.identity.lastName,"fa");return o!==0?o:i.identity.firstName.localeCompare(n.identity.firstName,"fa")}),t.sort((i,n)=>i.identity.name.localeCompare(n.identity.name,"fa")),[...s,...t,...c]}function Ei(e,s){let t=0;e.addEventListener("dblclick",s),e.addEventListener("touchend",c=>{const i=new Date().getTime(),n=i-t;n<400&&n>0&&(c.preventDefault(),s(c)),t=i})}const Io=Object.freeze(Object.defineProperty({__proto__:null,detectTextDirection:ms,normalizeKeyboard:Rn,normalizeText:We,parseStudentName:Wt,playSuccessSound:Bs,renderMultiLineText:va,setupDoubleAction:Ei,sortStudents:En},Symbol.toStringTag,{value:"Module"})),Si="teacherAssistantLogs_v2",xo=100;function ba(){try{const e=localStorage.getItem(Si);return e?JSON.parse(e):{}}catch(e){return console.error("Error reading logs from localStorage:",e),{}}}function _i(e){try{localStorage.setItem(Si,JSON.stringify(e))}catch(s){console.error("Error saving logs to localStorage:",s)}}function _e(e,s,t=null){if(!e)return;const c=ba();c[e]||(c[e]=[]);const i={timestamp:new Date().toISOString(),message:s,action:t,classroomName:e};c[e].unshift(i),c[e].length>xo&&c[e].pop(),_i(c)}function Lo(e){return ba()[e]||[]}function To(e,s){const t=ba();t[e]&&!t[s]&&(t[s]=t[e],delete t[e],_i(t))}var Wa={toJalaali:Bo,toGregorian:ki,isValidJalaaliDate:Do,isLeapJalaaliYear:Ii,jalaaliMonthLength:xi,jalCal:Ca,j2d:ns,d2j:ss,g2d:hs,d2g:wa,jalaaliToDateObject:Li,jalaaliWeek:Ao},Et=[-61,9,38,199,426,686,756,818,1111,1181,1210,1635,2060,2097,2192,2262,2324,2394,2456,3178];function Bo(e,s,t){return Object.prototype.toString.call(e)==="[object Date]"&&(t=e.getDate(),s=e.getMonth()+1,e=e.getFullYear()),ss(hs(e,s,t))}function ki(e,s,t){return wa(ns(e,s,t))}function Do(e,s,t){return e>=-61&&e<=3177&&s>=1&&s<=12&&t>=1&&t<=xi(e,s)}function Ii(e){return No(e)===0}function xi(e,s){return s<=6?31:s<=11||Ii(e)?30:29}function No(e){var s=Et.length,t=Et[0],c,i,n,o,a;if(e<t||e>=Et[s-1])throw new Error("Invalid Jalaali year "+e);for(a=1;a<s&&(c=Et[a],i=c-t,!(e<c));a+=1)t=c;return o=e-t,i-o<6&&(o=o-i+Be(i+4,33)*33),n=Ye(Ye(o+1,33)-1,4),n===-1&&(n=4),n}function Ca(e,s){var t=Et.length,c=e+621,i=-14,n=Et[0],o,a,r,l,f,p,h;if(e<n||e>=Et[t-1])throw new Error("Invalid Jalaali year "+e);for(h=1;h<t&&(o=Et[h],a=o-n,!(e<o));h+=1)i=i+Be(a,33)*8+Be(Ye(a,33),4),n=o;return p=e-n,i=i+Be(p,33)*8+Be(Ye(p,33)+3,4),Ye(a,33)===4&&a-p===4&&(i+=1),l=Be(c,4)-Be((Be(c,100)+1)*3,4)-150,f=20+i-l,s?{gy:c,march:f}:(a-p<6&&(p=p-a+Be(a+4,33)*33),r=Ye(Ye(p+1,33)-1,4),r===-1&&(r=4),{leap:r,gy:c,march:f})}function ns(e,s,t){var c=Ca(e,!0);return hs(c.gy,3,c.march)+(s-1)*31-Be(s,7)*(s-7)+t-1}function ss(e){var s=wa(e).gy,t=s-621,c=Ca(t,!1),i=hs(s,3,c.march),n,o,a;if(a=e-i,a>=0){if(a<=185)return o=1+Be(a,31),n=Ye(a,31)+1,{jy:t,jm:o,jd:n};a-=186}else t-=1,a+=179,c.leap===1&&(a+=1);return o=7+Be(a,30),n=Ye(a,30)+1,{jy:t,jm:o,jd:n}}function hs(e,s,t){var c=Be((e+Be(s-8,6)+100100)*1461,4)+Be(153*Ye(s+9,12)+2,5)+t-34840408;return c=c-Be(Be(e+100100+Be(s-8,6),100)*3,4)+752,c}function wa(e){var s,t,c,i,n;return s=4*e+139361631,s=s+Be(Be(4*e+183187720,146097)*3,4)*4-3908,t=Be(Ye(s,1461),4)*5+308,c=Be(Ye(t,153),5)+1,i=Ye(Be(t,153),12)+1,n=Be(s,1461)-100100+Be(8-i,6),{gy:n,gm:i,gd:c}}function Ao(e,s,t){var c=Li(e,s,t).getDay(),i=c==6?0:-(c+1),n=6+i;return{saturday:ss(ns(e,s,t+i)),friday:ss(ns(e,s,t+n))}}function Li(e,s,t,c,i,n,o){var a=ki(e,s,t);return new Date(a.gy,a.gm-1,a.gd,c||0,i||0,n||0,o||0)}function Be(e,s){return~~(e/s)}function Ye(e,s){return e-~~(e/s)*s}const Ti=document.getElementById("class-management-page"),Oo=document.getElementById("open-add-class-modal-btn"),Mo=document.getElementById("add-class-modal"),gn=document.getElementById("modal-new-class-name"),as=document.getElementById("modal-add-class-system"),Ea=document.getElementById("modal-add-class-level"),Ds=document.getElementById("confirm-add-class-btn"),Ns=document.getElementById("cancel-add-class-btn"),Nt=document.getElementById("class-list"),is=document.getElementById("undo-toast"),Bi=document.getElementById("undo-message"),Ro=document.getElementById("undo-btn"),$o=document.getElementById("settings-page"),Di=document.getElementById("settings-class-name-header"),As=document.getElementById("settings-student-list"),Os=document.getElementById("category-list"),zo=document.getElementById("back-to-sessions-btn"),Po=document.getElementById("new-student-name"),Fo=document.getElementById("add-student-btn"),Ni=document.getElementById("paste-area"),Ho=document.getElementById("process-paste-btn"),Wo=document.getElementById("csv-preview-page"),Ms=document.getElementById("csv-preview-list"),Uo=document.getElementById("csv-confirm-btn"),jo=document.getElementById("csv-cancel-btn"),qo=document.getElementById("import-csv-btn"),Zo=document.getElementById("csv-file-input"),Go=document.getElementById("column-mapping-page"),Rs=document.getElementById("column-select-dropdown"),Vo=document.getElementById("confirm-column-btn"),Jo=document.getElementById("cancel-import-btn"),$s=document.querySelector(".app-header"),Ke=document.getElementById("select-student-btn"),At=document.getElementById("select-student-btn-wrapper"),Ko=document.getElementById("assessment-mode-label"),$n=document.getElementById("category-weight-label"),Yo=document.getElementById("attendance-page"),rn=document.getElementById("attendance-list"),Xo=document.getElementById("finish-attendance-btn"),Qo=document.querySelector("#class-management-page h2"),zs=document.getElementById("student-stats-header"),er=document.getElementById("hamburger-menu-btn"),tr=document.getElementById("side-nav-menu"),nr=document.getElementById("close-nav-btn"),sr=document.getElementById("overlay"),ar=document.getElementById("backup-data-btn"),ir=document.getElementById("restore-data-btn"),Ai=document.getElementById("restore-file-input"),or=document.getElementById("custom-confirm-modal"),Oi=document.getElementById("confirm-modal-message"),Ps=document.getElementById("confirm-modal-cancel-btn"),tn=document.getElementById("confirm-modal-confirm-btn"),rr=document.getElementById("secure-confirm-modal"),Mi=document.getElementById("secure-confirm-message"),Ri=document.getElementById("secure-confirm-code"),Ft=document.getElementById("secure-confirm-input"),cr=document.getElementById("secure-confirm-cancel-btn"),zn=document.getElementById("secure-confirm-confirm-btn"),lr=document.getElementById("add-note-modal"),Ee=document.getElementById("new-note-content"),dr=document.getElementById("class-save-note-btn"),ur=document.getElementById("cancel-note-btn"),Fs=document.getElementById("student-search-input"),Ct=document.getElementById("student-search-results"),fr=document.getElementById("back-to-student-page-btn"),mr=document.getElementById("graded-category-pills-container"),hr=document.getElementById("new-score-value"),$i=document.getElementById("new-score-comment"),pr=document.getElementById("add-score-btn"),gr=document.getElementById("profile-stats-summary"),yr=document.getElementById("profile-scores-list"),nn=document.getElementById("global-student-search-input"),dt=document.getElementById("global-student-search-results"),vr=document.getElementById("trashed-classes-list"),br=document.getElementById("trashed-students-list"),Cr=document.getElementById("trashed-sessions-list"),wr=document.getElementById("trashed-categories-list"),Er=document.getElementById("trashed-notes-list"),Sr=document.getElementById("trashed-scores-list"),Ut=document.getElementById("quick-grade-form-wrapper"),mt=document.getElementById("quick-score-input"),rt=document.getElementById("quick-note-textarea"),Ot=document.getElementById("quick-grade-submit-btn"),cn=document.getElementById("category-selection-container"),Hs=document.getElementById("selected-student-result"),Mt=document.getElementById("custom-context-menu"),Ht=document.getElementById("breadcrumb-container"),_r=document.getElementById("report-config-modal"),zi=document.getElementById("report-columns-container"),Pi=document.getElementById("report-print-btn"),Fi=document.getElementById("report-cancel-btn");let Qt=null,qt=null;const kr=document.getElementById("category-modal"),Hi=document.getElementById("category-modal-title"),Zt=document.getElementById("new-category-modal-name"),yn=document.getElementById("new-category-modal-is-graded"),Ir=document.getElementById("category-modal-cancel-btn"),Wi=document.getElementById("category-modal-save-btn"),xr=document.getElementById("mass-comment-modal"),Lr=document.getElementById("mass-comment-modal-title"),Ui=document.getElementById("mass-comment-student-count-message"),ln=document.getElementById("mass-comment-content"),Sa=document.getElementById("mass-comment-append-checkbox"),Tr=document.getElementById("mass-comment-cancel-btn"),Br=document.getElementById("mass-comment-save-btn"),Ws=document.getElementById("mass-comment-btn"),Pn=document.getElementById("attendance-mass-actions-container"),Tt=document.createElement("input"),Dr=document.getElementById("session-dashboard-page"),Vt=document.getElementById("attendance-pane"),Fn=document.getElementById("settings-edu-system"),sn=document.getElementById("settings-level"),ji=document.getElementById("modal-schedule-text"),os=document.getElementById("modal-schedule-days"),qi=document.getElementById("modal-schedule-start-time"),Zi=document.getElementById("modal-schedule-end-time"),an=document.getElementById("modal-schedule-toggle"),Gi=document.getElementById("modal-schedule-content"),rs=document.getElementById("new-category-modal-weight"),Nr=document.getElementById("category-modal"),dn=document.getElementById("new-category-modal-weight-group"),Ar=document.getElementById("open-add-category-btn");function jt(e,s,t=800){let c,i=t;const n=a=>{c=setTimeout(()=>{ze.isVibrationEnabled&&navigator.vibrate&&navigator.vibrate(50),s(a)},i)},o=()=>{clearTimeout(c)};e.addEventListener("touchstart",n,{passive:!0}),e.addEventListener("touchend",o),e.addEventListener("touchmove",o),e.addEventListener("mousedown",n),e.addEventListener("mouseup",o),e.addEventListener("mouseleave",o)}function Sn(e="selector"){if(!A||!Y){ke("class-management-page");return}zr(),Wn(),Oe(),Qe(),ke("session-dashboard-page",{tab:e}),Vi(),Jt(e),Pr()}function Jt(e){const s=document.getElementById("selector-tab-btn"),t=document.getElementById("attendance-tab-btn"),c=document.getElementById("selector-pane"),i=e==="selector";s.classList.toggle("active",i),t.classList.toggle("active",!i),c.classList.toggle("active",i),Vt.classList.toggle("active",!i)}function Vi(){const e=document.getElementById("selector-tab-btn"),s=document.getElementById("attendance-tab-btn"),t=document.getElementById("selector-pane");e.addEventListener("click",()=>{Oe(),$e(),e.classList.add("active"),s.classList.remove("active"),t.classList.add("active"),Vt.classList.remove("active"),ke("session-dashboard-page",{tab:"selector"})}),s.addEventListener("click",()=>{Qe(),s.classList.add("active"),e.classList.remove("active"),Vt.classList.add("active"),t.classList.remove("active"),ke("session-dashboard-page",{tab:"attendance"})}),Ei(s,c=>{Jt("attendance"),Qe(),setTimeout(()=>{const i=document.getElementById("attendance-search-input");i&&i.focus()},100)})}function Or(e){clearTimeout(us),un||Qn(JSON.stringify(se)),Bi.textContent=e,is.classList.add("show"),hi(setTimeout(()=>{is.classList.remove("show"),Qn(null)},5e3))}function Ji(){if(un){const e=A?A.info.name:null,s=JSON.parse(un);$t(s),e&&se[e]?Je(se[e]):Je(null),A?(kt(),Yt(),Ze()):Fe(),is.classList.remove("show"),clearTimeout(us),Qn(null)}}function q(e,s=3e3){const t=document.getElementById("notification-toast");t&&(t.textContent=e,t.classList.add("show"),clearTimeout(Xs),pi(setTimeout(()=>{t.classList.remove("show")},s)))}function cs(e){var v;const s=document.getElementById("restore-confirm-modal"),t=document.getElementById("restore-modal-message"),c=document.getElementById("restore-append-checkbox"),i=document.querySelector('label[for="restore-append-checkbox"]'),n=document.getElementById("restore-confirm-cancel-btn"),o=document.getElementById("restore-confirm-confirm-btn"),a=document.getElementById("restore-modal-warning");a.style.display="none";const r=((v=e.metadata)==null?void 0:v.createdAt)||0;if(ze.lastRestoreTimestamp&&r<ze.lastRestoreTimestamp){const b=new Date(r).toLocaleDateString("fa-IR"),C=new Date(ze.lastRestoreTimestamp).toLocaleDateString("fa-IR");a.textContent=`⚠️ هشدار: این فایل پشتیبان (${b}) قدیمی‌تر از آخرین بازیابی شما (${C}) است.`,a.style.display="block"}const l=e.data.classrooms||{},f=Object.values(l).map(b=>b.info.name),p=f.length,h="کلاس",m=f.map(b=>`<li style="margin-bottom: 4px;">🔹 ${b}</li>`).join("");t.innerHTML=`
        <div style="margin-bottom: 10px;">
            فایل پشتیبان شامل <strong>${p} ${h}</strong> زیر است:
        </div>
        <ul style="
            margin: 0; 
            padding: 10px; 
            background-color: #f8f9fa; 
            border-radius: 5px; 
            border: 1px solid #e9ecef;
            list-style: none; 
            max-height: 150px; 
            overflow-y: auto;
            text-align: right;
        ">
            ${m}
        </ul>
        <div style="margin-top: 15px;">
            لطفاً نحوه بازیابی را مشخص کنید.
        </div>
    `,c.checked=!1,i&&(i.textContent="جایگزینی کامل (حذف داده‌های فعلی)");const y=()=>{const b=c.checked;oi(e,b),o.onclick=null,n.onclick=null,s.removeEventListener("click",y),he(),Fe(),ke("class-management-page"),q(`✅ اطلاعات با موفقیت بازیابی شد (${b?"پاک‌سازی و بازیابی":"همگام‌سازی هوشمند"}).`)},u=()=>{o.onclick=null,n.onclick=null,he()};o.onclick=y,n.onclick=u,Ae("restore-confirm-modal")}function be(e,s,t={}){const{confirmText:c="تایید",cancelText:i="لغو",confirmClass:n="btn-success",onCancel:o=()=>{},isDelete:a=!1}=t,r=a?()=>Ki(e,s):s;Oi.innerHTML=e.replace(/\n/g,"<br>"),tn.textContent=c,Ps.textContent=i,tn.className="modal-action-btn",tn.classList.add(n),ua(r),fa(o);const l=tn.parentElement;Ps.style.display=o===null?"none":"inline-block",l.style.justifyContent=o===null?"center":"space-between",Ae("custom-confirm-modal")}function Ki(e,s){const t=Math.floor(1e4+Math.random()*9e4).toString();Mi.textContent=e,Ri.textContent=t,Ft.value="",zn.disabled=!0,mn(s),Ae("secure-confirm-modal"),Ft.focus();const c=()=>{Ft.value===t?zn.disabled=!1:zn.disabled=!0};return Ft.addEventListener("input",c),()=>{Ft.removeEventListener("input",c)}}function Us(e,s={}){const{title:t="ایجاد دسته‌بندی جدید",initialName:c="",initialIsGraded:i=!1,initialWeight:n=1,saveButtonText:o="ذخیره"}=s;Hi.textContent=t,Zt.value=c,yn.checked=i,wn(),rs.value=n,Wi.textContent=o,hn((a,r)=>{const l=parseFloat(rs.value)||1;if(!a){q("⚠️ لطفاً نام دسته‌بندی را وارد کنید.");return}e(a,r,l),he()}),Ae("category-modal"),Zt.focus(),c&&Zt.select()}function _a(e,s){const t=Object.values(se).filter(o=>!o.isDeleted&&o.info.name!==s.info.name),c=document.getElementById("move-student-modal-title"),i=document.getElementById("move-student-class-select"),n=document.getElementById("move-student-confirm-btn");c.textContent=`انتقال دانش‌آموز: ${e.identity.name}`,i.innerHTML="",t.length===0?(i.innerHTML='<option value="">کلاس دیگری برای انتقال وجود ندارد</option>',n.disabled=!0):(t.forEach(o=>{const a=document.createElement("option");a.value=o.info.name,a.textContent=o.info.name,i.appendChild(a)}),n.disabled=!1),vi(e),bi(s),Ae("move-student-modal")}function ka(e,s){if(!e||!s)return;const t=e.identity.name,c=e.identity.firstName||"";e.identity.lastName;const i=document.getElementById("add-note-modal-title");i.textContent="تغییر نام دانش‌ آموز";const n=e.identity.firstName&&e.identity.lastName?`${e.identity.firstName} . ${e.identity.lastName}`:t;Ee.value=n,Ee.rows=1,Ee.dispatchEvent(new Event("input",{bubbles:!0})),lt(o=>{const a=o.indexOf(".");if(a<=0||a>=o.length-1)return q("لطفا نام و نام خانوادگی شخص را با یک نقطه از هم جدا کنید. مثال: علی . احمدی"),!1;const r=Wt(o),l=r.name,f=r.firstName||"";if(e.identity.firstName&&e.identity.lastName&&!r.firstName)return q("⚠️ این دانش‌آموز دارای نام و نام‌خانوادگی تفکیک شده است. لطفاً حتماً از نقطه (.) بین نام و نام‌خانوادگی استفاده کنید."),!1;if(l&&(l!==t||f!==c)){if(we(s.students).some(u=>u.identity.studentId!==e.identity.studentId&&u.identity.name.toLowerCase()===l.toLowerCase()))return q("دانش‌آموزی با این نام از قبل در این کلاس وجود دارد."),!1;{e.identity.name=l,e.identity.firstName=r.firstName,e.identity.lastName=r.lastName,_e(s.info.name,`نام دانش‌آموز «${t}» به «${l}» تغییر یافت.`,{type:"VIEW_STUDENT_PROFILE",studentId:e.identity.studentId}),ie(),kt(),Oe(),Qe(),$e(),Le&&Le.identity.studentId===e.identity.studentId&&je(e);const u=document.querySelector(`#settings-student-list li[data-student-id="${e.identity.studentId}"]`);u&&(u.classList.add("recently-updated"),setTimeout(()=>{u&&u.classList.remove("recently-updated")},1e4),u.scrollIntoView({behavior:"smooth",block:"center"})),q(`✅ نام دانش‌آموز به «${l}» تغییر یافت.`)}}else if(!l)return q("⚠️ نام نمی‌تواند خالی باشد."),!1;const m=document.getElementById("add-note-modal-title");m.textContent="ثبت یادداشت جدید",Ee.rows=4}),Ae("add-note-modal"),Ee.focus(),Ee.select()}function Ae(e){const s=document.getElementById(e);if(s){if(gt)return;s.classList.add("modal-visible"),ma(e),history.pushState(null,"",location.href)}}function he(e,s=!1){if(!gt)return;ia(!0);const t=document.getElementById(gt),c=gt;ma(null),c==="student-profile-modal"&&St(null),s||history.back(),t&&(t.classList.add("modal-closing"),setTimeout(()=>{t.classList.remove("modal-visible"),t.classList.remove("modal-closing"),c==="custom-confirm-modal"&&(ua(null),fa(null)),c==="secure-confirm-modal"&&mn(null),c==="category-modal"&&hn(null),c==="mass-comment-modal"&&(ln.value=""),c==="add-note-modal"&&lt(null),typeof e=="function"&&e()},300))}function Ia(){if(!Vt||!Vt.classList.contains("active")){Pn.style.display="none";return}const e=Rt.length;e<1?Pn.style.display="none":Pn.style.display="block",Ws.disabled=e<1,Ws.textContent=`📝 ثبت یادداشت گروهی (${e} نفر)`}function xa(){const e=Rt,s=e.length;let t=!1;s>0&&(t=e.some(i=>{var n;return(n=Y.studentRecords[i])==null?void 0:n.homework.comment})),Ui.textContent=`یادداشت برای ${s} دانش‌آموز ثبت خواهد شد.`,ln.value="",ln.dispatchEvent(new Event("input",{bubbles:!0})),Sa.checked=!0;const c=document.querySelector("#mass-comment-modal .modal-options");c.style.display=t?"flex":"none",Ae("mass-comment-modal"),ln.focus()}function js(e,s){if(!A||!Y)return;let t=0;const c=Rt,i=Y;c.forEach(n=>{const o=i.studentRecords[n];if(o&&o.homework){const a=o.homework.comment||"";let r=e;s&&a.length>0?r=a+`
---
`+e:r=e,o.homework.comment=r.trim();const l=A.students.find(f=>f.identity.studentId===n);l&&Mr(l,i,r.trim()),t++}}),pn([]),ie(),Qe(),_e(A.info.name,`${t} دانش‌آموز به صورت گروهی یادداشت تکلیف گرفتند.`,{type:"VIEW_SESSIONS"}),q(`✅ یادداشت برای ${t} دانش‌آموز ثبت شد.`)}function Mr(e,s,t){const i=st(A).get(s.sessionNumber),n={type:"fromAttendance",sessionNumber:s.sessionNumber},o=`یادداشت جلسه ${i}:
`,a=e.profile.notes.find(r=>!r.isDeleted&&r.source&&r.source.type==="fromAttendance"&&r.source.sessionNumber===n.sessionNumber);a?t?(a.content=o+t,a.isDeleted=!1):a.isDeleted=!0:t&&e.addNote(o+t,n)}function ps(e){Ee.value=e.note||"",lt(s=>{e.note=s,ie(),_e(e.info.name,"یادداشت کلاس ذخیره شد.",{type:"VIEW_CLASS_NOTE"}),Fe(),q("✅ یادداشت کلاس ذخیره شد.")}),Ae("add-note-modal"),Ee.focus()}function La(e,s){Ee.value=e.note||"",Ee.dispatchEvent(new Event("input",{bubbles:!0})),lt(t=>{e.note=t,ie(),_e(A.info.name,`یادداشت جلسه ${s} ذخیره شد.`,{type:"VIEW_SESSIONS"}),Ze(),q("✅یادداشت جلسه ذخیره شد.")}),Ae("add-note-modal"),Ee.focus()}function _t(e){Je(e),Di.textContent=`تنظیمات کلاس: ${e.info.name}`,kt(),Yt(),so(),ke("settings-page")}function Yi(e){const s=document.getElementById("log-modal-title"),t=document.getElementById("log-list");s.textContent=`گزارش فعالیت‌های کلاس: ${e}`,t.innerHTML="";const c=Lo(e);c.length===0?t.innerHTML='<li class="no-content-message">هنوز فعالیتی برای این کلاس ثبت نشده است.</li>':c.forEach(i=>{const n=document.createElement("li");n.className="log-entry";const o=new Date(i.timestamp),a=`${o.toLocaleDateString("fa-IR")} - ${o.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}`,r=document.createElement("span");r.className="log-timestamp",r.textContent=a;const l=document.createElement("span");l.className="log-message",l.textContent=i.message,i.action&&(l.classList.add("log-action-link"),l.dataset.action=JSON.stringify({...i.action,classroomName:i.classroomName})),n.appendChild(r),n.appendChild(l),t.appendChild(n)}),Ae("log-modal")}document.getElementById("log-modal-close-btn").addEventListener("click",()=>{he()});function qs(e){const s=URL.createObjectURL(e),t=document.createElement("a");t.href=s,t.download=e.name,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(s),setTimeout(()=>{be("آیا فایل پشتیبان با موفقیت ذخیره شد؟",()=>{pa(),gs(),q("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله، ذخیره شد",cancelText:"خیر",confirmClass:"btn-success"})},500)}async function vn(e=[]){const s=await ai(e);if(!s){q("❌ خطا در ایجاد فایل پشتیبان.");return}let t="پشتیبان کامل سیستم";if(e.length>0){const i=e.join("، ");t=`${e.length===1?"پشتیبان کلاس:":"پشتیبان کلاس‌های:"} ${i}`}Ci(s,{name:s.name,description:t,version:"2.0-b64"}).catch(i=>console.error("Failed to save local snapshot:",i)),("ontouchstart"in window||navigator.maxTouchPoints>0)&&navigator.share&&navigator.canShare&&navigator.canShare({files:[s]})?be("فایل پشتیبان شما آماده است. آیا مایل به اشتراک‌گذاری آن هستید؟",()=>{try{navigator.share({title:s.name,text:"فایل پشتیبان داده‌های برنامه",files:[s]}).then(()=>{be("آیا فایل پشتیبان با موفقیت ارسال/ذخیره شد؟",()=>{pa(),gs(),q("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}catch(i){console.error("Error during sharing process:",i),qs(s),q("⚠️خطا در فرآیند اشتراک‌گذاری. فایل در حال دانلود است.")}},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"}):(qs(s),q("✅پشتیبان‌گیری با موفقیت انجام شد."))}function _n(e,s){e.preventDefault(),Dt(),qt=e.target.closest("li"),qt&&qt.classList.add("context-menu-target"),setTimeout(()=>{const t=Mt,c=t.querySelector("ul");c.innerHTML="",s.forEach(l=>{const f=document.createElement("li");l.isSeparator?f.className="separator":(f.innerHTML=`
                    <span class="icon">${l.icon||""}</span>
                    <span class="label">${l.label}</span>
                `,l.className&&f.classList.add(l.className),f.addEventListener("click",()=>{l.action(),Dt()})),c.appendChild(f)}),t.classList.add("visible");const{offsetWidth:i,offsetHeight:n}=t,{innerHeight:o}=window,a=document.body.getBoundingClientRect();t.style.top=`${(o-n)/2}px`;const r=a.left+a.width/2;t.style.left=`${r-i/2}px`},50)}function Dt(){Mt.classList.contains("visible")&&Mt.classList.remove("visible"),qt&&(qt.classList.remove("context-menu-target"),qt=null)}function Xi(){var t;Ht.innerHTML="";const e=document.getElementById("header-settings-btn");if(!e)return;const s=[];if(s.push({label:"کلاس‌ها",handler:()=>{Je(null),at(null),St(null),ke("class-management-page")}}),A){s.push({label:A.info.name,handler:()=>{at(null),St(null),Ze(),ke("session-page")}});const c=(t=document.querySelector(".page.active"))==null?void 0:t.id;if(c==="session-page"?e.style.visibility="visible":e.style.visibility="hidden",c==="settings-page")s.push({label:"تنظیمات"});else if(Y){const n=st(A).get(Y.sessionNumber)||` (#${Y.sessionNumber})`;s.push({label:`جلسه ${n}`,handler:()=>{St(null),Sn("selector")}}),Le&&s.push({label:`پروفایل: ${Le.identity.name}`})}}else e.style.visibility="hidden";if(s.length<=1){Ht.style.display="none";return}Ht.style.display="flex",s.forEach((c,i)=>{const n=document.createElement("a");if(n.textContent=c.label,n.className="breadcrumb-item",i===s.length-1||!c.handler?n.classList.add("active"):n.addEventListener("click",c.handler),Ht.appendChild(n),i<s.length-1){const o=document.createElement("span");o.className="breadcrumb-separator",o.textContent="/",Ht.appendChild(o)}})}function Ua(e,s,t){t.innerHTML="";const c=A.sessions.filter(i=>{var n;return!i.isDeleted&&!i.isCancelled&&((n=i.studentRecords[e.identity.studentId])==null?void 0:n.attendance)==="absent"}).map(i=>({number:s.get(i.sessionNumber),isMakeup:i.isMakeup})).filter(i=>i.number!==void 0);c.length>0?(t.appendChild(document.createTextNode("جلسات غایب: ")),c.forEach((i,n)=>{const o=document.createElement("span");o.textContent=i.number,i.isMakeup&&o.classList.add("makeup-absence"),t.appendChild(o),n<c.length-1&&t.appendChild(document.createTextNode("، "))})):t.textContent="جلسات غایب: بدون غیبت"}function Hn(e,s,t,c={}){const{includePrefix:i=!0}=c;t.innerHTML="";const n=A.sessions.filter(o=>{if(o.isDeleted||o.isCancelled)return!1;const a=o.studentRecords[e.identity.studentId];return a&&a.homework&&(a.homework.status==="incomplete"||a.homework.status==="none")}).map(o=>({number:s.get(o.sessionNumber),status:o.studentRecords[e.identity.studentId].homework.status})).filter(o=>o.number!==void 0);n.length>0?(i&&t.appendChild(document.createTextNode("تکالیف ناقص: ")),n.forEach((o,a)=>{const r=document.createElement("span");r.textContent=o.number,o.status==="incomplete"&&r.classList.add("incomplete-homework"),t.appendChild(r),a<n.length-1&&t.appendChild(document.createTextNode("،"))})):i?t.textContent="تکالیف ناقص: ندارد":t.textContent="ندارد"}function Rr(e,s){var L,D,M;const t=document.createElement("li");t.className="attendance-list-item";const c=document.createElement("span");c.className="absence-info";const i=document.createElement("span");i.className="homework-info";const n=document.createElement("div");n.className="att-row-1";let o=!1;n.addEventListener("mousedown",()=>o=!1),n.addEventListener("touchstart",()=>o=!1,{passive:!0});const a=document.createElement("input");a.type="checkbox",a.className="mass-comment-checkbox",a.checked=Rt.includes(e.identity.studentId),a.addEventListener("change",()=>{const U=e.identity.studentId,Q=Rt;if(a.checked)Q.includes(U)||Q.push(U);else{const $=Q.indexOf(U);$>-1&&Q.splice($,1)}Ia();const I=document.getElementById("attendance-list");Q.length===0&&I.classList.contains("selection-mode-active")&&I.classList.remove("selection-mode-active")});const r=document.createElement("span");r.className="student-name",r.textContent=e.identity.firstName&&e.identity.lastName?`${e.identity.lastName}، ${e.identity.firstName}`:e.identity.name,r.addEventListener("click",U=>{if(o){U.stopPropagation(),U.preventDefault(),o=!1;return}je(e)}),jt(n,U=>{o=!0;const Q=document.getElementById("attendance-list");Q.classList.contains("selection-mode-active")||Q.classList.add("selection-mode-active"),a.checked||(a.checked=!0,a.dispatchEvent(new Event("change")))}),n.appendChild(a),n.appendChild(r);const l=document.createElement("div");l.className="att-row-2";const f=document.createElement("button");let p=!1;f.addEventListener("mousedown",()=>p=!1),f.addEventListener("touchstart",()=>p=!1,{passive:!0});const h=((L=Y.studentRecords[e.identity.studentId])==null?void 0:L.attendance)||"present",m=U=>{U==="present"?(f.textContent="حاضر",f.className="attendance-status-btn present active"):(f.textContent="غایب",f.className="attendance-status-btn absent active")};m(h),f.addEventListener("click",U=>{var $;if(p){U.stopPropagation();return}const I=((($=Y.studentRecords[e.identity.studentId])==null?void 0:$.attendance)||"present")==="present"?"absent":"present";Y.setAttendance(e.identity.studentId,I),I==="absent"&&(Y.studentRecords[e.identity.studentId].hadIssue=!1),ie(),m(I),Ua(e,s,c),Oe(),ao()}),jt(f,()=>{p=!0;const U=h==="present"?"absent":"present",Q=U==="present"?"حاضر":"غایب";be(`آیا مطمئن هستید که می‌خواهید وضعیت حضور تمام دانش‌آموزان را به «${Q}» تغییر دهید؟`,()=>{we(A.students).forEach(I=>{Y.setAttendance(I.identity.studentId,U),U==="absent"&&(Y.studentRecords[I.identity.studentId].hadIssue=!1)}),ie(),Qe(),q(`✅ وضعیت تمام دانش‌آموزان به «${Q}» تغییر یافت.`)},{confirmText:"بله، اعمال کن",confirmClass:"btn-warning"})});const y=document.createElement("div");y.className="homework-controls";const u={none:"بدون تکلیف",complete:"تکلیف کامل",incomplete:"تکلیف ناقص"},v=document.createElement("button");let b=!1;v.addEventListener("mousedown",()=>b=!1),v.addEventListener("touchstart",()=>b=!1,{passive:!0});const C=((D=Y.studentRecords[e.identity.studentId])==null?void 0:D.homework.status)||"none";v.className=`homework-status-btn ${C}`,v.title=u[C],v.addEventListener("click",U=>{if(b){U.stopPropagation();return}const Q=Y.studentRecords[e.identity.studentId].homework,$={none:"incomplete",incomplete:"complete",complete:"none"}[Q.status];Y.setHomeworkStatus(e.identity.studentId,$),ie(),v.className=`homework-status-btn ${$}`,v.title=u[$],Hn(e,s,i)}),jt(v,()=>{b=!0;const Q={none:"incomplete",incomplete:"complete",complete:"none"}[C],I=u[Q];be(`آیا از تغییر وضعیت تکلیف تمام دانش‌آموزان به «${I}» مطمئن هستید؟`,()=>{we(A.students).forEach($=>{Y.setHomeworkStatus($.identity.studentId,Q)}),ie(),Qe(),q(`✅ وضعیت تکلیف همه به «${I}» تغییر یافت.`)},{confirmText:"بله",confirmClass:"btn-warning"})});const S=document.createElement("button");let _=!1;S.addEventListener("mousedown",()=>_=!1),S.addEventListener("touchstart",()=>_=!1,{passive:!0}),S.className="btn-icon",S.innerHTML="📝",S.title="افزودن یادداشت برای تکلیف",((M=Y.studentRecords[e.identity.studentId])==null?void 0:M.homework.comment)||(S.style.opacity="0.3"),S.addEventListener("click",U=>{if(_){U.stopPropagation();return}const Q=Y.studentRecords[e.identity.studentId].homework;Ee.value=Q.comment||"",Ee.dispatchEvent(new Event("input",{bubbles:!0})),lt(I=>{Q.comment=I;const $=st(A),g=$.get(Y.sessionNumber),H={type:"fromAttendance",sessionNumber:Y.sessionNumber},ue=`یادداشت جلسه ${g}:
`,Z=e.profile.notes.find(me=>!me.isDeleted&&me.source&&me.source.type==="fromAttendance"&&me.source.sessionNumber===H.sessionNumber);Z?I?Z.content=ue+I:Z.isDeleted=!0:I&&e.addNote(ue+I,H),ie(),q("✅یادداشت تکلیف ذخیره شد."),S.style.opacity=I?"1":"0.3",Hn(e,$,i)}),Ae("add-note-modal"),Ee.focus()}),jt(S,()=>{_=!0,be("آیا می‌خواهید برای **تمام** دانش‌آموزان کلاس یادداشت تکلیف ثبت کنید؟",()=>{const U=we(A.students).map(Q=>Q.identity.studentId);pn(U),xa()},{confirmText:"بله",confirmClass:"btn-primary"})}),l.appendChild(f),y.appendChild(S),y.appendChild(v),l.appendChild(y);const x=document.createElement("div");return x.className="att-row-3",Ua(e,s,c),Hn(e,s,i),x.appendChild(c),x.appendChild(i),t.appendChild(n),t.appendChild(l),t.appendChild(x),t}function $r(){return st(A).get(Y.sessionNumber)}function Qe(){const e=we(A.students),s=En(e);if(!A||!Y)return;s.forEach(o=>{Y.initializeStudentRecord(o.identity.studentId)}),pn([]);const t=st(A);Vr(),rn.innerHTML="";const c=document.createElement("li");c.className="attendance-list-header",Tt.id="attendance-search-input",Tt.type="text",Tt.className="inline-search-input",Tt.placeholder="جستجو...",Tt.value="";const i=document.createElement("div");i.className="student-search-container",i.appendChild(Tt);const n=document.createElement("div");n.className="header-labels-container",n.innerHTML=`
    <span class="header-label">تکلیف</span>
    <span class="header-label">حضور</span>
`,c.appendChild(i),c.appendChild(n),rn.appendChild(c),s.forEach(o=>{const a=Rr(o,t);rn.appendChild(a)}),pn([]),Ia(),Jr(),ao()}function Oe(){const e=document.getElementById("student-stats-table-container");if(!e||(e.innerHTML="",!A))return;we(A.students).length,zs.textContent="آمار عملکرد";const s=["نام"],t=["کل انتخاب ها","غیبت","خروج","فرصت ازدست‌رفته","مشکل","میانگین","نمره نهایی"],c=A.categories.filter(m=>m.isGradedCategory&&!m.isDeleted).map(m=>m.name),i=[...s,...c,...t],n=document.createElement("table");n.className="student-stats-table";const a=n.createTHead().insertRow();i.forEach((m,y)=>{const u=document.createElement("th");y===0?(u.innerHTML=`${m} <span style="opacity: 0.6;">🔗</span>`,u.title="ردیف‌های این ستون قابل کلیک هستند"):u.textContent=m,a.appendChild(u)});const r=n.createTBody(),l=En(we(A.students)),f=m=>{let y=0;return A.sessions.forEach(u=>{if(u.isDeleted||u.isCancelled)return;const v=u.studentRecords[m.identity.studentId];v&&v.attendance==="absent"&&y++}),y};l.forEach(m=>{const y=r.insertRow();if(y.dataset.studentId=m.identity.studentId,Y){const _=Y.studentRecords[m.identity.studentId];_&&_.attendance==="absent"&&y.classList.add("absent-row-highlight")}const u=y.insertCell(),v=document.createElement("span");v.textContent=`${m.identity.lastName}، ${m.identity.firstName}`,v.className="student-name-link",v.addEventListener("click",()=>{je(m)}),u.appendChild(v),c.forEach(_=>{var D;const k=y.insertCell();k.style.direction="ltr";const x=_.toLowerCase(),L=((D=m.logs.scores[x])==null?void 0:D.filter(M=>!M.isDeleted))||[];L.length>0?L.forEach((M,U)=>{const Q=document.createElement("span");Q.textContent=M.value+(M.comment?"'":""),Q.style.position="relative",M.comment&&(Q.dataset.tooltip=M.comment),k.appendChild(Q),U<L.length-1&&k.appendChild(document.createTextNode(","))}):k.textContent="",k.style.cursor="pointer",k.addEventListener("click",()=>{$e(m,_);const M=document.getElementById("category-selection-container");M&&M.scrollIntoView({behavior:"smooth",block:"center"})})}),y.insertCell().textContent=m.statusCounters.totalSelections||0,y.insertCell().textContent=f(m),y.insertCell().textContent=m.statusCounters.outOfClassCount||0,y.insertCell().textContent=m.statusCounters.missedChances||0;const b=Object.values(m.categoryIssues||{}).reduce((_,k)=>_+k,0);y.insertCell().textContent=b;const C=m.getOverallAverageScore();y.insertCell().textContent=C!==null?C:"-";const S=A.calculateFinalStudentScore(m);y.insertCell().textContent=S!==null?S:"-"}),we(A.students),zs.setAttribute("data-student-count",l.length),e.appendChild(n);const p=e.querySelector(".student-stats-table"),h=p==null?void 0:p.querySelector("thead th:first-child");h&&h.addEventListener("click",()=>{p.classList.toggle("name-column-expanded")})}function $e(e=null,s=null){const t=ec(e,s);if(!t)return;const{winner:c,categoryName:i}=t;tc(c,i);const n=document.getElementById("selected-student-result"),o=!e,a=Y.studentRecords[c.identity.studentId],{nameContainer:r}=nc(c,i,o);n.appendChild(r);const l=sc(c,a,i);if(n.appendChild(l),i&&typeof ja=="function"){const p=ja(c,i);p&&n.appendChild(p)}const f=ac(c);n.appendChild(f)}function Ta(e){e.addEventListener("input",()=>{const s=e.value,t=ms(s);e.setAttribute("dir",t)})}function zr(){Ba(null),cn.innerHTML="",Hs.innerHTML="",Ut.classList.add("tooltip-container"),mt.disabled=!0,rt.disabled=!0,Ot.disabled=!0,mt.value="",rt.value="",At.classList.add("disabled-wrapper"),Ke.disabled=!0}function Wn(){cn.innerHTML="",A.categories.filter(t=>!t.isDeleted).forEach(t=>{const c=document.createElement("span");c.className="pill",c.textContent=t.name,c.dataset.categoryId=t.id,t.description&&(c.dataset.tooltip=t.description),Y.isFinished?c.classList.add("disabled"):c.addEventListener("click",()=>{document.querySelectorAll("#category-selection-container .pill").forEach(n=>n.classList.remove("active")),c.classList.add("active"),es(t),Ba(t),Zs(t),bn(t),Kt(t.name),At.classList.remove("disabled-wrapper"),Ke.disabled=Y.isFinished;const i=Y.lastWinnerByCategory[t.name];if(i){const n=A.students.find(o=>o.identity.studentId===i);n&&$e(n,t.name)}else{Hs.innerHTML="",Gt(null),yt(-1),Ke.disabled=!1;const n=document.querySelector(".current-winner-highlight");n&&n.classList.remove("current-winner-highlight")}}),Y.isFinished||c.addEventListener("contextmenu",i=>{_n(i,[{label:"تغییر نام",icon:"✏️",action:()=>{wn(),Us((o,a,r)=>{const l=ci(A,t,o);l.success?(t.isGradedCategory=a,t.weight=r,ie(),_e(A.info.name,`نام دسته‌بندی «${t.name}» به «${o}» تغییر یافت.`),Wn(),Oe(),Zs(t),q(`✅ نام دسته‌بندی به «${o}» تغییر یافت.`)):q(`⚠️ ${l.message}`)},{title:"ویرایش دسته‌بندی",initialName:t.name,initialIsGraded:t.isGradedCategory,initialWeight:t.weight||1,saveButtonText:"ذخیره تغییرات"})}},{label:"حذف دسته‌بندی",icon:"🗑️",className:"danger",action:()=>{be(`آیا از انتقال دسته‌بندی «${t.name}» به سطل زباله مطمئن هستید؟`,()=>{const o={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${t.name}» از کلاس «${A.info.name}»`,restoreData:{categoryId:t.id,classId:A.info.scheduleCode}};ct(o);const a=t.name.toLowerCase();if(A.students.forEach(r=>{r.logs.scores&&r.logs.scores[a]&&r.logs.scores[a].forEach(l=>{l.isDeleted=!0})}),Re&&Re.id===t.id){es(null),Hs.innerHTML="",bn(null),Kt(null),At.classList.add("disabled-wrapper"),Ke.disabled=!0;const r=document.querySelector(".current-winner-highlight");r&&r.classList.remove("current-winner-highlight")}t.isDeleted=!0,_e(A.info.name,`دسته‌بندی «${t.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ie(),Wn(),Oe(),q(`✅ دسته‌بندی «${t.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}}])}),cn.appendChild(c)});const s=document.createElement("span");s.className="pill add-category-pill",s.textContent="+",s.title="افزودن دسته‌بندی جدید",Y.isFinished?s.classList.add("disabled"):s.addEventListener("click",()=>{wn(),Us((t,c,i)=>{if(A.categories.find(a=>a.name.toLowerCase()===t.toLowerCase()&&!a.isDeleted)){q("⚠️ این دسته‌بندی از قبل وجود دارد.");return}const o=new pt(t,"",c,i);A.categories.push(o),ie(),_e(A.info.name,`دسته‌بندی جدید «${t}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),Wn(),q(`✅ دسته‌بندی «${t}» اضافه شد.`)},{initialWeight:1})}),cn.appendChild(s)}function Pr(){if(Y.lastUsedCategoryId){if(Y.isFinished)return;const e=cn.querySelector(`.pill[data-category-id="${Y.lastUsedCategoryId}"]`);e&&e.click()}Y.winnerHistory&&Y.winnerHistory.length>0&&(yt(Y.winnerHistory.length-1),$e())}function Ba(e){e?Ke.textContent=`نفر بعدی در ${e.name}`:Ke.textContent="نفر بعدی"}function Zs(e){e&&e.isGradedCategory?($n.textContent=`ضریب: ${e.weight||1}`,$n.style.display="block"):$n.style.display="none"}function bn(e){if(Y.isFinished){mt.disabled=!0,rt.disabled=!0,Ot.disabled=!0,Ut.setAttribute("title","جلسه خاتمه یافته است");return}e&&e.isGradedCategory?(mt.disabled=!1,rt.disabled=!1,Ot.disabled=!1,Ut.removeAttribute("title")):(mt.disabled=!0,rt.disabled=!0,Ot.disabled=!0,e?Ut.setAttribute("title","برای این دسته‌بندی قابلیت نمره دهی تعریف نشده است"):Ut.setAttribute("title","ابتدا یک دسته‌بندی را انتخاب کنید"))}function Kt(e){const s=document.querySelector(".student-stats-table");if(!s||(s.querySelectorAll(".current-category-highlight").forEach(o=>{o.classList.remove("current-category-highlight")}),!e))return;let c=-1;const i=s.querySelectorAll("thead th");if(i.forEach((o,a)=>{o.textContent.trim()===e&&(c=a)}),c===-1)return;i[c].classList.add("current-category-highlight"),s.querySelectorAll("tbody tr").forEach(o=>{const a=o.cells[c];a&&a.classList.add("current-category-highlight")})}function je(e){St(e);const s=document.getElementById("student-profile-modal"),t=document.getElementById("modal-profile-student-name"),c=document.getElementById("modal-profile-content-container"),i=document.getElementById("modal-profile-close-btn");if(!s||!t||!c||!i)return;t.textContent=`پروفایل: ${e.identity.name}`,t.style.cursor="pointer",t.onclick=()=>{const l=Le,f=A;he(()=>{ka(l,f)})},c.innerHTML="";const n=document.createElement("div");n.className="profile-header-actions";const o=document.createElement("button");o.className="btn-icon btn-icon-label",o.title="انتقال دانش‌آموز",o.innerHTML="<span>➡️</span><span>انتقال</span>",o.addEventListener("click",()=>{const l=Le,f=A;he(()=>{_a(l,f)})});const a=document.createElement("button");a.className="btn-icon btn-icon-label",a.title="حذف دانش‌آموز",a.innerHTML="<span>🗑️</span><span>حذف</span>",a.style.color="var(--color-strong-warning)",a.addEventListener("click",()=>{const l=Le,f=A;he(()=>{be(`آیا از انتقال دانش‌آموز «${l.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const p={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${l.identity.name}» از کلاس «${f.info.name}»`,restoreData:{studentId:l.identity.studentId,classId:f.info.scheduleCode}};ct(p),l.isDeleted=!0,_e(f.info.name,`دانش‌آموز «${l.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ie(),kt(),Oe(),Qe(),q(`✅ دانش‌آموز «${l.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0,onCancel:()=>{je(l)}})})});const r=document.createElement("button");r.className="btn-icon btn-icon-label",r.title="افزودن یادداشت جدید",r.innerHTML="<span>📝</span><span>یادداشت</span>",r.addEventListener("click",()=>{const l=Le;Ee.value="",Ee.dispatchEvent(new Event("input",{bubbles:!0})),lt(f=>{if(f)return l.addNote(f),ie(),_e(A.info.name,`یادداشت جدیدی برای دانش‌آموز «${l.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:l.identity.studentId}),$e(),q("✅ یادداشت با موفقیت ثبت شد."),()=>je(l)}),he(()=>{Ae("add-note-modal"),Ee.focus()})}),n.appendChild(o),n.appendChild(a),n.appendChild(r),c.appendChild(n),Fr(c),Qi(c),i.onclick=()=>he(),Ae("student-profile-modal")}function Fr(e){if(!Le||!A)return;const s=document.createElement("div");s.className="scoring-section",s.innerHTML=`
    <h3>ثبت نمره جدید</h3>
    <div id="modal-graded-pills" class="category-pills"></div>
    <div class="input-group" style="margin-top: 15px; display: flex; gap: 10px;">
        <input type="number" id="modal-new-score-value" placeholder="نمره" style="width: 70px; text-align: center;">
        <input type="text" id="modal-new-score-comment" placeholder="توضیحات (اختیاری)..." style="flex-grow: 1;">
    </div>
    <button id="modal-add-score-btn" class="btn-success" style="width: 100%; margin-top: 10px;">ثبت نمره</button>
`,Ta(s.querySelector("#modal-new-score-comment"));const t=s.querySelector("#modal-graded-pills");we(A.categories).filter(n=>n.isGradedCategory).forEach(n=>{const o=document.createElement("span");o.className="pill",o.textContent=n.name,o.dataset.skillName=n.name,o.addEventListener("click",()=>{t.querySelectorAll(".pill").forEach(a=>a.classList.remove("active")),o.classList.add("active")}),t.appendChild(o)}),s.querySelector("#modal-add-score-btn").addEventListener("click",()=>{const n=t.querySelector(".pill.active");if(!n){q("⚠️لطفاً یک مهارت را برای نمره‌دهی انتخاب کنید.");return}const o=n.dataset.skillName,a=s.querySelector("#modal-new-score-value"),r=s.querySelector("#modal-new-score-comment"),l=a.value,f=r.value.trim();if(!l){q("لطفاً مقدار نمره را وارد کنید.");return}Le.addScore(o,parseFloat(l),f),ie(),_e(A.info.name,`نمره ${l} در ${o} برای «${Le.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:Le.identity.studentId}),Oe(),$e(),a.value="",r.value="";const p=document.getElementById("modal-profile-content-container"),h=p.querySelector(".history-section");h&&h.remove(),Qi(p),q(`✅ نمره برای مهارت ${o} با موفقیت ثبت شد.`)}),e.appendChild(s)}function Qi(e){if(!Le)return;const s=document.createElement("div");s.className="history-section";const t=document.createElement("div");t.className="history-section-header";const c=document.createElement("h3");c.textContent="سوابق دانش‌آموز",t.appendChild(c),s.appendChild(t),Hr(s),eo(s),to(s),e.appendChild(s)}function Hr(e){if(!Le)return;const s=Le,t=A.sessions.reduce((_,k)=>{const x=k.studentRecords[s.identity.studentId];return _+(x&&x.attendance==="absent"?1:0)},0),c=Object.values(s.categoryIssues||{}).reduce((_,k)=>_+k,0);let i=0,n=0,o=0;const a=s.qualitativeStats||{};Object.values(a).forEach(_=>{i+=_.effort||0,n+=_.good||0,o+=_.excellent||0});const r=i+n+o,l=document.createElement("div");l.className="stats-summary-box",l.innerHTML=`
        <p><strong>کل انتخاب:</strong> ${s.statusCounters.totalSelections}</p>
        <p><strong>غیبت:</strong> ${t}</p>
        <p><strong>فرصت از دست رفته:</strong> ${s.statusCounters.missedChances||0}</p>
        <p><strong>مشکل:</strong> ${c}</p>
        <p><strong>عملکرد کیفی:</strong> ${r}</p>
    `,e.appendChild(l),l.querySelector("p:nth-child(1)");const f=l.querySelector("p:nth-child(4)"),p=l.querySelector("p:nth-child(5)");e.appendChild(l);const h=we(A.categories),m=document.createElement("div");if(m.className="stats-breakdown",h.length>0){h.forEach(k=>{var M;const x=k.name,L=((M=s.categoryCounts)==null?void 0:M[x])||0,D=document.createElement("p");D.className="stats-breakdown-item",D.innerHTML=`<strong>${x}:</strong> ${L}`,m.appendChild(D)});const _=l.querySelector("p:first-child");_&&(_.classList.add("collapsible-toggle"),_.onclick=()=>{m.classList.toggle("open"),_.classList.toggle("open")},_.after(m))}const y=document.createElement("div");y.className="stats-breakdown",h.length>0&&(h.forEach(_=>{var D;const k=_.name,x=((D=s.categoryIssues)==null?void 0:D[k])||0,L=document.createElement("p");L.className="stats-breakdown-item",L.innerHTML=`<strong>${k}:</strong> ${x}`,y.appendChild(L)}),f&&c>0&&(f.classList.add("collapsible-toggle"),f.onclick=()=>{y.classList.toggle("open"),f.classList.toggle("open")},f.after(y)));const u=document.createElement("div");if(u.className="stats-breakdown",r>0){for(const _ in a){const k=a[_];if((k.effort||0)+(k.good||0)+(k.excellent||0)>0){const L=document.createElement("p");L.className="stats-breakdown-item",L.innerHTML=`<strong>${_}:</strong> <span style="color:var(--color-primary)">عالی:${k.excellent}</span> | <span style="color:var(--color-success)">خوب:${k.good}</span> | <span style="color:#fd7e14">تلاش:${k.effort}</span>`,u.appendChild(L)}}p&&r>0&&(p.classList.add("collapsible-toggle"),p.onclick=()=>{u.classList.toggle("open"),p.classList.toggle("open")},p.after(u))}const v=document.createElement("p"),b=document.createElement("strong");b.textContent="تکالیف ناقص:";const C=document.createElement("span");C.style.marginRight="5px";const S=st(A);Hn(s,S,C,{includePrefix:!1}),v.appendChild(b),v.appendChild(C),l.appendChild(v)}function eo(e){if(!Le)return;const s=Le,t=document.createElement("h4");t.textContent="تاریخچه نمرات:",t.style.marginTop="20px";const c=s.getOverallAverageScore(),i=document.createElement("span");i.className="profile-avg-badge",i.textContent=` (میانگین: ${c!==null?c:"-"})`,t.appendChild(i);const n=A.calculateFinalStudentScore(s),o=document.createElement("span");o.className="profile-avg-badge",o.textContent=` (نمره نهایی: ${n!==null?n:"-"})`,t.appendChild(o);const a=document.createElement("ul");a.className="list-container";const r=Object.values(s.logs.scores||{}).flat().filter(l=>!l.isDeleted).sort((l,f)=>new Date(f.timestamp)-new Date(l.timestamp));r.length===0?a.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>':r.forEach(l=>{const f=document.createElement("li");f.className="score-history-item";const p=document.createElement("div");p.className="item-content";const h=document.createElement("div");h.className="score-info";const m=document.createElement("span");m.className="score-skill-badge",m.textContent=l.skill;const y=document.createElement("span");y.className="score-value",y.textContent=`نمره: ${l.value}`;const u=document.createElement("span");if(u.className="score-date",u.textContent=new Date(l.timestamp).toLocaleDateString("fa-IR"),h.appendChild(m),h.appendChild(y),h.appendChild(u),p.appendChild(h),l.comment){const b=document.createElement("p");b.className="score-comment",b.innerHTML=va(l.comment),b.addEventListener("click",()=>{Ee.value=l.comment,Ee.dispatchEvent(new Event("input",{bubbles:!0})),lt(C=>{l.comment=C,ie(),_e(A.info.name,`توضیحات نمره ${l.value} (${l.skill}) برای دانش‌آموز «${s.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:s.identity.studentId}),je(s),q("✅ توضیحات نمره با موفقیت ویرایش شد.")}),he(()=>{Ae("add-note-modal"),Ee.focus()})}),p.appendChild(b)}const v=document.createElement("button");v.className="btn-icon delete-item-btn",v.innerHTML="🗑️",v.title="حذف این نمره",v.addEventListener("click",()=>{he(()=>{be(`آیا از انتقال نمره ${l.value} در مهارت «${l.skill}» برای دانش آموز «${s.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const b={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"score",description:`نمره ${l.value} (${l.skill}) برای «${s.identity.name}»`,restoreData:{scoreId:l.id,skill:l.skill,studentId:s.identity.studentId,classId:A.info.scheduleCode}};ct(b),l.isDeleted=!0,ie(),_e(A.info.name,`نمره ${l.value} (${l.skill}) دانش‌آموز «${s.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),je(s),q(`✅ نمره دانش آموز ${s.identity.name} به سطل زباله منتقل شد.`)},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{je(s)}})})}),f.appendChild(p),f.appendChild(v),a.appendChild(f)}),e.appendChild(t),e.appendChild(a)}function to(e){if(!Le)return;const s=document.createElement("h4");s.textContent="تاریخچه یادداشت‌ها:",s.style.marginTop="20px";const t=document.createElement("ul");t.className="list-container",!Le.profile.notes||Le.profile.notes.length===0?t.innerHTML='<div class="no-content-message">هنوز یادداشتی ثبت نشده است.</div>':[...Le.profile.notes].filter(i=>!i.isDeleted).sort((i,n)=>new Date(n.timestamp)-new Date(i.timestamp)).forEach(i=>{const n=document.createElement("li");n.className="note-history-item";const o=document.createElement("div");o.className="item-content";const a=document.createElement("div");a.className="note-info";const r=document.createElement("span");r.className="note-date",r.textContent=new Date(i.timestamp).toLocaleDateString("fa-IR");const l=document.createElement("button");l.className="btn-icon delete-item-btn",l.innerHTML="🗑️",l.title="حذف این یادداشت",l.addEventListener("click",()=>{const p=Le;he(()=>{be("آیا از انتقال این یادداشت به سطل زباله مطمئن هستید؟",()=>{const h={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"note",description:`یادداشت برای دانش‌آموز «${p.identity.name}»`,restoreData:{noteId:i.id,studentId:p.identity.studentId,classId:A.info.scheduleCode}};ct(h),i.isDeleted=!0,_e(A.info.name,`یادداشت دانش‌آموز «${p.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ie(),je(p),q("✅ یادداشت به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{je(p)}})})}),a.appendChild(r),a.appendChild(l);const f=document.createElement("p");f.className="note-content",f.innerHTML=va(i.content),f.addEventListener("click",()=>{const p=Le;Ee.value=i.content,Ee.dispatchEvent(new Event("input",{bubbles:!0})),lt(h=>{i.content=h,ie(),_e(A.info.name,`یادداشت دانش‌آموز «${p.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:p.identity.studentId}),je(p),q("✅یادداشت با موفقیت ویرایش شد.")}),he(()=>{Ae("add-note-modal"),Ee.focus()})}),o.appendChild(a),o.appendChild(f),n.appendChild(o),t.appendChild(n)}),e.appendChild(s),e.appendChild(t)}function no(e){Rs.innerHTML="",e.forEach((s,t)=>{const c=document.createElement("option");c.value=t,c.textContent=s.trim(),Rs.appendChild(c)})}function Gs(){Ms.innerHTML="",Ys.forEach(e=>{const s=document.createElement("li");s.className="preview-item";const t=document.createElement("input");t.type="checkbox",t.checked=!0,t.dataset.name=e;const c=document.createElement("label");c.textContent=e,s.appendChild(t),s.appendChild(c),Ms.appendChild(s)})}function Wr(e){const s=document.createElement("div");s.className="list-item-buttons";const t=document.createElement("button");return t.className="btn-icon",t.innerHTML="📝",t.title="ویرایش یادداشت کلاس",e.note||(t.style.display="none"),t.addEventListener("click",c=>{c.stopPropagation(),ps(e)}),s.appendChild(t),s}function Ur(e){const s=document.createElement("div");s.style.flexGrow="1",s.style.display="flex",s.style.flexDirection="column",s.style.alignItems="flex-start";const t=document.createElement("span");t.textContent=e.info.name,t.classList.add("class-name-display"),s.appendChild(t);const c=we(e.students).length,i=we(e.sessions).filter(l=>l.isFinished).length,n=Yr(e.info.scheduleDays),o=document.createElement("div");o.classList.add("class-stats-row");const a=document.createElement("span");a.textContent=`${c} نفر`,a.classList.add("student-count-badge"),o.appendChild(a);const r=document.createElement("span");if(r.textContent=`${i} جلسه`,r.classList.add("session-count-badge"),o.appendChild(r),n){const l=document.createElement("span");l.textContent=n,l.classList.add("schedule-days-badge"),o.appendChild(l)}return s.appendChild(o),s.addEventListener("click",()=>{Je(e),at(null),fn(A.liveSession),Ze(),ke("session-page")}),s}function jr(e){const s=document.createElement("li");ds(e).type==="active"&&(s.classList.add("active-class-card"),s.title="این کلاس هم‌اکنون در حال برگزاری است");const c=document.createElement("input");c.type="checkbox",c.className="mass-selection-checkbox",c.checked=tt.includes(e.info.name),c.addEventListener("click",f=>{f.stopPropagation()}),c.addEventListener("change",()=>{const f=e.info.name;if(c.checked)tt.includes(f)||tt.push(f);else{const p=tt.indexOf(f);p>-1&&tt.splice(p,1)}}),s.appendChild(c);const i=Ur(e);s.appendChild(i);const n=document.createElement("div");n.style.display="flex",n.style.flexDirection="column",n.style.gap="5px",n.style.alignItems="flex-end",n.style.marginLeft="10px";const o=document.createElement("div");if(o.className="list-item-badges",e.liveSession&&!e.liveSession.isCancelled&&!e.liveSession.isDeleted){const f=document.createElement("span");f.className="warning-badge",f.textContent="جلسه باز",o.appendChild(f),s.classList.add("has-unfinished-session")}const a=document.createElement("span");if(a.className=`type-badge ${e.info.type}`,a.textContent=e.info.type==="online"?"آنلاین":"حضوری",a.title="نوع کلاس",o.appendChild(a),ds(e).type==="incomplete"){const f=document.createElement("span");f.className="type-badge cancelled-badge",f.textContent="زمان‌بندی ناقص",f.style.cursor="pointer",f.title="برای تکمیل زمان‌بندی کلیک کنید",f.addEventListener("click",p=>{p.stopPropagation(),be("زمان‌بندی این کلاس کامل نیست. برای نمایش صحیح در لیست، لطفاً روزها و ساعت برگزاری را مشخص کنید.",()=>{_t(e)},{confirmText:"تنظیمات",confirmClass:"btn-primary"})}),o.appendChild(f)}else{const f=Kr(e,se);if(f){const p=document.createElement("span");p.className="type-badge conflict-badge",p.textContent="تداخل زمانی",p.style.cursor="pointer",p.title=`تداخل با کلاس: ${f}`,p.addEventListener("click",h=>{h.stopPropagation(),be(`زمان برگزاری این کلاس با کلاس «${f}» تداخل دارد. لطفاً زمان‌بندی را بررسی کنید.`,()=>{_t(e)},{confirmText:"تنظیمات",confirmClass:"btn-primary"})}),o.appendChild(p)}}n.appendChild(o);const l=Wr(e);return n.appendChild(l),s.appendChild(n),s.addEventListener("contextmenu",f=>{const p={label:"پشتیبان‌گیری از این کلاس",icon:"📤",action:()=>{vn([e.info.name])}},h=tt.length;h>1&&tt.includes(e.info.name)&&(p.label=`پشتیبان‌گیری از ${h} کلاس`,p.action=()=>{vn(tt),Mn([]),Fe()});const m={label:"حذف کلاس",icon:"🗑️",className:"danger",action:()=>{be(`آیا از انتقال کلاس «${e.info.name}» به سطل زباله مطمئن هستید؟`,()=>{const u={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"classroom",description:`کلاس «${e.info.name}»`,restoreData:{name:e.info.name}};ct(u),e.isDeleted=!0,_e(e.info.name,`کلاس «${e.info.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ie(),Fe(),q(`✅ کلاس «${e.info.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}};h>1&&tt.includes(e.info.name)&&(m.label=`حذف ${h} کلاس`,m.action=()=>{be(`آیا از انتقال ${h} کلاس انتخاب شده به سطل زباله مطمئن هستید؟`,()=>{tt.forEach(u=>{const v=se[u];if(v&&!v.isDeleted){const b={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"classroom",description:`کلاس «${v.info.name}»`,restoreData:{name:v.info.name}};ct(b),v.isDeleted=!0,_e(v.info.name,`کلاس «${v.info.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"})}}),Mn([]),ie(),Fe(),q(`✅ ${h} کلاس به سطل زباله منتقل شدند.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})});const y=[{label:"چاپ گزارش کلاس",icon:"🖨️",action:()=>{Qr(e)}},{label:Nt.classList.contains("selection-mode-active")?"لغو انتخاب":"انتخاب چند کلاس",icon:"✔️",action:()=>{const u=Nt.classList.contains("selection-mode-active");Nt.classList.toggle("selection-mode-active"),u&&(Mn([]),Fe())}},p,{label:"یادداشت کلاس",icon:"📝",action:()=>{ps(e)}},{label:"تنظیمات کلاس",icon:"⚙️",action:()=>{_t(e)}},{label:"گزارش فعالیت‌ها",icon:"📋",action:()=>{Yi(e.info.name)}},{label:"تغییر نام",icon:"✏️",action:()=>{const u=e.info.name,v=document.getElementById("add-note-modal-title");v.textContent="تغییر نام کلاس",Ee.value=u,Ee.rows=1,lt(b=>{const C=b.trim();if(C&&C!==u){const S=ri(u,C);S.success?(To(u,C),_e(C,`نام کلاس از «${u}» به «${C}» تغییر یافت.`,{type:"VIEW_SESSIONS"}),ie(),Fe(),q(`✅نام کلاس به «${C}» تغییر یافت.`)):q(S.message)}v.textContent="ثبت یادداشت جدید",Ee.rows=4}),Ae("add-note-modal"),Ee.focus(),Ee.select()}},m];_n(f,y)}),s}function gs(){const e=document.getElementById("class-management-stats");if(!e)return;const s=Object.values(se).filter(n=>!n.isDeleted),t=s.length,c=s.reduce((n,o)=>n+we(o.students).length,0);let i="";ze.lastBackupTimestamp&&(i=`
            <div class="stats-row backup-stat">
                <span>آخرین پشتیبان: <strong>${new Date(ze.lastBackupTimestamp).toLocaleString("fa-IR",{year:"numeric",month:"numeric",day:"numeric",weekday:"long",hour:"2-digit",minute:"2-digit"})}</strong></span>
            </div>
        `),e.innerHTML=`
        <div class="stats-row main-stats">
            <span>کل کلاس‌ها: <strong>${t}</strong></span>
            <span>|</span>
            <span>کل دانش‌آموزان: <strong>${c}</strong></span>
        </div>
        ${i} 
    `}function Fe(){gs(),Nt.innerHTML="";const e=Object.values(se).filter(i=>!i.isDeleted),s=document.querySelector(".fab-container"),t=document.querySelector(".global-search-container");if(e.length===0){s&&s.classList.add("center-empty-state"),t&&(t.style.display="none"),Nt.innerHTML='<li class="no-content-message" style="text-align:center; margin-top:20px;">هنوز کلاسی ایجاد نشده است.</li>';return}else s&&s.classList.remove("center-empty-state"),t&&(t.style.display="");e.sort((i,n)=>{const o=ds(i),a=ds(n);return o.sortIndex!==a.sortIndex?o.sortIndex-a.sortIndex:o.type==="upcoming"?o.nextTimestamp-a.nextTimestamp:new Date(i.info.creationDate)-new Date(n.info.creationDate)}).forEach(i=>{const n=jr(i);Nt.appendChild(n)})}function kt(){if(!A)return;As.innerHTML="";const e=we(A.students);En(e).forEach(t=>{const c=document.createElement("li");c.dataset.studentId=t.identity.studentId;const i=document.createElement("span");i.className="student-name-link",i.style.flexGrow="1",t.identity.firstName&&t.identity.lastName?i.textContent=`${t.identity.lastName}، ${t.identity.firstName}`:i.textContent=t.identity.name,i.addEventListener("click",()=>{je(t)}),c.addEventListener("contextmenu",n=>{_n(n,[{label:"تغییر نام",icon:"✏️",action:()=>{ka(t,A)}},{label:"انتقال دانش‌آموز",icon:"➡️",action:()=>{_a(t,A)}},{label:"حذف دانش‌آموز",icon:"🗑️",className:"danger",action:()=>{be(`آیا از انتقال دانش‌آموز «${t.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const a={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${t.identity.name}» از کلاس «${A.info.name}»`,restoreData:{studentId:t.identity.studentId,classId:A.info.scheduleCode}};ct(a),t.isDeleted=!0,_e(A.info.name,`دانش‌آموز «${t.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ie(),kt(),Oe(),Qe(),q(`✅ دانش‌آموز «${t.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}}])}),c.appendChild(i),As.appendChild(c)})}function Yt(){if(Os.innerHTML="",!A)return;A.categories.filter(s=>!s.isDeleted).forEach(s=>{const t=document.createElement("li"),c=document.createElement("div");c.className="name-and-badge-container";const i=document.createElement("span");if(i.textContent=s.name,c.appendChild(i),s.isGradedCategory){const o=document.createElement("span");o.className="category-badge",o.textContent="نمره‌دار",c.appendChild(o)}if(s.isGradedCategory){const o=document.createElement("span");o.className="category-badge weight-badge",o.textContent=`ضریب: ${s.weight||1}`,c.appendChild(o)}const n=document.createElement("button");n.className="btn-icon",n.innerHTML="🗑️",n.style.color="var(--color-warning)",n.addEventListener("click",()=>{be(`آیا از انتقال دسته‌بندی «${s.name}» به سطل زباله مطمئن هستید؟`,()=>{const o={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${s.name}» از کلاس «${A.info.name}»`,restoreData:{categoryId:s.id,classId:A.info.scheduleCode}};ct(o),s.isDeleted=!0,_e(A.info.name,`دسته‌بندی «${s.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ie(),Yt(),q(`✅ دسته‌بندی «${s.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}),t.appendChild(c),t.appendChild(n),Os.appendChild(t)})}function so(){if(!A)return;const e=A;Da(Fn,sn,e.info.educationalSystem,e.info.level),Fn.addEventListener("change",()=>{e.info.educationalSystem=Fn.value,e.info.level=sn.value,ie()}),sn.addEventListener("change",()=>{e.info.level=sn.value,ie()});const s=e.info.type||"in-person",t=document.querySelector(`#settings-page input[name="class-type-setting"][value="${s}"]`);t&&(t.checked=!0);const c=e.info.scheduleDays||[];document.querySelectorAll('input[name="schedule-day"]').forEach(i=>{i.checked=c.includes(parseInt(i.value))}),document.getElementById("settings-schedule-start").value=e.info.scheduleStartTime||"",document.getElementById("settings-schedule-end").value=e.info.scheduleEndTime||""}function ls(e){document.querySelectorAll(".page").forEach(t=>{t.classList.remove("active")});const s=document.getElementById(e);s&&s.classList.add("active"),e==="class-management-page"?(Fe(),$s.style.display="flex"):$s.style.display="none",Xi()}function ke(e,s={}){const{tab:t}=s;let c=`#${e}`;const i=new URLSearchParams;A&&i.set("class",A.info.name),Y&&i.set("session",Y.sessionNumber),Le&&i.set("student",Le.identity.studentId),e==="session-dashboard-page"&&t&&i.set("tab",t);const n=i.toString();n&&(c+=`?${n}`),window.location.hash!==c&&history.pushState({pageId:e},"",c),ls(e)}function qr(e,s){const t=document.createElement("div");t.className="list-item-buttons",t.style.gap="10px";const c=document.createElement("button");if(c.className="btn-icon",c.innerHTML="📝",c.title="ویرایش یادداشت جلسه",e.note||(c.style.display="none"),c.addEventListener("click",i=>{i.stopPropagation(),La(e,s)}),!e.isFinished&&!e.isCancelled){const i=document.createElement("button");i.className="btn-success",i.textContent="پایان جلسه",i.style.fontSize="12px",i.style.padding="4px 10px",i.style.whiteSpace="nowrap",i.addEventListener("click",n=>{n.stopPropagation(),be(`جلسه شماره ${s} خاتمه پیدا خواهد کرد!`,()=>{A.endSpecificSession(e.sessionNumber),ie(),_e(A.info.name,`جلسه ${s} خاتمه یافت.`,{type:"VIEW_SESSIONS"}),Ze(),be("جلسه با موفقیت خاتمه یافت. آیا مایل به ایجاد فایل پشتیبان هستید؟",()=>{if(ut){q("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است.");return}vn(),q("✅فایل پشتیبان با موفقیت ایجاد شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}),t.appendChild(i)}return t.appendChild(c),t}function Zr(e,s){const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="flex-start",t.style.flexGrow="1";const c=new Date(e.startTime).toLocaleDateString("fa-IR"),i=document.createElement("span");i.className="session-list-title";const n=document.createElement("div");n.style.display="flex",n.style.gap="5px",n.style.marginTop="5px";const o=new Date(e.startTime).toLocaleDateString("fa-IR",{weekday:"long"}),a=document.createElement("span");if(a.className="type-badge day-badge",a.textContent=o,n.appendChild(a),e.isCancelled){i.textContent=`لغو شده - تاریخ: ${c}`,t.style.cursor="default";const r=document.createElement("span");r.className="type-badge cancelled-badge",r.textContent="لغو شده",n.appendChild(r)}else i.textContent=`جلسه ${s} - تاریخ: ${c}`,t.style.cursor="pointer",t.addEventListener("click",()=>{at(e),Sn()});if(t.appendChild(i),e.isFinished){const r=document.createElement("span");r.className="type-badge finished-badge",r.textContent="خاتمه یافته",n.appendChild(r)}if(e.isMakeup){const r=document.createElement("span");r.className="type-badge makeup-badge",r.textContent="جبرانی",n.appendChild(r)}return t.appendChild(n),t}function Gr(e,s){const t=document.createElement("li"),c=s.get(e.sessionNumber),i=Zr(e,c);t.appendChild(i);const n=qr(e,c);return t.appendChild(n),t.addEventListener("contextmenu",o=>{const a=[{label:"یادداشت جلسه",icon:"📝",action:()=>{La(e,c)}},{label:e.isCancelled?"بازگردانی جلسه":"لغو جلسه",icon:"❌",action:()=>{const r=e.isCancelled?"بازگردانی جلسه":"لغو جلسه",l=e.isCancelled?"آیا از بازگردانی این جلسه مطمئن هستید؟":"آیا از لغو این جلسه مطمئن هستید؟ جلسه لغو شده در آمار تاثیری ندارد اما قابل بازگردانی است.";be(l,()=>{e.isCancelled=!e.isCancelled;const f=e.isCancelled?`جلسه ${c} لغو شد.`:`جلسه لغو شده (تاریخ: ${new Date(e.startTime).toLocaleDateString("fa-IR")}) بازگردانی شد.`;_e(A.info.name,f,{type:"VIEW_SESSIONS"}),ie(),Ze(),q(e.isCancelled?"✅جلسه لغو شد.":"✅جلسه بازگردانی شد.")},{confirmText:r,confirmClass:"btn-warning"})}},{label:"تغییر وضعیت جبرانی",icon:"🔄",action:()=>{A.markAsMakeup(e.sessionNumber),ie();const r=e.isMakeup?`جلسه ${c} به عنوان جبرانی علامت‌گذاری شد.`:`جلسه ${c} از حالت جبرانی خارج شد.`;_e(A.info.name,r,{type:"VIEW_SESSIONS"}),Ze()}},{label:"حذف جلسه",icon:"🗑️",className:"danger",action:()=>{const r=e.isCancelled?"لغو شده":c;be(`آیا از انتقال جلسه ${r} به سطل زباله مطمئن هستید؟`,()=>{const l={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"session",description:`جلسه ${r} از کلاس «${A.info.name}»`,restoreData:{sessionNumber:e.sessionNumber,classId:A.info.scheduleCode}};ct(l),e.isDeleted=!0,_e(A.info.name,`جلسه ${r} به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ie(),Ze(),q(`✅ جلسه ${r} به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}},{label:"تغییر تاریخ",icon:"📅",action:()=>{const r=document.getElementById("dp-day"),l=document.getElementById("dp-month"),f=document.getElementById("dp-year"),p=Wa.toJalaali(e.startTime);r.innerHTML="";for(let y=1;y<=31;y++){const u=document.createElement("option");u.value=y,u.textContent=y.toLocaleString("fa-IR"),y===p.jd&&(u.selected=!0),r.appendChild(u)}const h=["فروردین","اردیبهشت","خرداد","تیر","مرداد","شهریور","مهر","آبان","آذر","دی","بهمن","اسفند"];l.innerHTML="",h.forEach((y,u)=>{const v=document.createElement("option");v.value=u+1,v.textContent=y,u+1===p.jm&&(v.selected=!0),l.appendChild(v)}),f.innerHTML="";const m=p.jy;for(let y=m-5;y<=m+5;y++){const u=document.createElement("option");u.value=y,u.textContent=y.toString().replace(/\d/g,v=>"۰۱۲۳۴۵۶۷۸۹"[v]),y===p.jy&&(u.selected=!0),f.appendChild(u)}ts(y=>{if(!y)return;const u=Wa.toGregorian(parseInt(y.jy),parseInt(y.jm),parseInt(y.jd)),v=new Date(u.gy,u.gm-1,u.gd);v.setHours(e.startTime.getHours()),v.setMinutes(e.startTime.getMinutes()),v.setSeconds(e.startTime.getSeconds());const b=e.startTime.toLocaleDateString("fa-IR");e.startTime=v;const C=e.startTime.toLocaleDateString("fa-IR");_e(A.info.name,`تاریخ جلسه ${c} از ${b} به ${C} تغییر یافت.`,{type:"VIEW_SESSIONS"}),ie(),Ze(),q(`✅ تاریخ جلسه به ${C} تغییر یافت.`)}),Ae("date-picker-modal")}}];_n(o,a)}),t}function Ze(){const e=document.getElementById("session-list");if(!A)return;if(e.innerHTML="",A.sessions.length===0){e.innerHTML="<li>هنوز جلسه‌ای شروع نشده است.</li>";return}const s=st(A);[...we(A.sessions)].reverse().forEach(c=>{const i=Gr(c,s);e.appendChild(i)})}function on(e){if(Ct.innerHTML="",e.length>0)e.forEach(s=>{const t=document.createElement("div");t.textContent=s.identity.name,t.addEventListener("click",()=>{je(s),Ct.style.display="none",Fs.value=""}),Ct.appendChild(t)}),Ct.style.display="block";else if(Fs.value.trim()!==""){const s=document.createElement("div");s.className="no-results",s.textContent="پیدا نشد",Ct.appendChild(s),Ct.style.display="block"}else Ct.style.display="none"}function Un(e){if(dt.innerHTML="",e.length>0)e.forEach(s=>{const t=document.createElement("div");if(t.className="global-search-result",s.type==="student"){const c=document.createElement("span");c.className="student-name",c.textContent=s.student.identity.name;const i=document.createElement("span");i.className="class-name",i.textContent=`کلاس: ${s.classroom.info.name}`,t.addEventListener("click",()=>{Je(s.classroom),je(s.student),dt.style.display="none",nn.value=""}),i.addEventListener("click",n=>{n.stopPropagation(),Je(s.classroom),at(null),fn(s.classroom.liveSession),Ze(),ke("session-page"),dt.style.display="none",nn.value=""}),t.appendChild(c),t.appendChild(i)}else if(s.type==="classroom"){const c=document.createElement("span");c.className="student-name",c.textContent=`[کلاس] ${s.classroom.info.name}`,t.addEventListener("click",()=>{Je(s.classroom),at(null),fn(s.classroom.liveSession),Ze(),ke("session-page"),dt.style.display="none",nn.value=""}),t.appendChild(c)}dt.appendChild(t)}),dt.style.display="block";else if(nn.value.trim()!==""){const s=document.createElement("div");s.className="no-results",s.textContent="پیدا نشد",dt.appendChild(s),dt.style.display="block"}else dt.style.display="none"}function Cn(){const e=document.getElementById("trashed-items-list");if(e.innerHTML="",Ue.length===0){e.innerHTML='<li style="text-align: center; padding: 20px;">سطل زباله خالی است.</li>';return}Ue.forEach((s,t)=>{const c=document.createElement("li"),i=document.createElement("span");i.textContent=s.description,i.style.flexGrow="1";const n=document.createElement("div");n.className="list-item-buttons";const o=document.createElement("button");o.className="btn-icon",o.innerHTML="🔄",o.title="بازیابی",o.addEventListener("click",()=>{var p;let r=!1,l=null;const f=s.restoreData;switch(s.type){case"classroom":{const h=se[f.name];h&&!h.isDeleted?l=`کلاسی با نام «${f.name}» از قبل فعال است.`:h&&h.isDeleted&&(h.isDeleted=!1,r=!0);break}case"student":{const h=Object.values(se).find(y=>y.info.scheduleCode===f.classId),m=h==null?void 0:h.students.find(y=>y.identity.studentId===f.studentId);m&&(m.isDeleted=!1,r=!0);break}case"session":{const h=Object.values(se).find(y=>y.info.scheduleCode===f.classId),m=h==null?void 0:h.sessions.find(y=>y.sessionNumber===f.sessionNumber);m&&(m.isDeleted=!1,r=!0);break}case"category":{const h=Object.values(se).find(y=>y.info.scheduleCode===f.classId),m=h==null?void 0:h.categories.find(y=>y.id===f.categoryId);m&&(m.isDeleted=!1,r=!0);break}case"score":{const h=Object.values(se).find(u=>u.info.scheduleCode===f.classId),m=h==null?void 0:h.students.find(u=>u.identity.studentId===f.studentId),y=(p=m==null?void 0:m.logs.scores[f.skill.toLowerCase()])==null?void 0:p.find(u=>u.id===f.scoreId);y&&(y.isDeleted=!1,r=!0);break}case"note":{const h=Object.values(se).find(u=>u.info.scheduleCode===f.classId),m=h==null?void 0:h.students.find(u=>u.identity.studentId===f.studentId),y=m==null?void 0:m.profile.notes.find(u=>u.id===f.noteId);y&&(y.isDeleted=!1,r=!0);break}}r?(Ue.splice(t,1),ie(),Cn(),s.type==="classroom"&&Fe(),q("✅ آیتم با موفقیت بازیابی شد.")):q(l?`⚠️ ${l}`:"⚠️ آیتم اصلی برای بازیابی یافت نشد.")});const a=document.createElement("button");a.className="btn-icon",a.innerHTML="🔥",a.title="حذف دائمی",a.addEventListener("click",()=>{be("آیا از حذف دائمی این آیتم مطمئن هستید؟ این عمل غیرقابل بازgشت است.",()=>{const r=s.restoreData,l=p=>Object.values(se).find(h=>h.info.scheduleCode===p);let f;switch(s.type){case"classroom":delete se[r.name];break;case"student":f=l(r.classId),fs({identity:{studentId:r.studentId}},f);break;case"session":f=l(r.classId),f&&ra(f.info.name,r.sessionNumber);break;case"category":f=l(r.classId),f&&ca(f.info.name,r.categoryId);break;case"score":f=l(r.classId),f&&la(f.info.name,r.studentId,r.skill,r.scoreId);break;case"note":f=l(r.classId),f&&da(f.info.name,r.studentId,r.noteId);break}Ue.splice(t,1),ie(),Cn(),q("✅ آیتم برای همیشه حذف شد.")},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),n.appendChild(o),n.appendChild(a),c.appendChild(i),c.appendChild(n),e.appendChild(c)})}function Vr(){const e=document.getElementById("absentees-summary-container");e&&(e.innerHTML=`
        <div id="absentees-summary-box" class="absentees-summary">
            <div class="absentees-summary-header">
                <h4>لیست غایبین جلسه شماره <span id="absentee-summary-session-number"></span></h4>
                <button id="copy-absentees-btn" class="btn-icon" title="کپی لیست غایبین">📋</button>
            </div>
            <div id="absentees-summary-list" class="summary-list"></div>
            <div class="attendance-counters">
                <span>تعداد حاضرین: <strong id="present-count">0</strong></span>
                <span>تعداد غایبین: <strong id="absent-count">0</strong></span>
            </div>
        </div>
    `)}function ao(){const e=document.getElementById("absentees-summary-box"),s=document.getElementById("absentees-summary-list"),t=document.getElementById("absentee-summary-session-number");if(!e||!s||!t){console.error("Could not find all absentee summary elements.");return}if(!A||!Y){e.classList.remove("visible");return}const c=we(A.students).filter(f=>{const p=Y.studentRecords[f.identity.studentId];return p&&p.attendance==="absent"}),i=we(A.students),n=c.length,o=i.length-n,a=document.getElementById("present-count"),r=document.getElementById("absent-count");a&&(a.textContent=o.toLocaleString("fa-IR")),r&&(r.textContent=n.toLocaleString("fa-IR"));const l=st(A);t.textContent=l.get(Y.sessionNumber),c.length>0?e.classList.add("visible"):e.classList.remove("visible"),s.innerHTML="",c.forEach(f=>{const h=(y=>A.sessions.reduce((u,v)=>{if(v.isDeleted||v.isCancelled)return u;const b=v.studentRecords[y.identity.studentId];return u+(b&&b.attendance==="absent"?1:0)},0))(f),m=document.createElement("span");m.className="summary-name",m.textContent=`${f.identity.name} (غیبت: ${h})`,m.addEventListener("click",()=>{m.classList.add("fading-out"),setTimeout(()=>{Y.setAttendance(f.identity.studentId,"present"),ie(),Qe()},200)}),s.appendChild(m)})}function Jr(){const e=document.getElementById("copy-absentees-btn");if(!e){console.error("Could not find the copy absentees button to attach listener.");return}e.addEventListener("click",()=>{if(!A||!Y)return;const s=we(A.students).filter(a=>{const r=Y.studentRecords[a.identity.studentId];return r&&r.attendance==="absent"});if(s.length===0){q("⚠️لیست غایبین خالی است.");return}const t=a=>A.sessions.reduce((r,l)=>{if(l.isDeleted||l.isCancelled)return r;const f=l.studentRecords[a.identity.studentId];return r+(f&&f.attendance==="absent"?1:0)},0),c=we(A.students),i=s.length,n=c.length-i;let o=`گزارش حضور و غیاب جلسه شماره ${$r()}:
`;o+=`✅ حاضرین: ${n.toLocaleString("fa-IR")}
`,o+=`❌ غایبین: ${i.toLocaleString("fa-IR")}

`,o+=`لیست اسامی غایبین:
`,s.forEach(a=>{const r=t(a);o+=`- ${a.identity.name} (تعداد غیبت‌ها: ${r})
`}),navigator.clipboard.writeText(o).then(()=>{q("✅لیست غایبین با موفقیت کپی شد.")}).catch(a=>{console.error("Failed to copy text: ",a),q("❌خطا در کپی کردن لیست.")})})}function jn(){const e=document.getElementById("demo-mode-banner");e&&(ut?(e.classList.add("visible"),document.body.classList.add("demo-mode-active")):(e.classList.remove("visible"),document.body.classList.remove("demo-mode-active")))}function ds(e){const{scheduleDays:s,scheduleStartTime:t,scheduleEndTime:c}=e.info,i=s&&s.length>0,n=t&&c;if(!i&&!n)return{type:"unscheduled",sortIndex:3};if(!i||!n)return{type:"incomplete",sortIndex:2};const o=new Date,a=o.getDay(),r=o.getHours()*60+o.getMinutes(),[l,f]=t.split(":").map(Number),[p,h]=c.split(":").map(Number),m=l*60+f,y=p*60+h;if(s.includes(a)&&r>=m&&r<y)return{type:"active",sortIndex:0};for(let u=0;u<=7;u++){const v=(a+u)%7;if(s.includes(v)){if(u===0&&r>=m)continue;const b=new Date(o);return b.setDate(o.getDate()+u),b.setHours(l,f,0,0),{type:"upcoming",sortIndex:1,nextTimestamp:b.getTime()}}}return{type:"upcoming",sortIndex:1,nextTimestamp:9999999999999}}function Kr(e,s){const{scheduleDays:t,scheduleStartTime:c,scheduleEndTime:i}=e.info;if(!t||!t.length||!c||!i)return null;const[n,o]=c.split(":").map(Number),[a,r]=i.split(":").map(Number),l=n*60+o,f=a*60+r;for(const p of Object.values(s)){if(p===e||p.isDeleted||p.info.name===e.info.name)continue;const h=p.info;if(!h.scheduleDays||!h.scheduleDays.length||!h.scheduleStartTime||!h.scheduleEndTime||!t.some(_=>h.scheduleDays.includes(_)))continue;const[y,u]=h.scheduleStartTime.split(":").map(Number),[v,b]=h.scheduleEndTime.split(":").map(Number),C=y*60+u,S=v*60+b;if(l<S&&f>C)return p.info.name}return null}function Yr(e){if(!e||e.length===0)return"";const s={6:"شنبه",0:"۱شنبه",1:"۲شنبه",2:"۳شنبه",3:"۴شنبه",4:"۵شنبه",5:"جمعه"};return[...e].sort((c,i)=>{const n={6:0,0:1,1:2,2:3,3:4,4:5,5:6};return n[c]-n[i]}).map(c=>s[c]).join("، ")}async function io(){const e=document.getElementById("restore-points-list");e.innerHTML='<li style="text-align:center; padding:20px;">در حال بارگذاری...</li>';try{const s=await wi();if(s.length===0){e.innerHTML='<li style="text-align:center; padding:20px;">هیچ فایل پشتیبانی یافت نشد.</li>';return}e.innerHTML="",s.forEach(t=>{const c=document.createElement("li");c.className="restore-point-card";const i=new Date(t.timestamp).toLocaleString("fa-IR",{weekday:"long",year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"}),n=(t.file.size/1024).toFixed(1)+" KB";c.innerHTML=`
                <div class="restore-card-header">
                    <span class="restore-date">${i}</span>
                    <span class="restore-size">${n}</span>
                </div>
                <div class="restore-desc">${t.metadata.description||"بدون توضیحات"}</div>
                <div class="restore-actions">
                    <button class="btn-restore-action">بازگردانی</button>
                </div>
            `,c.querySelector(".btn-restore-action").addEventListener("click",async()=>{try{const a=await t.file.text(),f=(await new Js().loadAsync(a,{base64:!0})).file("backup.json");if(!f)throw new Error("فایل backup.json یافت نشد.");const p=await f.async("string"),h=JSON.parse(p);cs(h)}catch(a){console.error("Restore failed:",a),q("❌ فایل پشتیبان معتبر نیست.")}}),e.appendChild(c)})}catch(s){console.error("Failed to load snapshots:",s),e.innerHTML='<li style="text-align:center; color:red;">خطا در بارگذاری اطلاعات.</li>'}}function Xr(e,s,t="default",c=!1){let i=[...we(e.students)];const n=new Date().toLocaleDateString("fa-IR",{year:"numeric",month:"long",day:"numeric",weekday:"long"});t==="alpha"&&(i=En(i));let o="<tr>";s.forEach(h=>{o+=`<th>${h.label}</th>`}),o+="</tr>";let a="";i.forEach((h,m)=>{a+="<tr>",s.forEach(y=>{var C;let u="-";if(y.id==="row_num")u=m+1;else if(y.id==="name")h.identity.firstName&&h.identity.lastName?u=`${h.identity.lastName}، ${h.identity.firstName}`:u=h.identity.name;else if(y.id==="total_selections")u=h.statusCounters.totalSelections;else if(y.id==="absences")u=e.sessions.reduce((S,_)=>{if(_.isDeleted||_.isCancelled)return S;const k=_.studentRecords[h.identity.studentId];return S+(k&&k.attendance==="absent"?1:0)},0);else if(y.id==="exit_count")u=h.statusCounters.outOfClassCount||0;else if(y.id==="missed_chances")u=h.statusCounters.missedChances;else if(y.id==="issues")u=Object.values(h.categoryIssues||{}).reduce((S,_)=>S+_,0);else if(y.id==="avg_score")u=h.getOverallAverageScore()||"-";else if(y.id==="final_score")u=e.calculateFinalStudentScore(h)||"-";else if(y.type==="category")u=h.categoryCounts[y.id]||0;else if(y.type==="category_scores"){const S=y.id.toLowerCase(),_=((C=h.logs.scores[S])==null?void 0:C.filter(k=>!k.isDeleted))||[];u=_.length>0?_.map(k=>k.value).join("، "):"-"}let v="text-align: center;";y.id==="name"?v="text-align: right; white-space: nowrap;":y.type==="category_scores"&&(v="text-align: center; white-space: nowrap;");const b=`style="${v}"`;a+=`<td ${b}>${u}</td>`}),a+="</tr>"});let r="";c&&(r=`
            <div class="warning-footnote">
                ⚠️ <strong>توجه:</strong> ترتیب الفبایی این لیست ممکن است دقیق نباشد. (نام خانوادگی برخی دانش‌آموزان در سیستم تفکیک نشده است)
            </div>
        `);const l=Array.from(document.querySelectorAll('link[rel="stylesheet"]')).map(h=>h.outerHTML).join(""),f=window.open("","_blank");if(!f){q("⚠️ مرورگر شما پنجره جدید را مسدود کرد. لطفاً اجازه دهید.","error");return}const p=`
        <!DOCTYPE html>
        <html lang="fa" dir="rtl">
        <head>
            <title>گزارش کلاس ${e.info.name}</title>
            ${l} <style>
                @media print {
                    @page { size: A4; margin: 10mm; }
                    /* Updated Font Family */
                    body { font-family: 'Vazirmatn', 'Vazir', Tahoma, sans-serif; color: #000; }
                }
                /* Updated Font Family */
                body { font-family: 'Vazirmatn', 'Vazir', Tahoma, sans-serif; padding: 20px; direction: rtl; }
                h1 { text-align: center; margin-bottom: 5px; font-size: 24px; }
                .meta { text-align: center; margin-bottom: 30px; font-size: 14px; color: #444; }
                table { width: 100%; border-collapse: collapse; font-size: 12px; }
                th, td { border: 1px solid #333; padding: 6px 8px; text-align: center; }
                th { background-color: #eee; font-weight: bold; }
                tr:nth-child(even) { background-color: #f9f9f9; }
                .signature { margin-top: 50px; display: flex; justify-content: space-between; padding: 0 50px; }
                
                .warning-footnote {
                    margin-top: 20px;
                    font-size: 11px;
                    color: #555;
                    font-style: italic;
                    border-top: 1px solid #ccc;
                    padding-top: 10px;
                }
            </style>
        </head>
        <body>
            <h1>گزارش وضعیت کلاس ${e.info.name}</h1>
            <div class="meta">
                تاریخ گزارش: ${n} | تعداد دانش‌آموزان: ${i.length}
            </div>
            <table>
                <thead>${o}</thead>
                <tbody>${a}</tbody>
            </table>
            ${r}
            <div class="signature">
                <div>امضای معلم</div>
                <div>مهر و امضای مدرسه</div>
            </div>
            <script>
                window.onload = function() { window.print(); }
            <\/script>
        </body>
        </html>
    `;f.document.write(p),f.document.close()}function Qr(e){const s=zi;s.innerHTML="";const c=we(e.students).filter(h=>!h.identity.lastName).length,i=[{id:"row_num",label:"ردیف",checked:!0},{id:"name",label:"نام دانش‌آموز",checked:!0},{id:"total_selections",label:"کل انتخاب‌ها",checked:!0},{id:"absences",label:"تعداد غیبت",checked:!0},{id:"exit_count",label:"تعداد خروج",checked:!1},{id:"missed_chances",label:"فرصت سوخته",checked:!1},{id:"issues",label:"مشکل‌پاسخگویی",checked:!1},{id:"avg_score",label:"میانگین نمرات",checked:!0},{id:"final_score",label:"نمره نهایی (کانون)",checked:!0}];e.categories.forEach(h=>{h.isDeleted||(i.push({id:h.name,label:`تعداد ${h.name}`,type:"category",checked:!1}),h.isGradedCategory&&i.push({id:h.name,label:`نمرات ${h.name}`,type:"category_scores",checked:!1}))}),i.forEach(h=>{const m=document.createElement("label");m.className="report-column-item";const y=document.createElement("input");y.type="checkbox",y.checked=h.checked,y.dataset.colId=h.id,y.dataset.colLabel=h.label,h.type&&(y.dataset.colType=h.type);const u=document.createElement("span");u.textContent=h.label,m.appendChild(y),m.appendChild(u),s.appendChild(m)});const n=s.parentElement,o=n.querySelector("#report-sort-options");o&&o.remove();const a=document.createElement("div");a.id="report-sort-options",a.style.marginTop="20px",a.style.padding="15px",a.style.backgroundColor="#f8f9fa",a.style.borderRadius="5px",a.style.border="1px solid #e9ecef",a.innerHTML=`
        <div style="margin-bottom: 10px; font-weight: bold; color: #333;">ترتیب نمایش لیست:</div>
        
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <label style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <input type="radio" name="report-sort" value="alpha" checked style="accent-color: var(--color-primary);">
                <span>بر اساس نام خانوادگی</span>
            </label>

            <label style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <input type="radio" name="report-sort" value="default" style="accent-color: var(--color-primary);">
                <span>بر اساس زمان ورود به کلاس</span>
            </label>
        </div>

        <div id="sort-warning" style="
            display: none; 
            margin-top: 12px; 
            background-color: #fff3cd; 
            color: #856404; 
            padding: 10px; 
            border-radius: 4px; 
            font-size: 13px; 
            border: 1px solid #ffeeba;
            line-height: 1.5;
        ">
            ⚠️ <strong>توجه:</strong> نام خانوادگی ${c} دانش‌آموز هنوز تفکیک نشده است. مرتب‌سازی این موارد ممکن است کاملاً دقیق نباشد.
        </div>
    `;const r=n.querySelector(".modal-actions");n.insertBefore(a,r);const l=a.querySelectorAll('input[name="report-sort"]'),f=a.querySelector("#sort-warning"),p=()=>{const h=a.querySelector('input[value="alpha"]').checked;f.style.display=h&&c>0?"block":"none"};l.forEach(h=>h.addEventListener("change",p)),p(),Pi.onclick=()=>{const h=[];if(s.querySelectorAll('input[type="checkbox"]:checked').forEach(v=>{h.push({id:v.dataset.colId,label:v.dataset.colLabel,type:v.dataset.colType})}),h.length===0){q("⚠️ لطفاً حداقل یک ستون را انتخاب کنید.");return}const y=a.querySelector('input[name="report-sort"]:checked').value,u=y==="alpha"&&c>0;he(),Xr(e,h,y,u)},Fi.onclick=()=>{he()},Ae("report-config-modal")}function ja(e,s){const t=document.createElement("div");t.className="qualitative-button-container";const c=Xe,i=c!==-1&&Y.winnerHistory[c],n=i?Y.winnerHistory[c]:null,o=Y.studentRecords[e.identity.studentId];e.qualitativeStats||(e.qualitativeStats={}),e.qualitativeStats[s]||(e.qualitativeStats[s]={effort:0,good:0,excellent:0}),o.performanceRatings||(o.performanceRatings={});const a=i?n.rating:o.performanceRatings[s],r=Y.isFinished||o.attendance==="absent"||o.hadIssue||o.wasOutOfClass;return[{key:"effort",label:"تلاش",className:"effort-btn"},{key:"good",label:"خوب",className:"good-btn"},{key:"excellent",label:"عالی",className:"excellent-btn"}].forEach(f=>{const p=document.createElement("button");p.className=`qualitative-btn ${f.className}`,p.textContent=f.label,p.disabled=r,a===f.key&&p.classList.add("active"),p.addEventListener("click",()=>{const h=f.key;a&&e.qualitativeStats[s][a]>0&&e.qualitativeStats[s][a]--,a!==h&&(e.qualitativeStats[s][h]=(e.qualitativeStats[s][h]||0)+1);const m=a===h?null:h;i?n.rating=m:m?o.performanceRatings[s]=m:delete o.performanceRatings[s],ie(),$e()}),t.appendChild(p)}),t}function Da(e,s,t="custom",c=null){e.innerHTML="",Object.values(Fa).forEach(n=>{const o=document.createElement("option");o.value=n.id,o.textContent=n.label,e.appendChild(o)}),e.value=t;const i=n=>{s.innerHTML="";const o=Fa[n];if(o&&o.levels.length>0)o.levels.forEach(a=>{const r=document.createElement("option");r.value=a,r.textContent=a,s.appendChild(r)}),s.disabled=!1;else{const a=document.createElement("option");a.value="",a.textContent="---",s.appendChild(a),s.disabled=!0}};i(t),c&&(s.value=c),e.onchange=()=>{i(e.value),s.dispatchEvent(new Event("change"))}}function oo(){gn.value="",Da(as,Ea,"custom"),Ae("add-class-modal");const e=[{label:"شنبه",value:6},{label:"یکشنبه",value:0},{label:"دوشنبه",value:1},{label:"سه‌شنبه",value:2},{label:"چهارشنبه",value:3},{label:"پنج‌شنبه",value:4},{label:"جمعه",value:5}];os.innerHTML="",e.forEach(s=>{const t=document.createElement("label"),c=document.createElement("input");c.type="checkbox",c.value=s.value,t.appendChild(c),t.appendChild(document.createTextNode(s.label)),os.appendChild(t)}),an.addEventListener("click",()=>{an.classList.toggle("open"),Gi.classList.toggle("open");const s=an.querySelector(".arrow");s.textContent=an.classList.contains("open")?"▼":"▶"}),gn.focus()}function ro(){Zt.value="",yn.checked=!1,rs.value=1,dn.style.visibility="hidden",Ae("category-modal"),Zt.focus()}function Vs(){he()}function ec(e,s){let t,c;if(e&&s)t=e,c=s,Gt({student:e,categoryName:s}),yt(-1);else{if(Gt(null),Kt(null),!Y||Xe<0||!Y.winnerHistory[Xe])return null;const i=Y.winnerHistory[Xe];t=i.winner,c=i.categoryName}return{winner:t,categoryName:c}}function tc(e,s){const t=document.getElementById("selected-student-result");t.innerHTML="",t.classList.remove("absent");const c=document.querySelector(".current-winner-highlight");if(c&&c.classList.remove("current-winner-highlight"),e){const n=document.querySelector(`.student-stats-table tr[data-student-id="${e.identity.studentId}"]`);n&&n.classList.add("current-winner-highlight")}const i=A.categories.find(n=>n.name===s);if(i){es(i),Ba(i),Zs(i),bn(i),Kt(i.name);const n=document.querySelectorAll("#category-selection-container .pill");n.forEach(a=>a.classList.remove("active"));const o=Array.from(n).find(a=>a.textContent===s);o&&o.classList.add("active")}}function nc(e,s,t){const c=document.createElement("div");c.className="winner-name-container";const i=document.createElement("button");i.className="btn-icon",i.innerHTML="˅",i.title="برنده قبلی",i.classList.toggle("is-disabled",!t||Xe<=0),i.addEventListener("click",()=>{i.classList.contains("is-disabled")?(i.classList.add("shake-animation"),setTimeout(()=>i.classList.remove("shake-animation"),200)):(yt(Xe-1),$e())});const n=Y.studentRecords[e.identity.studentId],o=(n==null?void 0:n.attendance)==="absent",a=document.createElement("div");a.className="winner-name",a.innerHTML=`✨ <strong>${e.identity.name}</strong>✨`,a.classList.add("heartbeat-animation"),o?(a.style.textDecoration="line-through",a.style.opacity="0.6",a.style.color="var(--color-secondary)"):n!=null&&n.hadIssue?(a.style.color="var(--color-warning)",a.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"):n!=null&&n.wasOutOfClass&&(a.style.color="var(--color-strong-warning)",a.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود");const r=()=>{Qt=setTimeout(()=>{cc(e,s),Qt=null},1e3)},l=()=>{Qt&&(clearTimeout(Qt),Qt=null)};["mousedown","touchstart"].forEach(h=>a.addEventListener(h,r)),["mouseup","mouseout","touchend","touchcancel","touchmove"].forEach(h=>a.addEventListener(h,l));const f=document.createElement("button");if(f.className="btn-icon",f.innerHTML="˄",f.title="برنده بعدی",f.classList.toggle("is-disabled",!t||Xe>=Y.winnerHistory.length-1),f.addEventListener("click",()=>{f.classList.contains("is-disabled")?(f.classList.add("shake-animation"),setTimeout(()=>f.classList.remove("shake-animation"),200)):(yt(Xe+1),$e())}),c.appendChild(f),c.appendChild(a),e.onboardingSession===Y.sessionNumber){const h=document.createElement("div");h.className="new-student-badge",h.textContent="دانش آموز جدید",c.appendChild(h)}c.appendChild(i);const p=document.getElementById("select-student-btn");return p&&(p.disabled=t&&!f.classList.contains("is-disabled")),{nameContainer:c,winnerNameEl:a}}function sc(e,s,t){const c=document.createElement("div");c.className="status-button-container";const i=document.createElement("button");i.textContent="غایب",i.classList.add("status-button","absent-btn"),(s==null?void 0:s.attendance)==="absent"&&i.classList.add("active");const n=document.createElement("button");n.textContent="مشکل",n.classList.add("status-button","issue-btn"),s!=null&&s.hadIssue&&n.classList.add("active");const o=document.createElement("button");o.textContent="خروج",o.classList.add("status-button","exit-btn"),s!=null&&s.wasOutOfClass&&o.classList.add("active");const a=document.createElement("button");a.textContent="پروفایل",a.className="status-button profile-btn";const r=()=>{Oe(),setTimeout(()=>{Xe!==-1?$e():$e(e,t)},0),ie()};return Y.isFinished?[i,n,o,a].forEach(l=>l.disabled=!0):(i.addEventListener("click",()=>{const l=i.classList.contains("active");o.classList.contains("active")&&(o.classList.remove("active"),s.wasOutOfClass=!1,e.statusCounters.outOfClassCount=Math.max(0,(e.statusCounters.outOfClassCount||0)-1),e.statusCounters.missedChances=Math.max(0,e.statusCounters.missedChances-1)),l?(i.classList.remove("active"),Y.setAttendance(e.identity.studentId,"present"),e.statusCounters.missedChances=Math.max(0,e.statusCounters.missedChances-1)):(n.classList.contains("active")&&(n.classList.remove("active"),s.hadIssue=!1,e.statusCounters.otherIssues=Math.max(0,e.statusCounters.otherIssues-1),e.statusCounters.missedChances=Math.max(0,e.statusCounters.missedChances-1)),i.classList.add("active"),Y.setAttendance(e.identity.studentId,"absent"),e.statusCounters.missedChances++),r()}),n.addEventListener("click",()=>{const l=n.classList.contains("active");o.classList.contains("active")&&(o.classList.remove("active"),s.wasOutOfClass=!1,e.statusCounters.outOfClassCount=Math.max(0,(e.statusCounters.outOfClassCount||0)-1),e.statusCounters.missedChances=Math.max(0,e.statusCounters.missedChances-1)),l?(n.classList.remove("active"),s.hadIssue=!1,e.categoryIssues[t]&&(e.categoryIssues[t]=Math.max(0,e.categoryIssues[t]-1)),e.statusCounters.missedChances=Math.max(0,e.statusCounters.missedChances-1)):(i.classList.contains("active")&&(i.classList.remove("active"),Y.setAttendance(e.identity.studentId,"present"),e.statusCounters.missedChances=Math.max(0,e.statusCounters.missedChances-1)),n.classList.add("active"),s.hadIssue=!0,e.categoryIssues[t]=(e.categoryIssues[t]||0)+1,e.statusCounters.missedChances++),r()}),o.addEventListener("click",()=>{o.classList.contains("active")?(o.classList.remove("active"),s.wasOutOfClass=!1,e.statusCounters.outOfClassCount=Math.max(0,(e.statusCounters.outOfClassCount||0)-1),e.statusCounters.missedChances=Math.max(0,e.statusCounters.missedChances-1)):(i.classList.contains("active")&&(i.classList.remove("active"),Y.setAttendance(e.identity.studentId,"present"),e.statusCounters.missedChances=Math.max(0,e.statusCounters.missedChances-1)),n.classList.contains("active")&&(n.classList.remove("active"),s.hadIssue=!1,e.categoryIssues[t]&&(e.categoryIssues[t]=Math.max(0,e.categoryIssues[t]-1)),e.statusCounters.missedChances=Math.max(0,e.statusCounters.missedChances-1)),o.classList.add("active"),s.wasOutOfClass=!0,e.statusCounters.outOfClassCount=(e.statusCounters.outOfClassCount||0)+1,e.statusCounters.missedChances++),r()}),a.addEventListener("click",()=>{je(e)})),c.appendChild(i),c.appendChild(o),c.appendChild(n),c.appendChild(a),c}function ac(e,s){const t=document.createElement("div");t.className="student-details-container";const c=document.createElement("div");c.className="student-details-scores",c.innerHTML="<h4>آخرین نمرات</h4>";const i=document.createElement("ul");i.className="scores-list";const n=A.categories.filter(m=>m.isGradedCategory&&!m.isDeleted);let o=!1;const a=e.logs.scores||{};n.forEach(m=>{var _;const y=m.name,u=y.toLowerCase(),v=(_=a[u])==null?void 0:_.filter(k=>!k.isDeleted),b=document.createElement("li"),C=document.createElement("span");C.className="skill-name",C.textContent=`${y}:`;const S=document.createElement("span");if(S.className="skill-scores",v&&v.length>0){o=!0;const k=v.slice(-3);k.forEach((x,L)=>{const D=document.createElement("span");D.textContent=x.value+(x.comment?"'":""),x.comment&&(D.dataset.tooltip=x.comment,D.style.position="relative",D.style.cursor="help",D.classList.add("tooltip-container")),S.appendChild(D),L<k.length-1&&S.appendChild(document.createTextNode(","))})}else S.textContent="none";b.appendChild(C),b.appendChild(S),i.appendChild(b)}),o||(i.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>'),c.appendChild(i),t.appendChild(c);const r=document.createElement("div");r.className="student-details-notes";const l=document.createElement("div");l.className="history-section-header";const f=document.createElement("h4");f.textContent="یادداشت‌ها";const p=document.createElement("button");p.className="btn-icon",p.innerHTML="📝",p.title="افزودن یادداشت جدید",Y.isFinished?p.disabled=!0:p.addEventListener("click",()=>{Ee.value="",Ee.dispatchEvent(new Event("input",{bubbles:!0})),lt(m=>{m&&(e.addNote(m),ie(),$e(),q("✅ یادداشت با موفقیت ثبت شد."))}),Ae("add-note-modal"),Ee.focus()}),l.appendChild(f),l.appendChild(p),r.appendChild(l);const h=document.createElement("ul");return h.className="notes-list",e.profile.notes&&e.profile.notes.length>0?[...e.profile.notes].sort((y,u)=>new Date(u.timestamp)-new Date(y.timestamp)).forEach(y=>{const u=document.createElement("li");u.dir=ms(y.content),u.textContent=y.content,h.appendChild(u)}):h.innerHTML='<div class="no-content-message">یادداشتی وجود ندارد.</div>',r.appendChild(h),t.appendChild(r),t}function wn(){if(yn&&dn){dn.style.display="flex";const e=yn.checked;dn.style.visibility=e?"visible":"hidden"}}const qa=Object.freeze(Object.defineProperty({__proto__:null,_internalShowPage:ls,addClassModal:Mo,addNoteModal:lr,addScoreBtn:pr,addStudentBtn:Fo,appHeader:$s,assessmentModeLabel:Ko,attendanceListUl:rn,attendanceMassActionsContainer:Pn,attendancePage:Yo,attendancePane:Vt,attendanceSearchInput:Tt,backToSessionsBtn:zo,backToStudentPageBtn:fr,backupDataBtn:ar,breadcrumbContainer:Ht,cancelAddClassBtn:Ns,cancelImportBtn:Jo,cancelNoteBtn:ur,categoryListUl:Os,categoryModal:kr,categoryModalCancelBtn:Ir,categoryModalSaveBtn:Wi,categoryModalTitle:Hi,categoryWeightLabel:$n,classListHeader:Qo,classListUl:Nt,classManagementPage:Ti,classSaveNoteBtn:dr,closeActiveModal:he,closeAddClassModal:Vs,closeContextMenu:Dt,closeNavBtn:nr,columnMappingPage:Go,columnSelectDropdown:Rs,confirmAddClassBtn:Ds,confirmColumnBtn:Vo,confirmModalCancelBtn:Ps,confirmModalConfirmBtn:tn,confirmModalMessage:Oi,contextMenu:Mt,csvCancelBtn:jo,csvConfirmBtn:Uo,csvFileInput:Zo,csvPreviewList:Ms,csvPreviewPage:Wo,customConfirmModal:or,displayWinner:$e,finishAttendanceBtn:Xo,globalStudentSearchInput:nn,globalStudentSearchResultsDiv:dt,gradedCategoryPillsContainer:mr,hamburgerMenuBtn:er,handleUndo:Ji,importCsvBtn:qo,initiateBackupProcess:vn,massCommentAppendCheckbox:Sa,massCommentBtn:Ws,massCommentCancelBtn:Tr,massCommentContent:ln,massCommentModal:xr,massCommentModalTitle:Lr,massCommentSaveBtn:Br,massCommentStudentCountMessage:Ui,modalAddClassLevelSelect:Ea,modalAddClassSystemSelect:as,modalNewClassNameInput:gn,modalScheduleContent:Gi,modalScheduleDaysContainer:os,modalScheduleEndTimeInput:Zi,modalScheduleStartTimeInput:qi,modalScheduleTextInput:ji,modalScheduleToggle:an,newCategoryModal:Nr,newCategoryModalIsGradedCheckbox:yn,newCategoryModalNameInput:Zt,newCategoryModalWeightGroup:dn,newCategoryModalWeightInput:rs,newNoteContent:Ee,newScoreCommentTextarea:$i,newScoreValueInput:hr,newStudentNameInput:Po,openAddCategoryBtn:Ar,openAddCategoryModal:ro,openAddClassModal:oo,openAddClassModalBtn:Oo,openContextMenu:_n,openModal:Ae,overlay:sr,pasteArea:Ni,populateSystemLevelSelects:Da,processMassHomeworkComment:js,processPasteBtn:Ho,profileScoresListUl:yr,profileStatsSummaryDiv:gr,quickGradeFormWrapper:Ut,quickGradeSubmitBtn:Ot,quickNoteTextarea:rt,quickScoreInput:mt,renderAttendancePage:Qe,renderBreadcrumbs:Xi,renderClassList:Fe,renderClassManagementStats:gs,renderColumnSelector:no,renderGlobalSearchResults:Un,renderImportPreview:Gs,renderLogModal:Yi,renderMassCommentControls:Ia,renderRestorePointsPage:io,renderScoresHistory:eo,renderSearchResults:on,renderSessionDashboard:Sn,renderSessions:Ze,renderSettingsCategories:Yt,renderSettingsOther:so,renderSettingsStudentList:kt,renderStudentNotes:to,renderStudentStatsList:Oe,renderTrashPage:Cn,reportCancelBtn:Fi,reportColumnsContainer:zi,reportConfigModal:_r,reportPrintBtn:Pi,restoreDataBtn:ir,restoreFileInput:Ai,secureConfirmCancelBtn:cr,secureConfirmCode:Ri,secureConfirmConfirmBtn:zn,secureConfirmInput:Ft,secureConfirmMessage:Mi,secureConfirmModal:rr,selectStudentBtn:Ke,selectStudentBtnWrapper:At,sessionDashboardPage:Dr,setAutoDirectionOnInput:Ta,settingsClassNameHeader:Di,settingsEduSystemSelect:Fn,settingsLevelSelect:sn,settingsPage:$o,settingsStudentListUl:As,setupDashboardTabs:Vi,setupLongPress:jt,showCategoryModal:Us,showClassNoteModal:ps,showCustomConfirm:be,showMassCommentModal:xa,showMoveStudentModal:_a,showNotification:q,showPage:ke,showRenameStudentModal:ka,showRestoreConfirmModal:cs,showSecureConfirm:Ki,showSessionNoteModal:La,showSettingsPage:_t,showStudentProfile:je,showUndoToast:Or,sideNavMenu:tr,studentSearchInput:Fs,studentSearchResultsDiv:Ct,studentStatsHeader:zs,switchDashboardTab:Jt,syncWeightGroupVisibility:wn,trashedCategoriesList:wr,trashedClassesList:vr,trashedNotesList:Er,trashedScoresList:Sr,trashedSessionsList:Cr,trashedStudentsList:br,triggerFileDownload:qs,undoBtn:Ro,undoMessage:Bi,undoToast:is,updateCategoryColumnHighlight:Kt,updateDemoModeBanner:jn,updateQuickGradeUIForCategory:bn},Symbol.toStringTag,{value:"Module"}));let Za=0,xs=!1;const ic={"session-dashboard-page":"session-page","column-mapping-page":"settings-page","csv-preview-page":"settings-page","restore-points-page":"class-management-page","session-page":"class-management-page","settings-page":"class-management-page","trash-page":"class-management-page","class-management-page":null};function oc(e){if(e==="class-management-page"){Je(null),at(null),history.replaceState({pageId:e},"","#class-management-page"),ls(e);return}else e==="session-page"&&(at(null),A&&Ze());const s=new URLSearchParams;A&&s.set("class",A.info.name),Y&&s.set("session",Y.sessionNumber);const t=`#${e}${s.toString()?"?"+s.toString():""}`;history.replaceState({pageId:e},"",t),ls(e)}function Ga(e=!1){if(gt){he();return}const s=document.querySelector(".page.active");if(!s)return;const t=ic[s.id];t&&(e?oc(t):ke(t))}function rc(){const e=window.location.hash;if(!e||e==="#")return!1;const[s,t]=e.split("?"),c=s.substring(1),i=new URLSearchParams(t),n=i.get("class"),o=parseInt(i.get("session"),10),a=i.get("student"),r=i.get("tab")||"selector";if(n&&se[n])Je(se[n]),o&&A.getSession(o)&&at(A.getSession(o)),a&&A.students.find(l=>l.identity.studentId===a)&&St(A.students.find(l=>l.identity.studentId===a));else return!1;switch(c){case"session-page":Ze(),ke("session-page");break;case"session-dashboard-page":Sn(c==="attendance-page"?"attendance":r);break;case"settings-page":_t(A);break;default:return!1}return!0}document.addEventListener("DOMContentLoaded",()=>{const{globalStudentSearchInput:e,undoBtn:s,newStudentNameInput:t,addStudentBtn:c,pasteArea:i,processPasteBtn:n,csvPreviewList:o,csvConfirmBtn:a,csvCancelBtn:r,importCsvBtn:l,csvFileInput:f,columnSelectDropdown:p,confirmColumnBtn:h,cancelImportBtn:m,selectStudentBtn:y,attendancePage:u,finishAttendanceBtn:v,classListHeader:b,studentStatsHeader:C,hamburgerMenuBtn:S,sideNavMenu:_,closeNavBtn:k,overlay:x,backupDataBtn:L,restoreDataBtn:D,restoreFileInput:M,confirmModalCancelBtn:U,confirmModalConfirmBtn:Q,secureConfirmCancelBtn:I,secureConfirmConfirmBtn:$,newNoteContent:g,classSaveNoteBtn:H,cancelNoteBtn:ue,studentSearchInput:Z,studentSearchResultsDiv:me,categoryModalSaveBtn:V,categoryModalCancelBtn:fe,massCommentBtn:R,massCommentCancelBtn:O,massCommentSaveBtn:de,massCommentContent:ne,massCommentAppendCheckbox:ee,attendanceSearchInput:De,newCategoryModalNameInput:Pe,newCategoryModalIsGradedCheckbox:pe,newCategoryModalWeightInput:Se,openAddCategoryBtn:Me}=qa,Ne=document.getElementById("trash-nav-btn");document.querySelector(".global-search-container .search-icon"),Xn(),jn(),rc()||(Fe(),ke("class-management-page"));function Ge(B,W){const P=document.querySelector(B);if(!P)return;const K=P.querySelector(".search-icon"),ae=P.querySelector(".animated-search-input");!K||!ae||(K.addEventListener("mousedown",re=>{re.preventDefault()}),K.addEventListener("click",()=>{P.classList.contains("search-active")||(P.classList.add("search-active"),ae.focus())}),ae.addEventListener("blur",()=>{setTimeout(()=>{P.classList.remove("search-active"),ae.value="",W&&W([])},150)}))}De.addEventListener("input",()=>{const B=De.value.toLowerCase().trim(),W=Rn(B);rn.querySelectorAll(".attendance-list-item").forEach(K=>{const ae=K.querySelector(".student-name");if(ae){const re=ae.textContent,oe=We(re.toLowerCase()),ce=oe.includes(We(B)),ge=oe.includes(We(W));ce||ge?K.style.display="flex":K.style.display="none"}})}),fe.addEventListener("click",()=>{he(),hn(null)}),V.addEventListener("click",()=>{const B=Pe.value.trim(),W=pe.checked,P=parseInt(Se.value,10)||1;if(!B){q("⚠️ نام دسته‌بندی نمی‌تواند خالی باشد.");return}typeof Jn=="function"&&Jn(B,W,P),he(),q(`✅ دسته‌بندی جدید ${B} با موفقیت اضافه شد.`),Yt()}),window.addEventListener("scroll",Dt),document.addEventListener("click",B=>{Mt.classList.contains("visible")&&!Mt.contains(B.target)&&Dt(),Z.contains(B.target)||(me.style.display="none");const W=B.target.closest(".log-action-link");if(W&&W.dataset.action)try{const P=JSON.parse(W.dataset.action);zt(P)}catch(P){console.error("Could not parse log action:",P)}}),At.addEventListener("click",()=>{(At.classList.contains("disabled-wrapper")||Ke.disabled)&&(Ke.classList.add("shake-animation"),setTimeout(()=>{Ke.classList.remove("shake-animation")},200))}),C.addEventListener("click",()=>{const B=new Date().getTime();B-ea>500?On(1):On(Gn+1),yi(B),Gn===5&&(On(0),be("آیا از صفر کردن تمام شمارنده‌های دانش‌آموزان مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{di(),Oe(),q("تمام آمارها صفر شدند ✅.")},{confirmText:"بله",confirmClass:"btn-warning"}))}),b.addEventListener("click",()=>{const B=new Date().getTime();B-Qs>500?An(1):An(Zn+1),gi(B),Zn===5&&(An(0),be("آیا از ساخت یک کلاس تستی تصادفی مطمئن هستید؟",()=>{function W(){const P=`کلاس تستی ${Object.keys(se).length+1}`,K=new Ts({name:P,type:"online"});["علی . رضایی","مریم . حسینی","زهرا . احمدی","رضا . محمدی","فاطمه . کریمی"].forEach(re=>K.addStudent(new Dn(Wt(re)))),se[P]=K,ie(),Fe()}W(),q("کلاس تستی با موفقیت ساخته شد ✅!")},{confirmText:"بساز",confirmClass:"btn-success"}))}),document.querySelector(".app-header h1").addEventListener("click",()=>{Za++,Za===10&&(window.dev={state:Ha,ui:qa,utils:Io,db:ko},console.log("🛠️ Developer Mode Activated! Access modules via the 'dev' object (e.g., dev.state.currentClassroom)"),q("🛠️ حالت توسعه‌دهنده فعال شد."),document.querySelector(".app-header h1").style.color="var(--color-primary)",document.querySelector(".app-header h1").classList.add("dev-mode-tilt"))}),I.addEventListener("click",()=>{he(),mn(null)});const d=document.getElementById("date-picker-confirm-btn"),F=document.getElementById("date-picker-cancel-btn"),z=document.getElementById("dp-day"),E=document.getElementById("dp-month"),w=document.getElementById("dp-year");d.addEventListener("click",()=>{const B=w.value,W=E.value,P=z.value;B&&W&&P&&typeof Yn=="function"?(Yn({jy:B,jm:W,jd:P}),he()):q("⚠️ خطا در انتخاب تاریخ."),ts(null)}),F&&F.addEventListener("click",()=>{he(),ts(null)}),$.addEventListener("click",()=>{typeof Vn=="function"&&Vn(),he(),mn(null)}),U.addEventListener("click",()=>{he(na)}),Q.addEventListener("click",()=>{he(ta)}),Ke.addEventListener("click",()=>{if(xs){xs=!1;return}if(mt.value.trim()!==""||rt.value.trim()!==""){q("⚠️لطفاً ابتدا با دکمه «ثبت»، تغییرات را ذخیره کنید و یا نمره و یادداشت را پاک کنید.");return}if(Bt){const B=uc(A,Re);B?(Oe(),$e(B,Re.name),Kt(Re.name),ie()):be("برای تمام دانش‌آموزان در این جلسه یک بار فرصت نمره‌گیری فراهم شده؛ آیا می‌خواهید برای بار دوم این کار را تکرار کنید؟",()=>{const W=Re.id;nt[W].scoredThisSession=[],Ke.click()},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})}else{if(!A||!Y||!Re)return;const B=A.selectNextWinner(Re.name,Y);if(B){Bs();const W=Y.studentRecords[B.identity.studentId];(W==null?void 0:W.attendance)==="absent"&&B.statusCounters.missedChances++,W!=null&&W.hadIssue&&(B.statusCounters.missedChances++,B.categoryIssues[Re.name]=(B.categoryIssues[Re.name]||0)+1),W!=null&&W.wasOutOfClass&&(B.statusCounters.outOfClassCount=(B.statusCounters.outOfClassCount||0)+1,B.statusCounters.missedChances++);const P={winner:B,categoryName:Re.name};Y.winnerHistory.push(P),Y.winnerHistory.length>10&&Y.winnerHistory.shift(),yt(Y.winnerHistory.length-1),Y.lastUsedCategoryId=Re.id,Y.lastSelectedWinnerId=B.identity.studentId,Oe(),setTimeout(()=>$e(),0),ie()}else q("❌دانش‌آموز واجد شرایطی برای انتخاب یافت نشد.")}}),document.querySelectorAll('#settings-page input[name="class-type-setting"]').forEach(B=>{B.addEventListener("change",()=>{if(!A)return;const W=B.value,P=A.info.type||"in-person";if(W===P)return;const K=oe=>oe==="online"?"آنلاین":"حضوری",ae=K(P),re=K(W);be(`آیا از تغییر نوع کلاس از «${ae}» به «${re}» مطمئن هستید؟`,()=>{A.info.type=W,ie(),_e(A.info.name,`نوع کلاس به «${re}» تغییر یافت.`,{type:"VIEW_CLASS_SETTINGS"}),Fe(),q(`✅ نوع کلاس به «${re}» تغییر یافت.`)},{confirmText:"بله",confirmClass:"btn-warning",onCancel:()=>{const oe=document.querySelector(`#settings-page input[name="class-type-setting"][value="${P}"]`);oe&&(oe.checked=!0)}})})});const j=document.querySelectorAll('input[name="schedule-day"]'),G=document.getElementById("settings-schedule-start"),N=document.getElementById("settings-schedule-end");j.forEach(B=>{B.addEventListener("change",()=>{if(!A)return;const W=Array.from(j).filter(P=>P.checked).map(P=>parseInt(P.value));A.info.scheduleDays=W,ie()})});const J=()=>{A&&(A.info.scheduleStartTime=G.value,A.info.scheduleEndTime=N.value,ie())};G.addEventListener("change",J),N.addEventListener("change",J),h.addEventListener("click",()=>{if(!qn){q("❌خطایی رخ داده است. لطفاً فایل را دوباره انتخاب کنید."),ke("settings-page");return}const B=parseInt(p.value,10),K=qn.split(`
`).slice(1).map(ae=>{var oe;return(oe=ae.split(",")[B])==null?void 0:oe.trim()}).filter(ae=>ae&&ae.length>0);K.length>0?(en(K),Gs(),ke("csv-preview-page")):q("هیچ نامی در ستون انتخاب شده پیدا نشد. لطفاً ستون دیگری را امتحان کنید یا فایل خود را بررسی کنید."),Nn(null)}),l.addEventListener("click",()=>{f.click()}),f.addEventListener("change",B=>{const W=B.target.files[0];if(!W)return;const P=new FileReader;P.onload=K=>{const ae=K.target.result;Nn(ae);const oe=ae.split(`
`)[0].split(",");no(oe),ke("column-mapping-page")},P.readAsText(W),B.target.value=null}),m.addEventListener("click",()=>{Nn(null),ke("settings-page")}),a.addEventListener("click",()=>{const B=o.querySelectorAll('input[type="checkbox"]:checked');let W=0,P=[],K=!1;B.forEach(re=>{const oe=re.dataset.name,ce=Wt(oe),ge=We(ce.name),Ce=A.students.find(Ve=>We(Ve.identity.name)===ge&&ge!=="");if(Ce)if(Ce.isDeleted)fs(Ce,A);else{P.push(ce.name);return}const Te=new Dn(ce);A.addStudent(Te),A.sessions.length>0&&(we(A.sessions).filter(Ve=>Ve.isFinished&&!Ve.isCancelled).forEach(Ve=>{Ve.setAttendance(Te.identity.studentId,"absent")}),et(Te,A),K=!0),W++}),ie(),W>0&&_e(A.info.name,`${W} دانش‌آموز جدید از لیست ورودی به کلاس اضافه شدند.`,{type:"VIEW_SESSIONS"}),_t(A);let ae=P.length>0?`⚠️ موارد زیر به دلیل تکراری بودن نادیده گرفته شدند:
- ${P.join(`
- `)}`:"";if(K)Xt(W,ae);else if(P.length>0||W>0){const re=W>0?`✅ ${W} دانش‌آموز با موفقیت اضافه شدند.
${ae}`:ae;be(re,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}i.value="",en([])}),r.addEventListener("click",()=>{en([]),ke("settings-page")}),i.addEventListener("keydown",B=>{if(B.key==="Enter"){const W=i.value,P=i.selectionStart,K=W.lastIndexOf(`
`,P-1),ae=W.substring(K+1,P).trim(),re=ae.indexOf(".");ae&&(re<=0||re>=ae.length-1)&&(B.preventDefault(),q("لطفا یک نقطه بین نام و نام خانوادگی قرار دهید.⚠️ مثال: علی . احمدی",5e3))}}),n.addEventListener("click",()=>{const B=i.value.trim();if(!B){q("کادر متنی خالی است. لطفاً اسامی را وارد کنید.");return}const W=B.split(`
`).map(K=>K.trim()).filter(K=>K.length>0),P=W.find(K=>{const ae=K.indexOf(".");return ae<=0||ae>=K.length-1});if(P){q(`فرمت نام «${P}» صحیح نیست. لطفا نام و نام خانوادگی را با نقطه جدا کنید⚠️.`,5e3);return}W.length>0?(en(W),Gs(),ke("csv-preview-page")):q("هیچ نام معتبری برای ورود پیدا نشد.")}),t.addEventListener("keyup",B=>{B.key==="Enter"&&c.click()}),c.addEventListener("click",()=>{if(!A)return;const B=t.value.trim();if(!B){q("لطفاً نام دانش‌آموز را وارد کنید.");return}const W=B.indexOf(".");if(W<=0||W>=B.length-1){q("لطفا یک نقطه بین نام و نام خانوادگی قرار دهید.⚠️ مثال: علی . احمدی",5e3);return}const P=Wt(t.value),K=We(P.name);if(we(A.students).some(ce=>We(ce.identity.name)===K)){q(`دانش‌آموز «${P.name}» قبلاً در لیست وجود دارد.`,4e3);return}const re=Wt(B),oe=new Dn(re);A.addStudent(oe),A.sessions.length>0&&(we(A.sessions).filter(ce=>ce.isFinished&&!ce.isCancelled).forEach(ce=>{ce.setAttendance(oe.identity.studentId,"absent")}),et(oe,A),Xt(1)),ie(),_e(A.info.name,`دانش‌آموز «${B}» به کلاس اضافه شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:oe.identity.studentId}),kt(),Oe(),t.value="",t.focus()}),document.getElementById("new-session-btn").addEventListener("click",()=>{if(A){const B=A.sessions.find(P=>!P.isFinished&&!P.isCancelled&&!P.isDeleted);if(B){q(`⚠️ جلسه ${B.sessionNumber} هنوز تمام نشده است. لطفاً ابتدا با دکمه ✅ آن را خاتمه دهید.`);return}const W=()=>{const P=K=>{const ae=A.startNewSession();fn(ae),at(ae),A.students.forEach(ce=>{Ks.setAttendance(ce.identity.studentId,"present")}),ie();const oe=st(A).get(ae.sessionNumber);_e(A.info.name,`جلسه ${oe} شروع شد.`,{type:"VIEW_SESSIONS"}),Sn(K?"attendance":"selector")};be("آیا تمایل به انجام فرآیند حضور و غیاب دارید؟",()=>P(!0),{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success",onCancel:()=>P(!1)})};A.hasSessionToday()?be("شما امروز یک جلسه برای این کلاس ثبت کرده‌اید. آیا از شروع یک جلسه جدید دیگر مطمئن هستید؟",W,{confirmText:"بله",confirmClass:"btn-warning"}):W()}});const te=document.getElementById("open-add-class-modal-btn");te&&te.addEventListener("click",()=>{oo()}),Ns&&Ns.addEventListener("click",()=>{Vs()}),Ds?Ds.addEventListener("click",()=>{var P;const B=gn;if(!B){console.error("❌ DEBUG: Name Input element is missing!");return}const W=B.value.trim();if(!W){q("لطفاً نام کلاس را وارد کنید.");return}if(se[W]){q("کلاسی با این نام قبلاً ایجاد شده است.");return}try{const K=document.querySelector('input[name="modal-class-type"]:checked');if(!K){console.error("❌ DEBUG: Class Type radio not selected or found!");return}const ae=K.value,re=as.value,oe=gn.value.trim();if(!oe){q("⚠️ لطفاً نام کلاس را وارد کنید.");return}if(se[oe]){q("⚠️ کلاسی با این نام وجود دارد.");return}const ce=((P=document.querySelector('input[name="modal-class-type"]:checked'))==null?void 0:P.value)||"in-person",ge=as.value,Ce=Ea.value||null,Te=ji.value.trim()||null,Ve=Array.from(os.querySelectorAll("input:checked")).map(Ie=>parseInt(Ie.value,10)),ws=qi.value||null,Es=Zi.value||null,ht=new Ts({name:oe,type:ce,educationalSystem:ge,level:Ce,scheduleText:Te,scheduleDays:Ve,scheduleStartTime:ws,scheduleEndTime:Es});se[oe]=ht,ie(),he(),Fe(),q(`✅ کلاس «${oe}» ایجاد شد.`),se[W]=ht,ie(),Fe(),Vs()}catch(K){console.error("❌ CRASH ERROR:",K),q("خطایی رخ داد: "+K.message)}}):console.error("❌ DEBUG: Create Button (ui.confirmAddClassBtn) is NOT found!"),e.addEventListener("input",B=>{const W=B.target.value;if(W.length<2){Un([]);return}const P=W.toLowerCase(),K=Rn(P),ae=[];for(const re in se){const oe=se[re];if(oe.isDeleted)continue;const ce=We(re.toLowerCase()),ge=ce.includes(We(P)),Ce=ce.includes(We(K));(ge||Ce)&&ae.push({type:"classroom",classroom:oe})}for(const re in se){const oe=se[re];if(oe.isDeleted)continue;we(oe.students).filter(ge=>{const Ce=We(ge.identity.name.toLowerCase()),Te=Ce.includes(We(P)),Ve=Ce.includes(We(K));return Te||Ve}).forEach(ge=>{ae.push({type:"student",student:ge,classroom:oe})})}Un(ae)}),s.addEventListener("click",Ji),v.addEventListener("click",()=>{Jt("selector")}),Z.addEventListener("input",B=>{const W=B.target.value;if(!W){on([]);return}const P=W.toLowerCase(),K=Rn(P),re=we(A.students).filter(oe=>{const ce=We(oe.identity.name.toLowerCase()),ge=ce.includes(We(P)),Ce=ce.includes(We(K));return ge||Ce});on(re)}),Z.addEventListener("focus",()=>{Z.value&&on(Z.value)}),Ot.addEventListener("click",()=>{const B=mt.value,W=rt.value.trim();let P;if(Kn)P=Kn.student;else{const ae=Y==null?void 0:Y.winnerHistory[Xe];P=ae==null?void 0:ae.winner}if(!P){q("❌خطا: دانش‌آموز معتبری برای ثبت نمره یافت نشد.");return}const K=Re;if(!P||!K){q("⚠️لطفاً ابتدا یک دانش‌آموز و یک دسته‌بندی را انتخاب کنید.");return}if(!B){q("⚠️لطفاً مقدار نمره را وارد کنید.");return}if(B>100||B<0){q("❌نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}P&&(P.addScore(K.name,parseFloat(B),W),_e(A.info.name,`نمره ${B} در ${K.name} برای «${P.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:P.identity.studentId}),ie(),Oe(),q(`✅نمره برای ${P.identity.name} در مهارت ${K.name} ثبت شد.`),ga(Re.id,P.identity.studentId),mt.value="",rt.value="",$e())});const X=B=>{B.key==="Enter"&&B.ctrlKey&&(B.preventDefault(),Ot.click())};mt.addEventListener("keydown",X),rt.addEventListener("keydown",X),ue.addEventListener("click",()=>{he()}),H.addEventListener("click",()=>{const B=g.value.trim(),W=sa;if(typeof W=="function"){const P=W(B);if(P===!1)return;he(()=>{typeof P=="function"&&P()})}else he()});const le=document.getElementById("move-student-confirm-btn"),xe=document.getElementById("move-student-cancel-btn"),ye=document.getElementById("move-student-class-select");xe.addEventListener("click",()=>{he()}),le.addEventListener("click",()=>{const B=ye.value,W=se[B],{studentToMove:P,sourceClassForMove:K}=Ha;if(!P||!K||!W){q("خطایی رخ داد. لطفاً دوباره امتحان کنید⚠️.","error"),he();return}const ae=li(P,K,W);ae.success?(_e(K.info.name,`دانش‌آموز «${P.identity.name}» به کلاس «${B}» منتقل شد.`,{type:"VIEW_SESSIONS"}),_e(B,`دانش‌آموز «${P.identity.name}» از کلاس «${K.info.name}» به این کلاس منتقل شد.`,{type:"VIEW_SESSIONS"}),ie(),kt(),Oe(),Qe(),q(`دانش‌آموز «${P.identity.name}» با موفقیت به کلاس «${B}» منتقل شد✅.`)):q(ae.message,"error"),he()}),S.addEventListener("click",()=>{_.style.width="300px",x.classList.add("modal-visible")}),S.addEventListener("click",()=>{_.style.width="300px",x.classList.add("modal-visible")});const qe=document.getElementById("header-settings-btn");qe&&qe.addEventListener("click",()=>{A&&_t(A)}),k.addEventListener("click",ve),k.addEventListener("click",ve),x.addEventListener("click",ve),Ne.addEventListener("click",()=>{Cn(),ke("trash-page"),ve()});const vt=document.getElementById("restore-points-nav-btn");vt&&vt.addEventListener("click",()=>{io(),ke("restore-points-page"),ve()}),document.getElementById("demo-mode-btn").addEventListener("click",()=>{ut?It():(ve(),be("شما در حال ورود به حالت نمایش (Demo) هستید. در این حالت، هیچ‌کدام از تغییرات شما ذخیره نخواهد شد. آیا ادامه می‌دهید؟",()=>{ui(),jn(),ve()},{confirmText:"تایید",confirmClass:"btn-warning",onCancel:ve}))});const bt=document.getElementById("exit-demo-btn");bt&&bt.addEventListener("click",()=>{ut&&It()}),L.addEventListener("click",()=>{if(ut){q("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است."),ve();return}ve(),vn()}),D.addEventListener("click",()=>{if(ut){q("⚠️ بازیابی اطلاعات در حالت نمایش (Demo) غیرفعال است."),ve();return}M.click(),ve()}),M.addEventListener("change",B=>{const W=B.target.files[0];if(!W)return;const P=new FileReader;P.onload=async K=>{const ae=K.target.result;try{const re=JSON.parse(ae);if(re.metadata&&re.data)cs(re);else{const oe=re.classrooms||re,ce=re.trashBin||[];be("آیا از بازیابی اطلاعات مطمئن هستید؟ تمام داده‌های فعلی شما بازنویسی خواهد شد.",()=>{$t(oe),ha(ce),wt({lastRestoreTimestamp:new Date().toISOString()}),ie(),Fe(),ke("class-management-page"),q("✅اطلاعات با موفقیت بازیابی شد.")},{confirmText:"بازیابی کن",confirmClass:"btn-warning"})}}catch{try{const ge=(await new Js().loadAsync(ae,{base64:!0})).file("backup.json");if(!ge)throw new Error("فایل backup.json در فایل پشتیبان یافت نشد.");const Ce=await ge.async("string"),Te=JSON.parse(Ce);if(Te.metadata&&Te.metadata.version==="2.0-b64")cs(Te);else throw new Error("فایل پشتیبان معتبر نیست (نسخه نامشخص).")}catch(oe){q("❌خطا در خواندن فایل. لطفاً فایل پشتیبان معتبر انتخاب کنید."),console.error("Restore error (zip/base64):",oe)}}},P.readAsText(W),B.target.value=null}),window.addEventListener("popstate",B=>{if(gt||aa){he(null,!0),ia(!1);return}Dt(),Ga(!0)}),document.addEventListener("keydown",B=>{const W=document.activeElement;if(!["INPUT","TEXTAREA","SELECT"].includes(W.tagName)){if(B.key.toLowerCase()==="o"&&B.shiftKey&&Ti.classList.contains("active")&&(B.preventDefault(),Ai.click()),B.key==="Escape"){if(Mt.classList.contains("visible")){Dt();return}if(gt){he();return}Ga(!1);return}if(Y){const K=B.key.toLowerCase();switch(" ascfg".includes(K)&&B.preventDefault(),K){case" ":y.click();break;case"a":u.classList.contains("active")?history.back():(Qe(),ke("attendance-page"));break;case"s":document.getElementById("session-page").classList.contains("active")&&history.back();break;case"f":const ae=document.querySelector(".action-column .search-icon");ae&&ae.click();break;case"arrowleft":{const re=document.querySelector('button[title="برنده قبلی"]');re&&!re.disabled&&(B.preventDefault(),re.click());break}case"arrowright":{const re=document.querySelector('button[title="برنده بعدی"]');re&&!re.disabled&&(B.preventDefault(),re.click());break}}}}});function ve(){_.style.width="0",x.classList.add("modal-closing"),setTimeout(()=>{x.classList.remove("modal-visible","modal-closing")},300)}function It(){be("آیا از خروج از حالت نمایش (Demo) مطمئن هستید؟ با خروج، تمام تغییرات آزمایشی شما حذف شده و داده‌های اصلی شما بازیابی خواهند شد.",()=>{fi(),Je(null),at(null),St(null),Fe(),ke("class-management-page"),jn(),ve()},{confirmText:"خروج",confirmClass:"btn-success"})}Ge(".global-search-container .animated-search-container",Un),Ge(".action-column-header .animated-search-container",on),lc(),[Ee,$i,rt,Ni].forEach(B=>{B&&Ta(B)});function et(B,W){const P=we(W.students).filter(Ie=>Ie.identity.studentId!==B.identity.studentId);if(P.length===0)return;const K=P.reduce((Ie,He)=>He.statusCounters.totalSelections>Ie.statusCounters.totalSelections?He:Ie,P[0]);if(!K||K.statusCounters.totalSelections===0)return;B.categoryCounts=JSON.parse(JSON.stringify(K.categoryCounts)),B.statusCounters.totalSelections=K.statusCounters.totalSelections;const ae=P.reduce((Ie,He)=>Ie+He.statusCounters.totalSelections,0),re=P.reduce((Ie,He)=>Ie+(He.statusCounters.missedChances||0),0),oe=ae>0?re/ae:0;B.statusCounters.missedChances=Math.round(B.statusCounters.totalSelections*oe);const ce=we(W.categories),ge={};ce.forEach(Ie=>{const He=P.reduce((_s,ks)=>_s+(ks.categoryCounts[Ie.name]||0),0),Ss=P.reduce((_s,ks)=>_s+(ks.categoryIssues[Ie.name]||0),0);ge[Ie.name]=He>0?Ss/He:0}),ce.forEach(Ie=>{const He=B.categoryCounts[Ie.name]||0,Ss=ge[Ie.name]||0;B.categoryIssues[Ie.name]=Math.round(He*Ss)});const Ce=W.liveSession;Ce?B.onboardingSession=Ce.sessionNumber:B.onboardingSession=W.sessions.length+1;const Te=we(W.sessions).filter(Ie=>Ie.isFinished&&!Ie.isCancelled),Ve="📝 یادداشت خودکار سیستم",Es=`این دانش‌آموز  از جلسه شماره ${Te.length} به کلاس اضافه شد. آمار مشارکت او بر اساس فعال‌ترین دانش‌آموز و آمار «فرصت از دست رفته» او بر اساس میانگین کلاس ثبت گردید:`,ht=[];B.statusCounters.totalSelections>0&&ht.push(`کل انتخاب‌ها: ${B.statusCounters.totalSelections}`),B.statusCounters.missedChances>0&&ht.push(`فرصت‌های از دست رفته: ${B.statusCounters.missedChances}`);for(const Ie in B.categoryCounts){const He=B.categoryCounts[Ie];He>0&&ht.push(`انتخاب در «${Ie}»: ${He}`)}for(const Ie in B.categoryIssues){const He=B.categoryIssues[Ie];He>0&&ht.push(`مشکل در «${Ie}»: ${He}`)}if(ht.length>0){const Ie=`${Ve}
${Es}

- ${ht.join(`
- `)}`;B.addNote(Ie)}}function Xt(B,W=""){const P=B>1?"دانش‌آموزان جدید":"دانش‌آموز جدید";let K=`✅ ${B} ${P} با موفقیت اضافه شدند.
`;K+="💡 چون این کلاس جلسات برگزار شده دارد، برای این افراد آمار پایه‌ای (متناسب با کلاس) ثبت شد تا در فرایند انتخاب اختلالی ایجاد نشود.",W&&(K+=`
${W}`),be(K,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}const ys="22.6.0",vs="951";{const B=` (ساخت ${vs})`;document.getElementById("app-version").textContent=`نسخه ${ys}${B}`}function bs(){console.log("Starting universal backfill for writing scores...");let B=0;for(const W in se){const P=se[W];if(P.isDeleted)continue;let K=0;we(P.students).forEach(re=>{const oe=re.logs.scores;if(!(oe&&oe.writing&&oe.writing.length>0)){let ge=-1;for(const Ce in oe)Ce!=="writing"&&oe[Ce].forEach(Te=>{Te.value>ge&&(ge=Te.value)});if(ge>-1){const Ce=`Automatically assigned based on the highest score (${ge}) from other skills.`;re.addScore("Writing",ge,Ce),K++}}}),K>0&&(console.log(`Updated ${K} student(s) in class: ${P.info.name}.`),B+=K)}B>0?(ie(),console.log(`Update complete. A total of ${B} student(s) were updated across all classes. Data saved.`),document.getElementById("student-page").classList.contains("active")&&Oe()):console.log("No students needed updating in any class.")}window.backfillWritingScoresForAll=bs;function In(){console.log("Starting backfill for 'outOfClassCount' and 'wasOutOfClass' properties...");let B=0,W=0;const P=localStorage.getItem("teacherAssistantData_v2");if(!P){console.log("No data found in localStorage. Nothing to do.");return}const K=JSON.parse(P);for(const ae in K){const re=K[ae];re.students&&re.students.forEach(oe=>{oe.statusCounters&&typeof oe.statusCounters.outOfClassCount>"u"&&(oe.statusCounters.outOfClassCount=0,B++)}),re.sessions&&re.sessions.forEach(oe=>{if(oe.studentRecords)for(const ce in oe.studentRecords){const ge=oe.studentRecords[ce];typeof ge.wasOutOfClass>"u"&&(ge.wasOutOfClass=!1,W++)}})}localStorage.setItem("teacherAssistantData_v2",JSON.stringify(K)),console.log(`Backfill complete. Updated ${B} students and ${W} session records. Data saved.`),Xn(),A&&Oe()}window.backfillExitCounters=In;function xt(){console.log("🧹 Starting orphaned data cleanup...");let B=0;for(const W in se){const P=se[W];if(P.isDeleted)continue;let K=!1;const ae=new Set(P.students.filter(ce=>!ce.isDeleted).map(ce=>ce.identity.studentId)),re=new Map(P.students.map(ce=>[ce.identity.studentId,ce.identity.name])),oe=[];P.sessions.forEach(ce=>{if(ce.isDeleted)return;const ge=[];for(const Ce in ce.studentRecords)if(!ae.has(Ce)){const Te=re.get(Ce)||"Unknown/Deleted";ge.push(`  - Removed student record for: ${Te} (ID: ${Ce})`),delete ce.studentRecords[Ce],B++,K=!0}for(const Ce in ce.lastWinnerByCategory){const Te=ce.lastWinnerByCategory[Ce];if(!ae.has(Te)){const Ve=re.get(Te)||"Unknown/Deleted";ge.push(`  - Removed '${Ce}' last winner: ${Ve} (ID: ${Te})`),delete ce.lastWinnerByCategory[Ce],B++,K=!0}}if(ce.lastSelectedWinnerId&&!ae.has(ce.lastSelectedWinnerId)){const Ce=ce.lastSelectedWinnerId,Te=re.get(Ce)||"Unknown/Deleted";ge.push(`  - Cleared 'lastSelectedWinnerId': ${Te} (ID: ${Ce})`),ce.lastSelectedWinnerId=null,B++,K=!0}if(ge.length>0){const Te=st(P).get(ce.sessionNumber)||`(#${ce.sessionNumber})`;oe.push({sessionDisplayNumber:Te,logs:ge})}}),K&&(console.group(`➡️ Class: ${W}`),oe.forEach(ce=>{console.groupCollapsed(`  Session ${ce.sessionDisplayNumber}`),ce.logs.forEach(ge=>console.warn(ge)),console.groupEnd()}),console.groupEnd())}B>0?(ie(),console.log(`✅ Cleanup complete! Found and removed ${B} orphaned references. Data saved.`)):console.log("✅ No orphaned data found. Your data is clean!")}window.cleanupOrphanedData=xt;function zt(B){if(!B||!B.classroomName)return;const W=se[B.classroomName];if(!W){q("⚠️ کلاس مربوط به این گزارش یافت نشد.");return}Je(W),he(),setTimeout(()=>{switch(B.type){case"VIEW_STUDENT_PROFILE":{const P=W.students.find(K=>K.identity.studentId===B.studentId);P?je(P):q("⚠️ دانش‌آموز مورد نظر یافت نشد.");break}case"VIEW_TRASH":Cn(),ke("trash-page");break;case"VIEW_SESSIONS":Ze(),ke("session-page");break;case"VIEW_CLASS_NOTE":ps(W);break;case"VIEW_CLASS_SETTINGS":_t(W);break}},300)}R.addEventListener("click",()=>{xa()}),O.addEventListener("click",()=>{he()}),de.addEventListener("click",()=>{const B=ne.value.trim(),W=ee.checked;if(!B){Sa.style.display==="flex"?be("کادر یادداشت خالی است. آیا مطمئنید که می‌خواهید یادداشت‌های قبلی دانش‌آموزان انتخاب‌شده را پاک کنید؟",()=>{he(),js("",!1)},{confirmText:"پاک کردن",confirmClass:"btn-warning"}):q("⚠️ لطفاً متن یادداشت را وارد کنید.");return}he(()=>{js(B,W)})});const Lt=document.getElementById("screen-saver-overlay");let Cs;const co=2*60*1e3,Na=["mousemove","keypress","scroll","click","touchstart"];function lo(){Lt.classList.add("visible")}function Aa(){Lt.classList.contains("visible")&&Lt.classList.remove("visible")}function xn(){Aa(),clearTimeout(Cs),Cs=setTimeout(lo,co)}function Ln(B){B.preventDefault(),B.stopPropagation(),setTimeout(xn,0)}function Oa(){xn(),Na.forEach(W=>window.addEventListener(W,xn)),Lt.addEventListener("click",Ln),Lt.addEventListener("touchstart",Ln);const B="22.6.0";{const W=document.getElementById("screen-saver-version");W&&(W.textContent=`v${B}`)}}function uo(){clearTimeout(Cs),Aa(),Na.forEach(B=>window.removeEventListener(B,xn)),Lt.removeEventListener("click",Ln),Lt.removeEventListener("touchstart",Ln)}document.getElementById("app-settings-modal");const Ma=document.getElementById("app-settings-nav-btn"),Ra=document.getElementById("close-settings-btn"),$a=document.getElementById("setting-sound-toggle"),za=document.getElementById("setting-vibration-toggle"),Pa=document.getElementById("setting-screensaver-toggle");Ma&&Ma.addEventListener("click",()=>{ve(),$a.checked=ze.isSoundEnabled,za.checked=ze.isVibrationEnabled,Pa.checked=ze.isScreenSaverEnabled,Ae("app-settings-modal")}),Ra&&Ra.addEventListener("click",()=>{he()}),$a.addEventListener("change",B=>{wt({isSoundEnabled:B.target.checked}),B.target.checked&&Bs()}),za.addEventListener("change",B=>{wt({isVibrationEnabled:B.target.checked}),B.target.checked&&navigator.vibrate&&navigator.vibrate(50)}),ze.isScreenSaverEnabled&&Oa(),Pa.addEventListener("change",B=>{B.target.checked?(wt({isScreenSaverEnabled:!0}),Oa()):(wt({isScreenSaverEnabled:!1}),uo())}),jt(Ke,()=>{if(xs=!0,!Re){q("⚠️ ابتدا یک دسته‌بندی انتخاب کنید.");return}if(!Re.isGradedCategory){q("⚠️ این دسته‌بندی نمره‌دار نیست.");return}si(!Bt),yt(-1),Gt(null),$e(),bn(Re),At.classList.toggle("assessment-mode-active",Bt),q(Bt?"حالت انتخاب برای نمره‌دهی فعال شد.":"حالت انتخاب معمولی فعال شد.")}),Me.addEventListener("click",()=>{hn((B,W,P)=>{if(B){if(A.categories.some(K=>K.name.toLowerCase()===B.toLowerCase())){q("⚠️ این دسته‌بندی قبلاً اضافه شده است.");return}A.categories.push(new pt(B,"",W,P)),ie(),Yt()}}),ro()}),pe&&pe.addEventListener("change",wn)});function cc(e,s){if(!Y||Y.isFinished){q("⚠️ امکان لغو انتخاب در جلسه خاتمه یافته وجود ندارد.");return}if(Bt){be(`آیا از لغو وضعیت نمره‌دهی «${e.identity.name}» مطمئن هستید؟ این دانش‌آموز به لیست انتظار بازمی‌گردد.`,()=>{const i=Re.id,n=nt[i];n&&(n.scoredThisSession=n.scoredThisSession.filter(o=>o!==e.identity.studentId)),Gt(null),Oe(),$e(),ie(),q(`✅ «${e.identity.name}» به لیست انتظار نمره بازگشت.`)});return}const t=Y.winnerHistory;if(!(Xe===t.length-1)||t.length===0){q("⚠️ فقط آخرین انتخاب قابل لغو است.");return}if(t[t.length-1].winner.identity.studentId!==e.identity.studentId){console.error("Undo mismatch!");return}be(`آیا از حذف انتخاب «${e.identity.name}» برای «${s}» مطمئن هستید؟ آمار این انتخاب بازگردانی خواهد شد.`,()=>{const i=Y.winnerHistory,n=i.pop();if(!n)return;const o=n.winner,a=n.categoryName,r=o.identity.studentId;o.statusCounters.totalSelections=Math.max(0,o.statusCounters.totalSelections-1),o.categoryCounts[a]&&(o.categoryCounts[a]=Math.max(0,o.categoryCounts[a]-1));const l=Y.studentRecords[r];if(l&&l.selections[a]&&(l.selections[a]=Math.max(0,l.selections[a]-1)),n.rating){const p=n.rating;o.qualitativeStats&&o.qualitativeStats[a]&&o.qualitativeStats[a][p]>0&&o.qualitativeStats[a][p]--}let f=null;for(let p=i.length-1;p>=0;p--)if(i[p].categoryName===a){f=i[p].winner.identity.studentId;break}f?Y.lastWinnerByCategory[a]=f:delete Y.lastWinnerByCategory[a],yt(i.length-1),Oe(),$e(),ie(),q(`✅ انتخاب «${o.identity.name}» لغو شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}function lc(){const e=document.getElementById("session-dashboard-page"),s=document.getElementById("student-stats-table-container");if(!e)return;let t=0,c=0;e.addEventListener("touchstart",n=>{if(s&&s.contains(n.target)){const o=n.target.closest("td, th");o&&o.parentElement.firstElementChild===o?t=n.changedTouches[0].screenX:t=0}else t=n.changedTouches[0].screenX},{passive:!0}),e.addEventListener("touchend",n=>{t!==0&&(c=n.changedTouches[0].screenX,i())});function i(){const o=t-c;Math.abs(o)>150&&(document.getElementById("selector-tab-btn").classList.contains("active")?(ke("session-dashboard-page",{tab:"attendance"}),Jt("attendance")):(ke("session-dashboard-page",{tab:"selector"}),Jt("selector"))),t=0,c=0}}function Va(e,s){const t=s.toLowerCase();return(e.logs.scores[t]||[]).filter(i=>!i.isDeleted).length}function dc(e,s){const t=s.id;nt[t]||(nt[t]={toBeScored:[],scoredThisSession:[]});const c=nt[t],n=we(e.students).filter(r=>!c.scoredThisSession.includes(r.identity.studentId));if(n.length===0)return c.toBeScored=[],[];const o=n.map(r=>Va(r,s.name)),a=Math.min(...o);return c.toBeScored=n.filter(r=>Va(r,s.name)===a).map(r=>r.identity.studentId),c.toBeScored}function uc(e,s){const t=dc(e,s);if(t.length===0)return null;const c=Math.floor(Math.random()*t.length),i=t[c];return ga(s.id,i),e.students.find(n=>n.identity.studentId===i)}
