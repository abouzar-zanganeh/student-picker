(function(){const c=document.createElement("link").relList;if(c&&c.supports&&c.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))l(a);new MutationObserver(a=>{for(const t of a)if(t.type==="childList")for(const n of t.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&l(n)}).observe(document,{childList:!0,subtree:!0});function e(a){const t={};return a.integrity&&(t.integrity=a.integrity),a.referrerPolicy&&(t.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?t.credentials="include":a.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function l(a){if(a.ep)return;a.ep=!0;const t=e(a);fetch(a.href,t)}})();class an{constructor(c){this.identity={name:c.name,studentId:c.studentId||`id_${new Date().getTime()}_${Math.random()}`,branchName:c.branchName||null,ageGroup:c.ageGroup||"adult",level:c.level||null,contact:{social:c.socialContact||null,parent:c.parentContact||null}},this.isDeleted=!1,this.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0,outOfClassCount:0},this.categoryCounts={},this.categoryIssues={},this.logs={parentContacts:[],scores:{},discipline:{},sessionHistory:{}},this.profile={notes:[],tags:[]},this.finalClassActivityScore=null,this.onboardingSession=null}addScore(c,e,l){if(e>100||e<0){console.log("نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}const a=c.toLowerCase();this.logs.scores[a]||(this.logs.scores[a]=[]);const t=new ki(c,e,l);this.logs.scores[a].push(t)}addNote(c,e=null){const l=new Si(c,e);this.profile.notes.push(l)}getOverallAverageScore(){let c=0,e=0;for(const a in this.logs.scores)this.logs.scores[a].forEach(t=>{t.isDeleted||(c+=t.value,e++)});if(e===0)return null;const l=c/e;return Math.round(l*100)/100}}class ki{constructor(c,e,l=""){this.id=`score_${new Date().getTime()}`,this.skill=c,this.value=e,this.timestamp=new Date,this.comment=l,this.isDeleted=!1}}class Si{constructor(c,e=null){this.id=`note_${new Date().getTime()}`,this.timestamp=new Date,this.content=c,this.isDeleted=!1,this.source=e}}class $n{constructor(c="complete",e=""){this.status=c,this.comment=e,this.timestamp=new Date}}class Is{constructor(c){this.sessionNumber=c,this.startTime=new Date,this.note="",this.isDeleted=!1,this.endTime=null,this.isFinished=!1,this.isMakeup=!1,this.isCancelled=!1,this.studentRecords={},this.lastWinnerByCategory={},this.lastUsedCategoryId=null,this.lastSelectedWinnerId=null,this.winnerHistory=[]}end(){this.isFinished=!0,this.endTime=new Date}markAsMakeup(){this.isMakeup=!this.isMakeup}initializeStudentRecord(c){this.studentRecords[c]||(this.studentRecords[c]={attendance:"present",homework:new $n,selections:{},hadIssue:!1,wasOutOfClass:!1})}setAttendance(c,e){this.initializeStudentRecord(c),this.studentRecords[c].attendance=e}setHomeworkStatus(c,e){this.initializeStudentRecord(c),this.studentRecords[c].homework.status=e}selectNextWinner(c,e,l){if(!e||e.length===0)return console.log("هیچ دانش‌آموزی در کلاس برای انتخاب وجود ندارد."),null;const a=this.lastWinnerByCategory[c];let t=e.filter(h=>h.identity.studentId!==a&&!h.isDeleted);if(t.length===0&&(t=e),t.length===0)return null;const n=(h,u)=>h.categoryCounts[u]||0,i=Math.min(...t.map(h=>n(h,c))),r=t.filter(h=>n(h,c)===i);let m;if(r.length===1)m=r[0];else if(r.length>1){const h=l.filter(y=>!y.isDeleted&&y.name!==c).map(y=>y.name),u=r.map(y=>{const g=h.reduce((w,k)=>w+n(y,k),0);return{student:y,otherCategoriesTotal:g}}),p=Math.min(...u.map(y=>y.otherCategoriesTotal)),f=u.filter(y=>y.otherCategoriesTotal===p).map(y=>y.student);f.length===1?m=f[0]:m=f[Math.floor(Math.random()*f.length)]}else m=t[Math.floor(Math.random()*t.length)];const b=m.identity.studentId;this.initializeStudentRecord(b);const v=(this.studentRecords[b].selections[c]||0)+1;return this.studentRecords[b].selections[c]=v,m.statusCounters.totalSelections++,m.categoryCounts[c]=(m.categoryCounts[c]||0)+1,this.lastWinnerByCategory[c]=b,m}}class Fn{constructor(c){this.info={name:c.name||"NotNamed",scheduleCode:c.scheduleCode||`code_${new Date().getTime()}`,teacherName:c.teacherName||null,type:c.type||"in-person",term:c.term||null,scheduleText:c.scheduleText||null,level:c.level||null,creationDate:c.creationDate?new Date(c.creationDate):new Date},this.students=[],this.sessions=[],this.note="",this.isDeleted=!1,this.categories=[new ct("Vocabulary","Questions about words and meanings."),new ct("Grammar","Questions about sentence structure and rules."),new ct("Listening",void 0,!0),new ct("Speaking",void 0,!0),new ct("Reading",void 0,!0),new ct("Writing",void 0,!0)],this.futurePlans={}}addStudent(c){this.students.push(c)}removeStudent(c){this.students=this.students.filter(e=>e.identity.studentId!==c)}startNewSession(){const c=this.sessions.length+1,e=new Is(c);return this.sessions.push(e),e}endSpecificSession(c){const e=this.getSession(c);return e&&!e.isFinished?(e.end(),!0):!1}getSession(c){return this.sessions.find(e=>e.sessionNumber===c)}markAsMakeup(c){const e=this.getSession(c);e&&e.markAsMakeup()}planForSession(c,e){this.futurePlans[c]=e}hasSessionToday(){const c=new Date().toDateString();return this.sessions.some(e=>!e.isDeleted&&e.startTime.toDateString()===c)}selectNextWinner(c,e){return e?e.selectNextWinner(c,this.students,this.categories):null}get liveSession(){for(let c=this.sessions.length-1;c>=0;c--)if(!this.sessions[c].isFinished)return this.sessions[c];return null}endLiveSession(){const c=this.liveSession;return c?(c.end(),!0):!1}calculateFinalStudentScore(c){const e=c.logs.scores,l=["reading","writing"];for(const h of l)if(!e[h]||e[h].length===0)return null;const a=e.listening&&e.listening.length>0,t=e.speaking&&e.speaking.length>0;if(!a&&!t)return null;const n=h=>e[h].reduce((p,f)=>p+f.value,0)/e[h].length;let i;a&&t?i=(n("listening")+n("speaking"))/2:a?i=n("listening"):i=n("speaking");const r=n("reading"),m=n("writing"),v=(i*3+r*2+m*1)/6;return Math.trunc(v*10)/10}assignAllFinalScores(){let c=0,e=[];console.log("شروع عملیات محاسبه نمره نهایی برای تمام دانش‌آموزان..."),this.students.forEach(a=>{const t=this.calculateFinalStudentScore(a);t!==null?(a.finalClassActivityScore=t,c++):(a.finalClassActivityScore=null,e.push(a.identity.name))});const l=e.length;console.log(`عملیات پایان یافت. تعداد نمرات موفق: ${c} | تعداد ناموفق (نمرات ناقص): ${l}`),l>0&&(console.log("اسامی دانش‌آموزانی که نمراتشان ناقص است:"),e.forEach(a=>console.log(`- ${a}`)))}}class ct{constructor(c,e="",l=!1){this.id=`cat_${new Date().getTime()}_${Math.random()}`,this.name=c,this.description=e,this.isDeleted=!1,this.isGradedCategory=l,this.isDeleted=!1}}var nn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Ii(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}function sn(s){throw new Error('Could not dynamically require "'+s+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var xs={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/(function(s,c){(function(e){s.exports=e()})(function(){return function e(l,a,t){function n(m,b){if(!a[m]){if(!l[m]){var v=typeof sn=="function"&&sn;if(!b&&v)return v(m,!0);if(i)return i(m,!0);var h=new Error("Cannot find module '"+m+"'");throw h.code="MODULE_NOT_FOUND",h}var u=a[m]={exports:{}};l[m][0].call(u.exports,function(p){var f=l[m][1][p];return n(f||p)},u,u.exports,e,l,a,t)}return a[m].exports}for(var i=typeof sn=="function"&&sn,r=0;r<t.length;r++)n(t[r]);return n}({1:[function(e,l,a){var t=e("./utils"),n=e("./support"),i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";a.encode=function(r){for(var m,b,v,h,u,p,f,y=[],g=0,w=r.length,k=w,I=t.getTypeOf(r)!=="string";g<r.length;)k=w-g,v=I?(m=r[g++],b=g<w?r[g++]:0,g<w?r[g++]:0):(m=r.charCodeAt(g++),b=g<w?r.charCodeAt(g++):0,g<w?r.charCodeAt(g++):0),h=m>>2,u=(3&m)<<4|b>>4,p=1<k?(15&b)<<2|v>>6:64,f=2<k?63&v:64,y.push(i.charAt(h)+i.charAt(u)+i.charAt(p)+i.charAt(f));return y.join("")},a.decode=function(r){var m,b,v,h,u,p,f=0,y=0,g="data:";if(r.substr(0,g.length)===g)throw new Error("Invalid base64 input, it looks like a data url.");var w,k=3*(r=r.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(r.charAt(r.length-1)===i.charAt(64)&&k--,r.charAt(r.length-2)===i.charAt(64)&&k--,k%1!=0)throw new Error("Invalid base64 input, bad content length.");for(w=n.uint8array?new Uint8Array(0|k):new Array(0|k);f<r.length;)m=i.indexOf(r.charAt(f++))<<2|(h=i.indexOf(r.charAt(f++)))>>4,b=(15&h)<<4|(u=i.indexOf(r.charAt(f++)))>>2,v=(3&u)<<6|(p=i.indexOf(r.charAt(f++))),w[y++]=m,u!==64&&(w[y++]=b),p!==64&&(w[y++]=v);return w}},{"./support":30,"./utils":32}],2:[function(e,l,a){var t=e("./external"),n=e("./stream/DataWorker"),i=e("./stream/Crc32Probe"),r=e("./stream/DataLengthProbe");function m(b,v,h,u,p){this.compressedSize=b,this.uncompressedSize=v,this.crc32=h,this.compression=u,this.compressedContent=p}m.prototype={getContentWorker:function(){var b=new n(t.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new r("data_length")),v=this;return b.on("end",function(){if(this.streamInfo.data_length!==v.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),b},getCompressedWorker:function(){return new n(t.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},m.createWorkerFrom=function(b,v,h){return b.pipe(new i).pipe(new r("uncompressedSize")).pipe(v.compressWorker(h)).pipe(new r("compressedSize")).withStreamInfo("compression",v)},l.exports=m},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,l,a){var t=e("./stream/GenericWorker");a.STORE={magic:"\0\0",compressWorker:function(){return new t("STORE compression")},uncompressWorker:function(){return new t("STORE decompression")}},a.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,l,a){var t=e("./utils"),n=function(){for(var i,r=[],m=0;m<256;m++){i=m;for(var b=0;b<8;b++)i=1&i?3988292384^i>>>1:i>>>1;r[m]=i}return r}();l.exports=function(i,r){return i!==void 0&&i.length?t.getTypeOf(i)!=="string"?function(m,b,v,h){var u=n,p=h+v;m^=-1;for(var f=h;f<p;f++)m=m>>>8^u[255&(m^b[f])];return-1^m}(0|r,i,i.length,0):function(m,b,v,h){var u=n,p=h+v;m^=-1;for(var f=h;f<p;f++)m=m>>>8^u[255&(m^b.charCodeAt(f))];return-1^m}(0|r,i,i.length,0):0}},{"./utils":32}],5:[function(e,l,a){a.base64=!1,a.binary=!1,a.dir=!1,a.createFolders=!0,a.date=null,a.compression=null,a.compressionOptions=null,a.comment=null,a.unixPermissions=null,a.dosPermissions=null},{}],6:[function(e,l,a){var t=null;t=typeof Promise<"u"?Promise:e("lie"),l.exports={Promise:t}},{lie:37}],7:[function(e,l,a){var t=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",n=e("pako"),i=e("./utils"),r=e("./stream/GenericWorker"),m=t?"uint8array":"array";function b(v,h){r.call(this,"FlateWorker/"+v),this._pako=null,this._pakoAction=v,this._pakoOptions=h,this.meta={}}a.magic="\b\0",i.inherits(b,r),b.prototype.processChunk=function(v){this.meta=v.meta,this._pako===null&&this._createPako(),this._pako.push(i.transformTo(m,v.data),!1)},b.prototype.flush=function(){r.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},b.prototype.cleanUp=function(){r.prototype.cleanUp.call(this),this._pako=null},b.prototype._createPako=function(){this._pako=new n[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var v=this;this._pako.onData=function(h){v.push({data:h,meta:v.meta})}},a.compressWorker=function(v){return new b("Deflate",v)},a.uncompressWorker=function(){return new b("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(e,l,a){function t(u,p){var f,y="";for(f=0;f<p;f++)y+=String.fromCharCode(255&u),u>>>=8;return y}function n(u,p,f,y,g,w){var k,I,S=u.file,A=u.compression,z=w!==m.utf8encode,H=i.transformTo("string",w(S.name)),D=i.transformTo("string",m.utf8encode(S.name)),G=S.comment,se=i.transformTo("string",w(G)),E=i.transformTo("string",m.utf8encode(G)),M=D.length!==S.name.length,d=E.length!==G.length,P="",de="",j="",ue=S.dir,$=S.date,te={crc32:0,compressedSize:0,uncompressedSize:0};p&&!f||(te.crc32=u.crc32,te.compressedSize=u.compressedSize,te.uncompressedSize=u.uncompressedSize);var N=0;p&&(N|=8),z||!M&&!d||(N|=2048);var T=0,ae=0;ue&&(T|=16),g==="UNIX"?(ae=798,T|=function(X,Le){var De=X;return X||(De=Le?16893:33204),(65535&De)<<16}(S.unixPermissions,ue)):(ae=20,T|=function(X){return 63&(X||0)}(S.dosPermissions)),k=$.getUTCHours(),k<<=6,k|=$.getUTCMinutes(),k<<=5,k|=$.getUTCSeconds()/2,I=$.getUTCFullYear()-1980,I<<=4,I|=$.getUTCMonth()+1,I<<=5,I|=$.getUTCDate(),M&&(de=t(1,1)+t(b(H),4)+D,P+="up"+t(de.length,2)+de),d&&(j=t(1,1)+t(b(se),4)+E,P+="uc"+t(j.length,2)+j);var ee="";return ee+=`
\0`,ee+=t(N,2),ee+=A.magic,ee+=t(k,2),ee+=t(I,2),ee+=t(te.crc32,4),ee+=t(te.compressedSize,4),ee+=t(te.uncompressedSize,4),ee+=t(H.length,2),ee+=t(P.length,2),{fileRecord:v.LOCAL_FILE_HEADER+ee+H+P,dirRecord:v.CENTRAL_FILE_HEADER+t(ae,2)+ee+t(se.length,2)+"\0\0\0\0"+t(T,4)+t(y,4)+H+P+se}}var i=e("../utils"),r=e("../stream/GenericWorker"),m=e("../utf8"),b=e("../crc32"),v=e("../signature");function h(u,p,f,y){r.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=p,this.zipPlatform=f,this.encodeFileName=y,this.streamFiles=u,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}i.inherits(h,r),h.prototype.push=function(u){var p=u.meta.percent||0,f=this.entriesCount,y=this._sources.length;this.accumulate?this.contentBuffer.push(u):(this.bytesWritten+=u.data.length,r.prototype.push.call(this,{data:u.data,meta:{currentFile:this.currentFile,percent:f?(p+100*(f-y-1))/f:100}}))},h.prototype.openedSource=function(u){this.currentSourceOffset=this.bytesWritten,this.currentFile=u.file.name;var p=this.streamFiles&&!u.file.dir;if(p){var f=n(u,p,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:f.fileRecord,meta:{percent:0}})}else this.accumulate=!0},h.prototype.closedSource=function(u){this.accumulate=!1;var p=this.streamFiles&&!u.file.dir,f=n(u,p,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(f.dirRecord),p)this.push({data:function(y){return v.DATA_DESCRIPTOR+t(y.crc32,4)+t(y.compressedSize,4)+t(y.uncompressedSize,4)}(u),meta:{percent:100}});else for(this.push({data:f.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},h.prototype.flush=function(){for(var u=this.bytesWritten,p=0;p<this.dirRecords.length;p++)this.push({data:this.dirRecords[p],meta:{percent:100}});var f=this.bytesWritten-u,y=function(g,w,k,I,S){var A=i.transformTo("string",S(I));return v.CENTRAL_DIRECTORY_END+"\0\0\0\0"+t(g,2)+t(g,2)+t(w,4)+t(k,4)+t(A.length,2)+A}(this.dirRecords.length,f,u,this.zipComment,this.encodeFileName);this.push({data:y,meta:{percent:100}})},h.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},h.prototype.registerPrevious=function(u){this._sources.push(u);var p=this;return u.on("data",function(f){p.processChunk(f)}),u.on("end",function(){p.closedSource(p.previous.streamInfo),p._sources.length?p.prepareNextSource():p.end()}),u.on("error",function(f){p.error(f)}),this},h.prototype.resume=function(){return!!r.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},h.prototype.error=function(u){var p=this._sources;if(!r.prototype.error.call(this,u))return!1;for(var f=0;f<p.length;f++)try{p[f].error(u)}catch{}return!0},h.prototype.lock=function(){r.prototype.lock.call(this);for(var u=this._sources,p=0;p<u.length;p++)u[p].lock()},l.exports=h},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,l,a){var t=e("../compressions"),n=e("./ZipFileWorker");a.generateWorker=function(i,r,m){var b=new n(r.streamFiles,m,r.platform,r.encodeFileName),v=0;try{i.forEach(function(h,u){v++;var p=function(w,k){var I=w||k,S=t[I];if(!S)throw new Error(I+" is not a valid compression method !");return S}(u.options.compression,r.compression),f=u.options.compressionOptions||r.compressionOptions||{},y=u.dir,g=u.date;u._compressWorker(p,f).withStreamInfo("file",{name:h,dir:y,date:g,comment:u.comment||"",unixPermissions:u.unixPermissions,dosPermissions:u.dosPermissions}).pipe(b)}),b.entriesCount=v}catch(h){b.error(h)}return b}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,l,a){function t(){if(!(this instanceof t))return new t;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var n=new t;for(var i in this)typeof this[i]!="function"&&(n[i]=this[i]);return n}}(t.prototype=e("./object")).loadAsync=e("./load"),t.support=e("./support"),t.defaults=e("./defaults"),t.version="3.10.1",t.loadAsync=function(n,i){return new t().loadAsync(n,i)},t.external=e("./external"),l.exports=t},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,l,a){var t=e("./utils"),n=e("./external"),i=e("./utf8"),r=e("./zipEntries"),m=e("./stream/Crc32Probe"),b=e("./nodejsUtils");function v(h){return new n.Promise(function(u,p){var f=h.decompressed.getContentWorker().pipe(new m);f.on("error",function(y){p(y)}).on("end",function(){f.streamInfo.crc32!==h.decompressed.crc32?p(new Error("Corrupted zip : CRC32 mismatch")):u()}).resume()})}l.exports=function(h,u){var p=this;return u=t.extend(u||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:i.utf8decode}),b.isNode&&b.isStream(h)?n.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):t.prepareContent("the loaded zip file",h,!0,u.optimizedBinaryString,u.base64).then(function(f){var y=new r(u);return y.load(f),y}).then(function(f){var y=[n.Promise.resolve(f)],g=f.files;if(u.checkCRC32)for(var w=0;w<g.length;w++)y.push(v(g[w]));return n.Promise.all(y)}).then(function(f){for(var y=f.shift(),g=y.files,w=0;w<g.length;w++){var k=g[w],I=k.fileNameStr,S=t.resolve(k.fileNameStr);p.file(S,k.decompressed,{binary:!0,optimizedBinaryString:!0,date:k.date,dir:k.dir,comment:k.fileCommentStr.length?k.fileCommentStr:null,unixPermissions:k.unixPermissions,dosPermissions:k.dosPermissions,createFolders:u.createFolders}),k.dir||(p.file(S).unsafeOriginalName=I)}return y.zipComment.length&&(p.comment=y.zipComment),p})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,l,a){var t=e("../utils"),n=e("../stream/GenericWorker");function i(r,m){n.call(this,"Nodejs stream input adapter for "+r),this._upstreamEnded=!1,this._bindStream(m)}t.inherits(i,n),i.prototype._bindStream=function(r){var m=this;(this._stream=r).pause(),r.on("data",function(b){m.push({data:b,meta:{percent:0}})}).on("error",function(b){m.isPaused?this.generatedError=b:m.error(b)}).on("end",function(){m.isPaused?m._upstreamEnded=!0:m.end()})},i.prototype.pause=function(){return!!n.prototype.pause.call(this)&&(this._stream.pause(),!0)},i.prototype.resume=function(){return!!n.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},l.exports=i},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,l,a){var t=e("readable-stream").Readable;function n(i,r,m){t.call(this,r),this._helper=i;var b=this;i.on("data",function(v,h){b.push(v)||b._helper.pause(),m&&m(h)}).on("error",function(v){b.emit("error",v)}).on("end",function(){b.push(null)})}e("../utils").inherits(n,t),n.prototype._read=function(){this._helper.resume()},l.exports=n},{"../utils":32,"readable-stream":16}],14:[function(e,l,a){l.exports={isNode:typeof Buffer<"u",newBufferFrom:function(t,n){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(t,n);if(typeof t=="number")throw new Error('The "data" argument must not be a number');return new Buffer(t,n)},allocBuffer:function(t){if(Buffer.alloc)return Buffer.alloc(t);var n=new Buffer(t);return n.fill(0),n},isBuffer:function(t){return Buffer.isBuffer(t)},isStream:function(t){return t&&typeof t.on=="function"&&typeof t.pause=="function"&&typeof t.resume=="function"}}},{}],15:[function(e,l,a){function t(S,A,z){var H,D=i.getTypeOf(A),G=i.extend(z||{},b);G.date=G.date||new Date,G.compression!==null&&(G.compression=G.compression.toUpperCase()),typeof G.unixPermissions=="string"&&(G.unixPermissions=parseInt(G.unixPermissions,8)),G.unixPermissions&&16384&G.unixPermissions&&(G.dir=!0),G.dosPermissions&&16&G.dosPermissions&&(G.dir=!0),G.dir&&(S=g(S)),G.createFolders&&(H=y(S))&&w.call(this,H,!0);var se=D==="string"&&G.binary===!1&&G.base64===!1;z&&z.binary!==void 0||(G.binary=!se),(A instanceof v&&A.uncompressedSize===0||G.dir||!A||A.length===0)&&(G.base64=!1,G.binary=!0,A="",G.compression="STORE",D="string");var E=null;E=A instanceof v||A instanceof r?A:p.isNode&&p.isStream(A)?new f(S,A):i.prepareContent(S,A,G.binary,G.optimizedBinaryString,G.base64);var M=new h(S,E,G);this.files[S]=M}var n=e("./utf8"),i=e("./utils"),r=e("./stream/GenericWorker"),m=e("./stream/StreamHelper"),b=e("./defaults"),v=e("./compressedObject"),h=e("./zipObject"),u=e("./generate"),p=e("./nodejsUtils"),f=e("./nodejs/NodejsStreamInputAdapter"),y=function(S){S.slice(-1)==="/"&&(S=S.substring(0,S.length-1));var A=S.lastIndexOf("/");return 0<A?S.substring(0,A):""},g=function(S){return S.slice(-1)!=="/"&&(S+="/"),S},w=function(S,A){return A=A!==void 0?A:b.createFolders,S=g(S),this.files[S]||t.call(this,S,null,{dir:!0,createFolders:A}),this.files[S]};function k(S){return Object.prototype.toString.call(S)==="[object RegExp]"}var I={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(S){var A,z,H;for(A in this.files)H=this.files[A],(z=A.slice(this.root.length,A.length))&&A.slice(0,this.root.length)===this.root&&S(z,H)},filter:function(S){var A=[];return this.forEach(function(z,H){S(z,H)&&A.push(H)}),A},file:function(S,A,z){if(arguments.length!==1)return S=this.root+S,t.call(this,S,A,z),this;if(k(S)){var H=S;return this.filter(function(G,se){return!se.dir&&H.test(G)})}var D=this.files[this.root+S];return D&&!D.dir?D:null},folder:function(S){if(!S)return this;if(k(S))return this.filter(function(D,G){return G.dir&&S.test(D)});var A=this.root+S,z=w.call(this,A),H=this.clone();return H.root=z.name,H},remove:function(S){S=this.root+S;var A=this.files[S];if(A||(S.slice(-1)!=="/"&&(S+="/"),A=this.files[S]),A&&!A.dir)delete this.files[S];else for(var z=this.filter(function(D,G){return G.name.slice(0,S.length)===S}),H=0;H<z.length;H++)delete this.files[z[H].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(S){var A,z={};try{if((z=i.extend(S||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:n.utf8encode})).type=z.type.toLowerCase(),z.compression=z.compression.toUpperCase(),z.type==="binarystring"&&(z.type="string"),!z.type)throw new Error("No output type specified.");i.checkSupport(z.type),z.platform!=="darwin"&&z.platform!=="freebsd"&&z.platform!=="linux"&&z.platform!=="sunos"||(z.platform="UNIX"),z.platform==="win32"&&(z.platform="DOS");var H=z.comment||this.comment||"";A=u.generateWorker(this,z,H)}catch(D){(A=new r("error")).error(D)}return new m(A,z.type||"string",z.mimeType)},generateAsync:function(S,A){return this.generateInternalStream(S).accumulate(A)},generateNodeStream:function(S,A){return(S=S||{}).type||(S.type="nodebuffer"),this.generateInternalStream(S).toNodejsStream(A)}};l.exports=I},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,l,a){l.exports=e("stream")},{stream:void 0}],17:[function(e,l,a){var t=e("./DataReader");function n(i){t.call(this,i);for(var r=0;r<this.data.length;r++)i[r]=255&i[r]}e("../utils").inherits(n,t),n.prototype.byteAt=function(i){return this.data[this.zero+i]},n.prototype.lastIndexOfSignature=function(i){for(var r=i.charCodeAt(0),m=i.charCodeAt(1),b=i.charCodeAt(2),v=i.charCodeAt(3),h=this.length-4;0<=h;--h)if(this.data[h]===r&&this.data[h+1]===m&&this.data[h+2]===b&&this.data[h+3]===v)return h-this.zero;return-1},n.prototype.readAndCheckSignature=function(i){var r=i.charCodeAt(0),m=i.charCodeAt(1),b=i.charCodeAt(2),v=i.charCodeAt(3),h=this.readData(4);return r===h[0]&&m===h[1]&&b===h[2]&&v===h[3]},n.prototype.readData=function(i){if(this.checkOffset(i),i===0)return[];var r=this.data.slice(this.zero+this.index,this.zero+this.index+i);return this.index+=i,r},l.exports=n},{"../utils":32,"./DataReader":18}],18:[function(e,l,a){var t=e("../utils");function n(i){this.data=i,this.length=i.length,this.index=0,this.zero=0}n.prototype={checkOffset:function(i){this.checkIndex(this.index+i)},checkIndex:function(i){if(this.length<this.zero+i||i<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+i+"). Corrupted zip ?")},setIndex:function(i){this.checkIndex(i),this.index=i},skip:function(i){this.setIndex(this.index+i)},byteAt:function(){},readInt:function(i){var r,m=0;for(this.checkOffset(i),r=this.index+i-1;r>=this.index;r--)m=(m<<8)+this.byteAt(r);return this.index+=i,m},readString:function(i){return t.transformTo("string",this.readData(i))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var i=this.readInt(4);return new Date(Date.UTC(1980+(i>>25&127),(i>>21&15)-1,i>>16&31,i>>11&31,i>>5&63,(31&i)<<1))}},l.exports=n},{"../utils":32}],19:[function(e,l,a){var t=e("./Uint8ArrayReader");function n(i){t.call(this,i)}e("../utils").inherits(n,t),n.prototype.readData=function(i){this.checkOffset(i);var r=this.data.slice(this.zero+this.index,this.zero+this.index+i);return this.index+=i,r},l.exports=n},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,l,a){var t=e("./DataReader");function n(i){t.call(this,i)}e("../utils").inherits(n,t),n.prototype.byteAt=function(i){return this.data.charCodeAt(this.zero+i)},n.prototype.lastIndexOfSignature=function(i){return this.data.lastIndexOf(i)-this.zero},n.prototype.readAndCheckSignature=function(i){return i===this.readData(4)},n.prototype.readData=function(i){this.checkOffset(i);var r=this.data.slice(this.zero+this.index,this.zero+this.index+i);return this.index+=i,r},l.exports=n},{"../utils":32,"./DataReader":18}],21:[function(e,l,a){var t=e("./ArrayReader");function n(i){t.call(this,i)}e("../utils").inherits(n,t),n.prototype.readData=function(i){if(this.checkOffset(i),i===0)return new Uint8Array(0);var r=this.data.subarray(this.zero+this.index,this.zero+this.index+i);return this.index+=i,r},l.exports=n},{"../utils":32,"./ArrayReader":17}],22:[function(e,l,a){var t=e("../utils"),n=e("../support"),i=e("./ArrayReader"),r=e("./StringReader"),m=e("./NodeBufferReader"),b=e("./Uint8ArrayReader");l.exports=function(v){var h=t.getTypeOf(v);return t.checkSupport(h),h!=="string"||n.uint8array?h==="nodebuffer"?new m(v):n.uint8array?new b(t.transformTo("uint8array",v)):new i(t.transformTo("array",v)):new r(v)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,l,a){a.LOCAL_FILE_HEADER="PK",a.CENTRAL_FILE_HEADER="PK",a.CENTRAL_DIRECTORY_END="PK",a.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",a.ZIP64_CENTRAL_DIRECTORY_END="PK",a.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(e,l,a){var t=e("./GenericWorker"),n=e("../utils");function i(r){t.call(this,"ConvertWorker to "+r),this.destType=r}n.inherits(i,t),i.prototype.processChunk=function(r){this.push({data:n.transformTo(this.destType,r.data),meta:r.meta})},l.exports=i},{"../utils":32,"./GenericWorker":28}],25:[function(e,l,a){var t=e("./GenericWorker"),n=e("../crc32");function i(){t.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}e("../utils").inherits(i,t),i.prototype.processChunk=function(r){this.streamInfo.crc32=n(r.data,this.streamInfo.crc32||0),this.push(r)},l.exports=i},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,l,a){var t=e("../utils"),n=e("./GenericWorker");function i(r){n.call(this,"DataLengthProbe for "+r),this.propName=r,this.withStreamInfo(r,0)}t.inherits(i,n),i.prototype.processChunk=function(r){if(r){var m=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=m+r.data.length}n.prototype.processChunk.call(this,r)},l.exports=i},{"../utils":32,"./GenericWorker":28}],27:[function(e,l,a){var t=e("../utils"),n=e("./GenericWorker");function i(r){n.call(this,"DataWorker");var m=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,r.then(function(b){m.dataIsReady=!0,m.data=b,m.max=b&&b.length||0,m.type=t.getTypeOf(b),m.isPaused||m._tickAndRepeat()},function(b){m.error(b)})}t.inherits(i,n),i.prototype.cleanUp=function(){n.prototype.cleanUp.call(this),this.data=null},i.prototype.resume=function(){return!!n.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,t.delay(this._tickAndRepeat,[],this)),!0)},i.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(t.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},i.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var r=null,m=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":r=this.data.substring(this.index,m);break;case"uint8array":r=this.data.subarray(this.index,m);break;case"array":case"nodebuffer":r=this.data.slice(this.index,m)}return this.index=m,this.push({data:r,meta:{percent:this.max?this.index/this.max*100:0}})},l.exports=i},{"../utils":32,"./GenericWorker":28}],28:[function(e,l,a){function t(n){this.name=n||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}t.prototype={push:function(n){this.emit("data",n)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(n){this.emit("error",n)}return!0},error:function(n){return!this.isFinished&&(this.isPaused?this.generatedError=n:(this.isFinished=!0,this.emit("error",n),this.previous&&this.previous.error(n),this.cleanUp()),!0)},on:function(n,i){return this._listeners[n].push(i),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(n,i){if(this._listeners[n])for(var r=0;r<this._listeners[n].length;r++)this._listeners[n][r].call(this,i)},pipe:function(n){return n.registerPrevious(this)},registerPrevious:function(n){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=n.streamInfo,this.mergeStreamInfo(),this.previous=n;var i=this;return n.on("data",function(r){i.processChunk(r)}),n.on("end",function(){i.end()}),n.on("error",function(r){i.error(r)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var n=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),n=!0),this.previous&&this.previous.resume(),!n},flush:function(){},processChunk:function(n){this.push(n)},withStreamInfo:function(n,i){return this.extraStreamInfo[n]=i,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var n in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,n)&&(this.streamInfo[n]=this.extraStreamInfo[n])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var n="Worker "+this.name;return this.previous?this.previous+" -> "+n:n}},l.exports=t},{}],29:[function(e,l,a){var t=e("../utils"),n=e("./ConvertWorker"),i=e("./GenericWorker"),r=e("../base64"),m=e("../support"),b=e("../external"),v=null;if(m.nodestream)try{v=e("../nodejs/NodejsStreamOutputAdapter")}catch{}function h(p,f){return new b.Promise(function(y,g){var w=[],k=p._internalType,I=p._outputType,S=p._mimeType;p.on("data",function(A,z){w.push(A),f&&f(z)}).on("error",function(A){w=[],g(A)}).on("end",function(){try{var A=function(z,H,D){switch(z){case"blob":return t.newBlob(t.transformTo("arraybuffer",H),D);case"base64":return r.encode(H);default:return t.transformTo(z,H)}}(I,function(z,H){var D,G=0,se=null,E=0;for(D=0;D<H.length;D++)E+=H[D].length;switch(z){case"string":return H.join("");case"array":return Array.prototype.concat.apply([],H);case"uint8array":for(se=new Uint8Array(E),D=0;D<H.length;D++)se.set(H[D],G),G+=H[D].length;return se;case"nodebuffer":return Buffer.concat(H);default:throw new Error("concat : unsupported type '"+z+"'")}}(k,w),S);y(A)}catch(z){g(z)}w=[]}).resume()})}function u(p,f,y){var g=f;switch(f){case"blob":case"arraybuffer":g="uint8array";break;case"base64":g="string"}try{this._internalType=g,this._outputType=f,this._mimeType=y,t.checkSupport(g),this._worker=p.pipe(new n(g)),p.lock()}catch(w){this._worker=new i("error"),this._worker.error(w)}}u.prototype={accumulate:function(p){return h(this,p)},on:function(p,f){var y=this;return p==="data"?this._worker.on(p,function(g){f.call(y,g.data,g.meta)}):this._worker.on(p,function(){t.delay(f,arguments,y)}),this},resume:function(){return t.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(p){if(t.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new v(this,{objectMode:this._outputType!=="nodebuffer"},p)}},l.exports=u},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,l,a){if(a.base64=!0,a.array=!0,a.string=!0,a.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",a.nodebuffer=typeof Buffer<"u",a.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")a.blob=!1;else{var t=new ArrayBuffer(0);try{a.blob=new Blob([t],{type:"application/zip"}).size===0}catch{try{var n=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);n.append(t),a.blob=n.getBlob("application/zip").size===0}catch{a.blob=!1}}}try{a.nodestream=!!e("readable-stream").Readable}catch{a.nodestream=!1}},{"readable-stream":16}],31:[function(e,l,a){for(var t=e("./utils"),n=e("./support"),i=e("./nodejsUtils"),r=e("./stream/GenericWorker"),m=new Array(256),b=0;b<256;b++)m[b]=252<=b?6:248<=b?5:240<=b?4:224<=b?3:192<=b?2:1;m[254]=m[254]=1;function v(){r.call(this,"utf-8 decode"),this.leftOver=null}function h(){r.call(this,"utf-8 encode")}a.utf8encode=function(u){return n.nodebuffer?i.newBufferFrom(u,"utf-8"):function(p){var f,y,g,w,k,I=p.length,S=0;for(w=0;w<I;w++)(64512&(y=p.charCodeAt(w)))==55296&&w+1<I&&(64512&(g=p.charCodeAt(w+1)))==56320&&(y=65536+(y-55296<<10)+(g-56320),w++),S+=y<128?1:y<2048?2:y<65536?3:4;for(f=n.uint8array?new Uint8Array(S):new Array(S),w=k=0;k<S;w++)(64512&(y=p.charCodeAt(w)))==55296&&w+1<I&&(64512&(g=p.charCodeAt(w+1)))==56320&&(y=65536+(y-55296<<10)+(g-56320),w++),y<128?f[k++]=y:(y<2048?f[k++]=192|y>>>6:(y<65536?f[k++]=224|y>>>12:(f[k++]=240|y>>>18,f[k++]=128|y>>>12&63),f[k++]=128|y>>>6&63),f[k++]=128|63&y);return f}(u)},a.utf8decode=function(u){return n.nodebuffer?t.transformTo("nodebuffer",u).toString("utf-8"):function(p){var f,y,g,w,k=p.length,I=new Array(2*k);for(f=y=0;f<k;)if((g=p[f++])<128)I[y++]=g;else if(4<(w=m[g]))I[y++]=65533,f+=w-1;else{for(g&=w===2?31:w===3?15:7;1<w&&f<k;)g=g<<6|63&p[f++],w--;1<w?I[y++]=65533:g<65536?I[y++]=g:(g-=65536,I[y++]=55296|g>>10&1023,I[y++]=56320|1023&g)}return I.length!==y&&(I.subarray?I=I.subarray(0,y):I.length=y),t.applyFromCharCode(I)}(u=t.transformTo(n.uint8array?"uint8array":"array",u))},t.inherits(v,r),v.prototype.processChunk=function(u){var p=t.transformTo(n.uint8array?"uint8array":"array",u.data);if(this.leftOver&&this.leftOver.length){if(n.uint8array){var f=p;(p=new Uint8Array(f.length+this.leftOver.length)).set(this.leftOver,0),p.set(f,this.leftOver.length)}else p=this.leftOver.concat(p);this.leftOver=null}var y=function(w,k){var I;for((k=k||w.length)>w.length&&(k=w.length),I=k-1;0<=I&&(192&w[I])==128;)I--;return I<0||I===0?k:I+m[w[I]]>k?I:k}(p),g=p;y!==p.length&&(n.uint8array?(g=p.subarray(0,y),this.leftOver=p.subarray(y,p.length)):(g=p.slice(0,y),this.leftOver=p.slice(y,p.length))),this.push({data:a.utf8decode(g),meta:u.meta})},v.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:a.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},a.Utf8DecodeWorker=v,t.inherits(h,r),h.prototype.processChunk=function(u){this.push({data:a.utf8encode(u.data),meta:u.meta})},a.Utf8EncodeWorker=h},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,l,a){var t=e("./support"),n=e("./base64"),i=e("./nodejsUtils"),r=e("./external");function m(f){return f}function b(f,y){for(var g=0;g<f.length;++g)y[g]=255&f.charCodeAt(g);return y}e("setimmediate"),a.newBlob=function(f,y){a.checkSupport("blob");try{return new Blob([f],{type:y})}catch{try{var g=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return g.append(f),g.getBlob(y)}catch{throw new Error("Bug : can't construct the Blob.")}}};var v={stringifyByChunk:function(f,y,g){var w=[],k=0,I=f.length;if(I<=g)return String.fromCharCode.apply(null,f);for(;k<I;)y==="array"||y==="nodebuffer"?w.push(String.fromCharCode.apply(null,f.slice(k,Math.min(k+g,I)))):w.push(String.fromCharCode.apply(null,f.subarray(k,Math.min(k+g,I)))),k+=g;return w.join("")},stringifyByChar:function(f){for(var y="",g=0;g<f.length;g++)y+=String.fromCharCode(f[g]);return y},applyCanBeUsed:{uint8array:function(){try{return t.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}}(),nodebuffer:function(){try{return t.nodebuffer&&String.fromCharCode.apply(null,i.allocBuffer(1)).length===1}catch{return!1}}()}};function h(f){var y=65536,g=a.getTypeOf(f),w=!0;if(g==="uint8array"?w=v.applyCanBeUsed.uint8array:g==="nodebuffer"&&(w=v.applyCanBeUsed.nodebuffer),w)for(;1<y;)try{return v.stringifyByChunk(f,g,y)}catch{y=Math.floor(y/2)}return v.stringifyByChar(f)}function u(f,y){for(var g=0;g<f.length;g++)y[g]=f[g];return y}a.applyFromCharCode=h;var p={};p.string={string:m,array:function(f){return b(f,new Array(f.length))},arraybuffer:function(f){return p.string.uint8array(f).buffer},uint8array:function(f){return b(f,new Uint8Array(f.length))},nodebuffer:function(f){return b(f,i.allocBuffer(f.length))}},p.array={string:h,array:m,arraybuffer:function(f){return new Uint8Array(f).buffer},uint8array:function(f){return new Uint8Array(f)},nodebuffer:function(f){return i.newBufferFrom(f)}},p.arraybuffer={string:function(f){return h(new Uint8Array(f))},array:function(f){return u(new Uint8Array(f),new Array(f.byteLength))},arraybuffer:m,uint8array:function(f){return new Uint8Array(f)},nodebuffer:function(f){return i.newBufferFrom(new Uint8Array(f))}},p.uint8array={string:h,array:function(f){return u(f,new Array(f.length))},arraybuffer:function(f){return f.buffer},uint8array:m,nodebuffer:function(f){return i.newBufferFrom(f)}},p.nodebuffer={string:h,array:function(f){return u(f,new Array(f.length))},arraybuffer:function(f){return p.nodebuffer.uint8array(f).buffer},uint8array:function(f){return u(f,new Uint8Array(f.length))},nodebuffer:m},a.transformTo=function(f,y){if(y=y||"",!f)return y;a.checkSupport(f);var g=a.getTypeOf(y);return p[g][f](y)},a.resolve=function(f){for(var y=f.split("/"),g=[],w=0;w<y.length;w++){var k=y[w];k==="."||k===""&&w!==0&&w!==y.length-1||(k===".."?g.pop():g.push(k))}return g.join("/")},a.getTypeOf=function(f){return typeof f=="string"?"string":Object.prototype.toString.call(f)==="[object Array]"?"array":t.nodebuffer&&i.isBuffer(f)?"nodebuffer":t.uint8array&&f instanceof Uint8Array?"uint8array":t.arraybuffer&&f instanceof ArrayBuffer?"arraybuffer":void 0},a.checkSupport=function(f){if(!t[f.toLowerCase()])throw new Error(f+" is not supported by this platform")},a.MAX_VALUE_16BITS=65535,a.MAX_VALUE_32BITS=-1,a.pretty=function(f){var y,g,w="";for(g=0;g<(f||"").length;g++)w+="\\x"+((y=f.charCodeAt(g))<16?"0":"")+y.toString(16).toUpperCase();return w},a.delay=function(f,y,g){setImmediate(function(){f.apply(g||null,y||[])})},a.inherits=function(f,y){function g(){}g.prototype=y.prototype,f.prototype=new g},a.extend=function(){var f,y,g={};for(f=0;f<arguments.length;f++)for(y in arguments[f])Object.prototype.hasOwnProperty.call(arguments[f],y)&&g[y]===void 0&&(g[y]=arguments[f][y]);return g},a.prepareContent=function(f,y,g,w,k){return r.Promise.resolve(y).then(function(I){return t.blob&&(I instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(I))!==-1)&&typeof FileReader<"u"?new r.Promise(function(S,A){var z=new FileReader;z.onload=function(H){S(H.target.result)},z.onerror=function(H){A(H.target.error)},z.readAsArrayBuffer(I)}):I}).then(function(I){var S=a.getTypeOf(I);return S?(S==="arraybuffer"?I=a.transformTo("uint8array",I):S==="string"&&(k?I=n.decode(I):g&&w!==!0&&(I=function(A){return b(A,t.uint8array?new Uint8Array(A.length):new Array(A.length))}(I))),I):r.Promise.reject(new Error("Can't read the data of '"+f+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(e,l,a){var t=e("./reader/readerFor"),n=e("./utils"),i=e("./signature"),r=e("./zipEntry"),m=e("./support");function b(v){this.files=[],this.loadOptions=v}b.prototype={checkSignature:function(v){if(!this.reader.readAndCheckSignature(v)){this.reader.index-=4;var h=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+n.pretty(h)+", expected "+n.pretty(v)+")")}},isSignature:function(v,h){var u=this.reader.index;this.reader.setIndex(v);var p=this.reader.readString(4)===h;return this.reader.setIndex(u),p},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var v=this.reader.readData(this.zipCommentLength),h=m.uint8array?"uint8array":"array",u=n.transformTo(h,v);this.zipComment=this.loadOptions.decodeFileName(u)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var v,h,u,p=this.zip64EndOfCentralSize-44;0<p;)v=this.reader.readInt(2),h=this.reader.readInt(4),u=this.reader.readData(h),this.zip64ExtensibleData[v]={id:v,length:h,value:u}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var v,h;for(v=0;v<this.files.length;v++)h=this.files[v],this.reader.setIndex(h.localHeaderOffset),this.checkSignature(i.LOCAL_FILE_HEADER),h.readLocalPart(this.reader),h.handleUTF8(),h.processAttributes()},readCentralDir:function(){var v;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(i.CENTRAL_FILE_HEADER);)(v=new r({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(v);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var v=this.reader.lastIndexOfSignature(i.CENTRAL_DIRECTORY_END);if(v<0)throw this.isSignature(0,i.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(v);var h=v;if(this.checkSignature(i.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===n.MAX_VALUE_16BITS||this.diskWithCentralDirStart===n.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===n.MAX_VALUE_16BITS||this.centralDirRecords===n.MAX_VALUE_16BITS||this.centralDirSize===n.MAX_VALUE_32BITS||this.centralDirOffset===n.MAX_VALUE_32BITS){if(this.zip64=!0,(v=this.reader.lastIndexOfSignature(i.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(v),this.checkSignature(i.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,i.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(i.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(i.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var u=this.centralDirOffset+this.centralDirSize;this.zip64&&(u+=20,u+=12+this.zip64EndOfCentralSize);var p=h-u;if(0<p)this.isSignature(h,i.CENTRAL_FILE_HEADER)||(this.reader.zero=p);else if(p<0)throw new Error("Corrupted zip: missing "+Math.abs(p)+" bytes.")},prepareReader:function(v){this.reader=t(v)},load:function(v){this.prepareReader(v),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},l.exports=b},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(e,l,a){var t=e("./reader/readerFor"),n=e("./utils"),i=e("./compressedObject"),r=e("./crc32"),m=e("./utf8"),b=e("./compressions"),v=e("./support");function h(u,p){this.options=u,this.loadOptions=p}h.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(u){var p,f;if(u.skip(22),this.fileNameLength=u.readInt(2),f=u.readInt(2),this.fileName=u.readData(this.fileNameLength),u.skip(f),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((p=function(y){for(var g in b)if(Object.prototype.hasOwnProperty.call(b,g)&&b[g].magic===y)return b[g];return null}(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+n.pretty(this.compressionMethod)+" unknown (inner file : "+n.transformTo("string",this.fileName)+")");this.decompressed=new i(this.compressedSize,this.uncompressedSize,this.crc32,p,u.readData(this.compressedSize))},readCentralPart:function(u){this.versionMadeBy=u.readInt(2),u.skip(2),this.bitFlag=u.readInt(2),this.compressionMethod=u.readString(2),this.date=u.readDate(),this.crc32=u.readInt(4),this.compressedSize=u.readInt(4),this.uncompressedSize=u.readInt(4);var p=u.readInt(2);if(this.extraFieldsLength=u.readInt(2),this.fileCommentLength=u.readInt(2),this.diskNumberStart=u.readInt(2),this.internalFileAttributes=u.readInt(2),this.externalFileAttributes=u.readInt(4),this.localHeaderOffset=u.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");u.skip(p),this.readExtraFields(u),this.parseZIP64ExtraField(u),this.fileComment=u.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var u=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),u==0&&(this.dosPermissions=63&this.externalFileAttributes),u==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var u=t(this.extraFields[1].value);this.uncompressedSize===n.MAX_VALUE_32BITS&&(this.uncompressedSize=u.readInt(8)),this.compressedSize===n.MAX_VALUE_32BITS&&(this.compressedSize=u.readInt(8)),this.localHeaderOffset===n.MAX_VALUE_32BITS&&(this.localHeaderOffset=u.readInt(8)),this.diskNumberStart===n.MAX_VALUE_32BITS&&(this.diskNumberStart=u.readInt(4))}},readExtraFields:function(u){var p,f,y,g=u.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});u.index+4<g;)p=u.readInt(2),f=u.readInt(2),y=u.readData(f),this.extraFields[p]={id:p,length:f,value:y};u.setIndex(g)},handleUTF8:function(){var u=v.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=m.utf8decode(this.fileName),this.fileCommentStr=m.utf8decode(this.fileComment);else{var p=this.findExtraFieldUnicodePath();if(p!==null)this.fileNameStr=p;else{var f=n.transformTo(u,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(f)}var y=this.findExtraFieldUnicodeComment();if(y!==null)this.fileCommentStr=y;else{var g=n.transformTo(u,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(g)}}},findExtraFieldUnicodePath:function(){var u=this.extraFields[28789];if(u){var p=t(u.value);return p.readInt(1)!==1||r(this.fileName)!==p.readInt(4)?null:m.utf8decode(p.readData(u.length-5))}return null},findExtraFieldUnicodeComment:function(){var u=this.extraFields[25461];if(u){var p=t(u.value);return p.readInt(1)!==1||r(this.fileComment)!==p.readInt(4)?null:m.utf8decode(p.readData(u.length-5))}return null}},l.exports=h},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(e,l,a){function t(p,f,y){this.name=p,this.dir=y.dir,this.date=y.date,this.comment=y.comment,this.unixPermissions=y.unixPermissions,this.dosPermissions=y.dosPermissions,this._data=f,this._dataBinary=y.binary,this.options={compression:y.compression,compressionOptions:y.compressionOptions}}var n=e("./stream/StreamHelper"),i=e("./stream/DataWorker"),r=e("./utf8"),m=e("./compressedObject"),b=e("./stream/GenericWorker");t.prototype={internalStream:function(p){var f=null,y="string";try{if(!p)throw new Error("No output type specified.");var g=(y=p.toLowerCase())==="string"||y==="text";y!=="binarystring"&&y!=="text"||(y="string"),f=this._decompressWorker();var w=!this._dataBinary;w&&!g&&(f=f.pipe(new r.Utf8EncodeWorker)),!w&&g&&(f=f.pipe(new r.Utf8DecodeWorker))}catch(k){(f=new b("error")).error(k)}return new n(f,y,"")},async:function(p,f){return this.internalStream(p).accumulate(f)},nodeStream:function(p,f){return this.internalStream(p||"nodebuffer").toNodejsStream(f)},_compressWorker:function(p,f){if(this._data instanceof m&&this._data.compression.magic===p.magic)return this._data.getCompressedWorker();var y=this._decompressWorker();return this._dataBinary||(y=y.pipe(new r.Utf8EncodeWorker)),m.createWorkerFrom(y,p,f)},_decompressWorker:function(){return this._data instanceof m?this._data.getContentWorker():this._data instanceof b?this._data:new i(this._data)}};for(var v=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],h=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},u=0;u<v.length;u++)t.prototype[v[u]]=h;l.exports=t},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(e,l,a){(function(t){var n,i,r=t.MutationObserver||t.WebKitMutationObserver;if(r){var m=0,b=new r(p),v=t.document.createTextNode("");b.observe(v,{characterData:!0}),n=function(){v.data=m=++m%2}}else if(t.setImmediate||t.MessageChannel===void 0)n="document"in t&&"onreadystatechange"in t.document.createElement("script")?function(){var f=t.document.createElement("script");f.onreadystatechange=function(){p(),f.onreadystatechange=null,f.parentNode.removeChild(f),f=null},t.document.documentElement.appendChild(f)}:function(){setTimeout(p,0)};else{var h=new t.MessageChannel;h.port1.onmessage=p,n=function(){h.port2.postMessage(0)}}var u=[];function p(){var f,y;i=!0;for(var g=u.length;g;){for(y=u,u=[],f=-1;++f<g;)y[f]();g=u.length}i=!1}l.exports=function(f){u.push(f)!==1||i||n()}}).call(this,typeof nn<"u"?nn:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(e,l,a){var t=e("immediate");function n(){}var i={},r=["REJECTED"],m=["FULFILLED"],b=["PENDING"];function v(g){if(typeof g!="function")throw new TypeError("resolver must be a function");this.state=b,this.queue=[],this.outcome=void 0,g!==n&&f(this,g)}function h(g,w,k){this.promise=g,typeof w=="function"&&(this.onFulfilled=w,this.callFulfilled=this.otherCallFulfilled),typeof k=="function"&&(this.onRejected=k,this.callRejected=this.otherCallRejected)}function u(g,w,k){t(function(){var I;try{I=w(k)}catch(S){return i.reject(g,S)}I===g?i.reject(g,new TypeError("Cannot resolve promise with itself")):i.resolve(g,I)})}function p(g){var w=g&&g.then;if(g&&(typeof g=="object"||typeof g=="function")&&typeof w=="function")return function(){w.apply(g,arguments)}}function f(g,w){var k=!1;function I(z){k||(k=!0,i.reject(g,z))}function S(z){k||(k=!0,i.resolve(g,z))}var A=y(function(){w(S,I)});A.status==="error"&&I(A.value)}function y(g,w){var k={};try{k.value=g(w),k.status="success"}catch(I){k.status="error",k.value=I}return k}(l.exports=v).prototype.finally=function(g){if(typeof g!="function")return this;var w=this.constructor;return this.then(function(k){return w.resolve(g()).then(function(){return k})},function(k){return w.resolve(g()).then(function(){throw k})})},v.prototype.catch=function(g){return this.then(null,g)},v.prototype.then=function(g,w){if(typeof g!="function"&&this.state===m||typeof w!="function"&&this.state===r)return this;var k=new this.constructor(n);return this.state!==b?u(k,this.state===m?g:w,this.outcome):this.queue.push(new h(k,g,w)),k},h.prototype.callFulfilled=function(g){i.resolve(this.promise,g)},h.prototype.otherCallFulfilled=function(g){u(this.promise,this.onFulfilled,g)},h.prototype.callRejected=function(g){i.reject(this.promise,g)},h.prototype.otherCallRejected=function(g){u(this.promise,this.onRejected,g)},i.resolve=function(g,w){var k=y(p,w);if(k.status==="error")return i.reject(g,k.value);var I=k.value;if(I)f(g,I);else{g.state=m,g.outcome=w;for(var S=-1,A=g.queue.length;++S<A;)g.queue[S].callFulfilled(w)}return g},i.reject=function(g,w){g.state=r,g.outcome=w;for(var k=-1,I=g.queue.length;++k<I;)g.queue[k].callRejected(w);return g},v.resolve=function(g){return g instanceof this?g:i.resolve(new this(n),g)},v.reject=function(g){var w=new this(n);return i.reject(w,g)},v.all=function(g){var w=this;if(Object.prototype.toString.call(g)!=="[object Array]")return this.reject(new TypeError("must be an array"));var k=g.length,I=!1;if(!k)return this.resolve([]);for(var S=new Array(k),A=0,z=-1,H=new this(n);++z<k;)D(g[z],z);return H;function D(G,se){w.resolve(G).then(function(E){S[se]=E,++A!==k||I||(I=!0,i.resolve(H,S))},function(E){I||(I=!0,i.reject(H,E))})}},v.race=function(g){var w=this;if(Object.prototype.toString.call(g)!=="[object Array]")return this.reject(new TypeError("must be an array"));var k=g.length,I=!1;if(!k)return this.resolve([]);for(var S=-1,A=new this(n);++S<k;)z=g[S],w.resolve(z).then(function(H){I||(I=!0,i.resolve(A,H))},function(H){I||(I=!0,i.reject(A,H))});var z;return A}},{immediate:36}],38:[function(e,l,a){var t={};(0,e("./lib/utils/common").assign)(t,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),l.exports=t},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(e,l,a){var t=e("./zlib/deflate"),n=e("./utils/common"),i=e("./utils/strings"),r=e("./zlib/messages"),m=e("./zlib/zstream"),b=Object.prototype.toString,v=0,h=-1,u=0,p=8;function f(g){if(!(this instanceof f))return new f(g);this.options=n.assign({level:h,method:p,chunkSize:16384,windowBits:15,memLevel:8,strategy:u,to:""},g||{});var w=this.options;w.raw&&0<w.windowBits?w.windowBits=-w.windowBits:w.gzip&&0<w.windowBits&&w.windowBits<16&&(w.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new m,this.strm.avail_out=0;var k=t.deflateInit2(this.strm,w.level,w.method,w.windowBits,w.memLevel,w.strategy);if(k!==v)throw new Error(r[k]);if(w.header&&t.deflateSetHeader(this.strm,w.header),w.dictionary){var I;if(I=typeof w.dictionary=="string"?i.string2buf(w.dictionary):b.call(w.dictionary)==="[object ArrayBuffer]"?new Uint8Array(w.dictionary):w.dictionary,(k=t.deflateSetDictionary(this.strm,I))!==v)throw new Error(r[k]);this._dict_set=!0}}function y(g,w){var k=new f(w);if(k.push(g,!0),k.err)throw k.msg||r[k.err];return k.result}f.prototype.push=function(g,w){var k,I,S=this.strm,A=this.options.chunkSize;if(this.ended)return!1;I=w===~~w?w:w===!0?4:0,typeof g=="string"?S.input=i.string2buf(g):b.call(g)==="[object ArrayBuffer]"?S.input=new Uint8Array(g):S.input=g,S.next_in=0,S.avail_in=S.input.length;do{if(S.avail_out===0&&(S.output=new n.Buf8(A),S.next_out=0,S.avail_out=A),(k=t.deflate(S,I))!==1&&k!==v)return this.onEnd(k),!(this.ended=!0);S.avail_out!==0&&(S.avail_in!==0||I!==4&&I!==2)||(this.options.to==="string"?this.onData(i.buf2binstring(n.shrinkBuf(S.output,S.next_out))):this.onData(n.shrinkBuf(S.output,S.next_out)))}while((0<S.avail_in||S.avail_out===0)&&k!==1);return I===4?(k=t.deflateEnd(this.strm),this.onEnd(k),this.ended=!0,k===v):I!==2||(this.onEnd(v),!(S.avail_out=0))},f.prototype.onData=function(g){this.chunks.push(g)},f.prototype.onEnd=function(g){g===v&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=g,this.msg=this.strm.msg},a.Deflate=f,a.deflate=y,a.deflateRaw=function(g,w){return(w=w||{}).raw=!0,y(g,w)},a.gzip=function(g,w){return(w=w||{}).gzip=!0,y(g,w)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(e,l,a){var t=e("./zlib/inflate"),n=e("./utils/common"),i=e("./utils/strings"),r=e("./zlib/constants"),m=e("./zlib/messages"),b=e("./zlib/zstream"),v=e("./zlib/gzheader"),h=Object.prototype.toString;function u(f){if(!(this instanceof u))return new u(f);this.options=n.assign({chunkSize:16384,windowBits:0,to:""},f||{});var y=this.options;y.raw&&0<=y.windowBits&&y.windowBits<16&&(y.windowBits=-y.windowBits,y.windowBits===0&&(y.windowBits=-15)),!(0<=y.windowBits&&y.windowBits<16)||f&&f.windowBits||(y.windowBits+=32),15<y.windowBits&&y.windowBits<48&&!(15&y.windowBits)&&(y.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new b,this.strm.avail_out=0;var g=t.inflateInit2(this.strm,y.windowBits);if(g!==r.Z_OK)throw new Error(m[g]);this.header=new v,t.inflateGetHeader(this.strm,this.header)}function p(f,y){var g=new u(y);if(g.push(f,!0),g.err)throw g.msg||m[g.err];return g.result}u.prototype.push=function(f,y){var g,w,k,I,S,A,z=this.strm,H=this.options.chunkSize,D=this.options.dictionary,G=!1;if(this.ended)return!1;w=y===~~y?y:y===!0?r.Z_FINISH:r.Z_NO_FLUSH,typeof f=="string"?z.input=i.binstring2buf(f):h.call(f)==="[object ArrayBuffer]"?z.input=new Uint8Array(f):z.input=f,z.next_in=0,z.avail_in=z.input.length;do{if(z.avail_out===0&&(z.output=new n.Buf8(H),z.next_out=0,z.avail_out=H),(g=t.inflate(z,r.Z_NO_FLUSH))===r.Z_NEED_DICT&&D&&(A=typeof D=="string"?i.string2buf(D):h.call(D)==="[object ArrayBuffer]"?new Uint8Array(D):D,g=t.inflateSetDictionary(this.strm,A)),g===r.Z_BUF_ERROR&&G===!0&&(g=r.Z_OK,G=!1),g!==r.Z_STREAM_END&&g!==r.Z_OK)return this.onEnd(g),!(this.ended=!0);z.next_out&&(z.avail_out!==0&&g!==r.Z_STREAM_END&&(z.avail_in!==0||w!==r.Z_FINISH&&w!==r.Z_SYNC_FLUSH)||(this.options.to==="string"?(k=i.utf8border(z.output,z.next_out),I=z.next_out-k,S=i.buf2string(z.output,k),z.next_out=I,z.avail_out=H-I,I&&n.arraySet(z.output,z.output,k,I,0),this.onData(S)):this.onData(n.shrinkBuf(z.output,z.next_out)))),z.avail_in===0&&z.avail_out===0&&(G=!0)}while((0<z.avail_in||z.avail_out===0)&&g!==r.Z_STREAM_END);return g===r.Z_STREAM_END&&(w=r.Z_FINISH),w===r.Z_FINISH?(g=t.inflateEnd(this.strm),this.onEnd(g),this.ended=!0,g===r.Z_OK):w!==r.Z_SYNC_FLUSH||(this.onEnd(r.Z_OK),!(z.avail_out=0))},u.prototype.onData=function(f){this.chunks.push(f)},u.prototype.onEnd=function(f){f===r.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=f,this.msg=this.strm.msg},a.Inflate=u,a.inflate=p,a.inflateRaw=function(f,y){return(y=y||{}).raw=!0,p(f,y)},a.ungzip=p},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(e,l,a){var t=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";a.assign=function(r){for(var m=Array.prototype.slice.call(arguments,1);m.length;){var b=m.shift();if(b){if(typeof b!="object")throw new TypeError(b+"must be non-object");for(var v in b)b.hasOwnProperty(v)&&(r[v]=b[v])}}return r},a.shrinkBuf=function(r,m){return r.length===m?r:r.subarray?r.subarray(0,m):(r.length=m,r)};var n={arraySet:function(r,m,b,v,h){if(m.subarray&&r.subarray)r.set(m.subarray(b,b+v),h);else for(var u=0;u<v;u++)r[h+u]=m[b+u]},flattenChunks:function(r){var m,b,v,h,u,p;for(m=v=0,b=r.length;m<b;m++)v+=r[m].length;for(p=new Uint8Array(v),m=h=0,b=r.length;m<b;m++)u=r[m],p.set(u,h),h+=u.length;return p}},i={arraySet:function(r,m,b,v,h){for(var u=0;u<v;u++)r[h+u]=m[b+u]},flattenChunks:function(r){return[].concat.apply([],r)}};a.setTyped=function(r){r?(a.Buf8=Uint8Array,a.Buf16=Uint16Array,a.Buf32=Int32Array,a.assign(a,n)):(a.Buf8=Array,a.Buf16=Array,a.Buf32=Array,a.assign(a,i))},a.setTyped(t)},{}],42:[function(e,l,a){var t=e("./common"),n=!0,i=!0;try{String.fromCharCode.apply(null,[0])}catch{n=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{i=!1}for(var r=new t.Buf8(256),m=0;m<256;m++)r[m]=252<=m?6:248<=m?5:240<=m?4:224<=m?3:192<=m?2:1;function b(v,h){if(h<65537&&(v.subarray&&i||!v.subarray&&n))return String.fromCharCode.apply(null,t.shrinkBuf(v,h));for(var u="",p=0;p<h;p++)u+=String.fromCharCode(v[p]);return u}r[254]=r[254]=1,a.string2buf=function(v){var h,u,p,f,y,g=v.length,w=0;for(f=0;f<g;f++)(64512&(u=v.charCodeAt(f)))==55296&&f+1<g&&(64512&(p=v.charCodeAt(f+1)))==56320&&(u=65536+(u-55296<<10)+(p-56320),f++),w+=u<128?1:u<2048?2:u<65536?3:4;for(h=new t.Buf8(w),f=y=0;y<w;f++)(64512&(u=v.charCodeAt(f)))==55296&&f+1<g&&(64512&(p=v.charCodeAt(f+1)))==56320&&(u=65536+(u-55296<<10)+(p-56320),f++),u<128?h[y++]=u:(u<2048?h[y++]=192|u>>>6:(u<65536?h[y++]=224|u>>>12:(h[y++]=240|u>>>18,h[y++]=128|u>>>12&63),h[y++]=128|u>>>6&63),h[y++]=128|63&u);return h},a.buf2binstring=function(v){return b(v,v.length)},a.binstring2buf=function(v){for(var h=new t.Buf8(v.length),u=0,p=h.length;u<p;u++)h[u]=v.charCodeAt(u);return h},a.buf2string=function(v,h){var u,p,f,y,g=h||v.length,w=new Array(2*g);for(u=p=0;u<g;)if((f=v[u++])<128)w[p++]=f;else if(4<(y=r[f]))w[p++]=65533,u+=y-1;else{for(f&=y===2?31:y===3?15:7;1<y&&u<g;)f=f<<6|63&v[u++],y--;1<y?w[p++]=65533:f<65536?w[p++]=f:(f-=65536,w[p++]=55296|f>>10&1023,w[p++]=56320|1023&f)}return b(w,p)},a.utf8border=function(v,h){var u;for((h=h||v.length)>v.length&&(h=v.length),u=h-1;0<=u&&(192&v[u])==128;)u--;return u<0||u===0?h:u+r[v[u]]>h?u:h}},{"./common":41}],43:[function(e,l,a){l.exports=function(t,n,i,r){for(var m=65535&t|0,b=t>>>16&65535|0,v=0;i!==0;){for(i-=v=2e3<i?2e3:i;b=b+(m=m+n[r++]|0)|0,--v;);m%=65521,b%=65521}return m|b<<16|0}},{}],44:[function(e,l,a){l.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(e,l,a){var t=function(){for(var n,i=[],r=0;r<256;r++){n=r;for(var m=0;m<8;m++)n=1&n?3988292384^n>>>1:n>>>1;i[r]=n}return i}();l.exports=function(n,i,r,m){var b=t,v=m+r;n^=-1;for(var h=m;h<v;h++)n=n>>>8^b[255&(n^i[h])];return-1^n}},{}],46:[function(e,l,a){var t,n=e("../utils/common"),i=e("./trees"),r=e("./adler32"),m=e("./crc32"),b=e("./messages"),v=0,h=4,u=0,p=-2,f=-1,y=4,g=2,w=8,k=9,I=286,S=30,A=19,z=2*I+1,H=15,D=3,G=258,se=G+D+1,E=42,M=113,d=1,P=2,de=3,j=4;function ue(o,F){return o.msg=b[F],F}function $(o){return(o<<1)-(4<o?9:0)}function te(o){for(var F=o.length;0<=--F;)o[F]=0}function N(o){var F=o.state,R=F.pending;R>o.avail_out&&(R=o.avail_out),R!==0&&(n.arraySet(o.output,F.pending_buf,F.pending_out,R,o.next_out),o.next_out+=R,F.pending_out+=R,o.total_out+=R,o.avail_out-=R,F.pending-=R,F.pending===0&&(F.pending_out=0))}function T(o,F){i._tr_flush_block(o,0<=o.block_start?o.block_start:-1,o.strstart-o.block_start,F),o.block_start=o.strstart,N(o.strm)}function ae(o,F){o.pending_buf[o.pending++]=F}function ee(o,F){o.pending_buf[o.pending++]=F>>>8&255,o.pending_buf[o.pending++]=255&F}function X(o,F){var R,_,C=o.max_chain_length,x=o.strstart,U=o.prev_length,W=o.nice_match,B=o.strstart>o.w_size-se?o.strstart-(o.w_size-se):0,V=o.window,ne=o.w_mask,K=o.prev,oe=o.strstart+G,Ee=V[x+U-1],ye=V[x+U];o.prev_length>=o.good_match&&(C>>=2),W>o.lookahead&&(W=o.lookahead);do if(V[(R=F)+U]===ye&&V[R+U-1]===Ee&&V[R]===V[x]&&V[++R]===V[x+1]){x+=2,R++;do;while(V[++x]===V[++R]&&V[++x]===V[++R]&&V[++x]===V[++R]&&V[++x]===V[++R]&&V[++x]===V[++R]&&V[++x]===V[++R]&&V[++x]===V[++R]&&V[++x]===V[++R]&&x<oe);if(_=G-(oe-x),x=oe-G,U<_){if(o.match_start=F,W<=(U=_))break;Ee=V[x+U-1],ye=V[x+U]}}while((F=K[F&ne])>B&&--C!=0);return U<=o.lookahead?U:o.lookahead}function Le(o){var F,R,_,C,x,U,W,B,V,ne,K=o.w_size;do{if(C=o.window_size-o.lookahead-o.strstart,o.strstart>=K+(K-se)){for(n.arraySet(o.window,o.window,K,K,0),o.match_start-=K,o.strstart-=K,o.block_start-=K,F=R=o.hash_size;_=o.head[--F],o.head[F]=K<=_?_-K:0,--R;);for(F=R=K;_=o.prev[--F],o.prev[F]=K<=_?_-K:0,--R;);C+=K}if(o.strm.avail_in===0)break;if(U=o.strm,W=o.window,B=o.strstart+o.lookahead,V=C,ne=void 0,ne=U.avail_in,V<ne&&(ne=V),R=ne===0?0:(U.avail_in-=ne,n.arraySet(W,U.input,U.next_in,ne,B),U.state.wrap===1?U.adler=r(U.adler,W,ne,B):U.state.wrap===2&&(U.adler=m(U.adler,W,ne,B)),U.next_in+=ne,U.total_in+=ne,ne),o.lookahead+=R,o.lookahead+o.insert>=D)for(x=o.strstart-o.insert,o.ins_h=o.window[x],o.ins_h=(o.ins_h<<o.hash_shift^o.window[x+1])&o.hash_mask;o.insert&&(o.ins_h=(o.ins_h<<o.hash_shift^o.window[x+D-1])&o.hash_mask,o.prev[x&o.w_mask]=o.head[o.ins_h],o.head[o.ins_h]=x,x++,o.insert--,!(o.lookahead+o.insert<D)););}while(o.lookahead<se&&o.strm.avail_in!==0)}function De(o,F){for(var R,_;;){if(o.lookahead<se){if(Le(o),o.lookahead<se&&F===v)return d;if(o.lookahead===0)break}if(R=0,o.lookahead>=D&&(o.ins_h=(o.ins_h<<o.hash_shift^o.window[o.strstart+D-1])&o.hash_mask,R=o.prev[o.strstart&o.w_mask]=o.head[o.ins_h],o.head[o.ins_h]=o.strstart),R!==0&&o.strstart-R<=o.w_size-se&&(o.match_length=X(o,R)),o.match_length>=D)if(_=i._tr_tally(o,o.strstart-o.match_start,o.match_length-D),o.lookahead-=o.match_length,o.match_length<=o.max_lazy_match&&o.lookahead>=D){for(o.match_length--;o.strstart++,o.ins_h=(o.ins_h<<o.hash_shift^o.window[o.strstart+D-1])&o.hash_mask,R=o.prev[o.strstart&o.w_mask]=o.head[o.ins_h],o.head[o.ins_h]=o.strstart,--o.match_length!=0;);o.strstart++}else o.strstart+=o.match_length,o.match_length=0,o.ins_h=o.window[o.strstart],o.ins_h=(o.ins_h<<o.hash_shift^o.window[o.strstart+1])&o.hash_mask;else _=i._tr_tally(o,0,o.window[o.strstart]),o.lookahead--,o.strstart++;if(_&&(T(o,!1),o.strm.avail_out===0))return d}return o.insert=o.strstart<D-1?o.strstart:D-1,F===h?(T(o,!0),o.strm.avail_out===0?de:j):o.last_lit&&(T(o,!1),o.strm.avail_out===0)?d:P}function ge(o,F){for(var R,_,C;;){if(o.lookahead<se){if(Le(o),o.lookahead<se&&F===v)return d;if(o.lookahead===0)break}if(R=0,o.lookahead>=D&&(o.ins_h=(o.ins_h<<o.hash_shift^o.window[o.strstart+D-1])&o.hash_mask,R=o.prev[o.strstart&o.w_mask]=o.head[o.ins_h],o.head[o.ins_h]=o.strstart),o.prev_length=o.match_length,o.prev_match=o.match_start,o.match_length=D-1,R!==0&&o.prev_length<o.max_lazy_match&&o.strstart-R<=o.w_size-se&&(o.match_length=X(o,R),o.match_length<=5&&(o.strategy===1||o.match_length===D&&4096<o.strstart-o.match_start)&&(o.match_length=D-1)),o.prev_length>=D&&o.match_length<=o.prev_length){for(C=o.strstart+o.lookahead-D,_=i._tr_tally(o,o.strstart-1-o.prev_match,o.prev_length-D),o.lookahead-=o.prev_length-1,o.prev_length-=2;++o.strstart<=C&&(o.ins_h=(o.ins_h<<o.hash_shift^o.window[o.strstart+D-1])&o.hash_mask,R=o.prev[o.strstart&o.w_mask]=o.head[o.ins_h],o.head[o.ins_h]=o.strstart),--o.prev_length!=0;);if(o.match_available=0,o.match_length=D-1,o.strstart++,_&&(T(o,!1),o.strm.avail_out===0))return d}else if(o.match_available){if((_=i._tr_tally(o,0,o.window[o.strstart-1]))&&T(o,!1),o.strstart++,o.lookahead--,o.strm.avail_out===0)return d}else o.match_available=1,o.strstart++,o.lookahead--}return o.match_available&&(_=i._tr_tally(o,0,o.window[o.strstart-1]),o.match_available=0),o.insert=o.strstart<D-1?o.strstart:D-1,F===h?(T(o,!0),o.strm.avail_out===0?de:j):o.last_lit&&(T(o,!1),o.strm.avail_out===0)?d:P}function be(o,F,R,_,C){this.good_length=o,this.max_lazy=F,this.nice_length=R,this.max_chain=_,this.func=C}function Ae(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=w,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new n.Buf16(2*z),this.dyn_dtree=new n.Buf16(2*(2*S+1)),this.bl_tree=new n.Buf16(2*(2*A+1)),te(this.dyn_ltree),te(this.dyn_dtree),te(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new n.Buf16(H+1),this.heap=new n.Buf16(2*I+1),te(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new n.Buf16(2*I+1),te(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function Te(o){var F;return o&&o.state?(o.total_in=o.total_out=0,o.data_type=g,(F=o.state).pending=0,F.pending_out=0,F.wrap<0&&(F.wrap=-F.wrap),F.status=F.wrap?E:M,o.adler=F.wrap===2?0:1,F.last_flush=v,i._tr_init(F),u):ue(o,p)}function Ke(o){var F=Te(o);return F===u&&function(R){R.window_size=2*R.w_size,te(R.head),R.max_lazy_match=t[R.level].max_lazy,R.good_match=t[R.level].good_length,R.nice_match=t[R.level].nice_length,R.max_chain_length=t[R.level].max_chain,R.strstart=0,R.block_start=0,R.lookahead=0,R.insert=0,R.match_length=R.prev_length=D-1,R.match_available=0,R.ins_h=0}(o.state),F}function Je(o,F,R,_,C,x){if(!o)return p;var U=1;if(F===f&&(F=6),_<0?(U=0,_=-_):15<_&&(U=2,_-=16),C<1||k<C||R!==w||_<8||15<_||F<0||9<F||x<0||y<x)return ue(o,p);_===8&&(_=9);var W=new Ae;return(o.state=W).strm=o,W.wrap=U,W.gzhead=null,W.w_bits=_,W.w_size=1<<W.w_bits,W.w_mask=W.w_size-1,W.hash_bits=C+7,W.hash_size=1<<W.hash_bits,W.hash_mask=W.hash_size-1,W.hash_shift=~~((W.hash_bits+D-1)/D),W.window=new n.Buf8(2*W.w_size),W.head=new n.Buf16(W.hash_size),W.prev=new n.Buf16(W.w_size),W.lit_bufsize=1<<C+6,W.pending_buf_size=4*W.lit_bufsize,W.pending_buf=new n.Buf8(W.pending_buf_size),W.d_buf=1*W.lit_bufsize,W.l_buf=3*W.lit_bufsize,W.level=F,W.strategy=x,W.method=R,Ke(o)}t=[new be(0,0,0,0,function(o,F){var R=65535;for(R>o.pending_buf_size-5&&(R=o.pending_buf_size-5);;){if(o.lookahead<=1){if(Le(o),o.lookahead===0&&F===v)return d;if(o.lookahead===0)break}o.strstart+=o.lookahead,o.lookahead=0;var _=o.block_start+R;if((o.strstart===0||o.strstart>=_)&&(o.lookahead=o.strstart-_,o.strstart=_,T(o,!1),o.strm.avail_out===0)||o.strstart-o.block_start>=o.w_size-se&&(T(o,!1),o.strm.avail_out===0))return d}return o.insert=0,F===h?(T(o,!0),o.strm.avail_out===0?de:j):(o.strstart>o.block_start&&(T(o,!1),o.strm.avail_out),d)}),new be(4,4,8,4,De),new be(4,5,16,8,De),new be(4,6,32,32,De),new be(4,4,16,16,ge),new be(8,16,32,32,ge),new be(8,16,128,128,ge),new be(8,32,128,256,ge),new be(32,128,258,1024,ge),new be(32,258,258,4096,ge)],a.deflateInit=function(o,F){return Je(o,F,w,15,8,0)},a.deflateInit2=Je,a.deflateReset=Ke,a.deflateResetKeep=Te,a.deflateSetHeader=function(o,F){return o&&o.state?o.state.wrap!==2?p:(o.state.gzhead=F,u):p},a.deflate=function(o,F){var R,_,C,x;if(!o||!o.state||5<F||F<0)return o?ue(o,p):p;if(_=o.state,!o.output||!o.input&&o.avail_in!==0||_.status===666&&F!==h)return ue(o,o.avail_out===0?-5:p);if(_.strm=o,R=_.last_flush,_.last_flush=F,_.status===E)if(_.wrap===2)o.adler=0,ae(_,31),ae(_,139),ae(_,8),_.gzhead?(ae(_,(_.gzhead.text?1:0)+(_.gzhead.hcrc?2:0)+(_.gzhead.extra?4:0)+(_.gzhead.name?8:0)+(_.gzhead.comment?16:0)),ae(_,255&_.gzhead.time),ae(_,_.gzhead.time>>8&255),ae(_,_.gzhead.time>>16&255),ae(_,_.gzhead.time>>24&255),ae(_,_.level===9?2:2<=_.strategy||_.level<2?4:0),ae(_,255&_.gzhead.os),_.gzhead.extra&&_.gzhead.extra.length&&(ae(_,255&_.gzhead.extra.length),ae(_,_.gzhead.extra.length>>8&255)),_.gzhead.hcrc&&(o.adler=m(o.adler,_.pending_buf,_.pending,0)),_.gzindex=0,_.status=69):(ae(_,0),ae(_,0),ae(_,0),ae(_,0),ae(_,0),ae(_,_.level===9?2:2<=_.strategy||_.level<2?4:0),ae(_,3),_.status=M);else{var U=w+(_.w_bits-8<<4)<<8;U|=(2<=_.strategy||_.level<2?0:_.level<6?1:_.level===6?2:3)<<6,_.strstart!==0&&(U|=32),U+=31-U%31,_.status=M,ee(_,U),_.strstart!==0&&(ee(_,o.adler>>>16),ee(_,65535&o.adler)),o.adler=1}if(_.status===69)if(_.gzhead.extra){for(C=_.pending;_.gzindex<(65535&_.gzhead.extra.length)&&(_.pending!==_.pending_buf_size||(_.gzhead.hcrc&&_.pending>C&&(o.adler=m(o.adler,_.pending_buf,_.pending-C,C)),N(o),C=_.pending,_.pending!==_.pending_buf_size));)ae(_,255&_.gzhead.extra[_.gzindex]),_.gzindex++;_.gzhead.hcrc&&_.pending>C&&(o.adler=m(o.adler,_.pending_buf,_.pending-C,C)),_.gzindex===_.gzhead.extra.length&&(_.gzindex=0,_.status=73)}else _.status=73;if(_.status===73)if(_.gzhead.name){C=_.pending;do{if(_.pending===_.pending_buf_size&&(_.gzhead.hcrc&&_.pending>C&&(o.adler=m(o.adler,_.pending_buf,_.pending-C,C)),N(o),C=_.pending,_.pending===_.pending_buf_size)){x=1;break}x=_.gzindex<_.gzhead.name.length?255&_.gzhead.name.charCodeAt(_.gzindex++):0,ae(_,x)}while(x!==0);_.gzhead.hcrc&&_.pending>C&&(o.adler=m(o.adler,_.pending_buf,_.pending-C,C)),x===0&&(_.gzindex=0,_.status=91)}else _.status=91;if(_.status===91)if(_.gzhead.comment){C=_.pending;do{if(_.pending===_.pending_buf_size&&(_.gzhead.hcrc&&_.pending>C&&(o.adler=m(o.adler,_.pending_buf,_.pending-C,C)),N(o),C=_.pending,_.pending===_.pending_buf_size)){x=1;break}x=_.gzindex<_.gzhead.comment.length?255&_.gzhead.comment.charCodeAt(_.gzindex++):0,ae(_,x)}while(x!==0);_.gzhead.hcrc&&_.pending>C&&(o.adler=m(o.adler,_.pending_buf,_.pending-C,C)),x===0&&(_.status=103)}else _.status=103;if(_.status===103&&(_.gzhead.hcrc?(_.pending+2>_.pending_buf_size&&N(o),_.pending+2<=_.pending_buf_size&&(ae(_,255&o.adler),ae(_,o.adler>>8&255),o.adler=0,_.status=M)):_.status=M),_.pending!==0){if(N(o),o.avail_out===0)return _.last_flush=-1,u}else if(o.avail_in===0&&$(F)<=$(R)&&F!==h)return ue(o,-5);if(_.status===666&&o.avail_in!==0)return ue(o,-5);if(o.avail_in!==0||_.lookahead!==0||F!==v&&_.status!==666){var W=_.strategy===2?function(B,V){for(var ne;;){if(B.lookahead===0&&(Le(B),B.lookahead===0)){if(V===v)return d;break}if(B.match_length=0,ne=i._tr_tally(B,0,B.window[B.strstart]),B.lookahead--,B.strstart++,ne&&(T(B,!1),B.strm.avail_out===0))return d}return B.insert=0,V===h?(T(B,!0),B.strm.avail_out===0?de:j):B.last_lit&&(T(B,!1),B.strm.avail_out===0)?d:P}(_,F):_.strategy===3?function(B,V){for(var ne,K,oe,Ee,ye=B.window;;){if(B.lookahead<=G){if(Le(B),B.lookahead<=G&&V===v)return d;if(B.lookahead===0)break}if(B.match_length=0,B.lookahead>=D&&0<B.strstart&&(K=ye[oe=B.strstart-1])===ye[++oe]&&K===ye[++oe]&&K===ye[++oe]){Ee=B.strstart+G;do;while(K===ye[++oe]&&K===ye[++oe]&&K===ye[++oe]&&K===ye[++oe]&&K===ye[++oe]&&K===ye[++oe]&&K===ye[++oe]&&K===ye[++oe]&&oe<Ee);B.match_length=G-(Ee-oe),B.match_length>B.lookahead&&(B.match_length=B.lookahead)}if(B.match_length>=D?(ne=i._tr_tally(B,1,B.match_length-D),B.lookahead-=B.match_length,B.strstart+=B.match_length,B.match_length=0):(ne=i._tr_tally(B,0,B.window[B.strstart]),B.lookahead--,B.strstart++),ne&&(T(B,!1),B.strm.avail_out===0))return d}return B.insert=0,V===h?(T(B,!0),B.strm.avail_out===0?de:j):B.last_lit&&(T(B,!1),B.strm.avail_out===0)?d:P}(_,F):t[_.level].func(_,F);if(W!==de&&W!==j||(_.status=666),W===d||W===de)return o.avail_out===0&&(_.last_flush=-1),u;if(W===P&&(F===1?i._tr_align(_):F!==5&&(i._tr_stored_block(_,0,0,!1),F===3&&(te(_.head),_.lookahead===0&&(_.strstart=0,_.block_start=0,_.insert=0))),N(o),o.avail_out===0))return _.last_flush=-1,u}return F!==h?u:_.wrap<=0?1:(_.wrap===2?(ae(_,255&o.adler),ae(_,o.adler>>8&255),ae(_,o.adler>>16&255),ae(_,o.adler>>24&255),ae(_,255&o.total_in),ae(_,o.total_in>>8&255),ae(_,o.total_in>>16&255),ae(_,o.total_in>>24&255)):(ee(_,o.adler>>>16),ee(_,65535&o.adler)),N(o),0<_.wrap&&(_.wrap=-_.wrap),_.pending!==0?u:1)},a.deflateEnd=function(o){var F;return o&&o.state?(F=o.state.status)!==E&&F!==69&&F!==73&&F!==91&&F!==103&&F!==M&&F!==666?ue(o,p):(o.state=null,F===M?ue(o,-3):u):p},a.deflateSetDictionary=function(o,F){var R,_,C,x,U,W,B,V,ne=F.length;if(!o||!o.state||(x=(R=o.state).wrap)===2||x===1&&R.status!==E||R.lookahead)return p;for(x===1&&(o.adler=r(o.adler,F,ne,0)),R.wrap=0,ne>=R.w_size&&(x===0&&(te(R.head),R.strstart=0,R.block_start=0,R.insert=0),V=new n.Buf8(R.w_size),n.arraySet(V,F,ne-R.w_size,R.w_size,0),F=V,ne=R.w_size),U=o.avail_in,W=o.next_in,B=o.input,o.avail_in=ne,o.next_in=0,o.input=F,Le(R);R.lookahead>=D;){for(_=R.strstart,C=R.lookahead-(D-1);R.ins_h=(R.ins_h<<R.hash_shift^R.window[_+D-1])&R.hash_mask,R.prev[_&R.w_mask]=R.head[R.ins_h],R.head[R.ins_h]=_,_++,--C;);R.strstart=_,R.lookahead=D-1,Le(R)}return R.strstart+=R.lookahead,R.block_start=R.strstart,R.insert=R.lookahead,R.lookahead=0,R.match_length=R.prev_length=D-1,R.match_available=0,o.next_in=W,o.input=B,o.avail_in=U,R.wrap=x,u},a.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(e,l,a){l.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(e,l,a){l.exports=function(t,n){var i,r,m,b,v,h,u,p,f,y,g,w,k,I,S,A,z,H,D,G,se,E,M,d,P;i=t.state,r=t.next_in,d=t.input,m=r+(t.avail_in-5),b=t.next_out,P=t.output,v=b-(n-t.avail_out),h=b+(t.avail_out-257),u=i.dmax,p=i.wsize,f=i.whave,y=i.wnext,g=i.window,w=i.hold,k=i.bits,I=i.lencode,S=i.distcode,A=(1<<i.lenbits)-1,z=(1<<i.distbits)-1;e:do{k<15&&(w+=d[r++]<<k,k+=8,w+=d[r++]<<k,k+=8),H=I[w&A];t:for(;;){if(w>>>=D=H>>>24,k-=D,(D=H>>>16&255)===0)P[b++]=65535&H;else{if(!(16&D)){if(!(64&D)){H=I[(65535&H)+(w&(1<<D)-1)];continue t}if(32&D){i.mode=12;break e}t.msg="invalid literal/length code",i.mode=30;break e}G=65535&H,(D&=15)&&(k<D&&(w+=d[r++]<<k,k+=8),G+=w&(1<<D)-1,w>>>=D,k-=D),k<15&&(w+=d[r++]<<k,k+=8,w+=d[r++]<<k,k+=8),H=S[w&z];n:for(;;){if(w>>>=D=H>>>24,k-=D,!(16&(D=H>>>16&255))){if(!(64&D)){H=S[(65535&H)+(w&(1<<D)-1)];continue n}t.msg="invalid distance code",i.mode=30;break e}if(se=65535&H,k<(D&=15)&&(w+=d[r++]<<k,(k+=8)<D&&(w+=d[r++]<<k,k+=8)),u<(se+=w&(1<<D)-1)){t.msg="invalid distance too far back",i.mode=30;break e}if(w>>>=D,k-=D,(D=b-v)<se){if(f<(D=se-D)&&i.sane){t.msg="invalid distance too far back",i.mode=30;break e}if(M=g,(E=0)===y){if(E+=p-D,D<G){for(G-=D;P[b++]=g[E++],--D;);E=b-se,M=P}}else if(y<D){if(E+=p+y-D,(D-=y)<G){for(G-=D;P[b++]=g[E++],--D;);if(E=0,y<G){for(G-=D=y;P[b++]=g[E++],--D;);E=b-se,M=P}}}else if(E+=y-D,D<G){for(G-=D;P[b++]=g[E++],--D;);E=b-se,M=P}for(;2<G;)P[b++]=M[E++],P[b++]=M[E++],P[b++]=M[E++],G-=3;G&&(P[b++]=M[E++],1<G&&(P[b++]=M[E++]))}else{for(E=b-se;P[b++]=P[E++],P[b++]=P[E++],P[b++]=P[E++],2<(G-=3););G&&(P[b++]=P[E++],1<G&&(P[b++]=P[E++]))}break}}break}}while(r<m&&b<h);r-=G=k>>3,w&=(1<<(k-=G<<3))-1,t.next_in=r,t.next_out=b,t.avail_in=r<m?m-r+5:5-(r-m),t.avail_out=b<h?h-b+257:257-(b-h),i.hold=w,i.bits=k}},{}],49:[function(e,l,a){var t=e("../utils/common"),n=e("./adler32"),i=e("./crc32"),r=e("./inffast"),m=e("./inftrees"),b=1,v=2,h=0,u=-2,p=1,f=852,y=592;function g(E){return(E>>>24&255)+(E>>>8&65280)+((65280&E)<<8)+((255&E)<<24)}function w(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new t.Buf16(320),this.work=new t.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function k(E){var M;return E&&E.state?(M=E.state,E.total_in=E.total_out=M.total=0,E.msg="",M.wrap&&(E.adler=1&M.wrap),M.mode=p,M.last=0,M.havedict=0,M.dmax=32768,M.head=null,M.hold=0,M.bits=0,M.lencode=M.lendyn=new t.Buf32(f),M.distcode=M.distdyn=new t.Buf32(y),M.sane=1,M.back=-1,h):u}function I(E){var M;return E&&E.state?((M=E.state).wsize=0,M.whave=0,M.wnext=0,k(E)):u}function S(E,M){var d,P;return E&&E.state?(P=E.state,M<0?(d=0,M=-M):(d=1+(M>>4),M<48&&(M&=15)),M&&(M<8||15<M)?u:(P.window!==null&&P.wbits!==M&&(P.window=null),P.wrap=d,P.wbits=M,I(E))):u}function A(E,M){var d,P;return E?(P=new w,(E.state=P).window=null,(d=S(E,M))!==h&&(E.state=null),d):u}var z,H,D=!0;function G(E){if(D){var M;for(z=new t.Buf32(512),H=new t.Buf32(32),M=0;M<144;)E.lens[M++]=8;for(;M<256;)E.lens[M++]=9;for(;M<280;)E.lens[M++]=7;for(;M<288;)E.lens[M++]=8;for(m(b,E.lens,0,288,z,0,E.work,{bits:9}),M=0;M<32;)E.lens[M++]=5;m(v,E.lens,0,32,H,0,E.work,{bits:5}),D=!1}E.lencode=z,E.lenbits=9,E.distcode=H,E.distbits=5}function se(E,M,d,P){var de,j=E.state;return j.window===null&&(j.wsize=1<<j.wbits,j.wnext=0,j.whave=0,j.window=new t.Buf8(j.wsize)),P>=j.wsize?(t.arraySet(j.window,M,d-j.wsize,j.wsize,0),j.wnext=0,j.whave=j.wsize):(P<(de=j.wsize-j.wnext)&&(de=P),t.arraySet(j.window,M,d-P,de,j.wnext),(P-=de)?(t.arraySet(j.window,M,d-P,P,0),j.wnext=P,j.whave=j.wsize):(j.wnext+=de,j.wnext===j.wsize&&(j.wnext=0),j.whave<j.wsize&&(j.whave+=de))),0}a.inflateReset=I,a.inflateReset2=S,a.inflateResetKeep=k,a.inflateInit=function(E){return A(E,15)},a.inflateInit2=A,a.inflate=function(E,M){var d,P,de,j,ue,$,te,N,T,ae,ee,X,Le,De,ge,be,Ae,Te,Ke,Je,o,F,R,_,C=0,x=new t.Buf8(4),U=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!E||!E.state||!E.output||!E.input&&E.avail_in!==0)return u;(d=E.state).mode===12&&(d.mode=13),ue=E.next_out,de=E.output,te=E.avail_out,j=E.next_in,P=E.input,$=E.avail_in,N=d.hold,T=d.bits,ae=$,ee=te,F=h;e:for(;;)switch(d.mode){case p:if(d.wrap===0){d.mode=13;break}for(;T<16;){if($===0)break e;$--,N+=P[j++]<<T,T+=8}if(2&d.wrap&&N===35615){x[d.check=0]=255&N,x[1]=N>>>8&255,d.check=i(d.check,x,2,0),T=N=0,d.mode=2;break}if(d.flags=0,d.head&&(d.head.done=!1),!(1&d.wrap)||(((255&N)<<8)+(N>>8))%31){E.msg="incorrect header check",d.mode=30;break}if((15&N)!=8){E.msg="unknown compression method",d.mode=30;break}if(T-=4,o=8+(15&(N>>>=4)),d.wbits===0)d.wbits=o;else if(o>d.wbits){E.msg="invalid window size",d.mode=30;break}d.dmax=1<<o,E.adler=d.check=1,d.mode=512&N?10:12,T=N=0;break;case 2:for(;T<16;){if($===0)break e;$--,N+=P[j++]<<T,T+=8}if(d.flags=N,(255&d.flags)!=8){E.msg="unknown compression method",d.mode=30;break}if(57344&d.flags){E.msg="unknown header flags set",d.mode=30;break}d.head&&(d.head.text=N>>8&1),512&d.flags&&(x[0]=255&N,x[1]=N>>>8&255,d.check=i(d.check,x,2,0)),T=N=0,d.mode=3;case 3:for(;T<32;){if($===0)break e;$--,N+=P[j++]<<T,T+=8}d.head&&(d.head.time=N),512&d.flags&&(x[0]=255&N,x[1]=N>>>8&255,x[2]=N>>>16&255,x[3]=N>>>24&255,d.check=i(d.check,x,4,0)),T=N=0,d.mode=4;case 4:for(;T<16;){if($===0)break e;$--,N+=P[j++]<<T,T+=8}d.head&&(d.head.xflags=255&N,d.head.os=N>>8),512&d.flags&&(x[0]=255&N,x[1]=N>>>8&255,d.check=i(d.check,x,2,0)),T=N=0,d.mode=5;case 5:if(1024&d.flags){for(;T<16;){if($===0)break e;$--,N+=P[j++]<<T,T+=8}d.length=N,d.head&&(d.head.extra_len=N),512&d.flags&&(x[0]=255&N,x[1]=N>>>8&255,d.check=i(d.check,x,2,0)),T=N=0}else d.head&&(d.head.extra=null);d.mode=6;case 6:if(1024&d.flags&&($<(X=d.length)&&(X=$),X&&(d.head&&(o=d.head.extra_len-d.length,d.head.extra||(d.head.extra=new Array(d.head.extra_len)),t.arraySet(d.head.extra,P,j,X,o)),512&d.flags&&(d.check=i(d.check,P,X,j)),$-=X,j+=X,d.length-=X),d.length))break e;d.length=0,d.mode=7;case 7:if(2048&d.flags){if($===0)break e;for(X=0;o=P[j+X++],d.head&&o&&d.length<65536&&(d.head.name+=String.fromCharCode(o)),o&&X<$;);if(512&d.flags&&(d.check=i(d.check,P,X,j)),$-=X,j+=X,o)break e}else d.head&&(d.head.name=null);d.length=0,d.mode=8;case 8:if(4096&d.flags){if($===0)break e;for(X=0;o=P[j+X++],d.head&&o&&d.length<65536&&(d.head.comment+=String.fromCharCode(o)),o&&X<$;);if(512&d.flags&&(d.check=i(d.check,P,X,j)),$-=X,j+=X,o)break e}else d.head&&(d.head.comment=null);d.mode=9;case 9:if(512&d.flags){for(;T<16;){if($===0)break e;$--,N+=P[j++]<<T,T+=8}if(N!==(65535&d.check)){E.msg="header crc mismatch",d.mode=30;break}T=N=0}d.head&&(d.head.hcrc=d.flags>>9&1,d.head.done=!0),E.adler=d.check=0,d.mode=12;break;case 10:for(;T<32;){if($===0)break e;$--,N+=P[j++]<<T,T+=8}E.adler=d.check=g(N),T=N=0,d.mode=11;case 11:if(d.havedict===0)return E.next_out=ue,E.avail_out=te,E.next_in=j,E.avail_in=$,d.hold=N,d.bits=T,2;E.adler=d.check=1,d.mode=12;case 12:if(M===5||M===6)break e;case 13:if(d.last){N>>>=7&T,T-=7&T,d.mode=27;break}for(;T<3;){if($===0)break e;$--,N+=P[j++]<<T,T+=8}switch(d.last=1&N,T-=1,3&(N>>>=1)){case 0:d.mode=14;break;case 1:if(G(d),d.mode=20,M!==6)break;N>>>=2,T-=2;break e;case 2:d.mode=17;break;case 3:E.msg="invalid block type",d.mode=30}N>>>=2,T-=2;break;case 14:for(N>>>=7&T,T-=7&T;T<32;){if($===0)break e;$--,N+=P[j++]<<T,T+=8}if((65535&N)!=(N>>>16^65535)){E.msg="invalid stored block lengths",d.mode=30;break}if(d.length=65535&N,T=N=0,d.mode=15,M===6)break e;case 15:d.mode=16;case 16:if(X=d.length){if($<X&&(X=$),te<X&&(X=te),X===0)break e;t.arraySet(de,P,j,X,ue),$-=X,j+=X,te-=X,ue+=X,d.length-=X;break}d.mode=12;break;case 17:for(;T<14;){if($===0)break e;$--,N+=P[j++]<<T,T+=8}if(d.nlen=257+(31&N),N>>>=5,T-=5,d.ndist=1+(31&N),N>>>=5,T-=5,d.ncode=4+(15&N),N>>>=4,T-=4,286<d.nlen||30<d.ndist){E.msg="too many length or distance symbols",d.mode=30;break}d.have=0,d.mode=18;case 18:for(;d.have<d.ncode;){for(;T<3;){if($===0)break e;$--,N+=P[j++]<<T,T+=8}d.lens[U[d.have++]]=7&N,N>>>=3,T-=3}for(;d.have<19;)d.lens[U[d.have++]]=0;if(d.lencode=d.lendyn,d.lenbits=7,R={bits:d.lenbits},F=m(0,d.lens,0,19,d.lencode,0,d.work,R),d.lenbits=R.bits,F){E.msg="invalid code lengths set",d.mode=30;break}d.have=0,d.mode=19;case 19:for(;d.have<d.nlen+d.ndist;){for(;be=(C=d.lencode[N&(1<<d.lenbits)-1])>>>16&255,Ae=65535&C,!((ge=C>>>24)<=T);){if($===0)break e;$--,N+=P[j++]<<T,T+=8}if(Ae<16)N>>>=ge,T-=ge,d.lens[d.have++]=Ae;else{if(Ae===16){for(_=ge+2;T<_;){if($===0)break e;$--,N+=P[j++]<<T,T+=8}if(N>>>=ge,T-=ge,d.have===0){E.msg="invalid bit length repeat",d.mode=30;break}o=d.lens[d.have-1],X=3+(3&N),N>>>=2,T-=2}else if(Ae===17){for(_=ge+3;T<_;){if($===0)break e;$--,N+=P[j++]<<T,T+=8}T-=ge,o=0,X=3+(7&(N>>>=ge)),N>>>=3,T-=3}else{for(_=ge+7;T<_;){if($===0)break e;$--,N+=P[j++]<<T,T+=8}T-=ge,o=0,X=11+(127&(N>>>=ge)),N>>>=7,T-=7}if(d.have+X>d.nlen+d.ndist){E.msg="invalid bit length repeat",d.mode=30;break}for(;X--;)d.lens[d.have++]=o}}if(d.mode===30)break;if(d.lens[256]===0){E.msg="invalid code -- missing end-of-block",d.mode=30;break}if(d.lenbits=9,R={bits:d.lenbits},F=m(b,d.lens,0,d.nlen,d.lencode,0,d.work,R),d.lenbits=R.bits,F){E.msg="invalid literal/lengths set",d.mode=30;break}if(d.distbits=6,d.distcode=d.distdyn,R={bits:d.distbits},F=m(v,d.lens,d.nlen,d.ndist,d.distcode,0,d.work,R),d.distbits=R.bits,F){E.msg="invalid distances set",d.mode=30;break}if(d.mode=20,M===6)break e;case 20:d.mode=21;case 21:if(6<=$&&258<=te){E.next_out=ue,E.avail_out=te,E.next_in=j,E.avail_in=$,d.hold=N,d.bits=T,r(E,ee),ue=E.next_out,de=E.output,te=E.avail_out,j=E.next_in,P=E.input,$=E.avail_in,N=d.hold,T=d.bits,d.mode===12&&(d.back=-1);break}for(d.back=0;be=(C=d.lencode[N&(1<<d.lenbits)-1])>>>16&255,Ae=65535&C,!((ge=C>>>24)<=T);){if($===0)break e;$--,N+=P[j++]<<T,T+=8}if(be&&!(240&be)){for(Te=ge,Ke=be,Je=Ae;be=(C=d.lencode[Je+((N&(1<<Te+Ke)-1)>>Te)])>>>16&255,Ae=65535&C,!(Te+(ge=C>>>24)<=T);){if($===0)break e;$--,N+=P[j++]<<T,T+=8}N>>>=Te,T-=Te,d.back+=Te}if(N>>>=ge,T-=ge,d.back+=ge,d.length=Ae,be===0){d.mode=26;break}if(32&be){d.back=-1,d.mode=12;break}if(64&be){E.msg="invalid literal/length code",d.mode=30;break}d.extra=15&be,d.mode=22;case 22:if(d.extra){for(_=d.extra;T<_;){if($===0)break e;$--,N+=P[j++]<<T,T+=8}d.length+=N&(1<<d.extra)-1,N>>>=d.extra,T-=d.extra,d.back+=d.extra}d.was=d.length,d.mode=23;case 23:for(;be=(C=d.distcode[N&(1<<d.distbits)-1])>>>16&255,Ae=65535&C,!((ge=C>>>24)<=T);){if($===0)break e;$--,N+=P[j++]<<T,T+=8}if(!(240&be)){for(Te=ge,Ke=be,Je=Ae;be=(C=d.distcode[Je+((N&(1<<Te+Ke)-1)>>Te)])>>>16&255,Ae=65535&C,!(Te+(ge=C>>>24)<=T);){if($===0)break e;$--,N+=P[j++]<<T,T+=8}N>>>=Te,T-=Te,d.back+=Te}if(N>>>=ge,T-=ge,d.back+=ge,64&be){E.msg="invalid distance code",d.mode=30;break}d.offset=Ae,d.extra=15&be,d.mode=24;case 24:if(d.extra){for(_=d.extra;T<_;){if($===0)break e;$--,N+=P[j++]<<T,T+=8}d.offset+=N&(1<<d.extra)-1,N>>>=d.extra,T-=d.extra,d.back+=d.extra}if(d.offset>d.dmax){E.msg="invalid distance too far back",d.mode=30;break}d.mode=25;case 25:if(te===0)break e;if(X=ee-te,d.offset>X){if((X=d.offset-X)>d.whave&&d.sane){E.msg="invalid distance too far back",d.mode=30;break}Le=X>d.wnext?(X-=d.wnext,d.wsize-X):d.wnext-X,X>d.length&&(X=d.length),De=d.window}else De=de,Le=ue-d.offset,X=d.length;for(te<X&&(X=te),te-=X,d.length-=X;de[ue++]=De[Le++],--X;);d.length===0&&(d.mode=21);break;case 26:if(te===0)break e;de[ue++]=d.length,te--,d.mode=21;break;case 27:if(d.wrap){for(;T<32;){if($===0)break e;$--,N|=P[j++]<<T,T+=8}if(ee-=te,E.total_out+=ee,d.total+=ee,ee&&(E.adler=d.check=d.flags?i(d.check,de,ee,ue-ee):n(d.check,de,ee,ue-ee)),ee=te,(d.flags?N:g(N))!==d.check){E.msg="incorrect data check",d.mode=30;break}T=N=0}d.mode=28;case 28:if(d.wrap&&d.flags){for(;T<32;){if($===0)break e;$--,N+=P[j++]<<T,T+=8}if(N!==(4294967295&d.total)){E.msg="incorrect length check",d.mode=30;break}T=N=0}d.mode=29;case 29:F=1;break e;case 30:F=-3;break e;case 31:return-4;case 32:default:return u}return E.next_out=ue,E.avail_out=te,E.next_in=j,E.avail_in=$,d.hold=N,d.bits=T,(d.wsize||ee!==E.avail_out&&d.mode<30&&(d.mode<27||M!==4))&&se(E,E.output,E.next_out,ee-E.avail_out)?(d.mode=31,-4):(ae-=E.avail_in,ee-=E.avail_out,E.total_in+=ae,E.total_out+=ee,d.total+=ee,d.wrap&&ee&&(E.adler=d.check=d.flags?i(d.check,de,ee,E.next_out-ee):n(d.check,de,ee,E.next_out-ee)),E.data_type=d.bits+(d.last?64:0)+(d.mode===12?128:0)+(d.mode===20||d.mode===15?256:0),(ae==0&&ee===0||M===4)&&F===h&&(F=-5),F)},a.inflateEnd=function(E){if(!E||!E.state)return u;var M=E.state;return M.window&&(M.window=null),E.state=null,h},a.inflateGetHeader=function(E,M){var d;return E&&E.state&&2&(d=E.state).wrap?((d.head=M).done=!1,h):u},a.inflateSetDictionary=function(E,M){var d,P=M.length;return E&&E.state?(d=E.state).wrap!==0&&d.mode!==11?u:d.mode===11&&n(1,M,P,0)!==d.check?-3:se(E,M,P,P)?(d.mode=31,-4):(d.havedict=1,h):u},a.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(e,l,a){var t=e("../utils/common"),n=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],i=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],r=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],m=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];l.exports=function(b,v,h,u,p,f,y,g){var w,k,I,S,A,z,H,D,G,se=g.bits,E=0,M=0,d=0,P=0,de=0,j=0,ue=0,$=0,te=0,N=0,T=null,ae=0,ee=new t.Buf16(16),X=new t.Buf16(16),Le=null,De=0;for(E=0;E<=15;E++)ee[E]=0;for(M=0;M<u;M++)ee[v[h+M]]++;for(de=se,P=15;1<=P&&ee[P]===0;P--);if(P<de&&(de=P),P===0)return p[f++]=20971520,p[f++]=20971520,g.bits=1,0;for(d=1;d<P&&ee[d]===0;d++);for(de<d&&(de=d),E=$=1;E<=15;E++)if($<<=1,($-=ee[E])<0)return-1;if(0<$&&(b===0||P!==1))return-1;for(X[1]=0,E=1;E<15;E++)X[E+1]=X[E]+ee[E];for(M=0;M<u;M++)v[h+M]!==0&&(y[X[v[h+M]]++]=M);if(z=b===0?(T=Le=y,19):b===1?(T=n,ae-=257,Le=i,De-=257,256):(T=r,Le=m,-1),E=d,A=f,ue=M=N=0,I=-1,S=(te=1<<(j=de))-1,b===1&&852<te||b===2&&592<te)return 1;for(;;){for(H=E-ue,G=y[M]<z?(D=0,y[M]):y[M]>z?(D=Le[De+y[M]],T[ae+y[M]]):(D=96,0),w=1<<E-ue,d=k=1<<j;p[A+(N>>ue)+(k-=w)]=H<<24|D<<16|G|0,k!==0;);for(w=1<<E-1;N&w;)w>>=1;if(w!==0?(N&=w-1,N+=w):N=0,M++,--ee[E]==0){if(E===P)break;E=v[h+y[M]]}if(de<E&&(N&S)!==I){for(ue===0&&(ue=de),A+=d,$=1<<(j=E-ue);j+ue<P&&!(($-=ee[j+ue])<=0);)j++,$<<=1;if(te+=1<<j,b===1&&852<te||b===2&&592<te)return 1;p[I=N&S]=de<<24|j<<16|A-f|0}}return N!==0&&(p[A+N]=E-ue<<24|64<<16|0),g.bits=de,0}},{"../utils/common":41}],51:[function(e,l,a){l.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(e,l,a){var t=e("../utils/common"),n=0,i=1;function r(C){for(var x=C.length;0<=--x;)C[x]=0}var m=0,b=29,v=256,h=v+1+b,u=30,p=19,f=2*h+1,y=15,g=16,w=7,k=256,I=16,S=17,A=18,z=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],H=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],D=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],G=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],se=new Array(2*(h+2));r(se);var E=new Array(2*u);r(E);var M=new Array(512);r(M);var d=new Array(256);r(d);var P=new Array(b);r(P);var de,j,ue,$=new Array(u);function te(C,x,U,W,B){this.static_tree=C,this.extra_bits=x,this.extra_base=U,this.elems=W,this.max_length=B,this.has_stree=C&&C.length}function N(C,x){this.dyn_tree=C,this.max_code=0,this.stat_desc=x}function T(C){return C<256?M[C]:M[256+(C>>>7)]}function ae(C,x){C.pending_buf[C.pending++]=255&x,C.pending_buf[C.pending++]=x>>>8&255}function ee(C,x,U){C.bi_valid>g-U?(C.bi_buf|=x<<C.bi_valid&65535,ae(C,C.bi_buf),C.bi_buf=x>>g-C.bi_valid,C.bi_valid+=U-g):(C.bi_buf|=x<<C.bi_valid&65535,C.bi_valid+=U)}function X(C,x,U){ee(C,U[2*x],U[2*x+1])}function Le(C,x){for(var U=0;U|=1&C,C>>>=1,U<<=1,0<--x;);return U>>>1}function De(C,x,U){var W,B,V=new Array(y+1),ne=0;for(W=1;W<=y;W++)V[W]=ne=ne+U[W-1]<<1;for(B=0;B<=x;B++){var K=C[2*B+1];K!==0&&(C[2*B]=Le(V[K]++,K))}}function ge(C){var x;for(x=0;x<h;x++)C.dyn_ltree[2*x]=0;for(x=0;x<u;x++)C.dyn_dtree[2*x]=0;for(x=0;x<p;x++)C.bl_tree[2*x]=0;C.dyn_ltree[2*k]=1,C.opt_len=C.static_len=0,C.last_lit=C.matches=0}function be(C){8<C.bi_valid?ae(C,C.bi_buf):0<C.bi_valid&&(C.pending_buf[C.pending++]=C.bi_buf),C.bi_buf=0,C.bi_valid=0}function Ae(C,x,U,W){var B=2*x,V=2*U;return C[B]<C[V]||C[B]===C[V]&&W[x]<=W[U]}function Te(C,x,U){for(var W=C.heap[U],B=U<<1;B<=C.heap_len&&(B<C.heap_len&&Ae(x,C.heap[B+1],C.heap[B],C.depth)&&B++,!Ae(x,W,C.heap[B],C.depth));)C.heap[U]=C.heap[B],U=B,B<<=1;C.heap[U]=W}function Ke(C,x,U){var W,B,V,ne,K=0;if(C.last_lit!==0)for(;W=C.pending_buf[C.d_buf+2*K]<<8|C.pending_buf[C.d_buf+2*K+1],B=C.pending_buf[C.l_buf+K],K++,W===0?X(C,B,x):(X(C,(V=d[B])+v+1,x),(ne=z[V])!==0&&ee(C,B-=P[V],ne),X(C,V=T(--W),U),(ne=H[V])!==0&&ee(C,W-=$[V],ne)),K<C.last_lit;);X(C,k,x)}function Je(C,x){var U,W,B,V=x.dyn_tree,ne=x.stat_desc.static_tree,K=x.stat_desc.has_stree,oe=x.stat_desc.elems,Ee=-1;for(C.heap_len=0,C.heap_max=f,U=0;U<oe;U++)V[2*U]!==0?(C.heap[++C.heap_len]=Ee=U,C.depth[U]=0):V[2*U+1]=0;for(;C.heap_len<2;)V[2*(B=C.heap[++C.heap_len]=Ee<2?++Ee:0)]=1,C.depth[B]=0,C.opt_len--,K&&(C.static_len-=ne[2*B+1]);for(x.max_code=Ee,U=C.heap_len>>1;1<=U;U--)Te(C,V,U);for(B=oe;U=C.heap[1],C.heap[1]=C.heap[C.heap_len--],Te(C,V,1),W=C.heap[1],C.heap[--C.heap_max]=U,C.heap[--C.heap_max]=W,V[2*B]=V[2*U]+V[2*W],C.depth[B]=(C.depth[U]>=C.depth[W]?C.depth[U]:C.depth[W])+1,V[2*U+1]=V[2*W+1]=B,C.heap[1]=B++,Te(C,V,1),2<=C.heap_len;);C.heap[--C.heap_max]=C.heap[1],function(ye,je){var ht,Re,dt,Ne,_t,Et,Ye=je.dyn_tree,Rt=je.max_code,kt=je.stat_desc.static_tree,St=je.stat_desc.has_stree,en=je.stat_desc.extra_bits,tn=je.stat_desc.extra_base,L=je.stat_desc.max_length,Z=0;for(Ne=0;Ne<=y;Ne++)ye.bl_count[Ne]=0;for(Ye[2*ye.heap[ye.heap_max]+1]=0,ht=ye.heap_max+1;ht<f;ht++)L<(Ne=Ye[2*Ye[2*(Re=ye.heap[ht])+1]+1]+1)&&(Ne=L,Z++),Ye[2*Re+1]=Ne,Rt<Re||(ye.bl_count[Ne]++,_t=0,tn<=Re&&(_t=en[Re-tn]),Et=Ye[2*Re],ye.opt_len+=Et*(Ne+_t),St&&(ye.static_len+=Et*(kt[2*Re+1]+_t)));if(Z!==0){do{for(Ne=L-1;ye.bl_count[Ne]===0;)Ne--;ye.bl_count[Ne]--,ye.bl_count[Ne+1]+=2,ye.bl_count[L]--,Z-=2}while(0<Z);for(Ne=L;Ne!==0;Ne--)for(Re=ye.bl_count[Ne];Re!==0;)Rt<(dt=ye.heap[--ht])||(Ye[2*dt+1]!==Ne&&(ye.opt_len+=(Ne-Ye[2*dt+1])*Ye[2*dt],Ye[2*dt+1]=Ne),Re--)}}(C,x),De(V,Ee,C.bl_count)}function o(C,x,U){var W,B,V=-1,ne=x[1],K=0,oe=7,Ee=4;for(ne===0&&(oe=138,Ee=3),x[2*(U+1)+1]=65535,W=0;W<=U;W++)B=ne,ne=x[2*(W+1)+1],++K<oe&&B===ne||(K<Ee?C.bl_tree[2*B]+=K:B!==0?(B!==V&&C.bl_tree[2*B]++,C.bl_tree[2*I]++):K<=10?C.bl_tree[2*S]++:C.bl_tree[2*A]++,V=B,Ee=(K=0)===ne?(oe=138,3):B===ne?(oe=6,3):(oe=7,4))}function F(C,x,U){var W,B,V=-1,ne=x[1],K=0,oe=7,Ee=4;for(ne===0&&(oe=138,Ee=3),W=0;W<=U;W++)if(B=ne,ne=x[2*(W+1)+1],!(++K<oe&&B===ne)){if(K<Ee)for(;X(C,B,C.bl_tree),--K!=0;);else B!==0?(B!==V&&(X(C,B,C.bl_tree),K--),X(C,I,C.bl_tree),ee(C,K-3,2)):K<=10?(X(C,S,C.bl_tree),ee(C,K-3,3)):(X(C,A,C.bl_tree),ee(C,K-11,7));V=B,Ee=(K=0)===ne?(oe=138,3):B===ne?(oe=6,3):(oe=7,4)}}r($);var R=!1;function _(C,x,U,W){ee(C,(m<<1)+(W?1:0),3),function(B,V,ne,K){be(B),ae(B,ne),ae(B,~ne),t.arraySet(B.pending_buf,B.window,V,ne,B.pending),B.pending+=ne}(C,x,U)}a._tr_init=function(C){R||(function(){var x,U,W,B,V,ne=new Array(y+1);for(B=W=0;B<b-1;B++)for(P[B]=W,x=0;x<1<<z[B];x++)d[W++]=B;for(d[W-1]=B,B=V=0;B<16;B++)for($[B]=V,x=0;x<1<<H[B];x++)M[V++]=B;for(V>>=7;B<u;B++)for($[B]=V<<7,x=0;x<1<<H[B]-7;x++)M[256+V++]=B;for(U=0;U<=y;U++)ne[U]=0;for(x=0;x<=143;)se[2*x+1]=8,x++,ne[8]++;for(;x<=255;)se[2*x+1]=9,x++,ne[9]++;for(;x<=279;)se[2*x+1]=7,x++,ne[7]++;for(;x<=287;)se[2*x+1]=8,x++,ne[8]++;for(De(se,h+1,ne),x=0;x<u;x++)E[2*x+1]=5,E[2*x]=Le(x,5);de=new te(se,z,v+1,h,y),j=new te(E,H,0,u,y),ue=new te(new Array(0),D,0,p,w)}(),R=!0),C.l_desc=new N(C.dyn_ltree,de),C.d_desc=new N(C.dyn_dtree,j),C.bl_desc=new N(C.bl_tree,ue),C.bi_buf=0,C.bi_valid=0,ge(C)},a._tr_stored_block=_,a._tr_flush_block=function(C,x,U,W){var B,V,ne=0;0<C.level?(C.strm.data_type===2&&(C.strm.data_type=function(K){var oe,Ee=4093624447;for(oe=0;oe<=31;oe++,Ee>>>=1)if(1&Ee&&K.dyn_ltree[2*oe]!==0)return n;if(K.dyn_ltree[18]!==0||K.dyn_ltree[20]!==0||K.dyn_ltree[26]!==0)return i;for(oe=32;oe<v;oe++)if(K.dyn_ltree[2*oe]!==0)return i;return n}(C)),Je(C,C.l_desc),Je(C,C.d_desc),ne=function(K){var oe;for(o(K,K.dyn_ltree,K.l_desc.max_code),o(K,K.dyn_dtree,K.d_desc.max_code),Je(K,K.bl_desc),oe=p-1;3<=oe&&K.bl_tree[2*G[oe]+1]===0;oe--);return K.opt_len+=3*(oe+1)+5+5+4,oe}(C),B=C.opt_len+3+7>>>3,(V=C.static_len+3+7>>>3)<=B&&(B=V)):B=V=U+5,U+4<=B&&x!==-1?_(C,x,U,W):C.strategy===4||V===B?(ee(C,2+(W?1:0),3),Ke(C,se,E)):(ee(C,4+(W?1:0),3),function(K,oe,Ee,ye){var je;for(ee(K,oe-257,5),ee(K,Ee-1,5),ee(K,ye-4,4),je=0;je<ye;je++)ee(K,K.bl_tree[2*G[je]+1],3);F(K,K.dyn_ltree,oe-1),F(K,K.dyn_dtree,Ee-1)}(C,C.l_desc.max_code+1,C.d_desc.max_code+1,ne+1),Ke(C,C.dyn_ltree,C.dyn_dtree)),ge(C),W&&be(C)},a._tr_tally=function(C,x,U){return C.pending_buf[C.d_buf+2*C.last_lit]=x>>>8&255,C.pending_buf[C.d_buf+2*C.last_lit+1]=255&x,C.pending_buf[C.l_buf+C.last_lit]=255&U,C.last_lit++,x===0?C.dyn_ltree[2*U]++:(C.matches++,x--,C.dyn_ltree[2*(d[U]+v+1)]++,C.dyn_dtree[2*T(x)]++),C.last_lit===C.lit_bufsize-1},a._tr_align=function(C){ee(C,2,3),X(C,k,se),function(x){x.bi_valid===16?(ae(x,x.bi_buf),x.bi_buf=0,x.bi_valid=0):8<=x.bi_valid&&(x.pending_buf[x.pending++]=255&x.bi_buf,x.bi_buf>>=8,x.bi_valid-=8)}(C)}},{"../utils/common":41}],53:[function(e,l,a){l.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(e,l,a){(function(t){(function(n,i){if(!n.setImmediate){var r,m,b,v,h=1,u={},p=!1,f=n.document,y=Object.getPrototypeOf&&Object.getPrototypeOf(n);y=y&&y.setTimeout?y:n,r={}.toString.call(n.process)==="[object process]"?function(I){process.nextTick(function(){w(I)})}:function(){if(n.postMessage&&!n.importScripts){var I=!0,S=n.onmessage;return n.onmessage=function(){I=!1},n.postMessage("","*"),n.onmessage=S,I}}()?(v="setImmediate$"+Math.random()+"$",n.addEventListener?n.addEventListener("message",k,!1):n.attachEvent("onmessage",k),function(I){n.postMessage(v+I,"*")}):n.MessageChannel?((b=new MessageChannel).port1.onmessage=function(I){w(I.data)},function(I){b.port2.postMessage(I)}):f&&"onreadystatechange"in f.createElement("script")?(m=f.documentElement,function(I){var S=f.createElement("script");S.onreadystatechange=function(){w(I),S.onreadystatechange=null,m.removeChild(S),S=null},m.appendChild(S)}):function(I){setTimeout(w,0,I)},y.setImmediate=function(I){typeof I!="function"&&(I=new Function(""+I));for(var S=new Array(arguments.length-1),A=0;A<S.length;A++)S[A]=arguments[A+1];var z={callback:I,args:S};return u[h]=z,r(h),h++},y.clearImmediate=g}function g(I){delete u[I]}function w(I){if(p)setTimeout(w,0,I);else{var S=u[I];if(S){p=!0;try{(function(A){var z=A.callback,H=A.args;switch(H.length){case 0:z();break;case 1:z(H[0]);break;case 2:z(H[0],H[1]);break;case 3:z(H[0],H[1],H[2]);break;default:z.apply(i,H)}})(S)}finally{g(I),p=!1}}}}function k(I){I.source===n&&typeof I.data=="string"&&I.data.indexOf(v)===0&&w(+I.data.slice(v.length))}})(typeof self>"u"?t===void 0?this:t:self)}).call(this,typeof nn<"u"?nn:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(xs);var xi=xs.exports;const Ls=Ii(xi);let ce={},O=null,ss=null,J=null,_e=null,qt=null,Nn=null,is=[],gn=null,as=null,Ge=null,yn=0,rs=0,bn=0,os=0,cs=null,ls=null,vn=null,ft=null,Qe=-1,ds=null,Cn=null,wn=null,Bs=null,Ns=null,it=!1,pe=[],st=[],vt=[],Ze={isScreenSaverEnabled:!0,lastRestoreTimestamp:null,lastBackupTimestamp:null};function le(){if(it)return;const s={classrooms:ce,trashBin:pe,userSettings:Ze};localStorage.setItem("teacherAssistantData_v2",JSON.stringify(s))}function Li(s){return new Promise((c,e)=>{const l=new FileReader;l.onerror=e,l.onload=()=>{c(l.result.split(",")[1])},l.readAsDataURL(s)})}async function Ts(s=[]){const c={};if(s.length>0)s.forEach(n=>{ce[n]&&(c[n]=ce[n])});else for(const n in ce)ce[n].isDeleted||(c[n]=ce[n]);const e={metadata:{version:"2.0-b64",createdAt:new Date().toISOString()},data:{classrooms:c,trashBin:pe}},l=JSON.stringify(e),t=`SP-Backup-${new Date().toLocaleDateString("fa-IR-u-nu-latn").replace(/\//g,"-")}.txt`;try{const n=new Ls;n.file("backup.json",l);const i=await n.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:9}}),r=await Li(i);return new File([r],t,{type:"text/plain"})}catch(n){return console.error("Error creating base64 backup file:",n),null}}function _n(){const s=localStorage.getItem("teacherAssistantData_v2");if(!s)return;const c=JSON.parse(s);c.classrooms!==void 0&&c.trashBin!==void 0?(Ct(c.classrooms),pe=c.trashBin||[],Ze={...Ze,...c.userSettings}):(Ct(c),Bi())}function Bi(){const s=[];Object.values(ce).forEach(c=>{c.isDeleted?s.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:c.info.creationDate,type:"classroom",description:`کلاس «${c.info.name}»`,restoreData:{name:c.info.name}}):c.students.forEach(e=>{e.isDeleted&&s.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:e.identity.studentId.split("_")[1],type:"student",description:`دانش‌آموز «${e.identity.name}»`,restoreData:{studentId:e.identity.studentId,classroomName:c.info.name}})})}),pe.length===0&&s.length>0&&(pe=s,console.log(`Migrated ${s.length} previously deleted item(s) to the new trash bin.`),le())}function Ds(s){const c=new an(s.identity);return c.isDeleted=s.isDeleted,c.statusCounters=s.statusCounters,c.logs=s.logs,c.logs.scores||(c.logs.scores={}),c.profile=s.profile,c.finalClassActivityScore=s.finalClassActivityScore,c.categoryCounts=s.categoryCounts||{},c.categoryIssues=s.categoryIssues||{},c.onboardingSession=s.onboardingSession||null,c}function Ct(s){ce={};for(const c in s){const e=s[c];let l;e.info?l=e.info:l={...e,name:c};const a=new Fn(l);a.isDeleted=e.isDeleted,a.note=e.note||"",a.students=(e.students||[]).map(Ds),a.sessions=(e.sessions||[]).map(t=>{const n=new Is(t.sessionNumber);n.isDeleted=t.isDeleted,n.note=t.note||"",n.startTime=new Date(t.startTime),n.endTime=t.endTime?new Date(t.endTime):null,n.isFinished=t.isFinished,n.isMakeup=t.isMakeup,n.isCancelled=t.isCancelled||!1,n.studentRecords=t.studentRecords;for(const r in n.studentRecords){const m=n.studentRecords[r];m.homework&&!(m.homework instanceof $n)&&(n.studentRecords[r].homework=new $n(m.homework.status,m.homework.comment))}n.lastWinnerByCategory=t.lastWinnerByCategory,n.lastUsedCategoryId=t.lastUsedCategoryId,n.lastSelectedWinnerId=t.lastSelectedWinnerId;const i=t.winnerHistory||[];return n.winnerHistory=i.filter(r=>r&&r.winner).map(r=>({winner:a.students.find(b=>b.identity.studentId===r.winner.identity.studentId),categoryName:r.categoryName})).filter(r=>r.winner),n}),a.categories=(e.categories||[]).map(t=>{const n=new ct(t.name,t.description,t.isGradedCategory);return n.id=t.id,n.isDeleted=t.isDeleted,n}),a.futurePlans=e.futurePlans,ce[c]=a}}function As(s,c){if(c){const e=s.data.classrooms;for(let l in e){let a=l;const t=e[l];for(;ce[a];)a=`${a} (Restored)`;a!==l&&(t.info.name=a),ce[a]=t}if(s.data.trashBin){const l=[...pe,...s.data.trashBin],a=[...new Map(l.map(t=>[t.id,t])).values()];xn(a)}Ct(ce)}else Ct(s.data.classrooms),xn(s.data.trashBin||[]);Wt({lastRestoreTimestamp:new Date().toISOString()}),le()}function Os(s,c){if(ce[c])return{success:!1,message:"کلاسی با این نام از قبل وجود دارد."};const e=ce[s];return e?(e.info.name=c,ce[c]=e,delete ce[s],O===e&&We(e),{success:!0}):{success:!1,message:"کلاس مورد نظر یافت نشد."}}function Rs(s,c,e){const l=e.trim();if(!l)return{success:!1,message:"نام دسته‌بندی نمی‌تواند خالی باشد."};if(s.categories.some(r=>r.id!==c.id&&!r.isDeleted&&r.name.toLowerCase()===l.toLowerCase()))return{success:!1,message:"دسته‌بندی دیگری با این نام وجود دارد."};const t=c.name,n=t.toLowerCase(),i=l.toLowerCase();return c.name=l,s.students.forEach(r=>{r.categoryCounts&&r.categoryCounts[t]!==void 0&&(r.categoryCounts[l]=r.categoryCounts[t],delete r.categoryCounts[t]),r.categoryIssues&&r.categoryIssues[t]!==void 0&&(r.categoryIssues[l]=r.categoryIssues[t],delete r.categoryIssues[t]),r.logs.scores&&r.logs.scores[n]&&(r.logs.scores[n].forEach(m=>m.skill=l),n!==i&&(r.logs.scores[i]=r.logs.scores[n],delete r.logs.scores[n]))}),s.sessions.forEach(r=>{r.lastWinnerByCategory&&r.lastWinnerByCategory[t]&&(r.lastWinnerByCategory[l]=r.lastWinnerByCategory[t],delete r.lastWinnerByCategory[t]),r.winnerHistory&&r.winnerHistory.forEach(m=>{m.categoryName===t&&(m.categoryName=l)})}),{success:!0}}function zs(s,c,e){if(xe(e.students).some(m=>m.identity.name.toLowerCase()===s.identity.name.toLowerCase()))return{success:!1,message:`دانش‌آموزی با نام «${s.identity.name}» از قبل در کلاس «${e.info.name}» وجود دارد.`};const a=JSON.parse(JSON.stringify(s)),t=Ds(a),n=new Map;c.sessions.forEach(m=>{const b=m.studentRecords[s.identity.studentId];b&&n.set(m.sessionNumber,JSON.parse(JSON.stringify(b)))}),e.addStudent(t);try{const m=xe(e.sessions).filter(y=>!y.isCancelled).sort((y,g)=>g.sessionNumber-y.sessionNumber),b=m.length>0?m[0]:null;let v="؟",h={type:"system",description:"Student Move"};b&&(v=Xe(e).get(b.sessionNumber)||b.sessionNumber,h={type:"fromSession",sessionNumber:b.sessionNumber});const u=new Date().toLocaleDateString("fa-IR"),p=c.info.name,f=`این دانش آموز در جلسه ${v} و در تاریخ ${u} از کلاس «${p}» به این کلاس انتقال پیدا کرد`;t.addNote(f,h)}catch(m){console.error("Failed to add automated move note:",m)}n.size>0&&e.sessions.forEach(m=>{const b=n.get(m.sessionNumber);b&&!m.isDeleted&&!m.isCancelled&&(m.studentRecords[t.identity.studentId]=b)});const i={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`(انتقال) دانش‌آموز «${s.identity.name}» از کلاس «${c.info.name}»`,restoreData:{studentId:s.identity.studentId,classId:c.info.scheduleCode}};pe.unshift(i),pe.length>50&&pe.pop();const r=c.students.find(m=>m.identity.studentId===s.identity.studentId);return r&&(r.isDeleted=!0),{success:!0}}function Ms(){for(const s in ce){const c=ce[s];c.students.forEach(e=>{e.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0},e.categoryCounts={},e.categoryIssues={},c.sessions.forEach(l=>{const a=e.identity.studentId;l.studentRecords[a]&&(l.studentRecords[a].attendance="present")})})}le()}function xe(s){return Array.isArray(s)?s.filter(c=>!c.isDeleted):[]}function Xe(s){const c=new Map;return s&&xe(s.sessions).filter(l=>!l.isCancelled).sort((l,a)=>l.sessionNumber-a.sessionNumber).forEach((l,a)=>{c.set(l.sessionNumber,a+1)}),c}function mt(s){Qe=s}function nt(s){ds=s}function En(s,c){if(!s||!c)return;const e=s.identity.studentId,l=c.students.findIndex(a=>a.identity.studentId===e);l>-1&&c.students.splice(l,1),c.sessions.forEach(a=>{a.studentRecords[e]&&delete a.studentRecords[e];for(const t in a.lastWinnerByCategory)a.lastWinnerByCategory[t]===e&&delete a.lastWinnerByCategory[t];a.lastSelectedWinnerId===e&&(a.lastSelectedWinnerId=null),a.winnerHistory=a.winnerHistory.filter(t=>t.winner&&t.winner.identity.studentId!==e)})}function $s(s,c){const e=ce[s];if(!e)return;const l=e.sessions.findIndex(a=>a.sessionNumber===c);l>-1&&(e.students.forEach(a=>{a.profile.notes&&a.profile.notes.length>0&&(a.profile.notes=a.profile.notes.filter(t=>!t.source||t.source.type!=="fromAttendance"||t.source.sessionNumber!==c)),a.onboardingSession===c&&(a.onboardingSession=null)}),e.sessions.splice(l,1))}function Fs(s,c){const e=ce[s];if(!e)return;const l=e.categories.findIndex(i=>i.id===c);if(l===-1)return;const t=e.categories[l].name,n=t.toLowerCase();e.students.forEach(i=>{i.categoryCounts&&delete i.categoryCounts[t],i.categoryIssues&&delete i.categoryIssues[t],i.logs.scores&&delete i.logs.scores[n]}),e.sessions.forEach(i=>{i.lastWinnerByCategory[t]&&delete i.lastWinnerByCategory[t],i.winnerHistory=i.winnerHistory.filter(r=>r.categoryName!==t)}),e.categories.splice(l,1)}function Ps(s,c,e,l){const a=ce[s];if(!a)return;const t=a.students.find(r=>r.identity.studentId===c);if(!t||!t.logs.scores[e.toLowerCase()])return;const n=t.logs.scores[e.toLowerCase()],i=n.findIndex(r=>r.id===l);i>-1&&n.splice(i,1)}function Ws(s,c,e){const l=ce[s];if(!l)return;const a=l.students.find(n=>n.identity.studentId===c);if(!a||!a.profile.notes)return;const t=a.profile.notes.findIndex(n=>n.id===e);t>-1&&a.profile.notes.splice(t,1)}function Us(){JSON.parse(JSON.stringify({classrooms:ce,trashBin:pe})),it=!0}function Hs(){it=!1,_n()}function We(s){O=s}function Tn(s){ss=s}function qe(s){J=s}function Ve(s){_e=s}function kn(s){qt=s}function js(s){Nn=s}function $t(s){is=s}function rn(s){gn=s}function Zs(s){as=s}function Sn(s){Ge=s}function on(s){yn=s}function Gs(s){rs=s}function cn(s){bn=s}function qs(s){os=s}function us(s){cs=s}function fs(s){ls=s}function Vt(s){vn=s}function ms(s){ft=s}function In(s){wn=s}function Vs(s){Bs=s}function Ks(s){Ns=s}function xn(s){pe=s}function Dn(s){Cn=s}function Ln(s){vt=s}function Wt(s){Ze={...Ze,...s},le()}function Pn(s){st=s}function hs(){Ze.lastBackupTimestamp=new Date().toISOString(),le()}const Ni=Object.freeze(Object.defineProperty({__proto__:null,get activeModal(){return ft},get cancelCallback(){return ls},get classrooms(){return ce},get confirmCallback(){return cs},get currentClassroom(){return O},get easterEggClickCount(){return yn},get easterEggLastClickTime(){return rs},enterDemoMode:Us,exitDemoMode:Hs,getActiveItems:xe,getSessionDisplayMap:Xe,get importedFileContent(){return gn},get isDemoMode(){return it},get liveSession(){return ss},loadData:_n,get manualSelection(){return wn},moveStudent:zs,get namesToImport(){return is},get notificationTimeout(){return as},permanentlyDeleteCategory:Fs,permanentlyDeleteNote:Ws,permanentlyDeleteScore:Ps,permanentlyDeleteSession:$s,permanentlyDeleteStudent:En,prepareBackupData:Ts,get previousState(){return qt},processRestore:As,rehydrateData:Ct,renameCategory:Rs,renameClassroom:Os,resetAllStudentCounters:Ms,get resetEasterEggClickCount(){return bn},get resetEasterEggLastClickTime(){return os},get saveCategoryCallback(){return Cn},saveData:le,get saveNoteCallback(){return ds},get secureConfirmCallback(){return vn},get selectedCategory(){return Ge},get selectedClassIds(){return st},get selectedSession(){return J},get selectedStudentForProfile(){return _e},get selectedStudentsForMassComment(){return vt},setActiveModal:ms,setCancelCallback:fs,setConfirmCallback:us,setCurrentClassroom:We,setEasterEggClickCount:on,setEasterEggLastClickTime:Gs,setImportedFileContent:rn,setLastBackupTimestamp:hs,setLiveSession:Tn,setManualSelection:In,setNamesToImport:$t,setNotificationTimeout:Zs,setPreviousState:kn,setResetEasterEggClickCount:cn,setResetEasterEggLastClickTime:qs,setSaveCategoryCallback:Dn,setSaveNoteCallback:nt,setSecureConfirmCallback:Vt,setSelectedCategory:Sn,setSelectedClassIds:Pn,setSelectedSession:qe,setSelectedStudentForProfile:Ve,setSelectedStudentsForMassComment:Ln,setSourceClassForMove:Ks,setStudentToMove:Vs,setTrashBin:xn,setUndoTimeout:js,setUserSettings:Wt,setWinnerHistoryIndex:mt,get sourceClassForMove(){return Ns},get studentToMove(){return Bs},get trashBin(){return pe},get undoTimeout(){return Nn},get userSettings(){return Ze},get winnerHistoryIndex(){return Qe}},Symbol.toStringTag,{value:"Module"}));function rt(s){return typeof s!="string"?"":s.replace(/ي/g,"ی").replace(/ك/g,"ک").replace(/[\s\u200c]/g,"")}function ps(s){return typeof s!="string"||s.length===0?"ltr":/[\u0590-\u07FF]/.test(s)?"rtl":"ltr"}function Js(s){return!s||!s.trim()?"":s.split(`
`).map(l=>`<div dir="${ps(l)}">${l||"&nbsp;"}</div>`).join("")}function Mn(s){if(typeof s!="string")return"";const c={q:"ض",w:"ص",e:"ث",r:"ق",t:"ف",y:"غ",u:"ع",i:"ه",o:"خ",p:"ح","[":"ج","]":"چ",a:"ش",s:"س",d:"ی",f:"ب",g:"ل",h:"ا",j:"ت",k:"ن",l:"م",";":"ک","'":"گ",z:"ظ",x:"ط",c:"ز",v:"ر",b:"ذ",n:"د",m:"پ",",":"و"};let e="";for(let l=0;l<s.length;l++){const a=s[l].toLowerCase();e+=c[a]||s[l]}return e}const Xs="teacherAssistantLogs_v2",Ti=100;function gs(){try{const s=localStorage.getItem(Xs);return s?JSON.parse(s):{}}catch(s){return console.error("Error reading logs from localStorage:",s),{}}}function Ys(s){try{localStorage.setItem(Xs,JSON.stringify(s))}catch(c){console.error("Error saving logs to localStorage:",c)}}function we(s,c,e=null){if(!s)return;const l=gs();l[s]||(l[s]=[]);const a={timestamp:new Date().toISOString(),message:c,action:e,classroomName:s};l[s].unshift(a),l[s].length>Ti&&l[s].pop(),Ys(l)}function Di(s){return gs()[s]||[]}function Ai(s,c){const e=gs();e[s]&&!e[c]&&(e[c]=e[s],delete e[s],Ys(e))}const Qs=document.getElementById("class-management-page"),Oi=document.getElementById("new-class-name"),Ri=document.getElementById("add-class-btn"),Nt=document.getElementById("class-list"),Bn=document.getElementById("undo-toast"),ei=document.getElementById("undo-message"),zi=document.getElementById("undo-btn"),Mi=document.getElementById("settings-page"),ys=document.getElementById("settings-class-name-header"),Wn=document.getElementById("settings-student-list"),Un=document.getElementById("category-list"),$i=document.getElementById("back-to-sessions-btn"),Fi=document.getElementById("new-student-name"),Pi=document.getElementById("add-student-btn"),ti=document.getElementById("paste-area"),Wi=document.getElementById("process-paste-btn"),Ui=document.getElementById("csv-preview-page"),Hn=document.getElementById("csv-preview-list"),Hi=document.getElementById("csv-confirm-btn"),ji=document.getElementById("csv-cancel-btn"),Zi=document.getElementById("import-csv-btn"),Gi=document.getElementById("csv-file-input"),qi=document.getElementById("column-mapping-page"),jn=document.getElementById("column-select-dropdown"),Vi=document.getElementById("confirm-column-btn"),Ki=document.getElementById("cancel-import-btn"),Ji=document.getElementById("new-category-name"),Xi=document.getElementById("add-category-btn"),Zn=document.querySelector(".app-header"),tt=document.getElementById("select-student-btn"),Dt=document.getElementById("select-student-btn-wrapper"),Yi=document.getElementById("attendance-page"),Ut=document.getElementById("attendance-list"),Qi=document.getElementById("finish-attendance-btn"),ea=document.querySelector("#class-management-page h2"),Gn=document.getElementById("student-stats-header"),ta=document.getElementById("hamburger-menu-btn"),na=document.getElementById("side-nav-menu"),sa=document.getElementById("close-nav-btn"),ia=document.getElementById("overlay"),aa=document.getElementById("backup-data-btn"),ra=document.getElementById("restore-data-btn"),ni=document.getElementById("restore-file-input"),oa=document.getElementById("custom-confirm-modal"),si=document.getElementById("confirm-modal-message"),qn=document.getElementById("confirm-modal-cancel-btn"),Ft=document.getElementById("confirm-modal-confirm-btn"),ca=document.getElementById("secure-confirm-modal"),ii=document.getElementById("secure-confirm-message"),ai=document.getElementById("secure-confirm-code"),xt=document.getElementById("secure-confirm-input"),la=document.getElementById("secure-confirm-cancel-btn"),ln=document.getElementById("secure-confirm-confirm-btn"),da=document.getElementById("add-note-modal"),Ce=document.getElementById("new-note-content"),ua=document.getElementById("class-save-note-btn"),fa=document.getElementById("cancel-note-btn"),Vn=document.getElementById("student-search-input"),ut=document.getElementById("student-search-results"),ma=document.getElementById("back-to-student-page-btn"),ha=document.getElementById("graded-category-pills-container"),pa=document.getElementById("new-score-value"),ri=document.getElementById("new-score-comment"),ga=document.getElementById("add-score-btn"),ya=document.getElementById("profile-stats-summary"),ba=document.getElementById("profile-scores-list"),dn=document.getElementById("global-student-search-input"),ot=document.getElementById("global-student-search-results"),va=document.getElementById("is-graded-checkbox"),Ca=document.getElementById("trashed-classes-list"),wa=document.getElementById("trashed-students-list"),_a=document.getElementById("trashed-sessions-list"),Ea=document.getElementById("trashed-categories-list"),ka=document.getElementById("trashed-notes-list"),Sa=document.getElementById("trashed-scores-list"),Bt=document.getElementById("quick-grade-form-wrapper"),at=document.getElementById("quick-score-input"),et=document.getElementById("quick-note-textarea"),yt=document.getElementById("quick-grade-submit-btn"),Ht=document.getElementById("category-selection-container"),Kn=document.getElementById("selected-student-result"),bt=document.getElementById("custom-context-menu"),Lt=document.getElementById("breadcrumb-container");let Mt=null,Tt=null;const Ia=document.getElementById("category-modal"),oi=document.getElementById("category-modal-title"),jt=document.getElementById("new-category-modal-name"),bs=document.getElementById("new-category-modal-is-graded"),xa=document.getElementById("category-modal-cancel-btn"),ci=document.getElementById("category-modal-save-btn"),La=document.getElementById("mass-comment-modal"),Ba=document.getElementById("mass-comment-modal-title"),li=document.getElementById("mass-comment-student-count-message"),Zt=document.getElementById("mass-comment-content"),vs=document.getElementById("mass-comment-append-checkbox"),Na=document.getElementById("mass-comment-cancel-btn"),Ta=document.getElementById("mass-comment-save-btn"),Jn=document.getElementById("mass-comment-btn"),un=document.getElementById("attendance-mass-actions-container"),pt=document.createElement("input"),Da=document.getElementById("session-dashboard-page"),At=document.getElementById("attendance-pane");function Kt(s="selector"){if(!O||!J){he("class-management-page");return}Ma(),mn(),ze(),wt(),he("session-dashboard-page",{tab:s}),di(),Jt(s),$a()}function Jt(s){const c=document.getElementById("selector-tab-btn"),e=document.getElementById("attendance-tab-btn"),l=document.getElementById("selector-pane"),a=s==="selector";c.classList.toggle("active",a),e.classList.toggle("active",!a),l.classList.toggle("active",a),At.classList.toggle("active",!a)}function di(){const s=document.getElementById("selector-tab-btn"),c=document.getElementById("attendance-tab-btn"),e=document.getElementById("selector-pane");s.addEventListener("click",()=>{ze(),Pe(),s.classList.add("active"),c.classList.remove("active"),e.classList.add("active"),At.classList.remove("active"),he("session-dashboard-page",{tab:"selector"})}),c.addEventListener("click",()=>{wt(),c.classList.add("active"),s.classList.remove("active"),At.classList.add("active"),e.classList.remove("active"),he("session-dashboard-page",{tab:"attendance"})})}function Aa(s){clearTimeout(Nn),qt||kn(JSON.stringify(ce)),ei.textContent=s,Bn.classList.add("show"),js(setTimeout(()=>{Bn.classList.remove("show"),kn(null)},5e3))}function ui(){if(qt){const s=O?O.info.name:null,c=JSON.parse(qt);Ct(c),s&&ce[s]?We(ce[s]):We(null),O?(lt(),Ot(),He()):Ue(),Bn.classList.remove("show"),clearTimeout(Nn),kn(null)}}function Q(s,c=3e3){const e=document.getElementById("notification-toast");e&&(e.textContent=s,e.classList.add("show"),clearTimeout(as),Zs(setTimeout(()=>{e.classList.remove("show")},c)))}function Xn(s){const c=document.getElementById("restore-confirm-modal"),e=document.getElementById("restore-modal-message"),l=document.getElementById("restore-append-checkbox"),a=document.getElementById("restore-confirm-cancel-btn"),t=document.getElementById("restore-confirm-confirm-btn"),n=document.getElementById("restore-modal-warning");n.style.display="none";const i=s.metadata.createdAt;if(Ze.lastRestoreTimestamp&&i<Ze.lastRestoreTimestamp){const h=new Date(i).toLocaleDateString("fa-IR"),u=new Date(Ze.lastRestoreTimestamp).toLocaleDateString("fa-IR");n.textContent=`⚠️ هشدار: این فایل پشتیبان (${h}) قدیمی‌تر از آخرین بازیابی شما (${u}) است.`,n.style.display="block"}const r=Object.keys(s.data.classrooms).length,m="کلاس";e.textContent=`فایل پشتیبان شما حاوی ${r} ${m} است. لطفاً نحوه بازیابی را مشخص کنید.`,l.checked=!0;const b=()=>{const h=l.checked;As(s,h),c.removeEventListener("click",b),ke(),Ue(),he("class-management-page"),Q("✅ اطلاعات با موفقیت بازیابی شد.")},v=()=>{ke()};t.onclick=b,a.onclick=v,$e("restore-confirm-modal")}function Be(s,c,e={}){const{confirmText:l="تایید",cancelText:a="لغو",confirmClass:t="btn-success",onCancel:n=()=>{},isDelete:i=!1}=e,r=i?()=>fi(s,c):c;si.textContent=s,Ft.textContent=l,qn.textContent=a,Ft.className="modal-action-btn",Ft.classList.add(t),us(r),fs(n);const m=Ft.parentElement;qn.style.display=n===null?"none":"inline-block",m.style.justifyContent=n===null?"center":"space-between",$e("custom-confirm-modal")}function fi(s,c){const e=Math.floor(1e4+Math.random()*9e4).toString();ii.textContent=s,ai.textContent=e,xt.value="",ln.disabled=!0,Vt(c),$e("secure-confirm-modal"),xt.focus();const l=()=>{xt.value===e?ln.disabled=!1:ln.disabled=!0};return xt.addEventListener("input",l),()=>{xt.removeEventListener("input",l)}}function Yn(s,c={}){const{title:e="ایجاد دسته‌بندی جدید",initialName:l="",initialIsGraded:a=!1,saveButtonText:t="ذخیره"}=c;oi.textContent=e,jt.value=l,bs.checked=a,ci.textContent=t,Dn((n,i)=>{if(!n){Q("⚠️ لطفاً نام دسته‌بندی را وارد کنید.");return}s(n,i),ke()}),$e("category-modal"),jt.focus(),l&&jt.select()}function mi(s,c){const e=Object.values(ce).filter(n=>!n.isDeleted&&n.info.name!==c.info.name),l=document.getElementById("move-student-modal-title"),a=document.getElementById("move-student-class-select"),t=document.getElementById("move-student-confirm-btn");l.textContent=`انتقال دانش‌آموز: ${s.identity.name}`,a.innerHTML="",e.length===0?(a.innerHTML='<option value="">کلاس دیگری برای انتقال وجود ندارد</option>',t.disabled=!0):(e.forEach(n=>{const i=document.createElement("option");i.value=n.info.name,i.textContent=n.info.name,a.appendChild(i)}),t.disabled=!1),Vs(s),Ks(c),$e("move-student-modal")}function Cs(s,c){if(!s||!c)return;const e=s.identity.name,l=document.getElementById("add-note-modal-title");l.textContent="تغییر نام دانش‌آموز",Ce.value=e,Ce.rows=1,Ce.dispatchEvent(new Event("input",{bubbles:!0})),nt(a=>{const t=a.trim();t&&t!==e&&(xe(c.students).some(i=>i.identity.studentId!==s.identity.studentId&&i.identity.name.toLowerCase()===t.toLowerCase())?Q("دانش‌آموزی با این نام از قبل در این کلاس وجود دارد."):(s.identity.name=t,we(c.info.name,`نام دانش‌آموز «${e}» به «${t}» تغییر یافت.`,{type:"VIEW_STUDENT_PROFILE",studentId:s.identity.studentId}),le(),lt(),ze(),wt(),Pe(),_e&&_e.identity.studentId===s.identity.studentId&&Me(s),Q(`✅نام دانش‌آموز به «${t}» تغییر یافت.`))),l.textContent="ثبت یادداشت جدید",Ce.rows=4}),$e("add-note-modal"),Ce.focus(),Ce.select()}function $e(s){const c=document.getElementById(s);if(c){if(ft)return;document.body.classList.add("modal-active"),c.classList.add("modal-visible"),ms(s),history.pushState(null,"",location.href)}}function ke(s,c=!1){if(!ft)return;const e=document.getElementById(ft),l=ft;ms(null),l==="student-profile-modal"&&Ve(null),c||history.back(),e&&(e.classList.add("modal-closing"),setTimeout(()=>{e.classList.remove("modal-visible"),e.classList.remove("modal-closing"),document.body.classList.remove("modal-active"),l==="custom-confirm-modal"&&(us(null),fs(null)),l==="secure-confirm-modal"&&Vt(null),l==="category-modal"&&Dn(null),l==="mass-comment-modal"&&(Zt.value=""),l==="add-note-modal"&&nt(null),typeof s=="function"&&s()},300))}function ws(){if(!At||!At.classList.contains("active")){un.style.display="none";return}const s=vt.length;s<1?un.style.display="none":un.style.display="block",Jn.disabled=s<1,Jn.textContent=`📝 ثبت یادداشت گروهی (${s} نفر)`}function hi(){const s=vt,c=s.length;let e=!1;c>0&&(e=s.some(a=>{var t;return(t=J.studentRecords[a])==null?void 0:t.homework.comment})),li.textContent=`یادداشت برای ${c} دانش‌آموز ثبت خواهد شد.`,Zt.value="",Zt.dispatchEvent(new Event("input",{bubbles:!0})),vs.checked=!0;const l=document.querySelector("#mass-comment-modal .modal-options");l.style.display=e?"flex":"none",$e("mass-comment-modal"),Zt.focus()}function Qn(s,c){if(!O||!J)return;let e=0;const l=vt,a=J;l.forEach(t=>{const n=a.studentRecords[t];if(n&&n.homework){const i=n.homework.comment||"";let r=s;c&&i.length>0?r=i+`
---
`+s:r=s,n.homework.comment=r.trim();const m=O.students.find(b=>b.identity.studentId===t);m&&Oa(m,a,r.trim()),e++}}),Ln([]),le(),wt(),we(O.info.name,`${e} دانش‌آموز به صورت گروهی یادداشت تکلیف گرفتند.`,{type:"VIEW_SESSIONS"}),Q(`✅ یادداشت برای ${e} دانش‌آموز ثبت شد.`)}function Oa(s,c,e){const a=Xe(O).get(c.sessionNumber),t={type:"fromAttendance",sessionNumber:c.sessionNumber},n=`یادداشت مربوط به جلسه ${a}: `,i=s.profile.notes.find(r=>!r.isDeleted&&r.source&&r.source.type==="fromAttendance"&&r.source.sessionNumber===t.sessionNumber);i?e?(i.content=n+e,i.isDeleted=!1):i.isDeleted=!0:e&&s.addNote(n+e,t)}function _s(s){Ce.value=s.note||"",nt(c=>{s.note=c,le(),we(s.info.name,"یادداشت کلاس ذخیره شد.",{type:"VIEW_CLASS_NOTE"}),Ue(),Q("✅ یادداشت کلاس ذخیره شد.")}),$e("add-note-modal"),Ce.focus()}function Es(s){We(s),ys.textContent=`تنظیمات کلاس: ${s.info.name}`,lt(),Ot(),he("settings-page")}function pi(s){const c=document.getElementById("log-modal-title"),e=document.getElementById("log-list");c.textContent=`گزارش فعالیت‌های کلاس: ${s}`,e.innerHTML="";const l=Di(s);l.length===0?e.innerHTML='<li class="no-content-message">هنوز فعالیتی برای این کلاس ثبت نشده است.</li>':l.forEach(a=>{const t=document.createElement("li");t.className="log-entry";const n=new Date(a.timestamp),i=`${n.toLocaleDateString("fa-IR")} - ${n.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}`,r=document.createElement("span");r.className="log-timestamp",r.textContent=i;const m=document.createElement("span");m.className="log-message",m.textContent=a.message,a.action&&(m.classList.add("log-action-link"),m.dataset.action=JSON.stringify({...a.action,classroomName:a.classroomName})),t.appendChild(r),t.appendChild(m),e.appendChild(t)}),$e("log-modal")}document.getElementById("log-modal-close-btn").addEventListener("click",()=>{ke()});function es(s){const c=URL.createObjectURL(s),e=document.createElement("a");e.href=c,e.download=s.name,document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(c),setTimeout(()=>{Be("آیا فایل پشتیبان با موفقیت ذخیره شد؟",()=>{hs(),An(),Q("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله، ذخیره شد",cancelText:"خیر",confirmClass:"btn-success"})},500)}async function Xt(s=[]){const c=await Ts(s);if(!c){Q("❌ خطا در ایجاد فایل پشتیبان.");return}("ontouchstart"in window||navigator.maxTouchPoints>0)&&navigator.share&&navigator.canShare&&navigator.canShare({files:[c]})?Be("فایل پشتیبان شما آماده است. آیا مایل به اشتراک‌گذاری آن هستید؟",()=>{try{navigator.share({title:c.name,text:"فایل پشتیبان داده‌های برنامه",files:[c]}).then(()=>{Be("آیا فایل پشتیبان با موفقیت ارسال/ذخیره شد؟",()=>{hs(),An(),Q("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}catch(l){console.error("Error during sharing process:",l),es(c),Q("⚠️خطا در فرآیند اشتراک‌گذاری. فایل در حال دانلود است.")}},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"}):(es(c),Q("✅پشتیبان‌گیری با موفقیت انجام شد."))}function Qt(s,c){s.preventDefault(),gt(),Tt=s.target.closest("li"),Tt&&Tt.classList.add("context-menu-target"),setTimeout(()=>{const e=bt,l=e.querySelector("ul");l.innerHTML="",c.forEach(m=>{const b=document.createElement("li");m.isSeparator?b.className="separator":(b.innerHTML=`
                    <span class="icon">${m.icon||""}</span>
                    <span class="label">${m.label}</span>
                `,m.className&&b.classList.add(m.className),b.addEventListener("click",()=>{m.action(),gt()})),l.appendChild(b)}),e.classList.add("visible");const{offsetWidth:a,offsetHeight:t}=e,{innerHeight:n}=window,i=document.body.getBoundingClientRect();e.style.top=`${(n-t)/2}px`;const r=i.left+i.width/2;e.style.left=`${r-a/2}px`},50)}function gt(){bt.classList.contains("visible")&&bt.classList.remove("visible"),Tt&&(Tt.classList.remove("context-menu-target"),Tt=null)}function gi(){var c,e;Lt.innerHTML="";const s=[];if(s.push({label:"کلاس‌ها",handler:()=>{We(null),qe(null),Ve(null),he("class-management-page")}}),O){if(s.push({label:O.info.name,handler:()=>{qe(null),Ve(null),He(),he("session-page")}}),((c=document.querySelector(".page.active"))==null?void 0:c.id)==="settings-page")s.push({label:"تنظیمات"});else if(J){const t=Xe(O).get(J.sessionNumber)||` (#${J.sessionNumber})`;s.push({label:`جلسه ${t}`,handler:()=>{Ve(null),he("student-page")}});const n=(e=document.querySelector(".page.active"))==null?void 0:e.id;_e?s.push({label:`پروفایل: ${_e.identity.name}`}):n==="attendance-page"&&s.push({label:"حضور و غیاب"})}}if(s.length<=1){Lt.style.display="none";return}Lt.style.display="flex",s.forEach((l,a)=>{const t=document.createElement("a");if(t.textContent=l.label,t.className="breadcrumb-item",a===s.length-1||!l.handler?t.classList.add("active"):t.addEventListener("click",l.handler),Lt.appendChild(t),a<s.length-1){const n=document.createElement("span");n.className="breadcrumb-separator",n.textContent="/",Lt.appendChild(n)}})}function Ss(s,c,e){e.innerHTML="";const l=O.sessions.filter(a=>{var t;return!a.isDeleted&&!a.isCancelled&&((t=a.studentRecords[s.identity.studentId])==null?void 0:t.attendance)==="absent"}).map(a=>({number:c.get(a.sessionNumber),isMakeup:a.isMakeup})).filter(a=>a.number!==void 0);l.length>0?(e.appendChild(document.createTextNode("جلسات غایب: ")),l.forEach((a,t)=>{const n=document.createElement("span");n.textContent=a.number,a.isMakeup&&n.classList.add("makeup-absence"),e.appendChild(n),t<l.length-1&&e.appendChild(document.createTextNode("، "))})):e.textContent="جلسات غایب: بدون غیبت"}function fn(s,c,e,l={}){const{includePrefix:a=!0}=l;e.innerHTML="";const t=O.sessions.filter(n=>{if(n.isDeleted||n.isCancelled)return!1;const i=n.studentRecords[s.identity.studentId];return i&&i.homework&&(i.homework.status==="incomplete"||i.homework.status==="none")}).map(n=>({number:c.get(n.sessionNumber),status:n.studentRecords[s.identity.studentId].homework.status})).filter(n=>n.number!==void 0);t.length>0?(a&&e.appendChild(document.createTextNode("تکالیف ناقص: ")),t.forEach((n,i)=>{const r=document.createElement("span");r.textContent=n.number,n.status==="incomplete"&&r.classList.add("incomplete-homework"),e.appendChild(r),i<t.length-1&&e.appendChild(document.createTextNode("،"))})):a?e.textContent="تکالیف ناقص: ندارد":e.textContent="ندارد"}function Ra(s,c){var g,w,k;const e=document.createElement("li");e.className="attendance-list-item";const l=document.createElement("input");l.type="checkbox",l.className="mass-comment-checkbox",l.checked=vt.includes(s.identity.studentId),l.addEventListener("change",()=>{const I=s.identity.studentId,S=vt;if(l.checked)S.includes(I)||S.push(I);else{const A=S.indexOf(I);A>-1&&S.splice(A,1)}ws()}),e.appendChild(l);const a={none:"بدون تکلیف",complete:"تکلیف کامل",incomplete:"تکلیف ناقص"},t=document.createElement("div");t.className="student-info";const n=document.createElement("span");n.className="student-name",n.textContent=s.identity.name,n.addEventListener("click",()=>{Me(s)});const i=document.createElement("span");i.className="absence-info";const r=document.createElement("span");r.className="homework-info",Ss(s,c,i),fn(s,c,r),t.appendChild(n),t.appendChild(i),t.appendChild(r);const m=document.createElement("div");m.className="homework-controls";const b=document.createElement("button"),v=((g=J.studentRecords[s.identity.studentId])==null?void 0:g.homework.status)||"none";b.className=`homework-status-btn ${v}`,b.title=a[v],b.addEventListener("click",()=>{const I=J.studentRecords[s.identity.studentId].homework,A={none:"incomplete",incomplete:"complete",complete:"none"}[I.status];b.title=a[A],J.setHomeworkStatus(s.identity.studentId,A),le(),b.className=`homework-status-btn ${A}`,fn(s,c,r)});const h=document.createElement("button");h.className="btn-icon",h.innerHTML="📝",h.title="افزودن یادداشت برای تکلیف",((w=J.studentRecords[s.identity.studentId])==null?void 0:w.homework.comment)||(h.style.opacity="0.3"),h.addEventListener("click",()=>{const I=J.studentRecords[s.identity.studentId].homework;Ce.value=I.comment||"",Ce.dispatchEvent(new Event("input",{bubbles:!0})),nt(S=>{I.comment=S;const A=Xe(O),z=A.get(J.sessionNumber),H={type:"fromAttendance",sessionNumber:J.sessionNumber},D=`یادداشت مربوط به جلسه ${z}: `,G=s.profile.notes.find(se=>!se.isDeleted&&se.source&&se.source.type==="fromAttendance"&&se.source.sessionNumber===H.sessionNumber);G?S?G.content=D+S:G.isDeleted=!0:S&&s.addNote(D+S,H),le(),we(O.info.name,`یادداشت تکلیف جلسه ${z} برای دانش‌آموز «${s.identity.name}» ذخیره شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:s.identity.studentId}),Q("✅یادداشت تکلیف ذخیره شد."),h.style.opacity=S?"1":"0.3",fn(s,A,r)}),$e("add-note-modal"),Ce.focus()}),m.appendChild(b),m.appendChild(h);const p=document.createElement("button"),f=((k=J.studentRecords[s.identity.studentId])==null?void 0:k.attendance)||"present",y=I=>{I==="present"?(p.textContent="حاضر",p.className="attendance-status-btn present active"):(p.textContent="غایب",p.className="attendance-status-btn absent active")};return y(f),p.addEventListener("click",()=>{var A;const S=(((A=J.studentRecords[s.identity.studentId])==null?void 0:A.attendance)||"present")==="present"?"absent":"present";J.setAttendance(s.identity.studentId,S),S==="absent"&&(J.studentRecords[s.identity.studentId].hadIssue=!1),le(),y(S),Ss(s,c,i),ze(),_i()}),e.appendChild(t),e.appendChild(m),e.appendChild(p),e}function za(){return Xe(O).get(J.sessionNumber)}function wt(){if(!O||!J)return;xe(O.students).forEach(a=>{J.initializeStudentRecord(a.identity.studentId)}),Ln([]);const s=Xe(O);qa(),Ut.innerHTML="";const c=document.createElement("li");c.className="attendance-list-header",pt.id="attendance-search-input",pt.type="text",pt.className="inline-search-input",pt.placeholder="جستجو...",pt.value="";const e=document.createElement("div");e.className="student-search-container",e.appendChild(pt);const l=document.createElement("div");l.className="header-labels-container",l.innerHTML=`
    <span class="header-label">تکلیف</span>
    <span class="header-label">حضور</span>
`,c.appendChild(e),c.appendChild(l),Ut.appendChild(c),xe(O.students).forEach(a=>{const t=Ra(a,s);Ut.appendChild(t)}),Ln([]),ws(),Va(),_i()}function ze(){const s=document.getElementById("student-stats-table-container");if(!s||(s.innerHTML="",!O))return;xe(O.students).length,Gn.textContent="آمار عملکرد";const c=["نام"],e=["کل انتخاب ها","غیبت","خروج","فرصت ازدست‌رفته","مشکل","میانگین","نمره کلاسی (کانون)"],l=O.categories.filter(u=>u.isGradedCategory&&!u.isDeleted).map(u=>u.name),a=[...c,...l,...e],t=document.createElement("table");t.className="student-stats-table";const i=t.createTHead().insertRow();a.forEach((u,p)=>{const f=document.createElement("th");p===0?(f.innerHTML=`${u} <span style="opacity: 0.6;">🔗</span>`,f.title="ردیف‌های این ستون قابل کلیک هستند"):f.textContent=u,i.appendChild(f)});const r=t.createTBody(),m=xe(O.students),b=u=>{let p=0;return O.sessions.forEach(f=>{if(f.isDeleted||f.isCancelled)return;const y=f.studentRecords[u.identity.studentId];y&&y.attendance==="absent"&&p++}),p};m.forEach(u=>{const p=r.insertRow();if(p.dataset.studentId=u.identity.studentId,J){const I=J.studentRecords[u.identity.studentId];I&&I.attendance==="absent"&&p.classList.add("absent-row-highlight")}const f=p.insertCell(),y=document.createElement("span");y.textContent=u.identity.name,y.className="student-name-link",y.addEventListener("click",()=>{Me(u)}),f.appendChild(y),l.forEach(I=>{var H;const S=p.insertCell(),A=I.toLowerCase(),z=((H=u.logs.scores[A])==null?void 0:H.filter(D=>!D.isDeleted))||[];z.length>0?z.forEach((D,G)=>{const se=document.createElement("span");se.textContent=D.value,se.style.position="relative",D.comment&&(se.dataset.tooltip=D.comment),S.appendChild(se),G<z.length-1&&S.appendChild(document.createTextNode(","))}):S.textContent="",S.style.cursor="pointer",S.addEventListener("click",()=>{Pe(u,I);const D=document.getElementById("category-selection-container");D&&D.scrollIntoView({behavior:"smooth",block:"center"})})}),p.insertCell().textContent=u.statusCounters.totalSelections||0,p.insertCell().textContent=b(u),p.insertCell().textContent=u.statusCounters.outOfClassCount||0,p.insertCell().textContent=u.statusCounters.missedChances||0;const g=Object.values(u.categoryIssues||{}).reduce((I,S)=>I+S,0);p.insertCell().textContent=g;const w=u.getOverallAverageScore();p.insertCell().textContent=w!==null?w:"-";const k=O.calculateFinalStudentScore(u);p.insertCell().textContent=k!==null?k:"-"}),xe(O.students),Gn.setAttribute("data-student-count",m.length),s.appendChild(t);const v=s.querySelector(".student-stats-table"),h=v==null?void 0:v.querySelector("thead th:first-child");h&&h.addEventListener("click",()=>{v.classList.toggle("name-column-expanded")})}function Pe(s=null,c=null){const e=document.getElementById("selected-student-result");e.innerHTML="",e.classList.remove("absent");let l,a;if(s&&c)l=s,a=c,In({student:s,categoryName:c}),mt(-1);else{if(In(null),!J||Qe<0||!J.winnerHistory[Qe])return;const $=J.winnerHistory[Qe];l=$.winner,a=$.categoryName}const t=document.querySelector(".current-winner-highlight");if(t&&t.classList.remove("current-winner-highlight"),l){const $=document.querySelector(`.student-stats-table tr[data-student-id="${l.identity.studentId}"]`);$&&$.classList.add("current-winner-highlight")}const n=O.categories.find($=>$.name===a);if(n){Sn(n),ks(n);const $=document.querySelectorAll("#category-selection-container .pill");$.forEach(N=>N.classList.remove("active"));const te=Array.from($).find(N=>N.textContent===a);te&&te.classList.add("active"),ts(n)}const i=J.studentRecords[l.identity.studentId],r=(i==null?void 0:i.attendance)==="absent",m=document.createElement("div");m.className="winner-name-container";const b=document.createElement("button");b.className="btn-icon",b.innerHTML="˅",b.title="برنده قبلی";const v=!s;b.classList.toggle("is-disabled",!v||Qe<=0),b.addEventListener("click",()=>{b.classList.contains("is-disabled")?(b.classList.add("shake-animation"),setTimeout(()=>b.classList.remove("shake-animation"),200)):(mt(Qe-1),Pe())});const h=document.createElement("div");h.className="winner-name",h.innerHTML=`✨ <strong>${l.identity.name}</strong>✨`,h.classList.add("heartbeat-animation"),r&&(h.style.textDecoration="line-through",h.style.opacity="0.6",h.style.color="var(--color-secondary)"),(i==null?void 0:i.hadIssue)&&!r&&(h.style.color="var(--color-warning)",h.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"),(i==null?void 0:i.wasOutOfClass)&&!r&&(h.style.color="var(--color-strong-warning)",h.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود");const f=1e3,y=$=>{Mt=setTimeout(()=>{Xa(l,a),Mt=null},f)},g=()=>{Mt&&(clearTimeout(Mt),Mt=null)};h.addEventListener("mousedown",y),h.addEventListener("mouseup",g),h.addEventListener("mouseout",g),h.addEventListener("touchstart",y),h.addEventListener("touchmove",g),h.addEventListener("touchend",g),h.addEventListener("touchcancel",g);const w=document.createElement("button");if(w.className="btn-icon",w.innerHTML="˄",w.title="برنده بعدی",w.classList.toggle("is-disabled",!v||Qe>=J.winnerHistory.length-1),w.addEventListener("click",()=>{w.classList.contains("is-disabled")?(w.classList.add("shake-animation"),setTimeout(()=>w.classList.remove("shake-animation"),200)):(mt(Qe+1),Pe())}),m.appendChild(w),m.appendChild(h),l.onboardingSession===J.sessionNumber){const $=document.createElement("div");$.className="new-student-badge",$.textContent="دانش آموز جدید",m.appendChild($)}m.appendChild(b),e.appendChild(m),tt.disabled=v&&!w.classList.contains("is-disabled");const k=document.createElement("div");k.className="status-button-container";const I=document.createElement("button");I.textContent="غایب",I.classList.add("status-button","absent-btn"),r&&I.classList.add("active");const S=document.createElement("button");S.textContent="مشکل",S.classList.add("status-button","issue-btn"),i!=null&&i.hadIssue&&S.classList.add("active");const A=document.createElement("button");A.textContent="خروج",A.classList.add("status-button","exit-btn"),i!=null&&i.wasOutOfClass&&A.classList.add("active");const z=document.createElement("button");z.textContent="پروفایل",z.className="status-button profile-btn",J.isFinished?I.disabled=!0:I.addEventListener("click",()=>{const $=I.classList.contains("active");A.classList.contains("active")&&(A.classList.remove("active"),i.wasOutOfClass=!1,l.statusCounters.outOfClassCount=Math.max(0,(l.statusCounters.outOfClassCount||0)-1),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)),$?(I.classList.remove("active"),J.setAttendance(l.identity.studentId,"present"),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1),h.style.textDecoration="",h.style.opacity="",h.style.color=""):(S.classList.contains("active")&&(S.classList.remove("active"),i.hadIssue=!1,l.statusCounters.otherIssues=Math.max(0,l.statusCounters.otherIssues-1),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)),I.classList.add("active"),J.setAttendance(l.identity.studentId,"absent"),l.statusCounters.missedChances++,h.style.textDecoration="line-through",h.style.opacity="0.6",h.style.color="var(--color-secondary)",h.title=""),ze(),setTimeout(()=>Pe(l,a),0),le()}),J.isFinished?S.disabled=!0:S.addEventListener("click",()=>{const $=S.classList.contains("active");if(A.classList.contains("active")&&(A.classList.remove("active"),i.wasOutOfClass=!1,l.statusCounters.outOfClassCount=Math.max(0,(l.statusCounters.outOfClassCount||0)-1),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)),$){S.classList.remove("active"),i.hadIssue=!1;const te=Ge.name;l.categoryIssues[te]&&(l.categoryIssues[te]=Math.max(0,l.categoryIssues[te]-1)),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1),h.style.color="",h.title=""}else{I.classList.contains("active")&&(I.classList.remove("active"),J.setAttendance(l.identity.studentId,"present"),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)),S.classList.add("active"),i.hadIssue=!0;const te=Ge.name;l.categoryIssues[te]=(l.categoryIssues[te]||0)+1,l.statusCounters.missedChances++,h.style.textDecoration="",h.style.opacity="",h.style.color="var(--color-warning)",h.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"}ze(),setTimeout(()=>Pe(l,a),0),le()}),J.isFinished?A.disabled=!0:A.addEventListener("click",()=>{if(A.classList.contains("active"))A.classList.remove("active"),i.wasOutOfClass=!1,h.style.color="",h.title="";else{if(I.classList.contains("active")&&(I.classList.remove("active"),J.setAttendance(l.identity.studentId,"present"),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)),S.classList.contains("active")){S.classList.remove("active"),i.hadIssue=!1;const te=Ge.name;l.categoryIssues[te]&&(l.categoryIssues[te]=Math.max(0,l.categoryIssues[te]-1)),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)}A.classList.add("active"),i.wasOutOfClass=!0,h.style.textDecoration="",h.style.opacity="",h.style.color="var(--color-strong-warning)",h.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود"}ze(),setTimeout(()=>Pe(l,a),0),le()}),J.isFinished?z.disabled=!0:z.addEventListener("click",()=>{Me(l)}),k.appendChild(I),k.appendChild(A),k.appendChild(S),k.appendChild(z),e.appendChild(k);const H=document.createElement("div");H.className="student-details-container";const D=document.createElement("div");D.className="student-details-scores",D.innerHTML="<h4>آخرین نمرات</h4>";const G=document.createElement("ul");G.className="scores-list";const se=O.categories.filter($=>$.isGradedCategory&&!$.isDeleted);let E=!1;const M=l.logs.scores||{};se.forEach($=>{var Le;const te=$.name,N=te.toLowerCase(),T=document.createElement("li"),ae=document.createElement("span");ae.className="skill-name",ae.textContent=`${te}:`;const ee=document.createElement("span");ee.className="skill-scores";const X=(Le=M[N])==null?void 0:Le.filter(De=>!De.isDeleted);X&&X.length>0?(E=!0,ee.textContent=X.slice(-3).map(De=>De.value).join(",")):ee.textContent="none",T.appendChild(ae),T.appendChild(ee),G.appendChild(T)}),E||(G.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>'),D.appendChild(G),H.appendChild(D);const d=document.createElement("div");d.className="student-details-notes";const P=document.createElement("div");P.className="history-section-header";const de=document.createElement("h4");de.textContent="یادداشت‌ها";const j=document.createElement("button");j.className="btn-icon",j.innerHTML="📝",j.title="افزودن یادداشت جدید",J.isFinished?j.disabled=!0:j.addEventListener("click",()=>{Ce.value="",Ce.dispatchEvent(new Event("input",{bubbles:!0})),nt($=>{$&&(l.addNote($),le(),Pe(),Q("✅ یادداشت با موفقیت ثبت شد."))}),$e("add-note-modal"),Ce.focus()}),P.appendChild(de),P.appendChild(j),d.appendChild(P);const ue=document.createElement("ul");ue.className="notes-list",l.profile.notes&&l.profile.notes.length>0?[...l.profile.notes].sort((te,N)=>new Date(N.timestamp)-new Date(te.timestamp)).forEach(te=>{const N=document.createElement("li");N.dir=ps(te.content),N.textContent=te.content,ue.appendChild(N)}):ue.innerHTML='<div class="no-content-message">یادداشتی وجود ندارد.</div>',d.appendChild(ue),H.appendChild(d),e.appendChild(H)}function yi(s){s.addEventListener("input",()=>{const c=s.value,e=ps(c);s.setAttribute("dir",e)})}function Ma(){ks(null),Ht.innerHTML="",Kn.innerHTML="",Bt.classList.add("tooltip-container"),at.disabled=!0,et.disabled=!0,yt.disabled=!0,at.value="",et.value="",Dt.classList.add("disabled-wrapper"),tt.disabled=!0}function mn(){Ht.innerHTML="",O.categories.filter(e=>!e.isDeleted).forEach(e=>{const l=document.createElement("span");l.className="pill",l.textContent=e.name,l.dataset.categoryId=e.id,e.description&&(l.dataset.tooltip=e.description),J.isFinished?l.classList.add("disabled"):l.addEventListener("click",()=>{document.querySelectorAll("#category-selection-container .pill").forEach(t=>t.classList.remove("active")),l.classList.add("active"),Sn(e),ks(e),ts(e),Dt.classList.remove("disabled-wrapper"),tt.disabled=J.isFinished;const a=J.lastWinnerByCategory[e.name];if(a){const t=O.students.find(n=>n.identity.studentId===a);t&&Pe(t,e.name)}else{Kn.innerHTML="",In(null),mt(-1),tt.disabled=!1;const t=document.querySelector(".current-winner-highlight");t&&t.classList.remove("current-winner-highlight")}}),J.isFinished||l.addEventListener("contextmenu",a=>{Qt(a,[{label:"تغییر نام",icon:"✏️",action:()=>{Yn((n,i)=>{const r=Rs(O,e,n);r.success?(e.isGradedCategory=i,le(),we(O.info.name,`نام دسته‌بندی «${e.name}» به «${n}» تغییر یافت.`),mn(),ze(),Q(`✅ نام دسته‌بندی به «${n}» تغییر یافت.`)):Q(`⚠️ ${r.message}`)},{title:"ویرایش دسته‌بندی",initialName:e.name,initialIsGraded:e.isGradedCategory,saveButtonText:"ذخیره تغییرات"})}},{label:"حذف دسته‌بندی",icon:"🗑️",className:"danger",action:()=>{Be(`آیا از انتقال دسته‌بندی «${e.name}» به سطل زباله مطمئن هستید؟`,()=>{const n={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${e.name}» از کلاس «${O.info.name}»`,restoreData:{categoryId:e.id,classId:O.info.scheduleCode}};pe.unshift(n),pe.length>50&&pe.pop();const i=e.name.toLowerCase();if(O.students.forEach(r=>{r.logs.scores&&r.logs.scores[i]&&r.logs.scores[i].forEach(m=>{m.isDeleted=!0})}),Ge&&Ge.id===e.id){Sn(null),Kn.innerHTML="",ts(null),Dt.classList.add("disabled-wrapper"),tt.disabled=!0;const r=document.querySelector(".current-winner-highlight");r&&r.classList.remove("current-winner-highlight")}e.isDeleted=!0,we(O.info.name,`دسته‌بندی «${e.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),le(),mn(),ze(),Q(`✅ دسته‌بندی «${e.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}}])}),Ht.appendChild(l)});const c=document.createElement("span");c.className="pill add-category-pill",c.textContent="+",c.title="افزودن دسته‌بندی جدید",J.isFinished?c.classList.add("disabled"):c.addEventListener("click",()=>{Yn((e,l)=>{if(O.categories.find(n=>n.name.toLowerCase()===e.toLowerCase()&&!n.isDeleted)){Q("⚠️ این دسته‌بندی از قبل وجود دارد.");return}const t=new ct(e,"",l);O.categories.push(t),le(),we(O.info.name,`دسته‌بندی جدید «${e}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),mn(),Q(`✅ دسته‌بندی «${e}» اضافه شد.`)})}),Ht.appendChild(c)}function $a(){if(J.lastUsedCategoryId){if(J.isFinished)return;const s=Ht.querySelector(`.pill[data-category-id="${J.lastUsedCategoryId}"]`);s&&s.click()}J.winnerHistory&&J.winnerHistory.length>0&&(mt(J.winnerHistory.length-1),Pe())}function ks(s){s?tt.textContent=`نفر بعدی در ${s.name}`:tt.textContent="نفر بعدی"}function ts(s){if(J.isFinished){at.disabled=!0,et.disabled=!0,yt.disabled=!0,Bt.setAttribute("title","جلسه خاتمه یافته است");return}s&&s.isGradedCategory?(at.disabled=!1,et.disabled=!1,yt.disabled=!1,Bt.removeAttribute("title")):(at.disabled=!0,et.disabled=!0,yt.disabled=!0,s?Bt.setAttribute("title","برای این دسته‌بندی قابلیت نمره دهی تعریف نشده است"):Bt.setAttribute("title","ابتدا یک دسته‌بندی را انتخاب کنید"))}function Me(s){Ve(s);const c=document.getElementById("student-profile-modal"),e=document.getElementById("modal-profile-student-name"),l=document.getElementById("modal-profile-content-container"),a=document.getElementById("modal-profile-close-btn");!c||!e||!l||!a||(e.textContent=`پروفایل: ${s.identity.name}`,e.style.cursor="pointer",e.onclick=()=>{const t=_e,n=O;ke(()=>{Cs(t,n)})},l.innerHTML="",Fa(l),bi(l),a.onclick=()=>ke(),$e("student-profile-modal"))}function Fa(s){if(!_e||!O)return;const c=document.createElement("div");c.className="scoring-section",c.innerHTML=`
        <h3>ثبت نمره جدید</h3>
        <div id="modal-graded-pills" class="category-pills"></div>
        <div class="input-group centered-input-group" style="margin-top: 15px;">
            <input type="number" id="modal-new-score-value" placeholder="نمره (مثلا: 85)">
        </div>
        <textarea id="modal-new-score-comment" placeholder="توضیحات این نمره (اختیاری)..." style="margin-top: 10px;"></textarea>
        <button id="modal-add-score-btn" class="btn-success" style="width: 100%; margin-top: 10px;">ثبت نمره</button>
    `;const e=c.querySelector("#modal-graded-pills");xe(O.categories).filter(t=>t.isGradedCategory).forEach(t=>{const n=document.createElement("span");n.className="pill",n.textContent=t.name,n.dataset.skillName=t.name,n.addEventListener("click",()=>{e.querySelectorAll(".pill").forEach(i=>i.classList.remove("active")),n.classList.add("active")}),e.appendChild(n)}),c.querySelector("#modal-add-score-btn").addEventListener("click",()=>{const t=e.querySelector(".pill.active");if(!t){Q("⚠️لطفاً یک مهارت را برای نمره‌دهی انتخاب کنید.");return}const n=t.dataset.skillName,i=c.querySelector("#modal-new-score-value"),r=c.querySelector("#modal-new-score-comment"),m=i.value,b=r.value.trim();if(!m){Q("لطفاً مقدار نمره را وارد کنید.");return}_e.addScore(n,parseFloat(m),b),le(),we(O.info.name,`نمره ${m} در ${n} برای «${_e.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:_e.identity.studentId}),ze(),Pe(),i.value="",r.value="";const v=document.getElementById("modal-profile-content-container"),h=v.querySelector(".history-section");h&&h.remove(),bi(v),Q(`✅ نمره برای مهارت ${n} با موفقیت ثبت شد.`)}),s.appendChild(c)}function bi(s){if(!_e)return;const c=document.createElement("div");c.className="history-section";const e=document.createElement("div");e.className="history-section-header";const l=document.createElement("h3");l.textContent="سوابق دانش‌آموز";const a=document.createElement("button");a.className="btn-icon",a.title="افزودن یادداشت جدید",a.innerHTML="📝",a.addEventListener("click",()=>{const t=_e;Ce.value="",Ce.dispatchEvent(new Event("input",{bubbles:!0})),nt(n=>{n&&(t.addNote(n),le(),we(O.info.name,`یادداشت جدیدی برای دانش‌آموز «${t.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:t.identity.studentId}),Pe(),Q("✅ یادداشت با موفقیت ثبت شد.")),Me(t)}),ke(()=>{$e("add-note-modal"),Ce.focus()})}),e.appendChild(l),e.appendChild(a),c.appendChild(e),Pa(c),vi(c),Ci(c),s.appendChild(c)}function Pa(s){if(!_e)return;const c=_e,e=O.sessions.reduce((u,p)=>{const f=p.studentRecords[c.identity.studentId];return u+(f&&f.attendance==="absent"?1:0)},0),l=Object.values(c.categoryIssues||{}).reduce((u,p)=>u+p,0),a=document.createElement("div");a.className="stats-summary-box",a.innerHTML=`
        <p><strong>کل انتخاب:</strong> ${c.statusCounters.totalSelections}</p>
        <p><strong>غیبت:</strong> ${e}</p>
        <p><strong>فرصت از دست رفته:</strong> ${c.statusCounters.missedChances||0}</p>
        <p><strong>مشکل:</strong> ${l}</p>
    `,s.appendChild(a),a.querySelector("p:nth-child(1)");const t=a.querySelector("p:nth-child(4)"),n=xe(O.categories),i=document.createElement("div");if(i.className="stats-breakdown",n.length>0){n.forEach(p=>{var w;const f=p.name,y=((w=c.categoryCounts)==null?void 0:w[f])||0,g=document.createElement("p");g.className="stats-breakdown-item",g.innerHTML=`<strong>${f}:</strong> ${y}`,i.appendChild(g)});const u=a.querySelector("p:first-child");u&&(u.classList.add("collapsible-toggle"),u.onclick=()=>{i.classList.toggle("open"),u.classList.toggle("open")},u.after(i))}const r=document.createElement("div");r.className="stats-breakdown",n.length>0&&(n.forEach(u=>{var g;const p=u.name,f=((g=c.categoryIssues)==null?void 0:g[p])||0,y=document.createElement("p");y.className="stats-breakdown-item",y.innerHTML=`<strong>${p}:</strong> ${f}`,r.appendChild(y)}),t&&(t.classList.add("collapsible-toggle"),t.onclick=()=>{r.classList.toggle("open"),t.classList.toggle("open")},a.appendChild(r)));const m=document.createElement("p"),b=document.createElement("strong");b.textContent="تکالیف ناقص:";const v=document.createElement("span");v.style.marginRight="5px";const h=Xe(O);fn(c,h,v,{includePrefix:!1}),m.appendChild(b),m.appendChild(v),a.appendChild(m)}function vi(s){if(!_e)return;const c=_e,e=document.createElement("h4");e.textContent="تاریخچه نمرات:",e.style.marginTop="20px";const l=document.createElement("ul");l.className="list-container";const a=Object.values(c.logs.scores||{}).flat().filter(t=>!t.isDeleted).sort((t,n)=>new Date(n.timestamp)-new Date(t.timestamp));a.length===0?l.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>':a.forEach(t=>{const n=document.createElement("li");n.className="score-history-item";const i=document.createElement("div");i.className="item-content";const r=document.createElement("div");r.className="score-info";const m=document.createElement("span");m.className="score-skill-badge",m.textContent=t.skill;const b=document.createElement("span");b.className="score-value",b.textContent=`نمره: ${t.value}`;const v=document.createElement("span");if(v.className="score-date",v.textContent=new Date(t.timestamp).toLocaleDateString("fa-IR"),r.appendChild(m),r.appendChild(b),r.appendChild(v),i.appendChild(r),t.comment){const u=document.createElement("p");u.className="score-comment",u.innerHTML=Js(t.comment),u.addEventListener("click",()=>{Ce.value=t.comment,Ce.dispatchEvent(new Event("input",{bubbles:!0})),nt(p=>{t.comment=p,le(),we(O.info.name,`توضیحات نمره ${t.value} (${t.skill}) برای دانش‌آموز «${c.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:c.identity.studentId}),Me(c),Q("✅ توضیحات نمره با موفقیت ویرایش شد.")}),ke(()=>{$e("add-note-modal"),Ce.focus()})}),i.appendChild(u)}const h=document.createElement("button");h.className="btn-icon delete-item-btn",h.innerHTML="🗑️",h.title="حذف این نمره",h.addEventListener("click",()=>{ke(()=>{Be(`آیا از انتقال نمره ${t.value} در مهارت «${t.skill}» به سطل زباله مطمئن هستید؟`,()=>{const u={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"score",description:`نمره ${t.value} (${t.skill}) برای «${c.identity.name}»`,restoreData:{scoreId:t.id,skill:t.skill,studentId:c.identity.studentId,classId:O.info.scheduleCode}};pe.unshift(u),pe.length>50&&pe.pop(),t.isDeleted=!0,le(),we(O.info.name,`نمره ${t.value} (${t.skill}) دانش‌آموز «${c.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),Me(c),Q("✅ نمره به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{Me(c)}})})}),n.appendChild(i),n.appendChild(h),l.appendChild(n)}),s.appendChild(e),s.appendChild(l)}function Ci(s){if(!_e)return;const c=document.createElement("h4");c.textContent="تاریخچه یادداشت‌ها:",c.style.marginTop="20px";const e=document.createElement("ul");e.className="list-container",!_e.profile.notes||_e.profile.notes.length===0?e.innerHTML='<div class="no-content-message">هنوز یادداشتی ثبت نشده است.</div>':[..._e.profile.notes].filter(a=>!a.isDeleted).sort((a,t)=>new Date(t.timestamp)-new Date(a.timestamp)).forEach(a=>{const t=document.createElement("li");t.className="note-history-item";const n=document.createElement("div");n.className="item-content";const i=document.createElement("div");i.className="note-info";const r=document.createElement("span");r.className="note-date",r.textContent=new Date(a.timestamp).toLocaleDateString("fa-IR");const m=document.createElement("button");m.className="btn-icon delete-item-btn",m.innerHTML="🗑️",m.title="حذف این یادداشت",m.addEventListener("click",()=>{const v=_e;ke(()=>{Be("آیا از انتقال این یادداشت به سطل زباله مطمئن هستید؟",()=>{const h={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"note",description:`یادداشت برای دانش‌آموز «${v.identity.name}»`,restoreData:{noteId:a.id,studentId:v.identity.studentId,classId:O.info.scheduleCode}};pe.unshift(h),pe.length>50&&pe.pop(),a.isDeleted=!0,we(O.info.name,`یادداشت دانش‌آموز «${v.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),le(),Me(v),Q("✅ یادداشت به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{Me(v)}})})}),i.appendChild(r),i.appendChild(m);const b=document.createElement("p");b.className="note-content",b.innerHTML=Js(a.content),b.addEventListener("click",()=>{const v=_e;Ce.value=a.content,Ce.dispatchEvent(new Event("input",{bubbles:!0})),nt(h=>{a.content=h,le(),we(O.info.name,`یادداشت دانش‌آموز «${v.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:v.identity.studentId}),Me(v),Q("✅یادداشت با موفقیت ویرایش شد.")}),ke(()=>{$e("add-note-modal"),Ce.focus()})}),n.appendChild(i),n.appendChild(b),t.appendChild(n),e.appendChild(t)}),s.appendChild(c),s.appendChild(e)}function wi(s){jn.innerHTML="",s.forEach((c,e)=>{const l=document.createElement("option");l.value=e,l.textContent=c.trim(),jn.appendChild(l)})}function ns(){Hn.innerHTML="",is.forEach(s=>{const c=document.createElement("li");c.className="preview-item";const e=document.createElement("input");e.type="checkbox",e.checked=!0,e.dataset.name=s;const l=document.createElement("label");l.textContent=s,c.appendChild(e),c.appendChild(l),Hn.appendChild(c)})}function Wa(s){const c=document.createElement("div");c.className="list-item-buttons";const e=document.createElement("button");return e.className="btn-icon",e.innerHTML="📝",e.title="افزودن/ویرایش یادداشت کلاس",e.style.borderBottom="solid",s.note||(e.style.opacity="0.5",e.style.borderBottom="none"),e.addEventListener("click",l=>{l.stopPropagation(),_s(s)}),c.appendChild(e),c}function Ua(s){const c=document.createElement("div");c.style.flexGrow="1",c.style.display="flex",c.style.flexDirection="column",c.style.alignItems="flex-start";const e=document.createElement("span");e.textContent=s.info.name,e.classList.add("class-name-display"),c.appendChild(e);const l=xe(s.students).length,a=xe(s.sessions).filter(r=>r.isFinished).length,t=document.createElement("div");t.classList.add("class-stats-row");const n=document.createElement("span");n.textContent=`${l} نفر`,n.classList.add("student-count-badge"),t.appendChild(n);const i=document.createElement("span");return i.textContent=`${a} جلسه`,i.classList.add("session-count-badge"),t.appendChild(i),c.appendChild(t),c.addEventListener("click",()=>{We(s),qe(null),Tn(O.liveSession),He(),he("session-page")}),c}function Ha(s){const c=document.createElement("li"),e=document.createElement("input");e.type="checkbox",e.className="mass-selection-checkbox",e.checked=st.includes(s.info.name),e.addEventListener("click",i=>{i.stopPropagation()}),e.addEventListener("change",()=>{const i=s.info.name;if(e.checked)st.includes(i)||st.push(i);else{const r=st.indexOf(i);r>-1&&st.splice(r,1)}}),c.appendChild(e);const l=Ua(s);c.appendChild(l);const a=document.createElement("div");if(a.className="list-item-badges",s.liveSession&&!s.liveSession.isCancelled&&!s.liveSession.isDeleted){const i=document.createElement("span");i.className="warning-badge",i.textContent="جلسه باز",a.appendChild(i),c.classList.add("has-unfinished-session")}const t=document.createElement("span");t.className=`type-badge ${s.info.type}`,t.textContent=s.info.type==="online"?"آنلاین":"حضوری",t.title="نوع کلاس",a.appendChild(t),c.appendChild(a);const n=Wa(s);return c.appendChild(n),c.addEventListener("contextmenu",i=>{const r={label:"پشتیبان‌گیری از این کلاس",icon:"📤",action:()=>{Xt([s.info.name])}},m=st.length;m>1&&st.includes(s.info.name)&&(r.label=`پشتیبان‌گیری از ${m} کلاس`,r.action=()=>{Xt(st),Pn([]),Ue()});const b=[{label:Nt.classList.contains("selection-mode-active")?"لغو انتخاب":"انتخاب چند کلاس",icon:"✔️",action:()=>{const v=Nt.classList.contains("selection-mode-active");Nt.classList.toggle("selection-mode-active"),v&&(Pn([]),Ue())}},r,{label:"تنظیمات کلاس",icon:"⚙️",action:()=>{Es(s)}},{label:"گزارش فعالیت‌ها",icon:"📋",action:()=>{pi(s.info.name)}},{label:"تغییر نام",icon:"✏️",action:()=>{const v=s.info.name,h=document.getElementById("add-note-modal-title");h.textContent="تغییر نام کلاس",Ce.value=v,Ce.rows=1,nt(u=>{const p=u.trim();if(p&&p!==v){const f=Os(v,p);f.success?(Ai(v,p),we(p,`نام کلاس از «${v}» به «${p}» تغییر یافت.`,{type:"VIEW_SESSIONS"}),le(),Ue(),Q(`✅نام کلاس به «${p}» تغییر یافت.`)):Q(f.message)}h.textContent="ثبت یادداشت جدید",Ce.rows=4}),$e("add-note-modal"),Ce.focus(),Ce.select()}},{label:"حذف کلاس",icon:"🗑️",className:"danger",action:()=>{Be(`آیا از انتقال کلاس «${s.info.name}» به سطل زباله مطمئن هستید؟`,()=>{const v={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"classroom",description:`کلاس «${s.info.name}»`,restoreData:{name:s.info.name}};pe.unshift(v),pe.length>50&&pe.pop(),s.isDeleted=!0,le(),Ue(),Q(`✅ کلاس «${s.info.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}];Qt(i,b)}),c}function An(){const s=document.getElementById("class-management-stats");if(!s)return;const c=Object.values(ce).filter(t=>!t.isDeleted),e=c.length,l=c.reduce((t,n)=>t+xe(n.students).length,0);let a="";Ze.lastBackupTimestamp&&(a=`
            <div class="stats-row backup-stat">
                <span>آخرین پشتیبان: <strong>${new Date(Ze.lastBackupTimestamp).toLocaleString("fa-IR",{year:"numeric",month:"numeric",day:"numeric",weekday:"long",hour:"2-digit",minute:"2-digit"})}</strong></span>
            </div>
        `),s.innerHTML=`
        <div class="stats-row main-stats">
            <span>کل کلاس‌ها: <strong>${e}</strong></span>
            <span>|</span>
            <span>کل دانش‌آموزان: <strong>${l}</strong></span>
        </div>
        ${a} 
    `}function Ue(){An(),Nt.innerHTML="",Object.values(ce).sort((c,e)=>new Date(c.info.creationDate)-new Date(e.info.creationDate)).forEach(c=>{if(c.isDeleted)return;const e=Ha(c);Nt.appendChild(e)})}function lt(){Wn.innerHTML="",O&&xe(O.students).forEach(s=>{const c=document.createElement("li"),e=document.createElement("span");e.textContent=s.identity.name,e.style.flexGrow="1",e.className="student-name-link",e.addEventListener("click",()=>{Me(s)}),c.appendChild(e),c.addEventListener("contextmenu",l=>{Qt(l,[{label:"تغییر نام",icon:"✏️",action:()=>{Cs(s,O)}},{label:"انتقال دانش‌آموز",icon:"➡️",action:()=>{mi(s,O)}},{label:"حذف دانش‌آموز",icon:"🗑️",className:"danger",action:()=>{Be(`آیا از انتقال دانش‌آموز «${s.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const t={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${s.identity.name}» از کلاس «${O.info.name}»`,restoreData:{studentId:s.identity.studentId,classId:O.info.scheduleCode}};pe.unshift(t),pe.length>50&&pe.pop(),s.isDeleted=!0,we(O.info.name,`دانش‌آموز «${s.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),le(),lt(),Q(`✅ دانش‌آموز «${s.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}])}),Wn.appendChild(c)})}function Ot(){if(Un.innerHTML="",!O)return;O.categories.filter(c=>!c.isDeleted).forEach(c=>{const e=document.createElement("li"),l=document.createElement("div");l.className="name-and-badge-container";const a=document.createElement("span");if(a.textContent=c.name,l.appendChild(a),c.isGradedCategory){const n=document.createElement("span");n.className="category-badge",n.textContent="قابل نمره‌دهی",l.appendChild(n)}const t=document.createElement("button");t.className="btn-icon",t.innerHTML="🗑️",t.style.color="var(--color-warning)",t.addEventListener("click",()=>{Be(`آیا از انتقال دسته‌بندی «${c.name}» به سطل زباله مطمئن هستید؟`,()=>{const n={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${c.name}» از کلاس «${O.info.name}»`,restoreData:{categoryId:c.id,classId:O.info.scheduleCode}};pe.unshift(n),pe.length>50&&pe.pop(),c.isDeleted=!0,we(O.info.name,`دسته‌بندی «${c.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),le(),Ot(),Q(`✅ دسته‌بندی «${c.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}),e.appendChild(l),e.appendChild(t),Un.appendChild(e)})}function Gt(s){document.querySelectorAll(".page").forEach(e=>{e.classList.remove("active")});const c=document.getElementById(s);c&&c.classList.add("active"),s==="class-management-page"?(We(null),qe(null),Ve(null),Ue(),Zn.style.display="flex"):Zn.style.display="none",gi()}function he(s,c={}){const{tab:e}=c,l={pageId:s,currentClassName:O?O.info.name:null,selectedSessionNumber:J?J.sessionNumber:null,selectedStudentId:_e?_e.identity.studentId:null};let a=`#${s}`;const t=new URLSearchParams(window.location.hash.split("?")[1]||"");O?t.set("class",O.info.name):t.delete("class"),J?t.set("session",J.sessionNumber):t.delete("session"),_e?t.set("student",_e.identity.studentId):t.delete("student"),s==="session-dashboard-page"&&e?t.set("tab",e):s!=="session-dashboard-page"&&t.delete("tab");const n=t.toString();n&&(a+=`?${n}`),window.location.hash!==a&&history.pushState(l,"",a),Gt(s)}function ja(s,c){const e=document.createElement("div");e.className="list-item-buttons";const l=document.createElement("button");if(l.className="btn-icon",l.innerHTML="📝",l.title="افزودن/ویرایش یادداشت جلسه",l.style.borderBottom="solid",s.note||(l.style.opacity="0.5",l.style.borderBottom="none"),l.addEventListener("click",a=>{a.stopPropagation(),Ce.value=s.note||"",nt(t=>{s.note=t,le(),we(O.info.name,`یادداشت جلسه ${c} ذخیره شد.`,{type:"VIEW_SESSIONS"}),He(),Q("✅یادداشت جلسه ذخیره شد.")}),$e("add-note-modal"),Ce.focus()}),e.appendChild(l),!s.isFinished&&!s.isCancelled){const a=document.createElement("button");a.className="btn-icon",a.innerHTML="✅",a.title="خاتمه جلسه",a.addEventListener("click",t=>{t.stopPropagation(),Be(`جلسه شماره ${c} خاتمه پیدا خواهد کرد!`,()=>{O.endSpecificSession(s.sessionNumber),le(),we(O.info.name,`جلسه ${c} خاتمه یافت.`,{type:"VIEW_SESSIONS"}),He(),Be("جلسه با موفقیت خاتمه یافت. آیا مایل به ایجاد فایل پشتیبان هستید؟",()=>{if(it){Q("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است.");return}Xt(),Q("✅فایل پشتیبان با موفقیت ایجاد شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}),e.appendChild(a)}return e}function Za(s,c){const e=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="flex-start",e.style.flexGrow="1";const l=new Date(s.startTime).toLocaleDateString("fa-IR"),a=document.createElement("span"),t=document.createElement("div");t.style.display="flex",t.style.gap="5px",t.style.marginTop="5px";const n=new Date(s.startTime).toLocaleDateString("fa-IR",{weekday:"long"}),i=document.createElement("span");if(i.className="type-badge day-badge",i.textContent=n,t.appendChild(i),s.isCancelled){a.textContent=`✅جلسه لغو شده - تاریخ: ${l}`,e.style.cursor="default";const r=document.createElement("span");r.className="type-badge cancelled-badge",r.textContent="لغو شده",t.appendChild(r)}else a.textContent=`جلسه ${c} - تاریخ: ${l}`,e.style.cursor="pointer",e.addEventListener("click",()=>{qe(s),Kt()});if(e.appendChild(a),s.isFinished){const r=document.createElement("span");r.className="type-badge",r.textContent="خاتمه یافته",r.style.backgroundColor="var(--color-secondary)",t.appendChild(r)}if(s.isMakeup){const r=document.createElement("span");r.className="type-badge",r.textContent="جبرانی",r.style.backgroundColor="var(--color-warning)",r.style.color="var(--color-text-dark)",t.appendChild(r)}return e.appendChild(t),e}function Ga(s,c){const e=document.createElement("li"),l=c.get(s.sessionNumber),a=Za(s,l);e.appendChild(a);const t=ja(s,l);return e.appendChild(t),e.addEventListener("contextmenu",n=>{const i=[{label:s.isCancelled?"بازگردانی جلسه":"لغو جلسه",icon:"❌",action:()=>{const r=s.isCancelled?"بازگردانی جلسه":"لغو جلسه",m=s.isCancelled?"آیا از بازگردانی این جلسه مطمئن هستید؟":"آیا از لغو این جلسه مطمئن هستید؟ جلسه لغو شده در آمار تاثیری ندارد اما قابل بازگردانی است.";Be(m,()=>{s.isCancelled=!s.isCancelled;const b=s.isCancelled?`جلسه ${l} لغو شد.`:`جلسه لغو شده (تاریخ: ${new Date(s.startTime).toLocaleDateString("fa-IR")}) بازگردانی شد.`;we(O.info.name,b,{type:"VIEW_SESSIONS"}),le(),He(),Q(s.isCancelled?"✅جلسه لغو شد.":"✅جلسه بازگردانی شد.")},{confirmText:r,confirmClass:"btn-warning"})}},{label:"تغییر وضعیت جبرانی",icon:"🔄",action:()=>{O.markAsMakeup(s.sessionNumber),le();const r=s.isMakeup?`جلسه ${l} به عنوان جبرانی علامت‌گذاری شد.`:`جلسه ${l} از حالت جبرانی خارج شد.`;we(O.info.name,r,{type:"VIEW_SESSIONS"}),He()}},{label:"حذف جلسه",icon:"🗑️",className:"danger",action:()=>{const r=s.isCancelled?"لغو شده":l;Be(`آیا از انتقال جلسه ${r} به سطل زباله مطمئن هستید؟`,()=>{const m={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"session",description:`جلسه ${r} از کلاس «${O.info.name}»`,restoreData:{sessionNumber:s.sessionNumber,classId:O.info.scheduleCode}};pe.unshift(m),pe.length>50&&pe.pop(),s.isDeleted=!0,we(O.info.name,`جلسه ${r} به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),le(),He(),Q(`✅ جلسه ${r} به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}];Qt(n,i)}),e}function He(){const s=document.getElementById("session-list");if(!O)return;if(s.innerHTML="",O.sessions.length===0){s.innerHTML="<li>هنوز جلسه‌ای شروع نشده است.</li>";return}const c=Xe(O);[...xe(O.sessions)].reverse().forEach(l=>{const a=Ga(l,c);s.appendChild(a)})}function Pt(s){if(ut.innerHTML="",s.length>0)s.forEach(c=>{const e=document.createElement("div");e.textContent=c.identity.name,e.addEventListener("click",()=>{Me(c),ut.style.display="none",Vn.value=""}),ut.appendChild(e)}),ut.style.display="block";else if(Vn.value.trim()!==""){const c=document.createElement("div");c.className="no-results",c.textContent="پیدا نشد",ut.appendChild(c),ut.style.display="block"}else ut.style.display="none"}function hn(s){if(ot.innerHTML="",s.length>0)s.forEach(c=>{const e=document.createElement("div");e.className="global-search-result";const l=document.createElement("span");l.className="student-name",l.textContent=c.student.identity.name;const a=document.createElement("span");a.className="class-name",a.textContent=`کلاس: ${c.classroom.info.name}`,e.addEventListener("click",()=>{We(c.classroom),Me(c.student),ot.style.display="none",dn.value=""}),a.addEventListener("click",t=>{t.stopPropagation(),We(c.classroom),qe(null),Tn(c.classroom.liveSession),He(),he("session-page"),ot.style.display="none",dn.value=""}),e.appendChild(l),e.appendChild(a),ot.appendChild(e)}),ot.style.display="block";else if(dn.value.trim()!==""){const c=document.createElement("div");c.className="no-results",c.textContent="پیدا نشد",ot.appendChild(c),ot.style.display="block"}else ot.style.display="none"}function Yt(){const s=document.getElementById("trashed-items-list");if(s.innerHTML="",pe.length===0){s.innerHTML='<li style="text-align: center; padding: 20px;">سطل زباله خالی است.</li>';return}pe.forEach((c,e)=>{const l=document.createElement("li"),a=document.createElement("span");a.textContent=c.description,a.style.flexGrow="1";const t=document.createElement("div");t.className="list-item-buttons";const n=document.createElement("button");n.className="btn-icon",n.innerHTML="🔄",n.title="بازیابی",n.addEventListener("click",()=>{var v;let r=!1,m=null;const b=c.restoreData;switch(c.type){case"classroom":{const h=ce[b.name];h&&!h.isDeleted?m=`کلاسی با نام «${b.name}» از قبل فعال است.`:h&&h.isDeleted&&(h.isDeleted=!1,r=!0);break}case"student":{const h=Object.values(ce).find(p=>p.info.scheduleCode===b.classId),u=h==null?void 0:h.students.find(p=>p.identity.studentId===b.studentId);u&&(u.isDeleted=!1,r=!0);break}case"session":{const h=Object.values(ce).find(p=>p.info.scheduleCode===b.classId),u=h==null?void 0:h.sessions.find(p=>p.sessionNumber===b.sessionNumber);u&&(u.isDeleted=!1,r=!0);break}case"category":{const h=Object.values(ce).find(p=>p.info.scheduleCode===b.classId),u=h==null?void 0:h.categories.find(p=>p.id===b.categoryId);u&&(u.isDeleted=!1,r=!0);break}case"score":{const h=Object.values(ce).find(f=>f.info.scheduleCode===b.classId),u=h==null?void 0:h.students.find(f=>f.identity.studentId===b.studentId),p=(v=u==null?void 0:u.logs.scores[b.skill.toLowerCase()])==null?void 0:v.find(f=>f.id===b.scoreId);p&&(p.isDeleted=!1,r=!0);break}case"note":{const h=Object.values(ce).find(f=>f.info.scheduleCode===b.classId),u=h==null?void 0:h.students.find(f=>f.identity.studentId===b.studentId),p=u==null?void 0:u.profile.notes.find(f=>f.id===b.noteId);p&&(p.isDeleted=!1,r=!0);break}}r?(pe.splice(e,1),le(),Yt(),c.type==="classroom"&&Ue(),Q("✅ آیتم با موفقیت بازیابی شد.")):Q(m?`⚠️ ${m}`:"⚠️ آیتم اصلی برای بازیابی یافت نشد.")});const i=document.createElement("button");i.className="btn-icon",i.innerHTML="🔥",i.title="حذف دائمی",i.addEventListener("click",()=>{Be("آیا از حذف دائمی این آیتم مطمئن هستید؟ این عمل غیرقابل بازgشت است.",()=>{const r=c.restoreData,m=v=>Object.values(ce).find(h=>h.info.scheduleCode===v);let b;switch(c.type){case"classroom":delete ce[r.name];break;case"student":b=m(r.classId),En({identity:{studentId:r.studentId}},b);break;case"session":b=m(r.classId),b&&$s(b.info.name,r.sessionNumber);break;case"category":b=m(r.classId),b&&Fs(b.info.name,r.categoryId);break;case"score":b=m(r.classId),b&&Ps(b.info.name,r.studentId,r.skill,r.scoreId);break;case"note":b=m(r.classId),b&&Ws(b.info.name,r.studentId,r.noteId);break}pe.splice(e,1),le(),Yt(),Q("✅ آیتم برای همیشه حذف شد.")},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),t.appendChild(n),t.appendChild(i),l.appendChild(a),l.appendChild(t),s.appendChild(l)})}function qa(){const s=document.getElementById("absentees-summary-container");s&&(s.innerHTML=`
        <div id="absentees-summary-box" class="absentees-summary">
            <div class="absentees-summary-header">
                <h4>لیست غایبین جلسه شماره <span id="absentee-summary-session-number"></span></h4>
                <button id="copy-absentees-btn" class="btn-icon" title="کپی لیست غایبین">📋</button>
            </div>
            <div id="absentees-summary-list" class="summary-list"></div>
        </div>
    `)}function _i(){const s=document.getElementById("absentees-summary-box"),c=document.getElementById("absentees-summary-list"),e=document.getElementById("absentee-summary-session-number");if(!s||!c||!e){console.error("Could not find all absentee summary elements.");return}if(!O||!J){s.classList.remove("visible");return}const l=xe(O.students).filter(t=>{const n=J.studentRecords[t.identity.studentId];return n&&n.attendance==="absent"}),a=Xe(O);e.textContent=a.get(J.sessionNumber),l.length>0?s.classList.add("visible"):s.classList.remove("visible"),c.innerHTML="",l.forEach(t=>{const i=(m=>O.sessions.reduce((b,v)=>{if(v.isDeleted||v.isCancelled)return b;const h=v.studentRecords[m.identity.studentId];return b+(h&&h.attendance==="absent"?1:0)},0))(t),r=document.createElement("span");r.className="summary-name",r.textContent=`${t.identity.name} (غیبت: ${i})`,r.addEventListener("click",()=>{r.classList.add("fading-out"),setTimeout(()=>{J.setAttendance(t.identity.studentId,"present"),le(),wt()},200)}),c.appendChild(r)})}function Va(){const s=document.getElementById("copy-absentees-btn");if(!s){console.error("Could not find the copy absentees button to attach listener.");return}s.addEventListener("click",()=>{if(!O||!J)return;const c=xe(O.students).filter(a=>{const t=J.studentRecords[a.identity.studentId];return t&&t.attendance==="absent"});if(c.length===0){Q("⚠️لیست غایبین خالی است.");return}const e=a=>O.sessions.reduce((t,n)=>{if(n.isDeleted||n.isCancelled)return t;const i=n.studentRecords[a.identity.studentId];return t+(i&&i.attendance==="absent"?1:0)},0);let l=`لیست غایبین جلسه شماره ${za()}:

`;c.forEach(a=>{const t=e(a);l+=`- ${a.identity.name} (تعداد غیبت‌ها: ${t})
`}),navigator.clipboard.writeText(l).then(()=>{Q("✅لیست غایبین با موفقیت کپی شد.")}).catch(a=>{console.error("Failed to copy text: ",a),Q("❌خطا در کپی کردن لیست.")})})}function pn(){const s=document.getElementById("demo-mode-banner");s&&(it?(s.classList.add("visible"),document.body.classList.add("demo-mode-active")):(s.classList.remove("visible"),document.body.classList.remove("demo-mode-active")))}const Ka=Object.freeze(Object.defineProperty({__proto__:null,_internalShowPage:Gt,addCategoryBtn:Xi,addClassBtn:Ri,addNoteModal:da,addScoreBtn:ga,addStudentBtn:Pi,appHeader:Zn,attendanceListUl:Ut,attendanceMassActionsContainer:un,attendancePage:Yi,attendancePane:At,attendanceSearchInput:pt,backToSessionsBtn:$i,backToStudentPageBtn:ma,backupDataBtn:aa,breadcrumbContainer:Lt,cancelImportBtn:Ki,cancelNoteBtn:fa,categoryListUl:Un,categoryModal:Ia,categoryModalCancelBtn:xa,categoryModalSaveBtn:ci,categoryModalTitle:oi,classListHeader:ea,classListUl:Nt,classManagementPage:Qs,classSaveNoteBtn:ua,closeActiveModal:ke,closeContextMenu:gt,closeNavBtn:sa,columnMappingPage:qi,columnSelectDropdown:jn,confirmColumnBtn:Vi,confirmModalCancelBtn:qn,confirmModalConfirmBtn:Ft,confirmModalMessage:si,contextMenu:bt,csvCancelBtn:ji,csvConfirmBtn:Hi,csvFileInput:Gi,csvPreviewList:Hn,csvPreviewPage:Ui,customConfirmModal:oa,displayWinner:Pe,finishAttendanceBtn:Qi,globalStudentSearchInput:dn,globalStudentSearchResultsDiv:ot,gradedCategoryPillsContainer:ha,hamburgerMenuBtn:ta,handleUndo:ui,importCsvBtn:Zi,initiateBackupProcess:Xt,isGradedCheckbox:va,massCommentAppendCheckbox:vs,massCommentBtn:Jn,massCommentCancelBtn:Na,massCommentContent:Zt,massCommentModal:La,massCommentModalTitle:Ba,massCommentSaveBtn:Ta,massCommentStudentCountMessage:li,newCategoryModalIsGradedCheckbox:bs,newCategoryModalNameInput:jt,newCategoryNameInput:Ji,newClassNameInput:Oi,newNoteContent:Ce,newScoreCommentTextarea:ri,newScoreValueInput:pa,newStudentNameInput:Fi,openContextMenu:Qt,openModal:$e,overlay:ia,pasteArea:ti,processMassHomeworkComment:Qn,processPasteBtn:Wi,profileScoresListUl:ba,profileStatsSummaryDiv:ya,quickGradeFormWrapper:Bt,quickGradeSubmitBtn:yt,quickNoteTextarea:et,quickScoreInput:at,renderAttendancePage:wt,renderBreadcrumbs:gi,renderClassList:Ue,renderClassManagementStats:An,renderColumnSelector:wi,renderGlobalSearchResults:hn,renderImportPreview:ns,renderLogModal:pi,renderMassCommentControls:ws,renderScoresHistory:vi,renderSearchResults:Pt,renderSessionDashboard:Kt,renderSessions:He,renderSettingsCategories:Ot,renderSettingsStudentList:lt,renderStudentNotes:Ci,renderStudentStatsList:ze,renderTrashPage:Yt,restoreDataBtn:ra,restoreFileInput:ni,secureConfirmCancelBtn:la,secureConfirmCode:ai,secureConfirmConfirmBtn:ln,secureConfirmInput:xt,secureConfirmMessage:ii,secureConfirmModal:ca,selectStudentBtn:tt,selectStudentBtnWrapper:Dt,sessionDashboardPage:Da,setAutoDirectionOnInput:yi,settingsClassNameHeader:ys,settingsPage:Mi,settingsStudentListUl:Wn,setupDashboardTabs:di,showCategoryModal:Yn,showClassNoteModal:_s,showCustomConfirm:Be,showMassCommentModal:hi,showMoveStudentModal:mi,showNotification:Q,showPage:he,showRenameStudentModal:Cs,showRestoreConfirmModal:Xn,showSecureConfirm:fi,showSettingsPage:Es,showStudentProfile:Me,showUndoToast:Aa,sideNavMenu:na,studentSearchInput:Vn,studentSearchResultsDiv:ut,studentStatsHeader:Gn,switchDashboardTab:Jt,trashedCategoriesList:Ea,trashedClassesList:Ca,trashedNotesList:ka,trashedScoresList:Sa,trashedSessionsList:_a,trashedStudentsList:wa,triggerFileDownload:es,undoBtn:zi,undoMessage:ei,undoToast:Bn,updateDemoModeBanner:pn},Symbol.toStringTag,{value:"Module"}));function Ja(){const s=window.location.hash;if(!s||s==="#")return!1;const[c,e]=s.split("?"),l=c.substring(1),a=new URLSearchParams(e),t=a.get("class"),n=parseInt(a.get("session"),10),i=a.get("student"),r=a.get("tab")||"selector";if(t&&ce[t])We(ce[t]),n&&O.getSession(n)&&qe(O.getSession(n)),i&&O.students.find(m=>m.identity.studentId===i)&&Ve(O.students.find(m=>m.identity.studentId===i));else return!1;switch(l){case"session-page":He(),he("session-page");break;case"session-dashboard-page":Kt(l==="attendance-page"?"attendance":r);break;case"settings-page":ys.textContent=`تنظیمات کلاس: ${O.info.name}`,lt(),Ot(),he("settings-page");break;case"student-profile-page":Kt(r),Me(_e);break;default:return!1}return!0}document.addEventListener("DOMContentLoaded",()=>{const{globalStudentSearchInput:s,newClassNameInput:c,addClassBtn:e,undoBtn:l,newStudentNameInput:a,addStudentBtn:t,pasteArea:n,processPasteBtn:i,csvPreviewList:r,csvConfirmBtn:m,csvCancelBtn:b,importCsvBtn:v,csvFileInput:h,columnSelectDropdown:u,confirmColumnBtn:p,cancelImportBtn:f,newCategoryNameInput:y,addCategoryBtn:g,selectStudentBtn:w,attendancePage:k,finishAttendanceBtn:I,classListHeader:S,studentStatsHeader:A,hamburgerMenuBtn:z,sideNavMenu:H,closeNavBtn:D,overlay:G,backupDataBtn:se,restoreDataBtn:E,restoreFileInput:M,confirmModalCancelBtn:d,confirmModalConfirmBtn:P,secureConfirmCancelBtn:de,secureConfirmConfirmBtn:j,newNoteContent:ue,classSaveNoteBtn:$,cancelNoteBtn:te,studentSearchInput:N,studentSearchResultsDiv:T,isGradedCheckbox:ae,categoryModalSaveBtn:ee,categoryModalCancelBtn:X,massCommentBtn:Le,massCommentCancelBtn:De,massCommentSaveBtn:ge,massCommentContent:be,massCommentAppendCheckbox:Ae,attendanceSearchInput:Te}=Ka,Ke=document.getElementById("trash-nav-btn");document.querySelector(".global-search-container .search-icon"),_n(),pn(),Ja()||(Ue(),he("class-management-page"));function o(L,Z){const q=document.querySelector(L);if(!q)return;const Y=q.querySelector(".search-icon"),ie=q.querySelector(".animated-search-input");!Y||!ie||(Y.addEventListener("mousedown",fe=>{fe.preventDefault()}),Y.addEventListener("click",()=>{q.classList.contains("search-active")||(q.classList.add("search-active"),ie.focus())}),ie.addEventListener("blur",()=>{setTimeout(()=>{q.classList.remove("search-active"),ie.value="",Z&&Z([])},150)}))}Te.addEventListener("input",()=>{const L=Te.value.toLowerCase().trim(),Z=Mn(L);Ut.querySelectorAll(".attendance-list-item").forEach(Y=>{const ie=Y.querySelector(".student-name");if(ie){const fe=ie.textContent,re=rt(fe.toLowerCase()),me=re.includes(rt(L)),ve=re.includes(rt(Z));me||ve?Y.style.display="flex":Y.style.display="none"}})}),X.addEventListener("click",()=>{ke(),Dn(null)}),ee.addEventListener("click",()=>{const L=jt.value.trim(),Z=bs.checked;typeof Cn=="function"&&Cn(L,Z)}),window.addEventListener("scroll",gt),document.addEventListener("click",L=>{bt.classList.contains("visible")&&!bt.contains(L.target)&&gt(),N.contains(L.target)||(T.style.display="none");const Z=L.target.closest(".log-action-link");if(Z&&Z.dataset.action)try{const q=JSON.parse(Z.dataset.action);ht(q)}catch(q){console.error("Could not parse log action:",q)}}),Dt.addEventListener("click",()=>{(Dt.classList.contains("disabled-wrapper")||tt.disabled)&&(tt.classList.add("shake-animation"),setTimeout(()=>{tt.classList.remove("shake-animation")},200))}),A.addEventListener("click",()=>{const L=new Date().getTime();L-os>500?cn(1):cn(bn+1),qs(L),bn===5&&(cn(0),Be("آیا از صفر کردن تمام شمارنده‌های دانش‌آموزان مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{Ms(),ze(),Q("تمام آمارها صفر شدند ✅.")},{confirmText:"بله",confirmClass:"btn-warning"}))}),S.addEventListener("click",()=>{const L=new Date().getTime();L-rs>500?on(1):on(yn+1),Gs(L),yn===5&&(on(0),Be("آیا از ساخت یک کلاس تستی تصادفی مطمئن هستید؟",()=>{function Z(){const q=`کلاس تستی ${Object.keys(ce).length+1}`,Y=new Fn({name:q,type:"online"});["علی رضایی","مریم حسینی","زهرا احمدی","رضا محمدی","فاطمه کریمی"].forEach(fe=>Y.addStudent(new an({name:fe}))),ce[q]=Y,le(),Ue()}Z(),Q("کلاس تستی با موفقیت ساخته شد ✅!")},{confirmText:"بساز",confirmClass:"btn-success"}))}),de.addEventListener("click",()=>{ke(),Vt(null)}),j.addEventListener("click",()=>{typeof vn=="function"&&vn(),ke(),Vt(null)}),d.addEventListener("click",()=>{ke(ls)}),P.addEventListener("click",()=>{ke(cs)}),w.addEventListener("click",()=>{if(at.value.trim()!==""||et.value.trim()!==""){Q("⚠️لطفاً ابتدا با دکمه «ثبت»، تغییرات را ذخیره کنید و یا نمره و یادداشت را پاک کنید.");return}if(!O||!J||!Ge)return;const L=O.selectNextWinner(Ge.name,J);if(L){const Z=J.studentRecords[L.identity.studentId];if(Z&&Z.attendance==="absent"&&L.statusCounters.missedChances++,Z&&Z.hadIssue){L.statusCounters.missedChances++;const Y=Ge.name;L.categoryIssues[Y]=(L.categoryIssues[Y]||0)+1}Z&&Z.wasOutOfClass&&(L.statusCounters.outOfClassCount=(L.statusCounters.outOfClassCount||0)+1,L.statusCounters.missedChances++);const q={winner:L,categoryName:Ge.name};J.winnerHistory.push(q),J.winnerHistory.length>10&&J.winnerHistory.shift(),mt(J.winnerHistory.length-1),J.lastUsedCategoryId=Ge.id,J.lastSelectedWinnerId=L.identity.studentId,ze(),setTimeout(()=>Pe(),0),le()}else Q("❌دانش‌آموز واجد شرایطی برای انتخاب یافت نشد.")}),g.addEventListener("click",()=>{if(!O)return;const L=y.value.trim(),Z=ae.checked;if(!L){alert("⚠️لطفاً نام دسته‌بندی را وارد کنید.");return}const q=O.categories.find(ie=>ie.name.toLowerCase()===L.toLowerCase());if(q)if(q.isDeleted){const ie=O.categories.findIndex(fe=>fe===q);ie>-1&&O.categories.splice(ie,1)}else{alert("⚠️این دسته‌بندی از قبل وجود دارد.");return}const Y=new ct(L,"",Z);O.categories.push(Y),le(),we(O.info.name,`دسته‌بندی جدید «${L}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),Ot(),y.value="",ae.checked=!1}),y.addEventListener("keyup",L=>{L.key==="Enter"&&g.click()}),p.addEventListener("click",()=>{if(!gn){alert("❌خطایی رخ داده است. لطفاً فایل را دوباره انتخاب کنید."),he("settings-page");return}const L=parseInt(u.value,10),Y=gn.split(`
`).slice(1).map(ie=>{var re;return(re=ie.split(",")[L])==null?void 0:re.trim()}).filter(ie=>ie&&ie.length>0);Y.length>0?($t(Y),ns(),he("csv-preview-page")):alert("هیچ نامی در ستون انتخاب شده پیدا نشد. لطفاً ستون دیگری را امتحان کنید یا فایل خود را بررسی کنید."),rn(null)}),v.addEventListener("click",()=>{h.click()}),h.addEventListener("change",L=>{const Z=L.target.files[0];if(!Z)return;const q=new FileReader;q.onload=Y=>{const ie=Y.target.result;rn(ie);const re=ie.split(`
`)[0].split(",");wi(re),he("column-mapping-page")},q.readAsText(Z),L.target.value=null}),f.addEventListener("click",()=>{rn(null),he("settings-page")}),m.addEventListener("click",()=>{const L=r.querySelectorAll('input[type="checkbox"]:checked');let Z=!1;L.forEach(q=>{const Y=q.dataset.name,ie=O.students.find(re=>re.identity.name.toLowerCase()===Y.toLowerCase());if(ie)if(ie.isDeleted)En(ie,O);else{console.log(`دانش‌آموز «${Y}» به دلیل تکراری بودن اضافه نشد.`);return}const fe=new an({name:Y});O.addStudent(fe),O.sessions.length>0&&(xe(O.sessions).filter(re=>re.isFinished&&!re.isCancelled).forEach(re=>{re.setAttendance(fe.identity.studentId,"absent")}),ne(fe,O),Z=!0)}),le(),we(O.info.name,`${L.length} دانش‌آموز جدید از لیست ورودی به کلاس اضافه شدند.`,{type:"VIEW_SESSIONS"}),lt(),Z&&K(L.length),he("settings-page"),n.value="",$t([])}),b.addEventListener("click",()=>{$t([]),he("settings-page")}),i.addEventListener("click",()=>{const L=n.value.trim();if(!L){alert("کادر متنی خالی است. لطفاً اسامی را وارد کنید.");return}const Z=L.split(`
`).map(q=>q.trim()).filter(q=>q.length>0);Z.length>0?($t(Z),ns(),he("csv-preview-page")):alert("هیچ نام معتبری برای ورود پیدا نشد.")}),a.addEventListener("keyup",L=>{L.key==="Enter"&&t.click()}),t.addEventListener("click",()=>{if(!O)return;const L=a.value.trim();if(!L){alert("لطفاً نام دانش‌آموز را وارد کنید.");return}const Z=O.students.find(Y=>Y.identity.name.toLowerCase()===L.toLowerCase());if(Z)if(Z.isDeleted)En(Z,O);else{alert("❌دانش‌آموزی با این نام از قبل در این کلاس وجود دارد.");return}const q=new an({name:L});O.addStudent(q),O.sessions.length>0&&(xe(O.sessions).filter(Y=>Y.isFinished&&!Y.isCancelled).forEach(Y=>{Y.setAttendance(q.identity.studentId,"absent")}),ne(q,O),K(1)),le(),we(O.info.name,`دانش‌آموز «${L}» به کلاس اضافه شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:q.identity.studentId}),lt(),ze(),a.value="",a.focus()}),document.getElementById("new-session-btn").addEventListener("click",()=>{if(O){const L=O.sessions.find(q=>!q.isFinished&&!q.isCancelled&&!q.isDeleted);if(L){Q(`⚠️ جلسه ${L.sessionNumber} هنوز تمام نشده است. لطفاً ابتدا با دکمه ✅ آن را خاتمه دهید.`);return}const Z=()=>{const q=Y=>{const ie=O.startNewSession();Tn(ie),qe(ie),O.students.forEach(me=>{ss.setAttendance(me.identity.studentId,"present")}),le();const re=Xe(O).get(ie.sessionNumber);we(O.info.name,`جلسه ${re} شروع شد.`,{type:"VIEW_SESSIONS"}),Kt(Y?"attendance":"selector")};Be("آیا تمایل به انجام فرآیند حضور و غیاب دارید؟",()=>q(!0),{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success",onCancel:()=>q(!1)})};O.hasSessionToday()?Be("شما امروز یک جلسه برای این کلاس ثبت کرده‌اید. آیا از شروع یک جلسه جدید دیگر مطمئن هستید؟",Z,{confirmText:"بله",confirmClass:"btn-warning"}):Z()}}),e.addEventListener("click",()=>{const L=c.value.trim(),Z=document.querySelector('input[name="class-type"]:checked');if(!L&&!Z){Q("⚠️لطفاً نام و نوع کلاس را مشخص کنید.");return}if(!L){Q("⚠️لطفاً نام کلاس را وارد کنید.");return}if(!Z){Q("⚠️لطفاً نوع کلاس را انتخاب کنید.");return}if(ce[L]){ce[L].isDeleted?Q("⚠️ کلاسی با این نام در سطل زباله است. ابتدا آن را بازیابی کنید و یا آن را پاک کنید."):Q("⚠️کلاسی با این نام از قبل وجود دارد.");return}const q=Z.value,Y=new Fn({name:L,type:q});ce[L]=Y,le(),we(L,`کلاس «${L}» ایجاد شد.`,{type:"VIEW_SESSIONS"}),Ue(),Q(`✅ کلاس «${L}» با موفقیت ایجاد شد.`),c.value="",Z.checked=!1}),s.addEventListener("input",L=>{const Z=L.target.value;if(Z.length<2){hn([]);return}const q=Z.toLowerCase(),Y=Mn(q),ie=[];for(const fe in ce){const re=ce[fe];if(re.isDeleted)continue;xe(re.students).filter(ve=>{const Se=rt(ve.identity.name.toLowerCase()),Oe=Se.includes(rt(q)),zt=Se.includes(rt(Y));return Oe||zt}).forEach(ve=>{ie.push({student:ve,classroom:re})})}hn(ie)}),c.addEventListener("keyup",L=>{L.key==="Enter"&&e.click()}),l.addEventListener("click",ui),I.addEventListener("click",()=>{Jt("selector")}),N.addEventListener("input",L=>{const Z=L.target.value;if(!Z){Pt([]);return}const q=Z.toLowerCase(),Y=Mn(q),fe=xe(O.students).filter(re=>{const me=rt(re.identity.name.toLowerCase()),ve=me.includes(rt(q)),Se=me.includes(rt(Y));return ve||Se});Pt(fe)}),N.addEventListener("focus",()=>{N.value&&Pt(N.value)}),yt.addEventListener("click",()=>{const L=at.value,Z=et.value.trim();let q;if(wn)q=wn.student;else{const ie=J==null?void 0:J.winnerHistory[Qe];q=ie==null?void 0:ie.winner}if(!q){Q("❌خطا: دانش‌آموز معتبری برای ثبت نمره یافت نشد.");return}const Y=Ge;if(!q||!Y){Q("⚠️لطفاً ابتدا یک دانش‌آموز و یک دسته‌بندی را انتخاب کنید.");return}if(!L){Q("⚠️لطفاً مقدار نمره را وارد کنید.");return}if(L>100||L<0){Q("❌نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}q&&(q.addScore(Y.name,parseFloat(L),Z),we(O.info.name,`نمره ${L} در ${Y.name} برای «${q.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:q.identity.studentId}),le(),ze(),Q(`✅نمره برای ${q.identity.name} در مهارت ${Y.name} ثبت شد.`),at.value="",et.value="",Pe())});const F=L=>{L.key==="Enter"&&L.ctrlKey&&(L.preventDefault(),yt.click())};at.addEventListener("keydown",F),et.addEventListener("keydown",F),te.addEventListener("click",()=>{ke()}),$.addEventListener("click",()=>{const L=ue.value.trim(),Z=ds;ke(()=>{typeof Z=="function"&&Z(L)})});const R=document.getElementById("move-student-confirm-btn"),_=document.getElementById("move-student-cancel-btn"),C=document.getElementById("move-student-class-select");_.addEventListener("click",()=>{ke()}),R.addEventListener("click",()=>{const L=C.value,Z=ce[L],{studentToMove:q,sourceClassForMove:Y}=Ni;if(!q||!Y||!Z){Q("خطایی رخ داد. لطفاً دوباره امتحان کنید⚠️.","error"),ke();return}const ie=zs(q,Y,Z);ie.success?(we(Y.info.name,`دانش‌آموز «${q.identity.name}» به کلاس «${L}» منتقل شد.`,{type:"VIEW_SESSIONS"}),we(L,`دانش‌آموز «${q.identity.name}» از کلاس «${Y.info.name}» به این کلاس منتقل شد.`,{type:"VIEW_SESSIONS"}),le(),lt(),Q(`دانش‌آموز «${q.identity.name}» با موفقیت به کلاس «${L}» منتقل شد✅.`)):Q(ie.message,"error"),ke()}),z.addEventListener("click",()=>{H.style.width="300px",G.classList.add("modal-visible")}),D.addEventListener("click",W),G.addEventListener("click",W),Ke.addEventListener("click",()=>{Yt(),he("trash-page"),W()}),document.getElementById("demo-mode-btn").addEventListener("click",()=>{it?B():(W(),Be("شما در حال ورود به حالت نمایش (Demo) هستید. در این حالت، هیچ‌کدام از تغییرات شما ذخیره نخواهد شد. آیا ادامه می‌دهید؟",()=>{Us(),pn(),W()},{confirmText:"تایید",confirmClass:"btn-warning",onCancel:W}))});const U=document.getElementById("exit-demo-btn");U&&U.addEventListener("click",()=>{it&&B()}),se.addEventListener("click",()=>{if(it){Q("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است."),W();return}W(),Xt()}),E.addEventListener("click",()=>{if(it){Q("⚠️ بازیابی اطلاعات در حالت نمایش (Demo) غیرفعال است."),W();return}M.click(),W()}),M.addEventListener("change",L=>{const Z=L.target.files[0];if(!Z)return;const q=new FileReader;q.onload=async Y=>{const ie=Y.target.result;try{const fe=JSON.parse(ie);if(fe.metadata&&fe.data)Xn(fe);else{const re=fe.classrooms||fe,me=fe.trashBin||[];Be("آیا از بازیابی اطلاعات مطمئن هستید؟ تمام داده‌های فعلی شما بازنویسی خواهد شد.",()=>{Ct(re),xn(me),Wt({lastRestoreTimestamp:new Date().toISOString()}),le(),Ue(),he("class-management-page"),Q("✅اطلاعات با موفقیت بازیابی شد.")},{confirmText:"بازیابی کن",confirmClass:"btn-warning"})}}catch{try{const ve=(await new Ls().loadAsync(ie,{base64:!0})).file("backup.json");if(!ve)throw new Error("فایل backup.json در فایل پشتیبان یافت نشد.");const Se=await ve.async("string"),Oe=JSON.parse(Se);if(Oe.metadata&&Oe.metadata.version==="2.0-b64")Xn(Oe);else throw new Error("فایل پشتیبان معتبر نیست (نسخه نامشخص).")}catch(re){Q("❌خطا در خواندن فایل. لطفاً فایل پشتیبان معتبر انتخاب کنید."),console.error("Restore error (zip/base64):",re)}}},q.readAsText(Z),L.target.value=null}),window.addEventListener("popstate",L=>{if(ft){ke(null,!0);return}if(gt(),L.state){const{pageId:Z,currentClassName:q,selectedSessionNumber:Y,selectedStudentId:ie}=L.state;q&&(We(ce[q]),Y&&qe(O.getSession(Y)),ie&&Ve(O.students.find(fe=>fe.identity.studentId===ie))),Z==="session-page"?(He(),Gt(Z)):Z==="student-profile-page"?(He(),he("session-page"),Me(_e)):Gt(Z)}else We(null),qe(null),Ve(null),Gt("class-management-page")}),document.addEventListener("keydown",L=>{var Y;const Z=document.activeElement;if(!["INPUT","TEXTAREA","SELECT"].includes(Z.tagName)){if(L.key.toLowerCase()==="o"&&L.shiftKey&&Qs.classList.contains("active")&&(L.preventDefault(),ni.click()),L.key==="Escape"){if(bt.classList.contains("visible")){gt();return}if(ft){ke();return}switch((Y=document.querySelector(".page.active"))==null?void 0:Y.id){case"csv-preview-page":case"column-mapping-page":he("settings-page");break;case"student-profile-page":Ve(null),he(J?"student-page":"session-page");break;case"attendance-page":he("student-page");break;case"student-page":qe(null),He(),he("session-page");break;case"settings-page":case"session-page":We(null),he("class-management-page");break}return}if(J){const ie=L.key.toLowerCase();switch(" ascfg".includes(ie)&&L.preventDefault(),ie){case" ":w.click();break;case"a":k.classList.contains("active")?history.back():(wt(),he("attendance-page"));break;case"s":document.getElementById("session-page").classList.contains("active")&&history.back();break;case"c":document.querySelector(".back-to-classes-btn").click();break;case"f":const fe=document.querySelector(".action-column .search-icon");fe&&fe.click();break;case"g":if(studentProfilePage.classList.contains("active"))history.back();else{const re=J.lastSelectedWinnerId;if(re){const me=O.students.find(ve=>ve.identity.studentId===re);me&&(Ve(me),(void 0)(),he("student-profile-page"))}else Q("⚠️ابتدا یک نفر را انتخاب کنید تا پروفایل او نمایش داده شود.")}break;case"arrowleft":{const re=document.querySelector('button[title="برنده قبلی"]');re&&!re.disabled&&(L.preventDefault(),re.click());break}case"arrowright":{const re=document.querySelector('button[title="برنده بعدی"]');re&&!re.disabled&&(L.preventDefault(),re.click());break}}}}});function W(){H.style.width="0",G.classList.add("modal-closing"),setTimeout(()=>{G.classList.remove("modal-visible","modal-closing")},300)}function B(){Be("آیا از خروج از حالت نمایش (Demo) مطمئن هستید؟ با خروج، تمام تغییرات آزمایشی شما حذف شده و داده‌های اصلی شما بازیابی خواهند شد.",()=>{Hs(),We(null),qe(null),Ve(null),Ue(),he("class-management-page"),pn(),W()},{confirmText:"خروج",confirmClass:"btn-success"})}o(".global-search-container .animated-search-container",hn),o(".action-column-header .animated-search-container",Pt),Ya(),[Ce,ri,et,ti].forEach(L=>{L&&yi(L)});function ne(L,Z){const q=xe(Z.students).filter(Ie=>Ie.identity.studentId!==L.identity.studentId);if(q.length===0)return;const Y=q.reduce((Ie,Fe)=>Fe.statusCounters.totalSelections>Ie.statusCounters.totalSelections?Fe:Ie,q[0]);if(!Y||Y.statusCounters.totalSelections===0)return;L.categoryCounts=JSON.parse(JSON.stringify(Y.categoryCounts)),L.statusCounters.totalSelections=Y.statusCounters.totalSelections;const ie=q.reduce((Ie,Fe)=>Ie+Fe.statusCounters.totalSelections,0),fe=q.reduce((Ie,Fe)=>Ie+(Fe.statusCounters.missedChances||0),0),re=ie>0?fe/ie:0;L.statusCounters.missedChances=Math.round(L.statusCounters.totalSelections*re);const me=xe(Z.categories),ve={};me.forEach(Ie=>{const Fe=q.reduce((Rn,zn)=>Rn+(zn.categoryCounts[Ie.name]||0),0),On=q.reduce((Rn,zn)=>Rn+(zn.categoryIssues[Ie.name]||0),0);ve[Ie.name]=Fe>0?On/Fe:0}),me.forEach(Ie=>{const Fe=L.categoryCounts[Ie.name]||0,On=ve[Ie.name]||0;L.categoryIssues[Ie.name]=Math.round(Fe*On)});const Se=Z.liveSession;Se?L.onboardingSession=Se.sessionNumber:L.onboardingSession=Z.sessions.length+1;const Oe=xe(Z.sessions).filter(Ie=>Ie.isFinished&&!Ie.isCancelled),zt="📝 یادداشت خودکار سیستم",Ei=`این دانش‌آموز  از جلسه شماره ${Oe.length} به کلاس اضافه شد. آمار مشارکت او بر اساس فعال‌ترین دانش‌آموز و آمار «فرصت از دست رفته» او بر اساس میانگین کلاس ثبت گردید:`,It=[];L.statusCounters.totalSelections>0&&It.push(`کل انتخاب‌ها: ${L.statusCounters.totalSelections}`),L.statusCounters.missedChances>0&&It.push(`فرصت‌های از دست رفته: ${L.statusCounters.missedChances}`);for(const Ie in L.categoryCounts){const Fe=L.categoryCounts[Ie];Fe>0&&It.push(`انتخاب در «${Ie}»: ${Fe}`)}for(const Ie in L.categoryIssues){const Fe=L.categoryIssues[Ie];Fe>0&&It.push(`مشکل در «${Ie}»: ${Fe}`)}if(It.length>0){const Ie=`${zt}
${Ei}

- ${It.join(`
- `)}`;L.addNote(Ie)}}function K(L){const q=`چون این کلاس جلسات برگزار شده دارد، برای ${L>1?"دانش‌آموزان جدید":"دانش‌آموز جدید"} آمار پایه‌ای (متناسب با سایر دانش‌آموزان) ثبت شد تا در فرایند انتخاب اختلالی ایجاد نشود.`;Be(q,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}const oe="10.2.0";document.getElementById("app-version").textContent=`نسخه ${oe}`;function Ee(){console.log("Starting universal backfill for writing scores...");let L=0;for(const Z in ce){const q=ce[Z];if(q.isDeleted)continue;let Y=0;xe(q.students).forEach(fe=>{const re=fe.logs.scores;if(!(re&&re.writing&&re.writing.length>0)){let ve=-1;for(const Se in re)Se!=="writing"&&re[Se].forEach(Oe=>{Oe.value>ve&&(ve=Oe.value)});if(ve>-1){const Se=`Automatically assigned based on the highest score (${ve}) from other skills.`;fe.addScore("Writing",ve,Se),Y++}}}),Y>0&&(console.log(`Updated ${Y} student(s) in class: ${q.info.name}.`),L+=Y)}L>0?(le(),console.log(`Update complete. A total of ${L} student(s) were updated across all classes. Data saved.`),document.getElementById("student-page").classList.contains("active")&&ze()):console.log("No students needed updating in any class.")}window.backfillWritingScoresForAll=Ee;function ye(){console.log("Starting backfill for 'outOfClassCount' and 'wasOutOfClass' properties...");let L=0,Z=0;const q=localStorage.getItem("teacherAssistantData_v2");if(!q){console.log("No data found in localStorage. Nothing to do.");return}const Y=JSON.parse(q);for(const ie in Y){const fe=Y[ie];fe.students&&fe.students.forEach(re=>{re.statusCounters&&typeof re.statusCounters.outOfClassCount>"u"&&(re.statusCounters.outOfClassCount=0,L++)}),fe.sessions&&fe.sessions.forEach(re=>{if(re.studentRecords)for(const me in re.studentRecords){const ve=re.studentRecords[me];typeof ve.wasOutOfClass>"u"&&(ve.wasOutOfClass=!1,Z++)}})}localStorage.setItem("teacherAssistantData_v2",JSON.stringify(Y)),console.log(`Backfill complete. Updated ${L} students and ${Z} session records. Data saved.`),_n(),O&&ze()}window.backfillExitCounters=ye;function je(){console.log("🧹 Starting orphaned data cleanup...");let L=0;for(const Z in ce){const q=ce[Z];if(q.isDeleted)continue;let Y=!1;const ie=new Set(q.students.filter(me=>!me.isDeleted).map(me=>me.identity.studentId)),fe=new Map(q.students.map(me=>[me.identity.studentId,me.identity.name])),re=[];q.sessions.forEach(me=>{if(me.isDeleted)return;const ve=[];for(const Se in me.studentRecords)if(!ie.has(Se)){const Oe=fe.get(Se)||"Unknown/Deleted";ve.push(`  - Removed student record for: ${Oe} (ID: ${Se})`),delete me.studentRecords[Se],L++,Y=!0}for(const Se in me.lastWinnerByCategory){const Oe=me.lastWinnerByCategory[Se];if(!ie.has(Oe)){const zt=fe.get(Oe)||"Unknown/Deleted";ve.push(`  - Removed '${Se}' last winner: ${zt} (ID: ${Oe})`),delete me.lastWinnerByCategory[Se],L++,Y=!0}}if(me.lastSelectedWinnerId&&!ie.has(me.lastSelectedWinnerId)){const Se=me.lastSelectedWinnerId,Oe=fe.get(Se)||"Unknown/Deleted";ve.push(`  - Cleared 'lastSelectedWinnerId': ${Oe} (ID: ${Se})`),me.lastSelectedWinnerId=null,L++,Y=!0}if(ve.length>0){const Oe=Xe(q).get(me.sessionNumber)||`(#${me.sessionNumber})`;re.push({sessionDisplayNumber:Oe,logs:ve})}}),Y&&(console.group(`➡️ Class: ${Z}`),re.forEach(me=>{console.groupCollapsed(`  Session ${me.sessionDisplayNumber}`),me.logs.forEach(ve=>console.warn(ve)),console.groupEnd()}),console.groupEnd())}L>0?(le(),console.log(`✅ Cleanup complete! Found and removed ${L} orphaned references. Data saved.`)):console.log("✅ No orphaned data found. Your data is clean!")}window.cleanupOrphanedData=je;function ht(L){if(!L||!L.classroomName)return;const Z=ce[L.classroomName];if(!Z){Q("⚠️ کلاس مربوط به این گزارش یافت نشد.");return}We(Z),ke(),setTimeout(()=>{switch(L.type){case"VIEW_STUDENT_PROFILE":{const q=Z.students.find(Y=>Y.identity.studentId===L.studentId);q?Me(q):Q("⚠️ دانش‌آموز مورد نظر یافت نشد.");break}case"VIEW_TRASH":Yt(),he("trash-page");break;case"VIEW_SESSIONS":He(),he("session-page");break;case"VIEW_CLASS_NOTE":_s(Z);break;case"VIEW_CLASS_SETTINGS":Es(Z);break}},300)}Le.addEventListener("click",()=>{hi()}),De.addEventListener("click",()=>{ke()}),ge.addEventListener("click",()=>{const L=be.value.trim(),Z=Ae.checked;if(!L){vs.style.display==="flex"?Be("کادر یادداشت خالی است. آیا مطمئنید که می‌خواهید یادداشت‌های قبلی دانش‌آموزان انتخاب‌شده را پاک کنید؟",()=>{ke(),Qn("",!1)},{confirmText:"پاک کردن",confirmClass:"btn-warning"}):Q("⚠️ لطفاً متن یادداشت را وارد کنید.");return}ke(()=>{Qn(L,Z)})});const Re=document.getElementById("screen-saver-overlay"),dt=document.getElementById("screen-saver-toggle");let Ne;const _t=2*60*1e3,Et=["mousemove","keypress","scroll","click","touchstart"];function Ye(){Re.classList.add("visible")}function Rt(){Re.classList.contains("visible")&&Re.classList.remove("visible")}function kt(){Rt(),clearTimeout(Ne),Ne=setTimeout(Ye,_t)}function St(L){L.preventDefault(),L.stopPropagation(),setTimeout(kt,0)}function en(){kt(),Et.forEach(Z=>window.addEventListener(Z,kt)),Re.addEventListener("click",St),Re.addEventListener("touchstart",St);const L="10.2.0";{const Z=document.getElementById("screen-saver-version");Z&&(Z.textContent=`v${L}`)}}function tn(){clearTimeout(Ne),Rt(),Et.forEach(L=>window.removeEventListener(L,kt)),Re.removeEventListener("click",St),Re.removeEventListener("touchstart",St)}dt.checked=Ze.isScreenSaverEnabled,Ze.isScreenSaverEnabled&&en(),dt.addEventListener("change",L=>{L.target.checked?(Wt({isScreenSaverEnabled:!0}),en()):(W(),L.preventDefault(),Be(`نکته:
محافظ صفحه در تلفن های همراه جدید کمک می کند که دستگاه باطری کمتری مصرف کند و به دلیل ثابت ماندن صفحه نمایش در گوشی های قدیمی تر، صفحه نمایش دچار ماندگی رد پیکسل نگردد. آیا مطمئن هستید که می خواهید این ویژگی را غیر فعال کنید؟`,()=>{L.target.checked=!1,Wt({isScreenSaverEnabled:!1}),tn(),Q("توصیه می شود زمان خاموش شدن صفحه نمایش گوشی خود را به حداقل دو دقیقه تغییر دهید تا در استفاده های طولانی مدت صفحه نمایش گوشی اصطحلاک کمتری را تجربه کند",7e3)},{confirmText:"بله، غیرفعال کن",cancelText:"لغو",onCancel:()=>{L.target.checked=!0}}))})});function Xa(s,c){if(!J||J.isFinished){Q("⚠️ امکان لغو انتخاب در جلسه خاتمه یافته وجود ندارد.");return}const e=J.winnerHistory;if(!(Qe===e.length-1)||e.length===0){Q("⚠️ فقط آخرین انتخاب قابل لغو است.");return}if(e[e.length-1].winner.identity.studentId!==s.identity.studentId){console.error("Undo mismatch!");return}Be(`آیا از حذف انتخاب «${s.identity.name}» برای «${c}» مطمئن هستید؟ آمار این انتخاب بازگردانی خواهد شد.`,()=>{const a=J.winnerHistory,t=a.pop();if(!t)return;const n=t.winner,i=t.categoryName,r=n.identity.studentId;n.statusCounters.totalSelections=Math.max(0,n.statusCounters.totalSelections-1),n.categoryCounts[i]&&(n.categoryCounts[i]=Math.max(0,n.categoryCounts[i]-1));const m=J.studentRecords[r];m&&m.selections[i]&&(m.selections[i]=Math.max(0,m.selections[i]-1));let b=null;for(let v=a.length-1;v>=0;v--)if(a[v].categoryName===i){b=a[v].winner.identity.studentId;break}b?J.lastWinnerByCategory[i]=b:delete J.lastWinnerByCategory[i],mt(a.length-1),ze(),Pe(),le(),Q(`✅ انتخاب «${n.identity.name}» لغو شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}function Ya(){const s=document.getElementById("session-dashboard-page"),c=document.getElementById("student-stats-table-container");if(!s)return;let e=0,l=0;s.addEventListener("touchstart",t=>{if(c&&c.contains(t.target)){const n=t.target.closest("td, th");n&&n.parentElement.firstElementChild===n?e=t.changedTouches[0].screenX:e=0}else e=t.changedTouches[0].screenX},{passive:!0}),s.addEventListener("touchend",t=>{e!==0&&(l=t.changedTouches[0].screenX,a())});function a(){const n=e-l;Math.abs(n)>100&&(document.getElementById("selector-tab-btn").classList.contains("active")?(he("session-dashboard-page",{tab:"attendance"}),Jt("attendance")):(he("session-dashboard-page",{tab:"selector"}),Jt("selector"))),e=0,l=0}}
