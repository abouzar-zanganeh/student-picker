(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function n(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(a){if(a.ep)return;a.ep=!0;const o=n(a);fetch(a.href,o)}})();class et{constructor(t){this.identity={name:t.name,studentId:t.studentId||`id_${new Date().getTime()}_${Math.random()}`,branchName:t.branchName||null,ageGroup:t.ageGroup||"adult",level:t.level||null,contact:{social:t.socialContact||null,parent:t.parentContact||null}},this.isDeleted=!1,this.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0,outOfClassCount:0},this.categoryCounts={},this.categoryIssues={},this.logs={parentContacts:[],scores:{},discipline:{},sessionHistory:{}},this.profile={notes:[],tags:[]},this.finalClassActivityScore=null}addScore(t,n,s){if(n>100||n<0){console.log("نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}const a=t.toLowerCase();this.logs.scores[a]||(this.logs.scores[a]=[]);const o=new ps(t,n,s);this.logs.scores[a].push(o)}addNote(t,n=null){const s=new gs(t,n);this.profile.notes.push(s)}getOverallAverageScore(){let t=0,n=0;for(const a in this.logs.scores)this.logs.scores[a].forEach(o=>{o.isDeleted||(t+=o.value,n++)});if(n===0)return null;const s=t/n;return Math.round(s*100)/100}}class ps{constructor(t,n,s=""){this.id=`score_${new Date().getTime()}`,this.skill=t,this.value=n,this.timestamp=new Date,this.comment=s,this.isDeleted=!1}}class gs{constructor(t,n=null){this.id=`note_${new Date().getTime()}`,this.timestamp=new Date,this.content=t,this.isDeleted=!1,this.source=n}}class $t{constructor(t="complete",n=""){this.status=t,this.comment=n,this.timestamp=new Date}}class yn{constructor(t){this.sessionNumber=t,this.startTime=new Date,this.note="",this.isDeleted=!1,this.endTime=null,this.isFinished=!1,this.isMakeup=!1,this.isCancelled=!1,this.studentRecords={},this.lastWinnerByCategory={},this.lastUsedCategoryId=null,this.lastSelectedWinnerId=null,this.winnerHistory=[]}end(){this.isFinished=!0,this.endTime=new Date}markAsMakeup(){this.isMakeup=!this.isMakeup}initializeStudentRecord(t){this.studentRecords[t]||(this.studentRecords[t]={attendance:"present",homework:new $t,selections:{},hadIssue:!1,wasOutOfClass:!1})}setAttendance(t,n){this.initializeStudentRecord(t),this.studentRecords[t].attendance=n}setHomeworkStatus(t,n){this.initializeStudentRecord(t),this.studentRecords[t].homework.status=n}selectNextWinner(t,n,s){if(!n||n.length===0)return console.log("هیچ دانش‌آموزی در کلاس برای انتخاب وجود ندارد."),null;const a=this.lastWinnerByCategory[t];let o=n.filter(r=>r.identity.studentId!==a);if(o.length===0&&(o=n),o.length===0)return null;const i=(r,m)=>r.categoryCounts[m]||0,c=Math.min(...o.map(r=>i(r,t))),d=o.filter(r=>i(r,t)===c);let p;if(d.length===1)p=d[0];else if(d.length>1){const r=s.filter(k=>!k.isDeleted&&k.name!==t).map(k=>k.name),m=d.map(k=>{const M=r.reduce((H,T)=>H+i(k,T),0);return{student:k,otherCategoriesTotal:M}}),S=Math.min(...m.map(k=>k.otherCategoriesTotal)),L=m.filter(k=>k.otherCategoriesTotal===S).map(k=>k.student);L.length===1?p=L[0]:p=L[Math.floor(Math.random()*L.length)]}else p=o[Math.floor(Math.random()*o.length)];const C=p.identity.studentId;this.initializeStudentRecord(C);const g=(this.studentRecords[C].selections[t]||0)+1;return this.studentRecords[C].selections[t]=g,p.statusCounters.totalSelections++,p.categoryCounts[t]=(p.categoryCounts[t]||0)+1,this.lastWinnerByCategory[t]=C,p}}class Ht{constructor(t){this.info={name:t.name||"NotNamed",scheduleCode:t.scheduleCode||`code_${new Date().getTime()}`,teacherName:t.teacherName||null,type:t.type||"in-person",term:t.term||null,scheduleText:t.scheduleText||null,level:t.level||null,creationDate:t.creationDate?new Date(t.creationDate):new Date},this.students=[],this.sessions=[],this.note="",this.isDeleted=!1,this.categories=[new he("Vocabulary","Questions about words and meanings."),new he("Grammar","Questions about sentence structure and rules."),new he("Listening",void 0,!0),new he("Speaking",void 0,!0),new he("Reading",void 0,!0),new he("Writing",void 0,!0)],this.futurePlans={}}addStudent(t){this.students.push(t)}removeStudent(t){this.students=this.students.filter(n=>n.identity.studentId!==t)}startNewSession(){const t=this.sessions.length+1,n=new yn(t);return this.sessions.push(n),n}endSpecificSession(t){const n=this.getSession(t);return n&&!n.isFinished?(n.end(),!0):!1}getSession(t){return this.sessions.find(n=>n.sessionNumber===t)}markAsMakeup(t){const n=this.getSession(t);n&&n.markAsMakeup()}planForSession(t,n){this.futurePlans[t]=n}hasSessionToday(){const t=new Date().toDateString();return this.sessions.some(n=>!n.isDeleted&&n.startTime.toDateString()===t)}selectNextWinner(t,n){return n?n.selectNextWinner(t,this.students,this.categories):null}get liveSession(){for(let t=this.sessions.length-1;t>=0;t--)if(!this.sessions[t].isFinished)return this.sessions[t];return null}endLiveSession(){const t=this.liveSession;return t?(t.end(),!0):!1}calculateFinalStudentScore(t){const n=t.logs.scores,s=["reading","writing"];for(const r of s)if(!n[r]||n[r].length===0)return null;const a=n.listening&&n.listening.length>0,o=n.speaking&&n.speaking.length>0;if(!a&&!o)return null;const i=r=>n[r].reduce((S,L)=>S+L.value,0)/n[r].length;let c;a&&o?c=(i("listening")+i("speaking"))/2:a?c=i("listening"):c=i("speaking");const d=i("reading"),p=i("writing"),g=(c*3+d*2+p*1)/6;return Math.trunc(g*10)/10}assignAllFinalScores(){let t=0,n=[];console.log("شروع عملیات محاسبه نمره نهایی برای تمام دانش‌آموزان..."),this.students.forEach(a=>{const o=this.calculateFinalStudentScore(a);o!==null?(a.finalClassActivityScore=o,t++):(a.finalClassActivityScore=null,n.push(a.identity.name))});const s=n.length;console.log(`عملیات پایان یافت. تعداد نمرات موفق: ${t} | تعداد ناموفق (نمرات ناقص): ${s}`),s>0&&(console.log("اسامی دانش‌آموزانی که نمراتشان ناقص است:"),n.forEach(a=>console.log(`- ${a}`)))}}class he{constructor(t,n="",s=!1){this.id=`cat_${new Date().getTime()}_${Math.random()}`,this.name=t,this.description=n,this.isDeleted=!1,this.isGradedCategory=s,this.isDeleted=!1}}let B={},u=null,Vt=null,v=null,U=null,ze=null,It=null,Kt=[],ht=null,Qt=null,oe=null,Ct=0,Xt=0,yt=0,Yt=0,Zt=null,en=null,vt=null,Ce=null,re=-1,bt=null,Et=null,vn=null,bn=null;function w(){localStorage.setItem("teacherAssistantData_v2",JSON.stringify(B))}function En(){const e=JSON.stringify(B,null,2),n=`SP-${new Date().toLocaleDateString("fa-IR-u-nu-latn").replace(/\//g,"-")}.txt`;return new File([e],n,{type:"text/plain"})}function At(){const e=localStorage.getItem("teacherAssistantData_v2");if(e){const t=JSON.parse(e);Nt(t)}}function Nt(e){B={};for(const t in e){const n=e[t],s=new Ht(n.info);s.isDeleted=n.isDeleted,s.note=n.note||"",s.students=n.students.map(a=>{const o=new et(a.identity);return o.isDeleted=a.isDeleted,o.statusCounters=a.statusCounters,o.logs=a.logs,o.logs.scores||(o.logs.scores={}),o.profile=a.profile,o.finalClassActivityScore=a.finalClassActivityScore,o.categoryCounts=a.categoryCounts||{},o.categoryIssues=a.categoryIssues||{},o}),s.sessions=n.sessions.map(a=>{const o=new yn(a.sessionNumber);o.isDeleted=a.isDeleted,o.note=a.note||"",o.startTime=new Date(a.startTime),o.endTime=a.endTime?new Date(a.endTime):null,o.isFinished=a.isFinished,o.isMakeup=a.isMakeup,o.isCancelled=a.isCancelled||!1,o.studentRecords=a.studentRecords;for(const c in o.studentRecords){const d=o.studentRecords[c];d.homework&&!(d.homework instanceof $t)&&(o.studentRecords[c].homework=new $t(d.homework.status,d.homework.comment))}o.lastWinnerByCategory=a.lastWinnerByCategory,o.lastUsedCategoryId=a.lastUsedCategoryId,o.lastSelectedWinnerId=a.lastSelectedWinnerId;const i=a.winnerHistory||[];return o.winnerHistory=i.map(c=>({winner:s.students.find(p=>p.identity.studentId===c.winner.identity.studentId),categoryName:c.categoryName})),o}),s.categories=n.categories.map(a=>{const o=new he(a.name,a.description,a.isGradedCategory);return o.id=a.id,o.isDeleted=a.isDeleted,o}),s.futurePlans=n.futurePlans,B[t]=s}}function Ln(e,t){if(B[t])return{success:!1,message:"کلاسی با این نام از قبل وجود دارد."};const n=B[e];return n?(n.info.name=t,B[t]=n,delete B[e],u===n&&V(n),{success:!0}):{success:!1,message:"کلاس مورد نظر یافت نشد."}}function kn(e,t,n){if(q(n.students).some(i=>i.identity.name.toLowerCase()===e.identity.name.toLowerCase()))return{success:!1,message:`دانش‌آموزی با نام «${e.identity.name}» از قبل در کلاس «${n.info.name}» وجود دارد.`};const a=JSON.parse(JSON.stringify(e));n.addStudent(a);const o=t.students.find(i=>i.identity.studentId===e.identity.studentId);return o&&(o.isDeleted=!0),{success:!0}}function V(e){u=e}function Je(e){Vt=e}function Y(e){v=e}function _(e){U=e}function Lt(e){ze=e}function wn(e){It=e}function We(e){Kt=e}function tt(e){ht=e}function Sn(e){Qt=e}function tn(e){oe=e}function nt(e){Ct=e}function In(e){Xt=e}function st(e){yt=e}function Nn(e){Yt=e}function nn(e){Zt=e}function sn(e){en=e}function Ve(e){vt=e}function an(e){Ce=e}function kt(e){Et=e}function Bn(e){vn=e}function Tn(e){bn=e}function xn(){for(const e in B){const t=B[e];t.students.forEach(n=>{n.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0},n.categoryCounts={},n.categoryIssues={},t.sessions.forEach(s=>{const a=n.identity.studentId;s.studentRecords[a]&&(s.studentRecords[a].attendance="present")})})}w()}function q(e){return Array.isArray(e)?e.filter(t=>!t.isDeleted):[]}function Ee(e){const t=new Map;return e&&q(e.sessions).filter(s=>!s.isCancelled).sort((s,a)=>s.sessionNumber-a.sessionNumber).forEach((s,a)=>{t.set(s.sessionNumber,a+1)}),t}function we(e){re=e}function ue(e){bt=e}const hs=Object.freeze(Object.defineProperty({__proto__:null,get activeModal(){return Ce},get cancelCallback(){return en},get classrooms(){return B},get confirmCallback(){return Zt},get currentClassroom(){return u},get easterEggClickCount(){return Ct},get easterEggLastClickTime(){return Xt},getActiveItems:q,getSessionDisplayMap:Ee,get importedFileContent(){return ht},get liveSession(){return Vt},loadData:At,get manualSelection(){return Et},moveStudent:kn,get namesToImport(){return Kt},get notificationTimeout(){return Qt},prepareBackupData:En,get previousState(){return ze},rehydrateData:Nt,renameClassroom:Ln,resetAllStudentCounters:xn,get resetEasterEggClickCount(){return yt},get resetEasterEggLastClickTime(){return Yt},saveData:w,get saveNoteCallback(){return bt},get secureConfirmCallback(){return vt},get selectedCategory(){return oe},get selectedSession(){return v},get selectedStudentForProfile(){return U},setActiveModal:an,setCancelCallback:sn,setConfirmCallback:nn,setCurrentClassroom:V,setEasterEggClickCount:nt,setEasterEggLastClickTime:In,setImportedFileContent:tt,setLiveSession:Je,setManualSelection:kt,setNamesToImport:We,setNotificationTimeout:Sn,setPreviousState:Lt,setResetEasterEggClickCount:st,setResetEasterEggLastClickTime:Nn,setSaveNoteCallback:ue,setSecureConfirmCallback:Ve,setSelectedCategory:tn,setSelectedSession:Y,setSelectedStudentForProfile:_,setSourceClassForMove:Tn,setStudentToMove:Bn,setUndoTimeout:wn,setWinnerHistoryIndex:we,get sourceClassForMove(){return bn},get studentToMove(){return vn},get undoTimeout(){return It},get winnerHistoryIndex(){return re}},Symbol.toStringTag,{value:"Module"}));function Te(e){return typeof e!="string"?"":e.replace(/ي/g,"ی").replace(/ك/g,"ک")}function Ke(e){return typeof e!="string"||e.length===0?"ltr":/[\u0590-\u07FF]/.test(e)?"rtl":"ltr"}function Dn(e){return!e||!e.trim()?"":e.split(`
`).map(s=>`<div dir="${Ke(s)}">${s||"&nbsp;"}</div>`).join("")}function hn(e){if(typeof e!="string")return"";const t={q:"ض",w:"ص",e:"ث",r:"ق",t:"ف",y:"غ",u:"ع",i:"ه",o:"خ",p:"ح","[":"ج","]":"چ",a:"ش",s:"س",d:"ی",f:"ب",g:"ل",h:"ا",j:"ت",k:"ن",l:"م",";":"ک","'":"گ",z:"ظ",x:"ط",c:"ز",v:"ر",b:"ذ",n:"د",m:"پ",",":"و"};let n="";for(let s=0;s<e.length;s++){const a=e[s].toLowerCase();n+=t[a]||e[s]}return n}const Mn=document.getElementById("class-management-page"),Cs=document.getElementById("new-class-name"),ys=document.getElementById("add-class-btn"),Ot=document.getElementById("class-list"),wt=document.getElementById("undo-toast"),$n=document.getElementById("undo-message"),vs=document.getElementById("undo-btn"),bs=document.getElementById("settings-page"),on=document.getElementById("settings-class-name-header"),Rt=document.getElementById("settings-student-list"),Pt=document.getElementById("category-list"),Es=document.getElementById("back-to-sessions-btn"),Ls=document.getElementById("new-student-name"),ks=document.getElementById("add-student-btn"),Hn=document.getElementById("paste-area"),ws=document.getElementById("process-paste-btn"),Ss=document.getElementById("csv-preview-page"),Ft=document.getElementById("csv-preview-list"),Is=document.getElementById("csv-confirm-btn"),Ns=document.getElementById("csv-cancel-btn"),Bs=document.getElementById("import-csv-btn"),Ts=document.getElementById("csv-file-input"),xs=document.getElementById("column-mapping-page"),qt=document.getElementById("column-select-dropdown"),Ds=document.getElementById("confirm-column-btn"),Ms=document.getElementById("cancel-import-btn"),$s=document.getElementById("new-category-name"),Hs=document.getElementById("add-category-btn"),Wt=document.querySelector(".app-header"),ye=document.getElementById("select-student-btn"),Qe=document.getElementById("select-student-btn-wrapper"),As=document.getElementById("attendance-page"),at=document.getElementById("attendance-list"),Os=document.getElementById("finish-attendance-btn"),Rs=document.getElementById("back-to-sessions-from-attendance-btn"),Ps=document.getElementById("back-to-attendance-btn"),Fs=document.querySelector("#class-management-page h2"),Ut=document.getElementById("student-stats-header"),qs=document.getElementById("hamburger-menu-btn"),Ws=document.getElementById("side-nav-menu"),Us=document.getElementById("close-nav-btn"),js=document.getElementById("overlay"),Gs=document.getElementById("backup-data-btn"),_s=document.getElementById("restore-data-btn"),An=document.getElementById("restore-file-input"),zs=document.getElementById("custom-confirm-modal"),On=document.getElementById("confirm-modal-message"),jt=document.getElementById("confirm-modal-cancel-btn"),Ue=document.getElementById("confirm-modal-confirm-btn"),Js=document.getElementById("secure-confirm-modal"),Rn=document.getElementById("secure-confirm-message"),Pn=document.getElementById("secure-confirm-code"),xe=document.getElementById("secure-confirm-input"),Vs=document.getElementById("secure-confirm-cancel-btn"),ot=document.getElementById("secure-confirm-confirm-btn"),Ks=document.getElementById("add-note-modal"),A=document.getElementById("new-note-content"),Qs=document.getElementById("save-note-btn"),Xs=document.getElementById("cancel-note-btn"),Gt=document.getElementById("student-search-input"),ge=document.getElementById("student-search-results"),Ys=document.getElementById("student-profile-page"),Fn=document.getElementById("profile-student-name-header"),Zs=document.getElementById("back-to-student-page-btn"),De=document.getElementById("graded-category-pills-container"),_t=document.getElementById("new-score-value"),cn=document.getElementById("new-score-comment"),ea=document.getElementById("add-score-btn"),je=document.getElementById("profile-stats-summary"),it=document.getElementById("profile-scores-list"),ct=document.getElementById("global-student-search-input"),fe=document.getElementById("global-student-search-results"),ta=document.getElementById("is-graded-checkbox"),lt=document.getElementById("trashed-classes-list"),rt=document.getElementById("trashed-students-list"),dt=document.getElementById("trashed-sessions-list"),ut=document.getElementById("trashed-categories-list"),mt=document.getElementById("trashed-notes-list"),ft=document.getElementById("trashed-score-comments-list"),St=document.getElementById("quick-grade-form-wrapper"),pe=document.getElementById("quick-score-input"),de=document.getElementById("quick-note-textarea"),Ae=document.getElementById("quick-grade-submit-btn"),ln=document.getElementById("category-selection-container"),qn=document.getElementById("selected-student-result"),Se=document.getElementById("custom-context-menu"),Me=document.getElementById("breadcrumb-container");function Ye(e){clearTimeout(It),ze||Lt(JSON.stringify(B)),$n.textContent=e,wt.classList.add("show"),wn(setTimeout(()=>{wt.classList.remove("show"),Lt(null)},5e3))}function Wn(){if(ze){const e=u?u.info.name:null,t=JSON.parse(ze);Nt(t),e&&B[e]?V(B[e]):V(null),u?(ve(),Oe(),z()):ce(),wt.classList.remove("show"),clearTimeout(It),Lt(null)}}function E(e,t=3e3){const n=document.getElementById("notification-toast");n&&(n.textContent=e,n.classList.add("show"),clearTimeout(Qt),Sn(setTimeout(()=>{n.classList.remove("show")},t)))}function F(e,t,n={}){const{confirmText:s="تایید",cancelText:a="لغو",confirmClass:o="btn-success",onCancel:i=()=>{},isDelete:c=!1}=n,d=c?()=>Un(e,t):t;On.textContent=e,Ue.textContent=s,jt.textContent=a,Ue.className="modal-action-btn",Ue.classList.add(o),nn(d),sn(i);const p=Ue.parentElement;jt.style.display=i===null?"none":"inline-block",p.style.justifyContent=i===null?"center":"space-between",ee("custom-confirm-modal")}function Un(e,t){const n=Math.floor(1e4+Math.random()*9e4).toString();Rn.textContent=e,Pn.textContent=n,xe.value="",ot.disabled=!0,Ve(t),ee("secure-confirm-modal"),xe.focus();const s=()=>{xe.value===n?ot.disabled=!1:ot.disabled=!0};return xe.addEventListener("input",s),()=>{xe.removeEventListener("input",s)}}function jn(e,t){const n=Object.values(B).filter(i=>!i.isDeleted&&i.info.name!==t.info.name),s=document.getElementById("move-student-modal-title"),a=document.getElementById("move-student-class-select"),o=document.getElementById("move-student-confirm-btn");s.textContent=`انتقال دانش‌آموز: ${e.identity.name}`,a.innerHTML="",n.length===0?(a.innerHTML='<option value="">کلاس دیگری برای انتقال وجود ندارد</option>',o.disabled=!0):(n.forEach(i=>{const c=document.createElement("option");c.value=i.info.name,c.textContent=i.info.name,a.appendChild(c)}),o.disabled=!1),Bn(e),Tn(t),ee("move-student-modal")}function ee(e){const t=document.getElementById(e);if(t){if(Ce)return;t.classList.add("modal-visible"),an(e),history.pushState(null,"",location.href)}}function ae(e){if(!Ce)return;const t=document.getElementById(Ce),n=Ce;an(null),history.back(),t&&(t.classList.add("modal-closing"),setTimeout(()=>{t.classList.remove("modal-visible"),t.classList.remove("modal-closing"),n==="custom-confirm-modal"&&(nn(null),sn(null)),n==="secure-confirm-modal"&&Ve(null),n==="add-note-modal"&&ue(null),typeof e=="function"&&e()},300))}function zt(e){const t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download=e.name,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t)}async function rn(){const e=En();if(("ontouchstart"in window||navigator.maxTouchPoints>0)&&navigator.share&&navigator.canShare&&navigator.canShare({files:[e]}))try{await navigator.share({title:"پشتیبان دستیار معلم",text:"فایل پشتیبان داده‌های برنامه",files:[e]})}catch(n){n.name!=="AbortError"&&(console.error("Error sharing file:",n),zt(e),E("⚠️اشتراک‌گذاری با خطا مواجه شد. فایل در حال دانلود است."))}else zt(e),E("✅پشتیبان‌گیری با موفقیت انجام شد.")}function Bt(e,t){e.preventDefault(),ke(),setTimeout(()=>{const n=Se,s=n.querySelector("ul");s.innerHTML="",t.forEach(C=>{const g=document.createElement("li");C.isSeparator?g.className="separator":(g.innerHTML=`
                    <span class="icon">${C.icon||""}</span>
                    <span class="label">${C.label}</span>
                `,C.className&&g.classList.add(C.className),g.addEventListener("click",()=>{C.action(),ke()})),s.appendChild(g)});const{clientX:a,clientY:o}=e,{innerWidth:i,innerHeight:c}=window;n.style.top=`${o}px`,n.style.left=`${a}px`,n.classList.add("visible");const{offsetWidth:d,offsetHeight:p}=n;a+d>i&&(n.style.left=`${i-d-5}px`),o+p>c&&(n.style.top=`${c-p-5}px`)},50)}function ke(){Se.classList.contains("visible")&&Se.classList.remove("visible")}function Gn(){var t,n;Me.innerHTML="";const e=[];if(e.push({label:"کلاس‌ها",handler:()=>{V(null),Y(null),_(null),I("class-management-page")}}),u){if(e.push({label:u.info.name,handler:()=>{Y(null),_(null),z(),I("session-page")}}),((t=document.querySelector(".page.active"))==null?void 0:t.id)==="settings-page")e.push({label:"تنظیمات"});else if(v){const o=Ee(u).get(v.sessionNumber)||` (#${v.sessionNumber})`;e.push({label:`جلسه ${o}`,handler:()=>{_(null),I("student-page")}});const i=(n=document.querySelector(".page.active"))==null?void 0:n.id;U?e.push({label:`پروفایل: ${U.identity.name}`}):i==="attendance-page"&&e.push({label:"حضور و غیاب"})}}if(e.length<=1){Me.style.display="none";return}Me.style.display="flex",e.forEach((s,a)=>{const o=document.createElement("a");if(o.textContent=s.label,o.className="breadcrumb-item",a===e.length-1||!s.handler?o.classList.add("active"):o.addEventListener("click",s.handler),Me.appendChild(o),a<e.length-1){const i=document.createElement("span");i.className="breadcrumb-separator",i.textContent="/",Me.appendChild(i)}})}function Cn(e,t,n){n.innerHTML="";const s=u.sessions.filter(a=>{var o;return!a.isDeleted&&!a.isCancelled&&((o=a.studentRecords[e.identity.studentId])==null?void 0:o.attendance)==="absent"}).map(a=>({number:t.get(a.sessionNumber),isMakeup:a.isMakeup})).filter(a=>a.number!==void 0);s.length>0?(n.appendChild(document.createTextNode("جلسات غایب: ")),s.forEach((a,o)=>{const i=document.createElement("span");i.textContent=a.number,a.isMakeup&&i.classList.add("makeup-absence"),n.appendChild(i),o<s.length-1&&n.appendChild(document.createTextNode("، "))})):n.textContent="جلسات غایب: بدون غیبت"}function pt(e,t,n,s={}){const{includePrefix:a=!0}=s;n.innerHTML="";const o=u.sessions.filter(i=>{if(i.isDeleted||i.isCancelled)return!1;const c=i.studentRecords[e.identity.studentId];return c&&c.homework&&(c.homework.status==="incomplete"||c.homework.status==="none")}).map(i=>({number:t.get(i.sessionNumber),status:i.studentRecords[e.identity.studentId].homework.status})).filter(i=>i.number!==void 0);o.length>0?(a&&n.appendChild(document.createTextNode("تکالیف ناقص: ")),o.forEach((i,c)=>{const d=document.createElement("span");d.textContent=i.number,i.status==="incomplete"&&d.classList.add("incomplete-homework"),n.appendChild(d),c<o.length-1&&n.appendChild(document.createTextNode("،"))})):a?n.textContent="تکالیف ناقص: ندارد":n.textContent="ندارد"}function na(e,t){var k,M,H;const n=document.createElement("li");n.className="attendance-list-item";const s={none:"بدون تکلیف",complete:"تکلیف کامل",incomplete:"تکلیف ناقص"},a=document.createElement("div");a.className="student-info";const o=document.createElement("span");o.className="student-name",o.textContent=e.identity.name,o.addEventListener("click",()=>{_(e),Z(),I("student-profile-page")});const i=document.createElement("span");i.className="absence-info";const c=document.createElement("span");c.className="homework-info",Cn(e,t,i),pt(e,t,c),a.appendChild(o),a.appendChild(i),a.appendChild(c);const d=document.createElement("div");d.className="homework-controls";const p=document.createElement("button"),C=((k=v.studentRecords[e.identity.studentId])==null?void 0:k.homework.status)||"none";p.className=`homework-status-btn ${C}`,p.title=s[C],p.addEventListener("click",()=>{const T=v.studentRecords[e.identity.studentId].homework,O={none:"incomplete",incomplete:"complete",complete:"none"}[T.status];p.title=s[O],v.setHomeworkStatus(e.identity.studentId,O),w(),p.className=`homework-status-btn ${O}`,pt(e,t,c)});const g=document.createElement("button");g.className="btn-icon",g.innerHTML="📝",g.title="افزودن یادداشت برای تکلیف",((M=v.studentRecords[e.identity.studentId])==null?void 0:M.homework.comment)||(g.style.opacity="0.3"),g.addEventListener("click",()=>{const T=v.studentRecords[e.identity.studentId].homework;A.value=T.comment||"",A.dispatchEvent(new Event("input",{bubbles:!0})),ue($=>{T.comment=$;const O=Ee(u),le=O.get(v.sessionNumber),K={type:"fromAttendance",sessionNumber:v.sessionNumber},me=`یادداشت حضور-غیاب ${le}: `,j=e.profile.notes.find(te=>!te.isDeleted&&te.source&&te.source.type==="fromAttendance"&&te.source.sessionNumber===K.sessionNumber);j?$?j.content=me+$:j.isDeleted=!0:$&&e.addNote(me+$,K),w(),g.style.opacity=$?"1":"0.3",pt(e,O,c)}),ee("add-note-modal"),A.focus()}),d.appendChild(p),d.appendChild(g);const m=document.createElement("button"),S=((H=v.studentRecords[e.identity.studentId])==null?void 0:H.attendance)||"present",L=T=>{T==="present"?(m.textContent="حاضر",m.className="attendance-status-btn present active"):(m.textContent="غایب",m.className="attendance-status-btn absent active")};return L(S),m.addEventListener("click",()=>{var O;const $=(((O=v.studentRecords[e.identity.studentId])==null?void 0:O.attendance)||"present")==="present"?"absent":"present";v.setAttendance(e.identity.studentId,$),$==="absent"&&(v.studentRecords[e.identity.studentId].hadIssue=!1),w(),L($),Cn(e,t,i),Vn()}),n.appendChild(a),n.appendChild(d),n.appendChild(m),n}function sa(){return Ee(u).get(v.sessionNumber)}function $e(){if(!u||!v)return;const e=Ee(u);fa(),at.innerHTML="";const t=document.createElement("li");t.className="attendance-list-header",t.innerHTML=`
    <span class="header-label-spacer"></span>
    <span class="header-label">تکلیف</span>
    <span class="header-label">حضور</span>
`,at.appendChild(t),q(u.students).forEach(n=>{const s=na(n,e);at.appendChild(s)}),pa(),Vn()}function ie(){const e=document.getElementById("student-stats-table-container");if(!e||(e.innerHTML="",!u))return;q(u.students).length,Ut.textContent="آمار عملکرد";const t=["نام"],n=["کل انتخاب ها","غیبت","خروج","فرصت ازدست‌رفته","مشکل","میانگین","نمره کلاسی (کانون)"],s=u.categories.filter(m=>m.isGradedCategory&&!m.isDeleted).map(m=>m.name),a=[...t,...s,...n],o=document.createElement("table");o.className="student-stats-table";const c=o.createTHead().insertRow();a.forEach((m,S)=>{const L=document.createElement("th");S===0?(L.innerHTML=`${m} <span style="opacity: 0.6;">🔗</span>`,L.title="ردیف‌های این ستون قابل کلیک هستند"):L.textContent=m,c.appendChild(L)});const d=o.createTBody(),p=q(u.students),C=m=>{let S=0;return u.sessions.forEach(L=>{if(L.isDeleted||L.isCancelled)return;const k=L.studentRecords[m.identity.studentId];k&&k.attendance==="absent"&&S++}),S};p.forEach(m=>{const S=d.insertRow();if(S.dataset.studentId=m.identity.studentId,v){const $=v.studentRecords[m.identity.studentId];$&&$.attendance==="absent"&&S.classList.add("absent-row-highlight")}const L=S.insertCell(),k=document.createElement("span");k.textContent=m.identity.name,k.className="student-name-link",k.addEventListener("click",()=>{_(m),Z(),I("student-profile-page")}),L.appendChild(k),s.forEach($=>{var me;const O=S.insertCell(),le=$.toLowerCase(),K=((me=m.logs.scores[le])==null?void 0:me.filter(j=>!j.isDeleted))||[];K.length>0?K.forEach((j,te)=>{const Q=document.createElement("span");Q.textContent=j.value,Q.style.position="relative",j.comment&&(Q.dataset.tooltip=j.comment),O.appendChild(Q),te<K.length-1&&O.appendChild(document.createTextNode(","))}):O.textContent="",O.style.cursor="pointer",O.addEventListener("click",()=>{be(m,$);const j=document.getElementById("category-selection-container");j&&j.scrollIntoView({behavior:"smooth",block:"center"})})}),S.insertCell().textContent=m.statusCounters.totalSelections||0,S.insertCell().textContent=C(m),S.insertCell().textContent=m.statusCounters.outOfClassCount||0,S.insertCell().textContent=m.statusCounters.missedChances||0;const M=Object.values(m.categoryIssues||{}).reduce(($,O)=>$+O,0);S.insertCell().textContent=M;const H=m.getOverallAverageScore();S.insertCell().textContent=H!==null?H:"-";const T=u.calculateFinalStudentScore(m);S.insertCell().textContent=T!==null?T:"-"}),q(u.students),Ut.setAttribute("data-student-count",p.length),e.appendChild(o);const g=e.querySelector(".student-stats-table"),r=g==null?void 0:g.querySelector("thead th:first-child");r&&r.addEventListener("click",()=>{g.classList.toggle("name-column-expanded")})}function be(e=null,t=null){const n=document.getElementById("selected-student-result");n.innerHTML="",n.classList.remove("absent");let s,a;if(e&&t)s=e,a=t,kt({student:e,categoryName:t}),we(-1);else{if(kt(null),!v||re<0||!v.winnerHistory[re])return;const R=v.winnerHistory[re];s=R.winner,a=R.categoryName}const o=document.querySelector(".current-winner-highlight");if(o&&o.classList.remove("current-winner-highlight"),s){const R=document.querySelector(`.student-stats-table tr[data-student-id="${s.identity.studentId}"]`);R&&R.classList.add("current-winner-highlight")}const i=u.categories.find(R=>R.name===a);if(i){tn(i);const R=document.querySelectorAll("#category-selection-container .pill");R.forEach(G=>G.classList.remove("active"));const P=Array.from(R).find(G=>G.textContent===a);P&&P.classList.add("active"),zn(i)}const c=v.studentRecords[s.identity.studentId],d=(c==null?void 0:c.attendance)==="absent",p=document.createElement("div");p.className="winner-name-container";const C=document.createElement("button");C.className="btn-icon",C.innerHTML="˅",C.title="برنده قبلی";const g=!e;C.classList.toggle("is-disabled",!g||re<=0),C.addEventListener("click",()=>{C.classList.contains("is-disabled")?(C.classList.add("shake-animation"),setTimeout(()=>C.classList.remove("shake-animation"),200)):(we(re-1),be())});const r=document.createElement("div");r.className="winner-name",r.innerHTML=`✨ <strong>${s.identity.name}</strong>✨`,r.classList.add("heartbeat-animation"),d&&(r.style.textDecoration="line-through",r.style.opacity="0.6",r.style.color="var(--color-secondary)"),(c==null?void 0:c.hadIssue)&&!d&&(r.style.color="var(--color-warning)",r.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"),(c==null?void 0:c.wasOutOfClass)&&!d&&(r.style.color="var(--color-strong-warning)",r.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود");const L=document.createElement("button");L.className="btn-icon",L.innerHTML="˄",L.title="برنده بعدی",L.classList.toggle("is-disabled",!g||re>=v.winnerHistory.length-1),L.addEventListener("click",()=>{L.classList.contains("is-disabled")?(L.classList.add("shake-animation"),setTimeout(()=>L.classList.remove("shake-animation"),200)):(we(re+1),be())}),p.appendChild(L),p.appendChild(r),p.appendChild(C),n.appendChild(p),ye.disabled=g&&!L.classList.contains("is-disabled");const k=document.createElement("div");k.className="status-button-container";const M=document.createElement("button");M.textContent="غایب",M.classList.add("status-button","absent-btn"),d&&M.classList.add("active");const H=document.createElement("button");H.textContent="مشکل",H.classList.add("status-button","issue-btn"),c!=null&&c.hadIssue&&H.classList.add("active");const T=document.createElement("button");T.textContent="خروج",T.classList.add("status-button","exit-btn"),c!=null&&c.wasOutOfClass&&T.classList.add("active");const $=document.createElement("button");$.textContent="پروفایل",$.className="status-button profile-btn",M.addEventListener("click",()=>{const R=M.classList.contains("active");T.classList.contains("active")&&(T.classList.remove("active"),c.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),R?(M.classList.remove("active"),v.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),r.style.textDecoration="",r.style.opacity="",r.style.color=""):(H.classList.contains("active")&&(H.classList.remove("active"),c.hadIssue=!1,s.statusCounters.otherIssues=Math.max(0,s.statusCounters.otherIssues-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),M.classList.add("active"),v.setAttendance(s.identity.studentId,"absent"),s.statusCounters.missedChances++,r.style.textDecoration="line-through",r.style.opacity="0.6",r.style.color="var(--color-secondary)",r.title=""),ie(),w()}),H.addEventListener("click",()=>{const R=H.classList.contains("active");if(T.classList.contains("active")&&(T.classList.remove("active"),c.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),R){H.classList.remove("active"),c.hadIssue=!1;const P=oe.name;s.categoryIssues[P]&&(s.categoryIssues[P]=Math.max(0,s.categoryIssues[P]-1)),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),r.style.color="",r.title=""}else{M.classList.contains("active")&&(M.classList.remove("active"),v.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),H.classList.add("active"),c.hadIssue=!0;const P=oe.name;s.categoryIssues[P]=(s.categoryIssues[P]||0)+1,s.statusCounters.missedChances++,r.style.textDecoration="",r.style.opacity="",r.style.color="var(--color-warning)",r.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"}ie(),w()}),T.addEventListener("click",()=>{if(T.classList.contains("active"))T.classList.remove("active"),c.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),r.style.color="",r.title="";else{if(M.classList.contains("active")&&(M.classList.remove("active"),v.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),H.classList.contains("active")){H.classList.remove("active"),c.hadIssue=!1;const P=oe.name;s.categoryIssues[P]&&(s.categoryIssues[P]=Math.max(0,s.categoryIssues[P]-1)),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)}T.classList.add("active"),c.wasOutOfClass=!0,s.statusCounters.outOfClassCount=(s.statusCounters.outOfClassCount||0)+1,s.statusCounters.missedChances++,r.style.textDecoration="",r.style.opacity="",r.style.color="var(--color-strong-warning)",r.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود"}ie(),w()}),$.addEventListener("click",()=>{_(s),Z(),I("student-profile-page")}),k.appendChild(M),k.appendChild(T),k.appendChild(H),k.appendChild($),n.appendChild(k);const O=document.createElement("div");O.className="student-details-container";const le=document.createElement("div");le.className="student-details-scores",le.innerHTML="<h4>آخرین نمرات</h4>";const K=document.createElement("ul");K.className="scores-list";const me=["Reading","Writing","Speaking","Listening"];let j=!1;const te=s.logs.scores||{};me.forEach(R=>{const P=document.createElement("li"),G=document.createElement("span");G.className="skill-name",G.textContent=`${R}:`;const Le=document.createElement("span");Le.className="skill-scores";const Tt=R.toLowerCase(),Re=te[Tt];Re&&Re.length>0?(j=!0,Le.textContent=Re.slice(-3).map(xt=>xt.value).join(",")):Le.textContent="none",P.appendChild(G),P.appendChild(Le),K.appendChild(P)}),!j&&Object.keys(te).length===0&&(K.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>'),le.appendChild(K),O.appendChild(le);const Q=document.createElement("div");Q.className="student-details-notes",Q.innerHTML="<h4>یادداشت‌ها</h4>";const Ie=document.createElement("ul");Ie.className="notes-list",s.profile.notes&&s.profile.notes.length>0?[...s.profile.notes].sort((P,G)=>new Date(G.timestamp)-new Date(P.timestamp)).forEach(P=>{const G=document.createElement("li");G.dir=Ke(P.content),G.textContent=P.content,Ie.appendChild(G)}):Ie.innerHTML='<div class="no-content-message">یادداشتی وجود ندارد.</div>',Q.appendChild(Ie),O.appendChild(Q),n.appendChild(O)}function _n(e){e.addEventListener("input",()=>{const t=e.value,n=Ke(t);e.setAttribute("dir",n)})}function aa(){ln.innerHTML="",qn.innerHTML="",St.classList.add("tooltip-container"),pe.disabled=!0,de.disabled=!0,Ae.disabled=!0,pe.value="",de.value="",Qe.classList.add("disabled-wrapper"),ye.disabled=!0}function oa(){u.categories.filter(t=>!t.isDeleted).forEach(t=>{const n=document.createElement("span");n.className="pill",n.textContent=t.name,n.dataset.categoryId=t.id,t.description&&(n.dataset.tooltip=t.description),n.addEventListener("click",()=>{document.querySelectorAll(".pill").forEach(a=>a.classList.remove("active")),n.classList.add("active"),tn(t),zn(t),Qe.classList.remove("disabled-wrapper"),ye.disabled=!1;const s=v.lastWinnerByCategory[t.name];if(s){const a=u.students.find(o=>o.identity.studentId===s);a&&be(a,t.name)}else{qn.innerHTML="",kt(null),we(-1),ye.disabled=!1;const a=document.querySelector(".current-winner-highlight");a&&a.classList.remove("current-winner-highlight")}}),ln.appendChild(n)})}function ia(){if(v.lastUsedCategoryId){const e=ln.querySelector(`.pill[data-category-id="${v.lastUsedCategoryId}"]`);e&&e.click()}v.winnerHistory&&v.winnerHistory.length>0&&(we(v.winnerHistory.length-1),be())}function zn(e){e&&(e.isGradedCategory?(pe.disabled=!1,de.disabled=!1,Ae.disabled=!1,St.removeAttribute("data-tooltip")):(pe.disabled=!0,de.disabled=!0,Ae.disabled=!0,St.setAttribute("data-tooltip","برای این دسته‌بندی قابلیت نمره دهی تعریف نشده است")))}function He(){if(!u||!v){I("class-management-page");return}aa(),oa(),ia(),I("student-page"),ie()}function Z(){if(!U)return;const e=U;Fn.textContent=`پروفایل: ${e.identity.name}`;const t=u.sessions.reduce((r,m)=>{const S=m.studentRecords[e.identity.studentId];return r+(S&&S.attendance==="absent"?1:0)},0),n=Object.values(e.categoryIssues||{}).reduce((r,m)=>r+m,0);je.innerHTML=`
    <p><strong>کل انتخاب:</strong> ${e.statusCounters.totalSelections}</p>
    <p><strong>غیبت:</strong> ${t}</p>
    <p><strong>فرصت از دست رفته:</strong> ${e.statusCounters.missedChances||0}</p>
    <p><strong>مشکل:</strong> ${n}</p>`;const s=q(u.categories),a=document.createElement("div");if(a.className="stats-breakdown",s.length>0){s.forEach(m=>{var M;const S=m.name,L=((M=e.categoryCounts)==null?void 0:M[S])||0,k=document.createElement("p");k.className="stats-breakdown-item",k.innerHTML=`<strong>${S}:</strong> ${L}`,a.appendChild(k)});const r=je.querySelector("p:first-child");r&&r.after(a)}const o=document.createElement("div");o.className="stats-breakdown",s.length>0&&(s.forEach(r=>{var k;const m=r.name,S=((k=e.categoryIssues)==null?void 0:k[m])||0,L=document.createElement("p");L.className="stats-breakdown-item",L.innerHTML=`<strong>${m}:</strong> ${S}`,o.appendChild(L)}),je.appendChild(o));const i=document.createElement("p"),c=document.createElement("strong");c.textContent="تکالیف ناقص:";const d=document.createElement("span");d.style.marginRight="5px";const p=Ee(u);pt(e,p,d,{includePrefix:!1}),i.appendChild(c),i.appendChild(d),je.appendChild(i);const C=u.categories.filter(r=>r.isGradedCategory&&!r.isDeleted);De.innerHTML="",C.forEach(r=>{const m=document.createElement("span");m.className="pill",m.textContent=r.name,m.dataset.skillName=r.name,r.description&&(m.dataset.tooltip=r.description),De.appendChild(m),m.addEventListener("click",()=>{De.querySelectorAll(".pill").forEach(S=>S.classList.remove("active")),m.classList.add("active"),_t.focus()})}),it.innerHTML="";const g=[];for(const r in e.logs.scores)e.logs.scores[r].forEach(m=>{m.isDeleted||g.push(m)});g.sort((r,m)=>new Date(m.timestamp)-new Date(r.timestamp)),g.length===0?it.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>':g.forEach(r=>{const m=document.createElement("li");m.className="score-history-item";const S=document.createElement("div");S.className="item-content";const L=document.createElement("div");if(L.className="score-info",L.innerHTML=`
        <span class="score-date">${new Date(r.timestamp).toLocaleDateString("fa-IR")}</span>
        <span class="score-value">نمره: <strong>${r.value}</strong></span>
        <span class="score-skill-badge">${r.skill}</span>
    `,S.appendChild(L),r.comment){const M=`توضیحات: ${r.comment}`,H=Ke(M);Ke(r.comment);const T=document.createElement("p");T.className="score-comment",T.dir=H,T.innerHTML=`<strong>توضیحات:</strong> <div>${Dn(r.comment)}</div>`,T.addEventListener("click",()=>{A.value=r.comment,A.dispatchEvent(new Event("input",{bubbles:!0})),ue($=>{r.comment=$,w(),Z()}),ee("add-note-modal"),A.focus()}),S.appendChild(T)}const k=document.createElement("button");k.className="btn-icon delete-item-btn",k.innerHTML="🗑️",k.title="حذف این نمره",k.addEventListener("click",()=>{F(`آیا از حذف نمره ${r.value} برای مهارت ${r.skill} مطمئن هستید؟`,()=>{r.isDeleted=!0,w(),Z(),E("✅نمره به سطل زباله منتقل شد.")},{confirmText:"تایید حذف",confirmClass:"btn-warning"})}),m.appendChild(S),m.appendChild(k),it.appendChild(m)}),_t.value="",cn.value="",De.querySelector(".pill.active")&&De.querySelector(".pill.active").classList.remove("active"),Xe()}function Xe(){const e=document.getElementById("profile-notes-list");if(e.innerHTML="",!U||!U.profile.notes||U.profile.notes.length===0){e.innerHTML='<div class="no-content-message">هنوز یادداشتی ثبت نشده است.</div>';return}[...U.profile.notes].filter(n=>!n.isDeleted).sort((n,s)=>new Date(s.timestamp)-new Date(n.timestamp)).forEach(n=>{const s=document.createElement("li");s.className="note-history-item";const a=document.createElement("div");a.className="item-content";const o=document.createElement("div");o.className="note-info";const i=document.createElement("span");i.className="note-date",i.textContent=new Date(n.timestamp).toLocaleDateString("fa-IR");const c=document.createElement("button");c.className="btn-icon delete-item-btn",c.innerHTML="🗑️",c.title="حذف این یادداشت",c.addEventListener("click",()=>{F("آیا از حذف این یادداشت مطمئن هستید؟",()=>{n.isDeleted=!0,w(),Xe(),E("✅یادداشت به سطل زباله منتقل شد.")},{confirmText:"تایید حذف",confirmClass:"btn-warning"})}),o.appendChild(i),o.appendChild(c);const d=document.createElement("p");d.className="note-content",d.innerHTML=Dn(n.content),d.addEventListener("click",()=>{A.value=n.content,A.dispatchEvent(new Event("input",{bubbles:!0})),ue(p=>{n.content=p,w(),Xe()}),ee("add-note-modal"),A.focus()}),a.appendChild(o),a.appendChild(d),s.appendChild(a),e.appendChild(s)})}function Jn(e){qt.innerHTML="",e.forEach((t,n)=>{const s=document.createElement("option");s.value=n,s.textContent=t.trim(),qt.appendChild(s)})}function Jt(){Ft.innerHTML="",Kt.forEach(e=>{const t=document.createElement("li");t.className="preview-item";const n=document.createElement("input");n.type="checkbox",n.checked=!0,n.dataset.name=e;const s=document.createElement("label");s.textContent=e,t.appendChild(n),t.appendChild(s),Ft.appendChild(t)})}function ca(e){const t=document.createElement("div");t.className="list-item-buttons";const n=document.createElement("button");return n.className="btn-icon",n.innerHTML="📝",n.title="افزودن/ویرایش یادداشت کلاس",n.style.borderBottom="solid",e.note||(n.style.opacity="0.5",n.style.borderBottom="none"),n.addEventListener("click",s=>{s.stopPropagation(),A.value=e.note||"",ue(a=>{e.note=a,w(),ce()}),ee("add-note-modal"),A.focus()}),t.appendChild(n),t}function la(e){const t=document.createElement("div");t.style.flexGrow="1",t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="flex-start";const n=document.createElement("span");n.textContent=e.info.name,n.classList.add("class-name-display"),t.appendChild(n);const s=q(e.students).length,a=q(e.sessions).filter(d=>d.isFinished).length,o=document.createElement("div");o.classList.add("class-stats-row");const i=document.createElement("span");i.textContent=`${s} نفر`,i.classList.add("student-count-badge"),o.appendChild(i);const c=document.createElement("span");return c.textContent=`${a} جلسه`,c.classList.add("session-count-badge"),o.appendChild(c),t.appendChild(o),t.addEventListener("click",()=>{V(e),Y(null),Je(u.liveSession),z(),I("session-page")}),t}function ra(e){const t=document.createElement("li"),n=la(e);t.appendChild(n);const s=document.createElement("div");if(s.className="list-item-badges",e.liveSession&&!e.liveSession.isCancelled&&!e.liveSession.isDeleted){const i=document.createElement("span");i.className="warning-badge",i.textContent="جلسه باز",s.appendChild(i),t.classList.add("has-unfinished-session")}const a=document.createElement("span");a.className=`type-badge ${e.info.type}`,a.textContent=e.info.type==="online"?"آنلاین":"حضوری",a.title="نوع کلاس",s.appendChild(a),t.appendChild(s);const o=ca(e);return t.appendChild(o),t.addEventListener("contextmenu",i=>{Bt(i,[{label:"تنظیمات کلاس",icon:"⚙️",action:()=>{V(e),on.textContent=`تنظیمات کلاس: ${u.info.name}`,ve(),Oe(),I("settings-page")}},{label:"تغییر نام",icon:"✏️",action:()=>{const d=e.info.name,p=document.getElementById("add-note-modal-title");p.textContent="تغییر نام کلاس",A.value=d,A.rows=1,ue(C=>{const g=C.trim();if(g&&g!==d){const r=Ln(d,g);r.success?(w(),ce(),E(`✅نام کلاس به «${g}» تغییر یافت.`)):E(r.message)}p.textContent="ثبت یادداشت جدید",A.rows=4}),ee("add-note-modal"),A.focus(),A.select()}},{label:"حذف کلاس",icon:"🗑️",className:"danger",action:()=>{F(`آیا از حذف کلاس «${e.info.name}» مطمئن هستید؟ این عمل تمام جلسات و آمار مربوط به آن را نیز حذف می‌کند.`,()=>{Ye(`کلاس «${e.info.name}» حذف شد.`),e.isDeleted=!0,w(),ce()},{confirmText:"تایید حذف",confirmClass:"btn-warning",isDelete:!0})}}])}),t}function ce(){Ot.innerHTML="",Object.values(B).sort((t,n)=>new Date(t.info.creationDate)-new Date(n.info.creationDate)).forEach(t=>{if(t.isDeleted)return;const n=ra(t);Ot.appendChild(n)})}function ve(){Rt.innerHTML="",u&&q(u.students).forEach(e=>{const t=document.createElement("li"),n=document.createElement("span");n.textContent=e.identity.name,n.style.flexGrow="1",t.appendChild(n),t.addEventListener("contextmenu",s=>{Bt(s,[{label:"انتقال دانش‌آموز",icon:"➡️",action:()=>{jn(e,u)}},{isSeparator:!0},{label:"حذف دانش‌آموز",icon:"🗑️",className:"danger",action:()=>{F(`آیا از حذف دانش‌آموز «${e.identity.name}» مطمئن هستید؟`,()=>{Ye(`دانش‌آموز «${e.identity.name}» حذف شد.`),e.isDeleted=!0,w(),ve()},{confirmText:"تایید حذف",confirmClass:"btn-warning"})}}])}),Rt.appendChild(t)})}function Oe(){if(Pt.innerHTML="",!u)return;u.categories.filter(t=>!t.isDeleted).forEach(t=>{const n=document.createElement("li"),s=document.createElement("div");s.className="name-and-badge-container";const a=document.createElement("span");if(a.textContent=t.name,s.appendChild(a),t.isGradedCategory){const i=document.createElement("span");i.className="category-badge",i.textContent="قابل نمره‌دهی",s.appendChild(i)}const o=document.createElement("button");o.className="btn-icon",o.innerHTML="🗑️",o.style.color="var(--color-warning)",o.addEventListener("click",()=>{Ye(`دسته‌بندی «${t.name}» حذف شد.`),t.isDeleted=!0,w(),Oe()}),n.appendChild(s),n.appendChild(o),Pt.appendChild(n)})}function _e(e){document.querySelectorAll(".page").forEach(n=>{n.classList.remove("active")});const t=document.getElementById(e);t&&t.classList.add("active"),e==="class-management-page"?(ce(),Wt.style.display="flex"):Wt.style.display="none",Gn()}function I(e){const t={pageId:e,currentClassName:u?u.info.name:null,selectedSessionNumber:v?v.sessionNumber:null,selectedStudentId:U?U.identity.studentId:null};let n=`#${e}`;const s=new URLSearchParams;u&&s.set("class",u.info.name),v&&s.set("session",v.sessionNumber),U&&s.set("student",U.identity.studentId);const a=s.toString();a&&(n+=`?${a}`),window.location.hash!==n&&history.pushState(t,"",n),_e(e)}function da(e,t){const n=document.createElement("div");n.className="list-item-buttons";const s=document.createElement("button");if(s.className="btn-icon",s.innerHTML="📝",s.title="افزودن/ویرایش یادداشت جلسه",s.style.borderBottom="solid",e.note||(s.style.opacity="0.5",s.style.borderBottom="none"),s.addEventListener("click",a=>{a.stopPropagation(),A.value=e.note||"",ue(o=>{e.note=o,w(),z()}),ee("add-note-modal"),A.focus()}),n.appendChild(s),!e.isFinished&&!e.isCancelled){const a=document.createElement("button");a.className="btn-icon",a.innerHTML="✅",a.title="خاتمه جلسه",a.addEventListener("click",o=>{o.stopPropagation(),F(`جلسه شماره ${t} خاتمه پیدا خواهد کرد!`,()=>{u.endSpecificSession(e.sessionNumber),w(),z(),F("جلسه با موفقیت خاتمه یافت. آیا مایل به ایجاد فایل پشتیبان هستید؟",()=>{rn(),E("✅فایل پشتیبان با موفقیت ایجاد شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}),n.appendChild(a)}return n}function ua(e,t){const n=document.createElement("div");n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="flex-start",n.style.flexGrow="1";const s=new Date(e.startTime).toLocaleDateString("fa-IR"),a=document.createElement("span"),o=document.createElement("div");o.style.display="flex",o.style.gap="5px",o.style.marginTop="5px";const i=new Date(e.startTime).toLocaleDateString("fa-IR",{weekday:"long"}),c=document.createElement("span");if(c.className="type-badge day-badge",c.textContent=i,o.appendChild(c),e.isCancelled){a.textContent=`✅جلسه لغو شده - تاریخ: ${s}`,n.style.cursor="default";const d=document.createElement("span");d.className="type-badge cancelled-badge",d.textContent="لغو شده",o.appendChild(d)}else a.textContent=`جلسه ${t} - تاریخ: ${s}`,n.style.cursor="pointer",n.addEventListener("click",()=>{Y(e),He()});if(n.appendChild(a),e.isFinished){const d=document.createElement("span");d.className="type-badge",d.textContent="خاتمه یافته",d.style.backgroundColor="var(--color-secondary)",o.appendChild(d)}if(e.isMakeup){const d=document.createElement("span");d.className="type-badge",d.textContent="جبرانی",d.style.backgroundColor="var(--color-warning)",d.style.color="var(--color-text-dark)",o.appendChild(d)}return n.appendChild(o),n}function ma(e,t){const n=document.createElement("li"),s=t.get(e.sessionNumber),a=ua(e,s);n.appendChild(a);const o=da(e,s);return n.appendChild(o),n.addEventListener("contextmenu",i=>{const c=[{label:e.isCancelled?"بازگردانی جلسه":"لغو جلسه",icon:"❌",action:()=>{const d=e.isCancelled?"بازگردانی جلسه":"لغو جلسه",p=e.isCancelled?"آیا از بازگردانی این جلسه مطمئن هستید؟":"آیا از لغو این جلسه مطمئن هستید؟ جلسه لغو شده در آمار تاثیری ندارد اما قابل بازگردانی است.";F(p,()=>{e.isCancelled=!e.isCancelled,w(),z(),E(e.isCancelled?"✅جلسه لغو شد.":"✅جلسه بازگردانی شد.")},{confirmText:d,confirmClass:"btn-warning"})}},{label:"تغییر وضعیت جبرانی",icon:"🔄",action:()=>{u.markAsMakeup(e.sessionNumber),w(),z()}},{label:"حذف جلسه",icon:"🗑️",className:"danger",action:()=>{const d=e.isCancelled?"لغو شده":s;F(`آیا از حذف جلسه ${d} مطمئن هستید؟ این عمل آمار ثبت شده در این جلسه را نیز حذف می‌کند.`,()=>{Ye(`جلسه ${d} حذف شد.`),e.isDeleted=!0,w(),z()},{confirmText:"تایید حذف",confirmClass:"btn-warning",isDelete:!0})}}];Bt(i,c)}),n}function z(){const e=document.getElementById("session-list");if(!u)return;if(e.innerHTML="",u.sessions.length===0){e.innerHTML="<li>هنوز جلسه‌ای شروع نشده است.</li>";return}const t=Ee(u);[...q(u.sessions)].reverse().forEach(s=>{const a=ma(s,t);e.appendChild(a)})}function Ge(e){if(ge.innerHTML="",e.length>0)e.forEach(t=>{const n=document.createElement("div");n.textContent=t.identity.name,n.addEventListener("click",()=>{_(t),Z(),I("student-profile-page"),ge.style.display="none",Gt.value=""}),ge.appendChild(n)}),ge.style.display="block";else if(Gt.value.trim()!==""){const t=document.createElement("div");t.className="no-results",t.textContent="پیدا نشد",ge.appendChild(t),ge.style.display="block"}else ge.style.display="none"}function gt(e){if(fe.innerHTML="",e.length>0)e.forEach(t=>{const n=document.createElement("div");n.className="global-search-result";const s=document.createElement("span");s.className="student-name",s.textContent=t.student.identity.name;const a=document.createElement("span");a.className="class-name",a.textContent=`کلاس: ${t.classroom.info.name}`,n.addEventListener("click",()=>{V(t.classroom),_(t.student),Z(),I("student-profile-page"),fe.style.display="none",ct.value=""}),a.addEventListener("click",o=>{o.stopPropagation(),V(t.classroom),Y(null),Je(t.classroom.liveSession),z(),I("session-page"),fe.style.display="none",ct.value=""}),n.appendChild(s),n.appendChild(a),fe.appendChild(n)}),fe.style.display="block";else if(ct.value.trim()!==""){const t=document.createElement("div");t.className="no-results",t.textContent="پیدا نشد",fe.appendChild(t),fe.style.display="block"}else fe.style.display="none"}function J(){lt.innerHTML="",rt.innerHTML="",dt.innerHTML="",ut.innerHTML="",mt.innerHTML="",ft.innerHTML="";const e=Object.values(B).filter(i=>i.isDeleted);e.length===0?lt.innerHTML="<li>هیچ کلاسی در سطل زباله نیست.</li>":e.forEach(i=>{const c=document.createElement("li");c.innerHTML=`<span>${i.info.name}</span>`;const d=document.createElement("div");d.className="list-item-buttons";const p=document.createElement("button");p.className="btn-icon",p.innerHTML="🔄",p.title="بازیابی",p.addEventListener("click",()=>{i.isDeleted=!1,w(),J(),ce(),E(`✅کلاس «${i.info.name}» بازیابی شد.`)});const C=document.createElement("button");C.className="btn-icon",C.innerHTML="🔥",C.title="حذف دائمی",C.addEventListener("click",()=>{F(`آیا از حذف دائمی کلاس «${i.info.name}» مطمئن هستید؟ این عمل غیرقابل بازگشت است.`,()=>{delete B[i.info.name],w(),J(),E(`✅کلاس «${i.info.name}» برای همیشه حذف شد.`)},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),d.appendChild(p),d.appendChild(C),c.appendChild(d),lt.appendChild(c)});const t=[];Object.values(B).forEach(i=>{i.isDeleted||i.students.forEach(c=>{c.isDeleted&&t.push({student:c,classroom:i})})}),t.length===0?rt.innerHTML="<li>هیچ دانش‌آموزی در سطل زباله نیست.</li>":t.forEach(({student:i,classroom:c})=>{const d=document.createElement("li");d.innerHTML=`<span>${i.identity.name} <small>(از کلاس: ${c.info.name})</small></span>`;const p=document.createElement("div");p.className="list-item-buttons";const C=document.createElement("button");C.className="btn-icon",C.innerHTML="🔄",C.title="بازیابی",C.addEventListener("click",()=>{i.isDeleted=!1,w(),J(),E(`دانش‌آموز «${i.identity.name}» بازیابی شد.`)});const g=document.createElement("button");g.className="btn-icon",g.innerHTML="🔥",g.title="حذف دائمی",g.addEventListener("click",()=>{F(`آیا از حذف دائمی دانش‌آموز «${i.identity.name}» مطمئن هستید؟ این عمل غیرقابل بازگشت است.`,()=>{const r=c.students.findIndex(m=>m.identity.studentId===i.identity.studentId);r>-1&&c.students.splice(r,1),w(),J(),E(`دانش‌آموز «${i.identity.name}» برای همیشه حذف شد.`)},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),p.appendChild(C),p.appendChild(g),d.appendChild(p),rt.appendChild(d)});const n=[];Object.values(B).forEach(i=>{i.isDeleted||i.sessions.forEach(c=>{c.isDeleted&&n.push({session:c,classroom:i})})}),n.length===0?dt.innerHTML="<li>هیچ جلسه‌ای در سطل زباله نیست.</li>":n.forEach(({session:i,classroom:c})=>{const d=document.createElement("li");d.innerHTML=`<span>جلسه ${i.sessionNumber} <small>(از کلاس: ${c.info.name})</small></span>`;const p=document.createElement("div");p.className="list-item-buttons";const C=document.createElement("button");C.className="btn-icon",C.innerHTML="🔄",C.title="بازیابی",C.addEventListener("click",()=>{i.isDeleted=!1,w(),J(),E(`جلسه ${i.sessionNumber} بازیابی شد.`)});const g=document.createElement("button");g.className="btn-icon",g.innerHTML="🔥",g.title="حذف دائمی",g.addEventListener("click",()=>{F(`آیا از حذف دائمی جلسه ${i.sessionNumber} مطمئن هستید؟`,()=>{const r=c.sessions.findIndex(m=>m.sessionNumber===i.sessionNumber);r>-1&&c.sessions.splice(r,1),w(),J(),E(`جلسه ${i.sessionNumber} برای همیشه حذف شد.`)},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),p.appendChild(C),p.appendChild(g),d.appendChild(p),dt.appendChild(d)});const s=[];Object.values(B).forEach(i=>{i.isDeleted||i.categories.forEach(c=>{c.isDeleted&&s.push({category:c,classroom:i})})}),s.length===0?ut.innerHTML="<li>هیچ دسته‌بندی در سطل زباله نیست.</li>":s.forEach(({category:i,classroom:c})=>{const d=document.createElement("li");d.innerHTML=`<span>${i.name} <small>(از کلاس: ${c.info.name})</small></span>`;const p=document.createElement("div");p.className="list-item-buttons";const C=document.createElement("button");C.className="btn-icon",C.innerHTML="🔄",C.title="بازیابی",C.addEventListener("click",()=>{i.isDeleted=!1,w(),J(),E(`دسته‌بندی «${i.name}» بازیابی شد.`)});const g=document.createElement("button");g.className="btn-icon",g.innerHTML="🔥",g.title="حذف دائمی",g.addEventListener("click",()=>{F(`آیا از حذف دائمی دسته‌بندی «${i.name}» مطمئن هستید؟`,()=>{const r=c.categories.findIndex(m=>m.id===i.id);r>-1&&c.categories.splice(r,1),w(),J(),E(`دسته‌بندی «${i.name}» برای همیشه حذف شد.`)},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),p.appendChild(C),p.appendChild(g),d.appendChild(p),ut.appendChild(d)});const a=[];Object.values(B).forEach(i=>{i.isDeleted||i.students.forEach(c=>{c.isDeleted||c.profile.notes.forEach(d=>{d.isDeleted&&a.push({note:d,student:c,classroom:i})})})}),a.length===0?mt.innerHTML="<li>هیچ یادداشتی در سطل زباله نیست.</li>":a.forEach(({note:i,student:c,classroom:d})=>{const p=document.createElement("li"),C=i.content.length>50?i.content.substring(0,50)+"...":i.content;p.innerHTML=`<span>"${C}" <small>(برای: ${c.identity.name}، کلاس: ${d.info.name})</small></span>`;const g=document.createElement("div");g.className="list-item-buttons";const r=document.createElement("button");r.className="btn-icon",r.innerHTML="🔄",r.title="بازیابی",r.addEventListener("click",()=>{i.isDeleted=!1,w(),J(),E("یادداشت بازیابی شد.")});const m=document.createElement("button");m.className="btn-icon",m.innerHTML="🔥",m.title="حذف دائمی",m.addEventListener("click",()=>{F("آیا از حذف دائمی این یادداشت مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{const S=c.profile.notes.findIndex(L=>L.id===i.id);S>-1&&c.profile.notes.splice(S,1),w(),J(),E("یادداشت برای همیشه حذف شد.")},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),g.appendChild(r),g.appendChild(m),p.appendChild(g),mt.appendChild(p)});const o=[];Object.values(B).forEach(i=>{i.isDeleted||i.students.forEach(c=>{if(!c.isDeleted)for(const d in c.logs.scores)c.logs.scores[d].forEach(p=>{p.isDeleted&&p.comment&&o.push({score:p,student:c,classroom:i})})})}),o.length===0?ft.innerHTML="<li>هیچ توضیح نمره‌ای در سطل زباله نیست.</li>":o.forEach(({score:i,student:c,classroom:d})=>{const p=document.createElement("li"),C=i.comment.length>50?i.comment.substring(0,50)+"...":i.comment;p.innerHTML=`<span>"${C}" <small>(برای نمره ${i.value} در مهارت ${i.skill} / دانش‌آموز: ${c.identity.name})</small></span>`;const g=document.createElement("div");g.className="list-item-buttons";const r=document.createElement("button");r.className="btn-icon",r.innerHTML="🔄",r.title="بازیابی",r.addEventListener("click",()=>{i.isDeleted=!1,w(),J(),E("توضیح نمره بازیابی شد.")});const m=document.createElement("button");m.className="btn-icon",m.innerHTML="🔥",m.title="حذف دائمی",m.addEventListener("click",()=>{F("آیا از حذف دائمی این توضیح مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{const S=i.skill.toLowerCase(),L=c.logs.scores[S];if(L){const k=L.findIndex(M=>M.id===i.id);k>-1&&L.splice(k,1)}w(),J(),E("توضیح نمره برای همیشه حذف شد.")},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),g.appendChild(r),g.appendChild(m),p.appendChild(g),ft.appendChild(p)})}function fa(){const e=document.getElementById("absentees-summary-container");e&&(e.innerHTML=`
        <div id="absentees-summary-box" class="absentees-summary">
            <div class="absentees-summary-header">
                <h4>لیست غایبین جلسه شماره <span id="absentee-summary-session-number"></span></h4>
                <button id="copy-absentees-btn" class="btn-icon" title="کپی لیست غایبین">📋</button>
            </div>
            <div id="absentees-summary-list" class="summary-list"></div>
        </div>
    `)}function Vn(){const e=document.getElementById("absentees-summary-box"),t=document.getElementById("absentees-summary-list"),n=document.getElementById("absentee-summary-session-number");if(!e||!t||!n){console.error("Could not find all absentee summary elements.");return}if(!u||!v){e.classList.remove("visible");return}const s=q(u.students).filter(o=>{const i=v.studentRecords[o.identity.studentId];return i&&i.attendance==="absent"}),a=Ee(u);n.textContent=a.get(v.sessionNumber),s.length>0?e.classList.add("visible"):e.classList.remove("visible"),t.innerHTML="",s.forEach(o=>{const c=(p=>u.sessions.reduce((C,g)=>{if(g.isDeleted||g.isCancelled)return C;const r=g.studentRecords[p.identity.studentId];return C+(r&&r.attendance==="absent"?1:0)},0))(o),d=document.createElement("span");d.className="summary-name",d.textContent=`${o.identity.name} (غیبت: ${c})`,d.addEventListener("click",()=>{d.classList.add("fading-out"),setTimeout(()=>{v.setAttendance(o.identity.studentId,"present"),w(),$e()},200)}),t.appendChild(d)})}function pa(){const e=document.getElementById("copy-absentees-btn");if(!e){console.error("Could not find the copy absentees button to attach listener.");return}e.addEventListener("click",()=>{if(!u||!v)return;const t=q(u.students).filter(a=>{const o=v.studentRecords[a.identity.studentId];return o&&o.attendance==="absent"});if(t.length===0){E("⚠️لیست غایبین خالی است.");return}const n=a=>u.sessions.reduce((o,i)=>{if(i.isDeleted||i.isCancelled)return o;const c=i.studentRecords[a.identity.studentId];return o+(c&&c.attendance==="absent"?1:0)},0);let s=`لیست غایبین جلسه شماره ${sa()}:

`;t.forEach(a=>{const o=n(a);s+=`- ${a.identity.name} (تعداد غیبت‌ها: ${o})
`}),navigator.clipboard.writeText(s).then(()=>{E("✅لیست غایبین با موفقیت کپی شد.")}).catch(a=>{console.error("Failed to copy text: ",a),E("❌خطا در کپی کردن لیست.")})})}const ga=Object.freeze(Object.defineProperty({__proto__:null,_internalShowPage:_e,addCategoryBtn:Hs,addClassBtn:ys,addNoteModal:Ks,addScoreBtn:ea,addStudentBtn:ks,appHeader:Wt,attendanceListUl:at,attendancePage:As,backToAttendanceBtn:Ps,backToSessionsBtn:Es,backToSessionsFromAttendanceBtn:Rs,backToStudentPageBtn:Zs,backupDataBtn:Gs,breadcrumbContainer:Me,cancelImportBtn:Ms,cancelNoteBtn:Xs,categoryListUl:Pt,classListHeader:Fs,classListUl:Ot,classManagementPage:Mn,closeActiveModal:ae,closeContextMenu:ke,closeNavBtn:Us,columnMappingPage:xs,columnSelectDropdown:qt,confirmColumnBtn:Ds,confirmModalCancelBtn:jt,confirmModalConfirmBtn:Ue,confirmModalMessage:On,contextMenu:Se,csvCancelBtn:Ns,csvConfirmBtn:Is,csvFileInput:Ts,csvPreviewList:Ft,csvPreviewPage:Ss,customConfirmModal:zs,displayWinner:be,finishAttendanceBtn:Os,globalStudentSearchInput:ct,globalStudentSearchResultsDiv:fe,gradedCategoryPillsContainer:De,hamburgerMenuBtn:qs,handleUndo:Wn,importCsvBtn:Bs,initiateBackupProcess:rn,isGradedCheckbox:ta,newCategoryNameInput:$s,newClassNameInput:Cs,newNoteContent:A,newScoreCommentTextarea:cn,newScoreValueInput:_t,newStudentNameInput:Ls,openContextMenu:Bt,openModal:ee,overlay:js,pasteArea:Hn,processPasteBtn:ws,profileScoresListUl:it,profileStatsSummaryDiv:je,profileStudentNameHeader:Fn,quickGradeFormWrapper:St,quickGradeSubmitBtn:Ae,quickNoteTextarea:de,quickScoreInput:pe,renderAttendancePage:$e,renderBreadcrumbs:Gn,renderClassList:ce,renderColumnSelector:Jn,renderGlobalSearchResults:gt,renderImportPreview:Jt,renderSearchResults:Ge,renderSessions:z,renderSettingsCategories:Oe,renderSettingsStudentList:ve,renderStudentNotes:Xe,renderStudentPage:He,renderStudentProfilePage:Z,renderStudentStatsList:ie,renderTrashPage:J,restoreDataBtn:_s,restoreFileInput:An,saveNoteBtn:Qs,secureConfirmCancelBtn:Vs,secureConfirmCode:Pn,secureConfirmConfirmBtn:ot,secureConfirmInput:xe,secureConfirmMessage:Rn,secureConfirmModal:Js,selectStudentBtn:ye,selectStudentBtnWrapper:Qe,setAutoDirectionOnInput:_n,settingsClassNameHeader:on,settingsPage:bs,settingsStudentListUl:Rt,showCustomConfirm:F,showMoveStudentModal:jn,showNotification:E,showPage:I,showSecureConfirm:Un,showUndoToast:Ye,sideNavMenu:Ws,studentProfilePage:Ys,studentSearchInput:Gt,studentSearchResultsDiv:ge,studentStatsHeader:Ut,trashedCategoriesList:ut,trashedClassesList:lt,trashedNotesList:mt,trashedScoreCommentsList:ft,trashedSessionsList:dt,trashedStudentsList:rt,triggerFileDownload:zt,undoBtn:vs,undoMessage:$n,undoToast:wt},Symbol.toStringTag,{value:"Module"}));function ha(){const e=window.location.hash;if(!e||e==="#")return!1;const[t,n]=e.split("?"),s=t.substring(1),a=new URLSearchParams(n),o=a.get("class"),i=parseInt(a.get("session"),10),c=a.get("student");if(o&&B[o])V(B[o]),i&&u.getSession(i)&&Y(u.getSession(i)),c&&u.students.find(d=>d.identity.studentId===c)&&_(u.students.find(d=>d.identity.studentId===c));else return!1;switch(s){case"session-page":z(),I("session-page");break;case"student-page":He();break;case"attendance-page":$e(),I("attendance-page");break;case"settings-page":on.textContent=`تنظیمات کلاس: ${u.info.name}`,ve(),Oe(),I("settings-page");break;case"student-profile-page":Z(),I("student-profile-page");break;default:return!1}return!0}document.addEventListener("DOMContentLoaded",()=>{const{globalStudentSearchInput:e,newClassNameInput:t,addClassBtn:n,undoBtn:s,backToSessionsBtn:a,newStudentNameInput:o,addStudentBtn:i,pasteArea:c,processPasteBtn:d,csvPreviewList:p,csvConfirmBtn:C,csvCancelBtn:g,importCsvBtn:r,csvFileInput:m,columnSelectDropdown:S,confirmColumnBtn:L,cancelImportBtn:k,newCategoryNameInput:M,addCategoryBtn:H,selectStudentBtn:T,attendancePage:$,finishAttendanceBtn:O,backToSessionsFromAttendanceBtn:le,backToAttendanceBtn:K,classListHeader:me,studentStatsHeader:j,hamburgerMenuBtn:te,sideNavMenu:Q,closeNavBtn:Ie,overlay:R,backupDataBtn:P,restoreDataBtn:G,restoreFileInput:Le,confirmModalCancelBtn:Tt,confirmModalConfirmBtn:Re,secureConfirmCancelBtn:xt,secureConfirmConfirmBtn:Kn,newNoteContent:Ze,saveNoteBtn:Qn,cancelNoteBtn:Xn,studentSearchInput:Pe,studentSearchResultsDiv:Yn,studentProfilePage:Zn,profileStudentNameHeader:es,backToStudentPageBtn:ts,gradedCategoryPillsContainer:ns,newScoreValueInput:ss,newScoreCommentTextarea:as,addScoreBtn:os,isGradedCheckbox:dn}=ga,is=document.getElementById("trash-nav-btn");document.querySelector(".global-search-container .search-icon"),At(),ha()||(ce(),I("class-management-page"));function un(l,h){const f=document.querySelector(l);if(!f)return;const y=f.querySelector(".search-icon"),b=f.querySelector(".animated-search-input");!y||!b||(y.addEventListener("mousedown",x=>{x.preventDefault()}),y.addEventListener("click",()=>{f.classList.contains("search-active")||(f.classList.add("search-active"),b.focus())}),b.addEventListener("blur",()=>{setTimeout(()=>{f.classList.remove("search-active"),b.value="",h&&h([])},150)}))}window.addEventListener("scroll",ke),document.addEventListener("click",l=>{Se.classList.contains("visible")&&!Se.contains(l.target)&&ke()}),Qe.addEventListener("click",()=>{(Qe.classList.contains("disabled-wrapper")||ye.disabled)&&(ye.classList.add("shake-animation"),setTimeout(()=>{ye.classList.remove("shake-animation")},200))}),j.addEventListener("click",()=>{const l=new Date().getTime();l-Yt>500?st(1):st(yt+1),Nn(l),yt===5&&(st(0),F("آیا از صفر کردن تمام شمارنده‌های دانش‌آموزان مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{xn(),ie(),E("تمام آمارها صفر شدند ✅.")},{confirmText:"بله",confirmClass:"btn-warning"}))}),me.addEventListener("click",()=>{const l=new Date().getTime();l-Xt>500?nt(1):nt(Ct+1),In(l),Ct===5&&(nt(0),F("آیا از ساخت یک کلاس تستی تصادفی مطمئن هستید؟",()=>{function h(){const f=`کلاس تستی ${Object.keys(B).length+1}`,y=new Ht({name:f,type:"online"});["علی رضایی","مریم حسینی","زهرا احمدی","رضا محمدی","فاطمه کریمی"].forEach(x=>y.addStudent(new et({name:x}))),B[f]=y,w(),ce()}h(),E("کلاس تستی با موفقیت ساخته شد ✅!")},{confirmText:"بساز",confirmClass:"btn-success"}))}),xt.addEventListener("click",()=>{ae(),Ve(null)}),Kn.addEventListener("click",()=>{typeof vt=="function"&&vt(),ae(),Ve(null)}),Tt.addEventListener("click",()=>{ae(en)}),Re.addEventListener("click",()=>{ae(Zt)}),K.addEventListener("click",()=>{u&&v&&($e(),I("attendance-page"))}),T.addEventListener("click",()=>{if(pe.value.trim()!==""||de.value.trim()!==""){E("⚠️لطفاً ابتدا با دکمه «ثبت»، تغییرات را ذخیره کنید.");return}if(!u||!v||!oe)return;const l=u.selectNextWinner(oe.name,v);if(l){const h=v.studentRecords[l.identity.studentId];if(h&&h.attendance==="absent"&&l.statusCounters.missedChances++,h&&h.hadIssue){l.statusCounters.missedChances++;const y=oe.name;l.categoryIssues[y]=(l.categoryIssues[y]||0)+1}const f={winner:l,categoryName:oe.name};v.winnerHistory.push(f),v.winnerHistory.length>10&&v.winnerHistory.shift(),we(v.winnerHistory.length-1),v.lastUsedCategoryId=oe.id,v.lastSelectedWinnerId=l.identity.studentId,ie(),be(),w()}else E("❌دانش‌آموز واجد شرایطی برای انتخاب یافت نشد.")}),H.addEventListener("click",()=>{if(!u)return;const l=M.value.trim(),h=dn.checked;if(!l){alert("لطفاً نام دسته‌بندی را وارد کنید.");return}if(u.categories.some(b=>!b.isDeleted&&b.name.toLowerCase()===l.toLowerCase())){alert("این دسته‌بندی از قبل وجود دارد.");return}const y=new he(l,"",h);u.categories.push(y),w(),Oe(),M.value="",dn.checked=!1}),M.addEventListener("keyup",l=>{l.key==="Enter"&&H.click()}),L.addEventListener("click",()=>{if(!ht){alert("خطایی رخ داده است. لطفاً فایل را دوباره انتخاب کنید."),I("settings-page");return}const l=parseInt(S.value,10),y=ht.split(`
`).slice(1).map(b=>{var N;return(N=b.split(",")[l])==null?void 0:N.trim()}).filter(b=>b&&b.length>0);y.length>0?(We(y),Jt(),I("csv-preview-page")):alert("هیچ نامی در ستون انتخاب شده پیدا نشد. لطفاً ستون دیگری را امتحان کنید یا فایل خود را بررسی کنید."),tt(null)}),r.addEventListener("click",()=>{m.click()}),m.addEventListener("change",l=>{const h=l.target.files[0];if(!h)return;const f=new FileReader;f.onload=y=>{const b=y.target.result;tt(b);const N=b.split(`
`)[0].split(",");Jn(N),I("column-mapping-page")},f.readAsText(h),l.target.value=null}),k.addEventListener("click",()=>{tt(null),I("settings-page")}),C.addEventListener("click",()=>{const l=p.querySelectorAll('input[type="checkbox"]:checked');let h=!1;l.forEach(f=>{const y=f.dataset.name;if(u.students.some(x=>x.identity.name.toLowerCase()===y.toLowerCase()))console.log(`دانش‌آموز «${y}» به دلیل تکراری بودن اضافه نشد.`);else{const x=new et({name:y});u.addStudent(x),u.sessions.length>0&&(fn(x,u),h=!0)}}),w(),ve(),h&&pn(l.length),I("settings-page"),c.value="",We([])}),g.addEventListener("click",()=>{We([]),I("settings-page")}),d.addEventListener("click",()=>{const l=c.value.trim();if(!l){alert("کادر متنی خالی است. لطفاً اسامی را وارد کنید.");return}const h=l.split(`
`).map(f=>f.trim()).filter(f=>f.length>0);h.length>0?(We(h),Jt(),I("csv-preview-page")):alert("هیچ نام معتبری برای ورود پیدا نشد.")}),o.addEventListener("keyup",l=>{l.key==="Enter"&&i.click()}),i.addEventListener("click",()=>{if(!u)return;const l=o.value.trim();if(!l){alert("لطفاً نام دانش‌آموز را وارد کنید.");return}if(u.students.some(y=>y.identity.name.toLowerCase()===l.toLowerCase())){alert("❌دانش‌آموزی با این نام از قبل در این کلاس وجود دارد.");return}const f=new et({name:l});u.addStudent(f),u.sessions.length>0&&(fn(f,u),pn(1)),w(),ve(),o.value="",o.focus()}),a.addEventListener("click",()=>{z(),I("session-page")}),document.getElementById("new-session-btn").addEventListener("click",()=>{if(u){const l=u.sessions.find(f=>!f.isFinished&&!f.isCancelled&&!f.isDeleted);if(l){E(`⚠️ جلسه ${l.sessionNumber} هنوز تمام نشده است. لطفاً ابتدا با دکمه ✅ آن را خاتمه دهید.`);return}const h=()=>{const f=y=>{const b=u.startNewSession();Je(b),Y(b),u.students.forEach(x=>{Vt.setAttendance(x.identity.studentId,"present")}),y?($e(),I("attendance-page")):He(),w()};F("آیا تمایل به انجام فرآیند حضور و غیاب دارید؟",()=>f(!0),{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success",onCancel:()=>f(!1)})};u.hasSessionToday()?F("شما امروز یک جلسه برای این کلاس ثبت کرده‌اید. آیا از شروع یک جلسه جدید دیگر مطمئن هستید؟",h,{confirmText:"بله",confirmClass:"btn-warning"}):h()}}),n.addEventListener("click",()=>{const l=t.value.trim(),h=document.querySelector('input[name="class-type"]:checked');if(!l&&!h){E("⚠️لطفاً نام و نوع کلاس را مشخص کنید.");return}if(!l){E("⚠️لطفاً نام کلاس را وارد کنید.");return}if(!h){E("⚠️لطفاً نوع کلاس را انتخاب کنید.");return}if(B[l]){E("⚠️کلاسی با این نام از قبل وجود دارد.");return}const f=h.value,y=new Ht({name:l,type:f});B[l]=y,w(),ce(),t.value="",h.checked=!1}),e.addEventListener("input",l=>{const h=l.target.value;if(h.length<2){gt([]);return}const f=h.toLowerCase(),y=hn(f),b=[];for(const x in B){const N=B[x];if(N.isDeleted)continue;q(N.students).filter(W=>{const X=Te(W.identity.name.toLowerCase()),Ne=X.includes(Te(f)),gn=X.includes(Te(y));return Ne||gn}).forEach(W=>{b.push({student:W,classroom:N})})}gt(b)}),t.addEventListener("keyup",l=>{l.key==="Enter"&&n.click()}),s.addEventListener("click",Wn),document.querySelectorAll(".back-to-classes-btn").forEach(l=>{l.addEventListener("click",()=>{V(null),Y(null),Je(null),I("class-management-page")})}),O.addEventListener("click",()=>{He()}),le.addEventListener("click",()=>{z(),I("session-page")}),ts.addEventListener("click",()=>{_(null),I("student-page")}),Pe.addEventListener("input",l=>{const h=l.target.value;if(!h){Ge([]);return}const f=h.toLowerCase(),y=hn(f),x=q(u.students).filter(N=>{const ne=Te(N.identity.name.toLowerCase()),W=ne.includes(Te(f)),X=ne.includes(Te(y));return W||X});Ge(x)}),Pe.addEventListener("focus",()=>{Pe.value&&Ge(Pe.value)}),document.addEventListener("click",l=>{Pe.contains(l.target)||(Yn.style.display="none")}),Ae.addEventListener("click",()=>{const l=pe.value,h=de.value.trim();let f;if(Et)f=Et.student;else{const b=v==null?void 0:v.winnerHistory[re];f=b==null?void 0:b.winner}if(!f){E("❌خطا: دانش‌آموز معتبری برای ثبت نمره یافت نشد.");return}const y=oe;if(!f||!y){E("⚠️لطفاً ابتدا یک دانش‌آموز و یک دسته‌بندی را انتخاب کنید.");return}if(!l){E("⚠️لطفاً مقدار نمره را وارد کنید.");return}if(l>100||l<0){E("❌نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}f&&(f.addScore(y.name,parseFloat(l),h),w(),ie(),E(`✅نمره برای ${f.identity.name} در مهارت ${y.name} ثبت شد.`),pe.value="",de.value="",be(f,y.name))});const mn=l=>{l.key==="Enter"&&l.ctrlKey&&(l.preventDefault(),Ae.click())};pe.addEventListener("keydown",mn),de.addEventListener("keydown",mn),os.addEventListener("click",()=>{const l=ns.querySelector(".pill.active");if(!l){E("⚠️لطفاً یک مهارت را برای نمره‌دهی انتخاب کنید.");return}const h=l.dataset.skillName,f=ss.value,y=as.value.trim();if(!f){E("لطفاً مقدار نمره را وارد کنید.");return}U.addScore(h,parseFloat(f),y),w(),Z(),E(`✅نمره برای مهارت ${h} با موفقیت ثبت شد.`)}),document.getElementById("add-note-btn").addEventListener("click",()=>{U&&(Ze.value="",Ze.dispatchEvent(new Event("input",{bubbles:!0})),ue(l=>{l&&(U.addNote(l),w(),Xe())}),ee("add-note-modal"),Ze.focus())}),Xn.addEventListener("click",()=>{ae()}),Qn.addEventListener("click",()=>{const l=Ze.value.trim();typeof bt=="function"&&(bt(l),ae(),E("✅یادداشت با موفقیت ذخیره شد."))});const cs=document.getElementById("move-student-confirm-btn"),ls=document.getElementById("move-student-cancel-btn"),rs=document.getElementById("move-student-class-select");ls.addEventListener("click",()=>{ae()}),cs.addEventListener("click",()=>{const l=rs.value,h=B[l],{studentToMove:f,sourceClassForMove:y}=hs;if(!f||!y||!h){E("خطایی رخ داد. لطفاً دوباره امتحان کنید.","error"),ae();return}const b=kn(f,y,h);b.success?(w(),ve(),E(`دانش‌آموز «${f.identity.name}» با موفقیت به کلاس «${l}» منتقل شد.`)):E(b.message,"error"),ae()}),te.addEventListener("click",()=>{Q.style.width="250px",R.classList.add("modal-visible")}),Ie.addEventListener("click",Fe),R.addEventListener("click",Fe),is.addEventListener("click",()=>{J(),I("trash-page"),Fe()}),P.addEventListener("click",()=>{Fe(),rn()}),G.addEventListener("click",()=>{Le.click(),Fe()}),Le.addEventListener("change",l=>{const h=l.target.files[0];if(!h)return;const f=new FileReader;f.onload=y=>{try{const b=JSON.parse(y.target.result);F("آیا از بازیابی اطلاعات مطمئن هستید؟ تمام داده‌های فعلی شما بازنویسی خواهد شد.",()=>{Nt(b),w(),ce(),I("class-management-page"),E("✅اطلاعات با موفقیت بازیابی شد.")},{confirmText:"بازیابی کن",confirmClass:"btn-warning"})}catch{E("❌خطا در خواندن فایل. لطفاً فایل پشتیبان معتبر انتخاب کنید.")}},f.readAsText(h),l.target.value=null}),window.addEventListener("popstate",l=>{if(Ce&&history.pushState(null,"",location.href),ke(),l.state){const{pageId:h,currentClassName:f,selectedSessionNumber:y,selectedStudentId:b}=l.state;f&&(V(B[f]),y&&Y(u.getSession(y)),b&&_(u.students.find(x=>x.identity.studentId===b))),h==="student-page"?He():(h==="session-page"&&z(),_e(h))}else V(null),Y(null),_(null),_e("class-management-page")}),document.addEventListener("keydown",l=>{var y;const h=document.activeElement;if(!["INPUT","TEXTAREA","SELECT"].includes(h.tagName)){if(l.key.toLowerCase()==="o"&&l.shiftKey&&Mn.classList.contains("active")&&(l.preventDefault(),An.click()),l.key==="Escape"){if(Se.classList.contains("visible")){ke();return}if(Ce){ae();return}switch((y=document.querySelector(".page.active"))==null?void 0:y.id){case"csv-preview-page":case"column-mapping-page":I("settings-page");break;case"student-profile-page":_(null),I(v?"student-page":"session-page");break;case"attendance-page":I("student-page");break;case"student-page":Y(null),z(),I("session-page");break;case"settings-page":case"session-page":V(null),I("class-management-page");break}return}if(v){const b=l.key.toLowerCase();switch(" ascfg".includes(b)&&l.preventDefault(),b){case" ":T.click();break;case"a":$.classList.contains("active")?history.back():($e(),I("attendance-page"));break;case"s":document.getElementById("session-page").classList.contains("active")?history.back():a.click();break;case"c":document.querySelector(".back-to-classes-btn").click();break;case"f":const x=document.querySelector(".action-column .search-icon");x&&x.click();break;case"g":if(Zn.classList.contains("active"))history.back();else{const N=v.lastSelectedWinnerId;if(N){const ne=u.students.find(W=>W.identity.studentId===N);ne&&(_(ne),Z(),I("student-profile-page"))}else E("⚠️ابتدا یک نفر را انتخاب کنید تا پروفایل او نمایش داده شود.")}break;case"arrowleft":{const N=document.querySelector('button[title="برنده قبلی"]');N&&!N.disabled&&(l.preventDefault(),N.click());break}case"arrowright":{const N=document.querySelector('button[title="برنده بعدی"]');N&&!N.disabled&&(l.preventDefault(),N.click());break}}}}});function Fe(){Q.style.width="0",R.classList.add("modal-closing"),setTimeout(()=>{R.classList.remove("modal-visible","modal-closing")},300)}un(".global-search-container .animated-search-container",gt),un(".action-column-header .animated-search-container",Ge),[A,cn,de,Hn].forEach(l=>{l&&_n(l)}),es.addEventListener("click",()=>{const l=U,h=u;if(!l||!h)return;const f=document.getElementById("add-note-modal-title");f.textContent="تغییر نام دانش‌آموز",A.value=l.identity.name,A.rows=1,ue(y=>{const b=y.trim();!b||b===l.identity.name||(h.students.some(N=>!N.isDeleted&&N.identity.name.toLowerCase()===b.toLowerCase())?E("دانش‌آموزی با این نام از قبل در این کلاس وجود دارد."):(l.identity.name=b,w(),Z(),ie(),E(`✅نام دانش‌آموز به «${b}» تغییر یافت.`))),f.textContent="ثبت یادداشت جدید",A.rows=4}),ee("add-note-modal"),A.focus(),A.select()});function fn(l,h){const f=q(h.students).filter(D=>D.identity.studentId!==l.identity.studentId);if(f.length===0)return;let y=0;const b=q(h.categories);b.forEach(D=>{const se=Math.max(0,...f.map(qe=>qe.categoryCounts[D.name]||0));l.categoryCounts[D.name]=se,y+=se}),l.statusCounters.totalSelections=y;const x=f.reduce((D,se)=>D+se.statusCounters.totalSelections,0),N=f.reduce((D,se)=>D+(se.statusCounters.missedChances||0),0),ne=x>0?N/x:0,W={};b.forEach(D=>{const se=f.reduce((Dt,Mt)=>Dt+(Mt.categoryCounts[D.name]||0),0),qe=f.reduce((Dt,Mt)=>Dt+(Mt.categoryIssues[D.name]||0),0);W[D.name]=se>0?qe/se:0}),l.statusCounters.missedChances=Math.round(l.statusCounters.totalSelections*ne),b.forEach(D=>{const se=l.categoryCounts[D.name]||0,qe=W[D.name]||0;l.categoryIssues[D.name]=Math.round(se*qe)});const X=q(h.sessions).filter(D=>!D.isCancelled&&D.isFinished);X.forEach(D=>{D.setAttendance(l.identity.studentId,"absent")});const Ne="📝 یادداشت خودکار سیستم",fs=`این دانش‌آموز پس از جلسه شماره ${X.length} به کلاس اضافه شد. آمار پایه‌ای زیر برای حفظ تعادل الگوریتم انتخاب برای او ثبت گردید:`,Be=[];l.statusCounters.totalSelections>0&&Be.push(`کل انتخاب‌ها: ${l.statusCounters.totalSelections}`),l.statusCounters.missedChances>0&&Be.push(`فرصت‌های از دست رفته: ${l.statusCounters.missedChances}`);for(const D in l.categoryCounts)l.categoryCounts[D]>0&&Be.push(`انتخاب در «${D}»: ${l.categoryCounts[D]}`);for(const D in l.categoryIssues)l.categoryIssues[D]>0&&Be.push(`مشکل در «${D}»: ${l.categoryIssues[D]}`);if(Be.length>0){const D=`${Ne}
${fs}

- ${Be.join(`
- `)}`;l.addNote(D)}}function pn(l){const f=`چون این کلاس جلسات برگزار شده دارد، برای ${l>1?"دانش‌آموزان جدید":"دانش‌آموز جدید"} آمار پایه‌ای (متناسب با سایر دانش‌آموزان) ثبت شد تا در فرایند انتخاب اختلالی ایجاد نشود.`;F(f,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}const ds="3.21.1";document.getElementById("app-version").textContent=`نسخه ${ds}`;function us(){console.log("Starting universal backfill for writing scores...");let l=0;for(const h in B){const f=B[h];if(f.isDeleted)continue;let y=0;q(f.students).forEach(x=>{const N=x.logs.scores;if(!(N&&N.writing&&N.writing.length>0)){let W=-1;for(const X in N)X!=="writing"&&N[X].forEach(Ne=>{Ne.value>W&&(W=Ne.value)});if(W>-1){const X=`Automatically assigned based on the highest score (${W}) from other skills.`;x.addScore("Writing",W,X),y++}}}),y>0&&(console.log(`Updated ${y} student(s) in class: ${f.info.name}.`),l+=y)}l>0?(w(),console.log(`Update complete. A total of ${l} student(s) were updated across all classes. Data saved.`),document.getElementById("student-page").classList.contains("active")&&ie()):console.log("No students needed updating in any class.")}window.backfillWritingScoresForAll=us;function ms(){console.log("Starting backfill for 'outOfClassCount' and 'wasOutOfClass' properties...");let l=0,h=0;const f=localStorage.getItem("teacherAssistantData_v2");if(!f){console.log("No data found in localStorage. Nothing to do.");return}const y=JSON.parse(f);for(const b in y){const x=y[b];x.students&&x.students.forEach(N=>{N.statusCounters&&typeof N.statusCounters.outOfClassCount>"u"&&(N.statusCounters.outOfClassCount=0,l++)}),x.sessions&&x.sessions.forEach(N=>{if(N.studentRecords)for(const ne in N.studentRecords){const W=N.studentRecords[ne];typeof W.wasOutOfClass>"u"&&(W.wasOutOfClass=!1,h++)}})}localStorage.setItem("teacherAssistantData_v2",JSON.stringify(y)),console.log(`Backfill complete. Updated ${l} students and ${h} session records. Data saved.`),At(),u&&ie()}window.backfillExitCounters=ms});
