(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(a){if(a.ep)return;a.ep=!0;const o=t(a);fetch(a.href,o)}})();class pt{constructor(n){this.identity={name:n.name,studentId:n.studentId||`id_${new Date().getTime()}_${Math.random()}`,branchName:n.branchName||null,ageGroup:n.ageGroup||"adult",level:n.level||null,contact:{social:n.socialContact||null,parent:n.parentContact||null}},this.isDeleted=!1,this.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0,outOfClassCount:0},this.categoryCounts={},this.categoryIssues={},this.logs={parentContacts:[],scores:{},discipline:{},sessionHistory:{}},this.profile={notes:[],tags:[]},this.finalClassActivityScore=null,this.onboardingSession=null}addScore(n,t,s){if(t>100||t<0){console.log("نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}const a=n.toLowerCase();this.logs.scores[a]||(this.logs.scores[a]=[]);const o=new Co(n,t,s);this.logs.scores[a].push(o)}addNote(n,t=null){const s=new vo(n,t);this.profile.notes.push(s)}getOverallAverageScore(){let n=0,t=0;for(const a in this.logs.scores)this.logs.scores[a].forEach(o=>{o.isDeleted||(n+=o.value,t++)});if(t===0)return null;const s=n/t;return Math.round(s*100)/100}}class Co{constructor(n,t,s=""){this.id=`score_${new Date().getTime()}`,this.skill=n,this.value=t,this.timestamp=new Date,this.comment=s,this.isDeleted=!1}}class vo{constructor(n,t=null){this.id=`note_${new Date().getTime()}`,this.timestamp=new Date,this.content=n,this.isDeleted=!1,this.source=t}}class Kt{constructor(n="complete",t=""){this.status=n,this.comment=t,this.timestamp=new Date}}class Kn{constructor(n){this.sessionNumber=n,this.startTime=new Date,this.note="",this.isDeleted=!1,this.endTime=null,this.isFinished=!1,this.isMakeup=!1,this.isCancelled=!1,this.studentRecords={},this.lastWinnerByCategory={},this.lastUsedCategoryId=null,this.lastSelectedWinnerId=null,this.winnerHistory=[]}end(){this.isFinished=!0,this.endTime=new Date}markAsMakeup(){this.isMakeup=!this.isMakeup}initializeStudentRecord(n){this.studentRecords[n]||(this.studentRecords[n]={attendance:"present",homework:new Kt,selections:{},hadIssue:!1,wasOutOfClass:!1})}setAttendance(n,t){this.initializeStudentRecord(n),this.studentRecords[n].attendance=t}setHomeworkStatus(n,t){this.initializeStudentRecord(n),this.studentRecords[n].homework.status=t}selectNextWinner(n,t,s){if(!t||t.length===0)return console.log("هیچ دانش‌آموزی در کلاس برای انتخاب وجود ندارد."),null;const a=this.lastWinnerByCategory[n];let o=t.filter(u=>u.identity.studentId!==a&&!u.isDeleted);if(o.length===0&&(o=t),o.length===0)return null;const r=(u,p)=>u.categoryCounts[p]||0,d=Math.min(...o.map(u=>r(u,n))),c=o.filter(u=>r(u,n)===d);let h;if(c.length===1)h=c[0];else if(c.length>1){const u=s.filter(k=>!k.isDeleted&&k.name!==n).map(k=>k.name),p=c.map(k=>{const M=u.reduce((F,$)=>F+r(k,$),0);return{student:k,otherCategoriesTotal:M}}),b=Math.min(...p.map(k=>k.otherCategoriesTotal)),S=p.filter(k=>k.otherCategoriesTotal===b).map(k=>k.student);S.length===1?h=S[0]:h=S[Math.floor(Math.random()*S.length)]}else h=o[Math.floor(Math.random()*o.length)];const v=h.identity.studentId;this.initializeStudentRecord(v);const B=(this.studentRecords[v].selections[n]||0)+1;return this.studentRecords[v].selections[n]=B,h.statusCounters.totalSelections++,h.categoryCounts[n]=(h.categoryCounts[n]||0)+1,this.lastWinnerByCategory[n]=v,h}}class Qt{constructor(n){this.info={name:n.name||"NotNamed",scheduleCode:n.scheduleCode||`code_${new Date().getTime()}`,teacherName:n.teacherName||null,type:n.type||"in-person",term:n.term||null,scheduleText:n.scheduleText||null,level:n.level||null,creationDate:n.creationDate?new Date(n.creationDate):new Date},this.students=[],this.sessions=[],this.note="",this.isDeleted=!1,this.categories=[new ve("Vocabulary","Questions about words and meanings."),new ve("Grammar","Questions about sentence structure and rules."),new ve("Listening",void 0,!0),new ve("Speaking",void 0,!0),new ve("Reading",void 0,!0),new ve("Writing",void 0,!0)],this.futurePlans={}}addStudent(n){this.students.push(n)}removeStudent(n){this.students=this.students.filter(t=>t.identity.studentId!==n)}startNewSession(){const n=this.sessions.length+1,t=new Kn(n);return this.sessions.push(t),t}endSpecificSession(n){const t=this.getSession(n);return t&&!t.isFinished?(t.end(),!0):!1}getSession(n){return this.sessions.find(t=>t.sessionNumber===n)}markAsMakeup(n){const t=this.getSession(n);t&&t.markAsMakeup()}planForSession(n,t){this.futurePlans[n]=t}hasSessionToday(){const n=new Date().toDateString();return this.sessions.some(t=>!t.isDeleted&&t.startTime.toDateString()===n)}selectNextWinner(n,t){return t?t.selectNextWinner(n,this.students,this.categories):null}get liveSession(){for(let n=this.sessions.length-1;n>=0;n--)if(!this.sessions[n].isFinished)return this.sessions[n];return null}endLiveSession(){const n=this.liveSession;return n?(n.end(),!0):!1}calculateFinalStudentScore(n){const t=n.logs.scores,s=["reading","writing"];for(const u of s)if(!t[u]||t[u].length===0)return null;const a=t.listening&&t.listening.length>0,o=t.speaking&&t.speaking.length>0;if(!a&&!o)return null;const r=u=>t[u].reduce((b,S)=>b+S.value,0)/t[u].length;let d;a&&o?d=(r("listening")+r("speaking"))/2:a?d=r("listening"):d=r("speaking");const c=r("reading"),h=r("writing"),B=(d*3+c*2+h*1)/6;return Math.trunc(B*10)/10}assignAllFinalScores(){let n=0,t=[];console.log("شروع عملیات محاسبه نمره نهایی برای تمام دانش‌آموزان..."),this.students.forEach(a=>{const o=this.calculateFinalStudentScore(a);o!==null?(a.finalClassActivityScore=o,n++):(a.finalClassActivityScore=null,t.push(a.identity.name))});const s=t.length;console.log(`عملیات پایان یافت. تعداد نمرات موفق: ${n} | تعداد ناموفق (نمرات ناقص): ${s}`),s>0&&(console.log("اسامی دانش‌آموزانی که نمراتشان ناقص است:"),t.forEach(a=>console.log(`- ${a}`)))}}class ve{constructor(n,t="",s=!1){this.id=`cat_${new Date().getTime()}_${Math.random()}`,this.name=n,this.description=t,this.isDeleted=!1,this.isGradedCategory=s,this.isDeleted=!1}}let N={},l=null,gn=null,y=null,O=null,nt=null,Pt=null,hn=[],wt=null,yn=null,le=null,Nt=0,Cn=0,Bt=0,vn=0,En=null,bn=null,Tt=null,Le=null,ue=-1,xt=null,Dt=null,Mt=null,Qn=null,Xn=null,fe=!1,x=[],Ae=[],we={isScreenSaverEnabled:!0};function w(){if(fe)return;const e={classrooms:N,trashBin:x,userSettings:we};localStorage.setItem("teacherAssistantData_v2",JSON.stringify(e))}function Yn(){const n=JSON.stringify({classrooms:N,trashBin:x},null,2),s=`SP-${new Date().toLocaleDateString("fa-IR-u-nu-latn").replace(/\//g,"-")}.txt`;return new File([n],s,{type:"text/plain"})}function $t(){const e=localStorage.getItem("teacherAssistantData_v2");if(!e)return;const n=JSON.parse(e);n.classrooms?(qe(n.classrooms),x=n.trashBin||[],we={...we,...n.userSettings}):(qe(n),Eo())}function Eo(){const e=[];Object.values(N).forEach(n=>{n.isDeleted?e.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:n.info.creationDate,type:"classroom",description:`کلاس «${n.info.name}»`,restoreData:{name:n.info.name}}):n.students.forEach(t=>{t.isDeleted&&e.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:t.identity.studentId.split("_")[1],type:"student",description:`دانش‌آموز «${t.identity.name}»`,restoreData:{studentId:t.identity.studentId,classroomName:n.info.name}})})}),x.length===0&&e.length>0&&(x=e,console.log(`Migrated ${e.length} previously deleted item(s) to the new trash bin.`),w())}function qe(e){N={};for(const n in e){const t=e[n],s=new Qt(t.info);s.isDeleted=t.isDeleted,s.note=t.note||"",s.students=t.students.map(a=>{const o=new pt(a.identity);return o.isDeleted=a.isDeleted,o.statusCounters=a.statusCounters,o.logs=a.logs,o.logs.scores||(o.logs.scores={}),o.profile=a.profile,o.finalClassActivityScore=a.finalClassActivityScore,o.categoryCounts=a.categoryCounts||{},o.categoryIssues=a.categoryIssues||{},o.onboardingSession=a.onboardingSession||null,o}),s.sessions=t.sessions.map(a=>{const o=new Kn(a.sessionNumber);o.isDeleted=a.isDeleted,o.note=a.note||"",o.startTime=new Date(a.startTime),o.endTime=a.endTime?new Date(a.endTime):null,o.isFinished=a.isFinished,o.isMakeup=a.isMakeup,o.isCancelled=a.isCancelled||!1,o.studentRecords=a.studentRecords;for(const d in o.studentRecords){const c=o.studentRecords[d];c.homework&&!(c.homework instanceof Kt)&&(o.studentRecords[d].homework=new Kt(c.homework.status,c.homework.comment))}o.lastWinnerByCategory=a.lastWinnerByCategory,o.lastUsedCategoryId=a.lastUsedCategoryId,o.lastSelectedWinnerId=a.lastSelectedWinnerId;const r=a.winnerHistory||[];return o.winnerHistory=r.map(d=>({winner:s.students.find(h=>h.identity.studentId===d.winner.identity.studentId),categoryName:d.categoryName})),o}),s.categories=t.categories.map(a=>{const o=new ve(a.name,a.description,a.isGradedCategory);return o.id=a.id,o.isDeleted=a.isDeleted,o}),s.futurePlans=t.futurePlans,N[n]=s}}function Zn(e,n){if(N[n])return{success:!1,message:"کلاسی با این نام از قبل وجود دارد."};const t=N[e];return t?(t.info.name=n,N[n]=t,delete N[e],l===t&&Z(t),{success:!0}):{success:!1,message:"کلاس مورد نظر یافت نشد."}}function es(e,n,t){const s=t.trim();if(!s)return{success:!1,message:"نام دسته‌بندی نمی‌تواند خالی باشد."};if(e.categories.some(c=>c.id!==n.id&&!c.isDeleted&&c.name.toLowerCase()===s.toLowerCase()))return{success:!1,message:"دسته‌بندی دیگری با این نام وجود دارد."};const o=n.name,r=o.toLowerCase(),d=s.toLowerCase();return n.name=s,e.students.forEach(c=>{c.categoryCounts&&c.categoryCounts[o]!==void 0&&(c.categoryCounts[s]=c.categoryCounts[o],delete c.categoryCounts[o]),c.categoryIssues&&c.categoryIssues[o]!==void 0&&(c.categoryIssues[s]=c.categoryIssues[o],delete c.categoryIssues[o]),c.logs.scores&&c.logs.scores[r]&&(c.logs.scores[r].forEach(h=>h.skill=s),r!==d&&(c.logs.scores[d]=c.logs.scores[r],delete c.logs.scores[r]))}),e.sessions.forEach(c=>{c.lastWinnerByCategory&&c.lastWinnerByCategory[o]&&(c.lastWinnerByCategory[s]=c.lastWinnerByCategory[o],delete c.lastWinnerByCategory[o]),c.winnerHistory&&c.winnerHistory.forEach(h=>{h.categoryName===o&&(h.categoryName=s)})}),{success:!0}}function ts(e,n,t){if(P(t.students).some(r=>r.identity.name.toLowerCase()===e.identity.name.toLowerCase()))return{success:!1,message:`دانش‌آموزی با نام «${e.identity.name}» از قبل در کلاس «${t.info.name}» وجود دارد.`};const a=JSON.parse(JSON.stringify(e));t.addStudent(a);const o=n.students.find(r=>r.identity.studentId===e.identity.studentId);return o&&st(o,n),{success:!0}}function ns(){for(const e in N){const n=N[e];n.students.forEach(t=>{t.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0},t.categoryCounts={},t.categoryIssues={},n.sessions.forEach(s=>{const a=t.identity.studentId;s.studentRecords[a]&&(s.studentRecords[a].attendance="present")})})}w()}function P(e){return Array.isArray(e)?e.filter(n=>!n.isDeleted):[]}function pe(e){const n=new Map;return e&&P(e.sessions).filter(s=>!s.isCancelled).sort((s,a)=>s.sessionNumber-a.sessionNumber).forEach((s,a)=>{n.set(s.sessionNumber,a+1)}),n}function $e(e){ue=e}function ge(e){xt=e}function st(e,n){if(!e||!n)return;const t=e.identity.studentId,s=n.students.findIndex(a=>a.identity.studentId===t);s>-1&&n.students.splice(s,1),n.sessions.forEach(a=>{a.studentRecords[t]&&delete a.studentRecords[t]})}function ss(e,n){const t=N[e];if(!t)return;const s=t.sessions.findIndex(a=>a.sessionNumber===n);s>-1&&t.sessions.splice(s,1)}function os(e,n){const t=N[e];if(!t)return;const s=t.categories.findIndex(d=>d.id===n);if(s===-1)return;const o=t.categories[s].name,r=o.toLowerCase();t.students.forEach(d=>{d.categoryCounts&&delete d.categoryCounts[o],d.categoryIssues&&delete d.categoryIssues[o],d.logs.scores&&delete d.logs.scores[r]}),t.categories.splice(s,1)}function as(e,n,t,s){const a=N[e];if(!a)return;const o=a.students.find(c=>c.identity.studentId===n);if(!o||!o.logs.scores[t.toLowerCase()])return;const r=o.logs.scores[t.toLowerCase()],d=r.findIndex(c=>c.id===s);d>-1&&r.splice(d,1)}function is(e,n,t){const s=N[e];if(!s)return;const a=s.students.find(r=>r.identity.studentId===n);if(!a||!a.profile.notes)return;const o=a.profile.notes.findIndex(r=>r.id===t);o>-1&&a.profile.notes.splice(o,1)}function cs(){JSON.parse(JSON.stringify({classrooms:N,trashBin:x})),fe=!0}function rs(){fe=!1,$t()}function Z(e){l=e}function ot(e){gn=e}function ne(e){y=e}function j(e){O=e}function Ot(e){nt=e}function ls(e){Pt=e}function je(e){hn=e}function gt(e){wt=e}function ds(e){yn=e}function Sn(e){le=e}function ht(e){Nt=e}function us(e){Cn=e}function yt(e){Bt=e}function ms(e){vn=e}function In(e){En=e}function Ln(e){bn=e}function at(e){Tt=e}function kn(e){Le=e}function At(e){Mt=e}function fs(e){Qn=e}function ps(e){Xn=e}function Xt(e){x=e}function Wt(e){Dt=e}function Ht(e){Ae=e}function Yt(e){we={...we,...e},w()}const bo=Object.freeze(Object.defineProperty({__proto__:null,get activeModal(){return Le},get cancelCallback(){return bn},get classrooms(){return N},get confirmCallback(){return En},get currentClassroom(){return l},get easterEggClickCount(){return Nt},get easterEggLastClickTime(){return Cn},enterDemoMode:cs,exitDemoMode:rs,getActiveItems:P,getSessionDisplayMap:pe,get importedFileContent(){return wt},get isDemoMode(){return fe},get liveSession(){return gn},loadData:$t,get manualSelection(){return Mt},moveStudent:ts,get namesToImport(){return hn},get notificationTimeout(){return yn},permanentlyDeleteCategory:os,permanentlyDeleteNote:is,permanentlyDeleteScore:as,permanentlyDeleteSession:ss,permanentlyDeleteStudent:st,prepareBackupData:Yn,get previousState(){return nt},rehydrateData:qe,renameCategory:es,renameClassroom:Zn,resetAllStudentCounters:ns,get resetEasterEggClickCount(){return Bt},get resetEasterEggLastClickTime(){return vn},get saveCategoryCallback(){return Dt},saveData:w,get saveNoteCallback(){return xt},get secureConfirmCallback(){return Tt},get selectedCategory(){return le},get selectedSession(){return y},get selectedStudentForProfile(){return O},get selectedStudentsForMassComment(){return Ae},setActiveModal:kn,setCancelCallback:Ln,setConfirmCallback:In,setCurrentClassroom:Z,setEasterEggClickCount:ht,setEasterEggLastClickTime:us,setImportedFileContent:gt,setLiveSession:ot,setManualSelection:At,setNamesToImport:je,setNotificationTimeout:ds,setPreviousState:Ot,setResetEasterEggClickCount:yt,setResetEasterEggLastClickTime:ms,setSaveCategoryCallback:Wt,setSaveNoteCallback:ge,setSecureConfirmCallback:at,setSelectedCategory:Sn,setSelectedSession:ne,setSelectedStudentForProfile:j,setSelectedStudentsForMassComment:Ht,setSourceClassForMove:ps,setStudentToMove:fs,setTrashBin:Xt,setUndoTimeout:ls,setUserSettings:Yt,setWinnerHistoryIndex:$e,get sourceClassForMove(){return Xn},get studentToMove(){return Qn},get trashBin(){return x},get undoTimeout(){return Pt},get userSettings(){return we},get winnerHistoryIndex(){return ue}},Symbol.toStringTag,{value:"Module"}));function ye(e){return typeof e!="string"?"":e.replace(/ي/g,"ی").replace(/ك/g,"ک").replace(/[\s\u200c]/g,"")}function it(e){return typeof e!="string"||e.length===0?"ltr":/[\u0590-\u07FF]/.test(e)?"rtl":"ltr"}function gs(e){return!e||!e.trim()?"":e.split(`
`).map(s=>`<div dir="${it(s)}">${s||"&nbsp;"}</div>`).join("")}function Jt(e){if(typeof e!="string")return"";const n={q:"ض",w:"ص",e:"ث",r:"ق",t:"ف",y:"غ",u:"ع",i:"ه",o:"خ",p:"ح","[":"ج","]":"چ",a:"ش",s:"س",d:"ی",f:"ب",g:"ل",h:"ا",j:"ت",k:"ن",l:"م",";":"ک","'":"گ",z:"ظ",x:"ط",c:"ز",v:"ر",b:"ذ",n:"د",m:"پ",",":"و"};let t="";for(let s=0;s<e.length;s++){const a=e[s].toLowerCase();t+=n[a]||e[s]}return t}const hs="teacherAssistantLogs_v2",So=100;function wn(){try{const e=localStorage.getItem(hs);return e?JSON.parse(e):{}}catch(e){return console.error("Error reading logs from localStorage:",e),{}}}function ys(e){try{localStorage.setItem(hs,JSON.stringify(e))}catch(n){console.error("Error saving logs to localStorage:",n)}}function R(e,n,t=null){if(!e)return;const s=wn();s[e]||(s[e]=[]);const a={timestamp:new Date().toISOString(),message:n,action:t,classroomName:e};s[e].unshift(a),s[e].length>So&&s[e].pop(),ys(s)}function Io(e){return wn()[e]||[]}function Lo(e,n){const t=wn();t[e]&&!t[n]&&(t[n]=t[e],delete t[e],ys(t))}const Cs=document.getElementById("class-management-page"),ko=document.getElementById("new-class-name"),wo=document.getElementById("add-class-btn"),Zt=document.getElementById("class-list"),Rt=document.getElementById("undo-toast"),vs=document.getElementById("undo-message"),No=document.getElementById("undo-btn"),Bo=document.getElementById("settings-page"),Nn=document.getElementById("settings-class-name-header"),en=document.getElementById("settings-student-list"),tn=document.getElementById("category-list"),To=document.getElementById("back-to-sessions-btn"),xo=document.getElementById("new-student-name"),Do=document.getElementById("add-student-btn"),Es=document.getElementById("paste-area"),Mo=document.getElementById("process-paste-btn"),$o=document.getElementById("csv-preview-page"),nn=document.getElementById("csv-preview-list"),Oo=document.getElementById("csv-confirm-btn"),Ao=document.getElementById("csv-cancel-btn"),Ho=document.getElementById("import-csv-btn"),Ro=document.getElementById("csv-file-input"),_o=document.getElementById("column-mapping-page"),sn=document.getElementById("column-select-dropdown"),Po=document.getElementById("confirm-column-btn"),Wo=document.getElementById("cancel-import-btn"),Fo=document.getElementById("new-category-name"),qo=document.getElementById("add-category-btn"),on=document.querySelector(".app-header"),ke=document.getElementById("select-student-btn"),ct=document.getElementById("select-student-btn-wrapper"),Uo=document.getElementById("attendance-page"),Xe=document.getElementById("attendance-list"),Vo=document.getElementById("finish-attendance-btn"),Go=document.getElementById("back-to-sessions-from-attendance-btn"),zo=document.getElementById("back-to-attendance-btn"),jo=document.querySelector("#class-management-page h2"),an=document.getElementById("student-stats-header"),Jo=document.getElementById("hamburger-menu-btn"),Ko=document.getElementById("side-nav-menu"),Qo=document.getElementById("close-nav-btn"),Xo=document.getElementById("overlay"),Yo=document.getElementById("backup-data-btn"),Zo=document.getElementById("restore-data-btn"),bs=document.getElementById("restore-file-input"),ea=document.getElementById("custom-confirm-modal"),Ss=document.getElementById("confirm-modal-message"),cn=document.getElementById("confirm-modal-cancel-btn"),Je=document.getElementById("confirm-modal-confirm-btn"),ta=document.getElementById("secure-confirm-modal"),Is=document.getElementById("secure-confirm-message"),Ls=document.getElementById("secure-confirm-code"),Pe=document.getElementById("secure-confirm-input"),na=document.getElementById("secure-confirm-cancel-btn"),Ct=document.getElementById("secure-confirm-confirm-btn"),sa=document.getElementById("add-note-modal"),W=document.getElementById("new-note-content"),oa=document.getElementById("class-save-note-btn"),aa=document.getElementById("cancel-note-btn"),rn=document.getElementById("student-search-input"),Se=document.getElementById("student-search-results"),ia=document.getElementById("student-profile-page"),ks=document.getElementById("profile-student-name-header"),ca=document.getElementById("back-to-student-page-btn"),We=document.getElementById("graded-category-pills-container"),ln=document.getElementById("new-score-value"),Bn=document.getElementById("new-score-comment"),ra=document.getElementById("add-score-btn"),Ke=document.getElementById("profile-stats-summary"),vt=document.getElementById("profile-scores-list"),Et=document.getElementById("global-student-search-input"),Ce=document.getElementById("global-student-search-results"),la=document.getElementById("is-graded-checkbox"),da=document.getElementById("trashed-classes-list"),ua=document.getElementById("trashed-students-list"),ma=document.getElementById("trashed-sessions-list"),fa=document.getElementById("trashed-categories-list"),pa=document.getElementById("trashed-notes-list"),ga=document.getElementById("trashed-scores-list"),_t=document.getElementById("quick-grade-form-wrapper"),Ee=document.getElementById("quick-score-input"),me=document.getElementById("quick-note-textarea"),Ue=document.getElementById("quick-grade-submit-btn"),Ye=document.getElementById("category-selection-container"),ws=document.getElementById("selected-student-result"),Oe=document.getElementById("custom-context-menu"),Fe=document.getElementById("breadcrumb-container"),ha=document.getElementById("category-modal"),Ns=document.getElementById("category-modal-title"),Ze=document.getElementById("new-category-modal-name"),Tn=document.getElementById("new-category-modal-is-graded"),ya=document.getElementById("category-modal-cancel-btn"),Bs=document.getElementById("category-modal-save-btn"),Ca=document.getElementById("mass-comment-modal"),va=document.getElementById("mass-comment-modal-title"),Ts=document.getElementById("mass-comment-student-count-message"),et=document.getElementById("mass-comment-content"),xn=document.getElementById("mass-comment-append-checkbox"),Ea=document.getElementById("mass-comment-cancel-btn"),ba=document.getElementById("mass-comment-save-btn"),dn=document.getElementById("mass-comment-btn"),bt=document.getElementById("attendance-mass-actions-container"),xe=document.createElement("input");function Sa(e){clearTimeout(Pt),nt||Ot(JSON.stringify(N)),vs.textContent=e,Rt.classList.add("show"),ls(setTimeout(()=>{Rt.classList.remove("show"),Ot(null)},5e3))}function xs(){if(nt){const e=l?l.info.name:null,n=JSON.parse(nt);qe(n),e&&N[e]?Z(N[e]):Z(null),l?(be(),Ve(),Q()):re(),Rt.classList.remove("show"),clearTimeout(Pt),Ot(null)}}function C(e,n=3e3){const t=document.getElementById("notification-toast");t&&(t.textContent=e,t.classList.add("show"),clearTimeout(yn),ds(setTimeout(()=>{t.classList.remove("show")},n)))}function U(e,n,t={}){const{confirmText:s="تایید",cancelText:a="لغو",confirmClass:o="btn-success",onCancel:r=()=>{},isDelete:d=!1}=t,c=d?()=>Ds(e,n):n;Ss.textContent=e,Je.textContent=s,cn.textContent=a,Je.className="modal-action-btn",Je.classList.add(o),In(c),Ln(r);const h=Je.parentElement;cn.style.display=r===null?"none":"inline-block",h.style.justifyContent=r===null?"center":"space-between",te("custom-confirm-modal")}function Ds(e,n){const t=Math.floor(1e4+Math.random()*9e4).toString();Is.textContent=e,Ls.textContent=t,Pe.value="",Ct.disabled=!0,at(n),te("secure-confirm-modal"),Pe.focus();const s=()=>{Pe.value===t?Ct.disabled=!1:Ct.disabled=!0};return Pe.addEventListener("input",s),()=>{Pe.removeEventListener("input",s)}}function un(e,n={}){const{title:t="ایجاد دسته‌بندی جدید",initialName:s="",initialIsGraded:a=!1,saveButtonText:o="ذخیره"}=n;Ns.textContent=t,Ze.value=s,Tn.checked=a,Bs.textContent=o,Wt((r,d)=>{if(!r){C("⚠️ لطفاً نام دسته‌بندی را وارد کنید.");return}e(r,d),z()}),te("category-modal"),Ze.focus(),s&&Ze.select()}function Ms(e,n){const t=Object.values(N).filter(r=>!r.isDeleted&&r.info.name!==n.info.name),s=document.getElementById("move-student-modal-title"),a=document.getElementById("move-student-class-select"),o=document.getElementById("move-student-confirm-btn");s.textContent=`انتقال دانش‌آموز: ${e.identity.name}`,a.innerHTML="",t.length===0?(a.innerHTML='<option value="">کلاس دیگری برای انتقال وجود ندارد</option>',o.disabled=!0):(t.forEach(r=>{const d=document.createElement("option");d.value=r.info.name,d.textContent=r.info.name,a.appendChild(d)}),o.disabled=!1),fs(e),ps(n),te("move-student-modal")}function Dn(e,n){if(!e||!n)return;const t=e.identity.name,s=document.getElementById("add-note-modal-title");s.textContent="تغییر نام دانش‌آموز",W.value=t,W.rows=1,W.dispatchEvent(new Event("input",{bubbles:!0})),ge(a=>{const o=a.trim();o&&o!==t&&(P(n.students).some(d=>d.identity.studentId!==e.identity.studentId&&d.identity.name.toLowerCase()===o.toLowerCase())?C("دانش‌آموزی با این نام از قبل در این کلاس وجود دارد."):(e.identity.name=o,R(n.info.name,`نام دانش‌آموز «${t}» به «${o}» تغییر یافت.`,{type:"VIEW_STUDENT_PROFILE",studentId:e.identity.studentId}),w(),be(),se(),O&&O.identity.studentId===e.identity.studentId&&oe(),C(`✅نام دانش‌آموز به «${o}» تغییر یافت.`))),s.textContent="ثبت یادداشت جدید",W.rows=4}),te("add-note-modal"),W.focus(),W.select()}function te(e){const n=document.getElementById(e);if(n){if(Le)return;n.classList.add("modal-visible"),kn(e),history.pushState(null,"",location.href)}}function z(e){if(!Le)return;const n=document.getElementById(Le),t=Le;kn(null),history.back(),n&&(n.classList.add("modal-closing"),setTimeout(()=>{n.classList.remove("modal-visible"),n.classList.remove("modal-closing"),t==="custom-confirm-modal"&&(In(null),Ln(null)),t==="secure-confirm-modal"&&at(null),t==="category-modal"&&Wt(null),t==="mass-comment-modal"&&(et.value=""),t==="add-note-modal"&&ge(null),typeof e=="function"&&e()},300))}function Mn(){var n;if(((n=document.querySelector(".page.active"))==null?void 0:n.id)!=="attendance-page"){bt.style.display="none";return}const e=Ae.length;e<1?bt.style.display="none":bt.style.display="block",dn.disabled=e<1,dn.textContent=`📝 ثبت یادداشت گروهی (${e} نفر)`}function $s(){const e=Ae,n=e.length;let t=!1;n>0&&(t=e.some(a=>{var o;return(o=y.studentRecords[a])==null?void 0:o.homework.comment})),Ts.textContent=`یادداشت برای ${n} دانش‌آموز ثبت خواهد شد.`,et.value="",et.dispatchEvent(new Event("input",{bubbles:!0})),xn.checked=!0;const s=document.querySelector("#mass-comment-modal .modal-options");s.style.display=t?"flex":"none",te("mass-comment-modal"),et.focus()}function mn(e,n){if(!l||!y)return;let t=0;const s=Ae,a=y;s.forEach(o=>{const r=a.studentRecords[o];if(r&&r.homework){const d=r.homework.comment||"";let c=e;n&&d.length>0?c=d+`
---
`+e:c=e,r.homework.comment=c.trim();const h=l.students.find(v=>v.identity.studentId===o);h&&Ia(h,a,c.trim()),t++}}),Ht([]),w(),Ie(),R(l.info.name,`${t} دانش‌آموز به صورت گروهی یادداشت تکلیف گرفتند.`,{type:"VIEW_SESSIONS"}),C(`✅ یادداشت برای ${t} دانش‌آموز ثبت شد.`)}function Ia(e,n,t){const a=pe(l).get(n.sessionNumber),o={type:"fromAttendance",sessionNumber:n.sessionNumber},r=`یادداشت مربوط به جلسه ${a}: `,d=e.profile.notes.find(c=>!c.isDeleted&&c.source&&c.source.type==="fromAttendance"&&c.source.sessionNumber===o.sessionNumber);d?t?(d.content=r+t,d.isDeleted=!1):d.isDeleted=!0:t&&e.addNote(r+t,o)}function $n(e){W.value=e.note||"",ge(n=>{e.note=n,w(),R(e.info.name,"یادداشت کلاس ذخیره شد.",{type:"VIEW_CLASS_NOTE"}),re(),C("✅ یادداشت کلاس ذخیره شد.")}),te("add-note-modal"),W.focus()}function On(e){Z(e),Nn.textContent=`تنظیمات کلاس: ${e.info.name}`,be(),Ve(),L("settings-page")}function Os(e){const n=document.getElementById("log-modal-title"),t=document.getElementById("log-list");n.textContent=`گزارش فعالیت‌های کلاس: ${e}`,t.innerHTML="";const s=Io(e);s.length===0?t.innerHTML='<li class="no-content-message">هنوز فعالیتی برای این کلاس ثبت نشده است.</li>':s.forEach(a=>{const o=document.createElement("li");o.className="log-entry";const r=new Date(a.timestamp),d=`${r.toLocaleDateString("fa-IR")} - ${r.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}`,c=document.createElement("span");c.className="log-timestamp",c.textContent=d;const h=document.createElement("span");h.className="log-message",h.textContent=a.message,a.action&&(h.classList.add("log-action-link"),h.dataset.action=JSON.stringify({...a.action,classroomName:a.classroomName})),o.appendChild(c),o.appendChild(h),t.appendChild(o)}),te("log-modal")}document.getElementById("log-modal-close-btn").addEventListener("click",()=>{z()});function fn(e){const n=URL.createObjectURL(e),t=document.createElement("a");t.href=n,t.download=e.name,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(n)}async function An(){const e=Yn();if(("ontouchstart"in window||navigator.maxTouchPoints>0)&&navigator.share&&navigator.canShare&&navigator.canShare({files:[e]}))try{await navigator.share({title:"پشتیبان دستیار معلم",text:"فایل پشتیبان داده‌های برنامه",files:[e]})}catch(t){t.name!=="AbortError"&&(console.error("Error sharing file:",t),fn(e),C("⚠️اشتراک‌گذاری با خطا مواجه شد. فایل در حال دانلود است."))}else fn(e),C("✅پشتیبان‌گیری با موفقیت انجام شد.")}function dt(e,n){e.preventDefault(),De(),setTimeout(()=>{const t=Oe,s=t.querySelector("ul");s.innerHTML="",n.forEach(v=>{const B=document.createElement("li");v.isSeparator?B.className="separator":(B.innerHTML=`
                    <span class="icon">${v.icon||""}</span>
                    <span class="label">${v.label}</span>
                `,v.className&&B.classList.add(v.className),B.addEventListener("click",()=>{v.action(),De()})),s.appendChild(B)});const{clientX:a,clientY:o}=e,{innerWidth:r,innerHeight:d}=window;t.style.top=`${o}px`,t.style.left=`${a}px`,t.classList.add("visible");const{offsetWidth:c,offsetHeight:h}=t;a+c>r&&(t.style.left=`${r-c-5}px`),o+h>d&&(t.style.top=`${d-h-5}px`)},50)}function De(){Oe.classList.contains("visible")&&Oe.classList.remove("visible")}function As(){var n,t;Fe.innerHTML="";const e=[];if(e.push({label:"کلاس‌ها",handler:()=>{Z(null),ne(null),j(null),L("class-management-page")}}),l){if(e.push({label:l.info.name,handler:()=>{ne(null),j(null),Q(),L("session-page")}}),((n=document.querySelector(".page.active"))==null?void 0:n.id)==="settings-page")e.push({label:"تنظیمات"});else if(y){const o=pe(l).get(y.sessionNumber)||` (#${y.sessionNumber})`;e.push({label:`جلسه ${o}`,handler:()=>{j(null),L("student-page")}});const r=(t=document.querySelector(".page.active"))==null?void 0:t.id;O?e.push({label:`پروفایل: ${O.identity.name}`}):r==="attendance-page"&&e.push({label:"حضور و غیاب"})}}if(e.length<=1){Fe.style.display="none";return}Fe.style.display="flex",e.forEach((s,a)=>{const o=document.createElement("a");if(o.textContent=s.label,o.className="breadcrumb-item",a===e.length-1||!s.handler?o.classList.add("active"):o.addEventListener("click",s.handler),Fe.appendChild(o),a<e.length-1){const r=document.createElement("span");r.className="breadcrumb-separator",r.textContent="/",Fe.appendChild(r)}})}function Jn(e,n,t){t.innerHTML="";const s=l.sessions.filter(a=>{var o;return!a.isDeleted&&!a.isCancelled&&((o=a.studentRecords[e.identity.studentId])==null?void 0:o.attendance)==="absent"}).map(a=>({number:n.get(a.sessionNumber),isMakeup:a.isMakeup})).filter(a=>a.number!==void 0);s.length>0?(t.appendChild(document.createTextNode("جلسات غایب: ")),s.forEach((a,o)=>{const r=document.createElement("span");r.textContent=a.number,a.isMakeup&&r.classList.add("makeup-absence"),t.appendChild(r),o<s.length-1&&t.appendChild(document.createTextNode("، "))})):t.textContent="جلسات غایب: بدون غیبت"}function St(e,n,t,s={}){const{includePrefix:a=!0}=s;t.innerHTML="";const o=l.sessions.filter(r=>{if(r.isDeleted||r.isCancelled)return!1;const d=r.studentRecords[e.identity.studentId];return d&&d.homework&&(d.homework.status==="incomplete"||d.homework.status==="none")}).map(r=>({number:n.get(r.sessionNumber),status:r.studentRecords[e.identity.studentId].homework.status})).filter(r=>r.number!==void 0);o.length>0?(a&&t.appendChild(document.createTextNode("تکالیف ناقص: ")),o.forEach((r,d)=>{const c=document.createElement("span");c.textContent=r.number,r.status==="incomplete"&&c.classList.add("incomplete-homework"),t.appendChild(c),d<o.length-1&&t.appendChild(document.createTextNode("،"))})):a?t.textContent="تکالیف ناقص: ندارد":t.textContent="ندارد"}function La(e,n){var M,F,$;const t=document.createElement("li");t.className="attendance-list-item";const s=document.createElement("input");s.type="checkbox",s.className="mass-comment-checkbox",s.checked=Ae.includes(e.identity.studentId),s.addEventListener("change",()=>{const A=e.identity.studentId,D=Ae;if(s.checked)D.includes(A)||D.push(A);else{const V=D.indexOf(A);V>-1&&D.splice(V,1)}Mn()}),t.appendChild(s);const a={none:"بدون تکلیف",complete:"تکلیف کامل",incomplete:"تکلیف ناقص"},o=document.createElement("div");o.className="student-info";const r=document.createElement("span");r.className="student-name",r.textContent=e.identity.name,r.addEventListener("click",()=>{j(e),oe(),L("student-profile-page")});const d=document.createElement("span");d.className="absence-info";const c=document.createElement("span");c.className="homework-info",Jn(e,n,d),St(e,n,c),o.appendChild(r),o.appendChild(d),o.appendChild(c);const h=document.createElement("div");h.className="homework-controls";const v=document.createElement("button"),B=((M=y.studentRecords[e.identity.studentId])==null?void 0:M.homework.status)||"none";v.className=`homework-status-btn ${B}`,v.title=a[B],v.addEventListener("click",()=>{const A=y.studentRecords[e.identity.studentId].homework,V={none:"incomplete",incomplete:"complete",complete:"none"}[A.status];v.title=a[V],y.setHomeworkStatus(e.identity.studentId,V),w(),v.className=`homework-status-btn ${V}`,St(e,n,c)});const u=document.createElement("button");u.className="btn-icon",u.innerHTML="📝",u.title="افزودن یادداشت برای تکلیف",((F=y.studentRecords[e.identity.studentId])==null?void 0:F.homework.comment)||(u.style.opacity="0.3"),u.addEventListener("click",()=>{const A=y.studentRecords[e.identity.studentId].homework;W.value=A.comment||"",W.dispatchEvent(new Event("input",{bubbles:!0})),ge(D=>{A.comment=D;const V=pe(l),ae=V.get(y.sessionNumber),he={type:"fromAttendance",sessionNumber:y.sessionNumber},X=`یادداشت مربوط به جلسه ${ae}: `,de=e.profile.notes.find(J=>!J.isDeleted&&J.source&&J.source.type==="fromAttendance"&&J.source.sessionNumber===he.sessionNumber);de?D?de.content=X+D:de.isDeleted=!0:D&&e.addNote(X+D,he),w(),R(l.info.name,`یادداشت تکلیف جلسه ${ae} برای دانش‌آموز «${e.identity.name}» ذخیره شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:e.identity.studentId}),C("✅یادداشت تکلیف ذخیره شد."),u.style.opacity=D?"1":"0.3",St(e,V,c)}),te("add-note-modal"),W.focus()}),h.appendChild(v),h.appendChild(u);const b=document.createElement("button"),S=(($=y.studentRecords[e.identity.studentId])==null?void 0:$.attendance)||"present",k=A=>{A==="present"?(b.textContent="حاضر",b.className="attendance-status-btn present active"):(b.textContent="غایب",b.className="attendance-status-btn absent active")};return k(S),b.addEventListener("click",()=>{var V;const D=(((V=y.studentRecords[e.identity.studentId])==null?void 0:V.attendance)||"present")==="present"?"absent":"present";y.setAttendance(e.identity.studentId,D),D==="absent"&&(y.studentRecords[e.identity.studentId].hadIssue=!1),w(),k(D),Jn(e,n,d),Ws()}),t.appendChild(o),t.appendChild(h),t.appendChild(b),t}function ka(){return pe(l).get(y.sessionNumber)}function Ie(){if(!l||!y)return;P(l.students).forEach(a=>{y.initializeStudentRecord(a.identity.studentId)}),Ht([]);const e=pe(l);Oa(),Xe.innerHTML="";const n=document.createElement("li");n.className="attendance-list-header",xe.id="attendance-search-input",xe.type="text",xe.className="inline-search-input",xe.placeholder="جستجو...",xe.value="";const t=document.createElement("div");t.className="student-search-container",t.appendChild(xe);const s=document.createElement("div");s.className="header-labels-container",s.innerHTML=`
    <span class="header-label">تکلیف</span>
    <span class="header-label">حضور</span>
`,n.appendChild(t),n.appendChild(s),Xe.appendChild(n),P(l.students).forEach(a=>{const o=La(a,e);Xe.appendChild(o)}),Ht([]),Mn(),Aa(),Ws()}function se(){const e=document.getElementById("student-stats-table-container");if(!e||(e.innerHTML="",!l))return;P(l.students).length,an.textContent="آمار عملکرد";const n=["نام"],t=["کل انتخاب ها","غیبت","خروج","فرصت ازدست‌رفته","مشکل","میانگین","نمره کلاسی (کانون)"],s=l.categories.filter(p=>p.isGradedCategory&&!p.isDeleted).map(p=>p.name),a=[...n,...s,...t],o=document.createElement("table");o.className="student-stats-table";const d=o.createTHead().insertRow();a.forEach((p,b)=>{const S=document.createElement("th");b===0?(S.innerHTML=`${p} <span style="opacity: 0.6;">🔗</span>`,S.title="ردیف‌های این ستون قابل کلیک هستند"):S.textContent=p,d.appendChild(S)});const c=o.createTBody(),h=P(l.students),v=p=>{let b=0;return l.sessions.forEach(S=>{if(S.isDeleted||S.isCancelled)return;const k=S.studentRecords[p.identity.studentId];k&&k.attendance==="absent"&&b++}),b};h.forEach(p=>{const b=c.insertRow();if(b.dataset.studentId=p.identity.studentId,y){const A=y.studentRecords[p.identity.studentId];A&&A.attendance==="absent"&&b.classList.add("absent-row-highlight")}const S=b.insertCell(),k=document.createElement("span");k.textContent=p.identity.name,k.className="student-name-link",k.addEventListener("click",()=>{j(p),oe(),L("student-profile-page")}),S.appendChild(k),s.forEach(A=>{var he;const D=b.insertCell(),V=A.toLowerCase(),ae=((he=p.logs.scores[V])==null?void 0:he.filter(X=>!X.isDeleted))||[];ae.length>0?ae.forEach((X,de)=>{const J=document.createElement("span");J.textContent=X.value,J.style.position="relative",X.comment&&(J.dataset.tooltip=X.comment),D.appendChild(J),de<ae.length-1&&D.appendChild(document.createTextNode(","))}):D.textContent="",D.style.cursor="pointer",D.addEventListener("click",()=>{Ne(p,A);const X=document.getElementById("category-selection-container");X&&X.scrollIntoView({behavior:"smooth",block:"center"})})}),b.insertCell().textContent=p.statusCounters.totalSelections||0,b.insertCell().textContent=v(p),b.insertCell().textContent=p.statusCounters.outOfClassCount||0,b.insertCell().textContent=p.statusCounters.missedChances||0;const M=Object.values(p.categoryIssues||{}).reduce((A,D)=>A+D,0);b.insertCell().textContent=M;const F=p.getOverallAverageScore();b.insertCell().textContent=F!==null?F:"-";const $=l.calculateFinalStudentScore(p);b.insertCell().textContent=$!==null?$:"-"}),P(l.students),an.setAttribute("data-student-count",h.length),e.appendChild(o);const B=e.querySelector(".student-stats-table"),u=B==null?void 0:B.querySelector("thead th:first-child");u&&u.addEventListener("click",()=>{B.classList.toggle("name-column-expanded")})}function Ne(e=null,n=null){const t=document.getElementById("selected-student-result");t.innerHTML="",t.classList.remove("absent");let s,a;if(e&&n)s=e,a=n,At({student:e,categoryName:n}),$e(-1);else{if(At(null),!y||ue<0||!y.winnerHistory[ue])return;const H=y.winnerHistory[ue];s=H.winner,a=H.categoryName}const o=document.querySelector(".current-winner-highlight");if(o&&o.classList.remove("current-winner-highlight"),s){const H=document.querySelector(`.student-stats-table tr[data-student-id="${s.identity.studentId}"]`);H&&H.classList.add("current-winner-highlight")}const r=l.categories.find(H=>H.name===a);if(r){Sn(r);const H=document.querySelectorAll("#category-selection-container .pill");H.forEach(ee=>ee.classList.remove("active"));const q=Array.from(H).find(ee=>ee.textContent===a);q&&q.classList.add("active"),Rs(r)}const d=y.studentRecords[s.identity.studentId],c=(d==null?void 0:d.attendance)==="absent",h=document.createElement("div");h.className="winner-name-container";const v=document.createElement("button");v.className="btn-icon",v.innerHTML="˅",v.title="برنده قبلی";const B=!e;v.classList.toggle("is-disabled",!B||ue<=0),v.addEventListener("click",()=>{v.classList.contains("is-disabled")?(v.classList.add("shake-animation"),setTimeout(()=>v.classList.remove("shake-animation"),200)):($e(ue-1),Ne())});const u=document.createElement("div");u.className="winner-name",u.innerHTML=`✨ <strong>${s.identity.name}</strong>✨`,u.classList.add("heartbeat-animation"),c&&(u.style.textDecoration="line-through",u.style.opacity="0.6",u.style.color="var(--color-secondary)"),(d==null?void 0:d.hadIssue)&&!c&&(u.style.color="var(--color-warning)",u.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"),(d==null?void 0:d.wasOutOfClass)&&!c&&(u.style.color="var(--color-strong-warning)",u.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود");const S=document.createElement("button");if(S.className="btn-icon",S.innerHTML="˄",S.title="برنده بعدی",S.classList.toggle("is-disabled",!B||ue>=y.winnerHistory.length-1),S.addEventListener("click",()=>{S.classList.contains("is-disabled")?(S.classList.add("shake-animation"),setTimeout(()=>S.classList.remove("shake-animation"),200)):($e(ue+1),Ne())}),h.appendChild(S),h.appendChild(u),s.onboardingSession===y.sessionNumber){const H=document.createElement("div");H.className="new-student-badge",H.textContent="دانش آموز جدید",h.appendChild(H)}h.appendChild(v),t.appendChild(h),ke.disabled=B&&!S.classList.contains("is-disabled");const k=document.createElement("div");k.className="status-button-container";const M=document.createElement("button");M.textContent="غایب",M.classList.add("status-button","absent-btn"),c&&M.classList.add("active");const F=document.createElement("button");F.textContent="مشکل",F.classList.add("status-button","issue-btn"),d!=null&&d.hadIssue&&F.classList.add("active");const $=document.createElement("button");$.textContent="خروج",$.classList.add("status-button","exit-btn"),d!=null&&d.wasOutOfClass&&$.classList.add("active");const A=document.createElement("button");A.textContent="پروفایل",A.className="status-button profile-btn",M.addEventListener("click",()=>{const H=M.classList.contains("active");$.classList.contains("active")&&($.classList.remove("active"),d.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),H?(M.classList.remove("active"),y.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),u.style.textDecoration="",u.style.opacity="",u.style.color=""):(F.classList.contains("active")&&(F.classList.remove("active"),d.hadIssue=!1,s.statusCounters.otherIssues=Math.max(0,s.statusCounters.otherIssues-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),M.classList.add("active"),y.setAttendance(s.identity.studentId,"absent"),s.statusCounters.missedChances++,u.style.textDecoration="line-through",u.style.opacity="0.6",u.style.color="var(--color-secondary)",u.title=""),se(),w()}),F.addEventListener("click",()=>{const H=F.classList.contains("active");if($.classList.contains("active")&&($.classList.remove("active"),d.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),H){F.classList.remove("active"),d.hadIssue=!1;const q=le.name;s.categoryIssues[q]&&(s.categoryIssues[q]=Math.max(0,s.categoryIssues[q]-1)),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),u.style.color="",u.title=""}else{M.classList.contains("active")&&(M.classList.remove("active"),y.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),F.classList.add("active"),d.hadIssue=!0;const q=le.name;s.categoryIssues[q]=(s.categoryIssues[q]||0)+1,s.statusCounters.missedChances++,u.style.textDecoration="",u.style.opacity="",u.style.color="var(--color-warning)",u.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"}se(),w()}),$.addEventListener("click",()=>{if($.classList.contains("active"))$.classList.remove("active"),d.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),u.style.color="",u.title="";else{if(M.classList.contains("active")&&(M.classList.remove("active"),y.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),F.classList.contains("active")){F.classList.remove("active"),d.hadIssue=!1;const q=le.name;s.categoryIssues[q]&&(s.categoryIssues[q]=Math.max(0,s.categoryIssues[q]-1)),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)}$.classList.add("active"),d.wasOutOfClass=!0,s.statusCounters.outOfClassCount=(s.statusCounters.outOfClassCount||0)+1,s.statusCounters.missedChances++,u.style.textDecoration="",u.style.opacity="",u.style.color="var(--color-strong-warning)",u.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود"}se(),w()}),A.addEventListener("click",()=>{j(s),oe(),L("student-profile-page")}),k.appendChild(M),k.appendChild($),k.appendChild(F),k.appendChild(A),t.appendChild(k);const D=document.createElement("div");D.className="student-details-container";const V=document.createElement("div");V.className="student-details-scores",V.innerHTML="<h4>آخرین نمرات</h4>";const ae=document.createElement("ul");ae.className="scores-list";const he=["Reading","Writing","Speaking","Listening"];let X=!1;const de=s.logs.scores||{};he.forEach(H=>{const q=document.createElement("li"),ee=document.createElement("span");ee.className="skill-name",ee.textContent=`${H}:`;const Be=document.createElement("span");Be.className="skill-scores";const Ft=H.toLowerCase(),Ge=de[Ft];Ge&&Ge.length>0?(X=!0,Be.textContent=Ge.slice(-3).map(qt=>qt.value).join(",")):Be.textContent="none",q.appendChild(ee),q.appendChild(Be),ae.appendChild(q)}),!X&&Object.keys(de).length===0&&(ae.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>'),V.appendChild(ae),D.appendChild(V);const J=document.createElement("div");J.className="student-details-notes",J.innerHTML="<h4>یادداشت‌ها</h4>";const He=document.createElement("ul");He.className="notes-list",s.profile.notes&&s.profile.notes.length>0?[...s.profile.notes].sort((q,ee)=>new Date(ee.timestamp)-new Date(q.timestamp)).forEach(q=>{const ee=document.createElement("li");ee.dir=it(q.content),ee.textContent=q.content,He.appendChild(ee)}):He.innerHTML='<div class="no-content-message">یادداشتی وجود ندارد.</div>',J.appendChild(He),D.appendChild(J),t.appendChild(D)}function Hs(e){e.addEventListener("input",()=>{const n=e.value,t=it(n);e.setAttribute("dir",t)})}function wa(){Ye.innerHTML="",ws.innerHTML="",_t.classList.add("tooltip-container"),Ee.disabled=!0,me.disabled=!0,Ue.disabled=!0,Ee.value="",me.value="",ct.classList.add("disabled-wrapper"),ke.disabled=!0}function It(){Ye.innerHTML="",l.categories.filter(t=>!t.isDeleted).forEach(t=>{const s=document.createElement("span");s.className="pill",s.textContent=t.name,s.dataset.categoryId=t.id,t.description&&(s.dataset.tooltip=t.description),s.addEventListener("click",()=>{document.querySelectorAll("#category-selection-container .pill").forEach(o=>o.classList.remove("active")),s.classList.add("active"),Sn(t),Rs(t),ct.classList.remove("disabled-wrapper"),ke.disabled=!1;const a=y.lastWinnerByCategory[t.name];if(a){const o=l.students.find(r=>r.identity.studentId===a);o&&Ne(o,t.name)}else{ws.innerHTML="",At(null),$e(-1),ke.disabled=!1;const o=document.querySelector(".current-winner-highlight");o&&o.classList.remove("current-winner-highlight")}}),s.addEventListener("contextmenu",a=>{dt(a,[{label:"تغییر نام",icon:"✏️",action:()=>{un((r,d)=>{const c=es(l,t,r);c.success?(t.isGradedCategory=d,w(),R(l.info.name,`نام دسته‌بندی «${t.name}» به «${r}» تغییر یافت.`),It(),se(),C(`✅ نام دسته‌بندی به «${r}» تغییر یافت.`)):C(`⚠️ ${c.message}`)},{title:"ویرایش دسته‌بندی",initialName:t.name,initialIsGraded:t.isGradedCategory,saveButtonText:"ذخیره تغییرات"})}},{label:"حذف دسته‌بندی",icon:"🗑️",className:"danger",action:()=>{U(`آیا از انتقال دسته‌بندی «${t.name}» به سطل زباله مطمئن هستید؟`,()=>{const r={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${t.name}» از کلاس «${l.info.name}»`,restoreData:{categoryId:t.id,classroomName:l.info.name}};x.unshift(r),x.length>50&&x.pop();const d=t.name.toLowerCase();l.students.forEach(c=>{c.logs.scores&&c.logs.scores[d]&&c.logs.scores[d].forEach(h=>{h.isDeleted=!0})}),t.isDeleted=!0,R(l.info.name,`دسته‌بندی «${t.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),w(),It(),se(),C(`✅ دسته‌بندی «${t.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}}])}),Ye.appendChild(s)});const n=document.createElement("span");n.className="pill add-category-pill",n.textContent="+",n.title="افزودن دسته‌بندی جدید",n.addEventListener("click",()=>{un((t,s)=>{if(l.categories.find(r=>r.name.toLowerCase()===t.toLowerCase()&&!r.isDeleted)){C("⚠️ این دسته‌بندی از قبل وجود دارد.");return}const o=new ve(t,"",s);l.categories.push(o),w(),R(l.info.name,`دسته‌بندی جدید «${t}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),It(),C(`✅ دسته‌بندی «${t}» اضافه شد.`)})}),Ye.appendChild(n)}function Na(){if(y.lastUsedCategoryId){const e=Ye.querySelector(`.pill[data-category-id="${y.lastUsedCategoryId}"]`);e&&e.click()}y.winnerHistory&&y.winnerHistory.length>0&&($e(y.winnerHistory.length-1),Ne())}function Rs(e){e&&(e.isGradedCategory?(Ee.disabled=!1,me.disabled=!1,Ue.disabled=!1,_t.removeAttribute("title")):(Ee.disabled=!0,me.disabled=!0,Ue.disabled=!0,_t.setAttribute("title","برای این دسته‌بندی قابلیت نمره دهی تعریف نشده است")))}function Me(){if(!l||!y){L("class-management-page");return}wa(),It(),Na(),L("student-page"),se()}function oe(){if(!O)return;const e=O;ks.textContent=`پروفایل: ${e.identity.name}`;const n=l.sessions.reduce((u,p)=>{const b=p.studentRecords[e.identity.studentId];return u+(b&&b.attendance==="absent"?1:0)},0),t=Object.values(e.categoryIssues||{}).reduce((u,p)=>u+p,0);Ke.innerHTML=`
    <p><strong>کل انتخاب:</strong> ${e.statusCounters.totalSelections}</p>
    <p><strong>غیبت:</strong> ${n}</p>
    <p><strong>فرصت از دست رفته:</strong> ${e.statusCounters.missedChances||0}</p>
    <p><strong>مشکل:</strong> ${t}</p>`;const s=P(l.categories),a=document.createElement("div");if(a.className="stats-breakdown",s.length>0){s.forEach(p=>{var M;const b=p.name,S=((M=e.categoryCounts)==null?void 0:M[b])||0,k=document.createElement("p");k.className="stats-breakdown-item",k.innerHTML=`<strong>${b}:</strong> ${S}`,a.appendChild(k)});const u=Ke.querySelector("p:first-child");u&&u.after(a)}const o=document.createElement("div");o.className="stats-breakdown",s.length>0&&(s.forEach(u=>{var k;const p=u.name,b=((k=e.categoryIssues)==null?void 0:k[p])||0,S=document.createElement("p");S.className="stats-breakdown-item",S.innerHTML=`<strong>${p}:</strong> ${b}`,o.appendChild(S)}),Ke.appendChild(o));const r=document.createElement("p"),d=document.createElement("strong");d.textContent="تکالیف ناقص:";const c=document.createElement("span");c.style.marginRight="5px";const h=pe(l);St(e,h,c,{includePrefix:!1}),r.appendChild(d),r.appendChild(c),Ke.appendChild(r);const v=l.categories.filter(u=>u.isGradedCategory&&!u.isDeleted);We.innerHTML="",v.forEach(u=>{const p=document.createElement("span");p.className="pill",p.textContent=u.name,p.dataset.skillName=u.name,u.description&&(p.dataset.tooltip=u.description),We.appendChild(p),p.addEventListener("click",()=>{We.querySelectorAll(".pill").forEach(b=>b.classList.remove("active")),p.classList.add("active"),ln.focus()})}),vt.innerHTML="";const B=[];for(const u in e.logs.scores)e.logs.scores[u].forEach(p=>{p.isDeleted||B.push(p)});B.sort((u,p)=>new Date(p.timestamp)-new Date(u.timestamp)),B.length===0?vt.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>':B.forEach(u=>{const p=document.createElement("li");p.className="score-history-item";const b=document.createElement("div");b.className="item-content";const S=document.createElement("div");if(S.className="score-info",S.innerHTML=`
        <span class="score-date">${new Date(u.timestamp).toLocaleDateString("fa-IR")}</span>
        <span class="score-value">نمره: <strong>${u.value}</strong></span>
        <span class="score-skill-badge">${u.skill}</span>
    `,b.appendChild(S),u.comment){const M=`توضیحات: ${u.comment}`,F=it(M);it(u.comment);const $=document.createElement("p");$.className="score-comment",$.dir=F,$.innerHTML=`<strong>توضیحات:</strong> <div>${gs(u.comment)}</div>`,$.addEventListener("click",()=>{W.value=u.comment,W.dispatchEvent(new Event("input",{bubbles:!0})),ge(A=>{u.comment=A,w(),oe(),C("✅ توضیحات نمره ویرایش شد.")}),te("add-note-modal"),W.focus()}),b.appendChild($)}const k=document.createElement("button");k.className="btn-icon delete-item-btn",k.innerHTML="🗑️",k.title="حذف این نمره",k.addEventListener("click",()=>{U(`آیا از حذف نمره ${u.value} برای مهارت ${u.skill} مطمئن هستید؟`,()=>{const M={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"score",description:`نمره ${u.value} (${u.skill}) برای دانش‌آموز «${e.identity.name}»`,restoreData:{scoreId:u.id,skill:u.skill,studentId:e.identity.studentId,classroomName:l.info.name}};x.unshift(M),x.length>50&&x.pop(),u.isDeleted=!0,R(l.info.name,`نمره ${u.value} در ${u.skill} برای «${e.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),w(),oe(),C("✅ نمره به سطل زباله منتقل شد.")},{confirmText:"تایید حذف",confirmClass:"btn-warning"})}),p.appendChild(b),p.appendChild(k),vt.appendChild(p)}),ln.value="",Bn.value="",We.querySelector(".pill.active")&&We.querySelector(".pill.active").classList.remove("active"),rt()}function rt(){const e=document.getElementById("profile-notes-list");if(e.innerHTML="",!O||!O.profile.notes||O.profile.notes.length===0){e.innerHTML='<div class="no-content-message">هنوز یادداشتی ثبت نشده است.</div>';return}[...O.profile.notes].filter(t=>!t.isDeleted).sort((t,s)=>new Date(s.timestamp)-new Date(t.timestamp)).forEach(t=>{const s=document.createElement("li");s.className="note-history-item";const a=document.createElement("div");a.className="item-content";const o=document.createElement("div");o.className="note-info";const r=document.createElement("span");r.className="note-date",r.textContent=new Date(t.timestamp).toLocaleDateString("fa-IR");const d=document.createElement("button");d.className="btn-icon delete-item-btn",d.innerHTML="🗑️",d.title="حذف این یادداشت",d.addEventListener("click",()=>{U("آیا از حذف این یادداشت مطمئن هستید؟",()=>{const h={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"note",description:`یادداشت برای دانش‌آموز «${O.identity.name}»`,restoreData:{noteId:t.id,studentId:O.identity.studentId,classroomName:l.info.name}};x.unshift(h),x.length>50&&x.pop(),t.isDeleted=!0,R(l.info.name,`یادداشت دانش‌آموز «${O.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),w(),rt(),C("✅ یادداشت به سطل زباله منتقل شد.")},{confirmText:"تایید حذف",confirmClass:"btn-warning"})}),o.appendChild(r),o.appendChild(d);const c=document.createElement("p");c.className="note-content",c.innerHTML=gs(t.content),c.addEventListener("click",()=>{W.value=t.content,W.dispatchEvent(new Event("input",{bubbles:!0})),ge(h=>{t.content=h,w(),R(l.info.name,`یادداشت دانش‌آموز «${O.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:O.identity.studentId}),rt(),C("✅یادداشت با موفقیت ویرایش شد.")}),te("add-note-modal"),W.focus()}),a.appendChild(o),a.appendChild(c),s.appendChild(a),e.appendChild(s)})}function _s(e){sn.innerHTML="",e.forEach((n,t)=>{const s=document.createElement("option");s.value=t,s.textContent=n.trim(),sn.appendChild(s)})}function pn(){nn.innerHTML="",hn.forEach(e=>{const n=document.createElement("li");n.className="preview-item";const t=document.createElement("input");t.type="checkbox",t.checked=!0,t.dataset.name=e;const s=document.createElement("label");s.textContent=e,n.appendChild(t),n.appendChild(s),nn.appendChild(n)})}function Ba(e){const n=document.createElement("div");n.className="list-item-buttons";const t=document.createElement("button");return t.className="btn-icon",t.innerHTML="📝",t.title="افزودن/ویرایش یادداشت کلاس",t.style.borderBottom="solid",e.note||(t.style.opacity="0.5",t.style.borderBottom="none"),t.addEventListener("click",s=>{s.stopPropagation(),$n(e)}),n.appendChild(t),n}function Ta(e){const n=document.createElement("div");n.style.flexGrow="1",n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="flex-start";const t=document.createElement("span");t.textContent=e.info.name,t.classList.add("class-name-display"),n.appendChild(t);const s=P(e.students).length,a=P(e.sessions).filter(c=>c.isFinished).length,o=document.createElement("div");o.classList.add("class-stats-row");const r=document.createElement("span");r.textContent=`${s} نفر`,r.classList.add("student-count-badge"),o.appendChild(r);const d=document.createElement("span");return d.textContent=`${a} جلسه`,d.classList.add("session-count-badge"),o.appendChild(d),n.appendChild(o),n.addEventListener("click",()=>{Z(e),ne(null),ot(l.liveSession),Q(),L("session-page")}),n}function xa(e){const n=document.createElement("li"),t=Ta(e);n.appendChild(t);const s=document.createElement("div");if(s.className="list-item-badges",e.liveSession&&!e.liveSession.isCancelled&&!e.liveSession.isDeleted){const r=document.createElement("span");r.className="warning-badge",r.textContent="جلسه باز",s.appendChild(r),n.classList.add("has-unfinished-session")}const a=document.createElement("span");a.className=`type-badge ${e.info.type}`,a.textContent=e.info.type==="online"?"آنلاین":"حضوری",a.title="نوع کلاس",s.appendChild(a),n.appendChild(s);const o=Ba(e);return n.appendChild(o),n.addEventListener("contextmenu",r=>{dt(r,[{label:"تنظیمات کلاس",icon:"⚙️",action:()=>{On(e)}},{label:"گزارش فعالیت‌ها",icon:"📋",action:()=>{Os(e.info.name)}},{label:"تغییر نام",icon:"✏️",action:()=>{const c=e.info.name,h=document.getElementById("add-note-modal-title");h.textContent="تغییر نام کلاس",W.value=c,W.rows=1,ge(v=>{const B=v.trim();if(B&&B!==c){const u=Zn(c,B);u.success?(Lo(c,B),R(B,`نام کلاس از «${c}» به «${B}» تغییر یافت.`,{type:"VIEW_SESSIONS"}),w(),re(),C(`✅نام کلاس به «${B}» تغییر یافت.`)):C(u.message)}h.textContent="ثبت یادداشت جدید",W.rows=4}),te("add-note-modal"),W.focus(),W.select()}},{label:"حذف کلاس",icon:"🗑️",className:"danger",action:()=>{U(`آیا از انتقال کلاس «${e.info.name}» به سطل زباله مطمئن هستید؟`,()=>{const c={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"classroom",description:`کلاس «${e.info.name}»`,restoreData:{name:e.info.name}};x.unshift(c),x.length>50&&x.pop(),e.isDeleted=!0,w(),re(),C(`✅ کلاس «${e.info.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}])}),n}function Ps(){const e=document.getElementById("class-management-stats");if(!e)return;const n=Object.values(N).filter(a=>!a.isDeleted),t=n.length,s=n.reduce((a,o)=>a+P(o.students).length,0);e.innerHTML=`
        <span>کل کلاس‌ها: <strong>${t}</strong></span>
        <span>|</span>
        <span>کل دانش‌آموزان: <strong>${s}</strong></span>
    `}function re(){Ps(),Zt.innerHTML="",Object.values(N).sort((n,t)=>new Date(n.info.creationDate)-new Date(t.info.creationDate)).forEach(n=>{if(n.isDeleted)return;const t=xa(n);Zt.appendChild(t)})}function be(){en.innerHTML="",l&&P(l.students).forEach(e=>{const n=document.createElement("li"),t=document.createElement("span");t.textContent=e.identity.name,t.style.flexGrow="1",t.className="student-name-link",t.addEventListener("click",()=>{j(e),oe(),L("student-profile-page")}),n.appendChild(t),n.addEventListener("contextmenu",s=>{dt(s,[{label:"تغییر نام",icon:"✏️",action:()=>{Dn(e,l)}},{label:"انتقال دانش‌آموز",icon:"➡️",action:()=>{Ms(e,l)}},{label:"حذف دانش‌آموز",icon:"🗑️",className:"danger",action:()=>{U(`آیا از انتقال دانش‌آموز «${e.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const o={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${e.identity.name}» از کلاس «${l.info.name}»`,restoreData:{studentId:e.identity.studentId,classroomName:l.info.name}};x.unshift(o),x.length>50&&x.pop(),e.isDeleted=!0,R(l.info.name,`دانش‌آموز «${e.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),w(),be(),C(`✅ دانش‌آموز «${e.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}])}),en.appendChild(n)})}function Ve(){if(tn.innerHTML="",!l)return;l.categories.filter(n=>!n.isDeleted).forEach(n=>{const t=document.createElement("li"),s=document.createElement("div");s.className="name-and-badge-container";const a=document.createElement("span");if(a.textContent=n.name,s.appendChild(a),n.isGradedCategory){const r=document.createElement("span");r.className="category-badge",r.textContent="قابل نمره‌دهی",s.appendChild(r)}const o=document.createElement("button");o.className="btn-icon",o.innerHTML="🗑️",o.style.color="var(--color-warning)",o.addEventListener("click",()=>{U(`آیا از انتقال دسته‌بندی «${n.name}» به سطل زباله مطمئن هستید؟`,()=>{const r={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${n.name}» از کلاس «${l.info.name}»`,restoreData:{categoryId:n.id,classroomName:l.info.name}};x.unshift(r),x.length>50&&x.pop(),n.isDeleted=!0,R(l.info.name,`دسته‌بندی «${n.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),w(),Ve(),C(`✅ دسته‌بندی «${n.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}),t.appendChild(s),t.appendChild(o),tn.appendChild(t)})}function tt(e){document.querySelectorAll(".page").forEach(t=>{t.classList.remove("active")});const n=document.getElementById(e);n&&n.classList.add("active"),e==="class-management-page"?(re(),on.style.display="flex"):on.style.display="none",As()}function L(e){const n={pageId:e,currentClassName:l?l.info.name:null,selectedSessionNumber:y?y.sessionNumber:null,selectedStudentId:O?O.identity.studentId:null};let t=`#${e}`;const s=new URLSearchParams;l&&s.set("class",l.info.name),y&&s.set("session",y.sessionNumber),O&&s.set("student",O.identity.studentId);const a=s.toString();a&&(t+=`?${a}`),window.location.hash!==t&&history.pushState(n,"",t),tt(e)}function Da(e,n){const t=document.createElement("div");t.className="list-item-buttons";const s=document.createElement("button");if(s.className="btn-icon",s.innerHTML="📝",s.title="افزودن/ویرایش یادداشت جلسه",s.style.borderBottom="solid",e.note||(s.style.opacity="0.5",s.style.borderBottom="none"),s.addEventListener("click",a=>{a.stopPropagation(),W.value=e.note||"",ge(o=>{e.note=o,w(),R(l.info.name,`یادداشت جلسه ${n} ذخیره شد.`,{type:"VIEW_SESSIONS"}),Q(),C("✅یادداشت جلسه ذخیره شد.")}),te("add-note-modal"),W.focus()}),t.appendChild(s),!e.isFinished&&!e.isCancelled){const a=document.createElement("button");a.className="btn-icon",a.innerHTML="✅",a.title="خاتمه جلسه",a.addEventListener("click",o=>{o.stopPropagation(),U(`جلسه شماره ${n} خاتمه پیدا خواهد کرد!`,()=>{l.endSpecificSession(e.sessionNumber),w(),R(l.info.name,`جلسه ${n} خاتمه یافت.`,{type:"VIEW_SESSIONS"}),Q(),U("جلسه با موفقیت خاتمه یافت. آیا مایل به ایجاد فایل پشتیبان هستید؟",()=>{if(fe){C("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است.");return}An(),C("✅فایل پشتیبان با موفقیت ایجاد شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}),t.appendChild(a)}return t}function Ma(e,n){const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="flex-start",t.style.flexGrow="1";const s=new Date(e.startTime).toLocaleDateString("fa-IR"),a=document.createElement("span"),o=document.createElement("div");o.style.display="flex",o.style.gap="5px",o.style.marginTop="5px";const r=new Date(e.startTime).toLocaleDateString("fa-IR",{weekday:"long"}),d=document.createElement("span");if(d.className="type-badge day-badge",d.textContent=r,o.appendChild(d),e.isCancelled){a.textContent=`✅جلسه لغو شده - تاریخ: ${s}`,t.style.cursor="default";const c=document.createElement("span");c.className="type-badge cancelled-badge",c.textContent="لغو شده",o.appendChild(c)}else a.textContent=`جلسه ${n} - تاریخ: ${s}`,t.style.cursor="pointer",t.addEventListener("click",()=>{ne(e),Me()});if(t.appendChild(a),e.isFinished){const c=document.createElement("span");c.className="type-badge",c.textContent="خاتمه یافته",c.style.backgroundColor="var(--color-secondary)",o.appendChild(c)}if(e.isMakeup){const c=document.createElement("span");c.className="type-badge",c.textContent="جبرانی",c.style.backgroundColor="var(--color-warning)",c.style.color="var(--color-text-dark)",o.appendChild(c)}return t.appendChild(o),t}function $a(e,n){const t=document.createElement("li"),s=n.get(e.sessionNumber),a=Ma(e,s);t.appendChild(a);const o=Da(e,s);return t.appendChild(o),t.addEventListener("contextmenu",r=>{const d=[{label:e.isCancelled?"بازگردانی جلسه":"لغو جلسه",icon:"❌",action:()=>{const c=e.isCancelled?"بازگردانی جلسه":"لغو جلسه",h=e.isCancelled?"آیا از بازگردانی این جلسه مطمئن هستید؟":"آیا از لغو این جلسه مطمئن هستید؟ جلسه لغو شده در آمار تاثیری ندارد اما قابل بازگردانی است.";U(h,()=>{e.isCancelled=!e.isCancelled;const v=e.isCancelled?`جلسه ${s} لغو شد.`:`جلسه لغو شده (تاریخ: ${new Date(e.startTime).toLocaleDateString("fa-IR")}) بازگردانی شد.`;R(l.info.name,v,{type:"VIEW_SESSIONS"}),w(),Q(),C(e.isCancelled?"✅جلسه لغو شد.":"✅جلسه بازگردانی شد.")},{confirmText:c,confirmClass:"btn-warning"})}},{label:"تغییر وضعیت جبرانی",icon:"🔄",action:()=>{l.markAsMakeup(e.sessionNumber),w();const c=e.isMakeup?`جلسه ${s} به عنوان جبرانی علامت‌گذاری شد.`:`جلسه ${s} از حالت جبرانی خارج شد.`;R(l.info.name,c,{type:"VIEW_SESSIONS"}),Q()}},{label:"حذف جلسه",icon:"🗑️",className:"danger",action:()=>{const c=e.isCancelled?"لغو شده":s;U(`آیا از انتقال جلسه ${c} به سطل زباله مطمئن هستید؟`,()=>{const h={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"session",description:`جلسه ${c} از کلاس «${l.info.name}»`,restoreData:{sessionNumber:e.sessionNumber,classroomName:l.info.name}};x.unshift(h),x.length>50&&x.pop(),e.isDeleted=!0,R(l.info.name,`جلسه ${c} به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),w(),Q(),C(`✅ جلسه ${c} به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}];dt(r,d)}),t}function Q(){const e=document.getElementById("session-list");if(!l)return;if(e.innerHTML="",l.sessions.length===0){e.innerHTML="<li>هنوز جلسه‌ای شروع نشده است.</li>";return}const n=pe(l);[...P(l.sessions)].reverse().forEach(s=>{const a=$a(s,n);e.appendChild(a)})}function Qe(e){if(Se.innerHTML="",e.length>0)e.forEach(n=>{const t=document.createElement("div");t.textContent=n.identity.name,t.addEventListener("click",()=>{j(n),oe(),L("student-profile-page"),Se.style.display="none",rn.value=""}),Se.appendChild(t)}),Se.style.display="block";else if(rn.value.trim()!==""){const n=document.createElement("div");n.className="no-results",n.textContent="پیدا نشد",Se.appendChild(n),Se.style.display="block"}else Se.style.display="none"}function Lt(e){if(Ce.innerHTML="",e.length>0)e.forEach(n=>{const t=document.createElement("div");t.className="global-search-result";const s=document.createElement("span");s.className="student-name",s.textContent=n.student.identity.name;const a=document.createElement("span");a.className="class-name",a.textContent=`کلاس: ${n.classroom.info.name}`,t.addEventListener("click",()=>{Z(n.classroom),j(n.student),oe(),L("student-profile-page"),Ce.style.display="none",Et.value=""}),a.addEventListener("click",o=>{o.stopPropagation(),Z(n.classroom),ne(null),ot(n.classroom.liveSession),Q(),L("session-page"),Ce.style.display="none",Et.value=""}),t.appendChild(s),t.appendChild(a),Ce.appendChild(t)}),Ce.style.display="block";else if(Et.value.trim()!==""){const n=document.createElement("div");n.className="no-results",n.textContent="پیدا نشد",Ce.appendChild(n),Ce.style.display="block"}else Ce.style.display="none"}function lt(){const e=document.getElementById("trashed-items-list");if(e.innerHTML="",x.length===0){e.innerHTML='<li style="text-align: center; padding: 20px;">سطل زباله خالی است.</li>';return}x.forEach((n,t)=>{const s=document.createElement("li"),a=document.createElement("span");a.textContent=n.description,a.style.flexGrow="1";const o=document.createElement("div");o.className="list-item-buttons";const r=document.createElement("button");r.className="btn-icon",r.innerHTML="🔄",r.title="بازیابی",r.addEventListener("click",()=>{var B;let c=!1,h=null;const v=n.restoreData;switch(n.type){case"classroom":{const u=N[v.name];u&&!u.isDeleted?h=`کلاسی با نام «${v.name}» از قبل فعال است.`:u&&u.isDeleted&&(u.isDeleted=!1,c=!0);break}case"student":{const u=N[v.classroomName],p=u==null?void 0:u.students.find(b=>b.identity.studentId===v.studentId);p&&(p.isDeleted=!1,c=!0);break}case"session":{const u=N[v.classroomName],p=u==null?void 0:u.sessions.find(b=>b.sessionNumber===v.sessionNumber);p&&(p.isDeleted=!1,c=!0);break}case"category":{const u=N[v.classroomName],p=u==null?void 0:u.categories.find(b=>b.id===v.categoryId);p&&(p.isDeleted=!1,c=!0);break}case"score":{const u=N[v.classroomName],p=u==null?void 0:u.students.find(S=>S.identity.studentId===v.studentId),b=(B=p==null?void 0:p.logs.scores[v.skill.toLowerCase()])==null?void 0:B.find(S=>S.id===v.scoreId);b&&(b.isDeleted=!1,c=!0);break}case"note":{const u=N[v.classroomName],p=u==null?void 0:u.students.find(S=>S.identity.studentId===v.studentId),b=p==null?void 0:p.profile.notes.find(S=>S.id===v.noteId);b&&(b.isDeleted=!1,c=!0);break}}c?(x.splice(t,1),w(),lt(),n.type==="classroom"&&re(),C("✅ آیتم با موفقیت بازیابی شد.")):C(h?`⚠️ ${h}`:"⚠️ آیتم اصلی برای بازیابی یافت نشد.")});const d=document.createElement("button");d.className="btn-icon",d.innerHTML="🔥",d.title="حذف دائمی",d.addEventListener("click",()=>{U("آیا از حذف دائمی این آیتم مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{const c=n.restoreData;switch(n.type){case"classroom":delete N[c.name];break;case"student":st({identity:{studentId:c.studentId}},N[c.classroomName]);break;case"session":ss(c.classroomName,c.sessionNumber);break;case"category":os(c.classroomName,c.categoryId);break;case"score":as(c.classroomName,c.studentId,c.skill,c.scoreId);break;case"note":is(c.classroomName,c.studentId,c.noteId);break}x.splice(t,1),w(),lt(),C("✅ آیتم برای همیشه حذف شد.")},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),o.appendChild(r),o.appendChild(d),s.appendChild(a),s.appendChild(o),e.appendChild(s)})}function Oa(){const e=document.getElementById("absentees-summary-container");e&&(e.innerHTML=`
        <div id="absentees-summary-box" class="absentees-summary">
            <div class="absentees-summary-header">
                <h4>لیست غایبین جلسه شماره <span id="absentee-summary-session-number"></span></h4>
                <button id="copy-absentees-btn" class="btn-icon" title="کپی لیست غایبین">📋</button>
            </div>
            <div id="absentees-summary-list" class="summary-list"></div>
        </div>
    `)}function Ws(){const e=document.getElementById("absentees-summary-box"),n=document.getElementById("absentees-summary-list"),t=document.getElementById("absentee-summary-session-number");if(!e||!n||!t){console.error("Could not find all absentee summary elements.");return}if(!l||!y){e.classList.remove("visible");return}const s=P(l.students).filter(o=>{const r=y.studentRecords[o.identity.studentId];return r&&r.attendance==="absent"}),a=pe(l);t.textContent=a.get(y.sessionNumber),s.length>0?e.classList.add("visible"):e.classList.remove("visible"),n.innerHTML="",s.forEach(o=>{const d=(h=>l.sessions.reduce((v,B)=>{if(B.isDeleted||B.isCancelled)return v;const u=B.studentRecords[h.identity.studentId];return v+(u&&u.attendance==="absent"?1:0)},0))(o),c=document.createElement("span");c.className="summary-name",c.textContent=`${o.identity.name} (غیبت: ${d})`,c.addEventListener("click",()=>{c.classList.add("fading-out"),setTimeout(()=>{y.setAttendance(o.identity.studentId,"present"),w(),Ie()},200)}),n.appendChild(c)})}function Aa(){const e=document.getElementById("copy-absentees-btn");if(!e){console.error("Could not find the copy absentees button to attach listener.");return}e.addEventListener("click",()=>{if(!l||!y)return;const n=P(l.students).filter(a=>{const o=y.studentRecords[a.identity.studentId];return o&&o.attendance==="absent"});if(n.length===0){C("⚠️لیست غایبین خالی است.");return}const t=a=>l.sessions.reduce((o,r)=>{if(r.isDeleted||r.isCancelled)return o;const d=r.studentRecords[a.identity.studentId];return o+(d&&d.attendance==="absent"?1:0)},0);let s=`لیست غایبین جلسه شماره ${ka()}:

`;n.forEach(a=>{const o=t(a);s+=`- ${a.identity.name} (تعداد غیبت‌ها: ${o})
`}),navigator.clipboard.writeText(s).then(()=>{C("✅لیست غایبین با موفقیت کپی شد.")}).catch(a=>{console.error("Failed to copy text: ",a),C("❌خطا در کپی کردن لیست.")})})}function kt(){const e=document.getElementById("demo-mode-banner");e&&(fe?(e.classList.add("visible"),document.body.classList.add("demo-mode-active")):(e.classList.remove("visible"),document.body.classList.remove("demo-mode-active")))}const Ha=Object.freeze(Object.defineProperty({__proto__:null,_internalShowPage:tt,addCategoryBtn:qo,addClassBtn:wo,addNoteModal:sa,addScoreBtn:ra,addStudentBtn:Do,appHeader:on,attendanceListUl:Xe,attendanceMassActionsContainer:bt,attendancePage:Uo,attendanceSearchInput:xe,backToAttendanceBtn:zo,backToSessionsBtn:To,backToSessionsFromAttendanceBtn:Go,backToStudentPageBtn:ca,backupDataBtn:Yo,breadcrumbContainer:Fe,cancelImportBtn:Wo,cancelNoteBtn:aa,categoryListUl:tn,categoryModal:ha,categoryModalCancelBtn:ya,categoryModalSaveBtn:Bs,categoryModalTitle:Ns,classListHeader:jo,classListUl:Zt,classManagementPage:Cs,classSaveNoteBtn:oa,closeActiveModal:z,closeContextMenu:De,closeNavBtn:Qo,columnMappingPage:_o,columnSelectDropdown:sn,confirmColumnBtn:Po,confirmModalCancelBtn:cn,confirmModalConfirmBtn:Je,confirmModalMessage:Ss,contextMenu:Oe,csvCancelBtn:Ao,csvConfirmBtn:Oo,csvFileInput:Ro,csvPreviewList:nn,csvPreviewPage:$o,customConfirmModal:ea,displayWinner:Ne,finishAttendanceBtn:Vo,globalStudentSearchInput:Et,globalStudentSearchResultsDiv:Ce,gradedCategoryPillsContainer:We,hamburgerMenuBtn:Jo,handleUndo:xs,importCsvBtn:Ho,initiateBackupProcess:An,isGradedCheckbox:la,massCommentAppendCheckbox:xn,massCommentBtn:dn,massCommentCancelBtn:Ea,massCommentContent:et,massCommentModal:Ca,massCommentModalTitle:va,massCommentSaveBtn:ba,massCommentStudentCountMessage:Ts,newCategoryModalIsGradedCheckbox:Tn,newCategoryModalNameInput:Ze,newCategoryNameInput:Fo,newClassNameInput:ko,newNoteContent:W,newScoreCommentTextarea:Bn,newScoreValueInput:ln,newStudentNameInput:xo,openContextMenu:dt,openModal:te,overlay:Xo,pasteArea:Es,processMassHomeworkComment:mn,processPasteBtn:Mo,profileScoresListUl:vt,profileStatsSummaryDiv:Ke,profileStudentNameHeader:ks,quickGradeFormWrapper:_t,quickGradeSubmitBtn:Ue,quickNoteTextarea:me,quickScoreInput:Ee,renderAttendancePage:Ie,renderBreadcrumbs:As,renderClassList:re,renderClassManagementStats:Ps,renderColumnSelector:_s,renderGlobalSearchResults:Lt,renderImportPreview:pn,renderLogModal:Os,renderMassCommentControls:Mn,renderSearchResults:Qe,renderSessions:Q,renderSettingsCategories:Ve,renderSettingsStudentList:be,renderStudentNotes:rt,renderStudentPage:Me,renderStudentProfilePage:oe,renderStudentStatsList:se,renderTrashPage:lt,restoreDataBtn:Zo,restoreFileInput:bs,secureConfirmCancelBtn:na,secureConfirmCode:Ls,secureConfirmConfirmBtn:Ct,secureConfirmInput:Pe,secureConfirmMessage:Is,secureConfirmModal:ta,selectStudentBtn:ke,selectStudentBtnWrapper:ct,setAutoDirectionOnInput:Hs,settingsClassNameHeader:Nn,settingsPage:Bo,settingsStudentListUl:en,showCategoryModal:un,showClassNoteModal:$n,showCustomConfirm:U,showMassCommentModal:$s,showMoveStudentModal:Ms,showNotification:C,showPage:L,showRenameStudentModal:Dn,showSecureConfirm:Ds,showSettingsPage:On,showUndoToast:Sa,sideNavMenu:Ko,studentProfilePage:ia,studentSearchInput:rn,studentSearchResultsDiv:Se,studentStatsHeader:an,trashedCategoriesList:fa,trashedClassesList:da,trashedNotesList:pa,trashedScoresList:ga,trashedSessionsList:ma,trashedStudentsList:ua,triggerFileDownload:fn,undoBtn:No,undoMessage:vs,undoToast:Rt,updateDemoModeBanner:kt},Symbol.toStringTag,{value:"Module"}));function Ra(){const e=window.location.hash;if(!e||e==="#")return!1;const[n,t]=e.split("?"),s=n.substring(1),a=new URLSearchParams(t),o=a.get("class"),r=parseInt(a.get("session"),10),d=a.get("student");if(o&&N[o])Z(N[o]),r&&l.getSession(r)&&ne(l.getSession(r)),d&&l.students.find(c=>c.identity.studentId===d)&&j(l.students.find(c=>c.identity.studentId===d));else return!1;switch(s){case"session-page":Q(),L("session-page");break;case"student-page":Me();break;case"attendance-page":Ie(),L("attendance-page");break;case"settings-page":Nn.textContent=`تنظیمات کلاس: ${l.info.name}`,be(),Ve(),L("settings-page");break;case"student-profile-page":oe(),L("student-profile-page");break;default:return!1}return!0}document.addEventListener("DOMContentLoaded",()=>{const{globalStudentSearchInput:e,newClassNameInput:n,addClassBtn:t,undoBtn:s,backToSessionsBtn:a,newStudentNameInput:o,addStudentBtn:r,pasteArea:d,processPasteBtn:c,csvPreviewList:h,csvConfirmBtn:v,csvCancelBtn:B,importCsvBtn:u,csvFileInput:p,columnSelectDropdown:b,confirmColumnBtn:S,cancelImportBtn:k,newCategoryNameInput:M,addCategoryBtn:F,selectStudentBtn:$,attendancePage:A,finishAttendanceBtn:D,backToSessionsFromAttendanceBtn:V,backToAttendanceBtn:ae,classListHeader:he,studentStatsHeader:X,hamburgerMenuBtn:de,sideNavMenu:J,closeNavBtn:He,overlay:H,backupDataBtn:q,restoreDataBtn:ee,restoreFileInput:Be,confirmModalCancelBtn:Ft,confirmModalConfirmBtn:Ge,secureConfirmCancelBtn:qt,secureConfirmConfirmBtn:Fs,newNoteContent:ut,classSaveNoteBtn:qs,cancelNoteBtn:Us,studentSearchInput:ze,studentSearchResultsDiv:Vs,studentProfilePage:Gs,profileStudentNameHeader:zs,backToStudentPageBtn:js,gradedCategoryPillsContainer:Js,newScoreValueInput:Ks,newScoreCommentTextarea:Qs,addScoreBtn:Xs,isGradedCheckbox:Hn,categoryModalSaveBtn:Ys,categoryModalCancelBtn:Zs,massCommentBtn:eo,massCommentCancelBtn:to,massCommentSaveBtn:no,massCommentContent:so,massCommentAppendCheckbox:oo,attendanceSearchInput:Rn}=Ha,ao=document.getElementById("trash-nav-btn");document.querySelector(".global-search-container .search-icon"),$t(),kt(),Ra()||(re(),L("class-management-page"));function _n(i,f){const m=document.querySelector(i);if(!m)return;const g=m.querySelector(".search-icon"),E=m.querySelector(".animated-search-input");!g||!E||(g.addEventListener("mousedown",T=>{T.preventDefault()}),g.addEventListener("click",()=>{m.classList.contains("search-active")||(m.classList.add("search-active"),E.focus())}),E.addEventListener("blur",()=>{setTimeout(()=>{m.classList.remove("search-active"),E.value="",f&&f([])},150)}))}Rn.addEventListener("input",()=>{const i=Rn.value.toLowerCase().trim(),f=Jt(i);Xe.querySelectorAll(".attendance-list-item").forEach(g=>{const E=g.querySelector(".student-name");if(E){const T=E.textContent,I=ye(T.toLowerCase()),Y=I.includes(ye(i)),G=I.includes(ye(f));Y||G?g.style.display="flex":g.style.display="none"}})}),Zs.addEventListener("click",()=>{z(),Wt(null)}),Ys.addEventListener("click",()=>{const i=Ze.value.trim(),f=Tn.checked;typeof Dt=="function"&&Dt(i,f)}),window.addEventListener("scroll",De),document.addEventListener("click",i=>{Oe.classList.contains("visible")&&!Oe.contains(i.target)&&De(),ze.contains(i.target)||(Vs.style.display="none");const f=i.target.closest(".log-action-link");if(f&&f.dataset.action)try{const m=JSON.parse(f.dataset.action);fo(m)}catch(m){console.error("Could not parse log action:",m)}}),ct.addEventListener("click",()=>{(ct.classList.contains("disabled-wrapper")||ke.disabled)&&(ke.classList.add("shake-animation"),setTimeout(()=>{ke.classList.remove("shake-animation")},200))}),X.addEventListener("click",()=>{const i=new Date().getTime();i-vn>500?yt(1):yt(Bt+1),ms(i),Bt===5&&(yt(0),U("آیا از صفر کردن تمام شمارنده‌های دانش‌آموزان مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{ns(),se(),C("تمام آمارها صفر شدند ✅.")},{confirmText:"بله",confirmClass:"btn-warning"}))}),he.addEventListener("click",()=>{const i=new Date().getTime();i-Cn>500?ht(1):ht(Nt+1),us(i),Nt===5&&(ht(0),U("آیا از ساخت یک کلاس تستی تصادفی مطمئن هستید؟",()=>{function f(){const m=`کلاس تستی ${Object.keys(N).length+1}`,g=new Qt({name:m,type:"online"});["علی رضایی","مریم حسینی","زهرا احمدی","رضا محمدی","فاطمه کریمی"].forEach(T=>g.addStudent(new pt({name:T}))),N[m]=g,w(),re()}f(),C("کلاس تستی با موفقیت ساخته شد ✅!")},{confirmText:"بساز",confirmClass:"btn-success"}))}),qt.addEventListener("click",()=>{z(),at(null)}),Fs.addEventListener("click",()=>{typeof Tt=="function"&&Tt(),z(),at(null)}),Ft.addEventListener("click",()=>{z(bn)}),Ge.addEventListener("click",()=>{z(En)}),ae.addEventListener("click",()=>{l&&y&&(Ie(),L("attendance-page"))}),$.addEventListener("click",()=>{if(Ee.value.trim()!==""||me.value.trim()!==""){C("⚠️لطفاً ابتدا با دکمه «ثبت»، تغییرات را ذخیره کنید و یا نمره و یادداشت را پاک کنید.");return}if(!l||!y||!le)return;const i=l.selectNextWinner(le.name,y);if(i){const f=y.studentRecords[i.identity.studentId];if(f&&f.attendance==="absent"&&i.statusCounters.missedChances++,f&&f.hadIssue){i.statusCounters.missedChances++;const g=le.name;i.categoryIssues[g]=(i.categoryIssues[g]||0)+1}const m={winner:i,categoryName:le.name};y.winnerHistory.push(m),y.winnerHistory.length>10&&y.winnerHistory.shift(),$e(y.winnerHistory.length-1),y.lastUsedCategoryId=le.id,y.lastSelectedWinnerId=i.identity.studentId,se(),Ne(),w()}else C("❌دانش‌آموز واجد شرایطی برای انتخاب یافت نشد.")}),F.addEventListener("click",()=>{if(!l)return;const i=M.value.trim(),f=Hn.checked;if(!i){alert("⚠️لطفاً نام دسته‌بندی را وارد کنید.");return}const m=l.categories.find(E=>E.name.toLowerCase()===i.toLowerCase());if(m)if(m.isDeleted){const E=l.categories.findIndex(T=>T===m);E>-1&&l.categories.splice(E,1)}else{alert("⚠️این دسته‌بندی از قبل وجود دارد.");return}const g=new ve(i,"",f);l.categories.push(g),w(),R(l.info.name,`دسته‌بندی جدید «${i}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),Ve(),M.value="",Hn.checked=!1}),M.addEventListener("keyup",i=>{i.key==="Enter"&&F.click()}),S.addEventListener("click",()=>{if(!wt){alert("❌خطایی رخ داده است. لطفاً فایل را دوباره انتخاب کنید."),L("settings-page");return}const i=parseInt(b.value,10),g=wt.split(`
`).slice(1).map(E=>{var I;return(I=E.split(",")[i])==null?void 0:I.trim()}).filter(E=>E&&E.length>0);g.length>0?(je(g),pn(),L("csv-preview-page")):alert("هیچ نامی در ستون انتخاب شده پیدا نشد. لطفاً ستون دیگری را امتحان کنید یا فایل خود را بررسی کنید."),gt(null)}),u.addEventListener("click",()=>{p.click()}),p.addEventListener("change",i=>{const f=i.target.files[0];if(!f)return;const m=new FileReader;m.onload=g=>{const E=g.target.result;gt(E);const I=E.split(`
`)[0].split(",");_s(I),L("column-mapping-page")},m.readAsText(f),i.target.value=null}),k.addEventListener("click",()=>{gt(null),L("settings-page")}),v.addEventListener("click",()=>{const i=h.querySelectorAll('input[type="checkbox"]:checked');let f=!1;i.forEach(m=>{const g=m.dataset.name,E=l.students.find(I=>I.identity.name.toLowerCase()===g.toLowerCase());if(E)if(E.isDeleted)st(E,l);else{console.log(`دانش‌آموز «${g}» به دلیل تکراری بودن اضافه نشد.`);return}const T=new pt({name:g});l.addStudent(T),l.sessions.length>0&&(P(l.sessions).filter(I=>I.isFinished&&!I.isCancelled).forEach(I=>{I.setAttendance(T.identity.studentId,"absent")}),qn(T,l),f=!0)}),w(),R(l.info.name,`${i.length} دانش‌آموز جدید از لیست ورودی به کلاس اضافه شدند.`,{type:"VIEW_SESSIONS"}),be(),f&&Un(i.length),L("settings-page"),d.value="",je([])}),B.addEventListener("click",()=>{je([]),L("settings-page")}),c.addEventListener("click",()=>{const i=d.value.trim();if(!i){alert("کادر متنی خالی است. لطفاً اسامی را وارد کنید.");return}const f=i.split(`
`).map(m=>m.trim()).filter(m=>m.length>0);f.length>0?(je(f),pn(),L("csv-preview-page")):alert("هیچ نام معتبری برای ورود پیدا نشد.")}),o.addEventListener("keyup",i=>{i.key==="Enter"&&r.click()}),r.addEventListener("click",()=>{if(!l)return;const i=o.value.trim();if(!i){alert("لطفاً نام دانش‌آموز را وارد کنید.");return}const f=l.students.find(g=>g.identity.name.toLowerCase()===i.toLowerCase());if(f)if(f.isDeleted)st(f,l);else{alert("❌دانش‌آموزی با این نام از قبل در این کلاس وجود دارد.");return}const m=new pt({name:i});l.addStudent(m),l.sessions.length>0&&(P(l.sessions).filter(g=>g.isFinished&&!g.isCancelled).forEach(g=>{g.setAttendance(m.identity.studentId,"absent")}),qn(m,l),Un(1)),w(),R(l.info.name,`دانش‌آموز «${i}» به کلاس اضافه شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:m.identity.studentId}),be(),se(),o.value="",o.focus()}),a.addEventListener("click",()=>{Q(),L("session-page")}),document.getElementById("new-session-btn").addEventListener("click",()=>{if(l){const i=l.sessions.find(m=>!m.isFinished&&!m.isCancelled&&!m.isDeleted);if(i){C(`⚠️ جلسه ${i.sessionNumber} هنوز تمام نشده است. لطفاً ابتدا با دکمه ✅ آن را خاتمه دهید.`);return}const f=()=>{const m=g=>{const E=l.startNewSession();ot(E),ne(E),l.students.forEach(Y=>{gn.setAttendance(Y.identity.studentId,"present")}),w();const I=pe(l).get(E.sessionNumber);R(l.info.name,`جلسه ${I} شروع شد.`,{type:"VIEW_SESSIONS"}),g?(Ie(),L("attendance-page")):Me()};U("آیا تمایل به انجام فرآیند حضور و غیاب دارید؟",()=>m(!0),{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success",onCancel:()=>m(!1)})};l.hasSessionToday()?U("شما امروز یک جلسه برای این کلاس ثبت کرده‌اید. آیا از شروع یک جلسه جدید دیگر مطمئن هستید؟",f,{confirmText:"بله",confirmClass:"btn-warning"}):f()}}),t.addEventListener("click",()=>{const i=n.value.trim(),f=document.querySelector('input[name="class-type"]:checked');if(!i&&!f){C("⚠️لطفاً نام و نوع کلاس را مشخص کنید.");return}if(!i){C("⚠️لطفاً نام کلاس را وارد کنید.");return}if(!f){C("⚠️لطفاً نوع کلاس را انتخاب کنید.");return}if(N[i]){N[i].isDeleted?C("⚠️ کلاسی با این نام در سطل زباله است. ابتدا آن را بازیابی کنید و یا آن را پاک کنید."):C("⚠️کلاسی با این نام از قبل وجود دارد.");return}const m=f.value,g=new Qt({name:i,type:m});N[i]=g,w(),R(i,`کلاس «${i}» ایجاد شد.`,{type:"VIEW_SESSIONS"}),re(),C(`✅ کلاس «${i}» با موفقیت ایجاد شد.`),n.value="",f.checked=!1}),e.addEventListener("input",i=>{const f=i.target.value;if(f.length<2){Lt([]);return}const m=f.toLowerCase(),g=Jt(m),E=[];for(const T in N){const I=N[T];if(I.isDeleted)continue;P(I.students).filter(G=>{const ce=ye(G.identity.name.toLowerCase()),Re=ce.includes(ye(m)),Vt=ce.includes(ye(g));return Re||Vt}).forEach(G=>{E.push({student:G,classroom:I})})}Lt(E)}),n.addEventListener("keyup",i=>{i.key==="Enter"&&t.click()}),s.addEventListener("click",xs),document.querySelectorAll(".back-to-classes-btn").forEach(i=>{i.addEventListener("click",()=>{Z(null),ne(null),ot(null),L("class-management-page")})}),D.addEventListener("click",()=>{Me()}),V.addEventListener("click",()=>{Q(),L("session-page")}),js.addEventListener("click",()=>{if(j(null),!y&&l&&l.sessions.length>0){const i=P(l.sessions).filter(f=>!f.isCancelled);if(i.length>0){const f=i[i.length-1];ne(f)}else{Q(),L("session-page");return}}Me()}),ze.addEventListener("input",i=>{const f=i.target.value;if(!f){Qe([]);return}const m=f.toLowerCase(),g=Jt(m),T=P(l.students).filter(I=>{const Y=ye(I.identity.name.toLowerCase()),G=Y.includes(ye(m)),ce=Y.includes(ye(g));return G||ce});Qe(T)}),ze.addEventListener("focus",()=>{ze.value&&Qe(ze.value)}),Ue.addEventListener("click",()=>{const i=Ee.value,f=me.value.trim();let m;if(Mt)m=Mt.student;else{const E=y==null?void 0:y.winnerHistory[ue];m=E==null?void 0:E.winner}if(!m){C("❌خطا: دانش‌آموز معتبری برای ثبت نمره یافت نشد.");return}const g=le;if(!m||!g){C("⚠️لطفاً ابتدا یک دانش‌آموز و یک دسته‌بندی را انتخاب کنید.");return}if(!i){C("⚠️لطفاً مقدار نمره را وارد کنید.");return}if(i>100||i<0){C("❌نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}m&&(m.addScore(g.name,parseFloat(i),f),R(l.info.name,`نمره ${i} در ${g.name} برای «${m.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:m.identity.studentId}),w(),se(),C(`✅نمره برای ${m.identity.name} در مهارت ${g.name} ثبت شد.`),Ee.value="",me.value="",Ne(m,g.name))});const Pn=i=>{i.key==="Enter"&&i.ctrlKey&&(i.preventDefault(),Ue.click())};Ee.addEventListener("keydown",Pn),me.addEventListener("keydown",Pn),Xs.addEventListener("click",()=>{const i=Js.querySelector(".pill.active");if(!i){C("⚠️لطفاً یک مهارت را برای نمره‌دهی انتخاب کنید.");return}const f=i.dataset.skillName,m=Ks.value,g=Qs.value.trim();if(!m){C("لطفاً مقدار نمره را وارد کنید.");return}O.addScore(f,parseFloat(m),g),w(),R(l.info.name,`نمره ${m} در ${f} برای «${O.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:O.identity.studentId}),oe(),C(`✅نمره برای مهارت ${f} با موفقیت ثبت شد.`)}),document.getElementById("add-note-btn").addEventListener("click",()=>{O&&(ut.value="",ut.dispatchEvent(new Event("input",{bubbles:!0})),ge(i=>{i&&(O.addNote(i),w(),R(l.info.name,`یادداشت جدیدی برای دانش‌آموز «${O.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:O.identity.studentId}),rt())}),te("add-note-modal"),ut.focus())}),Us.addEventListener("click",()=>{z()}),qs.addEventListener("click",()=>{const i=ut.value.trim();typeof xt=="function"&&(xt(i),Ie(),z())});const io=document.getElementById("move-student-confirm-btn"),co=document.getElementById("move-student-cancel-btn"),ro=document.getElementById("move-student-class-select");co.addEventListener("click",()=>{z()}),io.addEventListener("click",()=>{const i=ro.value,f=N[i],{studentToMove:m,sourceClassForMove:g}=bo;if(!m||!g||!f){C("خطایی رخ داد. لطفاً دوباره امتحان کنید⚠️.","error"),z();return}const E=ts(m,g,f);E.success?(R(g.info.name,`دانش‌آموز «${m.identity.name}» به کلاس «${i}» منتقل شد.`,{type:"VIEW_SESSIONS"}),R(i,`دانش‌آموز «${m.identity.name}» از کلاس «${g.info.name}» به این کلاس منتقل شد.`,{type:"VIEW_SESSIONS"}),w(),be(),C(`دانش‌آموز «${m.identity.name}» با موفقیت به کلاس «${i}» منتقل شد✅.`)):C(E.message,"error"),z()}),de.addEventListener("click",()=>{J.style.width="300px",H.classList.add("modal-visible")}),He.addEventListener("click",ie),H.addEventListener("click",ie),ao.addEventListener("click",()=>{lt(),L("trash-page"),ie()}),document.getElementById("demo-mode-btn").addEventListener("click",()=>{fe?Fn():(ie(),U("شما در حال ورود به حالت نمایش (Demo) هستید. در این حالت، هیچ‌کدام از تغییرات شما ذخیره نخواهد شد. آیا ادامه می‌دهید؟",()=>{cs(),kt(),ie()},{confirmText:"تایید",confirmClass:"btn-warning",onCancel:ie}))});const Wn=document.getElementById("exit-demo-btn");Wn&&Wn.addEventListener("click",()=>{fe&&Fn()}),q.addEventListener("click",()=>{if(fe){C("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است."),ie();return}ie(),An()}),ee.addEventListener("click",()=>{if(fe){C("⚠️ بازیابی اطلاعات در حالت نمایش (Demo) غیرفعال است."),ie();return}Be.click(),ie()}),Be.addEventListener("change",i=>{const f=i.target.files[0];if(!f)return;const m=new FileReader;m.onload=g=>{try{const E=JSON.parse(g.target.result);U("آیا از بازیابی اطلاعات مطمئن هستید؟ تمام داده‌های فعلی شما بازنویسی خواهد شد.",()=>{E.classrooms?(qe(E.classrooms),Xt(E.trashBin||[])):(qe(E),Xt([])),w(),re(),L("class-management-page"),C("✅اطلاعات با موفقیت بازیابی شد.")},{confirmText:"بازیابی کن",confirmClass:"btn-warning"})}catch{C("❌خطا در خواندن فایل. لطفاً فایل پشتیبان معتبر انتخاب کنید.")}},m.readAsText(f),i.target.value=null}),window.addEventListener("popstate",i=>{if(Le&&history.pushState(null,"",location.href),De(),i.state){const{pageId:f,currentClassName:m,selectedSessionNumber:g,selectedStudentId:E}=i.state;m&&(Z(N[m]),g&&ne(l.getSession(g)),E&&j(l.students.find(T=>T.identity.studentId===E))),f==="student-page"?Me():(f==="session-page"&&Q(),tt(f))}else Z(null),ne(null),j(null),tt("class-management-page")}),document.addEventListener("keydown",i=>{var g;const f=document.activeElement;if(!["INPUT","TEXTAREA","SELECT"].includes(f.tagName)){if(i.key.toLowerCase()==="o"&&i.shiftKey&&Cs.classList.contains("active")&&(i.preventDefault(),bs.click()),i.key==="Escape"){if(Oe.classList.contains("visible")){De();return}if(Le){z();return}switch((g=document.querySelector(".page.active"))==null?void 0:g.id){case"csv-preview-page":case"column-mapping-page":L("settings-page");break;case"student-profile-page":j(null),L(y?"student-page":"session-page");break;case"attendance-page":L("student-page");break;case"student-page":ne(null),Q(),L("session-page");break;case"settings-page":case"session-page":Z(null),L("class-management-page");break}return}if(y){const E=i.key.toLowerCase();switch(" ascfg".includes(E)&&i.preventDefault(),E){case" ":$.click();break;case"a":A.classList.contains("active")?history.back():(Ie(),L("attendance-page"));break;case"s":document.getElementById("session-page").classList.contains("active")?history.back():a.click();break;case"c":document.querySelector(".back-to-classes-btn").click();break;case"f":const T=document.querySelector(".action-column .search-icon");T&&T.click();break;case"g":if(Gs.classList.contains("active"))history.back();else{const I=y.lastSelectedWinnerId;if(I){const Y=l.students.find(G=>G.identity.studentId===I);Y&&(j(Y),oe(),L("student-profile-page"))}else C("⚠️ابتدا یک نفر را انتخاب کنید تا پروفایل او نمایش داده شود.")}break;case"arrowleft":{const I=document.querySelector('button[title="برنده قبلی"]');I&&!I.disabled&&(i.preventDefault(),I.click());break}case"arrowright":{const I=document.querySelector('button[title="برنده بعدی"]');I&&!I.disabled&&(i.preventDefault(),I.click());break}}}}});function ie(){J.style.width="0",H.classList.add("modal-closing"),setTimeout(()=>{H.classList.remove("modal-visible","modal-closing")},300)}function Fn(){U("آیا از خروج از حالت نمایش (Demo) مطمئن هستید؟ با خروج، تمام تغییرات آزمایشی شما حذف شده و داده‌های اصلی شما بازیابی خواهند شد.",()=>{rs(),Z(null),ne(null),j(null),re(),L("class-management-page"),kt(),ie()},{confirmText:"خروج",confirmClass:"btn-success"})}_n(".global-search-container .animated-search-container",Lt),_n(".action-column-header .animated-search-container",Qe),[W,Bn,me,Es].forEach(i=>{i&&Hs(i)}),zs.addEventListener("click",()=>{Dn(O,l)});function qn(i,f){const m=P(f.students).filter(_=>_.identity.studentId!==i.identity.studentId);if(m.length===0)return;const g=m.reduce((_,K)=>K.statusCounters.totalSelections>_.statusCounters.totalSelections?K:_,m[0]);if(!g||g.statusCounters.totalSelections===0)return;i.categoryCounts=JSON.parse(JSON.stringify(g.categoryCounts)),i.statusCounters.totalSelections=g.statusCounters.totalSelections;const E=m.reduce((_,K)=>_+K.statusCounters.totalSelections,0),T=m.reduce((_,K)=>_+(K.statusCounters.missedChances||0),0),I=E>0?T/E:0;i.statusCounters.missedChances=Math.round(i.statusCounters.totalSelections*I);const Y=P(f.categories),G={};Y.forEach(_=>{const K=m.reduce((zt,jt)=>zt+(jt.categoryCounts[_.name]||0),0),Gt=m.reduce((zt,jt)=>zt+(jt.categoryIssues[_.name]||0),0);G[_.name]=K>0?Gt/K:0}),Y.forEach(_=>{const K=i.categoryCounts[_.name]||0,Gt=G[_.name]||0;i.categoryIssues[_.name]=Math.round(K*Gt)});const ce=f.liveSession;ce?i.onboardingSession=ce.sessionNumber:i.onboardingSession=f.sessions.length+1;const Re=P(f.sessions).filter(_=>_.isFinished&&!_.isCancelled),Vt="📝 یادداشت خودکار سیستم",yo=`این دانش‌آموز  از جلسه شماره ${Re.length} به کلاس اضافه شد. آمار مشارکت او بر اساس فعال‌ترین دانش‌آموز و آمار «فرصت از دست رفته» او بر اساس میانگین کلاس ثبت گردید:`,_e=[];i.statusCounters.totalSelections>0&&_e.push(`کل انتخاب‌ها: ${i.statusCounters.totalSelections}`),i.statusCounters.missedChances>0&&_e.push(`فرصت‌های از دست رفته: ${i.statusCounters.missedChances}`);for(const _ in i.categoryCounts){const K=i.categoryCounts[_];K>0&&_e.push(`انتخاب در «${_}»: ${K}`)}for(const _ in i.categoryIssues){const K=i.categoryIssues[_];K>0&&_e.push(`مشکل در «${_}»: ${K}`)}if(_e.length>0){const _=`${Vt}
${yo}

- ${_e.join(`
- `)}`;i.addNote(_)}}function Un(i){const m=`چون این کلاس جلسات برگزار شده دارد، برای ${i>1?"دانش‌آموزان جدید":"دانش‌آموز جدید"} آمار پایه‌ای (متناسب با سایر دانش‌آموزان) ثبت شد تا در فرایند انتخاب اختلالی ایجاد نشود.`;U(m,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}const lo="7.3.2";document.getElementById("app-version").textContent=`نسخه ${lo}`;function uo(){console.log("Starting universal backfill for writing scores...");let i=0;for(const f in N){const m=N[f];if(m.isDeleted)continue;let g=0;P(m.students).forEach(T=>{const I=T.logs.scores;if(!(I&&I.writing&&I.writing.length>0)){let G=-1;for(const ce in I)ce!=="writing"&&I[ce].forEach(Re=>{Re.value>G&&(G=Re.value)});if(G>-1){const ce=`Automatically assigned based on the highest score (${G}) from other skills.`;T.addScore("Writing",G,ce),g++}}}),g>0&&(console.log(`Updated ${g} student(s) in class: ${m.info.name}.`),i+=g)}i>0?(w(),console.log(`Update complete. A total of ${i} student(s) were updated across all classes. Data saved.`),document.getElementById("student-page").classList.contains("active")&&se()):console.log("No students needed updating in any class.")}window.backfillWritingScoresForAll=uo;function mo(){console.log("Starting backfill for 'outOfClassCount' and 'wasOutOfClass' properties...");let i=0,f=0;const m=localStorage.getItem("teacherAssistantData_v2");if(!m){console.log("No data found in localStorage. Nothing to do.");return}const g=JSON.parse(m);for(const E in g){const T=g[E];T.students&&T.students.forEach(I=>{I.statusCounters&&typeof I.statusCounters.outOfClassCount>"u"&&(I.statusCounters.outOfClassCount=0,i++)}),T.sessions&&T.sessions.forEach(I=>{if(I.studentRecords)for(const Y in I.studentRecords){const G=I.studentRecords[Y];typeof G.wasOutOfClass>"u"&&(G.wasOutOfClass=!1,f++)}})}localStorage.setItem("teacherAssistantData_v2",JSON.stringify(g)),console.log(`Backfill complete. Updated ${i} students and ${f} session records. Data saved.`),$t(),l&&se()}window.backfillExitCounters=mo;function fo(i){if(!i||!i.classroomName)return;const f=N[i.classroomName];if(!f){C("⚠️ کلاس مربوط به این گزارش یافت نشد.");return}Z(f),z(),setTimeout(()=>{switch(i.type){case"VIEW_STUDENT_PROFILE":{const m=f.students.find(g=>g.identity.studentId===i.studentId);m?(j(m),oe(),L("student-profile-page")):C("⚠️ دانش‌آموز مورد نظر یافت نشد.");break}case"VIEW_TRASH":lt(),L("trash-page");break;case"VIEW_SESSIONS":Q(),L("session-page");break;case"VIEW_CLASS_NOTE":$n(f);break;case"VIEW_CLASS_SETTINGS":On(f);break}},300)}eo.addEventListener("click",()=>{$s()}),to.addEventListener("click",()=>{z()}),no.addEventListener("click",()=>{const i=so.value.trim(),f=oo.checked;if(!i){xn.style.display==="flex"?U("کادر یادداشت خالی است. آیا مطمئنید که می‌خواهید یادداشت‌های قبلی دانش‌آموزان انتخاب‌شده را پاک کنید؟",()=>{z(),mn("",!1)},{confirmText:"پاک کردن",confirmClass:"btn-warning"}):C("⚠️ لطفاً متن یادداشت را وارد کنید.");return}z(()=>{mn(i,f)})});const Te=document.getElementById("screen-saver-overlay"),Vn=document.getElementById("screen-saver-toggle");let Ut;const po=2*60*1e3,Gn=["mousemove","keypress","scroll","click","touchstart"];function go(){Te.classList.add("visible")}function zn(){Te.classList.contains("visible")&&Te.classList.remove("visible")}function mt(){zn(),clearTimeout(Ut),Ut=setTimeout(go,po)}function ft(i){i.preventDefault(),i.stopPropagation(),setTimeout(mt,0)}function jn(){mt(),Gn.forEach(f=>window.addEventListener(f,mt)),Te.addEventListener("click",ft),Te.addEventListener("touchstart",ft);const i="7.3.2";{const f=document.getElementById("screen-saver-version");f&&(f.textContent=`v${i}`)}}function ho(){clearTimeout(Ut),zn(),Gn.forEach(i=>window.removeEventListener(i,mt)),Te.removeEventListener("click",ft),Te.removeEventListener("touchstart",ft)}Vn.checked=we.isScreenSaverEnabled,we.isScreenSaverEnabled&&jn(),Vn.addEventListener("change",i=>{i.target.checked?(Yt({isScreenSaverEnabled:!0}),jn()):(ie(),i.preventDefault(),U(`نکته:
محافظ صفحه در تلفن های همراه جدید کمک می کند که دستگاه باطری کمتری مصرف کند و به دلیل ثابت ماندن صفحه نمایش در گوشی های قدیمی تر، صفحه نمایش دچار ماندگی رد پیکسل نگردد. آیا مطمئن هستید که می خواهید این ویژگی را غیر فعال کنید؟`,()=>{i.target.checked=!1,Yt({isScreenSaverEnabled:!1}),ho(),C("توصیه می شود زمان خاموش شدن صفحه نمایش گوشی خود را به حداقل دو دقیقه تغییر دهید تا در استفاده های طولانی مدت صفحه نمایش گوشی اصطحلاک کمتری را تجربه کند",7e3)},{confirmText:"بله، غیرفعال کن",cancelText:"لغو",onCancel:()=>{i.target.checked=!0}}))})});
