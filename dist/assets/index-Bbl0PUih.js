(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))c(o);new MutationObserver(o=>{for(const t of o)if(t.type==="childList")for(const a of t.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&c(a)}).observe(document,{childList:!0,subtree:!0});function e(o){const t={};return o.integrity&&(t.integrity=o.integrity),o.referrerPolicy&&(t.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?t.credentials="include":o.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function c(o){if(o.ep)return;o.ep=!0;const t=e(o);fetch(o.href,t)}})();class yn{constructor(i){this.identity={name:i.name,firstName:i.firstName||null,lastName:i.lastName||null,studentId:i.studentId||`id_${new Date().getTime()}_${Math.random()}`,branchName:i.branchName||null,ageGroup:i.ageGroup||"adult",level:i.level||null,contact:{social:i.socialContact||null,parent:i.parentContact||null}},this.isDeleted=!1,this.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0,outOfClassCount:0},this.categoryCounts={},this.categoryIssues={},this.logs={parentContacts:[],scores:{},discipline:{},sessionHistory:{}},this.profile={notes:[],tags:[]},this.finalClassActivityScore=null,this.onboardingSession=null}addScore(i,e,c){if(e>100||e<0){console.log("نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}const o=i.toLowerCase();this.logs.scores[o]||(this.logs.scores[o]=[]);const t=new wa(i,e,c);this.logs.scores[o].push(t)}addNote(i,e=null){const c=new Ea(i,e);this.profile.notes.push(c)}getOverallAverageScore(){let i=0,e=0;for(const o in this.logs.scores)this.logs.scores[o].forEach(t=>{t.isDeleted||(i+=t.value,e++)});if(e===0)return null;const c=i/e;return Math.round(c*100)/100}}class wa{constructor(i,e,c=""){this.id=`score_${new Date().getTime()}`,this.skill=i,this.value=e,this.timestamp=new Date,this.comment=c,this.isDeleted=!1}}class Ea{constructor(i,e=null){this.id=`note_${new Date().getTime()}`,this.timestamp=new Date,this.content=i,this.isDeleted=!1,this.source=e}}class as{constructor(i="complete",e=""){this.status=i,this.comment=e,this.timestamp=new Date}}class li{constructor(i){this.sessionNumber=i,this.startTime=new Date,this.createdAt=new Date,this.note="",this.isDeleted=!1,this.endTime=null,this.isFinished=!1,this.isMakeup=!1,this.isCancelled=!1,this.studentRecords={},this.lastWinnerByCategory={},this.lastUsedCategoryId=null,this.lastSelectedWinnerId=null,this.winnerHistory=[]}end(){this.isFinished=!0,this.endTime=new Date}markAsMakeup(){this.isMakeup=!this.isMakeup}initializeStudentRecord(i){this.studentRecords[i]||(this.studentRecords[i]={attendance:"present",homework:new as,selections:{},hadIssue:!1,wasOutOfClass:!1})}setAttendance(i,e){this.initializeStudentRecord(i),this.studentRecords[i].attendance=e}setHomeworkStatus(i,e){this.initializeStudentRecord(i),this.studentRecords[i].homework.status=e}selectNextWinner(i,e,c){if(!e||e.length===0)return console.log("هیچ دانش‌آموزی در کلاس برای انتخاب وجود ندارد."),null;const o=this.lastWinnerByCategory[i];let t=e.filter(f=>f.identity.studentId!==o&&!f.isDeleted);if(t.length===0&&(t=e),t.length===0)return null;const a=(f,u)=>f.categoryCounts[u]||0,s=Math.min(...t.map(f=>a(f,i))),r=t.filter(f=>a(f,i)===s);let l;if(r.length===1)l=r[0];else if(r.length>1){const f=c.filter(v=>!v.isDeleted&&v.name!==i).map(v=>v.name),u=r.map(v=>{const b=f.reduce((C,_)=>C+a(v,_),0);return{student:v,otherCategoriesTotal:b}}),y=Math.min(...u.map(v=>v.otherCategoriesTotal)),m=u.filter(v=>v.otherCategoriesTotal===y).map(v=>v.student);m.length===1?l=m[0]:l=m[Math.floor(Math.random()*m.length)]}else l=t[Math.floor(Math.random()*t.length)];const h=l.identity.studentId;this.initializeStudentRecord(h);const p=(this.studentRecords[h].selections[i]||0)+1;return this.studentRecords[h].selections[i]=p,l.statusCounters.totalSelections++,l.categoryCounts[i]=(l.categoryCounts[i]||0)+1,this.lastWinnerByCategory[i]=h,l}}class rs{constructor(i){this.info={name:i.name||"NotNamed",teacherName:i.teacherName||null,type:i.type||"in-person",term:i.term||null,scheduleText:i.scheduleText||null,level:i.level||null,creationDate:i.creationDate?new Date(i.creationDate):new Date,scheduleCode:i.scheduleCode||`code_${new Date().getTime()}`,scheduleDays:i.scheduleDays||[],scheduleStartTime:i.scheduleStartTime||null,scheduleEndTime:i.scheduleEndTime||null},this.students=[],this.sessions=[],this.note="",this.isDeleted=!1,this.categories=[new ut("Vocabulary","Questions about words and meanings."),new ut("Grammar","Questions about sentence structure and rules."),new ut("Listening",void 0,!0),new ut("Speaking",void 0,!0),new ut("Reading",void 0,!0),new ut("Writing",void 0,!0)],this.futurePlans={}}addStudent(i){this.students.push(i)}removeStudent(i){this.students=this.students.filter(e=>e.identity.studentId!==i)}startNewSession(){const i=this.sessions.length+1,e=new li(i);return this.sessions.push(e),e}endSpecificSession(i){const e=this.getSession(i);return e&&!e.isFinished?(e.end(),!0):!1}getSession(i){return this.sessions.find(e=>e.sessionNumber===i)}markAsMakeup(i){const e=this.getSession(i);e&&e.markAsMakeup()}planForSession(i,e){this.futurePlans[i]=e}hasSessionToday(){const i=new Date().toDateString();return this.sessions.some(e=>!e.isDeleted&&e.startTime.toDateString()===i)}selectNextWinner(i,e){return e?e.selectNextWinner(i,this.students,this.categories):null}get liveSession(){for(let i=this.sessions.length-1;i>=0;i--)if(!this.sessions[i].isFinished)return this.sessions[i];return null}endLiveSession(){const i=this.liveSession;return i?(i.end(),!0):!1}calculateFinalStudentScore(i){const e=i.logs.scores,c=["reading","writing"];for(const f of c)if(!e[f]||e[f].length===0)return null;const o=e.listening&&e.listening.length>0,t=e.speaking&&e.speaking.length>0;if(!o&&!t)return null;const a=f=>e[f].reduce((y,m)=>y+m.value,0)/e[f].length;let s;o&&t?s=(a("listening")+a("speaking"))/2:o?s=a("listening"):s=a("speaking");const r=a("reading"),l=a("writing"),p=(s*3+r*2+l*1)/6;return Math.trunc(p*10)/10}assignAllFinalScores(){let i=0,e=[];console.log("شروع عملیات محاسبه نمره نهایی برای تمام دانش‌آموزان..."),this.students.forEach(o=>{const t=this.calculateFinalStudentScore(o);t!==null?(o.finalClassActivityScore=t,i++):(o.finalClassActivityScore=null,e.push(o.identity.name))});const c=e.length;console.log(`عملیات پایان یافت. تعداد نمرات موفق: ${i} | تعداد ناموفق (نمرات ناقص): ${c}`),c>0&&(console.log("اسامی دانش‌آموزانی که نمراتشان ناقص است:"),e.forEach(o=>console.log(`- ${o}`)))}}class ut{constructor(i,e="",c=!1){this.id=`cat_${new Date().getTime()}_${Math.random()}`,this.name=i,this.description=e,this.isDeleted=!1,this.isGradedCategory=c,this.isDeleted=!1}}var pn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function di(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}function gn(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var ui={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/(function(n,i){(function(e){n.exports=e()})(function(){return function e(c,o,t){function a(l,h){if(!o[l]){if(!c[l]){var p=typeof gn=="function"&&gn;if(!h&&p)return p(l,!0);if(s)return s(l,!0);var f=new Error("Cannot find module '"+l+"'");throw f.code="MODULE_NOT_FOUND",f}var u=o[l]={exports:{}};c[l][0].call(u.exports,function(y){var m=c[l][1][y];return a(m||y)},u,u.exports,e,c,o,t)}return o[l].exports}for(var s=typeof gn=="function"&&gn,r=0;r<t.length;r++)a(t[r]);return a}({1:[function(e,c,o){var t=e("./utils"),a=e("./support"),s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";o.encode=function(r){for(var l,h,p,f,u,y,m,v=[],b=0,C=r.length,_=C,S=t.getTypeOf(r)!=="string";b<r.length;)_=C-b,p=S?(l=r[b++],h=b<C?r[b++]:0,b<C?r[b++]:0):(l=r.charCodeAt(b++),h=b<C?r.charCodeAt(b++):0,b<C?r.charCodeAt(b++):0),f=l>>2,u=(3&l)<<4|h>>4,y=1<_?(15&h)<<2|p>>6:64,m=2<_?63&p:64,v.push(s.charAt(f)+s.charAt(u)+s.charAt(y)+s.charAt(m));return v.join("")},o.decode=function(r){var l,h,p,f,u,y,m=0,v=0,b="data:";if(r.substr(0,b.length)===b)throw new Error("Invalid base64 input, it looks like a data url.");var C,_=3*(r=r.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(r.charAt(r.length-1)===s.charAt(64)&&_--,r.charAt(r.length-2)===s.charAt(64)&&_--,_%1!=0)throw new Error("Invalid base64 input, bad content length.");for(C=a.uint8array?new Uint8Array(0|_):new Array(0|_);m<r.length;)l=s.indexOf(r.charAt(m++))<<2|(f=s.indexOf(r.charAt(m++)))>>4,h=(15&f)<<4|(u=s.indexOf(r.charAt(m++)))>>2,p=(3&u)<<6|(y=s.indexOf(r.charAt(m++))),C[v++]=l,u!==64&&(C[v++]=h),y!==64&&(C[v++]=p);return C}},{"./support":30,"./utils":32}],2:[function(e,c,o){var t=e("./external"),a=e("./stream/DataWorker"),s=e("./stream/Crc32Probe"),r=e("./stream/DataLengthProbe");function l(h,p,f,u,y){this.compressedSize=h,this.uncompressedSize=p,this.crc32=f,this.compression=u,this.compressedContent=y}l.prototype={getContentWorker:function(){var h=new a(t.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new r("data_length")),p=this;return h.on("end",function(){if(this.streamInfo.data_length!==p.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),h},getCompressedWorker:function(){return new a(t.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},l.createWorkerFrom=function(h,p,f){return h.pipe(new s).pipe(new r("uncompressedSize")).pipe(p.compressWorker(f)).pipe(new r("compressedSize")).withStreamInfo("compression",p)},c.exports=l},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,c,o){var t=e("./stream/GenericWorker");o.STORE={magic:"\0\0",compressWorker:function(){return new t("STORE compression")},uncompressWorker:function(){return new t("STORE decompression")}},o.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,c,o){var t=e("./utils"),a=function(){for(var s,r=[],l=0;l<256;l++){s=l;for(var h=0;h<8;h++)s=1&s?3988292384^s>>>1:s>>>1;r[l]=s}return r}();c.exports=function(s,r){return s!==void 0&&s.length?t.getTypeOf(s)!=="string"?function(l,h,p,f){var u=a,y=f+p;l^=-1;for(var m=f;m<y;m++)l=l>>>8^u[255&(l^h[m])];return-1^l}(0|r,s,s.length,0):function(l,h,p,f){var u=a,y=f+p;l^=-1;for(var m=f;m<y;m++)l=l>>>8^u[255&(l^h.charCodeAt(m))];return-1^l}(0|r,s,s.length,0):0}},{"./utils":32}],5:[function(e,c,o){o.base64=!1,o.binary=!1,o.dir=!1,o.createFolders=!0,o.date=null,o.compression=null,o.compressionOptions=null,o.comment=null,o.unixPermissions=null,o.dosPermissions=null},{}],6:[function(e,c,o){var t=null;t=typeof Promise<"u"?Promise:e("lie"),c.exports={Promise:t}},{lie:37}],7:[function(e,c,o){var t=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",a=e("pako"),s=e("./utils"),r=e("./stream/GenericWorker"),l=t?"uint8array":"array";function h(p,f){r.call(this,"FlateWorker/"+p),this._pako=null,this._pakoAction=p,this._pakoOptions=f,this.meta={}}o.magic="\b\0",s.inherits(h,r),h.prototype.processChunk=function(p){this.meta=p.meta,this._pako===null&&this._createPako(),this._pako.push(s.transformTo(l,p.data),!1)},h.prototype.flush=function(){r.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},h.prototype.cleanUp=function(){r.prototype.cleanUp.call(this),this._pako=null},h.prototype._createPako=function(){this._pako=new a[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var p=this;this._pako.onData=function(f){p.push({data:f,meta:p.meta})}},o.compressWorker=function(p){return new h("Deflate",p)},o.uncompressWorker=function(){return new h("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(e,c,o){function t(u,y){var m,v="";for(m=0;m<y;m++)v+=String.fromCharCode(255&u),u>>>=8;return v}function a(u,y,m,v,b,C){var _,S,I=u.file,x=u.compression,L=C!==l.utf8encode,D=s.transformTo("string",C(I.name)),R=s.transformTo("string",l.utf8encode(I.name)),P=I.comment,Q=s.transformTo("string",C(P)),k=s.transformTo("string",l.utf8encode(P)),z=R.length!==I.name.length,g=k.length!==P.length,H="",ue="",j="",fe=I.dir,F=I.date,ne={crc32:0,compressedSize:0,uncompressedSize:0};y&&!m||(ne.crc32=u.crc32,ne.compressedSize=u.compressedSize,ne.uncompressedSize=u.uncompressedSize);var O=0;y&&(O|=8),L||!z&&!g||(O|=2048);var M=0,oe=0;fe&&(M|=16),b==="UNIX"?(oe=798,M|=function(X,Ne){var Oe=X;return X||(Oe=Ne?16893:33204),(65535&Oe)<<16}(I.unixPermissions,fe)):(oe=20,M|=function(X){return 63&(X||0)}(I.dosPermissions)),_=F.getUTCHours(),_<<=6,_|=F.getUTCMinutes(),_<<=5,_|=F.getUTCSeconds()/2,S=F.getUTCFullYear()-1980,S<<=4,S|=F.getUTCMonth()+1,S<<=5,S|=F.getUTCDate(),z&&(ue=t(1,1)+t(h(D),4)+R,H+="up"+t(ue.length,2)+ue),g&&(j=t(1,1)+t(h(Q),4)+k,H+="uc"+t(j.length,2)+j);var te="";return te+=`
\0`,te+=t(O,2),te+=x.magic,te+=t(_,2),te+=t(S,2),te+=t(ne.crc32,4),te+=t(ne.compressedSize,4),te+=t(ne.uncompressedSize,4),te+=t(D.length,2),te+=t(H.length,2),{fileRecord:p.LOCAL_FILE_HEADER+te+D+H,dirRecord:p.CENTRAL_FILE_HEADER+t(oe,2)+te+t(Q.length,2)+"\0\0\0\0"+t(M,4)+t(v,4)+D+H+Q}}var s=e("../utils"),r=e("../stream/GenericWorker"),l=e("../utf8"),h=e("../crc32"),p=e("../signature");function f(u,y,m,v){r.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=y,this.zipPlatform=m,this.encodeFileName=v,this.streamFiles=u,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}s.inherits(f,r),f.prototype.push=function(u){var y=u.meta.percent||0,m=this.entriesCount,v=this._sources.length;this.accumulate?this.contentBuffer.push(u):(this.bytesWritten+=u.data.length,r.prototype.push.call(this,{data:u.data,meta:{currentFile:this.currentFile,percent:m?(y+100*(m-v-1))/m:100}}))},f.prototype.openedSource=function(u){this.currentSourceOffset=this.bytesWritten,this.currentFile=u.file.name;var y=this.streamFiles&&!u.file.dir;if(y){var m=a(u,y,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:m.fileRecord,meta:{percent:0}})}else this.accumulate=!0},f.prototype.closedSource=function(u){this.accumulate=!1;var y=this.streamFiles&&!u.file.dir,m=a(u,y,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(m.dirRecord),y)this.push({data:function(v){return p.DATA_DESCRIPTOR+t(v.crc32,4)+t(v.compressedSize,4)+t(v.uncompressedSize,4)}(u),meta:{percent:100}});else for(this.push({data:m.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},f.prototype.flush=function(){for(var u=this.bytesWritten,y=0;y<this.dirRecords.length;y++)this.push({data:this.dirRecords[y],meta:{percent:100}});var m=this.bytesWritten-u,v=function(b,C,_,S,I){var x=s.transformTo("string",I(S));return p.CENTRAL_DIRECTORY_END+"\0\0\0\0"+t(b,2)+t(b,2)+t(C,4)+t(_,4)+t(x.length,2)+x}(this.dirRecords.length,m,u,this.zipComment,this.encodeFileName);this.push({data:v,meta:{percent:100}})},f.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},f.prototype.registerPrevious=function(u){this._sources.push(u);var y=this;return u.on("data",function(m){y.processChunk(m)}),u.on("end",function(){y.closedSource(y.previous.streamInfo),y._sources.length?y.prepareNextSource():y.end()}),u.on("error",function(m){y.error(m)}),this},f.prototype.resume=function(){return!!r.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},f.prototype.error=function(u){var y=this._sources;if(!r.prototype.error.call(this,u))return!1;for(var m=0;m<y.length;m++)try{y[m].error(u)}catch{}return!0},f.prototype.lock=function(){r.prototype.lock.call(this);for(var u=this._sources,y=0;y<u.length;y++)u[y].lock()},c.exports=f},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,c,o){var t=e("../compressions"),a=e("./ZipFileWorker");o.generateWorker=function(s,r,l){var h=new a(r.streamFiles,l,r.platform,r.encodeFileName),p=0;try{s.forEach(function(f,u){p++;var y=function(C,_){var S=C||_,I=t[S];if(!I)throw new Error(S+" is not a valid compression method !");return I}(u.options.compression,r.compression),m=u.options.compressionOptions||r.compressionOptions||{},v=u.dir,b=u.date;u._compressWorker(y,m).withStreamInfo("file",{name:f,dir:v,date:b,comment:u.comment||"",unixPermissions:u.unixPermissions,dosPermissions:u.dosPermissions}).pipe(h)}),h.entriesCount=p}catch(f){h.error(f)}return h}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,c,o){function t(){if(!(this instanceof t))return new t;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var a=new t;for(var s in this)typeof this[s]!="function"&&(a[s]=this[s]);return a}}(t.prototype=e("./object")).loadAsync=e("./load"),t.support=e("./support"),t.defaults=e("./defaults"),t.version="3.10.1",t.loadAsync=function(a,s){return new t().loadAsync(a,s)},t.external=e("./external"),c.exports=t},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,c,o){var t=e("./utils"),a=e("./external"),s=e("./utf8"),r=e("./zipEntries"),l=e("./stream/Crc32Probe"),h=e("./nodejsUtils");function p(f){return new a.Promise(function(u,y){var m=f.decompressed.getContentWorker().pipe(new l);m.on("error",function(v){y(v)}).on("end",function(){m.streamInfo.crc32!==f.decompressed.crc32?y(new Error("Corrupted zip : CRC32 mismatch")):u()}).resume()})}c.exports=function(f,u){var y=this;return u=t.extend(u||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:s.utf8decode}),h.isNode&&h.isStream(f)?a.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):t.prepareContent("the loaded zip file",f,!0,u.optimizedBinaryString,u.base64).then(function(m){var v=new r(u);return v.load(m),v}).then(function(m){var v=[a.Promise.resolve(m)],b=m.files;if(u.checkCRC32)for(var C=0;C<b.length;C++)v.push(p(b[C]));return a.Promise.all(v)}).then(function(m){for(var v=m.shift(),b=v.files,C=0;C<b.length;C++){var _=b[C],S=_.fileNameStr,I=t.resolve(_.fileNameStr);y.file(I,_.decompressed,{binary:!0,optimizedBinaryString:!0,date:_.date,dir:_.dir,comment:_.fileCommentStr.length?_.fileCommentStr:null,unixPermissions:_.unixPermissions,dosPermissions:_.dosPermissions,createFolders:u.createFolders}),_.dir||(y.file(I).unsafeOriginalName=S)}return v.zipComment.length&&(y.comment=v.zipComment),y})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,c,o){var t=e("../utils"),a=e("../stream/GenericWorker");function s(r,l){a.call(this,"Nodejs stream input adapter for "+r),this._upstreamEnded=!1,this._bindStream(l)}t.inherits(s,a),s.prototype._bindStream=function(r){var l=this;(this._stream=r).pause(),r.on("data",function(h){l.push({data:h,meta:{percent:0}})}).on("error",function(h){l.isPaused?this.generatedError=h:l.error(h)}).on("end",function(){l.isPaused?l._upstreamEnded=!0:l.end()})},s.prototype.pause=function(){return!!a.prototype.pause.call(this)&&(this._stream.pause(),!0)},s.prototype.resume=function(){return!!a.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},c.exports=s},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,c,o){var t=e("readable-stream").Readable;function a(s,r,l){t.call(this,r),this._helper=s;var h=this;s.on("data",function(p,f){h.push(p)||h._helper.pause(),l&&l(f)}).on("error",function(p){h.emit("error",p)}).on("end",function(){h.push(null)})}e("../utils").inherits(a,t),a.prototype._read=function(){this._helper.resume()},c.exports=a},{"../utils":32,"readable-stream":16}],14:[function(e,c,o){c.exports={isNode:typeof Buffer<"u",newBufferFrom:function(t,a){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(t,a);if(typeof t=="number")throw new Error('The "data" argument must not be a number');return new Buffer(t,a)},allocBuffer:function(t){if(Buffer.alloc)return Buffer.alloc(t);var a=new Buffer(t);return a.fill(0),a},isBuffer:function(t){return Buffer.isBuffer(t)},isStream:function(t){return t&&typeof t.on=="function"&&typeof t.pause=="function"&&typeof t.resume=="function"}}},{}],15:[function(e,c,o){function t(I,x,L){var D,R=s.getTypeOf(x),P=s.extend(L||{},h);P.date=P.date||new Date,P.compression!==null&&(P.compression=P.compression.toUpperCase()),typeof P.unixPermissions=="string"&&(P.unixPermissions=parseInt(P.unixPermissions,8)),P.unixPermissions&&16384&P.unixPermissions&&(P.dir=!0),P.dosPermissions&&16&P.dosPermissions&&(P.dir=!0),P.dir&&(I=b(I)),P.createFolders&&(D=v(I))&&C.call(this,D,!0);var Q=R==="string"&&P.binary===!1&&P.base64===!1;L&&L.binary!==void 0||(P.binary=!Q),(x instanceof p&&x.uncompressedSize===0||P.dir||!x||x.length===0)&&(P.base64=!1,P.binary=!0,x="",P.compression="STORE",R="string");var k=null;k=x instanceof p||x instanceof r?x:y.isNode&&y.isStream(x)?new m(I,x):s.prepareContent(I,x,P.binary,P.optimizedBinaryString,P.base64);var z=new f(I,k,P);this.files[I]=z}var a=e("./utf8"),s=e("./utils"),r=e("./stream/GenericWorker"),l=e("./stream/StreamHelper"),h=e("./defaults"),p=e("./compressedObject"),f=e("./zipObject"),u=e("./generate"),y=e("./nodejsUtils"),m=e("./nodejs/NodejsStreamInputAdapter"),v=function(I){I.slice(-1)==="/"&&(I=I.substring(0,I.length-1));var x=I.lastIndexOf("/");return 0<x?I.substring(0,x):""},b=function(I){return I.slice(-1)!=="/"&&(I+="/"),I},C=function(I,x){return x=x!==void 0?x:h.createFolders,I=b(I),this.files[I]||t.call(this,I,null,{dir:!0,createFolders:x}),this.files[I]};function _(I){return Object.prototype.toString.call(I)==="[object RegExp]"}var S={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(I){var x,L,D;for(x in this.files)D=this.files[x],(L=x.slice(this.root.length,x.length))&&x.slice(0,this.root.length)===this.root&&I(L,D)},filter:function(I){var x=[];return this.forEach(function(L,D){I(L,D)&&x.push(D)}),x},file:function(I,x,L){if(arguments.length!==1)return I=this.root+I,t.call(this,I,x,L),this;if(_(I)){var D=I;return this.filter(function(P,Q){return!Q.dir&&D.test(P)})}var R=this.files[this.root+I];return R&&!R.dir?R:null},folder:function(I){if(!I)return this;if(_(I))return this.filter(function(R,P){return P.dir&&I.test(R)});var x=this.root+I,L=C.call(this,x),D=this.clone();return D.root=L.name,D},remove:function(I){I=this.root+I;var x=this.files[I];if(x||(I.slice(-1)!=="/"&&(I+="/"),x=this.files[I]),x&&!x.dir)delete this.files[I];else for(var L=this.filter(function(R,P){return P.name.slice(0,I.length)===I}),D=0;D<L.length;D++)delete this.files[L[D].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(I){var x,L={};try{if((L=s.extend(I||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:a.utf8encode})).type=L.type.toLowerCase(),L.compression=L.compression.toUpperCase(),L.type==="binarystring"&&(L.type="string"),!L.type)throw new Error("No output type specified.");s.checkSupport(L.type),L.platform!=="darwin"&&L.platform!=="freebsd"&&L.platform!=="linux"&&L.platform!=="sunos"||(L.platform="UNIX"),L.platform==="win32"&&(L.platform="DOS");var D=L.comment||this.comment||"";x=u.generateWorker(this,L,D)}catch(R){(x=new r("error")).error(R)}return new l(x,L.type||"string",L.mimeType)},generateAsync:function(I,x){return this.generateInternalStream(I).accumulate(x)},generateNodeStream:function(I,x){return(I=I||{}).type||(I.type="nodebuffer"),this.generateInternalStream(I).toNodejsStream(x)}};c.exports=S},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,c,o){c.exports=e("stream")},{stream:void 0}],17:[function(e,c,o){var t=e("./DataReader");function a(s){t.call(this,s);for(var r=0;r<this.data.length;r++)s[r]=255&s[r]}e("../utils").inherits(a,t),a.prototype.byteAt=function(s){return this.data[this.zero+s]},a.prototype.lastIndexOfSignature=function(s){for(var r=s.charCodeAt(0),l=s.charCodeAt(1),h=s.charCodeAt(2),p=s.charCodeAt(3),f=this.length-4;0<=f;--f)if(this.data[f]===r&&this.data[f+1]===l&&this.data[f+2]===h&&this.data[f+3]===p)return f-this.zero;return-1},a.prototype.readAndCheckSignature=function(s){var r=s.charCodeAt(0),l=s.charCodeAt(1),h=s.charCodeAt(2),p=s.charCodeAt(3),f=this.readData(4);return r===f[0]&&l===f[1]&&h===f[2]&&p===f[3]},a.prototype.readData=function(s){if(this.checkOffset(s),s===0)return[];var r=this.data.slice(this.zero+this.index,this.zero+this.index+s);return this.index+=s,r},c.exports=a},{"../utils":32,"./DataReader":18}],18:[function(e,c,o){var t=e("../utils");function a(s){this.data=s,this.length=s.length,this.index=0,this.zero=0}a.prototype={checkOffset:function(s){this.checkIndex(this.index+s)},checkIndex:function(s){if(this.length<this.zero+s||s<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+s+"). Corrupted zip ?")},setIndex:function(s){this.checkIndex(s),this.index=s},skip:function(s){this.setIndex(this.index+s)},byteAt:function(){},readInt:function(s){var r,l=0;for(this.checkOffset(s),r=this.index+s-1;r>=this.index;r--)l=(l<<8)+this.byteAt(r);return this.index+=s,l},readString:function(s){return t.transformTo("string",this.readData(s))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var s=this.readInt(4);return new Date(Date.UTC(1980+(s>>25&127),(s>>21&15)-1,s>>16&31,s>>11&31,s>>5&63,(31&s)<<1))}},c.exports=a},{"../utils":32}],19:[function(e,c,o){var t=e("./Uint8ArrayReader");function a(s){t.call(this,s)}e("../utils").inherits(a,t),a.prototype.readData=function(s){this.checkOffset(s);var r=this.data.slice(this.zero+this.index,this.zero+this.index+s);return this.index+=s,r},c.exports=a},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,c,o){var t=e("./DataReader");function a(s){t.call(this,s)}e("../utils").inherits(a,t),a.prototype.byteAt=function(s){return this.data.charCodeAt(this.zero+s)},a.prototype.lastIndexOfSignature=function(s){return this.data.lastIndexOf(s)-this.zero},a.prototype.readAndCheckSignature=function(s){return s===this.readData(4)},a.prototype.readData=function(s){this.checkOffset(s);var r=this.data.slice(this.zero+this.index,this.zero+this.index+s);return this.index+=s,r},c.exports=a},{"../utils":32,"./DataReader":18}],21:[function(e,c,o){var t=e("./ArrayReader");function a(s){t.call(this,s)}e("../utils").inherits(a,t),a.prototype.readData=function(s){if(this.checkOffset(s),s===0)return new Uint8Array(0);var r=this.data.subarray(this.zero+this.index,this.zero+this.index+s);return this.index+=s,r},c.exports=a},{"../utils":32,"./ArrayReader":17}],22:[function(e,c,o){var t=e("../utils"),a=e("../support"),s=e("./ArrayReader"),r=e("./StringReader"),l=e("./NodeBufferReader"),h=e("./Uint8ArrayReader");c.exports=function(p){var f=t.getTypeOf(p);return t.checkSupport(f),f!=="string"||a.uint8array?f==="nodebuffer"?new l(p):a.uint8array?new h(t.transformTo("uint8array",p)):new s(t.transformTo("array",p)):new r(p)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,c,o){o.LOCAL_FILE_HEADER="PK",o.CENTRAL_FILE_HEADER="PK",o.CENTRAL_DIRECTORY_END="PK",o.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",o.ZIP64_CENTRAL_DIRECTORY_END="PK",o.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(e,c,o){var t=e("./GenericWorker"),a=e("../utils");function s(r){t.call(this,"ConvertWorker to "+r),this.destType=r}a.inherits(s,t),s.prototype.processChunk=function(r){this.push({data:a.transformTo(this.destType,r.data),meta:r.meta})},c.exports=s},{"../utils":32,"./GenericWorker":28}],25:[function(e,c,o){var t=e("./GenericWorker"),a=e("../crc32");function s(){t.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}e("../utils").inherits(s,t),s.prototype.processChunk=function(r){this.streamInfo.crc32=a(r.data,this.streamInfo.crc32||0),this.push(r)},c.exports=s},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,c,o){var t=e("../utils"),a=e("./GenericWorker");function s(r){a.call(this,"DataLengthProbe for "+r),this.propName=r,this.withStreamInfo(r,0)}t.inherits(s,a),s.prototype.processChunk=function(r){if(r){var l=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=l+r.data.length}a.prototype.processChunk.call(this,r)},c.exports=s},{"../utils":32,"./GenericWorker":28}],27:[function(e,c,o){var t=e("../utils"),a=e("./GenericWorker");function s(r){a.call(this,"DataWorker");var l=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,r.then(function(h){l.dataIsReady=!0,l.data=h,l.max=h&&h.length||0,l.type=t.getTypeOf(h),l.isPaused||l._tickAndRepeat()},function(h){l.error(h)})}t.inherits(s,a),s.prototype.cleanUp=function(){a.prototype.cleanUp.call(this),this.data=null},s.prototype.resume=function(){return!!a.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,t.delay(this._tickAndRepeat,[],this)),!0)},s.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(t.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},s.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var r=null,l=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":r=this.data.substring(this.index,l);break;case"uint8array":r=this.data.subarray(this.index,l);break;case"array":case"nodebuffer":r=this.data.slice(this.index,l)}return this.index=l,this.push({data:r,meta:{percent:this.max?this.index/this.max*100:0}})},c.exports=s},{"../utils":32,"./GenericWorker":28}],28:[function(e,c,o){function t(a){this.name=a||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}t.prototype={push:function(a){this.emit("data",a)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(a){this.emit("error",a)}return!0},error:function(a){return!this.isFinished&&(this.isPaused?this.generatedError=a:(this.isFinished=!0,this.emit("error",a),this.previous&&this.previous.error(a),this.cleanUp()),!0)},on:function(a,s){return this._listeners[a].push(s),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(a,s){if(this._listeners[a])for(var r=0;r<this._listeners[a].length;r++)this._listeners[a][r].call(this,s)},pipe:function(a){return a.registerPrevious(this)},registerPrevious:function(a){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=a.streamInfo,this.mergeStreamInfo(),this.previous=a;var s=this;return a.on("data",function(r){s.processChunk(r)}),a.on("end",function(){s.end()}),a.on("error",function(r){s.error(r)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var a=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),a=!0),this.previous&&this.previous.resume(),!a},flush:function(){},processChunk:function(a){this.push(a)},withStreamInfo:function(a,s){return this.extraStreamInfo[a]=s,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var a in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,a)&&(this.streamInfo[a]=this.extraStreamInfo[a])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var a="Worker "+this.name;return this.previous?this.previous+" -> "+a:a}},c.exports=t},{}],29:[function(e,c,o){var t=e("../utils"),a=e("./ConvertWorker"),s=e("./GenericWorker"),r=e("../base64"),l=e("../support"),h=e("../external"),p=null;if(l.nodestream)try{p=e("../nodejs/NodejsStreamOutputAdapter")}catch{}function f(y,m){return new h.Promise(function(v,b){var C=[],_=y._internalType,S=y._outputType,I=y._mimeType;y.on("data",function(x,L){C.push(x),m&&m(L)}).on("error",function(x){C=[],b(x)}).on("end",function(){try{var x=function(L,D,R){switch(L){case"blob":return t.newBlob(t.transformTo("arraybuffer",D),R);case"base64":return r.encode(D);default:return t.transformTo(L,D)}}(S,function(L,D){var R,P=0,Q=null,k=0;for(R=0;R<D.length;R++)k+=D[R].length;switch(L){case"string":return D.join("");case"array":return Array.prototype.concat.apply([],D);case"uint8array":for(Q=new Uint8Array(k),R=0;R<D.length;R++)Q.set(D[R],P),P+=D[R].length;return Q;case"nodebuffer":return Buffer.concat(D);default:throw new Error("concat : unsupported type '"+L+"'")}}(_,C),I);v(x)}catch(L){b(L)}C=[]}).resume()})}function u(y,m,v){var b=m;switch(m){case"blob":case"arraybuffer":b="uint8array";break;case"base64":b="string"}try{this._internalType=b,this._outputType=m,this._mimeType=v,t.checkSupport(b),this._worker=y.pipe(new a(b)),y.lock()}catch(C){this._worker=new s("error"),this._worker.error(C)}}u.prototype={accumulate:function(y){return f(this,y)},on:function(y,m){var v=this;return y==="data"?this._worker.on(y,function(b){m.call(v,b.data,b.meta)}):this._worker.on(y,function(){t.delay(m,arguments,v)}),this},resume:function(){return t.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(y){if(t.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new p(this,{objectMode:this._outputType!=="nodebuffer"},y)}},c.exports=u},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,c,o){if(o.base64=!0,o.array=!0,o.string=!0,o.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",o.nodebuffer=typeof Buffer<"u",o.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")o.blob=!1;else{var t=new ArrayBuffer(0);try{o.blob=new Blob([t],{type:"application/zip"}).size===0}catch{try{var a=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);a.append(t),o.blob=a.getBlob("application/zip").size===0}catch{o.blob=!1}}}try{o.nodestream=!!e("readable-stream").Readable}catch{o.nodestream=!1}},{"readable-stream":16}],31:[function(e,c,o){for(var t=e("./utils"),a=e("./support"),s=e("./nodejsUtils"),r=e("./stream/GenericWorker"),l=new Array(256),h=0;h<256;h++)l[h]=252<=h?6:248<=h?5:240<=h?4:224<=h?3:192<=h?2:1;l[254]=l[254]=1;function p(){r.call(this,"utf-8 decode"),this.leftOver=null}function f(){r.call(this,"utf-8 encode")}o.utf8encode=function(u){return a.nodebuffer?s.newBufferFrom(u,"utf-8"):function(y){var m,v,b,C,_,S=y.length,I=0;for(C=0;C<S;C++)(64512&(v=y.charCodeAt(C)))==55296&&C+1<S&&(64512&(b=y.charCodeAt(C+1)))==56320&&(v=65536+(v-55296<<10)+(b-56320),C++),I+=v<128?1:v<2048?2:v<65536?3:4;for(m=a.uint8array?new Uint8Array(I):new Array(I),C=_=0;_<I;C++)(64512&(v=y.charCodeAt(C)))==55296&&C+1<S&&(64512&(b=y.charCodeAt(C+1)))==56320&&(v=65536+(v-55296<<10)+(b-56320),C++),v<128?m[_++]=v:(v<2048?m[_++]=192|v>>>6:(v<65536?m[_++]=224|v>>>12:(m[_++]=240|v>>>18,m[_++]=128|v>>>12&63),m[_++]=128|v>>>6&63),m[_++]=128|63&v);return m}(u)},o.utf8decode=function(u){return a.nodebuffer?t.transformTo("nodebuffer",u).toString("utf-8"):function(y){var m,v,b,C,_=y.length,S=new Array(2*_);for(m=v=0;m<_;)if((b=y[m++])<128)S[v++]=b;else if(4<(C=l[b]))S[v++]=65533,m+=C-1;else{for(b&=C===2?31:C===3?15:7;1<C&&m<_;)b=b<<6|63&y[m++],C--;1<C?S[v++]=65533:b<65536?S[v++]=b:(b-=65536,S[v++]=55296|b>>10&1023,S[v++]=56320|1023&b)}return S.length!==v&&(S.subarray?S=S.subarray(0,v):S.length=v),t.applyFromCharCode(S)}(u=t.transformTo(a.uint8array?"uint8array":"array",u))},t.inherits(p,r),p.prototype.processChunk=function(u){var y=t.transformTo(a.uint8array?"uint8array":"array",u.data);if(this.leftOver&&this.leftOver.length){if(a.uint8array){var m=y;(y=new Uint8Array(m.length+this.leftOver.length)).set(this.leftOver,0),y.set(m,this.leftOver.length)}else y=this.leftOver.concat(y);this.leftOver=null}var v=function(C,_){var S;for((_=_||C.length)>C.length&&(_=C.length),S=_-1;0<=S&&(192&C[S])==128;)S--;return S<0||S===0?_:S+l[C[S]]>_?S:_}(y),b=y;v!==y.length&&(a.uint8array?(b=y.subarray(0,v),this.leftOver=y.subarray(v,y.length)):(b=y.slice(0,v),this.leftOver=y.slice(v,y.length))),this.push({data:o.utf8decode(b),meta:u.meta})},p.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:o.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},o.Utf8DecodeWorker=p,t.inherits(f,r),f.prototype.processChunk=function(u){this.push({data:o.utf8encode(u.data),meta:u.meta})},o.Utf8EncodeWorker=f},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,c,o){var t=e("./support"),a=e("./base64"),s=e("./nodejsUtils"),r=e("./external");function l(m){return m}function h(m,v){for(var b=0;b<m.length;++b)v[b]=255&m.charCodeAt(b);return v}e("setimmediate"),o.newBlob=function(m,v){o.checkSupport("blob");try{return new Blob([m],{type:v})}catch{try{var b=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return b.append(m),b.getBlob(v)}catch{throw new Error("Bug : can't construct the Blob.")}}};var p={stringifyByChunk:function(m,v,b){var C=[],_=0,S=m.length;if(S<=b)return String.fromCharCode.apply(null,m);for(;_<S;)v==="array"||v==="nodebuffer"?C.push(String.fromCharCode.apply(null,m.slice(_,Math.min(_+b,S)))):C.push(String.fromCharCode.apply(null,m.subarray(_,Math.min(_+b,S)))),_+=b;return C.join("")},stringifyByChar:function(m){for(var v="",b=0;b<m.length;b++)v+=String.fromCharCode(m[b]);return v},applyCanBeUsed:{uint8array:function(){try{return t.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}}(),nodebuffer:function(){try{return t.nodebuffer&&String.fromCharCode.apply(null,s.allocBuffer(1)).length===1}catch{return!1}}()}};function f(m){var v=65536,b=o.getTypeOf(m),C=!0;if(b==="uint8array"?C=p.applyCanBeUsed.uint8array:b==="nodebuffer"&&(C=p.applyCanBeUsed.nodebuffer),C)for(;1<v;)try{return p.stringifyByChunk(m,b,v)}catch{v=Math.floor(v/2)}return p.stringifyByChar(m)}function u(m,v){for(var b=0;b<m.length;b++)v[b]=m[b];return v}o.applyFromCharCode=f;var y={};y.string={string:l,array:function(m){return h(m,new Array(m.length))},arraybuffer:function(m){return y.string.uint8array(m).buffer},uint8array:function(m){return h(m,new Uint8Array(m.length))},nodebuffer:function(m){return h(m,s.allocBuffer(m.length))}},y.array={string:f,array:l,arraybuffer:function(m){return new Uint8Array(m).buffer},uint8array:function(m){return new Uint8Array(m)},nodebuffer:function(m){return s.newBufferFrom(m)}},y.arraybuffer={string:function(m){return f(new Uint8Array(m))},array:function(m){return u(new Uint8Array(m),new Array(m.byteLength))},arraybuffer:l,uint8array:function(m){return new Uint8Array(m)},nodebuffer:function(m){return s.newBufferFrom(new Uint8Array(m))}},y.uint8array={string:f,array:function(m){return u(m,new Array(m.length))},arraybuffer:function(m){return m.buffer},uint8array:l,nodebuffer:function(m){return s.newBufferFrom(m)}},y.nodebuffer={string:f,array:function(m){return u(m,new Array(m.length))},arraybuffer:function(m){return y.nodebuffer.uint8array(m).buffer},uint8array:function(m){return u(m,new Uint8Array(m.length))},nodebuffer:l},o.transformTo=function(m,v){if(v=v||"",!m)return v;o.checkSupport(m);var b=o.getTypeOf(v);return y[b][m](v)},o.resolve=function(m){for(var v=m.split("/"),b=[],C=0;C<v.length;C++){var _=v[C];_==="."||_===""&&C!==0&&C!==v.length-1||(_===".."?b.pop():b.push(_))}return b.join("/")},o.getTypeOf=function(m){return typeof m=="string"?"string":Object.prototype.toString.call(m)==="[object Array]"?"array":t.nodebuffer&&s.isBuffer(m)?"nodebuffer":t.uint8array&&m instanceof Uint8Array?"uint8array":t.arraybuffer&&m instanceof ArrayBuffer?"arraybuffer":void 0},o.checkSupport=function(m){if(!t[m.toLowerCase()])throw new Error(m+" is not supported by this platform")},o.MAX_VALUE_16BITS=65535,o.MAX_VALUE_32BITS=-1,o.pretty=function(m){var v,b,C="";for(b=0;b<(m||"").length;b++)C+="\\x"+((v=m.charCodeAt(b))<16?"0":"")+v.toString(16).toUpperCase();return C},o.delay=function(m,v,b){setImmediate(function(){m.apply(b||null,v||[])})},o.inherits=function(m,v){function b(){}b.prototype=v.prototype,m.prototype=new b},o.extend=function(){var m,v,b={};for(m=0;m<arguments.length;m++)for(v in arguments[m])Object.prototype.hasOwnProperty.call(arguments[m],v)&&b[v]===void 0&&(b[v]=arguments[m][v]);return b},o.prepareContent=function(m,v,b,C,_){return r.Promise.resolve(v).then(function(S){return t.blob&&(S instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(S))!==-1)&&typeof FileReader<"u"?new r.Promise(function(I,x){var L=new FileReader;L.onload=function(D){I(D.target.result)},L.onerror=function(D){x(D.target.error)},L.readAsArrayBuffer(S)}):S}).then(function(S){var I=o.getTypeOf(S);return I?(I==="arraybuffer"?S=o.transformTo("uint8array",S):I==="string"&&(_?S=a.decode(S):b&&C!==!0&&(S=function(x){return h(x,t.uint8array?new Uint8Array(x.length):new Array(x.length))}(S))),S):r.Promise.reject(new Error("Can't read the data of '"+m+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(e,c,o){var t=e("./reader/readerFor"),a=e("./utils"),s=e("./signature"),r=e("./zipEntry"),l=e("./support");function h(p){this.files=[],this.loadOptions=p}h.prototype={checkSignature:function(p){if(!this.reader.readAndCheckSignature(p)){this.reader.index-=4;var f=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+a.pretty(f)+", expected "+a.pretty(p)+")")}},isSignature:function(p,f){var u=this.reader.index;this.reader.setIndex(p);var y=this.reader.readString(4)===f;return this.reader.setIndex(u),y},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var p=this.reader.readData(this.zipCommentLength),f=l.uint8array?"uint8array":"array",u=a.transformTo(f,p);this.zipComment=this.loadOptions.decodeFileName(u)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var p,f,u,y=this.zip64EndOfCentralSize-44;0<y;)p=this.reader.readInt(2),f=this.reader.readInt(4),u=this.reader.readData(f),this.zip64ExtensibleData[p]={id:p,length:f,value:u}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var p,f;for(p=0;p<this.files.length;p++)f=this.files[p],this.reader.setIndex(f.localHeaderOffset),this.checkSignature(s.LOCAL_FILE_HEADER),f.readLocalPart(this.reader),f.handleUTF8(),f.processAttributes()},readCentralDir:function(){var p;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(s.CENTRAL_FILE_HEADER);)(p=new r({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(p);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var p=this.reader.lastIndexOfSignature(s.CENTRAL_DIRECTORY_END);if(p<0)throw this.isSignature(0,s.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(p);var f=p;if(this.checkSignature(s.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===a.MAX_VALUE_16BITS||this.diskWithCentralDirStart===a.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===a.MAX_VALUE_16BITS||this.centralDirRecords===a.MAX_VALUE_16BITS||this.centralDirSize===a.MAX_VALUE_32BITS||this.centralDirOffset===a.MAX_VALUE_32BITS){if(this.zip64=!0,(p=this.reader.lastIndexOfSignature(s.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(p),this.checkSignature(s.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,s.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(s.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(s.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var u=this.centralDirOffset+this.centralDirSize;this.zip64&&(u+=20,u+=12+this.zip64EndOfCentralSize);var y=f-u;if(0<y)this.isSignature(f,s.CENTRAL_FILE_HEADER)||(this.reader.zero=y);else if(y<0)throw new Error("Corrupted zip: missing "+Math.abs(y)+" bytes.")},prepareReader:function(p){this.reader=t(p)},load:function(p){this.prepareReader(p),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},c.exports=h},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(e,c,o){var t=e("./reader/readerFor"),a=e("./utils"),s=e("./compressedObject"),r=e("./crc32"),l=e("./utf8"),h=e("./compressions"),p=e("./support");function f(u,y){this.options=u,this.loadOptions=y}f.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(u){var y,m;if(u.skip(22),this.fileNameLength=u.readInt(2),m=u.readInt(2),this.fileName=u.readData(this.fileNameLength),u.skip(m),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((y=function(v){for(var b in h)if(Object.prototype.hasOwnProperty.call(h,b)&&h[b].magic===v)return h[b];return null}(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+a.pretty(this.compressionMethod)+" unknown (inner file : "+a.transformTo("string",this.fileName)+")");this.decompressed=new s(this.compressedSize,this.uncompressedSize,this.crc32,y,u.readData(this.compressedSize))},readCentralPart:function(u){this.versionMadeBy=u.readInt(2),u.skip(2),this.bitFlag=u.readInt(2),this.compressionMethod=u.readString(2),this.date=u.readDate(),this.crc32=u.readInt(4),this.compressedSize=u.readInt(4),this.uncompressedSize=u.readInt(4);var y=u.readInt(2);if(this.extraFieldsLength=u.readInt(2),this.fileCommentLength=u.readInt(2),this.diskNumberStart=u.readInt(2),this.internalFileAttributes=u.readInt(2),this.externalFileAttributes=u.readInt(4),this.localHeaderOffset=u.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");u.skip(y),this.readExtraFields(u),this.parseZIP64ExtraField(u),this.fileComment=u.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var u=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),u==0&&(this.dosPermissions=63&this.externalFileAttributes),u==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var u=t(this.extraFields[1].value);this.uncompressedSize===a.MAX_VALUE_32BITS&&(this.uncompressedSize=u.readInt(8)),this.compressedSize===a.MAX_VALUE_32BITS&&(this.compressedSize=u.readInt(8)),this.localHeaderOffset===a.MAX_VALUE_32BITS&&(this.localHeaderOffset=u.readInt(8)),this.diskNumberStart===a.MAX_VALUE_32BITS&&(this.diskNumberStart=u.readInt(4))}},readExtraFields:function(u){var y,m,v,b=u.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});u.index+4<b;)y=u.readInt(2),m=u.readInt(2),v=u.readData(m),this.extraFields[y]={id:y,length:m,value:v};u.setIndex(b)},handleUTF8:function(){var u=p.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=l.utf8decode(this.fileName),this.fileCommentStr=l.utf8decode(this.fileComment);else{var y=this.findExtraFieldUnicodePath();if(y!==null)this.fileNameStr=y;else{var m=a.transformTo(u,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(m)}var v=this.findExtraFieldUnicodeComment();if(v!==null)this.fileCommentStr=v;else{var b=a.transformTo(u,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(b)}}},findExtraFieldUnicodePath:function(){var u=this.extraFields[28789];if(u){var y=t(u.value);return y.readInt(1)!==1||r(this.fileName)!==y.readInt(4)?null:l.utf8decode(y.readData(u.length-5))}return null},findExtraFieldUnicodeComment:function(){var u=this.extraFields[25461];if(u){var y=t(u.value);return y.readInt(1)!==1||r(this.fileComment)!==y.readInt(4)?null:l.utf8decode(y.readData(u.length-5))}return null}},c.exports=f},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(e,c,o){function t(y,m,v){this.name=y,this.dir=v.dir,this.date=v.date,this.comment=v.comment,this.unixPermissions=v.unixPermissions,this.dosPermissions=v.dosPermissions,this._data=m,this._dataBinary=v.binary,this.options={compression:v.compression,compressionOptions:v.compressionOptions}}var a=e("./stream/StreamHelper"),s=e("./stream/DataWorker"),r=e("./utf8"),l=e("./compressedObject"),h=e("./stream/GenericWorker");t.prototype={internalStream:function(y){var m=null,v="string";try{if(!y)throw new Error("No output type specified.");var b=(v=y.toLowerCase())==="string"||v==="text";v!=="binarystring"&&v!=="text"||(v="string"),m=this._decompressWorker();var C=!this._dataBinary;C&&!b&&(m=m.pipe(new r.Utf8EncodeWorker)),!C&&b&&(m=m.pipe(new r.Utf8DecodeWorker))}catch(_){(m=new h("error")).error(_)}return new a(m,v,"")},async:function(y,m){return this.internalStream(y).accumulate(m)},nodeStream:function(y,m){return this.internalStream(y||"nodebuffer").toNodejsStream(m)},_compressWorker:function(y,m){if(this._data instanceof l&&this._data.compression.magic===y.magic)return this._data.getCompressedWorker();var v=this._decompressWorker();return this._dataBinary||(v=v.pipe(new r.Utf8EncodeWorker)),l.createWorkerFrom(v,y,m)},_decompressWorker:function(){return this._data instanceof l?this._data.getContentWorker():this._data instanceof h?this._data:new s(this._data)}};for(var p=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],f=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},u=0;u<p.length;u++)t.prototype[p[u]]=f;c.exports=t},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(e,c,o){(function(t){var a,s,r=t.MutationObserver||t.WebKitMutationObserver;if(r){var l=0,h=new r(y),p=t.document.createTextNode("");h.observe(p,{characterData:!0}),a=function(){p.data=l=++l%2}}else if(t.setImmediate||t.MessageChannel===void 0)a="document"in t&&"onreadystatechange"in t.document.createElement("script")?function(){var m=t.document.createElement("script");m.onreadystatechange=function(){y(),m.onreadystatechange=null,m.parentNode.removeChild(m),m=null},t.document.documentElement.appendChild(m)}:function(){setTimeout(y,0)};else{var f=new t.MessageChannel;f.port1.onmessage=y,a=function(){f.port2.postMessage(0)}}var u=[];function y(){var m,v;s=!0;for(var b=u.length;b;){for(v=u,u=[],m=-1;++m<b;)v[m]();b=u.length}s=!1}c.exports=function(m){u.push(m)!==1||s||a()}}).call(this,typeof pn<"u"?pn:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(e,c,o){var t=e("immediate");function a(){}var s={},r=["REJECTED"],l=["FULFILLED"],h=["PENDING"];function p(b){if(typeof b!="function")throw new TypeError("resolver must be a function");this.state=h,this.queue=[],this.outcome=void 0,b!==a&&m(this,b)}function f(b,C,_){this.promise=b,typeof C=="function"&&(this.onFulfilled=C,this.callFulfilled=this.otherCallFulfilled),typeof _=="function"&&(this.onRejected=_,this.callRejected=this.otherCallRejected)}function u(b,C,_){t(function(){var S;try{S=C(_)}catch(I){return s.reject(b,I)}S===b?s.reject(b,new TypeError("Cannot resolve promise with itself")):s.resolve(b,S)})}function y(b){var C=b&&b.then;if(b&&(typeof b=="object"||typeof b=="function")&&typeof C=="function")return function(){C.apply(b,arguments)}}function m(b,C){var _=!1;function S(L){_||(_=!0,s.reject(b,L))}function I(L){_||(_=!0,s.resolve(b,L))}var x=v(function(){C(I,S)});x.status==="error"&&S(x.value)}function v(b,C){var _={};try{_.value=b(C),_.status="success"}catch(S){_.status="error",_.value=S}return _}(c.exports=p).prototype.finally=function(b){if(typeof b!="function")return this;var C=this.constructor;return this.then(function(_){return C.resolve(b()).then(function(){return _})},function(_){return C.resolve(b()).then(function(){throw _})})},p.prototype.catch=function(b){return this.then(null,b)},p.prototype.then=function(b,C){if(typeof b!="function"&&this.state===l||typeof C!="function"&&this.state===r)return this;var _=new this.constructor(a);return this.state!==h?u(_,this.state===l?b:C,this.outcome):this.queue.push(new f(_,b,C)),_},f.prototype.callFulfilled=function(b){s.resolve(this.promise,b)},f.prototype.otherCallFulfilled=function(b){u(this.promise,this.onFulfilled,b)},f.prototype.callRejected=function(b){s.reject(this.promise,b)},f.prototype.otherCallRejected=function(b){u(this.promise,this.onRejected,b)},s.resolve=function(b,C){var _=v(y,C);if(_.status==="error")return s.reject(b,_.value);var S=_.value;if(S)m(b,S);else{b.state=l,b.outcome=C;for(var I=-1,x=b.queue.length;++I<x;)b.queue[I].callFulfilled(C)}return b},s.reject=function(b,C){b.state=r,b.outcome=C;for(var _=-1,S=b.queue.length;++_<S;)b.queue[_].callRejected(C);return b},p.resolve=function(b){return b instanceof this?b:s.resolve(new this(a),b)},p.reject=function(b){var C=new this(a);return s.reject(C,b)},p.all=function(b){var C=this;if(Object.prototype.toString.call(b)!=="[object Array]")return this.reject(new TypeError("must be an array"));var _=b.length,S=!1;if(!_)return this.resolve([]);for(var I=new Array(_),x=0,L=-1,D=new this(a);++L<_;)R(b[L],L);return D;function R(P,Q){C.resolve(P).then(function(k){I[Q]=k,++x!==_||S||(S=!0,s.resolve(D,I))},function(k){S||(S=!0,s.reject(D,k))})}},p.race=function(b){var C=this;if(Object.prototype.toString.call(b)!=="[object Array]")return this.reject(new TypeError("must be an array"));var _=b.length,S=!1;if(!_)return this.resolve([]);for(var I=-1,x=new this(a);++I<_;)L=b[I],C.resolve(L).then(function(D){S||(S=!0,s.resolve(x,D))},function(D){S||(S=!0,s.reject(x,D))});var L;return x}},{immediate:36}],38:[function(e,c,o){var t={};(0,e("./lib/utils/common").assign)(t,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),c.exports=t},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(e,c,o){var t=e("./zlib/deflate"),a=e("./utils/common"),s=e("./utils/strings"),r=e("./zlib/messages"),l=e("./zlib/zstream"),h=Object.prototype.toString,p=0,f=-1,u=0,y=8;function m(b){if(!(this instanceof m))return new m(b);this.options=a.assign({level:f,method:y,chunkSize:16384,windowBits:15,memLevel:8,strategy:u,to:""},b||{});var C=this.options;C.raw&&0<C.windowBits?C.windowBits=-C.windowBits:C.gzip&&0<C.windowBits&&C.windowBits<16&&(C.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new l,this.strm.avail_out=0;var _=t.deflateInit2(this.strm,C.level,C.method,C.windowBits,C.memLevel,C.strategy);if(_!==p)throw new Error(r[_]);if(C.header&&t.deflateSetHeader(this.strm,C.header),C.dictionary){var S;if(S=typeof C.dictionary=="string"?s.string2buf(C.dictionary):h.call(C.dictionary)==="[object ArrayBuffer]"?new Uint8Array(C.dictionary):C.dictionary,(_=t.deflateSetDictionary(this.strm,S))!==p)throw new Error(r[_]);this._dict_set=!0}}function v(b,C){var _=new m(C);if(_.push(b,!0),_.err)throw _.msg||r[_.err];return _.result}m.prototype.push=function(b,C){var _,S,I=this.strm,x=this.options.chunkSize;if(this.ended)return!1;S=C===~~C?C:C===!0?4:0,typeof b=="string"?I.input=s.string2buf(b):h.call(b)==="[object ArrayBuffer]"?I.input=new Uint8Array(b):I.input=b,I.next_in=0,I.avail_in=I.input.length;do{if(I.avail_out===0&&(I.output=new a.Buf8(x),I.next_out=0,I.avail_out=x),(_=t.deflate(I,S))!==1&&_!==p)return this.onEnd(_),!(this.ended=!0);I.avail_out!==0&&(I.avail_in!==0||S!==4&&S!==2)||(this.options.to==="string"?this.onData(s.buf2binstring(a.shrinkBuf(I.output,I.next_out))):this.onData(a.shrinkBuf(I.output,I.next_out)))}while((0<I.avail_in||I.avail_out===0)&&_!==1);return S===4?(_=t.deflateEnd(this.strm),this.onEnd(_),this.ended=!0,_===p):S!==2||(this.onEnd(p),!(I.avail_out=0))},m.prototype.onData=function(b){this.chunks.push(b)},m.prototype.onEnd=function(b){b===p&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=a.flattenChunks(this.chunks)),this.chunks=[],this.err=b,this.msg=this.strm.msg},o.Deflate=m,o.deflate=v,o.deflateRaw=function(b,C){return(C=C||{}).raw=!0,v(b,C)},o.gzip=function(b,C){return(C=C||{}).gzip=!0,v(b,C)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(e,c,o){var t=e("./zlib/inflate"),a=e("./utils/common"),s=e("./utils/strings"),r=e("./zlib/constants"),l=e("./zlib/messages"),h=e("./zlib/zstream"),p=e("./zlib/gzheader"),f=Object.prototype.toString;function u(m){if(!(this instanceof u))return new u(m);this.options=a.assign({chunkSize:16384,windowBits:0,to:""},m||{});var v=this.options;v.raw&&0<=v.windowBits&&v.windowBits<16&&(v.windowBits=-v.windowBits,v.windowBits===0&&(v.windowBits=-15)),!(0<=v.windowBits&&v.windowBits<16)||m&&m.windowBits||(v.windowBits+=32),15<v.windowBits&&v.windowBits<48&&!(15&v.windowBits)&&(v.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new h,this.strm.avail_out=0;var b=t.inflateInit2(this.strm,v.windowBits);if(b!==r.Z_OK)throw new Error(l[b]);this.header=new p,t.inflateGetHeader(this.strm,this.header)}function y(m,v){var b=new u(v);if(b.push(m,!0),b.err)throw b.msg||l[b.err];return b.result}u.prototype.push=function(m,v){var b,C,_,S,I,x,L=this.strm,D=this.options.chunkSize,R=this.options.dictionary,P=!1;if(this.ended)return!1;C=v===~~v?v:v===!0?r.Z_FINISH:r.Z_NO_FLUSH,typeof m=="string"?L.input=s.binstring2buf(m):f.call(m)==="[object ArrayBuffer]"?L.input=new Uint8Array(m):L.input=m,L.next_in=0,L.avail_in=L.input.length;do{if(L.avail_out===0&&(L.output=new a.Buf8(D),L.next_out=0,L.avail_out=D),(b=t.inflate(L,r.Z_NO_FLUSH))===r.Z_NEED_DICT&&R&&(x=typeof R=="string"?s.string2buf(R):f.call(R)==="[object ArrayBuffer]"?new Uint8Array(R):R,b=t.inflateSetDictionary(this.strm,x)),b===r.Z_BUF_ERROR&&P===!0&&(b=r.Z_OK,P=!1),b!==r.Z_STREAM_END&&b!==r.Z_OK)return this.onEnd(b),!(this.ended=!0);L.next_out&&(L.avail_out!==0&&b!==r.Z_STREAM_END&&(L.avail_in!==0||C!==r.Z_FINISH&&C!==r.Z_SYNC_FLUSH)||(this.options.to==="string"?(_=s.utf8border(L.output,L.next_out),S=L.next_out-_,I=s.buf2string(L.output,_),L.next_out=S,L.avail_out=D-S,S&&a.arraySet(L.output,L.output,_,S,0),this.onData(I)):this.onData(a.shrinkBuf(L.output,L.next_out)))),L.avail_in===0&&L.avail_out===0&&(P=!0)}while((0<L.avail_in||L.avail_out===0)&&b!==r.Z_STREAM_END);return b===r.Z_STREAM_END&&(C=r.Z_FINISH),C===r.Z_FINISH?(b=t.inflateEnd(this.strm),this.onEnd(b),this.ended=!0,b===r.Z_OK):C!==r.Z_SYNC_FLUSH||(this.onEnd(r.Z_OK),!(L.avail_out=0))},u.prototype.onData=function(m){this.chunks.push(m)},u.prototype.onEnd=function(m){m===r.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=a.flattenChunks(this.chunks)),this.chunks=[],this.err=m,this.msg=this.strm.msg},o.Inflate=u,o.inflate=y,o.inflateRaw=function(m,v){return(v=v||{}).raw=!0,y(m,v)},o.ungzip=y},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(e,c,o){var t=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";o.assign=function(r){for(var l=Array.prototype.slice.call(arguments,1);l.length;){var h=l.shift();if(h){if(typeof h!="object")throw new TypeError(h+"must be non-object");for(var p in h)h.hasOwnProperty(p)&&(r[p]=h[p])}}return r},o.shrinkBuf=function(r,l){return r.length===l?r:r.subarray?r.subarray(0,l):(r.length=l,r)};var a={arraySet:function(r,l,h,p,f){if(l.subarray&&r.subarray)r.set(l.subarray(h,h+p),f);else for(var u=0;u<p;u++)r[f+u]=l[h+u]},flattenChunks:function(r){var l,h,p,f,u,y;for(l=p=0,h=r.length;l<h;l++)p+=r[l].length;for(y=new Uint8Array(p),l=f=0,h=r.length;l<h;l++)u=r[l],y.set(u,f),f+=u.length;return y}},s={arraySet:function(r,l,h,p,f){for(var u=0;u<p;u++)r[f+u]=l[h+u]},flattenChunks:function(r){return[].concat.apply([],r)}};o.setTyped=function(r){r?(o.Buf8=Uint8Array,o.Buf16=Uint16Array,o.Buf32=Int32Array,o.assign(o,a)):(o.Buf8=Array,o.Buf16=Array,o.Buf32=Array,o.assign(o,s))},o.setTyped(t)},{}],42:[function(e,c,o){var t=e("./common"),a=!0,s=!0;try{String.fromCharCode.apply(null,[0])}catch{a=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{s=!1}for(var r=new t.Buf8(256),l=0;l<256;l++)r[l]=252<=l?6:248<=l?5:240<=l?4:224<=l?3:192<=l?2:1;function h(p,f){if(f<65537&&(p.subarray&&s||!p.subarray&&a))return String.fromCharCode.apply(null,t.shrinkBuf(p,f));for(var u="",y=0;y<f;y++)u+=String.fromCharCode(p[y]);return u}r[254]=r[254]=1,o.string2buf=function(p){var f,u,y,m,v,b=p.length,C=0;for(m=0;m<b;m++)(64512&(u=p.charCodeAt(m)))==55296&&m+1<b&&(64512&(y=p.charCodeAt(m+1)))==56320&&(u=65536+(u-55296<<10)+(y-56320),m++),C+=u<128?1:u<2048?2:u<65536?3:4;for(f=new t.Buf8(C),m=v=0;v<C;m++)(64512&(u=p.charCodeAt(m)))==55296&&m+1<b&&(64512&(y=p.charCodeAt(m+1)))==56320&&(u=65536+(u-55296<<10)+(y-56320),m++),u<128?f[v++]=u:(u<2048?f[v++]=192|u>>>6:(u<65536?f[v++]=224|u>>>12:(f[v++]=240|u>>>18,f[v++]=128|u>>>12&63),f[v++]=128|u>>>6&63),f[v++]=128|63&u);return f},o.buf2binstring=function(p){return h(p,p.length)},o.binstring2buf=function(p){for(var f=new t.Buf8(p.length),u=0,y=f.length;u<y;u++)f[u]=p.charCodeAt(u);return f},o.buf2string=function(p,f){var u,y,m,v,b=f||p.length,C=new Array(2*b);for(u=y=0;u<b;)if((m=p[u++])<128)C[y++]=m;else if(4<(v=r[m]))C[y++]=65533,u+=v-1;else{for(m&=v===2?31:v===3?15:7;1<v&&u<b;)m=m<<6|63&p[u++],v--;1<v?C[y++]=65533:m<65536?C[y++]=m:(m-=65536,C[y++]=55296|m>>10&1023,C[y++]=56320|1023&m)}return h(C,y)},o.utf8border=function(p,f){var u;for((f=f||p.length)>p.length&&(f=p.length),u=f-1;0<=u&&(192&p[u])==128;)u--;return u<0||u===0?f:u+r[p[u]]>f?u:f}},{"./common":41}],43:[function(e,c,o){c.exports=function(t,a,s,r){for(var l=65535&t|0,h=t>>>16&65535|0,p=0;s!==0;){for(s-=p=2e3<s?2e3:s;h=h+(l=l+a[r++]|0)|0,--p;);l%=65521,h%=65521}return l|h<<16|0}},{}],44:[function(e,c,o){c.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(e,c,o){var t=function(){for(var a,s=[],r=0;r<256;r++){a=r;for(var l=0;l<8;l++)a=1&a?3988292384^a>>>1:a>>>1;s[r]=a}return s}();c.exports=function(a,s,r,l){var h=t,p=l+r;a^=-1;for(var f=l;f<p;f++)a=a>>>8^h[255&(a^s[f])];return-1^a}},{}],46:[function(e,c,o){var t,a=e("../utils/common"),s=e("./trees"),r=e("./adler32"),l=e("./crc32"),h=e("./messages"),p=0,f=4,u=0,y=-2,m=-1,v=4,b=2,C=8,_=9,S=286,I=30,x=19,L=2*S+1,D=15,R=3,P=258,Q=P+R+1,k=42,z=113,g=1,H=2,ue=3,j=4;function fe(d,W){return d.msg=h[W],W}function F(d){return(d<<1)-(4<d?9:0)}function ne(d){for(var W=d.length;0<=--W;)d[W]=0}function O(d){var W=d.state,$=W.pending;$>d.avail_out&&($=d.avail_out),$!==0&&(a.arraySet(d.output,W.pending_buf,W.pending_out,$,d.next_out),d.next_out+=$,W.pending_out+=$,d.total_out+=$,d.avail_out-=$,W.pending-=$,W.pending===0&&(W.pending_out=0))}function M(d,W){s._tr_flush_block(d,0<=d.block_start?d.block_start:-1,d.strstart-d.block_start,W),d.block_start=d.strstart,O(d.strm)}function oe(d,W){d.pending_buf[d.pending++]=W}function te(d,W){d.pending_buf[d.pending++]=W>>>8&255,d.pending_buf[d.pending++]=255&W}function X(d,W){var $,E,w=d.max_chain_length,T=d.strstart,q=d.prev_length,G=d.nice_match,A=d.strstart>d.w_size-Q?d.strstart-(d.w_size-Q):0,V=d.window,ie=d.w_mask,K=d.prev,le=d.strstart+P,Le=V[T+q-1],ye=V[T+q];d.prev_length>=d.good_match&&(w>>=2),G>d.lookahead&&(G=d.lookahead);do if(V[($=W)+q]===ye&&V[$+q-1]===Le&&V[$]===V[T]&&V[++$]===V[T+1]){T+=2,$++;do;while(V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&T<le);if(E=P-(le-T),T=le-P,q<E){if(d.match_start=W,G<=(q=E))break;Le=V[T+q-1],ye=V[T+q]}}while((W=K[W&ie])>A&&--w!=0);return q<=d.lookahead?q:d.lookahead}function Ne(d){var W,$,E,w,T,q,G,A,V,ie,K=d.w_size;do{if(w=d.window_size-d.lookahead-d.strstart,d.strstart>=K+(K-Q)){for(a.arraySet(d.window,d.window,K,K,0),d.match_start-=K,d.strstart-=K,d.block_start-=K,W=$=d.hash_size;E=d.head[--W],d.head[W]=K<=E?E-K:0,--$;);for(W=$=K;E=d.prev[--W],d.prev[W]=K<=E?E-K:0,--$;);w+=K}if(d.strm.avail_in===0)break;if(q=d.strm,G=d.window,A=d.strstart+d.lookahead,V=w,ie=void 0,ie=q.avail_in,V<ie&&(ie=V),$=ie===0?0:(q.avail_in-=ie,a.arraySet(G,q.input,q.next_in,ie,A),q.state.wrap===1?q.adler=r(q.adler,G,ie,A):q.state.wrap===2&&(q.adler=l(q.adler,G,ie,A)),q.next_in+=ie,q.total_in+=ie,ie),d.lookahead+=$,d.lookahead+d.insert>=R)for(T=d.strstart-d.insert,d.ins_h=d.window[T],d.ins_h=(d.ins_h<<d.hash_shift^d.window[T+1])&d.hash_mask;d.insert&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[T+R-1])&d.hash_mask,d.prev[T&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=T,T++,d.insert--,!(d.lookahead+d.insert<R)););}while(d.lookahead<Q&&d.strm.avail_in!==0)}function Oe(d,W){for(var $,E;;){if(d.lookahead<Q){if(Ne(d),d.lookahead<Q&&W===p)return g;if(d.lookahead===0)break}if($=0,d.lookahead>=R&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),$!==0&&d.strstart-$<=d.w_size-Q&&(d.match_length=X(d,$)),d.match_length>=R)if(E=s._tr_tally(d,d.strstart-d.match_start,d.match_length-R),d.lookahead-=d.match_length,d.match_length<=d.max_lazy_match&&d.lookahead>=R){for(d.match_length--;d.strstart++,d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart,--d.match_length!=0;);d.strstart++}else d.strstart+=d.match_length,d.match_length=0,d.ins_h=d.window[d.strstart],d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+1])&d.hash_mask;else E=s._tr_tally(d,0,d.window[d.strstart]),d.lookahead--,d.strstart++;if(E&&(M(d,!1),d.strm.avail_out===0))return g}return d.insert=d.strstart<R-1?d.strstart:R-1,W===f?(M(d,!0),d.strm.avail_out===0?ue:j):d.last_lit&&(M(d,!1),d.strm.avail_out===0)?g:H}function he(d,W){for(var $,E,w;;){if(d.lookahead<Q){if(Ne(d),d.lookahead<Q&&W===p)return g;if(d.lookahead===0)break}if($=0,d.lookahead>=R&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),d.prev_length=d.match_length,d.prev_match=d.match_start,d.match_length=R-1,$!==0&&d.prev_length<d.max_lazy_match&&d.strstart-$<=d.w_size-Q&&(d.match_length=X(d,$),d.match_length<=5&&(d.strategy===1||d.match_length===R&&4096<d.strstart-d.match_start)&&(d.match_length=R-1)),d.prev_length>=R&&d.match_length<=d.prev_length){for(w=d.strstart+d.lookahead-R,E=s._tr_tally(d,d.strstart-1-d.prev_match,d.prev_length-R),d.lookahead-=d.prev_length-1,d.prev_length-=2;++d.strstart<=w&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),--d.prev_length!=0;);if(d.match_available=0,d.match_length=R-1,d.strstart++,E&&(M(d,!1),d.strm.avail_out===0))return g}else if(d.match_available){if((E=s._tr_tally(d,0,d.window[d.strstart-1]))&&M(d,!1),d.strstart++,d.lookahead--,d.strm.avail_out===0)return g}else d.match_available=1,d.strstart++,d.lookahead--}return d.match_available&&(E=s._tr_tally(d,0,d.window[d.strstart-1]),d.match_available=0),d.insert=d.strstart<R-1?d.strstart:R-1,W===f?(M(d,!0),d.strm.avail_out===0?ue:j):d.last_lit&&(M(d,!1),d.strm.avail_out===0)?g:H}function Ce(d,W,$,E,w){this.good_length=d,this.max_lazy=W,this.nice_length=$,this.max_chain=E,this.func=w}function Te(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=C,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new a.Buf16(2*L),this.dyn_dtree=new a.Buf16(2*(2*I+1)),this.bl_tree=new a.Buf16(2*(2*x+1)),ne(this.dyn_ltree),ne(this.dyn_dtree),ne(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new a.Buf16(D+1),this.heap=new a.Buf16(2*S+1),ne(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new a.Buf16(2*S+1),ne(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function Ae(d){var W;return d&&d.state?(d.total_in=d.total_out=0,d.data_type=b,(W=d.state).pending=0,W.pending_out=0,W.wrap<0&&(W.wrap=-W.wrap),W.status=W.wrap?k:z,d.adler=W.wrap===2?0:1,W.last_flush=p,s._tr_init(W),u):fe(d,y)}function Ye(d){var W=Ae(d);return W===u&&function($){$.window_size=2*$.w_size,ne($.head),$.max_lazy_match=t[$.level].max_lazy,$.good_match=t[$.level].good_length,$.nice_match=t[$.level].nice_length,$.max_chain_length=t[$.level].max_chain,$.strstart=0,$.block_start=0,$.lookahead=0,$.insert=0,$.match_length=$.prev_length=R-1,$.match_available=0,$.ins_h=0}(d.state),W}function Xe(d,W,$,E,w,T){if(!d)return y;var q=1;if(W===m&&(W=6),E<0?(q=0,E=-E):15<E&&(q=2,E-=16),w<1||_<w||$!==C||E<8||15<E||W<0||9<W||T<0||v<T)return fe(d,y);E===8&&(E=9);var G=new Te;return(d.state=G).strm=d,G.wrap=q,G.gzhead=null,G.w_bits=E,G.w_size=1<<G.w_bits,G.w_mask=G.w_size-1,G.hash_bits=w+7,G.hash_size=1<<G.hash_bits,G.hash_mask=G.hash_size-1,G.hash_shift=~~((G.hash_bits+R-1)/R),G.window=new a.Buf8(2*G.w_size),G.head=new a.Buf16(G.hash_size),G.prev=new a.Buf16(G.w_size),G.lit_bufsize=1<<w+6,G.pending_buf_size=4*G.lit_bufsize,G.pending_buf=new a.Buf8(G.pending_buf_size),G.d_buf=1*G.lit_bufsize,G.l_buf=3*G.lit_bufsize,G.level=W,G.strategy=T,G.method=$,Ye(d)}t=[new Ce(0,0,0,0,function(d,W){var $=65535;for($>d.pending_buf_size-5&&($=d.pending_buf_size-5);;){if(d.lookahead<=1){if(Ne(d),d.lookahead===0&&W===p)return g;if(d.lookahead===0)break}d.strstart+=d.lookahead,d.lookahead=0;var E=d.block_start+$;if((d.strstart===0||d.strstart>=E)&&(d.lookahead=d.strstart-E,d.strstart=E,M(d,!1),d.strm.avail_out===0)||d.strstart-d.block_start>=d.w_size-Q&&(M(d,!1),d.strm.avail_out===0))return g}return d.insert=0,W===f?(M(d,!0),d.strm.avail_out===0?ue:j):(d.strstart>d.block_start&&(M(d,!1),d.strm.avail_out),g)}),new Ce(4,4,8,4,Oe),new Ce(4,5,16,8,Oe),new Ce(4,6,32,32,Oe),new Ce(4,4,16,16,he),new Ce(8,16,32,32,he),new Ce(8,16,128,128,he),new Ce(8,32,128,256,he),new Ce(32,128,258,1024,he),new Ce(32,258,258,4096,he)],o.deflateInit=function(d,W){return Xe(d,W,C,15,8,0)},o.deflateInit2=Xe,o.deflateReset=Ye,o.deflateResetKeep=Ae,o.deflateSetHeader=function(d,W){return d&&d.state?d.state.wrap!==2?y:(d.state.gzhead=W,u):y},o.deflate=function(d,W){var $,E,w,T;if(!d||!d.state||5<W||W<0)return d?fe(d,y):y;if(E=d.state,!d.output||!d.input&&d.avail_in!==0||E.status===666&&W!==f)return fe(d,d.avail_out===0?-5:y);if(E.strm=d,$=E.last_flush,E.last_flush=W,E.status===k)if(E.wrap===2)d.adler=0,oe(E,31),oe(E,139),oe(E,8),E.gzhead?(oe(E,(E.gzhead.text?1:0)+(E.gzhead.hcrc?2:0)+(E.gzhead.extra?4:0)+(E.gzhead.name?8:0)+(E.gzhead.comment?16:0)),oe(E,255&E.gzhead.time),oe(E,E.gzhead.time>>8&255),oe(E,E.gzhead.time>>16&255),oe(E,E.gzhead.time>>24&255),oe(E,E.level===9?2:2<=E.strategy||E.level<2?4:0),oe(E,255&E.gzhead.os),E.gzhead.extra&&E.gzhead.extra.length&&(oe(E,255&E.gzhead.extra.length),oe(E,E.gzhead.extra.length>>8&255)),E.gzhead.hcrc&&(d.adler=l(d.adler,E.pending_buf,E.pending,0)),E.gzindex=0,E.status=69):(oe(E,0),oe(E,0),oe(E,0),oe(E,0),oe(E,0),oe(E,E.level===9?2:2<=E.strategy||E.level<2?4:0),oe(E,3),E.status=z);else{var q=C+(E.w_bits-8<<4)<<8;q|=(2<=E.strategy||E.level<2?0:E.level<6?1:E.level===6?2:3)<<6,E.strstart!==0&&(q|=32),q+=31-q%31,E.status=z,te(E,q),E.strstart!==0&&(te(E,d.adler>>>16),te(E,65535&d.adler)),d.adler=1}if(E.status===69)if(E.gzhead.extra){for(w=E.pending;E.gzindex<(65535&E.gzhead.extra.length)&&(E.pending!==E.pending_buf_size||(E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),O(d),w=E.pending,E.pending!==E.pending_buf_size));)oe(E,255&E.gzhead.extra[E.gzindex]),E.gzindex++;E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),E.gzindex===E.gzhead.extra.length&&(E.gzindex=0,E.status=73)}else E.status=73;if(E.status===73)if(E.gzhead.name){w=E.pending;do{if(E.pending===E.pending_buf_size&&(E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),O(d),w=E.pending,E.pending===E.pending_buf_size)){T=1;break}T=E.gzindex<E.gzhead.name.length?255&E.gzhead.name.charCodeAt(E.gzindex++):0,oe(E,T)}while(T!==0);E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),T===0&&(E.gzindex=0,E.status=91)}else E.status=91;if(E.status===91)if(E.gzhead.comment){w=E.pending;do{if(E.pending===E.pending_buf_size&&(E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),O(d),w=E.pending,E.pending===E.pending_buf_size)){T=1;break}T=E.gzindex<E.gzhead.comment.length?255&E.gzhead.comment.charCodeAt(E.gzindex++):0,oe(E,T)}while(T!==0);E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),T===0&&(E.status=103)}else E.status=103;if(E.status===103&&(E.gzhead.hcrc?(E.pending+2>E.pending_buf_size&&O(d),E.pending+2<=E.pending_buf_size&&(oe(E,255&d.adler),oe(E,d.adler>>8&255),d.adler=0,E.status=z)):E.status=z),E.pending!==0){if(O(d),d.avail_out===0)return E.last_flush=-1,u}else if(d.avail_in===0&&F(W)<=F($)&&W!==f)return fe(d,-5);if(E.status===666&&d.avail_in!==0)return fe(d,-5);if(d.avail_in!==0||E.lookahead!==0||W!==p&&E.status!==666){var G=E.strategy===2?function(A,V){for(var ie;;){if(A.lookahead===0&&(Ne(A),A.lookahead===0)){if(V===p)return g;break}if(A.match_length=0,ie=s._tr_tally(A,0,A.window[A.strstart]),A.lookahead--,A.strstart++,ie&&(M(A,!1),A.strm.avail_out===0))return g}return A.insert=0,V===f?(M(A,!0),A.strm.avail_out===0?ue:j):A.last_lit&&(M(A,!1),A.strm.avail_out===0)?g:H}(E,W):E.strategy===3?function(A,V){for(var ie,K,le,Le,ye=A.window;;){if(A.lookahead<=P){if(Ne(A),A.lookahead<=P&&V===p)return g;if(A.lookahead===0)break}if(A.match_length=0,A.lookahead>=R&&0<A.strstart&&(K=ye[le=A.strstart-1])===ye[++le]&&K===ye[++le]&&K===ye[++le]){Le=A.strstart+P;do;while(K===ye[++le]&&K===ye[++le]&&K===ye[++le]&&K===ye[++le]&&K===ye[++le]&&K===ye[++le]&&K===ye[++le]&&K===ye[++le]&&le<Le);A.match_length=P-(Le-le),A.match_length>A.lookahead&&(A.match_length=A.lookahead)}if(A.match_length>=R?(ie=s._tr_tally(A,1,A.match_length-R),A.lookahead-=A.match_length,A.strstart+=A.match_length,A.match_length=0):(ie=s._tr_tally(A,0,A.window[A.strstart]),A.lookahead--,A.strstart++),ie&&(M(A,!1),A.strm.avail_out===0))return g}return A.insert=0,V===f?(M(A,!0),A.strm.avail_out===0?ue:j):A.last_lit&&(M(A,!1),A.strm.avail_out===0)?g:H}(E,W):t[E.level].func(E,W);if(G!==ue&&G!==j||(E.status=666),G===g||G===ue)return d.avail_out===0&&(E.last_flush=-1),u;if(G===H&&(W===1?s._tr_align(E):W!==5&&(s._tr_stored_block(E,0,0,!1),W===3&&(ne(E.head),E.lookahead===0&&(E.strstart=0,E.block_start=0,E.insert=0))),O(d),d.avail_out===0))return E.last_flush=-1,u}return W!==f?u:E.wrap<=0?1:(E.wrap===2?(oe(E,255&d.adler),oe(E,d.adler>>8&255),oe(E,d.adler>>16&255),oe(E,d.adler>>24&255),oe(E,255&d.total_in),oe(E,d.total_in>>8&255),oe(E,d.total_in>>16&255),oe(E,d.total_in>>24&255)):(te(E,d.adler>>>16),te(E,65535&d.adler)),O(d),0<E.wrap&&(E.wrap=-E.wrap),E.pending!==0?u:1)},o.deflateEnd=function(d){var W;return d&&d.state?(W=d.state.status)!==k&&W!==69&&W!==73&&W!==91&&W!==103&&W!==z&&W!==666?fe(d,y):(d.state=null,W===z?fe(d,-3):u):y},o.deflateSetDictionary=function(d,W){var $,E,w,T,q,G,A,V,ie=W.length;if(!d||!d.state||(T=($=d.state).wrap)===2||T===1&&$.status!==k||$.lookahead)return y;for(T===1&&(d.adler=r(d.adler,W,ie,0)),$.wrap=0,ie>=$.w_size&&(T===0&&(ne($.head),$.strstart=0,$.block_start=0,$.insert=0),V=new a.Buf8($.w_size),a.arraySet(V,W,ie-$.w_size,$.w_size,0),W=V,ie=$.w_size),q=d.avail_in,G=d.next_in,A=d.input,d.avail_in=ie,d.next_in=0,d.input=W,Ne($);$.lookahead>=R;){for(E=$.strstart,w=$.lookahead-(R-1);$.ins_h=($.ins_h<<$.hash_shift^$.window[E+R-1])&$.hash_mask,$.prev[E&$.w_mask]=$.head[$.ins_h],$.head[$.ins_h]=E,E++,--w;);$.strstart=E,$.lookahead=R-1,Ne($)}return $.strstart+=$.lookahead,$.block_start=$.strstart,$.insert=$.lookahead,$.lookahead=0,$.match_length=$.prev_length=R-1,$.match_available=0,d.next_in=G,d.input=A,d.avail_in=q,$.wrap=T,u},o.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(e,c,o){c.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(e,c,o){c.exports=function(t,a){var s,r,l,h,p,f,u,y,m,v,b,C,_,S,I,x,L,D,R,P,Q,k,z,g,H;s=t.state,r=t.next_in,g=t.input,l=r+(t.avail_in-5),h=t.next_out,H=t.output,p=h-(a-t.avail_out),f=h+(t.avail_out-257),u=s.dmax,y=s.wsize,m=s.whave,v=s.wnext,b=s.window,C=s.hold,_=s.bits,S=s.lencode,I=s.distcode,x=(1<<s.lenbits)-1,L=(1<<s.distbits)-1;e:do{_<15&&(C+=g[r++]<<_,_+=8,C+=g[r++]<<_,_+=8),D=S[C&x];t:for(;;){if(C>>>=R=D>>>24,_-=R,(R=D>>>16&255)===0)H[h++]=65535&D;else{if(!(16&R)){if(!(64&R)){D=S[(65535&D)+(C&(1<<R)-1)];continue t}if(32&R){s.mode=12;break e}t.msg="invalid literal/length code",s.mode=30;break e}P=65535&D,(R&=15)&&(_<R&&(C+=g[r++]<<_,_+=8),P+=C&(1<<R)-1,C>>>=R,_-=R),_<15&&(C+=g[r++]<<_,_+=8,C+=g[r++]<<_,_+=8),D=I[C&L];n:for(;;){if(C>>>=R=D>>>24,_-=R,!(16&(R=D>>>16&255))){if(!(64&R)){D=I[(65535&D)+(C&(1<<R)-1)];continue n}t.msg="invalid distance code",s.mode=30;break e}if(Q=65535&D,_<(R&=15)&&(C+=g[r++]<<_,(_+=8)<R&&(C+=g[r++]<<_,_+=8)),u<(Q+=C&(1<<R)-1)){t.msg="invalid distance too far back",s.mode=30;break e}if(C>>>=R,_-=R,(R=h-p)<Q){if(m<(R=Q-R)&&s.sane){t.msg="invalid distance too far back",s.mode=30;break e}if(z=b,(k=0)===v){if(k+=y-R,R<P){for(P-=R;H[h++]=b[k++],--R;);k=h-Q,z=H}}else if(v<R){if(k+=y+v-R,(R-=v)<P){for(P-=R;H[h++]=b[k++],--R;);if(k=0,v<P){for(P-=R=v;H[h++]=b[k++],--R;);k=h-Q,z=H}}}else if(k+=v-R,R<P){for(P-=R;H[h++]=b[k++],--R;);k=h-Q,z=H}for(;2<P;)H[h++]=z[k++],H[h++]=z[k++],H[h++]=z[k++],P-=3;P&&(H[h++]=z[k++],1<P&&(H[h++]=z[k++]))}else{for(k=h-Q;H[h++]=H[k++],H[h++]=H[k++],H[h++]=H[k++],2<(P-=3););P&&(H[h++]=H[k++],1<P&&(H[h++]=H[k++]))}break}}break}}while(r<l&&h<f);r-=P=_>>3,C&=(1<<(_-=P<<3))-1,t.next_in=r,t.next_out=h,t.avail_in=r<l?l-r+5:5-(r-l),t.avail_out=h<f?f-h+257:257-(h-f),s.hold=C,s.bits=_}},{}],49:[function(e,c,o){var t=e("../utils/common"),a=e("./adler32"),s=e("./crc32"),r=e("./inffast"),l=e("./inftrees"),h=1,p=2,f=0,u=-2,y=1,m=852,v=592;function b(k){return(k>>>24&255)+(k>>>8&65280)+((65280&k)<<8)+((255&k)<<24)}function C(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new t.Buf16(320),this.work=new t.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function _(k){var z;return k&&k.state?(z=k.state,k.total_in=k.total_out=z.total=0,k.msg="",z.wrap&&(k.adler=1&z.wrap),z.mode=y,z.last=0,z.havedict=0,z.dmax=32768,z.head=null,z.hold=0,z.bits=0,z.lencode=z.lendyn=new t.Buf32(m),z.distcode=z.distdyn=new t.Buf32(v),z.sane=1,z.back=-1,f):u}function S(k){var z;return k&&k.state?((z=k.state).wsize=0,z.whave=0,z.wnext=0,_(k)):u}function I(k,z){var g,H;return k&&k.state?(H=k.state,z<0?(g=0,z=-z):(g=1+(z>>4),z<48&&(z&=15)),z&&(z<8||15<z)?u:(H.window!==null&&H.wbits!==z&&(H.window=null),H.wrap=g,H.wbits=z,S(k))):u}function x(k,z){var g,H;return k?(H=new C,(k.state=H).window=null,(g=I(k,z))!==f&&(k.state=null),g):u}var L,D,R=!0;function P(k){if(R){var z;for(L=new t.Buf32(512),D=new t.Buf32(32),z=0;z<144;)k.lens[z++]=8;for(;z<256;)k.lens[z++]=9;for(;z<280;)k.lens[z++]=7;for(;z<288;)k.lens[z++]=8;for(l(h,k.lens,0,288,L,0,k.work,{bits:9}),z=0;z<32;)k.lens[z++]=5;l(p,k.lens,0,32,D,0,k.work,{bits:5}),R=!1}k.lencode=L,k.lenbits=9,k.distcode=D,k.distbits=5}function Q(k,z,g,H){var ue,j=k.state;return j.window===null&&(j.wsize=1<<j.wbits,j.wnext=0,j.whave=0,j.window=new t.Buf8(j.wsize)),H>=j.wsize?(t.arraySet(j.window,z,g-j.wsize,j.wsize,0),j.wnext=0,j.whave=j.wsize):(H<(ue=j.wsize-j.wnext)&&(ue=H),t.arraySet(j.window,z,g-H,ue,j.wnext),(H-=ue)?(t.arraySet(j.window,z,g-H,H,0),j.wnext=H,j.whave=j.wsize):(j.wnext+=ue,j.wnext===j.wsize&&(j.wnext=0),j.whave<j.wsize&&(j.whave+=ue))),0}o.inflateReset=S,o.inflateReset2=I,o.inflateResetKeep=_,o.inflateInit=function(k){return x(k,15)},o.inflateInit2=x,o.inflate=function(k,z){var g,H,ue,j,fe,F,ne,O,M,oe,te,X,Ne,Oe,he,Ce,Te,Ae,Ye,Xe,d,W,$,E,w=0,T=new t.Buf8(4),q=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!k||!k.state||!k.output||!k.input&&k.avail_in!==0)return u;(g=k.state).mode===12&&(g.mode=13),fe=k.next_out,ue=k.output,ne=k.avail_out,j=k.next_in,H=k.input,F=k.avail_in,O=g.hold,M=g.bits,oe=F,te=ne,W=f;e:for(;;)switch(g.mode){case y:if(g.wrap===0){g.mode=13;break}for(;M<16;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(2&g.wrap&&O===35615){T[g.check=0]=255&O,T[1]=O>>>8&255,g.check=s(g.check,T,2,0),M=O=0,g.mode=2;break}if(g.flags=0,g.head&&(g.head.done=!1),!(1&g.wrap)||(((255&O)<<8)+(O>>8))%31){k.msg="incorrect header check",g.mode=30;break}if((15&O)!=8){k.msg="unknown compression method",g.mode=30;break}if(M-=4,d=8+(15&(O>>>=4)),g.wbits===0)g.wbits=d;else if(d>g.wbits){k.msg="invalid window size",g.mode=30;break}g.dmax=1<<d,k.adler=g.check=1,g.mode=512&O?10:12,M=O=0;break;case 2:for(;M<16;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(g.flags=O,(255&g.flags)!=8){k.msg="unknown compression method",g.mode=30;break}if(57344&g.flags){k.msg="unknown header flags set",g.mode=30;break}g.head&&(g.head.text=O>>8&1),512&g.flags&&(T[0]=255&O,T[1]=O>>>8&255,g.check=s(g.check,T,2,0)),M=O=0,g.mode=3;case 3:for(;M<32;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}g.head&&(g.head.time=O),512&g.flags&&(T[0]=255&O,T[1]=O>>>8&255,T[2]=O>>>16&255,T[3]=O>>>24&255,g.check=s(g.check,T,4,0)),M=O=0,g.mode=4;case 4:for(;M<16;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}g.head&&(g.head.xflags=255&O,g.head.os=O>>8),512&g.flags&&(T[0]=255&O,T[1]=O>>>8&255,g.check=s(g.check,T,2,0)),M=O=0,g.mode=5;case 5:if(1024&g.flags){for(;M<16;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}g.length=O,g.head&&(g.head.extra_len=O),512&g.flags&&(T[0]=255&O,T[1]=O>>>8&255,g.check=s(g.check,T,2,0)),M=O=0}else g.head&&(g.head.extra=null);g.mode=6;case 6:if(1024&g.flags&&(F<(X=g.length)&&(X=F),X&&(g.head&&(d=g.head.extra_len-g.length,g.head.extra||(g.head.extra=new Array(g.head.extra_len)),t.arraySet(g.head.extra,H,j,X,d)),512&g.flags&&(g.check=s(g.check,H,X,j)),F-=X,j+=X,g.length-=X),g.length))break e;g.length=0,g.mode=7;case 7:if(2048&g.flags){if(F===0)break e;for(X=0;d=H[j+X++],g.head&&d&&g.length<65536&&(g.head.name+=String.fromCharCode(d)),d&&X<F;);if(512&g.flags&&(g.check=s(g.check,H,X,j)),F-=X,j+=X,d)break e}else g.head&&(g.head.name=null);g.length=0,g.mode=8;case 8:if(4096&g.flags){if(F===0)break e;for(X=0;d=H[j+X++],g.head&&d&&g.length<65536&&(g.head.comment+=String.fromCharCode(d)),d&&X<F;);if(512&g.flags&&(g.check=s(g.check,H,X,j)),F-=X,j+=X,d)break e}else g.head&&(g.head.comment=null);g.mode=9;case 9:if(512&g.flags){for(;M<16;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(O!==(65535&g.check)){k.msg="header crc mismatch",g.mode=30;break}M=O=0}g.head&&(g.head.hcrc=g.flags>>9&1,g.head.done=!0),k.adler=g.check=0,g.mode=12;break;case 10:for(;M<32;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}k.adler=g.check=b(O),M=O=0,g.mode=11;case 11:if(g.havedict===0)return k.next_out=fe,k.avail_out=ne,k.next_in=j,k.avail_in=F,g.hold=O,g.bits=M,2;k.adler=g.check=1,g.mode=12;case 12:if(z===5||z===6)break e;case 13:if(g.last){O>>>=7&M,M-=7&M,g.mode=27;break}for(;M<3;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}switch(g.last=1&O,M-=1,3&(O>>>=1)){case 0:g.mode=14;break;case 1:if(P(g),g.mode=20,z!==6)break;O>>>=2,M-=2;break e;case 2:g.mode=17;break;case 3:k.msg="invalid block type",g.mode=30}O>>>=2,M-=2;break;case 14:for(O>>>=7&M,M-=7&M;M<32;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if((65535&O)!=(O>>>16^65535)){k.msg="invalid stored block lengths",g.mode=30;break}if(g.length=65535&O,M=O=0,g.mode=15,z===6)break e;case 15:g.mode=16;case 16:if(X=g.length){if(F<X&&(X=F),ne<X&&(X=ne),X===0)break e;t.arraySet(ue,H,j,X,fe),F-=X,j+=X,ne-=X,fe+=X,g.length-=X;break}g.mode=12;break;case 17:for(;M<14;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(g.nlen=257+(31&O),O>>>=5,M-=5,g.ndist=1+(31&O),O>>>=5,M-=5,g.ncode=4+(15&O),O>>>=4,M-=4,286<g.nlen||30<g.ndist){k.msg="too many length or distance symbols",g.mode=30;break}g.have=0,g.mode=18;case 18:for(;g.have<g.ncode;){for(;M<3;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}g.lens[q[g.have++]]=7&O,O>>>=3,M-=3}for(;g.have<19;)g.lens[q[g.have++]]=0;if(g.lencode=g.lendyn,g.lenbits=7,$={bits:g.lenbits},W=l(0,g.lens,0,19,g.lencode,0,g.work,$),g.lenbits=$.bits,W){k.msg="invalid code lengths set",g.mode=30;break}g.have=0,g.mode=19;case 19:for(;g.have<g.nlen+g.ndist;){for(;Ce=(w=g.lencode[O&(1<<g.lenbits)-1])>>>16&255,Te=65535&w,!((he=w>>>24)<=M);){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(Te<16)O>>>=he,M-=he,g.lens[g.have++]=Te;else{if(Te===16){for(E=he+2;M<E;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(O>>>=he,M-=he,g.have===0){k.msg="invalid bit length repeat",g.mode=30;break}d=g.lens[g.have-1],X=3+(3&O),O>>>=2,M-=2}else if(Te===17){for(E=he+3;M<E;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}M-=he,d=0,X=3+(7&(O>>>=he)),O>>>=3,M-=3}else{for(E=he+7;M<E;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}M-=he,d=0,X=11+(127&(O>>>=he)),O>>>=7,M-=7}if(g.have+X>g.nlen+g.ndist){k.msg="invalid bit length repeat",g.mode=30;break}for(;X--;)g.lens[g.have++]=d}}if(g.mode===30)break;if(g.lens[256]===0){k.msg="invalid code -- missing end-of-block",g.mode=30;break}if(g.lenbits=9,$={bits:g.lenbits},W=l(h,g.lens,0,g.nlen,g.lencode,0,g.work,$),g.lenbits=$.bits,W){k.msg="invalid literal/lengths set",g.mode=30;break}if(g.distbits=6,g.distcode=g.distdyn,$={bits:g.distbits},W=l(p,g.lens,g.nlen,g.ndist,g.distcode,0,g.work,$),g.distbits=$.bits,W){k.msg="invalid distances set",g.mode=30;break}if(g.mode=20,z===6)break e;case 20:g.mode=21;case 21:if(6<=F&&258<=ne){k.next_out=fe,k.avail_out=ne,k.next_in=j,k.avail_in=F,g.hold=O,g.bits=M,r(k,te),fe=k.next_out,ue=k.output,ne=k.avail_out,j=k.next_in,H=k.input,F=k.avail_in,O=g.hold,M=g.bits,g.mode===12&&(g.back=-1);break}for(g.back=0;Ce=(w=g.lencode[O&(1<<g.lenbits)-1])>>>16&255,Te=65535&w,!((he=w>>>24)<=M);){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(Ce&&!(240&Ce)){for(Ae=he,Ye=Ce,Xe=Te;Ce=(w=g.lencode[Xe+((O&(1<<Ae+Ye)-1)>>Ae)])>>>16&255,Te=65535&w,!(Ae+(he=w>>>24)<=M);){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}O>>>=Ae,M-=Ae,g.back+=Ae}if(O>>>=he,M-=he,g.back+=he,g.length=Te,Ce===0){g.mode=26;break}if(32&Ce){g.back=-1,g.mode=12;break}if(64&Ce){k.msg="invalid literal/length code",g.mode=30;break}g.extra=15&Ce,g.mode=22;case 22:if(g.extra){for(E=g.extra;M<E;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}g.length+=O&(1<<g.extra)-1,O>>>=g.extra,M-=g.extra,g.back+=g.extra}g.was=g.length,g.mode=23;case 23:for(;Ce=(w=g.distcode[O&(1<<g.distbits)-1])>>>16&255,Te=65535&w,!((he=w>>>24)<=M);){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(!(240&Ce)){for(Ae=he,Ye=Ce,Xe=Te;Ce=(w=g.distcode[Xe+((O&(1<<Ae+Ye)-1)>>Ae)])>>>16&255,Te=65535&w,!(Ae+(he=w>>>24)<=M);){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}O>>>=Ae,M-=Ae,g.back+=Ae}if(O>>>=he,M-=he,g.back+=he,64&Ce){k.msg="invalid distance code",g.mode=30;break}g.offset=Te,g.extra=15&Ce,g.mode=24;case 24:if(g.extra){for(E=g.extra;M<E;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}g.offset+=O&(1<<g.extra)-1,O>>>=g.extra,M-=g.extra,g.back+=g.extra}if(g.offset>g.dmax){k.msg="invalid distance too far back",g.mode=30;break}g.mode=25;case 25:if(ne===0)break e;if(X=te-ne,g.offset>X){if((X=g.offset-X)>g.whave&&g.sane){k.msg="invalid distance too far back",g.mode=30;break}Ne=X>g.wnext?(X-=g.wnext,g.wsize-X):g.wnext-X,X>g.length&&(X=g.length),Oe=g.window}else Oe=ue,Ne=fe-g.offset,X=g.length;for(ne<X&&(X=ne),ne-=X,g.length-=X;ue[fe++]=Oe[Ne++],--X;);g.length===0&&(g.mode=21);break;case 26:if(ne===0)break e;ue[fe++]=g.length,ne--,g.mode=21;break;case 27:if(g.wrap){for(;M<32;){if(F===0)break e;F--,O|=H[j++]<<M,M+=8}if(te-=ne,k.total_out+=te,g.total+=te,te&&(k.adler=g.check=g.flags?s(g.check,ue,te,fe-te):a(g.check,ue,te,fe-te)),te=ne,(g.flags?O:b(O))!==g.check){k.msg="incorrect data check",g.mode=30;break}M=O=0}g.mode=28;case 28:if(g.wrap&&g.flags){for(;M<32;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(O!==(4294967295&g.total)){k.msg="incorrect length check",g.mode=30;break}M=O=0}g.mode=29;case 29:W=1;break e;case 30:W=-3;break e;case 31:return-4;case 32:default:return u}return k.next_out=fe,k.avail_out=ne,k.next_in=j,k.avail_in=F,g.hold=O,g.bits=M,(g.wsize||te!==k.avail_out&&g.mode<30&&(g.mode<27||z!==4))&&Q(k,k.output,k.next_out,te-k.avail_out)?(g.mode=31,-4):(oe-=k.avail_in,te-=k.avail_out,k.total_in+=oe,k.total_out+=te,g.total+=te,g.wrap&&te&&(k.adler=g.check=g.flags?s(g.check,ue,te,k.next_out-te):a(g.check,ue,te,k.next_out-te)),k.data_type=g.bits+(g.last?64:0)+(g.mode===12?128:0)+(g.mode===20||g.mode===15?256:0),(oe==0&&te===0||z===4)&&W===f&&(W=-5),W)},o.inflateEnd=function(k){if(!k||!k.state)return u;var z=k.state;return z.window&&(z.window=null),k.state=null,f},o.inflateGetHeader=function(k,z){var g;return k&&k.state&&2&(g=k.state).wrap?((g.head=z).done=!1,f):u},o.inflateSetDictionary=function(k,z){var g,H=z.length;return k&&k.state?(g=k.state).wrap!==0&&g.mode!==11?u:g.mode===11&&a(1,z,H,0)!==g.check?-3:Q(k,z,H,H)?(g.mode=31,-4):(g.havedict=1,f):u},o.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(e,c,o){var t=e("../utils/common"),a=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],s=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],r=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],l=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];c.exports=function(h,p,f,u,y,m,v,b){var C,_,S,I,x,L,D,R,P,Q=b.bits,k=0,z=0,g=0,H=0,ue=0,j=0,fe=0,F=0,ne=0,O=0,M=null,oe=0,te=new t.Buf16(16),X=new t.Buf16(16),Ne=null,Oe=0;for(k=0;k<=15;k++)te[k]=0;for(z=0;z<u;z++)te[p[f+z]]++;for(ue=Q,H=15;1<=H&&te[H]===0;H--);if(H<ue&&(ue=H),H===0)return y[m++]=20971520,y[m++]=20971520,b.bits=1,0;for(g=1;g<H&&te[g]===0;g++);for(ue<g&&(ue=g),k=F=1;k<=15;k++)if(F<<=1,(F-=te[k])<0)return-1;if(0<F&&(h===0||H!==1))return-1;for(X[1]=0,k=1;k<15;k++)X[k+1]=X[k]+te[k];for(z=0;z<u;z++)p[f+z]!==0&&(v[X[p[f+z]]++]=z);if(L=h===0?(M=Ne=v,19):h===1?(M=a,oe-=257,Ne=s,Oe-=257,256):(M=r,Ne=l,-1),k=g,x=m,fe=z=O=0,S=-1,I=(ne=1<<(j=ue))-1,h===1&&852<ne||h===2&&592<ne)return 1;for(;;){for(D=k-fe,P=v[z]<L?(R=0,v[z]):v[z]>L?(R=Ne[Oe+v[z]],M[oe+v[z]]):(R=96,0),C=1<<k-fe,g=_=1<<j;y[x+(O>>fe)+(_-=C)]=D<<24|R<<16|P|0,_!==0;);for(C=1<<k-1;O&C;)C>>=1;if(C!==0?(O&=C-1,O+=C):O=0,z++,--te[k]==0){if(k===H)break;k=p[f+v[z]]}if(ue<k&&(O&I)!==S){for(fe===0&&(fe=ue),x+=g,F=1<<(j=k-fe);j+fe<H&&!((F-=te[j+fe])<=0);)j++,F<<=1;if(ne+=1<<j,h===1&&852<ne||h===2&&592<ne)return 1;y[S=O&I]=ue<<24|j<<16|x-m|0}}return O!==0&&(y[x+O]=k-fe<<24|64<<16|0),b.bits=ue,0}},{"../utils/common":41}],51:[function(e,c,o){c.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(e,c,o){var t=e("../utils/common"),a=0,s=1;function r(w){for(var T=w.length;0<=--T;)w[T]=0}var l=0,h=29,p=256,f=p+1+h,u=30,y=19,m=2*f+1,v=15,b=16,C=7,_=256,S=16,I=17,x=18,L=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],D=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],R=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],P=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Q=new Array(2*(f+2));r(Q);var k=new Array(2*u);r(k);var z=new Array(512);r(z);var g=new Array(256);r(g);var H=new Array(h);r(H);var ue,j,fe,F=new Array(u);function ne(w,T,q,G,A){this.static_tree=w,this.extra_bits=T,this.extra_base=q,this.elems=G,this.max_length=A,this.has_stree=w&&w.length}function O(w,T){this.dyn_tree=w,this.max_code=0,this.stat_desc=T}function M(w){return w<256?z[w]:z[256+(w>>>7)]}function oe(w,T){w.pending_buf[w.pending++]=255&T,w.pending_buf[w.pending++]=T>>>8&255}function te(w,T,q){w.bi_valid>b-q?(w.bi_buf|=T<<w.bi_valid&65535,oe(w,w.bi_buf),w.bi_buf=T>>b-w.bi_valid,w.bi_valid+=q-b):(w.bi_buf|=T<<w.bi_valid&65535,w.bi_valid+=q)}function X(w,T,q){te(w,q[2*T],q[2*T+1])}function Ne(w,T){for(var q=0;q|=1&w,w>>>=1,q<<=1,0<--T;);return q>>>1}function Oe(w,T,q){var G,A,V=new Array(v+1),ie=0;for(G=1;G<=v;G++)V[G]=ie=ie+q[G-1]<<1;for(A=0;A<=T;A++){var K=w[2*A+1];K!==0&&(w[2*A]=Ne(V[K]++,K))}}function he(w){var T;for(T=0;T<f;T++)w.dyn_ltree[2*T]=0;for(T=0;T<u;T++)w.dyn_dtree[2*T]=0;for(T=0;T<y;T++)w.bl_tree[2*T]=0;w.dyn_ltree[2*_]=1,w.opt_len=w.static_len=0,w.last_lit=w.matches=0}function Ce(w){8<w.bi_valid?oe(w,w.bi_buf):0<w.bi_valid&&(w.pending_buf[w.pending++]=w.bi_buf),w.bi_buf=0,w.bi_valid=0}function Te(w,T,q,G){var A=2*T,V=2*q;return w[A]<w[V]||w[A]===w[V]&&G[T]<=G[q]}function Ae(w,T,q){for(var G=w.heap[q],A=q<<1;A<=w.heap_len&&(A<w.heap_len&&Te(T,w.heap[A+1],w.heap[A],w.depth)&&A++,!Te(T,G,w.heap[A],w.depth));)w.heap[q]=w.heap[A],q=A,A<<=1;w.heap[q]=G}function Ye(w,T,q){var G,A,V,ie,K=0;if(w.last_lit!==0)for(;G=w.pending_buf[w.d_buf+2*K]<<8|w.pending_buf[w.d_buf+2*K+1],A=w.pending_buf[w.l_buf+K],K++,G===0?X(w,A,T):(X(w,(V=g[A])+p+1,T),(ie=L[V])!==0&&te(w,A-=H[V],ie),X(w,V=M(--G),q),(ie=D[V])!==0&&te(w,G-=F[V],ie)),K<w.last_lit;);X(w,_,T)}function Xe(w,T){var q,G,A,V=T.dyn_tree,ie=T.stat_desc.static_tree,K=T.stat_desc.has_stree,le=T.stat_desc.elems,Le=-1;for(w.heap_len=0,w.heap_max=m,q=0;q<le;q++)V[2*q]!==0?(w.heap[++w.heap_len]=Le=q,w.depth[q]=0):V[2*q+1]=0;for(;w.heap_len<2;)V[2*(A=w.heap[++w.heap_len]=Le<2?++Le:0)]=1,w.depth[A]=0,w.opt_len--,K&&(w.static_len-=ie[2*A+1]);for(T.max_code=Le,q=w.heap_len>>1;1<=q;q--)Ae(w,V,q);for(A=le;q=w.heap[1],w.heap[1]=w.heap[w.heap_len--],Ae(w,V,1),G=w.heap[1],w.heap[--w.heap_max]=q,w.heap[--w.heap_max]=G,V[2*A]=V[2*q]+V[2*G],w.depth[A]=(w.depth[q]>=w.depth[G]?w.depth[q]:w.depth[G])+1,V[2*q+1]=V[2*G+1]=A,w.heap[1]=A++,Ae(w,V,1),2<=w.heap_len;);w.heap[--w.heap_max]=w.heap[1],function(ye,qe){var mt,nt,ht,be,wt,un,Qe=qe.dyn_tree,Wt=qe.max_code,Kn=qe.stat_desc.static_tree,Yn=qe.stat_desc.has_stree,Xn=qe.stat_desc.extra_bits,fn=qe.stat_desc.extra_base,Et=qe.stat_desc.max_length,Nt=0;for(be=0;be<=v;be++)ye.bl_count[be]=0;for(Qe[2*ye.heap[ye.heap_max]+1]=0,mt=ye.heap_max+1;mt<m;mt++)Et<(be=Qe[2*Qe[2*(nt=ye.heap[mt])+1]+1]+1)&&(be=Et,Nt++),Qe[2*nt+1]=be,Wt<nt||(ye.bl_count[be]++,wt=0,fn<=nt&&(wt=Xn[nt-fn]),un=Qe[2*nt],ye.opt_len+=un*(be+wt),Yn&&(ye.static_len+=un*(Kn[2*nt+1]+wt)));if(Nt!==0){do{for(be=Et-1;ye.bl_count[be]===0;)be--;ye.bl_count[be]--,ye.bl_count[be+1]+=2,ye.bl_count[Et]--,Nt-=2}while(0<Nt);for(be=Et;be!==0;be--)for(nt=ye.bl_count[be];nt!==0;)Wt<(ht=ye.heap[--mt])||(Qe[2*ht+1]!==be&&(ye.opt_len+=(be-Qe[2*ht+1])*Qe[2*ht],Qe[2*ht+1]=be),nt--)}}(w,T),Oe(V,Le,w.bl_count)}function d(w,T,q){var G,A,V=-1,ie=T[1],K=0,le=7,Le=4;for(ie===0&&(le=138,Le=3),T[2*(q+1)+1]=65535,G=0;G<=q;G++)A=ie,ie=T[2*(G+1)+1],++K<le&&A===ie||(K<Le?w.bl_tree[2*A]+=K:A!==0?(A!==V&&w.bl_tree[2*A]++,w.bl_tree[2*S]++):K<=10?w.bl_tree[2*I]++:w.bl_tree[2*x]++,V=A,Le=(K=0)===ie?(le=138,3):A===ie?(le=6,3):(le=7,4))}function W(w,T,q){var G,A,V=-1,ie=T[1],K=0,le=7,Le=4;for(ie===0&&(le=138,Le=3),G=0;G<=q;G++)if(A=ie,ie=T[2*(G+1)+1],!(++K<le&&A===ie)){if(K<Le)for(;X(w,A,w.bl_tree),--K!=0;);else A!==0?(A!==V&&(X(w,A,w.bl_tree),K--),X(w,S,w.bl_tree),te(w,K-3,2)):K<=10?(X(w,I,w.bl_tree),te(w,K-3,3)):(X(w,x,w.bl_tree),te(w,K-11,7));V=A,Le=(K=0)===ie?(le=138,3):A===ie?(le=6,3):(le=7,4)}}r(F);var $=!1;function E(w,T,q,G){te(w,(l<<1)+(G?1:0),3),function(A,V,ie,K){Ce(A),oe(A,ie),oe(A,~ie),t.arraySet(A.pending_buf,A.window,V,ie,A.pending),A.pending+=ie}(w,T,q)}o._tr_init=function(w){$||(function(){var T,q,G,A,V,ie=new Array(v+1);for(A=G=0;A<h-1;A++)for(H[A]=G,T=0;T<1<<L[A];T++)g[G++]=A;for(g[G-1]=A,A=V=0;A<16;A++)for(F[A]=V,T=0;T<1<<D[A];T++)z[V++]=A;for(V>>=7;A<u;A++)for(F[A]=V<<7,T=0;T<1<<D[A]-7;T++)z[256+V++]=A;for(q=0;q<=v;q++)ie[q]=0;for(T=0;T<=143;)Q[2*T+1]=8,T++,ie[8]++;for(;T<=255;)Q[2*T+1]=9,T++,ie[9]++;for(;T<=279;)Q[2*T+1]=7,T++,ie[7]++;for(;T<=287;)Q[2*T+1]=8,T++,ie[8]++;for(Oe(Q,f+1,ie),T=0;T<u;T++)k[2*T+1]=5,k[2*T]=Ne(T,5);ue=new ne(Q,L,p+1,f,v),j=new ne(k,D,0,u,v),fe=new ne(new Array(0),R,0,y,C)}(),$=!0),w.l_desc=new O(w.dyn_ltree,ue),w.d_desc=new O(w.dyn_dtree,j),w.bl_desc=new O(w.bl_tree,fe),w.bi_buf=0,w.bi_valid=0,he(w)},o._tr_stored_block=E,o._tr_flush_block=function(w,T,q,G){var A,V,ie=0;0<w.level?(w.strm.data_type===2&&(w.strm.data_type=function(K){var le,Le=4093624447;for(le=0;le<=31;le++,Le>>>=1)if(1&Le&&K.dyn_ltree[2*le]!==0)return a;if(K.dyn_ltree[18]!==0||K.dyn_ltree[20]!==0||K.dyn_ltree[26]!==0)return s;for(le=32;le<p;le++)if(K.dyn_ltree[2*le]!==0)return s;return a}(w)),Xe(w,w.l_desc),Xe(w,w.d_desc),ie=function(K){var le;for(d(K,K.dyn_ltree,K.l_desc.max_code),d(K,K.dyn_dtree,K.d_desc.max_code),Xe(K,K.bl_desc),le=y-1;3<=le&&K.bl_tree[2*P[le]+1]===0;le--);return K.opt_len+=3*(le+1)+5+5+4,le}(w),A=w.opt_len+3+7>>>3,(V=w.static_len+3+7>>>3)<=A&&(A=V)):A=V=q+5,q+4<=A&&T!==-1?E(w,T,q,G):w.strategy===4||V===A?(te(w,2+(G?1:0),3),Ye(w,Q,k)):(te(w,4+(G?1:0),3),function(K,le,Le,ye){var qe;for(te(K,le-257,5),te(K,Le-1,5),te(K,ye-4,4),qe=0;qe<ye;qe++)te(K,K.bl_tree[2*P[qe]+1],3);W(K,K.dyn_ltree,le-1),W(K,K.dyn_dtree,Le-1)}(w,w.l_desc.max_code+1,w.d_desc.max_code+1,ie+1),Ye(w,w.dyn_ltree,w.dyn_dtree)),he(w),G&&Ce(w)},o._tr_tally=function(w,T,q){return w.pending_buf[w.d_buf+2*w.last_lit]=T>>>8&255,w.pending_buf[w.d_buf+2*w.last_lit+1]=255&T,w.pending_buf[w.l_buf+w.last_lit]=255&q,w.last_lit++,T===0?w.dyn_ltree[2*q]++:(w.matches++,T--,w.dyn_ltree[2*(g[q]+p+1)]++,w.dyn_dtree[2*M(T)]++),w.last_lit===w.lit_bufsize-1},o._tr_align=function(w){te(w,2,3),X(w,_,Q),function(T){T.bi_valid===16?(oe(T,T.bi_buf),T.bi_buf=0,T.bi_valid=0):8<=T.bi_valid&&(T.pending_buf[T.pending++]=255&T.bi_buf,T.bi_buf>>=8,T.bi_valid-=8)}(w)}},{"../utils/common":41}],53:[function(e,c,o){c.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(e,c,o){(function(t){(function(a,s){if(!a.setImmediate){var r,l,h,p,f=1,u={},y=!1,m=a.document,v=Object.getPrototypeOf&&Object.getPrototypeOf(a);v=v&&v.setTimeout?v:a,r={}.toString.call(a.process)==="[object process]"?function(S){process.nextTick(function(){C(S)})}:function(){if(a.postMessage&&!a.importScripts){var S=!0,I=a.onmessage;return a.onmessage=function(){S=!1},a.postMessage("","*"),a.onmessage=I,S}}()?(p="setImmediate$"+Math.random()+"$",a.addEventListener?a.addEventListener("message",_,!1):a.attachEvent("onmessage",_),function(S){a.postMessage(p+S,"*")}):a.MessageChannel?((h=new MessageChannel).port1.onmessage=function(S){C(S.data)},function(S){h.port2.postMessage(S)}):m&&"onreadystatechange"in m.createElement("script")?(l=m.documentElement,function(S){var I=m.createElement("script");I.onreadystatechange=function(){C(S),I.onreadystatechange=null,l.removeChild(I),I=null},l.appendChild(I)}):function(S){setTimeout(C,0,S)},v.setImmediate=function(S){typeof S!="function"&&(S=new Function(""+S));for(var I=new Array(arguments.length-1),x=0;x<I.length;x++)I[x]=arguments[x+1];var L={callback:S,args:I};return u[f]=L,r(f),f++},v.clearImmediate=b}function b(S){delete u[S]}function C(S){if(y)setTimeout(C,0,S);else{var I=u[S];if(I){y=!0;try{(function(x){var L=x.callback,D=x.args;switch(D.length){case 0:L();break;case 1:L(D[0]);break;case 2:L(D[0],D[1]);break;case 3:L(D[0],D[1],D[2]);break;default:L.apply(s,D)}})(I)}finally{b(S),y=!1}}}}function _(S){S.source===a&&typeof S.data=="string"&&S.data.indexOf(p)===0&&C(+S.data.slice(p.length))}})(typeof self>"u"?t===void 0?this:t:self)}).call(this,typeof pn<"u"?pn:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(ui);var _a=ui.exports;const Ss=di(_a);var fi={exports:{}};(function(n){var i=function(){var e=String.fromCharCode,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",t={};function a(r,l){if(!t[r]){t[r]={};for(var h=0;h<r.length;h++)t[r][r.charAt(h)]=h}return t[r][l]}var s={compressToBase64:function(r){if(r==null)return"";var l=s._compress(r,6,function(h){return c.charAt(h)});switch(l.length%4){default:case 0:return l;case 1:return l+"===";case 2:return l+"==";case 3:return l+"="}},decompressFromBase64:function(r){return r==null?"":r==""?null:s._decompress(r.length,32,function(l){return a(c,r.charAt(l))})},compressToUTF16:function(r){return r==null?"":s._compress(r,15,function(l){return e(l+32)})+" "},decompressFromUTF16:function(r){return r==null?"":r==""?null:s._decompress(r.length,16384,function(l){return r.charCodeAt(l)-32})},compressToUint8Array:function(r){for(var l=s.compress(r),h=new Uint8Array(l.length*2),p=0,f=l.length;p<f;p++){var u=l.charCodeAt(p);h[p*2]=u>>>8,h[p*2+1]=u%256}return h},decompressFromUint8Array:function(r){if(r==null)return s.decompress(r);for(var l=new Array(r.length/2),h=0,p=l.length;h<p;h++)l[h]=r[h*2]*256+r[h*2+1];var f=[];return l.forEach(function(u){f.push(e(u))}),s.decompress(f.join(""))},compressToEncodedURIComponent:function(r){return r==null?"":s._compress(r,6,function(l){return o.charAt(l)})},decompressFromEncodedURIComponent:function(r){return r==null?"":r==""?null:(r=r.replace(/ /g,"+"),s._decompress(r.length,32,function(l){return a(o,r.charAt(l))}))},compress:function(r){return s._compress(r,16,function(l){return e(l)})},_compress:function(r,l,h){if(r==null)return"";var p,f,u={},y={},m="",v="",b="",C=2,_=3,S=2,I=[],x=0,L=0,D;for(D=0;D<r.length;D+=1)if(m=r.charAt(D),Object.prototype.hasOwnProperty.call(u,m)||(u[m]=_++,y[m]=!0),v=b+m,Object.prototype.hasOwnProperty.call(u,v))b=v;else{if(Object.prototype.hasOwnProperty.call(y,b)){if(b.charCodeAt(0)<256){for(p=0;p<S;p++)x=x<<1,L==l-1?(L=0,I.push(h(x)),x=0):L++;for(f=b.charCodeAt(0),p=0;p<8;p++)x=x<<1|f&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,f=f>>1}else{for(f=1,p=0;p<S;p++)x=x<<1|f,L==l-1?(L=0,I.push(h(x)),x=0):L++,f=0;for(f=b.charCodeAt(0),p=0;p<16;p++)x=x<<1|f&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,f=f>>1}C--,C==0&&(C=Math.pow(2,S),S++),delete y[b]}else for(f=u[b],p=0;p<S;p++)x=x<<1|f&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,f=f>>1;C--,C==0&&(C=Math.pow(2,S),S++),u[v]=_++,b=String(m)}if(b!==""){if(Object.prototype.hasOwnProperty.call(y,b)){if(b.charCodeAt(0)<256){for(p=0;p<S;p++)x=x<<1,L==l-1?(L=0,I.push(h(x)),x=0):L++;for(f=b.charCodeAt(0),p=0;p<8;p++)x=x<<1|f&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,f=f>>1}else{for(f=1,p=0;p<S;p++)x=x<<1|f,L==l-1?(L=0,I.push(h(x)),x=0):L++,f=0;for(f=b.charCodeAt(0),p=0;p<16;p++)x=x<<1|f&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,f=f>>1}C--,C==0&&(C=Math.pow(2,S),S++),delete y[b]}else for(f=u[b],p=0;p<S;p++)x=x<<1|f&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,f=f>>1;C--,C==0&&(C=Math.pow(2,S),S++)}for(f=2,p=0;p<S;p++)x=x<<1|f&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,f=f>>1;for(;;)if(x=x<<1,L==l-1){I.push(h(x));break}else L++;return I.join("")},decompress:function(r){return r==null?"":r==""?null:s._decompress(r.length,32768,function(l){return r.charCodeAt(l)})},_decompress:function(r,l,h){var p=[],f=4,u=4,y=3,m="",v=[],b,C,_,S,I,x,L,D={val:h(0),position:l,index:1};for(b=0;b<3;b+=1)p[b]=b;for(_=0,I=Math.pow(2,2),x=1;x!=I;)S=D.val&D.position,D.position>>=1,D.position==0&&(D.position=l,D.val=h(D.index++)),_|=(S>0?1:0)*x,x<<=1;switch(_){case 0:for(_=0,I=Math.pow(2,8),x=1;x!=I;)S=D.val&D.position,D.position>>=1,D.position==0&&(D.position=l,D.val=h(D.index++)),_|=(S>0?1:0)*x,x<<=1;L=e(_);break;case 1:for(_=0,I=Math.pow(2,16),x=1;x!=I;)S=D.val&D.position,D.position>>=1,D.position==0&&(D.position=l,D.val=h(D.index++)),_|=(S>0?1:0)*x,x<<=1;L=e(_);break;case 2:return""}for(p[3]=L,C=L,v.push(L);;){if(D.index>r)return"";for(_=0,I=Math.pow(2,y),x=1;x!=I;)S=D.val&D.position,D.position>>=1,D.position==0&&(D.position=l,D.val=h(D.index++)),_|=(S>0?1:0)*x,x<<=1;switch(L=_){case 0:for(_=0,I=Math.pow(2,8),x=1;x!=I;)S=D.val&D.position,D.position>>=1,D.position==0&&(D.position=l,D.val=h(D.index++)),_|=(S>0?1:0)*x,x<<=1;p[u++]=e(_),L=u-1,f--;break;case 1:for(_=0,I=Math.pow(2,16),x=1;x!=I;)S=D.val&D.position,D.position>>=1,D.position==0&&(D.position=l,D.val=h(D.index++)),_|=(S>0?1:0)*x,x<<=1;p[u++]=e(_),L=u-1,f--;break;case 2:return v.join("")}if(f==0&&(f=Math.pow(2,y),y++),p[L])m=p[L];else if(L===u)m=C+C.charAt(0);else return null;v.push(m),p[u++]=C+m.charAt(0),f--,C=m,f==0&&(f=Math.pow(2,y),y++)}}};return s}();n!=null?n.exports=i:typeof angular<"u"&&angular!=null&&angular.module("LZString",[]).factory("LZString",function(){return i})})(fi);var ka=fi.exports;const mi=di(ka);function Sa(n){return new Worker("/assets/compression.worker-B3kqe_bR.js",{name:n==null?void 0:n.name})}let re={},N=null,Is=null,J=null,Ie=null,tn=null,qn=null,xs=[],xn=null,Ls=null,Ve=null,Ln=0,Ts=0,Tn=0,Bs=0,Ns=null,Ds=null,Bn=null,vt=null,Ze=-1,As=null,Nn=null,Dn=null,An=null,hi=null,pi=null,lt=!1,pe=[],ct=[],Tt=[],Fe={isScreenSaverEnabled:!0,isSoundEnabled:!0,isVibrationEnabled:!0,lastRestoreTimestamp:null,lastBackupTimestamp:null},At=null;const Os=new Sa;Os.onmessage=n=>{const i=n.data;try{localStorage.setItem("teacherAssistantData_v2",i),console.log("Background save complete.")}catch(e){console.error("Background storage failed:",e)}};Os.onerror=n=>{console.error("❌ Worker Communication Error:",n.message,n)};function ce(n=!1){if(lt)return;const e=JSON.stringify({classrooms:re,trashBin:pe,userSettings:Fe});if(n){At&&clearTimeout(At);try{const c=mi.compressToUTF16(e);localStorage.setItem("teacherAssistantData_v2",c),console.log("Immediate save complete.")}catch(c){console.error("Immediate save failed:",c)}return}At&&clearTimeout(At),At=setTimeout(()=>{Os.postMessage(e),At=null},500)}function Ia(n){return new Promise((i,e)=>{const c=new FileReader;c.onerror=e,c.onload=()=>{i(c.result.split(",")[1])},c.readAsDataURL(n)})}async function gi(n=[]){const i={};if(n.length>0)n.forEach(l=>{re[l]&&(i[l]=re[l])});else for(const l in re)re[l].isDeleted||(i[l]=re[l]);const e={metadata:{version:"2.0-b64",createdAt:new Date().toISOString()},data:{classrooms:i,trashBin:pe,userSettings:Fe}},c=JSON.stringify(e),o=new Date,t=new Intl.DateTimeFormat("fa-IR-u-nu-latn",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(o).reduce((l,h)=>(l[h.type]=h.value,l),{}),s=`${t.year.slice(-2)}-${t.month}-${t.day}_${t.hour}-${t.minute}`;let r;n.length===0?r=`SP_Full_${s}.txt`:n.length===1?r=`SP_${n[0].replace(/[<>:"/\\|?*]/g,"").replace(/\s+/g,"_")}_${s}.txt`:r=`SP_Selected-${n.length}_${s}.txt`;try{const l=new Ss;l.file("backup.json",c);const h=await l.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:9}}),p=await Ia(h);return new File([p],r,{type:"text/plain"})}catch(l){return console.error("Error creating base64 backup file:",l),null}}function On(){const n=localStorage.getItem("teacherAssistantData_v2");if(!n)return;let i;try{const e=mi.decompressFromUTF16(n);e?i=JSON.parse(e):i=JSON.parse(n)}catch{console.log("Migration: Parsing legacy uncompressed data..."),i=JSON.parse(n)}i.classrooms!==void 0&&i.trashBin!==void 0?(Bt(i.classrooms),pe=i.trashBin||[],Fe={...Fe,...i.userSettings}):(Bt(i),xa())}function xa(){const n=[];Object.values(re).forEach(i=>{i.isDeleted?n.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:i.info.creationDate,type:"classroom",description:`کلاس «${i.info.name}»`,restoreData:{name:i.info.name}}):i.students.forEach(e=>{e.isDeleted&&n.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:e.identity.studentId.split("_")[1],type:"student",description:`دانش‌آموز «${e.identity.name}»`,restoreData:{studentId:e.identity.studentId,classroomName:i.info.name}})})}),pe.length===0&&n.length>0&&(pe=n,console.log(`Migrated ${n.length} previously deleted item(s) to the new trash bin.`),ce())}function yi(n){const i=new yn(n.identity);return i.isDeleted=n.isDeleted,i.statusCounters=n.statusCounters,i.logs=n.logs,i.logs.scores||(i.logs.scores={}),i.profile=n.profile,i.finalClassActivityScore=n.finalClassActivityScore,i.categoryCounts=n.categoryCounts||{},i.categoryIssues=n.categoryIssues||{},i.onboardingSession=n.onboardingSession||null,i}function Bt(n){re={};for(const i in n){const e=n[i];let c;e.info?c=e.info:c={...e,name:i};const o=new rs(c);o.isDeleted=e.isDeleted,o.note=e.note||"",o.students=(e.students||[]).map(yi),o.sessions=(e.sessions||[]).map(t=>{const a=new li(t.sessionNumber);a.isDeleted=t.isDeleted,a.note=t.note||"",a.startTime=new Date(t.startTime),a.createdAt=t.createdAt?new Date(t.createdAt):new Date(t.startTime),a.endTime=t.endTime?new Date(t.endTime):null,a.isFinished=t.isFinished,a.isMakeup=t.isMakeup,a.isCancelled=t.isCancelled||!1,a.studentRecords=t.studentRecords;for(const r in a.studentRecords){const l=a.studentRecords[r];l.homework&&!(l.homework instanceof as)&&(a.studentRecords[r].homework=new as(l.homework.status,l.homework.comment))}a.lastWinnerByCategory=t.lastWinnerByCategory,a.lastUsedCategoryId=t.lastUsedCategoryId,a.lastSelectedWinnerId=t.lastSelectedWinnerId;const s=t.winnerHistory||[];return a.winnerHistory=s.filter(r=>r&&r.winner).map(r=>({winner:o.students.find(h=>h.identity.studentId===r.winner.identity.studentId),categoryName:r.categoryName})).filter(r=>r.winner),a}),o.categories=(e.categories||[]).map(t=>{const a=new ut(t.name,t.description,t.isGradedCategory);return a.id=t.id,a.isDeleted=t.isDeleted,a}),o.futurePlans=e.futurePlans,re[i]=o}}function bi(n,i){if(i)Bt(n.data.classrooms),$s(n.data.trashBin||[]);else{const e=n.data.classrooms,c=n.data.trashBin||[],o=new Map;for(const a in re){const s=re[a];s.info&&s.info.scheduleCode&&o.set(s.info.scheduleCode,a)}for(const a in e){const s=e[a],r=s.info.scheduleCode;if(o.has(r)){const l=o.get(r);l!==s.info.name&&delete re[l],re[s.info.name]=s}else{let l=s.info.name;for(;re[l];)l=`${l} (Imported)`;l!==s.info.name&&(s.info.name=l),re[l]=s}}const t=new Set(pe.map(a=>a.id));c.forEach(a=>{t.has(a.id)||pe.push(a)}),Bt(re)}n.data.userSettings&&gt(n.data.userSettings),gt({lastRestoreTimestamp:new Date().toISOString()}),ce()}function vi(n,i){if(re[i])return{success:!1,message:"کلاسی با این نام از قبل وجود دارد."};const e=re[n];return e?(e.info.name=i,re[i]=e,delete re[n],N===e&&We(e),{success:!0}):{success:!1,message:"کلاس مورد نظر یافت نشد."}}function Ci(n,i,e){const c=e.trim();if(!c)return{success:!1,message:"نام دسته‌بندی نمی‌تواند خالی باشد."};if(n.categories.some(r=>r.id!==i.id&&!r.isDeleted&&r.name.toLowerCase()===c.toLowerCase()))return{success:!1,message:"دسته‌بندی دیگری با این نام وجود دارد."};const t=i.name,a=t.toLowerCase(),s=c.toLowerCase();return i.name=c,n.students.forEach(r=>{r.categoryCounts&&r.categoryCounts[t]!==void 0&&(r.categoryCounts[c]=r.categoryCounts[t],delete r.categoryCounts[t]),r.categoryIssues&&r.categoryIssues[t]!==void 0&&(r.categoryIssues[c]=r.categoryIssues[t],delete r.categoryIssues[t]),r.logs.scores&&r.logs.scores[a]&&(r.logs.scores[a].forEach(l=>l.skill=c),a!==s&&(r.logs.scores[s]=r.logs.scores[a],delete r.logs.scores[a]))}),n.sessions.forEach(r=>{r.lastWinnerByCategory&&r.lastWinnerByCategory[t]&&(r.lastWinnerByCategory[c]=r.lastWinnerByCategory[t],delete r.lastWinnerByCategory[t]),r.winnerHistory&&r.winnerHistory.forEach(l=>{l.categoryName===t&&(l.categoryName=c)})}),{success:!0}}function wi(n,i,e){if(ke(e.students).some(l=>l.identity.name.toLowerCase()===n.identity.name.toLowerCase()))return{success:!1,message:`دانش‌آموزی با نام «${n.identity.name}» از قبل در کلاس «${e.info.name}» وجود دارد.`};const o=JSON.parse(JSON.stringify(n)),t=yi(o),a=new Map;i.sessions.forEach(l=>{const h=l.studentRecords[n.identity.studentId];h&&a.set(l.sessionNumber,JSON.parse(JSON.stringify(h)))}),e.addStudent(t);try{const l=ke(e.sessions).filter(v=>!v.isCancelled).sort((v,b)=>b.sessionNumber-v.sessionNumber),h=l.length>0?l[0]:null;let p="؟",f={type:"system",description:"Student Move"};h&&(p=tt(e).get(h.sessionNumber)||h.sessionNumber,f={type:"fromSession",sessionNumber:h.sessionNumber});const u=new Date().toLocaleDateString("fa-IR"),y=i.info.name,m=`این دانش آموز در جلسه ${p} و در تاریخ ${u} از کلاس «${y}» به این کلاس انتقال پیدا کرد`;t.addNote(m,f)}catch(l){console.error("Failed to add automated move note:",l)}a.size>0&&e.sessions.forEach(l=>{const h=a.get(l.sessionNumber);h&&!l.isDeleted&&!l.isCancelled&&(l.studentRecords[t.identity.studentId]=h)});const s={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`(انتقال) دانش‌آموز «${n.identity.name}» از کلاس «${i.info.name}»`,restoreData:{studentId:n.identity.studentId,classId:i.info.scheduleCode}};pe.unshift(s),pe.length>50&&pe.pop();const r=i.students.find(l=>l.identity.studentId===n.identity.studentId);return r&&(r.isDeleted=!0),{success:!0}}function Ei(){for(const n in re){const i=re[n];i.students.forEach(e=>{e.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0},e.categoryCounts={},e.categoryIssues={},i.sessions.forEach(c=>{const o=e.identity.studentId;c.studentRecords[o]&&(c.studentRecords[o].attendance="present")})})}ce()}function ke(n){return Array.isArray(n)?n.filter(i=>!i.isDeleted):[]}function tt(n){const i=new Map;return n&&ke(n.sessions).filter(c=>!c.isCancelled).sort((c,o)=>c.sessionNumber-o.sessionNumber).forEach((c,o)=>{i.set(c.sessionNumber,o+1)}),i}function Ct(n){Ze=n}function rt(n){As=n}function Mn(n,i){if(!n||!i)return;const e=n.identity.studentId,c=i.students.findIndex(o=>o.identity.studentId===e);c>-1&&i.students.splice(c,1),i.sessions.forEach(o=>{o.studentRecords[e]&&delete o.studentRecords[e];for(const t in o.lastWinnerByCategory)o.lastWinnerByCategory[t]===e&&delete o.lastWinnerByCategory[t];o.lastSelectedWinnerId===e&&(o.lastSelectedWinnerId=null),o.winnerHistory=o.winnerHistory.filter(t=>t.winner&&t.winner.identity.studentId!==e)})}function _i(n,i){const e=re[n];if(!e)return;const c=e.sessions.findIndex(o=>o.sessionNumber===i);c>-1&&(e.students.forEach(o=>{o.profile.notes&&o.profile.notes.length>0&&(o.profile.notes=o.profile.notes.filter(t=>!t.source||t.source.type!=="fromAttendance"||t.source.sessionNumber!==i)),o.onboardingSession===i&&(o.onboardingSession=null)}),e.sessions.splice(c,1))}function ki(n,i){const e=re[n];if(!e)return;const c=e.categories.findIndex(s=>s.id===i);if(c===-1)return;const t=e.categories[c].name,a=t.toLowerCase();e.students.forEach(s=>{s.categoryCounts&&delete s.categoryCounts[t],s.categoryIssues&&delete s.categoryIssues[t],s.logs.scores&&delete s.logs.scores[a]}),e.sessions.forEach(s=>{s.lastWinnerByCategory[t]&&delete s.lastWinnerByCategory[t],s.winnerHistory=s.winnerHistory.filter(r=>r.categoryName!==t)}),e.categories.splice(c,1)}function Si(n,i,e,c){const o=re[n];if(!o)return;const t=o.students.find(r=>r.identity.studentId===i);if(!t||!t.logs.scores[e.toLowerCase()])return;const a=t.logs.scores[e.toLowerCase()],s=a.findIndex(r=>r.id===c);s>-1&&a.splice(s,1)}function Ii(n,i,e){const c=re[n];if(!c)return;const o=c.students.find(a=>a.identity.studentId===i);if(!o||!o.profile.notes)return;const t=o.profile.notes.findIndex(a=>a.id===e);t>-1&&o.profile.notes.splice(t,1)}function xi(){JSON.parse(JSON.stringify({classrooms:re,trashBin:pe})),lt=!0}function Li(){lt=!1,On()}function We(n){N=n}function nn(n){Is=n}function Ge(n){J=n}function Je(n){Ie=n}function Rn(n){tn=n}function Ti(n){qn=n}function qt(n){xs=n}function bn(n){xn=n}function Bi(n){Ls=n}function zn(n){Ve=n}function vn(n){Ln=n}function Ni(n){Ts=n}function Cn(n){Tn=n}function Di(n){Bs=n}function Ms(n){Ns=n}function Rs(n){Ds=n}function sn(n){Bn=n}function zs(n){vt=n}function $n(n){Dn=n}function Ai(n){hi=n}function Oi(n){pi=n}function $s(n){pe=n}function Zn(n){Nn=n}function an(n){Tt=n}function gt(n){Fe={...Fe,...n},ce()}function os(n){ct=n}function Fs(){Fe.lastBackupTimestamp=new Date().toISOString(),ce()}function Fn(n){An=n}const La=Object.freeze(Object.defineProperty({__proto__:null,get activeModal(){return vt},get cancelCallback(){return Ds},get classrooms(){return re},get confirmCallback(){return Ns},get currentClassroom(){return N},get datePickerCallback(){return An},get easterEggClickCount(){return Ln},get easterEggLastClickTime(){return Ts},enterDemoMode:xi,exitDemoMode:Li,getActiveItems:ke,getSessionDisplayMap:tt,get importedFileContent(){return xn},get isDemoMode(){return lt},get liveSession(){return Is},loadData:On,get manualSelection(){return Dn},moveStudent:wi,get namesToImport(){return xs},get notificationTimeout(){return Ls},permanentlyDeleteCategory:ki,permanentlyDeleteNote:Ii,permanentlyDeleteScore:Si,permanentlyDeleteSession:_i,permanentlyDeleteStudent:Mn,prepareBackupData:gi,get previousState(){return tn},processRestore:bi,rehydrateData:Bt,renameCategory:Ci,renameClassroom:vi,resetAllStudentCounters:Ei,get resetEasterEggClickCount(){return Tn},get resetEasterEggLastClickTime(){return Bs},get saveCategoryCallback(){return Nn},saveData:ce,get saveNoteCallback(){return As},get secureConfirmCallback(){return Bn},get selectedCategory(){return Ve},get selectedClassIds(){return ct},get selectedSession(){return J},get selectedStudentForProfile(){return Ie},get selectedStudentsForMassComment(){return Tt},setActiveModal:zs,setCancelCallback:Rs,setConfirmCallback:Ms,setCurrentClassroom:We,setDatePickerCallback:Fn,setEasterEggClickCount:vn,setEasterEggLastClickTime:Ni,setImportedFileContent:bn,setLastBackupTimestamp:Fs,setLiveSession:nn,setManualSelection:$n,setNamesToImport:qt,setNotificationTimeout:Bi,setPreviousState:Rn,setResetEasterEggClickCount:Cn,setResetEasterEggLastClickTime:Di,setSaveCategoryCallback:Zn,setSaveNoteCallback:rt,setSecureConfirmCallback:sn,setSelectedCategory:zn,setSelectedClassIds:os,setSelectedSession:Ge,setSelectedStudentForProfile:Je,setSelectedStudentsForMassComment:an,setSourceClassForMove:Oi,setStudentToMove:Ai,setTrashBin:$s,setUndoTimeout:Ti,setUserSettings:gt,setWinnerHistoryIndex:Ct,get sourceClassForMove(){return pi},get studentToMove(){return hi},get trashBin(){return pe},get undoTimeout(){return qn},get userSettings(){return Fe},get winnerHistoryIndex(){return Ze}},Symbol.toStringTag,{value:"Module"})),Ta="TeacherAssistantDB",Ba=1,yt="backups";function Mi(){return new Promise((n,i)=>{const e=indexedDB.open(Ta,Ba);e.onupgradeneeded=c=>{const o=c.target.result;o.objectStoreNames.contains(yt)||o.createObjectStore(yt,{keyPath:"id"})},e.onsuccess=c=>n(c.target.result),e.onerror=c=>i(c.target.error)})}async function Na(n,i){const e=await Mi(),c=e.transaction(yt,"readwrite"),o=c.objectStore(yt),t={id:Date.now(),file:n,metadata:i,timestamp:new Date().toISOString()};o.add(t),c.oncomplete=()=>{const s=e.transaction(yt,"readwrite").objectStore(yt),r=s.count();r.onsuccess=()=>{if(r.result>10){const l=s.getAllKeys();l.onsuccess=()=>{const h=l.result;for(;h.length>10;){const p=h.shift();s.delete(p),console.log(`♻️ Auto-deleted old backup snapshot: ${p}`)}}}}}}async function Da(){const n=await Mi();return new Promise((i,e)=>{const t=n.transaction(yt,"readonly").objectStore(yt).getAll();t.onsuccess=()=>{const a=t.result.sort((s,r)=>r.id-s.id);i(a)},t.onerror=()=>e(t.error)})}function et(n){return typeof n!="string"?"":n.replace(/ي/g,"ی").replace(/ك/g,"ک").replace(/[\s\u200c]/g,"")}function Ps(n){return typeof n!="string"||n.length===0?"ltr":/[\u0590-\u07FF]/.test(n)?"rtl":"ltr"}function Ri(n){return!n||!n.trim()?"":n.split(`
`).map(c=>`<div dir="${Ps(c)}">${c||"&nbsp;"}</div>`).join("")}function ss(n){if(typeof n!="string")return"";const i={q:"ض",w:"ص",e:"ث",r:"ق",t:"ف",y:"غ",u:"ع",i:"ه",o:"خ",p:"ح","[":"ج","]":"چ",a:"ش",s:"س",d:"ی",f:"ب",g:"ل",h:"ا",j:"ت",k:"ن",l:"م",";":"ک","'":"گ",z:"ظ",x:"ط",c:"ز",v:"ر",b:"ذ",n:"د",m:"پ",",":"و"};let e="";for(let c=0;c<n.length;c++){const o=n[c].toLowerCase();e+=i[o]||n[c]}return e}function cs(n){if(!n||typeof n!="string")return{name:"",firstName:null,lastName:null};const i=n.indexOf(".");if(i>0&&i<n.length-1){const e=n.substring(0,i).trim(),c=n.substring(i+1).trim();return{name:`${e} ${c}`,firstName:e,lastName:c}}return{name:n.trim(),firstName:null,lastName:null}}let is=null;function ri(){if(!Fe.isSoundEnabled)return;const n=window.AudioContext||window.webkitAudioContext;if(!n)return;is||(is=new n);const i=is,e=()=>{const c=i.createOscillator(),o=i.createGain();c.connect(o),o.connect(i.destination),c.type="sine";const t=i.currentTime;c.frequency.setValueAtTime(450,t),o.gain.setValueAtTime(0,t),o.gain.linearRampToValueAtTime(.3,t+.002),o.gain.exponentialRampToValueAtTime(.001,t+.025),o.gain.linearRampToValueAtTime(0,t+.03),c.start(t),c.stop(t+.04)};i.state==="suspended"?i.resume().then(()=>{e()}).catch(c=>console.error("Audio resume failed:",c)):e()}const zi="teacherAssistantLogs_v2",Aa=100;function Hs(){try{const n=localStorage.getItem(zi);return n?JSON.parse(n):{}}catch(n){return console.error("Error reading logs from localStorage:",n),{}}}function $i(n){try{localStorage.setItem(zi,JSON.stringify(n))}catch(i){console.error("Error saving logs to localStorage:",i)}}function Se(n,i,e=null){if(!n)return;const c=Hs();c[n]||(c[n]=[]);const o={timestamp:new Date().toISOString(),message:i,action:e,classroomName:n};c[n].unshift(o),c[n].length>Aa&&c[n].pop(),$i(c)}function Oa(n){return Hs()[n]||[]}function Ma(n,i){const e=Hs();e[n]&&!e[i]&&(e[i]=e[n],delete e[n],$i(e))}var oi={toJalaali:Ra,toGregorian:Fi,isValidJalaaliDate:za,isLeapJalaaliYear:Pi,jalaaliMonthLength:Hi,jalCal:Ws,j2d:Pn,d2j:Hn,g2d:Gn,d2g:Us,jalaaliToDateObject:Wi,jalaaliWeek:Fa},bt=[-61,9,38,199,426,686,756,818,1111,1181,1210,1635,2060,2097,2192,2262,2324,2394,2456,3178];function Ra(n,i,e){return Object.prototype.toString.call(n)==="[object Date]"&&(e=n.getDate(),i=n.getMonth()+1,n=n.getFullYear()),Hn(Gn(n,i,e))}function Fi(n,i,e){return Us(Pn(n,i,e))}function za(n,i,e){return n>=-61&&n<=3177&&i>=1&&i<=12&&e>=1&&e<=Hi(n,i)}function Pi(n){return $a(n)===0}function Hi(n,i){return i<=6?31:i<=11||Pi(n)?30:29}function $a(n){var i=bt.length,e=bt[0],c,o,t,a,s;if(n<e||n>=bt[i-1])throw new Error("Invalid Jalaali year "+n);for(s=1;s<i&&(c=bt[s],o=c-e,!(n<c));s+=1)e=c;return a=n-e,o-a<6&&(a=a-o+De(o+4,33)*33),t=Ke(Ke(a+1,33)-1,4),t===-1&&(t=4),t}function Ws(n,i){var e=bt.length,c=n+621,o=-14,t=bt[0],a,s,r,l,h,p,f;if(n<t||n>=bt[e-1])throw new Error("Invalid Jalaali year "+n);for(f=1;f<e&&(a=bt[f],s=a-t,!(n<a));f+=1)o=o+De(s,33)*8+De(Ke(s,33),4),t=a;return p=n-t,o=o+De(p,33)*8+De(Ke(p,33)+3,4),Ke(s,33)===4&&s-p===4&&(o+=1),l=De(c,4)-De((De(c,100)+1)*3,4)-150,h=20+o-l,i?{gy:c,march:h}:(s-p<6&&(p=p-s+De(s+4,33)*33),r=Ke(Ke(p+1,33)-1,4),r===-1&&(r=4),{leap:r,gy:c,march:h})}function Pn(n,i,e){var c=Ws(n,!0);return Gn(c.gy,3,c.march)+(i-1)*31-De(i,7)*(i-7)+e-1}function Hn(n){var i=Us(n).gy,e=i-621,c=Ws(e,!1),o=Gn(i,3,c.march),t,a,s;if(s=n-o,s>=0){if(s<=185)return a=1+De(s,31),t=Ke(s,31)+1,{jy:e,jm:a,jd:t};s-=186}else e-=1,s+=179,c.leap===1&&(s+=1);return a=7+De(s,30),t=Ke(s,30)+1,{jy:e,jm:a,jd:t}}function Gn(n,i,e){var c=De((n+De(i-8,6)+100100)*1461,4)+De(153*Ke(i+9,12)+2,5)+e-34840408;return c=c-De(De(n+100100+De(i-8,6),100)*3,4)+752,c}function Us(n){var i,e,c,o,t;return i=4*n+139361631,i=i+De(De(4*n+183187720,146097)*3,4)*4-3908,e=De(Ke(i,1461),4)*5+308,c=De(Ke(e,153),5)+1,o=Ke(De(e,153),12)+1,t=De(i,1461)-100100+De(8-o,6),{gy:t,gm:o,gd:c}}function Fa(n,i,e){var c=Wi(n,i,e).getDay(),o=c==6?0:-(c+1),t=6+o;return{saturday:Hn(Pn(n,i,e+o)),friday:Hn(Pn(n,i,e+t))}}function Wi(n,i,e,c,o,t,a){var s=Fi(n,i,e);return new Date(s.gy,s.gm-1,s.gd,c||0,o||0,t||0,a||0)}function De(n,i){return~~(n/i)}function Ke(n,i){return n-~~(n/i)*i}const Ui=document.getElementById("class-management-page"),Pa=document.getElementById("new-class-name"),Ha=document.getElementById("add-class-btn"),zt=document.getElementById("class-list"),Wn=document.getElementById("undo-toast"),ji=document.getElementById("undo-message"),Wa=document.getElementById("undo-btn"),Ua=document.getElementById("settings-page"),qi=document.getElementById("settings-class-name-header"),ls=document.getElementById("settings-student-list"),ds=document.getElementById("category-list"),ja=document.getElementById("back-to-sessions-btn"),qa=document.getElementById("new-student-name"),Za=document.getElementById("add-student-btn"),Zi=document.getElementById("paste-area"),Ga=document.getElementById("process-paste-btn"),Va=document.getElementById("csv-preview-page"),us=document.getElementById("csv-preview-list"),Ja=document.getElementById("csv-confirm-btn"),Ka=document.getElementById("csv-cancel-btn"),Ya=document.getElementById("import-csv-btn"),Xa=document.getElementById("csv-file-input"),Qa=document.getElementById("column-mapping-page"),fs=document.getElementById("column-select-dropdown"),er=document.getElementById("confirm-column-btn"),tr=document.getElementById("cancel-import-btn"),nr=document.getElementById("new-category-name"),sr=document.getElementById("add-category-btn"),ms=document.querySelector(".app-header"),it=document.getElementById("select-student-btn"),Ft=document.getElementById("select-student-btn-wrapper"),ir=document.getElementById("attendance-page"),Kt=document.getElementById("attendance-list"),ar=document.getElementById("finish-attendance-btn"),rr=document.querySelector("#class-management-page h2"),hs=document.getElementById("student-stats-header"),or=document.getElementById("hamburger-menu-btn"),cr=document.getElementById("side-nav-menu"),lr=document.getElementById("close-nav-btn"),dr=document.getElementById("overlay"),ur=document.getElementById("backup-data-btn"),fr=document.getElementById("restore-data-btn"),Gi=document.getElementById("restore-file-input"),mr=document.getElementById("custom-confirm-modal"),Vi=document.getElementById("confirm-modal-message"),ps=document.getElementById("confirm-modal-cancel-btn"),Zt=document.getElementById("confirm-modal-confirm-btn"),hr=document.getElementById("secure-confirm-modal"),Ji=document.getElementById("secure-confirm-message"),Ki=document.getElementById("secure-confirm-code"),Ot=document.getElementById("secure-confirm-input"),pr=document.getElementById("secure-confirm-cancel-btn"),wn=document.getElementById("secure-confirm-confirm-btn"),gr=document.getElementById("add-note-modal"),Ee=document.getElementById("new-note-content"),yr=document.getElementById("class-save-note-btn"),br=document.getElementById("cancel-note-btn"),gs=document.getElementById("student-search-input"),pt=document.getElementById("student-search-results"),vr=document.getElementById("back-to-student-page-btn"),Cr=document.getElementById("graded-category-pills-container"),wr=document.getElementById("new-score-value"),Yi=document.getElementById("new-score-comment"),Er=document.getElementById("add-score-btn"),_r=document.getElementById("profile-stats-summary"),kr=document.getElementById("profile-scores-list"),Gt=document.getElementById("global-student-search-input"),ot=document.getElementById("global-student-search-results"),Sr=document.getElementById("is-graded-checkbox"),Ir=document.getElementById("trashed-classes-list"),xr=document.getElementById("trashed-students-list"),Lr=document.getElementById("trashed-sessions-list"),Tr=document.getElementById("trashed-categories-list"),Br=document.getElementById("trashed-notes-list"),Nr=document.getElementById("trashed-scores-list"),Rt=document.getElementById("quick-grade-form-wrapper"),dt=document.getElementById("quick-score-input"),st=document.getElementById("quick-note-textarea"),It=document.getElementById("quick-grade-submit-btn"),Yt=document.getElementById("category-selection-container"),ys=document.getElementById("selected-student-result"),xt=document.getElementById("custom-context-menu"),Mt=document.getElementById("breadcrumb-container"),Dr=document.getElementById("report-config-modal"),Xi=document.getElementById("report-columns-container"),Qi=document.getElementById("report-print-btn"),ea=document.getElementById("report-cancel-btn");let jt=null,$t=null;const Ar=document.getElementById("category-modal"),ta=document.getElementById("category-modal-title"),Xt=document.getElementById("new-category-modal-name"),js=document.getElementById("new-category-modal-is-graded"),Or=document.getElementById("category-modal-cancel-btn"),na=document.getElementById("category-modal-save-btn"),Mr=document.getElementById("mass-comment-modal"),Rr=document.getElementById("mass-comment-modal-title"),sa=document.getElementById("mass-comment-student-count-message"),Qt=document.getElementById("mass-comment-content"),qs=document.getElementById("mass-comment-append-checkbox"),zr=document.getElementById("mass-comment-cancel-btn"),$r=document.getElementById("mass-comment-save-btn"),bs=document.getElementById("mass-comment-btn"),En=document.getElementById("attendance-mass-actions-container"),kt=document.createElement("input"),Fr=document.getElementById("session-dashboard-page"),Pt=document.getElementById("attendance-pane");function Vt(n,i){let e;const o=a=>{e=setTimeout(()=>{Fe.isVibrationEnabled&&navigator.vibrate&&navigator.vibrate(50),i(a)},800)},t=()=>{clearTimeout(e)};n.addEventListener("touchstart",o,{passive:!0}),n.addEventListener("touchend",t),n.addEventListener("touchmove",t),n.addEventListener("mousedown",o),n.addEventListener("mouseup",t),n.addEventListener("mouseleave",t)}function Ht(n="selector"){if(!N||!J){ge("class-management-page");return}jr(),kn(),$e(),at(),ge("session-dashboard-page",{tab:n}),ia(),rn(n),qr()}function rn(n){const i=document.getElementById("selector-tab-btn"),e=document.getElementById("attendance-tab-btn"),c=document.getElementById("selector-pane"),o=n==="selector";i.classList.toggle("active",o),e.classList.toggle("active",!o),c.classList.toggle("active",o),Pt.classList.toggle("active",!o)}function ia(){const n=document.getElementById("selector-tab-btn"),i=document.getElementById("attendance-tab-btn"),e=document.getElementById("selector-pane");n.addEventListener("click",()=>{$e(),ze(),n.classList.add("active"),i.classList.remove("active"),e.classList.add("active"),Pt.classList.remove("active"),ge("session-dashboard-page",{tab:"selector"})}),i.addEventListener("click",()=>{at(),i.classList.add("active"),n.classList.remove("active"),Pt.classList.add("active"),e.classList.remove("active"),ge("session-dashboard-page",{tab:"attendance"})})}function Pr(n){clearTimeout(qn),tn||Rn(JSON.stringify(re)),ji.textContent=n,Wn.classList.add("show"),Ti(setTimeout(()=>{Wn.classList.remove("show"),Rn(null)},5e3))}function aa(){if(tn){const n=N?N.info.name:null,i=JSON.parse(tn);Bt(i),n&&re[n]?We(re[n]):We(null),N?(ft(),dn(),Ue()):je(),Wn.classList.remove("show"),clearTimeout(qn),Rn(null)}}function Y(n,i=3e3){const e=document.getElementById("notification-toast");e&&(e.textContent=n,e.classList.add("show"),clearTimeout(Ls),Bi(setTimeout(()=>{e.classList.remove("show")},i)))}function Un(n){var v;const i=document.getElementById("restore-confirm-modal"),e=document.getElementById("restore-modal-message"),c=document.getElementById("restore-append-checkbox"),o=document.querySelector('label[for="restore-append-checkbox"]'),t=document.getElementById("restore-confirm-cancel-btn"),a=document.getElementById("restore-confirm-confirm-btn"),s=document.getElementById("restore-modal-warning");s.style.display="none";const r=((v=n.metadata)==null?void 0:v.createdAt)||0;if(Fe.lastRestoreTimestamp&&r<Fe.lastRestoreTimestamp){const b=new Date(r).toLocaleDateString("fa-IR"),C=new Date(Fe.lastRestoreTimestamp).toLocaleDateString("fa-IR");s.textContent=`⚠️ هشدار: این فایل پشتیبان (${b}) قدیمی‌تر از آخرین بازیابی شما (${C}) است.`,s.style.display="block"}const l=n.data.classrooms||{},h=Object.values(l).map(b=>b.info.name),p=h.length,f="کلاس",u=h.map(b=>`<li style="margin-bottom: 4px;">🔹 ${b}</li>`).join("");e.innerHTML=`
        <div style="margin-bottom: 10px;">
            فایل پشتیبان شامل <strong>${p} ${f}</strong> زیر است:
        </div>
        <ul style="
            margin: 0; 
            padding: 10px; 
            background-color: #f8f9fa; 
            border-radius: 5px; 
            border: 1px solid #e9ecef;
            list-style: none; 
            max-height: 150px; 
            overflow-y: auto;
            text-align: right;
        ">
            ${u}
        </ul>
        <div style="margin-top: 15px;">
            لطفاً نحوه بازیابی را مشخص کنید.
        </div>
    `,c.checked=!1,o&&(o.textContent="جایگزینی کامل (حذف داده‌های فعلی)");const y=()=>{const b=c.checked;bi(n,b),a.onclick=null,t.onclick=null,i.removeEventListener("click",y),ve(),je(),ge("class-management-page"),Y(`✅ اطلاعات با موفقیت بازیابی شد (${b?"پاک‌سازی و بازیابی":"همگام‌سازی هوشمند"}).`)},m=()=>{a.onclick=null,t.onclick=null,ve()};a.onclick=y,t.onclick=m,Me("restore-confirm-modal")}function _e(n,i,e={}){const{confirmText:c="تایید",cancelText:o="لغو",confirmClass:t="btn-success",onCancel:a=()=>{},isDelete:s=!1}=e,r=s?()=>ra(n,i):i;Vi.textContent=n,Zt.textContent=c,ps.textContent=o,Zt.className="modal-action-btn",Zt.classList.add(t),Ms(r),Rs(a);const l=Zt.parentElement;ps.style.display=a===null?"none":"inline-block",l.style.justifyContent=a===null?"center":"space-between",Me("custom-confirm-modal")}function ra(n,i){const e=Math.floor(1e4+Math.random()*9e4).toString();Ji.textContent=n,Ki.textContent=e,Ot.value="",wn.disabled=!0,sn(i),Me("secure-confirm-modal"),Ot.focus();const c=()=>{Ot.value===e?wn.disabled=!1:wn.disabled=!0};return Ot.addEventListener("input",c),()=>{Ot.removeEventListener("input",c)}}function vs(n,i={}){const{title:e="ایجاد دسته‌بندی جدید",initialName:c="",initialIsGraded:o=!1,saveButtonText:t="ذخیره"}=i;ta.textContent=e,Xt.value=c,js.checked=o,na.textContent=t,Zn((a,s)=>{if(!a){Y("⚠️ لطفاً نام دسته‌بندی را وارد کنید.");return}n(a,s),ve()}),Me("category-modal"),Xt.focus(),c&&Xt.select()}function Zs(n,i){const e=Object.values(re).filter(a=>!a.isDeleted&&a.info.name!==i.info.name),c=document.getElementById("move-student-modal-title"),o=document.getElementById("move-student-class-select"),t=document.getElementById("move-student-confirm-btn");c.textContent=`انتقال دانش‌آموز: ${n.identity.name}`,o.innerHTML="",e.length===0?(o.innerHTML='<option value="">کلاس دیگری برای انتقال وجود ندارد</option>',t.disabled=!0):(e.forEach(a=>{const s=document.createElement("option");s.value=a.info.name,s.textContent=a.info.name,o.appendChild(s)}),t.disabled=!1),Ai(n),Oi(i),Me("move-student-modal")}function Gs(n,i){if(!n||!i)return;const e=n.identity.name,c=n.identity.firstName||"";n.identity.lastName;const o=document.getElementById("add-note-modal-title");o.textContent="تغییر نام دانش‌آموز";const t=n.identity.firstName&&n.identity.lastName?`${n.identity.firstName} . ${n.identity.lastName}`:e;Ee.value=t,Ee.rows=1,Ee.dispatchEvent(new Event("input",{bubbles:!0})),rt(a=>{const s=cs(a),r=s.name,l=s.firstName||"";if(n.identity.firstName&&n.identity.lastName&&!s.firstName)return Y("⚠️ این دانش‌آموز دارای نام و نام‌خانوادگی تفکیک شده است. لطفاً حتماً از نقطه (.) بین نام و نام‌خانوادگی استفاده کنید."),!1;if(r&&(r!==e||l!==c)){if(ke(i.students).some(y=>y.identity.studentId!==n.identity.studentId&&y.identity.name.toLowerCase()===r.toLowerCase()))return Y("دانش‌آموزی با این نام از قبل در این کلاس وجود دارد."),!1;{n.identity.name=r,n.identity.firstName=s.firstName,n.identity.lastName=s.lastName,Se(i.info.name,`نام دانش‌آموز «${e}» به «${r}» تغییر یافت.`,{type:"VIEW_STUDENT_PROFILE",studentId:n.identity.studentId}),ce(),ft(),$e(),at(),ze(),Ie&&Ie.identity.studentId===n.identity.studentId&&Pe(n);const y=document.querySelector(`#settings-student-list li[data-student-id="${n.identity.studentId}"]`);y&&(y.classList.add("recently-updated"),setTimeout(()=>{y&&y.classList.remove("recently-updated")},1e4),y.scrollIntoView({behavior:"smooth",block:"center"})),Y(`✅ نام دانش‌آموز به «${r}» تغییر یافت.`)}}else if(!r)return Y("⚠️ نام نمی‌تواند خالی باشد."),!1;const f=document.getElementById("add-note-modal-title");f.textContent="ثبت یادداشت جدید",Ee.rows=4}),Me("add-note-modal"),Ee.focus(),Ee.select()}function Me(n){const i=document.getElementById(n);if(i){if(vt)return;i.classList.add("modal-visible"),zs(n),history.pushState(null,"",location.href)}}function ve(n,i=!1){if(!vt)return;const e=document.getElementById(vt),c=vt;zs(null),c==="student-profile-modal"&&Je(null),i||history.back(),e&&(e.classList.add("modal-closing"),setTimeout(()=>{e.classList.remove("modal-visible"),e.classList.remove("modal-closing"),c==="custom-confirm-modal"&&(Ms(null),Rs(null)),c==="secure-confirm-modal"&&sn(null),c==="category-modal"&&Zn(null),c==="mass-comment-modal"&&(Qt.value=""),c==="add-note-modal"&&rt(null),typeof n=="function"&&n()},300))}function Vs(){if(!Pt||!Pt.classList.contains("active")){En.style.display="none";return}const n=Tt.length;n<1?En.style.display="none":En.style.display="block",bs.disabled=n<1,bs.textContent=`📝 ثبت یادداشت گروهی (${n} نفر)`}function Js(){const n=Tt,i=n.length;let e=!1;i>0&&(e=n.some(o=>{var t;return(t=J.studentRecords[o])==null?void 0:t.homework.comment})),sa.textContent=`یادداشت برای ${i} دانش‌آموز ثبت خواهد شد.`,Qt.value="",Qt.dispatchEvent(new Event("input",{bubbles:!0})),qs.checked=!0;const c=document.querySelector("#mass-comment-modal .modal-options");c.style.display=e?"flex":"none",Me("mass-comment-modal"),Qt.focus()}function Cs(n,i){if(!N||!J)return;let e=0;const c=Tt,o=J;c.forEach(t=>{const a=o.studentRecords[t];if(a&&a.homework){const s=a.homework.comment||"";let r=n;i&&s.length>0?r=s+`
---
`+n:r=n,a.homework.comment=r.trim();const l=N.students.find(h=>h.identity.studentId===t);l&&Hr(l,o,r.trim()),e++}}),an([]),ce(),at(),Se(N.info.name,`${e} دانش‌آموز به صورت گروهی یادداشت تکلیف گرفتند.`,{type:"VIEW_SESSIONS"}),Y(`✅ یادداشت برای ${e} دانش‌آموز ثبت شد.`)}function Hr(n,i,e){const o=tt(N).get(i.sessionNumber),t={type:"fromAttendance",sessionNumber:i.sessionNumber},a=`یادداشت جلسه ${o}:
`,s=n.profile.notes.find(r=>!r.isDeleted&&r.source&&r.source.type==="fromAttendance"&&r.source.sessionNumber===t.sessionNumber);s?e?(s.content=a+e,s.isDeleted=!1):s.isDeleted=!0:e&&n.addNote(a+e,t)}function Vn(n){Ee.value=n.note||"",rt(i=>{n.note=i,ce(),Se(n.info.name,"یادداشت کلاس ذخیره شد.",{type:"VIEW_CLASS_NOTE"}),je(),Y("✅ یادداشت کلاس ذخیره شد.")}),Me("add-note-modal"),Ee.focus()}function Ks(n,i){Ee.value=n.note||"",Ee.dispatchEvent(new Event("input",{bubbles:!0})),rt(e=>{n.note=e,ce(),Se(N.info.name,`یادداشت جلسه ${i} ذخیره شد.`,{type:"VIEW_SESSIONS"}),Ue(),Y("✅یادداشت جلسه ذخیره شد.")}),Me("add-note-modal"),Ee.focus()}function Lt(n){We(n),qi.textContent=`تنظیمات کلاس: ${n.info.name}`,ft(),dn(),ha(),ge("settings-page")}function oa(n){const i=document.getElementById("log-modal-title"),e=document.getElementById("log-list");i.textContent=`گزارش فعالیت‌های کلاس: ${n}`,e.innerHTML="";const c=Oa(n);c.length===0?e.innerHTML='<li class="no-content-message">هنوز فعالیتی برای این کلاس ثبت نشده است.</li>':c.forEach(o=>{const t=document.createElement("li");t.className="log-entry";const a=new Date(o.timestamp),s=`${a.toLocaleDateString("fa-IR")} - ${a.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}`,r=document.createElement("span");r.className="log-timestamp",r.textContent=s;const l=document.createElement("span");l.className="log-message",l.textContent=o.message,o.action&&(l.classList.add("log-action-link"),l.dataset.action=JSON.stringify({...o.action,classroomName:o.classroomName})),t.appendChild(r),t.appendChild(l),e.appendChild(t)}),Me("log-modal")}document.getElementById("log-modal-close-btn").addEventListener("click",()=>{ve()});function ws(n){const i=URL.createObjectURL(n),e=document.createElement("a");e.href=i,e.download=n.name,document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(i),setTimeout(()=>{_e("آیا فایل پشتیبان با موفقیت ذخیره شد؟",()=>{Fs(),Jn(),Y("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله، ذخیره شد",cancelText:"خیر",confirmClass:"btn-success"})},500)}async function on(n=[]){const i=await gi(n);if(!i){Y("❌ خطا در ایجاد فایل پشتیبان.");return}let e="پشتیبان کامل سیستم";if(n.length>0){const o=n.join("، ");e=`${n.length===1?"پشتیبان کلاس:":"پشتیبان کلاس‌های:"} ${o}`}Na(i,{name:i.name,description:e,version:"2.0-b64"}).catch(o=>console.error("Failed to save local snapshot:",o)),("ontouchstart"in window||navigator.maxTouchPoints>0)&&navigator.share&&navigator.canShare&&navigator.canShare({files:[i]})?_e("فایل پشتیبان شما آماده است. آیا مایل به اشتراک‌گذاری آن هستید؟",()=>{try{navigator.share({title:i.name,text:"فایل پشتیبان داده‌های برنامه",files:[i]}).then(()=>{_e("آیا فایل پشتیبان با موفقیت ارسال/ذخیره شد؟",()=>{Fs(),Jn(),Y("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}catch(o){console.error("Error during sharing process:",o),ws(i),Y("⚠️خطا در فرآیند اشتراک‌گذاری. فایل در حال دانلود است.")}},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"}):(ws(i),Y("✅پشتیبان‌گیری با موفقیت انجام شد."))}function ln(n,i){n.preventDefault(),St(),$t=n.target.closest("li"),$t&&$t.classList.add("context-menu-target"),setTimeout(()=>{const e=xt,c=e.querySelector("ul");c.innerHTML="",i.forEach(l=>{const h=document.createElement("li");l.isSeparator?h.className="separator":(h.innerHTML=`
                    <span class="icon">${l.icon||""}</span>
                    <span class="label">${l.label}</span>
                `,l.className&&h.classList.add(l.className),h.addEventListener("click",()=>{l.action(),St()})),c.appendChild(h)}),e.classList.add("visible");const{offsetWidth:o,offsetHeight:t}=e,{innerHeight:a}=window,s=document.body.getBoundingClientRect();e.style.top=`${(a-t)/2}px`;const r=s.left+s.width/2;e.style.left=`${r-o/2}px`},50)}function St(){xt.classList.contains("visible")&&xt.classList.remove("visible"),$t&&($t.classList.remove("context-menu-target"),$t=null)}function ca(){var e;Mt.innerHTML="";const n=document.getElementById("header-settings-btn");if(!n)return;const i=[];if(i.push({label:"کلاس‌ها",handler:()=>{We(null),Ge(null),Je(null),ge("class-management-page")}}),N){i.push({label:N.info.name,handler:()=>{Ge(null),Je(null),Ue(),ge("session-page")}});const c=(e=document.querySelector(".page.active"))==null?void 0:e.id;if(c==="session-page"?n.style.visibility="visible":n.style.visibility="hidden",c==="settings-page")i.push({label:"تنظیمات"});else if(J){const t=tt(N).get(J.sessionNumber)||` (#${J.sessionNumber})`;i.push({label:`جلسه ${t}`,handler:()=>{Je(null),Ht("selector")}}),Ie?i.push({label:`پروفایل: ${Ie.identity.name}`}):c==="session-dashboard-page"&&(document.getElementById("attendance-tab-btn").classList.contains("active")?i.push({label:"حضور و غیاب"}):i.push({label:"انتخابگر"}))}}else n.style.visibility="hidden";if(i.length<=1){Mt.style.display="none";return}Mt.style.display="flex",i.forEach((c,o)=>{const t=document.createElement("a");if(t.textContent=c.label,t.className="breadcrumb-item",o===i.length-1||!c.handler?t.classList.add("active"):t.addEventListener("click",c.handler),Mt.appendChild(t),o<i.length-1){const a=document.createElement("span");a.className="breadcrumb-separator",a.textContent="/",Mt.appendChild(a)}})}function ci(n,i,e){e.innerHTML="";const c=N.sessions.filter(o=>{var t;return!o.isDeleted&&!o.isCancelled&&((t=o.studentRecords[n.identity.studentId])==null?void 0:t.attendance)==="absent"}).map(o=>({number:i.get(o.sessionNumber),isMakeup:o.isMakeup})).filter(o=>o.number!==void 0);c.length>0?(e.appendChild(document.createTextNode("جلسات غایب: ")),c.forEach((o,t)=>{const a=document.createElement("span");a.textContent=o.number,o.isMakeup&&a.classList.add("makeup-absence"),e.appendChild(a),t<c.length-1&&e.appendChild(document.createTextNode("، "))})):e.textContent="جلسات غایب: بدون غیبت"}function _n(n,i,e,c={}){const{includePrefix:o=!0}=c;e.innerHTML="";const t=N.sessions.filter(a=>{if(a.isDeleted||a.isCancelled)return!1;const s=a.studentRecords[n.identity.studentId];return s&&s.homework&&(s.homework.status==="incomplete"||s.homework.status==="none")}).map(a=>({number:i.get(a.sessionNumber),status:a.studentRecords[n.identity.studentId].homework.status})).filter(a=>a.number!==void 0);t.length>0?(o&&e.appendChild(document.createTextNode("تکالیف ناقص: ")),t.forEach((a,s)=>{const r=document.createElement("span");r.textContent=a.number,a.status==="incomplete"&&r.classList.add("incomplete-homework"),e.appendChild(r),s<t.length-1&&e.appendChild(document.createTextNode("،"))})):o?e.textContent="تکالیف ناقص: ندارد":e.textContent="ندارد"}function Wr(n,i){var L,D,R;const e=document.createElement("li");e.className="attendance-list-item";const c=document.createElement("span");c.className="absence-info";const o=document.createElement("span");o.className="homework-info";const t=document.createElement("div");t.className="att-row-1";let a=!1;t.addEventListener("mousedown",()=>a=!1),t.addEventListener("touchstart",()=>a=!1,{passive:!0});const s=document.createElement("input");s.type="checkbox",s.className="mass-comment-checkbox",s.checked=Tt.includes(n.identity.studentId),s.addEventListener("change",()=>{const P=n.identity.studentId,Q=Tt;if(s.checked)Q.includes(P)||Q.push(P);else{const z=Q.indexOf(P);z>-1&&Q.splice(z,1)}Vs();const k=document.getElementById("attendance-list");Q.length===0&&k.classList.contains("selection-mode-active")&&k.classList.remove("selection-mode-active")});const r=document.createElement("span");r.className="student-name",r.textContent=n.identity.name,r.addEventListener("click",P=>{if(a){P.stopPropagation(),P.preventDefault(),a=!1;return}Pe(n)}),Vt(t,P=>{a=!0;const Q=document.getElementById("attendance-list");Q.classList.contains("selection-mode-active")||Q.classList.add("selection-mode-active"),s.checked||(s.checked=!0,s.dispatchEvent(new Event("change")))}),t.appendChild(s),t.appendChild(r);const l=document.createElement("div");l.className="att-row-2";const h=document.createElement("button");let p=!1;h.addEventListener("mousedown",()=>p=!1),h.addEventListener("touchstart",()=>p=!1,{passive:!0});const f=((L=J.studentRecords[n.identity.studentId])==null?void 0:L.attendance)||"present",u=P=>{P==="present"?(h.textContent="حاضر",h.className="attendance-status-btn present active"):(h.textContent="غایب",h.className="attendance-status-btn absent active")};u(f),h.addEventListener("click",P=>{var z;if(p){P.stopPropagation();return}const k=(((z=J.studentRecords[n.identity.studentId])==null?void 0:z.attendance)||"present")==="present"?"absent":"present";J.setAttendance(n.identity.studentId,k),k==="absent"&&(J.studentRecords[n.identity.studentId].hadIssue=!1),ce(),u(k),ci(n,i,c),$e(),pa()}),Vt(h,()=>{p=!0;const P=f==="present"?"absent":"present",Q=P==="present"?"حاضر":"غایب";_e(`آیا مطمئن هستید که می‌خواهید وضعیت حضور تمام دانش‌آموزان را به «${Q}» تغییر دهید؟`,()=>{ke(N.students).forEach(k=>{J.setAttendance(k.identity.studentId,P),P==="absent"&&(J.studentRecords[k.identity.studentId].hadIssue=!1)}),ce(),at(),Y(`✅ وضعیت تمام دانش‌آموزان به «${Q}» تغییر یافت.`)},{confirmText:"بله، اعمال کن",confirmClass:"btn-warning"})});const y=document.createElement("div");y.className="homework-controls";const m={none:"بدون تکلیف",complete:"تکلیف کامل",incomplete:"تکلیف ناقص"},v=document.createElement("button");let b=!1;v.addEventListener("mousedown",()=>b=!1),v.addEventListener("touchstart",()=>b=!1,{passive:!0});const C=((D=J.studentRecords[n.identity.studentId])==null?void 0:D.homework.status)||"none";v.className=`homework-status-btn ${C}`,v.title=m[C],v.addEventListener("click",P=>{if(b){P.stopPropagation();return}const Q=J.studentRecords[n.identity.studentId].homework,z={none:"incomplete",incomplete:"complete",complete:"none"}[Q.status];J.setHomeworkStatus(n.identity.studentId,z),ce(),v.className=`homework-status-btn ${z}`,v.title=m[z],_n(n,i,o)}),Vt(v,()=>{b=!0;const Q={none:"incomplete",incomplete:"complete",complete:"none"}[C],k=m[Q];_e(`آیا از تغییر وضعیت تکلیف تمام دانش‌آموزان به «${k}» مطمئن هستید؟`,()=>{ke(N.students).forEach(z=>{J.setHomeworkStatus(z.identity.studentId,Q)}),ce(),at(),Y(`✅ وضعیت تکلیف همه به «${k}» تغییر یافت.`)},{confirmText:"بله",confirmClass:"btn-warning"})});const _=document.createElement("button");let S=!1;_.addEventListener("mousedown",()=>S=!1),_.addEventListener("touchstart",()=>S=!1,{passive:!0}),_.className="btn-icon",_.innerHTML="📝",_.title="افزودن یادداشت برای تکلیف",((R=J.studentRecords[n.identity.studentId])==null?void 0:R.homework.comment)||(_.style.opacity="0.3"),_.addEventListener("click",P=>{if(S){P.stopPropagation();return}const Q=J.studentRecords[n.identity.studentId].homework;Ee.value=Q.comment||"",Ee.dispatchEvent(new Event("input",{bubbles:!0})),rt(k=>{Q.comment=k;const z=tt(N),g=z.get(J.sessionNumber),H={type:"fromAttendance",sessionNumber:J.sessionNumber},ue=`یادداشت جلسه ${g}:
`,j=n.profile.notes.find(fe=>!fe.isDeleted&&fe.source&&fe.source.type==="fromAttendance"&&fe.source.sessionNumber===H.sessionNumber);j?k?j.content=ue+k:j.isDeleted=!0:k&&n.addNote(ue+k,H),ce(),Y("✅یادداشت تکلیف ذخیره شد."),_.style.opacity=k?"1":"0.3",_n(n,z,o)}),Me("add-note-modal"),Ee.focus()}),Vt(_,()=>{S=!0,_e("آیا می‌خواهید برای **تمام** دانش‌آموزان کلاس یادداشت تکلیف ثبت کنید؟",()=>{const P=ke(N.students).map(Q=>Q.identity.studentId);an(P),Js()},{confirmText:"بله",confirmClass:"btn-primary"})}),l.appendChild(h),y.appendChild(_),y.appendChild(v),l.appendChild(y);const x=document.createElement("div");return x.className="att-row-3",ci(n,i,c),_n(n,i,o),x.appendChild(c),x.appendChild(o),e.appendChild(t),e.appendChild(l),e.appendChild(x),e}function Ur(){return tt(N).get(J.sessionNumber)}function at(){if(!N||!J)return;ke(N.students).forEach(o=>{J.initializeStudentRecord(o.identity.studentId)}),an([]);const n=tt(N);eo(),Kt.innerHTML="";const i=document.createElement("li");i.className="attendance-list-header",kt.id="attendance-search-input",kt.type="text",kt.className="inline-search-input",kt.placeholder="جستجو...",kt.value="";const e=document.createElement("div");e.className="student-search-container",e.appendChild(kt);const c=document.createElement("div");c.className="header-labels-container",c.innerHTML=`
    <span class="header-label">تکلیف</span>
    <span class="header-label">حضور</span>
`,i.appendChild(e),i.appendChild(c),Kt.appendChild(i),ke(N.students).forEach(o=>{const t=Wr(o,n);Kt.appendChild(t)}),an([]),Vs(),to(),pa()}function $e(){const n=document.getElementById("student-stats-table-container");if(!n||(n.innerHTML="",!N))return;ke(N.students).length,hs.textContent="آمار عملکرد";const i=["نام"],e=["کل انتخاب ها","غیبت","خروج","فرصت ازدست‌رفته","مشکل","میانگین","نمره کلاسی (کانون)"],c=N.categories.filter(u=>u.isGradedCategory&&!u.isDeleted).map(u=>u.name),o=[...i,...c,...e],t=document.createElement("table");t.className="student-stats-table";const s=t.createTHead().insertRow();o.forEach((u,y)=>{const m=document.createElement("th");y===0?(m.innerHTML=`${u} <span style="opacity: 0.6;">🔗</span>`,m.title="ردیف‌های این ستون قابل کلیک هستند"):m.textContent=u,s.appendChild(m)});const r=t.createTBody(),l=ke(N.students),h=u=>{let y=0;return N.sessions.forEach(m=>{if(m.isDeleted||m.isCancelled)return;const v=m.studentRecords[u.identity.studentId];v&&v.attendance==="absent"&&y++}),y};l.forEach(u=>{const y=r.insertRow();if(y.dataset.studentId=u.identity.studentId,J){const S=J.studentRecords[u.identity.studentId];S&&S.attendance==="absent"&&y.classList.add("absent-row-highlight")}const m=y.insertCell(),v=document.createElement("span");v.textContent=u.identity.name,v.className="student-name-link",v.addEventListener("click",()=>{Pe(u)}),m.appendChild(v),c.forEach(S=>{var D;const I=y.insertCell();I.style.direction="ltr";const x=S.toLowerCase(),L=((D=u.logs.scores[x])==null?void 0:D.filter(R=>!R.isDeleted))||[];L.length>0?L.forEach((R,P)=>{const Q=document.createElement("span");Q.textContent=R.value+(R.comment?"'":""),Q.style.position="relative",R.comment&&(Q.dataset.tooltip=R.comment),I.appendChild(Q),P<L.length-1&&I.appendChild(document.createTextNode(","))}):I.textContent="",I.style.cursor="pointer",I.addEventListener("click",()=>{ze(u,S);const R=document.getElementById("category-selection-container");R&&R.scrollIntoView({behavior:"smooth",block:"center"})})}),y.insertCell().textContent=u.statusCounters.totalSelections||0,y.insertCell().textContent=h(u),y.insertCell().textContent=u.statusCounters.outOfClassCount||0,y.insertCell().textContent=u.statusCounters.missedChances||0;const b=Object.values(u.categoryIssues||{}).reduce((S,I)=>S+I,0);y.insertCell().textContent=b;const C=u.getOverallAverageScore();y.insertCell().textContent=C!==null?C:"-";const _=N.calculateFinalStudentScore(u);y.insertCell().textContent=_!==null?_:"-"}),ke(N.students),hs.setAttribute("data-student-count",l.length),n.appendChild(t);const p=n.querySelector(".student-stats-table"),f=p==null?void 0:p.querySelector("thead th:first-child");f&&f.addEventListener("click",()=>{p.classList.toggle("name-column-expanded")})}function ze(n=null,i=null){const e=document.getElementById("selected-student-result");e.innerHTML="",e.classList.remove("absent");let c,o;if(n&&i)c=n,o=i,$n({student:n,categoryName:i}),Ct(-1);else{if($n(null),!J||Ze<0||!J.winnerHistory[Ze])return;const F=J.winnerHistory[Ze];c=F.winner,o=F.categoryName}const t=document.querySelector(".current-winner-highlight");if(t&&t.classList.remove("current-winner-highlight"),c){const F=document.querySelector(`.student-stats-table tr[data-student-id="${c.identity.studentId}"]`);F&&F.classList.add("current-winner-highlight")}const a=N.categories.find(F=>F.name===o);if(a){zn(a),Ys(a);const F=document.querySelectorAll("#category-selection-container .pill");F.forEach(O=>O.classList.remove("active"));const ne=Array.from(F).find(O=>O.textContent===o);ne&&ne.classList.add("active"),Es(a),_s(a.name)}const s=J.studentRecords[c.identity.studentId],r=(s==null?void 0:s.attendance)==="absent",l=document.createElement("div");l.className="winner-name-container";const h=document.createElement("button");h.className="btn-icon",h.innerHTML="˅",h.title="برنده قبلی";const p=!n;h.classList.toggle("is-disabled",!p||Ze<=0),h.addEventListener("click",()=>{h.classList.contains("is-disabled")?(h.classList.add("shake-animation"),setTimeout(()=>h.classList.remove("shake-animation"),200)):(Ct(Ze-1),ze())});const f=document.createElement("div");f.className="winner-name",f.innerHTML=`✨ <strong>${c.identity.name}</strong>✨`,f.classList.add("heartbeat-animation"),r&&(f.style.textDecoration="line-through",f.style.opacity="0.6",f.style.color="var(--color-secondary)"),(s==null?void 0:s.hadIssue)&&!r&&(f.style.color="var(--color-warning)",f.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"),(s==null?void 0:s.wasOutOfClass)&&!r&&(f.style.color="var(--color-strong-warning)",f.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود");const m=1e3,v=F=>{jt=setTimeout(()=>{co(c,o),jt=null},m)},b=()=>{jt&&(clearTimeout(jt),jt=null)};f.addEventListener("mousedown",v),f.addEventListener("mouseup",b),f.addEventListener("mouseout",b),f.addEventListener("touchstart",v),f.addEventListener("touchmove",b),f.addEventListener("touchend",b),f.addEventListener("touchcancel",b);const C=document.createElement("button");if(C.className="btn-icon",C.innerHTML="˄",C.title="برنده بعدی",C.classList.toggle("is-disabled",!p||Ze>=J.winnerHistory.length-1),C.addEventListener("click",()=>{C.classList.contains("is-disabled")?(C.classList.add("shake-animation"),setTimeout(()=>C.classList.remove("shake-animation"),200)):(Ct(Ze+1),ze())}),l.appendChild(C),l.appendChild(f),c.onboardingSession===J.sessionNumber){const F=document.createElement("div");F.className="new-student-badge",F.textContent="دانش آموز جدید",l.appendChild(F)}l.appendChild(h),e.appendChild(l),it.disabled=p&&!C.classList.contains("is-disabled");const _=document.createElement("div");_.className="status-button-container";const S=document.createElement("button");S.textContent="غایب",S.classList.add("status-button","absent-btn"),r&&S.classList.add("active");const I=document.createElement("button");I.textContent="مشکل",I.classList.add("status-button","issue-btn"),s!=null&&s.hadIssue&&I.classList.add("active");const x=document.createElement("button");x.textContent="خروج",x.classList.add("status-button","exit-btn"),s!=null&&s.wasOutOfClass&&x.classList.add("active");const L=document.createElement("button");L.textContent="پروفایل",L.className="status-button profile-btn",J.isFinished?S.disabled=!0:S.addEventListener("click",()=>{const F=S.classList.contains("active");x.classList.contains("active")&&(x.classList.remove("active"),s.wasOutOfClass=!1,c.statusCounters.outOfClassCount=Math.max(0,(c.statusCounters.outOfClassCount||0)-1),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)),F?(S.classList.remove("active"),J.setAttendance(c.identity.studentId,"present"),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1),f.style.textDecoration="",f.style.opacity="",f.style.color=""):(I.classList.contains("active")&&(I.classList.remove("active"),s.hadIssue=!1,c.statusCounters.otherIssues=Math.max(0,c.statusCounters.otherIssues-1),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)),S.classList.add("active"),J.setAttendance(c.identity.studentId,"absent"),c.statusCounters.missedChances++,f.style.textDecoration="line-through",f.style.opacity="0.6",f.style.color="var(--color-secondary)",f.title=""),$e(),setTimeout(()=>{Ze!==-1?ze():ze(c,o)},0),ce()}),J.isFinished?I.disabled=!0:I.addEventListener("click",()=>{const F=I.classList.contains("active");if(x.classList.contains("active")&&(x.classList.remove("active"),s.wasOutOfClass=!1,c.statusCounters.outOfClassCount=Math.max(0,(c.statusCounters.outOfClassCount||0)-1),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)),F){I.classList.remove("active"),s.hadIssue=!1;const ne=Ve.name;c.categoryIssues[ne]&&(c.categoryIssues[ne]=Math.max(0,c.categoryIssues[ne]-1)),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1),f.style.color="",f.title=""}else{S.classList.contains("active")&&(S.classList.remove("active"),J.setAttendance(c.identity.studentId,"present"),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)),I.classList.add("active"),s.hadIssue=!0;const ne=Ve.name;c.categoryIssues[ne]=(c.categoryIssues[ne]||0)+1,c.statusCounters.missedChances++,f.style.textDecoration="",f.style.opacity="",f.style.color="var(--color-warning)",f.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"}$e(),setTimeout(()=>{Ze!==-1?ze():ze(c,o)},0),ce()}),J.isFinished?x.disabled=!0:x.addEventListener("click",()=>{if(x.classList.contains("active"))x.classList.remove("active"),s.wasOutOfClass=!1,c.statusCounters.outOfClassCount=Math.max(0,(c.statusCounters.outOfClassCount||0)-1),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1),f.style.color="",f.title="";else{if(S.classList.contains("active")&&(S.classList.remove("active"),J.setAttendance(c.identity.studentId,"present"),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)),I.classList.contains("active")){I.classList.remove("active"),s.hadIssue=!1;const ne=Ve.name;c.categoryIssues[ne]&&(c.categoryIssues[ne]=Math.max(0,c.categoryIssues[ne]-1)),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)}x.classList.add("active"),s.wasOutOfClass=!0,c.statusCounters.outOfClassCount=(c.statusCounters.outOfClassCount||0)+1,c.statusCounters.missedChances++,f.style.textDecoration="",f.style.opacity="",f.style.color="var(--color-strong-warning)",f.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود"}$e(),setTimeout(()=>{Ze!==-1?ze():ze(c,o)},0),ce()}),J.isFinished?L.disabled=!0:L.addEventListener("click",()=>{Pe(c)}),_.appendChild(S),_.appendChild(x),_.appendChild(I),_.appendChild(L),e.appendChild(_);const D=document.createElement("div");D.className="student-details-container";const R=document.createElement("div");R.className="student-details-scores",R.innerHTML="<h4>آخرین نمرات</h4>";const P=document.createElement("ul");P.className="scores-list";const Q=N.categories.filter(F=>F.isGradedCategory&&!F.isDeleted);let k=!1;const z=c.logs.scores||{};Q.forEach(F=>{var Ne;const ne=F.name,O=ne.toLowerCase(),M=document.createElement("li"),oe=document.createElement("span");oe.className="skill-name",oe.textContent=`${ne}:`;const te=document.createElement("span");te.className="skill-scores";const X=(Ne=z[O])==null?void 0:Ne.filter(Oe=>!Oe.isDeleted);if(X&&X.length>0){k=!0;const Oe=X.slice(-3);Oe.forEach((he,Ce)=>{const Te=document.createElement("span");Te.textContent=he.value+(he.comment?"'":""),he.comment&&(Te.dataset.tooltip=he.comment,Te.style.position="relative",Te.style.cursor="help",Te.classList.add("tooltip-container")),te.appendChild(Te),Ce<Oe.length-1&&te.appendChild(document.createTextNode(","))})}else te.textContent="none";M.appendChild(oe),M.appendChild(te),P.appendChild(M)}),k||(P.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>'),R.appendChild(P),D.appendChild(R);const g=document.createElement("div");g.className="student-details-notes";const H=document.createElement("div");H.className="history-section-header";const ue=document.createElement("h4");ue.textContent="یادداشت‌ها";const j=document.createElement("button");j.className="btn-icon",j.innerHTML="📝",j.title="افزودن یادداشت جدید",J.isFinished?j.disabled=!0:j.addEventListener("click",()=>{Ee.value="",Ee.dispatchEvent(new Event("input",{bubbles:!0})),rt(F=>{F&&(c.addNote(F),ce(),ze(),Y("✅ یادداشت با موفقیت ثبت شد."))}),Me("add-note-modal"),Ee.focus()}),H.appendChild(ue),H.appendChild(j),g.appendChild(H);const fe=document.createElement("ul");fe.className="notes-list",c.profile.notes&&c.profile.notes.length>0?[...c.profile.notes].sort((ne,O)=>new Date(O.timestamp)-new Date(ne.timestamp)).forEach(ne=>{const O=document.createElement("li");O.dir=Ps(ne.content),O.textContent=ne.content,fe.appendChild(O)}):fe.innerHTML='<div class="no-content-message">یادداشتی وجود ندارد.</div>',g.appendChild(fe),D.appendChild(g),e.appendChild(D)}function la(n){n.addEventListener("input",()=>{const i=n.value,e=Ps(i);n.setAttribute("dir",e)})}function jr(){Ys(null),Yt.innerHTML="",ys.innerHTML="",Rt.classList.add("tooltip-container"),dt.disabled=!0,st.disabled=!0,It.disabled=!0,dt.value="",st.value="",Ft.classList.add("disabled-wrapper"),it.disabled=!0}function kn(){Yt.innerHTML="",N.categories.filter(e=>!e.isDeleted).forEach(e=>{const c=document.createElement("span");c.className="pill",c.textContent=e.name,c.dataset.categoryId=e.id,e.description&&(c.dataset.tooltip=e.description),J.isFinished?c.classList.add("disabled"):c.addEventListener("click",()=>{document.querySelectorAll("#category-selection-container .pill").forEach(t=>t.classList.remove("active")),c.classList.add("active"),zn(e),Ys(e),Es(e),_s(e.name),Ft.classList.remove("disabled-wrapper"),it.disabled=J.isFinished;const o=J.lastWinnerByCategory[e.name];if(o){const t=N.students.find(a=>a.identity.studentId===o);t&&ze(t,e.name)}else{ys.innerHTML="",$n(null),Ct(-1),it.disabled=!1;const t=document.querySelector(".current-winner-highlight");t&&t.classList.remove("current-winner-highlight")}}),J.isFinished||c.addEventListener("contextmenu",o=>{ln(o,[{label:"تغییر نام",icon:"✏️",action:()=>{vs((a,s)=>{const r=Ci(N,e,a);r.success?(e.isGradedCategory=s,ce(),Se(N.info.name,`نام دسته‌بندی «${e.name}» به «${a}» تغییر یافت.`),kn(),$e(),Y(`✅ نام دسته‌بندی به «${a}» تغییر یافت.`)):Y(`⚠️ ${r.message}`)},{title:"ویرایش دسته‌بندی",initialName:e.name,initialIsGraded:e.isGradedCategory,saveButtonText:"ذخیره تغییرات"})}},{label:"حذف دسته‌بندی",icon:"🗑️",className:"danger",action:()=>{_e(`آیا از انتقال دسته‌بندی «${e.name}» به سطل زباله مطمئن هستید؟`,()=>{const a={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${e.name}» از کلاس «${N.info.name}»`,restoreData:{categoryId:e.id,classId:N.info.scheduleCode}};pe.unshift(a),pe.length>50&&pe.pop();const s=e.name.toLowerCase();if(N.students.forEach(r=>{r.logs.scores&&r.logs.scores[s]&&r.logs.scores[s].forEach(l=>{l.isDeleted=!0})}),Ve&&Ve.id===e.id){zn(null),ys.innerHTML="",Es(null),_s(null),Ft.classList.add("disabled-wrapper"),it.disabled=!0;const r=document.querySelector(".current-winner-highlight");r&&r.classList.remove("current-winner-highlight")}e.isDeleted=!0,Se(N.info.name,`دسته‌بندی «${e.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),kn(),$e(),Y(`✅ دسته‌بندی «${e.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}}])}),Yt.appendChild(c)});const i=document.createElement("span");i.className="pill add-category-pill",i.textContent="+",i.title="افزودن دسته‌بندی جدید",J.isFinished?i.classList.add("disabled"):i.addEventListener("click",()=>{vs((e,c)=>{if(N.categories.find(a=>a.name.toLowerCase()===e.toLowerCase()&&!a.isDeleted)){Y("⚠️ این دسته‌بندی از قبل وجود دارد.");return}const t=new ut(e,"",c);N.categories.push(t),ce(),Se(N.info.name,`دسته‌بندی جدید «${e}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),kn(),Y(`✅ دسته‌بندی «${e}» اضافه شد.`)})}),Yt.appendChild(i)}function qr(){if(J.lastUsedCategoryId){if(J.isFinished)return;const n=Yt.querySelector(`.pill[data-category-id="${J.lastUsedCategoryId}"]`);n&&n.click()}J.winnerHistory&&J.winnerHistory.length>0&&(Ct(J.winnerHistory.length-1),ze())}function Ys(n){n?it.textContent=`نفر بعدی در ${n.name}`:it.textContent="نفر بعدی"}function Es(n){if(J.isFinished){dt.disabled=!0,st.disabled=!0,It.disabled=!0,Rt.setAttribute("title","جلسه خاتمه یافته است");return}n&&n.isGradedCategory?(dt.disabled=!1,st.disabled=!1,It.disabled=!1,Rt.removeAttribute("title")):(dt.disabled=!0,st.disabled=!0,It.disabled=!0,n?Rt.setAttribute("title","برای این دسته‌بندی قابلیت نمره دهی تعریف نشده است"):Rt.setAttribute("title","ابتدا یک دسته‌بندی را انتخاب کنید"))}function _s(n){const i=document.querySelector(".student-stats-table");if(!i||(i.querySelectorAll(".current-category-highlight").forEach(a=>{a.classList.remove("current-category-highlight")}),!n))return;let c=-1;const o=i.querySelectorAll("thead th");if(o.forEach((a,s)=>{a.textContent.trim()===n&&(c=s)}),c===-1)return;o[c].classList.add("current-category-highlight"),i.querySelectorAll("tbody tr").forEach(a=>{const s=a.cells[c];s&&s.classList.add("current-category-highlight")})}function Pe(n){Je(n);const i=document.getElementById("student-profile-modal"),e=document.getElementById("modal-profile-student-name"),c=document.getElementById("modal-profile-content-container"),o=document.getElementById("modal-profile-close-btn");if(!i||!e||!c||!o)return;e.textContent=`پروفایل: ${n.identity.name}`,e.style.cursor="pointer",e.onclick=()=>{const l=Ie,h=N;ve(()=>{Gs(l,h)})},c.innerHTML="";const t=document.createElement("div");t.className="profile-header-actions";const a=document.createElement("button");a.className="btn-icon btn-icon-label",a.title="انتقال دانش‌آموز",a.innerHTML="<span>➡️</span><span>انتقال</span>",a.addEventListener("click",()=>{const l=Ie,h=N;ve(()=>{Zs(l,h)})});const s=document.createElement("button");s.className="btn-icon btn-icon-label",s.title="حذف دانش‌آموز",s.innerHTML="<span>🗑️</span><span>حذف</span>",s.style.color="var(--color-strong-warning)",s.addEventListener("click",()=>{const l=Ie,h=N;ve(()=>{_e(`آیا از انتقال دانش‌آموز «${l.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const p={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${l.identity.name}» از کلاس «${h.info.name}»`,restoreData:{studentId:l.identity.studentId,classId:h.info.scheduleCode}};pe.unshift(p),pe.length>50&&pe.pop(),l.isDeleted=!0,Se(h.info.name,`دانش‌آموز «${l.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),ft(),$e(),at(),Y(`✅ دانش‌آموز «${l.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0,onCancel:()=>{Pe(l)}})})});const r=document.createElement("button");r.className="btn-icon btn-icon-label",r.title="افزودن یادداشت جدید",r.innerHTML="<span>📝</span><span>یادداشت</span>",r.addEventListener("click",()=>{const l=Ie;Ee.value="",Ee.dispatchEvent(new Event("input",{bubbles:!0})),rt(h=>{if(h)return l.addNote(h),ce(),Se(N.info.name,`یادداشت جدیدی برای دانش‌آموز «${l.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:l.identity.studentId}),ze(),Y("✅ یادداشت با موفقیت ثبت شد."),()=>Pe(l)}),ve(()=>{Me("add-note-modal"),Ee.focus()})}),t.appendChild(a),t.appendChild(s),t.appendChild(r),c.appendChild(t),Zr(c),da(c),o.onclick=()=>ve(),Me("student-profile-modal")}function Zr(n){if(!Ie||!N)return;const i=document.createElement("div");i.className="scoring-section",i.innerHTML=`
        <h3>ثبت نمره جدید</h3>
        <div id="modal-graded-pills" class="category-pills"></div>
        <div class="input-group centered-input-group" style="margin-top: 15px;">
            <input type="number" id="modal-new-score-value" placeholder="نمره (مثلا: 85)">
        </div>
        <textarea id="modal-new-score-comment" placeholder="توضیحات این نمره (اختیاری)..." style="margin-top: 10px;"></textarea>
        <button id="modal-add-score-btn" class="btn-success" style="width: 100%; margin-top: 10px;">ثبت نمره</button>
    `;const e=i.querySelector("#modal-graded-pills");ke(N.categories).filter(t=>t.isGradedCategory).forEach(t=>{const a=document.createElement("span");a.className="pill",a.textContent=t.name,a.dataset.skillName=t.name,a.addEventListener("click",()=>{e.querySelectorAll(".pill").forEach(s=>s.classList.remove("active")),a.classList.add("active")}),e.appendChild(a)}),i.querySelector("#modal-add-score-btn").addEventListener("click",()=>{const t=e.querySelector(".pill.active");if(!t){Y("⚠️لطفاً یک مهارت را برای نمره‌دهی انتخاب کنید.");return}const a=t.dataset.skillName,s=i.querySelector("#modal-new-score-value"),r=i.querySelector("#modal-new-score-comment"),l=s.value,h=r.value.trim();if(!l){Y("لطفاً مقدار نمره را وارد کنید.");return}Ie.addScore(a,parseFloat(l),h),ce(),Se(N.info.name,`نمره ${l} در ${a} برای «${Ie.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:Ie.identity.studentId}),$e(),ze(),s.value="",r.value="";const p=document.getElementById("modal-profile-content-container"),f=p.querySelector(".history-section");f&&f.remove(),da(p),Y(`✅ نمره برای مهارت ${a} با موفقیت ثبت شد.`)}),n.appendChild(i)}function da(n){if(!Ie)return;const i=document.createElement("div");i.className="history-section";const e=document.createElement("div");e.className="history-section-header";const c=document.createElement("h3");c.textContent="سوابق دانش‌آموز",e.appendChild(c),i.appendChild(e),Gr(i),ua(i),fa(i),n.appendChild(i)}function Gr(n){if(!Ie)return;const i=Ie,e=N.sessions.reduce((u,y)=>{const m=y.studentRecords[i.identity.studentId];return u+(m&&m.attendance==="absent"?1:0)},0),c=Object.values(i.categoryIssues||{}).reduce((u,y)=>u+y,0),o=document.createElement("div");o.className="stats-summary-box",o.innerHTML=`
        <p><strong>کل انتخاب:</strong> ${i.statusCounters.totalSelections}</p>
        <p><strong>غیبت:</strong> ${e}</p>
        <p><strong>فرصت از دست رفته:</strong> ${i.statusCounters.missedChances||0}</p>
        <p><strong>مشکل:</strong> ${c}</p>
    `,n.appendChild(o),o.querySelector("p:nth-child(1)");const t=o.querySelector("p:nth-child(4)"),a=ke(N.categories),s=document.createElement("div");if(s.className="stats-breakdown",a.length>0){a.forEach(y=>{var C;const m=y.name,v=((C=i.categoryCounts)==null?void 0:C[m])||0,b=document.createElement("p");b.className="stats-breakdown-item",b.innerHTML=`<strong>${m}:</strong> ${v}`,s.appendChild(b)});const u=o.querySelector("p:first-child");u&&(u.classList.add("collapsible-toggle"),u.onclick=()=>{s.classList.toggle("open"),u.classList.toggle("open")},u.after(s))}const r=document.createElement("div");r.className="stats-breakdown",a.length>0&&(a.forEach(u=>{var b;const y=u.name,m=((b=i.categoryIssues)==null?void 0:b[y])||0,v=document.createElement("p");v.className="stats-breakdown-item",v.innerHTML=`<strong>${y}:</strong> ${m}`,r.appendChild(v)}),t&&(t.classList.add("collapsible-toggle"),t.onclick=()=>{r.classList.toggle("open"),t.classList.toggle("open")},o.appendChild(r)));const l=document.createElement("p"),h=document.createElement("strong");h.textContent="تکالیف ناقص:";const p=document.createElement("span");p.style.marginRight="5px";const f=tt(N);_n(i,f,p,{includePrefix:!1}),l.appendChild(h),l.appendChild(p),o.appendChild(l)}function ua(n){if(!Ie)return;const i=Ie,e=document.createElement("h4");e.textContent="تاریخچه نمرات:",e.style.marginTop="20px";const c=document.createElement("ul");c.className="list-container";const o=Object.values(i.logs.scores||{}).flat().filter(t=>!t.isDeleted).sort((t,a)=>new Date(a.timestamp)-new Date(t.timestamp));o.length===0?c.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>':o.forEach(t=>{const a=document.createElement("li");a.className="score-history-item";const s=document.createElement("div");s.className="item-content";const r=document.createElement("div");r.className="score-info";const l=document.createElement("span");l.className="score-skill-badge",l.textContent=t.skill;const h=document.createElement("span");h.className="score-value",h.textContent=`نمره: ${t.value}`;const p=document.createElement("span");if(p.className="score-date",p.textContent=new Date(t.timestamp).toLocaleDateString("fa-IR"),r.appendChild(l),r.appendChild(h),r.appendChild(p),s.appendChild(r),t.comment){const u=document.createElement("p");u.className="score-comment",u.innerHTML=Ri(t.comment),u.addEventListener("click",()=>{Ee.value=t.comment,Ee.dispatchEvent(new Event("input",{bubbles:!0})),rt(y=>{t.comment=y,ce(),Se(N.info.name,`توضیحات نمره ${t.value} (${t.skill}) برای دانش‌آموز «${i.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:i.identity.studentId}),Pe(i),Y("✅ توضیحات نمره با موفقیت ویرایش شد.")}),ve(()=>{Me("add-note-modal"),Ee.focus()})}),s.appendChild(u)}const f=document.createElement("button");f.className="btn-icon delete-item-btn",f.innerHTML="🗑️",f.title="حذف این نمره",f.addEventListener("click",()=>{ve(()=>{_e(`آیا از انتقال نمره ${t.value} در مهارت «${t.skill}» به سطل زباله مطمئن هستید؟`,()=>{const u={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"score",description:`نمره ${t.value} (${t.skill}) برای «${i.identity.name}»`,restoreData:{scoreId:t.id,skill:t.skill,studentId:i.identity.studentId,classId:N.info.scheduleCode}};pe.unshift(u),pe.length>50&&pe.pop(),t.isDeleted=!0,ce(),Se(N.info.name,`نمره ${t.value} (${t.skill}) دانش‌آموز «${i.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),Pe(i),Y("✅ نمره به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{Pe(i)}})})}),a.appendChild(s),a.appendChild(f),c.appendChild(a)}),n.appendChild(e),n.appendChild(c)}function fa(n){if(!Ie)return;const i=document.createElement("h4");i.textContent="تاریخچه یادداشت‌ها:",i.style.marginTop="20px";const e=document.createElement("ul");e.className="list-container",!Ie.profile.notes||Ie.profile.notes.length===0?e.innerHTML='<div class="no-content-message">هنوز یادداشتی ثبت نشده است.</div>':[...Ie.profile.notes].filter(o=>!o.isDeleted).sort((o,t)=>new Date(t.timestamp)-new Date(o.timestamp)).forEach(o=>{const t=document.createElement("li");t.className="note-history-item";const a=document.createElement("div");a.className="item-content";const s=document.createElement("div");s.className="note-info";const r=document.createElement("span");r.className="note-date",r.textContent=new Date(o.timestamp).toLocaleDateString("fa-IR");const l=document.createElement("button");l.className="btn-icon delete-item-btn",l.innerHTML="🗑️",l.title="حذف این یادداشت",l.addEventListener("click",()=>{const p=Ie;ve(()=>{_e("آیا از انتقال این یادداشت به سطل زباله مطمئن هستید؟",()=>{const f={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"note",description:`یادداشت برای دانش‌آموز «${p.identity.name}»`,restoreData:{noteId:o.id,studentId:p.identity.studentId,classId:N.info.scheduleCode}};pe.unshift(f),pe.length>50&&pe.pop(),o.isDeleted=!0,Se(N.info.name,`یادداشت دانش‌آموز «${p.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),Pe(p),Y("✅ یادداشت به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{Pe(p)}})})}),s.appendChild(r),s.appendChild(l);const h=document.createElement("p");h.className="note-content",h.innerHTML=Ri(o.content),h.addEventListener("click",()=>{const p=Ie;Ee.value=o.content,Ee.dispatchEvent(new Event("input",{bubbles:!0})),rt(f=>{o.content=f,ce(),Se(N.info.name,`یادداشت دانش‌آموز «${p.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:p.identity.studentId}),Pe(p),Y("✅یادداشت با موفقیت ویرایش شد.")}),ve(()=>{Me("add-note-modal"),Ee.focus()})}),a.appendChild(s),a.appendChild(h),t.appendChild(a),e.appendChild(t)}),n.appendChild(i),n.appendChild(e)}function ma(n){fs.innerHTML="",n.forEach((i,e)=>{const c=document.createElement("option");c.value=e,c.textContent=i.trim(),fs.appendChild(c)})}function ks(){us.innerHTML="",xs.forEach(n=>{const i=document.createElement("li");i.className="preview-item";const e=document.createElement("input");e.type="checkbox",e.checked=!0,e.dataset.name=n;const c=document.createElement("label");c.textContent=n,i.appendChild(e),i.appendChild(c),us.appendChild(i)})}function Vr(n){const i=document.createElement("div");i.className="list-item-buttons";const e=document.createElement("button");return e.className="btn-icon",e.innerHTML="📝",e.title="ویرایش یادداشت کلاس",n.note||(e.style.display="none"),e.addEventListener("click",c=>{c.stopPropagation(),Vn(n)}),i.appendChild(e),i}function Jr(n){const i=document.createElement("div");i.style.flexGrow="1",i.style.display="flex",i.style.flexDirection="column",i.style.alignItems="flex-start";const e=document.createElement("span");e.textContent=n.info.name,e.classList.add("class-name-display"),i.appendChild(e);const c=ke(n.students).length,o=ke(n.sessions).filter(l=>l.isFinished).length,t=so(n.info.scheduleDays),a=document.createElement("div");a.classList.add("class-stats-row");const s=document.createElement("span");s.textContent=`${c} نفر`,s.classList.add("student-count-badge"),a.appendChild(s);const r=document.createElement("span");if(r.textContent=`${o} جلسه`,r.classList.add("session-count-badge"),a.appendChild(r),t){const l=document.createElement("span");l.textContent=t,l.classList.add("schedule-days-badge"),a.appendChild(l)}return i.appendChild(a),i.addEventListener("click",()=>{We(n),Ge(null),nn(N.liveSession),Ue(),ge("session-page")}),i}function Kr(n){const i=document.createElement("li");jn(n).type==="active"&&(i.classList.add("active-class-card"),i.title="این کلاس هم‌اکنون در حال برگزاری است");const c=document.createElement("input");c.type="checkbox",c.className="mass-selection-checkbox",c.checked=ct.includes(n.info.name),c.addEventListener("click",h=>{h.stopPropagation()}),c.addEventListener("change",()=>{const h=n.info.name;if(c.checked)ct.includes(h)||ct.push(h);else{const p=ct.indexOf(h);p>-1&&ct.splice(p,1)}}),i.appendChild(c);const o=Jr(n);i.appendChild(o);const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.gap="5px",t.style.alignItems="flex-end",t.style.marginLeft="10px";const a=document.createElement("div");if(a.className="list-item-badges",n.liveSession&&!n.liveSession.isCancelled&&!n.liveSession.isDeleted){const h=document.createElement("span");h.className="warning-badge",h.textContent="جلسه باز",a.appendChild(h),i.classList.add("has-unfinished-session")}const s=document.createElement("span");if(s.className=`type-badge ${n.info.type}`,s.textContent=n.info.type==="online"?"آنلاین":"حضوری",s.title="نوع کلاس",a.appendChild(s),jn(n).type==="incomplete"){const h=document.createElement("span");h.className="type-badge cancelled-badge",h.textContent="زمان‌بندی ناقص",h.style.cursor="pointer",h.title="برای تکمیل زمان‌بندی کلیک کنید",h.addEventListener("click",p=>{p.stopPropagation(),_e("زمان‌بندی این کلاس کامل نیست. برای نمایش صحیح در لیست، لطفاً روزها و ساعت برگزاری را مشخص کنید.",()=>{Lt(n)},{confirmText:"تنظیمات",confirmClass:"btn-primary"})}),a.appendChild(h)}else{const h=no(n,re);if(h){const p=document.createElement("span");p.className="type-badge conflict-badge",p.textContent="تداخل زمانی",p.style.cursor="pointer",p.title=`تداخل با کلاس: ${h}`,p.addEventListener("click",f=>{f.stopPropagation(),_e(`زمان برگزاری این کلاس با کلاس «${h}» تداخل دارد. لطفاً زمان‌بندی را بررسی کنید.`,()=>{Lt(n)},{confirmText:"تنظیمات",confirmClass:"btn-primary"})}),a.appendChild(p)}}t.appendChild(a);const l=Vr(n);return t.appendChild(l),i.appendChild(t),i.addEventListener("contextmenu",h=>{const p={label:"پشتیبان‌گیری از این کلاس",icon:"📤",action:()=>{on([n.info.name])}},f=ct.length;f>1&&ct.includes(n.info.name)&&(p.label=`پشتیبان‌گیری از ${f} کلاس`,p.action=()=>{on(ct),os([]),je()});const u=[{label:"چاپ گزارش کلاس",icon:"🖨️",action:()=>{ao(n)}},{label:zt.classList.contains("selection-mode-active")?"لغو انتخاب":"انتخاب چند کلاس",icon:"✔️",action:()=>{const y=zt.classList.contains("selection-mode-active");zt.classList.toggle("selection-mode-active"),y&&(os([]),je())}},p,{label:"یادداشت کلاس",icon:"📝",action:()=>{Vn(n)}},{label:"تنظیمات کلاس",icon:"⚙️",action:()=>{Lt(n)}},{label:"گزارش فعالیت‌ها",icon:"📋",action:()=>{oa(n.info.name)}},{label:"تغییر نام",icon:"✏️",action:()=>{const y=n.info.name,m=document.getElementById("add-note-modal-title");m.textContent="تغییر نام کلاس",Ee.value=y,Ee.rows=1,rt(v=>{const b=v.trim();if(b&&b!==y){const C=vi(y,b);C.success?(Ma(y,b),Se(b,`نام کلاس از «${y}» به «${b}» تغییر یافت.`,{type:"VIEW_SESSIONS"}),ce(),je(),Y(`✅نام کلاس به «${b}» تغییر یافت.`)):Y(C.message)}m.textContent="ثبت یادداشت جدید",Ee.rows=4}),Me("add-note-modal"),Ee.focus(),Ee.select()}},{label:"حذف کلاس",icon:"🗑️",className:"danger",action:()=>{_e(`آیا از انتقال کلاس «${n.info.name}» به سطل زباله مطمئن هستید؟`,()=>{const y={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"classroom",description:`کلاس «${n.info.name}»`,restoreData:{name:n.info.name}};pe.unshift(y),pe.length>50&&pe.pop(),n.isDeleted=!0,ce(),je(),Y(`✅ کلاس «${n.info.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}];ln(h,u)}),i}function Jn(){const n=document.getElementById("class-management-stats");if(!n)return;const i=Object.values(re).filter(t=>!t.isDeleted),e=i.length,c=i.reduce((t,a)=>t+ke(a.students).length,0);let o="";Fe.lastBackupTimestamp&&(o=`
            <div class="stats-row backup-stat">
                <span>آخرین پشتیبان: <strong>${new Date(Fe.lastBackupTimestamp).toLocaleString("fa-IR",{year:"numeric",month:"numeric",day:"numeric",weekday:"long",hour:"2-digit",minute:"2-digit"})}</strong></span>
            </div>
        `),n.innerHTML=`
        <div class="stats-row main-stats">
            <span>کل کلاس‌ها: <strong>${e}</strong></span>
            <span>|</span>
            <span>کل دانش‌آموزان: <strong>${c}</strong></span>
        </div>
        ${o} 
    `}function je(){Jn(),zt.innerHTML="",Object.values(re).sort((i,e)=>{const c=jn(i),o=jn(e);return c.sortIndex!==o.sortIndex?c.sortIndex-o.sortIndex:c.type==="upcoming"?c.nextTimestamp-o.nextTimestamp:new Date(i.info.creationDate)-new Date(e.info.creationDate)}).forEach(i=>{if(i.isDeleted)return;const e=Kr(i);zt.appendChild(e)})}function ft(){ls.innerHTML="",N&&ke(N.students).forEach(n=>{const i=document.createElement("li");i.dataset.studentId=n.identity.studentId;const e=document.createElement("span");e.textContent=n.identity.name,e.style.flexGrow="1",e.className="student-name-link",e.addEventListener("click",()=>{Pe(n)}),i.appendChild(e),i.addEventListener("contextmenu",c=>{ln(c,[{label:"تغییر نام",icon:"✏️",action:()=>{Gs(n,N)}},{label:"انتقال دانش‌آموز",icon:"➡️",action:()=>{Zs(n,N)}},{label:"حذف دانش‌آموز",icon:"🗑️",className:"danger",action:()=>{_e(`آیا از انتقال دانش‌آموز «${n.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const t={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${n.identity.name}» از کلاس «${N.info.name}»`,restoreData:{studentId:n.identity.studentId,classId:N.info.scheduleCode}};pe.unshift(t),pe.length>50&&pe.pop(),n.isDeleted=!0,Se(N.info.name,`دانش‌آموز «${n.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),ft(),Y(`✅ دانش‌آموز «${n.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}])}),ls.appendChild(i)})}function dn(){if(ds.innerHTML="",!N)return;N.categories.filter(i=>!i.isDeleted).forEach(i=>{const e=document.createElement("li"),c=document.createElement("div");c.className="name-and-badge-container";const o=document.createElement("span");if(o.textContent=i.name,c.appendChild(o),i.isGradedCategory){const a=document.createElement("span");a.className="category-badge",a.textContent="نمره‌دار",c.appendChild(a)}const t=document.createElement("button");t.className="btn-icon",t.innerHTML="🗑️",t.style.color="var(--color-warning)",t.addEventListener("click",()=>{_e(`آیا از انتقال دسته‌بندی «${i.name}» به سطل زباله مطمئن هستید؟`,()=>{const a={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${i.name}» از کلاس «${N.info.name}»`,restoreData:{categoryId:i.id,classId:N.info.scheduleCode}};pe.unshift(a),pe.length>50&&pe.pop(),i.isDeleted=!0,Se(N.info.name,`دسته‌بندی «${i.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),dn(),Y(`✅ دسته‌بندی «${i.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}),e.appendChild(c),e.appendChild(t),ds.appendChild(e)})}function ha(){if(!N)return;const n=N.info.type||"in-person",i=document.querySelector(`#settings-page input[name="class-type-setting"][value="${n}"]`);i&&(i.checked=!0);const e=N.info.scheduleDays||[];document.querySelectorAll('input[name="schedule-day"]').forEach(c=>{c.checked=e.includes(parseInt(c.value))}),document.getElementById("settings-schedule-start").value=N.info.scheduleStartTime||"",document.getElementById("settings-schedule-end").value=N.info.scheduleEndTime||""}function en(n){document.querySelectorAll(".page").forEach(e=>{e.classList.remove("active")});const i=document.getElementById(n);i&&i.classList.add("active"),n==="class-management-page"?(We(null),Ge(null),Je(null),je(),ms.style.display="flex"):ms.style.display="none",ca()}function ge(n,i={}){const{tab:e}=i,c={pageId:n,currentClassName:N?N.info.name:null,selectedSessionNumber:J?J.sessionNumber:null,selectedStudentId:Ie?Ie.identity.studentId:null};let o=`#${n}`;const t=new URLSearchParams(window.location.hash.split("?")[1]||"");N?t.set("class",N.info.name):t.delete("class"),J?t.set("session",J.sessionNumber):t.delete("session"),Ie?t.set("student",Ie.identity.studentId):t.delete("student"),n==="session-dashboard-page"&&e?t.set("tab",e):n!=="session-dashboard-page"&&t.delete("tab");const a=t.toString();a&&(o+=`?${a}`),window.location.hash!==o&&history.pushState(c,"",o),en(n)}function Yr(n,i){const e=document.createElement("div");e.className="list-item-buttons",e.style.gap="10px";const c=document.createElement("button");if(c.className="btn-icon",c.innerHTML="📝",c.title="ویرایش یادداشت جلسه",n.note||(c.style.display="none"),c.addEventListener("click",o=>{o.stopPropagation(),Ks(n,i)}),!n.isFinished&&!n.isCancelled){const o=document.createElement("button");o.className="btn-success",o.textContent="پایان جلسه",o.style.fontSize="12px",o.style.padding="4px 10px",o.style.whiteSpace="nowrap",o.addEventListener("click",t=>{t.stopPropagation(),_e(`جلسه شماره ${i} خاتمه پیدا خواهد کرد!`,()=>{N.endSpecificSession(n.sessionNumber),ce(),Se(N.info.name,`جلسه ${i} خاتمه یافت.`,{type:"VIEW_SESSIONS"}),Ue(),_e("جلسه با موفقیت خاتمه یافت. آیا مایل به ایجاد فایل پشتیبان هستید؟",()=>{if(lt){Y("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است.");return}on(),Y("✅فایل پشتیبان با موفقیت ایجاد شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}),e.appendChild(o)}return e.appendChild(c),e}function Xr(n,i){const e=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="flex-start",e.style.flexGrow="1";const c=new Date(n.startTime).toLocaleDateString("fa-IR"),o=document.createElement("span");o.className="session-list-title";const t=document.createElement("div");t.style.display="flex",t.style.gap="5px",t.style.marginTop="5px";const a=new Date(n.startTime).toLocaleDateString("fa-IR",{weekday:"long"}),s=document.createElement("span");if(s.className="type-badge day-badge",s.textContent=a,t.appendChild(s),n.isCancelled){o.textContent=`لغو شده - تاریخ: ${c}`,e.style.cursor="default";const r=document.createElement("span");r.className="type-badge cancelled-badge",r.textContent="لغو شده",t.appendChild(r)}else o.textContent=`جلسه ${i} - تاریخ: ${c}`,e.style.cursor="pointer",e.addEventListener("click",()=>{Ge(n),Ht()});if(e.appendChild(o),n.isFinished){const r=document.createElement("span");r.className="type-badge finished-badge",r.textContent="خاتمه یافته",t.appendChild(r)}if(n.isMakeup){const r=document.createElement("span");r.className="type-badge makeup-badge",r.textContent="جبرانی",t.appendChild(r)}return e.appendChild(t),e}function Qr(n,i){const e=document.createElement("li"),c=i.get(n.sessionNumber),o=Xr(n,c);e.appendChild(o);const t=Yr(n,c);return e.appendChild(t),e.addEventListener("contextmenu",a=>{const s=[{label:"یادداشت جلسه",icon:"📝",action:()=>{Ks(n,c)}},{label:n.isCancelled?"بازگردانی جلسه":"لغو جلسه",icon:"❌",action:()=>{const r=n.isCancelled?"بازگردانی جلسه":"لغو جلسه",l=n.isCancelled?"آیا از بازگردانی این جلسه مطمئن هستید؟":"آیا از لغو این جلسه مطمئن هستید؟ جلسه لغو شده در آمار تاثیری ندارد اما قابل بازگردانی است.";_e(l,()=>{n.isCancelled=!n.isCancelled;const h=n.isCancelled?`جلسه ${c} لغو شد.`:`جلسه لغو شده (تاریخ: ${new Date(n.startTime).toLocaleDateString("fa-IR")}) بازگردانی شد.`;Se(N.info.name,h,{type:"VIEW_SESSIONS"}),ce(),Ue(),Y(n.isCancelled?"✅جلسه لغو شد.":"✅جلسه بازگردانی شد.")},{confirmText:r,confirmClass:"btn-warning"})}},{label:"تغییر وضعیت جبرانی",icon:"🔄",action:()=>{N.markAsMakeup(n.sessionNumber),ce();const r=n.isMakeup?`جلسه ${c} به عنوان جبرانی علامت‌گذاری شد.`:`جلسه ${c} از حالت جبرانی خارج شد.`;Se(N.info.name,r,{type:"VIEW_SESSIONS"}),Ue()}},{label:"حذف جلسه",icon:"🗑️",className:"danger",action:()=>{const r=n.isCancelled?"لغو شده":c;_e(`آیا از انتقال جلسه ${r} به سطل زباله مطمئن هستید؟`,()=>{const l={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"session",description:`جلسه ${r} از کلاس «${N.info.name}»`,restoreData:{sessionNumber:n.sessionNumber,classId:N.info.scheduleCode}};pe.unshift(l),pe.length>50&&pe.pop(),n.isDeleted=!0,Se(N.info.name,`جلسه ${r} به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),Ue(),Y(`✅ جلسه ${r} به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}},{label:"تغییر تاریخ",icon:"📅",action:()=>{const r=document.getElementById("dp-day"),l=document.getElementById("dp-month"),h=document.getElementById("dp-year"),p=oi.toJalaali(n.startTime);r.innerHTML="";for(let y=1;y<=31;y++){const m=document.createElement("option");m.value=y,m.textContent=y.toLocaleString("fa-IR"),y===p.jd&&(m.selected=!0),r.appendChild(m)}const f=["فروردین","اردیبهشت","خرداد","تیر","مرداد","شهریور","مهر","آبان","آذر","دی","بهمن","اسفند"];l.innerHTML="",f.forEach((y,m)=>{const v=document.createElement("option");v.value=m+1,v.textContent=y,m+1===p.jm&&(v.selected=!0),l.appendChild(v)}),h.innerHTML="";const u=p.jy;for(let y=u-5;y<=u+5;y++){const m=document.createElement("option");m.value=y,m.textContent=y.toString().replace(/\d/g,v=>"۰۱۲۳۴۵۶۷۸۹"[v]),y===p.jy&&(m.selected=!0),h.appendChild(m)}Fn(y=>{if(!y)return;const m=oi.toGregorian(parseInt(y.jy),parseInt(y.jm),parseInt(y.jd)),v=new Date(m.gy,m.gm-1,m.gd);v.setHours(n.startTime.getHours()),v.setMinutes(n.startTime.getMinutes()),v.setSeconds(n.startTime.getSeconds());const b=n.startTime.toLocaleDateString("fa-IR");n.startTime=v;const C=n.startTime.toLocaleDateString("fa-IR");Se(N.info.name,`تاریخ جلسه ${c} از ${b} به ${C} تغییر یافت.`,{type:"VIEW_SESSIONS"}),ce(),Ue(),Y(`✅ تاریخ جلسه به ${C} تغییر یافت.`)}),Me("date-picker-modal")}}];ln(a,s)}),e}function Ue(){const n=document.getElementById("session-list");if(!N)return;if(n.innerHTML="",N.sessions.length===0){n.innerHTML="<li>هنوز جلسه‌ای شروع نشده است.</li>";return}const i=tt(N);[...ke(N.sessions)].reverse().forEach(c=>{const o=Qr(c,i);n.appendChild(o)})}function Jt(n){if(pt.innerHTML="",n.length>0)n.forEach(i=>{const e=document.createElement("div");e.textContent=i.identity.name,e.addEventListener("click",()=>{Pe(i),pt.style.display="none",gs.value=""}),pt.appendChild(e)}),pt.style.display="block";else if(gs.value.trim()!==""){const i=document.createElement("div");i.className="no-results",i.textContent="پیدا نشد",pt.appendChild(i),pt.style.display="block"}else pt.style.display="none"}function Sn(n){if(ot.innerHTML="",n.length>0)n.forEach(i=>{const e=document.createElement("div");if(e.className="global-search-result",i.type==="student"){const c=document.createElement("span");c.className="student-name",c.textContent=i.student.identity.name;const o=document.createElement("span");o.className="class-name",o.textContent=`کلاس: ${i.classroom.info.name}`,e.addEventListener("click",()=>{We(i.classroom),Pe(i.student),ot.style.display="none",Gt.value=""}),o.addEventListener("click",t=>{t.stopPropagation(),We(i.classroom),Ge(null),nn(i.classroom.liveSession),Ue(),ge("session-page"),ot.style.display="none",Gt.value=""}),e.appendChild(c),e.appendChild(o)}else if(i.type==="classroom"){const c=document.createElement("span");c.className="student-name",c.textContent=`[کلاس] ${i.classroom.info.name}`,e.addEventListener("click",()=>{We(i.classroom),Ge(null),nn(i.classroom.liveSession),Ue(),ge("session-page"),ot.style.display="none",Gt.value=""}),e.appendChild(c)}ot.appendChild(e)}),ot.style.display="block";else if(Gt.value.trim()!==""){const i=document.createElement("div");i.className="no-results",i.textContent="پیدا نشد",ot.appendChild(i),ot.style.display="block"}else ot.style.display="none"}function cn(){const n=document.getElementById("trashed-items-list");if(n.innerHTML="",pe.length===0){n.innerHTML='<li style="text-align: center; padding: 20px;">سطل زباله خالی است.</li>';return}pe.forEach((i,e)=>{const c=document.createElement("li"),o=document.createElement("span");o.textContent=i.description,o.style.flexGrow="1";const t=document.createElement("div");t.className="list-item-buttons";const a=document.createElement("button");a.className="btn-icon",a.innerHTML="🔄",a.title="بازیابی",a.addEventListener("click",()=>{var p;let r=!1,l=null;const h=i.restoreData;switch(i.type){case"classroom":{const f=re[h.name];f&&!f.isDeleted?l=`کلاسی با نام «${h.name}» از قبل فعال است.`:f&&f.isDeleted&&(f.isDeleted=!1,r=!0);break}case"student":{const f=Object.values(re).find(y=>y.info.scheduleCode===h.classId),u=f==null?void 0:f.students.find(y=>y.identity.studentId===h.studentId);u&&(u.isDeleted=!1,r=!0);break}case"session":{const f=Object.values(re).find(y=>y.info.scheduleCode===h.classId),u=f==null?void 0:f.sessions.find(y=>y.sessionNumber===h.sessionNumber);u&&(u.isDeleted=!1,r=!0);break}case"category":{const f=Object.values(re).find(y=>y.info.scheduleCode===h.classId),u=f==null?void 0:f.categories.find(y=>y.id===h.categoryId);u&&(u.isDeleted=!1,r=!0);break}case"score":{const f=Object.values(re).find(m=>m.info.scheduleCode===h.classId),u=f==null?void 0:f.students.find(m=>m.identity.studentId===h.studentId),y=(p=u==null?void 0:u.logs.scores[h.skill.toLowerCase()])==null?void 0:p.find(m=>m.id===h.scoreId);y&&(y.isDeleted=!1,r=!0);break}case"note":{const f=Object.values(re).find(m=>m.info.scheduleCode===h.classId),u=f==null?void 0:f.students.find(m=>m.identity.studentId===h.studentId),y=u==null?void 0:u.profile.notes.find(m=>m.id===h.noteId);y&&(y.isDeleted=!1,r=!0);break}}r?(pe.splice(e,1),ce(),cn(),i.type==="classroom"&&je(),Y("✅ آیتم با موفقیت بازیابی شد.")):Y(l?`⚠️ ${l}`:"⚠️ آیتم اصلی برای بازیابی یافت نشد.")});const s=document.createElement("button");s.className="btn-icon",s.innerHTML="🔥",s.title="حذف دائمی",s.addEventListener("click",()=>{_e("آیا از حذف دائمی این آیتم مطمئن هستید؟ این عمل غیرقابل بازgشت است.",()=>{const r=i.restoreData,l=p=>Object.values(re).find(f=>f.info.scheduleCode===p);let h;switch(i.type){case"classroom":delete re[r.name];break;case"student":h=l(r.classId),Mn({identity:{studentId:r.studentId}},h);break;case"session":h=l(r.classId),h&&_i(h.info.name,r.sessionNumber);break;case"category":h=l(r.classId),h&&ki(h.info.name,r.categoryId);break;case"score":h=l(r.classId),h&&Si(h.info.name,r.studentId,r.skill,r.scoreId);break;case"note":h=l(r.classId),h&&Ii(h.info.name,r.studentId,r.noteId);break}pe.splice(e,1),ce(),cn(),Y("✅ آیتم برای همیشه حذف شد.")},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),t.appendChild(a),t.appendChild(s),c.appendChild(o),c.appendChild(t),n.appendChild(c)})}function eo(){const n=document.getElementById("absentees-summary-container");n&&(n.innerHTML=`
        <div id="absentees-summary-box" class="absentees-summary">
            <div class="absentees-summary-header">
                <h4>لیست غایبین جلسه شماره <span id="absentee-summary-session-number"></span></h4>
                <button id="copy-absentees-btn" class="btn-icon" title="کپی لیست غایبین">📋</button>
            </div>
            <div id="absentees-summary-list" class="summary-list"></div>
        </div>
    `)}function pa(){const n=document.getElementById("absentees-summary-box"),i=document.getElementById("absentees-summary-list"),e=document.getElementById("absentee-summary-session-number");if(!n||!i||!e){console.error("Could not find all absentee summary elements.");return}if(!N||!J){n.classList.remove("visible");return}const c=ke(N.students).filter(t=>{const a=J.studentRecords[t.identity.studentId];return a&&a.attendance==="absent"}),o=tt(N);e.textContent=o.get(J.sessionNumber),c.length>0?n.classList.add("visible"):n.classList.remove("visible"),i.innerHTML="",c.forEach(t=>{const s=(l=>N.sessions.reduce((h,p)=>{if(p.isDeleted||p.isCancelled)return h;const f=p.studentRecords[l.identity.studentId];return h+(f&&f.attendance==="absent"?1:0)},0))(t),r=document.createElement("span");r.className="summary-name",r.textContent=`${t.identity.name} (غیبت: ${s})`,r.addEventListener("click",()=>{r.classList.add("fading-out"),setTimeout(()=>{J.setAttendance(t.identity.studentId,"present"),ce(),at()},200)}),i.appendChild(r)})}function to(){const n=document.getElementById("copy-absentees-btn");if(!n){console.error("Could not find the copy absentees button to attach listener.");return}n.addEventListener("click",()=>{if(!N||!J)return;const i=ke(N.students).filter(o=>{const t=J.studentRecords[o.identity.studentId];return t&&t.attendance==="absent"});if(i.length===0){Y("⚠️لیست غایبین خالی است.");return}const e=o=>N.sessions.reduce((t,a)=>{if(a.isDeleted||a.isCancelled)return t;const s=a.studentRecords[o.identity.studentId];return t+(s&&s.attendance==="absent"?1:0)},0);let c=`لیست غایبین جلسه شماره ${Ur()}:

`;i.forEach(o=>{const t=e(o);c+=`- ${o.identity.name} (تعداد غیبت‌ها: ${t})
`}),navigator.clipboard.writeText(c).then(()=>{Y("✅لیست غایبین با موفقیت کپی شد.")}).catch(o=>{console.error("Failed to copy text: ",o),Y("❌خطا در کپی کردن لیست.")})})}function In(){const n=document.getElementById("demo-mode-banner");n&&(lt?(n.classList.add("visible"),document.body.classList.add("demo-mode-active")):(n.classList.remove("visible"),document.body.classList.remove("demo-mode-active")))}function jn(n){const{scheduleDays:i,scheduleStartTime:e,scheduleEndTime:c}=n.info,o=i&&i.length>0,t=e&&c;if(!o&&!t)return{type:"unscheduled",sortIndex:3};if(!o||!t)return{type:"incomplete",sortIndex:2};const a=new Date,s=a.getDay(),r=a.getHours()*60+a.getMinutes(),[l,h]=e.split(":").map(Number),[p,f]=c.split(":").map(Number),u=l*60+h,y=p*60+f;if(i.includes(s)&&r>=u&&r<y)return{type:"active",sortIndex:0};for(let m=0;m<=7;m++){const v=(s+m)%7;if(i.includes(v)){if(m===0&&r>=u)continue;const b=new Date(a);return b.setDate(a.getDate()+m),b.setHours(l,h,0,0),{type:"upcoming",sortIndex:1,nextTimestamp:b.getTime()}}}return{type:"upcoming",sortIndex:1,nextTimestamp:9999999999999}}function no(n,i){const{scheduleDays:e,scheduleStartTime:c,scheduleEndTime:o}=n.info;if(!e||!e.length||!c||!o)return null;const[t,a]=c.split(":").map(Number),[s,r]=o.split(":").map(Number),l=t*60+a,h=s*60+r;for(const p of Object.values(i)){if(p===n||p.isDeleted||p.info.name===n.info.name)continue;const f=p.info;if(!f.scheduleDays||!f.scheduleDays.length||!f.scheduleStartTime||!f.scheduleEndTime||!e.some(S=>f.scheduleDays.includes(S)))continue;const[y,m]=f.scheduleStartTime.split(":").map(Number),[v,b]=f.scheduleEndTime.split(":").map(Number),C=y*60+m,_=v*60+b;if(l<_&&h>C)return p.info.name}return null}function so(n){if(!n||n.length===0)return"";const i={6:"شنبه",0:"۱شنبه",1:"۲شنبه",2:"۳شنبه",3:"۴شنبه",4:"۵شنبه",5:"جمعه"};return[...n].sort((c,o)=>{const t={6:0,0:1,1:2,2:3,3:4,4:5,5:6};return t[c]-t[o]}).map(c=>i[c]).join("، ")}async function ga(){const n=document.getElementById("restore-points-list");n.innerHTML='<li style="text-align:center; padding:20px;">در حال بارگذاری...</li>';try{const i=await Da();if(i.length===0){n.innerHTML='<li style="text-align:center; padding:20px;">هیچ فایل پشتیبانی یافت نشد.</li>';return}n.innerHTML="",i.forEach(e=>{const c=document.createElement("li");c.className="restore-point-card";const o=new Date(e.timestamp).toLocaleString("fa-IR",{weekday:"long",year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"}),t=(e.file.size/1024).toFixed(1)+" KB";c.innerHTML=`
                <div class="restore-card-header">
                    <span class="restore-date">${o}</span>
                    <span class="restore-size">${t}</span>
                </div>
                <div class="restore-desc">${e.metadata.description||"بدون توضیحات"}</div>
                <div class="restore-actions">
                    <button class="btn-restore-action">بازگردانی</button>
                </div>
            `,c.querySelector(".btn-restore-action").addEventListener("click",async()=>{try{const s=await e.file.text(),h=(await new Ss().loadAsync(s,{base64:!0})).file("backup.json");if(!h)throw new Error("فایل backup.json یافت نشد.");const p=await h.async("string"),f=JSON.parse(p);Un(f)}catch(s){console.error("Restore failed:",s),Y("❌ فایل پشتیبان معتبر نیست.")}}),n.appendChild(c)})}catch(i){console.error("Failed to load snapshots:",i),n.innerHTML='<li style="text-align:center; color:red;">خطا در بارگذاری اطلاعات.</li>'}}function io(n,i,e="default",c=!1){let o=[...ke(n.students)];const t=new Date().toLocaleDateString("fa-IR",{year:"numeric",month:"long",day:"numeric",weekday:"long"});e==="alpha"&&o.sort((p,f)=>{const u=v=>{if(v.identity.lastName)return v.identity.lastName;const b=v.identity.name.trim().split(/\s+/);return b[b.length-1]||""},y=u(p),m=u(f);return y.localeCompare(m,"fa-IR")});let a="<tr>";i.forEach(p=>{a+=`<th>${p.label}</th>`}),a+="</tr>";let s="";o.forEach((p,f)=>{s+="<tr>",i.forEach(u=>{let y="-";if(u.id==="row_num")y=f+1;else if(u.id==="name")if(p.identity.lastName&&p.identity.firstName)y=`${p.identity.lastName}، ${p.identity.firstName}`;else{const v=p.identity.name.trim().split(/\s+/);if(v.length>1){const b=v.pop(),C=v.join(" ");y=`${b}، ${C}`}else y=p.identity.name}else u.id==="total_selections"?y=p.statusCounters.totalSelections:u.id==="missed_chances"?y=p.statusCounters.missedChances:u.id==="issues"?y=Object.values(p.categoryIssues||{}).reduce((v,b)=>v+b,0):u.id==="absences"?y=n.sessions.reduce((v,b)=>{if(b.isDeleted||b.isCancelled)return v;const C=b.studentRecords[p.identity.studentId];return v+(C&&C.attendance==="absent"?1:0)},0):u.id==="avg_score"?y=p.getOverallAverageScore()||"-":u.id==="final_score"?y=n.calculateFinalStudentScore(p)||"-":u.type==="category"&&(y=p.categoryCounts[u.id]||0);const m=u.id==="name"?'style="text-align: right;"':"";s+=`<td ${m}>${y}</td>`}),s+="</tr>"});let r="";c&&(r=`
            <div class="warning-footnote">
                ⚠️ <strong>توجه:</strong> ترتیب الفبایی این لیست ممکن است دقیق نباشد. (نام خانوادگی برخی دانش‌آموزان در سیستم تفکیک نشده است)
            </div>
        `);const l=window.open("","_blank");if(!l){Y("⚠️ مرورگر شما پنجره جدید را مسدود کرد. لطفاً اجازه دهید.","error");return}const h=`
        <!DOCTYPE html>
        <html lang="fa" dir="rtl">
        <head>
            <title>گزارش کلاس ${n.info.name}</title>
            <style>
                @media print {
                    @page { size: A4; margin: 10mm; }
                    body { font-family: Tahoma, 'Vazirmatn', sans-serif; color: #000; }
                }
                body { font-family: Tahoma, sans-serif; padding: 20px; direction: rtl; }
                h1 { text-align: center; margin-bottom: 5px; font-size: 24px; }
                .meta { text-align: center; margin-bottom: 30px; font-size: 14px; color: #444; }
                table { width: 100%; border-collapse: collapse; font-size: 12px; }
                th, td { border: 1px solid #333; padding: 6px 8px; text-align: center; }
                th { background-color: #eee; font-weight: bold; }
                tr:nth-child(even) { background-color: #f9f9f9; }
                .signature { margin-top: 50px; display: flex; justify-content: space-between; padding: 0 50px; }
                
                .warning-footnote {
                    margin-top: 20px;
                    font-size: 11px;
                    color: #555;
                    font-style: italic;
                    border-top: 1px solid #ccc;
                    padding-top: 10px;
                }
            </style>
        </head>
        <body>
            <h1>گزارش وضعیت کلاس ${n.info.name}</h1>
            <div class="meta">
                تاریخ گزارش: ${t} | تعداد دانش‌آموزان: ${o.length}
            </div>
            <table>
                <thead>${a}</thead>
                <tbody>${s}</tbody>
            </table>
            ${r}
            <div class="signature">
                <div>امضای معلم</div>
                <div>مهر و امضای مدرسه</div>
            </div>
            <script>
                window.onload = function() { window.print(); }
            <\/script>
        </body>
        </html>
    `;l.document.write(h),l.document.close()}function ao(n){const i=Xi;i.innerHTML="";const c=ke(n.students).filter(f=>!f.identity.lastName).length,o=[{id:"row_num",label:"ردیف",checked:!0},{id:"name",label:"نام دانش‌آموز",checked:!0},{id:"total_selections",label:"کل انتخاب‌ها",checked:!0},{id:"absences",label:"تعداد غیبت",checked:!0},{id:"missed_chances",label:"فرصت سوخته",checked:!1},{id:"issues",label:"موارد انضباطی",checked:!1},{id:"avg_score",label:"میانگین نمرات",checked:!0},{id:"final_score",label:"نمره نهایی (کانون)",checked:!0}];n.categories.forEach(f=>{f.isDeleted||o.push({id:f.name,label:`تعداد ${f.name}`,type:"category",checked:!1})}),o.forEach(f=>{const u=document.createElement("label");u.className="report-column-item";const y=document.createElement("input");y.type="checkbox",y.checked=f.checked,y.dataset.colId=f.id,y.dataset.colLabel=f.label,f.type&&(y.dataset.colType=f.type);const m=document.createElement("span");m.textContent=f.label,u.appendChild(y),u.appendChild(m),i.appendChild(u)});const t=i.parentElement,a=t.querySelector("#report-sort-options");a&&a.remove();const s=document.createElement("div");s.id="report-sort-options",s.style.marginTop="20px",s.style.padding="15px",s.style.backgroundColor="#f8f9fa",s.style.borderRadius="5px",s.style.border="1px solid #e9ecef",s.innerHTML=`
        <div style="margin-bottom: 10px; font-weight: bold; color: #333;">ترتیب نمایش لیست:</div>
        
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <label style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <input type="radio" name="report-sort" value="default" checked style="accent-color: var(--color-primary);">
                <span>پیش‌فرض (بر اساس زمان ورود به کلاس)</span>
            </label>
            
            <label style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <input type="radio" name="report-sort" value="alpha" style="accent-color: var(--color-primary);">
                <span>الفبایی (بر اساس نام خانوادگی)</span>
            </label>
        </div>

        <div id="sort-warning" style="
            display: none; 
            margin-top: 12px; 
            background-color: #fff3cd; 
            color: #856404; 
            padding: 10px; 
            border-radius: 4px; 
            font-size: 13px; 
            border: 1px solid #ffeeba;
            line-height: 1.5;
        ">
            ⚠️ <strong>توجه:</strong> نام خانوادگی ${c} دانش‌آموز هنوز تفکیک نشده است. مرتب‌سازی این موارد ممکن است کاملاً دقیق نباشد.
        </div>
    `;const r=t.querySelector(".modal-actions");t.insertBefore(s,r);const l=s.querySelectorAll('input[name="report-sort"]'),h=s.querySelector("#sort-warning"),p=()=>{const f=s.querySelector('input[value="alpha"]').checked;h.style.display=f&&c>0?"block":"none"};l.forEach(f=>f.addEventListener("change",p)),Qi.onclick=()=>{const f=[];if(i.querySelectorAll('input[type="checkbox"]:checked').forEach(v=>{f.push({id:v.dataset.colId,label:v.dataset.colLabel,type:v.dataset.colType})}),f.length===0){Y("⚠️ لطفاً حداقل یک ستون را انتخاب کنید.");return}const y=s.querySelector('input[name="report-sort"]:checked').value,m=y==="alpha"&&c>0;ve(),io(n,f,y,m)},ea.onclick=()=>{ve()},Me("report-config-modal")}const ro=Object.freeze(Object.defineProperty({__proto__:null,_internalShowPage:en,addCategoryBtn:sr,addClassBtn:Ha,addNoteModal:gr,addScoreBtn:Er,addStudentBtn:Za,appHeader:ms,attendanceListUl:Kt,attendanceMassActionsContainer:En,attendancePage:ir,attendancePane:Pt,attendanceSearchInput:kt,backToSessionsBtn:ja,backToStudentPageBtn:vr,backupDataBtn:ur,breadcrumbContainer:Mt,cancelImportBtn:tr,cancelNoteBtn:br,categoryListUl:ds,categoryModal:Ar,categoryModalCancelBtn:Or,categoryModalSaveBtn:na,categoryModalTitle:ta,classListHeader:rr,classListUl:zt,classManagementPage:Ui,classSaveNoteBtn:yr,closeActiveModal:ve,closeContextMenu:St,closeNavBtn:lr,columnMappingPage:Qa,columnSelectDropdown:fs,confirmColumnBtn:er,confirmModalCancelBtn:ps,confirmModalConfirmBtn:Zt,confirmModalMessage:Vi,contextMenu:xt,csvCancelBtn:Ka,csvConfirmBtn:Ja,csvFileInput:Xa,csvPreviewList:us,csvPreviewPage:Va,customConfirmModal:mr,displayWinner:ze,finishAttendanceBtn:ar,globalStudentSearchInput:Gt,globalStudentSearchResultsDiv:ot,gradedCategoryPillsContainer:Cr,hamburgerMenuBtn:or,handleUndo:aa,importCsvBtn:Ya,initiateBackupProcess:on,isGradedCheckbox:Sr,massCommentAppendCheckbox:qs,massCommentBtn:bs,massCommentCancelBtn:zr,massCommentContent:Qt,massCommentModal:Mr,massCommentModalTitle:Rr,massCommentSaveBtn:$r,massCommentStudentCountMessage:sa,newCategoryModalIsGradedCheckbox:js,newCategoryModalNameInput:Xt,newCategoryNameInput:nr,newClassNameInput:Pa,newNoteContent:Ee,newScoreCommentTextarea:Yi,newScoreValueInput:wr,newStudentNameInput:qa,openContextMenu:ln,openModal:Me,overlay:dr,pasteArea:Zi,processMassHomeworkComment:Cs,processPasteBtn:Ga,profileScoresListUl:kr,profileStatsSummaryDiv:_r,quickGradeFormWrapper:Rt,quickGradeSubmitBtn:It,quickNoteTextarea:st,quickScoreInput:dt,renderAttendancePage:at,renderBreadcrumbs:ca,renderClassList:je,renderClassManagementStats:Jn,renderColumnSelector:ma,renderGlobalSearchResults:Sn,renderImportPreview:ks,renderLogModal:oa,renderMassCommentControls:Vs,renderRestorePointsPage:ga,renderScoresHistory:ua,renderSearchResults:Jt,renderSessionDashboard:Ht,renderSessions:Ue,renderSettingsCategories:dn,renderSettingsOther:ha,renderSettingsStudentList:ft,renderStudentNotes:fa,renderStudentStatsList:$e,renderTrashPage:cn,reportCancelBtn:ea,reportColumnsContainer:Xi,reportConfigModal:Dr,reportPrintBtn:Qi,restoreDataBtn:fr,restoreFileInput:Gi,secureConfirmCancelBtn:pr,secureConfirmCode:Ki,secureConfirmConfirmBtn:wn,secureConfirmInput:Ot,secureConfirmMessage:Ji,secureConfirmModal:hr,selectStudentBtn:it,selectStudentBtnWrapper:Ft,sessionDashboardPage:Fr,setAutoDirectionOnInput:la,settingsClassNameHeader:qi,settingsPage:Ua,settingsStudentListUl:ls,setupDashboardTabs:ia,setupLongPress:Vt,showCategoryModal:vs,showClassNoteModal:Vn,showCustomConfirm:_e,showMassCommentModal:Js,showMoveStudentModal:Zs,showNotification:Y,showPage:ge,showRenameStudentModal:Gs,showRestoreConfirmModal:Un,showSecureConfirm:ra,showSessionNoteModal:Ks,showSettingsPage:Lt,showStudentProfile:Pe,showUndoToast:Pr,sideNavMenu:cr,studentSearchInput:gs,studentSearchResultsDiv:pt,studentStatsHeader:hs,switchDashboardTab:rn,trashedCategoriesList:Tr,trashedClassesList:Ir,trashedNotesList:Br,trashedScoresList:Nr,trashedSessionsList:Lr,trashedStudentsList:xr,triggerFileDownload:ws,undoBtn:Wa,undoMessage:ji,undoToast:Wn,updateDemoModeBanner:In},Symbol.toStringTag,{value:"Module"}));function oo(){const n=window.location.hash;if(!n||n==="#")return!1;const[i,e]=n.split("?"),c=i.substring(1),o=new URLSearchParams(e),t=o.get("class"),a=parseInt(o.get("session"),10),s=o.get("student"),r=o.get("tab")||"selector";if(t&&re[t])We(re[t]),a&&N.getSession(a)&&Ge(N.getSession(a)),s&&N.students.find(l=>l.identity.studentId===s)&&Je(N.students.find(l=>l.identity.studentId===s));else return!1;switch(c){case"session-page":Ue(),ge("session-page");break;case"session-dashboard-page":Ht(c==="attendance-page"?"attendance":r);break;case"settings-page":Lt(N);break;case"student-profile-page":Ht(r),Pe(Ie);break;default:return!1}return!0}document.addEventListener("DOMContentLoaded",()=>{const{globalStudentSearchInput:n,newClassNameInput:i,addClassBtn:e,undoBtn:c,newStudentNameInput:o,addStudentBtn:t,pasteArea:a,processPasteBtn:s,csvPreviewList:r,csvConfirmBtn:l,csvCancelBtn:h,importCsvBtn:p,csvFileInput:f,columnSelectDropdown:u,confirmColumnBtn:y,cancelImportBtn:m,newCategoryNameInput:v,addCategoryBtn:b,selectStudentBtn:C,attendancePage:_,finishAttendanceBtn:S,classListHeader:I,studentStatsHeader:x,hamburgerMenuBtn:L,sideNavMenu:D,closeNavBtn:R,overlay:P,backupDataBtn:Q,restoreDataBtn:k,restoreFileInput:z,confirmModalCancelBtn:g,confirmModalConfirmBtn:H,secureConfirmCancelBtn:ue,secureConfirmConfirmBtn:j,newNoteContent:fe,classSaveNoteBtn:F,cancelNoteBtn:ne,studentSearchInput:O,studentSearchResultsDiv:M,isGradedCheckbox:oe,categoryModalSaveBtn:te,categoryModalCancelBtn:X,massCommentBtn:Ne,massCommentCancelBtn:Oe,massCommentSaveBtn:he,massCommentContent:Ce,massCommentAppendCheckbox:Te,attendanceSearchInput:Ae}=ro,Ye=document.getElementById("trash-nav-btn");document.querySelector(".global-search-container .search-icon"),On(),In(),oo()||(je(),ge("class-management-page"));function d(B,Z){const U=document.querySelector(B);if(!U)return;const ee=U.querySelector(".search-icon"),se=U.querySelector(".animated-search-input");!ee||!se||(ee.addEventListener("mousedown",me=>{me.preventDefault()}),ee.addEventListener("click",()=>{U.classList.contains("search-active")||(U.classList.add("search-active"),se.focus())}),se.addEventListener("blur",()=>{setTimeout(()=>{U.classList.remove("search-active"),se.value="",Z&&Z([])},150)}))}Ae.addEventListener("input",()=>{const B=Ae.value.toLowerCase().trim(),Z=ss(B);Kt.querySelectorAll(".attendance-list-item").forEach(ee=>{const se=ee.querySelector(".student-name");if(se){const me=se.textContent,ae=et(me.toLowerCase()),de=ae.includes(et(B)),we=ae.includes(et(Z));de||we?ee.style.display="flex":ee.style.display="none"}})}),X.addEventListener("click",()=>{ve(),Zn(null)}),te.addEventListener("click",()=>{const B=Xt.value.trim(),Z=js.checked;typeof Nn=="function"&&Nn(B,Z)}),window.addEventListener("scroll",St),document.addEventListener("click",B=>{xt.classList.contains("visible")&&!xt.contains(B.target)&&St(),O.contains(B.target)||(M.style.display="none");const Z=B.target.closest(".log-action-link");if(Z&&Z.dataset.action)try{const U=JSON.parse(Z.dataset.action);Nt(U)}catch(U){console.error("Could not parse log action:",U)}}),Ft.addEventListener("click",()=>{(Ft.classList.contains("disabled-wrapper")||it.disabled)&&(it.classList.add("shake-animation"),setTimeout(()=>{it.classList.remove("shake-animation")},200))}),x.addEventListener("click",()=>{const B=new Date().getTime();B-Bs>500?Cn(1):Cn(Tn+1),Di(B),Tn===5&&(Cn(0),_e("آیا از صفر کردن تمام شمارنده‌های دانش‌آموزان مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{Ei(),$e(),Y("تمام آمارها صفر شدند ✅.")},{confirmText:"بله",confirmClass:"btn-warning"}))}),I.addEventListener("click",()=>{const B=new Date().getTime();B-Ts>500?vn(1):vn(Ln+1),Ni(B),Ln===5&&(vn(0),_e("آیا از ساخت یک کلاس تستی تصادفی مطمئن هستید؟",()=>{function Z(){const U=`کلاس تستی ${Object.keys(re).length+1}`,ee=new rs({name:U,type:"online"});["علی رضایی","مریم حسینی","زهرا احمدی","رضا محمدی","فاطمه کریمی"].forEach(me=>ee.addStudent(new yn({name:me}))),re[U]=ee,ce(),je()}Z(),Y("کلاس تستی با موفقیت ساخته شد ✅!")},{confirmText:"بساز",confirmClass:"btn-success"}))}),ue.addEventListener("click",()=>{ve(),sn(null)});const W=document.getElementById("date-picker-confirm-btn"),$=document.getElementById("date-picker-cancel-btn"),E=document.getElementById("dp-day"),w=document.getElementById("dp-month"),T=document.getElementById("dp-year");W.addEventListener("click",()=>{const B=T.value,Z=w.value,U=E.value;B&&Z&&U&&typeof An=="function"?(An({jy:B,jm:Z,jd:U}),ve()):Y("⚠️ خطا در انتخاب تاریخ."),Fn(null)}),$&&$.addEventListener("click",()=>{ve(),Fn(null)}),j.addEventListener("click",()=>{typeof Bn=="function"&&Bn(),ve(),sn(null)}),g.addEventListener("click",()=>{ve(Ds)}),H.addEventListener("click",()=>{ve(Ns)}),C.addEventListener("click",()=>{if(dt.value.trim()!==""||st.value.trim()!==""){Y("⚠️لطفاً ابتدا با دکمه «ثبت»، تغییرات را ذخیره کنید و یا نمره و یادداشت را پاک کنید.");return}if(!N||!J||!Ve)return;const B=N.selectNextWinner(Ve.name,J);if(B){ri();const Z=J.studentRecords[B.identity.studentId];if(Z&&Z.attendance==="absent"&&B.statusCounters.missedChances++,Z&&Z.hadIssue){B.statusCounters.missedChances++;const ee=Ve.name;B.categoryIssues[ee]=(B.categoryIssues[ee]||0)+1}Z&&Z.wasOutOfClass&&(B.statusCounters.outOfClassCount=(B.statusCounters.outOfClassCount||0)+1,B.statusCounters.missedChances++);const U={winner:B,categoryName:Ve.name};J.winnerHistory.push(U),J.winnerHistory.length>10&&J.winnerHistory.shift(),Ct(J.winnerHistory.length-1),J.lastUsedCategoryId=Ve.id,J.lastSelectedWinnerId=B.identity.studentId,$e(),setTimeout(()=>ze(),0),ce()}else Y("❌دانش‌آموز واجد شرایطی برای انتخاب یافت نشد.")}),b.addEventListener("click",()=>{if(!N)return;const B=v.value.trim(),Z=oe.checked;if(!B){alert("⚠️لطفاً نام دسته‌بندی را وارد کنید.");return}const U=N.categories.find(se=>se.name.toLowerCase()===B.toLowerCase());if(U)if(U.isDeleted){const se=N.categories.findIndex(me=>me===U);se>-1&&N.categories.splice(se,1)}else{alert("⚠️این دسته‌بندی از قبل وجود دارد.");return}const ee=new ut(B,"",Z);N.categories.push(ee),ce(),Se(N.info.name,`دسته‌بندی جدید «${B}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),dn(),v.value="",oe.checked=!1}),document.querySelectorAll('#settings-page input[name="class-type-setting"]').forEach(B=>{B.addEventListener("change",()=>{if(!N)return;const Z=B.value,U=N.info.type||"in-person";if(Z===U)return;const ee=ae=>ae==="online"?"آنلاین":"حضوری",se=ee(U),me=ee(Z);_e(`آیا از تغییر نوع کلاس از «${se}» به «${me}» مطمئن هستید؟`,()=>{N.info.type=Z,ce(),Se(N.info.name,`نوع کلاس به «${me}» تغییر یافت.`,{type:"VIEW_CLASS_SETTINGS"}),je(),Y(`✅ نوع کلاس به «${me}» تغییر یافت.`)},{confirmText:"بله",confirmClass:"btn-warning",onCancel:()=>{const ae=document.querySelector(`#settings-page input[name="class-type-setting"][value="${U}"]`);ae&&(ae.checked=!0)}})})});const G=document.querySelectorAll('input[name="schedule-day"]'),A=document.getElementById("settings-schedule-start"),V=document.getElementById("settings-schedule-end");G.forEach(B=>{B.addEventListener("change",()=>{if(!N)return;const Z=Array.from(G).filter(U=>U.checked).map(U=>parseInt(U.value));N.info.scheduleDays=Z,ce()})});const ie=()=>{N&&(N.info.scheduleStartTime=A.value,N.info.scheduleEndTime=V.value,ce())};A.addEventListener("change",ie),V.addEventListener("change",ie),v.addEventListener("keyup",B=>{B.key==="Enter"&&b.click()}),y.addEventListener("click",()=>{if(!xn){alert("❌خطایی رخ داده است. لطفاً فایل را دوباره انتخاب کنید."),ge("settings-page");return}const B=parseInt(u.value,10),ee=xn.split(`
`).slice(1).map(se=>{var ae;return(ae=se.split(",")[B])==null?void 0:ae.trim()}).filter(se=>se&&se.length>0);ee.length>0?(qt(ee),ks(),ge("csv-preview-page")):alert("هیچ نامی در ستون انتخاب شده پیدا نشد. لطفاً ستون دیگری را امتحان کنید یا فایل خود را بررسی کنید."),bn(null)}),p.addEventListener("click",()=>{f.click()}),f.addEventListener("change",B=>{const Z=B.target.files[0];if(!Z)return;const U=new FileReader;U.onload=ee=>{const se=ee.target.result;bn(se);const ae=se.split(`
`)[0].split(",");ma(ae),ge("column-mapping-page")},U.readAsText(Z),B.target.value=null}),m.addEventListener("click",()=>{bn(null),ge("settings-page")}),l.addEventListener("click",()=>{const B=r.querySelectorAll('input[type="checkbox"]:checked');let Z=!1;B.forEach(U=>{const ee=U.dataset.name,se=N.students.find(de=>de.identity.name.toLowerCase()===ee.toLowerCase());if(se)if(se.isDeleted)Mn(se,N);else{console.log(`دانش‌آموز «${ee}» به دلیل تکراری بودن اضافه نشد.`);return}const me=cs(ee),ae=new yn(me);N.addStudent(ae),N.sessions.length>0&&(ke(N.sessions).filter(de=>de.isFinished&&!de.isCancelled).forEach(de=>{de.setAttendance(ae.identity.studentId,"absent")}),Qe(ae,N),Z=!0)}),ce(),Se(N.info.name,`${B.length} دانش‌آموز جدید از لیست ورودی به کلاس اضافه شدند.`,{type:"VIEW_SESSIONS"}),ft(),Z&&Wt(B.length),ge("settings-page"),a.value="",qt([])}),h.addEventListener("click",()=>{qt([]),ge("settings-page")}),s.addEventListener("click",()=>{const B=a.value.trim();if(!B){alert("کادر متنی خالی است. لطفاً اسامی را وارد کنید.");return}const Z=B.split(`
`).map(U=>U.trim()).filter(U=>U.length>0);Z.length>0?(qt(Z),ks(),ge("csv-preview-page")):alert("هیچ نام معتبری برای ورود پیدا نشد.")}),o.addEventListener("keyup",B=>{B.key==="Enter"&&t.click()}),t.addEventListener("click",()=>{if(!N)return;const B=o.value.trim();if(!B){alert("لطفاً نام دانش‌آموز را وارد کنید.");return}const Z=N.students.find(se=>se.identity.name.toLowerCase()===B.toLowerCase());if(Z)if(Z.isDeleted)Mn(Z,N);else{alert("❌دانش‌آموزی با این نام از قبل در این کلاس وجود دارد.");return}const U=cs(B),ee=new yn(U);N.addStudent(ee),N.sessions.length>0&&(ke(N.sessions).filter(se=>se.isFinished&&!se.isCancelled).forEach(se=>{se.setAttendance(ee.identity.studentId,"absent")}),Qe(ee,N),Wt(1)),ce(),Se(N.info.name,`دانش‌آموز «${B}» به کلاس اضافه شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:ee.identity.studentId}),ft(),$e(),o.value="",o.focus()}),document.getElementById("new-session-btn").addEventListener("click",()=>{if(N){const B=N.sessions.find(U=>!U.isFinished&&!U.isCancelled&&!U.isDeleted);if(B){Y(`⚠️ جلسه ${B.sessionNumber} هنوز تمام نشده است. لطفاً ابتدا با دکمه ✅ آن را خاتمه دهید.`);return}const Z=()=>{const U=ee=>{const se=N.startNewSession();nn(se),Ge(se),N.students.forEach(de=>{Is.setAttendance(de.identity.studentId,"present")}),ce();const ae=tt(N).get(se.sessionNumber);Se(N.info.name,`جلسه ${ae} شروع شد.`,{type:"VIEW_SESSIONS"}),Ht(ee?"attendance":"selector")};_e("آیا تمایل به انجام فرآیند حضور و غیاب دارید؟",()=>U(!0),{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success",onCancel:()=>U(!1)})};N.hasSessionToday()?_e("شما امروز یک جلسه برای این کلاس ثبت کرده‌اید. آیا از شروع یک جلسه جدید دیگر مطمئن هستید؟",Z,{confirmText:"بله",confirmClass:"btn-warning"}):Z()}}),e.addEventListener("click",()=>{const B=i.value.trim(),Z=document.querySelector('input[name="class-type"]:checked');if(!B&&!Z){Y("⚠️لطفاً نام و نوع کلاس را مشخص کنید.");return}if(!B){Y("⚠️لطفاً نام کلاس را وارد کنید.");return}if(!Z){Y("⚠️لطفاً نوع کلاس را انتخاب کنید.");return}if(re[B]){re[B].isDeleted?Y("⚠️ کلاسی با این نام در سطل زباله است. ابتدا آن را بازیابی کنید و یا آن را پاک کنید."):Y("⚠️کلاسی با این نام از قبل وجود دارد.");return}const U=Z.value,ee=new rs({name:B,type:U});re[B]=ee,ce(),Se(B,`کلاس «${B}» ایجاد شد.`,{type:"VIEW_SESSIONS"}),je(),Y(`✅ کلاس «${B}» با موفقیت ایجاد شد.`),i.value="",Z.checked=!1}),n.addEventListener("input",B=>{const Z=B.target.value;if(Z.length<2){Sn([]);return}const U=Z.toLowerCase(),ee=ss(U),se=[];for(const me in re){const ae=re[me];if(ae.isDeleted)continue;const de=et(me.toLowerCase()),we=de.includes(et(U)),xe=de.includes(et(ee));(we||xe)&&se.push({type:"classroom",classroom:ae})}for(const me in re){const ae=re[me];if(ae.isDeleted)continue;ke(ae.students).filter(we=>{const xe=et(we.identity.name.toLowerCase()),Re=xe.includes(et(U)),Ut=xe.includes(et(ee));return Re||Ut}).forEach(we=>{se.push({type:"student",student:we,classroom:ae})})}Sn(se)}),i.addEventListener("keyup",B=>{B.key==="Enter"&&e.click()}),c.addEventListener("click",aa),S.addEventListener("click",()=>{rn("selector")}),O.addEventListener("input",B=>{const Z=B.target.value;if(!Z){Jt([]);return}const U=Z.toLowerCase(),ee=ss(U),me=ke(N.students).filter(ae=>{const de=et(ae.identity.name.toLowerCase()),we=de.includes(et(U)),xe=de.includes(et(ee));return we||xe});Jt(me)}),O.addEventListener("focus",()=>{O.value&&Jt(O.value)}),It.addEventListener("click",()=>{const B=dt.value,Z=st.value.trim();let U;if(Dn)U=Dn.student;else{const se=J==null?void 0:J.winnerHistory[Ze];U=se==null?void 0:se.winner}if(!U){Y("❌خطا: دانش‌آموز معتبری برای ثبت نمره یافت نشد.");return}const ee=Ve;if(!U||!ee){Y("⚠️لطفاً ابتدا یک دانش‌آموز و یک دسته‌بندی را انتخاب کنید.");return}if(!B){Y("⚠️لطفاً مقدار نمره را وارد کنید.");return}if(B>100||B<0){Y("❌نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}U&&(U.addScore(ee.name,parseFloat(B),Z),Se(N.info.name,`نمره ${B} در ${ee.name} برای «${U.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:U.identity.studentId}),ce(),$e(),Y(`✅نمره برای ${U.identity.name} در مهارت ${ee.name} ثبت شد.`),dt.value="",st.value="",ze())});const K=B=>{B.key==="Enter"&&B.ctrlKey&&(B.preventDefault(),It.click())};dt.addEventListener("keydown",K),st.addEventListener("keydown",K),ne.addEventListener("click",()=>{ve()}),F.addEventListener("click",()=>{const B=fe.value.trim(),Z=As;if(typeof Z=="function"){const U=Z(B);if(U===!1)return;ve(()=>{typeof U=="function"&&U()})}else ve()});const le=document.getElementById("move-student-confirm-btn"),Le=document.getElementById("move-student-cancel-btn"),ye=document.getElementById("move-student-class-select");Le.addEventListener("click",()=>{ve()}),le.addEventListener("click",()=>{const B=ye.value,Z=re[B],{studentToMove:U,sourceClassForMove:ee}=La;if(!U||!ee||!Z){Y("خطایی رخ داد. لطفاً دوباره امتحان کنید⚠️.","error"),ve();return}const se=wi(U,ee,Z);se.success?(Se(ee.info.name,`دانش‌آموز «${U.identity.name}» به کلاس «${B}» منتقل شد.`,{type:"VIEW_SESSIONS"}),Se(B,`دانش‌آموز «${U.identity.name}» از کلاس «${ee.info.name}» به این کلاس منتقل شد.`,{type:"VIEW_SESSIONS"}),ce(),ft(),$e(),at(),Y(`دانش‌آموز «${U.identity.name}» با موفقیت به کلاس «${B}» منتقل شد✅.`)):Y(se.message,"error"),ve()}),L.addEventListener("click",()=>{D.style.width="300px",P.classList.add("modal-visible")}),L.addEventListener("click",()=>{D.style.width="300px",P.classList.add("modal-visible")});const qe=document.getElementById("header-settings-btn");qe&&qe.addEventListener("click",()=>{N&&Lt(N)}),R.addEventListener("click",be),R.addEventListener("click",be),P.addEventListener("click",be),Ye.addEventListener("click",()=>{cn(),ge("trash-page"),be()});const mt=document.getElementById("restore-points-nav-btn");mt&&mt.addEventListener("click",()=>{ga(),ge("restore-points-page"),be()}),document.getElementById("demo-mode-btn").addEventListener("click",()=>{lt?wt():(be(),_e("شما در حال ورود به حالت نمایش (Demo) هستید. در این حالت، هیچ‌کدام از تغییرات شما ذخیره نخواهد شد. آیا ادامه می‌دهید؟",()=>{xi(),In(),be()},{confirmText:"تایید",confirmClass:"btn-warning",onCancel:be}))});const ht=document.getElementById("exit-demo-btn");ht&&ht.addEventListener("click",()=>{lt&&wt()}),Q.addEventListener("click",()=>{if(lt){Y("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است."),be();return}be(),on()}),k.addEventListener("click",()=>{if(lt){Y("⚠️ بازیابی اطلاعات در حالت نمایش (Demo) غیرفعال است."),be();return}z.click(),be()}),z.addEventListener("change",B=>{const Z=B.target.files[0];if(!Z)return;const U=new FileReader;U.onload=async ee=>{const se=ee.target.result;try{const me=JSON.parse(se);if(me.metadata&&me.data)Un(me);else{const ae=me.classrooms||me,de=me.trashBin||[];_e("آیا از بازیابی اطلاعات مطمئن هستید؟ تمام داده‌های فعلی شما بازنویسی خواهد شد.",()=>{Bt(ae),$s(de),gt({lastRestoreTimestamp:new Date().toISOString()}),ce(),je(),ge("class-management-page"),Y("✅اطلاعات با موفقیت بازیابی شد.")},{confirmText:"بازیابی کن",confirmClass:"btn-warning"})}}catch{try{const we=(await new Ss().loadAsync(se,{base64:!0})).file("backup.json");if(!we)throw new Error("فایل backup.json در فایل پشتیبان یافت نشد.");const xe=await we.async("string"),Re=JSON.parse(xe);if(Re.metadata&&Re.metadata.version==="2.0-b64")Un(Re);else throw new Error("فایل پشتیبان معتبر نیست (نسخه نامشخص).")}catch(ae){Y("❌خطا در خواندن فایل. لطفاً فایل پشتیبان معتبر انتخاب کنید."),console.error("Restore error (zip/base64):",ae)}}},U.readAsText(Z),B.target.value=null}),window.addEventListener("popstate",B=>{if(vt){ve(null,!0);return}if(St(),B.state){const{pageId:Z,currentClassName:U,selectedSessionNumber:ee,selectedStudentId:se}=B.state;U&&(We(re[U]),ee&&Ge(N.getSession(ee)),se&&Je(N.students.find(me=>me.identity.studentId===se))),Z==="session-page"?(Ue(),en(Z)):Z==="student-profile-page"?(Ue(),ge("session-page"),Pe(Ie)):en(Z)}else We(null),Ge(null),Je(null),en("class-management-page")}),document.addEventListener("keydown",B=>{var ee;const Z=document.activeElement;if(!["INPUT","TEXTAREA","SELECT"].includes(Z.tagName)){if(B.key.toLowerCase()==="o"&&B.shiftKey&&Ui.classList.contains("active")&&(B.preventDefault(),Gi.click()),B.key==="Escape"){if(xt.classList.contains("visible")){St();return}if(vt){ve();return}switch((ee=document.querySelector(".page.active"))==null?void 0:ee.id){case"csv-preview-page":case"column-mapping-page":ge("settings-page");break;case"student-profile-page":Je(null),ge(J?"student-page":"session-page");break;case"attendance-page":ge("student-page");break;case"student-page":Ge(null),Ue(),ge("session-page");break;case"settings-page":case"session-page":We(null),ge("class-management-page");break}return}if(J){const se=B.key.toLowerCase();switch(" ascfg".includes(se)&&B.preventDefault(),se){case" ":C.click();break;case"a":_.classList.contains("active")?history.back():(at(),ge("attendance-page"));break;case"s":document.getElementById("session-page").classList.contains("active")&&history.back();break;case"c":document.querySelector(".back-to-classes-btn").click();break;case"f":const me=document.querySelector(".action-column .search-icon");me&&me.click();break;case"g":if(studentProfilePage.classList.contains("active"))history.back();else{const ae=J.lastSelectedWinnerId;if(ae){const de=N.students.find(we=>we.identity.studentId===ae);de&&(Je(de),(void 0)(),ge("student-profile-page"))}else Y("⚠️ابتدا یک نفر را انتخاب کنید تا پروفایل او نمایش داده شود.")}break;case"arrowleft":{const ae=document.querySelector('button[title="برنده قبلی"]');ae&&!ae.disabled&&(B.preventDefault(),ae.click());break}case"arrowright":{const ae=document.querySelector('button[title="برنده بعدی"]');ae&&!ae.disabled&&(B.preventDefault(),ae.click());break}}}}});function be(){D.style.width="0",P.classList.add("modal-closing"),setTimeout(()=>{P.classList.remove("modal-visible","modal-closing")},300)}function wt(){_e("آیا از خروج از حالت نمایش (Demo) مطمئن هستید؟ با خروج، تمام تغییرات آزمایشی شما حذف شده و داده‌های اصلی شما بازیابی خواهند شد.",()=>{Li(),We(null),Ge(null),Je(null),je(),ge("class-management-page"),In(),be()},{confirmText:"خروج",confirmClass:"btn-success"})}d(".global-search-container .animated-search-container",Sn),d(".action-column-header .animated-search-container",Jt),lo(),[Ee,Yi,st,Zi].forEach(B=>{B&&la(B)});function Qe(B,Z){const U=ke(Z.students).filter(Be=>Be.identity.studentId!==B.identity.studentId);if(U.length===0)return;const ee=U.reduce((Be,He)=>He.statusCounters.totalSelections>Be.statusCounters.totalSelections?He:Be,U[0]);if(!ee||ee.statusCounters.totalSelections===0)return;B.categoryCounts=JSON.parse(JSON.stringify(ee.categoryCounts)),B.statusCounters.totalSelections=ee.statusCounters.totalSelections;const se=U.reduce((Be,He)=>Be+He.statusCounters.totalSelections,0),me=U.reduce((Be,He)=>Be+(He.statusCounters.missedChances||0),0),ae=se>0?me/se:0;B.statusCounters.missedChances=Math.round(B.statusCounters.totalSelections*ae);const de=ke(Z.categories),we={};de.forEach(Be=>{const He=U.reduce((ts,ns)=>ts+(ns.categoryCounts[Be.name]||0),0),es=U.reduce((ts,ns)=>ts+(ns.categoryIssues[Be.name]||0),0);we[Be.name]=He>0?es/He:0}),de.forEach(Be=>{const He=B.categoryCounts[Be.name]||0,es=we[Be.name]||0;B.categoryIssues[Be.name]=Math.round(He*es)});const xe=Z.liveSession;xe?B.onboardingSession=xe.sessionNumber:B.onboardingSession=Z.sessions.length+1;const Re=ke(Z.sessions).filter(Be=>Be.isFinished&&!Be.isCancelled),Ut="📝 یادداشت خودکار سیستم",Ca=`این دانش‌آموز  از جلسه شماره ${Re.length} به کلاس اضافه شد. آمار مشارکت او بر اساس فعال‌ترین دانش‌آموز و آمار «فرصت از دست رفته» او بر اساس میانگین کلاس ثبت گردید:`,Dt=[];B.statusCounters.totalSelections>0&&Dt.push(`کل انتخاب‌ها: ${B.statusCounters.totalSelections}`),B.statusCounters.missedChances>0&&Dt.push(`فرصت‌های از دست رفته: ${B.statusCounters.missedChances}`);for(const Be in B.categoryCounts){const He=B.categoryCounts[Be];He>0&&Dt.push(`انتخاب در «${Be}»: ${He}`)}for(const Be in B.categoryIssues){const He=B.categoryIssues[Be];He>0&&Dt.push(`مشکل در «${Be}»: ${He}`)}if(Dt.length>0){const Be=`${Ut}
${Ca}

- ${Dt.join(`
- `)}`;B.addNote(Be)}}function Wt(B){const U=`چون این کلاس جلسات برگزار شده دارد، برای ${B>1?"دانش‌آموزان جدید":"دانش‌آموز جدید"} آمار پایه‌ای (متناسب با سایر دانش‌آموزان) ثبت شد تا در فرایند انتخاب اختلالی ایجاد نشود.`;_e(U,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}const Kn="16.2.0",Yn="786";{const B=` (ساخت ${Yn})`;document.getElementById("app-version").textContent=`نسخه ${Kn}${B}`}function Xn(){console.log("Starting universal backfill for writing scores...");let B=0;for(const Z in re){const U=re[Z];if(U.isDeleted)continue;let ee=0;ke(U.students).forEach(me=>{const ae=me.logs.scores;if(!(ae&&ae.writing&&ae.writing.length>0)){let we=-1;for(const xe in ae)xe!=="writing"&&ae[xe].forEach(Re=>{Re.value>we&&(we=Re.value)});if(we>-1){const xe=`Automatically assigned based on the highest score (${we}) from other skills.`;me.addScore("Writing",we,xe),ee++}}}),ee>0&&(console.log(`Updated ${ee} student(s) in class: ${U.info.name}.`),B+=ee)}B>0?(ce(),console.log(`Update complete. A total of ${B} student(s) were updated across all classes. Data saved.`),document.getElementById("student-page").classList.contains("active")&&$e()):console.log("No students needed updating in any class.")}window.backfillWritingScoresForAll=Xn;function fn(){console.log("Starting backfill for 'outOfClassCount' and 'wasOutOfClass' properties...");let B=0,Z=0;const U=localStorage.getItem("teacherAssistantData_v2");if(!U){console.log("No data found in localStorage. Nothing to do.");return}const ee=JSON.parse(U);for(const se in ee){const me=ee[se];me.students&&me.students.forEach(ae=>{ae.statusCounters&&typeof ae.statusCounters.outOfClassCount>"u"&&(ae.statusCounters.outOfClassCount=0,B++)}),me.sessions&&me.sessions.forEach(ae=>{if(ae.studentRecords)for(const de in ae.studentRecords){const we=ae.studentRecords[de];typeof we.wasOutOfClass>"u"&&(we.wasOutOfClass=!1,Z++)}})}localStorage.setItem("teacherAssistantData_v2",JSON.stringify(ee)),console.log(`Backfill complete. Updated ${B} students and ${Z} session records. Data saved.`),On(),N&&$e()}window.backfillExitCounters=fn;function Et(){console.log("🧹 Starting orphaned data cleanup...");let B=0;for(const Z in re){const U=re[Z];if(U.isDeleted)continue;let ee=!1;const se=new Set(U.students.filter(de=>!de.isDeleted).map(de=>de.identity.studentId)),me=new Map(U.students.map(de=>[de.identity.studentId,de.identity.name])),ae=[];U.sessions.forEach(de=>{if(de.isDeleted)return;const we=[];for(const xe in de.studentRecords)if(!se.has(xe)){const Re=me.get(xe)||"Unknown/Deleted";we.push(`  - Removed student record for: ${Re} (ID: ${xe})`),delete de.studentRecords[xe],B++,ee=!0}for(const xe in de.lastWinnerByCategory){const Re=de.lastWinnerByCategory[xe];if(!se.has(Re)){const Ut=me.get(Re)||"Unknown/Deleted";we.push(`  - Removed '${xe}' last winner: ${Ut} (ID: ${Re})`),delete de.lastWinnerByCategory[xe],B++,ee=!0}}if(de.lastSelectedWinnerId&&!se.has(de.lastSelectedWinnerId)){const xe=de.lastSelectedWinnerId,Re=me.get(xe)||"Unknown/Deleted";we.push(`  - Cleared 'lastSelectedWinnerId': ${Re} (ID: ${xe})`),de.lastSelectedWinnerId=null,B++,ee=!0}if(we.length>0){const Re=tt(U).get(de.sessionNumber)||`(#${de.sessionNumber})`;ae.push({sessionDisplayNumber:Re,logs:we})}}),ee&&(console.group(`➡️ Class: ${Z}`),ae.forEach(de=>{console.groupCollapsed(`  Session ${de.sessionDisplayNumber}`),de.logs.forEach(we=>console.warn(we)),console.groupEnd()}),console.groupEnd())}B>0?(ce(),console.log(`✅ Cleanup complete! Found and removed ${B} orphaned references. Data saved.`)):console.log("✅ No orphaned data found. Your data is clean!")}window.cleanupOrphanedData=Et;function Nt(B){if(!B||!B.classroomName)return;const Z=re[B.classroomName];if(!Z){Y("⚠️ کلاس مربوط به این گزارش یافت نشد.");return}We(Z),ve(),setTimeout(()=>{switch(B.type){case"VIEW_STUDENT_PROFILE":{const U=Z.students.find(ee=>ee.identity.studentId===B.studentId);U?Pe(U):Y("⚠️ دانش‌آموز مورد نظر یافت نشد.");break}case"VIEW_TRASH":cn(),ge("trash-page");break;case"VIEW_SESSIONS":Ue(),ge("session-page");break;case"VIEW_CLASS_NOTE":Vn(Z);break;case"VIEW_CLASS_SETTINGS":Lt(Z);break}},300)}Ne.addEventListener("click",()=>{Js()}),Oe.addEventListener("click",()=>{ve()}),he.addEventListener("click",()=>{const B=Ce.value.trim(),Z=Te.checked;if(!B){qs.style.display==="flex"?_e("کادر یادداشت خالی است. آیا مطمئنید که می‌خواهید یادداشت‌های قبلی دانش‌آموزان انتخاب‌شده را پاک کنید؟",()=>{ve(),Cs("",!1)},{confirmText:"پاک کردن",confirmClass:"btn-warning"}):Y("⚠️ لطفاً متن یادداشت را وارد کنید.");return}ve(()=>{Cs(B,Z)})});const _t=document.getElementById("screen-saver-overlay");let Qn;const ya=2*60*1e3,Xs=["mousemove","keypress","scroll","click","touchstart"];function ba(){_t.classList.add("visible")}function Qs(){_t.classList.contains("visible")&&_t.classList.remove("visible")}function mn(){Qs(),clearTimeout(Qn),Qn=setTimeout(ba,ya)}function hn(B){B.preventDefault(),B.stopPropagation(),setTimeout(mn,0)}function ei(){mn(),Xs.forEach(Z=>window.addEventListener(Z,mn)),_t.addEventListener("click",hn),_t.addEventListener("touchstart",hn);const B="16.2.0";{const Z=document.getElementById("screen-saver-version");Z&&(Z.textContent=`v${B}`)}}function va(){clearTimeout(Qn),Qs(),Xs.forEach(B=>window.removeEventListener(B,mn)),_t.removeEventListener("click",hn),_t.removeEventListener("touchstart",hn)}document.getElementById("app-settings-modal");const ti=document.getElementById("app-settings-nav-btn"),ni=document.getElementById("close-settings-btn"),si=document.getElementById("setting-sound-toggle"),ii=document.getElementById("setting-vibration-toggle"),ai=document.getElementById("setting-screensaver-toggle");ti&&ti.addEventListener("click",()=>{be(),si.checked=Fe.isSoundEnabled,ii.checked=Fe.isVibrationEnabled,ai.checked=Fe.isScreenSaverEnabled,Me("app-settings-modal")}),ni&&ni.addEventListener("click",()=>{ve()}),si.addEventListener("change",B=>{gt({isSoundEnabled:B.target.checked}),B.target.checked&&ri()}),ii.addEventListener("change",B=>{gt({isVibrationEnabled:B.target.checked}),B.target.checked&&navigator.vibrate&&navigator.vibrate(50)}),Fe.isScreenSaverEnabled&&ei(),ai.addEventListener("change",B=>{B.target.checked?(gt({isScreenSaverEnabled:!0}),ei()):(gt({isScreenSaverEnabled:!1}),va())})});function co(n,i){if(!J||J.isFinished){Y("⚠️ امکان لغو انتخاب در جلسه خاتمه یافته وجود ندارد.");return}const e=J.winnerHistory;if(!(Ze===e.length-1)||e.length===0){Y("⚠️ فقط آخرین انتخاب قابل لغو است.");return}if(e[e.length-1].winner.identity.studentId!==n.identity.studentId){console.error("Undo mismatch!");return}_e(`آیا از حذف انتخاب «${n.identity.name}» برای «${i}» مطمئن هستید؟ آمار این انتخاب بازگردانی خواهد شد.`,()=>{const o=J.winnerHistory,t=o.pop();if(!t)return;const a=t.winner,s=t.categoryName,r=a.identity.studentId;a.statusCounters.totalSelections=Math.max(0,a.statusCounters.totalSelections-1),a.categoryCounts[s]&&(a.categoryCounts[s]=Math.max(0,a.categoryCounts[s]-1));const l=J.studentRecords[r];l&&l.selections[s]&&(l.selections[s]=Math.max(0,l.selections[s]-1));let h=null;for(let p=o.length-1;p>=0;p--)if(o[p].categoryName===s){h=o[p].winner.identity.studentId;break}h?J.lastWinnerByCategory[s]=h:delete J.lastWinnerByCategory[s],Ct(o.length-1),$e(),ze(),ce(),Y(`✅ انتخاب «${a.identity.name}» لغو شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}function lo(){const n=document.getElementById("session-dashboard-page"),i=document.getElementById("student-stats-table-container");if(!n)return;let e=0,c=0;n.addEventListener("touchstart",t=>{if(i&&i.contains(t.target)){const a=t.target.closest("td, th");a&&a.parentElement.firstElementChild===a?e=t.changedTouches[0].screenX:e=0}else e=t.changedTouches[0].screenX},{passive:!0}),n.addEventListener("touchend",t=>{e!==0&&(c=t.changedTouches[0].screenX,o())});function o(){const a=e-c;Math.abs(a)>150&&(document.getElementById("selector-tab-btn").classList.contains("active")?(ge("session-dashboard-page",{tab:"attendance"}),rn("attendance")):(ge("session-dashboard-page",{tab:"selector"}),rn("selector"))),e=0,c=0}}
