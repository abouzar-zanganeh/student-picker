(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))c(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&c(i)}).observe(document,{childList:!0,subtree:!0});function e(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function c(o){if(o.ep)return;o.ep=!0;const n=e(o);fetch(o.href,n)}})();class yn{constructor(a){this.identity={name:a.name,firstName:a.firstName||null,lastName:a.lastName||null,studentId:a.studentId||`id_${new Date().getTime()}_${Math.random()}`,branchName:a.branchName||null,ageGroup:a.ageGroup||"adult",level:a.level||null,contact:{social:a.socialContact||null,parent:a.parentContact||null}},this.isDeleted=!1,this.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0,outOfClassCount:0},this.categoryCounts={},this.categoryIssues={},this.logs={parentContacts:[],scores:{},discipline:{},sessionHistory:{}},this.profile={notes:[],tags:[]},this.finalClassActivityScore=null,this.onboardingSession=null}addScore(a,e,c){if(e>100||e<0){console.log("نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}const o=a.toLowerCase();this.logs.scores[o]||(this.logs.scores[o]=[]);const n=new pa(a,e,c);this.logs.scores[o].push(n)}addNote(a,e=null){const c=new ga(a,e);this.profile.notes.push(c)}getOverallAverageScore(){let a=0,e=0;for(const o in this.logs.scores)this.logs.scores[o].forEach(n=>{n.isDeleted||(a+=n.value,e++)});if(e===0)return null;const c=a/e;return Math.round(c*100)/100}}class pa{constructor(a,e,c=""){this.id=`score_${new Date().getTime()}`,this.skill=a,this.value=e,this.timestamp=new Date,this.comment=c,this.isDeleted=!1}}class ga{constructor(a,e=null){this.id=`note_${new Date().getTime()}`,this.timestamp=new Date,this.content=a,this.isDeleted=!1,this.source=e}}class is{constructor(a="complete",e=""){this.status=a,this.comment=e,this.timestamp=new Date}}class ii{constructor(a){this.sessionNumber=a,this.startTime=new Date,this.createdAt=new Date,this.note="",this.isDeleted=!1,this.endTime=null,this.isFinished=!1,this.isMakeup=!1,this.isCancelled=!1,this.studentRecords={},this.lastWinnerByCategory={},this.lastUsedCategoryId=null,this.lastSelectedWinnerId=null,this.winnerHistory=[]}end(){this.isFinished=!0,this.endTime=new Date}markAsMakeup(){this.isMakeup=!this.isMakeup}initializeStudentRecord(a){this.studentRecords[a]||(this.studentRecords[a]={attendance:"present",homework:new is,selections:{},hadIssue:!1,wasOutOfClass:!1})}setAttendance(a,e){this.initializeStudentRecord(a),this.studentRecords[a].attendance=e}setHomeworkStatus(a,e){this.initializeStudentRecord(a),this.studentRecords[a].homework.status=e}selectNextWinner(a,e,c){if(!e||e.length===0)return console.log("هیچ دانش‌آموزی در کلاس برای انتخاب وجود ندارد."),null;const o=this.lastWinnerByCategory[a];let n=e.filter(f=>f.identity.studentId!==o&&!f.isDeleted);if(n.length===0&&(n=e),n.length===0)return null;const i=(f,u)=>f.categoryCounts[u]||0,s=Math.min(...n.map(f=>i(f,a))),r=n.filter(f=>i(f,a)===s);let l;if(r.length===1)l=r[0];else if(r.length>1){const f=c.filter(v=>!v.isDeleted&&v.name!==a).map(v=>v.name),u=r.map(v=>{const b=f.reduce((C,_)=>C+i(v,_),0);return{student:v,otherCategoriesTotal:b}}),y=Math.min(...u.map(v=>v.otherCategoriesTotal)),m=u.filter(v=>v.otherCategoriesTotal===y).map(v=>v.student);m.length===1?l=m[0]:l=m[Math.floor(Math.random()*m.length)]}else l=n[Math.floor(Math.random()*n.length)];const h=l.identity.studentId;this.initializeStudentRecord(h);const p=(this.studentRecords[h].selections[a]||0)+1;return this.studentRecords[h].selections[a]=p,l.statusCounters.totalSelections++,l.categoryCounts[a]=(l.categoryCounts[a]||0)+1,this.lastWinnerByCategory[a]=h,l}}class as{constructor(a){this.info={name:a.name||"NotNamed",teacherName:a.teacherName||null,type:a.type||"in-person",term:a.term||null,scheduleText:a.scheduleText||null,level:a.level||null,creationDate:a.creationDate?new Date(a.creationDate):new Date,scheduleCode:a.scheduleCode||`code_${new Date().getTime()}`,scheduleDays:a.scheduleDays||[],scheduleStartTime:a.scheduleStartTime||null,scheduleEndTime:a.scheduleEndTime||null},this.students=[],this.sessions=[],this.note="",this.isDeleted=!1,this.categories=[new ft("Vocabulary","Questions about words and meanings."),new ft("Grammar","Questions about sentence structure and rules."),new ft("Listening",void 0,!0),new ft("Speaking",void 0,!0),new ft("Reading",void 0,!0),new ft("Writing",void 0,!0)],this.futurePlans={}}addStudent(a){this.students.push(a)}removeStudent(a){this.students=this.students.filter(e=>e.identity.studentId!==a)}startNewSession(){const a=this.sessions.length+1,e=new ii(a);return this.sessions.push(e),e}endSpecificSession(a){const e=this.getSession(a);return e&&!e.isFinished?(e.end(),!0):!1}getSession(a){return this.sessions.find(e=>e.sessionNumber===a)}markAsMakeup(a){const e=this.getSession(a);e&&e.markAsMakeup()}planForSession(a,e){this.futurePlans[a]=e}hasSessionToday(){const a=new Date().toDateString();return this.sessions.some(e=>!e.isDeleted&&e.startTime.toDateString()===a)}selectNextWinner(a,e){return e?e.selectNextWinner(a,this.students,this.categories):null}get liveSession(){for(let a=this.sessions.length-1;a>=0;a--)if(!this.sessions[a].isFinished)return this.sessions[a];return null}endLiveSession(){const a=this.liveSession;return a?(a.end(),!0):!1}calculateFinalStudentScore(a){const e=a.logs.scores,c=["reading","writing"];for(const f of c)if(!e[f]||e[f].length===0)return null;const o=e.listening&&e.listening.length>0,n=e.speaking&&e.speaking.length>0;if(!o&&!n)return null;const i=f=>e[f].reduce((y,m)=>y+m.value,0)/e[f].length;let s;o&&n?s=(i("listening")+i("speaking"))/2:o?s=i("listening"):s=i("speaking");const r=i("reading"),l=i("writing"),p=(s*3+r*2+l*1)/6;return Math.trunc(p*10)/10}assignAllFinalScores(){let a=0,e=[];console.log("شروع عملیات محاسبه نمره نهایی برای تمام دانش‌آموزان..."),this.students.forEach(o=>{const n=this.calculateFinalStudentScore(o);n!==null?(o.finalClassActivityScore=n,a++):(o.finalClassActivityScore=null,e.push(o.identity.name))});const c=e.length;console.log(`عملیات پایان یافت. تعداد نمرات موفق: ${a} | تعداد ناموفق (نمرات ناقص): ${c}`),c>0&&(console.log("اسامی دانش‌آموزانی که نمراتشان ناقص است:"),e.forEach(o=>console.log(`- ${o}`)))}}class ft{constructor(a,e="",c=!1){this.id=`cat_${new Date().getTime()}_${Math.random()}`,this.name=a,this.description=e,this.isDeleted=!1,this.isGradedCategory=c,this.isDeleted=!1}}var pn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ai(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function gn(t){throw new Error('Could not dynamically require "'+t+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var ri={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/(function(t,a){(function(e){t.exports=e()})(function(){return function e(c,o,n){function i(l,h){if(!o[l]){if(!c[l]){var p=typeof gn=="function"&&gn;if(!h&&p)return p(l,!0);if(s)return s(l,!0);var f=new Error("Cannot find module '"+l+"'");throw f.code="MODULE_NOT_FOUND",f}var u=o[l]={exports:{}};c[l][0].call(u.exports,function(y){var m=c[l][1][y];return i(m||y)},u,u.exports,e,c,o,n)}return o[l].exports}for(var s=typeof gn=="function"&&gn,r=0;r<n.length;r++)i(n[r]);return i}({1:[function(e,c,o){var n=e("./utils"),i=e("./support"),s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";o.encode=function(r){for(var l,h,p,f,u,y,m,v=[],b=0,C=r.length,_=C,S=n.getTypeOf(r)!=="string";b<r.length;)_=C-b,p=S?(l=r[b++],h=b<C?r[b++]:0,b<C?r[b++]:0):(l=r.charCodeAt(b++),h=b<C?r.charCodeAt(b++):0,b<C?r.charCodeAt(b++):0),f=l>>2,u=(3&l)<<4|h>>4,y=1<_?(15&h)<<2|p>>6:64,m=2<_?63&p:64,v.push(s.charAt(f)+s.charAt(u)+s.charAt(y)+s.charAt(m));return v.join("")},o.decode=function(r){var l,h,p,f,u,y,m=0,v=0,b="data:";if(r.substr(0,b.length)===b)throw new Error("Invalid base64 input, it looks like a data url.");var C,_=3*(r=r.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(r.charAt(r.length-1)===s.charAt(64)&&_--,r.charAt(r.length-2)===s.charAt(64)&&_--,_%1!=0)throw new Error("Invalid base64 input, bad content length.");for(C=i.uint8array?new Uint8Array(0|_):new Array(0|_);m<r.length;)l=s.indexOf(r.charAt(m++))<<2|(f=s.indexOf(r.charAt(m++)))>>4,h=(15&f)<<4|(u=s.indexOf(r.charAt(m++)))>>2,p=(3&u)<<6|(y=s.indexOf(r.charAt(m++))),C[v++]=l,u!==64&&(C[v++]=h),y!==64&&(C[v++]=p);return C}},{"./support":30,"./utils":32}],2:[function(e,c,o){var n=e("./external"),i=e("./stream/DataWorker"),s=e("./stream/Crc32Probe"),r=e("./stream/DataLengthProbe");function l(h,p,f,u,y){this.compressedSize=h,this.uncompressedSize=p,this.crc32=f,this.compression=u,this.compressedContent=y}l.prototype={getContentWorker:function(){var h=new i(n.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new r("data_length")),p=this;return h.on("end",function(){if(this.streamInfo.data_length!==p.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),h},getCompressedWorker:function(){return new i(n.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},l.createWorkerFrom=function(h,p,f){return h.pipe(new s).pipe(new r("uncompressedSize")).pipe(p.compressWorker(f)).pipe(new r("compressedSize")).withStreamInfo("compression",p)},c.exports=l},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,c,o){var n=e("./stream/GenericWorker");o.STORE={magic:"\0\0",compressWorker:function(){return new n("STORE compression")},uncompressWorker:function(){return new n("STORE decompression")}},o.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,c,o){var n=e("./utils"),i=function(){for(var s,r=[],l=0;l<256;l++){s=l;for(var h=0;h<8;h++)s=1&s?3988292384^s>>>1:s>>>1;r[l]=s}return r}();c.exports=function(s,r){return s!==void 0&&s.length?n.getTypeOf(s)!=="string"?function(l,h,p,f){var u=i,y=f+p;l^=-1;for(var m=f;m<y;m++)l=l>>>8^u[255&(l^h[m])];return-1^l}(0|r,s,s.length,0):function(l,h,p,f){var u=i,y=f+p;l^=-1;for(var m=f;m<y;m++)l=l>>>8^u[255&(l^h.charCodeAt(m))];return-1^l}(0|r,s,s.length,0):0}},{"./utils":32}],5:[function(e,c,o){o.base64=!1,o.binary=!1,o.dir=!1,o.createFolders=!0,o.date=null,o.compression=null,o.compressionOptions=null,o.comment=null,o.unixPermissions=null,o.dosPermissions=null},{}],6:[function(e,c,o){var n=null;n=typeof Promise<"u"?Promise:e("lie"),c.exports={Promise:n}},{lie:37}],7:[function(e,c,o){var n=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",i=e("pako"),s=e("./utils"),r=e("./stream/GenericWorker"),l=n?"uint8array":"array";function h(p,f){r.call(this,"FlateWorker/"+p),this._pako=null,this._pakoAction=p,this._pakoOptions=f,this.meta={}}o.magic="\b\0",s.inherits(h,r),h.prototype.processChunk=function(p){this.meta=p.meta,this._pako===null&&this._createPako(),this._pako.push(s.transformTo(l,p.data),!1)},h.prototype.flush=function(){r.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},h.prototype.cleanUp=function(){r.prototype.cleanUp.call(this),this._pako=null},h.prototype._createPako=function(){this._pako=new i[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var p=this;this._pako.onData=function(f){p.push({data:f,meta:p.meta})}},o.compressWorker=function(p){return new h("Deflate",p)},o.uncompressWorker=function(){return new h("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(e,c,o){function n(u,y){var m,v="";for(m=0;m<y;m++)v+=String.fromCharCode(255&u),u>>>=8;return v}function i(u,y,m,v,b,C){var _,S,I=u.file,x=u.compression,L=C!==l.utf8encode,D=s.transformTo("string",C(I.name)),R=s.transformTo("string",l.utf8encode(I.name)),P=I.comment,Q=s.transformTo("string",C(P)),k=s.transformTo("string",l.utf8encode(P)),z=R.length!==I.name.length,g=k.length!==P.length,H="",ue="",j="",fe=I.dir,F=I.date,ne={crc32:0,compressedSize:0,uncompressedSize:0};y&&!m||(ne.crc32=u.crc32,ne.compressedSize=u.compressedSize,ne.uncompressedSize=u.uncompressedSize);var O=0;y&&(O|=8),L||!z&&!g||(O|=2048);var M=0,oe=0;fe&&(M|=16),b==="UNIX"?(oe=798,M|=function(X,Ne){var Oe=X;return X||(Oe=Ne?16893:33204),(65535&Oe)<<16}(I.unixPermissions,fe)):(oe=20,M|=function(X){return 63&(X||0)}(I.dosPermissions)),_=F.getUTCHours(),_<<=6,_|=F.getUTCMinutes(),_<<=5,_|=F.getUTCSeconds()/2,S=F.getUTCFullYear()-1980,S<<=4,S|=F.getUTCMonth()+1,S<<=5,S|=F.getUTCDate(),z&&(ue=n(1,1)+n(h(D),4)+R,H+="up"+n(ue.length,2)+ue),g&&(j=n(1,1)+n(h(Q),4)+k,H+="uc"+n(j.length,2)+j);var te="";return te+=`
\0`,te+=n(O,2),te+=x.magic,te+=n(_,2),te+=n(S,2),te+=n(ne.crc32,4),te+=n(ne.compressedSize,4),te+=n(ne.uncompressedSize,4),te+=n(D.length,2),te+=n(H.length,2),{fileRecord:p.LOCAL_FILE_HEADER+te+D+H,dirRecord:p.CENTRAL_FILE_HEADER+n(oe,2)+te+n(Q.length,2)+"\0\0\0\0"+n(M,4)+n(v,4)+D+H+Q}}var s=e("../utils"),r=e("../stream/GenericWorker"),l=e("../utf8"),h=e("../crc32"),p=e("../signature");function f(u,y,m,v){r.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=y,this.zipPlatform=m,this.encodeFileName=v,this.streamFiles=u,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}s.inherits(f,r),f.prototype.push=function(u){var y=u.meta.percent||0,m=this.entriesCount,v=this._sources.length;this.accumulate?this.contentBuffer.push(u):(this.bytesWritten+=u.data.length,r.prototype.push.call(this,{data:u.data,meta:{currentFile:this.currentFile,percent:m?(y+100*(m-v-1))/m:100}}))},f.prototype.openedSource=function(u){this.currentSourceOffset=this.bytesWritten,this.currentFile=u.file.name;var y=this.streamFiles&&!u.file.dir;if(y){var m=i(u,y,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:m.fileRecord,meta:{percent:0}})}else this.accumulate=!0},f.prototype.closedSource=function(u){this.accumulate=!1;var y=this.streamFiles&&!u.file.dir,m=i(u,y,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(m.dirRecord),y)this.push({data:function(v){return p.DATA_DESCRIPTOR+n(v.crc32,4)+n(v.compressedSize,4)+n(v.uncompressedSize,4)}(u),meta:{percent:100}});else for(this.push({data:m.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},f.prototype.flush=function(){for(var u=this.bytesWritten,y=0;y<this.dirRecords.length;y++)this.push({data:this.dirRecords[y],meta:{percent:100}});var m=this.bytesWritten-u,v=function(b,C,_,S,I){var x=s.transformTo("string",I(S));return p.CENTRAL_DIRECTORY_END+"\0\0\0\0"+n(b,2)+n(b,2)+n(C,4)+n(_,4)+n(x.length,2)+x}(this.dirRecords.length,m,u,this.zipComment,this.encodeFileName);this.push({data:v,meta:{percent:100}})},f.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},f.prototype.registerPrevious=function(u){this._sources.push(u);var y=this;return u.on("data",function(m){y.processChunk(m)}),u.on("end",function(){y.closedSource(y.previous.streamInfo),y._sources.length?y.prepareNextSource():y.end()}),u.on("error",function(m){y.error(m)}),this},f.prototype.resume=function(){return!!r.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},f.prototype.error=function(u){var y=this._sources;if(!r.prototype.error.call(this,u))return!1;for(var m=0;m<y.length;m++)try{y[m].error(u)}catch{}return!0},f.prototype.lock=function(){r.prototype.lock.call(this);for(var u=this._sources,y=0;y<u.length;y++)u[y].lock()},c.exports=f},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,c,o){var n=e("../compressions"),i=e("./ZipFileWorker");o.generateWorker=function(s,r,l){var h=new i(r.streamFiles,l,r.platform,r.encodeFileName),p=0;try{s.forEach(function(f,u){p++;var y=function(C,_){var S=C||_,I=n[S];if(!I)throw new Error(S+" is not a valid compression method !");return I}(u.options.compression,r.compression),m=u.options.compressionOptions||r.compressionOptions||{},v=u.dir,b=u.date;u._compressWorker(y,m).withStreamInfo("file",{name:f,dir:v,date:b,comment:u.comment||"",unixPermissions:u.unixPermissions,dosPermissions:u.dosPermissions}).pipe(h)}),h.entriesCount=p}catch(f){h.error(f)}return h}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,c,o){function n(){if(!(this instanceof n))return new n;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var i=new n;for(var s in this)typeof this[s]!="function"&&(i[s]=this[s]);return i}}(n.prototype=e("./object")).loadAsync=e("./load"),n.support=e("./support"),n.defaults=e("./defaults"),n.version="3.10.1",n.loadAsync=function(i,s){return new n().loadAsync(i,s)},n.external=e("./external"),c.exports=n},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,c,o){var n=e("./utils"),i=e("./external"),s=e("./utf8"),r=e("./zipEntries"),l=e("./stream/Crc32Probe"),h=e("./nodejsUtils");function p(f){return new i.Promise(function(u,y){var m=f.decompressed.getContentWorker().pipe(new l);m.on("error",function(v){y(v)}).on("end",function(){m.streamInfo.crc32!==f.decompressed.crc32?y(new Error("Corrupted zip : CRC32 mismatch")):u()}).resume()})}c.exports=function(f,u){var y=this;return u=n.extend(u||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:s.utf8decode}),h.isNode&&h.isStream(f)?i.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):n.prepareContent("the loaded zip file",f,!0,u.optimizedBinaryString,u.base64).then(function(m){var v=new r(u);return v.load(m),v}).then(function(m){var v=[i.Promise.resolve(m)],b=m.files;if(u.checkCRC32)for(var C=0;C<b.length;C++)v.push(p(b[C]));return i.Promise.all(v)}).then(function(m){for(var v=m.shift(),b=v.files,C=0;C<b.length;C++){var _=b[C],S=_.fileNameStr,I=n.resolve(_.fileNameStr);y.file(I,_.decompressed,{binary:!0,optimizedBinaryString:!0,date:_.date,dir:_.dir,comment:_.fileCommentStr.length?_.fileCommentStr:null,unixPermissions:_.unixPermissions,dosPermissions:_.dosPermissions,createFolders:u.createFolders}),_.dir||(y.file(I).unsafeOriginalName=S)}return v.zipComment.length&&(y.comment=v.zipComment),y})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,c,o){var n=e("../utils"),i=e("../stream/GenericWorker");function s(r,l){i.call(this,"Nodejs stream input adapter for "+r),this._upstreamEnded=!1,this._bindStream(l)}n.inherits(s,i),s.prototype._bindStream=function(r){var l=this;(this._stream=r).pause(),r.on("data",function(h){l.push({data:h,meta:{percent:0}})}).on("error",function(h){l.isPaused?this.generatedError=h:l.error(h)}).on("end",function(){l.isPaused?l._upstreamEnded=!0:l.end()})},s.prototype.pause=function(){return!!i.prototype.pause.call(this)&&(this._stream.pause(),!0)},s.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},c.exports=s},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,c,o){var n=e("readable-stream").Readable;function i(s,r,l){n.call(this,r),this._helper=s;var h=this;s.on("data",function(p,f){h.push(p)||h._helper.pause(),l&&l(f)}).on("error",function(p){h.emit("error",p)}).on("end",function(){h.push(null)})}e("../utils").inherits(i,n),i.prototype._read=function(){this._helper.resume()},c.exports=i},{"../utils":32,"readable-stream":16}],14:[function(e,c,o){c.exports={isNode:typeof Buffer<"u",newBufferFrom:function(n,i){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(n,i);if(typeof n=="number")throw new Error('The "data" argument must not be a number');return new Buffer(n,i)},allocBuffer:function(n){if(Buffer.alloc)return Buffer.alloc(n);var i=new Buffer(n);return i.fill(0),i},isBuffer:function(n){return Buffer.isBuffer(n)},isStream:function(n){return n&&typeof n.on=="function"&&typeof n.pause=="function"&&typeof n.resume=="function"}}},{}],15:[function(e,c,o){function n(I,x,L){var D,R=s.getTypeOf(x),P=s.extend(L||{},h);P.date=P.date||new Date,P.compression!==null&&(P.compression=P.compression.toUpperCase()),typeof P.unixPermissions=="string"&&(P.unixPermissions=parseInt(P.unixPermissions,8)),P.unixPermissions&&16384&P.unixPermissions&&(P.dir=!0),P.dosPermissions&&16&P.dosPermissions&&(P.dir=!0),P.dir&&(I=b(I)),P.createFolders&&(D=v(I))&&C.call(this,D,!0);var Q=R==="string"&&P.binary===!1&&P.base64===!1;L&&L.binary!==void 0||(P.binary=!Q),(x instanceof p&&x.uncompressedSize===0||P.dir||!x||x.length===0)&&(P.base64=!1,P.binary=!0,x="",P.compression="STORE",R="string");var k=null;k=x instanceof p||x instanceof r?x:y.isNode&&y.isStream(x)?new m(I,x):s.prepareContent(I,x,P.binary,P.optimizedBinaryString,P.base64);var z=new f(I,k,P);this.files[I]=z}var i=e("./utf8"),s=e("./utils"),r=e("./stream/GenericWorker"),l=e("./stream/StreamHelper"),h=e("./defaults"),p=e("./compressedObject"),f=e("./zipObject"),u=e("./generate"),y=e("./nodejsUtils"),m=e("./nodejs/NodejsStreamInputAdapter"),v=function(I){I.slice(-1)==="/"&&(I=I.substring(0,I.length-1));var x=I.lastIndexOf("/");return 0<x?I.substring(0,x):""},b=function(I){return I.slice(-1)!=="/"&&(I+="/"),I},C=function(I,x){return x=x!==void 0?x:h.createFolders,I=b(I),this.files[I]||n.call(this,I,null,{dir:!0,createFolders:x}),this.files[I]};function _(I){return Object.prototype.toString.call(I)==="[object RegExp]"}var S={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(I){var x,L,D;for(x in this.files)D=this.files[x],(L=x.slice(this.root.length,x.length))&&x.slice(0,this.root.length)===this.root&&I(L,D)},filter:function(I){var x=[];return this.forEach(function(L,D){I(L,D)&&x.push(D)}),x},file:function(I,x,L){if(arguments.length!==1)return I=this.root+I,n.call(this,I,x,L),this;if(_(I)){var D=I;return this.filter(function(P,Q){return!Q.dir&&D.test(P)})}var R=this.files[this.root+I];return R&&!R.dir?R:null},folder:function(I){if(!I)return this;if(_(I))return this.filter(function(R,P){return P.dir&&I.test(R)});var x=this.root+I,L=C.call(this,x),D=this.clone();return D.root=L.name,D},remove:function(I){I=this.root+I;var x=this.files[I];if(x||(I.slice(-1)!=="/"&&(I+="/"),x=this.files[I]),x&&!x.dir)delete this.files[I];else for(var L=this.filter(function(R,P){return P.name.slice(0,I.length)===I}),D=0;D<L.length;D++)delete this.files[L[D].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(I){var x,L={};try{if((L=s.extend(I||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:i.utf8encode})).type=L.type.toLowerCase(),L.compression=L.compression.toUpperCase(),L.type==="binarystring"&&(L.type="string"),!L.type)throw new Error("No output type specified.");s.checkSupport(L.type),L.platform!=="darwin"&&L.platform!=="freebsd"&&L.platform!=="linux"&&L.platform!=="sunos"||(L.platform="UNIX"),L.platform==="win32"&&(L.platform="DOS");var D=L.comment||this.comment||"";x=u.generateWorker(this,L,D)}catch(R){(x=new r("error")).error(R)}return new l(x,L.type||"string",L.mimeType)},generateAsync:function(I,x){return this.generateInternalStream(I).accumulate(x)},generateNodeStream:function(I,x){return(I=I||{}).type||(I.type="nodebuffer"),this.generateInternalStream(I).toNodejsStream(x)}};c.exports=S},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,c,o){c.exports=e("stream")},{stream:void 0}],17:[function(e,c,o){var n=e("./DataReader");function i(s){n.call(this,s);for(var r=0;r<this.data.length;r++)s[r]=255&s[r]}e("../utils").inherits(i,n),i.prototype.byteAt=function(s){return this.data[this.zero+s]},i.prototype.lastIndexOfSignature=function(s){for(var r=s.charCodeAt(0),l=s.charCodeAt(1),h=s.charCodeAt(2),p=s.charCodeAt(3),f=this.length-4;0<=f;--f)if(this.data[f]===r&&this.data[f+1]===l&&this.data[f+2]===h&&this.data[f+3]===p)return f-this.zero;return-1},i.prototype.readAndCheckSignature=function(s){var r=s.charCodeAt(0),l=s.charCodeAt(1),h=s.charCodeAt(2),p=s.charCodeAt(3),f=this.readData(4);return r===f[0]&&l===f[1]&&h===f[2]&&p===f[3]},i.prototype.readData=function(s){if(this.checkOffset(s),s===0)return[];var r=this.data.slice(this.zero+this.index,this.zero+this.index+s);return this.index+=s,r},c.exports=i},{"../utils":32,"./DataReader":18}],18:[function(e,c,o){var n=e("../utils");function i(s){this.data=s,this.length=s.length,this.index=0,this.zero=0}i.prototype={checkOffset:function(s){this.checkIndex(this.index+s)},checkIndex:function(s){if(this.length<this.zero+s||s<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+s+"). Corrupted zip ?")},setIndex:function(s){this.checkIndex(s),this.index=s},skip:function(s){this.setIndex(this.index+s)},byteAt:function(){},readInt:function(s){var r,l=0;for(this.checkOffset(s),r=this.index+s-1;r>=this.index;r--)l=(l<<8)+this.byteAt(r);return this.index+=s,l},readString:function(s){return n.transformTo("string",this.readData(s))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var s=this.readInt(4);return new Date(Date.UTC(1980+(s>>25&127),(s>>21&15)-1,s>>16&31,s>>11&31,s>>5&63,(31&s)<<1))}},c.exports=i},{"../utils":32}],19:[function(e,c,o){var n=e("./Uint8ArrayReader");function i(s){n.call(this,s)}e("../utils").inherits(i,n),i.prototype.readData=function(s){this.checkOffset(s);var r=this.data.slice(this.zero+this.index,this.zero+this.index+s);return this.index+=s,r},c.exports=i},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,c,o){var n=e("./DataReader");function i(s){n.call(this,s)}e("../utils").inherits(i,n),i.prototype.byteAt=function(s){return this.data.charCodeAt(this.zero+s)},i.prototype.lastIndexOfSignature=function(s){return this.data.lastIndexOf(s)-this.zero},i.prototype.readAndCheckSignature=function(s){return s===this.readData(4)},i.prototype.readData=function(s){this.checkOffset(s);var r=this.data.slice(this.zero+this.index,this.zero+this.index+s);return this.index+=s,r},c.exports=i},{"../utils":32,"./DataReader":18}],21:[function(e,c,o){var n=e("./ArrayReader");function i(s){n.call(this,s)}e("../utils").inherits(i,n),i.prototype.readData=function(s){if(this.checkOffset(s),s===0)return new Uint8Array(0);var r=this.data.subarray(this.zero+this.index,this.zero+this.index+s);return this.index+=s,r},c.exports=i},{"../utils":32,"./ArrayReader":17}],22:[function(e,c,o){var n=e("../utils"),i=e("../support"),s=e("./ArrayReader"),r=e("./StringReader"),l=e("./NodeBufferReader"),h=e("./Uint8ArrayReader");c.exports=function(p){var f=n.getTypeOf(p);return n.checkSupport(f),f!=="string"||i.uint8array?f==="nodebuffer"?new l(p):i.uint8array?new h(n.transformTo("uint8array",p)):new s(n.transformTo("array",p)):new r(p)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,c,o){o.LOCAL_FILE_HEADER="PK",o.CENTRAL_FILE_HEADER="PK",o.CENTRAL_DIRECTORY_END="PK",o.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",o.ZIP64_CENTRAL_DIRECTORY_END="PK",o.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(e,c,o){var n=e("./GenericWorker"),i=e("../utils");function s(r){n.call(this,"ConvertWorker to "+r),this.destType=r}i.inherits(s,n),s.prototype.processChunk=function(r){this.push({data:i.transformTo(this.destType,r.data),meta:r.meta})},c.exports=s},{"../utils":32,"./GenericWorker":28}],25:[function(e,c,o){var n=e("./GenericWorker"),i=e("../crc32");function s(){n.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}e("../utils").inherits(s,n),s.prototype.processChunk=function(r){this.streamInfo.crc32=i(r.data,this.streamInfo.crc32||0),this.push(r)},c.exports=s},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,c,o){var n=e("../utils"),i=e("./GenericWorker");function s(r){i.call(this,"DataLengthProbe for "+r),this.propName=r,this.withStreamInfo(r,0)}n.inherits(s,i),s.prototype.processChunk=function(r){if(r){var l=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=l+r.data.length}i.prototype.processChunk.call(this,r)},c.exports=s},{"../utils":32,"./GenericWorker":28}],27:[function(e,c,o){var n=e("../utils"),i=e("./GenericWorker");function s(r){i.call(this,"DataWorker");var l=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,r.then(function(h){l.dataIsReady=!0,l.data=h,l.max=h&&h.length||0,l.type=n.getTypeOf(h),l.isPaused||l._tickAndRepeat()},function(h){l.error(h)})}n.inherits(s,i),s.prototype.cleanUp=function(){i.prototype.cleanUp.call(this),this.data=null},s.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,n.delay(this._tickAndRepeat,[],this)),!0)},s.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(n.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},s.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var r=null,l=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":r=this.data.substring(this.index,l);break;case"uint8array":r=this.data.subarray(this.index,l);break;case"array":case"nodebuffer":r=this.data.slice(this.index,l)}return this.index=l,this.push({data:r,meta:{percent:this.max?this.index/this.max*100:0}})},c.exports=s},{"../utils":32,"./GenericWorker":28}],28:[function(e,c,o){function n(i){this.name=i||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}n.prototype={push:function(i){this.emit("data",i)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(i){this.emit("error",i)}return!0},error:function(i){return!this.isFinished&&(this.isPaused?this.generatedError=i:(this.isFinished=!0,this.emit("error",i),this.previous&&this.previous.error(i),this.cleanUp()),!0)},on:function(i,s){return this._listeners[i].push(s),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(i,s){if(this._listeners[i])for(var r=0;r<this._listeners[i].length;r++)this._listeners[i][r].call(this,s)},pipe:function(i){return i.registerPrevious(this)},registerPrevious:function(i){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=i.streamInfo,this.mergeStreamInfo(),this.previous=i;var s=this;return i.on("data",function(r){s.processChunk(r)}),i.on("end",function(){s.end()}),i.on("error",function(r){s.error(r)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var i=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),i=!0),this.previous&&this.previous.resume(),!i},flush:function(){},processChunk:function(i){this.push(i)},withStreamInfo:function(i,s){return this.extraStreamInfo[i]=s,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var i in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,i)&&(this.streamInfo[i]=this.extraStreamInfo[i])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var i="Worker "+this.name;return this.previous?this.previous+" -> "+i:i}},c.exports=n},{}],29:[function(e,c,o){var n=e("../utils"),i=e("./ConvertWorker"),s=e("./GenericWorker"),r=e("../base64"),l=e("../support"),h=e("../external"),p=null;if(l.nodestream)try{p=e("../nodejs/NodejsStreamOutputAdapter")}catch{}function f(y,m){return new h.Promise(function(v,b){var C=[],_=y._internalType,S=y._outputType,I=y._mimeType;y.on("data",function(x,L){C.push(x),m&&m(L)}).on("error",function(x){C=[],b(x)}).on("end",function(){try{var x=function(L,D,R){switch(L){case"blob":return n.newBlob(n.transformTo("arraybuffer",D),R);case"base64":return r.encode(D);default:return n.transformTo(L,D)}}(S,function(L,D){var R,P=0,Q=null,k=0;for(R=0;R<D.length;R++)k+=D[R].length;switch(L){case"string":return D.join("");case"array":return Array.prototype.concat.apply([],D);case"uint8array":for(Q=new Uint8Array(k),R=0;R<D.length;R++)Q.set(D[R],P),P+=D[R].length;return Q;case"nodebuffer":return Buffer.concat(D);default:throw new Error("concat : unsupported type '"+L+"'")}}(_,C),I);v(x)}catch(L){b(L)}C=[]}).resume()})}function u(y,m,v){var b=m;switch(m){case"blob":case"arraybuffer":b="uint8array";break;case"base64":b="string"}try{this._internalType=b,this._outputType=m,this._mimeType=v,n.checkSupport(b),this._worker=y.pipe(new i(b)),y.lock()}catch(C){this._worker=new s("error"),this._worker.error(C)}}u.prototype={accumulate:function(y){return f(this,y)},on:function(y,m){var v=this;return y==="data"?this._worker.on(y,function(b){m.call(v,b.data,b.meta)}):this._worker.on(y,function(){n.delay(m,arguments,v)}),this},resume:function(){return n.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(y){if(n.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new p(this,{objectMode:this._outputType!=="nodebuffer"},y)}},c.exports=u},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,c,o){if(o.base64=!0,o.array=!0,o.string=!0,o.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",o.nodebuffer=typeof Buffer<"u",o.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")o.blob=!1;else{var n=new ArrayBuffer(0);try{o.blob=new Blob([n],{type:"application/zip"}).size===0}catch{try{var i=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);i.append(n),o.blob=i.getBlob("application/zip").size===0}catch{o.blob=!1}}}try{o.nodestream=!!e("readable-stream").Readable}catch{o.nodestream=!1}},{"readable-stream":16}],31:[function(e,c,o){for(var n=e("./utils"),i=e("./support"),s=e("./nodejsUtils"),r=e("./stream/GenericWorker"),l=new Array(256),h=0;h<256;h++)l[h]=252<=h?6:248<=h?5:240<=h?4:224<=h?3:192<=h?2:1;l[254]=l[254]=1;function p(){r.call(this,"utf-8 decode"),this.leftOver=null}function f(){r.call(this,"utf-8 encode")}o.utf8encode=function(u){return i.nodebuffer?s.newBufferFrom(u,"utf-8"):function(y){var m,v,b,C,_,S=y.length,I=0;for(C=0;C<S;C++)(64512&(v=y.charCodeAt(C)))==55296&&C+1<S&&(64512&(b=y.charCodeAt(C+1)))==56320&&(v=65536+(v-55296<<10)+(b-56320),C++),I+=v<128?1:v<2048?2:v<65536?3:4;for(m=i.uint8array?new Uint8Array(I):new Array(I),C=_=0;_<I;C++)(64512&(v=y.charCodeAt(C)))==55296&&C+1<S&&(64512&(b=y.charCodeAt(C+1)))==56320&&(v=65536+(v-55296<<10)+(b-56320),C++),v<128?m[_++]=v:(v<2048?m[_++]=192|v>>>6:(v<65536?m[_++]=224|v>>>12:(m[_++]=240|v>>>18,m[_++]=128|v>>>12&63),m[_++]=128|v>>>6&63),m[_++]=128|63&v);return m}(u)},o.utf8decode=function(u){return i.nodebuffer?n.transformTo("nodebuffer",u).toString("utf-8"):function(y){var m,v,b,C,_=y.length,S=new Array(2*_);for(m=v=0;m<_;)if((b=y[m++])<128)S[v++]=b;else if(4<(C=l[b]))S[v++]=65533,m+=C-1;else{for(b&=C===2?31:C===3?15:7;1<C&&m<_;)b=b<<6|63&y[m++],C--;1<C?S[v++]=65533:b<65536?S[v++]=b:(b-=65536,S[v++]=55296|b>>10&1023,S[v++]=56320|1023&b)}return S.length!==v&&(S.subarray?S=S.subarray(0,v):S.length=v),n.applyFromCharCode(S)}(u=n.transformTo(i.uint8array?"uint8array":"array",u))},n.inherits(p,r),p.prototype.processChunk=function(u){var y=n.transformTo(i.uint8array?"uint8array":"array",u.data);if(this.leftOver&&this.leftOver.length){if(i.uint8array){var m=y;(y=new Uint8Array(m.length+this.leftOver.length)).set(this.leftOver,0),y.set(m,this.leftOver.length)}else y=this.leftOver.concat(y);this.leftOver=null}var v=function(C,_){var S;for((_=_||C.length)>C.length&&(_=C.length),S=_-1;0<=S&&(192&C[S])==128;)S--;return S<0||S===0?_:S+l[C[S]]>_?S:_}(y),b=y;v!==y.length&&(i.uint8array?(b=y.subarray(0,v),this.leftOver=y.subarray(v,y.length)):(b=y.slice(0,v),this.leftOver=y.slice(v,y.length))),this.push({data:o.utf8decode(b),meta:u.meta})},p.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:o.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},o.Utf8DecodeWorker=p,n.inherits(f,r),f.prototype.processChunk=function(u){this.push({data:o.utf8encode(u.data),meta:u.meta})},o.Utf8EncodeWorker=f},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,c,o){var n=e("./support"),i=e("./base64"),s=e("./nodejsUtils"),r=e("./external");function l(m){return m}function h(m,v){for(var b=0;b<m.length;++b)v[b]=255&m.charCodeAt(b);return v}e("setimmediate"),o.newBlob=function(m,v){o.checkSupport("blob");try{return new Blob([m],{type:v})}catch{try{var b=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return b.append(m),b.getBlob(v)}catch{throw new Error("Bug : can't construct the Blob.")}}};var p={stringifyByChunk:function(m,v,b){var C=[],_=0,S=m.length;if(S<=b)return String.fromCharCode.apply(null,m);for(;_<S;)v==="array"||v==="nodebuffer"?C.push(String.fromCharCode.apply(null,m.slice(_,Math.min(_+b,S)))):C.push(String.fromCharCode.apply(null,m.subarray(_,Math.min(_+b,S)))),_+=b;return C.join("")},stringifyByChar:function(m){for(var v="",b=0;b<m.length;b++)v+=String.fromCharCode(m[b]);return v},applyCanBeUsed:{uint8array:function(){try{return n.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}}(),nodebuffer:function(){try{return n.nodebuffer&&String.fromCharCode.apply(null,s.allocBuffer(1)).length===1}catch{return!1}}()}};function f(m){var v=65536,b=o.getTypeOf(m),C=!0;if(b==="uint8array"?C=p.applyCanBeUsed.uint8array:b==="nodebuffer"&&(C=p.applyCanBeUsed.nodebuffer),C)for(;1<v;)try{return p.stringifyByChunk(m,b,v)}catch{v=Math.floor(v/2)}return p.stringifyByChar(m)}function u(m,v){for(var b=0;b<m.length;b++)v[b]=m[b];return v}o.applyFromCharCode=f;var y={};y.string={string:l,array:function(m){return h(m,new Array(m.length))},arraybuffer:function(m){return y.string.uint8array(m).buffer},uint8array:function(m){return h(m,new Uint8Array(m.length))},nodebuffer:function(m){return h(m,s.allocBuffer(m.length))}},y.array={string:f,array:l,arraybuffer:function(m){return new Uint8Array(m).buffer},uint8array:function(m){return new Uint8Array(m)},nodebuffer:function(m){return s.newBufferFrom(m)}},y.arraybuffer={string:function(m){return f(new Uint8Array(m))},array:function(m){return u(new Uint8Array(m),new Array(m.byteLength))},arraybuffer:l,uint8array:function(m){return new Uint8Array(m)},nodebuffer:function(m){return s.newBufferFrom(new Uint8Array(m))}},y.uint8array={string:f,array:function(m){return u(m,new Array(m.length))},arraybuffer:function(m){return m.buffer},uint8array:l,nodebuffer:function(m){return s.newBufferFrom(m)}},y.nodebuffer={string:f,array:function(m){return u(m,new Array(m.length))},arraybuffer:function(m){return y.nodebuffer.uint8array(m).buffer},uint8array:function(m){return u(m,new Uint8Array(m.length))},nodebuffer:l},o.transformTo=function(m,v){if(v=v||"",!m)return v;o.checkSupport(m);var b=o.getTypeOf(v);return y[b][m](v)},o.resolve=function(m){for(var v=m.split("/"),b=[],C=0;C<v.length;C++){var _=v[C];_==="."||_===""&&C!==0&&C!==v.length-1||(_===".."?b.pop():b.push(_))}return b.join("/")},o.getTypeOf=function(m){return typeof m=="string"?"string":Object.prototype.toString.call(m)==="[object Array]"?"array":n.nodebuffer&&s.isBuffer(m)?"nodebuffer":n.uint8array&&m instanceof Uint8Array?"uint8array":n.arraybuffer&&m instanceof ArrayBuffer?"arraybuffer":void 0},o.checkSupport=function(m){if(!n[m.toLowerCase()])throw new Error(m+" is not supported by this platform")},o.MAX_VALUE_16BITS=65535,o.MAX_VALUE_32BITS=-1,o.pretty=function(m){var v,b,C="";for(b=0;b<(m||"").length;b++)C+="\\x"+((v=m.charCodeAt(b))<16?"0":"")+v.toString(16).toUpperCase();return C},o.delay=function(m,v,b){setImmediate(function(){m.apply(b||null,v||[])})},o.inherits=function(m,v){function b(){}b.prototype=v.prototype,m.prototype=new b},o.extend=function(){var m,v,b={};for(m=0;m<arguments.length;m++)for(v in arguments[m])Object.prototype.hasOwnProperty.call(arguments[m],v)&&b[v]===void 0&&(b[v]=arguments[m][v]);return b},o.prepareContent=function(m,v,b,C,_){return r.Promise.resolve(v).then(function(S){return n.blob&&(S instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(S))!==-1)&&typeof FileReader<"u"?new r.Promise(function(I,x){var L=new FileReader;L.onload=function(D){I(D.target.result)},L.onerror=function(D){x(D.target.error)},L.readAsArrayBuffer(S)}):S}).then(function(S){var I=o.getTypeOf(S);return I?(I==="arraybuffer"?S=o.transformTo("uint8array",S):I==="string"&&(_?S=i.decode(S):b&&C!==!0&&(S=function(x){return h(x,n.uint8array?new Uint8Array(x.length):new Array(x.length))}(S))),S):r.Promise.reject(new Error("Can't read the data of '"+m+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(e,c,o){var n=e("./reader/readerFor"),i=e("./utils"),s=e("./signature"),r=e("./zipEntry"),l=e("./support");function h(p){this.files=[],this.loadOptions=p}h.prototype={checkSignature:function(p){if(!this.reader.readAndCheckSignature(p)){this.reader.index-=4;var f=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+i.pretty(f)+", expected "+i.pretty(p)+")")}},isSignature:function(p,f){var u=this.reader.index;this.reader.setIndex(p);var y=this.reader.readString(4)===f;return this.reader.setIndex(u),y},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var p=this.reader.readData(this.zipCommentLength),f=l.uint8array?"uint8array":"array",u=i.transformTo(f,p);this.zipComment=this.loadOptions.decodeFileName(u)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var p,f,u,y=this.zip64EndOfCentralSize-44;0<y;)p=this.reader.readInt(2),f=this.reader.readInt(4),u=this.reader.readData(f),this.zip64ExtensibleData[p]={id:p,length:f,value:u}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var p,f;for(p=0;p<this.files.length;p++)f=this.files[p],this.reader.setIndex(f.localHeaderOffset),this.checkSignature(s.LOCAL_FILE_HEADER),f.readLocalPart(this.reader),f.handleUTF8(),f.processAttributes()},readCentralDir:function(){var p;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(s.CENTRAL_FILE_HEADER);)(p=new r({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(p);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var p=this.reader.lastIndexOfSignature(s.CENTRAL_DIRECTORY_END);if(p<0)throw this.isSignature(0,s.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(p);var f=p;if(this.checkSignature(s.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===i.MAX_VALUE_16BITS||this.diskWithCentralDirStart===i.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===i.MAX_VALUE_16BITS||this.centralDirRecords===i.MAX_VALUE_16BITS||this.centralDirSize===i.MAX_VALUE_32BITS||this.centralDirOffset===i.MAX_VALUE_32BITS){if(this.zip64=!0,(p=this.reader.lastIndexOfSignature(s.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(p),this.checkSignature(s.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,s.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(s.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(s.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var u=this.centralDirOffset+this.centralDirSize;this.zip64&&(u+=20,u+=12+this.zip64EndOfCentralSize);var y=f-u;if(0<y)this.isSignature(f,s.CENTRAL_FILE_HEADER)||(this.reader.zero=y);else if(y<0)throw new Error("Corrupted zip: missing "+Math.abs(y)+" bytes.")},prepareReader:function(p){this.reader=n(p)},load:function(p){this.prepareReader(p),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},c.exports=h},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(e,c,o){var n=e("./reader/readerFor"),i=e("./utils"),s=e("./compressedObject"),r=e("./crc32"),l=e("./utf8"),h=e("./compressions"),p=e("./support");function f(u,y){this.options=u,this.loadOptions=y}f.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(u){var y,m;if(u.skip(22),this.fileNameLength=u.readInt(2),m=u.readInt(2),this.fileName=u.readData(this.fileNameLength),u.skip(m),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((y=function(v){for(var b in h)if(Object.prototype.hasOwnProperty.call(h,b)&&h[b].magic===v)return h[b];return null}(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+i.pretty(this.compressionMethod)+" unknown (inner file : "+i.transformTo("string",this.fileName)+")");this.decompressed=new s(this.compressedSize,this.uncompressedSize,this.crc32,y,u.readData(this.compressedSize))},readCentralPart:function(u){this.versionMadeBy=u.readInt(2),u.skip(2),this.bitFlag=u.readInt(2),this.compressionMethod=u.readString(2),this.date=u.readDate(),this.crc32=u.readInt(4),this.compressedSize=u.readInt(4),this.uncompressedSize=u.readInt(4);var y=u.readInt(2);if(this.extraFieldsLength=u.readInt(2),this.fileCommentLength=u.readInt(2),this.diskNumberStart=u.readInt(2),this.internalFileAttributes=u.readInt(2),this.externalFileAttributes=u.readInt(4),this.localHeaderOffset=u.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");u.skip(y),this.readExtraFields(u),this.parseZIP64ExtraField(u),this.fileComment=u.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var u=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),u==0&&(this.dosPermissions=63&this.externalFileAttributes),u==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var u=n(this.extraFields[1].value);this.uncompressedSize===i.MAX_VALUE_32BITS&&(this.uncompressedSize=u.readInt(8)),this.compressedSize===i.MAX_VALUE_32BITS&&(this.compressedSize=u.readInt(8)),this.localHeaderOffset===i.MAX_VALUE_32BITS&&(this.localHeaderOffset=u.readInt(8)),this.diskNumberStart===i.MAX_VALUE_32BITS&&(this.diskNumberStart=u.readInt(4))}},readExtraFields:function(u){var y,m,v,b=u.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});u.index+4<b;)y=u.readInt(2),m=u.readInt(2),v=u.readData(m),this.extraFields[y]={id:y,length:m,value:v};u.setIndex(b)},handleUTF8:function(){var u=p.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=l.utf8decode(this.fileName),this.fileCommentStr=l.utf8decode(this.fileComment);else{var y=this.findExtraFieldUnicodePath();if(y!==null)this.fileNameStr=y;else{var m=i.transformTo(u,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(m)}var v=this.findExtraFieldUnicodeComment();if(v!==null)this.fileCommentStr=v;else{var b=i.transformTo(u,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(b)}}},findExtraFieldUnicodePath:function(){var u=this.extraFields[28789];if(u){var y=n(u.value);return y.readInt(1)!==1||r(this.fileName)!==y.readInt(4)?null:l.utf8decode(y.readData(u.length-5))}return null},findExtraFieldUnicodeComment:function(){var u=this.extraFields[25461];if(u){var y=n(u.value);return y.readInt(1)!==1||r(this.fileComment)!==y.readInt(4)?null:l.utf8decode(y.readData(u.length-5))}return null}},c.exports=f},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(e,c,o){function n(y,m,v){this.name=y,this.dir=v.dir,this.date=v.date,this.comment=v.comment,this.unixPermissions=v.unixPermissions,this.dosPermissions=v.dosPermissions,this._data=m,this._dataBinary=v.binary,this.options={compression:v.compression,compressionOptions:v.compressionOptions}}var i=e("./stream/StreamHelper"),s=e("./stream/DataWorker"),r=e("./utf8"),l=e("./compressedObject"),h=e("./stream/GenericWorker");n.prototype={internalStream:function(y){var m=null,v="string";try{if(!y)throw new Error("No output type specified.");var b=(v=y.toLowerCase())==="string"||v==="text";v!=="binarystring"&&v!=="text"||(v="string"),m=this._decompressWorker();var C=!this._dataBinary;C&&!b&&(m=m.pipe(new r.Utf8EncodeWorker)),!C&&b&&(m=m.pipe(new r.Utf8DecodeWorker))}catch(_){(m=new h("error")).error(_)}return new i(m,v,"")},async:function(y,m){return this.internalStream(y).accumulate(m)},nodeStream:function(y,m){return this.internalStream(y||"nodebuffer").toNodejsStream(m)},_compressWorker:function(y,m){if(this._data instanceof l&&this._data.compression.magic===y.magic)return this._data.getCompressedWorker();var v=this._decompressWorker();return this._dataBinary||(v=v.pipe(new r.Utf8EncodeWorker)),l.createWorkerFrom(v,y,m)},_decompressWorker:function(){return this._data instanceof l?this._data.getContentWorker():this._data instanceof h?this._data:new s(this._data)}};for(var p=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],f=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},u=0;u<p.length;u++)n.prototype[p[u]]=f;c.exports=n},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(e,c,o){(function(n){var i,s,r=n.MutationObserver||n.WebKitMutationObserver;if(r){var l=0,h=new r(y),p=n.document.createTextNode("");h.observe(p,{characterData:!0}),i=function(){p.data=l=++l%2}}else if(n.setImmediate||n.MessageChannel===void 0)i="document"in n&&"onreadystatechange"in n.document.createElement("script")?function(){var m=n.document.createElement("script");m.onreadystatechange=function(){y(),m.onreadystatechange=null,m.parentNode.removeChild(m),m=null},n.document.documentElement.appendChild(m)}:function(){setTimeout(y,0)};else{var f=new n.MessageChannel;f.port1.onmessage=y,i=function(){f.port2.postMessage(0)}}var u=[];function y(){var m,v;s=!0;for(var b=u.length;b;){for(v=u,u=[],m=-1;++m<b;)v[m]();b=u.length}s=!1}c.exports=function(m){u.push(m)!==1||s||i()}}).call(this,typeof pn<"u"?pn:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(e,c,o){var n=e("immediate");function i(){}var s={},r=["REJECTED"],l=["FULFILLED"],h=["PENDING"];function p(b){if(typeof b!="function")throw new TypeError("resolver must be a function");this.state=h,this.queue=[],this.outcome=void 0,b!==i&&m(this,b)}function f(b,C,_){this.promise=b,typeof C=="function"&&(this.onFulfilled=C,this.callFulfilled=this.otherCallFulfilled),typeof _=="function"&&(this.onRejected=_,this.callRejected=this.otherCallRejected)}function u(b,C,_){n(function(){var S;try{S=C(_)}catch(I){return s.reject(b,I)}S===b?s.reject(b,new TypeError("Cannot resolve promise with itself")):s.resolve(b,S)})}function y(b){var C=b&&b.then;if(b&&(typeof b=="object"||typeof b=="function")&&typeof C=="function")return function(){C.apply(b,arguments)}}function m(b,C){var _=!1;function S(L){_||(_=!0,s.reject(b,L))}function I(L){_||(_=!0,s.resolve(b,L))}var x=v(function(){C(I,S)});x.status==="error"&&S(x.value)}function v(b,C){var _={};try{_.value=b(C),_.status="success"}catch(S){_.status="error",_.value=S}return _}(c.exports=p).prototype.finally=function(b){if(typeof b!="function")return this;var C=this.constructor;return this.then(function(_){return C.resolve(b()).then(function(){return _})},function(_){return C.resolve(b()).then(function(){throw _})})},p.prototype.catch=function(b){return this.then(null,b)},p.prototype.then=function(b,C){if(typeof b!="function"&&this.state===l||typeof C!="function"&&this.state===r)return this;var _=new this.constructor(i);return this.state!==h?u(_,this.state===l?b:C,this.outcome):this.queue.push(new f(_,b,C)),_},f.prototype.callFulfilled=function(b){s.resolve(this.promise,b)},f.prototype.otherCallFulfilled=function(b){u(this.promise,this.onFulfilled,b)},f.prototype.callRejected=function(b){s.reject(this.promise,b)},f.prototype.otherCallRejected=function(b){u(this.promise,this.onRejected,b)},s.resolve=function(b,C){var _=v(y,C);if(_.status==="error")return s.reject(b,_.value);var S=_.value;if(S)m(b,S);else{b.state=l,b.outcome=C;for(var I=-1,x=b.queue.length;++I<x;)b.queue[I].callFulfilled(C)}return b},s.reject=function(b,C){b.state=r,b.outcome=C;for(var _=-1,S=b.queue.length;++_<S;)b.queue[_].callRejected(C);return b},p.resolve=function(b){return b instanceof this?b:s.resolve(new this(i),b)},p.reject=function(b){var C=new this(i);return s.reject(C,b)},p.all=function(b){var C=this;if(Object.prototype.toString.call(b)!=="[object Array]")return this.reject(new TypeError("must be an array"));var _=b.length,S=!1;if(!_)return this.resolve([]);for(var I=new Array(_),x=0,L=-1,D=new this(i);++L<_;)R(b[L],L);return D;function R(P,Q){C.resolve(P).then(function(k){I[Q]=k,++x!==_||S||(S=!0,s.resolve(D,I))},function(k){S||(S=!0,s.reject(D,k))})}},p.race=function(b){var C=this;if(Object.prototype.toString.call(b)!=="[object Array]")return this.reject(new TypeError("must be an array"));var _=b.length,S=!1;if(!_)return this.resolve([]);for(var I=-1,x=new this(i);++I<_;)L=b[I],C.resolve(L).then(function(D){S||(S=!0,s.resolve(x,D))},function(D){S||(S=!0,s.reject(x,D))});var L;return x}},{immediate:36}],38:[function(e,c,o){var n={};(0,e("./lib/utils/common").assign)(n,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),c.exports=n},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(e,c,o){var n=e("./zlib/deflate"),i=e("./utils/common"),s=e("./utils/strings"),r=e("./zlib/messages"),l=e("./zlib/zstream"),h=Object.prototype.toString,p=0,f=-1,u=0,y=8;function m(b){if(!(this instanceof m))return new m(b);this.options=i.assign({level:f,method:y,chunkSize:16384,windowBits:15,memLevel:8,strategy:u,to:""},b||{});var C=this.options;C.raw&&0<C.windowBits?C.windowBits=-C.windowBits:C.gzip&&0<C.windowBits&&C.windowBits<16&&(C.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new l,this.strm.avail_out=0;var _=n.deflateInit2(this.strm,C.level,C.method,C.windowBits,C.memLevel,C.strategy);if(_!==p)throw new Error(r[_]);if(C.header&&n.deflateSetHeader(this.strm,C.header),C.dictionary){var S;if(S=typeof C.dictionary=="string"?s.string2buf(C.dictionary):h.call(C.dictionary)==="[object ArrayBuffer]"?new Uint8Array(C.dictionary):C.dictionary,(_=n.deflateSetDictionary(this.strm,S))!==p)throw new Error(r[_]);this._dict_set=!0}}function v(b,C){var _=new m(C);if(_.push(b,!0),_.err)throw _.msg||r[_.err];return _.result}m.prototype.push=function(b,C){var _,S,I=this.strm,x=this.options.chunkSize;if(this.ended)return!1;S=C===~~C?C:C===!0?4:0,typeof b=="string"?I.input=s.string2buf(b):h.call(b)==="[object ArrayBuffer]"?I.input=new Uint8Array(b):I.input=b,I.next_in=0,I.avail_in=I.input.length;do{if(I.avail_out===0&&(I.output=new i.Buf8(x),I.next_out=0,I.avail_out=x),(_=n.deflate(I,S))!==1&&_!==p)return this.onEnd(_),!(this.ended=!0);I.avail_out!==0&&(I.avail_in!==0||S!==4&&S!==2)||(this.options.to==="string"?this.onData(s.buf2binstring(i.shrinkBuf(I.output,I.next_out))):this.onData(i.shrinkBuf(I.output,I.next_out)))}while((0<I.avail_in||I.avail_out===0)&&_!==1);return S===4?(_=n.deflateEnd(this.strm),this.onEnd(_),this.ended=!0,_===p):S!==2||(this.onEnd(p),!(I.avail_out=0))},m.prototype.onData=function(b){this.chunks.push(b)},m.prototype.onEnd=function(b){b===p&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=i.flattenChunks(this.chunks)),this.chunks=[],this.err=b,this.msg=this.strm.msg},o.Deflate=m,o.deflate=v,o.deflateRaw=function(b,C){return(C=C||{}).raw=!0,v(b,C)},o.gzip=function(b,C){return(C=C||{}).gzip=!0,v(b,C)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(e,c,o){var n=e("./zlib/inflate"),i=e("./utils/common"),s=e("./utils/strings"),r=e("./zlib/constants"),l=e("./zlib/messages"),h=e("./zlib/zstream"),p=e("./zlib/gzheader"),f=Object.prototype.toString;function u(m){if(!(this instanceof u))return new u(m);this.options=i.assign({chunkSize:16384,windowBits:0,to:""},m||{});var v=this.options;v.raw&&0<=v.windowBits&&v.windowBits<16&&(v.windowBits=-v.windowBits,v.windowBits===0&&(v.windowBits=-15)),!(0<=v.windowBits&&v.windowBits<16)||m&&m.windowBits||(v.windowBits+=32),15<v.windowBits&&v.windowBits<48&&!(15&v.windowBits)&&(v.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new h,this.strm.avail_out=0;var b=n.inflateInit2(this.strm,v.windowBits);if(b!==r.Z_OK)throw new Error(l[b]);this.header=new p,n.inflateGetHeader(this.strm,this.header)}function y(m,v){var b=new u(v);if(b.push(m,!0),b.err)throw b.msg||l[b.err];return b.result}u.prototype.push=function(m,v){var b,C,_,S,I,x,L=this.strm,D=this.options.chunkSize,R=this.options.dictionary,P=!1;if(this.ended)return!1;C=v===~~v?v:v===!0?r.Z_FINISH:r.Z_NO_FLUSH,typeof m=="string"?L.input=s.binstring2buf(m):f.call(m)==="[object ArrayBuffer]"?L.input=new Uint8Array(m):L.input=m,L.next_in=0,L.avail_in=L.input.length;do{if(L.avail_out===0&&(L.output=new i.Buf8(D),L.next_out=0,L.avail_out=D),(b=n.inflate(L,r.Z_NO_FLUSH))===r.Z_NEED_DICT&&R&&(x=typeof R=="string"?s.string2buf(R):f.call(R)==="[object ArrayBuffer]"?new Uint8Array(R):R,b=n.inflateSetDictionary(this.strm,x)),b===r.Z_BUF_ERROR&&P===!0&&(b=r.Z_OK,P=!1),b!==r.Z_STREAM_END&&b!==r.Z_OK)return this.onEnd(b),!(this.ended=!0);L.next_out&&(L.avail_out!==0&&b!==r.Z_STREAM_END&&(L.avail_in!==0||C!==r.Z_FINISH&&C!==r.Z_SYNC_FLUSH)||(this.options.to==="string"?(_=s.utf8border(L.output,L.next_out),S=L.next_out-_,I=s.buf2string(L.output,_),L.next_out=S,L.avail_out=D-S,S&&i.arraySet(L.output,L.output,_,S,0),this.onData(I)):this.onData(i.shrinkBuf(L.output,L.next_out)))),L.avail_in===0&&L.avail_out===0&&(P=!0)}while((0<L.avail_in||L.avail_out===0)&&b!==r.Z_STREAM_END);return b===r.Z_STREAM_END&&(C=r.Z_FINISH),C===r.Z_FINISH?(b=n.inflateEnd(this.strm),this.onEnd(b),this.ended=!0,b===r.Z_OK):C!==r.Z_SYNC_FLUSH||(this.onEnd(r.Z_OK),!(L.avail_out=0))},u.prototype.onData=function(m){this.chunks.push(m)},u.prototype.onEnd=function(m){m===r.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=i.flattenChunks(this.chunks)),this.chunks=[],this.err=m,this.msg=this.strm.msg},o.Inflate=u,o.inflate=y,o.inflateRaw=function(m,v){return(v=v||{}).raw=!0,y(m,v)},o.ungzip=y},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(e,c,o){var n=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";o.assign=function(r){for(var l=Array.prototype.slice.call(arguments,1);l.length;){var h=l.shift();if(h){if(typeof h!="object")throw new TypeError(h+"must be non-object");for(var p in h)h.hasOwnProperty(p)&&(r[p]=h[p])}}return r},o.shrinkBuf=function(r,l){return r.length===l?r:r.subarray?r.subarray(0,l):(r.length=l,r)};var i={arraySet:function(r,l,h,p,f){if(l.subarray&&r.subarray)r.set(l.subarray(h,h+p),f);else for(var u=0;u<p;u++)r[f+u]=l[h+u]},flattenChunks:function(r){var l,h,p,f,u,y;for(l=p=0,h=r.length;l<h;l++)p+=r[l].length;for(y=new Uint8Array(p),l=f=0,h=r.length;l<h;l++)u=r[l],y.set(u,f),f+=u.length;return y}},s={arraySet:function(r,l,h,p,f){for(var u=0;u<p;u++)r[f+u]=l[h+u]},flattenChunks:function(r){return[].concat.apply([],r)}};o.setTyped=function(r){r?(o.Buf8=Uint8Array,o.Buf16=Uint16Array,o.Buf32=Int32Array,o.assign(o,i)):(o.Buf8=Array,o.Buf16=Array,o.Buf32=Array,o.assign(o,s))},o.setTyped(n)},{}],42:[function(e,c,o){var n=e("./common"),i=!0,s=!0;try{String.fromCharCode.apply(null,[0])}catch{i=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{s=!1}for(var r=new n.Buf8(256),l=0;l<256;l++)r[l]=252<=l?6:248<=l?5:240<=l?4:224<=l?3:192<=l?2:1;function h(p,f){if(f<65537&&(p.subarray&&s||!p.subarray&&i))return String.fromCharCode.apply(null,n.shrinkBuf(p,f));for(var u="",y=0;y<f;y++)u+=String.fromCharCode(p[y]);return u}r[254]=r[254]=1,o.string2buf=function(p){var f,u,y,m,v,b=p.length,C=0;for(m=0;m<b;m++)(64512&(u=p.charCodeAt(m)))==55296&&m+1<b&&(64512&(y=p.charCodeAt(m+1)))==56320&&(u=65536+(u-55296<<10)+(y-56320),m++),C+=u<128?1:u<2048?2:u<65536?3:4;for(f=new n.Buf8(C),m=v=0;v<C;m++)(64512&(u=p.charCodeAt(m)))==55296&&m+1<b&&(64512&(y=p.charCodeAt(m+1)))==56320&&(u=65536+(u-55296<<10)+(y-56320),m++),u<128?f[v++]=u:(u<2048?f[v++]=192|u>>>6:(u<65536?f[v++]=224|u>>>12:(f[v++]=240|u>>>18,f[v++]=128|u>>>12&63),f[v++]=128|u>>>6&63),f[v++]=128|63&u);return f},o.buf2binstring=function(p){return h(p,p.length)},o.binstring2buf=function(p){for(var f=new n.Buf8(p.length),u=0,y=f.length;u<y;u++)f[u]=p.charCodeAt(u);return f},o.buf2string=function(p,f){var u,y,m,v,b=f||p.length,C=new Array(2*b);for(u=y=0;u<b;)if((m=p[u++])<128)C[y++]=m;else if(4<(v=r[m]))C[y++]=65533,u+=v-1;else{for(m&=v===2?31:v===3?15:7;1<v&&u<b;)m=m<<6|63&p[u++],v--;1<v?C[y++]=65533:m<65536?C[y++]=m:(m-=65536,C[y++]=55296|m>>10&1023,C[y++]=56320|1023&m)}return h(C,y)},o.utf8border=function(p,f){var u;for((f=f||p.length)>p.length&&(f=p.length),u=f-1;0<=u&&(192&p[u])==128;)u--;return u<0||u===0?f:u+r[p[u]]>f?u:f}},{"./common":41}],43:[function(e,c,o){c.exports=function(n,i,s,r){for(var l=65535&n|0,h=n>>>16&65535|0,p=0;s!==0;){for(s-=p=2e3<s?2e3:s;h=h+(l=l+i[r++]|0)|0,--p;);l%=65521,h%=65521}return l|h<<16|0}},{}],44:[function(e,c,o){c.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(e,c,o){var n=function(){for(var i,s=[],r=0;r<256;r++){i=r;for(var l=0;l<8;l++)i=1&i?3988292384^i>>>1:i>>>1;s[r]=i}return s}();c.exports=function(i,s,r,l){var h=n,p=l+r;i^=-1;for(var f=l;f<p;f++)i=i>>>8^h[255&(i^s[f])];return-1^i}},{}],46:[function(e,c,o){var n,i=e("../utils/common"),s=e("./trees"),r=e("./adler32"),l=e("./crc32"),h=e("./messages"),p=0,f=4,u=0,y=-2,m=-1,v=4,b=2,C=8,_=9,S=286,I=30,x=19,L=2*S+1,D=15,R=3,P=258,Q=P+R+1,k=42,z=113,g=1,H=2,ue=3,j=4;function fe(d,W){return d.msg=h[W],W}function F(d){return(d<<1)-(4<d?9:0)}function ne(d){for(var W=d.length;0<=--W;)d[W]=0}function O(d){var W=d.state,$=W.pending;$>d.avail_out&&($=d.avail_out),$!==0&&(i.arraySet(d.output,W.pending_buf,W.pending_out,$,d.next_out),d.next_out+=$,W.pending_out+=$,d.total_out+=$,d.avail_out-=$,W.pending-=$,W.pending===0&&(W.pending_out=0))}function M(d,W){s._tr_flush_block(d,0<=d.block_start?d.block_start:-1,d.strstart-d.block_start,W),d.block_start=d.strstart,O(d.strm)}function oe(d,W){d.pending_buf[d.pending++]=W}function te(d,W){d.pending_buf[d.pending++]=W>>>8&255,d.pending_buf[d.pending++]=255&W}function X(d,W){var $,E,w=d.max_chain_length,T=d.strstart,q=d.prev_length,G=d.nice_match,A=d.strstart>d.w_size-Q?d.strstart-(d.w_size-Q):0,V=d.window,ie=d.w_mask,K=d.prev,le=d.strstart+P,Le=V[T+q-1],ye=V[T+q];d.prev_length>=d.good_match&&(w>>=2),G>d.lookahead&&(G=d.lookahead);do if(V[($=W)+q]===ye&&V[$+q-1]===Le&&V[$]===V[T]&&V[++$]===V[T+1]){T+=2,$++;do;while(V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&T<le);if(E=P-(le-T),T=le-P,q<E){if(d.match_start=W,G<=(q=E))break;Le=V[T+q-1],ye=V[T+q]}}while((W=K[W&ie])>A&&--w!=0);return q<=d.lookahead?q:d.lookahead}function Ne(d){var W,$,E,w,T,q,G,A,V,ie,K=d.w_size;do{if(w=d.window_size-d.lookahead-d.strstart,d.strstart>=K+(K-Q)){for(i.arraySet(d.window,d.window,K,K,0),d.match_start-=K,d.strstart-=K,d.block_start-=K,W=$=d.hash_size;E=d.head[--W],d.head[W]=K<=E?E-K:0,--$;);for(W=$=K;E=d.prev[--W],d.prev[W]=K<=E?E-K:0,--$;);w+=K}if(d.strm.avail_in===0)break;if(q=d.strm,G=d.window,A=d.strstart+d.lookahead,V=w,ie=void 0,ie=q.avail_in,V<ie&&(ie=V),$=ie===0?0:(q.avail_in-=ie,i.arraySet(G,q.input,q.next_in,ie,A),q.state.wrap===1?q.adler=r(q.adler,G,ie,A):q.state.wrap===2&&(q.adler=l(q.adler,G,ie,A)),q.next_in+=ie,q.total_in+=ie,ie),d.lookahead+=$,d.lookahead+d.insert>=R)for(T=d.strstart-d.insert,d.ins_h=d.window[T],d.ins_h=(d.ins_h<<d.hash_shift^d.window[T+1])&d.hash_mask;d.insert&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[T+R-1])&d.hash_mask,d.prev[T&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=T,T++,d.insert--,!(d.lookahead+d.insert<R)););}while(d.lookahead<Q&&d.strm.avail_in!==0)}function Oe(d,W){for(var $,E;;){if(d.lookahead<Q){if(Ne(d),d.lookahead<Q&&W===p)return g;if(d.lookahead===0)break}if($=0,d.lookahead>=R&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),$!==0&&d.strstart-$<=d.w_size-Q&&(d.match_length=X(d,$)),d.match_length>=R)if(E=s._tr_tally(d,d.strstart-d.match_start,d.match_length-R),d.lookahead-=d.match_length,d.match_length<=d.max_lazy_match&&d.lookahead>=R){for(d.match_length--;d.strstart++,d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart,--d.match_length!=0;);d.strstart++}else d.strstart+=d.match_length,d.match_length=0,d.ins_h=d.window[d.strstart],d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+1])&d.hash_mask;else E=s._tr_tally(d,0,d.window[d.strstart]),d.lookahead--,d.strstart++;if(E&&(M(d,!1),d.strm.avail_out===0))return g}return d.insert=d.strstart<R-1?d.strstart:R-1,W===f?(M(d,!0),d.strm.avail_out===0?ue:j):d.last_lit&&(M(d,!1),d.strm.avail_out===0)?g:H}function he(d,W){for(var $,E,w;;){if(d.lookahead<Q){if(Ne(d),d.lookahead<Q&&W===p)return g;if(d.lookahead===0)break}if($=0,d.lookahead>=R&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),d.prev_length=d.match_length,d.prev_match=d.match_start,d.match_length=R-1,$!==0&&d.prev_length<d.max_lazy_match&&d.strstart-$<=d.w_size-Q&&(d.match_length=X(d,$),d.match_length<=5&&(d.strategy===1||d.match_length===R&&4096<d.strstart-d.match_start)&&(d.match_length=R-1)),d.prev_length>=R&&d.match_length<=d.prev_length){for(w=d.strstart+d.lookahead-R,E=s._tr_tally(d,d.strstart-1-d.prev_match,d.prev_length-R),d.lookahead-=d.prev_length-1,d.prev_length-=2;++d.strstart<=w&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),--d.prev_length!=0;);if(d.match_available=0,d.match_length=R-1,d.strstart++,E&&(M(d,!1),d.strm.avail_out===0))return g}else if(d.match_available){if((E=s._tr_tally(d,0,d.window[d.strstart-1]))&&M(d,!1),d.strstart++,d.lookahead--,d.strm.avail_out===0)return g}else d.match_available=1,d.strstart++,d.lookahead--}return d.match_available&&(E=s._tr_tally(d,0,d.window[d.strstart-1]),d.match_available=0),d.insert=d.strstart<R-1?d.strstart:R-1,W===f?(M(d,!0),d.strm.avail_out===0?ue:j):d.last_lit&&(M(d,!1),d.strm.avail_out===0)?g:H}function Ce(d,W,$,E,w){this.good_length=d,this.max_lazy=W,this.nice_length=$,this.max_chain=E,this.func=w}function Te(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=C,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new i.Buf16(2*L),this.dyn_dtree=new i.Buf16(2*(2*I+1)),this.bl_tree=new i.Buf16(2*(2*x+1)),ne(this.dyn_ltree),ne(this.dyn_dtree),ne(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new i.Buf16(D+1),this.heap=new i.Buf16(2*S+1),ne(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new i.Buf16(2*S+1),ne(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function Ae(d){var W;return d&&d.state?(d.total_in=d.total_out=0,d.data_type=b,(W=d.state).pending=0,W.pending_out=0,W.wrap<0&&(W.wrap=-W.wrap),W.status=W.wrap?k:z,d.adler=W.wrap===2?0:1,W.last_flush=p,s._tr_init(W),u):fe(d,y)}function Ye(d){var W=Ae(d);return W===u&&function($){$.window_size=2*$.w_size,ne($.head),$.max_lazy_match=n[$.level].max_lazy,$.good_match=n[$.level].good_length,$.nice_match=n[$.level].nice_length,$.max_chain_length=n[$.level].max_chain,$.strstart=0,$.block_start=0,$.lookahead=0,$.insert=0,$.match_length=$.prev_length=R-1,$.match_available=0,$.ins_h=0}(d.state),W}function Xe(d,W,$,E,w,T){if(!d)return y;var q=1;if(W===m&&(W=6),E<0?(q=0,E=-E):15<E&&(q=2,E-=16),w<1||_<w||$!==C||E<8||15<E||W<0||9<W||T<0||v<T)return fe(d,y);E===8&&(E=9);var G=new Te;return(d.state=G).strm=d,G.wrap=q,G.gzhead=null,G.w_bits=E,G.w_size=1<<G.w_bits,G.w_mask=G.w_size-1,G.hash_bits=w+7,G.hash_size=1<<G.hash_bits,G.hash_mask=G.hash_size-1,G.hash_shift=~~((G.hash_bits+R-1)/R),G.window=new i.Buf8(2*G.w_size),G.head=new i.Buf16(G.hash_size),G.prev=new i.Buf16(G.w_size),G.lit_bufsize=1<<w+6,G.pending_buf_size=4*G.lit_bufsize,G.pending_buf=new i.Buf8(G.pending_buf_size),G.d_buf=1*G.lit_bufsize,G.l_buf=3*G.lit_bufsize,G.level=W,G.strategy=T,G.method=$,Ye(d)}n=[new Ce(0,0,0,0,function(d,W){var $=65535;for($>d.pending_buf_size-5&&($=d.pending_buf_size-5);;){if(d.lookahead<=1){if(Ne(d),d.lookahead===0&&W===p)return g;if(d.lookahead===0)break}d.strstart+=d.lookahead,d.lookahead=0;var E=d.block_start+$;if((d.strstart===0||d.strstart>=E)&&(d.lookahead=d.strstart-E,d.strstart=E,M(d,!1),d.strm.avail_out===0)||d.strstart-d.block_start>=d.w_size-Q&&(M(d,!1),d.strm.avail_out===0))return g}return d.insert=0,W===f?(M(d,!0),d.strm.avail_out===0?ue:j):(d.strstart>d.block_start&&(M(d,!1),d.strm.avail_out),g)}),new Ce(4,4,8,4,Oe),new Ce(4,5,16,8,Oe),new Ce(4,6,32,32,Oe),new Ce(4,4,16,16,he),new Ce(8,16,32,32,he),new Ce(8,16,128,128,he),new Ce(8,32,128,256,he),new Ce(32,128,258,1024,he),new Ce(32,258,258,4096,he)],o.deflateInit=function(d,W){return Xe(d,W,C,15,8,0)},o.deflateInit2=Xe,o.deflateReset=Ye,o.deflateResetKeep=Ae,o.deflateSetHeader=function(d,W){return d&&d.state?d.state.wrap!==2?y:(d.state.gzhead=W,u):y},o.deflate=function(d,W){var $,E,w,T;if(!d||!d.state||5<W||W<0)return d?fe(d,y):y;if(E=d.state,!d.output||!d.input&&d.avail_in!==0||E.status===666&&W!==f)return fe(d,d.avail_out===0?-5:y);if(E.strm=d,$=E.last_flush,E.last_flush=W,E.status===k)if(E.wrap===2)d.adler=0,oe(E,31),oe(E,139),oe(E,8),E.gzhead?(oe(E,(E.gzhead.text?1:0)+(E.gzhead.hcrc?2:0)+(E.gzhead.extra?4:0)+(E.gzhead.name?8:0)+(E.gzhead.comment?16:0)),oe(E,255&E.gzhead.time),oe(E,E.gzhead.time>>8&255),oe(E,E.gzhead.time>>16&255),oe(E,E.gzhead.time>>24&255),oe(E,E.level===9?2:2<=E.strategy||E.level<2?4:0),oe(E,255&E.gzhead.os),E.gzhead.extra&&E.gzhead.extra.length&&(oe(E,255&E.gzhead.extra.length),oe(E,E.gzhead.extra.length>>8&255)),E.gzhead.hcrc&&(d.adler=l(d.adler,E.pending_buf,E.pending,0)),E.gzindex=0,E.status=69):(oe(E,0),oe(E,0),oe(E,0),oe(E,0),oe(E,0),oe(E,E.level===9?2:2<=E.strategy||E.level<2?4:0),oe(E,3),E.status=z);else{var q=C+(E.w_bits-8<<4)<<8;q|=(2<=E.strategy||E.level<2?0:E.level<6?1:E.level===6?2:3)<<6,E.strstart!==0&&(q|=32),q+=31-q%31,E.status=z,te(E,q),E.strstart!==0&&(te(E,d.adler>>>16),te(E,65535&d.adler)),d.adler=1}if(E.status===69)if(E.gzhead.extra){for(w=E.pending;E.gzindex<(65535&E.gzhead.extra.length)&&(E.pending!==E.pending_buf_size||(E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),O(d),w=E.pending,E.pending!==E.pending_buf_size));)oe(E,255&E.gzhead.extra[E.gzindex]),E.gzindex++;E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),E.gzindex===E.gzhead.extra.length&&(E.gzindex=0,E.status=73)}else E.status=73;if(E.status===73)if(E.gzhead.name){w=E.pending;do{if(E.pending===E.pending_buf_size&&(E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),O(d),w=E.pending,E.pending===E.pending_buf_size)){T=1;break}T=E.gzindex<E.gzhead.name.length?255&E.gzhead.name.charCodeAt(E.gzindex++):0,oe(E,T)}while(T!==0);E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),T===0&&(E.gzindex=0,E.status=91)}else E.status=91;if(E.status===91)if(E.gzhead.comment){w=E.pending;do{if(E.pending===E.pending_buf_size&&(E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),O(d),w=E.pending,E.pending===E.pending_buf_size)){T=1;break}T=E.gzindex<E.gzhead.comment.length?255&E.gzhead.comment.charCodeAt(E.gzindex++):0,oe(E,T)}while(T!==0);E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),T===0&&(E.status=103)}else E.status=103;if(E.status===103&&(E.gzhead.hcrc?(E.pending+2>E.pending_buf_size&&O(d),E.pending+2<=E.pending_buf_size&&(oe(E,255&d.adler),oe(E,d.adler>>8&255),d.adler=0,E.status=z)):E.status=z),E.pending!==0){if(O(d),d.avail_out===0)return E.last_flush=-1,u}else if(d.avail_in===0&&F(W)<=F($)&&W!==f)return fe(d,-5);if(E.status===666&&d.avail_in!==0)return fe(d,-5);if(d.avail_in!==0||E.lookahead!==0||W!==p&&E.status!==666){var G=E.strategy===2?function(A,V){for(var ie;;){if(A.lookahead===0&&(Ne(A),A.lookahead===0)){if(V===p)return g;break}if(A.match_length=0,ie=s._tr_tally(A,0,A.window[A.strstart]),A.lookahead--,A.strstart++,ie&&(M(A,!1),A.strm.avail_out===0))return g}return A.insert=0,V===f?(M(A,!0),A.strm.avail_out===0?ue:j):A.last_lit&&(M(A,!1),A.strm.avail_out===0)?g:H}(E,W):E.strategy===3?function(A,V){for(var ie,K,le,Le,ye=A.window;;){if(A.lookahead<=P){if(Ne(A),A.lookahead<=P&&V===p)return g;if(A.lookahead===0)break}if(A.match_length=0,A.lookahead>=R&&0<A.strstart&&(K=ye[le=A.strstart-1])===ye[++le]&&K===ye[++le]&&K===ye[++le]){Le=A.strstart+P;do;while(K===ye[++le]&&K===ye[++le]&&K===ye[++le]&&K===ye[++le]&&K===ye[++le]&&K===ye[++le]&&K===ye[++le]&&K===ye[++le]&&le<Le);A.match_length=P-(Le-le),A.match_length>A.lookahead&&(A.match_length=A.lookahead)}if(A.match_length>=R?(ie=s._tr_tally(A,1,A.match_length-R),A.lookahead-=A.match_length,A.strstart+=A.match_length,A.match_length=0):(ie=s._tr_tally(A,0,A.window[A.strstart]),A.lookahead--,A.strstart++),ie&&(M(A,!1),A.strm.avail_out===0))return g}return A.insert=0,V===f?(M(A,!0),A.strm.avail_out===0?ue:j):A.last_lit&&(M(A,!1),A.strm.avail_out===0)?g:H}(E,W):n[E.level].func(E,W);if(G!==ue&&G!==j||(E.status=666),G===g||G===ue)return d.avail_out===0&&(E.last_flush=-1),u;if(G===H&&(W===1?s._tr_align(E):W!==5&&(s._tr_stored_block(E,0,0,!1),W===3&&(ne(E.head),E.lookahead===0&&(E.strstart=0,E.block_start=0,E.insert=0))),O(d),d.avail_out===0))return E.last_flush=-1,u}return W!==f?u:E.wrap<=0?1:(E.wrap===2?(oe(E,255&d.adler),oe(E,d.adler>>8&255),oe(E,d.adler>>16&255),oe(E,d.adler>>24&255),oe(E,255&d.total_in),oe(E,d.total_in>>8&255),oe(E,d.total_in>>16&255),oe(E,d.total_in>>24&255)):(te(E,d.adler>>>16),te(E,65535&d.adler)),O(d),0<E.wrap&&(E.wrap=-E.wrap),E.pending!==0?u:1)},o.deflateEnd=function(d){var W;return d&&d.state?(W=d.state.status)!==k&&W!==69&&W!==73&&W!==91&&W!==103&&W!==z&&W!==666?fe(d,y):(d.state=null,W===z?fe(d,-3):u):y},o.deflateSetDictionary=function(d,W){var $,E,w,T,q,G,A,V,ie=W.length;if(!d||!d.state||(T=($=d.state).wrap)===2||T===1&&$.status!==k||$.lookahead)return y;for(T===1&&(d.adler=r(d.adler,W,ie,0)),$.wrap=0,ie>=$.w_size&&(T===0&&(ne($.head),$.strstart=0,$.block_start=0,$.insert=0),V=new i.Buf8($.w_size),i.arraySet(V,W,ie-$.w_size,$.w_size,0),W=V,ie=$.w_size),q=d.avail_in,G=d.next_in,A=d.input,d.avail_in=ie,d.next_in=0,d.input=W,Ne($);$.lookahead>=R;){for(E=$.strstart,w=$.lookahead-(R-1);$.ins_h=($.ins_h<<$.hash_shift^$.window[E+R-1])&$.hash_mask,$.prev[E&$.w_mask]=$.head[$.ins_h],$.head[$.ins_h]=E,E++,--w;);$.strstart=E,$.lookahead=R-1,Ne($)}return $.strstart+=$.lookahead,$.block_start=$.strstart,$.insert=$.lookahead,$.lookahead=0,$.match_length=$.prev_length=R-1,$.match_available=0,d.next_in=G,d.input=A,d.avail_in=q,$.wrap=T,u},o.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(e,c,o){c.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(e,c,o){c.exports=function(n,i){var s,r,l,h,p,f,u,y,m,v,b,C,_,S,I,x,L,D,R,P,Q,k,z,g,H;s=n.state,r=n.next_in,g=n.input,l=r+(n.avail_in-5),h=n.next_out,H=n.output,p=h-(i-n.avail_out),f=h+(n.avail_out-257),u=s.dmax,y=s.wsize,m=s.whave,v=s.wnext,b=s.window,C=s.hold,_=s.bits,S=s.lencode,I=s.distcode,x=(1<<s.lenbits)-1,L=(1<<s.distbits)-1;e:do{_<15&&(C+=g[r++]<<_,_+=8,C+=g[r++]<<_,_+=8),D=S[C&x];t:for(;;){if(C>>>=R=D>>>24,_-=R,(R=D>>>16&255)===0)H[h++]=65535&D;else{if(!(16&R)){if(!(64&R)){D=S[(65535&D)+(C&(1<<R)-1)];continue t}if(32&R){s.mode=12;break e}n.msg="invalid literal/length code",s.mode=30;break e}P=65535&D,(R&=15)&&(_<R&&(C+=g[r++]<<_,_+=8),P+=C&(1<<R)-1,C>>>=R,_-=R),_<15&&(C+=g[r++]<<_,_+=8,C+=g[r++]<<_,_+=8),D=I[C&L];n:for(;;){if(C>>>=R=D>>>24,_-=R,!(16&(R=D>>>16&255))){if(!(64&R)){D=I[(65535&D)+(C&(1<<R)-1)];continue n}n.msg="invalid distance code",s.mode=30;break e}if(Q=65535&D,_<(R&=15)&&(C+=g[r++]<<_,(_+=8)<R&&(C+=g[r++]<<_,_+=8)),u<(Q+=C&(1<<R)-1)){n.msg="invalid distance too far back",s.mode=30;break e}if(C>>>=R,_-=R,(R=h-p)<Q){if(m<(R=Q-R)&&s.sane){n.msg="invalid distance too far back",s.mode=30;break e}if(z=b,(k=0)===v){if(k+=y-R,R<P){for(P-=R;H[h++]=b[k++],--R;);k=h-Q,z=H}}else if(v<R){if(k+=y+v-R,(R-=v)<P){for(P-=R;H[h++]=b[k++],--R;);if(k=0,v<P){for(P-=R=v;H[h++]=b[k++],--R;);k=h-Q,z=H}}}else if(k+=v-R,R<P){for(P-=R;H[h++]=b[k++],--R;);k=h-Q,z=H}for(;2<P;)H[h++]=z[k++],H[h++]=z[k++],H[h++]=z[k++],P-=3;P&&(H[h++]=z[k++],1<P&&(H[h++]=z[k++]))}else{for(k=h-Q;H[h++]=H[k++],H[h++]=H[k++],H[h++]=H[k++],2<(P-=3););P&&(H[h++]=H[k++],1<P&&(H[h++]=H[k++]))}break}}break}}while(r<l&&h<f);r-=P=_>>3,C&=(1<<(_-=P<<3))-1,n.next_in=r,n.next_out=h,n.avail_in=r<l?l-r+5:5-(r-l),n.avail_out=h<f?f-h+257:257-(h-f),s.hold=C,s.bits=_}},{}],49:[function(e,c,o){var n=e("../utils/common"),i=e("./adler32"),s=e("./crc32"),r=e("./inffast"),l=e("./inftrees"),h=1,p=2,f=0,u=-2,y=1,m=852,v=592;function b(k){return(k>>>24&255)+(k>>>8&65280)+((65280&k)<<8)+((255&k)<<24)}function C(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new n.Buf16(320),this.work=new n.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function _(k){var z;return k&&k.state?(z=k.state,k.total_in=k.total_out=z.total=0,k.msg="",z.wrap&&(k.adler=1&z.wrap),z.mode=y,z.last=0,z.havedict=0,z.dmax=32768,z.head=null,z.hold=0,z.bits=0,z.lencode=z.lendyn=new n.Buf32(m),z.distcode=z.distdyn=new n.Buf32(v),z.sane=1,z.back=-1,f):u}function S(k){var z;return k&&k.state?((z=k.state).wsize=0,z.whave=0,z.wnext=0,_(k)):u}function I(k,z){var g,H;return k&&k.state?(H=k.state,z<0?(g=0,z=-z):(g=1+(z>>4),z<48&&(z&=15)),z&&(z<8||15<z)?u:(H.window!==null&&H.wbits!==z&&(H.window=null),H.wrap=g,H.wbits=z,S(k))):u}function x(k,z){var g,H;return k?(H=new C,(k.state=H).window=null,(g=I(k,z))!==f&&(k.state=null),g):u}var L,D,R=!0;function P(k){if(R){var z;for(L=new n.Buf32(512),D=new n.Buf32(32),z=0;z<144;)k.lens[z++]=8;for(;z<256;)k.lens[z++]=9;for(;z<280;)k.lens[z++]=7;for(;z<288;)k.lens[z++]=8;for(l(h,k.lens,0,288,L,0,k.work,{bits:9}),z=0;z<32;)k.lens[z++]=5;l(p,k.lens,0,32,D,0,k.work,{bits:5}),R=!1}k.lencode=L,k.lenbits=9,k.distcode=D,k.distbits=5}function Q(k,z,g,H){var ue,j=k.state;return j.window===null&&(j.wsize=1<<j.wbits,j.wnext=0,j.whave=0,j.window=new n.Buf8(j.wsize)),H>=j.wsize?(n.arraySet(j.window,z,g-j.wsize,j.wsize,0),j.wnext=0,j.whave=j.wsize):(H<(ue=j.wsize-j.wnext)&&(ue=H),n.arraySet(j.window,z,g-H,ue,j.wnext),(H-=ue)?(n.arraySet(j.window,z,g-H,H,0),j.wnext=H,j.whave=j.wsize):(j.wnext+=ue,j.wnext===j.wsize&&(j.wnext=0),j.whave<j.wsize&&(j.whave+=ue))),0}o.inflateReset=S,o.inflateReset2=I,o.inflateResetKeep=_,o.inflateInit=function(k){return x(k,15)},o.inflateInit2=x,o.inflate=function(k,z){var g,H,ue,j,fe,F,ne,O,M,oe,te,X,Ne,Oe,he,Ce,Te,Ae,Ye,Xe,d,W,$,E,w=0,T=new n.Buf8(4),q=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!k||!k.state||!k.output||!k.input&&k.avail_in!==0)return u;(g=k.state).mode===12&&(g.mode=13),fe=k.next_out,ue=k.output,ne=k.avail_out,j=k.next_in,H=k.input,F=k.avail_in,O=g.hold,M=g.bits,oe=F,te=ne,W=f;e:for(;;)switch(g.mode){case y:if(g.wrap===0){g.mode=13;break}for(;M<16;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(2&g.wrap&&O===35615){T[g.check=0]=255&O,T[1]=O>>>8&255,g.check=s(g.check,T,2,0),M=O=0,g.mode=2;break}if(g.flags=0,g.head&&(g.head.done=!1),!(1&g.wrap)||(((255&O)<<8)+(O>>8))%31){k.msg="incorrect header check",g.mode=30;break}if((15&O)!=8){k.msg="unknown compression method",g.mode=30;break}if(M-=4,d=8+(15&(O>>>=4)),g.wbits===0)g.wbits=d;else if(d>g.wbits){k.msg="invalid window size",g.mode=30;break}g.dmax=1<<d,k.adler=g.check=1,g.mode=512&O?10:12,M=O=0;break;case 2:for(;M<16;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(g.flags=O,(255&g.flags)!=8){k.msg="unknown compression method",g.mode=30;break}if(57344&g.flags){k.msg="unknown header flags set",g.mode=30;break}g.head&&(g.head.text=O>>8&1),512&g.flags&&(T[0]=255&O,T[1]=O>>>8&255,g.check=s(g.check,T,2,0)),M=O=0,g.mode=3;case 3:for(;M<32;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}g.head&&(g.head.time=O),512&g.flags&&(T[0]=255&O,T[1]=O>>>8&255,T[2]=O>>>16&255,T[3]=O>>>24&255,g.check=s(g.check,T,4,0)),M=O=0,g.mode=4;case 4:for(;M<16;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}g.head&&(g.head.xflags=255&O,g.head.os=O>>8),512&g.flags&&(T[0]=255&O,T[1]=O>>>8&255,g.check=s(g.check,T,2,0)),M=O=0,g.mode=5;case 5:if(1024&g.flags){for(;M<16;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}g.length=O,g.head&&(g.head.extra_len=O),512&g.flags&&(T[0]=255&O,T[1]=O>>>8&255,g.check=s(g.check,T,2,0)),M=O=0}else g.head&&(g.head.extra=null);g.mode=6;case 6:if(1024&g.flags&&(F<(X=g.length)&&(X=F),X&&(g.head&&(d=g.head.extra_len-g.length,g.head.extra||(g.head.extra=new Array(g.head.extra_len)),n.arraySet(g.head.extra,H,j,X,d)),512&g.flags&&(g.check=s(g.check,H,X,j)),F-=X,j+=X,g.length-=X),g.length))break e;g.length=0,g.mode=7;case 7:if(2048&g.flags){if(F===0)break e;for(X=0;d=H[j+X++],g.head&&d&&g.length<65536&&(g.head.name+=String.fromCharCode(d)),d&&X<F;);if(512&g.flags&&(g.check=s(g.check,H,X,j)),F-=X,j+=X,d)break e}else g.head&&(g.head.name=null);g.length=0,g.mode=8;case 8:if(4096&g.flags){if(F===0)break e;for(X=0;d=H[j+X++],g.head&&d&&g.length<65536&&(g.head.comment+=String.fromCharCode(d)),d&&X<F;);if(512&g.flags&&(g.check=s(g.check,H,X,j)),F-=X,j+=X,d)break e}else g.head&&(g.head.comment=null);g.mode=9;case 9:if(512&g.flags){for(;M<16;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(O!==(65535&g.check)){k.msg="header crc mismatch",g.mode=30;break}M=O=0}g.head&&(g.head.hcrc=g.flags>>9&1,g.head.done=!0),k.adler=g.check=0,g.mode=12;break;case 10:for(;M<32;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}k.adler=g.check=b(O),M=O=0,g.mode=11;case 11:if(g.havedict===0)return k.next_out=fe,k.avail_out=ne,k.next_in=j,k.avail_in=F,g.hold=O,g.bits=M,2;k.adler=g.check=1,g.mode=12;case 12:if(z===5||z===6)break e;case 13:if(g.last){O>>>=7&M,M-=7&M,g.mode=27;break}for(;M<3;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}switch(g.last=1&O,M-=1,3&(O>>>=1)){case 0:g.mode=14;break;case 1:if(P(g),g.mode=20,z!==6)break;O>>>=2,M-=2;break e;case 2:g.mode=17;break;case 3:k.msg="invalid block type",g.mode=30}O>>>=2,M-=2;break;case 14:for(O>>>=7&M,M-=7&M;M<32;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if((65535&O)!=(O>>>16^65535)){k.msg="invalid stored block lengths",g.mode=30;break}if(g.length=65535&O,M=O=0,g.mode=15,z===6)break e;case 15:g.mode=16;case 16:if(X=g.length){if(F<X&&(X=F),ne<X&&(X=ne),X===0)break e;n.arraySet(ue,H,j,X,fe),F-=X,j+=X,ne-=X,fe+=X,g.length-=X;break}g.mode=12;break;case 17:for(;M<14;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(g.nlen=257+(31&O),O>>>=5,M-=5,g.ndist=1+(31&O),O>>>=5,M-=5,g.ncode=4+(15&O),O>>>=4,M-=4,286<g.nlen||30<g.ndist){k.msg="too many length or distance symbols",g.mode=30;break}g.have=0,g.mode=18;case 18:for(;g.have<g.ncode;){for(;M<3;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}g.lens[q[g.have++]]=7&O,O>>>=3,M-=3}for(;g.have<19;)g.lens[q[g.have++]]=0;if(g.lencode=g.lendyn,g.lenbits=7,$={bits:g.lenbits},W=l(0,g.lens,0,19,g.lencode,0,g.work,$),g.lenbits=$.bits,W){k.msg="invalid code lengths set",g.mode=30;break}g.have=0,g.mode=19;case 19:for(;g.have<g.nlen+g.ndist;){for(;Ce=(w=g.lencode[O&(1<<g.lenbits)-1])>>>16&255,Te=65535&w,!((he=w>>>24)<=M);){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(Te<16)O>>>=he,M-=he,g.lens[g.have++]=Te;else{if(Te===16){for(E=he+2;M<E;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(O>>>=he,M-=he,g.have===0){k.msg="invalid bit length repeat",g.mode=30;break}d=g.lens[g.have-1],X=3+(3&O),O>>>=2,M-=2}else if(Te===17){for(E=he+3;M<E;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}M-=he,d=0,X=3+(7&(O>>>=he)),O>>>=3,M-=3}else{for(E=he+7;M<E;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}M-=he,d=0,X=11+(127&(O>>>=he)),O>>>=7,M-=7}if(g.have+X>g.nlen+g.ndist){k.msg="invalid bit length repeat",g.mode=30;break}for(;X--;)g.lens[g.have++]=d}}if(g.mode===30)break;if(g.lens[256]===0){k.msg="invalid code -- missing end-of-block",g.mode=30;break}if(g.lenbits=9,$={bits:g.lenbits},W=l(h,g.lens,0,g.nlen,g.lencode,0,g.work,$),g.lenbits=$.bits,W){k.msg="invalid literal/lengths set",g.mode=30;break}if(g.distbits=6,g.distcode=g.distdyn,$={bits:g.distbits},W=l(p,g.lens,g.nlen,g.ndist,g.distcode,0,g.work,$),g.distbits=$.bits,W){k.msg="invalid distances set",g.mode=30;break}if(g.mode=20,z===6)break e;case 20:g.mode=21;case 21:if(6<=F&&258<=ne){k.next_out=fe,k.avail_out=ne,k.next_in=j,k.avail_in=F,g.hold=O,g.bits=M,r(k,te),fe=k.next_out,ue=k.output,ne=k.avail_out,j=k.next_in,H=k.input,F=k.avail_in,O=g.hold,M=g.bits,g.mode===12&&(g.back=-1);break}for(g.back=0;Ce=(w=g.lencode[O&(1<<g.lenbits)-1])>>>16&255,Te=65535&w,!((he=w>>>24)<=M);){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(Ce&&!(240&Ce)){for(Ae=he,Ye=Ce,Xe=Te;Ce=(w=g.lencode[Xe+((O&(1<<Ae+Ye)-1)>>Ae)])>>>16&255,Te=65535&w,!(Ae+(he=w>>>24)<=M);){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}O>>>=Ae,M-=Ae,g.back+=Ae}if(O>>>=he,M-=he,g.back+=he,g.length=Te,Ce===0){g.mode=26;break}if(32&Ce){g.back=-1,g.mode=12;break}if(64&Ce){k.msg="invalid literal/length code",g.mode=30;break}g.extra=15&Ce,g.mode=22;case 22:if(g.extra){for(E=g.extra;M<E;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}g.length+=O&(1<<g.extra)-1,O>>>=g.extra,M-=g.extra,g.back+=g.extra}g.was=g.length,g.mode=23;case 23:for(;Ce=(w=g.distcode[O&(1<<g.distbits)-1])>>>16&255,Te=65535&w,!((he=w>>>24)<=M);){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(!(240&Ce)){for(Ae=he,Ye=Ce,Xe=Te;Ce=(w=g.distcode[Xe+((O&(1<<Ae+Ye)-1)>>Ae)])>>>16&255,Te=65535&w,!(Ae+(he=w>>>24)<=M);){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}O>>>=Ae,M-=Ae,g.back+=Ae}if(O>>>=he,M-=he,g.back+=he,64&Ce){k.msg="invalid distance code",g.mode=30;break}g.offset=Te,g.extra=15&Ce,g.mode=24;case 24:if(g.extra){for(E=g.extra;M<E;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}g.offset+=O&(1<<g.extra)-1,O>>>=g.extra,M-=g.extra,g.back+=g.extra}if(g.offset>g.dmax){k.msg="invalid distance too far back",g.mode=30;break}g.mode=25;case 25:if(ne===0)break e;if(X=te-ne,g.offset>X){if((X=g.offset-X)>g.whave&&g.sane){k.msg="invalid distance too far back",g.mode=30;break}Ne=X>g.wnext?(X-=g.wnext,g.wsize-X):g.wnext-X,X>g.length&&(X=g.length),Oe=g.window}else Oe=ue,Ne=fe-g.offset,X=g.length;for(ne<X&&(X=ne),ne-=X,g.length-=X;ue[fe++]=Oe[Ne++],--X;);g.length===0&&(g.mode=21);break;case 26:if(ne===0)break e;ue[fe++]=g.length,ne--,g.mode=21;break;case 27:if(g.wrap){for(;M<32;){if(F===0)break e;F--,O|=H[j++]<<M,M+=8}if(te-=ne,k.total_out+=te,g.total+=te,te&&(k.adler=g.check=g.flags?s(g.check,ue,te,fe-te):i(g.check,ue,te,fe-te)),te=ne,(g.flags?O:b(O))!==g.check){k.msg="incorrect data check",g.mode=30;break}M=O=0}g.mode=28;case 28:if(g.wrap&&g.flags){for(;M<32;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(O!==(4294967295&g.total)){k.msg="incorrect length check",g.mode=30;break}M=O=0}g.mode=29;case 29:W=1;break e;case 30:W=-3;break e;case 31:return-4;case 32:default:return u}return k.next_out=fe,k.avail_out=ne,k.next_in=j,k.avail_in=F,g.hold=O,g.bits=M,(g.wsize||te!==k.avail_out&&g.mode<30&&(g.mode<27||z!==4))&&Q(k,k.output,k.next_out,te-k.avail_out)?(g.mode=31,-4):(oe-=k.avail_in,te-=k.avail_out,k.total_in+=oe,k.total_out+=te,g.total+=te,g.wrap&&te&&(k.adler=g.check=g.flags?s(g.check,ue,te,k.next_out-te):i(g.check,ue,te,k.next_out-te)),k.data_type=g.bits+(g.last?64:0)+(g.mode===12?128:0)+(g.mode===20||g.mode===15?256:0),(oe==0&&te===0||z===4)&&W===f&&(W=-5),W)},o.inflateEnd=function(k){if(!k||!k.state)return u;var z=k.state;return z.window&&(z.window=null),k.state=null,f},o.inflateGetHeader=function(k,z){var g;return k&&k.state&&2&(g=k.state).wrap?((g.head=z).done=!1,f):u},o.inflateSetDictionary=function(k,z){var g,H=z.length;return k&&k.state?(g=k.state).wrap!==0&&g.mode!==11?u:g.mode===11&&i(1,z,H,0)!==g.check?-3:Q(k,z,H,H)?(g.mode=31,-4):(g.havedict=1,f):u},o.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(e,c,o){var n=e("../utils/common"),i=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],s=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],r=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],l=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];c.exports=function(h,p,f,u,y,m,v,b){var C,_,S,I,x,L,D,R,P,Q=b.bits,k=0,z=0,g=0,H=0,ue=0,j=0,fe=0,F=0,ne=0,O=0,M=null,oe=0,te=new n.Buf16(16),X=new n.Buf16(16),Ne=null,Oe=0;for(k=0;k<=15;k++)te[k]=0;for(z=0;z<u;z++)te[p[f+z]]++;for(ue=Q,H=15;1<=H&&te[H]===0;H--);if(H<ue&&(ue=H),H===0)return y[m++]=20971520,y[m++]=20971520,b.bits=1,0;for(g=1;g<H&&te[g]===0;g++);for(ue<g&&(ue=g),k=F=1;k<=15;k++)if(F<<=1,(F-=te[k])<0)return-1;if(0<F&&(h===0||H!==1))return-1;for(X[1]=0,k=1;k<15;k++)X[k+1]=X[k]+te[k];for(z=0;z<u;z++)p[f+z]!==0&&(v[X[p[f+z]]++]=z);if(L=h===0?(M=Ne=v,19):h===1?(M=i,oe-=257,Ne=s,Oe-=257,256):(M=r,Ne=l,-1),k=g,x=m,fe=z=O=0,S=-1,I=(ne=1<<(j=ue))-1,h===1&&852<ne||h===2&&592<ne)return 1;for(;;){for(D=k-fe,P=v[z]<L?(R=0,v[z]):v[z]>L?(R=Ne[Oe+v[z]],M[oe+v[z]]):(R=96,0),C=1<<k-fe,g=_=1<<j;y[x+(O>>fe)+(_-=C)]=D<<24|R<<16|P|0,_!==0;);for(C=1<<k-1;O&C;)C>>=1;if(C!==0?(O&=C-1,O+=C):O=0,z++,--te[k]==0){if(k===H)break;k=p[f+v[z]]}if(ue<k&&(O&I)!==S){for(fe===0&&(fe=ue),x+=g,F=1<<(j=k-fe);j+fe<H&&!((F-=te[j+fe])<=0);)j++,F<<=1;if(ne+=1<<j,h===1&&852<ne||h===2&&592<ne)return 1;y[S=O&I]=ue<<24|j<<16|x-m|0}}return O!==0&&(y[x+O]=k-fe<<24|64<<16|0),b.bits=ue,0}},{"../utils/common":41}],51:[function(e,c,o){c.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(e,c,o){var n=e("../utils/common"),i=0,s=1;function r(w){for(var T=w.length;0<=--T;)w[T]=0}var l=0,h=29,p=256,f=p+1+h,u=30,y=19,m=2*f+1,v=15,b=16,C=7,_=256,S=16,I=17,x=18,L=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],D=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],R=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],P=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Q=new Array(2*(f+2));r(Q);var k=new Array(2*u);r(k);var z=new Array(512);r(z);var g=new Array(256);r(g);var H=new Array(h);r(H);var ue,j,fe,F=new Array(u);function ne(w,T,q,G,A){this.static_tree=w,this.extra_bits=T,this.extra_base=q,this.elems=G,this.max_length=A,this.has_stree=w&&w.length}function O(w,T){this.dyn_tree=w,this.max_code=0,this.stat_desc=T}function M(w){return w<256?z[w]:z[256+(w>>>7)]}function oe(w,T){w.pending_buf[w.pending++]=255&T,w.pending_buf[w.pending++]=T>>>8&255}function te(w,T,q){w.bi_valid>b-q?(w.bi_buf|=T<<w.bi_valid&65535,oe(w,w.bi_buf),w.bi_buf=T>>b-w.bi_valid,w.bi_valid+=q-b):(w.bi_buf|=T<<w.bi_valid&65535,w.bi_valid+=q)}function X(w,T,q){te(w,q[2*T],q[2*T+1])}function Ne(w,T){for(var q=0;q|=1&w,w>>>=1,q<<=1,0<--T;);return q>>>1}function Oe(w,T,q){var G,A,V=new Array(v+1),ie=0;for(G=1;G<=v;G++)V[G]=ie=ie+q[G-1]<<1;for(A=0;A<=T;A++){var K=w[2*A+1];K!==0&&(w[2*A]=Ne(V[K]++,K))}}function he(w){var T;for(T=0;T<f;T++)w.dyn_ltree[2*T]=0;for(T=0;T<u;T++)w.dyn_dtree[2*T]=0;for(T=0;T<y;T++)w.bl_tree[2*T]=0;w.dyn_ltree[2*_]=1,w.opt_len=w.static_len=0,w.last_lit=w.matches=0}function Ce(w){8<w.bi_valid?oe(w,w.bi_buf):0<w.bi_valid&&(w.pending_buf[w.pending++]=w.bi_buf),w.bi_buf=0,w.bi_valid=0}function Te(w,T,q,G){var A=2*T,V=2*q;return w[A]<w[V]||w[A]===w[V]&&G[T]<=G[q]}function Ae(w,T,q){for(var G=w.heap[q],A=q<<1;A<=w.heap_len&&(A<w.heap_len&&Te(T,w.heap[A+1],w.heap[A],w.depth)&&A++,!Te(T,G,w.heap[A],w.depth));)w.heap[q]=w.heap[A],q=A,A<<=1;w.heap[q]=G}function Ye(w,T,q){var G,A,V,ie,K=0;if(w.last_lit!==0)for(;G=w.pending_buf[w.d_buf+2*K]<<8|w.pending_buf[w.d_buf+2*K+1],A=w.pending_buf[w.l_buf+K],K++,G===0?X(w,A,T):(X(w,(V=g[A])+p+1,T),(ie=L[V])!==0&&te(w,A-=H[V],ie),X(w,V=M(--G),q),(ie=D[V])!==0&&te(w,G-=F[V],ie)),K<w.last_lit;);X(w,_,T)}function Xe(w,T){var q,G,A,V=T.dyn_tree,ie=T.stat_desc.static_tree,K=T.stat_desc.has_stree,le=T.stat_desc.elems,Le=-1;for(w.heap_len=0,w.heap_max=m,q=0;q<le;q++)V[2*q]!==0?(w.heap[++w.heap_len]=Le=q,w.depth[q]=0):V[2*q+1]=0;for(;w.heap_len<2;)V[2*(A=w.heap[++w.heap_len]=Le<2?++Le:0)]=1,w.depth[A]=0,w.opt_len--,K&&(w.static_len-=ie[2*A+1]);for(T.max_code=Le,q=w.heap_len>>1;1<=q;q--)Ae(w,V,q);for(A=le;q=w.heap[1],w.heap[1]=w.heap[w.heap_len--],Ae(w,V,1),G=w.heap[1],w.heap[--w.heap_max]=q,w.heap[--w.heap_max]=G,V[2*A]=V[2*q]+V[2*G],w.depth[A]=(w.depth[q]>=w.depth[G]?w.depth[q]:w.depth[G])+1,V[2*q+1]=V[2*G+1]=A,w.heap[1]=A++,Ae(w,V,1),2<=w.heap_len;);w.heap[--w.heap_max]=w.heap[1],function(ye,je){var mt,nt,ht,be,Ct,un,Qe=je.dyn_tree,Wt=je.max_code,Kn=je.stat_desc.static_tree,Yn=je.stat_desc.has_stree,Xn=je.stat_desc.extra_bits,fn=je.stat_desc.extra_base,wt=je.stat_desc.max_length,Tt=0;for(be=0;be<=v;be++)ye.bl_count[be]=0;for(Qe[2*ye.heap[ye.heap_max]+1]=0,mt=ye.heap_max+1;mt<m;mt++)wt<(be=Qe[2*Qe[2*(nt=ye.heap[mt])+1]+1]+1)&&(be=wt,Tt++),Qe[2*nt+1]=be,Wt<nt||(ye.bl_count[be]++,Ct=0,fn<=nt&&(Ct=Xn[nt-fn]),un=Qe[2*nt],ye.opt_len+=un*(be+Ct),Yn&&(ye.static_len+=un*(Kn[2*nt+1]+Ct)));if(Tt!==0){do{for(be=wt-1;ye.bl_count[be]===0;)be--;ye.bl_count[be]--,ye.bl_count[be+1]+=2,ye.bl_count[wt]--,Tt-=2}while(0<Tt);for(be=wt;be!==0;be--)for(nt=ye.bl_count[be];nt!==0;)Wt<(ht=ye.heap[--mt])||(Qe[2*ht+1]!==be&&(ye.opt_len+=(be-Qe[2*ht+1])*Qe[2*ht],Qe[2*ht+1]=be),nt--)}}(w,T),Oe(V,Le,w.bl_count)}function d(w,T,q){var G,A,V=-1,ie=T[1],K=0,le=7,Le=4;for(ie===0&&(le=138,Le=3),T[2*(q+1)+1]=65535,G=0;G<=q;G++)A=ie,ie=T[2*(G+1)+1],++K<le&&A===ie||(K<Le?w.bl_tree[2*A]+=K:A!==0?(A!==V&&w.bl_tree[2*A]++,w.bl_tree[2*S]++):K<=10?w.bl_tree[2*I]++:w.bl_tree[2*x]++,V=A,Le=(K=0)===ie?(le=138,3):A===ie?(le=6,3):(le=7,4))}function W(w,T,q){var G,A,V=-1,ie=T[1],K=0,le=7,Le=4;for(ie===0&&(le=138,Le=3),G=0;G<=q;G++)if(A=ie,ie=T[2*(G+1)+1],!(++K<le&&A===ie)){if(K<Le)for(;X(w,A,w.bl_tree),--K!=0;);else A!==0?(A!==V&&(X(w,A,w.bl_tree),K--),X(w,S,w.bl_tree),te(w,K-3,2)):K<=10?(X(w,I,w.bl_tree),te(w,K-3,3)):(X(w,x,w.bl_tree),te(w,K-11,7));V=A,Le=(K=0)===ie?(le=138,3):A===ie?(le=6,3):(le=7,4)}}r(F);var $=!1;function E(w,T,q,G){te(w,(l<<1)+(G?1:0),3),function(A,V,ie,K){Ce(A),oe(A,ie),oe(A,~ie),n.arraySet(A.pending_buf,A.window,V,ie,A.pending),A.pending+=ie}(w,T,q)}o._tr_init=function(w){$||(function(){var T,q,G,A,V,ie=new Array(v+1);for(A=G=0;A<h-1;A++)for(H[A]=G,T=0;T<1<<L[A];T++)g[G++]=A;for(g[G-1]=A,A=V=0;A<16;A++)for(F[A]=V,T=0;T<1<<D[A];T++)z[V++]=A;for(V>>=7;A<u;A++)for(F[A]=V<<7,T=0;T<1<<D[A]-7;T++)z[256+V++]=A;for(q=0;q<=v;q++)ie[q]=0;for(T=0;T<=143;)Q[2*T+1]=8,T++,ie[8]++;for(;T<=255;)Q[2*T+1]=9,T++,ie[9]++;for(;T<=279;)Q[2*T+1]=7,T++,ie[7]++;for(;T<=287;)Q[2*T+1]=8,T++,ie[8]++;for(Oe(Q,f+1,ie),T=0;T<u;T++)k[2*T+1]=5,k[2*T]=Ne(T,5);ue=new ne(Q,L,p+1,f,v),j=new ne(k,D,0,u,v),fe=new ne(new Array(0),R,0,y,C)}(),$=!0),w.l_desc=new O(w.dyn_ltree,ue),w.d_desc=new O(w.dyn_dtree,j),w.bl_desc=new O(w.bl_tree,fe),w.bi_buf=0,w.bi_valid=0,he(w)},o._tr_stored_block=E,o._tr_flush_block=function(w,T,q,G){var A,V,ie=0;0<w.level?(w.strm.data_type===2&&(w.strm.data_type=function(K){var le,Le=4093624447;for(le=0;le<=31;le++,Le>>>=1)if(1&Le&&K.dyn_ltree[2*le]!==0)return i;if(K.dyn_ltree[18]!==0||K.dyn_ltree[20]!==0||K.dyn_ltree[26]!==0)return s;for(le=32;le<p;le++)if(K.dyn_ltree[2*le]!==0)return s;return i}(w)),Xe(w,w.l_desc),Xe(w,w.d_desc),ie=function(K){var le;for(d(K,K.dyn_ltree,K.l_desc.max_code),d(K,K.dyn_dtree,K.d_desc.max_code),Xe(K,K.bl_desc),le=y-1;3<=le&&K.bl_tree[2*P[le]+1]===0;le--);return K.opt_len+=3*(le+1)+5+5+4,le}(w),A=w.opt_len+3+7>>>3,(V=w.static_len+3+7>>>3)<=A&&(A=V)):A=V=q+5,q+4<=A&&T!==-1?E(w,T,q,G):w.strategy===4||V===A?(te(w,2+(G?1:0),3),Ye(w,Q,k)):(te(w,4+(G?1:0),3),function(K,le,Le,ye){var je;for(te(K,le-257,5),te(K,Le-1,5),te(K,ye-4,4),je=0;je<ye;je++)te(K,K.bl_tree[2*P[je]+1],3);W(K,K.dyn_ltree,le-1),W(K,K.dyn_dtree,Le-1)}(w,w.l_desc.max_code+1,w.d_desc.max_code+1,ie+1),Ye(w,w.dyn_ltree,w.dyn_dtree)),he(w),G&&Ce(w)},o._tr_tally=function(w,T,q){return w.pending_buf[w.d_buf+2*w.last_lit]=T>>>8&255,w.pending_buf[w.d_buf+2*w.last_lit+1]=255&T,w.pending_buf[w.l_buf+w.last_lit]=255&q,w.last_lit++,T===0?w.dyn_ltree[2*q]++:(w.matches++,T--,w.dyn_ltree[2*(g[q]+p+1)]++,w.dyn_dtree[2*M(T)]++),w.last_lit===w.lit_bufsize-1},o._tr_align=function(w){te(w,2,3),X(w,_,Q),function(T){T.bi_valid===16?(oe(T,T.bi_buf),T.bi_buf=0,T.bi_valid=0):8<=T.bi_valid&&(T.pending_buf[T.pending++]=255&T.bi_buf,T.bi_buf>>=8,T.bi_valid-=8)}(w)}},{"../utils/common":41}],53:[function(e,c,o){c.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(e,c,o){(function(n){(function(i,s){if(!i.setImmediate){var r,l,h,p,f=1,u={},y=!1,m=i.document,v=Object.getPrototypeOf&&Object.getPrototypeOf(i);v=v&&v.setTimeout?v:i,r={}.toString.call(i.process)==="[object process]"?function(S){process.nextTick(function(){C(S)})}:function(){if(i.postMessage&&!i.importScripts){var S=!0,I=i.onmessage;return i.onmessage=function(){S=!1},i.postMessage("","*"),i.onmessage=I,S}}()?(p="setImmediate$"+Math.random()+"$",i.addEventListener?i.addEventListener("message",_,!1):i.attachEvent("onmessage",_),function(S){i.postMessage(p+S,"*")}):i.MessageChannel?((h=new MessageChannel).port1.onmessage=function(S){C(S.data)},function(S){h.port2.postMessage(S)}):m&&"onreadystatechange"in m.createElement("script")?(l=m.documentElement,function(S){var I=m.createElement("script");I.onreadystatechange=function(){C(S),I.onreadystatechange=null,l.removeChild(I),I=null},l.appendChild(I)}):function(S){setTimeout(C,0,S)},v.setImmediate=function(S){typeof S!="function"&&(S=new Function(""+S));for(var I=new Array(arguments.length-1),x=0;x<I.length;x++)I[x]=arguments[x+1];var L={callback:S,args:I};return u[f]=L,r(f),f++},v.clearImmediate=b}function b(S){delete u[S]}function C(S){if(y)setTimeout(C,0,S);else{var I=u[S];if(I){y=!0;try{(function(x){var L=x.callback,D=x.args;switch(D.length){case 0:L();break;case 1:L(D[0]);break;case 2:L(D[0],D[1]);break;case 3:L(D[0],D[1],D[2]);break;default:L.apply(s,D)}})(I)}finally{b(S),y=!1}}}}function _(S){S.source===i&&typeof S.data=="string"&&S.data.indexOf(p)===0&&C(+S.data.slice(p.length))}})(typeof self>"u"?n===void 0?this:n:self)}).call(this,typeof pn<"u"?pn:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(ri);var ya=ri.exports;const ks=ai(ya);var oi={exports:{}};(function(t){var a=function(){var e=String.fromCharCode,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",n={};function i(r,l){if(!n[r]){n[r]={};for(var h=0;h<r.length;h++)n[r][r.charAt(h)]=h}return n[r][l]}var s={compressToBase64:function(r){if(r==null)return"";var l=s._compress(r,6,function(h){return c.charAt(h)});switch(l.length%4){default:case 0:return l;case 1:return l+"===";case 2:return l+"==";case 3:return l+"="}},decompressFromBase64:function(r){return r==null?"":r==""?null:s._decompress(r.length,32,function(l){return i(c,r.charAt(l))})},compressToUTF16:function(r){return r==null?"":s._compress(r,15,function(l){return e(l+32)})+" "},decompressFromUTF16:function(r){return r==null?"":r==""?null:s._decompress(r.length,16384,function(l){return r.charCodeAt(l)-32})},compressToUint8Array:function(r){for(var l=s.compress(r),h=new Uint8Array(l.length*2),p=0,f=l.length;p<f;p++){var u=l.charCodeAt(p);h[p*2]=u>>>8,h[p*2+1]=u%256}return h},decompressFromUint8Array:function(r){if(r==null)return s.decompress(r);for(var l=new Array(r.length/2),h=0,p=l.length;h<p;h++)l[h]=r[h*2]*256+r[h*2+1];var f=[];return l.forEach(function(u){f.push(e(u))}),s.decompress(f.join(""))},compressToEncodedURIComponent:function(r){return r==null?"":s._compress(r,6,function(l){return o.charAt(l)})},decompressFromEncodedURIComponent:function(r){return r==null?"":r==""?null:(r=r.replace(/ /g,"+"),s._decompress(r.length,32,function(l){return i(o,r.charAt(l))}))},compress:function(r){return s._compress(r,16,function(l){return e(l)})},_compress:function(r,l,h){if(r==null)return"";var p,f,u={},y={},m="",v="",b="",C=2,_=3,S=2,I=[],x=0,L=0,D;for(D=0;D<r.length;D+=1)if(m=r.charAt(D),Object.prototype.hasOwnProperty.call(u,m)||(u[m]=_++,y[m]=!0),v=b+m,Object.prototype.hasOwnProperty.call(u,v))b=v;else{if(Object.prototype.hasOwnProperty.call(y,b)){if(b.charCodeAt(0)<256){for(p=0;p<S;p++)x=x<<1,L==l-1?(L=0,I.push(h(x)),x=0):L++;for(f=b.charCodeAt(0),p=0;p<8;p++)x=x<<1|f&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,f=f>>1}else{for(f=1,p=0;p<S;p++)x=x<<1|f,L==l-1?(L=0,I.push(h(x)),x=0):L++,f=0;for(f=b.charCodeAt(0),p=0;p<16;p++)x=x<<1|f&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,f=f>>1}C--,C==0&&(C=Math.pow(2,S),S++),delete y[b]}else for(f=u[b],p=0;p<S;p++)x=x<<1|f&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,f=f>>1;C--,C==0&&(C=Math.pow(2,S),S++),u[v]=_++,b=String(m)}if(b!==""){if(Object.prototype.hasOwnProperty.call(y,b)){if(b.charCodeAt(0)<256){for(p=0;p<S;p++)x=x<<1,L==l-1?(L=0,I.push(h(x)),x=0):L++;for(f=b.charCodeAt(0),p=0;p<8;p++)x=x<<1|f&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,f=f>>1}else{for(f=1,p=0;p<S;p++)x=x<<1|f,L==l-1?(L=0,I.push(h(x)),x=0):L++,f=0;for(f=b.charCodeAt(0),p=0;p<16;p++)x=x<<1|f&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,f=f>>1}C--,C==0&&(C=Math.pow(2,S),S++),delete y[b]}else for(f=u[b],p=0;p<S;p++)x=x<<1|f&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,f=f>>1;C--,C==0&&(C=Math.pow(2,S),S++)}for(f=2,p=0;p<S;p++)x=x<<1|f&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,f=f>>1;for(;;)if(x=x<<1,L==l-1){I.push(h(x));break}else L++;return I.join("")},decompress:function(r){return r==null?"":r==""?null:s._decompress(r.length,32768,function(l){return r.charCodeAt(l)})},_decompress:function(r,l,h){var p=[],f=4,u=4,y=3,m="",v=[],b,C,_,S,I,x,L,D={val:h(0),position:l,index:1};for(b=0;b<3;b+=1)p[b]=b;for(_=0,I=Math.pow(2,2),x=1;x!=I;)S=D.val&D.position,D.position>>=1,D.position==0&&(D.position=l,D.val=h(D.index++)),_|=(S>0?1:0)*x,x<<=1;switch(_){case 0:for(_=0,I=Math.pow(2,8),x=1;x!=I;)S=D.val&D.position,D.position>>=1,D.position==0&&(D.position=l,D.val=h(D.index++)),_|=(S>0?1:0)*x,x<<=1;L=e(_);break;case 1:for(_=0,I=Math.pow(2,16),x=1;x!=I;)S=D.val&D.position,D.position>>=1,D.position==0&&(D.position=l,D.val=h(D.index++)),_|=(S>0?1:0)*x,x<<=1;L=e(_);break;case 2:return""}for(p[3]=L,C=L,v.push(L);;){if(D.index>r)return"";for(_=0,I=Math.pow(2,y),x=1;x!=I;)S=D.val&D.position,D.position>>=1,D.position==0&&(D.position=l,D.val=h(D.index++)),_|=(S>0?1:0)*x,x<<=1;switch(L=_){case 0:for(_=0,I=Math.pow(2,8),x=1;x!=I;)S=D.val&D.position,D.position>>=1,D.position==0&&(D.position=l,D.val=h(D.index++)),_|=(S>0?1:0)*x,x<<=1;p[u++]=e(_),L=u-1,f--;break;case 1:for(_=0,I=Math.pow(2,16),x=1;x!=I;)S=D.val&D.position,D.position>>=1,D.position==0&&(D.position=l,D.val=h(D.index++)),_|=(S>0?1:0)*x,x<<=1;p[u++]=e(_),L=u-1,f--;break;case 2:return v.join("")}if(f==0&&(f=Math.pow(2,y),y++),p[L])m=p[L];else if(L===u)m=C+C.charAt(0);else return null;v.push(m),p[u++]=C+m.charAt(0),f--,C=m,f==0&&(f=Math.pow(2,y),y++)}}};return s}();t!=null?t.exports=a:typeof angular<"u"&&angular!=null&&angular.module("LZString",[]).factory("LZString",function(){return a})})(oi);var ba=oi.exports;const ci=ai(ba);function va(t){return new Worker("/assets/compression.worker-B3kqe_bR.js",{name:t==null?void 0:t.name})}let re={},N=null,Ss=null,J=null,Ie=null,nn=null,qn=null,Is=[],xn=null,xs=null,Ve=null,Ln=0,Ls=0,Tn=0,Ts=0,Bs=null,Ns=null,Bn=null,bt=null,qe=-1,Ds=null,Nn=null,Dn=null,An=null,li=null,di=null,lt=!1,pe=[],ct=[],xt=[],Ge={isScreenSaverEnabled:!0,lastRestoreTimestamp:null,lastBackupTimestamp:null},Nt=null;const As=new va;As.onmessage=t=>{const a=t.data;try{localStorage.setItem("teacherAssistantData_v2",a),console.log("Background save complete.")}catch(e){console.error("Background storage failed:",e)}};As.onerror=t=>{console.error("❌ Worker Communication Error:",t.message,t)};function ce(t=!1){if(lt)return;const e=JSON.stringify({classrooms:re,trashBin:pe,userSettings:Ge});if(t){Nt&&clearTimeout(Nt);try{const c=ci.compressToUTF16(e);localStorage.setItem("teacherAssistantData_v2",c),console.log("Immediate save complete.")}catch(c){console.error("Immediate save failed:",c)}return}Nt&&clearTimeout(Nt),Nt=setTimeout(()=>{As.postMessage(e),Nt=null},500)}function Ca(t){return new Promise((a,e)=>{const c=new FileReader;c.onerror=e,c.onload=()=>{a(c.result.split(",")[1])},c.readAsDataURL(t)})}async function ui(t=[]){const a={};if(t.length>0)t.forEach(l=>{re[l]&&(a[l]=re[l])});else for(const l in re)re[l].isDeleted||(a[l]=re[l]);const e={metadata:{version:"2.0-b64",createdAt:new Date().toISOString()},data:{classrooms:a,trashBin:pe}},c=JSON.stringify(e),o=new Date,n=new Intl.DateTimeFormat("fa-IR-u-nu-latn",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(o).reduce((l,h)=>(l[h.type]=h.value,l),{}),s=`${n.year.slice(-2)}-${n.month}-${n.day}_${n.hour}-${n.minute}`;let r;t.length===0?r=`SP_Full_${s}.txt`:t.length===1?r=`SP_${t[0].replace(/[<>:"/\\|?*]/g,"").replace(/\s+/g,"_")}_${s}.txt`:r=`SP_Selected-${t.length}_${s}.txt`;try{const l=new ks;l.file("backup.json",c);const h=await l.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:9}}),p=await Ca(h);return new File([p],r,{type:"text/plain"})}catch(l){return console.error("Error creating base64 backup file:",l),null}}function On(){const t=localStorage.getItem("teacherAssistantData_v2");if(!t)return;let a;try{const e=ci.decompressFromUTF16(t);e?a=JSON.parse(e):a=JSON.parse(t)}catch{console.log("Migration: Parsing legacy uncompressed data..."),a=JSON.parse(t)}a.classrooms!==void 0&&a.trashBin!==void 0?(Lt(a.classrooms),pe=a.trashBin||[],Ge={...Ge,...a.userSettings}):(Lt(a),wa())}function wa(){const t=[];Object.values(re).forEach(a=>{a.isDeleted?t.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:a.info.creationDate,type:"classroom",description:`کلاس «${a.info.name}»`,restoreData:{name:a.info.name}}):a.students.forEach(e=>{e.isDeleted&&t.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:e.identity.studentId.split("_")[1],type:"student",description:`دانش‌آموز «${e.identity.name}»`,restoreData:{studentId:e.identity.studentId,classroomName:a.info.name}})})}),pe.length===0&&t.length>0&&(pe=t,console.log(`Migrated ${t.length} previously deleted item(s) to the new trash bin.`),ce())}function fi(t){const a=new yn(t.identity);return a.isDeleted=t.isDeleted,a.statusCounters=t.statusCounters,a.logs=t.logs,a.logs.scores||(a.logs.scores={}),a.profile=t.profile,a.finalClassActivityScore=t.finalClassActivityScore,a.categoryCounts=t.categoryCounts||{},a.categoryIssues=t.categoryIssues||{},a.onboardingSession=t.onboardingSession||null,a}function Lt(t){re={};for(const a in t){const e=t[a];let c;e.info?c=e.info:c={...e,name:a};const o=new as(c);o.isDeleted=e.isDeleted,o.note=e.note||"",o.students=(e.students||[]).map(fi),o.sessions=(e.sessions||[]).map(n=>{const i=new ii(n.sessionNumber);i.isDeleted=n.isDeleted,i.note=n.note||"",i.startTime=new Date(n.startTime),i.createdAt=n.createdAt?new Date(n.createdAt):new Date(n.startTime),i.endTime=n.endTime?new Date(n.endTime):null,i.isFinished=n.isFinished,i.isMakeup=n.isMakeup,i.isCancelled=n.isCancelled||!1,i.studentRecords=n.studentRecords;for(const r in i.studentRecords){const l=i.studentRecords[r];l.homework&&!(l.homework instanceof is)&&(i.studentRecords[r].homework=new is(l.homework.status,l.homework.comment))}i.lastWinnerByCategory=n.lastWinnerByCategory,i.lastUsedCategoryId=n.lastUsedCategoryId,i.lastSelectedWinnerId=n.lastSelectedWinnerId;const s=n.winnerHistory||[];return i.winnerHistory=s.filter(r=>r&&r.winner).map(r=>({winner:o.students.find(h=>h.identity.studentId===r.winner.identity.studentId),categoryName:r.categoryName})).filter(r=>r.winner),i}),o.categories=(e.categories||[]).map(n=>{const i=new ft(n.name,n.description,n.isGradedCategory);return i.id=n.id,i.isDeleted=n.isDeleted,i}),o.futurePlans=e.futurePlans,re[a]=o}}function mi(t,a){if(a)Lt(t.data.classrooms),zs(t.data.trashBin||[]);else{const e=t.data.classrooms,c=t.data.trashBin||[],o=new Map;for(const i in re){const s=re[i];s.info&&s.info.scheduleCode&&o.set(s.info.scheduleCode,i)}for(const i in e){const s=e[i],r=s.info.scheduleCode;if(o.has(r)){const l=o.get(r);l!==s.info.name&&delete re[l],re[s.info.name]=s}else{let l=s.info.name;for(;re[l];)l=`${l} (Imported)`;l!==s.info.name&&(s.info.name=l),re[l]=s}}const n=new Set(pe.map(i=>i.id));c.forEach(i=>{n.has(i.id)||pe.push(i)}),Lt(re)}Kt({lastRestoreTimestamp:new Date().toISOString()}),ce()}function hi(t,a){if(re[a])return{success:!1,message:"کلاسی با این نام از قبل وجود دارد."};const e=re[t];return e?(e.info.name=a,re[a]=e,delete re[t],N===e&&He(e),{success:!0}):{success:!1,message:"کلاس مورد نظر یافت نشد."}}function pi(t,a,e){const c=e.trim();if(!c)return{success:!1,message:"نام دسته‌بندی نمی‌تواند خالی باشد."};if(t.categories.some(r=>r.id!==a.id&&!r.isDeleted&&r.name.toLowerCase()===c.toLowerCase()))return{success:!1,message:"دسته‌بندی دیگری با این نام وجود دارد."};const n=a.name,i=n.toLowerCase(),s=c.toLowerCase();return a.name=c,t.students.forEach(r=>{r.categoryCounts&&r.categoryCounts[n]!==void 0&&(r.categoryCounts[c]=r.categoryCounts[n],delete r.categoryCounts[n]),r.categoryIssues&&r.categoryIssues[n]!==void 0&&(r.categoryIssues[c]=r.categoryIssues[n],delete r.categoryIssues[n]),r.logs.scores&&r.logs.scores[i]&&(r.logs.scores[i].forEach(l=>l.skill=c),i!==s&&(r.logs.scores[s]=r.logs.scores[i],delete r.logs.scores[i]))}),t.sessions.forEach(r=>{r.lastWinnerByCategory&&r.lastWinnerByCategory[n]&&(r.lastWinnerByCategory[c]=r.lastWinnerByCategory[n],delete r.lastWinnerByCategory[n]),r.winnerHistory&&r.winnerHistory.forEach(l=>{l.categoryName===n&&(l.categoryName=c)})}),{success:!0}}function gi(t,a,e){if(ke(e.students).some(l=>l.identity.name.toLowerCase()===t.identity.name.toLowerCase()))return{success:!1,message:`دانش‌آموزی با نام «${t.identity.name}» از قبل در کلاس «${e.info.name}» وجود دارد.`};const o=JSON.parse(JSON.stringify(t)),n=fi(o),i=new Map;a.sessions.forEach(l=>{const h=l.studentRecords[t.identity.studentId];h&&i.set(l.sessionNumber,JSON.parse(JSON.stringify(h)))}),e.addStudent(n);try{const l=ke(e.sessions).filter(v=>!v.isCancelled).sort((v,b)=>b.sessionNumber-v.sessionNumber),h=l.length>0?l[0]:null;let p="؟",f={type:"system",description:"Student Move"};h&&(p=tt(e).get(h.sessionNumber)||h.sessionNumber,f={type:"fromSession",sessionNumber:h.sessionNumber});const u=new Date().toLocaleDateString("fa-IR"),y=a.info.name,m=`این دانش آموز در جلسه ${p} و در تاریخ ${u} از کلاس «${y}» به این کلاس انتقال پیدا کرد`;n.addNote(m,f)}catch(l){console.error("Failed to add automated move note:",l)}i.size>0&&e.sessions.forEach(l=>{const h=i.get(l.sessionNumber);h&&!l.isDeleted&&!l.isCancelled&&(l.studentRecords[n.identity.studentId]=h)});const s={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`(انتقال) دانش‌آموز «${t.identity.name}» از کلاس «${a.info.name}»`,restoreData:{studentId:t.identity.studentId,classId:a.info.scheduleCode}};pe.unshift(s),pe.length>50&&pe.pop();const r=a.students.find(l=>l.identity.studentId===t.identity.studentId);return r&&(r.isDeleted=!0),{success:!0}}function yi(){for(const t in re){const a=re[t];a.students.forEach(e=>{e.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0},e.categoryCounts={},e.categoryIssues={},a.sessions.forEach(c=>{const o=e.identity.studentId;c.studentRecords[o]&&(c.studentRecords[o].attendance="present")})})}ce()}function ke(t){return Array.isArray(t)?t.filter(a=>!a.isDeleted):[]}function tt(t){const a=new Map;return t&&ke(t.sessions).filter(c=>!c.isCancelled).sort((c,o)=>c.sessionNumber-o.sessionNumber).forEach((c,o)=>{a.set(c.sessionNumber,o+1)}),a}function vt(t){qe=t}function rt(t){Ds=t}function Mn(t,a){if(!t||!a)return;const e=t.identity.studentId,c=a.students.findIndex(o=>o.identity.studentId===e);c>-1&&a.students.splice(c,1),a.sessions.forEach(o=>{o.studentRecords[e]&&delete o.studentRecords[e];for(const n in o.lastWinnerByCategory)o.lastWinnerByCategory[n]===e&&delete o.lastWinnerByCategory[n];o.lastSelectedWinnerId===e&&(o.lastSelectedWinnerId=null),o.winnerHistory=o.winnerHistory.filter(n=>n.winner&&n.winner.identity.studentId!==e)})}function bi(t,a){const e=re[t];if(!e)return;const c=e.sessions.findIndex(o=>o.sessionNumber===a);c>-1&&(e.students.forEach(o=>{o.profile.notes&&o.profile.notes.length>0&&(o.profile.notes=o.profile.notes.filter(n=>!n.source||n.source.type!=="fromAttendance"||n.source.sessionNumber!==a)),o.onboardingSession===a&&(o.onboardingSession=null)}),e.sessions.splice(c,1))}function vi(t,a){const e=re[t];if(!e)return;const c=e.categories.findIndex(s=>s.id===a);if(c===-1)return;const n=e.categories[c].name,i=n.toLowerCase();e.students.forEach(s=>{s.categoryCounts&&delete s.categoryCounts[n],s.categoryIssues&&delete s.categoryIssues[n],s.logs.scores&&delete s.logs.scores[i]}),e.sessions.forEach(s=>{s.lastWinnerByCategory[n]&&delete s.lastWinnerByCategory[n],s.winnerHistory=s.winnerHistory.filter(r=>r.categoryName!==n)}),e.categories.splice(c,1)}function Ci(t,a,e,c){const o=re[t];if(!o)return;const n=o.students.find(r=>r.identity.studentId===a);if(!n||!n.logs.scores[e.toLowerCase()])return;const i=n.logs.scores[e.toLowerCase()],s=i.findIndex(r=>r.id===c);s>-1&&i.splice(s,1)}function wi(t,a,e){const c=re[t];if(!c)return;const o=c.students.find(i=>i.identity.studentId===a);if(!o||!o.profile.notes)return;const n=o.profile.notes.findIndex(i=>i.id===e);n>-1&&o.profile.notes.splice(n,1)}function Ei(){JSON.parse(JSON.stringify({classrooms:re,trashBin:pe})),lt=!0}function _i(){lt=!1,On()}function He(t){N=t}function sn(t){Ss=t}function Ze(t){J=t}function Je(t){Ie=t}function Rn(t){nn=t}function ki(t){qn=t}function qt(t){Is=t}function bn(t){xn=t}function Si(t){xs=t}function zn(t){Ve=t}function vn(t){Ln=t}function Ii(t){Ls=t}function Cn(t){Tn=t}function xi(t){Ts=t}function Os(t){Bs=t}function Ms(t){Ns=t}function an(t){Bn=t}function Rs(t){bt=t}function $n(t){Dn=t}function Li(t){li=t}function Ti(t){di=t}function zs(t){pe=t}function Zn(t){Nn=t}function rn(t){xt=t}function Kt(t){Ge={...Ge,...t},ce()}function rs(t){ct=t}function $s(){Ge.lastBackupTimestamp=new Date().toISOString(),ce()}function Fn(t){An=t}const Ea=Object.freeze(Object.defineProperty({__proto__:null,get activeModal(){return bt},get cancelCallback(){return Ns},get classrooms(){return re},get confirmCallback(){return Bs},get currentClassroom(){return N},get datePickerCallback(){return An},get easterEggClickCount(){return Ln},get easterEggLastClickTime(){return Ls},enterDemoMode:Ei,exitDemoMode:_i,getActiveItems:ke,getSessionDisplayMap:tt,get importedFileContent(){return xn},get isDemoMode(){return lt},get liveSession(){return Ss},loadData:On,get manualSelection(){return Dn},moveStudent:gi,get namesToImport(){return Is},get notificationTimeout(){return xs},permanentlyDeleteCategory:vi,permanentlyDeleteNote:wi,permanentlyDeleteScore:Ci,permanentlyDeleteSession:bi,permanentlyDeleteStudent:Mn,prepareBackupData:ui,get previousState(){return nn},processRestore:mi,rehydrateData:Lt,renameCategory:pi,renameClassroom:hi,resetAllStudentCounters:yi,get resetEasterEggClickCount(){return Tn},get resetEasterEggLastClickTime(){return Ts},get saveCategoryCallback(){return Nn},saveData:ce,get saveNoteCallback(){return Ds},get secureConfirmCallback(){return Bn},get selectedCategory(){return Ve},get selectedClassIds(){return ct},get selectedSession(){return J},get selectedStudentForProfile(){return Ie},get selectedStudentsForMassComment(){return xt},setActiveModal:Rs,setCancelCallback:Ms,setConfirmCallback:Os,setCurrentClassroom:He,setDatePickerCallback:Fn,setEasterEggClickCount:vn,setEasterEggLastClickTime:Ii,setImportedFileContent:bn,setLastBackupTimestamp:$s,setLiveSession:sn,setManualSelection:$n,setNamesToImport:qt,setNotificationTimeout:Si,setPreviousState:Rn,setResetEasterEggClickCount:Cn,setResetEasterEggLastClickTime:xi,setSaveCategoryCallback:Zn,setSaveNoteCallback:rt,setSecureConfirmCallback:an,setSelectedCategory:zn,setSelectedClassIds:rs,setSelectedSession:Ze,setSelectedStudentForProfile:Je,setSelectedStudentsForMassComment:rn,setSourceClassForMove:Ti,setStudentToMove:Li,setTrashBin:zs,setUndoTimeout:ki,setUserSettings:Kt,setWinnerHistoryIndex:vt,get sourceClassForMove(){return di},get studentToMove(){return li},get trashBin(){return pe},get undoTimeout(){return qn},get userSettings(){return Ge},get winnerHistoryIndex(){return qe}},Symbol.toStringTag,{value:"Module"})),_a="TeacherAssistantDB",ka=1,gt="backups";function Bi(){return new Promise((t,a)=>{const e=indexedDB.open(_a,ka);e.onupgradeneeded=c=>{const o=c.target.result;o.objectStoreNames.contains(gt)||o.createObjectStore(gt,{keyPath:"id"})},e.onsuccess=c=>t(c.target.result),e.onerror=c=>a(c.target.error)})}async function Sa(t,a){const e=await Bi(),c=e.transaction(gt,"readwrite"),o=c.objectStore(gt),n={id:Date.now(),file:t,metadata:a,timestamp:new Date().toISOString()};o.add(n),c.oncomplete=()=>{const s=e.transaction(gt,"readwrite").objectStore(gt),r=s.count();r.onsuccess=()=>{if(r.result>10){const l=s.getAllKeys();l.onsuccess=()=>{const h=l.result;for(;h.length>10;){const p=h.shift();s.delete(p),console.log(`♻️ Auto-deleted old backup snapshot: ${p}`)}}}}}}async function Ia(){const t=await Bi();return new Promise((a,e)=>{const n=t.transaction(gt,"readonly").objectStore(gt).getAll();n.onsuccess=()=>{const i=n.result.sort((s,r)=>r.id-s.id);a(i)},n.onerror=()=>e(n.error)})}function et(t){return typeof t!="string"?"":t.replace(/ي/g,"ی").replace(/ك/g,"ک").replace(/[\s\u200c]/g,"")}function Fs(t){return typeof t!="string"||t.length===0?"ltr":/[\u0590-\u07FF]/.test(t)?"rtl":"ltr"}function Ni(t){return!t||!t.trim()?"":t.split(`
`).map(c=>`<div dir="${Fs(c)}">${c||"&nbsp;"}</div>`).join("")}function ss(t){if(typeof t!="string")return"";const a={q:"ض",w:"ص",e:"ث",r:"ق",t:"ف",y:"غ",u:"ع",i:"ه",o:"خ",p:"ح","[":"ج","]":"چ",a:"ش",s:"س",d:"ی",f:"ب",g:"ل",h:"ا",j:"ت",k:"ن",l:"م",";":"ک","'":"گ",z:"ظ",x:"ط",c:"ز",v:"ر",b:"ذ",n:"د",m:"پ",",":"و"};let e="";for(let c=0;c<t.length;c++){const o=t[c].toLowerCase();e+=a[o]||t[c]}return e}function os(t){if(!t||typeof t!="string")return{name:"",firstName:null,lastName:null};const a=t.indexOf(".");if(a>0&&a<t.length-1){const e=t.substring(0,a).trim(),c=t.substring(a+1).trim();return{name:`${e} ${c}`,firstName:e,lastName:c}}return{name:t.trim(),firstName:null,lastName:null}}const Di="teacherAssistantLogs_v2",xa=100;function Ps(){try{const t=localStorage.getItem(Di);return t?JSON.parse(t):{}}catch(t){return console.error("Error reading logs from localStorage:",t),{}}}function Ai(t){try{localStorage.setItem(Di,JSON.stringify(t))}catch(a){console.error("Error saving logs to localStorage:",a)}}function Se(t,a,e=null){if(!t)return;const c=Ps();c[t]||(c[t]=[]);const o={timestamp:new Date().toISOString(),message:a,action:e,classroomName:t};c[t].unshift(o),c[t].length>xa&&c[t].pop(),Ai(c)}function La(t){return Ps()[t]||[]}function Ta(t,a){const e=Ps();e[t]&&!e[a]&&(e[a]=e[t],delete e[t],Ai(e))}var ni={toJalaali:Ba,toGregorian:Oi,isValidJalaaliDate:Na,isLeapJalaaliYear:Mi,jalaaliMonthLength:Ri,jalCal:Hs,j2d:Pn,d2j:Hn,g2d:Gn,d2g:Ws,jalaaliToDateObject:zi,jalaaliWeek:Aa},yt=[-61,9,38,199,426,686,756,818,1111,1181,1210,1635,2060,2097,2192,2262,2324,2394,2456,3178];function Ba(t,a,e){return Object.prototype.toString.call(t)==="[object Date]"&&(e=t.getDate(),a=t.getMonth()+1,t=t.getFullYear()),Hn(Gn(t,a,e))}function Oi(t,a,e){return Ws(Pn(t,a,e))}function Na(t,a,e){return t>=-61&&t<=3177&&a>=1&&a<=12&&e>=1&&e<=Ri(t,a)}function Mi(t){return Da(t)===0}function Ri(t,a){return a<=6?31:a<=11||Mi(t)?30:29}function Da(t){var a=yt.length,e=yt[0],c,o,n,i,s;if(t<e||t>=yt[a-1])throw new Error("Invalid Jalaali year "+t);for(s=1;s<a&&(c=yt[s],o=c-e,!(t<c));s+=1)e=c;return i=t-e,o-i<6&&(i=i-o+De(o+4,33)*33),n=Ke(Ke(i+1,33)-1,4),n===-1&&(n=4),n}function Hs(t,a){var e=yt.length,c=t+621,o=-14,n=yt[0],i,s,r,l,h,p,f;if(t<n||t>=yt[e-1])throw new Error("Invalid Jalaali year "+t);for(f=1;f<e&&(i=yt[f],s=i-n,!(t<i));f+=1)o=o+De(s,33)*8+De(Ke(s,33),4),n=i;return p=t-n,o=o+De(p,33)*8+De(Ke(p,33)+3,4),Ke(s,33)===4&&s-p===4&&(o+=1),l=De(c,4)-De((De(c,100)+1)*3,4)-150,h=20+o-l,a?{gy:c,march:h}:(s-p<6&&(p=p-s+De(s+4,33)*33),r=Ke(Ke(p+1,33)-1,4),r===-1&&(r=4),{leap:r,gy:c,march:h})}function Pn(t,a,e){var c=Hs(t,!0);return Gn(c.gy,3,c.march)+(a-1)*31-De(a,7)*(a-7)+e-1}function Hn(t){var a=Ws(t).gy,e=a-621,c=Hs(e,!1),o=Gn(a,3,c.march),n,i,s;if(s=t-o,s>=0){if(s<=185)return i=1+De(s,31),n=Ke(s,31)+1,{jy:e,jm:i,jd:n};s-=186}else e-=1,s+=179,c.leap===1&&(s+=1);return i=7+De(s,30),n=Ke(s,30)+1,{jy:e,jm:i,jd:n}}function Gn(t,a,e){var c=De((t+De(a-8,6)+100100)*1461,4)+De(153*Ke(a+9,12)+2,5)+e-34840408;return c=c-De(De(t+100100+De(a-8,6),100)*3,4)+752,c}function Ws(t){var a,e,c,o,n;return a=4*t+139361631,a=a+De(De(4*t+183187720,146097)*3,4)*4-3908,e=De(Ke(a,1461),4)*5+308,c=De(Ke(e,153),5)+1,o=Ke(De(e,153),12)+1,n=De(a,1461)-100100+De(8-o,6),{gy:n,gm:o,gd:c}}function Aa(t,a,e){var c=zi(t,a,e).getDay(),o=c==6?0:-(c+1),n=6+o;return{saturday:Hn(Pn(t,a,e+o)),friday:Hn(Pn(t,a,e+n))}}function zi(t,a,e,c,o,n,i){var s=Oi(t,a,e);return new Date(s.gy,s.gm-1,s.gd,c||0,o||0,n||0,i||0)}function De(t,a){return~~(t/a)}function Ke(t,a){return t-~~(t/a)*a}const $i=document.getElementById("class-management-page"),Oa=document.getElementById("new-class-name"),Ma=document.getElementById("add-class-btn"),Mt=document.getElementById("class-list"),Wn=document.getElementById("undo-toast"),Fi=document.getElementById("undo-message"),Ra=document.getElementById("undo-btn"),za=document.getElementById("settings-page"),Us=document.getElementById("settings-class-name-header"),cs=document.getElementById("settings-student-list"),ls=document.getElementById("category-list"),$a=document.getElementById("back-to-sessions-btn"),Fa=document.getElementById("new-student-name"),Pa=document.getElementById("add-student-btn"),Pi=document.getElementById("paste-area"),Ha=document.getElementById("process-paste-btn"),Wa=document.getElementById("csv-preview-page"),ds=document.getElementById("csv-preview-list"),Ua=document.getElementById("csv-confirm-btn"),ja=document.getElementById("csv-cancel-btn"),qa=document.getElementById("import-csv-btn"),Za=document.getElementById("csv-file-input"),Ga=document.getElementById("column-mapping-page"),us=document.getElementById("column-select-dropdown"),Va=document.getElementById("confirm-column-btn"),Ja=document.getElementById("cancel-import-btn"),Ka=document.getElementById("new-category-name"),Ya=document.getElementById("add-category-btn"),fs=document.querySelector(".app-header"),it=document.getElementById("select-student-btn"),$t=document.getElementById("select-student-btn-wrapper"),Xa=document.getElementById("attendance-page"),Yt=document.getElementById("attendance-list"),Qa=document.getElementById("finish-attendance-btn"),er=document.querySelector("#class-management-page h2"),ms=document.getElementById("student-stats-header"),tr=document.getElementById("hamburger-menu-btn"),nr=document.getElementById("side-nav-menu"),sr=document.getElementById("close-nav-btn"),ir=document.getElementById("overlay"),ar=document.getElementById("backup-data-btn"),rr=document.getElementById("restore-data-btn"),Hi=document.getElementById("restore-file-input"),or=document.getElementById("custom-confirm-modal"),Wi=document.getElementById("confirm-modal-message"),hs=document.getElementById("confirm-modal-cancel-btn"),Zt=document.getElementById("confirm-modal-confirm-btn"),cr=document.getElementById("secure-confirm-modal"),Ui=document.getElementById("secure-confirm-message"),ji=document.getElementById("secure-confirm-code"),Dt=document.getElementById("secure-confirm-input"),lr=document.getElementById("secure-confirm-cancel-btn"),wn=document.getElementById("secure-confirm-confirm-btn"),dr=document.getElementById("add-note-modal"),_e=document.getElementById("new-note-content"),ur=document.getElementById("class-save-note-btn"),fr=document.getElementById("cancel-note-btn"),ps=document.getElementById("student-search-input"),pt=document.getElementById("student-search-results"),mr=document.getElementById("back-to-student-page-btn"),hr=document.getElementById("graded-category-pills-container"),pr=document.getElementById("new-score-value"),qi=document.getElementById("new-score-comment"),gr=document.getElementById("add-score-btn"),yr=document.getElementById("profile-stats-summary"),br=document.getElementById("profile-scores-list"),Gt=document.getElementById("global-student-search-input"),ot=document.getElementById("global-student-search-results"),vr=document.getElementById("is-graded-checkbox"),Cr=document.getElementById("trashed-classes-list"),wr=document.getElementById("trashed-students-list"),Er=document.getElementById("trashed-sessions-list"),_r=document.getElementById("trashed-categories-list"),kr=document.getElementById("trashed-notes-list"),Sr=document.getElementById("trashed-scores-list"),Ot=document.getElementById("quick-grade-form-wrapper"),dt=document.getElementById("quick-score-input"),st=document.getElementById("quick-note-textarea"),St=document.getElementById("quick-grade-submit-btn"),Xt=document.getElementById("category-selection-container"),gs=document.getElementById("selected-student-result"),It=document.getElementById("custom-context-menu"),At=document.getElementById("breadcrumb-container"),Ir=document.getElementById("report-config-modal"),Zi=document.getElementById("report-columns-container"),Gi=document.getElementById("report-print-btn"),Vi=document.getElementById("report-cancel-btn");let jt=null,Rt=null;const xr=document.getElementById("category-modal"),Ji=document.getElementById("category-modal-title"),Qt=document.getElementById("new-category-modal-name"),js=document.getElementById("new-category-modal-is-graded"),Lr=document.getElementById("category-modal-cancel-btn"),Ki=document.getElementById("category-modal-save-btn"),Tr=document.getElementById("mass-comment-modal"),Br=document.getElementById("mass-comment-modal-title"),Yi=document.getElementById("mass-comment-student-count-message"),en=document.getElementById("mass-comment-content"),qs=document.getElementById("mass-comment-append-checkbox"),Nr=document.getElementById("mass-comment-cancel-btn"),Dr=document.getElementById("mass-comment-save-btn"),ys=document.getElementById("mass-comment-btn"),En=document.getElementById("attendance-mass-actions-container"),_t=document.createElement("input"),Ar=document.getElementById("session-dashboard-page"),Ft=document.getElementById("attendance-pane");function Vt(t,a){let e;const o=i=>{e=setTimeout(()=>{navigator.vibrate&&navigator.vibrate(50),a(i)},800)},n=()=>{clearTimeout(e)};t.addEventListener("touchstart",o,{passive:!0}),t.addEventListener("touchend",n),t.addEventListener("touchmove",n),t.addEventListener("mousedown",o),t.addEventListener("mouseup",n),t.addEventListener("mouseleave",n)}function Pt(t="selector"){if(!N||!J){ge("class-management-page");return}$r(),kn(),ze(),at(),ge("session-dashboard-page",{tab:t}),Xi(),on(t),Fr()}function on(t){const a=document.getElementById("selector-tab-btn"),e=document.getElementById("attendance-tab-btn"),c=document.getElementById("selector-pane"),o=t==="selector";a.classList.toggle("active",o),e.classList.toggle("active",!o),c.classList.toggle("active",o),Ft.classList.toggle("active",!o)}function Xi(){const t=document.getElementById("selector-tab-btn"),a=document.getElementById("attendance-tab-btn"),e=document.getElementById("selector-pane");t.addEventListener("click",()=>{ze(),Re(),t.classList.add("active"),a.classList.remove("active"),e.classList.add("active"),Ft.classList.remove("active"),ge("session-dashboard-page",{tab:"selector"})}),a.addEventListener("click",()=>{at(),a.classList.add("active"),t.classList.remove("active"),Ft.classList.add("active"),e.classList.remove("active"),ge("session-dashboard-page",{tab:"attendance"})})}function Or(t){clearTimeout(qn),nn||Rn(JSON.stringify(re)),Fi.textContent=t,Wn.classList.add("show"),ki(setTimeout(()=>{Wn.classList.remove("show"),Rn(null)},5e3))}function Qi(){if(nn){const t=N?N.info.name:null,a=JSON.parse(nn);Lt(a),t&&re[t]?He(re[t]):He(null),N?(ut(),Ht(),We()):Ue(),Wn.classList.remove("show"),clearTimeout(qn),Rn(null)}}function Y(t,a=3e3){const e=document.getElementById("notification-toast");e&&(e.textContent=t,e.classList.add("show"),clearTimeout(xs),Si(setTimeout(()=>{e.classList.remove("show")},a)))}function Un(t){var v;const a=document.getElementById("restore-confirm-modal"),e=document.getElementById("restore-modal-message"),c=document.getElementById("restore-append-checkbox"),o=document.querySelector('label[for="restore-append-checkbox"]'),n=document.getElementById("restore-confirm-cancel-btn"),i=document.getElementById("restore-confirm-confirm-btn"),s=document.getElementById("restore-modal-warning");s.style.display="none";const r=((v=t.metadata)==null?void 0:v.createdAt)||0;if(Ge.lastRestoreTimestamp&&r<Ge.lastRestoreTimestamp){const b=new Date(r).toLocaleDateString("fa-IR"),C=new Date(Ge.lastRestoreTimestamp).toLocaleDateString("fa-IR");s.textContent=`⚠️ هشدار: این فایل پشتیبان (${b}) قدیمی‌تر از آخرین بازیابی شما (${C}) است.`,s.style.display="block"}const l=t.data.classrooms||{},h=Object.values(l).map(b=>b.info.name),p=h.length,f="کلاس",u=h.map(b=>`<li style="margin-bottom: 4px;">🔹 ${b}</li>`).join("");e.innerHTML=`
        <div style="margin-bottom: 10px;">
            فایل پشتیبان شامل <strong>${p} ${f}</strong> زیر است:
        </div>
        <ul style="
            margin: 0; 
            padding: 10px; 
            background-color: #f8f9fa; 
            border-radius: 5px; 
            border: 1px solid #e9ecef;
            list-style: none; 
            max-height: 150px; 
            overflow-y: auto;
            text-align: right;
        ">
            ${u}
        </ul>
        <div style="margin-top: 15px;">
            لطفاً نحوه بازیابی را مشخص کنید.
        </div>
    `,c.checked=!1,o&&(o.textContent="جایگزینی کامل (حذف داده‌های فعلی)");const y=()=>{const b=c.checked;mi(t,b),i.onclick=null,n.onclick=null,a.removeEventListener("click",y),ve(),Ue(),ge("class-management-page"),Y(`✅ اطلاعات با موفقیت بازیابی شد (${b?"پاک‌سازی و بازیابی":"همگام‌سازی هوشمند"}).`)},m=()=>{i.onclick=null,n.onclick=null,ve()};i.onclick=y,n.onclick=m,$e("restore-confirm-modal")}function Ee(t,a,e={}){const{confirmText:c="تایید",cancelText:o="لغو",confirmClass:n="btn-success",onCancel:i=()=>{},isDelete:s=!1}=e,r=s?()=>ea(t,a):a;Wi.textContent=t,Zt.textContent=c,hs.textContent=o,Zt.className="modal-action-btn",Zt.classList.add(n),Os(r),Ms(i);const l=Zt.parentElement;hs.style.display=i===null?"none":"inline-block",l.style.justifyContent=i===null?"center":"space-between",$e("custom-confirm-modal")}function ea(t,a){const e=Math.floor(1e4+Math.random()*9e4).toString();Ui.textContent=t,ji.textContent=e,Dt.value="",wn.disabled=!0,an(a),$e("secure-confirm-modal"),Dt.focus();const c=()=>{Dt.value===e?wn.disabled=!1:wn.disabled=!0};return Dt.addEventListener("input",c),()=>{Dt.removeEventListener("input",c)}}function bs(t,a={}){const{title:e="ایجاد دسته‌بندی جدید",initialName:c="",initialIsGraded:o=!1,saveButtonText:n="ذخیره"}=a;Ji.textContent=e,Qt.value=c,js.checked=o,Ki.textContent=n,Zn((i,s)=>{if(!i){Y("⚠️ لطفاً نام دسته‌بندی را وارد کنید.");return}t(i,s),ve()}),$e("category-modal"),Qt.focus(),c&&Qt.select()}function Zs(t,a){const e=Object.values(re).filter(i=>!i.isDeleted&&i.info.name!==a.info.name),c=document.getElementById("move-student-modal-title"),o=document.getElementById("move-student-class-select"),n=document.getElementById("move-student-confirm-btn");c.textContent=`انتقال دانش‌آموز: ${t.identity.name}`,o.innerHTML="",e.length===0?(o.innerHTML='<option value="">کلاس دیگری برای انتقال وجود ندارد</option>',n.disabled=!0):(e.forEach(i=>{const s=document.createElement("option");s.value=i.info.name,s.textContent=i.info.name,o.appendChild(s)}),n.disabled=!1),Li(t),Ti(a),$e("move-student-modal")}function Gs(t,a){if(!t||!a)return;const e=t.identity.name,c=document.getElementById("add-note-modal-title");c.textContent="تغییر نام دانش‌آموز";const o=t.identity.firstName&&t.identity.lastName?`${t.identity.firstName} . ${t.identity.lastName}`:e;_e.value=o,_e.rows=1,_e.dispatchEvent(new Event("input",{bubbles:!0})),rt(n=>{const i=os(n),s=i.name;if(t.identity.firstName&&t.identity.lastName&&!i.firstName)return Y("⚠️ این دانش‌آموز دارای نام و نام‌خانوادگی تفکیک شده است. لطفاً حتماً از نقطه (.) بین نام و نام‌خانوادگی استفاده کنید."),!1;const r=!t.identity.firstName&&i.firstName;if(s&&(s!==e||r)){if(ke(a.students).some(p=>p.identity.studentId!==t.identity.studentId&&p.identity.name.toLowerCase()===s.toLowerCase()))return Y("دانش‌آموزی با این نام از قبل در این کلاس وجود دارد."),!1;{t.identity.name=s,t.identity.firstName=i.firstName,t.identity.lastName=i.lastName,Se(a.info.name,`نام دانش‌آموز «${e}» به «${s}» تغییر یافت.`,{type:"VIEW_STUDENT_PROFILE",studentId:t.identity.studentId}),ce(),ut(),ze(),at(),Re(),Ie&&Ie.identity.studentId===t.identity.studentId&&Fe(t);const p=document.querySelector(`#settings-student-list li[data-student-id="${t.identity.studentId}"]`);p&&(p.classList.add("recently-updated"),setTimeout(()=>{p&&p.classList.remove("recently-updated")},1e4),p.scrollIntoView({behavior:"smooth",block:"center"})),Y(`✅ نام دانش‌آموز به «${s}» تغییر یافت.`)}}else if(!s)return Y("⚠️ نام نمی‌تواند خالی باشد."),!1;const l=document.getElementById("add-note-modal-title");l.textContent="ثبت یادداشت جدید",_e.rows=4}),$e("add-note-modal"),_e.focus(),_e.select()}function $e(t){const a=document.getElementById(t);if(a){if(bt)return;a.classList.add("modal-visible"),Rs(t),history.pushState(null,"",location.href)}}function ve(t,a=!1){if(!bt)return;const e=document.getElementById(bt),c=bt;Rs(null),c==="student-profile-modal"&&Je(null),a||history.back(),e&&(e.classList.add("modal-closing"),setTimeout(()=>{e.classList.remove("modal-visible"),e.classList.remove("modal-closing"),c==="custom-confirm-modal"&&(Os(null),Ms(null)),c==="secure-confirm-modal"&&an(null),c==="category-modal"&&Zn(null),c==="mass-comment-modal"&&(en.value=""),c==="add-note-modal"&&rt(null),typeof t=="function"&&t()},300))}function Vs(){if(!Ft||!Ft.classList.contains("active")){En.style.display="none";return}const t=xt.length;t<1?En.style.display="none":En.style.display="block",ys.disabled=t<1,ys.textContent=`📝 ثبت یادداشت گروهی (${t} نفر)`}function Js(){const t=xt,a=t.length;let e=!1;a>0&&(e=t.some(o=>{var n;return(n=J.studentRecords[o])==null?void 0:n.homework.comment})),Yi.textContent=`یادداشت برای ${a} دانش‌آموز ثبت خواهد شد.`,en.value="",en.dispatchEvent(new Event("input",{bubbles:!0})),qs.checked=!0;const c=document.querySelector("#mass-comment-modal .modal-options");c.style.display=e?"flex":"none",$e("mass-comment-modal"),en.focus()}function vs(t,a){if(!N||!J)return;let e=0;const c=xt,o=J;c.forEach(n=>{const i=o.studentRecords[n];if(i&&i.homework){const s=i.homework.comment||"";let r=t;a&&s.length>0?r=s+`
---
`+t:r=t,i.homework.comment=r.trim();const l=N.students.find(h=>h.identity.studentId===n);l&&Mr(l,o,r.trim()),e++}}),rn([]),ce(),at(),Se(N.info.name,`${e} دانش‌آموز به صورت گروهی یادداشت تکلیف گرفتند.`,{type:"VIEW_SESSIONS"}),Y(`✅ یادداشت برای ${e} دانش‌آموز ثبت شد.`)}function Mr(t,a,e){const o=tt(N).get(a.sessionNumber),n={type:"fromAttendance",sessionNumber:a.sessionNumber},i=`یادداشت جلسه ${o}:
`,s=t.profile.notes.find(r=>!r.isDeleted&&r.source&&r.source.type==="fromAttendance"&&r.source.sessionNumber===n.sessionNumber);s?e?(s.content=i+e,s.isDeleted=!1):s.isDeleted=!0:e&&t.addNote(i+e,n)}function Vn(t){_e.value=t.note||"",rt(a=>{t.note=a,ce(),Se(t.info.name,"یادداشت کلاس ذخیره شد.",{type:"VIEW_CLASS_NOTE"}),Ue(),Y("✅ یادداشت کلاس ذخیره شد.")}),$e("add-note-modal"),_e.focus()}function Ks(t,a){_e.value=t.note||"",_e.dispatchEvent(new Event("input",{bubbles:!0})),rt(e=>{t.note=e,ce(),Se(N.info.name,`یادداشت جلسه ${a} ذخیره شد.`,{type:"VIEW_SESSIONS"}),We(),Y("✅یادداشت جلسه ذخیره شد.")}),$e("add-note-modal"),_e.focus()}function zt(t){He(t),Us.textContent=`تنظیمات کلاس: ${t.info.name}`,ut(),Ht(),ca(),ge("settings-page")}function ta(t){const a=document.getElementById("log-modal-title"),e=document.getElementById("log-list");a.textContent=`گزارش فعالیت‌های کلاس: ${t}`,e.innerHTML="";const c=La(t);c.length===0?e.innerHTML='<li class="no-content-message">هنوز فعالیتی برای این کلاس ثبت نشده است.</li>':c.forEach(o=>{const n=document.createElement("li");n.className="log-entry";const i=new Date(o.timestamp),s=`${i.toLocaleDateString("fa-IR")} - ${i.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}`,r=document.createElement("span");r.className="log-timestamp",r.textContent=s;const l=document.createElement("span");l.className="log-message",l.textContent=o.message,o.action&&(l.classList.add("log-action-link"),l.dataset.action=JSON.stringify({...o.action,classroomName:o.classroomName})),n.appendChild(r),n.appendChild(l),e.appendChild(n)}),$e("log-modal")}document.getElementById("log-modal-close-btn").addEventListener("click",()=>{ve()});function Cs(t){const a=URL.createObjectURL(t),e=document.createElement("a");e.href=a,e.download=t.name,document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(a),setTimeout(()=>{Ee("آیا فایل پشتیبان با موفقیت ذخیره شد؟",()=>{$s(),Jn(),Y("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله، ذخیره شد",cancelText:"خیر",confirmClass:"btn-success"})},500)}async function cn(t=[]){const a=await ui(t);if(!a){Y("❌ خطا در ایجاد فایل پشتیبان.");return}let e="پشتیبان کامل سیستم";if(t.length>0){const o=t.join("، ");e=`${t.length===1?"پشتیبان کلاس:":"پشتیبان کلاس‌های:"} ${o}`}Sa(a,{name:a.name,description:e,version:"2.0-b64"}).catch(o=>console.error("Failed to save local snapshot:",o)),("ontouchstart"in window||navigator.maxTouchPoints>0)&&navigator.share&&navigator.canShare&&navigator.canShare({files:[a]})?Ee("فایل پشتیبان شما آماده است. آیا مایل به اشتراک‌گذاری آن هستید؟",()=>{try{navigator.share({title:a.name,text:"فایل پشتیبان داده‌های برنامه",files:[a]}).then(()=>{Ee("آیا فایل پشتیبان با موفقیت ارسال/ذخیره شد؟",()=>{$s(),Jn(),Y("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}catch(o){console.error("Error during sharing process:",o),Cs(a),Y("⚠️خطا در فرآیند اشتراک‌گذاری. فایل در حال دانلود است.")}},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"}):(Cs(a),Y("✅پشتیبان‌گیری با موفقیت انجام شد."))}function dn(t,a){t.preventDefault(),kt(),Rt=t.target.closest("li"),Rt&&Rt.classList.add("context-menu-target"),setTimeout(()=>{const e=It,c=e.querySelector("ul");c.innerHTML="",a.forEach(l=>{const h=document.createElement("li");l.isSeparator?h.className="separator":(h.innerHTML=`
                    <span class="icon">${l.icon||""}</span>
                    <span class="label">${l.label}</span>
                `,l.className&&h.classList.add(l.className),h.addEventListener("click",()=>{l.action(),kt()})),c.appendChild(h)}),e.classList.add("visible");const{offsetWidth:o,offsetHeight:n}=e,{innerHeight:i}=window,s=document.body.getBoundingClientRect();e.style.top=`${(i-n)/2}px`;const r=s.left+s.width/2;e.style.left=`${r-o/2}px`},50)}function kt(){It.classList.contains("visible")&&It.classList.remove("visible"),Rt&&(Rt.classList.remove("context-menu-target"),Rt=null)}function na(){var e;At.innerHTML="";const t=document.getElementById("header-settings-btn");if(!t)return;const a=[];if(a.push({label:"کلاس‌ها",handler:()=>{He(null),Ze(null),Je(null),ge("class-management-page")}}),N){a.push({label:N.info.name,handler:()=>{Ze(null),Je(null),We(),ge("session-page")}});const c=(e=document.querySelector(".page.active"))==null?void 0:e.id;if(c==="session-page"?t.style.visibility="visible":t.style.visibility="hidden",c==="settings-page")a.push({label:"تنظیمات"});else if(J){const n=tt(N).get(J.sessionNumber)||` (#${J.sessionNumber})`;a.push({label:`جلسه ${n}`,handler:()=>{Je(null),Pt("selector")}}),Ie?a.push({label:`پروفایل: ${Ie.identity.name}`}):c==="session-dashboard-page"&&(document.getElementById("attendance-tab-btn").classList.contains("active")?a.push({label:"حضور و غیاب"}):a.push({label:"انتخابگر"}))}}else t.style.visibility="hidden";if(a.length<=1){At.style.display="none";return}At.style.display="flex",a.forEach((c,o)=>{const n=document.createElement("a");if(n.textContent=c.label,n.className="breadcrumb-item",o===a.length-1||!c.handler?n.classList.add("active"):n.addEventListener("click",c.handler),At.appendChild(n),o<a.length-1){const i=document.createElement("span");i.className="breadcrumb-separator",i.textContent="/",At.appendChild(i)}})}function si(t,a,e){e.innerHTML="";const c=N.sessions.filter(o=>{var n;return!o.isDeleted&&!o.isCancelled&&((n=o.studentRecords[t.identity.studentId])==null?void 0:n.attendance)==="absent"}).map(o=>({number:a.get(o.sessionNumber),isMakeup:o.isMakeup})).filter(o=>o.number!==void 0);c.length>0?(e.appendChild(document.createTextNode("جلسات غایب: ")),c.forEach((o,n)=>{const i=document.createElement("span");i.textContent=o.number,o.isMakeup&&i.classList.add("makeup-absence"),e.appendChild(i),n<c.length-1&&e.appendChild(document.createTextNode("، "))})):e.textContent="جلسات غایب: بدون غیبت"}function _n(t,a,e,c={}){const{includePrefix:o=!0}=c;e.innerHTML="";const n=N.sessions.filter(i=>{if(i.isDeleted||i.isCancelled)return!1;const s=i.studentRecords[t.identity.studentId];return s&&s.homework&&(s.homework.status==="incomplete"||s.homework.status==="none")}).map(i=>({number:a.get(i.sessionNumber),status:i.studentRecords[t.identity.studentId].homework.status})).filter(i=>i.number!==void 0);n.length>0?(o&&e.appendChild(document.createTextNode("تکالیف ناقص: ")),n.forEach((i,s)=>{const r=document.createElement("span");r.textContent=i.number,i.status==="incomplete"&&r.classList.add("incomplete-homework"),e.appendChild(r),s<n.length-1&&e.appendChild(document.createTextNode("،"))})):o?e.textContent="تکالیف ناقص: ندارد":e.textContent="ندارد"}function Rr(t,a){var L,D,R;const e=document.createElement("li");e.className="attendance-list-item";const c=document.createElement("span");c.className="absence-info";const o=document.createElement("span");o.className="homework-info";const n=document.createElement("div");n.className="att-row-1";let i=!1;n.addEventListener("mousedown",()=>i=!1),n.addEventListener("touchstart",()=>i=!1,{passive:!0});const s=document.createElement("input");s.type="checkbox",s.className="mass-comment-checkbox",s.checked=xt.includes(t.identity.studentId),s.addEventListener("change",()=>{const P=t.identity.studentId,Q=xt;if(s.checked)Q.includes(P)||Q.push(P);else{const z=Q.indexOf(P);z>-1&&Q.splice(z,1)}Vs();const k=document.getElementById("attendance-list");Q.length===0&&k.classList.contains("selection-mode-active")&&k.classList.remove("selection-mode-active")});const r=document.createElement("span");r.className="student-name",r.textContent=t.identity.name,r.addEventListener("click",P=>{if(i){P.stopPropagation(),P.preventDefault(),i=!1;return}Fe(t)}),Vt(n,P=>{i=!0;const Q=document.getElementById("attendance-list");Q.classList.contains("selection-mode-active")||Q.classList.add("selection-mode-active"),s.checked||(s.checked=!0,s.dispatchEvent(new Event("change")))}),n.appendChild(s),n.appendChild(r);const l=document.createElement("div");l.className="att-row-2";const h=document.createElement("button");let p=!1;h.addEventListener("mousedown",()=>p=!1),h.addEventListener("touchstart",()=>p=!1,{passive:!0});const f=((L=J.studentRecords[t.identity.studentId])==null?void 0:L.attendance)||"present",u=P=>{P==="present"?(h.textContent="حاضر",h.className="attendance-status-btn present active"):(h.textContent="غایب",h.className="attendance-status-btn absent active")};u(f),h.addEventListener("click",P=>{var z;if(p){P.stopPropagation();return}const k=(((z=J.studentRecords[t.identity.studentId])==null?void 0:z.attendance)||"present")==="present"?"absent":"present";J.setAttendance(t.identity.studentId,k),k==="absent"&&(J.studentRecords[t.identity.studentId].hadIssue=!1),ce(),u(k),si(t,a,c),ze(),la()}),Vt(h,()=>{p=!0;const P=f==="present"?"absent":"present",Q=P==="present"?"حاضر":"غایب";Ee(`آیا مطمئن هستید که می‌خواهید وضعیت حضور تمام دانش‌آموزان را به «${Q}» تغییر دهید؟`,()=>{ke(N.students).forEach(k=>{J.setAttendance(k.identity.studentId,P),P==="absent"&&(J.studentRecords[k.identity.studentId].hadIssue=!1)}),ce(),at(),Y(`✅ وضعیت تمام دانش‌آموزان به «${Q}» تغییر یافت.`)},{confirmText:"بله، اعمال کن",confirmClass:"btn-warning"})});const y=document.createElement("div");y.className="homework-controls";const m={none:"بدون تکلیف",complete:"تکلیف کامل",incomplete:"تکلیف ناقص"},v=document.createElement("button");let b=!1;v.addEventListener("mousedown",()=>b=!1),v.addEventListener("touchstart",()=>b=!1,{passive:!0});const C=((D=J.studentRecords[t.identity.studentId])==null?void 0:D.homework.status)||"none";v.className=`homework-status-btn ${C}`,v.title=m[C],v.addEventListener("click",P=>{if(b){P.stopPropagation();return}const Q=J.studentRecords[t.identity.studentId].homework,z={none:"incomplete",incomplete:"complete",complete:"none"}[Q.status];J.setHomeworkStatus(t.identity.studentId,z),ce(),v.className=`homework-status-btn ${z}`,v.title=m[z],_n(t,a,o)}),Vt(v,()=>{b=!0;const Q={none:"incomplete",incomplete:"complete",complete:"none"}[C],k=m[Q];Ee(`آیا از تغییر وضعیت تکلیف تمام دانش‌آموزان به «${k}» مطمئن هستید؟`,()=>{ke(N.students).forEach(z=>{J.setHomeworkStatus(z.identity.studentId,Q)}),ce(),at(),Y(`✅ وضعیت تکلیف همه به «${k}» تغییر یافت.`)},{confirmText:"بله",confirmClass:"btn-warning"})});const _=document.createElement("button");let S=!1;_.addEventListener("mousedown",()=>S=!1),_.addEventListener("touchstart",()=>S=!1,{passive:!0}),_.className="btn-icon",_.innerHTML="📝",_.title="افزودن یادداشت برای تکلیف",((R=J.studentRecords[t.identity.studentId])==null?void 0:R.homework.comment)||(_.style.opacity="0.3"),_.addEventListener("click",P=>{if(S){P.stopPropagation();return}const Q=J.studentRecords[t.identity.studentId].homework;_e.value=Q.comment||"",_e.dispatchEvent(new Event("input",{bubbles:!0})),rt(k=>{Q.comment=k;const z=tt(N),g=z.get(J.sessionNumber),H={type:"fromAttendance",sessionNumber:J.sessionNumber},ue=`یادداشت جلسه ${g}:
`,j=t.profile.notes.find(fe=>!fe.isDeleted&&fe.source&&fe.source.type==="fromAttendance"&&fe.source.sessionNumber===H.sessionNumber);j?k?j.content=ue+k:j.isDeleted=!0:k&&t.addNote(ue+k,H),ce(),Y("✅یادداشت تکلیف ذخیره شد."),_.style.opacity=k?"1":"0.3",_n(t,z,o)}),$e("add-note-modal"),_e.focus()}),Vt(_,()=>{S=!0,Ee("آیا می‌خواهید برای **تمام** دانش‌آموزان کلاس یادداشت تکلیف ثبت کنید؟",()=>{const P=ke(N.students).map(Q=>Q.identity.studentId);rn(P),Js()},{confirmText:"بله",confirmClass:"btn-primary"})}),l.appendChild(h),y.appendChild(_),y.appendChild(v),l.appendChild(y);const x=document.createElement("div");return x.className="att-row-3",si(t,a,c),_n(t,a,o),x.appendChild(c),x.appendChild(o),e.appendChild(n),e.appendChild(l),e.appendChild(x),e}function zr(){return tt(N).get(J.sessionNumber)}function at(){if(!N||!J)return;ke(N.students).forEach(o=>{J.initializeStudentRecord(o.identity.studentId)}),rn([]);const t=tt(N);Vr(),Yt.innerHTML="";const a=document.createElement("li");a.className="attendance-list-header",_t.id="attendance-search-input",_t.type="text",_t.className="inline-search-input",_t.placeholder="جستجو...",_t.value="";const e=document.createElement("div");e.className="student-search-container",e.appendChild(_t);const c=document.createElement("div");c.className="header-labels-container",c.innerHTML=`
    <span class="header-label">تکلیف</span>
    <span class="header-label">حضور</span>
`,a.appendChild(e),a.appendChild(c),Yt.appendChild(a),ke(N.students).forEach(o=>{const n=Rr(o,t);Yt.appendChild(n)}),rn([]),Vs(),Jr(),la()}function ze(){const t=document.getElementById("student-stats-table-container");if(!t||(t.innerHTML="",!N))return;ke(N.students).length,ms.textContent="آمار عملکرد";const a=["نام"],e=["کل انتخاب ها","غیبت","خروج","فرصت ازدست‌رفته","مشکل","میانگین","نمره کلاسی (کانون)"],c=N.categories.filter(u=>u.isGradedCategory&&!u.isDeleted).map(u=>u.name),o=[...a,...c,...e],n=document.createElement("table");n.className="student-stats-table";const s=n.createTHead().insertRow();o.forEach((u,y)=>{const m=document.createElement("th");y===0?(m.innerHTML=`${u} <span style="opacity: 0.6;">🔗</span>`,m.title="ردیف‌های این ستون قابل کلیک هستند"):m.textContent=u,s.appendChild(m)});const r=n.createTBody(),l=ke(N.students),h=u=>{let y=0;return N.sessions.forEach(m=>{if(m.isDeleted||m.isCancelled)return;const v=m.studentRecords[u.identity.studentId];v&&v.attendance==="absent"&&y++}),y};l.forEach(u=>{const y=r.insertRow();if(y.dataset.studentId=u.identity.studentId,J){const S=J.studentRecords[u.identity.studentId];S&&S.attendance==="absent"&&y.classList.add("absent-row-highlight")}const m=y.insertCell(),v=document.createElement("span");v.textContent=u.identity.name,v.className="student-name-link",v.addEventListener("click",()=>{Fe(u)}),m.appendChild(v),c.forEach(S=>{var D;const I=y.insertCell();I.style.direction="ltr";const x=S.toLowerCase(),L=((D=u.logs.scores[x])==null?void 0:D.filter(R=>!R.isDeleted))||[];L.length>0?L.forEach((R,P)=>{const Q=document.createElement("span");Q.textContent=R.value+(R.comment?"'":""),Q.style.position="relative",R.comment&&(Q.dataset.tooltip=R.comment),I.appendChild(Q),P<L.length-1&&I.appendChild(document.createTextNode(","))}):I.textContent="",I.style.cursor="pointer",I.addEventListener("click",()=>{Re(u,S);const R=document.getElementById("category-selection-container");R&&R.scrollIntoView({behavior:"smooth",block:"center"})})}),y.insertCell().textContent=u.statusCounters.totalSelections||0,y.insertCell().textContent=h(u),y.insertCell().textContent=u.statusCounters.outOfClassCount||0,y.insertCell().textContent=u.statusCounters.missedChances||0;const b=Object.values(u.categoryIssues||{}).reduce((S,I)=>S+I,0);y.insertCell().textContent=b;const C=u.getOverallAverageScore();y.insertCell().textContent=C!==null?C:"-";const _=N.calculateFinalStudentScore(u);y.insertCell().textContent=_!==null?_:"-"}),ke(N.students),ms.setAttribute("data-student-count",l.length),t.appendChild(n);const p=t.querySelector(".student-stats-table"),f=p==null?void 0:p.querySelector("thead th:first-child");f&&f.addEventListener("click",()=>{p.classList.toggle("name-column-expanded")})}function Re(t=null,a=null){const e=document.getElementById("selected-student-result");e.innerHTML="",e.classList.remove("absent");let c,o;if(t&&a)c=t,o=a,$n({student:t,categoryName:a}),vt(-1);else{if($n(null),!J||qe<0||!J.winnerHistory[qe])return;const F=J.winnerHistory[qe];c=F.winner,o=F.categoryName}const n=document.querySelector(".current-winner-highlight");if(n&&n.classList.remove("current-winner-highlight"),c){const F=document.querySelector(`.student-stats-table tr[data-student-id="${c.identity.studentId}"]`);F&&F.classList.add("current-winner-highlight")}const i=N.categories.find(F=>F.name===o);if(i){zn(i),Ys(i);const F=document.querySelectorAll("#category-selection-container .pill");F.forEach(O=>O.classList.remove("active"));const ne=Array.from(F).find(O=>O.textContent===o);ne&&ne.classList.add("active"),ws(i),Es(i.name)}const s=J.studentRecords[c.identity.studentId],r=(s==null?void 0:s.attendance)==="absent",l=document.createElement("div");l.className="winner-name-container";const h=document.createElement("button");h.className="btn-icon",h.innerHTML="˅",h.title="برنده قبلی";const p=!t;h.classList.toggle("is-disabled",!p||qe<=0),h.addEventListener("click",()=>{h.classList.contains("is-disabled")?(h.classList.add("shake-animation"),setTimeout(()=>h.classList.remove("shake-animation"),200)):(vt(qe-1),Re())});const f=document.createElement("div");f.className="winner-name",f.innerHTML=`✨ <strong>${c.identity.name}</strong>✨`,f.classList.add("heartbeat-animation"),r&&(f.style.textDecoration="line-through",f.style.opacity="0.6",f.style.color="var(--color-secondary)"),(s==null?void 0:s.hadIssue)&&!r&&(f.style.color="var(--color-warning)",f.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"),(s==null?void 0:s.wasOutOfClass)&&!r&&(f.style.color="var(--color-strong-warning)",f.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود");const m=1e3,v=F=>{jt=setTimeout(()=>{no(c,o),jt=null},m)},b=()=>{jt&&(clearTimeout(jt),jt=null)};f.addEventListener("mousedown",v),f.addEventListener("mouseup",b),f.addEventListener("mouseout",b),f.addEventListener("touchstart",v),f.addEventListener("touchmove",b),f.addEventListener("touchend",b),f.addEventListener("touchcancel",b);const C=document.createElement("button");if(C.className="btn-icon",C.innerHTML="˄",C.title="برنده بعدی",C.classList.toggle("is-disabled",!p||qe>=J.winnerHistory.length-1),C.addEventListener("click",()=>{C.classList.contains("is-disabled")?(C.classList.add("shake-animation"),setTimeout(()=>C.classList.remove("shake-animation"),200)):(vt(qe+1),Re())}),l.appendChild(C),l.appendChild(f),c.onboardingSession===J.sessionNumber){const F=document.createElement("div");F.className="new-student-badge",F.textContent="دانش آموز جدید",l.appendChild(F)}l.appendChild(h),e.appendChild(l),it.disabled=p&&!C.classList.contains("is-disabled");const _=document.createElement("div");_.className="status-button-container";const S=document.createElement("button");S.textContent="غایب",S.classList.add("status-button","absent-btn"),r&&S.classList.add("active");const I=document.createElement("button");I.textContent="مشکل",I.classList.add("status-button","issue-btn"),s!=null&&s.hadIssue&&I.classList.add("active");const x=document.createElement("button");x.textContent="خروج",x.classList.add("status-button","exit-btn"),s!=null&&s.wasOutOfClass&&x.classList.add("active");const L=document.createElement("button");L.textContent="پروفایل",L.className="status-button profile-btn",J.isFinished?S.disabled=!0:S.addEventListener("click",()=>{const F=S.classList.contains("active");x.classList.contains("active")&&(x.classList.remove("active"),s.wasOutOfClass=!1,c.statusCounters.outOfClassCount=Math.max(0,(c.statusCounters.outOfClassCount||0)-1),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)),F?(S.classList.remove("active"),J.setAttendance(c.identity.studentId,"present"),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1),f.style.textDecoration="",f.style.opacity="",f.style.color=""):(I.classList.contains("active")&&(I.classList.remove("active"),s.hadIssue=!1,c.statusCounters.otherIssues=Math.max(0,c.statusCounters.otherIssues-1),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)),S.classList.add("active"),J.setAttendance(c.identity.studentId,"absent"),c.statusCounters.missedChances++,f.style.textDecoration="line-through",f.style.opacity="0.6",f.style.color="var(--color-secondary)",f.title=""),ze(),setTimeout(()=>{qe!==-1?Re():Re(c,o)},0),ce()}),J.isFinished?I.disabled=!0:I.addEventListener("click",()=>{const F=I.classList.contains("active");if(x.classList.contains("active")&&(x.classList.remove("active"),s.wasOutOfClass=!1,c.statusCounters.outOfClassCount=Math.max(0,(c.statusCounters.outOfClassCount||0)-1),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)),F){I.classList.remove("active"),s.hadIssue=!1;const ne=Ve.name;c.categoryIssues[ne]&&(c.categoryIssues[ne]=Math.max(0,c.categoryIssues[ne]-1)),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1),f.style.color="",f.title=""}else{S.classList.contains("active")&&(S.classList.remove("active"),J.setAttendance(c.identity.studentId,"present"),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)),I.classList.add("active"),s.hadIssue=!0;const ne=Ve.name;c.categoryIssues[ne]=(c.categoryIssues[ne]||0)+1,c.statusCounters.missedChances++,f.style.textDecoration="",f.style.opacity="",f.style.color="var(--color-warning)",f.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"}ze(),setTimeout(()=>{qe!==-1?Re():Re(c,o)},0),ce()}),J.isFinished?x.disabled=!0:x.addEventListener("click",()=>{if(x.classList.contains("active"))x.classList.remove("active"),s.wasOutOfClass=!1,c.statusCounters.outOfClassCount=Math.max(0,(c.statusCounters.outOfClassCount||0)-1),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1),f.style.color="",f.title="";else{if(S.classList.contains("active")&&(S.classList.remove("active"),J.setAttendance(c.identity.studentId,"present"),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)),I.classList.contains("active")){I.classList.remove("active"),s.hadIssue=!1;const ne=Ve.name;c.categoryIssues[ne]&&(c.categoryIssues[ne]=Math.max(0,c.categoryIssues[ne]-1)),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)}x.classList.add("active"),s.wasOutOfClass=!0,c.statusCounters.outOfClassCount=(c.statusCounters.outOfClassCount||0)+1,c.statusCounters.missedChances++,f.style.textDecoration="",f.style.opacity="",f.style.color="var(--color-strong-warning)",f.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود"}ze(),setTimeout(()=>{qe!==-1?Re():Re(c,o)},0),ce()}),J.isFinished?L.disabled=!0:L.addEventListener("click",()=>{Fe(c)}),_.appendChild(S),_.appendChild(x),_.appendChild(I),_.appendChild(L),e.appendChild(_);const D=document.createElement("div");D.className="student-details-container";const R=document.createElement("div");R.className="student-details-scores",R.innerHTML="<h4>آخرین نمرات</h4>";const P=document.createElement("ul");P.className="scores-list";const Q=N.categories.filter(F=>F.isGradedCategory&&!F.isDeleted);let k=!1;const z=c.logs.scores||{};Q.forEach(F=>{var Ne;const ne=F.name,O=ne.toLowerCase(),M=document.createElement("li"),oe=document.createElement("span");oe.className="skill-name",oe.textContent=`${ne}:`;const te=document.createElement("span");te.className="skill-scores";const X=(Ne=z[O])==null?void 0:Ne.filter(Oe=>!Oe.isDeleted);if(X&&X.length>0){k=!0;const Oe=X.slice(-3);Oe.forEach((he,Ce)=>{const Te=document.createElement("span");Te.textContent=he.value+(he.comment?"'":""),he.comment&&(Te.dataset.tooltip=he.comment,Te.style.position="relative",Te.style.cursor="help",Te.classList.add("tooltip-container")),te.appendChild(Te),Ce<Oe.length-1&&te.appendChild(document.createTextNode(","))})}else te.textContent="none";M.appendChild(oe),M.appendChild(te),P.appendChild(M)}),k||(P.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>'),R.appendChild(P),D.appendChild(R);const g=document.createElement("div");g.className="student-details-notes";const H=document.createElement("div");H.className="history-section-header";const ue=document.createElement("h4");ue.textContent="یادداشت‌ها";const j=document.createElement("button");j.className="btn-icon",j.innerHTML="📝",j.title="افزودن یادداشت جدید",J.isFinished?j.disabled=!0:j.addEventListener("click",()=>{_e.value="",_e.dispatchEvent(new Event("input",{bubbles:!0})),rt(F=>{F&&(c.addNote(F),ce(),Re(),Y("✅ یادداشت با موفقیت ثبت شد."))}),$e("add-note-modal"),_e.focus()}),H.appendChild(ue),H.appendChild(j),g.appendChild(H);const fe=document.createElement("ul");fe.className="notes-list",c.profile.notes&&c.profile.notes.length>0?[...c.profile.notes].sort((ne,O)=>new Date(O.timestamp)-new Date(ne.timestamp)).forEach(ne=>{const O=document.createElement("li");O.dir=Fs(ne.content),O.textContent=ne.content,fe.appendChild(O)}):fe.innerHTML='<div class="no-content-message">یادداشتی وجود ندارد.</div>',g.appendChild(fe),D.appendChild(g),e.appendChild(D)}function sa(t){t.addEventListener("input",()=>{const a=t.value,e=Fs(a);t.setAttribute("dir",e)})}function $r(){Ys(null),Xt.innerHTML="",gs.innerHTML="",Ot.classList.add("tooltip-container"),dt.disabled=!0,st.disabled=!0,St.disabled=!0,dt.value="",st.value="",$t.classList.add("disabled-wrapper"),it.disabled=!0}function kn(){Xt.innerHTML="",N.categories.filter(e=>!e.isDeleted).forEach(e=>{const c=document.createElement("span");c.className="pill",c.textContent=e.name,c.dataset.categoryId=e.id,e.description&&(c.dataset.tooltip=e.description),J.isFinished?c.classList.add("disabled"):c.addEventListener("click",()=>{document.querySelectorAll("#category-selection-container .pill").forEach(n=>n.classList.remove("active")),c.classList.add("active"),zn(e),Ys(e),ws(e),Es(e.name),$t.classList.remove("disabled-wrapper"),it.disabled=J.isFinished;const o=J.lastWinnerByCategory[e.name];if(o){const n=N.students.find(i=>i.identity.studentId===o);n&&Re(n,e.name)}else{gs.innerHTML="",$n(null),vt(-1),it.disabled=!1;const n=document.querySelector(".current-winner-highlight");n&&n.classList.remove("current-winner-highlight")}}),J.isFinished||c.addEventListener("contextmenu",o=>{dn(o,[{label:"تغییر نام",icon:"✏️",action:()=>{bs((i,s)=>{const r=pi(N,e,i);r.success?(e.isGradedCategory=s,ce(),Se(N.info.name,`نام دسته‌بندی «${e.name}» به «${i}» تغییر یافت.`),kn(),ze(),Y(`✅ نام دسته‌بندی به «${i}» تغییر یافت.`)):Y(`⚠️ ${r.message}`)},{title:"ویرایش دسته‌بندی",initialName:e.name,initialIsGraded:e.isGradedCategory,saveButtonText:"ذخیره تغییرات"})}},{label:"حذف دسته‌بندی",icon:"🗑️",className:"danger",action:()=>{Ee(`آیا از انتقال دسته‌بندی «${e.name}» به سطل زباله مطمئن هستید؟`,()=>{const i={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${e.name}» از کلاس «${N.info.name}»`,restoreData:{categoryId:e.id,classId:N.info.scheduleCode}};pe.unshift(i),pe.length>50&&pe.pop();const s=e.name.toLowerCase();if(N.students.forEach(r=>{r.logs.scores&&r.logs.scores[s]&&r.logs.scores[s].forEach(l=>{l.isDeleted=!0})}),Ve&&Ve.id===e.id){zn(null),gs.innerHTML="",ws(null),Es(null),$t.classList.add("disabled-wrapper"),it.disabled=!0;const r=document.querySelector(".current-winner-highlight");r&&r.classList.remove("current-winner-highlight")}e.isDeleted=!0,Se(N.info.name,`دسته‌بندی «${e.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),kn(),ze(),Y(`✅ دسته‌بندی «${e.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}}])}),Xt.appendChild(c)});const a=document.createElement("span");a.className="pill add-category-pill",a.textContent="+",a.title="افزودن دسته‌بندی جدید",J.isFinished?a.classList.add("disabled"):a.addEventListener("click",()=>{bs((e,c)=>{if(N.categories.find(i=>i.name.toLowerCase()===e.toLowerCase()&&!i.isDeleted)){Y("⚠️ این دسته‌بندی از قبل وجود دارد.");return}const n=new ft(e,"",c);N.categories.push(n),ce(),Se(N.info.name,`دسته‌بندی جدید «${e}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),kn(),Y(`✅ دسته‌بندی «${e}» اضافه شد.`)})}),Xt.appendChild(a)}function Fr(){if(J.lastUsedCategoryId){if(J.isFinished)return;const t=Xt.querySelector(`.pill[data-category-id="${J.lastUsedCategoryId}"]`);t&&t.click()}J.winnerHistory&&J.winnerHistory.length>0&&(vt(J.winnerHistory.length-1),Re())}function Ys(t){t?it.textContent=`نفر بعدی در ${t.name}`:it.textContent="نفر بعدی"}function ws(t){if(J.isFinished){dt.disabled=!0,st.disabled=!0,St.disabled=!0,Ot.setAttribute("title","جلسه خاتمه یافته است");return}t&&t.isGradedCategory?(dt.disabled=!1,st.disabled=!1,St.disabled=!1,Ot.removeAttribute("title")):(dt.disabled=!0,st.disabled=!0,St.disabled=!0,t?Ot.setAttribute("title","برای این دسته‌بندی قابلیت نمره دهی تعریف نشده است"):Ot.setAttribute("title","ابتدا یک دسته‌بندی را انتخاب کنید"))}function Es(t){const a=document.querySelector(".student-stats-table");if(!a||(a.querySelectorAll(".current-category-highlight").forEach(i=>{i.classList.remove("current-category-highlight")}),!t))return;let c=-1;const o=a.querySelectorAll("thead th");if(o.forEach((i,s)=>{i.textContent.trim()===t&&(c=s)}),c===-1)return;o[c].classList.add("current-category-highlight"),a.querySelectorAll("tbody tr").forEach(i=>{const s=i.cells[c];s&&s.classList.add("current-category-highlight")})}function Fe(t){Je(t);const a=document.getElementById("student-profile-modal"),e=document.getElementById("modal-profile-student-name"),c=document.getElementById("modal-profile-content-container"),o=document.getElementById("modal-profile-close-btn");if(!a||!e||!c||!o)return;e.textContent=`پروفایل: ${t.identity.name}`,e.style.cursor="pointer",e.onclick=()=>{const l=Ie,h=N;ve(()=>{Gs(l,h)})},c.innerHTML="";const n=document.createElement("div");n.className="profile-header-actions";const i=document.createElement("button");i.className="btn-icon btn-icon-label",i.title="انتقال دانش‌آموز",i.innerHTML="<span>➡️</span><span>انتقال</span>",i.addEventListener("click",()=>{const l=Ie,h=N;ve(()=>{Zs(l,h)})});const s=document.createElement("button");s.className="btn-icon btn-icon-label",s.title="حذف دانش‌آموز",s.innerHTML="<span>🗑️</span><span>حذف</span>",s.style.color="var(--color-strong-warning)",s.addEventListener("click",()=>{const l=Ie,h=N;ve(()=>{Ee(`آیا از انتقال دانش‌آموز «${l.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const p={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${l.identity.name}» از کلاس «${h.info.name}»`,restoreData:{studentId:l.identity.studentId,classId:h.info.scheduleCode}};pe.unshift(p),pe.length>50&&pe.pop(),l.isDeleted=!0,Se(h.info.name,`دانش‌آموز «${l.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),ut(),ze(),at(),Y(`✅ دانش‌آموز «${l.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0,onCancel:()=>{Fe(l)}})})});const r=document.createElement("button");r.className="btn-icon btn-icon-label",r.title="افزودن یادداشت جدید",r.innerHTML="<span>📝</span><span>یادداشت</span>",r.addEventListener("click",()=>{const l=Ie;_e.value="",_e.dispatchEvent(new Event("input",{bubbles:!0})),rt(h=>{if(h)return l.addNote(h),ce(),Se(N.info.name,`یادداشت جدیدی برای دانش‌آموز «${l.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:l.identity.studentId}),Re(),Y("✅ یادداشت با موفقیت ثبت شد."),()=>Fe(l)}),ve(()=>{$e("add-note-modal"),_e.focus()})}),n.appendChild(i),n.appendChild(s),n.appendChild(r),c.appendChild(n),Pr(c),ia(c),o.onclick=()=>ve(),$e("student-profile-modal")}function Pr(t){if(!Ie||!N)return;const a=document.createElement("div");a.className="scoring-section",a.innerHTML=`
        <h3>ثبت نمره جدید</h3>
        <div id="modal-graded-pills" class="category-pills"></div>
        <div class="input-group centered-input-group" style="margin-top: 15px;">
            <input type="number" id="modal-new-score-value" placeholder="نمره (مثلا: 85)">
        </div>
        <textarea id="modal-new-score-comment" placeholder="توضیحات این نمره (اختیاری)..." style="margin-top: 10px;"></textarea>
        <button id="modal-add-score-btn" class="btn-success" style="width: 100%; margin-top: 10px;">ثبت نمره</button>
    `;const e=a.querySelector("#modal-graded-pills");ke(N.categories).filter(n=>n.isGradedCategory).forEach(n=>{const i=document.createElement("span");i.className="pill",i.textContent=n.name,i.dataset.skillName=n.name,i.addEventListener("click",()=>{e.querySelectorAll(".pill").forEach(s=>s.classList.remove("active")),i.classList.add("active")}),e.appendChild(i)}),a.querySelector("#modal-add-score-btn").addEventListener("click",()=>{const n=e.querySelector(".pill.active");if(!n){Y("⚠️لطفاً یک مهارت را برای نمره‌دهی انتخاب کنید.");return}const i=n.dataset.skillName,s=a.querySelector("#modal-new-score-value"),r=a.querySelector("#modal-new-score-comment"),l=s.value,h=r.value.trim();if(!l){Y("لطفاً مقدار نمره را وارد کنید.");return}Ie.addScore(i,parseFloat(l),h),ce(),Se(N.info.name,`نمره ${l} در ${i} برای «${Ie.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:Ie.identity.studentId}),ze(),Re(),s.value="",r.value="";const p=document.getElementById("modal-profile-content-container"),f=p.querySelector(".history-section");f&&f.remove(),ia(p),Y(`✅ نمره برای مهارت ${i} با موفقیت ثبت شد.`)}),t.appendChild(a)}function ia(t){if(!Ie)return;const a=document.createElement("div");a.className="history-section";const e=document.createElement("div");e.className="history-section-header";const c=document.createElement("h3");c.textContent="سوابق دانش‌آموز",e.appendChild(c),a.appendChild(e),Hr(a),aa(a),ra(a),t.appendChild(a)}function Hr(t){if(!Ie)return;const a=Ie,e=N.sessions.reduce((u,y)=>{const m=y.studentRecords[a.identity.studentId];return u+(m&&m.attendance==="absent"?1:0)},0),c=Object.values(a.categoryIssues||{}).reduce((u,y)=>u+y,0),o=document.createElement("div");o.className="stats-summary-box",o.innerHTML=`
        <p><strong>کل انتخاب:</strong> ${a.statusCounters.totalSelections}</p>
        <p><strong>غیبت:</strong> ${e}</p>
        <p><strong>فرصت از دست رفته:</strong> ${a.statusCounters.missedChances||0}</p>
        <p><strong>مشکل:</strong> ${c}</p>
    `,t.appendChild(o),o.querySelector("p:nth-child(1)");const n=o.querySelector("p:nth-child(4)"),i=ke(N.categories),s=document.createElement("div");if(s.className="stats-breakdown",i.length>0){i.forEach(y=>{var C;const m=y.name,v=((C=a.categoryCounts)==null?void 0:C[m])||0,b=document.createElement("p");b.className="stats-breakdown-item",b.innerHTML=`<strong>${m}:</strong> ${v}`,s.appendChild(b)});const u=o.querySelector("p:first-child");u&&(u.classList.add("collapsible-toggle"),u.onclick=()=>{s.classList.toggle("open"),u.classList.toggle("open")},u.after(s))}const r=document.createElement("div");r.className="stats-breakdown",i.length>0&&(i.forEach(u=>{var b;const y=u.name,m=((b=a.categoryIssues)==null?void 0:b[y])||0,v=document.createElement("p");v.className="stats-breakdown-item",v.innerHTML=`<strong>${y}:</strong> ${m}`,r.appendChild(v)}),n&&(n.classList.add("collapsible-toggle"),n.onclick=()=>{r.classList.toggle("open"),n.classList.toggle("open")},o.appendChild(r)));const l=document.createElement("p"),h=document.createElement("strong");h.textContent="تکالیف ناقص:";const p=document.createElement("span");p.style.marginRight="5px";const f=tt(N);_n(a,f,p,{includePrefix:!1}),l.appendChild(h),l.appendChild(p),o.appendChild(l)}function aa(t){if(!Ie)return;const a=Ie,e=document.createElement("h4");e.textContent="تاریخچه نمرات:",e.style.marginTop="20px";const c=document.createElement("ul");c.className="list-container";const o=Object.values(a.logs.scores||{}).flat().filter(n=>!n.isDeleted).sort((n,i)=>new Date(i.timestamp)-new Date(n.timestamp));o.length===0?c.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>':o.forEach(n=>{const i=document.createElement("li");i.className="score-history-item";const s=document.createElement("div");s.className="item-content";const r=document.createElement("div");r.className="score-info";const l=document.createElement("span");l.className="score-skill-badge",l.textContent=n.skill;const h=document.createElement("span");h.className="score-value",h.textContent=`نمره: ${n.value}`;const p=document.createElement("span");if(p.className="score-date",p.textContent=new Date(n.timestamp).toLocaleDateString("fa-IR"),r.appendChild(l),r.appendChild(h),r.appendChild(p),s.appendChild(r),n.comment){const u=document.createElement("p");u.className="score-comment",u.innerHTML=Ni(n.comment),u.addEventListener("click",()=>{_e.value=n.comment,_e.dispatchEvent(new Event("input",{bubbles:!0})),rt(y=>{n.comment=y,ce(),Se(N.info.name,`توضیحات نمره ${n.value} (${n.skill}) برای دانش‌آموز «${a.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:a.identity.studentId}),Fe(a),Y("✅ توضیحات نمره با موفقیت ویرایش شد.")}),ve(()=>{$e("add-note-modal"),_e.focus()})}),s.appendChild(u)}const f=document.createElement("button");f.className="btn-icon delete-item-btn",f.innerHTML="🗑️",f.title="حذف این نمره",f.addEventListener("click",()=>{ve(()=>{Ee(`آیا از انتقال نمره ${n.value} در مهارت «${n.skill}» به سطل زباله مطمئن هستید؟`,()=>{const u={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"score",description:`نمره ${n.value} (${n.skill}) برای «${a.identity.name}»`,restoreData:{scoreId:n.id,skill:n.skill,studentId:a.identity.studentId,classId:N.info.scheduleCode}};pe.unshift(u),pe.length>50&&pe.pop(),n.isDeleted=!0,ce(),Se(N.info.name,`نمره ${n.value} (${n.skill}) دانش‌آموز «${a.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),Fe(a),Y("✅ نمره به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{Fe(a)}})})}),i.appendChild(s),i.appendChild(f),c.appendChild(i)}),t.appendChild(e),t.appendChild(c)}function ra(t){if(!Ie)return;const a=document.createElement("h4");a.textContent="تاریخچه یادداشت‌ها:",a.style.marginTop="20px";const e=document.createElement("ul");e.className="list-container",!Ie.profile.notes||Ie.profile.notes.length===0?e.innerHTML='<div class="no-content-message">هنوز یادداشتی ثبت نشده است.</div>':[...Ie.profile.notes].filter(o=>!o.isDeleted).sort((o,n)=>new Date(n.timestamp)-new Date(o.timestamp)).forEach(o=>{const n=document.createElement("li");n.className="note-history-item";const i=document.createElement("div");i.className="item-content";const s=document.createElement("div");s.className="note-info";const r=document.createElement("span");r.className="note-date",r.textContent=new Date(o.timestamp).toLocaleDateString("fa-IR");const l=document.createElement("button");l.className="btn-icon delete-item-btn",l.innerHTML="🗑️",l.title="حذف این یادداشت",l.addEventListener("click",()=>{const p=Ie;ve(()=>{Ee("آیا از انتقال این یادداشت به سطل زباله مطمئن هستید؟",()=>{const f={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"note",description:`یادداشت برای دانش‌آموز «${p.identity.name}»`,restoreData:{noteId:o.id,studentId:p.identity.studentId,classId:N.info.scheduleCode}};pe.unshift(f),pe.length>50&&pe.pop(),o.isDeleted=!0,Se(N.info.name,`یادداشت دانش‌آموز «${p.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),Fe(p),Y("✅ یادداشت به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{Fe(p)}})})}),s.appendChild(r),s.appendChild(l);const h=document.createElement("p");h.className="note-content",h.innerHTML=Ni(o.content),h.addEventListener("click",()=>{const p=Ie;_e.value=o.content,_e.dispatchEvent(new Event("input",{bubbles:!0})),rt(f=>{o.content=f,ce(),Se(N.info.name,`یادداشت دانش‌آموز «${p.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:p.identity.studentId}),Fe(p),Y("✅یادداشت با موفقیت ویرایش شد.")}),ve(()=>{$e("add-note-modal"),_e.focus()})}),i.appendChild(s),i.appendChild(h),n.appendChild(i),e.appendChild(n)}),t.appendChild(a),t.appendChild(e)}function oa(t){us.innerHTML="",t.forEach((a,e)=>{const c=document.createElement("option");c.value=e,c.textContent=a.trim(),us.appendChild(c)})}function _s(){ds.innerHTML="",Is.forEach(t=>{const a=document.createElement("li");a.className="preview-item";const e=document.createElement("input");e.type="checkbox",e.checked=!0,e.dataset.name=t;const c=document.createElement("label");c.textContent=t,a.appendChild(e),a.appendChild(c),ds.appendChild(a)})}function Wr(t){const a=document.createElement("div");a.className="list-item-buttons";const e=document.createElement("button");return e.className="btn-icon",e.innerHTML="📝",e.title="ویرایش یادداشت کلاس",t.note||(e.style.display="none"),e.addEventListener("click",c=>{c.stopPropagation(),Vn(t)}),a.appendChild(e),a}function Ur(t){const a=document.createElement("div");a.style.flexGrow="1",a.style.display="flex",a.style.flexDirection="column",a.style.alignItems="flex-start";const e=document.createElement("span");e.textContent=t.info.name,e.classList.add("class-name-display"),a.appendChild(e);const c=ke(t.students).length,o=ke(t.sessions).filter(l=>l.isFinished).length,n=Yr(t.info.scheduleDays),i=document.createElement("div");i.classList.add("class-stats-row");const s=document.createElement("span");s.textContent=`${c} نفر`,s.classList.add("student-count-badge"),i.appendChild(s);const r=document.createElement("span");if(r.textContent=`${o} جلسه`,r.classList.add("session-count-badge"),i.appendChild(r),n){const l=document.createElement("span");l.textContent=n,l.classList.add("schedule-days-badge"),i.appendChild(l)}return a.appendChild(i),a.addEventListener("click",()=>{He(t),Ze(null),sn(N.liveSession),We(),ge("session-page")}),a}function jr(t){const a=document.createElement("li");jn(t).type==="active"&&(a.classList.add("active-class-card"),a.title="این کلاس هم‌اکنون در حال برگزاری است");const c=document.createElement("input");c.type="checkbox",c.className="mass-selection-checkbox",c.checked=ct.includes(t.info.name),c.addEventListener("click",h=>{h.stopPropagation()}),c.addEventListener("change",()=>{const h=t.info.name;if(c.checked)ct.includes(h)||ct.push(h);else{const p=ct.indexOf(h);p>-1&&ct.splice(p,1)}}),a.appendChild(c);const o=Ur(t);a.appendChild(o);const n=document.createElement("div");n.style.display="flex",n.style.flexDirection="column",n.style.gap="5px",n.style.alignItems="flex-end",n.style.marginLeft="10px";const i=document.createElement("div");if(i.className="list-item-badges",t.liveSession&&!t.liveSession.isCancelled&&!t.liveSession.isDeleted){const h=document.createElement("span");h.className="warning-badge",h.textContent="جلسه باز",i.appendChild(h),a.classList.add("has-unfinished-session")}const s=document.createElement("span");if(s.className=`type-badge ${t.info.type}`,s.textContent=t.info.type==="online"?"آنلاین":"حضوری",s.title="نوع کلاس",i.appendChild(s),jn(t).type==="incomplete"){const h=document.createElement("span");h.className="type-badge cancelled-badge",h.textContent="زمان‌بندی ناقص",h.style.cursor="pointer",h.title="برای تکمیل زمان‌بندی کلیک کنید",h.addEventListener("click",p=>{p.stopPropagation(),Ee("زمان‌بندی این کلاس کامل نیست. برای نمایش صحیح در لیست، لطفاً روزها و ساعت برگزاری را مشخص کنید.",()=>{zt(t)},{confirmText:"تنظیمات",confirmClass:"btn-primary"})}),i.appendChild(h)}else{const h=Kr(t,re);if(h){const p=document.createElement("span");p.className="type-badge conflict-badge",p.textContent="تداخل زمانی",p.style.cursor="pointer",p.title=`تداخل با کلاس: ${h}`,p.addEventListener("click",f=>{f.stopPropagation(),Ee(`زمان برگزاری این کلاس با کلاس «${h}» تداخل دارد. لطفاً زمان‌بندی را بررسی کنید.`,()=>{zt(t)},{confirmText:"تنظیمات",confirmClass:"btn-primary"})}),i.appendChild(p)}}n.appendChild(i);const l=Wr(t);return n.appendChild(l),a.appendChild(n),a.addEventListener("contextmenu",h=>{const p={label:"پشتیبان‌گیری از این کلاس",icon:"📤",action:()=>{cn([t.info.name])}},f=ct.length;f>1&&ct.includes(t.info.name)&&(p.label=`پشتیبان‌گیری از ${f} کلاس`,p.action=()=>{cn(ct),rs([]),Ue()});const u=[{label:"چاپ گزارش کلاس",icon:"🖨️",action:()=>{Qr(t)}},{label:Mt.classList.contains("selection-mode-active")?"لغو انتخاب":"انتخاب چند کلاس",icon:"✔️",action:()=>{const y=Mt.classList.contains("selection-mode-active");Mt.classList.toggle("selection-mode-active"),y&&(rs([]),Ue())}},p,{label:"یادداشت کلاس",icon:"📝",action:()=>{Vn(t)}},{label:"تنظیمات کلاس",icon:"⚙️",action:()=>{zt(t)}},{label:"گزارش فعالیت‌ها",icon:"📋",action:()=>{ta(t.info.name)}},{label:"تغییر نام",icon:"✏️",action:()=>{const y=t.info.name,m=document.getElementById("add-note-modal-title");m.textContent="تغییر نام کلاس",_e.value=y,_e.rows=1,rt(v=>{const b=v.trim();if(b&&b!==y){const C=hi(y,b);C.success?(Ta(y,b),Se(b,`نام کلاس از «${y}» به «${b}» تغییر یافت.`,{type:"VIEW_SESSIONS"}),ce(),Ue(),Y(`✅نام کلاس به «${b}» تغییر یافت.`)):Y(C.message)}m.textContent="ثبت یادداشت جدید",_e.rows=4}),$e("add-note-modal"),_e.focus(),_e.select()}},{label:"حذف کلاس",icon:"🗑️",className:"danger",action:()=>{Ee(`آیا از انتقال کلاس «${t.info.name}» به سطل زباله مطمئن هستید؟`,()=>{const y={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"classroom",description:`کلاس «${t.info.name}»`,restoreData:{name:t.info.name}};pe.unshift(y),pe.length>50&&pe.pop(),t.isDeleted=!0,ce(),Ue(),Y(`✅ کلاس «${t.info.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}];dn(h,u)}),a}function Jn(){const t=document.getElementById("class-management-stats");if(!t)return;const a=Object.values(re).filter(n=>!n.isDeleted),e=a.length,c=a.reduce((n,i)=>n+ke(i.students).length,0);let o="";Ge.lastBackupTimestamp&&(o=`
            <div class="stats-row backup-stat">
                <span>آخرین پشتیبان: <strong>${new Date(Ge.lastBackupTimestamp).toLocaleString("fa-IR",{year:"numeric",month:"numeric",day:"numeric",weekday:"long",hour:"2-digit",minute:"2-digit"})}</strong></span>
            </div>
        `),t.innerHTML=`
        <div class="stats-row main-stats">
            <span>کل کلاس‌ها: <strong>${e}</strong></span>
            <span>|</span>
            <span>کل دانش‌آموزان: <strong>${c}</strong></span>
        </div>
        ${o} 
    `}function Ue(){Jn(),Mt.innerHTML="",Object.values(re).sort((a,e)=>{const c=jn(a),o=jn(e);return c.sortIndex!==o.sortIndex?c.sortIndex-o.sortIndex:c.type==="upcoming"?c.nextTimestamp-o.nextTimestamp:new Date(a.info.creationDate)-new Date(e.info.creationDate)}).forEach(a=>{if(a.isDeleted)return;const e=jr(a);Mt.appendChild(e)})}function ut(){cs.innerHTML="",N&&ke(N.students).forEach(t=>{const a=document.createElement("li");a.dataset.studentId=t.identity.studentId;const e=document.createElement("span");e.textContent=t.identity.name,e.style.flexGrow="1",e.className="student-name-link",e.addEventListener("click",()=>{Fe(t)}),a.appendChild(e),a.addEventListener("contextmenu",c=>{dn(c,[{label:"تغییر نام",icon:"✏️",action:()=>{Gs(t,N)}},{label:"انتقال دانش‌آموز",icon:"➡️",action:()=>{Zs(t,N)}},{label:"حذف دانش‌آموز",icon:"🗑️",className:"danger",action:()=>{Ee(`آیا از انتقال دانش‌آموز «${t.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const n={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${t.identity.name}» از کلاس «${N.info.name}»`,restoreData:{studentId:t.identity.studentId,classId:N.info.scheduleCode}};pe.unshift(n),pe.length>50&&pe.pop(),t.isDeleted=!0,Se(N.info.name,`دانش‌آموز «${t.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),ut(),Y(`✅ دانش‌آموز «${t.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}])}),cs.appendChild(a)})}function Ht(){if(ls.innerHTML="",!N)return;N.categories.filter(a=>!a.isDeleted).forEach(a=>{const e=document.createElement("li"),c=document.createElement("div");c.className="name-and-badge-container";const o=document.createElement("span");if(o.textContent=a.name,c.appendChild(o),a.isGradedCategory){const i=document.createElement("span");i.className="category-badge",i.textContent="نمره‌دار",c.appendChild(i)}const n=document.createElement("button");n.className="btn-icon",n.innerHTML="🗑️",n.style.color="var(--color-warning)",n.addEventListener("click",()=>{Ee(`آیا از انتقال دسته‌بندی «${a.name}» به سطل زباله مطمئن هستید؟`,()=>{const i={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${a.name}» از کلاس «${N.info.name}»`,restoreData:{categoryId:a.id,classId:N.info.scheduleCode}};pe.unshift(i),pe.length>50&&pe.pop(),a.isDeleted=!0,Se(N.info.name,`دسته‌بندی «${a.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),Ht(),Y(`✅ دسته‌بندی «${a.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}),e.appendChild(c),e.appendChild(n),ls.appendChild(e)})}function ca(){if(!N)return;const t=N.info.type||"in-person",a=document.querySelector(`#settings-page input[name="class-type-setting"][value="${t}"]`);a&&(a.checked=!0);const e=N.info.scheduleDays||[];document.querySelectorAll('input[name="schedule-day"]').forEach(c=>{c.checked=e.includes(parseInt(c.value))}),document.getElementById("settings-schedule-start").value=N.info.scheduleStartTime||"",document.getElementById("settings-schedule-end").value=N.info.scheduleEndTime||""}function tn(t){document.querySelectorAll(".page").forEach(e=>{e.classList.remove("active")});const a=document.getElementById(t);a&&a.classList.add("active"),t==="class-management-page"?(He(null),Ze(null),Je(null),Ue(),fs.style.display="flex"):fs.style.display="none",na()}function ge(t,a={}){const{tab:e}=a,c={pageId:t,currentClassName:N?N.info.name:null,selectedSessionNumber:J?J.sessionNumber:null,selectedStudentId:Ie?Ie.identity.studentId:null};let o=`#${t}`;const n=new URLSearchParams(window.location.hash.split("?")[1]||"");N?n.set("class",N.info.name):n.delete("class"),J?n.set("session",J.sessionNumber):n.delete("session"),Ie?n.set("student",Ie.identity.studentId):n.delete("student"),t==="session-dashboard-page"&&e?n.set("tab",e):t!=="session-dashboard-page"&&n.delete("tab");const i=n.toString();i&&(o+=`?${i}`),window.location.hash!==o&&history.pushState(c,"",o),tn(t)}function qr(t,a){const e=document.createElement("div");e.className="list-item-buttons",e.style.gap="10px";const c=document.createElement("button");if(c.className="btn-icon",c.innerHTML="📝",c.title="ویرایش یادداشت جلسه",t.note||(c.style.display="none"),c.addEventListener("click",o=>{o.stopPropagation(),Ks(t,a)}),!t.isFinished&&!t.isCancelled){const o=document.createElement("button");o.className="btn-success",o.textContent="پایان جلسه",o.style.fontSize="12px",o.style.padding="4px 10px",o.style.whiteSpace="nowrap",o.addEventListener("click",n=>{n.stopPropagation(),Ee(`جلسه شماره ${a} خاتمه پیدا خواهد کرد!`,()=>{N.endSpecificSession(t.sessionNumber),ce(),Se(N.info.name,`جلسه ${a} خاتمه یافت.`,{type:"VIEW_SESSIONS"}),We(),Ee("جلسه با موفقیت خاتمه یافت. آیا مایل به ایجاد فایل پشتیبان هستید؟",()=>{if(lt){Y("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است.");return}cn(),Y("✅فایل پشتیبان با موفقیت ایجاد شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}),e.appendChild(o)}return e.appendChild(c),e}function Zr(t,a){const e=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="flex-start",e.style.flexGrow="1";const c=new Date(t.startTime).toLocaleDateString("fa-IR"),o=document.createElement("span");o.className="session-list-title";const n=document.createElement("div");n.style.display="flex",n.style.gap="5px",n.style.marginTop="5px";const i=new Date(t.startTime).toLocaleDateString("fa-IR",{weekday:"long"}),s=document.createElement("span");if(s.className="type-badge day-badge",s.textContent=i,n.appendChild(s),t.isCancelled){o.textContent=`لغو شده - تاریخ: ${c}`,e.style.cursor="default";const r=document.createElement("span");r.className="type-badge cancelled-badge",r.textContent="لغو شده",n.appendChild(r)}else o.textContent=`جلسه ${a} - تاریخ: ${c}`,e.style.cursor="pointer",e.addEventListener("click",()=>{Ze(t),Pt()});if(e.appendChild(o),t.isFinished){const r=document.createElement("span");r.className="type-badge finished-badge",r.textContent="خاتمه یافته",n.appendChild(r)}if(t.isMakeup){const r=document.createElement("span");r.className="type-badge makeup-badge",r.textContent="جبرانی",n.appendChild(r)}return e.appendChild(n),e}function Gr(t,a){const e=document.createElement("li"),c=a.get(t.sessionNumber),o=Zr(t,c);e.appendChild(o);const n=qr(t,c);return e.appendChild(n),e.addEventListener("contextmenu",i=>{const s=[{label:"یادداشت جلسه",icon:"📝",action:()=>{Ks(t,c)}},{label:t.isCancelled?"بازگردانی جلسه":"لغو جلسه",icon:"❌",action:()=>{const r=t.isCancelled?"بازگردانی جلسه":"لغو جلسه",l=t.isCancelled?"آیا از بازگردانی این جلسه مطمئن هستید؟":"آیا از لغو این جلسه مطمئن هستید؟ جلسه لغو شده در آمار تاثیری ندارد اما قابل بازگردانی است.";Ee(l,()=>{t.isCancelled=!t.isCancelled;const h=t.isCancelled?`جلسه ${c} لغو شد.`:`جلسه لغو شده (تاریخ: ${new Date(t.startTime).toLocaleDateString("fa-IR")}) بازگردانی شد.`;Se(N.info.name,h,{type:"VIEW_SESSIONS"}),ce(),We(),Y(t.isCancelled?"✅جلسه لغو شد.":"✅جلسه بازگردانی شد.")},{confirmText:r,confirmClass:"btn-warning"})}},{label:"تغییر وضعیت جبرانی",icon:"🔄",action:()=>{N.markAsMakeup(t.sessionNumber),ce();const r=t.isMakeup?`جلسه ${c} به عنوان جبرانی علامت‌گذاری شد.`:`جلسه ${c} از حالت جبرانی خارج شد.`;Se(N.info.name,r,{type:"VIEW_SESSIONS"}),We()}},{label:"حذف جلسه",icon:"🗑️",className:"danger",action:()=>{const r=t.isCancelled?"لغو شده":c;Ee(`آیا از انتقال جلسه ${r} به سطل زباله مطمئن هستید؟`,()=>{const l={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"session",description:`جلسه ${r} از کلاس «${N.info.name}»`,restoreData:{sessionNumber:t.sessionNumber,classId:N.info.scheduleCode}};pe.unshift(l),pe.length>50&&pe.pop(),t.isDeleted=!0,Se(N.info.name,`جلسه ${r} به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),We(),Y(`✅ جلسه ${r} به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}},{label:"تغییر تاریخ",icon:"📅",action:()=>{const r=document.getElementById("dp-day"),l=document.getElementById("dp-month"),h=document.getElementById("dp-year"),p=ni.toJalaali(t.startTime);r.innerHTML="";for(let y=1;y<=31;y++){const m=document.createElement("option");m.value=y,m.textContent=y.toLocaleString("fa-IR"),y===p.jd&&(m.selected=!0),r.appendChild(m)}const f=["فروردین","اردیبهشت","خرداد","تیر","مرداد","شهریور","مهر","آبان","آذر","دی","بهمن","اسفند"];l.innerHTML="",f.forEach((y,m)=>{const v=document.createElement("option");v.value=m+1,v.textContent=y,m+1===p.jm&&(v.selected=!0),l.appendChild(v)}),h.innerHTML="";const u=p.jy;for(let y=u-5;y<=u+5;y++){const m=document.createElement("option");m.value=y,m.textContent=y.toString().replace(/\d/g,v=>"۰۱۲۳۴۵۶۷۸۹"[v]),y===p.jy&&(m.selected=!0),h.appendChild(m)}Fn(y=>{if(!y)return;const m=ni.toGregorian(parseInt(y.jy),parseInt(y.jm),parseInt(y.jd)),v=new Date(m.gy,m.gm-1,m.gd);v.setHours(t.startTime.getHours()),v.setMinutes(t.startTime.getMinutes()),v.setSeconds(t.startTime.getSeconds());const b=t.startTime.toLocaleDateString("fa-IR");t.startTime=v;const C=t.startTime.toLocaleDateString("fa-IR");Se(N.info.name,`تاریخ جلسه ${c} از ${b} به ${C} تغییر یافت.`,{type:"VIEW_SESSIONS"}),ce(),We(),Y(`✅ تاریخ جلسه به ${C} تغییر یافت.`)}),$e("date-picker-modal")}}];dn(i,s)}),e}function We(){const t=document.getElementById("session-list");if(!N)return;if(t.innerHTML="",N.sessions.length===0){t.innerHTML="<li>هنوز جلسه‌ای شروع نشده است.</li>";return}const a=tt(N);[...ke(N.sessions)].reverse().forEach(c=>{const o=Gr(c,a);t.appendChild(o)})}function Jt(t){if(pt.innerHTML="",t.length>0)t.forEach(a=>{const e=document.createElement("div");e.textContent=a.identity.name,e.addEventListener("click",()=>{Fe(a),pt.style.display="none",ps.value=""}),pt.appendChild(e)}),pt.style.display="block";else if(ps.value.trim()!==""){const a=document.createElement("div");a.className="no-results",a.textContent="پیدا نشد",pt.appendChild(a),pt.style.display="block"}else pt.style.display="none"}function Sn(t){if(ot.innerHTML="",t.length>0)t.forEach(a=>{const e=document.createElement("div");if(e.className="global-search-result",a.type==="student"){const c=document.createElement("span");c.className="student-name",c.textContent=a.student.identity.name;const o=document.createElement("span");o.className="class-name",o.textContent=`کلاس: ${a.classroom.info.name}`,e.addEventListener("click",()=>{He(a.classroom),Fe(a.student),ot.style.display="none",Gt.value=""}),o.addEventListener("click",n=>{n.stopPropagation(),He(a.classroom),Ze(null),sn(a.classroom.liveSession),We(),ge("session-page"),ot.style.display="none",Gt.value=""}),e.appendChild(c),e.appendChild(o)}else if(a.type==="classroom"){const c=document.createElement("span");c.className="student-name",c.textContent=`[کلاس] ${a.classroom.info.name}`,e.addEventListener("click",()=>{He(a.classroom),Ze(null),sn(a.classroom.liveSession),We(),ge("session-page"),ot.style.display="none",Gt.value=""}),e.appendChild(c)}ot.appendChild(e)}),ot.style.display="block";else if(Gt.value.trim()!==""){const a=document.createElement("div");a.className="no-results",a.textContent="پیدا نشد",ot.appendChild(a),ot.style.display="block"}else ot.style.display="none"}function ln(){const t=document.getElementById("trashed-items-list");if(t.innerHTML="",pe.length===0){t.innerHTML='<li style="text-align: center; padding: 20px;">سطل زباله خالی است.</li>';return}pe.forEach((a,e)=>{const c=document.createElement("li"),o=document.createElement("span");o.textContent=a.description,o.style.flexGrow="1";const n=document.createElement("div");n.className="list-item-buttons";const i=document.createElement("button");i.className="btn-icon",i.innerHTML="🔄",i.title="بازیابی",i.addEventListener("click",()=>{var p;let r=!1,l=null;const h=a.restoreData;switch(a.type){case"classroom":{const f=re[h.name];f&&!f.isDeleted?l=`کلاسی با نام «${h.name}» از قبل فعال است.`:f&&f.isDeleted&&(f.isDeleted=!1,r=!0);break}case"student":{const f=Object.values(re).find(y=>y.info.scheduleCode===h.classId),u=f==null?void 0:f.students.find(y=>y.identity.studentId===h.studentId);u&&(u.isDeleted=!1,r=!0);break}case"session":{const f=Object.values(re).find(y=>y.info.scheduleCode===h.classId),u=f==null?void 0:f.sessions.find(y=>y.sessionNumber===h.sessionNumber);u&&(u.isDeleted=!1,r=!0);break}case"category":{const f=Object.values(re).find(y=>y.info.scheduleCode===h.classId),u=f==null?void 0:f.categories.find(y=>y.id===h.categoryId);u&&(u.isDeleted=!1,r=!0);break}case"score":{const f=Object.values(re).find(m=>m.info.scheduleCode===h.classId),u=f==null?void 0:f.students.find(m=>m.identity.studentId===h.studentId),y=(p=u==null?void 0:u.logs.scores[h.skill.toLowerCase()])==null?void 0:p.find(m=>m.id===h.scoreId);y&&(y.isDeleted=!1,r=!0);break}case"note":{const f=Object.values(re).find(m=>m.info.scheduleCode===h.classId),u=f==null?void 0:f.students.find(m=>m.identity.studentId===h.studentId),y=u==null?void 0:u.profile.notes.find(m=>m.id===h.noteId);y&&(y.isDeleted=!1,r=!0);break}}r?(pe.splice(e,1),ce(),ln(),a.type==="classroom"&&Ue(),Y("✅ آیتم با موفقیت بازیابی شد.")):Y(l?`⚠️ ${l}`:"⚠️ آیتم اصلی برای بازیابی یافت نشد.")});const s=document.createElement("button");s.className="btn-icon",s.innerHTML="🔥",s.title="حذف دائمی",s.addEventListener("click",()=>{Ee("آیا از حذف دائمی این آیتم مطمئن هستید؟ این عمل غیرقابل بازgشت است.",()=>{const r=a.restoreData,l=p=>Object.values(re).find(f=>f.info.scheduleCode===p);let h;switch(a.type){case"classroom":delete re[r.name];break;case"student":h=l(r.classId),Mn({identity:{studentId:r.studentId}},h);break;case"session":h=l(r.classId),h&&bi(h.info.name,r.sessionNumber);break;case"category":h=l(r.classId),h&&vi(h.info.name,r.categoryId);break;case"score":h=l(r.classId),h&&Ci(h.info.name,r.studentId,r.skill,r.scoreId);break;case"note":h=l(r.classId),h&&wi(h.info.name,r.studentId,r.noteId);break}pe.splice(e,1),ce(),ln(),Y("✅ آیتم برای همیشه حذف شد.")},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),n.appendChild(i),n.appendChild(s),c.appendChild(o),c.appendChild(n),t.appendChild(c)})}function Vr(){const t=document.getElementById("absentees-summary-container");t&&(t.innerHTML=`
        <div id="absentees-summary-box" class="absentees-summary">
            <div class="absentees-summary-header">
                <h4>لیست غایبین جلسه شماره <span id="absentee-summary-session-number"></span></h4>
                <button id="copy-absentees-btn" class="btn-icon" title="کپی لیست غایبین">📋</button>
            </div>
            <div id="absentees-summary-list" class="summary-list"></div>
        </div>
    `)}function la(){const t=document.getElementById("absentees-summary-box"),a=document.getElementById("absentees-summary-list"),e=document.getElementById("absentee-summary-session-number");if(!t||!a||!e){console.error("Could not find all absentee summary elements.");return}if(!N||!J){t.classList.remove("visible");return}const c=ke(N.students).filter(n=>{const i=J.studentRecords[n.identity.studentId];return i&&i.attendance==="absent"}),o=tt(N);e.textContent=o.get(J.sessionNumber),c.length>0?t.classList.add("visible"):t.classList.remove("visible"),a.innerHTML="",c.forEach(n=>{const s=(l=>N.sessions.reduce((h,p)=>{if(p.isDeleted||p.isCancelled)return h;const f=p.studentRecords[l.identity.studentId];return h+(f&&f.attendance==="absent"?1:0)},0))(n),r=document.createElement("span");r.className="summary-name",r.textContent=`${n.identity.name} (غیبت: ${s})`,r.addEventListener("click",()=>{r.classList.add("fading-out"),setTimeout(()=>{J.setAttendance(n.identity.studentId,"present"),ce(),at()},200)}),a.appendChild(r)})}function Jr(){const t=document.getElementById("copy-absentees-btn");if(!t){console.error("Could not find the copy absentees button to attach listener.");return}t.addEventListener("click",()=>{if(!N||!J)return;const a=ke(N.students).filter(o=>{const n=J.studentRecords[o.identity.studentId];return n&&n.attendance==="absent"});if(a.length===0){Y("⚠️لیست غایبین خالی است.");return}const e=o=>N.sessions.reduce((n,i)=>{if(i.isDeleted||i.isCancelled)return n;const s=i.studentRecords[o.identity.studentId];return n+(s&&s.attendance==="absent"?1:0)},0);let c=`لیست غایبین جلسه شماره ${zr()}:

`;a.forEach(o=>{const n=e(o);c+=`- ${o.identity.name} (تعداد غیبت‌ها: ${n})
`}),navigator.clipboard.writeText(c).then(()=>{Y("✅لیست غایبین با موفقیت کپی شد.")}).catch(o=>{console.error("Failed to copy text: ",o),Y("❌خطا در کپی کردن لیست.")})})}function In(){const t=document.getElementById("demo-mode-banner");t&&(lt?(t.classList.add("visible"),document.body.classList.add("demo-mode-active")):(t.classList.remove("visible"),document.body.classList.remove("demo-mode-active")))}function jn(t){const{scheduleDays:a,scheduleStartTime:e,scheduleEndTime:c}=t.info,o=a&&a.length>0,n=e&&c;if(!o&&!n)return{type:"unscheduled",sortIndex:3};if(!o||!n)return{type:"incomplete",sortIndex:2};const i=new Date,s=i.getDay(),r=i.getHours()*60+i.getMinutes(),[l,h]=e.split(":").map(Number),[p,f]=c.split(":").map(Number),u=l*60+h,y=p*60+f;if(a.includes(s)&&r>=u&&r<y)return{type:"active",sortIndex:0};for(let m=0;m<=7;m++){const v=(s+m)%7;if(a.includes(v)){if(m===0&&r>=u)continue;const b=new Date(i);return b.setDate(i.getDate()+m),b.setHours(l,h,0,0),{type:"upcoming",sortIndex:1,nextTimestamp:b.getTime()}}}return{type:"upcoming",sortIndex:1,nextTimestamp:9999999999999}}function Kr(t,a){const{scheduleDays:e,scheduleStartTime:c,scheduleEndTime:o}=t.info;if(!e||!e.length||!c||!o)return null;const[n,i]=c.split(":").map(Number),[s,r]=o.split(":").map(Number),l=n*60+i,h=s*60+r;for(const p of Object.values(a)){if(p===t||p.isDeleted||p.info.name===t.info.name)continue;const f=p.info;if(!f.scheduleDays||!f.scheduleDays.length||!f.scheduleStartTime||!f.scheduleEndTime||!e.some(S=>f.scheduleDays.includes(S)))continue;const[y,m]=f.scheduleStartTime.split(":").map(Number),[v,b]=f.scheduleEndTime.split(":").map(Number),C=y*60+m,_=v*60+b;if(l<_&&h>C)return p.info.name}return null}function Yr(t){if(!t||t.length===0)return"";const a={6:"شنبه",0:"۱شنبه",1:"۲شنبه",2:"۳شنبه",3:"۴شنبه",4:"۵شنبه",5:"جمعه"};return[...t].sort((c,o)=>{const n={6:0,0:1,1:2,2:3,3:4,4:5,5:6};return n[c]-n[o]}).map(c=>a[c]).join("، ")}async function da(){const t=document.getElementById("restore-points-list");t.innerHTML='<li style="text-align:center; padding:20px;">در حال بارگذاری...</li>';try{const a=await Ia();if(a.length===0){t.innerHTML='<li style="text-align:center; padding:20px;">هیچ فایل پشتیبانی یافت نشد.</li>';return}t.innerHTML="",a.forEach(e=>{const c=document.createElement("li");c.className="restore-point-card";const o=new Date(e.timestamp).toLocaleString("fa-IR",{weekday:"long",year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"}),n=(e.file.size/1024).toFixed(1)+" KB";c.innerHTML=`
                <div class="restore-card-header">
                    <span class="restore-date">${o}</span>
                    <span class="restore-size">${n}</span>
                </div>
                <div class="restore-desc">${e.metadata.description||"بدون توضیحات"}</div>
                <div class="restore-actions">
                    <button class="btn-restore-action">بازگردانی</button>
                </div>
            `,c.querySelector(".btn-restore-action").addEventListener("click",async()=>{try{const s=await e.file.text(),h=(await new ks().loadAsync(s,{base64:!0})).file("backup.json");if(!h)throw new Error("فایل backup.json یافت نشد.");const p=await h.async("string"),f=JSON.parse(p);Un(f)}catch(s){console.error("Restore failed:",s),Y("❌ فایل پشتیبان معتبر نیست.")}}),t.appendChild(c)})}catch(a){console.error("Failed to load snapshots:",a),t.innerHTML='<li style="text-align:center; color:red;">خطا در بارگذاری اطلاعات.</li>'}}function Xr(t,a,e="default",c=!1){let o=[...ke(t.students)];const n=new Date().toLocaleDateString("fa-IR",{year:"numeric",month:"long",day:"numeric",weekday:"long"});e==="alpha"&&o.sort((p,f)=>{const u=v=>{if(v.identity.lastName)return v.identity.lastName;const b=v.identity.name.trim().split(/\s+/);return b[b.length-1]||""},y=u(p),m=u(f);return y.localeCompare(m,"fa-IR")});let i="<tr>";a.forEach(p=>{i+=`<th>${p.label}</th>`}),i+="</tr>";let s="";o.forEach((p,f)=>{s+="<tr>",a.forEach(u=>{let y="-";if(u.id==="row_num")y=f+1;else if(u.id==="name")if(p.identity.lastName&&p.identity.firstName)y=`${p.identity.lastName}، ${p.identity.firstName}`;else{const v=p.identity.name.trim().split(/\s+/);if(v.length>1){const b=v.pop(),C=v.join(" ");y=`${b}، ${C}`}else y=p.identity.name}else u.id==="total_selections"?y=p.statusCounters.totalSelections:u.id==="missed_chances"?y=p.statusCounters.missedChances:u.id==="issues"?y=Object.values(p.categoryIssues||{}).reduce((v,b)=>v+b,0):u.id==="absences"?y=t.sessions.reduce((v,b)=>{if(b.isDeleted||b.isCancelled)return v;const C=b.studentRecords[p.identity.studentId];return v+(C&&C.attendance==="absent"?1:0)},0):u.id==="avg_score"?y=p.getOverallAverageScore()||"-":u.id==="final_score"?y=t.calculateFinalStudentScore(p)||"-":u.type==="category"&&(y=p.categoryCounts[u.id]||0);const m=u.id==="name"?'style="text-align: right;"':"";s+=`<td ${m}>${y}</td>`}),s+="</tr>"});let r="";c&&(r=`
            <div class="warning-footnote">
                ⚠️ <strong>توجه:</strong> ترتیب الفبایی این لیست ممکن است دقیق نباشد. (نام خانوادگی برخی دانش‌آموزان در سیستم تفکیک نشده است)
            </div>
        `);const l=window.open("","_blank");if(!l){Y("⚠️ مرورگر شما پنجره جدید را مسدود کرد. لطفاً اجازه دهید.","error");return}const h=`
        <!DOCTYPE html>
        <html lang="fa" dir="rtl">
        <head>
            <title>گزارش کلاس ${t.info.name}</title>
            <style>
                @media print {
                    @page { size: A4; margin: 10mm; }
                    body { font-family: Tahoma, 'Vazirmatn', sans-serif; color: #000; }
                }
                body { font-family: Tahoma, sans-serif; padding: 20px; direction: rtl; }
                h1 { text-align: center; margin-bottom: 5px; font-size: 24px; }
                .meta { text-align: center; margin-bottom: 30px; font-size: 14px; color: #444; }
                table { width: 100%; border-collapse: collapse; font-size: 12px; }
                th, td { border: 1px solid #333; padding: 6px 8px; text-align: center; }
                th { background-color: #eee; font-weight: bold; }
                tr:nth-child(even) { background-color: #f9f9f9; }
                .signature { margin-top: 50px; display: flex; justify-content: space-between; padding: 0 50px; }
                
                .warning-footnote {
                    margin-top: 20px;
                    font-size: 11px;
                    color: #555;
                    font-style: italic;
                    border-top: 1px solid #ccc;
                    padding-top: 10px;
                }
            </style>
        </head>
        <body>
            <h1>گزارش وضعیت کلاس ${t.info.name}</h1>
            <div class="meta">
                تاریخ گزارش: ${n} | تعداد دانش‌آموزان: ${o.length}
            </div>
            <table>
                <thead>${i}</thead>
                <tbody>${s}</tbody>
            </table>
            ${r}
            <div class="signature">
                <div>امضای معلم</div>
                <div>مهر و امضای مدرسه</div>
            </div>
            <script>
                window.onload = function() { window.print(); }
            <\/script>
        </body>
        </html>
    `;l.document.write(h),l.document.close()}function Qr(t){const a=Zi;a.innerHTML="";const c=ke(t.students).filter(f=>!f.identity.lastName).length,o=[{id:"row_num",label:"ردیف",checked:!0},{id:"name",label:"نام دانش‌آموز",checked:!0},{id:"total_selections",label:"کل انتخاب‌ها",checked:!0},{id:"absences",label:"تعداد غیبت",checked:!0},{id:"missed_chances",label:"فرصت سوخته",checked:!1},{id:"issues",label:"موارد انضباطی",checked:!1},{id:"avg_score",label:"میانگین نمرات",checked:!0},{id:"final_score",label:"نمره نهایی (کانون)",checked:!0}];t.categories.forEach(f=>{f.isDeleted||o.push({id:f.name,label:`تعداد ${f.name}`,type:"category",checked:!1})}),o.forEach(f=>{const u=document.createElement("label");u.className="report-column-item";const y=document.createElement("input");y.type="checkbox",y.checked=f.checked,y.dataset.colId=f.id,y.dataset.colLabel=f.label,f.type&&(y.dataset.colType=f.type);const m=document.createElement("span");m.textContent=f.label,u.appendChild(y),u.appendChild(m),a.appendChild(u)});const n=a.parentElement,i=n.querySelector("#report-sort-options");i&&i.remove();const s=document.createElement("div");s.id="report-sort-options",s.style.marginTop="20px",s.style.padding="15px",s.style.backgroundColor="#f8f9fa",s.style.borderRadius="5px",s.style.border="1px solid #e9ecef",s.innerHTML=`
        <div style="margin-bottom: 10px; font-weight: bold; color: #333;">ترتیب نمایش لیست:</div>
        
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <label style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <input type="radio" name="report-sort" value="default" checked style="accent-color: var(--color-primary);">
                <span>پیش‌فرض (بر اساس زمان ورود به کلاس)</span>
            </label>
            
            <label style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <input type="radio" name="report-sort" value="alpha" style="accent-color: var(--color-primary);">
                <span>الفبایی (بر اساس نام خانوادگی)</span>
            </label>
        </div>

        <div id="sort-warning" style="
            display: none; 
            margin-top: 12px; 
            background-color: #fff3cd; 
            color: #856404; 
            padding: 10px; 
            border-radius: 4px; 
            font-size: 13px; 
            border: 1px solid #ffeeba;
            line-height: 1.5;
        ">
            ⚠️ <strong>توجه:</strong> نام خانوادگی ${c} دانش‌آموز هنوز تفکیک نشده است. مرتب‌سازی این موارد ممکن است کاملاً دقیق نباشد.
        </div>
    `;const r=n.querySelector(".modal-actions");n.insertBefore(s,r);const l=s.querySelectorAll('input[name="report-sort"]'),h=s.querySelector("#sort-warning"),p=()=>{const f=s.querySelector('input[value="alpha"]').checked;h.style.display=f&&c>0?"block":"none"};l.forEach(f=>f.addEventListener("change",p)),Gi.onclick=()=>{const f=[];if(a.querySelectorAll('input[type="checkbox"]:checked').forEach(v=>{f.push({id:v.dataset.colId,label:v.dataset.colLabel,type:v.dataset.colType})}),f.length===0){Y("⚠️ لطفاً حداقل یک ستون را انتخاب کنید.");return}const y=s.querySelector('input[name="report-sort"]:checked').value,m=y==="alpha"&&c>0;ve(),Xr(t,f,y,m)},Vi.onclick=()=>{ve()},$e("report-config-modal")}const eo=Object.freeze(Object.defineProperty({__proto__:null,_internalShowPage:tn,addCategoryBtn:Ya,addClassBtn:Ma,addNoteModal:dr,addScoreBtn:gr,addStudentBtn:Pa,appHeader:fs,attendanceListUl:Yt,attendanceMassActionsContainer:En,attendancePage:Xa,attendancePane:Ft,attendanceSearchInput:_t,backToSessionsBtn:$a,backToStudentPageBtn:mr,backupDataBtn:ar,breadcrumbContainer:At,cancelImportBtn:Ja,cancelNoteBtn:fr,categoryListUl:ls,categoryModal:xr,categoryModalCancelBtn:Lr,categoryModalSaveBtn:Ki,categoryModalTitle:Ji,classListHeader:er,classListUl:Mt,classManagementPage:$i,classSaveNoteBtn:ur,closeActiveModal:ve,closeContextMenu:kt,closeNavBtn:sr,columnMappingPage:Ga,columnSelectDropdown:us,confirmColumnBtn:Va,confirmModalCancelBtn:hs,confirmModalConfirmBtn:Zt,confirmModalMessage:Wi,contextMenu:It,csvCancelBtn:ja,csvConfirmBtn:Ua,csvFileInput:Za,csvPreviewList:ds,csvPreviewPage:Wa,customConfirmModal:or,displayWinner:Re,finishAttendanceBtn:Qa,globalStudentSearchInput:Gt,globalStudentSearchResultsDiv:ot,gradedCategoryPillsContainer:hr,hamburgerMenuBtn:tr,handleUndo:Qi,importCsvBtn:qa,initiateBackupProcess:cn,isGradedCheckbox:vr,massCommentAppendCheckbox:qs,massCommentBtn:ys,massCommentCancelBtn:Nr,massCommentContent:en,massCommentModal:Tr,massCommentModalTitle:Br,massCommentSaveBtn:Dr,massCommentStudentCountMessage:Yi,newCategoryModalIsGradedCheckbox:js,newCategoryModalNameInput:Qt,newCategoryNameInput:Ka,newClassNameInput:Oa,newNoteContent:_e,newScoreCommentTextarea:qi,newScoreValueInput:pr,newStudentNameInput:Fa,openContextMenu:dn,openModal:$e,overlay:ir,pasteArea:Pi,processMassHomeworkComment:vs,processPasteBtn:Ha,profileScoresListUl:br,profileStatsSummaryDiv:yr,quickGradeFormWrapper:Ot,quickGradeSubmitBtn:St,quickNoteTextarea:st,quickScoreInput:dt,renderAttendancePage:at,renderBreadcrumbs:na,renderClassList:Ue,renderClassManagementStats:Jn,renderColumnSelector:oa,renderGlobalSearchResults:Sn,renderImportPreview:_s,renderLogModal:ta,renderMassCommentControls:Vs,renderRestorePointsPage:da,renderScoresHistory:aa,renderSearchResults:Jt,renderSessionDashboard:Pt,renderSessions:We,renderSettingsCategories:Ht,renderSettingsOther:ca,renderSettingsStudentList:ut,renderStudentNotes:ra,renderStudentStatsList:ze,renderTrashPage:ln,reportCancelBtn:Vi,reportColumnsContainer:Zi,reportConfigModal:Ir,reportPrintBtn:Gi,restoreDataBtn:rr,restoreFileInput:Hi,secureConfirmCancelBtn:lr,secureConfirmCode:ji,secureConfirmConfirmBtn:wn,secureConfirmInput:Dt,secureConfirmMessage:Ui,secureConfirmModal:cr,selectStudentBtn:it,selectStudentBtnWrapper:$t,sessionDashboardPage:Ar,setAutoDirectionOnInput:sa,settingsClassNameHeader:Us,settingsPage:za,settingsStudentListUl:cs,setupDashboardTabs:Xi,setupLongPress:Vt,showCategoryModal:bs,showClassNoteModal:Vn,showCustomConfirm:Ee,showMassCommentModal:Js,showMoveStudentModal:Zs,showNotification:Y,showPage:ge,showRenameStudentModal:Gs,showRestoreConfirmModal:Un,showSecureConfirm:ea,showSessionNoteModal:Ks,showSettingsPage:zt,showStudentProfile:Fe,showUndoToast:Or,sideNavMenu:nr,studentSearchInput:ps,studentSearchResultsDiv:pt,studentStatsHeader:ms,switchDashboardTab:on,trashedCategoriesList:_r,trashedClassesList:Cr,trashedNotesList:kr,trashedScoresList:Sr,trashedSessionsList:Er,trashedStudentsList:wr,triggerFileDownload:Cs,undoBtn:Ra,undoMessage:Fi,undoToast:Wn,updateDemoModeBanner:In},Symbol.toStringTag,{value:"Module"}));function to(){const t=window.location.hash;if(!t||t==="#")return!1;const[a,e]=t.split("?"),c=a.substring(1),o=new URLSearchParams(e),n=o.get("class"),i=parseInt(o.get("session"),10),s=o.get("student"),r=o.get("tab")||"selector";if(n&&re[n])He(re[n]),i&&N.getSession(i)&&Ze(N.getSession(i)),s&&N.students.find(l=>l.identity.studentId===s)&&Je(N.students.find(l=>l.identity.studentId===s));else return!1;switch(c){case"session-page":We(),ge("session-page");break;case"session-dashboard-page":Pt(c==="attendance-page"?"attendance":r);break;case"settings-page":Us.textContent=`تنظیمات کلاس: ${N.info.name}`,ut(),Ht(),ge("settings-page");break;case"student-profile-page":Pt(r),Fe(Ie);break;default:return!1}return!0}document.addEventListener("DOMContentLoaded",()=>{const{globalStudentSearchInput:t,newClassNameInput:a,addClassBtn:e,undoBtn:c,newStudentNameInput:o,addStudentBtn:n,pasteArea:i,processPasteBtn:s,csvPreviewList:r,csvConfirmBtn:l,csvCancelBtn:h,importCsvBtn:p,csvFileInput:f,columnSelectDropdown:u,confirmColumnBtn:y,cancelImportBtn:m,newCategoryNameInput:v,addCategoryBtn:b,selectStudentBtn:C,attendancePage:_,finishAttendanceBtn:S,classListHeader:I,studentStatsHeader:x,hamburgerMenuBtn:L,sideNavMenu:D,closeNavBtn:R,overlay:P,backupDataBtn:Q,restoreDataBtn:k,restoreFileInput:z,confirmModalCancelBtn:g,confirmModalConfirmBtn:H,secureConfirmCancelBtn:ue,secureConfirmConfirmBtn:j,newNoteContent:fe,classSaveNoteBtn:F,cancelNoteBtn:ne,studentSearchInput:O,studentSearchResultsDiv:M,isGradedCheckbox:oe,categoryModalSaveBtn:te,categoryModalCancelBtn:X,massCommentBtn:Ne,massCommentCancelBtn:Oe,massCommentSaveBtn:he,massCommentContent:Ce,massCommentAppendCheckbox:Te,attendanceSearchInput:Ae}=eo,Ye=document.getElementById("trash-nav-btn");document.querySelector(".global-search-container .search-icon"),On(),In(),to()||(Ue(),ge("class-management-page"));function d(B,Z){const U=document.querySelector(B);if(!U)return;const ee=U.querySelector(".search-icon"),se=U.querySelector(".animated-search-input");!ee||!se||(ee.addEventListener("mousedown",me=>{me.preventDefault()}),ee.addEventListener("click",()=>{U.classList.contains("search-active")||(U.classList.add("search-active"),se.focus())}),se.addEventListener("blur",()=>{setTimeout(()=>{U.classList.remove("search-active"),se.value="",Z&&Z([])},150)}))}Ae.addEventListener("input",()=>{const B=Ae.value.toLowerCase().trim(),Z=ss(B);Yt.querySelectorAll(".attendance-list-item").forEach(ee=>{const se=ee.querySelector(".student-name");if(se){const me=se.textContent,ae=et(me.toLowerCase()),de=ae.includes(et(B)),we=ae.includes(et(Z));de||we?ee.style.display="flex":ee.style.display="none"}})}),X.addEventListener("click",()=>{ve(),Zn(null)}),te.addEventListener("click",()=>{const B=Qt.value.trim(),Z=js.checked;typeof Nn=="function"&&Nn(B,Z)}),window.addEventListener("scroll",kt),document.addEventListener("click",B=>{It.classList.contains("visible")&&!It.contains(B.target)&&kt(),O.contains(B.target)||(M.style.display="none");const Z=B.target.closest(".log-action-link");if(Z&&Z.dataset.action)try{const U=JSON.parse(Z.dataset.action);Tt(U)}catch(U){console.error("Could not parse log action:",U)}}),$t.addEventListener("click",()=>{($t.classList.contains("disabled-wrapper")||it.disabled)&&(it.classList.add("shake-animation"),setTimeout(()=>{it.classList.remove("shake-animation")},200))}),x.addEventListener("click",()=>{const B=new Date().getTime();B-Ts>500?Cn(1):Cn(Tn+1),xi(B),Tn===5&&(Cn(0),Ee("آیا از صفر کردن تمام شمارنده‌های دانش‌آموزان مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{yi(),ze(),Y("تمام آمارها صفر شدند ✅.")},{confirmText:"بله",confirmClass:"btn-warning"}))}),I.addEventListener("click",()=>{const B=new Date().getTime();B-Ls>500?vn(1):vn(Ln+1),Ii(B),Ln===5&&(vn(0),Ee("آیا از ساخت یک کلاس تستی تصادفی مطمئن هستید؟",()=>{function Z(){const U=`کلاس تستی ${Object.keys(re).length+1}`,ee=new as({name:U,type:"online"});["علی رضایی","مریم حسینی","زهرا احمدی","رضا محمدی","فاطمه کریمی"].forEach(me=>ee.addStudent(new yn({name:me}))),re[U]=ee,ce(),Ue()}Z(),Y("کلاس تستی با موفقیت ساخته شد ✅!")},{confirmText:"بساز",confirmClass:"btn-success"}))}),ue.addEventListener("click",()=>{ve(),an(null)});const W=document.getElementById("date-picker-confirm-btn"),$=document.getElementById("date-picker-cancel-btn"),E=document.getElementById("dp-day"),w=document.getElementById("dp-month"),T=document.getElementById("dp-year");W.addEventListener("click",()=>{const B=T.value,Z=w.value,U=E.value;B&&Z&&U&&typeof An=="function"?(An({jy:B,jm:Z,jd:U}),ve()):Y("⚠️ خطا در انتخاب تاریخ."),Fn(null)}),$&&$.addEventListener("click",()=>{ve(),Fn(null)}),j.addEventListener("click",()=>{typeof Bn=="function"&&Bn(),ve(),an(null)}),g.addEventListener("click",()=>{ve(Ns)}),H.addEventListener("click",()=>{ve(Bs)}),C.addEventListener("click",()=>{if(dt.value.trim()!==""||st.value.trim()!==""){Y("⚠️لطفاً ابتدا با دکمه «ثبت»، تغییرات را ذخیره کنید و یا نمره و یادداشت را پاک کنید.");return}if(!N||!J||!Ve)return;const B=N.selectNextWinner(Ve.name,J);if(B){const Z=J.studentRecords[B.identity.studentId];if(Z&&Z.attendance==="absent"&&B.statusCounters.missedChances++,Z&&Z.hadIssue){B.statusCounters.missedChances++;const ee=Ve.name;B.categoryIssues[ee]=(B.categoryIssues[ee]||0)+1}Z&&Z.wasOutOfClass&&(B.statusCounters.outOfClassCount=(B.statusCounters.outOfClassCount||0)+1,B.statusCounters.missedChances++);const U={winner:B,categoryName:Ve.name};J.winnerHistory.push(U),J.winnerHistory.length>10&&J.winnerHistory.shift(),vt(J.winnerHistory.length-1),J.lastUsedCategoryId=Ve.id,J.lastSelectedWinnerId=B.identity.studentId,ze(),setTimeout(()=>Re(),0),ce()}else Y("❌دانش‌آموز واجد شرایطی برای انتخاب یافت نشد.")}),b.addEventListener("click",()=>{if(!N)return;const B=v.value.trim(),Z=oe.checked;if(!B){alert("⚠️لطفاً نام دسته‌بندی را وارد کنید.");return}const U=N.categories.find(se=>se.name.toLowerCase()===B.toLowerCase());if(U)if(U.isDeleted){const se=N.categories.findIndex(me=>me===U);se>-1&&N.categories.splice(se,1)}else{alert("⚠️این دسته‌بندی از قبل وجود دارد.");return}const ee=new ft(B,"",Z);N.categories.push(ee),ce(),Se(N.info.name,`دسته‌بندی جدید «${B}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),Ht(),v.value="",oe.checked=!1}),document.querySelectorAll('#settings-page input[name="class-type-setting"]').forEach(B=>{B.addEventListener("change",()=>{if(!N)return;const Z=B.value,U=N.info.type||"in-person";if(Z===U)return;const ee=ae=>ae==="online"?"آنلاین":"حضوری",se=ee(U),me=ee(Z);Ee(`آیا از تغییر نوع کلاس از «${se}» به «${me}» مطمئن هستید؟`,()=>{N.info.type=Z,ce(),Se(N.info.name,`نوع کلاس به «${me}» تغییر یافت.`,{type:"VIEW_CLASS_SETTINGS"}),Ue(),Y(`✅ نوع کلاس به «${me}» تغییر یافت.`)},{confirmText:"بله",confirmClass:"btn-warning",onCancel:()=>{const ae=document.querySelector(`#settings-page input[name="class-type-setting"][value="${U}"]`);ae&&(ae.checked=!0)}})})});const G=document.querySelectorAll('input[name="schedule-day"]'),A=document.getElementById("settings-schedule-start"),V=document.getElementById("settings-schedule-end");G.forEach(B=>{B.addEventListener("change",()=>{if(!N)return;const Z=Array.from(G).filter(U=>U.checked).map(U=>parseInt(U.value));N.info.scheduleDays=Z,ce()})});const ie=()=>{N&&(N.info.scheduleStartTime=A.value,N.info.scheduleEndTime=V.value,ce())};A.addEventListener("change",ie),V.addEventListener("change",ie),v.addEventListener("keyup",B=>{B.key==="Enter"&&b.click()}),y.addEventListener("click",()=>{if(!xn){alert("❌خطایی رخ داده است. لطفاً فایل را دوباره انتخاب کنید."),ge("settings-page");return}const B=parseInt(u.value,10),ee=xn.split(`
`).slice(1).map(se=>{var ae;return(ae=se.split(",")[B])==null?void 0:ae.trim()}).filter(se=>se&&se.length>0);ee.length>0?(qt(ee),_s(),ge("csv-preview-page")):alert("هیچ نامی در ستون انتخاب شده پیدا نشد. لطفاً ستون دیگری را امتحان کنید یا فایل خود را بررسی کنید."),bn(null)}),p.addEventListener("click",()=>{f.click()}),f.addEventListener("change",B=>{const Z=B.target.files[0];if(!Z)return;const U=new FileReader;U.onload=ee=>{const se=ee.target.result;bn(se);const ae=se.split(`
`)[0].split(",");oa(ae),ge("column-mapping-page")},U.readAsText(Z),B.target.value=null}),m.addEventListener("click",()=>{bn(null),ge("settings-page")}),l.addEventListener("click",()=>{const B=r.querySelectorAll('input[type="checkbox"]:checked');let Z=!1;B.forEach(U=>{const ee=U.dataset.name,se=N.students.find(de=>de.identity.name.toLowerCase()===ee.toLowerCase());if(se)if(se.isDeleted)Mn(se,N);else{console.log(`دانش‌آموز «${ee}» به دلیل تکراری بودن اضافه نشد.`);return}const me=os(ee),ae=new yn(me);N.addStudent(ae),N.sessions.length>0&&(ke(N.sessions).filter(de=>de.isFinished&&!de.isCancelled).forEach(de=>{de.setAttendance(ae.identity.studentId,"absent")}),Qe(ae,N),Z=!0)}),ce(),Se(N.info.name,`${B.length} دانش‌آموز جدید از لیست ورودی به کلاس اضافه شدند.`,{type:"VIEW_SESSIONS"}),ut(),Z&&Wt(B.length),ge("settings-page"),i.value="",qt([])}),h.addEventListener("click",()=>{qt([]),ge("settings-page")}),s.addEventListener("click",()=>{const B=i.value.trim();if(!B){alert("کادر متنی خالی است. لطفاً اسامی را وارد کنید.");return}const Z=B.split(`
`).map(U=>U.trim()).filter(U=>U.length>0);Z.length>0?(qt(Z),_s(),ge("csv-preview-page")):alert("هیچ نام معتبری برای ورود پیدا نشد.")}),o.addEventListener("keyup",B=>{B.key==="Enter"&&n.click()}),n.addEventListener("click",()=>{if(!N)return;const B=o.value.trim();if(!B){alert("لطفاً نام دانش‌آموز را وارد کنید.");return}const Z=N.students.find(se=>se.identity.name.toLowerCase()===B.toLowerCase());if(Z)if(Z.isDeleted)Mn(Z,N);else{alert("❌دانش‌آموزی با این نام از قبل در این کلاس وجود دارد.");return}const U=os(B),ee=new yn(U);N.addStudent(ee),N.sessions.length>0&&(ke(N.sessions).filter(se=>se.isFinished&&!se.isCancelled).forEach(se=>{se.setAttendance(ee.identity.studentId,"absent")}),Qe(ee,N),Wt(1)),ce(),Se(N.info.name,`دانش‌آموز «${B}» به کلاس اضافه شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:ee.identity.studentId}),ut(),ze(),o.value="",o.focus()}),document.getElementById("new-session-btn").addEventListener("click",()=>{if(N){const B=N.sessions.find(U=>!U.isFinished&&!U.isCancelled&&!U.isDeleted);if(B){Y(`⚠️ جلسه ${B.sessionNumber} هنوز تمام نشده است. لطفاً ابتدا با دکمه ✅ آن را خاتمه دهید.`);return}const Z=()=>{const U=ee=>{const se=N.startNewSession();sn(se),Ze(se),N.students.forEach(de=>{Ss.setAttendance(de.identity.studentId,"present")}),ce();const ae=tt(N).get(se.sessionNumber);Se(N.info.name,`جلسه ${ae} شروع شد.`,{type:"VIEW_SESSIONS"}),Pt(ee?"attendance":"selector")};Ee("آیا تمایل به انجام فرآیند حضور و غیاب دارید؟",()=>U(!0),{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success",onCancel:()=>U(!1)})};N.hasSessionToday()?Ee("شما امروز یک جلسه برای این کلاس ثبت کرده‌اید. آیا از شروع یک جلسه جدید دیگر مطمئن هستید؟",Z,{confirmText:"بله",confirmClass:"btn-warning"}):Z()}}),e.addEventListener("click",()=>{const B=a.value.trim(),Z=document.querySelector('input[name="class-type"]:checked');if(!B&&!Z){Y("⚠️لطفاً نام و نوع کلاس را مشخص کنید.");return}if(!B){Y("⚠️لطفاً نام کلاس را وارد کنید.");return}if(!Z){Y("⚠️لطفاً نوع کلاس را انتخاب کنید.");return}if(re[B]){re[B].isDeleted?Y("⚠️ کلاسی با این نام در سطل زباله است. ابتدا آن را بازیابی کنید و یا آن را پاک کنید."):Y("⚠️کلاسی با این نام از قبل وجود دارد.");return}const U=Z.value,ee=new as({name:B,type:U});re[B]=ee,ce(),Se(B,`کلاس «${B}» ایجاد شد.`,{type:"VIEW_SESSIONS"}),Ue(),Y(`✅ کلاس «${B}» با موفقیت ایجاد شد.`),a.value="",Z.checked=!1}),t.addEventListener("input",B=>{const Z=B.target.value;if(Z.length<2){Sn([]);return}const U=Z.toLowerCase(),ee=ss(U),se=[];for(const me in re){const ae=re[me];if(ae.isDeleted)continue;const de=et(me.toLowerCase()),we=de.includes(et(U)),xe=de.includes(et(ee));(we||xe)&&se.push({type:"classroom",classroom:ae})}for(const me in re){const ae=re[me];if(ae.isDeleted)continue;ke(ae.students).filter(we=>{const xe=et(we.identity.name.toLowerCase()),Me=xe.includes(et(U)),Ut=xe.includes(et(ee));return Me||Ut}).forEach(we=>{se.push({type:"student",student:we,classroom:ae})})}Sn(se)}),a.addEventListener("keyup",B=>{B.key==="Enter"&&e.click()}),c.addEventListener("click",Qi),S.addEventListener("click",()=>{on("selector")}),O.addEventListener("input",B=>{const Z=B.target.value;if(!Z){Jt([]);return}const U=Z.toLowerCase(),ee=ss(U),me=ke(N.students).filter(ae=>{const de=et(ae.identity.name.toLowerCase()),we=de.includes(et(U)),xe=de.includes(et(ee));return we||xe});Jt(me)}),O.addEventListener("focus",()=>{O.value&&Jt(O.value)}),St.addEventListener("click",()=>{const B=dt.value,Z=st.value.trim();let U;if(Dn)U=Dn.student;else{const se=J==null?void 0:J.winnerHistory[qe];U=se==null?void 0:se.winner}if(!U){Y("❌خطا: دانش‌آموز معتبری برای ثبت نمره یافت نشد.");return}const ee=Ve;if(!U||!ee){Y("⚠️لطفاً ابتدا یک دانش‌آموز و یک دسته‌بندی را انتخاب کنید.");return}if(!B){Y("⚠️لطفاً مقدار نمره را وارد کنید.");return}if(B>100||B<0){Y("❌نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}U&&(U.addScore(ee.name,parseFloat(B),Z),Se(N.info.name,`نمره ${B} در ${ee.name} برای «${U.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:U.identity.studentId}),ce(),ze(),Y(`✅نمره برای ${U.identity.name} در مهارت ${ee.name} ثبت شد.`),dt.value="",st.value="",Re())});const K=B=>{B.key==="Enter"&&B.ctrlKey&&(B.preventDefault(),St.click())};dt.addEventListener("keydown",K),st.addEventListener("keydown",K),ne.addEventListener("click",()=>{ve()}),F.addEventListener("click",()=>{const B=fe.value.trim(),Z=Ds;if(typeof Z=="function"){const U=Z(B);if(U===!1)return;ve(()=>{typeof U=="function"&&U()})}else ve()});const le=document.getElementById("move-student-confirm-btn"),Le=document.getElementById("move-student-cancel-btn"),ye=document.getElementById("move-student-class-select");Le.addEventListener("click",()=>{ve()}),le.addEventListener("click",()=>{const B=ye.value,Z=re[B],{studentToMove:U,sourceClassForMove:ee}=Ea;if(!U||!ee||!Z){Y("خطایی رخ داد. لطفاً دوباره امتحان کنید⚠️.","error"),ve();return}const se=gi(U,ee,Z);se.success?(Se(ee.info.name,`دانش‌آموز «${U.identity.name}» به کلاس «${B}» منتقل شد.`,{type:"VIEW_SESSIONS"}),Se(B,`دانش‌آموز «${U.identity.name}» از کلاس «${ee.info.name}» به این کلاس منتقل شد.`,{type:"VIEW_SESSIONS"}),ce(),ut(),ze(),at(),Y(`دانش‌آموز «${U.identity.name}» با موفقیت به کلاس «${B}» منتقل شد✅.`)):Y(se.message,"error"),ve()}),L.addEventListener("click",()=>{D.style.width="300px",P.classList.add("modal-visible")}),L.addEventListener("click",()=>{D.style.width="300px",P.classList.add("modal-visible")});const je=document.getElementById("header-settings-btn");je&&je.addEventListener("click",()=>{N&&zt(N)}),R.addEventListener("click",be),R.addEventListener("click",be),P.addEventListener("click",be),Ye.addEventListener("click",()=>{ln(),ge("trash-page"),be()});const mt=document.getElementById("restore-points-nav-btn");mt&&mt.addEventListener("click",()=>{da(),ge("restore-points-page"),be()}),document.getElementById("demo-mode-btn").addEventListener("click",()=>{lt?Ct():(be(),Ee("شما در حال ورود به حالت نمایش (Demo) هستید. در این حالت، هیچ‌کدام از تغییرات شما ذخیره نخواهد شد. آیا ادامه می‌دهید؟",()=>{Ei(),In(),be()},{confirmText:"تایید",confirmClass:"btn-warning",onCancel:be}))});const ht=document.getElementById("exit-demo-btn");ht&&ht.addEventListener("click",()=>{lt&&Ct()}),Q.addEventListener("click",()=>{if(lt){Y("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است."),be();return}be(),cn()}),k.addEventListener("click",()=>{if(lt){Y("⚠️ بازیابی اطلاعات در حالت نمایش (Demo) غیرفعال است."),be();return}z.click(),be()}),z.addEventListener("change",B=>{const Z=B.target.files[0];if(!Z)return;const U=new FileReader;U.onload=async ee=>{const se=ee.target.result;try{const me=JSON.parse(se);if(me.metadata&&me.data)Un(me);else{const ae=me.classrooms||me,de=me.trashBin||[];Ee("آیا از بازیابی اطلاعات مطمئن هستید؟ تمام داده‌های فعلی شما بازنویسی خواهد شد.",()=>{Lt(ae),zs(de),Kt({lastRestoreTimestamp:new Date().toISOString()}),ce(),Ue(),ge("class-management-page"),Y("✅اطلاعات با موفقیت بازیابی شد.")},{confirmText:"بازیابی کن",confirmClass:"btn-warning"})}}catch{try{const we=(await new ks().loadAsync(se,{base64:!0})).file("backup.json");if(!we)throw new Error("فایل backup.json در فایل پشتیبان یافت نشد.");const xe=await we.async("string"),Me=JSON.parse(xe);if(Me.metadata&&Me.metadata.version==="2.0-b64")Un(Me);else throw new Error("فایل پشتیبان معتبر نیست (نسخه نامشخص).")}catch(ae){Y("❌خطا در خواندن فایل. لطفاً فایل پشتیبان معتبر انتخاب کنید."),console.error("Restore error (zip/base64):",ae)}}},U.readAsText(Z),B.target.value=null}),window.addEventListener("popstate",B=>{if(bt){ve(null,!0);return}if(kt(),B.state){const{pageId:Z,currentClassName:U,selectedSessionNumber:ee,selectedStudentId:se}=B.state;U&&(He(re[U]),ee&&Ze(N.getSession(ee)),se&&Je(N.students.find(me=>me.identity.studentId===se))),Z==="session-page"?(We(),tn(Z)):Z==="student-profile-page"?(We(),ge("session-page"),Fe(Ie)):tn(Z)}else He(null),Ze(null),Je(null),tn("class-management-page")}),document.addEventListener("keydown",B=>{var ee;const Z=document.activeElement;if(!["INPUT","TEXTAREA","SELECT"].includes(Z.tagName)){if(B.key.toLowerCase()==="o"&&B.shiftKey&&$i.classList.contains("active")&&(B.preventDefault(),Hi.click()),B.key==="Escape"){if(It.classList.contains("visible")){kt();return}if(bt){ve();return}switch((ee=document.querySelector(".page.active"))==null?void 0:ee.id){case"csv-preview-page":case"column-mapping-page":ge("settings-page");break;case"student-profile-page":Je(null),ge(J?"student-page":"session-page");break;case"attendance-page":ge("student-page");break;case"student-page":Ze(null),We(),ge("session-page");break;case"settings-page":case"session-page":He(null),ge("class-management-page");break}return}if(J){const se=B.key.toLowerCase();switch(" ascfg".includes(se)&&B.preventDefault(),se){case" ":C.click();break;case"a":_.classList.contains("active")?history.back():(at(),ge("attendance-page"));break;case"s":document.getElementById("session-page").classList.contains("active")&&history.back();break;case"c":document.querySelector(".back-to-classes-btn").click();break;case"f":const me=document.querySelector(".action-column .search-icon");me&&me.click();break;case"g":if(studentProfilePage.classList.contains("active"))history.back();else{const ae=J.lastSelectedWinnerId;if(ae){const de=N.students.find(we=>we.identity.studentId===ae);de&&(Je(de),(void 0)(),ge("student-profile-page"))}else Y("⚠️ابتدا یک نفر را انتخاب کنید تا پروفایل او نمایش داده شود.")}break;case"arrowleft":{const ae=document.querySelector('button[title="برنده قبلی"]');ae&&!ae.disabled&&(B.preventDefault(),ae.click());break}case"arrowright":{const ae=document.querySelector('button[title="برنده بعدی"]');ae&&!ae.disabled&&(B.preventDefault(),ae.click());break}}}}});function be(){D.style.width="0",P.classList.add("modal-closing"),setTimeout(()=>{P.classList.remove("modal-visible","modal-closing")},300)}function Ct(){Ee("آیا از خروج از حالت نمایش (Demo) مطمئن هستید؟ با خروج، تمام تغییرات آزمایشی شما حذف شده و داده‌های اصلی شما بازیابی خواهند شد.",()=>{_i(),He(null),Ze(null),Je(null),Ue(),ge("class-management-page"),In(),be()},{confirmText:"خروج",confirmClass:"btn-success"})}d(".global-search-container .animated-search-container",Sn),d(".action-column-header .animated-search-container",Jt),so(),[_e,qi,st,Pi].forEach(B=>{B&&sa(B)});function Qe(B,Z){const U=ke(Z.students).filter(Be=>Be.identity.studentId!==B.identity.studentId);if(U.length===0)return;const ee=U.reduce((Be,Pe)=>Pe.statusCounters.totalSelections>Be.statusCounters.totalSelections?Pe:Be,U[0]);if(!ee||ee.statusCounters.totalSelections===0)return;B.categoryCounts=JSON.parse(JSON.stringify(ee.categoryCounts)),B.statusCounters.totalSelections=ee.statusCounters.totalSelections;const se=U.reduce((Be,Pe)=>Be+Pe.statusCounters.totalSelections,0),me=U.reduce((Be,Pe)=>Be+(Pe.statusCounters.missedChances||0),0),ae=se>0?me/se:0;B.statusCounters.missedChances=Math.round(B.statusCounters.totalSelections*ae);const de=ke(Z.categories),we={};de.forEach(Be=>{const Pe=U.reduce((ts,ns)=>ts+(ns.categoryCounts[Be.name]||0),0),es=U.reduce((ts,ns)=>ts+(ns.categoryIssues[Be.name]||0),0);we[Be.name]=Pe>0?es/Pe:0}),de.forEach(Be=>{const Pe=B.categoryCounts[Be.name]||0,es=we[Be.name]||0;B.categoryIssues[Be.name]=Math.round(Pe*es)});const xe=Z.liveSession;xe?B.onboardingSession=xe.sessionNumber:B.onboardingSession=Z.sessions.length+1;const Me=ke(Z.sessions).filter(Be=>Be.isFinished&&!Be.isCancelled),Ut="📝 یادداشت خودکار سیستم",ha=`این دانش‌آموز  از جلسه شماره ${Me.length} به کلاس اضافه شد. آمار مشارکت او بر اساس فعال‌ترین دانش‌آموز و آمار «فرصت از دست رفته» او بر اساس میانگین کلاس ثبت گردید:`,Bt=[];B.statusCounters.totalSelections>0&&Bt.push(`کل انتخاب‌ها: ${B.statusCounters.totalSelections}`),B.statusCounters.missedChances>0&&Bt.push(`فرصت‌های از دست رفته: ${B.statusCounters.missedChances}`);for(const Be in B.categoryCounts){const Pe=B.categoryCounts[Be];Pe>0&&Bt.push(`انتخاب در «${Be}»: ${Pe}`)}for(const Be in B.categoryIssues){const Pe=B.categoryIssues[Be];Pe>0&&Bt.push(`مشکل در «${Be}»: ${Pe}`)}if(Bt.length>0){const Be=`${Ut}
${ha}

- ${Bt.join(`
- `)}`;B.addNote(Be)}}function Wt(B){const U=`چون این کلاس جلسات برگزار شده دارد، برای ${B>1?"دانش‌آموزان جدید":"دانش‌آموز جدید"} آمار پایه‌ای (متناسب با سایر دانش‌آموزان) ثبت شد تا در فرایند انتخاب اختلالی ایجاد نشود.`;Ee(U,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}const Kn="15.0.0",Yn="775";{const B=` (ساخت ${Yn})`;document.getElementById("app-version").textContent=`نسخه ${Kn}${B}`}function Xn(){console.log("Starting universal backfill for writing scores...");let B=0;for(const Z in re){const U=re[Z];if(U.isDeleted)continue;let ee=0;ke(U.students).forEach(me=>{const ae=me.logs.scores;if(!(ae&&ae.writing&&ae.writing.length>0)){let we=-1;for(const xe in ae)xe!=="writing"&&ae[xe].forEach(Me=>{Me.value>we&&(we=Me.value)});if(we>-1){const xe=`Automatically assigned based on the highest score (${we}) from other skills.`;me.addScore("Writing",we,xe),ee++}}}),ee>0&&(console.log(`Updated ${ee} student(s) in class: ${U.info.name}.`),B+=ee)}B>0?(ce(),console.log(`Update complete. A total of ${B} student(s) were updated across all classes. Data saved.`),document.getElementById("student-page").classList.contains("active")&&ze()):console.log("No students needed updating in any class.")}window.backfillWritingScoresForAll=Xn;function fn(){console.log("Starting backfill for 'outOfClassCount' and 'wasOutOfClass' properties...");let B=0,Z=0;const U=localStorage.getItem("teacherAssistantData_v2");if(!U){console.log("No data found in localStorage. Nothing to do.");return}const ee=JSON.parse(U);for(const se in ee){const me=ee[se];me.students&&me.students.forEach(ae=>{ae.statusCounters&&typeof ae.statusCounters.outOfClassCount>"u"&&(ae.statusCounters.outOfClassCount=0,B++)}),me.sessions&&me.sessions.forEach(ae=>{if(ae.studentRecords)for(const de in ae.studentRecords){const we=ae.studentRecords[de];typeof we.wasOutOfClass>"u"&&(we.wasOutOfClass=!1,Z++)}})}localStorage.setItem("teacherAssistantData_v2",JSON.stringify(ee)),console.log(`Backfill complete. Updated ${B} students and ${Z} session records. Data saved.`),On(),N&&ze()}window.backfillExitCounters=fn;function wt(){console.log("🧹 Starting orphaned data cleanup...");let B=0;for(const Z in re){const U=re[Z];if(U.isDeleted)continue;let ee=!1;const se=new Set(U.students.filter(de=>!de.isDeleted).map(de=>de.identity.studentId)),me=new Map(U.students.map(de=>[de.identity.studentId,de.identity.name])),ae=[];U.sessions.forEach(de=>{if(de.isDeleted)return;const we=[];for(const xe in de.studentRecords)if(!se.has(xe)){const Me=me.get(xe)||"Unknown/Deleted";we.push(`  - Removed student record for: ${Me} (ID: ${xe})`),delete de.studentRecords[xe],B++,ee=!0}for(const xe in de.lastWinnerByCategory){const Me=de.lastWinnerByCategory[xe];if(!se.has(Me)){const Ut=me.get(Me)||"Unknown/Deleted";we.push(`  - Removed '${xe}' last winner: ${Ut} (ID: ${Me})`),delete de.lastWinnerByCategory[xe],B++,ee=!0}}if(de.lastSelectedWinnerId&&!se.has(de.lastSelectedWinnerId)){const xe=de.lastSelectedWinnerId,Me=me.get(xe)||"Unknown/Deleted";we.push(`  - Cleared 'lastSelectedWinnerId': ${Me} (ID: ${xe})`),de.lastSelectedWinnerId=null,B++,ee=!0}if(we.length>0){const Me=tt(U).get(de.sessionNumber)||`(#${de.sessionNumber})`;ae.push({sessionDisplayNumber:Me,logs:we})}}),ee&&(console.group(`➡️ Class: ${Z}`),ae.forEach(de=>{console.groupCollapsed(`  Session ${de.sessionDisplayNumber}`),de.logs.forEach(we=>console.warn(we)),console.groupEnd()}),console.groupEnd())}B>0?(ce(),console.log(`✅ Cleanup complete! Found and removed ${B} orphaned references. Data saved.`)):console.log("✅ No orphaned data found. Your data is clean!")}window.cleanupOrphanedData=wt;function Tt(B){if(!B||!B.classroomName)return;const Z=re[B.classroomName];if(!Z){Y("⚠️ کلاس مربوط به این گزارش یافت نشد.");return}He(Z),ve(),setTimeout(()=>{switch(B.type){case"VIEW_STUDENT_PROFILE":{const U=Z.students.find(ee=>ee.identity.studentId===B.studentId);U?Fe(U):Y("⚠️ دانش‌آموز مورد نظر یافت نشد.");break}case"VIEW_TRASH":ln(),ge("trash-page");break;case"VIEW_SESSIONS":We(),ge("session-page");break;case"VIEW_CLASS_NOTE":Vn(Z);break;case"VIEW_CLASS_SETTINGS":zt(Z);break}},300)}Ne.addEventListener("click",()=>{Js()}),Oe.addEventListener("click",()=>{ve()}),he.addEventListener("click",()=>{const B=Ce.value.trim(),Z=Te.checked;if(!B){qs.style.display==="flex"?Ee("کادر یادداشت خالی است. آیا مطمئنید که می‌خواهید یادداشت‌های قبلی دانش‌آموزان انتخاب‌شده را پاک کنید؟",()=>{ve(),vs("",!1)},{confirmText:"پاک کردن",confirmClass:"btn-warning"}):Y("⚠️ لطفاً متن یادداشت را وارد کنید.");return}ve(()=>{vs(B,Z)})});const Et=document.getElementById("screen-saver-overlay"),Xs=document.getElementById("screen-saver-toggle");let Qn;const ua=2*60*1e3,Qs=["mousemove","keypress","scroll","click","touchstart"];function fa(){Et.classList.add("visible")}function ei(){Et.classList.contains("visible")&&Et.classList.remove("visible")}function mn(){ei(),clearTimeout(Qn),Qn=setTimeout(fa,ua)}function hn(B){B.preventDefault(),B.stopPropagation(),setTimeout(mn,0)}function ti(){mn(),Qs.forEach(Z=>window.addEventListener(Z,mn)),Et.addEventListener("click",hn),Et.addEventListener("touchstart",hn);const B="15.0.0";{const Z=document.getElementById("screen-saver-version");Z&&(Z.textContent=`v${B}`)}}function ma(){clearTimeout(Qn),ei(),Qs.forEach(B=>window.removeEventListener(B,mn)),Et.removeEventListener("click",hn),Et.removeEventListener("touchstart",hn)}Xs.checked=Ge.isScreenSaverEnabled,Ge.isScreenSaverEnabled&&ti(),Xs.addEventListener("change",B=>{B.target.checked?(Kt({isScreenSaverEnabled:!0}),ti()):(be(),B.preventDefault(),Ee(`نکته:
محافظ صفحه در تلفن های همراه جدید کمک می کند که دستگاه باطری کمتری مصرف کند و به دلیل ثابت ماندن صفحه نمایش در گوشی های قدیمی تر، صفحه نمایش دچار ماندگی رد پیکسل نگردد. آیا مطمئن هستید که می خواهید این ویژگی را غیر فعال کنید؟`,()=>{B.target.checked=!1,Kt({isScreenSaverEnabled:!1}),ma(),Y("توصیه می شود زمان خاموش شدن صفحه نمایش گوشی خود را به حداقل دو دقیقه تغییر دهید تا در استفاده های طولانی مدت صفحه نمایش گوشی اصطحلاک کمتری را تجربه کند",7e3)},{confirmText:"بله، غیرفعال کن",cancelText:"لغو",onCancel:()=>{B.target.checked=!0}}))})});function no(t,a){if(!J||J.isFinished){Y("⚠️ امکان لغو انتخاب در جلسه خاتمه یافته وجود ندارد.");return}const e=J.winnerHistory;if(!(qe===e.length-1)||e.length===0){Y("⚠️ فقط آخرین انتخاب قابل لغو است.");return}if(e[e.length-1].winner.identity.studentId!==t.identity.studentId){console.error("Undo mismatch!");return}Ee(`آیا از حذف انتخاب «${t.identity.name}» برای «${a}» مطمئن هستید؟ آمار این انتخاب بازگردانی خواهد شد.`,()=>{const o=J.winnerHistory,n=o.pop();if(!n)return;const i=n.winner,s=n.categoryName,r=i.identity.studentId;i.statusCounters.totalSelections=Math.max(0,i.statusCounters.totalSelections-1),i.categoryCounts[s]&&(i.categoryCounts[s]=Math.max(0,i.categoryCounts[s]-1));const l=J.studentRecords[r];l&&l.selections[s]&&(l.selections[s]=Math.max(0,l.selections[s]-1));let h=null;for(let p=o.length-1;p>=0;p--)if(o[p].categoryName===s){h=o[p].winner.identity.studentId;break}h?J.lastWinnerByCategory[s]=h:delete J.lastWinnerByCategory[s],vt(o.length-1),ze(),Re(),ce(),Y(`✅ انتخاب «${i.identity.name}» لغو شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}function so(){const t=document.getElementById("session-dashboard-page"),a=document.getElementById("student-stats-table-container");if(!t)return;let e=0,c=0;t.addEventListener("touchstart",n=>{if(a&&a.contains(n.target)){const i=n.target.closest("td, th");i&&i.parentElement.firstElementChild===i?e=n.changedTouches[0].screenX:e=0}else e=n.changedTouches[0].screenX},{passive:!0}),t.addEventListener("touchend",n=>{e!==0&&(c=n.changedTouches[0].screenX,o())});function o(){const i=e-c;Math.abs(i)>150&&(document.getElementById("selector-tab-btn").classList.contains("active")?(ge("session-dashboard-page",{tab:"attendance"}),on("attendance")):(ge("session-dashboard-page",{tab:"selector"}),on("selector"))),e=0,c=0}}
