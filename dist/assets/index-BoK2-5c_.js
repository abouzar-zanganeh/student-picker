(function(){const c=document.createElement("link").relList;if(c&&c.supports&&c.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))l(r);new MutationObserver(r=>{for(const t of r)if(t.type==="childList")for(const s of t.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&l(s)}).observe(document,{childList:!0,subtree:!0});function e(r){const t={};return r.integrity&&(t.integrity=r.integrity),r.referrerPolicy&&(t.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?t.credentials="include":r.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function l(r){if(r.ep)return;r.ep=!0;const t=e(r);fetch(r.href,t)}})();class cn{constructor(c){this.identity={name:c.name,studentId:c.studentId||`id_${new Date().getTime()}_${Math.random()}`,branchName:c.branchName||null,ageGroup:c.ageGroup||"adult",level:c.level||null,contact:{social:c.socialContact||null,parent:c.parentContact||null}},this.isDeleted=!1,this.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0,outOfClassCount:0},this.categoryCounts={},this.categoryIssues={},this.logs={parentContacts:[],scores:{},discipline:{},sessionHistory:{}},this.profile={notes:[],tags:[]},this.finalClassActivityScore=null,this.onboardingSession=null}addScore(c,e,l){if(e>100||e<0){console.log("نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}const r=c.toLowerCase();this.logs.scores[r]||(this.logs.scores[r]=[]);const t=new Li(c,e,l);this.logs.scores[r].push(t)}addNote(c,e=null){const l=new Bi(c,e);this.profile.notes.push(l)}getOverallAverageScore(){let c=0,e=0;for(const r in this.logs.scores)this.logs.scores[r].forEach(t=>{t.isDeleted||(c+=t.value,e++)});if(e===0)return null;const l=c/e;return Math.round(l*100)/100}}class Li{constructor(c,e,l=""){this.id=`score_${new Date().getTime()}`,this.skill=c,this.value=e,this.timestamp=new Date,this.comment=l,this.isDeleted=!1}}class Bi{constructor(c,e=null){this.id=`note_${new Date().getTime()}`,this.timestamp=new Date,this.content=c,this.isDeleted=!1,this.source=e}}class Wn{constructor(c="complete",e=""){this.status=c,this.comment=e,this.timestamp=new Date}}class Ts{constructor(c){this.sessionNumber=c,this.startTime=new Date,this.note="",this.isDeleted=!1,this.endTime=null,this.isFinished=!1,this.isMakeup=!1,this.isCancelled=!1,this.studentRecords={},this.lastWinnerByCategory={},this.lastUsedCategoryId=null,this.lastSelectedWinnerId=null,this.winnerHistory=[]}end(){this.isFinished=!0,this.endTime=new Date}markAsMakeup(){this.isMakeup=!this.isMakeup}initializeStudentRecord(c){this.studentRecords[c]||(this.studentRecords[c]={attendance:"present",homework:new Wn,selections:{},hadIssue:!1,wasOutOfClass:!1})}setAttendance(c,e){this.initializeStudentRecord(c),this.studentRecords[c].attendance=e}setHomeworkStatus(c,e){this.initializeStudentRecord(c),this.studentRecords[c].homework.status=e}selectNextWinner(c,e,l){if(!e||e.length===0)return console.log("هیچ دانش‌آموزی در کلاس برای انتخاب وجود ندارد."),null;const r=this.lastWinnerByCategory[c];let t=e.filter(h=>h.identity.studentId!==r&&!h.isDeleted);if(t.length===0&&(t=e),t.length===0)return null;const s=(h,u)=>h.categoryCounts[u]||0,n=Math.min(...t.map(h=>s(h,c))),a=t.filter(h=>s(h,c)===n);let m;if(a.length===1)m=a[0];else if(a.length>1){const h=l.filter(b=>!b.isDeleted&&b.name!==c).map(b=>b.name),u=a.map(b=>{const y=h.reduce((w,k)=>w+s(b,k),0);return{student:b,otherCategoriesTotal:y}}),g=Math.min(...u.map(b=>b.otherCategoriesTotal)),f=u.filter(b=>b.otherCategoriesTotal===g).map(b=>b.student);f.length===1?m=f[0]:m=f[Math.floor(Math.random()*f.length)]}else m=t[Math.floor(Math.random()*t.length)];const p=m.identity.studentId;this.initializeStudentRecord(p);const v=(this.studentRecords[p].selections[c]||0)+1;return this.studentRecords[p].selections[c]=v,m.statusCounters.totalSelections++,m.categoryCounts[c]=(m.categoryCounts[c]||0)+1,this.lastWinnerByCategory[c]=p,m}}class Hn{constructor(c){this.info={name:c.name||"NotNamed",scheduleCode:c.scheduleCode||`code_${new Date().getTime()}`,teacherName:c.teacherName||null,type:c.type||"in-person",term:c.term||null,scheduleText:c.scheduleText||null,level:c.level||null,creationDate:c.creationDate?new Date(c.creationDate):new Date},this.students=[],this.sessions=[],this.note="",this.isDeleted=!1,this.categories=[new lt("Vocabulary","Questions about words and meanings."),new lt("Grammar","Questions about sentence structure and rules."),new lt("Listening",void 0,!0),new lt("Speaking",void 0,!0),new lt("Reading",void 0,!0),new lt("Writing",void 0,!0)],this.futurePlans={}}addStudent(c){this.students.push(c)}removeStudent(c){this.students=this.students.filter(e=>e.identity.studentId!==c)}startNewSession(){const c=this.sessions.length+1,e=new Ts(c);return this.sessions.push(e),e}endSpecificSession(c){const e=this.getSession(c);return e&&!e.isFinished?(e.end(),!0):!1}getSession(c){return this.sessions.find(e=>e.sessionNumber===c)}markAsMakeup(c){const e=this.getSession(c);e&&e.markAsMakeup()}planForSession(c,e){this.futurePlans[c]=e}hasSessionToday(){const c=new Date().toDateString();return this.sessions.some(e=>!e.isDeleted&&e.startTime.toDateString()===c)}selectNextWinner(c,e){return e?e.selectNextWinner(c,this.students,this.categories):null}get liveSession(){for(let c=this.sessions.length-1;c>=0;c--)if(!this.sessions[c].isFinished)return this.sessions[c];return null}endLiveSession(){const c=this.liveSession;return c?(c.end(),!0):!1}calculateFinalStudentScore(c){const e=c.logs.scores,l=["reading","writing"];for(const h of l)if(!e[h]||e[h].length===0)return null;const r=e.listening&&e.listening.length>0,t=e.speaking&&e.speaking.length>0;if(!r&&!t)return null;const s=h=>e[h].reduce((g,f)=>g+f.value,0)/e[h].length;let n;r&&t?n=(s("listening")+s("speaking"))/2:r?n=s("listening"):n=s("speaking");const a=s("reading"),m=s("writing"),v=(n*3+a*2+m*1)/6;return Math.trunc(v*10)/10}assignAllFinalScores(){let c=0,e=[];console.log("شروع عملیات محاسبه نمره نهایی برای تمام دانش‌آموزان..."),this.students.forEach(r=>{const t=this.calculateFinalStudentScore(r);t!==null?(r.finalClassActivityScore=t,c++):(r.finalClassActivityScore=null,e.push(r.identity.name))});const l=e.length;console.log(`عملیات پایان یافت. تعداد نمرات موفق: ${c} | تعداد ناموفق (نمرات ناقص): ${l}`),l>0&&(console.log("اسامی دانش‌آموزانی که نمراتشان ناقص است:"),e.forEach(r=>console.log(`- ${r}`)))}}class lt{constructor(c,e="",l=!1){this.id=`cat_${new Date().getTime()}_${Math.random()}`,this.name=c,this.description=e,this.isDeleted=!1,this.isGradedCategory=l,this.isDeleted=!1}}var rn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Ti(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}function on(i){throw new Error('Could not dynamically require "'+i+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Ns={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/(function(i,c){(function(e){i.exports=e()})(function(){return function e(l,r,t){function s(m,p){if(!r[m]){if(!l[m]){var v=typeof on=="function"&&on;if(!p&&v)return v(m,!0);if(n)return n(m,!0);var h=new Error("Cannot find module '"+m+"'");throw h.code="MODULE_NOT_FOUND",h}var u=r[m]={exports:{}};l[m][0].call(u.exports,function(g){var f=l[m][1][g];return s(f||g)},u,u.exports,e,l,r,t)}return r[m].exports}for(var n=typeof on=="function"&&on,a=0;a<t.length;a++)s(t[a]);return s}({1:[function(e,l,r){var t=e("./utils"),s=e("./support"),n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";r.encode=function(a){for(var m,p,v,h,u,g,f,b=[],y=0,w=a.length,k=w,I=t.getTypeOf(a)!=="string";y<a.length;)k=w-y,v=I?(m=a[y++],p=y<w?a[y++]:0,y<w?a[y++]:0):(m=a.charCodeAt(y++),p=y<w?a.charCodeAt(y++):0,y<w?a.charCodeAt(y++):0),h=m>>2,u=(3&m)<<4|p>>4,g=1<k?(15&p)<<2|v>>6:64,f=2<k?63&v:64,b.push(n.charAt(h)+n.charAt(u)+n.charAt(g)+n.charAt(f));return b.join("")},r.decode=function(a){var m,p,v,h,u,g,f=0,b=0,y="data:";if(a.substr(0,y.length)===y)throw new Error("Invalid base64 input, it looks like a data url.");var w,k=3*(a=a.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(a.charAt(a.length-1)===n.charAt(64)&&k--,a.charAt(a.length-2)===n.charAt(64)&&k--,k%1!=0)throw new Error("Invalid base64 input, bad content length.");for(w=s.uint8array?new Uint8Array(0|k):new Array(0|k);f<a.length;)m=n.indexOf(a.charAt(f++))<<2|(h=n.indexOf(a.charAt(f++)))>>4,p=(15&h)<<4|(u=n.indexOf(a.charAt(f++)))>>2,v=(3&u)<<6|(g=n.indexOf(a.charAt(f++))),w[b++]=m,u!==64&&(w[b++]=p),g!==64&&(w[b++]=v);return w}},{"./support":30,"./utils":32}],2:[function(e,l,r){var t=e("./external"),s=e("./stream/DataWorker"),n=e("./stream/Crc32Probe"),a=e("./stream/DataLengthProbe");function m(p,v,h,u,g){this.compressedSize=p,this.uncompressedSize=v,this.crc32=h,this.compression=u,this.compressedContent=g}m.prototype={getContentWorker:function(){var p=new s(t.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new a("data_length")),v=this;return p.on("end",function(){if(this.streamInfo.data_length!==v.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),p},getCompressedWorker:function(){return new s(t.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},m.createWorkerFrom=function(p,v,h){return p.pipe(new n).pipe(new a("uncompressedSize")).pipe(v.compressWorker(h)).pipe(new a("compressedSize")).withStreamInfo("compression",v)},l.exports=m},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,l,r){var t=e("./stream/GenericWorker");r.STORE={magic:"\0\0",compressWorker:function(){return new t("STORE compression")},uncompressWorker:function(){return new t("STORE decompression")}},r.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,l,r){var t=e("./utils"),s=function(){for(var n,a=[],m=0;m<256;m++){n=m;for(var p=0;p<8;p++)n=1&n?3988292384^n>>>1:n>>>1;a[m]=n}return a}();l.exports=function(n,a){return n!==void 0&&n.length?t.getTypeOf(n)!=="string"?function(m,p,v,h){var u=s,g=h+v;m^=-1;for(var f=h;f<g;f++)m=m>>>8^u[255&(m^p[f])];return-1^m}(0|a,n,n.length,0):function(m,p,v,h){var u=s,g=h+v;m^=-1;for(var f=h;f<g;f++)m=m>>>8^u[255&(m^p.charCodeAt(f))];return-1^m}(0|a,n,n.length,0):0}},{"./utils":32}],5:[function(e,l,r){r.base64=!1,r.binary=!1,r.dir=!1,r.createFolders=!0,r.date=null,r.compression=null,r.compressionOptions=null,r.comment=null,r.unixPermissions=null,r.dosPermissions=null},{}],6:[function(e,l,r){var t=null;t=typeof Promise<"u"?Promise:e("lie"),l.exports={Promise:t}},{lie:37}],7:[function(e,l,r){var t=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",s=e("pako"),n=e("./utils"),a=e("./stream/GenericWorker"),m=t?"uint8array":"array";function p(v,h){a.call(this,"FlateWorker/"+v),this._pako=null,this._pakoAction=v,this._pakoOptions=h,this.meta={}}r.magic="\b\0",n.inherits(p,a),p.prototype.processChunk=function(v){this.meta=v.meta,this._pako===null&&this._createPako(),this._pako.push(n.transformTo(m,v.data),!1)},p.prototype.flush=function(){a.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},p.prototype.cleanUp=function(){a.prototype.cleanUp.call(this),this._pako=null},p.prototype._createPako=function(){this._pako=new s[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var v=this;this._pako.onData=function(h){v.push({data:h,meta:v.meta})}},r.compressWorker=function(v){return new p("Deflate",v)},r.uncompressWorker=function(){return new p("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(e,l,r){function t(u,g){var f,b="";for(f=0;f<g;f++)b+=String.fromCharCode(255&u),u>>>=8;return b}function s(u,g,f,b,y,w){var k,I,S=u.file,O=u.compression,z=w!==m.utf8encode,H=n.transformTo("string",w(S.name)),A=n.transformTo("string",m.utf8encode(S.name)),Z=S.comment,ie=n.transformTo("string",w(Z)),E=n.transformTo("string",m.utf8encode(Z)),M=A.length!==S.name.length,d=E.length!==Z.length,F="",ue="",j="",fe=S.dir,$=S.date,te={crc32:0,compressedSize:0,uncompressedSize:0};g&&!f||(te.crc32=u.crc32,te.compressedSize=u.compressedSize,te.uncompressedSize=u.uncompressedSize);var T=0;g&&(T|=8),z||!M&&!d||(T|=2048);var N=0,re=0;fe&&(N|=16),y==="UNIX"?(re=798,N|=function(Y,Te){var De=Y;return Y||(De=Te?16893:33204),(65535&De)<<16}(S.unixPermissions,fe)):(re=20,N|=function(Y){return 63&(Y||0)}(S.dosPermissions)),k=$.getUTCHours(),k<<=6,k|=$.getUTCMinutes(),k<<=5,k|=$.getUTCSeconds()/2,I=$.getUTCFullYear()-1980,I<<=4,I|=$.getUTCMonth()+1,I<<=5,I|=$.getUTCDate(),M&&(ue=t(1,1)+t(p(H),4)+A,F+="up"+t(ue.length,2)+ue),d&&(j=t(1,1)+t(p(ie),4)+E,F+="uc"+t(j.length,2)+j);var ee="";return ee+=`
\0`,ee+=t(T,2),ee+=O.magic,ee+=t(k,2),ee+=t(I,2),ee+=t(te.crc32,4),ee+=t(te.compressedSize,4),ee+=t(te.uncompressedSize,4),ee+=t(H.length,2),ee+=t(F.length,2),{fileRecord:v.LOCAL_FILE_HEADER+ee+H+F,dirRecord:v.CENTRAL_FILE_HEADER+t(re,2)+ee+t(ie.length,2)+"\0\0\0\0"+t(N,4)+t(b,4)+H+F+ie}}var n=e("../utils"),a=e("../stream/GenericWorker"),m=e("../utf8"),p=e("../crc32"),v=e("../signature");function h(u,g,f,b){a.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=g,this.zipPlatform=f,this.encodeFileName=b,this.streamFiles=u,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}n.inherits(h,a),h.prototype.push=function(u){var g=u.meta.percent||0,f=this.entriesCount,b=this._sources.length;this.accumulate?this.contentBuffer.push(u):(this.bytesWritten+=u.data.length,a.prototype.push.call(this,{data:u.data,meta:{currentFile:this.currentFile,percent:f?(g+100*(f-b-1))/f:100}}))},h.prototype.openedSource=function(u){this.currentSourceOffset=this.bytesWritten,this.currentFile=u.file.name;var g=this.streamFiles&&!u.file.dir;if(g){var f=s(u,g,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:f.fileRecord,meta:{percent:0}})}else this.accumulate=!0},h.prototype.closedSource=function(u){this.accumulate=!1;var g=this.streamFiles&&!u.file.dir,f=s(u,g,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(f.dirRecord),g)this.push({data:function(b){return v.DATA_DESCRIPTOR+t(b.crc32,4)+t(b.compressedSize,4)+t(b.uncompressedSize,4)}(u),meta:{percent:100}});else for(this.push({data:f.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},h.prototype.flush=function(){for(var u=this.bytesWritten,g=0;g<this.dirRecords.length;g++)this.push({data:this.dirRecords[g],meta:{percent:100}});var f=this.bytesWritten-u,b=function(y,w,k,I,S){var O=n.transformTo("string",S(I));return v.CENTRAL_DIRECTORY_END+"\0\0\0\0"+t(y,2)+t(y,2)+t(w,4)+t(k,4)+t(O.length,2)+O}(this.dirRecords.length,f,u,this.zipComment,this.encodeFileName);this.push({data:b,meta:{percent:100}})},h.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},h.prototype.registerPrevious=function(u){this._sources.push(u);var g=this;return u.on("data",function(f){g.processChunk(f)}),u.on("end",function(){g.closedSource(g.previous.streamInfo),g._sources.length?g.prepareNextSource():g.end()}),u.on("error",function(f){g.error(f)}),this},h.prototype.resume=function(){return!!a.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},h.prototype.error=function(u){var g=this._sources;if(!a.prototype.error.call(this,u))return!1;for(var f=0;f<g.length;f++)try{g[f].error(u)}catch{}return!0},h.prototype.lock=function(){a.prototype.lock.call(this);for(var u=this._sources,g=0;g<u.length;g++)u[g].lock()},l.exports=h},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,l,r){var t=e("../compressions"),s=e("./ZipFileWorker");r.generateWorker=function(n,a,m){var p=new s(a.streamFiles,m,a.platform,a.encodeFileName),v=0;try{n.forEach(function(h,u){v++;var g=function(w,k){var I=w||k,S=t[I];if(!S)throw new Error(I+" is not a valid compression method !");return S}(u.options.compression,a.compression),f=u.options.compressionOptions||a.compressionOptions||{},b=u.dir,y=u.date;u._compressWorker(g,f).withStreamInfo("file",{name:h,dir:b,date:y,comment:u.comment||"",unixPermissions:u.unixPermissions,dosPermissions:u.dosPermissions}).pipe(p)}),p.entriesCount=v}catch(h){p.error(h)}return p}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,l,r){function t(){if(!(this instanceof t))return new t;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var s=new t;for(var n in this)typeof this[n]!="function"&&(s[n]=this[n]);return s}}(t.prototype=e("./object")).loadAsync=e("./load"),t.support=e("./support"),t.defaults=e("./defaults"),t.version="3.10.1",t.loadAsync=function(s,n){return new t().loadAsync(s,n)},t.external=e("./external"),l.exports=t},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,l,r){var t=e("./utils"),s=e("./external"),n=e("./utf8"),a=e("./zipEntries"),m=e("./stream/Crc32Probe"),p=e("./nodejsUtils");function v(h){return new s.Promise(function(u,g){var f=h.decompressed.getContentWorker().pipe(new m);f.on("error",function(b){g(b)}).on("end",function(){f.streamInfo.crc32!==h.decompressed.crc32?g(new Error("Corrupted zip : CRC32 mismatch")):u()}).resume()})}l.exports=function(h,u){var g=this;return u=t.extend(u||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:n.utf8decode}),p.isNode&&p.isStream(h)?s.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):t.prepareContent("the loaded zip file",h,!0,u.optimizedBinaryString,u.base64).then(function(f){var b=new a(u);return b.load(f),b}).then(function(f){var b=[s.Promise.resolve(f)],y=f.files;if(u.checkCRC32)for(var w=0;w<y.length;w++)b.push(v(y[w]));return s.Promise.all(b)}).then(function(f){for(var b=f.shift(),y=b.files,w=0;w<y.length;w++){var k=y[w],I=k.fileNameStr,S=t.resolve(k.fileNameStr);g.file(S,k.decompressed,{binary:!0,optimizedBinaryString:!0,date:k.date,dir:k.dir,comment:k.fileCommentStr.length?k.fileCommentStr:null,unixPermissions:k.unixPermissions,dosPermissions:k.dosPermissions,createFolders:u.createFolders}),k.dir||(g.file(S).unsafeOriginalName=I)}return b.zipComment.length&&(g.comment=b.zipComment),g})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,l,r){var t=e("../utils"),s=e("../stream/GenericWorker");function n(a,m){s.call(this,"Nodejs stream input adapter for "+a),this._upstreamEnded=!1,this._bindStream(m)}t.inherits(n,s),n.prototype._bindStream=function(a){var m=this;(this._stream=a).pause(),a.on("data",function(p){m.push({data:p,meta:{percent:0}})}).on("error",function(p){m.isPaused?this.generatedError=p:m.error(p)}).on("end",function(){m.isPaused?m._upstreamEnded=!0:m.end()})},n.prototype.pause=function(){return!!s.prototype.pause.call(this)&&(this._stream.pause(),!0)},n.prototype.resume=function(){return!!s.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},l.exports=n},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,l,r){var t=e("readable-stream").Readable;function s(n,a,m){t.call(this,a),this._helper=n;var p=this;n.on("data",function(v,h){p.push(v)||p._helper.pause(),m&&m(h)}).on("error",function(v){p.emit("error",v)}).on("end",function(){p.push(null)})}e("../utils").inherits(s,t),s.prototype._read=function(){this._helper.resume()},l.exports=s},{"../utils":32,"readable-stream":16}],14:[function(e,l,r){l.exports={isNode:typeof Buffer<"u",newBufferFrom:function(t,s){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(t,s);if(typeof t=="number")throw new Error('The "data" argument must not be a number');return new Buffer(t,s)},allocBuffer:function(t){if(Buffer.alloc)return Buffer.alloc(t);var s=new Buffer(t);return s.fill(0),s},isBuffer:function(t){return Buffer.isBuffer(t)},isStream:function(t){return t&&typeof t.on=="function"&&typeof t.pause=="function"&&typeof t.resume=="function"}}},{}],15:[function(e,l,r){function t(S,O,z){var H,A=n.getTypeOf(O),Z=n.extend(z||{},p);Z.date=Z.date||new Date,Z.compression!==null&&(Z.compression=Z.compression.toUpperCase()),typeof Z.unixPermissions=="string"&&(Z.unixPermissions=parseInt(Z.unixPermissions,8)),Z.unixPermissions&&16384&Z.unixPermissions&&(Z.dir=!0),Z.dosPermissions&&16&Z.dosPermissions&&(Z.dir=!0),Z.dir&&(S=y(S)),Z.createFolders&&(H=b(S))&&w.call(this,H,!0);var ie=A==="string"&&Z.binary===!1&&Z.base64===!1;z&&z.binary!==void 0||(Z.binary=!ie),(O instanceof v&&O.uncompressedSize===0||Z.dir||!O||O.length===0)&&(Z.base64=!1,Z.binary=!0,O="",Z.compression="STORE",A="string");var E=null;E=O instanceof v||O instanceof a?O:g.isNode&&g.isStream(O)?new f(S,O):n.prepareContent(S,O,Z.binary,Z.optimizedBinaryString,Z.base64);var M=new h(S,E,Z);this.files[S]=M}var s=e("./utf8"),n=e("./utils"),a=e("./stream/GenericWorker"),m=e("./stream/StreamHelper"),p=e("./defaults"),v=e("./compressedObject"),h=e("./zipObject"),u=e("./generate"),g=e("./nodejsUtils"),f=e("./nodejs/NodejsStreamInputAdapter"),b=function(S){S.slice(-1)==="/"&&(S=S.substring(0,S.length-1));var O=S.lastIndexOf("/");return 0<O?S.substring(0,O):""},y=function(S){return S.slice(-1)!=="/"&&(S+="/"),S},w=function(S,O){return O=O!==void 0?O:p.createFolders,S=y(S),this.files[S]||t.call(this,S,null,{dir:!0,createFolders:O}),this.files[S]};function k(S){return Object.prototype.toString.call(S)==="[object RegExp]"}var I={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(S){var O,z,H;for(O in this.files)H=this.files[O],(z=O.slice(this.root.length,O.length))&&O.slice(0,this.root.length)===this.root&&S(z,H)},filter:function(S){var O=[];return this.forEach(function(z,H){S(z,H)&&O.push(H)}),O},file:function(S,O,z){if(arguments.length!==1)return S=this.root+S,t.call(this,S,O,z),this;if(k(S)){var H=S;return this.filter(function(Z,ie){return!ie.dir&&H.test(Z)})}var A=this.files[this.root+S];return A&&!A.dir?A:null},folder:function(S){if(!S)return this;if(k(S))return this.filter(function(A,Z){return Z.dir&&S.test(A)});var O=this.root+S,z=w.call(this,O),H=this.clone();return H.root=z.name,H},remove:function(S){S=this.root+S;var O=this.files[S];if(O||(S.slice(-1)!=="/"&&(S+="/"),O=this.files[S]),O&&!O.dir)delete this.files[S];else for(var z=this.filter(function(A,Z){return Z.name.slice(0,S.length)===S}),H=0;H<z.length;H++)delete this.files[z[H].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(S){var O,z={};try{if((z=n.extend(S||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:s.utf8encode})).type=z.type.toLowerCase(),z.compression=z.compression.toUpperCase(),z.type==="binarystring"&&(z.type="string"),!z.type)throw new Error("No output type specified.");n.checkSupport(z.type),z.platform!=="darwin"&&z.platform!=="freebsd"&&z.platform!=="linux"&&z.platform!=="sunos"||(z.platform="UNIX"),z.platform==="win32"&&(z.platform="DOS");var H=z.comment||this.comment||"";O=u.generateWorker(this,z,H)}catch(A){(O=new a("error")).error(A)}return new m(O,z.type||"string",z.mimeType)},generateAsync:function(S,O){return this.generateInternalStream(S).accumulate(O)},generateNodeStream:function(S,O){return(S=S||{}).type||(S.type="nodebuffer"),this.generateInternalStream(S).toNodejsStream(O)}};l.exports=I},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,l,r){l.exports=e("stream")},{stream:void 0}],17:[function(e,l,r){var t=e("./DataReader");function s(n){t.call(this,n);for(var a=0;a<this.data.length;a++)n[a]=255&n[a]}e("../utils").inherits(s,t),s.prototype.byteAt=function(n){return this.data[this.zero+n]},s.prototype.lastIndexOfSignature=function(n){for(var a=n.charCodeAt(0),m=n.charCodeAt(1),p=n.charCodeAt(2),v=n.charCodeAt(3),h=this.length-4;0<=h;--h)if(this.data[h]===a&&this.data[h+1]===m&&this.data[h+2]===p&&this.data[h+3]===v)return h-this.zero;return-1},s.prototype.readAndCheckSignature=function(n){var a=n.charCodeAt(0),m=n.charCodeAt(1),p=n.charCodeAt(2),v=n.charCodeAt(3),h=this.readData(4);return a===h[0]&&m===h[1]&&p===h[2]&&v===h[3]},s.prototype.readData=function(n){if(this.checkOffset(n),n===0)return[];var a=this.data.slice(this.zero+this.index,this.zero+this.index+n);return this.index+=n,a},l.exports=s},{"../utils":32,"./DataReader":18}],18:[function(e,l,r){var t=e("../utils");function s(n){this.data=n,this.length=n.length,this.index=0,this.zero=0}s.prototype={checkOffset:function(n){this.checkIndex(this.index+n)},checkIndex:function(n){if(this.length<this.zero+n||n<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+n+"). Corrupted zip ?")},setIndex:function(n){this.checkIndex(n),this.index=n},skip:function(n){this.setIndex(this.index+n)},byteAt:function(){},readInt:function(n){var a,m=0;for(this.checkOffset(n),a=this.index+n-1;a>=this.index;a--)m=(m<<8)+this.byteAt(a);return this.index+=n,m},readString:function(n){return t.transformTo("string",this.readData(n))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var n=this.readInt(4);return new Date(Date.UTC(1980+(n>>25&127),(n>>21&15)-1,n>>16&31,n>>11&31,n>>5&63,(31&n)<<1))}},l.exports=s},{"../utils":32}],19:[function(e,l,r){var t=e("./Uint8ArrayReader");function s(n){t.call(this,n)}e("../utils").inherits(s,t),s.prototype.readData=function(n){this.checkOffset(n);var a=this.data.slice(this.zero+this.index,this.zero+this.index+n);return this.index+=n,a},l.exports=s},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,l,r){var t=e("./DataReader");function s(n){t.call(this,n)}e("../utils").inherits(s,t),s.prototype.byteAt=function(n){return this.data.charCodeAt(this.zero+n)},s.prototype.lastIndexOfSignature=function(n){return this.data.lastIndexOf(n)-this.zero},s.prototype.readAndCheckSignature=function(n){return n===this.readData(4)},s.prototype.readData=function(n){this.checkOffset(n);var a=this.data.slice(this.zero+this.index,this.zero+this.index+n);return this.index+=n,a},l.exports=s},{"../utils":32,"./DataReader":18}],21:[function(e,l,r){var t=e("./ArrayReader");function s(n){t.call(this,n)}e("../utils").inherits(s,t),s.prototype.readData=function(n){if(this.checkOffset(n),n===0)return new Uint8Array(0);var a=this.data.subarray(this.zero+this.index,this.zero+this.index+n);return this.index+=n,a},l.exports=s},{"../utils":32,"./ArrayReader":17}],22:[function(e,l,r){var t=e("../utils"),s=e("../support"),n=e("./ArrayReader"),a=e("./StringReader"),m=e("./NodeBufferReader"),p=e("./Uint8ArrayReader");l.exports=function(v){var h=t.getTypeOf(v);return t.checkSupport(h),h!=="string"||s.uint8array?h==="nodebuffer"?new m(v):s.uint8array?new p(t.transformTo("uint8array",v)):new n(t.transformTo("array",v)):new a(v)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,l,r){r.LOCAL_FILE_HEADER="PK",r.CENTRAL_FILE_HEADER="PK",r.CENTRAL_DIRECTORY_END="PK",r.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",r.ZIP64_CENTRAL_DIRECTORY_END="PK",r.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(e,l,r){var t=e("./GenericWorker"),s=e("../utils");function n(a){t.call(this,"ConvertWorker to "+a),this.destType=a}s.inherits(n,t),n.prototype.processChunk=function(a){this.push({data:s.transformTo(this.destType,a.data),meta:a.meta})},l.exports=n},{"../utils":32,"./GenericWorker":28}],25:[function(e,l,r){var t=e("./GenericWorker"),s=e("../crc32");function n(){t.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}e("../utils").inherits(n,t),n.prototype.processChunk=function(a){this.streamInfo.crc32=s(a.data,this.streamInfo.crc32||0),this.push(a)},l.exports=n},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,l,r){var t=e("../utils"),s=e("./GenericWorker");function n(a){s.call(this,"DataLengthProbe for "+a),this.propName=a,this.withStreamInfo(a,0)}t.inherits(n,s),n.prototype.processChunk=function(a){if(a){var m=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=m+a.data.length}s.prototype.processChunk.call(this,a)},l.exports=n},{"../utils":32,"./GenericWorker":28}],27:[function(e,l,r){var t=e("../utils"),s=e("./GenericWorker");function n(a){s.call(this,"DataWorker");var m=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,a.then(function(p){m.dataIsReady=!0,m.data=p,m.max=p&&p.length||0,m.type=t.getTypeOf(p),m.isPaused||m._tickAndRepeat()},function(p){m.error(p)})}t.inherits(n,s),n.prototype.cleanUp=function(){s.prototype.cleanUp.call(this),this.data=null},n.prototype.resume=function(){return!!s.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,t.delay(this._tickAndRepeat,[],this)),!0)},n.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(t.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},n.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var a=null,m=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":a=this.data.substring(this.index,m);break;case"uint8array":a=this.data.subarray(this.index,m);break;case"array":case"nodebuffer":a=this.data.slice(this.index,m)}return this.index=m,this.push({data:a,meta:{percent:this.max?this.index/this.max*100:0}})},l.exports=n},{"../utils":32,"./GenericWorker":28}],28:[function(e,l,r){function t(s){this.name=s||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}t.prototype={push:function(s){this.emit("data",s)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(s){this.emit("error",s)}return!0},error:function(s){return!this.isFinished&&(this.isPaused?this.generatedError=s:(this.isFinished=!0,this.emit("error",s),this.previous&&this.previous.error(s),this.cleanUp()),!0)},on:function(s,n){return this._listeners[s].push(n),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(s,n){if(this._listeners[s])for(var a=0;a<this._listeners[s].length;a++)this._listeners[s][a].call(this,n)},pipe:function(s){return s.registerPrevious(this)},registerPrevious:function(s){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=s.streamInfo,this.mergeStreamInfo(),this.previous=s;var n=this;return s.on("data",function(a){n.processChunk(a)}),s.on("end",function(){n.end()}),s.on("error",function(a){n.error(a)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var s=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),s=!0),this.previous&&this.previous.resume(),!s},flush:function(){},processChunk:function(s){this.push(s)},withStreamInfo:function(s,n){return this.extraStreamInfo[s]=n,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var s in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,s)&&(this.streamInfo[s]=this.extraStreamInfo[s])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var s="Worker "+this.name;return this.previous?this.previous+" -> "+s:s}},l.exports=t},{}],29:[function(e,l,r){var t=e("../utils"),s=e("./ConvertWorker"),n=e("./GenericWorker"),a=e("../base64"),m=e("../support"),p=e("../external"),v=null;if(m.nodestream)try{v=e("../nodejs/NodejsStreamOutputAdapter")}catch{}function h(g,f){return new p.Promise(function(b,y){var w=[],k=g._internalType,I=g._outputType,S=g._mimeType;g.on("data",function(O,z){w.push(O),f&&f(z)}).on("error",function(O){w=[],y(O)}).on("end",function(){try{var O=function(z,H,A){switch(z){case"blob":return t.newBlob(t.transformTo("arraybuffer",H),A);case"base64":return a.encode(H);default:return t.transformTo(z,H)}}(I,function(z,H){var A,Z=0,ie=null,E=0;for(A=0;A<H.length;A++)E+=H[A].length;switch(z){case"string":return H.join("");case"array":return Array.prototype.concat.apply([],H);case"uint8array":for(ie=new Uint8Array(E),A=0;A<H.length;A++)ie.set(H[A],Z),Z+=H[A].length;return ie;case"nodebuffer":return Buffer.concat(H);default:throw new Error("concat : unsupported type '"+z+"'")}}(k,w),S);b(O)}catch(z){y(z)}w=[]}).resume()})}function u(g,f,b){var y=f;switch(f){case"blob":case"arraybuffer":y="uint8array";break;case"base64":y="string"}try{this._internalType=y,this._outputType=f,this._mimeType=b,t.checkSupport(y),this._worker=g.pipe(new s(y)),g.lock()}catch(w){this._worker=new n("error"),this._worker.error(w)}}u.prototype={accumulate:function(g){return h(this,g)},on:function(g,f){var b=this;return g==="data"?this._worker.on(g,function(y){f.call(b,y.data,y.meta)}):this._worker.on(g,function(){t.delay(f,arguments,b)}),this},resume:function(){return t.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(g){if(t.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new v(this,{objectMode:this._outputType!=="nodebuffer"},g)}},l.exports=u},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,l,r){if(r.base64=!0,r.array=!0,r.string=!0,r.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",r.nodebuffer=typeof Buffer<"u",r.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")r.blob=!1;else{var t=new ArrayBuffer(0);try{r.blob=new Blob([t],{type:"application/zip"}).size===0}catch{try{var s=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);s.append(t),r.blob=s.getBlob("application/zip").size===0}catch{r.blob=!1}}}try{r.nodestream=!!e("readable-stream").Readable}catch{r.nodestream=!1}},{"readable-stream":16}],31:[function(e,l,r){for(var t=e("./utils"),s=e("./support"),n=e("./nodejsUtils"),a=e("./stream/GenericWorker"),m=new Array(256),p=0;p<256;p++)m[p]=252<=p?6:248<=p?5:240<=p?4:224<=p?3:192<=p?2:1;m[254]=m[254]=1;function v(){a.call(this,"utf-8 decode"),this.leftOver=null}function h(){a.call(this,"utf-8 encode")}r.utf8encode=function(u){return s.nodebuffer?n.newBufferFrom(u,"utf-8"):function(g){var f,b,y,w,k,I=g.length,S=0;for(w=0;w<I;w++)(64512&(b=g.charCodeAt(w)))==55296&&w+1<I&&(64512&(y=g.charCodeAt(w+1)))==56320&&(b=65536+(b-55296<<10)+(y-56320),w++),S+=b<128?1:b<2048?2:b<65536?3:4;for(f=s.uint8array?new Uint8Array(S):new Array(S),w=k=0;k<S;w++)(64512&(b=g.charCodeAt(w)))==55296&&w+1<I&&(64512&(y=g.charCodeAt(w+1)))==56320&&(b=65536+(b-55296<<10)+(y-56320),w++),b<128?f[k++]=b:(b<2048?f[k++]=192|b>>>6:(b<65536?f[k++]=224|b>>>12:(f[k++]=240|b>>>18,f[k++]=128|b>>>12&63),f[k++]=128|b>>>6&63),f[k++]=128|63&b);return f}(u)},r.utf8decode=function(u){return s.nodebuffer?t.transformTo("nodebuffer",u).toString("utf-8"):function(g){var f,b,y,w,k=g.length,I=new Array(2*k);for(f=b=0;f<k;)if((y=g[f++])<128)I[b++]=y;else if(4<(w=m[y]))I[b++]=65533,f+=w-1;else{for(y&=w===2?31:w===3?15:7;1<w&&f<k;)y=y<<6|63&g[f++],w--;1<w?I[b++]=65533:y<65536?I[b++]=y:(y-=65536,I[b++]=55296|y>>10&1023,I[b++]=56320|1023&y)}return I.length!==b&&(I.subarray?I=I.subarray(0,b):I.length=b),t.applyFromCharCode(I)}(u=t.transformTo(s.uint8array?"uint8array":"array",u))},t.inherits(v,a),v.prototype.processChunk=function(u){var g=t.transformTo(s.uint8array?"uint8array":"array",u.data);if(this.leftOver&&this.leftOver.length){if(s.uint8array){var f=g;(g=new Uint8Array(f.length+this.leftOver.length)).set(this.leftOver,0),g.set(f,this.leftOver.length)}else g=this.leftOver.concat(g);this.leftOver=null}var b=function(w,k){var I;for((k=k||w.length)>w.length&&(k=w.length),I=k-1;0<=I&&(192&w[I])==128;)I--;return I<0||I===0?k:I+m[w[I]]>k?I:k}(g),y=g;b!==g.length&&(s.uint8array?(y=g.subarray(0,b),this.leftOver=g.subarray(b,g.length)):(y=g.slice(0,b),this.leftOver=g.slice(b,g.length))),this.push({data:r.utf8decode(y),meta:u.meta})},v.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:r.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},r.Utf8DecodeWorker=v,t.inherits(h,a),h.prototype.processChunk=function(u){this.push({data:r.utf8encode(u.data),meta:u.meta})},r.Utf8EncodeWorker=h},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,l,r){var t=e("./support"),s=e("./base64"),n=e("./nodejsUtils"),a=e("./external");function m(f){return f}function p(f,b){for(var y=0;y<f.length;++y)b[y]=255&f.charCodeAt(y);return b}e("setimmediate"),r.newBlob=function(f,b){r.checkSupport("blob");try{return new Blob([f],{type:b})}catch{try{var y=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return y.append(f),y.getBlob(b)}catch{throw new Error("Bug : can't construct the Blob.")}}};var v={stringifyByChunk:function(f,b,y){var w=[],k=0,I=f.length;if(I<=y)return String.fromCharCode.apply(null,f);for(;k<I;)b==="array"||b==="nodebuffer"?w.push(String.fromCharCode.apply(null,f.slice(k,Math.min(k+y,I)))):w.push(String.fromCharCode.apply(null,f.subarray(k,Math.min(k+y,I)))),k+=y;return w.join("")},stringifyByChar:function(f){for(var b="",y=0;y<f.length;y++)b+=String.fromCharCode(f[y]);return b},applyCanBeUsed:{uint8array:function(){try{return t.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}}(),nodebuffer:function(){try{return t.nodebuffer&&String.fromCharCode.apply(null,n.allocBuffer(1)).length===1}catch{return!1}}()}};function h(f){var b=65536,y=r.getTypeOf(f),w=!0;if(y==="uint8array"?w=v.applyCanBeUsed.uint8array:y==="nodebuffer"&&(w=v.applyCanBeUsed.nodebuffer),w)for(;1<b;)try{return v.stringifyByChunk(f,y,b)}catch{b=Math.floor(b/2)}return v.stringifyByChar(f)}function u(f,b){for(var y=0;y<f.length;y++)b[y]=f[y];return b}r.applyFromCharCode=h;var g={};g.string={string:m,array:function(f){return p(f,new Array(f.length))},arraybuffer:function(f){return g.string.uint8array(f).buffer},uint8array:function(f){return p(f,new Uint8Array(f.length))},nodebuffer:function(f){return p(f,n.allocBuffer(f.length))}},g.array={string:h,array:m,arraybuffer:function(f){return new Uint8Array(f).buffer},uint8array:function(f){return new Uint8Array(f)},nodebuffer:function(f){return n.newBufferFrom(f)}},g.arraybuffer={string:function(f){return h(new Uint8Array(f))},array:function(f){return u(new Uint8Array(f),new Array(f.byteLength))},arraybuffer:m,uint8array:function(f){return new Uint8Array(f)},nodebuffer:function(f){return n.newBufferFrom(new Uint8Array(f))}},g.uint8array={string:h,array:function(f){return u(f,new Array(f.length))},arraybuffer:function(f){return f.buffer},uint8array:m,nodebuffer:function(f){return n.newBufferFrom(f)}},g.nodebuffer={string:h,array:function(f){return u(f,new Array(f.length))},arraybuffer:function(f){return g.nodebuffer.uint8array(f).buffer},uint8array:function(f){return u(f,new Uint8Array(f.length))},nodebuffer:m},r.transformTo=function(f,b){if(b=b||"",!f)return b;r.checkSupport(f);var y=r.getTypeOf(b);return g[y][f](b)},r.resolve=function(f){for(var b=f.split("/"),y=[],w=0;w<b.length;w++){var k=b[w];k==="."||k===""&&w!==0&&w!==b.length-1||(k===".."?y.pop():y.push(k))}return y.join("/")},r.getTypeOf=function(f){return typeof f=="string"?"string":Object.prototype.toString.call(f)==="[object Array]"?"array":t.nodebuffer&&n.isBuffer(f)?"nodebuffer":t.uint8array&&f instanceof Uint8Array?"uint8array":t.arraybuffer&&f instanceof ArrayBuffer?"arraybuffer":void 0},r.checkSupport=function(f){if(!t[f.toLowerCase()])throw new Error(f+" is not supported by this platform")},r.MAX_VALUE_16BITS=65535,r.MAX_VALUE_32BITS=-1,r.pretty=function(f){var b,y,w="";for(y=0;y<(f||"").length;y++)w+="\\x"+((b=f.charCodeAt(y))<16?"0":"")+b.toString(16).toUpperCase();return w},r.delay=function(f,b,y){setImmediate(function(){f.apply(y||null,b||[])})},r.inherits=function(f,b){function y(){}y.prototype=b.prototype,f.prototype=new y},r.extend=function(){var f,b,y={};for(f=0;f<arguments.length;f++)for(b in arguments[f])Object.prototype.hasOwnProperty.call(arguments[f],b)&&y[b]===void 0&&(y[b]=arguments[f][b]);return y},r.prepareContent=function(f,b,y,w,k){return a.Promise.resolve(b).then(function(I){return t.blob&&(I instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(I))!==-1)&&typeof FileReader<"u"?new a.Promise(function(S,O){var z=new FileReader;z.onload=function(H){S(H.target.result)},z.onerror=function(H){O(H.target.error)},z.readAsArrayBuffer(I)}):I}).then(function(I){var S=r.getTypeOf(I);return S?(S==="arraybuffer"?I=r.transformTo("uint8array",I):S==="string"&&(k?I=s.decode(I):y&&w!==!0&&(I=function(O){return p(O,t.uint8array?new Uint8Array(O.length):new Array(O.length))}(I))),I):a.Promise.reject(new Error("Can't read the data of '"+f+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(e,l,r){var t=e("./reader/readerFor"),s=e("./utils"),n=e("./signature"),a=e("./zipEntry"),m=e("./support");function p(v){this.files=[],this.loadOptions=v}p.prototype={checkSignature:function(v){if(!this.reader.readAndCheckSignature(v)){this.reader.index-=4;var h=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+s.pretty(h)+", expected "+s.pretty(v)+")")}},isSignature:function(v,h){var u=this.reader.index;this.reader.setIndex(v);var g=this.reader.readString(4)===h;return this.reader.setIndex(u),g},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var v=this.reader.readData(this.zipCommentLength),h=m.uint8array?"uint8array":"array",u=s.transformTo(h,v);this.zipComment=this.loadOptions.decodeFileName(u)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var v,h,u,g=this.zip64EndOfCentralSize-44;0<g;)v=this.reader.readInt(2),h=this.reader.readInt(4),u=this.reader.readData(h),this.zip64ExtensibleData[v]={id:v,length:h,value:u}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var v,h;for(v=0;v<this.files.length;v++)h=this.files[v],this.reader.setIndex(h.localHeaderOffset),this.checkSignature(n.LOCAL_FILE_HEADER),h.readLocalPart(this.reader),h.handleUTF8(),h.processAttributes()},readCentralDir:function(){var v;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(n.CENTRAL_FILE_HEADER);)(v=new a({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(v);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var v=this.reader.lastIndexOfSignature(n.CENTRAL_DIRECTORY_END);if(v<0)throw this.isSignature(0,n.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(v);var h=v;if(this.checkSignature(n.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===s.MAX_VALUE_16BITS||this.diskWithCentralDirStart===s.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===s.MAX_VALUE_16BITS||this.centralDirRecords===s.MAX_VALUE_16BITS||this.centralDirSize===s.MAX_VALUE_32BITS||this.centralDirOffset===s.MAX_VALUE_32BITS){if(this.zip64=!0,(v=this.reader.lastIndexOfSignature(n.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(v),this.checkSignature(n.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,n.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(n.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(n.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var u=this.centralDirOffset+this.centralDirSize;this.zip64&&(u+=20,u+=12+this.zip64EndOfCentralSize);var g=h-u;if(0<g)this.isSignature(h,n.CENTRAL_FILE_HEADER)||(this.reader.zero=g);else if(g<0)throw new Error("Corrupted zip: missing "+Math.abs(g)+" bytes.")},prepareReader:function(v){this.reader=t(v)},load:function(v){this.prepareReader(v),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},l.exports=p},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(e,l,r){var t=e("./reader/readerFor"),s=e("./utils"),n=e("./compressedObject"),a=e("./crc32"),m=e("./utf8"),p=e("./compressions"),v=e("./support");function h(u,g){this.options=u,this.loadOptions=g}h.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(u){var g,f;if(u.skip(22),this.fileNameLength=u.readInt(2),f=u.readInt(2),this.fileName=u.readData(this.fileNameLength),u.skip(f),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((g=function(b){for(var y in p)if(Object.prototype.hasOwnProperty.call(p,y)&&p[y].magic===b)return p[y];return null}(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+s.pretty(this.compressionMethod)+" unknown (inner file : "+s.transformTo("string",this.fileName)+")");this.decompressed=new n(this.compressedSize,this.uncompressedSize,this.crc32,g,u.readData(this.compressedSize))},readCentralPart:function(u){this.versionMadeBy=u.readInt(2),u.skip(2),this.bitFlag=u.readInt(2),this.compressionMethod=u.readString(2),this.date=u.readDate(),this.crc32=u.readInt(4),this.compressedSize=u.readInt(4),this.uncompressedSize=u.readInt(4);var g=u.readInt(2);if(this.extraFieldsLength=u.readInt(2),this.fileCommentLength=u.readInt(2),this.diskNumberStart=u.readInt(2),this.internalFileAttributes=u.readInt(2),this.externalFileAttributes=u.readInt(4),this.localHeaderOffset=u.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");u.skip(g),this.readExtraFields(u),this.parseZIP64ExtraField(u),this.fileComment=u.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var u=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),u==0&&(this.dosPermissions=63&this.externalFileAttributes),u==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var u=t(this.extraFields[1].value);this.uncompressedSize===s.MAX_VALUE_32BITS&&(this.uncompressedSize=u.readInt(8)),this.compressedSize===s.MAX_VALUE_32BITS&&(this.compressedSize=u.readInt(8)),this.localHeaderOffset===s.MAX_VALUE_32BITS&&(this.localHeaderOffset=u.readInt(8)),this.diskNumberStart===s.MAX_VALUE_32BITS&&(this.diskNumberStart=u.readInt(4))}},readExtraFields:function(u){var g,f,b,y=u.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});u.index+4<y;)g=u.readInt(2),f=u.readInt(2),b=u.readData(f),this.extraFields[g]={id:g,length:f,value:b};u.setIndex(y)},handleUTF8:function(){var u=v.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=m.utf8decode(this.fileName),this.fileCommentStr=m.utf8decode(this.fileComment);else{var g=this.findExtraFieldUnicodePath();if(g!==null)this.fileNameStr=g;else{var f=s.transformTo(u,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(f)}var b=this.findExtraFieldUnicodeComment();if(b!==null)this.fileCommentStr=b;else{var y=s.transformTo(u,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(y)}}},findExtraFieldUnicodePath:function(){var u=this.extraFields[28789];if(u){var g=t(u.value);return g.readInt(1)!==1||a(this.fileName)!==g.readInt(4)?null:m.utf8decode(g.readData(u.length-5))}return null},findExtraFieldUnicodeComment:function(){var u=this.extraFields[25461];if(u){var g=t(u.value);return g.readInt(1)!==1||a(this.fileComment)!==g.readInt(4)?null:m.utf8decode(g.readData(u.length-5))}return null}},l.exports=h},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(e,l,r){function t(g,f,b){this.name=g,this.dir=b.dir,this.date=b.date,this.comment=b.comment,this.unixPermissions=b.unixPermissions,this.dosPermissions=b.dosPermissions,this._data=f,this._dataBinary=b.binary,this.options={compression:b.compression,compressionOptions:b.compressionOptions}}var s=e("./stream/StreamHelper"),n=e("./stream/DataWorker"),a=e("./utf8"),m=e("./compressedObject"),p=e("./stream/GenericWorker");t.prototype={internalStream:function(g){var f=null,b="string";try{if(!g)throw new Error("No output type specified.");var y=(b=g.toLowerCase())==="string"||b==="text";b!=="binarystring"&&b!=="text"||(b="string"),f=this._decompressWorker();var w=!this._dataBinary;w&&!y&&(f=f.pipe(new a.Utf8EncodeWorker)),!w&&y&&(f=f.pipe(new a.Utf8DecodeWorker))}catch(k){(f=new p("error")).error(k)}return new s(f,b,"")},async:function(g,f){return this.internalStream(g).accumulate(f)},nodeStream:function(g,f){return this.internalStream(g||"nodebuffer").toNodejsStream(f)},_compressWorker:function(g,f){if(this._data instanceof m&&this._data.compression.magic===g.magic)return this._data.getCompressedWorker();var b=this._decompressWorker();return this._dataBinary||(b=b.pipe(new a.Utf8EncodeWorker)),m.createWorkerFrom(b,g,f)},_decompressWorker:function(){return this._data instanceof m?this._data.getContentWorker():this._data instanceof p?this._data:new n(this._data)}};for(var v=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],h=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},u=0;u<v.length;u++)t.prototype[v[u]]=h;l.exports=t},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(e,l,r){(function(t){var s,n,a=t.MutationObserver||t.WebKitMutationObserver;if(a){var m=0,p=new a(g),v=t.document.createTextNode("");p.observe(v,{characterData:!0}),s=function(){v.data=m=++m%2}}else if(t.setImmediate||t.MessageChannel===void 0)s="document"in t&&"onreadystatechange"in t.document.createElement("script")?function(){var f=t.document.createElement("script");f.onreadystatechange=function(){g(),f.onreadystatechange=null,f.parentNode.removeChild(f),f=null},t.document.documentElement.appendChild(f)}:function(){setTimeout(g,0)};else{var h=new t.MessageChannel;h.port1.onmessage=g,s=function(){h.port2.postMessage(0)}}var u=[];function g(){var f,b;n=!0;for(var y=u.length;y;){for(b=u,u=[],f=-1;++f<y;)b[f]();y=u.length}n=!1}l.exports=function(f){u.push(f)!==1||n||s()}}).call(this,typeof rn<"u"?rn:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(e,l,r){var t=e("immediate");function s(){}var n={},a=["REJECTED"],m=["FULFILLED"],p=["PENDING"];function v(y){if(typeof y!="function")throw new TypeError("resolver must be a function");this.state=p,this.queue=[],this.outcome=void 0,y!==s&&f(this,y)}function h(y,w,k){this.promise=y,typeof w=="function"&&(this.onFulfilled=w,this.callFulfilled=this.otherCallFulfilled),typeof k=="function"&&(this.onRejected=k,this.callRejected=this.otherCallRejected)}function u(y,w,k){t(function(){var I;try{I=w(k)}catch(S){return n.reject(y,S)}I===y?n.reject(y,new TypeError("Cannot resolve promise with itself")):n.resolve(y,I)})}function g(y){var w=y&&y.then;if(y&&(typeof y=="object"||typeof y=="function")&&typeof w=="function")return function(){w.apply(y,arguments)}}function f(y,w){var k=!1;function I(z){k||(k=!0,n.reject(y,z))}function S(z){k||(k=!0,n.resolve(y,z))}var O=b(function(){w(S,I)});O.status==="error"&&I(O.value)}function b(y,w){var k={};try{k.value=y(w),k.status="success"}catch(I){k.status="error",k.value=I}return k}(l.exports=v).prototype.finally=function(y){if(typeof y!="function")return this;var w=this.constructor;return this.then(function(k){return w.resolve(y()).then(function(){return k})},function(k){return w.resolve(y()).then(function(){throw k})})},v.prototype.catch=function(y){return this.then(null,y)},v.prototype.then=function(y,w){if(typeof y!="function"&&this.state===m||typeof w!="function"&&this.state===a)return this;var k=new this.constructor(s);return this.state!==p?u(k,this.state===m?y:w,this.outcome):this.queue.push(new h(k,y,w)),k},h.prototype.callFulfilled=function(y){n.resolve(this.promise,y)},h.prototype.otherCallFulfilled=function(y){u(this.promise,this.onFulfilled,y)},h.prototype.callRejected=function(y){n.reject(this.promise,y)},h.prototype.otherCallRejected=function(y){u(this.promise,this.onRejected,y)},n.resolve=function(y,w){var k=b(g,w);if(k.status==="error")return n.reject(y,k.value);var I=k.value;if(I)f(y,I);else{y.state=m,y.outcome=w;for(var S=-1,O=y.queue.length;++S<O;)y.queue[S].callFulfilled(w)}return y},n.reject=function(y,w){y.state=a,y.outcome=w;for(var k=-1,I=y.queue.length;++k<I;)y.queue[k].callRejected(w);return y},v.resolve=function(y){return y instanceof this?y:n.resolve(new this(s),y)},v.reject=function(y){var w=new this(s);return n.reject(w,y)},v.all=function(y){var w=this;if(Object.prototype.toString.call(y)!=="[object Array]")return this.reject(new TypeError("must be an array"));var k=y.length,I=!1;if(!k)return this.resolve([]);for(var S=new Array(k),O=0,z=-1,H=new this(s);++z<k;)A(y[z],z);return H;function A(Z,ie){w.resolve(Z).then(function(E){S[ie]=E,++O!==k||I||(I=!0,n.resolve(H,S))},function(E){I||(I=!0,n.reject(H,E))})}},v.race=function(y){var w=this;if(Object.prototype.toString.call(y)!=="[object Array]")return this.reject(new TypeError("must be an array"));var k=y.length,I=!1;if(!k)return this.resolve([]);for(var S=-1,O=new this(s);++S<k;)z=y[S],w.resolve(z).then(function(H){I||(I=!0,n.resolve(O,H))},function(H){I||(I=!0,n.reject(O,H))});var z;return O}},{immediate:36}],38:[function(e,l,r){var t={};(0,e("./lib/utils/common").assign)(t,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),l.exports=t},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(e,l,r){var t=e("./zlib/deflate"),s=e("./utils/common"),n=e("./utils/strings"),a=e("./zlib/messages"),m=e("./zlib/zstream"),p=Object.prototype.toString,v=0,h=-1,u=0,g=8;function f(y){if(!(this instanceof f))return new f(y);this.options=s.assign({level:h,method:g,chunkSize:16384,windowBits:15,memLevel:8,strategy:u,to:""},y||{});var w=this.options;w.raw&&0<w.windowBits?w.windowBits=-w.windowBits:w.gzip&&0<w.windowBits&&w.windowBits<16&&(w.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new m,this.strm.avail_out=0;var k=t.deflateInit2(this.strm,w.level,w.method,w.windowBits,w.memLevel,w.strategy);if(k!==v)throw new Error(a[k]);if(w.header&&t.deflateSetHeader(this.strm,w.header),w.dictionary){var I;if(I=typeof w.dictionary=="string"?n.string2buf(w.dictionary):p.call(w.dictionary)==="[object ArrayBuffer]"?new Uint8Array(w.dictionary):w.dictionary,(k=t.deflateSetDictionary(this.strm,I))!==v)throw new Error(a[k]);this._dict_set=!0}}function b(y,w){var k=new f(w);if(k.push(y,!0),k.err)throw k.msg||a[k.err];return k.result}f.prototype.push=function(y,w){var k,I,S=this.strm,O=this.options.chunkSize;if(this.ended)return!1;I=w===~~w?w:w===!0?4:0,typeof y=="string"?S.input=n.string2buf(y):p.call(y)==="[object ArrayBuffer]"?S.input=new Uint8Array(y):S.input=y,S.next_in=0,S.avail_in=S.input.length;do{if(S.avail_out===0&&(S.output=new s.Buf8(O),S.next_out=0,S.avail_out=O),(k=t.deflate(S,I))!==1&&k!==v)return this.onEnd(k),!(this.ended=!0);S.avail_out!==0&&(S.avail_in!==0||I!==4&&I!==2)||(this.options.to==="string"?this.onData(n.buf2binstring(s.shrinkBuf(S.output,S.next_out))):this.onData(s.shrinkBuf(S.output,S.next_out)))}while((0<S.avail_in||S.avail_out===0)&&k!==1);return I===4?(k=t.deflateEnd(this.strm),this.onEnd(k),this.ended=!0,k===v):I!==2||(this.onEnd(v),!(S.avail_out=0))},f.prototype.onData=function(y){this.chunks.push(y)},f.prototype.onEnd=function(y){y===v&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=s.flattenChunks(this.chunks)),this.chunks=[],this.err=y,this.msg=this.strm.msg},r.Deflate=f,r.deflate=b,r.deflateRaw=function(y,w){return(w=w||{}).raw=!0,b(y,w)},r.gzip=function(y,w){return(w=w||{}).gzip=!0,b(y,w)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(e,l,r){var t=e("./zlib/inflate"),s=e("./utils/common"),n=e("./utils/strings"),a=e("./zlib/constants"),m=e("./zlib/messages"),p=e("./zlib/zstream"),v=e("./zlib/gzheader"),h=Object.prototype.toString;function u(f){if(!(this instanceof u))return new u(f);this.options=s.assign({chunkSize:16384,windowBits:0,to:""},f||{});var b=this.options;b.raw&&0<=b.windowBits&&b.windowBits<16&&(b.windowBits=-b.windowBits,b.windowBits===0&&(b.windowBits=-15)),!(0<=b.windowBits&&b.windowBits<16)||f&&f.windowBits||(b.windowBits+=32),15<b.windowBits&&b.windowBits<48&&!(15&b.windowBits)&&(b.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new p,this.strm.avail_out=0;var y=t.inflateInit2(this.strm,b.windowBits);if(y!==a.Z_OK)throw new Error(m[y]);this.header=new v,t.inflateGetHeader(this.strm,this.header)}function g(f,b){var y=new u(b);if(y.push(f,!0),y.err)throw y.msg||m[y.err];return y.result}u.prototype.push=function(f,b){var y,w,k,I,S,O,z=this.strm,H=this.options.chunkSize,A=this.options.dictionary,Z=!1;if(this.ended)return!1;w=b===~~b?b:b===!0?a.Z_FINISH:a.Z_NO_FLUSH,typeof f=="string"?z.input=n.binstring2buf(f):h.call(f)==="[object ArrayBuffer]"?z.input=new Uint8Array(f):z.input=f,z.next_in=0,z.avail_in=z.input.length;do{if(z.avail_out===0&&(z.output=new s.Buf8(H),z.next_out=0,z.avail_out=H),(y=t.inflate(z,a.Z_NO_FLUSH))===a.Z_NEED_DICT&&A&&(O=typeof A=="string"?n.string2buf(A):h.call(A)==="[object ArrayBuffer]"?new Uint8Array(A):A,y=t.inflateSetDictionary(this.strm,O)),y===a.Z_BUF_ERROR&&Z===!0&&(y=a.Z_OK,Z=!1),y!==a.Z_STREAM_END&&y!==a.Z_OK)return this.onEnd(y),!(this.ended=!0);z.next_out&&(z.avail_out!==0&&y!==a.Z_STREAM_END&&(z.avail_in!==0||w!==a.Z_FINISH&&w!==a.Z_SYNC_FLUSH)||(this.options.to==="string"?(k=n.utf8border(z.output,z.next_out),I=z.next_out-k,S=n.buf2string(z.output,k),z.next_out=I,z.avail_out=H-I,I&&s.arraySet(z.output,z.output,k,I,0),this.onData(S)):this.onData(s.shrinkBuf(z.output,z.next_out)))),z.avail_in===0&&z.avail_out===0&&(Z=!0)}while((0<z.avail_in||z.avail_out===0)&&y!==a.Z_STREAM_END);return y===a.Z_STREAM_END&&(w=a.Z_FINISH),w===a.Z_FINISH?(y=t.inflateEnd(this.strm),this.onEnd(y),this.ended=!0,y===a.Z_OK):w!==a.Z_SYNC_FLUSH||(this.onEnd(a.Z_OK),!(z.avail_out=0))},u.prototype.onData=function(f){this.chunks.push(f)},u.prototype.onEnd=function(f){f===a.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=s.flattenChunks(this.chunks)),this.chunks=[],this.err=f,this.msg=this.strm.msg},r.Inflate=u,r.inflate=g,r.inflateRaw=function(f,b){return(b=b||{}).raw=!0,g(f,b)},r.ungzip=g},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(e,l,r){var t=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";r.assign=function(a){for(var m=Array.prototype.slice.call(arguments,1);m.length;){var p=m.shift();if(p){if(typeof p!="object")throw new TypeError(p+"must be non-object");for(var v in p)p.hasOwnProperty(v)&&(a[v]=p[v])}}return a},r.shrinkBuf=function(a,m){return a.length===m?a:a.subarray?a.subarray(0,m):(a.length=m,a)};var s={arraySet:function(a,m,p,v,h){if(m.subarray&&a.subarray)a.set(m.subarray(p,p+v),h);else for(var u=0;u<v;u++)a[h+u]=m[p+u]},flattenChunks:function(a){var m,p,v,h,u,g;for(m=v=0,p=a.length;m<p;m++)v+=a[m].length;for(g=new Uint8Array(v),m=h=0,p=a.length;m<p;m++)u=a[m],g.set(u,h),h+=u.length;return g}},n={arraySet:function(a,m,p,v,h){for(var u=0;u<v;u++)a[h+u]=m[p+u]},flattenChunks:function(a){return[].concat.apply([],a)}};r.setTyped=function(a){a?(r.Buf8=Uint8Array,r.Buf16=Uint16Array,r.Buf32=Int32Array,r.assign(r,s)):(r.Buf8=Array,r.Buf16=Array,r.Buf32=Array,r.assign(r,n))},r.setTyped(t)},{}],42:[function(e,l,r){var t=e("./common"),s=!0,n=!0;try{String.fromCharCode.apply(null,[0])}catch{s=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{n=!1}for(var a=new t.Buf8(256),m=0;m<256;m++)a[m]=252<=m?6:248<=m?5:240<=m?4:224<=m?3:192<=m?2:1;function p(v,h){if(h<65537&&(v.subarray&&n||!v.subarray&&s))return String.fromCharCode.apply(null,t.shrinkBuf(v,h));for(var u="",g=0;g<h;g++)u+=String.fromCharCode(v[g]);return u}a[254]=a[254]=1,r.string2buf=function(v){var h,u,g,f,b,y=v.length,w=0;for(f=0;f<y;f++)(64512&(u=v.charCodeAt(f)))==55296&&f+1<y&&(64512&(g=v.charCodeAt(f+1)))==56320&&(u=65536+(u-55296<<10)+(g-56320),f++),w+=u<128?1:u<2048?2:u<65536?3:4;for(h=new t.Buf8(w),f=b=0;b<w;f++)(64512&(u=v.charCodeAt(f)))==55296&&f+1<y&&(64512&(g=v.charCodeAt(f+1)))==56320&&(u=65536+(u-55296<<10)+(g-56320),f++),u<128?h[b++]=u:(u<2048?h[b++]=192|u>>>6:(u<65536?h[b++]=224|u>>>12:(h[b++]=240|u>>>18,h[b++]=128|u>>>12&63),h[b++]=128|u>>>6&63),h[b++]=128|63&u);return h},r.buf2binstring=function(v){return p(v,v.length)},r.binstring2buf=function(v){for(var h=new t.Buf8(v.length),u=0,g=h.length;u<g;u++)h[u]=v.charCodeAt(u);return h},r.buf2string=function(v,h){var u,g,f,b,y=h||v.length,w=new Array(2*y);for(u=g=0;u<y;)if((f=v[u++])<128)w[g++]=f;else if(4<(b=a[f]))w[g++]=65533,u+=b-1;else{for(f&=b===2?31:b===3?15:7;1<b&&u<y;)f=f<<6|63&v[u++],b--;1<b?w[g++]=65533:f<65536?w[g++]=f:(f-=65536,w[g++]=55296|f>>10&1023,w[g++]=56320|1023&f)}return p(w,g)},r.utf8border=function(v,h){var u;for((h=h||v.length)>v.length&&(h=v.length),u=h-1;0<=u&&(192&v[u])==128;)u--;return u<0||u===0?h:u+a[v[u]]>h?u:h}},{"./common":41}],43:[function(e,l,r){l.exports=function(t,s,n,a){for(var m=65535&t|0,p=t>>>16&65535|0,v=0;n!==0;){for(n-=v=2e3<n?2e3:n;p=p+(m=m+s[a++]|0)|0,--v;);m%=65521,p%=65521}return m|p<<16|0}},{}],44:[function(e,l,r){l.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(e,l,r){var t=function(){for(var s,n=[],a=0;a<256;a++){s=a;for(var m=0;m<8;m++)s=1&s?3988292384^s>>>1:s>>>1;n[a]=s}return n}();l.exports=function(s,n,a,m){var p=t,v=m+a;s^=-1;for(var h=m;h<v;h++)s=s>>>8^p[255&(s^n[h])];return-1^s}},{}],46:[function(e,l,r){var t,s=e("../utils/common"),n=e("./trees"),a=e("./adler32"),m=e("./crc32"),p=e("./messages"),v=0,h=4,u=0,g=-2,f=-1,b=4,y=2,w=8,k=9,I=286,S=30,O=19,z=2*I+1,H=15,A=3,Z=258,ie=Z+A+1,E=42,M=113,d=1,F=2,ue=3,j=4;function fe(o,P){return o.msg=p[P],P}function $(o){return(o<<1)-(4<o?9:0)}function te(o){for(var P=o.length;0<=--P;)o[P]=0}function T(o){var P=o.state,R=P.pending;R>o.avail_out&&(R=o.avail_out),R!==0&&(s.arraySet(o.output,P.pending_buf,P.pending_out,R,o.next_out),o.next_out+=R,P.pending_out+=R,o.total_out+=R,o.avail_out-=R,P.pending-=R,P.pending===0&&(P.pending_out=0))}function N(o,P){n._tr_flush_block(o,0<=o.block_start?o.block_start:-1,o.strstart-o.block_start,P),o.block_start=o.strstart,T(o.strm)}function re(o,P){o.pending_buf[o.pending++]=P}function ee(o,P){o.pending_buf[o.pending++]=P>>>8&255,o.pending_buf[o.pending++]=255&P}function Y(o,P){var R,_,C=o.max_chain_length,x=o.strstart,W=o.prev_length,q=o.nice_match,B=o.strstart>o.w_size-ie?o.strstart-(o.w_size-ie):0,G=o.window,ne=o.w_mask,K=o.prev,ce=o.strstart+Z,ke=G[x+W-1],ye=G[x+W];o.prev_length>=o.good_match&&(C>>=2),q>o.lookahead&&(q=o.lookahead);do if(G[(R=P)+W]===ye&&G[R+W-1]===ke&&G[R]===G[x]&&G[++R]===G[x+1]){x+=2,R++;do;while(G[++x]===G[++R]&&G[++x]===G[++R]&&G[++x]===G[++R]&&G[++x]===G[++R]&&G[++x]===G[++R]&&G[++x]===G[++R]&&G[++x]===G[++R]&&G[++x]===G[++R]&&x<ce);if(_=Z-(ce-x),x=ce-Z,W<_){if(o.match_start=P,q<=(W=_))break;ke=G[x+W-1],ye=G[x+W]}}while((P=K[P&ne])>B&&--C!=0);return W<=o.lookahead?W:o.lookahead}function Te(o){var P,R,_,C,x,W,q,B,G,ne,K=o.w_size;do{if(C=o.window_size-o.lookahead-o.strstart,o.strstart>=K+(K-ie)){for(s.arraySet(o.window,o.window,K,K,0),o.match_start-=K,o.strstart-=K,o.block_start-=K,P=R=o.hash_size;_=o.head[--P],o.head[P]=K<=_?_-K:0,--R;);for(P=R=K;_=o.prev[--P],o.prev[P]=K<=_?_-K:0,--R;);C+=K}if(o.strm.avail_in===0)break;if(W=o.strm,q=o.window,B=o.strstart+o.lookahead,G=C,ne=void 0,ne=W.avail_in,G<ne&&(ne=G),R=ne===0?0:(W.avail_in-=ne,s.arraySet(q,W.input,W.next_in,ne,B),W.state.wrap===1?W.adler=a(W.adler,q,ne,B):W.state.wrap===2&&(W.adler=m(W.adler,q,ne,B)),W.next_in+=ne,W.total_in+=ne,ne),o.lookahead+=R,o.lookahead+o.insert>=A)for(x=o.strstart-o.insert,o.ins_h=o.window[x],o.ins_h=(o.ins_h<<o.hash_shift^o.window[x+1])&o.hash_mask;o.insert&&(o.ins_h=(o.ins_h<<o.hash_shift^o.window[x+A-1])&o.hash_mask,o.prev[x&o.w_mask]=o.head[o.ins_h],o.head[o.ins_h]=x,x++,o.insert--,!(o.lookahead+o.insert<A)););}while(o.lookahead<ie&&o.strm.avail_in!==0)}function De(o,P){for(var R,_;;){if(o.lookahead<ie){if(Te(o),o.lookahead<ie&&P===v)return d;if(o.lookahead===0)break}if(R=0,o.lookahead>=A&&(o.ins_h=(o.ins_h<<o.hash_shift^o.window[o.strstart+A-1])&o.hash_mask,R=o.prev[o.strstart&o.w_mask]=o.head[o.ins_h],o.head[o.ins_h]=o.strstart),R!==0&&o.strstart-R<=o.w_size-ie&&(o.match_length=Y(o,R)),o.match_length>=A)if(_=n._tr_tally(o,o.strstart-o.match_start,o.match_length-A),o.lookahead-=o.match_length,o.match_length<=o.max_lazy_match&&o.lookahead>=A){for(o.match_length--;o.strstart++,o.ins_h=(o.ins_h<<o.hash_shift^o.window[o.strstart+A-1])&o.hash_mask,R=o.prev[o.strstart&o.w_mask]=o.head[o.ins_h],o.head[o.ins_h]=o.strstart,--o.match_length!=0;);o.strstart++}else o.strstart+=o.match_length,o.match_length=0,o.ins_h=o.window[o.strstart],o.ins_h=(o.ins_h<<o.hash_shift^o.window[o.strstart+1])&o.hash_mask;else _=n._tr_tally(o,0,o.window[o.strstart]),o.lookahead--,o.strstart++;if(_&&(N(o,!1),o.strm.avail_out===0))return d}return o.insert=o.strstart<A-1?o.strstart:A-1,P===h?(N(o,!0),o.strm.avail_out===0?ue:j):o.last_lit&&(N(o,!1),o.strm.avail_out===0)?d:F}function ge(o,P){for(var R,_,C;;){if(o.lookahead<ie){if(Te(o),o.lookahead<ie&&P===v)return d;if(o.lookahead===0)break}if(R=0,o.lookahead>=A&&(o.ins_h=(o.ins_h<<o.hash_shift^o.window[o.strstart+A-1])&o.hash_mask,R=o.prev[o.strstart&o.w_mask]=o.head[o.ins_h],o.head[o.ins_h]=o.strstart),o.prev_length=o.match_length,o.prev_match=o.match_start,o.match_length=A-1,R!==0&&o.prev_length<o.max_lazy_match&&o.strstart-R<=o.w_size-ie&&(o.match_length=Y(o,R),o.match_length<=5&&(o.strategy===1||o.match_length===A&&4096<o.strstart-o.match_start)&&(o.match_length=A-1)),o.prev_length>=A&&o.match_length<=o.prev_length){for(C=o.strstart+o.lookahead-A,_=n._tr_tally(o,o.strstart-1-o.prev_match,o.prev_length-A),o.lookahead-=o.prev_length-1,o.prev_length-=2;++o.strstart<=C&&(o.ins_h=(o.ins_h<<o.hash_shift^o.window[o.strstart+A-1])&o.hash_mask,R=o.prev[o.strstart&o.w_mask]=o.head[o.ins_h],o.head[o.ins_h]=o.strstart),--o.prev_length!=0;);if(o.match_available=0,o.match_length=A-1,o.strstart++,_&&(N(o,!1),o.strm.avail_out===0))return d}else if(o.match_available){if((_=n._tr_tally(o,0,o.window[o.strstart-1]))&&N(o,!1),o.strstart++,o.lookahead--,o.strm.avail_out===0)return d}else o.match_available=1,o.strstart++,o.lookahead--}return o.match_available&&(_=n._tr_tally(o,0,o.window[o.strstart-1]),o.match_available=0),o.insert=o.strstart<A-1?o.strstart:A-1,P===h?(N(o,!0),o.strm.avail_out===0?ue:j):o.last_lit&&(N(o,!1),o.strm.avail_out===0)?d:F}function ve(o,P,R,_,C){this.good_length=o,this.max_lazy=P,this.nice_length=R,this.max_chain=_,this.func=C}function Ae(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=w,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new s.Buf16(2*z),this.dyn_dtree=new s.Buf16(2*(2*S+1)),this.bl_tree=new s.Buf16(2*(2*O+1)),te(this.dyn_ltree),te(this.dyn_dtree),te(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new s.Buf16(H+1),this.heap=new s.Buf16(2*I+1),te(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new s.Buf16(2*I+1),te(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function Ne(o){var P;return o&&o.state?(o.total_in=o.total_out=0,o.data_type=y,(P=o.state).pending=0,P.pending_out=0,P.wrap<0&&(P.wrap=-P.wrap),P.status=P.wrap?E:M,o.adler=P.wrap===2?0:1,P.last_flush=v,n._tr_init(P),u):fe(o,g)}function Ve(o){var P=Ne(o);return P===u&&function(R){R.window_size=2*R.w_size,te(R.head),R.max_lazy_match=t[R.level].max_lazy,R.good_match=t[R.level].good_length,R.nice_match=t[R.level].nice_length,R.max_chain_length=t[R.level].max_chain,R.strstart=0,R.block_start=0,R.lookahead=0,R.insert=0,R.match_length=R.prev_length=A-1,R.match_available=0,R.ins_h=0}(o.state),P}function Ke(o,P,R,_,C,x){if(!o)return g;var W=1;if(P===f&&(P=6),_<0?(W=0,_=-_):15<_&&(W=2,_-=16),C<1||k<C||R!==w||_<8||15<_||P<0||9<P||x<0||b<x)return fe(o,g);_===8&&(_=9);var q=new Ae;return(o.state=q).strm=o,q.wrap=W,q.gzhead=null,q.w_bits=_,q.w_size=1<<q.w_bits,q.w_mask=q.w_size-1,q.hash_bits=C+7,q.hash_size=1<<q.hash_bits,q.hash_mask=q.hash_size-1,q.hash_shift=~~((q.hash_bits+A-1)/A),q.window=new s.Buf8(2*q.w_size),q.head=new s.Buf16(q.hash_size),q.prev=new s.Buf16(q.w_size),q.lit_bufsize=1<<C+6,q.pending_buf_size=4*q.lit_bufsize,q.pending_buf=new s.Buf8(q.pending_buf_size),q.d_buf=1*q.lit_bufsize,q.l_buf=3*q.lit_bufsize,q.level=P,q.strategy=x,q.method=R,Ve(o)}t=[new ve(0,0,0,0,function(o,P){var R=65535;for(R>o.pending_buf_size-5&&(R=o.pending_buf_size-5);;){if(o.lookahead<=1){if(Te(o),o.lookahead===0&&P===v)return d;if(o.lookahead===0)break}o.strstart+=o.lookahead,o.lookahead=0;var _=o.block_start+R;if((o.strstart===0||o.strstart>=_)&&(o.lookahead=o.strstart-_,o.strstart=_,N(o,!1),o.strm.avail_out===0)||o.strstart-o.block_start>=o.w_size-ie&&(N(o,!1),o.strm.avail_out===0))return d}return o.insert=0,P===h?(N(o,!0),o.strm.avail_out===0?ue:j):(o.strstart>o.block_start&&(N(o,!1),o.strm.avail_out),d)}),new ve(4,4,8,4,De),new ve(4,5,16,8,De),new ve(4,6,32,32,De),new ve(4,4,16,16,ge),new ve(8,16,32,32,ge),new ve(8,16,128,128,ge),new ve(8,32,128,256,ge),new ve(32,128,258,1024,ge),new ve(32,258,258,4096,ge)],r.deflateInit=function(o,P){return Ke(o,P,w,15,8,0)},r.deflateInit2=Ke,r.deflateReset=Ve,r.deflateResetKeep=Ne,r.deflateSetHeader=function(o,P){return o&&o.state?o.state.wrap!==2?g:(o.state.gzhead=P,u):g},r.deflate=function(o,P){var R,_,C,x;if(!o||!o.state||5<P||P<0)return o?fe(o,g):g;if(_=o.state,!o.output||!o.input&&o.avail_in!==0||_.status===666&&P!==h)return fe(o,o.avail_out===0?-5:g);if(_.strm=o,R=_.last_flush,_.last_flush=P,_.status===E)if(_.wrap===2)o.adler=0,re(_,31),re(_,139),re(_,8),_.gzhead?(re(_,(_.gzhead.text?1:0)+(_.gzhead.hcrc?2:0)+(_.gzhead.extra?4:0)+(_.gzhead.name?8:0)+(_.gzhead.comment?16:0)),re(_,255&_.gzhead.time),re(_,_.gzhead.time>>8&255),re(_,_.gzhead.time>>16&255),re(_,_.gzhead.time>>24&255),re(_,_.level===9?2:2<=_.strategy||_.level<2?4:0),re(_,255&_.gzhead.os),_.gzhead.extra&&_.gzhead.extra.length&&(re(_,255&_.gzhead.extra.length),re(_,_.gzhead.extra.length>>8&255)),_.gzhead.hcrc&&(o.adler=m(o.adler,_.pending_buf,_.pending,0)),_.gzindex=0,_.status=69):(re(_,0),re(_,0),re(_,0),re(_,0),re(_,0),re(_,_.level===9?2:2<=_.strategy||_.level<2?4:0),re(_,3),_.status=M);else{var W=w+(_.w_bits-8<<4)<<8;W|=(2<=_.strategy||_.level<2?0:_.level<6?1:_.level===6?2:3)<<6,_.strstart!==0&&(W|=32),W+=31-W%31,_.status=M,ee(_,W),_.strstart!==0&&(ee(_,o.adler>>>16),ee(_,65535&o.adler)),o.adler=1}if(_.status===69)if(_.gzhead.extra){for(C=_.pending;_.gzindex<(65535&_.gzhead.extra.length)&&(_.pending!==_.pending_buf_size||(_.gzhead.hcrc&&_.pending>C&&(o.adler=m(o.adler,_.pending_buf,_.pending-C,C)),T(o),C=_.pending,_.pending!==_.pending_buf_size));)re(_,255&_.gzhead.extra[_.gzindex]),_.gzindex++;_.gzhead.hcrc&&_.pending>C&&(o.adler=m(o.adler,_.pending_buf,_.pending-C,C)),_.gzindex===_.gzhead.extra.length&&(_.gzindex=0,_.status=73)}else _.status=73;if(_.status===73)if(_.gzhead.name){C=_.pending;do{if(_.pending===_.pending_buf_size&&(_.gzhead.hcrc&&_.pending>C&&(o.adler=m(o.adler,_.pending_buf,_.pending-C,C)),T(o),C=_.pending,_.pending===_.pending_buf_size)){x=1;break}x=_.gzindex<_.gzhead.name.length?255&_.gzhead.name.charCodeAt(_.gzindex++):0,re(_,x)}while(x!==0);_.gzhead.hcrc&&_.pending>C&&(o.adler=m(o.adler,_.pending_buf,_.pending-C,C)),x===0&&(_.gzindex=0,_.status=91)}else _.status=91;if(_.status===91)if(_.gzhead.comment){C=_.pending;do{if(_.pending===_.pending_buf_size&&(_.gzhead.hcrc&&_.pending>C&&(o.adler=m(o.adler,_.pending_buf,_.pending-C,C)),T(o),C=_.pending,_.pending===_.pending_buf_size)){x=1;break}x=_.gzindex<_.gzhead.comment.length?255&_.gzhead.comment.charCodeAt(_.gzindex++):0,re(_,x)}while(x!==0);_.gzhead.hcrc&&_.pending>C&&(o.adler=m(o.adler,_.pending_buf,_.pending-C,C)),x===0&&(_.status=103)}else _.status=103;if(_.status===103&&(_.gzhead.hcrc?(_.pending+2>_.pending_buf_size&&T(o),_.pending+2<=_.pending_buf_size&&(re(_,255&o.adler),re(_,o.adler>>8&255),o.adler=0,_.status=M)):_.status=M),_.pending!==0){if(T(o),o.avail_out===0)return _.last_flush=-1,u}else if(o.avail_in===0&&$(P)<=$(R)&&P!==h)return fe(o,-5);if(_.status===666&&o.avail_in!==0)return fe(o,-5);if(o.avail_in!==0||_.lookahead!==0||P!==v&&_.status!==666){var q=_.strategy===2?function(B,G){for(var ne;;){if(B.lookahead===0&&(Te(B),B.lookahead===0)){if(G===v)return d;break}if(B.match_length=0,ne=n._tr_tally(B,0,B.window[B.strstart]),B.lookahead--,B.strstart++,ne&&(N(B,!1),B.strm.avail_out===0))return d}return B.insert=0,G===h?(N(B,!0),B.strm.avail_out===0?ue:j):B.last_lit&&(N(B,!1),B.strm.avail_out===0)?d:F}(_,P):_.strategy===3?function(B,G){for(var ne,K,ce,ke,ye=B.window;;){if(B.lookahead<=Z){if(Te(B),B.lookahead<=Z&&G===v)return d;if(B.lookahead===0)break}if(B.match_length=0,B.lookahead>=A&&0<B.strstart&&(K=ye[ce=B.strstart-1])===ye[++ce]&&K===ye[++ce]&&K===ye[++ce]){ke=B.strstart+Z;do;while(K===ye[++ce]&&K===ye[++ce]&&K===ye[++ce]&&K===ye[++ce]&&K===ye[++ce]&&K===ye[++ce]&&K===ye[++ce]&&K===ye[++ce]&&ce<ke);B.match_length=Z-(ke-ce),B.match_length>B.lookahead&&(B.match_length=B.lookahead)}if(B.match_length>=A?(ne=n._tr_tally(B,1,B.match_length-A),B.lookahead-=B.match_length,B.strstart+=B.match_length,B.match_length=0):(ne=n._tr_tally(B,0,B.window[B.strstart]),B.lookahead--,B.strstart++),ne&&(N(B,!1),B.strm.avail_out===0))return d}return B.insert=0,G===h?(N(B,!0),B.strm.avail_out===0?ue:j):B.last_lit&&(N(B,!1),B.strm.avail_out===0)?d:F}(_,P):t[_.level].func(_,P);if(q!==ue&&q!==j||(_.status=666),q===d||q===ue)return o.avail_out===0&&(_.last_flush=-1),u;if(q===F&&(P===1?n._tr_align(_):P!==5&&(n._tr_stored_block(_,0,0,!1),P===3&&(te(_.head),_.lookahead===0&&(_.strstart=0,_.block_start=0,_.insert=0))),T(o),o.avail_out===0))return _.last_flush=-1,u}return P!==h?u:_.wrap<=0?1:(_.wrap===2?(re(_,255&o.adler),re(_,o.adler>>8&255),re(_,o.adler>>16&255),re(_,o.adler>>24&255),re(_,255&o.total_in),re(_,o.total_in>>8&255),re(_,o.total_in>>16&255),re(_,o.total_in>>24&255)):(ee(_,o.adler>>>16),ee(_,65535&o.adler)),T(o),0<_.wrap&&(_.wrap=-_.wrap),_.pending!==0?u:1)},r.deflateEnd=function(o){var P;return o&&o.state?(P=o.state.status)!==E&&P!==69&&P!==73&&P!==91&&P!==103&&P!==M&&P!==666?fe(o,g):(o.state=null,P===M?fe(o,-3):u):g},r.deflateSetDictionary=function(o,P){var R,_,C,x,W,q,B,G,ne=P.length;if(!o||!o.state||(x=(R=o.state).wrap)===2||x===1&&R.status!==E||R.lookahead)return g;for(x===1&&(o.adler=a(o.adler,P,ne,0)),R.wrap=0,ne>=R.w_size&&(x===0&&(te(R.head),R.strstart=0,R.block_start=0,R.insert=0),G=new s.Buf8(R.w_size),s.arraySet(G,P,ne-R.w_size,R.w_size,0),P=G,ne=R.w_size),W=o.avail_in,q=o.next_in,B=o.input,o.avail_in=ne,o.next_in=0,o.input=P,Te(R);R.lookahead>=A;){for(_=R.strstart,C=R.lookahead-(A-1);R.ins_h=(R.ins_h<<R.hash_shift^R.window[_+A-1])&R.hash_mask,R.prev[_&R.w_mask]=R.head[R.ins_h],R.head[R.ins_h]=_,_++,--C;);R.strstart=_,R.lookahead=A-1,Te(R)}return R.strstart+=R.lookahead,R.block_start=R.strstart,R.insert=R.lookahead,R.lookahead=0,R.match_length=R.prev_length=A-1,R.match_available=0,o.next_in=q,o.input=B,o.avail_in=W,R.wrap=x,u},r.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(e,l,r){l.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(e,l,r){l.exports=function(t,s){var n,a,m,p,v,h,u,g,f,b,y,w,k,I,S,O,z,H,A,Z,ie,E,M,d,F;n=t.state,a=t.next_in,d=t.input,m=a+(t.avail_in-5),p=t.next_out,F=t.output,v=p-(s-t.avail_out),h=p+(t.avail_out-257),u=n.dmax,g=n.wsize,f=n.whave,b=n.wnext,y=n.window,w=n.hold,k=n.bits,I=n.lencode,S=n.distcode,O=(1<<n.lenbits)-1,z=(1<<n.distbits)-1;e:do{k<15&&(w+=d[a++]<<k,k+=8,w+=d[a++]<<k,k+=8),H=I[w&O];t:for(;;){if(w>>>=A=H>>>24,k-=A,(A=H>>>16&255)===0)F[p++]=65535&H;else{if(!(16&A)){if(!(64&A)){H=I[(65535&H)+(w&(1<<A)-1)];continue t}if(32&A){n.mode=12;break e}t.msg="invalid literal/length code",n.mode=30;break e}Z=65535&H,(A&=15)&&(k<A&&(w+=d[a++]<<k,k+=8),Z+=w&(1<<A)-1,w>>>=A,k-=A),k<15&&(w+=d[a++]<<k,k+=8,w+=d[a++]<<k,k+=8),H=S[w&z];n:for(;;){if(w>>>=A=H>>>24,k-=A,!(16&(A=H>>>16&255))){if(!(64&A)){H=S[(65535&H)+(w&(1<<A)-1)];continue n}t.msg="invalid distance code",n.mode=30;break e}if(ie=65535&H,k<(A&=15)&&(w+=d[a++]<<k,(k+=8)<A&&(w+=d[a++]<<k,k+=8)),u<(ie+=w&(1<<A)-1)){t.msg="invalid distance too far back",n.mode=30;break e}if(w>>>=A,k-=A,(A=p-v)<ie){if(f<(A=ie-A)&&n.sane){t.msg="invalid distance too far back",n.mode=30;break e}if(M=y,(E=0)===b){if(E+=g-A,A<Z){for(Z-=A;F[p++]=y[E++],--A;);E=p-ie,M=F}}else if(b<A){if(E+=g+b-A,(A-=b)<Z){for(Z-=A;F[p++]=y[E++],--A;);if(E=0,b<Z){for(Z-=A=b;F[p++]=y[E++],--A;);E=p-ie,M=F}}}else if(E+=b-A,A<Z){for(Z-=A;F[p++]=y[E++],--A;);E=p-ie,M=F}for(;2<Z;)F[p++]=M[E++],F[p++]=M[E++],F[p++]=M[E++],Z-=3;Z&&(F[p++]=M[E++],1<Z&&(F[p++]=M[E++]))}else{for(E=p-ie;F[p++]=F[E++],F[p++]=F[E++],F[p++]=F[E++],2<(Z-=3););Z&&(F[p++]=F[E++],1<Z&&(F[p++]=F[E++]))}break}}break}}while(a<m&&p<h);a-=Z=k>>3,w&=(1<<(k-=Z<<3))-1,t.next_in=a,t.next_out=p,t.avail_in=a<m?m-a+5:5-(a-m),t.avail_out=p<h?h-p+257:257-(p-h),n.hold=w,n.bits=k}},{}],49:[function(e,l,r){var t=e("../utils/common"),s=e("./adler32"),n=e("./crc32"),a=e("./inffast"),m=e("./inftrees"),p=1,v=2,h=0,u=-2,g=1,f=852,b=592;function y(E){return(E>>>24&255)+(E>>>8&65280)+((65280&E)<<8)+((255&E)<<24)}function w(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new t.Buf16(320),this.work=new t.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function k(E){var M;return E&&E.state?(M=E.state,E.total_in=E.total_out=M.total=0,E.msg="",M.wrap&&(E.adler=1&M.wrap),M.mode=g,M.last=0,M.havedict=0,M.dmax=32768,M.head=null,M.hold=0,M.bits=0,M.lencode=M.lendyn=new t.Buf32(f),M.distcode=M.distdyn=new t.Buf32(b),M.sane=1,M.back=-1,h):u}function I(E){var M;return E&&E.state?((M=E.state).wsize=0,M.whave=0,M.wnext=0,k(E)):u}function S(E,M){var d,F;return E&&E.state?(F=E.state,M<0?(d=0,M=-M):(d=1+(M>>4),M<48&&(M&=15)),M&&(M<8||15<M)?u:(F.window!==null&&F.wbits!==M&&(F.window=null),F.wrap=d,F.wbits=M,I(E))):u}function O(E,M){var d,F;return E?(F=new w,(E.state=F).window=null,(d=S(E,M))!==h&&(E.state=null),d):u}var z,H,A=!0;function Z(E){if(A){var M;for(z=new t.Buf32(512),H=new t.Buf32(32),M=0;M<144;)E.lens[M++]=8;for(;M<256;)E.lens[M++]=9;for(;M<280;)E.lens[M++]=7;for(;M<288;)E.lens[M++]=8;for(m(p,E.lens,0,288,z,0,E.work,{bits:9}),M=0;M<32;)E.lens[M++]=5;m(v,E.lens,0,32,H,0,E.work,{bits:5}),A=!1}E.lencode=z,E.lenbits=9,E.distcode=H,E.distbits=5}function ie(E,M,d,F){var ue,j=E.state;return j.window===null&&(j.wsize=1<<j.wbits,j.wnext=0,j.whave=0,j.window=new t.Buf8(j.wsize)),F>=j.wsize?(t.arraySet(j.window,M,d-j.wsize,j.wsize,0),j.wnext=0,j.whave=j.wsize):(F<(ue=j.wsize-j.wnext)&&(ue=F),t.arraySet(j.window,M,d-F,ue,j.wnext),(F-=ue)?(t.arraySet(j.window,M,d-F,F,0),j.wnext=F,j.whave=j.wsize):(j.wnext+=ue,j.wnext===j.wsize&&(j.wnext=0),j.whave<j.wsize&&(j.whave+=ue))),0}r.inflateReset=I,r.inflateReset2=S,r.inflateResetKeep=k,r.inflateInit=function(E){return O(E,15)},r.inflateInit2=O,r.inflate=function(E,M){var d,F,ue,j,fe,$,te,T,N,re,ee,Y,Te,De,ge,ve,Ae,Ne,Ve,Ke,o,P,R,_,C=0,x=new t.Buf8(4),W=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!E||!E.state||!E.output||!E.input&&E.avail_in!==0)return u;(d=E.state).mode===12&&(d.mode=13),fe=E.next_out,ue=E.output,te=E.avail_out,j=E.next_in,F=E.input,$=E.avail_in,T=d.hold,N=d.bits,re=$,ee=te,P=h;e:for(;;)switch(d.mode){case g:if(d.wrap===0){d.mode=13;break}for(;N<16;){if($===0)break e;$--,T+=F[j++]<<N,N+=8}if(2&d.wrap&&T===35615){x[d.check=0]=255&T,x[1]=T>>>8&255,d.check=n(d.check,x,2,0),N=T=0,d.mode=2;break}if(d.flags=0,d.head&&(d.head.done=!1),!(1&d.wrap)||(((255&T)<<8)+(T>>8))%31){E.msg="incorrect header check",d.mode=30;break}if((15&T)!=8){E.msg="unknown compression method",d.mode=30;break}if(N-=4,o=8+(15&(T>>>=4)),d.wbits===0)d.wbits=o;else if(o>d.wbits){E.msg="invalid window size",d.mode=30;break}d.dmax=1<<o,E.adler=d.check=1,d.mode=512&T?10:12,N=T=0;break;case 2:for(;N<16;){if($===0)break e;$--,T+=F[j++]<<N,N+=8}if(d.flags=T,(255&d.flags)!=8){E.msg="unknown compression method",d.mode=30;break}if(57344&d.flags){E.msg="unknown header flags set",d.mode=30;break}d.head&&(d.head.text=T>>8&1),512&d.flags&&(x[0]=255&T,x[1]=T>>>8&255,d.check=n(d.check,x,2,0)),N=T=0,d.mode=3;case 3:for(;N<32;){if($===0)break e;$--,T+=F[j++]<<N,N+=8}d.head&&(d.head.time=T),512&d.flags&&(x[0]=255&T,x[1]=T>>>8&255,x[2]=T>>>16&255,x[3]=T>>>24&255,d.check=n(d.check,x,4,0)),N=T=0,d.mode=4;case 4:for(;N<16;){if($===0)break e;$--,T+=F[j++]<<N,N+=8}d.head&&(d.head.xflags=255&T,d.head.os=T>>8),512&d.flags&&(x[0]=255&T,x[1]=T>>>8&255,d.check=n(d.check,x,2,0)),N=T=0,d.mode=5;case 5:if(1024&d.flags){for(;N<16;){if($===0)break e;$--,T+=F[j++]<<N,N+=8}d.length=T,d.head&&(d.head.extra_len=T),512&d.flags&&(x[0]=255&T,x[1]=T>>>8&255,d.check=n(d.check,x,2,0)),N=T=0}else d.head&&(d.head.extra=null);d.mode=6;case 6:if(1024&d.flags&&($<(Y=d.length)&&(Y=$),Y&&(d.head&&(o=d.head.extra_len-d.length,d.head.extra||(d.head.extra=new Array(d.head.extra_len)),t.arraySet(d.head.extra,F,j,Y,o)),512&d.flags&&(d.check=n(d.check,F,Y,j)),$-=Y,j+=Y,d.length-=Y),d.length))break e;d.length=0,d.mode=7;case 7:if(2048&d.flags){if($===0)break e;for(Y=0;o=F[j+Y++],d.head&&o&&d.length<65536&&(d.head.name+=String.fromCharCode(o)),o&&Y<$;);if(512&d.flags&&(d.check=n(d.check,F,Y,j)),$-=Y,j+=Y,o)break e}else d.head&&(d.head.name=null);d.length=0,d.mode=8;case 8:if(4096&d.flags){if($===0)break e;for(Y=0;o=F[j+Y++],d.head&&o&&d.length<65536&&(d.head.comment+=String.fromCharCode(o)),o&&Y<$;);if(512&d.flags&&(d.check=n(d.check,F,Y,j)),$-=Y,j+=Y,o)break e}else d.head&&(d.head.comment=null);d.mode=9;case 9:if(512&d.flags){for(;N<16;){if($===0)break e;$--,T+=F[j++]<<N,N+=8}if(T!==(65535&d.check)){E.msg="header crc mismatch",d.mode=30;break}N=T=0}d.head&&(d.head.hcrc=d.flags>>9&1,d.head.done=!0),E.adler=d.check=0,d.mode=12;break;case 10:for(;N<32;){if($===0)break e;$--,T+=F[j++]<<N,N+=8}E.adler=d.check=y(T),N=T=0,d.mode=11;case 11:if(d.havedict===0)return E.next_out=fe,E.avail_out=te,E.next_in=j,E.avail_in=$,d.hold=T,d.bits=N,2;E.adler=d.check=1,d.mode=12;case 12:if(M===5||M===6)break e;case 13:if(d.last){T>>>=7&N,N-=7&N,d.mode=27;break}for(;N<3;){if($===0)break e;$--,T+=F[j++]<<N,N+=8}switch(d.last=1&T,N-=1,3&(T>>>=1)){case 0:d.mode=14;break;case 1:if(Z(d),d.mode=20,M!==6)break;T>>>=2,N-=2;break e;case 2:d.mode=17;break;case 3:E.msg="invalid block type",d.mode=30}T>>>=2,N-=2;break;case 14:for(T>>>=7&N,N-=7&N;N<32;){if($===0)break e;$--,T+=F[j++]<<N,N+=8}if((65535&T)!=(T>>>16^65535)){E.msg="invalid stored block lengths",d.mode=30;break}if(d.length=65535&T,N=T=0,d.mode=15,M===6)break e;case 15:d.mode=16;case 16:if(Y=d.length){if($<Y&&(Y=$),te<Y&&(Y=te),Y===0)break e;t.arraySet(ue,F,j,Y,fe),$-=Y,j+=Y,te-=Y,fe+=Y,d.length-=Y;break}d.mode=12;break;case 17:for(;N<14;){if($===0)break e;$--,T+=F[j++]<<N,N+=8}if(d.nlen=257+(31&T),T>>>=5,N-=5,d.ndist=1+(31&T),T>>>=5,N-=5,d.ncode=4+(15&T),T>>>=4,N-=4,286<d.nlen||30<d.ndist){E.msg="too many length or distance symbols",d.mode=30;break}d.have=0,d.mode=18;case 18:for(;d.have<d.ncode;){for(;N<3;){if($===0)break e;$--,T+=F[j++]<<N,N+=8}d.lens[W[d.have++]]=7&T,T>>>=3,N-=3}for(;d.have<19;)d.lens[W[d.have++]]=0;if(d.lencode=d.lendyn,d.lenbits=7,R={bits:d.lenbits},P=m(0,d.lens,0,19,d.lencode,0,d.work,R),d.lenbits=R.bits,P){E.msg="invalid code lengths set",d.mode=30;break}d.have=0,d.mode=19;case 19:for(;d.have<d.nlen+d.ndist;){for(;ve=(C=d.lencode[T&(1<<d.lenbits)-1])>>>16&255,Ae=65535&C,!((ge=C>>>24)<=N);){if($===0)break e;$--,T+=F[j++]<<N,N+=8}if(Ae<16)T>>>=ge,N-=ge,d.lens[d.have++]=Ae;else{if(Ae===16){for(_=ge+2;N<_;){if($===0)break e;$--,T+=F[j++]<<N,N+=8}if(T>>>=ge,N-=ge,d.have===0){E.msg="invalid bit length repeat",d.mode=30;break}o=d.lens[d.have-1],Y=3+(3&T),T>>>=2,N-=2}else if(Ae===17){for(_=ge+3;N<_;){if($===0)break e;$--,T+=F[j++]<<N,N+=8}N-=ge,o=0,Y=3+(7&(T>>>=ge)),T>>>=3,N-=3}else{for(_=ge+7;N<_;){if($===0)break e;$--,T+=F[j++]<<N,N+=8}N-=ge,o=0,Y=11+(127&(T>>>=ge)),T>>>=7,N-=7}if(d.have+Y>d.nlen+d.ndist){E.msg="invalid bit length repeat",d.mode=30;break}for(;Y--;)d.lens[d.have++]=o}}if(d.mode===30)break;if(d.lens[256]===0){E.msg="invalid code -- missing end-of-block",d.mode=30;break}if(d.lenbits=9,R={bits:d.lenbits},P=m(p,d.lens,0,d.nlen,d.lencode,0,d.work,R),d.lenbits=R.bits,P){E.msg="invalid literal/lengths set",d.mode=30;break}if(d.distbits=6,d.distcode=d.distdyn,R={bits:d.distbits},P=m(v,d.lens,d.nlen,d.ndist,d.distcode,0,d.work,R),d.distbits=R.bits,P){E.msg="invalid distances set",d.mode=30;break}if(d.mode=20,M===6)break e;case 20:d.mode=21;case 21:if(6<=$&&258<=te){E.next_out=fe,E.avail_out=te,E.next_in=j,E.avail_in=$,d.hold=T,d.bits=N,a(E,ee),fe=E.next_out,ue=E.output,te=E.avail_out,j=E.next_in,F=E.input,$=E.avail_in,T=d.hold,N=d.bits,d.mode===12&&(d.back=-1);break}for(d.back=0;ve=(C=d.lencode[T&(1<<d.lenbits)-1])>>>16&255,Ae=65535&C,!((ge=C>>>24)<=N);){if($===0)break e;$--,T+=F[j++]<<N,N+=8}if(ve&&!(240&ve)){for(Ne=ge,Ve=ve,Ke=Ae;ve=(C=d.lencode[Ke+((T&(1<<Ne+Ve)-1)>>Ne)])>>>16&255,Ae=65535&C,!(Ne+(ge=C>>>24)<=N);){if($===0)break e;$--,T+=F[j++]<<N,N+=8}T>>>=Ne,N-=Ne,d.back+=Ne}if(T>>>=ge,N-=ge,d.back+=ge,d.length=Ae,ve===0){d.mode=26;break}if(32&ve){d.back=-1,d.mode=12;break}if(64&ve){E.msg="invalid literal/length code",d.mode=30;break}d.extra=15&ve,d.mode=22;case 22:if(d.extra){for(_=d.extra;N<_;){if($===0)break e;$--,T+=F[j++]<<N,N+=8}d.length+=T&(1<<d.extra)-1,T>>>=d.extra,N-=d.extra,d.back+=d.extra}d.was=d.length,d.mode=23;case 23:for(;ve=(C=d.distcode[T&(1<<d.distbits)-1])>>>16&255,Ae=65535&C,!((ge=C>>>24)<=N);){if($===0)break e;$--,T+=F[j++]<<N,N+=8}if(!(240&ve)){for(Ne=ge,Ve=ve,Ke=Ae;ve=(C=d.distcode[Ke+((T&(1<<Ne+Ve)-1)>>Ne)])>>>16&255,Ae=65535&C,!(Ne+(ge=C>>>24)<=N);){if($===0)break e;$--,T+=F[j++]<<N,N+=8}T>>>=Ne,N-=Ne,d.back+=Ne}if(T>>>=ge,N-=ge,d.back+=ge,64&ve){E.msg="invalid distance code",d.mode=30;break}d.offset=Ae,d.extra=15&ve,d.mode=24;case 24:if(d.extra){for(_=d.extra;N<_;){if($===0)break e;$--,T+=F[j++]<<N,N+=8}d.offset+=T&(1<<d.extra)-1,T>>>=d.extra,N-=d.extra,d.back+=d.extra}if(d.offset>d.dmax){E.msg="invalid distance too far back",d.mode=30;break}d.mode=25;case 25:if(te===0)break e;if(Y=ee-te,d.offset>Y){if((Y=d.offset-Y)>d.whave&&d.sane){E.msg="invalid distance too far back",d.mode=30;break}Te=Y>d.wnext?(Y-=d.wnext,d.wsize-Y):d.wnext-Y,Y>d.length&&(Y=d.length),De=d.window}else De=ue,Te=fe-d.offset,Y=d.length;for(te<Y&&(Y=te),te-=Y,d.length-=Y;ue[fe++]=De[Te++],--Y;);d.length===0&&(d.mode=21);break;case 26:if(te===0)break e;ue[fe++]=d.length,te--,d.mode=21;break;case 27:if(d.wrap){for(;N<32;){if($===0)break e;$--,T|=F[j++]<<N,N+=8}if(ee-=te,E.total_out+=ee,d.total+=ee,ee&&(E.adler=d.check=d.flags?n(d.check,ue,ee,fe-ee):s(d.check,ue,ee,fe-ee)),ee=te,(d.flags?T:y(T))!==d.check){E.msg="incorrect data check",d.mode=30;break}N=T=0}d.mode=28;case 28:if(d.wrap&&d.flags){for(;N<32;){if($===0)break e;$--,T+=F[j++]<<N,N+=8}if(T!==(4294967295&d.total)){E.msg="incorrect length check",d.mode=30;break}N=T=0}d.mode=29;case 29:P=1;break e;case 30:P=-3;break e;case 31:return-4;case 32:default:return u}return E.next_out=fe,E.avail_out=te,E.next_in=j,E.avail_in=$,d.hold=T,d.bits=N,(d.wsize||ee!==E.avail_out&&d.mode<30&&(d.mode<27||M!==4))&&ie(E,E.output,E.next_out,ee-E.avail_out)?(d.mode=31,-4):(re-=E.avail_in,ee-=E.avail_out,E.total_in+=re,E.total_out+=ee,d.total+=ee,d.wrap&&ee&&(E.adler=d.check=d.flags?n(d.check,ue,ee,E.next_out-ee):s(d.check,ue,ee,E.next_out-ee)),E.data_type=d.bits+(d.last?64:0)+(d.mode===12?128:0)+(d.mode===20||d.mode===15?256:0),(re==0&&ee===0||M===4)&&P===h&&(P=-5),P)},r.inflateEnd=function(E){if(!E||!E.state)return u;var M=E.state;return M.window&&(M.window=null),E.state=null,h},r.inflateGetHeader=function(E,M){var d;return E&&E.state&&2&(d=E.state).wrap?((d.head=M).done=!1,h):u},r.inflateSetDictionary=function(E,M){var d,F=M.length;return E&&E.state?(d=E.state).wrap!==0&&d.mode!==11?u:d.mode===11&&s(1,M,F,0)!==d.check?-3:ie(E,M,F,F)?(d.mode=31,-4):(d.havedict=1,h):u},r.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(e,l,r){var t=e("../utils/common"),s=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],n=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],a=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],m=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];l.exports=function(p,v,h,u,g,f,b,y){var w,k,I,S,O,z,H,A,Z,ie=y.bits,E=0,M=0,d=0,F=0,ue=0,j=0,fe=0,$=0,te=0,T=0,N=null,re=0,ee=new t.Buf16(16),Y=new t.Buf16(16),Te=null,De=0;for(E=0;E<=15;E++)ee[E]=0;for(M=0;M<u;M++)ee[v[h+M]]++;for(ue=ie,F=15;1<=F&&ee[F]===0;F--);if(F<ue&&(ue=F),F===0)return g[f++]=20971520,g[f++]=20971520,y.bits=1,0;for(d=1;d<F&&ee[d]===0;d++);for(ue<d&&(ue=d),E=$=1;E<=15;E++)if($<<=1,($-=ee[E])<0)return-1;if(0<$&&(p===0||F!==1))return-1;for(Y[1]=0,E=1;E<15;E++)Y[E+1]=Y[E]+ee[E];for(M=0;M<u;M++)v[h+M]!==0&&(b[Y[v[h+M]]++]=M);if(z=p===0?(N=Te=b,19):p===1?(N=s,re-=257,Te=n,De-=257,256):(N=a,Te=m,-1),E=d,O=f,fe=M=T=0,I=-1,S=(te=1<<(j=ue))-1,p===1&&852<te||p===2&&592<te)return 1;for(;;){for(H=E-fe,Z=b[M]<z?(A=0,b[M]):b[M]>z?(A=Te[De+b[M]],N[re+b[M]]):(A=96,0),w=1<<E-fe,d=k=1<<j;g[O+(T>>fe)+(k-=w)]=H<<24|A<<16|Z|0,k!==0;);for(w=1<<E-1;T&w;)w>>=1;if(w!==0?(T&=w-1,T+=w):T=0,M++,--ee[E]==0){if(E===F)break;E=v[h+b[M]]}if(ue<E&&(T&S)!==I){for(fe===0&&(fe=ue),O+=d,$=1<<(j=E-fe);j+fe<F&&!(($-=ee[j+fe])<=0);)j++,$<<=1;if(te+=1<<j,p===1&&852<te||p===2&&592<te)return 1;g[I=T&S]=ue<<24|j<<16|O-f|0}}return T!==0&&(g[O+T]=E-fe<<24|64<<16|0),y.bits=ue,0}},{"../utils/common":41}],51:[function(e,l,r){l.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(e,l,r){var t=e("../utils/common"),s=0,n=1;function a(C){for(var x=C.length;0<=--x;)C[x]=0}var m=0,p=29,v=256,h=v+1+p,u=30,g=19,f=2*h+1,b=15,y=16,w=7,k=256,I=16,S=17,O=18,z=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],H=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],A=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],Z=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],ie=new Array(2*(h+2));a(ie);var E=new Array(2*u);a(E);var M=new Array(512);a(M);var d=new Array(256);a(d);var F=new Array(p);a(F);var ue,j,fe,$=new Array(u);function te(C,x,W,q,B){this.static_tree=C,this.extra_bits=x,this.extra_base=W,this.elems=q,this.max_length=B,this.has_stree=C&&C.length}function T(C,x){this.dyn_tree=C,this.max_code=0,this.stat_desc=x}function N(C){return C<256?M[C]:M[256+(C>>>7)]}function re(C,x){C.pending_buf[C.pending++]=255&x,C.pending_buf[C.pending++]=x>>>8&255}function ee(C,x,W){C.bi_valid>y-W?(C.bi_buf|=x<<C.bi_valid&65535,re(C,C.bi_buf),C.bi_buf=x>>y-C.bi_valid,C.bi_valid+=W-y):(C.bi_buf|=x<<C.bi_valid&65535,C.bi_valid+=W)}function Y(C,x,W){ee(C,W[2*x],W[2*x+1])}function Te(C,x){for(var W=0;W|=1&C,C>>>=1,W<<=1,0<--x;);return W>>>1}function De(C,x,W){var q,B,G=new Array(b+1),ne=0;for(q=1;q<=b;q++)G[q]=ne=ne+W[q-1]<<1;for(B=0;B<=x;B++){var K=C[2*B+1];K!==0&&(C[2*B]=Te(G[K]++,K))}}function ge(C){var x;for(x=0;x<h;x++)C.dyn_ltree[2*x]=0;for(x=0;x<u;x++)C.dyn_dtree[2*x]=0;for(x=0;x<g;x++)C.bl_tree[2*x]=0;C.dyn_ltree[2*k]=1,C.opt_len=C.static_len=0,C.last_lit=C.matches=0}function ve(C){8<C.bi_valid?re(C,C.bi_buf):0<C.bi_valid&&(C.pending_buf[C.pending++]=C.bi_buf),C.bi_buf=0,C.bi_valid=0}function Ae(C,x,W,q){var B=2*x,G=2*W;return C[B]<C[G]||C[B]===C[G]&&q[x]<=q[W]}function Ne(C,x,W){for(var q=C.heap[W],B=W<<1;B<=C.heap_len&&(B<C.heap_len&&Ae(x,C.heap[B+1],C.heap[B],C.depth)&&B++,!Ae(x,q,C.heap[B],C.depth));)C.heap[W]=C.heap[B],W=B,B<<=1;C.heap[W]=q}function Ve(C,x,W){var q,B,G,ne,K=0;if(C.last_lit!==0)for(;q=C.pending_buf[C.d_buf+2*K]<<8|C.pending_buf[C.d_buf+2*K+1],B=C.pending_buf[C.l_buf+K],K++,q===0?Y(C,B,x):(Y(C,(G=d[B])+v+1,x),(ne=z[G])!==0&&ee(C,B-=F[G],ne),Y(C,G=N(--q),W),(ne=H[G])!==0&&ee(C,q-=$[G],ne)),K<C.last_lit;);Y(C,k,x)}function Ke(C,x){var W,q,B,G=x.dyn_tree,ne=x.stat_desc.static_tree,K=x.stat_desc.has_stree,ce=x.stat_desc.elems,ke=-1;for(C.heap_len=0,C.heap_max=f,W=0;W<ce;W++)G[2*W]!==0?(C.heap[++C.heap_len]=ke=W,C.depth[W]=0):G[2*W+1]=0;for(;C.heap_len<2;)G[2*(B=C.heap[++C.heap_len]=ke<2?++ke:0)]=1,C.depth[B]=0,C.opt_len--,K&&(C.static_len-=ne[2*B+1]);for(x.max_code=ke,W=C.heap_len>>1;1<=W;W--)Ne(C,G,W);for(B=ce;W=C.heap[1],C.heap[1]=C.heap[C.heap_len--],Ne(C,G,1),q=C.heap[1],C.heap[--C.heap_max]=W,C.heap[--C.heap_max]=q,G[2*B]=G[2*W]+G[2*q],C.depth[B]=(C.depth[W]>=C.depth[q]?C.depth[W]:C.depth[q])+1,G[2*W+1]=G[2*q+1]=B,C.heap[1]=B++,Ne(C,G,1),2<=C.heap_len;);C.heap[--C.heap_max]=C.heap[1],function(ye,Ue){var pt,Je,gt,Se,yt,bt,Qe=Ue.dyn_tree,$t=Ue.max_code,zn=Ue.stat_desc.static_tree,an=Ue.stat_desc.has_stree,It=Ue.stat_desc.extra_bits,vt=Ue.stat_desc.extra_base,ut=Ue.stat_desc.max_length,xt=0;for(Se=0;Se<=b;Se++)ye.bl_count[Se]=0;for(Qe[2*ye.heap[ye.heap_max]+1]=0,pt=ye.heap_max+1;pt<f;pt++)ut<(Se=Qe[2*Qe[2*(Je=ye.heap[pt])+1]+1]+1)&&(Se=ut,xt++),Qe[2*Je+1]=Se,$t<Je||(ye.bl_count[Se]++,yt=0,vt<=Je&&(yt=It[Je-vt]),bt=Qe[2*Je],ye.opt_len+=bt*(Se+yt),an&&(ye.static_len+=bt*(zn[2*Je+1]+yt)));if(xt!==0){do{for(Se=ut-1;ye.bl_count[Se]===0;)Se--;ye.bl_count[Se]--,ye.bl_count[Se+1]+=2,ye.bl_count[ut]--,xt-=2}while(0<xt);for(Se=ut;Se!==0;Se--)for(Je=ye.bl_count[Se];Je!==0;)$t<(gt=ye.heap[--pt])||(Qe[2*gt+1]!==Se&&(ye.opt_len+=(Se-Qe[2*gt+1])*Qe[2*gt],Qe[2*gt+1]=Se),Je--)}}(C,x),De(G,ke,C.bl_count)}function o(C,x,W){var q,B,G=-1,ne=x[1],K=0,ce=7,ke=4;for(ne===0&&(ce=138,ke=3),x[2*(W+1)+1]=65535,q=0;q<=W;q++)B=ne,ne=x[2*(q+1)+1],++K<ce&&B===ne||(K<ke?C.bl_tree[2*B]+=K:B!==0?(B!==G&&C.bl_tree[2*B]++,C.bl_tree[2*I]++):K<=10?C.bl_tree[2*S]++:C.bl_tree[2*O]++,G=B,ke=(K=0)===ne?(ce=138,3):B===ne?(ce=6,3):(ce=7,4))}function P(C,x,W){var q,B,G=-1,ne=x[1],K=0,ce=7,ke=4;for(ne===0&&(ce=138,ke=3),q=0;q<=W;q++)if(B=ne,ne=x[2*(q+1)+1],!(++K<ce&&B===ne)){if(K<ke)for(;Y(C,B,C.bl_tree),--K!=0;);else B!==0?(B!==G&&(Y(C,B,C.bl_tree),K--),Y(C,I,C.bl_tree),ee(C,K-3,2)):K<=10?(Y(C,S,C.bl_tree),ee(C,K-3,3)):(Y(C,O,C.bl_tree),ee(C,K-11,7));G=B,ke=(K=0)===ne?(ce=138,3):B===ne?(ce=6,3):(ce=7,4)}}a($);var R=!1;function _(C,x,W,q){ee(C,(m<<1)+(q?1:0),3),function(B,G,ne,K){ve(B),re(B,ne),re(B,~ne),t.arraySet(B.pending_buf,B.window,G,ne,B.pending),B.pending+=ne}(C,x,W)}r._tr_init=function(C){R||(function(){var x,W,q,B,G,ne=new Array(b+1);for(B=q=0;B<p-1;B++)for(F[B]=q,x=0;x<1<<z[B];x++)d[q++]=B;for(d[q-1]=B,B=G=0;B<16;B++)for($[B]=G,x=0;x<1<<H[B];x++)M[G++]=B;for(G>>=7;B<u;B++)for($[B]=G<<7,x=0;x<1<<H[B]-7;x++)M[256+G++]=B;for(W=0;W<=b;W++)ne[W]=0;for(x=0;x<=143;)ie[2*x+1]=8,x++,ne[8]++;for(;x<=255;)ie[2*x+1]=9,x++,ne[9]++;for(;x<=279;)ie[2*x+1]=7,x++,ne[7]++;for(;x<=287;)ie[2*x+1]=8,x++,ne[8]++;for(De(ie,h+1,ne),x=0;x<u;x++)E[2*x+1]=5,E[2*x]=Te(x,5);ue=new te(ie,z,v+1,h,b),j=new te(E,H,0,u,b),fe=new te(new Array(0),A,0,g,w)}(),R=!0),C.l_desc=new T(C.dyn_ltree,ue),C.d_desc=new T(C.dyn_dtree,j),C.bl_desc=new T(C.bl_tree,fe),C.bi_buf=0,C.bi_valid=0,ge(C)},r._tr_stored_block=_,r._tr_flush_block=function(C,x,W,q){var B,G,ne=0;0<C.level?(C.strm.data_type===2&&(C.strm.data_type=function(K){var ce,ke=4093624447;for(ce=0;ce<=31;ce++,ke>>>=1)if(1&ke&&K.dyn_ltree[2*ce]!==0)return s;if(K.dyn_ltree[18]!==0||K.dyn_ltree[20]!==0||K.dyn_ltree[26]!==0)return n;for(ce=32;ce<v;ce++)if(K.dyn_ltree[2*ce]!==0)return n;return s}(C)),Ke(C,C.l_desc),Ke(C,C.d_desc),ne=function(K){var ce;for(o(K,K.dyn_ltree,K.l_desc.max_code),o(K,K.dyn_dtree,K.d_desc.max_code),Ke(K,K.bl_desc),ce=g-1;3<=ce&&K.bl_tree[2*Z[ce]+1]===0;ce--);return K.opt_len+=3*(ce+1)+5+5+4,ce}(C),B=C.opt_len+3+7>>>3,(G=C.static_len+3+7>>>3)<=B&&(B=G)):B=G=W+5,W+4<=B&&x!==-1?_(C,x,W,q):C.strategy===4||G===B?(ee(C,2+(q?1:0),3),Ve(C,ie,E)):(ee(C,4+(q?1:0),3),function(K,ce,ke,ye){var Ue;for(ee(K,ce-257,5),ee(K,ke-1,5),ee(K,ye-4,4),Ue=0;Ue<ye;Ue++)ee(K,K.bl_tree[2*Z[Ue]+1],3);P(K,K.dyn_ltree,ce-1),P(K,K.dyn_dtree,ke-1)}(C,C.l_desc.max_code+1,C.d_desc.max_code+1,ne+1),Ve(C,C.dyn_ltree,C.dyn_dtree)),ge(C),q&&ve(C)},r._tr_tally=function(C,x,W){return C.pending_buf[C.d_buf+2*C.last_lit]=x>>>8&255,C.pending_buf[C.d_buf+2*C.last_lit+1]=255&x,C.pending_buf[C.l_buf+C.last_lit]=255&W,C.last_lit++,x===0?C.dyn_ltree[2*W]++:(C.matches++,x--,C.dyn_ltree[2*(d[W]+v+1)]++,C.dyn_dtree[2*N(x)]++),C.last_lit===C.lit_bufsize-1},r._tr_align=function(C){ee(C,2,3),Y(C,k,ie),function(x){x.bi_valid===16?(re(x,x.bi_buf),x.bi_buf=0,x.bi_valid=0):8<=x.bi_valid&&(x.pending_buf[x.pending++]=255&x.bi_buf,x.bi_buf>>=8,x.bi_valid-=8)}(C)}},{"../utils/common":41}],53:[function(e,l,r){l.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(e,l,r){(function(t){(function(s,n){if(!s.setImmediate){var a,m,p,v,h=1,u={},g=!1,f=s.document,b=Object.getPrototypeOf&&Object.getPrototypeOf(s);b=b&&b.setTimeout?b:s,a={}.toString.call(s.process)==="[object process]"?function(I){process.nextTick(function(){w(I)})}:function(){if(s.postMessage&&!s.importScripts){var I=!0,S=s.onmessage;return s.onmessage=function(){I=!1},s.postMessage("","*"),s.onmessage=S,I}}()?(v="setImmediate$"+Math.random()+"$",s.addEventListener?s.addEventListener("message",k,!1):s.attachEvent("onmessage",k),function(I){s.postMessage(v+I,"*")}):s.MessageChannel?((p=new MessageChannel).port1.onmessage=function(I){w(I.data)},function(I){p.port2.postMessage(I)}):f&&"onreadystatechange"in f.createElement("script")?(m=f.documentElement,function(I){var S=f.createElement("script");S.onreadystatechange=function(){w(I),S.onreadystatechange=null,m.removeChild(S),S=null},m.appendChild(S)}):function(I){setTimeout(w,0,I)},b.setImmediate=function(I){typeof I!="function"&&(I=new Function(""+I));for(var S=new Array(arguments.length-1),O=0;O<S.length;O++)S[O]=arguments[O+1];var z={callback:I,args:S};return u[h]=z,a(h),h++},b.clearImmediate=y}function y(I){delete u[I]}function w(I){if(g)setTimeout(w,0,I);else{var S=u[I];if(S){g=!0;try{(function(O){var z=O.callback,H=O.args;switch(H.length){case 0:z();break;case 1:z(H[0]);break;case 2:z(H[0],H[1]);break;case 3:z(H[0],H[1],H[2]);break;default:z.apply(n,H)}})(S)}finally{y(I),g=!1}}}}function k(I){I.source===s&&typeof I.data=="string"&&I.data.indexOf(v)===0&&w(+I.data.slice(v.length))}})(typeof self>"u"?t===void 0?this:t:self)}).call(this,typeof rn<"u"?rn:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(Ns);var Ni=Ns.exports;const Ds=Ti(Ni);let oe={},D=null,os=null,J=null,_e=null,Yt=null,An=null,cs=[],bn=null,ls=null,qe=null,vn=0,ds=0,Cn=0,us=0,fs=null,ms=null,wn=null,mt=null,et=-1,hs=null,_n=null,En=null,As=null,Os=null,rt=!1,he=[],at=[],kt=[],Ze={isScreenSaverEnabled:!0,lastRestoreTimestamp:null,lastBackupTimestamp:null};function de(){if(rt)return;const i={classrooms:oe,trashBin:he,userSettings:Ze};localStorage.setItem("teacherAssistantData_v2",JSON.stringify(i))}function Di(i){return new Promise((c,e)=>{const l=new FileReader;l.onerror=e,l.onload=()=>{c(l.result.split(",")[1])},l.readAsDataURL(i)})}async function Rs(i=[]){const c={};if(i.length>0)i.forEach(a=>{oe[a]&&(c[a]=oe[a])});else for(const a in oe)oe[a].isDeleted||(c[a]=oe[a]);const e={metadata:{version:"2.0-b64",createdAt:new Date().toISOString()},data:{classrooms:c,trashBin:he}},l=JSON.stringify(e),r=new Date,t=new Intl.DateTimeFormat("fa-IR-u-nu-latn",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(r).reduce((a,m)=>(a[m.type]=m.value,a),{}),n=`SP_${t.year.slice(-2)}-${t.month}-${t.day}_${t.hour}-${t.minute}.txt`;try{const a=new Ds;a.file("backup.json",l);const m=await a.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:9}}),p=await Di(m);return new File([p],n,{type:"text/plain"})}catch(a){return console.error("Error creating base64 backup file:",a),null}}function kn(){const i=localStorage.getItem("teacherAssistantData_v2");if(!i)return;const c=JSON.parse(i);c.classrooms!==void 0&&c.trashBin!==void 0?(St(c.classrooms),he=c.trashBin||[],Ze={...Ze,...c.userSettings}):(St(c),Ai())}function Ai(){const i=[];Object.values(oe).forEach(c=>{c.isDeleted?i.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:c.info.creationDate,type:"classroom",description:`کلاس «${c.info.name}»`,restoreData:{name:c.info.name}}):c.students.forEach(e=>{e.isDeleted&&i.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:e.identity.studentId.split("_")[1],type:"student",description:`دانش‌آموز «${e.identity.name}»`,restoreData:{studentId:e.identity.studentId,classroomName:c.info.name}})})}),he.length===0&&i.length>0&&(he=i,console.log(`Migrated ${i.length} previously deleted item(s) to the new trash bin.`),de())}function zs(i){const c=new cn(i.identity);return c.isDeleted=i.isDeleted,c.statusCounters=i.statusCounters,c.logs=i.logs,c.logs.scores||(c.logs.scores={}),c.profile=i.profile,c.finalClassActivityScore=i.finalClassActivityScore,c.categoryCounts=i.categoryCounts||{},c.categoryIssues=i.categoryIssues||{},c.onboardingSession=i.onboardingSession||null,c}function St(i){oe={};for(const c in i){const e=i[c];let l;e.info?l=e.info:l={...e,name:c};const r=new Hn(l);r.isDeleted=e.isDeleted,r.note=e.note||"",r.students=(e.students||[]).map(zs),r.sessions=(e.sessions||[]).map(t=>{const s=new Ts(t.sessionNumber);s.isDeleted=t.isDeleted,s.note=t.note||"",s.startTime=new Date(t.startTime),s.endTime=t.endTime?new Date(t.endTime):null,s.isFinished=t.isFinished,s.isMakeup=t.isMakeup,s.isCancelled=t.isCancelled||!1,s.studentRecords=t.studentRecords;for(const a in s.studentRecords){const m=s.studentRecords[a];m.homework&&!(m.homework instanceof Wn)&&(s.studentRecords[a].homework=new Wn(m.homework.status,m.homework.comment))}s.lastWinnerByCategory=t.lastWinnerByCategory,s.lastUsedCategoryId=t.lastUsedCategoryId,s.lastSelectedWinnerId=t.lastSelectedWinnerId;const n=t.winnerHistory||[];return s.winnerHistory=n.filter(a=>a&&a.winner).map(a=>({winner:r.students.find(p=>p.identity.studentId===a.winner.identity.studentId),categoryName:a.categoryName})).filter(a=>a.winner),s}),r.categories=(e.categories||[]).map(t=>{const s=new lt(t.name,t.description,t.isGradedCategory);return s.id=t.id,s.isDeleted=t.isDeleted,s}),r.futurePlans=e.futurePlans,oe[c]=r}}function Ms(i,c){if(c){const e=i.data.classrooms;for(let l in e){let r=l;const t=e[l];for(;oe[r];)r=`${r} (Restored)`;r!==l&&(t.info.name=r),oe[r]=t}if(i.data.trashBin){const l=[...he,...i.data.trashBin],r=[...new Map(l.map(t=>[t.id,t])).values()];Bn(r)}St(oe)}else St(i.data.classrooms),Bn(i.data.trashBin||[]);Zt({lastRestoreTimestamp:new Date().toISOString()}),de()}function $s(i,c){if(oe[c])return{success:!1,message:"کلاسی با این نام از قبل وجود دارد."};const e=oe[i];return e?(e.info.name=c,oe[c]=e,delete oe[i],D===e&&Pe(e),{success:!0}):{success:!1,message:"کلاس مورد نظر یافت نشد."}}function Fs(i,c,e){const l=e.trim();if(!l)return{success:!1,message:"نام دسته‌بندی نمی‌تواند خالی باشد."};if(i.categories.some(a=>a.id!==c.id&&!a.isDeleted&&a.name.toLowerCase()===l.toLowerCase()))return{success:!1,message:"دسته‌بندی دیگری با این نام وجود دارد."};const t=c.name,s=t.toLowerCase(),n=l.toLowerCase();return c.name=l,i.students.forEach(a=>{a.categoryCounts&&a.categoryCounts[t]!==void 0&&(a.categoryCounts[l]=a.categoryCounts[t],delete a.categoryCounts[t]),a.categoryIssues&&a.categoryIssues[t]!==void 0&&(a.categoryIssues[l]=a.categoryIssues[t],delete a.categoryIssues[t]),a.logs.scores&&a.logs.scores[s]&&(a.logs.scores[s].forEach(m=>m.skill=l),s!==n&&(a.logs.scores[n]=a.logs.scores[s],delete a.logs.scores[s]))}),i.sessions.forEach(a=>{a.lastWinnerByCategory&&a.lastWinnerByCategory[t]&&(a.lastWinnerByCategory[l]=a.lastWinnerByCategory[t],delete a.lastWinnerByCategory[t]),a.winnerHistory&&a.winnerHistory.forEach(m=>{m.categoryName===t&&(m.categoryName=l)})}),{success:!0}}function Ps(i,c,e){if(Be(e.students).some(m=>m.identity.name.toLowerCase()===i.identity.name.toLowerCase()))return{success:!1,message:`دانش‌آموزی با نام «${i.identity.name}» از قبل در کلاس «${e.info.name}» وجود دارد.`};const r=JSON.parse(JSON.stringify(i)),t=zs(r),s=new Map;c.sessions.forEach(m=>{const p=m.studentRecords[i.identity.studentId];p&&s.set(m.sessionNumber,JSON.parse(JSON.stringify(p)))}),e.addStudent(t);try{const m=Be(e.sessions).filter(b=>!b.isCancelled).sort((b,y)=>y.sessionNumber-b.sessionNumber),p=m.length>0?m[0]:null;let v="؟",h={type:"system",description:"Student Move"};p&&(v=Xe(e).get(p.sessionNumber)||p.sessionNumber,h={type:"fromSession",sessionNumber:p.sessionNumber});const u=new Date().toLocaleDateString("fa-IR"),g=c.info.name,f=`این دانش آموز در جلسه ${v} و در تاریخ ${u} از کلاس «${g}» به این کلاس انتقال پیدا کرد`;t.addNote(f,h)}catch(m){console.error("Failed to add automated move note:",m)}s.size>0&&e.sessions.forEach(m=>{const p=s.get(m.sessionNumber);p&&!m.isDeleted&&!m.isCancelled&&(m.studentRecords[t.identity.studentId]=p)});const n={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`(انتقال) دانش‌آموز «${i.identity.name}» از کلاس «${c.info.name}»`,restoreData:{studentId:i.identity.studentId,classId:c.info.scheduleCode}};he.unshift(n),he.length>50&&he.pop();const a=c.students.find(m=>m.identity.studentId===i.identity.studentId);return a&&(a.isDeleted=!0),{success:!0}}function Ws(){for(const i in oe){const c=oe[i];c.students.forEach(e=>{e.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0},e.categoryCounts={},e.categoryIssues={},c.sessions.forEach(l=>{const r=e.identity.studentId;l.studentRecords[r]&&(l.studentRecords[r].attendance="present")})})}de()}function Be(i){return Array.isArray(i)?i.filter(c=>!c.isDeleted):[]}function Xe(i){const c=new Map;return i&&Be(i.sessions).filter(l=>!l.isCancelled).sort((l,r)=>l.sessionNumber-r.sessionNumber).forEach((l,r)=>{c.set(l.sessionNumber,r+1)}),c}function ht(i){et=i}function st(i){hs=i}function Sn(i,c){if(!i||!c)return;const e=i.identity.studentId,l=c.students.findIndex(r=>r.identity.studentId===e);l>-1&&c.students.splice(l,1),c.sessions.forEach(r=>{r.studentRecords[e]&&delete r.studentRecords[e];for(const t in r.lastWinnerByCategory)r.lastWinnerByCategory[t]===e&&delete r.lastWinnerByCategory[t];r.lastSelectedWinnerId===e&&(r.lastSelectedWinnerId=null),r.winnerHistory=r.winnerHistory.filter(t=>t.winner&&t.winner.identity.studentId!==e)})}function Hs(i,c){const e=oe[i];if(!e)return;const l=e.sessions.findIndex(r=>r.sessionNumber===c);l>-1&&(e.students.forEach(r=>{r.profile.notes&&r.profile.notes.length>0&&(r.profile.notes=r.profile.notes.filter(t=>!t.source||t.source.type!=="fromAttendance"||t.source.sessionNumber!==c)),r.onboardingSession===c&&(r.onboardingSession=null)}),e.sessions.splice(l,1))}function Us(i,c){const e=oe[i];if(!e)return;const l=e.categories.findIndex(n=>n.id===c);if(l===-1)return;const t=e.categories[l].name,s=t.toLowerCase();e.students.forEach(n=>{n.categoryCounts&&delete n.categoryCounts[t],n.categoryIssues&&delete n.categoryIssues[t],n.logs.scores&&delete n.logs.scores[s]}),e.sessions.forEach(n=>{n.lastWinnerByCategory[t]&&delete n.lastWinnerByCategory[t],n.winnerHistory=n.winnerHistory.filter(a=>a.categoryName!==t)}),e.categories.splice(l,1)}function js(i,c,e,l){const r=oe[i];if(!r)return;const t=r.students.find(a=>a.identity.studentId===c);if(!t||!t.logs.scores[e.toLowerCase()])return;const s=t.logs.scores[e.toLowerCase()],n=s.findIndex(a=>a.id===l);n>-1&&s.splice(n,1)}function Zs(i,c,e){const l=oe[i];if(!l)return;const r=l.students.find(s=>s.identity.studentId===c);if(!r||!r.profile.notes)return;const t=r.profile.notes.findIndex(s=>s.id===e);t>-1&&r.profile.notes.splice(t,1)}function qs(){JSON.parse(JSON.stringify({classrooms:oe,trashBin:he})),rt=!0}function Gs(){rt=!1,kn()}function Pe(i){D=i}function Xt(i){os=i}function je(i){J=i}function Ge(i){_e=i}function In(i){Yt=i}function Vs(i){An=i}function Wt(i){cs=i}function ln(i){bn=i}function Ks(i){ls=i}function xn(i){qe=i}function dn(i){vn=i}function Js(i){ds=i}function un(i){Cn=i}function Ys(i){us=i}function ps(i){fs=i}function gs(i){ms=i}function Qt(i){wn=i}function ys(i){mt=i}function Ln(i){En=i}function Xs(i){As=i}function Qs(i){Os=i}function Bn(i){he=i}function On(i){_n=i}function Tn(i){kt=i}function Zt(i){Ze={...Ze,...i},de()}function Un(i){at=i}function bs(){Ze.lastBackupTimestamp=new Date().toISOString(),de()}const Oi=Object.freeze(Object.defineProperty({__proto__:null,get activeModal(){return mt},get cancelCallback(){return ms},get classrooms(){return oe},get confirmCallback(){return fs},get currentClassroom(){return D},get easterEggClickCount(){return vn},get easterEggLastClickTime(){return ds},enterDemoMode:qs,exitDemoMode:Gs,getActiveItems:Be,getSessionDisplayMap:Xe,get importedFileContent(){return bn},get isDemoMode(){return rt},get liveSession(){return os},loadData:kn,get manualSelection(){return En},moveStudent:Ps,get namesToImport(){return cs},get notificationTimeout(){return ls},permanentlyDeleteCategory:Us,permanentlyDeleteNote:Zs,permanentlyDeleteScore:js,permanentlyDeleteSession:Hs,permanentlyDeleteStudent:Sn,prepareBackupData:Rs,get previousState(){return Yt},processRestore:Ms,rehydrateData:St,renameCategory:Fs,renameClassroom:$s,resetAllStudentCounters:Ws,get resetEasterEggClickCount(){return Cn},get resetEasterEggLastClickTime(){return us},get saveCategoryCallback(){return _n},saveData:de,get saveNoteCallback(){return hs},get secureConfirmCallback(){return wn},get selectedCategory(){return qe},get selectedClassIds(){return at},get selectedSession(){return J},get selectedStudentForProfile(){return _e},get selectedStudentsForMassComment(){return kt},setActiveModal:ys,setCancelCallback:gs,setConfirmCallback:ps,setCurrentClassroom:Pe,setEasterEggClickCount:dn,setEasterEggLastClickTime:Js,setImportedFileContent:ln,setLastBackupTimestamp:bs,setLiveSession:Xt,setManualSelection:Ln,setNamesToImport:Wt,setNotificationTimeout:Ks,setPreviousState:In,setResetEasterEggClickCount:un,setResetEasterEggLastClickTime:Ys,setSaveCategoryCallback:On,setSaveNoteCallback:st,setSecureConfirmCallback:Qt,setSelectedCategory:xn,setSelectedClassIds:Un,setSelectedSession:je,setSelectedStudentForProfile:Ge,setSelectedStudentsForMassComment:Tn,setSourceClassForMove:Qs,setStudentToMove:Xs,setTrashBin:Bn,setUndoTimeout:Vs,setUserSettings:Zt,setWinnerHistoryIndex:ht,get sourceClassForMove(){return Os},get studentToMove(){return As},get trashBin(){return he},get undoTimeout(){return An},get userSettings(){return Ze},get winnerHistoryIndex(){return et}},Symbol.toStringTag,{value:"Module"}));function Ye(i){return typeof i!="string"?"":i.replace(/ي/g,"ی").replace(/ك/g,"ک").replace(/[\s\u200c]/g,"")}function vs(i){return typeof i!="string"||i.length===0?"ltr":/[\u0590-\u07FF]/.test(i)?"rtl":"ltr"}function ei(i){return!i||!i.trim()?"":i.split(`
`).map(l=>`<div dir="${vs(l)}">${l||"&nbsp;"}</div>`).join("")}function Pn(i){if(typeof i!="string")return"";const c={q:"ض",w:"ص",e:"ث",r:"ق",t:"ف",y:"غ",u:"ع",i:"ه",o:"خ",p:"ح","[":"ج","]":"چ",a:"ش",s:"س",d:"ی",f:"ب",g:"ل",h:"ا",j:"ت",k:"ن",l:"م",";":"ک","'":"گ",z:"ظ",x:"ط",c:"ز",v:"ر",b:"ذ",n:"د",m:"پ",",":"و"};let e="";for(let l=0;l<i.length;l++){const r=i[l].toLowerCase();e+=c[r]||i[l]}return e}const ti="teacherAssistantLogs_v2",Ri=100;function Cs(){try{const i=localStorage.getItem(ti);return i?JSON.parse(i):{}}catch(i){return console.error("Error reading logs from localStorage:",i),{}}}function ni(i){try{localStorage.setItem(ti,JSON.stringify(i))}catch(c){console.error("Error saving logs to localStorage:",c)}}function we(i,c,e=null){if(!i)return;const l=Cs();l[i]||(l[i]=[]);const r={timestamp:new Date().toISOString(),message:c,action:e,classroomName:i};l[i].unshift(r),l[i].length>Ri&&l[i].pop(),ni(l)}function zi(i){return Cs()[i]||[]}function Mi(i,c){const e=Cs();e[i]&&!e[c]&&(e[c]=e[i],delete e[i],ni(e))}const si=document.getElementById("class-management-page"),$i=document.getElementById("new-class-name"),Fi=document.getElementById("add-class-btn"),Dt=document.getElementById("class-list"),Nn=document.getElementById("undo-toast"),ii=document.getElementById("undo-message"),Pi=document.getElementById("undo-btn"),Wi=document.getElementById("settings-page"),ws=document.getElementById("settings-class-name-header"),jn=document.getElementById("settings-student-list"),Zn=document.getElementById("category-list"),Hi=document.getElementById("back-to-sessions-btn"),Ui=document.getElementById("new-student-name"),ji=document.getElementById("add-student-btn"),ai=document.getElementById("paste-area"),Zi=document.getElementById("process-paste-btn"),qi=document.getElementById("csv-preview-page"),qn=document.getElementById("csv-preview-list"),Gi=document.getElementById("csv-confirm-btn"),Vi=document.getElementById("csv-cancel-btn"),Ki=document.getElementById("import-csv-btn"),Ji=document.getElementById("csv-file-input"),Yi=document.getElementById("column-mapping-page"),Gn=document.getElementById("column-select-dropdown"),Xi=document.getElementById("confirm-column-btn"),Qi=document.getElementById("cancel-import-btn"),ea=document.getElementById("new-category-name"),ta=document.getElementById("add-category-btn"),Vn=document.querySelector(".app-header"),nt=document.getElementById("select-student-btn"),Ot=document.getElementById("select-student-btn-wrapper"),na=document.getElementById("attendance-page"),qt=document.getElementById("attendance-list"),sa=document.getElementById("finish-attendance-btn"),ia=document.querySelector("#class-management-page h2"),Kn=document.getElementById("student-stats-header"),aa=document.getElementById("hamburger-menu-btn"),ra=document.getElementById("side-nav-menu"),oa=document.getElementById("close-nav-btn"),ca=document.getElementById("overlay"),la=document.getElementById("backup-data-btn"),da=document.getElementById("restore-data-btn"),ri=document.getElementById("restore-file-input"),ua=document.getElementById("custom-confirm-modal"),oi=document.getElementById("confirm-modal-message"),Jn=document.getElementById("confirm-modal-cancel-btn"),Ht=document.getElementById("confirm-modal-confirm-btn"),fa=document.getElementById("secure-confirm-modal"),ci=document.getElementById("secure-confirm-message"),li=document.getElementById("secure-confirm-code"),Bt=document.getElementById("secure-confirm-input"),ma=document.getElementById("secure-confirm-cancel-btn"),fn=document.getElementById("secure-confirm-confirm-btn"),ha=document.getElementById("add-note-modal"),Ce=document.getElementById("new-note-content"),pa=document.getElementById("class-save-note-btn"),ga=document.getElementById("cancel-note-btn"),Yn=document.getElementById("student-search-input"),ft=document.getElementById("student-search-results"),ya=document.getElementById("back-to-student-page-btn"),ba=document.getElementById("graded-category-pills-container"),va=document.getElementById("new-score-value"),di=document.getElementById("new-score-comment"),Ca=document.getElementById("add-score-btn"),wa=document.getElementById("profile-stats-summary"),_a=document.getElementById("profile-scores-list"),Ut=document.getElementById("global-student-search-input"),it=document.getElementById("global-student-search-results"),Ea=document.getElementById("is-graded-checkbox"),ka=document.getElementById("trashed-classes-list"),Sa=document.getElementById("trashed-students-list"),Ia=document.getElementById("trashed-sessions-list"),xa=document.getElementById("trashed-categories-list"),La=document.getElementById("trashed-notes-list"),Ba=document.getElementById("trashed-scores-list"),Nt=document.getElementById("quick-grade-form-wrapper"),ot=document.getElementById("quick-score-input"),tt=document.getElementById("quick-note-textarea"),_t=document.getElementById("quick-grade-submit-btn"),Gt=document.getElementById("category-selection-container"),Xn=document.getElementById("selected-student-result"),Et=document.getElementById("custom-context-menu"),Tt=document.getElementById("breadcrumb-container");let Pt=null,At=null;const Ta=document.getElementById("category-modal"),ui=document.getElementById("category-modal-title"),Vt=document.getElementById("new-category-modal-name"),_s=document.getElementById("new-category-modal-is-graded"),Na=document.getElementById("category-modal-cancel-btn"),fi=document.getElementById("category-modal-save-btn"),Da=document.getElementById("mass-comment-modal"),Aa=document.getElementById("mass-comment-modal-title"),mi=document.getElementById("mass-comment-student-count-message"),Kt=document.getElementById("mass-comment-content"),Es=document.getElementById("mass-comment-append-checkbox"),Oa=document.getElementById("mass-comment-cancel-btn"),Ra=document.getElementById("mass-comment-save-btn"),Qn=document.getElementById("mass-comment-btn"),mn=document.getElementById("attendance-mass-actions-container"),Ct=document.createElement("input"),za=document.getElementById("session-dashboard-page"),Rt=document.getElementById("attendance-pane");function zt(i="selector"){if(!D||!J){pe("class-management-page");return}Wa(),pn(),Re(),dt(),pe("session-dashboard-page",{tab:i}),hi(),en(i),Ha()}function en(i){const c=document.getElementById("selector-tab-btn"),e=document.getElementById("attendance-tab-btn"),l=document.getElementById("selector-pane"),r=i==="selector";c.classList.toggle("active",r),e.classList.toggle("active",!r),l.classList.toggle("active",r),Rt.classList.toggle("active",!r)}function hi(){const i=document.getElementById("selector-tab-btn"),c=document.getElementById("attendance-tab-btn"),e=document.getElementById("selector-pane");i.addEventListener("click",()=>{Re(),Fe(),i.classList.add("active"),c.classList.remove("active"),e.classList.add("active"),Rt.classList.remove("active"),pe("session-dashboard-page",{tab:"selector"})}),c.addEventListener("click",()=>{dt(),c.classList.add("active"),i.classList.remove("active"),Rt.classList.add("active"),e.classList.remove("active"),pe("session-dashboard-page",{tab:"attendance"})})}function Ma(i){clearTimeout(An),Yt||In(JSON.stringify(oe)),ii.textContent=i,Nn.classList.add("show"),Vs(setTimeout(()=>{Nn.classList.remove("show"),In(null)},5e3))}function pi(){if(Yt){const i=D?D.info.name:null,c=JSON.parse(Yt);St(c),i&&oe[i]?Pe(oe[i]):Pe(null),D?(ct(),Mt(),He()):We(),Nn.classList.remove("show"),clearTimeout(An),In(null)}}function Q(i,c=3e3){const e=document.getElementById("notification-toast");e&&(e.textContent=i,e.classList.add("show"),clearTimeout(ls),Ks(setTimeout(()=>{e.classList.remove("show")},c)))}function es(i){const c=document.getElementById("restore-confirm-modal"),e=document.getElementById("restore-modal-message"),l=document.getElementById("restore-append-checkbox"),r=document.getElementById("restore-confirm-cancel-btn"),t=document.getElementById("restore-confirm-confirm-btn"),s=document.getElementById("restore-modal-warning");s.style.display="none";const n=i.metadata.createdAt;if(Ze.lastRestoreTimestamp&&n<Ze.lastRestoreTimestamp){const h=new Date(n).toLocaleDateString("fa-IR"),u=new Date(Ze.lastRestoreTimestamp).toLocaleDateString("fa-IR");s.textContent=`⚠️ هشدار: این فایل پشتیبان (${h}) قدیمی‌تر از آخرین بازیابی شما (${u}) است.`,s.style.display="block"}const a=Object.keys(i.data.classrooms).length,m="کلاس";e.textContent=`فایل پشتیبان شما حاوی ${a} ${m} است. لطفاً نحوه بازیابی را مشخص کنید.`,l.checked=!0;const p=()=>{const h=l.checked;Ms(i,h),c.removeEventListener("click",p),Ee(),We(),pe("class-management-page"),Q("✅ اطلاعات با موفقیت بازیابی شد.")},v=()=>{Ee()};t.onclick=p,r.onclick=v,Me("restore-confirm-modal")}function xe(i,c,e={}){const{confirmText:l="تایید",cancelText:r="لغو",confirmClass:t="btn-success",onCancel:s=()=>{},isDelete:n=!1}=e,a=n?()=>gi(i,c):c;oi.textContent=i,Ht.textContent=l,Jn.textContent=r,Ht.className="modal-action-btn",Ht.classList.add(t),ps(a),gs(s);const m=Ht.parentElement;Jn.style.display=s===null?"none":"inline-block",m.style.justifyContent=s===null?"center":"space-between",Me("custom-confirm-modal")}function gi(i,c){const e=Math.floor(1e4+Math.random()*9e4).toString();ci.textContent=i,li.textContent=e,Bt.value="",fn.disabled=!0,Qt(c),Me("secure-confirm-modal"),Bt.focus();const l=()=>{Bt.value===e?fn.disabled=!1:fn.disabled=!0};return Bt.addEventListener("input",l),()=>{Bt.removeEventListener("input",l)}}function ts(i,c={}){const{title:e="ایجاد دسته‌بندی جدید",initialName:l="",initialIsGraded:r=!1,saveButtonText:t="ذخیره"}=c;ui.textContent=e,Vt.value=l,_s.checked=r,fi.textContent=t,On((s,n)=>{if(!s){Q("⚠️ لطفاً نام دسته‌بندی را وارد کنید.");return}i(s,n),Ee()}),Me("category-modal"),Vt.focus(),l&&Vt.select()}function ks(i,c){const e=Object.values(oe).filter(s=>!s.isDeleted&&s.info.name!==c.info.name),l=document.getElementById("move-student-modal-title"),r=document.getElementById("move-student-class-select"),t=document.getElementById("move-student-confirm-btn");l.textContent=`انتقال دانش‌آموز: ${i.identity.name}`,r.innerHTML="",e.length===0?(r.innerHTML='<option value="">کلاس دیگری برای انتقال وجود ندارد</option>',t.disabled=!0):(e.forEach(s=>{const n=document.createElement("option");n.value=s.info.name,n.textContent=s.info.name,r.appendChild(n)}),t.disabled=!1),Xs(i),Qs(c),Me("move-student-modal")}function Ss(i,c){if(!i||!c)return;const e=i.identity.name,l=document.getElementById("add-note-modal-title");l.textContent="تغییر نام دانش‌آموز",Ce.value=e,Ce.rows=1,Ce.dispatchEvent(new Event("input",{bubbles:!0})),st(r=>{const t=r.trim();t&&t!==e&&(Be(c.students).some(n=>n.identity.studentId!==i.identity.studentId&&n.identity.name.toLowerCase()===t.toLowerCase())?Q("دانش‌آموزی با این نام از قبل در این کلاس وجود دارد."):(i.identity.name=t,we(c.info.name,`نام دانش‌آموز «${e}» به «${t}» تغییر یافت.`,{type:"VIEW_STUDENT_PROFILE",studentId:i.identity.studentId}),de(),ct(),Re(),dt(),Fe(),_e&&_e.identity.studentId===i.identity.studentId&&ze(i),Q(`✅نام دانش‌آموز به «${t}» تغییر یافت.`))),l.textContent="ثبت یادداشت جدید",Ce.rows=4}),Me("add-note-modal"),Ce.focus(),Ce.select()}function Me(i){const c=document.getElementById(i);if(c){if(mt)return;document.body.classList.add("modal-active"),c.classList.add("modal-visible"),ys(i),history.pushState(null,"",location.href)}}function Ee(i,c=!1){if(!mt)return;const e=document.getElementById(mt),l=mt;ys(null),l==="student-profile-modal"&&Ge(null),c||history.back(),e&&(e.classList.add("modal-closing"),setTimeout(()=>{e.classList.remove("modal-visible"),e.classList.remove("modal-closing"),document.body.classList.remove("modal-active"),l==="custom-confirm-modal"&&(ps(null),gs(null)),l==="secure-confirm-modal"&&Qt(null),l==="category-modal"&&On(null),l==="mass-comment-modal"&&(Kt.value=""),l==="add-note-modal"&&st(null),typeof i=="function"&&i()},300))}function Is(){if(!Rt||!Rt.classList.contains("active")){mn.style.display="none";return}const i=kt.length;i<1?mn.style.display="none":mn.style.display="block",Qn.disabled=i<1,Qn.textContent=`📝 ثبت یادداشت گروهی (${i} نفر)`}function yi(){const i=kt,c=i.length;let e=!1;c>0&&(e=i.some(r=>{var t;return(t=J.studentRecords[r])==null?void 0:t.homework.comment})),mi.textContent=`یادداشت برای ${c} دانش‌آموز ثبت خواهد شد.`,Kt.value="",Kt.dispatchEvent(new Event("input",{bubbles:!0})),Es.checked=!0;const l=document.querySelector("#mass-comment-modal .modal-options");l.style.display=e?"flex":"none",Me("mass-comment-modal"),Kt.focus()}function ns(i,c){if(!D||!J)return;let e=0;const l=kt,r=J;l.forEach(t=>{const s=r.studentRecords[t];if(s&&s.homework){const n=s.homework.comment||"";let a=i;c&&n.length>0?a=n+`
---
`+i:a=i,s.homework.comment=a.trim();const m=D.students.find(p=>p.identity.studentId===t);m&&$a(m,r,a.trim()),e++}}),Tn([]),de(),dt(),we(D.info.name,`${e} دانش‌آموز به صورت گروهی یادداشت تکلیف گرفتند.`,{type:"VIEW_SESSIONS"}),Q(`✅ یادداشت برای ${e} دانش‌آموز ثبت شد.`)}function $a(i,c,e){const r=Xe(D).get(c.sessionNumber),t={type:"fromAttendance",sessionNumber:c.sessionNumber},s=`یادداشت مربوط به جلسه ${r}: `,n=i.profile.notes.find(a=>!a.isDeleted&&a.source&&a.source.type==="fromAttendance"&&a.source.sessionNumber===t.sessionNumber);n?e?(n.content=s+e,n.isDeleted=!1):n.isDeleted=!0:e&&i.addNote(s+e,t)}function xs(i){Ce.value=i.note||"",st(c=>{i.note=c,de(),we(i.info.name,"یادداشت کلاس ذخیره شد.",{type:"VIEW_CLASS_NOTE"}),We(),Q("✅ یادداشت کلاس ذخیره شد.")}),Me("add-note-modal"),Ce.focus()}function Dn(i){Pe(i),ws.textContent=`تنظیمات کلاس: ${i.info.name}`,ct(),Mt(),Si(),pe("settings-page")}function bi(i){const c=document.getElementById("log-modal-title"),e=document.getElementById("log-list");c.textContent=`گزارش فعالیت‌های کلاس: ${i}`,e.innerHTML="";const l=zi(i);l.length===0?e.innerHTML='<li class="no-content-message">هنوز فعالیتی برای این کلاس ثبت نشده است.</li>':l.forEach(r=>{const t=document.createElement("li");t.className="log-entry";const s=new Date(r.timestamp),n=`${s.toLocaleDateString("fa-IR")} - ${s.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}`,a=document.createElement("span");a.className="log-timestamp",a.textContent=n;const m=document.createElement("span");m.className="log-message",m.textContent=r.message,r.action&&(m.classList.add("log-action-link"),m.dataset.action=JSON.stringify({...r.action,classroomName:r.classroomName})),t.appendChild(a),t.appendChild(m),e.appendChild(t)}),Me("log-modal")}document.getElementById("log-modal-close-btn").addEventListener("click",()=>{Ee()});function ss(i){const c=URL.createObjectURL(i),e=document.createElement("a");e.href=c,e.download=i.name,document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(c),setTimeout(()=>{xe("آیا فایل پشتیبان با موفقیت ذخیره شد؟",()=>{bs(),Rn(),Q("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله، ذخیره شد",cancelText:"خیر",confirmClass:"btn-success"})},500)}async function tn(i=[]){const c=await Rs(i);if(!c){Q("❌ خطا در ایجاد فایل پشتیبان.");return}("ontouchstart"in window||navigator.maxTouchPoints>0)&&navigator.share&&navigator.canShare&&navigator.canShare({files:[c]})?xe("فایل پشتیبان شما آماده است. آیا مایل به اشتراک‌گذاری آن هستید؟",()=>{try{navigator.share({title:c.name,text:"فایل پشتیبان داده‌های برنامه",files:[c]}).then(()=>{xe("آیا فایل پشتیبان با موفقیت ارسال/ذخیره شد؟",()=>{bs(),Rn(),Q("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}catch(l){console.error("Error during sharing process:",l),ss(c),Q("⚠️خطا در فرآیند اشتراک‌گذاری. فایل در حال دانلود است.")}},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"}):(ss(c),Q("✅پشتیبان‌گیری با موفقیت انجام شد."))}function sn(i,c){i.preventDefault(),wt(),At=i.target.closest("li"),At&&At.classList.add("context-menu-target"),setTimeout(()=>{const e=Et,l=e.querySelector("ul");l.innerHTML="",c.forEach(m=>{const p=document.createElement("li");m.isSeparator?p.className="separator":(p.innerHTML=`
                    <span class="icon">${m.icon||""}</span>
                    <span class="label">${m.label}</span>
                `,m.className&&p.classList.add(m.className),p.addEventListener("click",()=>{m.action(),wt()})),l.appendChild(p)}),e.classList.add("visible");const{offsetWidth:r,offsetHeight:t}=e,{innerHeight:s}=window,n=document.body.getBoundingClientRect();e.style.top=`${(s-t)/2}px`;const a=n.left+n.width/2;e.style.left=`${a-r/2}px`},50)}function wt(){Et.classList.contains("visible")&&Et.classList.remove("visible"),At&&(At.classList.remove("context-menu-target"),At=null)}function vi(){var e;Tt.innerHTML="";const i=document.getElementById("header-settings-btn");if(!i)return;const c=[];if(c.push({label:"کلاس‌ها",handler:()=>{Pe(null),je(null),Ge(null),pe("class-management-page")}}),D){c.push({label:D.info.name,handler:()=>{je(null),Ge(null),He(),pe("session-page")}});const l=(e=document.querySelector(".page.active"))==null?void 0:e.id;if(l==="session-page"?i.style.visibility="visible":i.style.visibility="hidden",l==="settings-page")c.push({label:"تنظیمات"});else if(J){const t=Xe(D).get(J.sessionNumber)||` (#${J.sessionNumber})`;c.push({label:`جلسه ${t}`,handler:()=>{Ge(null),zt("selector")}}),_e?c.push({label:`پروفایل: ${_e.identity.name}`}):l==="session-dashboard-page"&&(document.getElementById("attendance-tab-btn").classList.contains("active")?c.push({label:"حضور و غیاب"}):c.push({label:"انتخابگر"}))}}else i.style.visibility="hidden";if(c.length<=1){Tt.style.display="none";return}Tt.style.display="flex",c.forEach((l,r)=>{const t=document.createElement("a");if(t.textContent=l.label,t.className="breadcrumb-item",r===c.length-1||!l.handler?t.classList.add("active"):t.addEventListener("click",l.handler),Tt.appendChild(t),r<c.length-1){const s=document.createElement("span");s.className="breadcrumb-separator",s.textContent="/",Tt.appendChild(s)}})}function Bs(i,c,e){e.innerHTML="";const l=D.sessions.filter(r=>{var t;return!r.isDeleted&&!r.isCancelled&&((t=r.studentRecords[i.identity.studentId])==null?void 0:t.attendance)==="absent"}).map(r=>({number:c.get(r.sessionNumber),isMakeup:r.isMakeup})).filter(r=>r.number!==void 0);l.length>0?(e.appendChild(document.createTextNode("جلسات غایب: ")),l.forEach((r,t)=>{const s=document.createElement("span");s.textContent=r.number,r.isMakeup&&s.classList.add("makeup-absence"),e.appendChild(s),t<l.length-1&&e.appendChild(document.createTextNode("، "))})):e.textContent="جلسات غایب: بدون غیبت"}function hn(i,c,e,l={}){const{includePrefix:r=!0}=l;e.innerHTML="";const t=D.sessions.filter(s=>{if(s.isDeleted||s.isCancelled)return!1;const n=s.studentRecords[i.identity.studentId];return n&&n.homework&&(n.homework.status==="incomplete"||n.homework.status==="none")}).map(s=>({number:c.get(s.sessionNumber),status:s.studentRecords[i.identity.studentId].homework.status})).filter(s=>s.number!==void 0);t.length>0?(r&&e.appendChild(document.createTextNode("تکالیف ناقص: ")),t.forEach((s,n)=>{const a=document.createElement("span");a.textContent=s.number,s.status==="incomplete"&&a.classList.add("incomplete-homework"),e.appendChild(a),n<t.length-1&&e.appendChild(document.createTextNode("،"))})):r?e.textContent="تکالیف ناقص: ندارد":e.textContent="ندارد"}function Fa(i,c){var y,w,k;const e=document.createElement("li");e.className="attendance-list-item";const l=document.createElement("input");l.type="checkbox",l.className="mass-comment-checkbox",l.checked=kt.includes(i.identity.studentId),l.addEventListener("change",()=>{const I=i.identity.studentId,S=kt;if(l.checked)S.includes(I)||S.push(I);else{const O=S.indexOf(I);O>-1&&S.splice(O,1)}Is()}),e.appendChild(l);const r={none:"بدون تکلیف",complete:"تکلیف کامل",incomplete:"تکلیف ناقص"},t=document.createElement("div");t.className="student-info";const s=document.createElement("span");s.className="student-name",s.textContent=i.identity.name,s.addEventListener("click",()=>{ze(i)});const n=document.createElement("span");n.className="absence-info";const a=document.createElement("span");a.className="homework-info",Bs(i,c,n),hn(i,c,a),t.appendChild(s),t.appendChild(n),t.appendChild(a);const m=document.createElement("div");m.className="homework-controls";const p=document.createElement("button"),v=((y=J.studentRecords[i.identity.studentId])==null?void 0:y.homework.status)||"none";p.className=`homework-status-btn ${v}`,p.title=r[v],p.addEventListener("click",()=>{const I=J.studentRecords[i.identity.studentId].homework,O={none:"incomplete",incomplete:"complete",complete:"none"}[I.status];p.title=r[O],J.setHomeworkStatus(i.identity.studentId,O),de(),p.className=`homework-status-btn ${O}`,hn(i,c,a)});const h=document.createElement("button");h.className="btn-icon",h.innerHTML="📝",h.title="افزودن یادداشت برای تکلیف",((w=J.studentRecords[i.identity.studentId])==null?void 0:w.homework.comment)||(h.style.opacity="0.3"),h.addEventListener("click",()=>{const I=J.studentRecords[i.identity.studentId].homework;Ce.value=I.comment||"",Ce.dispatchEvent(new Event("input",{bubbles:!0})),st(S=>{I.comment=S;const O=Xe(D),z=O.get(J.sessionNumber),H={type:"fromAttendance",sessionNumber:J.sessionNumber},A=`یادداشت مربوط به جلسه ${z}: `,Z=i.profile.notes.find(ie=>!ie.isDeleted&&ie.source&&ie.source.type==="fromAttendance"&&ie.source.sessionNumber===H.sessionNumber);Z?S?Z.content=A+S:Z.isDeleted=!0:S&&i.addNote(A+S,H),de(),we(D.info.name,`یادداشت تکلیف جلسه ${z} برای دانش‌آموز «${i.identity.name}» ذخیره شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:i.identity.studentId}),Q("✅یادداشت تکلیف ذخیره شد."),h.style.opacity=S?"1":"0.3",hn(i,O,a)}),Me("add-note-modal"),Ce.focus()}),m.appendChild(p),m.appendChild(h);const g=document.createElement("button"),f=((k=J.studentRecords[i.identity.studentId])==null?void 0:k.attendance)||"present",b=I=>{I==="present"?(g.textContent="حاضر",g.className="attendance-status-btn present active"):(g.textContent="غایب",g.className="attendance-status-btn absent active")};return b(f),g.addEventListener("click",()=>{var O;const S=(((O=J.studentRecords[i.identity.studentId])==null?void 0:O.attendance)||"present")==="present"?"absent":"present";J.setAttendance(i.identity.studentId,S),S==="absent"&&(J.studentRecords[i.identity.studentId].hadIssue=!1),de(),b(S),Bs(i,c,n),Re(),Ii()}),e.appendChild(t),e.appendChild(m),e.appendChild(g),e}function Pa(){return Xe(D).get(J.sessionNumber)}function dt(){if(!D||!J)return;Be(D.students).forEach(r=>{J.initializeStudentRecord(r.identity.studentId)}),Tn([]);const i=Xe(D);Ya(),qt.innerHTML="";const c=document.createElement("li");c.className="attendance-list-header",Ct.id="attendance-search-input",Ct.type="text",Ct.className="inline-search-input",Ct.placeholder="جستجو...",Ct.value="";const e=document.createElement("div");e.className="student-search-container",e.appendChild(Ct);const l=document.createElement("div");l.className="header-labels-container",l.innerHTML=`
    <span class="header-label">تکلیف</span>
    <span class="header-label">حضور</span>
`,c.appendChild(e),c.appendChild(l),qt.appendChild(c),Be(D.students).forEach(r=>{const t=Fa(r,i);qt.appendChild(t)}),Tn([]),Is(),Xa(),Ii()}function Re(){const i=document.getElementById("student-stats-table-container");if(!i||(i.innerHTML="",!D))return;Be(D.students).length,Kn.textContent="آمار عملکرد";const c=["نام"],e=["کل انتخاب ها","غیبت","خروج","فرصت ازدست‌رفته","مشکل","میانگین","نمره کلاسی (کانون)"],l=D.categories.filter(u=>u.isGradedCategory&&!u.isDeleted).map(u=>u.name),r=[...c,...l,...e],t=document.createElement("table");t.className="student-stats-table";const n=t.createTHead().insertRow();r.forEach((u,g)=>{const f=document.createElement("th");g===0?(f.innerHTML=`${u} <span style="opacity: 0.6;">🔗</span>`,f.title="ردیف‌های این ستون قابل کلیک هستند"):f.textContent=u,n.appendChild(f)});const a=t.createTBody(),m=Be(D.students),p=u=>{let g=0;return D.sessions.forEach(f=>{if(f.isDeleted||f.isCancelled)return;const b=f.studentRecords[u.identity.studentId];b&&b.attendance==="absent"&&g++}),g};m.forEach(u=>{const g=a.insertRow();if(g.dataset.studentId=u.identity.studentId,J){const I=J.studentRecords[u.identity.studentId];I&&I.attendance==="absent"&&g.classList.add("absent-row-highlight")}const f=g.insertCell(),b=document.createElement("span");b.textContent=u.identity.name,b.className="student-name-link",b.addEventListener("click",()=>{ze(u)}),f.appendChild(b),l.forEach(I=>{var H;const S=g.insertCell(),O=I.toLowerCase(),z=((H=u.logs.scores[O])==null?void 0:H.filter(A=>!A.isDeleted))||[];z.length>0?z.forEach((A,Z)=>{const ie=document.createElement("span");ie.textContent=A.value,ie.style.position="relative",A.comment&&(ie.dataset.tooltip=A.comment),S.appendChild(ie),Z<z.length-1&&S.appendChild(document.createTextNode(","))}):S.textContent="",S.style.cursor="pointer",S.addEventListener("click",()=>{Fe(u,I);const A=document.getElementById("category-selection-container");A&&A.scrollIntoView({behavior:"smooth",block:"center"})})}),g.insertCell().textContent=u.statusCounters.totalSelections||0,g.insertCell().textContent=p(u),g.insertCell().textContent=u.statusCounters.outOfClassCount||0,g.insertCell().textContent=u.statusCounters.missedChances||0;const y=Object.values(u.categoryIssues||{}).reduce((I,S)=>I+S,0);g.insertCell().textContent=y;const w=u.getOverallAverageScore();g.insertCell().textContent=w!==null?w:"-";const k=D.calculateFinalStudentScore(u);g.insertCell().textContent=k!==null?k:"-"}),Be(D.students),Kn.setAttribute("data-student-count",m.length),i.appendChild(t);const v=i.querySelector(".student-stats-table"),h=v==null?void 0:v.querySelector("thead th:first-child");h&&h.addEventListener("click",()=>{v.classList.toggle("name-column-expanded")})}function Fe(i=null,c=null){const e=document.getElementById("selected-student-result");e.innerHTML="",e.classList.remove("absent");let l,r;if(i&&c)l=i,r=c,Ln({student:i,categoryName:c}),ht(-1);else{if(Ln(null),!J||et<0||!J.winnerHistory[et])return;const $=J.winnerHistory[et];l=$.winner,r=$.categoryName}const t=document.querySelector(".current-winner-highlight");if(t&&t.classList.remove("current-winner-highlight"),l){const $=document.querySelector(`.student-stats-table tr[data-student-id="${l.identity.studentId}"]`);$&&$.classList.add("current-winner-highlight")}const s=D.categories.find($=>$.name===r);if(s){xn(s),Ls(s);const $=document.querySelectorAll("#category-selection-container .pill");$.forEach(T=>T.classList.remove("active"));const te=Array.from($).find(T=>T.textContent===r);te&&te.classList.add("active"),is(s),as(s.name)}const n=J.studentRecords[l.identity.studentId],a=(n==null?void 0:n.attendance)==="absent",m=document.createElement("div");m.className="winner-name-container";const p=document.createElement("button");p.className="btn-icon",p.innerHTML="˅",p.title="برنده قبلی";const v=!i;p.classList.toggle("is-disabled",!v||et<=0),p.addEventListener("click",()=>{p.classList.contains("is-disabled")?(p.classList.add("shake-animation"),setTimeout(()=>p.classList.remove("shake-animation"),200)):(ht(et-1),Fe())});const h=document.createElement("div");h.className="winner-name",h.innerHTML=`✨ <strong>${l.identity.name}</strong>✨`,h.classList.add("heartbeat-animation"),a&&(h.style.textDecoration="line-through",h.style.opacity="0.6",h.style.color="var(--color-secondary)"),(n==null?void 0:n.hadIssue)&&!a&&(h.style.color="var(--color-warning)",h.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"),(n==null?void 0:n.wasOutOfClass)&&!a&&(h.style.color="var(--color-strong-warning)",h.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود");const f=1e3,b=$=>{Pt=setTimeout(()=>{tr(l,r),Pt=null},f)},y=()=>{Pt&&(clearTimeout(Pt),Pt=null)};h.addEventListener("mousedown",b),h.addEventListener("mouseup",y),h.addEventListener("mouseout",y),h.addEventListener("touchstart",b),h.addEventListener("touchmove",y),h.addEventListener("touchend",y),h.addEventListener("touchcancel",y);const w=document.createElement("button");if(w.className="btn-icon",w.innerHTML="˄",w.title="برنده بعدی",w.classList.toggle("is-disabled",!v||et>=J.winnerHistory.length-1),w.addEventListener("click",()=>{w.classList.contains("is-disabled")?(w.classList.add("shake-animation"),setTimeout(()=>w.classList.remove("shake-animation"),200)):(ht(et+1),Fe())}),m.appendChild(w),m.appendChild(h),l.onboardingSession===J.sessionNumber){const $=document.createElement("div");$.className="new-student-badge",$.textContent="دانش آموز جدید",m.appendChild($)}m.appendChild(p),e.appendChild(m),nt.disabled=v&&!w.classList.contains("is-disabled");const k=document.createElement("div");k.className="status-button-container";const I=document.createElement("button");I.textContent="غایب",I.classList.add("status-button","absent-btn"),a&&I.classList.add("active");const S=document.createElement("button");S.textContent="مشکل",S.classList.add("status-button","issue-btn"),n!=null&&n.hadIssue&&S.classList.add("active");const O=document.createElement("button");O.textContent="خروج",O.classList.add("status-button","exit-btn"),n!=null&&n.wasOutOfClass&&O.classList.add("active");const z=document.createElement("button");z.textContent="پروفایل",z.className="status-button profile-btn",J.isFinished?I.disabled=!0:I.addEventListener("click",()=>{const $=I.classList.contains("active");O.classList.contains("active")&&(O.classList.remove("active"),n.wasOutOfClass=!1,l.statusCounters.outOfClassCount=Math.max(0,(l.statusCounters.outOfClassCount||0)-1),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)),$?(I.classList.remove("active"),J.setAttendance(l.identity.studentId,"present"),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1),h.style.textDecoration="",h.style.opacity="",h.style.color=""):(S.classList.contains("active")&&(S.classList.remove("active"),n.hadIssue=!1,l.statusCounters.otherIssues=Math.max(0,l.statusCounters.otherIssues-1),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)),I.classList.add("active"),J.setAttendance(l.identity.studentId,"absent"),l.statusCounters.missedChances++,h.style.textDecoration="line-through",h.style.opacity="0.6",h.style.color="var(--color-secondary)",h.title=""),Re(),setTimeout(()=>Fe(l,r),0),de()}),J.isFinished?S.disabled=!0:S.addEventListener("click",()=>{const $=S.classList.contains("active");if(O.classList.contains("active")&&(O.classList.remove("active"),n.wasOutOfClass=!1,l.statusCounters.outOfClassCount=Math.max(0,(l.statusCounters.outOfClassCount||0)-1),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)),$){S.classList.remove("active"),n.hadIssue=!1;const te=qe.name;l.categoryIssues[te]&&(l.categoryIssues[te]=Math.max(0,l.categoryIssues[te]-1)),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1),h.style.color="",h.title=""}else{I.classList.contains("active")&&(I.classList.remove("active"),J.setAttendance(l.identity.studentId,"present"),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)),S.classList.add("active"),n.hadIssue=!0;const te=qe.name;l.categoryIssues[te]=(l.categoryIssues[te]||0)+1,l.statusCounters.missedChances++,h.style.textDecoration="",h.style.opacity="",h.style.color="var(--color-warning)",h.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"}Re(),setTimeout(()=>Fe(l,r),0),de()}),J.isFinished?O.disabled=!0:O.addEventListener("click",()=>{if(O.classList.contains("active"))O.classList.remove("active"),n.wasOutOfClass=!1,h.style.color="",h.title="";else{if(I.classList.contains("active")&&(I.classList.remove("active"),J.setAttendance(l.identity.studentId,"present"),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)),S.classList.contains("active")){S.classList.remove("active"),n.hadIssue=!1;const te=qe.name;l.categoryIssues[te]&&(l.categoryIssues[te]=Math.max(0,l.categoryIssues[te]-1)),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)}O.classList.add("active"),n.wasOutOfClass=!0,h.style.textDecoration="",h.style.opacity="",h.style.color="var(--color-strong-warning)",h.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود"}Re(),setTimeout(()=>Fe(l,r),0),de()}),J.isFinished?z.disabled=!0:z.addEventListener("click",()=>{ze(l)}),k.appendChild(I),k.appendChild(O),k.appendChild(S),k.appendChild(z),e.appendChild(k);const H=document.createElement("div");H.className="student-details-container";const A=document.createElement("div");A.className="student-details-scores",A.innerHTML="<h4>آخرین نمرات</h4>";const Z=document.createElement("ul");Z.className="scores-list";const ie=D.categories.filter($=>$.isGradedCategory&&!$.isDeleted);let E=!1;const M=l.logs.scores||{};ie.forEach($=>{var Te;const te=$.name,T=te.toLowerCase(),N=document.createElement("li"),re=document.createElement("span");re.className="skill-name",re.textContent=`${te}:`;const ee=document.createElement("span");ee.className="skill-scores";const Y=(Te=M[T])==null?void 0:Te.filter(De=>!De.isDeleted);Y&&Y.length>0?(E=!0,ee.textContent=Y.slice(-3).map(De=>De.value).join(",")):ee.textContent="none",N.appendChild(re),N.appendChild(ee),Z.appendChild(N)}),E||(Z.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>'),A.appendChild(Z),H.appendChild(A);const d=document.createElement("div");d.className="student-details-notes";const F=document.createElement("div");F.className="history-section-header";const ue=document.createElement("h4");ue.textContent="یادداشت‌ها";const j=document.createElement("button");j.className="btn-icon",j.innerHTML="📝",j.title="افزودن یادداشت جدید",J.isFinished?j.disabled=!0:j.addEventListener("click",()=>{Ce.value="",Ce.dispatchEvent(new Event("input",{bubbles:!0})),st($=>{$&&(l.addNote($),de(),Fe(),Q("✅ یادداشت با موفقیت ثبت شد."))}),Me("add-note-modal"),Ce.focus()}),F.appendChild(ue),F.appendChild(j),d.appendChild(F);const fe=document.createElement("ul");fe.className="notes-list",l.profile.notes&&l.profile.notes.length>0?[...l.profile.notes].sort((te,T)=>new Date(T.timestamp)-new Date(te.timestamp)).forEach(te=>{const T=document.createElement("li");T.dir=vs(te.content),T.textContent=te.content,fe.appendChild(T)}):fe.innerHTML='<div class="no-content-message">یادداشتی وجود ندارد.</div>',d.appendChild(fe),H.appendChild(d),e.appendChild(H)}function Ci(i){i.addEventListener("input",()=>{const c=i.value,e=vs(c);i.setAttribute("dir",e)})}function Wa(){Ls(null),Gt.innerHTML="",Xn.innerHTML="",Nt.classList.add("tooltip-container"),ot.disabled=!0,tt.disabled=!0,_t.disabled=!0,ot.value="",tt.value="",Ot.classList.add("disabled-wrapper"),nt.disabled=!0}function pn(){Gt.innerHTML="",D.categories.filter(e=>!e.isDeleted).forEach(e=>{const l=document.createElement("span");l.className="pill",l.textContent=e.name,l.dataset.categoryId=e.id,e.description&&(l.dataset.tooltip=e.description),J.isFinished?l.classList.add("disabled"):l.addEventListener("click",()=>{document.querySelectorAll("#category-selection-container .pill").forEach(t=>t.classList.remove("active")),l.classList.add("active"),xn(e),Ls(e),is(e),as(e.name),Ot.classList.remove("disabled-wrapper"),nt.disabled=J.isFinished;const r=J.lastWinnerByCategory[e.name];if(r){const t=D.students.find(s=>s.identity.studentId===r);t&&Fe(t,e.name)}else{Xn.innerHTML="",Ln(null),ht(-1),nt.disabled=!1;const t=document.querySelector(".current-winner-highlight");t&&t.classList.remove("current-winner-highlight")}}),J.isFinished||l.addEventListener("contextmenu",r=>{sn(r,[{label:"تغییر نام",icon:"✏️",action:()=>{ts((s,n)=>{const a=Fs(D,e,s);a.success?(e.isGradedCategory=n,de(),we(D.info.name,`نام دسته‌بندی «${e.name}» به «${s}» تغییر یافت.`),pn(),Re(),Q(`✅ نام دسته‌بندی به «${s}» تغییر یافت.`)):Q(`⚠️ ${a.message}`)},{title:"ویرایش دسته‌بندی",initialName:e.name,initialIsGraded:e.isGradedCategory,saveButtonText:"ذخیره تغییرات"})}},{label:"حذف دسته‌بندی",icon:"🗑️",className:"danger",action:()=>{xe(`آیا از انتقال دسته‌بندی «${e.name}» به سطل زباله مطمئن هستید؟`,()=>{const s={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${e.name}» از کلاس «${D.info.name}»`,restoreData:{categoryId:e.id,classId:D.info.scheduleCode}};he.unshift(s),he.length>50&&he.pop();const n=e.name.toLowerCase();if(D.students.forEach(a=>{a.logs.scores&&a.logs.scores[n]&&a.logs.scores[n].forEach(m=>{m.isDeleted=!0})}),qe&&qe.id===e.id){xn(null),Xn.innerHTML="",is(null),as(null),Ot.classList.add("disabled-wrapper"),nt.disabled=!0;const a=document.querySelector(".current-winner-highlight");a&&a.classList.remove("current-winner-highlight")}e.isDeleted=!0,we(D.info.name,`دسته‌بندی «${e.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),de(),pn(),Re(),Q(`✅ دسته‌بندی «${e.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}}])}),Gt.appendChild(l)});const c=document.createElement("span");c.className="pill add-category-pill",c.textContent="+",c.title="افزودن دسته‌بندی جدید",J.isFinished?c.classList.add("disabled"):c.addEventListener("click",()=>{ts((e,l)=>{if(D.categories.find(s=>s.name.toLowerCase()===e.toLowerCase()&&!s.isDeleted)){Q("⚠️ این دسته‌بندی از قبل وجود دارد.");return}const t=new lt(e,"",l);D.categories.push(t),de(),we(D.info.name,`دسته‌بندی جدید «${e}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),pn(),Q(`✅ دسته‌بندی «${e}» اضافه شد.`)})}),Gt.appendChild(c)}function Ha(){if(J.lastUsedCategoryId){if(J.isFinished)return;const i=Gt.querySelector(`.pill[data-category-id="${J.lastUsedCategoryId}"]`);i&&i.click()}J.winnerHistory&&J.winnerHistory.length>0&&(ht(J.winnerHistory.length-1),Fe())}function Ls(i){i?nt.textContent=`نفر بعدی در ${i.name}`:nt.textContent="نفر بعدی"}function is(i){if(J.isFinished){ot.disabled=!0,tt.disabled=!0,_t.disabled=!0,Nt.setAttribute("title","جلسه خاتمه یافته است");return}i&&i.isGradedCategory?(ot.disabled=!1,tt.disabled=!1,_t.disabled=!1,Nt.removeAttribute("title")):(ot.disabled=!0,tt.disabled=!0,_t.disabled=!0,i?Nt.setAttribute("title","برای این دسته‌بندی قابلیت نمره دهی تعریف نشده است"):Nt.setAttribute("title","ابتدا یک دسته‌بندی را انتخاب کنید"))}function as(i){const c=document.querySelector(".student-stats-table");if(!c||(c.querySelectorAll(".current-category-highlight").forEach(s=>{s.classList.remove("current-category-highlight")}),!i))return;let l=-1;const r=c.querySelectorAll("thead th");if(r.forEach((s,n)=>{s.textContent.trim()===i&&(l=n)}),l===-1)return;r[l].classList.add("current-category-highlight"),c.querySelectorAll("tbody tr").forEach(s=>{const n=s.cells[l];n&&n.classList.add("current-category-highlight")})}function ze(i){Ge(i);const c=document.getElementById("student-profile-modal"),e=document.getElementById("modal-profile-student-name"),l=document.getElementById("modal-profile-content-container"),r=document.getElementById("modal-profile-close-btn");if(!c||!e||!l||!r)return;e.textContent=`پروفایل: ${i.identity.name}`,e.style.cursor="pointer",e.onclick=()=>{const m=_e,p=D;Ee(()=>{Ss(m,p)})},l.innerHTML="";const t=document.createElement("div");t.className="profile-header-actions";const s=document.createElement("button");s.className="btn-icon btn-icon-label",s.title="انتقال دانش‌آموز",s.innerHTML="<span>➡️</span><span>انتقال</span>",s.addEventListener("click",()=>{const m=_e,p=D;Ee(()=>{ks(m,p)})});const n=document.createElement("button");n.className="btn-icon btn-icon-label",n.title="حذف دانش‌آموز",n.innerHTML="<span>🗑️</span><span>حذف</span>",n.style.color="var(--color-strong-warning)",n.addEventListener("click",()=>{const m=_e,p=D;Ee(()=>{xe(`آیا از انتقال دانش‌آموز «${m.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const v={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آMوز «${m.identity.name}» از کلاس «${p.info.name}»`,restoreData:{studentId:m.identity.studentId,classId:p.info.scheduleCode}};he.unshift(v),he.length>50&&he.pop(),m.isDeleted=!0,we(p.info.name,`دانش‌آموز «${m.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),de(),ct(),Re(),dt(),Q(`✅ دانش‌آموز «${m.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0,onCancel:()=>{ze(m)}})})});const a=document.createElement("button");a.className="btn-icon btn-icon-label",a.title="افزودن یادداشت جدید",a.innerHTML="<span>📝</span><span>یادداشت</span>",a.addEventListener("click",()=>{const m=_e;Ce.value="",Ce.dispatchEvent(new Event("input",{bubbles:!0})),st(p=>{p&&(m.addNote(p),de(),we(D.info.name,`یادداشت جدیدی برای دانش‌آموز «${m.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:m.identity.studentId}),Fe(),Q("✅ یادداشت با موفقیت ثبت شد.")),ze(m)}),Ee(()=>{Me("add-note-modal"),Ce.focus()})}),t.appendChild(s),t.appendChild(n),t.appendChild(a),l.appendChild(t),Ua(l),wi(l),r.onclick=()=>Ee(),Me("student-profile-modal")}function Ua(i){if(!_e||!D)return;const c=document.createElement("div");c.className="scoring-section",c.innerHTML=`
        <h3>ثبت نمره جدید</h3>
        <div id="modal-graded-pills" class="category-pills"></div>
        <div class="input-group centered-input-group" style="margin-top: 15px;">
            <input type="number" id="modal-new-score-value" placeholder="نمره (مثلا: 85)">
        </div>
        <textarea id="modal-new-score-comment" placeholder="توضیحات این نمره (اختیاری)..." style="margin-top: 10px;"></textarea>
        <button id="modal-add-score-btn" class="btn-success" style="width: 100%; margin-top: 10px;">ثبت نمره</button>
    `;const e=c.querySelector("#modal-graded-pills");Be(D.categories).filter(t=>t.isGradedCategory).forEach(t=>{const s=document.createElement("span");s.className="pill",s.textContent=t.name,s.dataset.skillName=t.name,s.addEventListener("click",()=>{e.querySelectorAll(".pill").forEach(n=>n.classList.remove("active")),s.classList.add("active")}),e.appendChild(s)}),c.querySelector("#modal-add-score-btn").addEventListener("click",()=>{const t=e.querySelector(".pill.active");if(!t){Q("⚠️لطفاً یک مهارت را برای نمره‌دهی انتخاب کنید.");return}const s=t.dataset.skillName,n=c.querySelector("#modal-new-score-value"),a=c.querySelector("#modal-new-score-comment"),m=n.value,p=a.value.trim();if(!m){Q("لطفاً مقدار نمره را وارد کنید.");return}_e.addScore(s,parseFloat(m),p),de(),we(D.info.name,`نمره ${m} در ${s} برای «${_e.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:_e.identity.studentId}),Re(),Fe(),n.value="",a.value="";const v=document.getElementById("modal-profile-content-container"),h=v.querySelector(".history-section");h&&h.remove(),wi(v),Q(`✅ نمره برای مهارت ${s} با موفقیت ثبت شد.`)}),i.appendChild(c)}function wi(i){if(!_e)return;const c=document.createElement("div");c.className="history-section";const e=document.createElement("div");e.className="history-section-header";const l=document.createElement("h3");l.textContent="سوابق دانش‌آموز",e.appendChild(l),c.appendChild(e),ja(c),_i(c),Ei(c),i.appendChild(c)}function ja(i){if(!_e)return;const c=_e,e=D.sessions.reduce((u,g)=>{const f=g.studentRecords[c.identity.studentId];return u+(f&&f.attendance==="absent"?1:0)},0),l=Object.values(c.categoryIssues||{}).reduce((u,g)=>u+g,0),r=document.createElement("div");r.className="stats-summary-box",r.innerHTML=`
        <p><strong>کل انتخاب:</strong> ${c.statusCounters.totalSelections}</p>
        <p><strong>غیبت:</strong> ${e}</p>
        <p><strong>فرصت از دست رفته:</strong> ${c.statusCounters.missedChances||0}</p>
        <p><strong>مشکل:</strong> ${l}</p>
    `,i.appendChild(r),r.querySelector("p:nth-child(1)");const t=r.querySelector("p:nth-child(4)"),s=Be(D.categories),n=document.createElement("div");if(n.className="stats-breakdown",s.length>0){s.forEach(g=>{var w;const f=g.name,b=((w=c.categoryCounts)==null?void 0:w[f])||0,y=document.createElement("p");y.className="stats-breakdown-item",y.innerHTML=`<strong>${f}:</strong> ${b}`,n.appendChild(y)});const u=r.querySelector("p:first-child");u&&(u.classList.add("collapsible-toggle"),u.onclick=()=>{n.classList.toggle("open"),u.classList.toggle("open")},u.after(n))}const a=document.createElement("div");a.className="stats-breakdown",s.length>0&&(s.forEach(u=>{var y;const g=u.name,f=((y=c.categoryIssues)==null?void 0:y[g])||0,b=document.createElement("p");b.className="stats-breakdown-item",b.innerHTML=`<strong>${g}:</strong> ${f}`,a.appendChild(b)}),t&&(t.classList.add("collapsible-toggle"),t.onclick=()=>{a.classList.toggle("open"),t.classList.toggle("open")},r.appendChild(a)));const m=document.createElement("p"),p=document.createElement("strong");p.textContent="تکالیف ناقص:";const v=document.createElement("span");v.style.marginRight="5px";const h=Xe(D);hn(c,h,v,{includePrefix:!1}),m.appendChild(p),m.appendChild(v),r.appendChild(m)}function _i(i){if(!_e)return;const c=_e,e=document.createElement("h4");e.textContent="تاریخچه نمرات:",e.style.marginTop="20px";const l=document.createElement("ul");l.className="list-container";const r=Object.values(c.logs.scores||{}).flat().filter(t=>!t.isDeleted).sort((t,s)=>new Date(s.timestamp)-new Date(t.timestamp));r.length===0?l.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>':r.forEach(t=>{const s=document.createElement("li");s.className="score-history-item";const n=document.createElement("div");n.className="item-content";const a=document.createElement("div");a.className="score-info";const m=document.createElement("span");m.className="score-skill-badge",m.textContent=t.skill;const p=document.createElement("span");p.className="score-value",p.textContent=`نمره: ${t.value}`;const v=document.createElement("span");if(v.className="score-date",v.textContent=new Date(t.timestamp).toLocaleDateString("fa-IR"),a.appendChild(m),a.appendChild(p),a.appendChild(v),n.appendChild(a),t.comment){const u=document.createElement("p");u.className="score-comment",u.innerHTML=ei(t.comment),u.addEventListener("click",()=>{Ce.value=t.comment,Ce.dispatchEvent(new Event("input",{bubbles:!0})),st(g=>{t.comment=g,de(),we(D.info.name,`توضیحات نمره ${t.value} (${t.skill}) برای دانش‌آموز «${c.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:c.identity.studentId}),ze(c),Q("✅ توضیحات نمره با موفقیت ویرایش شد.")}),Ee(()=>{Me("add-note-modal"),Ce.focus()})}),n.appendChild(u)}const h=document.createElement("button");h.className="btn-icon delete-item-btn",h.innerHTML="🗑️",h.title="حذف این نمره",h.addEventListener("click",()=>{Ee(()=>{xe(`آیا از انتقال نمره ${t.value} در مهارت «${t.skill}» به سطل زباله مطمئن هستید؟`,()=>{const u={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"score",description:`نمره ${t.value} (${t.skill}) برای «${c.identity.name}»`,restoreData:{scoreId:t.id,skill:t.skill,studentId:c.identity.studentId,classId:D.info.scheduleCode}};he.unshift(u),he.length>50&&he.pop(),t.isDeleted=!0,de(),we(D.info.name,`نمره ${t.value} (${t.skill}) دانش‌آموز «${c.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ze(c),Q("✅ نمره به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{ze(c)}})})}),s.appendChild(n),s.appendChild(h),l.appendChild(s)}),i.appendChild(e),i.appendChild(l)}function Ei(i){if(!_e)return;const c=document.createElement("h4");c.textContent="تاریخچه یادداشت‌ها:",c.style.marginTop="20px";const e=document.createElement("ul");e.className="list-container",!_e.profile.notes||_e.profile.notes.length===0?e.innerHTML='<div class="no-content-message">هنوز یادداشتی ثبت نشده است.</div>':[..._e.profile.notes].filter(r=>!r.isDeleted).sort((r,t)=>new Date(t.timestamp)-new Date(r.timestamp)).forEach(r=>{const t=document.createElement("li");t.className="note-history-item";const s=document.createElement("div");s.className="item-content";const n=document.createElement("div");n.className="note-info";const a=document.createElement("span");a.className="note-date",a.textContent=new Date(r.timestamp).toLocaleDateString("fa-IR");const m=document.createElement("button");m.className="btn-icon delete-item-btn",m.innerHTML="🗑️",m.title="حذف این یادداشت",m.addEventListener("click",()=>{const v=_e;Ee(()=>{xe("آیا از انتقال این یادداشت به سطل زباله مطمئن هستید؟",()=>{const h={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"note",description:`یادداشت برای دانش‌آموز «${v.identity.name}»`,restoreData:{noteId:r.id,studentId:v.identity.studentId,classId:D.info.scheduleCode}};he.unshift(h),he.length>50&&he.pop(),r.isDeleted=!0,we(D.info.name,`یادداشت دانش‌آموز «${v.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),de(),ze(v),Q("✅ یادداشت به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{ze(v)}})})}),n.appendChild(a),n.appendChild(m);const p=document.createElement("p");p.className="note-content",p.innerHTML=ei(r.content),p.addEventListener("click",()=>{const v=_e;Ce.value=r.content,Ce.dispatchEvent(new Event("input",{bubbles:!0})),st(h=>{r.content=h,de(),we(D.info.name,`یادداشت دانش‌آموز «${v.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:v.identity.studentId}),ze(v),Q("✅یادداشت با موفقیت ویرایش شد.")}),Ee(()=>{Me("add-note-modal"),Ce.focus()})}),s.appendChild(n),s.appendChild(p),t.appendChild(s),e.appendChild(t)}),i.appendChild(c),i.appendChild(e)}function ki(i){Gn.innerHTML="",i.forEach((c,e)=>{const l=document.createElement("option");l.value=e,l.textContent=c.trim(),Gn.appendChild(l)})}function rs(){qn.innerHTML="",cs.forEach(i=>{const c=document.createElement("li");c.className="preview-item";const e=document.createElement("input");e.type="checkbox",e.checked=!0,e.dataset.name=i;const l=document.createElement("label");l.textContent=i,c.appendChild(e),c.appendChild(l),qn.appendChild(c)})}function Za(i){const c=document.createElement("div");c.className="list-item-buttons";const e=document.createElement("button");return e.className="btn-icon",e.innerHTML="📝",e.title="افزودن/ویرایش یادداشت کلاس",e.style.borderBottom="solid",i.note||(e.style.opacity="0.5",e.style.borderBottom="none"),e.addEventListener("click",l=>{l.stopPropagation(),xs(i)}),c.appendChild(e),c}function qa(i){const c=document.createElement("div");c.style.flexGrow="1",c.style.display="flex",c.style.flexDirection="column",c.style.alignItems="flex-start";const e=document.createElement("span");e.textContent=i.info.name,e.classList.add("class-name-display"),c.appendChild(e);const l=Be(i.students).length,r=Be(i.sessions).filter(a=>a.isFinished).length,t=document.createElement("div");t.classList.add("class-stats-row");const s=document.createElement("span");s.textContent=`${l} نفر`,s.classList.add("student-count-badge"),t.appendChild(s);const n=document.createElement("span");return n.textContent=`${r} جلسه`,n.classList.add("session-count-badge"),t.appendChild(n),c.appendChild(t),c.addEventListener("click",()=>{Pe(i),je(null),Xt(D.liveSession),He(),pe("session-page")}),c}function Ga(i){const c=document.createElement("li"),e=document.createElement("input");e.type="checkbox",e.className="mass-selection-checkbox",e.checked=at.includes(i.info.name),e.addEventListener("click",n=>{n.stopPropagation()}),e.addEventListener("change",()=>{const n=i.info.name;if(e.checked)at.includes(n)||at.push(n);else{const a=at.indexOf(n);a>-1&&at.splice(a,1)}}),c.appendChild(e);const l=qa(i);c.appendChild(l);const r=document.createElement("div");if(r.className="list-item-badges",i.liveSession&&!i.liveSession.isCancelled&&!i.liveSession.isDeleted){const n=document.createElement("span");n.className="warning-badge",n.textContent="جلسه باز",r.appendChild(n),c.classList.add("has-unfinished-session")}const t=document.createElement("span");t.className=`type-badge ${i.info.type}`,t.textContent=i.info.type==="online"?"آنلاین":"حضوری",t.title="نوع کلاس",r.appendChild(t),c.appendChild(r);const s=Za(i);return c.appendChild(s),c.addEventListener("contextmenu",n=>{const a={label:"پشتیبان‌گیری از این کلاس",icon:"📤",action:()=>{tn([i.info.name])}},m=at.length;m>1&&at.includes(i.info.name)&&(a.label=`پشتیبان‌گیری از ${m} کلاس`,a.action=()=>{tn(at),Un([]),We()});const p=[{label:Dt.classList.contains("selection-mode-active")?"لغو انتخاب":"انتخاب چند کلاس",icon:"✔️",action:()=>{const v=Dt.classList.contains("selection-mode-active");Dt.classList.toggle("selection-mode-active"),v&&(Un([]),We())}},a,{label:"تنظیمات کلاس",icon:"⚙️",action:()=>{Dn(i)}},{label:"گزارش فعالیت‌ها",icon:"📋",action:()=>{bi(i.info.name)}},{label:"تغییر نام",icon:"✏️",action:()=>{const v=i.info.name,h=document.getElementById("add-note-modal-title");h.textContent="تغییر نام کلاس",Ce.value=v,Ce.rows=1,st(u=>{const g=u.trim();if(g&&g!==v){const f=$s(v,g);f.success?(Mi(v,g),we(g,`نام کلاس از «${v}» به «${g}» تغییر یافت.`,{type:"VIEW_SESSIONS"}),de(),We(),Q(`✅نام کلاس به «${g}» تغییر یافت.`)):Q(f.message)}h.textContent="ثبت یادداشت جدید",Ce.rows=4}),Me("add-note-modal"),Ce.focus(),Ce.select()}},{label:"حذف کلاس",icon:"🗑️",className:"danger",action:()=>{xe(`آیا از انتقال کلاس «${i.info.name}» به سطل زباله مطمئن هستید؟`,()=>{const v={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"classroom",description:`کلاس «${i.info.name}»`,restoreData:{name:i.info.name}};he.unshift(v),he.length>50&&he.pop(),i.isDeleted=!0,de(),We(),Q(`✅ کلاس «${i.info.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}];sn(n,p)}),c}function Rn(){const i=document.getElementById("class-management-stats");if(!i)return;const c=Object.values(oe).filter(t=>!t.isDeleted),e=c.length,l=c.reduce((t,s)=>t+Be(s.students).length,0);let r="";Ze.lastBackupTimestamp&&(r=`
            <div class="stats-row backup-stat">
                <span>آخرین پشتیبان: <strong>${new Date(Ze.lastBackupTimestamp).toLocaleString("fa-IR",{year:"numeric",month:"numeric",day:"numeric",weekday:"long",hour:"2-digit",minute:"2-digit"})}</strong></span>
            </div>
        `),i.innerHTML=`
        <div class="stats-row main-stats">
            <span>کل کلاس‌ها: <strong>${e}</strong></span>
            <span>|</span>
            <span>کل دانش‌آموزان: <strong>${l}</strong></span>
        </div>
        ${r} 
    `}function We(){Rn(),Dt.innerHTML="",Object.values(oe).sort((c,e)=>new Date(c.info.creationDate)-new Date(e.info.creationDate)).forEach(c=>{if(c.isDeleted)return;const e=Ga(c);Dt.appendChild(e)})}function ct(){jn.innerHTML="",D&&Be(D.students).forEach(i=>{const c=document.createElement("li"),e=document.createElement("span");e.textContent=i.identity.name,e.style.flexGrow="1",e.className="student-name-link",e.addEventListener("click",()=>{ze(i)}),c.appendChild(e),c.addEventListener("contextmenu",l=>{sn(l,[{label:"تغییر نام",icon:"✏️",action:()=>{Ss(i,D)}},{label:"انتقال دانش‌آموز",icon:"➡️",action:()=>{ks(i,D)}},{label:"حذف دانش‌آموز",icon:"🗑️",className:"danger",action:()=>{xe(`آیا از انتقال دانش‌آموز «${i.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const t={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${i.identity.name}» از کلاس «${D.info.name}»`,restoreData:{studentId:i.identity.studentId,classId:D.info.scheduleCode}};he.unshift(t),he.length>50&&he.pop(),i.isDeleted=!0,we(D.info.name,`دانش‌آموز «${i.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),de(),ct(),Q(`✅ دانش‌آموز «${i.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}])}),jn.appendChild(c)})}function Mt(){if(Zn.innerHTML="",!D)return;D.categories.filter(c=>!c.isDeleted).forEach(c=>{const e=document.createElement("li"),l=document.createElement("div");l.className="name-and-badge-container";const r=document.createElement("span");if(r.textContent=c.name,l.appendChild(r),c.isGradedCategory){const s=document.createElement("span");s.className="category-badge",s.textContent="قابل نمره‌دهی",l.appendChild(s)}const t=document.createElement("button");t.className="btn-icon",t.innerHTML="🗑️",t.style.color="var(--color-warning)",t.addEventListener("click",()=>{xe(`آیا از انتقال دسته‌بندی «${c.name}» به سطل زباله مطمئن هستید؟`,()=>{const s={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${c.name}» از کلاس «${D.info.name}»`,restoreData:{categoryId:c.id,classId:D.info.scheduleCode}};he.unshift(s),he.length>50&&he.pop(),c.isDeleted=!0,we(D.info.name,`دسته‌بندی «${c.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),de(),Mt(),Q(`✅ دسته‌بندی «${c.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}),e.appendChild(l),e.appendChild(t),Zn.appendChild(e)})}function Si(){if(!D)return;const i=D.info.type||"in-person",c=document.querySelector(`#settings-page input[name="class-type-setting"][value="${i}"]`);c&&(c.checked=!0)}function Jt(i){document.querySelectorAll(".page").forEach(e=>{e.classList.remove("active")});const c=document.getElementById(i);c&&c.classList.add("active"),i==="class-management-page"?(Pe(null),je(null),Ge(null),We(),Vn.style.display="flex"):Vn.style.display="none",vi()}function pe(i,c={}){const{tab:e}=c,l={pageId:i,currentClassName:D?D.info.name:null,selectedSessionNumber:J?J.sessionNumber:null,selectedStudentId:_e?_e.identity.studentId:null};let r=`#${i}`;const t=new URLSearchParams(window.location.hash.split("?")[1]||"");D?t.set("class",D.info.name):t.delete("class"),J?t.set("session",J.sessionNumber):t.delete("session"),_e?t.set("student",_e.identity.studentId):t.delete("student"),i==="session-dashboard-page"&&e?t.set("tab",e):i!=="session-dashboard-page"&&t.delete("tab");const s=t.toString();s&&(r+=`?${s}`),window.location.hash!==r&&history.pushState(l,"",r),Jt(i)}function Va(i,c){const e=document.createElement("div");e.className="list-item-buttons";const l=document.createElement("button");if(l.className="btn-icon",l.innerHTML="📝",l.title="افزودن/ویرایش یادداشت جلسه",l.style.borderBottom="solid",i.note||(l.style.opacity="0.5",l.style.borderBottom="none"),l.addEventListener("click",r=>{r.stopPropagation(),Ce.value=i.note||"",st(t=>{i.note=t,de(),we(D.info.name,`یادداشت جلسه ${c} ذخیره شد.`,{type:"VIEW_SESSIONS"}),He(),Q("✅یادداشت جلسه ذخیره شد.")}),Me("add-note-modal"),Ce.focus()}),e.appendChild(l),!i.isFinished&&!i.isCancelled){const r=document.createElement("button");r.className="btn-icon",r.innerHTML="✅",r.title="خاتمه جلسه",r.addEventListener("click",t=>{t.stopPropagation(),xe(`جلسه شماره ${c} خاتمه پیدا خواهد کرد!`,()=>{D.endSpecificSession(i.sessionNumber),de(),we(D.info.name,`جلسه ${c} خاتمه یافت.`,{type:"VIEW_SESSIONS"}),He(),xe("جلسه با موفقیت خاتمه یافت. آیا مایل به ایجاد فایل پشتیبان هستید؟",()=>{if(rt){Q("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است.");return}tn(),Q("✅فایل پشتیبان با موفقیت ایجاد شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}),e.appendChild(r)}return e}function Ka(i,c){const e=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="flex-start",e.style.flexGrow="1";const l=new Date(i.startTime).toLocaleDateString("fa-IR"),r=document.createElement("span"),t=document.createElement("div");t.style.display="flex",t.style.gap="5px",t.style.marginTop="5px";const s=new Date(i.startTime).toLocaleDateString("fa-IR",{weekday:"long"}),n=document.createElement("span");if(n.className="type-badge day-badge",n.textContent=s,t.appendChild(n),i.isCancelled){r.textContent=`لغو شده - تاریخ: ${l}`,e.style.cursor="default";const a=document.createElement("span");a.className="type-badge cancelled-badge",a.textContent="لغو شده",t.appendChild(a)}else r.textContent=`جلسه ${c} - تاریخ: ${l}`,e.style.cursor="pointer",e.addEventListener("click",()=>{je(i),zt()});if(e.appendChild(r),i.isFinished){const a=document.createElement("span");a.className="type-badge",a.textContent="خاتمه یافته",a.style.backgroundColor="var(--color-secondary)",t.appendChild(a)}if(i.isMakeup){const a=document.createElement("span");a.className="type-badge",a.textContent="جبرانی",a.style.backgroundColor="var(--color-warning)",a.style.color="var(--color-text-dark)",t.appendChild(a)}return e.appendChild(t),e}function Ja(i,c){const e=document.createElement("li"),l=c.get(i.sessionNumber),r=Ka(i,l);e.appendChild(r);const t=Va(i,l);return e.appendChild(t),e.addEventListener("contextmenu",s=>{const n=[{label:i.isCancelled?"بازگردانی جلسه":"لغو جلسه",icon:"❌",action:()=>{const a=i.isCancelled?"بازگردانی جلسه":"لغو جلسه",m=i.isCancelled?"آیا از بازگردانی این جلسه مطمئن هستید؟":"آیا از لغو این جلسه مطمئن هستید؟ جلسه لغو شده در آمار تاثیری ندارد اما قابل بازگردانی است.";xe(m,()=>{i.isCancelled=!i.isCancelled;const p=i.isCancelled?`جلسه ${l} لغو شد.`:`جلسه لغو شده (تاریخ: ${new Date(i.startTime).toLocaleDateString("fa-IR")}) بازگردانی شد.`;we(D.info.name,p,{type:"VIEW_SESSIONS"}),de(),He(),Q(i.isCancelled?"✅جلسه لغو شد.":"✅جلسه بازگردانی شد.")},{confirmText:a,confirmClass:"btn-warning"})}},{label:"تغییر وضعیت جبرانی",icon:"🔄",action:()=>{D.markAsMakeup(i.sessionNumber),de();const a=i.isMakeup?`جلسه ${l} به عنوان جبرانی علامت‌گذاری شد.`:`جلسه ${l} از حالت جبرانی خارج شد.`;we(D.info.name,a,{type:"VIEW_SESSIONS"}),He()}},{label:"حذف جلسه",icon:"🗑️",className:"danger",action:()=>{const a=i.isCancelled?"لغو شده":l;xe(`آیا از انتقال جلسه ${a} به سطل زباله مطمئن هستید؟`,()=>{const m={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"session",description:`جلسه ${a} از کلاس «${D.info.name}»`,restoreData:{sessionNumber:i.sessionNumber,classId:D.info.scheduleCode}};he.unshift(m),he.length>50&&he.pop(),i.isDeleted=!0,we(D.info.name,`جلسه ${a} به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),de(),He(),Q(`✅ جلسه ${a} به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}];sn(s,n)}),e}function He(){const i=document.getElementById("session-list");if(!D)return;if(i.innerHTML="",D.sessions.length===0){i.innerHTML="<li>هنوز جلسه‌ای شروع نشده است.</li>";return}const c=Xe(D);[...Be(D.sessions)].reverse().forEach(l=>{const r=Ja(l,c);i.appendChild(r)})}function jt(i){if(ft.innerHTML="",i.length>0)i.forEach(c=>{const e=document.createElement("div");e.textContent=c.identity.name,e.addEventListener("click",()=>{ze(c),ft.style.display="none",Yn.value=""}),ft.appendChild(e)}),ft.style.display="block";else if(Yn.value.trim()!==""){const c=document.createElement("div");c.className="no-results",c.textContent="پیدا نشد",ft.appendChild(c),ft.style.display="block"}else ft.style.display="none"}function gn(i){if(it.innerHTML="",i.length>0)i.forEach(c=>{const e=document.createElement("div");if(e.className="global-search-result",c.type==="student"){const l=document.createElement("span");l.className="student-name",l.textContent=c.student.identity.name;const r=document.createElement("span");r.className="class-name",r.textContent=`کلاس: ${c.classroom.info.name}`,e.addEventListener("click",()=>{Pe(c.classroom),ze(c.student),it.style.display="none",Ut.value=""}),r.addEventListener("click",t=>{t.stopPropagation(),Pe(c.classroom),je(null),Xt(c.classroom.liveSession),He(),pe("session-page"),it.style.display="none",Ut.value=""}),e.appendChild(l),e.appendChild(r)}else if(c.type==="classroom"){const l=document.createElement("span");l.className="student-name",l.textContent=`[کلاس] ${c.classroom.info.name}`,e.addEventListener("click",()=>{Pe(c.classroom),je(null),Xt(c.classroom.liveSession),He(),pe("session-page"),it.style.display="none",Ut.value=""}),e.appendChild(l)}it.appendChild(e)}),it.style.display="block";else if(Ut.value.trim()!==""){const c=document.createElement("div");c.className="no-results",c.textContent="پیدا نشد",it.appendChild(c),it.style.display="block"}else it.style.display="none"}function nn(){const i=document.getElementById("trashed-items-list");if(i.innerHTML="",he.length===0){i.innerHTML='<li style="text-align: center; padding: 20px;">سطل زباله خالی است.</li>';return}he.forEach((c,e)=>{const l=document.createElement("li"),r=document.createElement("span");r.textContent=c.description,r.style.flexGrow="1";const t=document.createElement("div");t.className="list-item-buttons";const s=document.createElement("button");s.className="btn-icon",s.innerHTML="🔄",s.title="بازیابی",s.addEventListener("click",()=>{var v;let a=!1,m=null;const p=c.restoreData;switch(c.type){case"classroom":{const h=oe[p.name];h&&!h.isDeleted?m=`کلاسی با نام «${p.name}» از قبل فعال است.`:h&&h.isDeleted&&(h.isDeleted=!1,a=!0);break}case"student":{const h=Object.values(oe).find(g=>g.info.scheduleCode===p.classId),u=h==null?void 0:h.students.find(g=>g.identity.studentId===p.studentId);u&&(u.isDeleted=!1,a=!0);break}case"session":{const h=Object.values(oe).find(g=>g.info.scheduleCode===p.classId),u=h==null?void 0:h.sessions.find(g=>g.sessionNumber===p.sessionNumber);u&&(u.isDeleted=!1,a=!0);break}case"category":{const h=Object.values(oe).find(g=>g.info.scheduleCode===p.classId),u=h==null?void 0:h.categories.find(g=>g.id===p.categoryId);u&&(u.isDeleted=!1,a=!0);break}case"score":{const h=Object.values(oe).find(f=>f.info.scheduleCode===p.classId),u=h==null?void 0:h.students.find(f=>f.identity.studentId===p.studentId),g=(v=u==null?void 0:u.logs.scores[p.skill.toLowerCase()])==null?void 0:v.find(f=>f.id===p.scoreId);g&&(g.isDeleted=!1,a=!0);break}case"note":{const h=Object.values(oe).find(f=>f.info.scheduleCode===p.classId),u=h==null?void 0:h.students.find(f=>f.identity.studentId===p.studentId),g=u==null?void 0:u.profile.notes.find(f=>f.id===p.noteId);g&&(g.isDeleted=!1,a=!0);break}}a?(he.splice(e,1),de(),nn(),c.type==="classroom"&&We(),Q("✅ آیتم با موفقیت بازیابی شد.")):Q(m?`⚠️ ${m}`:"⚠️ آیتم اصلی برای بازیابی یافت نشد.")});const n=document.createElement("button");n.className="btn-icon",n.innerHTML="🔥",n.title="حذف دائمی",n.addEventListener("click",()=>{xe("آیا از حذف دائمی این آیتم مطمئن هستید؟ این عمل غیرقابل بازgشت است.",()=>{const a=c.restoreData,m=v=>Object.values(oe).find(h=>h.info.scheduleCode===v);let p;switch(c.type){case"classroom":delete oe[a.name];break;case"student":p=m(a.classId),Sn({identity:{studentId:a.studentId}},p);break;case"session":p=m(a.classId),p&&Hs(p.info.name,a.sessionNumber);break;case"category":p=m(a.classId),p&&Us(p.info.name,a.categoryId);break;case"score":p=m(a.classId),p&&js(p.info.name,a.studentId,a.skill,a.scoreId);break;case"note":p=m(a.classId),p&&Zs(p.info.name,a.studentId,a.noteId);break}he.splice(e,1),de(),nn(),Q("✅ آیتم برای همیشه حذف شد.")},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),t.appendChild(s),t.appendChild(n),l.appendChild(r),l.appendChild(t),i.appendChild(l)})}function Ya(){const i=document.getElementById("absentees-summary-container");i&&(i.innerHTML=`
        <div id="absentees-summary-box" class="absentees-summary">
            <div class="absentees-summary-header">
                <h4>لیست غایبین جلسه شماره <span id="absentee-summary-session-number"></span></h4>
                <button id="copy-absentees-btn" class="btn-icon" title="کپی لیست غایبین">📋</button>
            </div>
            <div id="absentees-summary-list" class="summary-list"></div>
        </div>
    `)}function Ii(){const i=document.getElementById("absentees-summary-box"),c=document.getElementById("absentees-summary-list"),e=document.getElementById("absentee-summary-session-number");if(!i||!c||!e){console.error("Could not find all absentee summary elements.");return}if(!D||!J){i.classList.remove("visible");return}const l=Be(D.students).filter(t=>{const s=J.studentRecords[t.identity.studentId];return s&&s.attendance==="absent"}),r=Xe(D);e.textContent=r.get(J.sessionNumber),l.length>0?i.classList.add("visible"):i.classList.remove("visible"),c.innerHTML="",l.forEach(t=>{const n=(m=>D.sessions.reduce((p,v)=>{if(v.isDeleted||v.isCancelled)return p;const h=v.studentRecords[m.identity.studentId];return p+(h&&h.attendance==="absent"?1:0)},0))(t),a=document.createElement("span");a.className="summary-name",a.textContent=`${t.identity.name} (غیبت: ${n})`,a.addEventListener("click",()=>{a.classList.add("fading-out"),setTimeout(()=>{J.setAttendance(t.identity.studentId,"present"),de(),dt()},200)}),c.appendChild(a)})}function Xa(){const i=document.getElementById("copy-absentees-btn");if(!i){console.error("Could not find the copy absentees button to attach listener.");return}i.addEventListener("click",()=>{if(!D||!J)return;const c=Be(D.students).filter(r=>{const t=J.studentRecords[r.identity.studentId];return t&&t.attendance==="absent"});if(c.length===0){Q("⚠️لیست غایبین خالی است.");return}const e=r=>D.sessions.reduce((t,s)=>{if(s.isDeleted||s.isCancelled)return t;const n=s.studentRecords[r.identity.studentId];return t+(n&&n.attendance==="absent"?1:0)},0);let l=`لیست غایبین جلسه شماره ${Pa()}:

`;c.forEach(r=>{const t=e(r);l+=`- ${r.identity.name} (تعداد غیبت‌ها: ${t})
`}),navigator.clipboard.writeText(l).then(()=>{Q("✅لیست غایبین با موفقیت کپی شد.")}).catch(r=>{console.error("Failed to copy text: ",r),Q("❌خطا در کپی کردن لیست.")})})}function yn(){const i=document.getElementById("demo-mode-banner");i&&(rt?(i.classList.add("visible"),document.body.classList.add("demo-mode-active")):(i.classList.remove("visible"),document.body.classList.remove("demo-mode-active")))}const Qa=Object.freeze(Object.defineProperty({__proto__:null,_internalShowPage:Jt,addCategoryBtn:ta,addClassBtn:Fi,addNoteModal:ha,addScoreBtn:Ca,addStudentBtn:ji,appHeader:Vn,attendanceListUl:qt,attendanceMassActionsContainer:mn,attendancePage:na,attendancePane:Rt,attendanceSearchInput:Ct,backToSessionsBtn:Hi,backToStudentPageBtn:ya,backupDataBtn:la,breadcrumbContainer:Tt,cancelImportBtn:Qi,cancelNoteBtn:ga,categoryListUl:Zn,categoryModal:Ta,categoryModalCancelBtn:Na,categoryModalSaveBtn:fi,categoryModalTitle:ui,classListHeader:ia,classListUl:Dt,classManagementPage:si,classSaveNoteBtn:pa,closeActiveModal:Ee,closeContextMenu:wt,closeNavBtn:oa,columnMappingPage:Yi,columnSelectDropdown:Gn,confirmColumnBtn:Xi,confirmModalCancelBtn:Jn,confirmModalConfirmBtn:Ht,confirmModalMessage:oi,contextMenu:Et,csvCancelBtn:Vi,csvConfirmBtn:Gi,csvFileInput:Ji,csvPreviewList:qn,csvPreviewPage:qi,customConfirmModal:ua,displayWinner:Fe,finishAttendanceBtn:sa,globalStudentSearchInput:Ut,globalStudentSearchResultsDiv:it,gradedCategoryPillsContainer:ba,hamburgerMenuBtn:aa,handleUndo:pi,importCsvBtn:Ki,initiateBackupProcess:tn,isGradedCheckbox:Ea,massCommentAppendCheckbox:Es,massCommentBtn:Qn,massCommentCancelBtn:Oa,massCommentContent:Kt,massCommentModal:Da,massCommentModalTitle:Aa,massCommentSaveBtn:Ra,massCommentStudentCountMessage:mi,newCategoryModalIsGradedCheckbox:_s,newCategoryModalNameInput:Vt,newCategoryNameInput:ea,newClassNameInput:$i,newNoteContent:Ce,newScoreCommentTextarea:di,newScoreValueInput:va,newStudentNameInput:Ui,openContextMenu:sn,openModal:Me,overlay:ca,pasteArea:ai,processMassHomeworkComment:ns,processPasteBtn:Zi,profileScoresListUl:_a,profileStatsSummaryDiv:wa,quickGradeFormWrapper:Nt,quickGradeSubmitBtn:_t,quickNoteTextarea:tt,quickScoreInput:ot,renderAttendancePage:dt,renderBreadcrumbs:vi,renderClassList:We,renderClassManagementStats:Rn,renderColumnSelector:ki,renderGlobalSearchResults:gn,renderImportPreview:rs,renderLogModal:bi,renderMassCommentControls:Is,renderScoresHistory:_i,renderSearchResults:jt,renderSessionDashboard:zt,renderSessions:He,renderSettingsCategories:Mt,renderSettingsOther:Si,renderSettingsStudentList:ct,renderStudentNotes:Ei,renderStudentStatsList:Re,renderTrashPage:nn,restoreDataBtn:da,restoreFileInput:ri,secureConfirmCancelBtn:ma,secureConfirmCode:li,secureConfirmConfirmBtn:fn,secureConfirmInput:Bt,secureConfirmMessage:ci,secureConfirmModal:fa,selectStudentBtn:nt,selectStudentBtnWrapper:Ot,sessionDashboardPage:za,setAutoDirectionOnInput:Ci,settingsClassNameHeader:ws,settingsPage:Wi,settingsStudentListUl:jn,setupDashboardTabs:hi,showCategoryModal:ts,showClassNoteModal:xs,showCustomConfirm:xe,showMassCommentModal:yi,showMoveStudentModal:ks,showNotification:Q,showPage:pe,showRenameStudentModal:Ss,showRestoreConfirmModal:es,showSecureConfirm:gi,showSettingsPage:Dn,showStudentProfile:ze,showUndoToast:Ma,sideNavMenu:ra,studentSearchInput:Yn,studentSearchResultsDiv:ft,studentStatsHeader:Kn,switchDashboardTab:en,trashedCategoriesList:xa,trashedClassesList:ka,trashedNotesList:La,trashedScoresList:Ba,trashedSessionsList:Ia,trashedStudentsList:Sa,triggerFileDownload:ss,undoBtn:Pi,undoMessage:ii,undoToast:Nn,updateDemoModeBanner:yn},Symbol.toStringTag,{value:"Module"}));function er(){const i=window.location.hash;if(!i||i==="#")return!1;const[c,e]=i.split("?"),l=c.substring(1),r=new URLSearchParams(e),t=r.get("class"),s=parseInt(r.get("session"),10),n=r.get("student"),a=r.get("tab")||"selector";if(t&&oe[t])Pe(oe[t]),s&&D.getSession(s)&&je(D.getSession(s)),n&&D.students.find(m=>m.identity.studentId===n)&&Ge(D.students.find(m=>m.identity.studentId===n));else return!1;switch(l){case"session-page":He(),pe("session-page");break;case"session-dashboard-page":zt(l==="attendance-page"?"attendance":a);break;case"settings-page":ws.textContent=`تنظیمات کلاس: ${D.info.name}`,ct(),Mt(),pe("settings-page");break;case"student-profile-page":zt(a),ze(_e);break;default:return!1}return!0}document.addEventListener("DOMContentLoaded",()=>{const{globalStudentSearchInput:i,newClassNameInput:c,addClassBtn:e,undoBtn:l,newStudentNameInput:r,addStudentBtn:t,pasteArea:s,processPasteBtn:n,csvPreviewList:a,csvConfirmBtn:m,csvCancelBtn:p,importCsvBtn:v,csvFileInput:h,columnSelectDropdown:u,confirmColumnBtn:g,cancelImportBtn:f,newCategoryNameInput:b,addCategoryBtn:y,selectStudentBtn:w,attendancePage:k,finishAttendanceBtn:I,classListHeader:S,studentStatsHeader:O,hamburgerMenuBtn:z,sideNavMenu:H,closeNavBtn:A,overlay:Z,backupDataBtn:ie,restoreDataBtn:E,restoreFileInput:M,confirmModalCancelBtn:d,confirmModalConfirmBtn:F,secureConfirmCancelBtn:ue,secureConfirmConfirmBtn:j,newNoteContent:fe,classSaveNoteBtn:$,cancelNoteBtn:te,studentSearchInput:T,studentSearchResultsDiv:N,isGradedCheckbox:re,categoryModalSaveBtn:ee,categoryModalCancelBtn:Y,massCommentBtn:Te,massCommentCancelBtn:De,massCommentSaveBtn:ge,massCommentContent:ve,massCommentAppendCheckbox:Ae,attendanceSearchInput:Ne}=Qa,Ve=document.getElementById("trash-nav-btn");document.querySelector(".global-search-container .search-icon"),kn(),yn(),er()||(We(),pe("class-management-page"));function o(L,V){const U=document.querySelector(L);if(!U)return;const X=U.querySelector(".search-icon"),ae=U.querySelector(".animated-search-input");!X||!ae||(X.addEventListener("mousedown",le=>{le.preventDefault()}),X.addEventListener("click",()=>{U.classList.contains("search-active")||(U.classList.add("search-active"),ae.focus())}),ae.addEventListener("blur",()=>{setTimeout(()=>{U.classList.remove("search-active"),ae.value="",V&&V([])},150)}))}Ne.addEventListener("input",()=>{const L=Ne.value.toLowerCase().trim(),V=Pn(L);qt.querySelectorAll(".attendance-list-item").forEach(X=>{const ae=X.querySelector(".student-name");if(ae){const le=ae.textContent,se=Ye(le.toLowerCase()),me=se.includes(Ye(L)),be=se.includes(Ye(V));me||be?X.style.display="flex":X.style.display="none"}})}),Y.addEventListener("click",()=>{Ee(),On(null)}),ee.addEventListener("click",()=>{const L=Vt.value.trim(),V=_s.checked;typeof _n=="function"&&_n(L,V)}),window.addEventListener("scroll",wt),document.addEventListener("click",L=>{Et.classList.contains("visible")&&!Et.contains(L.target)&&wt(),T.contains(L.target)||(N.style.display="none");const V=L.target.closest(".log-action-link");if(V&&V.dataset.action)try{const U=JSON.parse(V.dataset.action);gt(U)}catch(U){console.error("Could not parse log action:",U)}}),Ot.addEventListener("click",()=>{(Ot.classList.contains("disabled-wrapper")||nt.disabled)&&(nt.classList.add("shake-animation"),setTimeout(()=>{nt.classList.remove("shake-animation")},200))}),O.addEventListener("click",()=>{const L=new Date().getTime();L-us>500?un(1):un(Cn+1),Ys(L),Cn===5&&(un(0),xe("آیا از صفر کردن تمام شمارنده‌های دانش‌آموزان مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{Ws(),Re(),Q("تمام آمارها صفر شدند ✅.")},{confirmText:"بله",confirmClass:"btn-warning"}))}),S.addEventListener("click",()=>{const L=new Date().getTime();L-ds>500?dn(1):dn(vn+1),Js(L),vn===5&&(dn(0),xe("آیا از ساخت یک کلاس تستی تصادفی مطمئن هستید؟",()=>{function V(){const U=`کلاس تستی ${Object.keys(oe).length+1}`,X=new Hn({name:U,type:"online"});["علی رضایی","مریم حسینی","زهرا احمدی","رضا محمدی","فاطمه کریمی"].forEach(le=>X.addStudent(new cn({name:le}))),oe[U]=X,de(),We()}V(),Q("کلاس تستی با موفقیت ساخته شد ✅!")},{confirmText:"بساز",confirmClass:"btn-success"}))}),ue.addEventListener("click",()=>{Ee(),Qt(null)}),j.addEventListener("click",()=>{typeof wn=="function"&&wn(),Ee(),Qt(null)}),d.addEventListener("click",()=>{Ee(ms)}),F.addEventListener("click",()=>{Ee(fs)}),w.addEventListener("click",()=>{if(ot.value.trim()!==""||tt.value.trim()!==""){Q("⚠️لطفاً ابتدا با دکمه «ثبت»، تغییرات را ذخیره کنید و یا نمره و یادداشت را پاک کنید.");return}if(!D||!J||!qe)return;const L=D.selectNextWinner(qe.name,J);if(L){const V=J.studentRecords[L.identity.studentId];if(V&&V.attendance==="absent"&&L.statusCounters.missedChances++,V&&V.hadIssue){L.statusCounters.missedChances++;const X=qe.name;L.categoryIssues[X]=(L.categoryIssues[X]||0)+1}V&&V.wasOutOfClass&&(L.statusCounters.outOfClassCount=(L.statusCounters.outOfClassCount||0)+1,L.statusCounters.missedChances++);const U={winner:L,categoryName:qe.name};J.winnerHistory.push(U),J.winnerHistory.length>10&&J.winnerHistory.shift(),ht(J.winnerHistory.length-1),J.lastUsedCategoryId=qe.id,J.lastSelectedWinnerId=L.identity.studentId,Re(),setTimeout(()=>Fe(),0),de()}else Q("❌دانش‌آموز واجد شرایطی برای انتخاب یافت نشد.")}),y.addEventListener("click",()=>{if(!D)return;const L=b.value.trim(),V=re.checked;if(!L){alert("⚠️لطفاً نام دسته‌بندی را وارد کنید.");return}const U=D.categories.find(ae=>ae.name.toLowerCase()===L.toLowerCase());if(U)if(U.isDeleted){const ae=D.categories.findIndex(le=>le===U);ae>-1&&D.categories.splice(ae,1)}else{alert("⚠️این دسته‌بندی از قبل وجود دارد.");return}const X=new lt(L,"",V);D.categories.push(X),de(),we(D.info.name,`دسته‌بندی جدید «${L}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),Mt(),b.value="",re.checked=!1}),document.querySelectorAll('#settings-page input[name="class-type-setting"]').forEach(L=>{L.addEventListener("change",()=>{if(!D)return;const V=L.value,U=D.info.type||"in-person";if(V===U)return;const X=se=>se==="online"?"آنلاین":"حضوری",ae=X(U),le=X(V);xe(`آیا از تغییر نوع کلاس از «${ae}» به «${le}» مطمئن هستید؟`,()=>{D.info.type=V,de(),we(D.info.name,`نوع کلاس به «${le}» تغییر یافت.`,{type:"VIEW_CLASS_SETTINGS"}),We(),Q(`✅ نوع کلاس به «${le}» تغییر یافت.`)},{confirmText:"بله",confirmClass:"btn-warning",onCancel:()=>{const se=document.querySelector(`#settings-page input[name="class-type-setting"][value="${U}"]`);se&&(se.checked=!0)}})})}),b.addEventListener("keyup",L=>{L.key==="Enter"&&y.click()}),g.addEventListener("click",()=>{if(!bn){alert("❌خطایی رخ داده است. لطفاً فایل را دوباره انتخاب کنید."),pe("settings-page");return}const L=parseInt(u.value,10),X=bn.split(`
`).slice(1).map(ae=>{var se;return(se=ae.split(",")[L])==null?void 0:se.trim()}).filter(ae=>ae&&ae.length>0);X.length>0?(Wt(X),rs(),pe("csv-preview-page")):alert("هیچ نامی در ستون انتخاب شده پیدا نشد. لطفاً ستون دیگری را امتحان کنید یا فایل خود را بررسی کنید."),ln(null)}),v.addEventListener("click",()=>{h.click()}),h.addEventListener("change",L=>{const V=L.target.files[0];if(!V)return;const U=new FileReader;U.onload=X=>{const ae=X.target.result;ln(ae);const se=ae.split(`
`)[0].split(",");ki(se),pe("column-mapping-page")},U.readAsText(V),L.target.value=null}),f.addEventListener("click",()=>{ln(null),pe("settings-page")}),m.addEventListener("click",()=>{const L=a.querySelectorAll('input[type="checkbox"]:checked');let V=!1;L.forEach(U=>{const X=U.dataset.name,ae=D.students.find(se=>se.identity.name.toLowerCase()===X.toLowerCase());if(ae)if(ae.isDeleted)Sn(ae,D);else{console.log(`دانش‌آموز «${X}» به دلیل تکراری بودن اضافه نشد.`);return}const le=new cn({name:X});D.addStudent(le),D.sessions.length>0&&(Be(D.sessions).filter(se=>se.isFinished&&!se.isCancelled).forEach(se=>{se.setAttendance(le.identity.studentId,"absent")}),ce(le,D),V=!0)}),de(),we(D.info.name,`${L.length} دانش‌آموز جدید از لیست ورودی به کلاس اضافه شدند.`,{type:"VIEW_SESSIONS"}),ct(),V&&ke(L.length),pe("settings-page"),s.value="",Wt([])}),p.addEventListener("click",()=>{Wt([]),pe("settings-page")}),n.addEventListener("click",()=>{const L=s.value.trim();if(!L){alert("کادر متنی خالی است. لطفاً اسامی را وارد کنید.");return}const V=L.split(`
`).map(U=>U.trim()).filter(U=>U.length>0);V.length>0?(Wt(V),rs(),pe("csv-preview-page")):alert("هیچ نام معتبری برای ورود پیدا نشد.")}),r.addEventListener("keyup",L=>{L.key==="Enter"&&t.click()}),t.addEventListener("click",()=>{if(!D)return;const L=r.value.trim();if(!L){alert("لطفاً نام دانش‌آموز را وارد کنید.");return}const V=D.students.find(X=>X.identity.name.toLowerCase()===L.toLowerCase());if(V)if(V.isDeleted)Sn(V,D);else{alert("❌دانش‌آموزی با این نام از قبل در این کلاس وجود دارد.");return}const U=new cn({name:L});D.addStudent(U),D.sessions.length>0&&(Be(D.sessions).filter(X=>X.isFinished&&!X.isCancelled).forEach(X=>{X.setAttendance(U.identity.studentId,"absent")}),ce(U,D),ke(1)),de(),we(D.info.name,`دانش‌آموز «${L}» به کلاس اضافه شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:U.identity.studentId}),ct(),Re(),r.value="",r.focus()}),document.getElementById("new-session-btn").addEventListener("click",()=>{if(D){const L=D.sessions.find(U=>!U.isFinished&&!U.isCancelled&&!U.isDeleted);if(L){Q(`⚠️ جلسه ${L.sessionNumber} هنوز تمام نشده است. لطفاً ابتدا با دکمه ✅ آن را خاتمه دهید.`);return}const V=()=>{const U=X=>{const ae=D.startNewSession();Xt(ae),je(ae),D.students.forEach(me=>{os.setAttendance(me.identity.studentId,"present")}),de();const se=Xe(D).get(ae.sessionNumber);we(D.info.name,`جلسه ${se} شروع شد.`,{type:"VIEW_SESSIONS"}),zt(X?"attendance":"selector")};xe("آیا تمایل به انجام فرآیند حضور و غیاب دارید؟",()=>U(!0),{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success",onCancel:()=>U(!1)})};D.hasSessionToday()?xe("شما امروز یک جلسه برای این کلاس ثبت کرده‌اید. آیا از شروع یک جلسه جدید دیگر مطمئن هستید؟",V,{confirmText:"بله",confirmClass:"btn-warning"}):V()}}),e.addEventListener("click",()=>{const L=c.value.trim(),V=document.querySelector('input[name="class-type"]:checked');if(!L&&!V){Q("⚠️لطفاً نام و نوع کلاس را مشخص کنید.");return}if(!L){Q("⚠️لطفاً نام کلاس را وارد کنید.");return}if(!V){Q("⚠️لطفاً نوع کلاس را انتخاب کنید.");return}if(oe[L]){oe[L].isDeleted?Q("⚠️ کلاسی با این نام در سطل زباله است. ابتدا آن را بازیابی کنید و یا آن را پاک کنید."):Q("⚠️کلاسی با این نام از قبل وجود دارد.");return}const U=V.value,X=new Hn({name:L,type:U});oe[L]=X,de(),we(L,`کلاس «${L}» ایجاد شد.`,{type:"VIEW_SESSIONS"}),We(),Q(`✅ کلاس «${L}» با موفقیت ایجاد شد.`),c.value="",V.checked=!1}),i.addEventListener("input",L=>{const V=L.target.value;if(V.length<2){gn([]);return}const U=V.toLowerCase(),X=Pn(U),ae=[];for(const le in oe){const se=oe[le];if(se.isDeleted)continue;const me=Ye(le.toLowerCase()),be=me.includes(Ye(U)),Ie=me.includes(Ye(X));(be||Ie)&&ae.push({type:"classroom",classroom:se})}for(const le in oe){const se=oe[le];if(se.isDeleted)continue;Be(se.students).filter(be=>{const Ie=Ye(be.identity.name.toLowerCase()),Oe=Ie.includes(Ye(U)),Ft=Ie.includes(Ye(X));return Oe||Ft}).forEach(be=>{ae.push({type:"student",student:be,classroom:se})})}gn(ae)}),c.addEventListener("keyup",L=>{L.key==="Enter"&&e.click()}),l.addEventListener("click",pi),I.addEventListener("click",()=>{en("selector")}),T.addEventListener("input",L=>{const V=L.target.value;if(!V){jt([]);return}const U=V.toLowerCase(),X=Pn(U),le=Be(D.students).filter(se=>{const me=Ye(se.identity.name.toLowerCase()),be=me.includes(Ye(U)),Ie=me.includes(Ye(X));return be||Ie});jt(le)}),T.addEventListener("focus",()=>{T.value&&jt(T.value)}),_t.addEventListener("click",()=>{const L=ot.value,V=tt.value.trim();let U;if(En)U=En.student;else{const ae=J==null?void 0:J.winnerHistory[et];U=ae==null?void 0:ae.winner}if(!U){Q("❌خطا: دانش‌آموز معتبری برای ثبت نمره یافت نشد.");return}const X=qe;if(!U||!X){Q("⚠️لطفاً ابتدا یک دانش‌آموز و یک دسته‌بندی را انتخاب کنید.");return}if(!L){Q("⚠️لطفاً مقدار نمره را وارد کنید.");return}if(L>100||L<0){Q("❌نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}U&&(U.addScore(X.name,parseFloat(L),V),we(D.info.name,`نمره ${L} در ${X.name} برای «${U.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:U.identity.studentId}),de(),Re(),Q(`✅نمره برای ${U.identity.name} در مهارت ${X.name} ثبت شد.`),ot.value="",tt.value="",Fe())});const R=L=>{L.key==="Enter"&&L.ctrlKey&&(L.preventDefault(),_t.click())};ot.addEventListener("keydown",R),tt.addEventListener("keydown",R),te.addEventListener("click",()=>{Ee()}),$.addEventListener("click",()=>{const L=fe.value.trim(),V=hs;Ee(()=>{typeof V=="function"&&V(L)})});const _=document.getElementById("move-student-confirm-btn"),C=document.getElementById("move-student-cancel-btn"),x=document.getElementById("move-student-class-select");C.addEventListener("click",()=>{Ee()}),_.addEventListener("click",()=>{const L=x.value,V=oe[L],{studentToMove:U,sourceClassForMove:X}=Oi;if(!U||!X||!V){Q("خطایی رخ داد. لطفاً دوباره امتحان کنید⚠️.","error"),Ee();return}const ae=Ps(U,X,V);ae.success?(we(X.info.name,`دانش‌آموز «${U.identity.name}» به کلاس «${L}» منتقل شد.`,{type:"VIEW_SESSIONS"}),we(L,`دانش‌آموز «${U.identity.name}» از کلاس «${X.info.name}» به این کلاس منتقل شد.`,{type:"VIEW_SESSIONS"}),de(),ct(),Re(),dt(),Q(`دانش‌آموز «${U.identity.name}» با موفقیت به کلاس «${L}» منتقل شد✅.`)):Q(ae.message,"error"),Ee()}),z.addEventListener("click",()=>{H.style.width="300px",Z.classList.add("modal-visible")}),z.addEventListener("click",()=>{H.style.width="300px",Z.classList.add("modal-visible")});const W=document.getElementById("header-settings-btn");W&&W.addEventListener("click",()=>{D&&Dn(D)}),A.addEventListener("click",G),A.addEventListener("click",G),Z.addEventListener("click",G),Ve.addEventListener("click",()=>{nn(),pe("trash-page"),G()}),document.getElementById("demo-mode-btn").addEventListener("click",()=>{rt?ne():(G(),xe("شما در حال ورود به حالت نمایش (Demo) هستید. در این حالت، هیچ‌کدام از تغییرات شما ذخیره نخواهد شد. آیا ادامه می‌دهید؟",()=>{qs(),yn(),G()},{confirmText:"تایید",confirmClass:"btn-warning",onCancel:G}))});const B=document.getElementById("exit-demo-btn");B&&B.addEventListener("click",()=>{rt&&ne()}),ie.addEventListener("click",()=>{if(rt){Q("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است."),G();return}G(),tn()}),E.addEventListener("click",()=>{if(rt){Q("⚠️ بازیابی اطلاعات در حالت نمایش (Demo) غیرفعال است."),G();return}M.click(),G()}),M.addEventListener("change",L=>{const V=L.target.files[0];if(!V)return;const U=new FileReader;U.onload=async X=>{const ae=X.target.result;try{const le=JSON.parse(ae);if(le.metadata&&le.data)es(le);else{const se=le.classrooms||le,me=le.trashBin||[];xe("آیا از بازیابی اطلاعات مطمئن هستید؟ تمام داده‌های فعلی شما بازنویسی خواهد شد.",()=>{St(se),Bn(me),Zt({lastRestoreTimestamp:new Date().toISOString()}),de(),We(),pe("class-management-page"),Q("✅اطلاعات با موفقیت بازیابی شد.")},{confirmText:"بازیابی کن",confirmClass:"btn-warning"})}}catch{try{const be=(await new Ds().loadAsync(ae,{base64:!0})).file("backup.json");if(!be)throw new Error("فایل backup.json در فایل پشتیبان یافت نشد.");const Ie=await be.async("string"),Oe=JSON.parse(Ie);if(Oe.metadata&&Oe.metadata.version==="2.0-b64")es(Oe);else throw new Error("فایل پشتیبان معتبر نیست (نسخه نامشخص).")}catch(se){Q("❌خطا در خواندن فایل. لطفاً فایل پشتیبان معتبر انتخاب کنید."),console.error("Restore error (zip/base64):",se)}}},U.readAsText(V),L.target.value=null}),window.addEventListener("popstate",L=>{if(mt){Ee(null,!0);return}if(wt(),L.state){const{pageId:V,currentClassName:U,selectedSessionNumber:X,selectedStudentId:ae}=L.state;U&&(Pe(oe[U]),X&&je(D.getSession(X)),ae&&Ge(D.students.find(le=>le.identity.studentId===ae))),V==="session-page"?(He(),Jt(V)):V==="student-profile-page"?(He(),pe("session-page"),ze(_e)):Jt(V)}else Pe(null),je(null),Ge(null),Jt("class-management-page")}),document.addEventListener("keydown",L=>{var X;const V=document.activeElement;if(!["INPUT","TEXTAREA","SELECT"].includes(V.tagName)){if(L.key.toLowerCase()==="o"&&L.shiftKey&&si.classList.contains("active")&&(L.preventDefault(),ri.click()),L.key==="Escape"){if(Et.classList.contains("visible")){wt();return}if(mt){Ee();return}switch((X=document.querySelector(".page.active"))==null?void 0:X.id){case"csv-preview-page":case"column-mapping-page":pe("settings-page");break;case"student-profile-page":Ge(null),pe(J?"student-page":"session-page");break;case"attendance-page":pe("student-page");break;case"student-page":je(null),He(),pe("session-page");break;case"settings-page":case"session-page":Pe(null),pe("class-management-page");break}return}if(J){const ae=L.key.toLowerCase();switch(" ascfg".includes(ae)&&L.preventDefault(),ae){case" ":w.click();break;case"a":k.classList.contains("active")?history.back():(dt(),pe("attendance-page"));break;case"s":document.getElementById("session-page").classList.contains("active")&&history.back();break;case"c":document.querySelector(".back-to-classes-btn").click();break;case"f":const le=document.querySelector(".action-column .search-icon");le&&le.click();break;case"g":if(studentProfilePage.classList.contains("active"))history.back();else{const se=J.lastSelectedWinnerId;if(se){const me=D.students.find(be=>be.identity.studentId===se);me&&(Ge(me),(void 0)(),pe("student-profile-page"))}else Q("⚠️ابتدا یک نفر را انتخاب کنید تا پروفایل او نمایش داده شود.")}break;case"arrowleft":{const se=document.querySelector('button[title="برنده قبلی"]');se&&!se.disabled&&(L.preventDefault(),se.click());break}case"arrowright":{const se=document.querySelector('button[title="برنده بعدی"]');se&&!se.disabled&&(L.preventDefault(),se.click());break}}}}});function G(){H.style.width="0",Z.classList.add("modal-closing"),setTimeout(()=>{Z.classList.remove("modal-visible","modal-closing")},300)}function ne(){xe("آیا از خروج از حالت نمایش (Demo) مطمئن هستید؟ با خروج، تمام تغییرات آزمایشی شما حذف شده و داده‌های اصلی شما بازیابی خواهند شد.",()=>{Gs(),Pe(null),je(null),Ge(null),We(),pe("class-management-page"),yn(),G()},{confirmText:"خروج",confirmClass:"btn-success"})}o(".global-search-container .animated-search-container",gn),o(".action-column-header .animated-search-container",jt),nr(),[Ce,di,tt,ai].forEach(L=>{L&&Ci(L)});function ce(L,V){const U=Be(V.students).filter(Le=>Le.identity.studentId!==L.identity.studentId);if(U.length===0)return;const X=U.reduce((Le,$e)=>$e.statusCounters.totalSelections>Le.statusCounters.totalSelections?$e:Le,U[0]);if(!X||X.statusCounters.totalSelections===0)return;L.categoryCounts=JSON.parse(JSON.stringify(X.categoryCounts)),L.statusCounters.totalSelections=X.statusCounters.totalSelections;const ae=U.reduce((Le,$e)=>Le+$e.statusCounters.totalSelections,0),le=U.reduce((Le,$e)=>Le+($e.statusCounters.missedChances||0),0),se=ae>0?le/ae:0;L.statusCounters.missedChances=Math.round(L.statusCounters.totalSelections*se);const me=Be(V.categories),be={};me.forEach(Le=>{const $e=U.reduce(($n,Fn)=>$n+(Fn.categoryCounts[Le.name]||0),0),Mn=U.reduce(($n,Fn)=>$n+(Fn.categoryIssues[Le.name]||0),0);be[Le.name]=$e>0?Mn/$e:0}),me.forEach(Le=>{const $e=L.categoryCounts[Le.name]||0,Mn=be[Le.name]||0;L.categoryIssues[Le.name]=Math.round($e*Mn)});const Ie=V.liveSession;Ie?L.onboardingSession=Ie.sessionNumber:L.onboardingSession=V.sessions.length+1;const Oe=Be(V.sessions).filter(Le=>Le.isFinished&&!Le.isCancelled),Ft="📝 یادداشت خودکار سیستم",xi=`این دانش‌آموز  از جلسه شماره ${Oe.length} به کلاس اضافه شد. آمار مشارکت او بر اساس فعال‌ترین دانش‌آموز و آمار «فرصت از دست رفته» او بر اساس میانگین کلاس ثبت گردید:`,Lt=[];L.statusCounters.totalSelections>0&&Lt.push(`کل انتخاب‌ها: ${L.statusCounters.totalSelections}`),L.statusCounters.missedChances>0&&Lt.push(`فرصت‌های از دست رفته: ${L.statusCounters.missedChances}`);for(const Le in L.categoryCounts){const $e=L.categoryCounts[Le];$e>0&&Lt.push(`انتخاب در «${Le}»: ${$e}`)}for(const Le in L.categoryIssues){const $e=L.categoryIssues[Le];$e>0&&Lt.push(`مشکل در «${Le}»: ${$e}`)}if(Lt.length>0){const Le=`${Ft}
${xi}

- ${Lt.join(`
- `)}`;L.addNote(Le)}}function ke(L){const U=`چون این کلاس جلسات برگزار شده دارد، برای ${L>1?"دانش‌آموزان جدید":"دانش‌آموز جدید"} آمار پایه‌ای (متناسب با سایر دانش‌آموزان) ثبت شد تا در فرایند انتخاب اختلالی ایجاد نشود.`;xe(U,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}const ye="10.11.0";document.getElementById("app-version").textContent=`نسخه ${ye}`;function Ue(){console.log("Starting universal backfill for writing scores...");let L=0;for(const V in oe){const U=oe[V];if(U.isDeleted)continue;let X=0;Be(U.students).forEach(le=>{const se=le.logs.scores;if(!(se&&se.writing&&se.writing.length>0)){let be=-1;for(const Ie in se)Ie!=="writing"&&se[Ie].forEach(Oe=>{Oe.value>be&&(be=Oe.value)});if(be>-1){const Ie=`Automatically assigned based on the highest score (${be}) from other skills.`;le.addScore("Writing",be,Ie),X++}}}),X>0&&(console.log(`Updated ${X} student(s) in class: ${U.info.name}.`),L+=X)}L>0?(de(),console.log(`Update complete. A total of ${L} student(s) were updated across all classes. Data saved.`),document.getElementById("student-page").classList.contains("active")&&Re()):console.log("No students needed updating in any class.")}window.backfillWritingScoresForAll=Ue;function pt(){console.log("Starting backfill for 'outOfClassCount' and 'wasOutOfClass' properties...");let L=0,V=0;const U=localStorage.getItem("teacherAssistantData_v2");if(!U){console.log("No data found in localStorage. Nothing to do.");return}const X=JSON.parse(U);for(const ae in X){const le=X[ae];le.students&&le.students.forEach(se=>{se.statusCounters&&typeof se.statusCounters.outOfClassCount>"u"&&(se.statusCounters.outOfClassCount=0,L++)}),le.sessions&&le.sessions.forEach(se=>{if(se.studentRecords)for(const me in se.studentRecords){const be=se.studentRecords[me];typeof be.wasOutOfClass>"u"&&(be.wasOutOfClass=!1,V++)}})}localStorage.setItem("teacherAssistantData_v2",JSON.stringify(X)),console.log(`Backfill complete. Updated ${L} students and ${V} session records. Data saved.`),kn(),D&&Re()}window.backfillExitCounters=pt;function Je(){console.log("🧹 Starting orphaned data cleanup...");let L=0;for(const V in oe){const U=oe[V];if(U.isDeleted)continue;let X=!1;const ae=new Set(U.students.filter(me=>!me.isDeleted).map(me=>me.identity.studentId)),le=new Map(U.students.map(me=>[me.identity.studentId,me.identity.name])),se=[];U.sessions.forEach(me=>{if(me.isDeleted)return;const be=[];for(const Ie in me.studentRecords)if(!ae.has(Ie)){const Oe=le.get(Ie)||"Unknown/Deleted";be.push(`  - Removed student record for: ${Oe} (ID: ${Ie})`),delete me.studentRecords[Ie],L++,X=!0}for(const Ie in me.lastWinnerByCategory){const Oe=me.lastWinnerByCategory[Ie];if(!ae.has(Oe)){const Ft=le.get(Oe)||"Unknown/Deleted";be.push(`  - Removed '${Ie}' last winner: ${Ft} (ID: ${Oe})`),delete me.lastWinnerByCategory[Ie],L++,X=!0}}if(me.lastSelectedWinnerId&&!ae.has(me.lastSelectedWinnerId)){const Ie=me.lastSelectedWinnerId,Oe=le.get(Ie)||"Unknown/Deleted";be.push(`  - Cleared 'lastSelectedWinnerId': ${Oe} (ID: ${Ie})`),me.lastSelectedWinnerId=null,L++,X=!0}if(be.length>0){const Oe=Xe(U).get(me.sessionNumber)||`(#${me.sessionNumber})`;se.push({sessionDisplayNumber:Oe,logs:be})}}),X&&(console.group(`➡️ Class: ${V}`),se.forEach(me=>{console.groupCollapsed(`  Session ${me.sessionDisplayNumber}`),me.logs.forEach(be=>console.warn(be)),console.groupEnd()}),console.groupEnd())}L>0?(de(),console.log(`✅ Cleanup complete! Found and removed ${L} orphaned references. Data saved.`)):console.log("✅ No orphaned data found. Your data is clean!")}window.cleanupOrphanedData=Je;function gt(L){if(!L||!L.classroomName)return;const V=oe[L.classroomName];if(!V){Q("⚠️ کلاس مربوط به این گزارش یافت نشد.");return}Pe(V),Ee(),setTimeout(()=>{switch(L.type){case"VIEW_STUDENT_PROFILE":{const U=V.students.find(X=>X.identity.studentId===L.studentId);U?ze(U):Q("⚠️ دانش‌آموز مورد نظر یافت نشد.");break}case"VIEW_TRASH":nn(),pe("trash-page");break;case"VIEW_SESSIONS":He(),pe("session-page");break;case"VIEW_CLASS_NOTE":xs(V);break;case"VIEW_CLASS_SETTINGS":Dn(V);break}},300)}Te.addEventListener("click",()=>{yi()}),De.addEventListener("click",()=>{Ee()}),ge.addEventListener("click",()=>{const L=ve.value.trim(),V=Ae.checked;if(!L){Es.style.display==="flex"?xe("کادر یادداشت خالی است. آیا مطمئنید که می‌خواهید یادداشت‌های قبلی دانش‌آموزان انتخاب‌شده را پاک کنید؟",()=>{Ee(),ns("",!1)},{confirmText:"پاک کردن",confirmClass:"btn-warning"}):Q("⚠️ لطفاً متن یادداشت را وارد کنید.");return}Ee(()=>{ns(L,V)})});const Se=document.getElementById("screen-saver-overlay"),yt=document.getElementById("screen-saver-toggle");let bt;const Qe=2*60*1e3,$t=["mousemove","keypress","scroll","click","touchstart"];function zn(){Se.classList.add("visible")}function an(){Se.classList.contains("visible")&&Se.classList.remove("visible")}function It(){an(),clearTimeout(bt),bt=setTimeout(zn,Qe)}function vt(L){L.preventDefault(),L.stopPropagation(),setTimeout(It,0)}function ut(){It(),$t.forEach(V=>window.addEventListener(V,It)),Se.addEventListener("click",vt),Se.addEventListener("touchstart",vt);const L="10.11.0";{const V=document.getElementById("screen-saver-version");V&&(V.textContent=`v${L}`)}}function xt(){clearTimeout(bt),an(),$t.forEach(L=>window.removeEventListener(L,It)),Se.removeEventListener("click",vt),Se.removeEventListener("touchstart",vt)}yt.checked=Ze.isScreenSaverEnabled,Ze.isScreenSaverEnabled&&ut(),yt.addEventListener("change",L=>{L.target.checked?(Zt({isScreenSaverEnabled:!0}),ut()):(G(),L.preventDefault(),xe(`نکته:
محافظ صفحه در تلفن های همراه جدید کمک می کند که دستگاه باطری کمتری مصرف کند و به دلیل ثابت ماندن صفحه نمایش در گوشی های قدیمی تر، صفحه نمایش دچار ماندگی رد پیکسل نگردد. آیا مطمئن هستید که می خواهید این ویژگی را غیر فعال کنید؟`,()=>{L.target.checked=!1,Zt({isScreenSaverEnabled:!1}),xt(),Q("توصیه می شود زمان خاموش شدن صفحه نمایش گوشی خود را به حداقل دو دقیقه تغییر دهید تا در استفاده های طولانی مدت صفحه نمایش گوشی اصطحلاک کمتری را تجربه کند",7e3)},{confirmText:"بله، غیرفعال کن",cancelText:"لغو",onCancel:()=>{L.target.checked=!0}}))})});function tr(i,c){if(!J||J.isFinished){Q("⚠️ امکان لغو انتخاب در جلسه خاتمه یافته وجود ندارد.");return}const e=J.winnerHistory;if(!(et===e.length-1)||e.length===0){Q("⚠️ فقط آخرین انتخاب قابل لغو است.");return}if(e[e.length-1].winner.identity.studentId!==i.identity.studentId){console.error("Undo mismatch!");return}xe(`آیا از حذف انتخاب «${i.identity.name}» برای «${c}» مطمئن هستید؟ آمار این انتخاب بازگردانی خواهد شد.`,()=>{const r=J.winnerHistory,t=r.pop();if(!t)return;const s=t.winner,n=t.categoryName,a=s.identity.studentId;s.statusCounters.totalSelections=Math.max(0,s.statusCounters.totalSelections-1),s.categoryCounts[n]&&(s.categoryCounts[n]=Math.max(0,s.categoryCounts[n]-1));const m=J.studentRecords[a];m&&m.selections[n]&&(m.selections[n]=Math.max(0,m.selections[n]-1));let p=null;for(let v=r.length-1;v>=0;v--)if(r[v].categoryName===n){p=r[v].winner.identity.studentId;break}p?J.lastWinnerByCategory[n]=p:delete J.lastWinnerByCategory[n],ht(r.length-1),Re(),Fe(),de(),Q(`✅ انتخاب «${s.identity.name}» لغو شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}function nr(){const i=document.getElementById("session-dashboard-page"),c=document.getElementById("student-stats-table-container");if(!i)return;let e=0,l=0;i.addEventListener("touchstart",t=>{if(c&&c.contains(t.target)){const s=t.target.closest("td, th");s&&s.parentElement.firstElementChild===s?e=t.changedTouches[0].screenX:e=0}else e=t.changedTouches[0].screenX},{passive:!0}),i.addEventListener("touchend",t=>{e!==0&&(l=t.changedTouches[0].screenX,r())});function r(){const s=e-l;Math.abs(s)>100&&(document.getElementById("selector-tab-btn").classList.contains("active")?(pe("session-dashboard-page",{tab:"attendance"}),en("attendance")):(pe("session-dashboard-page",{tab:"selector"}),en("selector"))),e=0,l=0}}
