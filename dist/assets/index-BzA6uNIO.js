(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))l(r);new MutationObserver(r=>{for(const t of r)if(t.type==="childList")for(const n of t.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&l(n)}).observe(document,{childList:!0,subtree:!0});function e(r){const t={};return r.integrity&&(t.integrity=r.integrity),r.referrerPolicy&&(t.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?t.credentials="include":r.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function l(r){if(r.ep)return;r.ep=!0;const t=e(r);fetch(r.href,t)}})();class un{constructor(o){this.identity={name:o.name,studentId:o.studentId||`id_${new Date().getTime()}_${Math.random()}`,branchName:o.branchName||null,ageGroup:o.ageGroup||"adult",level:o.level||null,contact:{social:o.socialContact||null,parent:o.parentContact||null}},this.isDeleted=!1,this.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0,outOfClassCount:0},this.categoryCounts={},this.categoryIssues={},this.logs={parentContacts:[],scores:{},discipline:{},sessionHistory:{}},this.profile={notes:[],tags:[]},this.finalClassActivityScore=null,this.onboardingSession=null}addScore(o,e,l){if(e>100||e<0){console.log("نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}const r=o.toLowerCase();this.logs.scores[r]||(this.logs.scores[r]=[]);const t=new Ai(o,e,l);this.logs.scores[r].push(t)}addNote(o,e=null){const l=new Oi(o,e);this.profile.notes.push(l)}getOverallAverageScore(){let o=0,e=0;for(const r in this.logs.scores)this.logs.scores[r].forEach(t=>{t.isDeleted||(o+=t.value,e++)});if(e===0)return null;const l=o/e;return Math.round(l*100)/100}}class Ai{constructor(o,e,l=""){this.id=`score_${new Date().getTime()}`,this.skill=o,this.value=e,this.timestamp=new Date,this.comment=l,this.isDeleted=!1}}class Oi{constructor(o,e=null){this.id=`note_${new Date().getTime()}`,this.timestamp=new Date,this.content=o,this.isDeleted=!1,this.source=e}}class jn{constructor(o="complete",e=""){this.status=o,this.comment=e,this.timestamp=new Date}}class Os{constructor(o){this.sessionNumber=o,this.startTime=new Date,this.note="",this.isDeleted=!1,this.endTime=null,this.isFinished=!1,this.isMakeup=!1,this.isCancelled=!1,this.studentRecords={},this.lastWinnerByCategory={},this.lastUsedCategoryId=null,this.lastSelectedWinnerId=null,this.winnerHistory=[]}end(){this.isFinished=!0,this.endTime=new Date}markAsMakeup(){this.isMakeup=!this.isMakeup}initializeStudentRecord(o){this.studentRecords[o]||(this.studentRecords[o]={attendance:"present",homework:new jn,selections:{},hadIssue:!1,wasOutOfClass:!1})}setAttendance(o,e){this.initializeStudentRecord(o),this.studentRecords[o].attendance=e}setHomeworkStatus(o,e){this.initializeStudentRecord(o),this.studentRecords[o].homework.status=e}selectNextWinner(o,e,l){if(!e||e.length===0)return console.log("هیچ دانش‌آموزی در کلاس برای انتخاب وجود ندارد."),null;const r=this.lastWinnerByCategory[o];let t=e.filter(h=>h.identity.studentId!==r&&!h.isDeleted);if(t.length===0&&(t=e),t.length===0)return null;const n=(h,f)=>h.categoryCounts[f]||0,a=Math.min(...t.map(h=>n(h,o))),i=t.filter(h=>n(h,o)===a);let u;if(i.length===1)u=i[0];else if(i.length>1){const h=l.filter(y=>!y.isDeleted&&y.name!==o).map(y=>y.name),f=i.map(y=>{const g=h.reduce((w,k)=>w+n(y,k),0);return{student:y,otherCategoriesTotal:g}}),b=Math.min(...f.map(y=>y.otherCategoriesTotal)),m=f.filter(y=>y.otherCategoriesTotal===b).map(y=>y.student);m.length===1?u=m[0]:u=m[Math.floor(Math.random()*m.length)]}else u=t[Math.floor(Math.random()*t.length)];const p=u.identity.studentId;this.initializeStudentRecord(p);const v=(this.studentRecords[p].selections[o]||0)+1;return this.studentRecords[p].selections[o]=v,u.statusCounters.totalSelections++,u.categoryCounts[o]=(u.categoryCounts[o]||0)+1,this.lastWinnerByCategory[o]=p,u}}class Zn{constructor(o){this.info={name:o.name||"NotNamed",teacherName:o.teacherName||null,type:o.type||"in-person",term:o.term||null,scheduleText:o.scheduleText||null,level:o.level||null,creationDate:o.creationDate?new Date(o.creationDate):new Date,scheduleCode:o.scheduleCode||`code_${new Date().getTime()}`,scheduleDays:o.scheduleDays||[],scheduleStartTime:o.scheduleStartTime||null,scheduleEndTime:o.scheduleEndTime||null},this.students=[],this.sessions=[],this.note="",this.isDeleted=!1,this.categories=[new dt("Vocabulary","Questions about words and meanings."),new dt("Grammar","Questions about sentence structure and rules."),new dt("Listening",void 0,!0),new dt("Speaking",void 0,!0),new dt("Reading",void 0,!0),new dt("Writing",void 0,!0)],this.futurePlans={}}addStudent(o){this.students.push(o)}removeStudent(o){this.students=this.students.filter(e=>e.identity.studentId!==o)}startNewSession(){const o=this.sessions.length+1,e=new Os(o);return this.sessions.push(e),e}endSpecificSession(o){const e=this.getSession(o);return e&&!e.isFinished?(e.end(),!0):!1}getSession(o){return this.sessions.find(e=>e.sessionNumber===o)}markAsMakeup(o){const e=this.getSession(o);e&&e.markAsMakeup()}planForSession(o,e){this.futurePlans[o]=e}hasSessionToday(){const o=new Date().toDateString();return this.sessions.some(e=>!e.isDeleted&&e.startTime.toDateString()===o)}selectNextWinner(o,e){return e?e.selectNextWinner(o,this.students,this.categories):null}get liveSession(){for(let o=this.sessions.length-1;o>=0;o--)if(!this.sessions[o].isFinished)return this.sessions[o];return null}endLiveSession(){const o=this.liveSession;return o?(o.end(),!0):!1}calculateFinalStudentScore(o){const e=o.logs.scores,l=["reading","writing"];for(const h of l)if(!e[h]||e[h].length===0)return null;const r=e.listening&&e.listening.length>0,t=e.speaking&&e.speaking.length>0;if(!r&&!t)return null;const n=h=>e[h].reduce((b,m)=>b+m.value,0)/e[h].length;let a;r&&t?a=(n("listening")+n("speaking"))/2:r?a=n("listening"):a=n("speaking");const i=n("reading"),u=n("writing"),v=(a*3+i*2+u*1)/6;return Math.trunc(v*10)/10}assignAllFinalScores(){let o=0,e=[];console.log("شروع عملیات محاسبه نمره نهایی برای تمام دانش‌آموزان..."),this.students.forEach(r=>{const t=this.calculateFinalStudentScore(r);t!==null?(r.finalClassActivityScore=t,o++):(r.finalClassActivityScore=null,e.push(r.identity.name))});const l=e.length;console.log(`عملیات پایان یافت. تعداد نمرات موفق: ${o} | تعداد ناموفق (نمرات ناقص): ${l}`),l>0&&(console.log("اسامی دانش‌آموزانی که نمراتشان ناقص است:"),e.forEach(r=>console.log(`- ${r}`)))}}class dt{constructor(o,e="",l=!1){this.id=`cat_${new Date().getTime()}_${Math.random()}`,this.name=o,this.description=e,this.isDeleted=!1,this.isGradedCategory=l,this.isDeleted=!1}}var ln=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Ri(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}function dn(s){throw new Error('Could not dynamically require "'+s+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Rs={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/(function(s,o){(function(e){s.exports=e()})(function(){return function e(l,r,t){function n(u,p){if(!r[u]){if(!l[u]){var v=typeof dn=="function"&&dn;if(!p&&v)return v(u,!0);if(a)return a(u,!0);var h=new Error("Cannot find module '"+u+"'");throw h.code="MODULE_NOT_FOUND",h}var f=r[u]={exports:{}};l[u][0].call(f.exports,function(b){var m=l[u][1][b];return n(m||b)},f,f.exports,e,l,r,t)}return r[u].exports}for(var a=typeof dn=="function"&&dn,i=0;i<t.length;i++)n(t[i]);return n}({1:[function(e,l,r){var t=e("./utils"),n=e("./support"),a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";r.encode=function(i){for(var u,p,v,h,f,b,m,y=[],g=0,w=i.length,k=w,I=t.getTypeOf(i)!=="string";g<i.length;)k=w-g,v=I?(u=i[g++],p=g<w?i[g++]:0,g<w?i[g++]:0):(u=i.charCodeAt(g++),p=g<w?i.charCodeAt(g++):0,g<w?i.charCodeAt(g++):0),h=u>>2,f=(3&u)<<4|p>>4,b=1<k?(15&p)<<2|v>>6:64,m=2<k?63&v:64,y.push(a.charAt(h)+a.charAt(f)+a.charAt(b)+a.charAt(m));return y.join("")},r.decode=function(i){var u,p,v,h,f,b,m=0,y=0,g="data:";if(i.substr(0,g.length)===g)throw new Error("Invalid base64 input, it looks like a data url.");var w,k=3*(i=i.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(i.charAt(i.length-1)===a.charAt(64)&&k--,i.charAt(i.length-2)===a.charAt(64)&&k--,k%1!=0)throw new Error("Invalid base64 input, bad content length.");for(w=n.uint8array?new Uint8Array(0|k):new Array(0|k);m<i.length;)u=a.indexOf(i.charAt(m++))<<2|(h=a.indexOf(i.charAt(m++)))>>4,p=(15&h)<<4|(f=a.indexOf(i.charAt(m++)))>>2,v=(3&f)<<6|(b=a.indexOf(i.charAt(m++))),w[y++]=u,f!==64&&(w[y++]=p),b!==64&&(w[y++]=v);return w}},{"./support":30,"./utils":32}],2:[function(e,l,r){var t=e("./external"),n=e("./stream/DataWorker"),a=e("./stream/Crc32Probe"),i=e("./stream/DataLengthProbe");function u(p,v,h,f,b){this.compressedSize=p,this.uncompressedSize=v,this.crc32=h,this.compression=f,this.compressedContent=b}u.prototype={getContentWorker:function(){var p=new n(t.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new i("data_length")),v=this;return p.on("end",function(){if(this.streamInfo.data_length!==v.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),p},getCompressedWorker:function(){return new n(t.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},u.createWorkerFrom=function(p,v,h){return p.pipe(new a).pipe(new i("uncompressedSize")).pipe(v.compressWorker(h)).pipe(new i("compressedSize")).withStreamInfo("compression",v)},l.exports=u},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,l,r){var t=e("./stream/GenericWorker");r.STORE={magic:"\0\0",compressWorker:function(){return new t("STORE compression")},uncompressWorker:function(){return new t("STORE decompression")}},r.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,l,r){var t=e("./utils"),n=function(){for(var a,i=[],u=0;u<256;u++){a=u;for(var p=0;p<8;p++)a=1&a?3988292384^a>>>1:a>>>1;i[u]=a}return i}();l.exports=function(a,i){return a!==void 0&&a.length?t.getTypeOf(a)!=="string"?function(u,p,v,h){var f=n,b=h+v;u^=-1;for(var m=h;m<b;m++)u=u>>>8^f[255&(u^p[m])];return-1^u}(0|i,a,a.length,0):function(u,p,v,h){var f=n,b=h+v;u^=-1;for(var m=h;m<b;m++)u=u>>>8^f[255&(u^p.charCodeAt(m))];return-1^u}(0|i,a,a.length,0):0}},{"./utils":32}],5:[function(e,l,r){r.base64=!1,r.binary=!1,r.dir=!1,r.createFolders=!0,r.date=null,r.compression=null,r.compressionOptions=null,r.comment=null,r.unixPermissions=null,r.dosPermissions=null},{}],6:[function(e,l,r){var t=null;t=typeof Promise<"u"?Promise:e("lie"),l.exports={Promise:t}},{lie:37}],7:[function(e,l,r){var t=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",n=e("pako"),a=e("./utils"),i=e("./stream/GenericWorker"),u=t?"uint8array":"array";function p(v,h){i.call(this,"FlateWorker/"+v),this._pako=null,this._pakoAction=v,this._pakoOptions=h,this.meta={}}r.magic="\b\0",a.inherits(p,i),p.prototype.processChunk=function(v){this.meta=v.meta,this._pako===null&&this._createPako(),this._pako.push(a.transformTo(u,v.data),!1)},p.prototype.flush=function(){i.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},p.prototype.cleanUp=function(){i.prototype.cleanUp.call(this),this._pako=null},p.prototype._createPako=function(){this._pako=new n[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var v=this;this._pako.onData=function(h){v.push({data:h,meta:v.meta})}},r.compressWorker=function(v){return new p("Deflate",v)},r.uncompressWorker=function(){return new p("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(e,l,r){function t(f,b){var m,y="";for(m=0;m<b;m++)y+=String.fromCharCode(255&f),f>>>=8;return y}function n(f,b,m,y,g,w){var k,I,S=f.file,O=f.compression,M=w!==u.utf8encode,U=a.transformTo("string",w(S.name)),A=a.transformTo("string",u.utf8encode(S.name)),G=S.comment,ie=a.transformTo("string",w(G)),E=a.transformTo("string",u.utf8encode(G)),z=A.length!==S.name.length,d=E.length!==G.length,F="",ue="",j="",fe=S.dir,$=S.date,te={crc32:0,compressedSize:0,uncompressedSize:0};b&&!m||(te.crc32=f.crc32,te.compressedSize=f.compressedSize,te.uncompressedSize=f.uncompressedSize);var T=0;b&&(T|=8),M||!z&&!d||(T|=2048);var D=0,re=0;fe&&(D|=16),g==="UNIX"?(re=798,D|=function(Y,Te){var Ne=Y;return Y||(Ne=Te?16893:33204),(65535&Ne)<<16}(S.unixPermissions,fe)):(re=20,D|=function(Y){return 63&(Y||0)}(S.dosPermissions)),k=$.getUTCHours(),k<<=6,k|=$.getUTCMinutes(),k<<=5,k|=$.getUTCSeconds()/2,I=$.getUTCFullYear()-1980,I<<=4,I|=$.getUTCMonth()+1,I<<=5,I|=$.getUTCDate(),z&&(ue=t(1,1)+t(p(U),4)+A,F+="up"+t(ue.length,2)+ue),d&&(j=t(1,1)+t(p(ie),4)+E,F+="uc"+t(j.length,2)+j);var ee="";return ee+=`
\0`,ee+=t(T,2),ee+=O.magic,ee+=t(k,2),ee+=t(I,2),ee+=t(te.crc32,4),ee+=t(te.compressedSize,4),ee+=t(te.uncompressedSize,4),ee+=t(U.length,2),ee+=t(F.length,2),{fileRecord:v.LOCAL_FILE_HEADER+ee+U+F,dirRecord:v.CENTRAL_FILE_HEADER+t(re,2)+ee+t(ie.length,2)+"\0\0\0\0"+t(D,4)+t(y,4)+U+F+ie}}var a=e("../utils"),i=e("../stream/GenericWorker"),u=e("../utf8"),p=e("../crc32"),v=e("../signature");function h(f,b,m,y){i.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=b,this.zipPlatform=m,this.encodeFileName=y,this.streamFiles=f,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}a.inherits(h,i),h.prototype.push=function(f){var b=f.meta.percent||0,m=this.entriesCount,y=this._sources.length;this.accumulate?this.contentBuffer.push(f):(this.bytesWritten+=f.data.length,i.prototype.push.call(this,{data:f.data,meta:{currentFile:this.currentFile,percent:m?(b+100*(m-y-1))/m:100}}))},h.prototype.openedSource=function(f){this.currentSourceOffset=this.bytesWritten,this.currentFile=f.file.name;var b=this.streamFiles&&!f.file.dir;if(b){var m=n(f,b,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:m.fileRecord,meta:{percent:0}})}else this.accumulate=!0},h.prototype.closedSource=function(f){this.accumulate=!1;var b=this.streamFiles&&!f.file.dir,m=n(f,b,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(m.dirRecord),b)this.push({data:function(y){return v.DATA_DESCRIPTOR+t(y.crc32,4)+t(y.compressedSize,4)+t(y.uncompressedSize,4)}(f),meta:{percent:100}});else for(this.push({data:m.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},h.prototype.flush=function(){for(var f=this.bytesWritten,b=0;b<this.dirRecords.length;b++)this.push({data:this.dirRecords[b],meta:{percent:100}});var m=this.bytesWritten-f,y=function(g,w,k,I,S){var O=a.transformTo("string",S(I));return v.CENTRAL_DIRECTORY_END+"\0\0\0\0"+t(g,2)+t(g,2)+t(w,4)+t(k,4)+t(O.length,2)+O}(this.dirRecords.length,m,f,this.zipComment,this.encodeFileName);this.push({data:y,meta:{percent:100}})},h.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},h.prototype.registerPrevious=function(f){this._sources.push(f);var b=this;return f.on("data",function(m){b.processChunk(m)}),f.on("end",function(){b.closedSource(b.previous.streamInfo),b._sources.length?b.prepareNextSource():b.end()}),f.on("error",function(m){b.error(m)}),this},h.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},h.prototype.error=function(f){var b=this._sources;if(!i.prototype.error.call(this,f))return!1;for(var m=0;m<b.length;m++)try{b[m].error(f)}catch{}return!0},h.prototype.lock=function(){i.prototype.lock.call(this);for(var f=this._sources,b=0;b<f.length;b++)f[b].lock()},l.exports=h},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,l,r){var t=e("../compressions"),n=e("./ZipFileWorker");r.generateWorker=function(a,i,u){var p=new n(i.streamFiles,u,i.platform,i.encodeFileName),v=0;try{a.forEach(function(h,f){v++;var b=function(w,k){var I=w||k,S=t[I];if(!S)throw new Error(I+" is not a valid compression method !");return S}(f.options.compression,i.compression),m=f.options.compressionOptions||i.compressionOptions||{},y=f.dir,g=f.date;f._compressWorker(b,m).withStreamInfo("file",{name:h,dir:y,date:g,comment:f.comment||"",unixPermissions:f.unixPermissions,dosPermissions:f.dosPermissions}).pipe(p)}),p.entriesCount=v}catch(h){p.error(h)}return p}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,l,r){function t(){if(!(this instanceof t))return new t;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var n=new t;for(var a in this)typeof this[a]!="function"&&(n[a]=this[a]);return n}}(t.prototype=e("./object")).loadAsync=e("./load"),t.support=e("./support"),t.defaults=e("./defaults"),t.version="3.10.1",t.loadAsync=function(n,a){return new t().loadAsync(n,a)},t.external=e("./external"),l.exports=t},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,l,r){var t=e("./utils"),n=e("./external"),a=e("./utf8"),i=e("./zipEntries"),u=e("./stream/Crc32Probe"),p=e("./nodejsUtils");function v(h){return new n.Promise(function(f,b){var m=h.decompressed.getContentWorker().pipe(new u);m.on("error",function(y){b(y)}).on("end",function(){m.streamInfo.crc32!==h.decompressed.crc32?b(new Error("Corrupted zip : CRC32 mismatch")):f()}).resume()})}l.exports=function(h,f){var b=this;return f=t.extend(f||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:a.utf8decode}),p.isNode&&p.isStream(h)?n.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):t.prepareContent("the loaded zip file",h,!0,f.optimizedBinaryString,f.base64).then(function(m){var y=new i(f);return y.load(m),y}).then(function(m){var y=[n.Promise.resolve(m)],g=m.files;if(f.checkCRC32)for(var w=0;w<g.length;w++)y.push(v(g[w]));return n.Promise.all(y)}).then(function(m){for(var y=m.shift(),g=y.files,w=0;w<g.length;w++){var k=g[w],I=k.fileNameStr,S=t.resolve(k.fileNameStr);b.file(S,k.decompressed,{binary:!0,optimizedBinaryString:!0,date:k.date,dir:k.dir,comment:k.fileCommentStr.length?k.fileCommentStr:null,unixPermissions:k.unixPermissions,dosPermissions:k.dosPermissions,createFolders:f.createFolders}),k.dir||(b.file(S).unsafeOriginalName=I)}return y.zipComment.length&&(b.comment=y.zipComment),b})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,l,r){var t=e("../utils"),n=e("../stream/GenericWorker");function a(i,u){n.call(this,"Nodejs stream input adapter for "+i),this._upstreamEnded=!1,this._bindStream(u)}t.inherits(a,n),a.prototype._bindStream=function(i){var u=this;(this._stream=i).pause(),i.on("data",function(p){u.push({data:p,meta:{percent:0}})}).on("error",function(p){u.isPaused?this.generatedError=p:u.error(p)}).on("end",function(){u.isPaused?u._upstreamEnded=!0:u.end()})},a.prototype.pause=function(){return!!n.prototype.pause.call(this)&&(this._stream.pause(),!0)},a.prototype.resume=function(){return!!n.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},l.exports=a},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,l,r){var t=e("readable-stream").Readable;function n(a,i,u){t.call(this,i),this._helper=a;var p=this;a.on("data",function(v,h){p.push(v)||p._helper.pause(),u&&u(h)}).on("error",function(v){p.emit("error",v)}).on("end",function(){p.push(null)})}e("../utils").inherits(n,t),n.prototype._read=function(){this._helper.resume()},l.exports=n},{"../utils":32,"readable-stream":16}],14:[function(e,l,r){l.exports={isNode:typeof Buffer<"u",newBufferFrom:function(t,n){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(t,n);if(typeof t=="number")throw new Error('The "data" argument must not be a number');return new Buffer(t,n)},allocBuffer:function(t){if(Buffer.alloc)return Buffer.alloc(t);var n=new Buffer(t);return n.fill(0),n},isBuffer:function(t){return Buffer.isBuffer(t)},isStream:function(t){return t&&typeof t.on=="function"&&typeof t.pause=="function"&&typeof t.resume=="function"}}},{}],15:[function(e,l,r){function t(S,O,M){var U,A=a.getTypeOf(O),G=a.extend(M||{},p);G.date=G.date||new Date,G.compression!==null&&(G.compression=G.compression.toUpperCase()),typeof G.unixPermissions=="string"&&(G.unixPermissions=parseInt(G.unixPermissions,8)),G.unixPermissions&&16384&G.unixPermissions&&(G.dir=!0),G.dosPermissions&&16&G.dosPermissions&&(G.dir=!0),G.dir&&(S=g(S)),G.createFolders&&(U=y(S))&&w.call(this,U,!0);var ie=A==="string"&&G.binary===!1&&G.base64===!1;M&&M.binary!==void 0||(G.binary=!ie),(O instanceof v&&O.uncompressedSize===0||G.dir||!O||O.length===0)&&(G.base64=!1,G.binary=!0,O="",G.compression="STORE",A="string");var E=null;E=O instanceof v||O instanceof i?O:b.isNode&&b.isStream(O)?new m(S,O):a.prepareContent(S,O,G.binary,G.optimizedBinaryString,G.base64);var z=new h(S,E,G);this.files[S]=z}var n=e("./utf8"),a=e("./utils"),i=e("./stream/GenericWorker"),u=e("./stream/StreamHelper"),p=e("./defaults"),v=e("./compressedObject"),h=e("./zipObject"),f=e("./generate"),b=e("./nodejsUtils"),m=e("./nodejs/NodejsStreamInputAdapter"),y=function(S){S.slice(-1)==="/"&&(S=S.substring(0,S.length-1));var O=S.lastIndexOf("/");return 0<O?S.substring(0,O):""},g=function(S){return S.slice(-1)!=="/"&&(S+="/"),S},w=function(S,O){return O=O!==void 0?O:p.createFolders,S=g(S),this.files[S]||t.call(this,S,null,{dir:!0,createFolders:O}),this.files[S]};function k(S){return Object.prototype.toString.call(S)==="[object RegExp]"}var I={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(S){var O,M,U;for(O in this.files)U=this.files[O],(M=O.slice(this.root.length,O.length))&&O.slice(0,this.root.length)===this.root&&S(M,U)},filter:function(S){var O=[];return this.forEach(function(M,U){S(M,U)&&O.push(U)}),O},file:function(S,O,M){if(arguments.length!==1)return S=this.root+S,t.call(this,S,O,M),this;if(k(S)){var U=S;return this.filter(function(G,ie){return!ie.dir&&U.test(G)})}var A=this.files[this.root+S];return A&&!A.dir?A:null},folder:function(S){if(!S)return this;if(k(S))return this.filter(function(A,G){return G.dir&&S.test(A)});var O=this.root+S,M=w.call(this,O),U=this.clone();return U.root=M.name,U},remove:function(S){S=this.root+S;var O=this.files[S];if(O||(S.slice(-1)!=="/"&&(S+="/"),O=this.files[S]),O&&!O.dir)delete this.files[S];else for(var M=this.filter(function(A,G){return G.name.slice(0,S.length)===S}),U=0;U<M.length;U++)delete this.files[M[U].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(S){var O,M={};try{if((M=a.extend(S||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:n.utf8encode})).type=M.type.toLowerCase(),M.compression=M.compression.toUpperCase(),M.type==="binarystring"&&(M.type="string"),!M.type)throw new Error("No output type specified.");a.checkSupport(M.type),M.platform!=="darwin"&&M.platform!=="freebsd"&&M.platform!=="linux"&&M.platform!=="sunos"||(M.platform="UNIX"),M.platform==="win32"&&(M.platform="DOS");var U=M.comment||this.comment||"";O=f.generateWorker(this,M,U)}catch(A){(O=new i("error")).error(A)}return new u(O,M.type||"string",M.mimeType)},generateAsync:function(S,O){return this.generateInternalStream(S).accumulate(O)},generateNodeStream:function(S,O){return(S=S||{}).type||(S.type="nodebuffer"),this.generateInternalStream(S).toNodejsStream(O)}};l.exports=I},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,l,r){l.exports=e("stream")},{stream:void 0}],17:[function(e,l,r){var t=e("./DataReader");function n(a){t.call(this,a);for(var i=0;i<this.data.length;i++)a[i]=255&a[i]}e("../utils").inherits(n,t),n.prototype.byteAt=function(a){return this.data[this.zero+a]},n.prototype.lastIndexOfSignature=function(a){for(var i=a.charCodeAt(0),u=a.charCodeAt(1),p=a.charCodeAt(2),v=a.charCodeAt(3),h=this.length-4;0<=h;--h)if(this.data[h]===i&&this.data[h+1]===u&&this.data[h+2]===p&&this.data[h+3]===v)return h-this.zero;return-1},n.prototype.readAndCheckSignature=function(a){var i=a.charCodeAt(0),u=a.charCodeAt(1),p=a.charCodeAt(2),v=a.charCodeAt(3),h=this.readData(4);return i===h[0]&&u===h[1]&&p===h[2]&&v===h[3]},n.prototype.readData=function(a){if(this.checkOffset(a),a===0)return[];var i=this.data.slice(this.zero+this.index,this.zero+this.index+a);return this.index+=a,i},l.exports=n},{"../utils":32,"./DataReader":18}],18:[function(e,l,r){var t=e("../utils");function n(a){this.data=a,this.length=a.length,this.index=0,this.zero=0}n.prototype={checkOffset:function(a){this.checkIndex(this.index+a)},checkIndex:function(a){if(this.length<this.zero+a||a<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+a+"). Corrupted zip ?")},setIndex:function(a){this.checkIndex(a),this.index=a},skip:function(a){this.setIndex(this.index+a)},byteAt:function(){},readInt:function(a){var i,u=0;for(this.checkOffset(a),i=this.index+a-1;i>=this.index;i--)u=(u<<8)+this.byteAt(i);return this.index+=a,u},readString:function(a){return t.transformTo("string",this.readData(a))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var a=this.readInt(4);return new Date(Date.UTC(1980+(a>>25&127),(a>>21&15)-1,a>>16&31,a>>11&31,a>>5&63,(31&a)<<1))}},l.exports=n},{"../utils":32}],19:[function(e,l,r){var t=e("./Uint8ArrayReader");function n(a){t.call(this,a)}e("../utils").inherits(n,t),n.prototype.readData=function(a){this.checkOffset(a);var i=this.data.slice(this.zero+this.index,this.zero+this.index+a);return this.index+=a,i},l.exports=n},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,l,r){var t=e("./DataReader");function n(a){t.call(this,a)}e("../utils").inherits(n,t),n.prototype.byteAt=function(a){return this.data.charCodeAt(this.zero+a)},n.prototype.lastIndexOfSignature=function(a){return this.data.lastIndexOf(a)-this.zero},n.prototype.readAndCheckSignature=function(a){return a===this.readData(4)},n.prototype.readData=function(a){this.checkOffset(a);var i=this.data.slice(this.zero+this.index,this.zero+this.index+a);return this.index+=a,i},l.exports=n},{"../utils":32,"./DataReader":18}],21:[function(e,l,r){var t=e("./ArrayReader");function n(a){t.call(this,a)}e("../utils").inherits(n,t),n.prototype.readData=function(a){if(this.checkOffset(a),a===0)return new Uint8Array(0);var i=this.data.subarray(this.zero+this.index,this.zero+this.index+a);return this.index+=a,i},l.exports=n},{"../utils":32,"./ArrayReader":17}],22:[function(e,l,r){var t=e("../utils"),n=e("../support"),a=e("./ArrayReader"),i=e("./StringReader"),u=e("./NodeBufferReader"),p=e("./Uint8ArrayReader");l.exports=function(v){var h=t.getTypeOf(v);return t.checkSupport(h),h!=="string"||n.uint8array?h==="nodebuffer"?new u(v):n.uint8array?new p(t.transformTo("uint8array",v)):new a(t.transformTo("array",v)):new i(v)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,l,r){r.LOCAL_FILE_HEADER="PK",r.CENTRAL_FILE_HEADER="PK",r.CENTRAL_DIRECTORY_END="PK",r.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",r.ZIP64_CENTRAL_DIRECTORY_END="PK",r.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(e,l,r){var t=e("./GenericWorker"),n=e("../utils");function a(i){t.call(this,"ConvertWorker to "+i),this.destType=i}n.inherits(a,t),a.prototype.processChunk=function(i){this.push({data:n.transformTo(this.destType,i.data),meta:i.meta})},l.exports=a},{"../utils":32,"./GenericWorker":28}],25:[function(e,l,r){var t=e("./GenericWorker"),n=e("../crc32");function a(){t.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}e("../utils").inherits(a,t),a.prototype.processChunk=function(i){this.streamInfo.crc32=n(i.data,this.streamInfo.crc32||0),this.push(i)},l.exports=a},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,l,r){var t=e("../utils"),n=e("./GenericWorker");function a(i){n.call(this,"DataLengthProbe for "+i),this.propName=i,this.withStreamInfo(i,0)}t.inherits(a,n),a.prototype.processChunk=function(i){if(i){var u=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=u+i.data.length}n.prototype.processChunk.call(this,i)},l.exports=a},{"../utils":32,"./GenericWorker":28}],27:[function(e,l,r){var t=e("../utils"),n=e("./GenericWorker");function a(i){n.call(this,"DataWorker");var u=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,i.then(function(p){u.dataIsReady=!0,u.data=p,u.max=p&&p.length||0,u.type=t.getTypeOf(p),u.isPaused||u._tickAndRepeat()},function(p){u.error(p)})}t.inherits(a,n),a.prototype.cleanUp=function(){n.prototype.cleanUp.call(this),this.data=null},a.prototype.resume=function(){return!!n.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,t.delay(this._tickAndRepeat,[],this)),!0)},a.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(t.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},a.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var i=null,u=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":i=this.data.substring(this.index,u);break;case"uint8array":i=this.data.subarray(this.index,u);break;case"array":case"nodebuffer":i=this.data.slice(this.index,u)}return this.index=u,this.push({data:i,meta:{percent:this.max?this.index/this.max*100:0}})},l.exports=a},{"../utils":32,"./GenericWorker":28}],28:[function(e,l,r){function t(n){this.name=n||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}t.prototype={push:function(n){this.emit("data",n)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(n){this.emit("error",n)}return!0},error:function(n){return!this.isFinished&&(this.isPaused?this.generatedError=n:(this.isFinished=!0,this.emit("error",n),this.previous&&this.previous.error(n),this.cleanUp()),!0)},on:function(n,a){return this._listeners[n].push(a),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(n,a){if(this._listeners[n])for(var i=0;i<this._listeners[n].length;i++)this._listeners[n][i].call(this,a)},pipe:function(n){return n.registerPrevious(this)},registerPrevious:function(n){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=n.streamInfo,this.mergeStreamInfo(),this.previous=n;var a=this;return n.on("data",function(i){a.processChunk(i)}),n.on("end",function(){a.end()}),n.on("error",function(i){a.error(i)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var n=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),n=!0),this.previous&&this.previous.resume(),!n},flush:function(){},processChunk:function(n){this.push(n)},withStreamInfo:function(n,a){return this.extraStreamInfo[n]=a,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var n in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,n)&&(this.streamInfo[n]=this.extraStreamInfo[n])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var n="Worker "+this.name;return this.previous?this.previous+" -> "+n:n}},l.exports=t},{}],29:[function(e,l,r){var t=e("../utils"),n=e("./ConvertWorker"),a=e("./GenericWorker"),i=e("../base64"),u=e("../support"),p=e("../external"),v=null;if(u.nodestream)try{v=e("../nodejs/NodejsStreamOutputAdapter")}catch{}function h(b,m){return new p.Promise(function(y,g){var w=[],k=b._internalType,I=b._outputType,S=b._mimeType;b.on("data",function(O,M){w.push(O),m&&m(M)}).on("error",function(O){w=[],g(O)}).on("end",function(){try{var O=function(M,U,A){switch(M){case"blob":return t.newBlob(t.transformTo("arraybuffer",U),A);case"base64":return i.encode(U);default:return t.transformTo(M,U)}}(I,function(M,U){var A,G=0,ie=null,E=0;for(A=0;A<U.length;A++)E+=U[A].length;switch(M){case"string":return U.join("");case"array":return Array.prototype.concat.apply([],U);case"uint8array":for(ie=new Uint8Array(E),A=0;A<U.length;A++)ie.set(U[A],G),G+=U[A].length;return ie;case"nodebuffer":return Buffer.concat(U);default:throw new Error("concat : unsupported type '"+M+"'")}}(k,w),S);y(O)}catch(M){g(M)}w=[]}).resume()})}function f(b,m,y){var g=m;switch(m){case"blob":case"arraybuffer":g="uint8array";break;case"base64":g="string"}try{this._internalType=g,this._outputType=m,this._mimeType=y,t.checkSupport(g),this._worker=b.pipe(new n(g)),b.lock()}catch(w){this._worker=new a("error"),this._worker.error(w)}}f.prototype={accumulate:function(b){return h(this,b)},on:function(b,m){var y=this;return b==="data"?this._worker.on(b,function(g){m.call(y,g.data,g.meta)}):this._worker.on(b,function(){t.delay(m,arguments,y)}),this},resume:function(){return t.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(b){if(t.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new v(this,{objectMode:this._outputType!=="nodebuffer"},b)}},l.exports=f},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,l,r){if(r.base64=!0,r.array=!0,r.string=!0,r.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",r.nodebuffer=typeof Buffer<"u",r.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")r.blob=!1;else{var t=new ArrayBuffer(0);try{r.blob=new Blob([t],{type:"application/zip"}).size===0}catch{try{var n=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);n.append(t),r.blob=n.getBlob("application/zip").size===0}catch{r.blob=!1}}}try{r.nodestream=!!e("readable-stream").Readable}catch{r.nodestream=!1}},{"readable-stream":16}],31:[function(e,l,r){for(var t=e("./utils"),n=e("./support"),a=e("./nodejsUtils"),i=e("./stream/GenericWorker"),u=new Array(256),p=0;p<256;p++)u[p]=252<=p?6:248<=p?5:240<=p?4:224<=p?3:192<=p?2:1;u[254]=u[254]=1;function v(){i.call(this,"utf-8 decode"),this.leftOver=null}function h(){i.call(this,"utf-8 encode")}r.utf8encode=function(f){return n.nodebuffer?a.newBufferFrom(f,"utf-8"):function(b){var m,y,g,w,k,I=b.length,S=0;for(w=0;w<I;w++)(64512&(y=b.charCodeAt(w)))==55296&&w+1<I&&(64512&(g=b.charCodeAt(w+1)))==56320&&(y=65536+(y-55296<<10)+(g-56320),w++),S+=y<128?1:y<2048?2:y<65536?3:4;for(m=n.uint8array?new Uint8Array(S):new Array(S),w=k=0;k<S;w++)(64512&(y=b.charCodeAt(w)))==55296&&w+1<I&&(64512&(g=b.charCodeAt(w+1)))==56320&&(y=65536+(y-55296<<10)+(g-56320),w++),y<128?m[k++]=y:(y<2048?m[k++]=192|y>>>6:(y<65536?m[k++]=224|y>>>12:(m[k++]=240|y>>>18,m[k++]=128|y>>>12&63),m[k++]=128|y>>>6&63),m[k++]=128|63&y);return m}(f)},r.utf8decode=function(f){return n.nodebuffer?t.transformTo("nodebuffer",f).toString("utf-8"):function(b){var m,y,g,w,k=b.length,I=new Array(2*k);for(m=y=0;m<k;)if((g=b[m++])<128)I[y++]=g;else if(4<(w=u[g]))I[y++]=65533,m+=w-1;else{for(g&=w===2?31:w===3?15:7;1<w&&m<k;)g=g<<6|63&b[m++],w--;1<w?I[y++]=65533:g<65536?I[y++]=g:(g-=65536,I[y++]=55296|g>>10&1023,I[y++]=56320|1023&g)}return I.length!==y&&(I.subarray?I=I.subarray(0,y):I.length=y),t.applyFromCharCode(I)}(f=t.transformTo(n.uint8array?"uint8array":"array",f))},t.inherits(v,i),v.prototype.processChunk=function(f){var b=t.transformTo(n.uint8array?"uint8array":"array",f.data);if(this.leftOver&&this.leftOver.length){if(n.uint8array){var m=b;(b=new Uint8Array(m.length+this.leftOver.length)).set(this.leftOver,0),b.set(m,this.leftOver.length)}else b=this.leftOver.concat(b);this.leftOver=null}var y=function(w,k){var I;for((k=k||w.length)>w.length&&(k=w.length),I=k-1;0<=I&&(192&w[I])==128;)I--;return I<0||I===0?k:I+u[w[I]]>k?I:k}(b),g=b;y!==b.length&&(n.uint8array?(g=b.subarray(0,y),this.leftOver=b.subarray(y,b.length)):(g=b.slice(0,y),this.leftOver=b.slice(y,b.length))),this.push({data:r.utf8decode(g),meta:f.meta})},v.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:r.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},r.Utf8DecodeWorker=v,t.inherits(h,i),h.prototype.processChunk=function(f){this.push({data:r.utf8encode(f.data),meta:f.meta})},r.Utf8EncodeWorker=h},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,l,r){var t=e("./support"),n=e("./base64"),a=e("./nodejsUtils"),i=e("./external");function u(m){return m}function p(m,y){for(var g=0;g<m.length;++g)y[g]=255&m.charCodeAt(g);return y}e("setimmediate"),r.newBlob=function(m,y){r.checkSupport("blob");try{return new Blob([m],{type:y})}catch{try{var g=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return g.append(m),g.getBlob(y)}catch{throw new Error("Bug : can't construct the Blob.")}}};var v={stringifyByChunk:function(m,y,g){var w=[],k=0,I=m.length;if(I<=g)return String.fromCharCode.apply(null,m);for(;k<I;)y==="array"||y==="nodebuffer"?w.push(String.fromCharCode.apply(null,m.slice(k,Math.min(k+g,I)))):w.push(String.fromCharCode.apply(null,m.subarray(k,Math.min(k+g,I)))),k+=g;return w.join("")},stringifyByChar:function(m){for(var y="",g=0;g<m.length;g++)y+=String.fromCharCode(m[g]);return y},applyCanBeUsed:{uint8array:function(){try{return t.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}}(),nodebuffer:function(){try{return t.nodebuffer&&String.fromCharCode.apply(null,a.allocBuffer(1)).length===1}catch{return!1}}()}};function h(m){var y=65536,g=r.getTypeOf(m),w=!0;if(g==="uint8array"?w=v.applyCanBeUsed.uint8array:g==="nodebuffer"&&(w=v.applyCanBeUsed.nodebuffer),w)for(;1<y;)try{return v.stringifyByChunk(m,g,y)}catch{y=Math.floor(y/2)}return v.stringifyByChar(m)}function f(m,y){for(var g=0;g<m.length;g++)y[g]=m[g];return y}r.applyFromCharCode=h;var b={};b.string={string:u,array:function(m){return p(m,new Array(m.length))},arraybuffer:function(m){return b.string.uint8array(m).buffer},uint8array:function(m){return p(m,new Uint8Array(m.length))},nodebuffer:function(m){return p(m,a.allocBuffer(m.length))}},b.array={string:h,array:u,arraybuffer:function(m){return new Uint8Array(m).buffer},uint8array:function(m){return new Uint8Array(m)},nodebuffer:function(m){return a.newBufferFrom(m)}},b.arraybuffer={string:function(m){return h(new Uint8Array(m))},array:function(m){return f(new Uint8Array(m),new Array(m.byteLength))},arraybuffer:u,uint8array:function(m){return new Uint8Array(m)},nodebuffer:function(m){return a.newBufferFrom(new Uint8Array(m))}},b.uint8array={string:h,array:function(m){return f(m,new Array(m.length))},arraybuffer:function(m){return m.buffer},uint8array:u,nodebuffer:function(m){return a.newBufferFrom(m)}},b.nodebuffer={string:h,array:function(m){return f(m,new Array(m.length))},arraybuffer:function(m){return b.nodebuffer.uint8array(m).buffer},uint8array:function(m){return f(m,new Uint8Array(m.length))},nodebuffer:u},r.transformTo=function(m,y){if(y=y||"",!m)return y;r.checkSupport(m);var g=r.getTypeOf(y);return b[g][m](y)},r.resolve=function(m){for(var y=m.split("/"),g=[],w=0;w<y.length;w++){var k=y[w];k==="."||k===""&&w!==0&&w!==y.length-1||(k===".."?g.pop():g.push(k))}return g.join("/")},r.getTypeOf=function(m){return typeof m=="string"?"string":Object.prototype.toString.call(m)==="[object Array]"?"array":t.nodebuffer&&a.isBuffer(m)?"nodebuffer":t.uint8array&&m instanceof Uint8Array?"uint8array":t.arraybuffer&&m instanceof ArrayBuffer?"arraybuffer":void 0},r.checkSupport=function(m){if(!t[m.toLowerCase()])throw new Error(m+" is not supported by this platform")},r.MAX_VALUE_16BITS=65535,r.MAX_VALUE_32BITS=-1,r.pretty=function(m){var y,g,w="";for(g=0;g<(m||"").length;g++)w+="\\x"+((y=m.charCodeAt(g))<16?"0":"")+y.toString(16).toUpperCase();return w},r.delay=function(m,y,g){setImmediate(function(){m.apply(g||null,y||[])})},r.inherits=function(m,y){function g(){}g.prototype=y.prototype,m.prototype=new g},r.extend=function(){var m,y,g={};for(m=0;m<arguments.length;m++)for(y in arguments[m])Object.prototype.hasOwnProperty.call(arguments[m],y)&&g[y]===void 0&&(g[y]=arguments[m][y]);return g},r.prepareContent=function(m,y,g,w,k){return i.Promise.resolve(y).then(function(I){return t.blob&&(I instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(I))!==-1)&&typeof FileReader<"u"?new i.Promise(function(S,O){var M=new FileReader;M.onload=function(U){S(U.target.result)},M.onerror=function(U){O(U.target.error)},M.readAsArrayBuffer(I)}):I}).then(function(I){var S=r.getTypeOf(I);return S?(S==="arraybuffer"?I=r.transformTo("uint8array",I):S==="string"&&(k?I=n.decode(I):g&&w!==!0&&(I=function(O){return p(O,t.uint8array?new Uint8Array(O.length):new Array(O.length))}(I))),I):i.Promise.reject(new Error("Can't read the data of '"+m+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(e,l,r){var t=e("./reader/readerFor"),n=e("./utils"),a=e("./signature"),i=e("./zipEntry"),u=e("./support");function p(v){this.files=[],this.loadOptions=v}p.prototype={checkSignature:function(v){if(!this.reader.readAndCheckSignature(v)){this.reader.index-=4;var h=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+n.pretty(h)+", expected "+n.pretty(v)+")")}},isSignature:function(v,h){var f=this.reader.index;this.reader.setIndex(v);var b=this.reader.readString(4)===h;return this.reader.setIndex(f),b},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var v=this.reader.readData(this.zipCommentLength),h=u.uint8array?"uint8array":"array",f=n.transformTo(h,v);this.zipComment=this.loadOptions.decodeFileName(f)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var v,h,f,b=this.zip64EndOfCentralSize-44;0<b;)v=this.reader.readInt(2),h=this.reader.readInt(4),f=this.reader.readData(h),this.zip64ExtensibleData[v]={id:v,length:h,value:f}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var v,h;for(v=0;v<this.files.length;v++)h=this.files[v],this.reader.setIndex(h.localHeaderOffset),this.checkSignature(a.LOCAL_FILE_HEADER),h.readLocalPart(this.reader),h.handleUTF8(),h.processAttributes()},readCentralDir:function(){var v;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(a.CENTRAL_FILE_HEADER);)(v=new i({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(v);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var v=this.reader.lastIndexOfSignature(a.CENTRAL_DIRECTORY_END);if(v<0)throw this.isSignature(0,a.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(v);var h=v;if(this.checkSignature(a.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===n.MAX_VALUE_16BITS||this.diskWithCentralDirStart===n.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===n.MAX_VALUE_16BITS||this.centralDirRecords===n.MAX_VALUE_16BITS||this.centralDirSize===n.MAX_VALUE_32BITS||this.centralDirOffset===n.MAX_VALUE_32BITS){if(this.zip64=!0,(v=this.reader.lastIndexOfSignature(a.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(v),this.checkSignature(a.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,a.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(a.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(a.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var f=this.centralDirOffset+this.centralDirSize;this.zip64&&(f+=20,f+=12+this.zip64EndOfCentralSize);var b=h-f;if(0<b)this.isSignature(h,a.CENTRAL_FILE_HEADER)||(this.reader.zero=b);else if(b<0)throw new Error("Corrupted zip: missing "+Math.abs(b)+" bytes.")},prepareReader:function(v){this.reader=t(v)},load:function(v){this.prepareReader(v),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},l.exports=p},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(e,l,r){var t=e("./reader/readerFor"),n=e("./utils"),a=e("./compressedObject"),i=e("./crc32"),u=e("./utf8"),p=e("./compressions"),v=e("./support");function h(f,b){this.options=f,this.loadOptions=b}h.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(f){var b,m;if(f.skip(22),this.fileNameLength=f.readInt(2),m=f.readInt(2),this.fileName=f.readData(this.fileNameLength),f.skip(m),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((b=function(y){for(var g in p)if(Object.prototype.hasOwnProperty.call(p,g)&&p[g].magic===y)return p[g];return null}(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+n.pretty(this.compressionMethod)+" unknown (inner file : "+n.transformTo("string",this.fileName)+")");this.decompressed=new a(this.compressedSize,this.uncompressedSize,this.crc32,b,f.readData(this.compressedSize))},readCentralPart:function(f){this.versionMadeBy=f.readInt(2),f.skip(2),this.bitFlag=f.readInt(2),this.compressionMethod=f.readString(2),this.date=f.readDate(),this.crc32=f.readInt(4),this.compressedSize=f.readInt(4),this.uncompressedSize=f.readInt(4);var b=f.readInt(2);if(this.extraFieldsLength=f.readInt(2),this.fileCommentLength=f.readInt(2),this.diskNumberStart=f.readInt(2),this.internalFileAttributes=f.readInt(2),this.externalFileAttributes=f.readInt(4),this.localHeaderOffset=f.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");f.skip(b),this.readExtraFields(f),this.parseZIP64ExtraField(f),this.fileComment=f.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var f=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),f==0&&(this.dosPermissions=63&this.externalFileAttributes),f==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var f=t(this.extraFields[1].value);this.uncompressedSize===n.MAX_VALUE_32BITS&&(this.uncompressedSize=f.readInt(8)),this.compressedSize===n.MAX_VALUE_32BITS&&(this.compressedSize=f.readInt(8)),this.localHeaderOffset===n.MAX_VALUE_32BITS&&(this.localHeaderOffset=f.readInt(8)),this.diskNumberStart===n.MAX_VALUE_32BITS&&(this.diskNumberStart=f.readInt(4))}},readExtraFields:function(f){var b,m,y,g=f.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});f.index+4<g;)b=f.readInt(2),m=f.readInt(2),y=f.readData(m),this.extraFields[b]={id:b,length:m,value:y};f.setIndex(g)},handleUTF8:function(){var f=v.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=u.utf8decode(this.fileName),this.fileCommentStr=u.utf8decode(this.fileComment);else{var b=this.findExtraFieldUnicodePath();if(b!==null)this.fileNameStr=b;else{var m=n.transformTo(f,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(m)}var y=this.findExtraFieldUnicodeComment();if(y!==null)this.fileCommentStr=y;else{var g=n.transformTo(f,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(g)}}},findExtraFieldUnicodePath:function(){var f=this.extraFields[28789];if(f){var b=t(f.value);return b.readInt(1)!==1||i(this.fileName)!==b.readInt(4)?null:u.utf8decode(b.readData(f.length-5))}return null},findExtraFieldUnicodeComment:function(){var f=this.extraFields[25461];if(f){var b=t(f.value);return b.readInt(1)!==1||i(this.fileComment)!==b.readInt(4)?null:u.utf8decode(b.readData(f.length-5))}return null}},l.exports=h},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(e,l,r){function t(b,m,y){this.name=b,this.dir=y.dir,this.date=y.date,this.comment=y.comment,this.unixPermissions=y.unixPermissions,this.dosPermissions=y.dosPermissions,this._data=m,this._dataBinary=y.binary,this.options={compression:y.compression,compressionOptions:y.compressionOptions}}var n=e("./stream/StreamHelper"),a=e("./stream/DataWorker"),i=e("./utf8"),u=e("./compressedObject"),p=e("./stream/GenericWorker");t.prototype={internalStream:function(b){var m=null,y="string";try{if(!b)throw new Error("No output type specified.");var g=(y=b.toLowerCase())==="string"||y==="text";y!=="binarystring"&&y!=="text"||(y="string"),m=this._decompressWorker();var w=!this._dataBinary;w&&!g&&(m=m.pipe(new i.Utf8EncodeWorker)),!w&&g&&(m=m.pipe(new i.Utf8DecodeWorker))}catch(k){(m=new p("error")).error(k)}return new n(m,y,"")},async:function(b,m){return this.internalStream(b).accumulate(m)},nodeStream:function(b,m){return this.internalStream(b||"nodebuffer").toNodejsStream(m)},_compressWorker:function(b,m){if(this._data instanceof u&&this._data.compression.magic===b.magic)return this._data.getCompressedWorker();var y=this._decompressWorker();return this._dataBinary||(y=y.pipe(new i.Utf8EncodeWorker)),u.createWorkerFrom(y,b,m)},_decompressWorker:function(){return this._data instanceof u?this._data.getContentWorker():this._data instanceof p?this._data:new a(this._data)}};for(var v=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],h=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},f=0;f<v.length;f++)t.prototype[v[f]]=h;l.exports=t},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(e,l,r){(function(t){var n,a,i=t.MutationObserver||t.WebKitMutationObserver;if(i){var u=0,p=new i(b),v=t.document.createTextNode("");p.observe(v,{characterData:!0}),n=function(){v.data=u=++u%2}}else if(t.setImmediate||t.MessageChannel===void 0)n="document"in t&&"onreadystatechange"in t.document.createElement("script")?function(){var m=t.document.createElement("script");m.onreadystatechange=function(){b(),m.onreadystatechange=null,m.parentNode.removeChild(m),m=null},t.document.documentElement.appendChild(m)}:function(){setTimeout(b,0)};else{var h=new t.MessageChannel;h.port1.onmessage=b,n=function(){h.port2.postMessage(0)}}var f=[];function b(){var m,y;a=!0;for(var g=f.length;g;){for(y=f,f=[],m=-1;++m<g;)y[m]();g=f.length}a=!1}l.exports=function(m){f.push(m)!==1||a||n()}}).call(this,typeof ln<"u"?ln:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(e,l,r){var t=e("immediate");function n(){}var a={},i=["REJECTED"],u=["FULFILLED"],p=["PENDING"];function v(g){if(typeof g!="function")throw new TypeError("resolver must be a function");this.state=p,this.queue=[],this.outcome=void 0,g!==n&&m(this,g)}function h(g,w,k){this.promise=g,typeof w=="function"&&(this.onFulfilled=w,this.callFulfilled=this.otherCallFulfilled),typeof k=="function"&&(this.onRejected=k,this.callRejected=this.otherCallRejected)}function f(g,w,k){t(function(){var I;try{I=w(k)}catch(S){return a.reject(g,S)}I===g?a.reject(g,new TypeError("Cannot resolve promise with itself")):a.resolve(g,I)})}function b(g){var w=g&&g.then;if(g&&(typeof g=="object"||typeof g=="function")&&typeof w=="function")return function(){w.apply(g,arguments)}}function m(g,w){var k=!1;function I(M){k||(k=!0,a.reject(g,M))}function S(M){k||(k=!0,a.resolve(g,M))}var O=y(function(){w(S,I)});O.status==="error"&&I(O.value)}function y(g,w){var k={};try{k.value=g(w),k.status="success"}catch(I){k.status="error",k.value=I}return k}(l.exports=v).prototype.finally=function(g){if(typeof g!="function")return this;var w=this.constructor;return this.then(function(k){return w.resolve(g()).then(function(){return k})},function(k){return w.resolve(g()).then(function(){throw k})})},v.prototype.catch=function(g){return this.then(null,g)},v.prototype.then=function(g,w){if(typeof g!="function"&&this.state===u||typeof w!="function"&&this.state===i)return this;var k=new this.constructor(n);return this.state!==p?f(k,this.state===u?g:w,this.outcome):this.queue.push(new h(k,g,w)),k},h.prototype.callFulfilled=function(g){a.resolve(this.promise,g)},h.prototype.otherCallFulfilled=function(g){f(this.promise,this.onFulfilled,g)},h.prototype.callRejected=function(g){a.reject(this.promise,g)},h.prototype.otherCallRejected=function(g){f(this.promise,this.onRejected,g)},a.resolve=function(g,w){var k=y(b,w);if(k.status==="error")return a.reject(g,k.value);var I=k.value;if(I)m(g,I);else{g.state=u,g.outcome=w;for(var S=-1,O=g.queue.length;++S<O;)g.queue[S].callFulfilled(w)}return g},a.reject=function(g,w){g.state=i,g.outcome=w;for(var k=-1,I=g.queue.length;++k<I;)g.queue[k].callRejected(w);return g},v.resolve=function(g){return g instanceof this?g:a.resolve(new this(n),g)},v.reject=function(g){var w=new this(n);return a.reject(w,g)},v.all=function(g){var w=this;if(Object.prototype.toString.call(g)!=="[object Array]")return this.reject(new TypeError("must be an array"));var k=g.length,I=!1;if(!k)return this.resolve([]);for(var S=new Array(k),O=0,M=-1,U=new this(n);++M<k;)A(g[M],M);return U;function A(G,ie){w.resolve(G).then(function(E){S[ie]=E,++O!==k||I||(I=!0,a.resolve(U,S))},function(E){I||(I=!0,a.reject(U,E))})}},v.race=function(g){var w=this;if(Object.prototype.toString.call(g)!=="[object Array]")return this.reject(new TypeError("must be an array"));var k=g.length,I=!1;if(!k)return this.resolve([]);for(var S=-1,O=new this(n);++S<k;)M=g[S],w.resolve(M).then(function(U){I||(I=!0,a.resolve(O,U))},function(U){I||(I=!0,a.reject(O,U))});var M;return O}},{immediate:36}],38:[function(e,l,r){var t={};(0,e("./lib/utils/common").assign)(t,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),l.exports=t},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(e,l,r){var t=e("./zlib/deflate"),n=e("./utils/common"),a=e("./utils/strings"),i=e("./zlib/messages"),u=e("./zlib/zstream"),p=Object.prototype.toString,v=0,h=-1,f=0,b=8;function m(g){if(!(this instanceof m))return new m(g);this.options=n.assign({level:h,method:b,chunkSize:16384,windowBits:15,memLevel:8,strategy:f,to:""},g||{});var w=this.options;w.raw&&0<w.windowBits?w.windowBits=-w.windowBits:w.gzip&&0<w.windowBits&&w.windowBits<16&&(w.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new u,this.strm.avail_out=0;var k=t.deflateInit2(this.strm,w.level,w.method,w.windowBits,w.memLevel,w.strategy);if(k!==v)throw new Error(i[k]);if(w.header&&t.deflateSetHeader(this.strm,w.header),w.dictionary){var I;if(I=typeof w.dictionary=="string"?a.string2buf(w.dictionary):p.call(w.dictionary)==="[object ArrayBuffer]"?new Uint8Array(w.dictionary):w.dictionary,(k=t.deflateSetDictionary(this.strm,I))!==v)throw new Error(i[k]);this._dict_set=!0}}function y(g,w){var k=new m(w);if(k.push(g,!0),k.err)throw k.msg||i[k.err];return k.result}m.prototype.push=function(g,w){var k,I,S=this.strm,O=this.options.chunkSize;if(this.ended)return!1;I=w===~~w?w:w===!0?4:0,typeof g=="string"?S.input=a.string2buf(g):p.call(g)==="[object ArrayBuffer]"?S.input=new Uint8Array(g):S.input=g,S.next_in=0,S.avail_in=S.input.length;do{if(S.avail_out===0&&(S.output=new n.Buf8(O),S.next_out=0,S.avail_out=O),(k=t.deflate(S,I))!==1&&k!==v)return this.onEnd(k),!(this.ended=!0);S.avail_out!==0&&(S.avail_in!==0||I!==4&&I!==2)||(this.options.to==="string"?this.onData(a.buf2binstring(n.shrinkBuf(S.output,S.next_out))):this.onData(n.shrinkBuf(S.output,S.next_out)))}while((0<S.avail_in||S.avail_out===0)&&k!==1);return I===4?(k=t.deflateEnd(this.strm),this.onEnd(k),this.ended=!0,k===v):I!==2||(this.onEnd(v),!(S.avail_out=0))},m.prototype.onData=function(g){this.chunks.push(g)},m.prototype.onEnd=function(g){g===v&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=g,this.msg=this.strm.msg},r.Deflate=m,r.deflate=y,r.deflateRaw=function(g,w){return(w=w||{}).raw=!0,y(g,w)},r.gzip=function(g,w){return(w=w||{}).gzip=!0,y(g,w)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(e,l,r){var t=e("./zlib/inflate"),n=e("./utils/common"),a=e("./utils/strings"),i=e("./zlib/constants"),u=e("./zlib/messages"),p=e("./zlib/zstream"),v=e("./zlib/gzheader"),h=Object.prototype.toString;function f(m){if(!(this instanceof f))return new f(m);this.options=n.assign({chunkSize:16384,windowBits:0,to:""},m||{});var y=this.options;y.raw&&0<=y.windowBits&&y.windowBits<16&&(y.windowBits=-y.windowBits,y.windowBits===0&&(y.windowBits=-15)),!(0<=y.windowBits&&y.windowBits<16)||m&&m.windowBits||(y.windowBits+=32),15<y.windowBits&&y.windowBits<48&&!(15&y.windowBits)&&(y.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new p,this.strm.avail_out=0;var g=t.inflateInit2(this.strm,y.windowBits);if(g!==i.Z_OK)throw new Error(u[g]);this.header=new v,t.inflateGetHeader(this.strm,this.header)}function b(m,y){var g=new f(y);if(g.push(m,!0),g.err)throw g.msg||u[g.err];return g.result}f.prototype.push=function(m,y){var g,w,k,I,S,O,M=this.strm,U=this.options.chunkSize,A=this.options.dictionary,G=!1;if(this.ended)return!1;w=y===~~y?y:y===!0?i.Z_FINISH:i.Z_NO_FLUSH,typeof m=="string"?M.input=a.binstring2buf(m):h.call(m)==="[object ArrayBuffer]"?M.input=new Uint8Array(m):M.input=m,M.next_in=0,M.avail_in=M.input.length;do{if(M.avail_out===0&&(M.output=new n.Buf8(U),M.next_out=0,M.avail_out=U),(g=t.inflate(M,i.Z_NO_FLUSH))===i.Z_NEED_DICT&&A&&(O=typeof A=="string"?a.string2buf(A):h.call(A)==="[object ArrayBuffer]"?new Uint8Array(A):A,g=t.inflateSetDictionary(this.strm,O)),g===i.Z_BUF_ERROR&&G===!0&&(g=i.Z_OK,G=!1),g!==i.Z_STREAM_END&&g!==i.Z_OK)return this.onEnd(g),!(this.ended=!0);M.next_out&&(M.avail_out!==0&&g!==i.Z_STREAM_END&&(M.avail_in!==0||w!==i.Z_FINISH&&w!==i.Z_SYNC_FLUSH)||(this.options.to==="string"?(k=a.utf8border(M.output,M.next_out),I=M.next_out-k,S=a.buf2string(M.output,k),M.next_out=I,M.avail_out=U-I,I&&n.arraySet(M.output,M.output,k,I,0),this.onData(S)):this.onData(n.shrinkBuf(M.output,M.next_out)))),M.avail_in===0&&M.avail_out===0&&(G=!0)}while((0<M.avail_in||M.avail_out===0)&&g!==i.Z_STREAM_END);return g===i.Z_STREAM_END&&(w=i.Z_FINISH),w===i.Z_FINISH?(g=t.inflateEnd(this.strm),this.onEnd(g),this.ended=!0,g===i.Z_OK):w!==i.Z_SYNC_FLUSH||(this.onEnd(i.Z_OK),!(M.avail_out=0))},f.prototype.onData=function(m){this.chunks.push(m)},f.prototype.onEnd=function(m){m===i.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=m,this.msg=this.strm.msg},r.Inflate=f,r.inflate=b,r.inflateRaw=function(m,y){return(y=y||{}).raw=!0,b(m,y)},r.ungzip=b},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(e,l,r){var t=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";r.assign=function(i){for(var u=Array.prototype.slice.call(arguments,1);u.length;){var p=u.shift();if(p){if(typeof p!="object")throw new TypeError(p+"must be non-object");for(var v in p)p.hasOwnProperty(v)&&(i[v]=p[v])}}return i},r.shrinkBuf=function(i,u){return i.length===u?i:i.subarray?i.subarray(0,u):(i.length=u,i)};var n={arraySet:function(i,u,p,v,h){if(u.subarray&&i.subarray)i.set(u.subarray(p,p+v),h);else for(var f=0;f<v;f++)i[h+f]=u[p+f]},flattenChunks:function(i){var u,p,v,h,f,b;for(u=v=0,p=i.length;u<p;u++)v+=i[u].length;for(b=new Uint8Array(v),u=h=0,p=i.length;u<p;u++)f=i[u],b.set(f,h),h+=f.length;return b}},a={arraySet:function(i,u,p,v,h){for(var f=0;f<v;f++)i[h+f]=u[p+f]},flattenChunks:function(i){return[].concat.apply([],i)}};r.setTyped=function(i){i?(r.Buf8=Uint8Array,r.Buf16=Uint16Array,r.Buf32=Int32Array,r.assign(r,n)):(r.Buf8=Array,r.Buf16=Array,r.Buf32=Array,r.assign(r,a))},r.setTyped(t)},{}],42:[function(e,l,r){var t=e("./common"),n=!0,a=!0;try{String.fromCharCode.apply(null,[0])}catch{n=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{a=!1}for(var i=new t.Buf8(256),u=0;u<256;u++)i[u]=252<=u?6:248<=u?5:240<=u?4:224<=u?3:192<=u?2:1;function p(v,h){if(h<65537&&(v.subarray&&a||!v.subarray&&n))return String.fromCharCode.apply(null,t.shrinkBuf(v,h));for(var f="",b=0;b<h;b++)f+=String.fromCharCode(v[b]);return f}i[254]=i[254]=1,r.string2buf=function(v){var h,f,b,m,y,g=v.length,w=0;for(m=0;m<g;m++)(64512&(f=v.charCodeAt(m)))==55296&&m+1<g&&(64512&(b=v.charCodeAt(m+1)))==56320&&(f=65536+(f-55296<<10)+(b-56320),m++),w+=f<128?1:f<2048?2:f<65536?3:4;for(h=new t.Buf8(w),m=y=0;y<w;m++)(64512&(f=v.charCodeAt(m)))==55296&&m+1<g&&(64512&(b=v.charCodeAt(m+1)))==56320&&(f=65536+(f-55296<<10)+(b-56320),m++),f<128?h[y++]=f:(f<2048?h[y++]=192|f>>>6:(f<65536?h[y++]=224|f>>>12:(h[y++]=240|f>>>18,h[y++]=128|f>>>12&63),h[y++]=128|f>>>6&63),h[y++]=128|63&f);return h},r.buf2binstring=function(v){return p(v,v.length)},r.binstring2buf=function(v){for(var h=new t.Buf8(v.length),f=0,b=h.length;f<b;f++)h[f]=v.charCodeAt(f);return h},r.buf2string=function(v,h){var f,b,m,y,g=h||v.length,w=new Array(2*g);for(f=b=0;f<g;)if((m=v[f++])<128)w[b++]=m;else if(4<(y=i[m]))w[b++]=65533,f+=y-1;else{for(m&=y===2?31:y===3?15:7;1<y&&f<g;)m=m<<6|63&v[f++],y--;1<y?w[b++]=65533:m<65536?w[b++]=m:(m-=65536,w[b++]=55296|m>>10&1023,w[b++]=56320|1023&m)}return p(w,b)},r.utf8border=function(v,h){var f;for((h=h||v.length)>v.length&&(h=v.length),f=h-1;0<=f&&(192&v[f])==128;)f--;return f<0||f===0?h:f+i[v[f]]>h?f:h}},{"./common":41}],43:[function(e,l,r){l.exports=function(t,n,a,i){for(var u=65535&t|0,p=t>>>16&65535|0,v=0;a!==0;){for(a-=v=2e3<a?2e3:a;p=p+(u=u+n[i++]|0)|0,--v;);u%=65521,p%=65521}return u|p<<16|0}},{}],44:[function(e,l,r){l.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(e,l,r){var t=function(){for(var n,a=[],i=0;i<256;i++){n=i;for(var u=0;u<8;u++)n=1&n?3988292384^n>>>1:n>>>1;a[i]=n}return a}();l.exports=function(n,a,i,u){var p=t,v=u+i;n^=-1;for(var h=u;h<v;h++)n=n>>>8^p[255&(n^a[h])];return-1^n}},{}],46:[function(e,l,r){var t,n=e("../utils/common"),a=e("./trees"),i=e("./adler32"),u=e("./crc32"),p=e("./messages"),v=0,h=4,f=0,b=-2,m=-1,y=4,g=2,w=8,k=9,I=286,S=30,O=19,M=2*I+1,U=15,A=3,G=258,ie=G+A+1,E=42,z=113,d=1,F=2,ue=3,j=4;function fe(c,P){return c.msg=p[P],P}function $(c){return(c<<1)-(4<c?9:0)}function te(c){for(var P=c.length;0<=--P;)c[P]=0}function T(c){var P=c.state,R=P.pending;R>c.avail_out&&(R=c.avail_out),R!==0&&(n.arraySet(c.output,P.pending_buf,P.pending_out,R,c.next_out),c.next_out+=R,P.pending_out+=R,c.total_out+=R,c.avail_out-=R,P.pending-=R,P.pending===0&&(P.pending_out=0))}function D(c,P){a._tr_flush_block(c,0<=c.block_start?c.block_start:-1,c.strstart-c.block_start,P),c.block_start=c.strstart,T(c.strm)}function re(c,P){c.pending_buf[c.pending++]=P}function ee(c,P){c.pending_buf[c.pending++]=P>>>8&255,c.pending_buf[c.pending++]=255&P}function Y(c,P){var R,_,C=c.max_chain_length,x=c.strstart,W=c.prev_length,Z=c.nice_match,B=c.strstart>c.w_size-ie?c.strstart-(c.w_size-ie):0,V=c.window,ne=c.w_mask,K=c.prev,ce=c.strstart+G,he=V[x+W-1],ye=V[x+W];c.prev_length>=c.good_match&&(C>>=2),Z>c.lookahead&&(Z=c.lookahead);do if(V[(R=P)+W]===ye&&V[R+W-1]===he&&V[R]===V[x]&&V[++R]===V[x+1]){x+=2,R++;do;while(V[++x]===V[++R]&&V[++x]===V[++R]&&V[++x]===V[++R]&&V[++x]===V[++R]&&V[++x]===V[++R]&&V[++x]===V[++R]&&V[++x]===V[++R]&&V[++x]===V[++R]&&x<ce);if(_=G-(ce-x),x=ce-G,W<_){if(c.match_start=P,Z<=(W=_))break;he=V[x+W-1],ye=V[x+W]}}while((P=K[P&ne])>B&&--C!=0);return W<=c.lookahead?W:c.lookahead}function Te(c){var P,R,_,C,x,W,Z,B,V,ne,K=c.w_size;do{if(C=c.window_size-c.lookahead-c.strstart,c.strstart>=K+(K-ie)){for(n.arraySet(c.window,c.window,K,K,0),c.match_start-=K,c.strstart-=K,c.block_start-=K,P=R=c.hash_size;_=c.head[--P],c.head[P]=K<=_?_-K:0,--R;);for(P=R=K;_=c.prev[--P],c.prev[P]=K<=_?_-K:0,--R;);C+=K}if(c.strm.avail_in===0)break;if(W=c.strm,Z=c.window,B=c.strstart+c.lookahead,V=C,ne=void 0,ne=W.avail_in,V<ne&&(ne=V),R=ne===0?0:(W.avail_in-=ne,n.arraySet(Z,W.input,W.next_in,ne,B),W.state.wrap===1?W.adler=i(W.adler,Z,ne,B):W.state.wrap===2&&(W.adler=u(W.adler,Z,ne,B)),W.next_in+=ne,W.total_in+=ne,ne),c.lookahead+=R,c.lookahead+c.insert>=A)for(x=c.strstart-c.insert,c.ins_h=c.window[x],c.ins_h=(c.ins_h<<c.hash_shift^c.window[x+1])&c.hash_mask;c.insert&&(c.ins_h=(c.ins_h<<c.hash_shift^c.window[x+A-1])&c.hash_mask,c.prev[x&c.w_mask]=c.head[c.ins_h],c.head[c.ins_h]=x,x++,c.insert--,!(c.lookahead+c.insert<A)););}while(c.lookahead<ie&&c.strm.avail_in!==0)}function Ne(c,P){for(var R,_;;){if(c.lookahead<ie){if(Te(c),c.lookahead<ie&&P===v)return d;if(c.lookahead===0)break}if(R=0,c.lookahead>=A&&(c.ins_h=(c.ins_h<<c.hash_shift^c.window[c.strstart+A-1])&c.hash_mask,R=c.prev[c.strstart&c.w_mask]=c.head[c.ins_h],c.head[c.ins_h]=c.strstart),R!==0&&c.strstart-R<=c.w_size-ie&&(c.match_length=Y(c,R)),c.match_length>=A)if(_=a._tr_tally(c,c.strstart-c.match_start,c.match_length-A),c.lookahead-=c.match_length,c.match_length<=c.max_lazy_match&&c.lookahead>=A){for(c.match_length--;c.strstart++,c.ins_h=(c.ins_h<<c.hash_shift^c.window[c.strstart+A-1])&c.hash_mask,R=c.prev[c.strstart&c.w_mask]=c.head[c.ins_h],c.head[c.ins_h]=c.strstart,--c.match_length!=0;);c.strstart++}else c.strstart+=c.match_length,c.match_length=0,c.ins_h=c.window[c.strstart],c.ins_h=(c.ins_h<<c.hash_shift^c.window[c.strstart+1])&c.hash_mask;else _=a._tr_tally(c,0,c.window[c.strstart]),c.lookahead--,c.strstart++;if(_&&(D(c,!1),c.strm.avail_out===0))return d}return c.insert=c.strstart<A-1?c.strstart:A-1,P===h?(D(c,!0),c.strm.avail_out===0?ue:j):c.last_lit&&(D(c,!1),c.strm.avail_out===0)?d:F}function be(c,P){for(var R,_,C;;){if(c.lookahead<ie){if(Te(c),c.lookahead<ie&&P===v)return d;if(c.lookahead===0)break}if(R=0,c.lookahead>=A&&(c.ins_h=(c.ins_h<<c.hash_shift^c.window[c.strstart+A-1])&c.hash_mask,R=c.prev[c.strstart&c.w_mask]=c.head[c.ins_h],c.head[c.ins_h]=c.strstart),c.prev_length=c.match_length,c.prev_match=c.match_start,c.match_length=A-1,R!==0&&c.prev_length<c.max_lazy_match&&c.strstart-R<=c.w_size-ie&&(c.match_length=Y(c,R),c.match_length<=5&&(c.strategy===1||c.match_length===A&&4096<c.strstart-c.match_start)&&(c.match_length=A-1)),c.prev_length>=A&&c.match_length<=c.prev_length){for(C=c.strstart+c.lookahead-A,_=a._tr_tally(c,c.strstart-1-c.prev_match,c.prev_length-A),c.lookahead-=c.prev_length-1,c.prev_length-=2;++c.strstart<=C&&(c.ins_h=(c.ins_h<<c.hash_shift^c.window[c.strstart+A-1])&c.hash_mask,R=c.prev[c.strstart&c.w_mask]=c.head[c.ins_h],c.head[c.ins_h]=c.strstart),--c.prev_length!=0;);if(c.match_available=0,c.match_length=A-1,c.strstart++,_&&(D(c,!1),c.strm.avail_out===0))return d}else if(c.match_available){if((_=a._tr_tally(c,0,c.window[c.strstart-1]))&&D(c,!1),c.strstart++,c.lookahead--,c.strm.avail_out===0)return d}else c.match_available=1,c.strstart++,c.lookahead--}return c.match_available&&(_=a._tr_tally(c,0,c.window[c.strstart-1]),c.match_available=0),c.insert=c.strstart<A-1?c.strstart:A-1,P===h?(D(c,!0),c.strm.avail_out===0?ue:j):c.last_lit&&(D(c,!1),c.strm.avail_out===0)?d:F}function Ce(c,P,R,_,C){this.good_length=c,this.max_lazy=P,this.nice_length=R,this.max_chain=_,this.func=C}function Ae(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=w,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new n.Buf16(2*M),this.dyn_dtree=new n.Buf16(2*(2*S+1)),this.bl_tree=new n.Buf16(2*(2*O+1)),te(this.dyn_ltree),te(this.dyn_dtree),te(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new n.Buf16(U+1),this.heap=new n.Buf16(2*I+1),te(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new n.Buf16(2*I+1),te(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function Be(c){var P;return c&&c.state?(c.total_in=c.total_out=0,c.data_type=g,(P=c.state).pending=0,P.pending_out=0,P.wrap<0&&(P.wrap=-P.wrap),P.status=P.wrap?E:z,c.adler=P.wrap===2?0:1,P.last_flush=v,a._tr_init(P),f):fe(c,b)}function Ke(c){var P=Be(c);return P===f&&function(R){R.window_size=2*R.w_size,te(R.head),R.max_lazy_match=t[R.level].max_lazy,R.good_match=t[R.level].good_length,R.nice_match=t[R.level].nice_length,R.max_chain_length=t[R.level].max_chain,R.strstart=0,R.block_start=0,R.lookahead=0,R.insert=0,R.match_length=R.prev_length=A-1,R.match_available=0,R.ins_h=0}(c.state),P}function Je(c,P,R,_,C,x){if(!c)return b;var W=1;if(P===m&&(P=6),_<0?(W=0,_=-_):15<_&&(W=2,_-=16),C<1||k<C||R!==w||_<8||15<_||P<0||9<P||x<0||y<x)return fe(c,b);_===8&&(_=9);var Z=new Ae;return(c.state=Z).strm=c,Z.wrap=W,Z.gzhead=null,Z.w_bits=_,Z.w_size=1<<Z.w_bits,Z.w_mask=Z.w_size-1,Z.hash_bits=C+7,Z.hash_size=1<<Z.hash_bits,Z.hash_mask=Z.hash_size-1,Z.hash_shift=~~((Z.hash_bits+A-1)/A),Z.window=new n.Buf8(2*Z.w_size),Z.head=new n.Buf16(Z.hash_size),Z.prev=new n.Buf16(Z.w_size),Z.lit_bufsize=1<<C+6,Z.pending_buf_size=4*Z.lit_bufsize,Z.pending_buf=new n.Buf8(Z.pending_buf_size),Z.d_buf=1*Z.lit_bufsize,Z.l_buf=3*Z.lit_bufsize,Z.level=P,Z.strategy=x,Z.method=R,Ke(c)}t=[new Ce(0,0,0,0,function(c,P){var R=65535;for(R>c.pending_buf_size-5&&(R=c.pending_buf_size-5);;){if(c.lookahead<=1){if(Te(c),c.lookahead===0&&P===v)return d;if(c.lookahead===0)break}c.strstart+=c.lookahead,c.lookahead=0;var _=c.block_start+R;if((c.strstart===0||c.strstart>=_)&&(c.lookahead=c.strstart-_,c.strstart=_,D(c,!1),c.strm.avail_out===0)||c.strstart-c.block_start>=c.w_size-ie&&(D(c,!1),c.strm.avail_out===0))return d}return c.insert=0,P===h?(D(c,!0),c.strm.avail_out===0?ue:j):(c.strstart>c.block_start&&(D(c,!1),c.strm.avail_out),d)}),new Ce(4,4,8,4,Ne),new Ce(4,5,16,8,Ne),new Ce(4,6,32,32,Ne),new Ce(4,4,16,16,be),new Ce(8,16,32,32,be),new Ce(8,16,128,128,be),new Ce(8,32,128,256,be),new Ce(32,128,258,1024,be),new Ce(32,258,258,4096,be)],r.deflateInit=function(c,P){return Je(c,P,w,15,8,0)},r.deflateInit2=Je,r.deflateReset=Ke,r.deflateResetKeep=Be,r.deflateSetHeader=function(c,P){return c&&c.state?c.state.wrap!==2?b:(c.state.gzhead=P,f):b},r.deflate=function(c,P){var R,_,C,x;if(!c||!c.state||5<P||P<0)return c?fe(c,b):b;if(_=c.state,!c.output||!c.input&&c.avail_in!==0||_.status===666&&P!==h)return fe(c,c.avail_out===0?-5:b);if(_.strm=c,R=_.last_flush,_.last_flush=P,_.status===E)if(_.wrap===2)c.adler=0,re(_,31),re(_,139),re(_,8),_.gzhead?(re(_,(_.gzhead.text?1:0)+(_.gzhead.hcrc?2:0)+(_.gzhead.extra?4:0)+(_.gzhead.name?8:0)+(_.gzhead.comment?16:0)),re(_,255&_.gzhead.time),re(_,_.gzhead.time>>8&255),re(_,_.gzhead.time>>16&255),re(_,_.gzhead.time>>24&255),re(_,_.level===9?2:2<=_.strategy||_.level<2?4:0),re(_,255&_.gzhead.os),_.gzhead.extra&&_.gzhead.extra.length&&(re(_,255&_.gzhead.extra.length),re(_,_.gzhead.extra.length>>8&255)),_.gzhead.hcrc&&(c.adler=u(c.adler,_.pending_buf,_.pending,0)),_.gzindex=0,_.status=69):(re(_,0),re(_,0),re(_,0),re(_,0),re(_,0),re(_,_.level===9?2:2<=_.strategy||_.level<2?4:0),re(_,3),_.status=z);else{var W=w+(_.w_bits-8<<4)<<8;W|=(2<=_.strategy||_.level<2?0:_.level<6?1:_.level===6?2:3)<<6,_.strstart!==0&&(W|=32),W+=31-W%31,_.status=z,ee(_,W),_.strstart!==0&&(ee(_,c.adler>>>16),ee(_,65535&c.adler)),c.adler=1}if(_.status===69)if(_.gzhead.extra){for(C=_.pending;_.gzindex<(65535&_.gzhead.extra.length)&&(_.pending!==_.pending_buf_size||(_.gzhead.hcrc&&_.pending>C&&(c.adler=u(c.adler,_.pending_buf,_.pending-C,C)),T(c),C=_.pending,_.pending!==_.pending_buf_size));)re(_,255&_.gzhead.extra[_.gzindex]),_.gzindex++;_.gzhead.hcrc&&_.pending>C&&(c.adler=u(c.adler,_.pending_buf,_.pending-C,C)),_.gzindex===_.gzhead.extra.length&&(_.gzindex=0,_.status=73)}else _.status=73;if(_.status===73)if(_.gzhead.name){C=_.pending;do{if(_.pending===_.pending_buf_size&&(_.gzhead.hcrc&&_.pending>C&&(c.adler=u(c.adler,_.pending_buf,_.pending-C,C)),T(c),C=_.pending,_.pending===_.pending_buf_size)){x=1;break}x=_.gzindex<_.gzhead.name.length?255&_.gzhead.name.charCodeAt(_.gzindex++):0,re(_,x)}while(x!==0);_.gzhead.hcrc&&_.pending>C&&(c.adler=u(c.adler,_.pending_buf,_.pending-C,C)),x===0&&(_.gzindex=0,_.status=91)}else _.status=91;if(_.status===91)if(_.gzhead.comment){C=_.pending;do{if(_.pending===_.pending_buf_size&&(_.gzhead.hcrc&&_.pending>C&&(c.adler=u(c.adler,_.pending_buf,_.pending-C,C)),T(c),C=_.pending,_.pending===_.pending_buf_size)){x=1;break}x=_.gzindex<_.gzhead.comment.length?255&_.gzhead.comment.charCodeAt(_.gzindex++):0,re(_,x)}while(x!==0);_.gzhead.hcrc&&_.pending>C&&(c.adler=u(c.adler,_.pending_buf,_.pending-C,C)),x===0&&(_.status=103)}else _.status=103;if(_.status===103&&(_.gzhead.hcrc?(_.pending+2>_.pending_buf_size&&T(c),_.pending+2<=_.pending_buf_size&&(re(_,255&c.adler),re(_,c.adler>>8&255),c.adler=0,_.status=z)):_.status=z),_.pending!==0){if(T(c),c.avail_out===0)return _.last_flush=-1,f}else if(c.avail_in===0&&$(P)<=$(R)&&P!==h)return fe(c,-5);if(_.status===666&&c.avail_in!==0)return fe(c,-5);if(c.avail_in!==0||_.lookahead!==0||P!==v&&_.status!==666){var Z=_.strategy===2?function(B,V){for(var ne;;){if(B.lookahead===0&&(Te(B),B.lookahead===0)){if(V===v)return d;break}if(B.match_length=0,ne=a._tr_tally(B,0,B.window[B.strstart]),B.lookahead--,B.strstart++,ne&&(D(B,!1),B.strm.avail_out===0))return d}return B.insert=0,V===h?(D(B,!0),B.strm.avail_out===0?ue:j):B.last_lit&&(D(B,!1),B.strm.avail_out===0)?d:F}(_,P):_.strategy===3?function(B,V){for(var ne,K,ce,he,ye=B.window;;){if(B.lookahead<=G){if(Te(B),B.lookahead<=G&&V===v)return d;if(B.lookahead===0)break}if(B.match_length=0,B.lookahead>=A&&0<B.strstart&&(K=ye[ce=B.strstart-1])===ye[++ce]&&K===ye[++ce]&&K===ye[++ce]){he=B.strstart+G;do;while(K===ye[++ce]&&K===ye[++ce]&&K===ye[++ce]&&K===ye[++ce]&&K===ye[++ce]&&K===ye[++ce]&&K===ye[++ce]&&K===ye[++ce]&&ce<he);B.match_length=G-(he-ce),B.match_length>B.lookahead&&(B.match_length=B.lookahead)}if(B.match_length>=A?(ne=a._tr_tally(B,1,B.match_length-A),B.lookahead-=B.match_length,B.strstart+=B.match_length,B.match_length=0):(ne=a._tr_tally(B,0,B.window[B.strstart]),B.lookahead--,B.strstart++),ne&&(D(B,!1),B.strm.avail_out===0))return d}return B.insert=0,V===h?(D(B,!0),B.strm.avail_out===0?ue:j):B.last_lit&&(D(B,!1),B.strm.avail_out===0)?d:F}(_,P):t[_.level].func(_,P);if(Z!==ue&&Z!==j||(_.status=666),Z===d||Z===ue)return c.avail_out===0&&(_.last_flush=-1),f;if(Z===F&&(P===1?a._tr_align(_):P!==5&&(a._tr_stored_block(_,0,0,!1),P===3&&(te(_.head),_.lookahead===0&&(_.strstart=0,_.block_start=0,_.insert=0))),T(c),c.avail_out===0))return _.last_flush=-1,f}return P!==h?f:_.wrap<=0?1:(_.wrap===2?(re(_,255&c.adler),re(_,c.adler>>8&255),re(_,c.adler>>16&255),re(_,c.adler>>24&255),re(_,255&c.total_in),re(_,c.total_in>>8&255),re(_,c.total_in>>16&255),re(_,c.total_in>>24&255)):(ee(_,c.adler>>>16),ee(_,65535&c.adler)),T(c),0<_.wrap&&(_.wrap=-_.wrap),_.pending!==0?f:1)},r.deflateEnd=function(c){var P;return c&&c.state?(P=c.state.status)!==E&&P!==69&&P!==73&&P!==91&&P!==103&&P!==z&&P!==666?fe(c,b):(c.state=null,P===z?fe(c,-3):f):b},r.deflateSetDictionary=function(c,P){var R,_,C,x,W,Z,B,V,ne=P.length;if(!c||!c.state||(x=(R=c.state).wrap)===2||x===1&&R.status!==E||R.lookahead)return b;for(x===1&&(c.adler=i(c.adler,P,ne,0)),R.wrap=0,ne>=R.w_size&&(x===0&&(te(R.head),R.strstart=0,R.block_start=0,R.insert=0),V=new n.Buf8(R.w_size),n.arraySet(V,P,ne-R.w_size,R.w_size,0),P=V,ne=R.w_size),W=c.avail_in,Z=c.next_in,B=c.input,c.avail_in=ne,c.next_in=0,c.input=P,Te(R);R.lookahead>=A;){for(_=R.strstart,C=R.lookahead-(A-1);R.ins_h=(R.ins_h<<R.hash_shift^R.window[_+A-1])&R.hash_mask,R.prev[_&R.w_mask]=R.head[R.ins_h],R.head[R.ins_h]=_,_++,--C;);R.strstart=_,R.lookahead=A-1,Te(R)}return R.strstart+=R.lookahead,R.block_start=R.strstart,R.insert=R.lookahead,R.lookahead=0,R.match_length=R.prev_length=A-1,R.match_available=0,c.next_in=Z,c.input=B,c.avail_in=W,R.wrap=x,f},r.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(e,l,r){l.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(e,l,r){l.exports=function(t,n){var a,i,u,p,v,h,f,b,m,y,g,w,k,I,S,O,M,U,A,G,ie,E,z,d,F;a=t.state,i=t.next_in,d=t.input,u=i+(t.avail_in-5),p=t.next_out,F=t.output,v=p-(n-t.avail_out),h=p+(t.avail_out-257),f=a.dmax,b=a.wsize,m=a.whave,y=a.wnext,g=a.window,w=a.hold,k=a.bits,I=a.lencode,S=a.distcode,O=(1<<a.lenbits)-1,M=(1<<a.distbits)-1;e:do{k<15&&(w+=d[i++]<<k,k+=8,w+=d[i++]<<k,k+=8),U=I[w&O];t:for(;;){if(w>>>=A=U>>>24,k-=A,(A=U>>>16&255)===0)F[p++]=65535&U;else{if(!(16&A)){if(!(64&A)){U=I[(65535&U)+(w&(1<<A)-1)];continue t}if(32&A){a.mode=12;break e}t.msg="invalid literal/length code",a.mode=30;break e}G=65535&U,(A&=15)&&(k<A&&(w+=d[i++]<<k,k+=8),G+=w&(1<<A)-1,w>>>=A,k-=A),k<15&&(w+=d[i++]<<k,k+=8,w+=d[i++]<<k,k+=8),U=S[w&M];n:for(;;){if(w>>>=A=U>>>24,k-=A,!(16&(A=U>>>16&255))){if(!(64&A)){U=S[(65535&U)+(w&(1<<A)-1)];continue n}t.msg="invalid distance code",a.mode=30;break e}if(ie=65535&U,k<(A&=15)&&(w+=d[i++]<<k,(k+=8)<A&&(w+=d[i++]<<k,k+=8)),f<(ie+=w&(1<<A)-1)){t.msg="invalid distance too far back",a.mode=30;break e}if(w>>>=A,k-=A,(A=p-v)<ie){if(m<(A=ie-A)&&a.sane){t.msg="invalid distance too far back",a.mode=30;break e}if(z=g,(E=0)===y){if(E+=b-A,A<G){for(G-=A;F[p++]=g[E++],--A;);E=p-ie,z=F}}else if(y<A){if(E+=b+y-A,(A-=y)<G){for(G-=A;F[p++]=g[E++],--A;);if(E=0,y<G){for(G-=A=y;F[p++]=g[E++],--A;);E=p-ie,z=F}}}else if(E+=y-A,A<G){for(G-=A;F[p++]=g[E++],--A;);E=p-ie,z=F}for(;2<G;)F[p++]=z[E++],F[p++]=z[E++],F[p++]=z[E++],G-=3;G&&(F[p++]=z[E++],1<G&&(F[p++]=z[E++]))}else{for(E=p-ie;F[p++]=F[E++],F[p++]=F[E++],F[p++]=F[E++],2<(G-=3););G&&(F[p++]=F[E++],1<G&&(F[p++]=F[E++]))}break}}break}}while(i<u&&p<h);i-=G=k>>3,w&=(1<<(k-=G<<3))-1,t.next_in=i,t.next_out=p,t.avail_in=i<u?u-i+5:5-(i-u),t.avail_out=p<h?h-p+257:257-(p-h),a.hold=w,a.bits=k}},{}],49:[function(e,l,r){var t=e("../utils/common"),n=e("./adler32"),a=e("./crc32"),i=e("./inffast"),u=e("./inftrees"),p=1,v=2,h=0,f=-2,b=1,m=852,y=592;function g(E){return(E>>>24&255)+(E>>>8&65280)+((65280&E)<<8)+((255&E)<<24)}function w(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new t.Buf16(320),this.work=new t.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function k(E){var z;return E&&E.state?(z=E.state,E.total_in=E.total_out=z.total=0,E.msg="",z.wrap&&(E.adler=1&z.wrap),z.mode=b,z.last=0,z.havedict=0,z.dmax=32768,z.head=null,z.hold=0,z.bits=0,z.lencode=z.lendyn=new t.Buf32(m),z.distcode=z.distdyn=new t.Buf32(y),z.sane=1,z.back=-1,h):f}function I(E){var z;return E&&E.state?((z=E.state).wsize=0,z.whave=0,z.wnext=0,k(E)):f}function S(E,z){var d,F;return E&&E.state?(F=E.state,z<0?(d=0,z=-z):(d=1+(z>>4),z<48&&(z&=15)),z&&(z<8||15<z)?f:(F.window!==null&&F.wbits!==z&&(F.window=null),F.wrap=d,F.wbits=z,I(E))):f}function O(E,z){var d,F;return E?(F=new w,(E.state=F).window=null,(d=S(E,z))!==h&&(E.state=null),d):f}var M,U,A=!0;function G(E){if(A){var z;for(M=new t.Buf32(512),U=new t.Buf32(32),z=0;z<144;)E.lens[z++]=8;for(;z<256;)E.lens[z++]=9;for(;z<280;)E.lens[z++]=7;for(;z<288;)E.lens[z++]=8;for(u(p,E.lens,0,288,M,0,E.work,{bits:9}),z=0;z<32;)E.lens[z++]=5;u(v,E.lens,0,32,U,0,E.work,{bits:5}),A=!1}E.lencode=M,E.lenbits=9,E.distcode=U,E.distbits=5}function ie(E,z,d,F){var ue,j=E.state;return j.window===null&&(j.wsize=1<<j.wbits,j.wnext=0,j.whave=0,j.window=new t.Buf8(j.wsize)),F>=j.wsize?(t.arraySet(j.window,z,d-j.wsize,j.wsize,0),j.wnext=0,j.whave=j.wsize):(F<(ue=j.wsize-j.wnext)&&(ue=F),t.arraySet(j.window,z,d-F,ue,j.wnext),(F-=ue)?(t.arraySet(j.window,z,d-F,F,0),j.wnext=F,j.whave=j.wsize):(j.wnext+=ue,j.wnext===j.wsize&&(j.wnext=0),j.whave<j.wsize&&(j.whave+=ue))),0}r.inflateReset=I,r.inflateReset2=S,r.inflateResetKeep=k,r.inflateInit=function(E){return O(E,15)},r.inflateInit2=O,r.inflate=function(E,z){var d,F,ue,j,fe,$,te,T,D,re,ee,Y,Te,Ne,be,Ce,Ae,Be,Ke,Je,c,P,R,_,C=0,x=new t.Buf8(4),W=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!E||!E.state||!E.output||!E.input&&E.avail_in!==0)return f;(d=E.state).mode===12&&(d.mode=13),fe=E.next_out,ue=E.output,te=E.avail_out,j=E.next_in,F=E.input,$=E.avail_in,T=d.hold,D=d.bits,re=$,ee=te,P=h;e:for(;;)switch(d.mode){case b:if(d.wrap===0){d.mode=13;break}for(;D<16;){if($===0)break e;$--,T+=F[j++]<<D,D+=8}if(2&d.wrap&&T===35615){x[d.check=0]=255&T,x[1]=T>>>8&255,d.check=a(d.check,x,2,0),D=T=0,d.mode=2;break}if(d.flags=0,d.head&&(d.head.done=!1),!(1&d.wrap)||(((255&T)<<8)+(T>>8))%31){E.msg="incorrect header check",d.mode=30;break}if((15&T)!=8){E.msg="unknown compression method",d.mode=30;break}if(D-=4,c=8+(15&(T>>>=4)),d.wbits===0)d.wbits=c;else if(c>d.wbits){E.msg="invalid window size",d.mode=30;break}d.dmax=1<<c,E.adler=d.check=1,d.mode=512&T?10:12,D=T=0;break;case 2:for(;D<16;){if($===0)break e;$--,T+=F[j++]<<D,D+=8}if(d.flags=T,(255&d.flags)!=8){E.msg="unknown compression method",d.mode=30;break}if(57344&d.flags){E.msg="unknown header flags set",d.mode=30;break}d.head&&(d.head.text=T>>8&1),512&d.flags&&(x[0]=255&T,x[1]=T>>>8&255,d.check=a(d.check,x,2,0)),D=T=0,d.mode=3;case 3:for(;D<32;){if($===0)break e;$--,T+=F[j++]<<D,D+=8}d.head&&(d.head.time=T),512&d.flags&&(x[0]=255&T,x[1]=T>>>8&255,x[2]=T>>>16&255,x[3]=T>>>24&255,d.check=a(d.check,x,4,0)),D=T=0,d.mode=4;case 4:for(;D<16;){if($===0)break e;$--,T+=F[j++]<<D,D+=8}d.head&&(d.head.xflags=255&T,d.head.os=T>>8),512&d.flags&&(x[0]=255&T,x[1]=T>>>8&255,d.check=a(d.check,x,2,0)),D=T=0,d.mode=5;case 5:if(1024&d.flags){for(;D<16;){if($===0)break e;$--,T+=F[j++]<<D,D+=8}d.length=T,d.head&&(d.head.extra_len=T),512&d.flags&&(x[0]=255&T,x[1]=T>>>8&255,d.check=a(d.check,x,2,0)),D=T=0}else d.head&&(d.head.extra=null);d.mode=6;case 6:if(1024&d.flags&&($<(Y=d.length)&&(Y=$),Y&&(d.head&&(c=d.head.extra_len-d.length,d.head.extra||(d.head.extra=new Array(d.head.extra_len)),t.arraySet(d.head.extra,F,j,Y,c)),512&d.flags&&(d.check=a(d.check,F,Y,j)),$-=Y,j+=Y,d.length-=Y),d.length))break e;d.length=0,d.mode=7;case 7:if(2048&d.flags){if($===0)break e;for(Y=0;c=F[j+Y++],d.head&&c&&d.length<65536&&(d.head.name+=String.fromCharCode(c)),c&&Y<$;);if(512&d.flags&&(d.check=a(d.check,F,Y,j)),$-=Y,j+=Y,c)break e}else d.head&&(d.head.name=null);d.length=0,d.mode=8;case 8:if(4096&d.flags){if($===0)break e;for(Y=0;c=F[j+Y++],d.head&&c&&d.length<65536&&(d.head.comment+=String.fromCharCode(c)),c&&Y<$;);if(512&d.flags&&(d.check=a(d.check,F,Y,j)),$-=Y,j+=Y,c)break e}else d.head&&(d.head.comment=null);d.mode=9;case 9:if(512&d.flags){for(;D<16;){if($===0)break e;$--,T+=F[j++]<<D,D+=8}if(T!==(65535&d.check)){E.msg="header crc mismatch",d.mode=30;break}D=T=0}d.head&&(d.head.hcrc=d.flags>>9&1,d.head.done=!0),E.adler=d.check=0,d.mode=12;break;case 10:for(;D<32;){if($===0)break e;$--,T+=F[j++]<<D,D+=8}E.adler=d.check=g(T),D=T=0,d.mode=11;case 11:if(d.havedict===0)return E.next_out=fe,E.avail_out=te,E.next_in=j,E.avail_in=$,d.hold=T,d.bits=D,2;E.adler=d.check=1,d.mode=12;case 12:if(z===5||z===6)break e;case 13:if(d.last){T>>>=7&D,D-=7&D,d.mode=27;break}for(;D<3;){if($===0)break e;$--,T+=F[j++]<<D,D+=8}switch(d.last=1&T,D-=1,3&(T>>>=1)){case 0:d.mode=14;break;case 1:if(G(d),d.mode=20,z!==6)break;T>>>=2,D-=2;break e;case 2:d.mode=17;break;case 3:E.msg="invalid block type",d.mode=30}T>>>=2,D-=2;break;case 14:for(T>>>=7&D,D-=7&D;D<32;){if($===0)break e;$--,T+=F[j++]<<D,D+=8}if((65535&T)!=(T>>>16^65535)){E.msg="invalid stored block lengths",d.mode=30;break}if(d.length=65535&T,D=T=0,d.mode=15,z===6)break e;case 15:d.mode=16;case 16:if(Y=d.length){if($<Y&&(Y=$),te<Y&&(Y=te),Y===0)break e;t.arraySet(ue,F,j,Y,fe),$-=Y,j+=Y,te-=Y,fe+=Y,d.length-=Y;break}d.mode=12;break;case 17:for(;D<14;){if($===0)break e;$--,T+=F[j++]<<D,D+=8}if(d.nlen=257+(31&T),T>>>=5,D-=5,d.ndist=1+(31&T),T>>>=5,D-=5,d.ncode=4+(15&T),T>>>=4,D-=4,286<d.nlen||30<d.ndist){E.msg="too many length or distance symbols",d.mode=30;break}d.have=0,d.mode=18;case 18:for(;d.have<d.ncode;){for(;D<3;){if($===0)break e;$--,T+=F[j++]<<D,D+=8}d.lens[W[d.have++]]=7&T,T>>>=3,D-=3}for(;d.have<19;)d.lens[W[d.have++]]=0;if(d.lencode=d.lendyn,d.lenbits=7,R={bits:d.lenbits},P=u(0,d.lens,0,19,d.lencode,0,d.work,R),d.lenbits=R.bits,P){E.msg="invalid code lengths set",d.mode=30;break}d.have=0,d.mode=19;case 19:for(;d.have<d.nlen+d.ndist;){for(;Ce=(C=d.lencode[T&(1<<d.lenbits)-1])>>>16&255,Ae=65535&C,!((be=C>>>24)<=D);){if($===0)break e;$--,T+=F[j++]<<D,D+=8}if(Ae<16)T>>>=be,D-=be,d.lens[d.have++]=Ae;else{if(Ae===16){for(_=be+2;D<_;){if($===0)break e;$--,T+=F[j++]<<D,D+=8}if(T>>>=be,D-=be,d.have===0){E.msg="invalid bit length repeat",d.mode=30;break}c=d.lens[d.have-1],Y=3+(3&T),T>>>=2,D-=2}else if(Ae===17){for(_=be+3;D<_;){if($===0)break e;$--,T+=F[j++]<<D,D+=8}D-=be,c=0,Y=3+(7&(T>>>=be)),T>>>=3,D-=3}else{for(_=be+7;D<_;){if($===0)break e;$--,T+=F[j++]<<D,D+=8}D-=be,c=0,Y=11+(127&(T>>>=be)),T>>>=7,D-=7}if(d.have+Y>d.nlen+d.ndist){E.msg="invalid bit length repeat",d.mode=30;break}for(;Y--;)d.lens[d.have++]=c}}if(d.mode===30)break;if(d.lens[256]===0){E.msg="invalid code -- missing end-of-block",d.mode=30;break}if(d.lenbits=9,R={bits:d.lenbits},P=u(p,d.lens,0,d.nlen,d.lencode,0,d.work,R),d.lenbits=R.bits,P){E.msg="invalid literal/lengths set",d.mode=30;break}if(d.distbits=6,d.distcode=d.distdyn,R={bits:d.distbits},P=u(v,d.lens,d.nlen,d.ndist,d.distcode,0,d.work,R),d.distbits=R.bits,P){E.msg="invalid distances set",d.mode=30;break}if(d.mode=20,z===6)break e;case 20:d.mode=21;case 21:if(6<=$&&258<=te){E.next_out=fe,E.avail_out=te,E.next_in=j,E.avail_in=$,d.hold=T,d.bits=D,i(E,ee),fe=E.next_out,ue=E.output,te=E.avail_out,j=E.next_in,F=E.input,$=E.avail_in,T=d.hold,D=d.bits,d.mode===12&&(d.back=-1);break}for(d.back=0;Ce=(C=d.lencode[T&(1<<d.lenbits)-1])>>>16&255,Ae=65535&C,!((be=C>>>24)<=D);){if($===0)break e;$--,T+=F[j++]<<D,D+=8}if(Ce&&!(240&Ce)){for(Be=be,Ke=Ce,Je=Ae;Ce=(C=d.lencode[Je+((T&(1<<Be+Ke)-1)>>Be)])>>>16&255,Ae=65535&C,!(Be+(be=C>>>24)<=D);){if($===0)break e;$--,T+=F[j++]<<D,D+=8}T>>>=Be,D-=Be,d.back+=Be}if(T>>>=be,D-=be,d.back+=be,d.length=Ae,Ce===0){d.mode=26;break}if(32&Ce){d.back=-1,d.mode=12;break}if(64&Ce){E.msg="invalid literal/length code",d.mode=30;break}d.extra=15&Ce,d.mode=22;case 22:if(d.extra){for(_=d.extra;D<_;){if($===0)break e;$--,T+=F[j++]<<D,D+=8}d.length+=T&(1<<d.extra)-1,T>>>=d.extra,D-=d.extra,d.back+=d.extra}d.was=d.length,d.mode=23;case 23:for(;Ce=(C=d.distcode[T&(1<<d.distbits)-1])>>>16&255,Ae=65535&C,!((be=C>>>24)<=D);){if($===0)break e;$--,T+=F[j++]<<D,D+=8}if(!(240&Ce)){for(Be=be,Ke=Ce,Je=Ae;Ce=(C=d.distcode[Je+((T&(1<<Be+Ke)-1)>>Be)])>>>16&255,Ae=65535&C,!(Be+(be=C>>>24)<=D);){if($===0)break e;$--,T+=F[j++]<<D,D+=8}T>>>=Be,D-=Be,d.back+=Be}if(T>>>=be,D-=be,d.back+=be,64&Ce){E.msg="invalid distance code",d.mode=30;break}d.offset=Ae,d.extra=15&Ce,d.mode=24;case 24:if(d.extra){for(_=d.extra;D<_;){if($===0)break e;$--,T+=F[j++]<<D,D+=8}d.offset+=T&(1<<d.extra)-1,T>>>=d.extra,D-=d.extra,d.back+=d.extra}if(d.offset>d.dmax){E.msg="invalid distance too far back",d.mode=30;break}d.mode=25;case 25:if(te===0)break e;if(Y=ee-te,d.offset>Y){if((Y=d.offset-Y)>d.whave&&d.sane){E.msg="invalid distance too far back",d.mode=30;break}Te=Y>d.wnext?(Y-=d.wnext,d.wsize-Y):d.wnext-Y,Y>d.length&&(Y=d.length),Ne=d.window}else Ne=ue,Te=fe-d.offset,Y=d.length;for(te<Y&&(Y=te),te-=Y,d.length-=Y;ue[fe++]=Ne[Te++],--Y;);d.length===0&&(d.mode=21);break;case 26:if(te===0)break e;ue[fe++]=d.length,te--,d.mode=21;break;case 27:if(d.wrap){for(;D<32;){if($===0)break e;$--,T|=F[j++]<<D,D+=8}if(ee-=te,E.total_out+=ee,d.total+=ee,ee&&(E.adler=d.check=d.flags?a(d.check,ue,ee,fe-ee):n(d.check,ue,ee,fe-ee)),ee=te,(d.flags?T:g(T))!==d.check){E.msg="incorrect data check",d.mode=30;break}D=T=0}d.mode=28;case 28:if(d.wrap&&d.flags){for(;D<32;){if($===0)break e;$--,T+=F[j++]<<D,D+=8}if(T!==(4294967295&d.total)){E.msg="incorrect length check",d.mode=30;break}D=T=0}d.mode=29;case 29:P=1;break e;case 30:P=-3;break e;case 31:return-4;case 32:default:return f}return E.next_out=fe,E.avail_out=te,E.next_in=j,E.avail_in=$,d.hold=T,d.bits=D,(d.wsize||ee!==E.avail_out&&d.mode<30&&(d.mode<27||z!==4))&&ie(E,E.output,E.next_out,ee-E.avail_out)?(d.mode=31,-4):(re-=E.avail_in,ee-=E.avail_out,E.total_in+=re,E.total_out+=ee,d.total+=ee,d.wrap&&ee&&(E.adler=d.check=d.flags?a(d.check,ue,ee,E.next_out-ee):n(d.check,ue,ee,E.next_out-ee)),E.data_type=d.bits+(d.last?64:0)+(d.mode===12?128:0)+(d.mode===20||d.mode===15?256:0),(re==0&&ee===0||z===4)&&P===h&&(P=-5),P)},r.inflateEnd=function(E){if(!E||!E.state)return f;var z=E.state;return z.window&&(z.window=null),E.state=null,h},r.inflateGetHeader=function(E,z){var d;return E&&E.state&&2&(d=E.state).wrap?((d.head=z).done=!1,h):f},r.inflateSetDictionary=function(E,z){var d,F=z.length;return E&&E.state?(d=E.state).wrap!==0&&d.mode!==11?f:d.mode===11&&n(1,z,F,0)!==d.check?-3:ie(E,z,F,F)?(d.mode=31,-4):(d.havedict=1,h):f},r.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(e,l,r){var t=e("../utils/common"),n=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],a=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],i=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],u=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];l.exports=function(p,v,h,f,b,m,y,g){var w,k,I,S,O,M,U,A,G,ie=g.bits,E=0,z=0,d=0,F=0,ue=0,j=0,fe=0,$=0,te=0,T=0,D=null,re=0,ee=new t.Buf16(16),Y=new t.Buf16(16),Te=null,Ne=0;for(E=0;E<=15;E++)ee[E]=0;for(z=0;z<f;z++)ee[v[h+z]]++;for(ue=ie,F=15;1<=F&&ee[F]===0;F--);if(F<ue&&(ue=F),F===0)return b[m++]=20971520,b[m++]=20971520,g.bits=1,0;for(d=1;d<F&&ee[d]===0;d++);for(ue<d&&(ue=d),E=$=1;E<=15;E++)if($<<=1,($-=ee[E])<0)return-1;if(0<$&&(p===0||F!==1))return-1;for(Y[1]=0,E=1;E<15;E++)Y[E+1]=Y[E]+ee[E];for(z=0;z<f;z++)v[h+z]!==0&&(y[Y[v[h+z]]++]=z);if(M=p===0?(D=Te=y,19):p===1?(D=n,re-=257,Te=a,Ne-=257,256):(D=i,Te=u,-1),E=d,O=m,fe=z=T=0,I=-1,S=(te=1<<(j=ue))-1,p===1&&852<te||p===2&&592<te)return 1;for(;;){for(U=E-fe,G=y[z]<M?(A=0,y[z]):y[z]>M?(A=Te[Ne+y[z]],D[re+y[z]]):(A=96,0),w=1<<E-fe,d=k=1<<j;b[O+(T>>fe)+(k-=w)]=U<<24|A<<16|G|0,k!==0;);for(w=1<<E-1;T&w;)w>>=1;if(w!==0?(T&=w-1,T+=w):T=0,z++,--ee[E]==0){if(E===F)break;E=v[h+y[z]]}if(ue<E&&(T&S)!==I){for(fe===0&&(fe=ue),O+=d,$=1<<(j=E-fe);j+fe<F&&!(($-=ee[j+fe])<=0);)j++,$<<=1;if(te+=1<<j,p===1&&852<te||p===2&&592<te)return 1;b[I=T&S]=ue<<24|j<<16|O-m|0}}return T!==0&&(b[O+T]=E-fe<<24|64<<16|0),g.bits=ue,0}},{"../utils/common":41}],51:[function(e,l,r){l.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(e,l,r){var t=e("../utils/common"),n=0,a=1;function i(C){for(var x=C.length;0<=--x;)C[x]=0}var u=0,p=29,v=256,h=v+1+p,f=30,b=19,m=2*h+1,y=15,g=16,w=7,k=256,I=16,S=17,O=18,M=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],U=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],A=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],G=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],ie=new Array(2*(h+2));i(ie);var E=new Array(2*f);i(E);var z=new Array(512);i(z);var d=new Array(256);i(d);var F=new Array(p);i(F);var ue,j,fe,$=new Array(f);function te(C,x,W,Z,B){this.static_tree=C,this.extra_bits=x,this.extra_base=W,this.elems=Z,this.max_length=B,this.has_stree=C&&C.length}function T(C,x){this.dyn_tree=C,this.max_code=0,this.stat_desc=x}function D(C){return C<256?z[C]:z[256+(C>>>7)]}function re(C,x){C.pending_buf[C.pending++]=255&x,C.pending_buf[C.pending++]=x>>>8&255}function ee(C,x,W){C.bi_valid>g-W?(C.bi_buf|=x<<C.bi_valid&65535,re(C,C.bi_buf),C.bi_buf=x>>g-C.bi_valid,C.bi_valid+=W-g):(C.bi_buf|=x<<C.bi_valid&65535,C.bi_valid+=W)}function Y(C,x,W){ee(C,W[2*x],W[2*x+1])}function Te(C,x){for(var W=0;W|=1&C,C>>>=1,W<<=1,0<--x;);return W>>>1}function Ne(C,x,W){var Z,B,V=new Array(y+1),ne=0;for(Z=1;Z<=y;Z++)V[Z]=ne=ne+W[Z-1]<<1;for(B=0;B<=x;B++){var K=C[2*B+1];K!==0&&(C[2*B]=Te(V[K]++,K))}}function be(C){var x;for(x=0;x<h;x++)C.dyn_ltree[2*x]=0;for(x=0;x<f;x++)C.dyn_dtree[2*x]=0;for(x=0;x<b;x++)C.bl_tree[2*x]=0;C.dyn_ltree[2*k]=1,C.opt_len=C.static_len=0,C.last_lit=C.matches=0}function Ce(C){8<C.bi_valid?re(C,C.bi_buf):0<C.bi_valid&&(C.pending_buf[C.pending++]=C.bi_buf),C.bi_buf=0,C.bi_valid=0}function Ae(C,x,W,Z){var B=2*x,V=2*W;return C[B]<C[V]||C[B]===C[V]&&Z[x]<=Z[W]}function Be(C,x,W){for(var Z=C.heap[W],B=W<<1;B<=C.heap_len&&(B<C.heap_len&&Ae(x,C.heap[B+1],C.heap[B],C.depth)&&B++,!Ae(x,Z,C.heap[B],C.depth));)C.heap[W]=C.heap[B],W=B,B<<=1;C.heap[W]=Z}function Ke(C,x,W){var Z,B,V,ne,K=0;if(C.last_lit!==0)for(;Z=C.pending_buf[C.d_buf+2*K]<<8|C.pending_buf[C.d_buf+2*K+1],B=C.pending_buf[C.l_buf+K],K++,Z===0?Y(C,B,x):(Y(C,(V=d[B])+v+1,x),(ne=M[V])!==0&&ee(C,B-=F[V],ne),Y(C,V=D(--Z),W),(ne=U[V])!==0&&ee(C,Z-=$[V],ne)),K<C.last_lit;);Y(C,k,x)}function Je(C,x){var W,Z,B,V=x.dyn_tree,ne=x.stat_desc.static_tree,K=x.stat_desc.has_stree,ce=x.stat_desc.elems,he=-1;for(C.heap_len=0,C.heap_max=m,W=0;W<ce;W++)V[2*W]!==0?(C.heap[++C.heap_len]=he=W,C.depth[W]=0):V[2*W+1]=0;for(;C.heap_len<2;)V[2*(B=C.heap[++C.heap_len]=he<2?++he:0)]=1,C.depth[B]=0,C.opt_len--,K&&(C.static_len-=ne[2*B+1]);for(x.max_code=he,W=C.heap_len>>1;1<=W;W--)Be(C,V,W);for(B=ce;W=C.heap[1],C.heap[1]=C.heap[C.heap_len--],Be(C,V,1),Z=C.heap[1],C.heap[--C.heap_max]=W,C.heap[--C.heap_max]=Z,V[2*B]=V[2*W]+V[2*Z],C.depth[B]=(C.depth[W]>=C.depth[Z]?C.depth[W]:C.depth[Z])+1,V[2*W+1]=V[2*Z+1]=B,C.heap[1]=B++,Be(C,V,1),2<=C.heap_len;);C.heap[--C.heap_max]=C.heap[1],function(ye,Ze){var ft,qe,gt,De,St,zt,Qe=Ze.dyn_tree,it=Ze.max_code,rn=Ze.stat_desc.static_tree,$t=Ze.stat_desc.has_stree,Fn=Ze.stat_desc.extra_bits,Ft=Ze.stat_desc.extra_base,yt=Ze.stat_desc.max_length,bt=0;for(De=0;De<=y;De++)ye.bl_count[De]=0;for(Qe[2*ye.heap[ye.heap_max]+1]=0,ft=ye.heap_max+1;ft<m;ft++)yt<(De=Qe[2*Qe[2*(qe=ye.heap[ft])+1]+1]+1)&&(De=yt,bt++),Qe[2*qe+1]=De,it<qe||(ye.bl_count[De]++,St=0,Ft<=qe&&(St=Fn[qe-Ft]),zt=Qe[2*qe],ye.opt_len+=zt*(De+St),$t&&(ye.static_len+=zt*(rn[2*qe+1]+St)));if(bt!==0){do{for(De=yt-1;ye.bl_count[De]===0;)De--;ye.bl_count[De]--,ye.bl_count[De+1]+=2,ye.bl_count[yt]--,bt-=2}while(0<bt);for(De=yt;De!==0;De--)for(qe=ye.bl_count[De];qe!==0;)it<(gt=ye.heap[--ft])||(Qe[2*gt+1]!==De&&(ye.opt_len+=(De-Qe[2*gt+1])*Qe[2*gt],Qe[2*gt+1]=De),qe--)}}(C,x),Ne(V,he,C.bl_count)}function c(C,x,W){var Z,B,V=-1,ne=x[1],K=0,ce=7,he=4;for(ne===0&&(ce=138,he=3),x[2*(W+1)+1]=65535,Z=0;Z<=W;Z++)B=ne,ne=x[2*(Z+1)+1],++K<ce&&B===ne||(K<he?C.bl_tree[2*B]+=K:B!==0?(B!==V&&C.bl_tree[2*B]++,C.bl_tree[2*I]++):K<=10?C.bl_tree[2*S]++:C.bl_tree[2*O]++,V=B,he=(K=0)===ne?(ce=138,3):B===ne?(ce=6,3):(ce=7,4))}function P(C,x,W){var Z,B,V=-1,ne=x[1],K=0,ce=7,he=4;for(ne===0&&(ce=138,he=3),Z=0;Z<=W;Z++)if(B=ne,ne=x[2*(Z+1)+1],!(++K<ce&&B===ne)){if(K<he)for(;Y(C,B,C.bl_tree),--K!=0;);else B!==0?(B!==V&&(Y(C,B,C.bl_tree),K--),Y(C,I,C.bl_tree),ee(C,K-3,2)):K<=10?(Y(C,S,C.bl_tree),ee(C,K-3,3)):(Y(C,O,C.bl_tree),ee(C,K-11,7));V=B,he=(K=0)===ne?(ce=138,3):B===ne?(ce=6,3):(ce=7,4)}}i($);var R=!1;function _(C,x,W,Z){ee(C,(u<<1)+(Z?1:0),3),function(B,V,ne,K){Ce(B),re(B,ne),re(B,~ne),t.arraySet(B.pending_buf,B.window,V,ne,B.pending),B.pending+=ne}(C,x,W)}r._tr_init=function(C){R||(function(){var x,W,Z,B,V,ne=new Array(y+1);for(B=Z=0;B<p-1;B++)for(F[B]=Z,x=0;x<1<<M[B];x++)d[Z++]=B;for(d[Z-1]=B,B=V=0;B<16;B++)for($[B]=V,x=0;x<1<<U[B];x++)z[V++]=B;for(V>>=7;B<f;B++)for($[B]=V<<7,x=0;x<1<<U[B]-7;x++)z[256+V++]=B;for(W=0;W<=y;W++)ne[W]=0;for(x=0;x<=143;)ie[2*x+1]=8,x++,ne[8]++;for(;x<=255;)ie[2*x+1]=9,x++,ne[9]++;for(;x<=279;)ie[2*x+1]=7,x++,ne[7]++;for(;x<=287;)ie[2*x+1]=8,x++,ne[8]++;for(Ne(ie,h+1,ne),x=0;x<f;x++)E[2*x+1]=5,E[2*x]=Te(x,5);ue=new te(ie,M,v+1,h,y),j=new te(E,U,0,f,y),fe=new te(new Array(0),A,0,b,w)}(),R=!0),C.l_desc=new T(C.dyn_ltree,ue),C.d_desc=new T(C.dyn_dtree,j),C.bl_desc=new T(C.bl_tree,fe),C.bi_buf=0,C.bi_valid=0,be(C)},r._tr_stored_block=_,r._tr_flush_block=function(C,x,W,Z){var B,V,ne=0;0<C.level?(C.strm.data_type===2&&(C.strm.data_type=function(K){var ce,he=4093624447;for(ce=0;ce<=31;ce++,he>>>=1)if(1&he&&K.dyn_ltree[2*ce]!==0)return n;if(K.dyn_ltree[18]!==0||K.dyn_ltree[20]!==0||K.dyn_ltree[26]!==0)return a;for(ce=32;ce<v;ce++)if(K.dyn_ltree[2*ce]!==0)return a;return n}(C)),Je(C,C.l_desc),Je(C,C.d_desc),ne=function(K){var ce;for(c(K,K.dyn_ltree,K.l_desc.max_code),c(K,K.dyn_dtree,K.d_desc.max_code),Je(K,K.bl_desc),ce=b-1;3<=ce&&K.bl_tree[2*G[ce]+1]===0;ce--);return K.opt_len+=3*(ce+1)+5+5+4,ce}(C),B=C.opt_len+3+7>>>3,(V=C.static_len+3+7>>>3)<=B&&(B=V)):B=V=W+5,W+4<=B&&x!==-1?_(C,x,W,Z):C.strategy===4||V===B?(ee(C,2+(Z?1:0),3),Ke(C,ie,E)):(ee(C,4+(Z?1:0),3),function(K,ce,he,ye){var Ze;for(ee(K,ce-257,5),ee(K,he-1,5),ee(K,ye-4,4),Ze=0;Ze<ye;Ze++)ee(K,K.bl_tree[2*G[Ze]+1],3);P(K,K.dyn_ltree,ce-1),P(K,K.dyn_dtree,he-1)}(C,C.l_desc.max_code+1,C.d_desc.max_code+1,ne+1),Ke(C,C.dyn_ltree,C.dyn_dtree)),be(C),Z&&Ce(C)},r._tr_tally=function(C,x,W){return C.pending_buf[C.d_buf+2*C.last_lit]=x>>>8&255,C.pending_buf[C.d_buf+2*C.last_lit+1]=255&x,C.pending_buf[C.l_buf+C.last_lit]=255&W,C.last_lit++,x===0?C.dyn_ltree[2*W]++:(C.matches++,x--,C.dyn_ltree[2*(d[W]+v+1)]++,C.dyn_dtree[2*D(x)]++),C.last_lit===C.lit_bufsize-1},r._tr_align=function(C){ee(C,2,3),Y(C,k,ie),function(x){x.bi_valid===16?(re(x,x.bi_buf),x.bi_buf=0,x.bi_valid=0):8<=x.bi_valid&&(x.pending_buf[x.pending++]=255&x.bi_buf,x.bi_buf>>=8,x.bi_valid-=8)}(C)}},{"../utils/common":41}],53:[function(e,l,r){l.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(e,l,r){(function(t){(function(n,a){if(!n.setImmediate){var i,u,p,v,h=1,f={},b=!1,m=n.document,y=Object.getPrototypeOf&&Object.getPrototypeOf(n);y=y&&y.setTimeout?y:n,i={}.toString.call(n.process)==="[object process]"?function(I){process.nextTick(function(){w(I)})}:function(){if(n.postMessage&&!n.importScripts){var I=!0,S=n.onmessage;return n.onmessage=function(){I=!1},n.postMessage("","*"),n.onmessage=S,I}}()?(v="setImmediate$"+Math.random()+"$",n.addEventListener?n.addEventListener("message",k,!1):n.attachEvent("onmessage",k),function(I){n.postMessage(v+I,"*")}):n.MessageChannel?((p=new MessageChannel).port1.onmessage=function(I){w(I.data)},function(I){p.port2.postMessage(I)}):m&&"onreadystatechange"in m.createElement("script")?(u=m.documentElement,function(I){var S=m.createElement("script");S.onreadystatechange=function(){w(I),S.onreadystatechange=null,u.removeChild(S),S=null},u.appendChild(S)}):function(I){setTimeout(w,0,I)},y.setImmediate=function(I){typeof I!="function"&&(I=new Function(""+I));for(var S=new Array(arguments.length-1),O=0;O<S.length;O++)S[O]=arguments[O+1];var M={callback:I,args:S};return f[h]=M,i(h),h++},y.clearImmediate=g}function g(I){delete f[I]}function w(I){if(b)setTimeout(w,0,I);else{var S=f[I];if(S){b=!0;try{(function(O){var M=O.callback,U=O.args;switch(U.length){case 0:M();break;case 1:M(U[0]);break;case 2:M(U[0],U[1]);break;case 3:M(U[0],U[1],U[2]);break;default:M.apply(a,U)}})(S)}finally{g(I),b=!1}}}}function k(I){I.source===n&&typeof I.data=="string"&&I.data.indexOf(v)===0&&w(+I.data.slice(v.length))}})(typeof self>"u"?t===void 0?this:t:self)}).call(this,typeof ln<"u"?ln:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(Rs);var Mi=Rs.exports;const Ms=Ri(Mi);let oe={},N=null,us=null,J=null,Ee=null,Xt=null,Rn=null,fs=[],wn=null,ms=null,Ge=null,_n=0,hs=0,En=0,ps=0,gs=null,ys=null,kn=null,ht=null,et=-1,bs=null,Sn=null,In=null,zs=null,$s=null,ot=!1,pe=[],rt=[],Et=[],je={isScreenSaverEnabled:!0,lastRestoreTimestamp:null,lastBackupTimestamp:null};function le(){if(ot)return;const s={classrooms:oe,trashBin:pe,userSettings:je};localStorage.setItem("teacherAssistantData_v2",JSON.stringify(s))}function zi(s){return new Promise((o,e)=>{const l=new FileReader;l.onerror=e,l.onload=()=>{o(l.result.split(",")[1])},l.readAsDataURL(s)})}async function Fs(s=[]){const o={};if(s.length>0)s.forEach(i=>{oe[i]&&(o[i]=oe[i])});else for(const i in oe)oe[i].isDeleted||(o[i]=oe[i]);const e={metadata:{version:"2.0-b64",createdAt:new Date().toISOString()},data:{classrooms:o,trashBin:pe}},l=JSON.stringify(e),r=new Date,t=new Intl.DateTimeFormat("fa-IR-u-nu-latn",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(r).reduce((i,u)=>(i[u.type]=u.value,i),{}),a=`SP_${t.year.slice(-2)}-${t.month}-${t.day}_${t.hour}-${t.minute}.txt`;try{const i=new Ms;i.file("backup.json",l);const u=await i.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:9}}),p=await zi(u);return new File([p],a,{type:"text/plain"})}catch(i){return console.error("Error creating base64 backup file:",i),null}}function xn(){const s=localStorage.getItem("teacherAssistantData_v2");if(!s)return;const o=JSON.parse(s);o.classrooms!==void 0&&o.trashBin!==void 0?(kt(o.classrooms),pe=o.trashBin||[],je={...je,...o.userSettings}):(kt(o),$i())}function $i(){const s=[];Object.values(oe).forEach(o=>{o.isDeleted?s.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:o.info.creationDate,type:"classroom",description:`کلاس «${o.info.name}»`,restoreData:{name:o.info.name}}):o.students.forEach(e=>{e.isDeleted&&s.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:e.identity.studentId.split("_")[1],type:"student",description:`دانش‌آموز «${e.identity.name}»`,restoreData:{studentId:e.identity.studentId,classroomName:o.info.name}})})}),pe.length===0&&s.length>0&&(pe=s,console.log(`Migrated ${s.length} previously deleted item(s) to the new trash bin.`),le())}function Ps(s){const o=new un(s.identity);return o.isDeleted=s.isDeleted,o.statusCounters=s.statusCounters,o.logs=s.logs,o.logs.scores||(o.logs.scores={}),o.profile=s.profile,o.finalClassActivityScore=s.finalClassActivityScore,o.categoryCounts=s.categoryCounts||{},o.categoryIssues=s.categoryIssues||{},o.onboardingSession=s.onboardingSession||null,o}function kt(s){oe={};for(const o in s){const e=s[o];let l;e.info?l=e.info:l={...e,name:o};const r=new Zn(l);r.isDeleted=e.isDeleted,r.note=e.note||"",r.students=(e.students||[]).map(Ps),r.sessions=(e.sessions||[]).map(t=>{const n=new Os(t.sessionNumber);n.isDeleted=t.isDeleted,n.note=t.note||"",n.startTime=new Date(t.startTime),n.endTime=t.endTime?new Date(t.endTime):null,n.isFinished=t.isFinished,n.isMakeup=t.isMakeup,n.isCancelled=t.isCancelled||!1,n.studentRecords=t.studentRecords;for(const i in n.studentRecords){const u=n.studentRecords[i];u.homework&&!(u.homework instanceof jn)&&(n.studentRecords[i].homework=new jn(u.homework.status,u.homework.comment))}n.lastWinnerByCategory=t.lastWinnerByCategory,n.lastUsedCategoryId=t.lastUsedCategoryId,n.lastSelectedWinnerId=t.lastSelectedWinnerId;const a=t.winnerHistory||[];return n.winnerHistory=a.filter(i=>i&&i.winner).map(i=>({winner:r.students.find(p=>p.identity.studentId===i.winner.identity.studentId),categoryName:i.categoryName})).filter(i=>i.winner),n}),r.categories=(e.categories||[]).map(t=>{const n=new dt(t.name,t.description,t.isGradedCategory);return n.id=t.id,n.isDeleted=t.isDeleted,n}),r.futurePlans=e.futurePlans,oe[o]=r}}function Hs(s,o){if(o){const e=s.data.classrooms;for(let l in e){let r=l;const t=e[l];for(;oe[r];)r=`${r} (Restored)`;r!==l&&(t.info.name=r),oe[r]=t}if(s.data.trashBin){const l=[...pe,...s.data.trashBin],r=[...new Map(l.map(t=>[t.id,t])).values()];Dn(r)}kt(oe)}else kt(s.data.classrooms),Dn(s.data.trashBin||[]);qt({lastRestoreTimestamp:new Date().toISOString()}),le()}function Ws(s,o){if(oe[o])return{success:!1,message:"کلاسی با این نام از قبل وجود دارد."};const e=oe[s];return e?(e.info.name=o,oe[o]=e,delete oe[s],N===e&&Pe(e),{success:!0}):{success:!1,message:"کلاس مورد نظر یافت نشد."}}function Us(s,o,e){const l=e.trim();if(!l)return{success:!1,message:"نام دسته‌بندی نمی‌تواند خالی باشد."};if(s.categories.some(i=>i.id!==o.id&&!i.isDeleted&&i.name.toLowerCase()===l.toLowerCase()))return{success:!1,message:"دسته‌بندی دیگری با این نام وجود دارد."};const t=o.name,n=t.toLowerCase(),a=l.toLowerCase();return o.name=l,s.students.forEach(i=>{i.categoryCounts&&i.categoryCounts[t]!==void 0&&(i.categoryCounts[l]=i.categoryCounts[t],delete i.categoryCounts[t]),i.categoryIssues&&i.categoryIssues[t]!==void 0&&(i.categoryIssues[l]=i.categoryIssues[t],delete i.categoryIssues[t]),i.logs.scores&&i.logs.scores[n]&&(i.logs.scores[n].forEach(u=>u.skill=l),n!==a&&(i.logs.scores[a]=i.logs.scores[n],delete i.logs.scores[n]))}),s.sessions.forEach(i=>{i.lastWinnerByCategory&&i.lastWinnerByCategory[t]&&(i.lastWinnerByCategory[l]=i.lastWinnerByCategory[t],delete i.lastWinnerByCategory[t]),i.winnerHistory&&i.winnerHistory.forEach(u=>{u.categoryName===t&&(u.categoryName=l)})}),{success:!0}}function js(s,o,e){if(Le(e.students).some(u=>u.identity.name.toLowerCase()===s.identity.name.toLowerCase()))return{success:!1,message:`دانش‌آموزی با نام «${s.identity.name}» از قبل در کلاس «${e.info.name}» وجود دارد.`};const r=JSON.parse(JSON.stringify(s)),t=Ps(r),n=new Map;o.sessions.forEach(u=>{const p=u.studentRecords[s.identity.studentId];p&&n.set(u.sessionNumber,JSON.parse(JSON.stringify(p)))}),e.addStudent(t);try{const u=Le(e.sessions).filter(y=>!y.isCancelled).sort((y,g)=>g.sessionNumber-y.sessionNumber),p=u.length>0?u[0]:null;let v="؟",h={type:"system",description:"Student Move"};p&&(v=Xe(e).get(p.sessionNumber)||p.sessionNumber,h={type:"fromSession",sessionNumber:p.sessionNumber});const f=new Date().toLocaleDateString("fa-IR"),b=o.info.name,m=`این دانش آموز در جلسه ${v} و در تاریخ ${f} از کلاس «${b}» به این کلاس انتقال پیدا کرد`;t.addNote(m,h)}catch(u){console.error("Failed to add automated move note:",u)}n.size>0&&e.sessions.forEach(u=>{const p=n.get(u.sessionNumber);p&&!u.isDeleted&&!u.isCancelled&&(u.studentRecords[t.identity.studentId]=p)});const a={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`(انتقال) دانش‌آموز «${s.identity.name}» از کلاس «${o.info.name}»`,restoreData:{studentId:s.identity.studentId,classId:o.info.scheduleCode}};pe.unshift(a),pe.length>50&&pe.pop();const i=o.students.find(u=>u.identity.studentId===s.identity.studentId);return i&&(i.isDeleted=!0),{success:!0}}function Zs(){for(const s in oe){const o=oe[s];o.students.forEach(e=>{e.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0},e.categoryCounts={},e.categoryIssues={},o.sessions.forEach(l=>{const r=e.identity.studentId;l.studentRecords[r]&&(l.studentRecords[r].attendance="present")})})}le()}function Le(s){return Array.isArray(s)?s.filter(o=>!o.isDeleted):[]}function Xe(s){const o=new Map;return s&&Le(s.sessions).filter(l=>!l.isCancelled).sort((l,r)=>l.sessionNumber-r.sessionNumber).forEach((l,r)=>{o.set(l.sessionNumber,r+1)}),o}function pt(s){et=s}function st(s){bs=s}function Ln(s,o){if(!s||!o)return;const e=s.identity.studentId,l=o.students.findIndex(r=>r.identity.studentId===e);l>-1&&o.students.splice(l,1),o.sessions.forEach(r=>{r.studentRecords[e]&&delete r.studentRecords[e];for(const t in r.lastWinnerByCategory)r.lastWinnerByCategory[t]===e&&delete r.lastWinnerByCategory[t];r.lastSelectedWinnerId===e&&(r.lastSelectedWinnerId=null),r.winnerHistory=r.winnerHistory.filter(t=>t.winner&&t.winner.identity.studentId!==e)})}function qs(s,o){const e=oe[s];if(!e)return;const l=e.sessions.findIndex(r=>r.sessionNumber===o);l>-1&&(e.students.forEach(r=>{r.profile.notes&&r.profile.notes.length>0&&(r.profile.notes=r.profile.notes.filter(t=>!t.source||t.source.type!=="fromAttendance"||t.source.sessionNumber!==o)),r.onboardingSession===o&&(r.onboardingSession=null)}),e.sessions.splice(l,1))}function Gs(s,o){const e=oe[s];if(!e)return;const l=e.categories.findIndex(a=>a.id===o);if(l===-1)return;const t=e.categories[l].name,n=t.toLowerCase();e.students.forEach(a=>{a.categoryCounts&&delete a.categoryCounts[t],a.categoryIssues&&delete a.categoryIssues[t],a.logs.scores&&delete a.logs.scores[n]}),e.sessions.forEach(a=>{a.lastWinnerByCategory[t]&&delete a.lastWinnerByCategory[t],a.winnerHistory=a.winnerHistory.filter(i=>i.categoryName!==t)}),e.categories.splice(l,1)}function Vs(s,o,e,l){const r=oe[s];if(!r)return;const t=r.students.find(i=>i.identity.studentId===o);if(!t||!t.logs.scores[e.toLowerCase()])return;const n=t.logs.scores[e.toLowerCase()],a=n.findIndex(i=>i.id===l);a>-1&&n.splice(a,1)}function Ks(s,o,e){const l=oe[s];if(!l)return;const r=l.students.find(n=>n.identity.studentId===o);if(!r||!r.profile.notes)return;const t=r.profile.notes.findIndex(n=>n.id===e);t>-1&&r.profile.notes.splice(t,1)}function Js(){JSON.parse(JSON.stringify({classrooms:oe,trashBin:pe})),ot=!0}function Ys(){ot=!1,xn()}function Pe(s){N=s}function Qt(s){us=s}function Ue(s){J=s}function Ve(s){Ee=s}function Tn(s){Xt=s}function Xs(s){Rn=s}function Wt(s){fs=s}function fn(s){wn=s}function Qs(s){ms=s}function Bn(s){Ge=s}function mn(s){_n=s}function ei(s){hs=s}function hn(s){En=s}function ti(s){ps=s}function vs(s){gs=s}function Cs(s){ys=s}function en(s){kn=s}function ws(s){ht=s}function Nn(s){In=s}function ni(s){zs=s}function si(s){$s=s}function Dn(s){pe=s}function Mn(s){Sn=s}function An(s){Et=s}function qt(s){je={...je,...s},le()}function qn(s){rt=s}function _s(){je.lastBackupTimestamp=new Date().toISOString(),le()}const Fi=Object.freeze(Object.defineProperty({__proto__:null,get activeModal(){return ht},get cancelCallback(){return ys},get classrooms(){return oe},get confirmCallback(){return gs},get currentClassroom(){return N},get easterEggClickCount(){return _n},get easterEggLastClickTime(){return hs},enterDemoMode:Js,exitDemoMode:Ys,getActiveItems:Le,getSessionDisplayMap:Xe,get importedFileContent(){return wn},get isDemoMode(){return ot},get liveSession(){return us},loadData:xn,get manualSelection(){return In},moveStudent:js,get namesToImport(){return fs},get notificationTimeout(){return ms},permanentlyDeleteCategory:Gs,permanentlyDeleteNote:Ks,permanentlyDeleteScore:Vs,permanentlyDeleteSession:qs,permanentlyDeleteStudent:Ln,prepareBackupData:Fs,get previousState(){return Xt},processRestore:Hs,rehydrateData:kt,renameCategory:Us,renameClassroom:Ws,resetAllStudentCounters:Zs,get resetEasterEggClickCount(){return En},get resetEasterEggLastClickTime(){return ps},get saveCategoryCallback(){return Sn},saveData:le,get saveNoteCallback(){return bs},get secureConfirmCallback(){return kn},get selectedCategory(){return Ge},get selectedClassIds(){return rt},get selectedSession(){return J},get selectedStudentForProfile(){return Ee},get selectedStudentsForMassComment(){return Et},setActiveModal:ws,setCancelCallback:Cs,setConfirmCallback:vs,setCurrentClassroom:Pe,setEasterEggClickCount:mn,setEasterEggLastClickTime:ei,setImportedFileContent:fn,setLastBackupTimestamp:_s,setLiveSession:Qt,setManualSelection:Nn,setNamesToImport:Wt,setNotificationTimeout:Qs,setPreviousState:Tn,setResetEasterEggClickCount:hn,setResetEasterEggLastClickTime:ti,setSaveCategoryCallback:Mn,setSaveNoteCallback:st,setSecureConfirmCallback:en,setSelectedCategory:Bn,setSelectedClassIds:qn,setSelectedSession:Ue,setSelectedStudentForProfile:Ve,setSelectedStudentsForMassComment:An,setSourceClassForMove:si,setStudentToMove:ni,setTrashBin:Dn,setUndoTimeout:Xs,setUserSettings:qt,setWinnerHistoryIndex:pt,get sourceClassForMove(){return $s},get studentToMove(){return zs},get trashBin(){return pe},get undoTimeout(){return Rn},get userSettings(){return je},get winnerHistoryIndex(){return et}},Symbol.toStringTag,{value:"Module"}));function Ye(s){return typeof s!="string"?"":s.replace(/ي/g,"ی").replace(/ك/g,"ک").replace(/[\s\u200c]/g,"")}function Es(s){return typeof s!="string"||s.length===0?"ltr":/[\u0590-\u07FF]/.test(s)?"rtl":"ltr"}function ii(s){return!s||!s.trim()?"":s.split(`
`).map(l=>`<div dir="${Es(l)}">${l||"&nbsp;"}</div>`).join("")}function Un(s){if(typeof s!="string")return"";const o={q:"ض",w:"ص",e:"ث",r:"ق",t:"ف",y:"غ",u:"ع",i:"ه",o:"خ",p:"ح","[":"ج","]":"چ",a:"ش",s:"س",d:"ی",f:"ب",g:"ل",h:"ا",j:"ت",k:"ن",l:"م",";":"ک","'":"گ",z:"ظ",x:"ط",c:"ز",v:"ر",b:"ذ",n:"د",m:"پ",",":"و"};let e="";for(let l=0;l<s.length;l++){const r=s[l].toLowerCase();e+=o[r]||s[l]}return e}const ai="teacherAssistantLogs_v2",Pi=100;function ks(){try{const s=localStorage.getItem(ai);return s?JSON.parse(s):{}}catch(s){return console.error("Error reading logs from localStorage:",s),{}}}function ri(s){try{localStorage.setItem(ai,JSON.stringify(s))}catch(o){console.error("Error saving logs to localStorage:",o)}}function _e(s,o,e=null){if(!s)return;const l=ks();l[s]||(l[s]=[]);const r={timestamp:new Date().toISOString(),message:o,action:e,classroomName:s};l[s].unshift(r),l[s].length>Pi&&l[s].pop(),ri(l)}function Hi(s){return ks()[s]||[]}function Wi(s,o){const e=ks();e[s]&&!e[o]&&(e[o]=e[s],delete e[s],ri(e))}const oi=document.getElementById("class-management-page"),Ui=document.getElementById("new-class-name"),ji=document.getElementById("add-class-btn"),Bt=document.getElementById("class-list"),On=document.getElementById("undo-toast"),ci=document.getElementById("undo-message"),Zi=document.getElementById("undo-btn"),qi=document.getElementById("settings-page"),Ss=document.getElementById("settings-class-name-header"),Gn=document.getElementById("settings-student-list"),Vn=document.getElementById("category-list"),Gi=document.getElementById("back-to-sessions-btn"),Vi=document.getElementById("new-student-name"),Ki=document.getElementById("add-student-btn"),li=document.getElementById("paste-area"),Ji=document.getElementById("process-paste-btn"),Yi=document.getElementById("csv-preview-page"),Kn=document.getElementById("csv-preview-list"),Xi=document.getElementById("csv-confirm-btn"),Qi=document.getElementById("csv-cancel-btn"),ea=document.getElementById("import-csv-btn"),ta=document.getElementById("csv-file-input"),na=document.getElementById("column-mapping-page"),Jn=document.getElementById("column-select-dropdown"),sa=document.getElementById("confirm-column-btn"),ia=document.getElementById("cancel-import-btn"),aa=document.getElementById("new-category-name"),ra=document.getElementById("add-category-btn"),Yn=document.querySelector(".app-header"),nt=document.getElementById("select-student-btn"),At=document.getElementById("select-student-btn-wrapper"),oa=document.getElementById("attendance-page"),Gt=document.getElementById("attendance-list"),ca=document.getElementById("finish-attendance-btn"),la=document.querySelector("#class-management-page h2"),Xn=document.getElementById("student-stats-header"),da=document.getElementById("hamburger-menu-btn"),ua=document.getElementById("side-nav-menu"),fa=document.getElementById("close-nav-btn"),ma=document.getElementById("overlay"),ha=document.getElementById("backup-data-btn"),pa=document.getElementById("restore-data-btn"),di=document.getElementById("restore-file-input"),ga=document.getElementById("custom-confirm-modal"),ui=document.getElementById("confirm-modal-message"),Qn=document.getElementById("confirm-modal-cancel-btn"),Ut=document.getElementById("confirm-modal-confirm-btn"),ya=document.getElementById("secure-confirm-modal"),fi=document.getElementById("secure-confirm-message"),mi=document.getElementById("secure-confirm-code"),xt=document.getElementById("secure-confirm-input"),ba=document.getElementById("secure-confirm-cancel-btn"),pn=document.getElementById("secure-confirm-confirm-btn"),va=document.getElementById("add-note-modal"),we=document.getElementById("new-note-content"),Ca=document.getElementById("class-save-note-btn"),wa=document.getElementById("cancel-note-btn"),es=document.getElementById("student-search-input"),mt=document.getElementById("student-search-results"),_a=document.getElementById("back-to-student-page-btn"),Ea=document.getElementById("graded-category-pills-container"),ka=document.getElementById("new-score-value"),hi=document.getElementById("new-score-comment"),Sa=document.getElementById("add-score-btn"),Ia=document.getElementById("profile-stats-summary"),xa=document.getElementById("profile-scores-list"),jt=document.getElementById("global-student-search-input"),at=document.getElementById("global-student-search-results"),La=document.getElementById("is-graded-checkbox"),Ta=document.getElementById("trashed-classes-list"),Ba=document.getElementById("trashed-students-list"),Na=document.getElementById("trashed-sessions-list"),Da=document.getElementById("trashed-categories-list"),Aa=document.getElementById("trashed-notes-list"),Oa=document.getElementById("trashed-scores-list"),Tt=document.getElementById("quick-grade-form-wrapper"),ct=document.getElementById("quick-score-input"),tt=document.getElementById("quick-note-textarea"),wt=document.getElementById("quick-grade-submit-btn"),Vt=document.getElementById("category-selection-container"),ts=document.getElementById("selected-student-result"),_t=document.getElementById("custom-context-menu"),Lt=document.getElementById("breadcrumb-container");let Ht=null,Nt=null;const Ra=document.getElementById("category-modal"),pi=document.getElementById("category-modal-title"),Kt=document.getElementById("new-category-modal-name"),Is=document.getElementById("new-category-modal-is-graded"),Ma=document.getElementById("category-modal-cancel-btn"),gi=document.getElementById("category-modal-save-btn"),za=document.getElementById("mass-comment-modal"),$a=document.getElementById("mass-comment-modal-title"),yi=document.getElementById("mass-comment-student-count-message"),Jt=document.getElementById("mass-comment-content"),xs=document.getElementById("mass-comment-append-checkbox"),Fa=document.getElementById("mass-comment-cancel-btn"),Pa=document.getElementById("mass-comment-save-btn"),ns=document.getElementById("mass-comment-btn"),gn=document.getElementById("attendance-mass-actions-container"),vt=document.createElement("input"),Ha=document.getElementById("session-dashboard-page"),Ot=document.getElementById("attendance-pane");function Rt(s="selector"){if(!N||!J){ge("class-management-page");return}qa(),bn(),Re(),ut(),ge("session-dashboard-page",{tab:s}),bi(),tn(s),Ga()}function tn(s){const o=document.getElementById("selector-tab-btn"),e=document.getElementById("attendance-tab-btn"),l=document.getElementById("selector-pane"),r=s==="selector";o.classList.toggle("active",r),e.classList.toggle("active",!r),l.classList.toggle("active",r),Ot.classList.toggle("active",!r)}function bi(){const s=document.getElementById("selector-tab-btn"),o=document.getElementById("attendance-tab-btn"),e=document.getElementById("selector-pane");s.addEventListener("click",()=>{Re(),Fe(),s.classList.add("active"),o.classList.remove("active"),e.classList.add("active"),Ot.classList.remove("active"),ge("session-dashboard-page",{tab:"selector"})}),o.addEventListener("click",()=>{ut(),o.classList.add("active"),s.classList.remove("active"),Ot.classList.add("active"),e.classList.remove("active"),ge("session-dashboard-page",{tab:"attendance"})})}function Wa(s){clearTimeout(Rn),Xt||Tn(JSON.stringify(oe)),ci.textContent=s,On.classList.add("show"),Xs(setTimeout(()=>{On.classList.remove("show"),Tn(null)},5e3))}function vi(){if(Xt){const s=N?N.info.name:null,o=JSON.parse(Xt);kt(o),s&&oe[s]?Pe(oe[s]):Pe(null),N?(lt(),Mt(),We()):He(),On.classList.remove("show"),clearTimeout(Rn),Tn(null)}}function Q(s,o=3e3){const e=document.getElementById("notification-toast");e&&(e.textContent=s,e.classList.add("show"),clearTimeout(ms),Qs(setTimeout(()=>{e.classList.remove("show")},o)))}function ss(s){const o=document.getElementById("restore-confirm-modal"),e=document.getElementById("restore-modal-message"),l=document.getElementById("restore-append-checkbox"),r=document.getElementById("restore-confirm-cancel-btn"),t=document.getElementById("restore-confirm-confirm-btn"),n=document.getElementById("restore-modal-warning");n.style.display="none";const a=s.metadata.createdAt;if(je.lastRestoreTimestamp&&a<je.lastRestoreTimestamp){const h=new Date(a).toLocaleDateString("fa-IR"),f=new Date(je.lastRestoreTimestamp).toLocaleDateString("fa-IR");n.textContent=`⚠️ هشدار: این فایل پشتیبان (${h}) قدیمی‌تر از آخرین بازیابی شما (${f}) است.`,n.style.display="block"}const i=Object.keys(s.data.classrooms).length,u="کلاس";e.textContent=`فایل پشتیبان شما حاوی ${i} ${u} است. لطفاً نحوه بازیابی را مشخص کنید.`,l.checked=!0;const p=()=>{const h=l.checked;Hs(s,h),o.removeEventListener("click",p),ke(),He(),ge("class-management-page"),Q("✅ اطلاعات با موفقیت بازیابی شد.")},v=()=>{ke()};t.onclick=p,r.onclick=v,ze("restore-confirm-modal")}function Se(s,o,e={}){const{confirmText:l="تایید",cancelText:r="لغو",confirmClass:t="btn-success",onCancel:n=()=>{},isDelete:a=!1}=e,i=a?()=>Ci(s,o):o;ui.textContent=s,Ut.textContent=l,Qn.textContent=r,Ut.className="modal-action-btn",Ut.classList.add(t),vs(i),Cs(n);const u=Ut.parentElement;Qn.style.display=n===null?"none":"inline-block",u.style.justifyContent=n===null?"center":"space-between",ze("custom-confirm-modal")}function Ci(s,o){const e=Math.floor(1e4+Math.random()*9e4).toString();fi.textContent=s,mi.textContent=e,xt.value="",pn.disabled=!0,en(o),ze("secure-confirm-modal"),xt.focus();const l=()=>{xt.value===e?pn.disabled=!1:pn.disabled=!0};return xt.addEventListener("input",l),()=>{xt.removeEventListener("input",l)}}function is(s,o={}){const{title:e="ایجاد دسته‌بندی جدید",initialName:l="",initialIsGraded:r=!1,saveButtonText:t="ذخیره"}=o;pi.textContent=e,Kt.value=l,Is.checked=r,gi.textContent=t,Mn((n,a)=>{if(!n){Q("⚠️ لطفاً نام دسته‌بندی را وارد کنید.");return}s(n,a),ke()}),ze("category-modal"),Kt.focus(),l&&Kt.select()}function Ls(s,o){const e=Object.values(oe).filter(n=>!n.isDeleted&&n.info.name!==o.info.name),l=document.getElementById("move-student-modal-title"),r=document.getElementById("move-student-class-select"),t=document.getElementById("move-student-confirm-btn");l.textContent=`انتقال دانش‌آموز: ${s.identity.name}`,r.innerHTML="",e.length===0?(r.innerHTML='<option value="">کلاس دیگری برای انتقال وجود ندارد</option>',t.disabled=!0):(e.forEach(n=>{const a=document.createElement("option");a.value=n.info.name,a.textContent=n.info.name,r.appendChild(a)}),t.disabled=!1),ni(s),si(o),ze("move-student-modal")}function Ts(s,o){if(!s||!o)return;const e=s.identity.name,l=document.getElementById("add-note-modal-title");l.textContent="تغییر نام دانش‌آموز",we.value=e,we.rows=1,we.dispatchEvent(new Event("input",{bubbles:!0})),st(r=>{const t=r.trim();t&&t!==e&&(Le(o.students).some(a=>a.identity.studentId!==s.identity.studentId&&a.identity.name.toLowerCase()===t.toLowerCase())?Q("دانش‌آموزی با این نام از قبل در این کلاس وجود دارد."):(s.identity.name=t,_e(o.info.name,`نام دانش‌آموز «${e}» به «${t}» تغییر یافت.`,{type:"VIEW_STUDENT_PROFILE",studentId:s.identity.studentId}),le(),lt(),Re(),ut(),Fe(),Ee&&Ee.identity.studentId===s.identity.studentId&&Me(s),Q(`✅نام دانش‌آموز به «${t}» تغییر یافت.`))),l.textContent="ثبت یادداشت جدید",we.rows=4}),ze("add-note-modal"),we.focus(),we.select()}function ze(s){const o=document.getElementById(s);if(o){if(ht)return;document.body.classList.add("modal-active"),o.classList.add("modal-visible"),ws(s),history.pushState(null,"",location.href)}}function ke(s,o=!1){if(!ht)return;const e=document.getElementById(ht),l=ht;ws(null),l==="student-profile-modal"&&Ve(null),o||history.back(),e&&(e.classList.add("modal-closing"),setTimeout(()=>{e.classList.remove("modal-visible"),e.classList.remove("modal-closing"),document.body.classList.remove("modal-active"),l==="custom-confirm-modal"&&(vs(null),Cs(null)),l==="secure-confirm-modal"&&en(null),l==="category-modal"&&Mn(null),l==="mass-comment-modal"&&(Jt.value=""),l==="add-note-modal"&&st(null),typeof s=="function"&&s()},300))}function Bs(){if(!Ot||!Ot.classList.contains("active")){gn.style.display="none";return}const s=Et.length;s<1?gn.style.display="none":gn.style.display="block",ns.disabled=s<1,ns.textContent=`📝 ثبت یادداشت گروهی (${s} نفر)`}function wi(){const s=Et,o=s.length;let e=!1;o>0&&(e=s.some(r=>{var t;return(t=J.studentRecords[r])==null?void 0:t.homework.comment})),yi.textContent=`یادداشت برای ${o} دانش‌آموز ثبت خواهد شد.`,Jt.value="",Jt.dispatchEvent(new Event("input",{bubbles:!0})),xs.checked=!0;const l=document.querySelector("#mass-comment-modal .modal-options");l.style.display=e?"flex":"none",ze("mass-comment-modal"),Jt.focus()}function as(s,o){if(!N||!J)return;let e=0;const l=Et,r=J;l.forEach(t=>{const n=r.studentRecords[t];if(n&&n.homework){const a=n.homework.comment||"";let i=s;o&&a.length>0?i=a+`
---
`+s:i=s,n.homework.comment=i.trim();const u=N.students.find(p=>p.identity.studentId===t);u&&Ua(u,r,i.trim()),e++}}),An([]),le(),ut(),_e(N.info.name,`${e} دانش‌آموز به صورت گروهی یادداشت تکلیف گرفتند.`,{type:"VIEW_SESSIONS"}),Q(`✅ یادداشت برای ${e} دانش‌آموز ثبت شد.`)}function Ua(s,o,e){const r=Xe(N).get(o.sessionNumber),t={type:"fromAttendance",sessionNumber:o.sessionNumber},n=`یادداشت مربوط به جلسه ${r}: `,a=s.profile.notes.find(i=>!i.isDeleted&&i.source&&i.source.type==="fromAttendance"&&i.source.sessionNumber===t.sessionNumber);a?e?(a.content=n+e,a.isDeleted=!1):a.isDeleted=!0:e&&s.addNote(n+e,t)}function zn(s){we.value=s.note||"",st(o=>{s.note=o,le(),_e(s.info.name,"یادداشت کلاس ذخیره شد.",{type:"VIEW_CLASS_NOTE"}),He(),Q("✅ یادداشت کلاس ذخیره شد.")}),ze("add-note-modal"),we.focus()}function Dt(s){Pe(s),Ss.textContent=`تنظیمات کلاس: ${s.info.name}`,lt(),Mt(),Ti(),ge("settings-page")}function _i(s){const o=document.getElementById("log-modal-title"),e=document.getElementById("log-list");o.textContent=`گزارش فعالیت‌های کلاس: ${s}`,e.innerHTML="";const l=Hi(s);l.length===0?e.innerHTML='<li class="no-content-message">هنوز فعالیتی برای این کلاس ثبت نشده است.</li>':l.forEach(r=>{const t=document.createElement("li");t.className="log-entry";const n=new Date(r.timestamp),a=`${n.toLocaleDateString("fa-IR")} - ${n.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}`,i=document.createElement("span");i.className="log-timestamp",i.textContent=a;const u=document.createElement("span");u.className="log-message",u.textContent=r.message,r.action&&(u.classList.add("log-action-link"),u.dataset.action=JSON.stringify({...r.action,classroomName:r.classroomName})),t.appendChild(i),t.appendChild(u),e.appendChild(t)}),ze("log-modal")}document.getElementById("log-modal-close-btn").addEventListener("click",()=>{ke()});function rs(s){const o=URL.createObjectURL(s),e=document.createElement("a");e.href=o,e.download=s.name,document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(o),setTimeout(()=>{Se("آیا فایل پشتیبان با موفقیت ذخیره شد؟",()=>{_s(),$n(),Q("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله، ذخیره شد",cancelText:"خیر",confirmClass:"btn-success"})},500)}async function nn(s=[]){const o=await Fs(s);if(!o){Q("❌ خطا در ایجاد فایل پشتیبان.");return}("ontouchstart"in window||navigator.maxTouchPoints>0)&&navigator.share&&navigator.canShare&&navigator.canShare({files:[o]})?Se("فایل پشتیبان شما آماده است. آیا مایل به اشتراک‌گذاری آن هستید؟",()=>{try{navigator.share({title:o.name,text:"فایل پشتیبان داده‌های برنامه",files:[o]}).then(()=>{Se("آیا فایل پشتیبان با موفقیت ارسال/ذخیره شد؟",()=>{_s(),$n(),Q("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}catch(l){console.error("Error during sharing process:",l),rs(o),Q("⚠️خطا در فرآیند اشتراک‌گذاری. فایل در حال دانلود است.")}},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"}):(rs(o),Q("✅پشتیبان‌گیری با موفقیت انجام شد."))}function an(s,o){s.preventDefault(),Ct(),Nt=s.target.closest("li"),Nt&&Nt.classList.add("context-menu-target"),setTimeout(()=>{const e=_t,l=e.querySelector("ul");l.innerHTML="",o.forEach(u=>{const p=document.createElement("li");u.isSeparator?p.className="separator":(p.innerHTML=`
                    <span class="icon">${u.icon||""}</span>
                    <span class="label">${u.label}</span>
                `,u.className&&p.classList.add(u.className),p.addEventListener("click",()=>{u.action(),Ct()})),l.appendChild(p)}),e.classList.add("visible");const{offsetWidth:r,offsetHeight:t}=e,{innerHeight:n}=window,a=document.body.getBoundingClientRect();e.style.top=`${(n-t)/2}px`;const i=a.left+a.width/2;e.style.left=`${i-r/2}px`},50)}function Ct(){_t.classList.contains("visible")&&_t.classList.remove("visible"),Nt&&(Nt.classList.remove("context-menu-target"),Nt=null)}function Ei(){var e;Lt.innerHTML="";const s=document.getElementById("header-settings-btn");if(!s)return;const o=[];if(o.push({label:"کلاس‌ها",handler:()=>{Pe(null),Ue(null),Ve(null),ge("class-management-page")}}),N){o.push({label:N.info.name,handler:()=>{Ue(null),Ve(null),We(),ge("session-page")}});const l=(e=document.querySelector(".page.active"))==null?void 0:e.id;if(l==="session-page"?s.style.visibility="visible":s.style.visibility="hidden",l==="settings-page")o.push({label:"تنظیمات"});else if(J){const t=Xe(N).get(J.sessionNumber)||` (#${J.sessionNumber})`;o.push({label:`جلسه ${t}`,handler:()=>{Ve(null),Rt("selector")}}),Ee?o.push({label:`پروفایل: ${Ee.identity.name}`}):l==="session-dashboard-page"&&(document.getElementById("attendance-tab-btn").classList.contains("active")?o.push({label:"حضور و غیاب"}):o.push({label:"انتخابگر"}))}}else s.style.visibility="hidden";if(o.length<=1){Lt.style.display="none";return}Lt.style.display="flex",o.forEach((l,r)=>{const t=document.createElement("a");if(t.textContent=l.label,t.className="breadcrumb-item",r===o.length-1||!l.handler?t.classList.add("active"):t.addEventListener("click",l.handler),Lt.appendChild(t),r<o.length-1){const n=document.createElement("span");n.className="breadcrumb-separator",n.textContent="/",Lt.appendChild(n)}})}function As(s,o,e){e.innerHTML="";const l=N.sessions.filter(r=>{var t;return!r.isDeleted&&!r.isCancelled&&((t=r.studentRecords[s.identity.studentId])==null?void 0:t.attendance)==="absent"}).map(r=>({number:o.get(r.sessionNumber),isMakeup:r.isMakeup})).filter(r=>r.number!==void 0);l.length>0?(e.appendChild(document.createTextNode("جلسات غایب: ")),l.forEach((r,t)=>{const n=document.createElement("span");n.textContent=r.number,r.isMakeup&&n.classList.add("makeup-absence"),e.appendChild(n),t<l.length-1&&e.appendChild(document.createTextNode("، "))})):e.textContent="جلسات غایب: بدون غیبت"}function yn(s,o,e,l={}){const{includePrefix:r=!0}=l;e.innerHTML="";const t=N.sessions.filter(n=>{if(n.isDeleted||n.isCancelled)return!1;const a=n.studentRecords[s.identity.studentId];return a&&a.homework&&(a.homework.status==="incomplete"||a.homework.status==="none")}).map(n=>({number:o.get(n.sessionNumber),status:n.studentRecords[s.identity.studentId].homework.status})).filter(n=>n.number!==void 0);t.length>0?(r&&e.appendChild(document.createTextNode("تکالیف ناقص: ")),t.forEach((n,a)=>{const i=document.createElement("span");i.textContent=n.number,n.status==="incomplete"&&i.classList.add("incomplete-homework"),e.appendChild(i),a<t.length-1&&e.appendChild(document.createTextNode("،"))})):r?e.textContent="تکالیف ناقص: ندارد":e.textContent="ندارد"}function ja(s,o){var g,w,k;const e=document.createElement("li");e.className="attendance-list-item";const l=document.createElement("input");l.type="checkbox",l.className="mass-comment-checkbox",l.checked=Et.includes(s.identity.studentId),l.addEventListener("change",()=>{const I=s.identity.studentId,S=Et;if(l.checked)S.includes(I)||S.push(I);else{const O=S.indexOf(I);O>-1&&S.splice(O,1)}Bs()}),e.appendChild(l);const r={none:"بدون تکلیف",complete:"تکلیف کامل",incomplete:"تکلیف ناقص"},t=document.createElement("div");t.className="student-info";const n=document.createElement("span");n.className="student-name",n.textContent=s.identity.name,n.addEventListener("click",()=>{Me(s)});const a=document.createElement("span");a.className="absence-info";const i=document.createElement("span");i.className="homework-info",As(s,o,a),yn(s,o,i),t.appendChild(n),t.appendChild(a),t.appendChild(i);const u=document.createElement("div");u.className="homework-controls";const p=document.createElement("button"),v=((g=J.studentRecords[s.identity.studentId])==null?void 0:g.homework.status)||"none";p.className=`homework-status-btn ${v}`,p.title=r[v],p.addEventListener("click",()=>{const I=J.studentRecords[s.identity.studentId].homework,O={none:"incomplete",incomplete:"complete",complete:"none"}[I.status];p.title=r[O],J.setHomeworkStatus(s.identity.studentId,O),le(),p.className=`homework-status-btn ${O}`,yn(s,o,i)});const h=document.createElement("button");h.className="btn-icon",h.innerHTML="📝",h.title="افزودن یادداشت برای تکلیف",((w=J.studentRecords[s.identity.studentId])==null?void 0:w.homework.comment)||(h.style.opacity="0.3"),h.addEventListener("click",()=>{const I=J.studentRecords[s.identity.studentId].homework;we.value=I.comment||"",we.dispatchEvent(new Event("input",{bubbles:!0})),st(S=>{I.comment=S;const O=Xe(N),M=O.get(J.sessionNumber),U={type:"fromAttendance",sessionNumber:J.sessionNumber},A=`یادداشت مربوط به جلسه ${M}: `,G=s.profile.notes.find(ie=>!ie.isDeleted&&ie.source&&ie.source.type==="fromAttendance"&&ie.source.sessionNumber===U.sessionNumber);G?S?G.content=A+S:G.isDeleted=!0:S&&s.addNote(A+S,U),le(),_e(N.info.name,`یادداشت تکلیف جلسه ${M} برای دانش‌آموز «${s.identity.name}» ذخیره شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:s.identity.studentId}),Q("✅یادداشت تکلیف ذخیره شد."),h.style.opacity=S?"1":"0.3",yn(s,O,i)}),ze("add-note-modal"),we.focus()}),u.appendChild(p),u.appendChild(h);const b=document.createElement("button"),m=((k=J.studentRecords[s.identity.studentId])==null?void 0:k.attendance)||"present",y=I=>{I==="present"?(b.textContent="حاضر",b.className="attendance-status-btn present active"):(b.textContent="غایب",b.className="attendance-status-btn absent active")};return y(m),b.addEventListener("click",()=>{var O;const S=(((O=J.studentRecords[s.identity.studentId])==null?void 0:O.attendance)||"present")==="present"?"absent":"present";J.setAttendance(s.identity.studentId,S),S==="absent"&&(J.studentRecords[s.identity.studentId].hadIssue=!1),le(),y(S),As(s,o,a),Re(),Bi()}),e.appendChild(t),e.appendChild(u),e.appendChild(b),e}function Za(){return Xe(N).get(J.sessionNumber)}function ut(){if(!N||!J)return;Le(N.students).forEach(r=>{J.initializeStudentRecord(r.identity.studentId)}),An([]);const s=Xe(N);nr(),Gt.innerHTML="";const o=document.createElement("li");o.className="attendance-list-header",vt.id="attendance-search-input",vt.type="text",vt.className="inline-search-input",vt.placeholder="جستجو...",vt.value="";const e=document.createElement("div");e.className="student-search-container",e.appendChild(vt);const l=document.createElement("div");l.className="header-labels-container",l.innerHTML=`
    <span class="header-label">تکلیف</span>
    <span class="header-label">حضور</span>
`,o.appendChild(e),o.appendChild(l),Gt.appendChild(o),Le(N.students).forEach(r=>{const t=ja(r,s);Gt.appendChild(t)}),An([]),Bs(),sr(),Bi()}function Re(){const s=document.getElementById("student-stats-table-container");if(!s||(s.innerHTML="",!N))return;Le(N.students).length,Xn.textContent="آمار عملکرد";const o=["نام"],e=["کل انتخاب ها","غیبت","خروج","فرصت ازدست‌رفته","مشکل","میانگین","نمره کلاسی (کانون)"],l=N.categories.filter(f=>f.isGradedCategory&&!f.isDeleted).map(f=>f.name),r=[...o,...l,...e],t=document.createElement("table");t.className="student-stats-table";const a=t.createTHead().insertRow();r.forEach((f,b)=>{const m=document.createElement("th");b===0?(m.innerHTML=`${f} <span style="opacity: 0.6;">🔗</span>`,m.title="ردیف‌های این ستون قابل کلیک هستند"):m.textContent=f,a.appendChild(m)});const i=t.createTBody(),u=Le(N.students),p=f=>{let b=0;return N.sessions.forEach(m=>{if(m.isDeleted||m.isCancelled)return;const y=m.studentRecords[f.identity.studentId];y&&y.attendance==="absent"&&b++}),b};u.forEach(f=>{const b=i.insertRow();if(b.dataset.studentId=f.identity.studentId,J){const I=J.studentRecords[f.identity.studentId];I&&I.attendance==="absent"&&b.classList.add("absent-row-highlight")}const m=b.insertCell(),y=document.createElement("span");y.textContent=f.identity.name,y.className="student-name-link",y.addEventListener("click",()=>{Me(f)}),m.appendChild(y),l.forEach(I=>{var U;const S=b.insertCell();S.style.direction="ltr";const O=I.toLowerCase(),M=((U=f.logs.scores[O])==null?void 0:U.filter(A=>!A.isDeleted))||[];M.length>0?M.forEach((A,G)=>{const ie=document.createElement("span");ie.textContent=A.value+(A.comment?"'":""),ie.style.position="relative",A.comment&&(ie.dataset.tooltip=A.comment),S.appendChild(ie),G<M.length-1&&S.appendChild(document.createTextNode(","))}):S.textContent="",S.style.cursor="pointer",S.addEventListener("click",()=>{Fe(f,I);const A=document.getElementById("category-selection-container");A&&A.scrollIntoView({behavior:"smooth",block:"center"})})}),b.insertCell().textContent=f.statusCounters.totalSelections||0,b.insertCell().textContent=p(f),b.insertCell().textContent=f.statusCounters.outOfClassCount||0,b.insertCell().textContent=f.statusCounters.missedChances||0;const g=Object.values(f.categoryIssues||{}).reduce((I,S)=>I+S,0);b.insertCell().textContent=g;const w=f.getOverallAverageScore();b.insertCell().textContent=w!==null?w:"-";const k=N.calculateFinalStudentScore(f);b.insertCell().textContent=k!==null?k:"-"}),Le(N.students),Xn.setAttribute("data-student-count",u.length),s.appendChild(t);const v=s.querySelector(".student-stats-table"),h=v==null?void 0:v.querySelector("thead th:first-child");h&&h.addEventListener("click",()=>{v.classList.toggle("name-column-expanded")})}function Fe(s=null,o=null){const e=document.getElementById("selected-student-result");e.innerHTML="",e.classList.remove("absent");let l,r;if(s&&o)l=s,r=o,Nn({student:s,categoryName:o}),pt(-1);else{if(Nn(null),!J||et<0||!J.winnerHistory[et])return;const $=J.winnerHistory[et];l=$.winner,r=$.categoryName}const t=document.querySelector(".current-winner-highlight");if(t&&t.classList.remove("current-winner-highlight"),l){const $=document.querySelector(`.student-stats-table tr[data-student-id="${l.identity.studentId}"]`);$&&$.classList.add("current-winner-highlight")}const n=N.categories.find($=>$.name===r);if(n){Bn(n),Ns(n);const $=document.querySelectorAll("#category-selection-container .pill");$.forEach(T=>T.classList.remove("active"));const te=Array.from($).find(T=>T.textContent===r);te&&te.classList.add("active"),os(n),cs(n.name)}const a=J.studentRecords[l.identity.studentId],i=(a==null?void 0:a.attendance)==="absent",u=document.createElement("div");u.className="winner-name-container";const p=document.createElement("button");p.className="btn-icon",p.innerHTML="˅",p.title="برنده قبلی";const v=!s;p.classList.toggle("is-disabled",!v||et<=0),p.addEventListener("click",()=>{p.classList.contains("is-disabled")?(p.classList.add("shake-animation"),setTimeout(()=>p.classList.remove("shake-animation"),200)):(pt(et-1),Fe())});const h=document.createElement("div");h.className="winner-name",h.innerHTML=`✨ <strong>${l.identity.name}</strong>✨`,h.classList.add("heartbeat-animation"),i&&(h.style.textDecoration="line-through",h.style.opacity="0.6",h.style.color="var(--color-secondary)"),(a==null?void 0:a.hadIssue)&&!i&&(h.style.color="var(--color-warning)",h.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"),(a==null?void 0:a.wasOutOfClass)&&!i&&(h.style.color="var(--color-strong-warning)",h.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود");const m=1e3,y=$=>{Ht=setTimeout(()=>{cr(l,r),Ht=null},m)},g=()=>{Ht&&(clearTimeout(Ht),Ht=null)};h.addEventListener("mousedown",y),h.addEventListener("mouseup",g),h.addEventListener("mouseout",g),h.addEventListener("touchstart",y),h.addEventListener("touchmove",g),h.addEventListener("touchend",g),h.addEventListener("touchcancel",g);const w=document.createElement("button");if(w.className="btn-icon",w.innerHTML="˄",w.title="برنده بعدی",w.classList.toggle("is-disabled",!v||et>=J.winnerHistory.length-1),w.addEventListener("click",()=>{w.classList.contains("is-disabled")?(w.classList.add("shake-animation"),setTimeout(()=>w.classList.remove("shake-animation"),200)):(pt(et+1),Fe())}),u.appendChild(w),u.appendChild(h),l.onboardingSession===J.sessionNumber){const $=document.createElement("div");$.className="new-student-badge",$.textContent="دانش آموز جدید",u.appendChild($)}u.appendChild(p),e.appendChild(u),nt.disabled=v&&!w.classList.contains("is-disabled");const k=document.createElement("div");k.className="status-button-container";const I=document.createElement("button");I.textContent="غایب",I.classList.add("status-button","absent-btn"),i&&I.classList.add("active");const S=document.createElement("button");S.textContent="مشکل",S.classList.add("status-button","issue-btn"),a!=null&&a.hadIssue&&S.classList.add("active");const O=document.createElement("button");O.textContent="خروج",O.classList.add("status-button","exit-btn"),a!=null&&a.wasOutOfClass&&O.classList.add("active");const M=document.createElement("button");M.textContent="پروفایل",M.className="status-button profile-btn",J.isFinished?I.disabled=!0:I.addEventListener("click",()=>{const $=I.classList.contains("active");O.classList.contains("active")&&(O.classList.remove("active"),a.wasOutOfClass=!1,l.statusCounters.outOfClassCount=Math.max(0,(l.statusCounters.outOfClassCount||0)-1),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)),$?(I.classList.remove("active"),J.setAttendance(l.identity.studentId,"present"),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1),h.style.textDecoration="",h.style.opacity="",h.style.color=""):(S.classList.contains("active")&&(S.classList.remove("active"),a.hadIssue=!1,l.statusCounters.otherIssues=Math.max(0,l.statusCounters.otherIssues-1),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)),I.classList.add("active"),J.setAttendance(l.identity.studentId,"absent"),l.statusCounters.missedChances++,h.style.textDecoration="line-through",h.style.opacity="0.6",h.style.color="var(--color-secondary)",h.title=""),Re(),setTimeout(()=>Fe(l,r),0),le()}),J.isFinished?S.disabled=!0:S.addEventListener("click",()=>{const $=S.classList.contains("active");if(O.classList.contains("active")&&(O.classList.remove("active"),a.wasOutOfClass=!1,l.statusCounters.outOfClassCount=Math.max(0,(l.statusCounters.outOfClassCount||0)-1),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)),$){S.classList.remove("active"),a.hadIssue=!1;const te=Ge.name;l.categoryIssues[te]&&(l.categoryIssues[te]=Math.max(0,l.categoryIssues[te]-1)),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1),h.style.color="",h.title=""}else{I.classList.contains("active")&&(I.classList.remove("active"),J.setAttendance(l.identity.studentId,"present"),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)),S.classList.add("active"),a.hadIssue=!0;const te=Ge.name;l.categoryIssues[te]=(l.categoryIssues[te]||0)+1,l.statusCounters.missedChances++,h.style.textDecoration="",h.style.opacity="",h.style.color="var(--color-warning)",h.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"}Re(),setTimeout(()=>Fe(l,r),0),le()}),J.isFinished?O.disabled=!0:O.addEventListener("click",()=>{if(O.classList.contains("active"))O.classList.remove("active"),a.wasOutOfClass=!1,h.style.color="",h.title="";else{if(I.classList.contains("active")&&(I.classList.remove("active"),J.setAttendance(l.identity.studentId,"present"),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)),S.classList.contains("active")){S.classList.remove("active"),a.hadIssue=!1;const te=Ge.name;l.categoryIssues[te]&&(l.categoryIssues[te]=Math.max(0,l.categoryIssues[te]-1)),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)}O.classList.add("active"),a.wasOutOfClass=!0,h.style.textDecoration="",h.style.opacity="",h.style.color="var(--color-strong-warning)",h.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود"}Re(),setTimeout(()=>Fe(l,r),0),le()}),J.isFinished?M.disabled=!0:M.addEventListener("click",()=>{Me(l)}),k.appendChild(I),k.appendChild(O),k.appendChild(S),k.appendChild(M),e.appendChild(k);const U=document.createElement("div");U.className="student-details-container";const A=document.createElement("div");A.className="student-details-scores",A.innerHTML="<h4>آخرین نمرات</h4>";const G=document.createElement("ul");G.className="scores-list";const ie=N.categories.filter($=>$.isGradedCategory&&!$.isDeleted);let E=!1;const z=l.logs.scores||{};ie.forEach($=>{var Te;const te=$.name,T=te.toLowerCase(),D=document.createElement("li"),re=document.createElement("span");re.className="skill-name",re.textContent=`${te}:`;const ee=document.createElement("span");ee.className="skill-scores";const Y=(Te=z[T])==null?void 0:Te.filter(Ne=>!Ne.isDeleted);Y&&Y.length>0?(E=!0,ee.textContent=Y.slice(-3).map(Ne=>Ne.value+(Ne.comment?"'":"")).join(" , ")):ee.textContent="none",D.appendChild(re),D.appendChild(ee),G.appendChild(D)}),E||(G.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>'),A.appendChild(G),U.appendChild(A);const d=document.createElement("div");d.className="student-details-notes";const F=document.createElement("div");F.className="history-section-header";const ue=document.createElement("h4");ue.textContent="یادداشت‌ها";const j=document.createElement("button");j.className="btn-icon",j.innerHTML="📝",j.title="افزودن یادداشت جدید",J.isFinished?j.disabled=!0:j.addEventListener("click",()=>{we.value="",we.dispatchEvent(new Event("input",{bubbles:!0})),st($=>{$&&(l.addNote($),le(),Fe(),Q("✅ یادداشت با موفقیت ثبت شد."))}),ze("add-note-modal"),we.focus()}),F.appendChild(ue),F.appendChild(j),d.appendChild(F);const fe=document.createElement("ul");fe.className="notes-list",l.profile.notes&&l.profile.notes.length>0?[...l.profile.notes].sort((te,T)=>new Date(T.timestamp)-new Date(te.timestamp)).forEach(te=>{const T=document.createElement("li");T.dir=Es(te.content),T.textContent=te.content,fe.appendChild(T)}):fe.innerHTML='<div class="no-content-message">یادداشتی وجود ندارد.</div>',d.appendChild(fe),U.appendChild(d),e.appendChild(U)}function ki(s){s.addEventListener("input",()=>{const o=s.value,e=Es(o);s.setAttribute("dir",e)})}function qa(){Ns(null),Vt.innerHTML="",ts.innerHTML="",Tt.classList.add("tooltip-container"),ct.disabled=!0,tt.disabled=!0,wt.disabled=!0,ct.value="",tt.value="",At.classList.add("disabled-wrapper"),nt.disabled=!0}function bn(){Vt.innerHTML="",N.categories.filter(e=>!e.isDeleted).forEach(e=>{const l=document.createElement("span");l.className="pill",l.textContent=e.name,l.dataset.categoryId=e.id,e.description&&(l.dataset.tooltip=e.description),J.isFinished?l.classList.add("disabled"):l.addEventListener("click",()=>{document.querySelectorAll("#category-selection-container .pill").forEach(t=>t.classList.remove("active")),l.classList.add("active"),Bn(e),Ns(e),os(e),cs(e.name),At.classList.remove("disabled-wrapper"),nt.disabled=J.isFinished;const r=J.lastWinnerByCategory[e.name];if(r){const t=N.students.find(n=>n.identity.studentId===r);t&&Fe(t,e.name)}else{ts.innerHTML="",Nn(null),pt(-1),nt.disabled=!1;const t=document.querySelector(".current-winner-highlight");t&&t.classList.remove("current-winner-highlight")}}),J.isFinished||l.addEventListener("contextmenu",r=>{an(r,[{label:"تغییر نام",icon:"✏️",action:()=>{is((n,a)=>{const i=Us(N,e,n);i.success?(e.isGradedCategory=a,le(),_e(N.info.name,`نام دسته‌بندی «${e.name}» به «${n}» تغییر یافت.`),bn(),Re(),Q(`✅ نام دسته‌بندی به «${n}» تغییر یافت.`)):Q(`⚠️ ${i.message}`)},{title:"ویرایش دسته‌بندی",initialName:e.name,initialIsGraded:e.isGradedCategory,saveButtonText:"ذخیره تغییرات"})}},{label:"حذف دسته‌بندی",icon:"🗑️",className:"danger",action:()=>{Se(`آیا از انتقال دسته‌بندی «${e.name}» به سطل زباله مطمئن هستید؟`,()=>{const n={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${e.name}» از کلاس «${N.info.name}»`,restoreData:{categoryId:e.id,classId:N.info.scheduleCode}};pe.unshift(n),pe.length>50&&pe.pop();const a=e.name.toLowerCase();if(N.students.forEach(i=>{i.logs.scores&&i.logs.scores[a]&&i.logs.scores[a].forEach(u=>{u.isDeleted=!0})}),Ge&&Ge.id===e.id){Bn(null),ts.innerHTML="",os(null),cs(null),At.classList.add("disabled-wrapper"),nt.disabled=!0;const i=document.querySelector(".current-winner-highlight");i&&i.classList.remove("current-winner-highlight")}e.isDeleted=!0,_e(N.info.name,`دسته‌بندی «${e.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),le(),bn(),Re(),Q(`✅ دسته‌بندی «${e.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}}])}),Vt.appendChild(l)});const o=document.createElement("span");o.className="pill add-category-pill",o.textContent="+",o.title="افزودن دسته‌بندی جدید",J.isFinished?o.classList.add("disabled"):o.addEventListener("click",()=>{is((e,l)=>{if(N.categories.find(n=>n.name.toLowerCase()===e.toLowerCase()&&!n.isDeleted)){Q("⚠️ این دسته‌بندی از قبل وجود دارد.");return}const t=new dt(e,"",l);N.categories.push(t),le(),_e(N.info.name,`دسته‌بندی جدید «${e}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),bn(),Q(`✅ دسته‌بندی «${e}» اضافه شد.`)})}),Vt.appendChild(o)}function Ga(){if(J.lastUsedCategoryId){if(J.isFinished)return;const s=Vt.querySelector(`.pill[data-category-id="${J.lastUsedCategoryId}"]`);s&&s.click()}J.winnerHistory&&J.winnerHistory.length>0&&(pt(J.winnerHistory.length-1),Fe())}function Ns(s){s?nt.textContent=`نفر بعدی در ${s.name}`:nt.textContent="نفر بعدی"}function os(s){if(J.isFinished){ct.disabled=!0,tt.disabled=!0,wt.disabled=!0,Tt.setAttribute("title","جلسه خاتمه یافته است");return}s&&s.isGradedCategory?(ct.disabled=!1,tt.disabled=!1,wt.disabled=!1,Tt.removeAttribute("title")):(ct.disabled=!0,tt.disabled=!0,wt.disabled=!0,s?Tt.setAttribute("title","برای این دسته‌بندی قابلیت نمره دهی تعریف نشده است"):Tt.setAttribute("title","ابتدا یک دسته‌بندی را انتخاب کنید"))}function cs(s){const o=document.querySelector(".student-stats-table");if(!o||(o.querySelectorAll(".current-category-highlight").forEach(n=>{n.classList.remove("current-category-highlight")}),!s))return;let l=-1;const r=o.querySelectorAll("thead th");if(r.forEach((n,a)=>{n.textContent.trim()===s&&(l=a)}),l===-1)return;r[l].classList.add("current-category-highlight"),o.querySelectorAll("tbody tr").forEach(n=>{const a=n.cells[l];a&&a.classList.add("current-category-highlight")})}function Me(s){Ve(s);const o=document.getElementById("student-profile-modal"),e=document.getElementById("modal-profile-student-name"),l=document.getElementById("modal-profile-content-container"),r=document.getElementById("modal-profile-close-btn");if(!o||!e||!l||!r)return;e.textContent=`پروفایل: ${s.identity.name}`,e.style.cursor="pointer",e.onclick=()=>{const u=Ee,p=N;ke(()=>{Ts(u,p)})},l.innerHTML="";const t=document.createElement("div");t.className="profile-header-actions";const n=document.createElement("button");n.className="btn-icon btn-icon-label",n.title="انتقال دانش‌آموز",n.innerHTML="<span>➡️</span><span>انتقال</span>",n.addEventListener("click",()=>{const u=Ee,p=N;ke(()=>{Ls(u,p)})});const a=document.createElement("button");a.className="btn-icon btn-icon-label",a.title="حذف دانش‌آموز",a.innerHTML="<span>🗑️</span><span>حذف</span>",a.style.color="var(--color-strong-warning)",a.addEventListener("click",()=>{const u=Ee,p=N;ke(()=>{Se(`آیا از انتقال دانش‌آموز «${u.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const v={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آMوز «${u.identity.name}» از کلاس «${p.info.name}»`,restoreData:{studentId:u.identity.studentId,classId:p.info.scheduleCode}};pe.unshift(v),pe.length>50&&pe.pop(),u.isDeleted=!0,_e(p.info.name,`دانش‌آموز «${u.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),le(),lt(),Re(),ut(),Q(`✅ دانش‌آموز «${u.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0,onCancel:()=>{Me(u)}})})});const i=document.createElement("button");i.className="btn-icon btn-icon-label",i.title="افزودن یادداشت جدید",i.innerHTML="<span>📝</span><span>یادداشت</span>",i.addEventListener("click",()=>{const u=Ee;we.value="",we.dispatchEvent(new Event("input",{bubbles:!0})),st(p=>{p&&(u.addNote(p),le(),_e(N.info.name,`یادداشت جدیدی برای دانش‌آموز «${u.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:u.identity.studentId}),Fe(),Q("✅ یادداشت با موفقیت ثبت شد.")),Me(u)}),ke(()=>{ze("add-note-modal"),we.focus()})}),t.appendChild(n),t.appendChild(a),t.appendChild(i),l.appendChild(t),Va(l),Si(l),r.onclick=()=>ke(),ze("student-profile-modal")}function Va(s){if(!Ee||!N)return;const o=document.createElement("div");o.className="scoring-section",o.innerHTML=`
        <h3>ثبت نمره جدید</h3>
        <div id="modal-graded-pills" class="category-pills"></div>
        <div class="input-group centered-input-group" style="margin-top: 15px;">
            <input type="number" id="modal-new-score-value" placeholder="نمره (مثلا: 85)">
        </div>
        <textarea id="modal-new-score-comment" placeholder="توضیحات این نمره (اختیاری)..." style="margin-top: 10px;"></textarea>
        <button id="modal-add-score-btn" class="btn-success" style="width: 100%; margin-top: 10px;">ثبت نمره</button>
    `;const e=o.querySelector("#modal-graded-pills");Le(N.categories).filter(t=>t.isGradedCategory).forEach(t=>{const n=document.createElement("span");n.className="pill",n.textContent=t.name,n.dataset.skillName=t.name,n.addEventListener("click",()=>{e.querySelectorAll(".pill").forEach(a=>a.classList.remove("active")),n.classList.add("active")}),e.appendChild(n)}),o.querySelector("#modal-add-score-btn").addEventListener("click",()=>{const t=e.querySelector(".pill.active");if(!t){Q("⚠️لطفاً یک مهارت را برای نمره‌دهی انتخاب کنید.");return}const n=t.dataset.skillName,a=o.querySelector("#modal-new-score-value"),i=o.querySelector("#modal-new-score-comment"),u=a.value,p=i.value.trim();if(!u){Q("لطفاً مقدار نمره را وارد کنید.");return}Ee.addScore(n,parseFloat(u),p),le(),_e(N.info.name,`نمره ${u} در ${n} برای «${Ee.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:Ee.identity.studentId}),Re(),Fe(),a.value="",i.value="";const v=document.getElementById("modal-profile-content-container"),h=v.querySelector(".history-section");h&&h.remove(),Si(v),Q(`✅ نمره برای مهارت ${n} با موفقیت ثبت شد.`)}),s.appendChild(o)}function Si(s){if(!Ee)return;const o=document.createElement("div");o.className="history-section";const e=document.createElement("div");e.className="history-section-header";const l=document.createElement("h3");l.textContent="سوابق دانش‌آموز",e.appendChild(l),o.appendChild(e),Ka(o),Ii(o),xi(o),s.appendChild(o)}function Ka(s){if(!Ee)return;const o=Ee,e=N.sessions.reduce((f,b)=>{const m=b.studentRecords[o.identity.studentId];return f+(m&&m.attendance==="absent"?1:0)},0),l=Object.values(o.categoryIssues||{}).reduce((f,b)=>f+b,0),r=document.createElement("div");r.className="stats-summary-box",r.innerHTML=`
        <p><strong>کل انتخاب:</strong> ${o.statusCounters.totalSelections}</p>
        <p><strong>غیبت:</strong> ${e}</p>
        <p><strong>فرصت از دست رفته:</strong> ${o.statusCounters.missedChances||0}</p>
        <p><strong>مشکل:</strong> ${l}</p>
    `,s.appendChild(r),r.querySelector("p:nth-child(1)");const t=r.querySelector("p:nth-child(4)"),n=Le(N.categories),a=document.createElement("div");if(a.className="stats-breakdown",n.length>0){n.forEach(b=>{var w;const m=b.name,y=((w=o.categoryCounts)==null?void 0:w[m])||0,g=document.createElement("p");g.className="stats-breakdown-item",g.innerHTML=`<strong>${m}:</strong> ${y}`,a.appendChild(g)});const f=r.querySelector("p:first-child");f&&(f.classList.add("collapsible-toggle"),f.onclick=()=>{a.classList.toggle("open"),f.classList.toggle("open")},f.after(a))}const i=document.createElement("div");i.className="stats-breakdown",n.length>0&&(n.forEach(f=>{var g;const b=f.name,m=((g=o.categoryIssues)==null?void 0:g[b])||0,y=document.createElement("p");y.className="stats-breakdown-item",y.innerHTML=`<strong>${b}:</strong> ${m}`,i.appendChild(y)}),t&&(t.classList.add("collapsible-toggle"),t.onclick=()=>{i.classList.toggle("open"),t.classList.toggle("open")},r.appendChild(i)));const u=document.createElement("p"),p=document.createElement("strong");p.textContent="تکالیف ناقص:";const v=document.createElement("span");v.style.marginRight="5px";const h=Xe(N);yn(o,h,v,{includePrefix:!1}),u.appendChild(p),u.appendChild(v),r.appendChild(u)}function Ii(s){if(!Ee)return;const o=Ee,e=document.createElement("h4");e.textContent="تاریخچه نمرات:",e.style.marginTop="20px";const l=document.createElement("ul");l.className="list-container";const r=Object.values(o.logs.scores||{}).flat().filter(t=>!t.isDeleted).sort((t,n)=>new Date(n.timestamp)-new Date(t.timestamp));r.length===0?l.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>':r.forEach(t=>{const n=document.createElement("li");n.className="score-history-item";const a=document.createElement("div");a.className="item-content";const i=document.createElement("div");i.className="score-info";const u=document.createElement("span");u.className="score-skill-badge",u.textContent=t.skill;const p=document.createElement("span");p.className="score-value",p.textContent=`نمره: ${t.value}`;const v=document.createElement("span");if(v.className="score-date",v.textContent=new Date(t.timestamp).toLocaleDateString("fa-IR"),i.appendChild(u),i.appendChild(p),i.appendChild(v),a.appendChild(i),t.comment){const f=document.createElement("p");f.className="score-comment",f.innerHTML=ii(t.comment),f.addEventListener("click",()=>{we.value=t.comment,we.dispatchEvent(new Event("input",{bubbles:!0})),st(b=>{t.comment=b,le(),_e(N.info.name,`توضیحات نمره ${t.value} (${t.skill}) برای دانش‌آموز «${o.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:o.identity.studentId}),Me(o),Q("✅ توضیحات نمره با موفقیت ویرایش شد.")}),ke(()=>{ze("add-note-modal"),we.focus()})}),a.appendChild(f)}const h=document.createElement("button");h.className="btn-icon delete-item-btn",h.innerHTML="🗑️",h.title="حذف این نمره",h.addEventListener("click",()=>{ke(()=>{Se(`آیا از انتقال نمره ${t.value} در مهارت «${t.skill}» به سطل زباله مطمئن هستید؟`,()=>{const f={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"score",description:`نمره ${t.value} (${t.skill}) برای «${o.identity.name}»`,restoreData:{scoreId:t.id,skill:t.skill,studentId:o.identity.studentId,classId:N.info.scheduleCode}};pe.unshift(f),pe.length>50&&pe.pop(),t.isDeleted=!0,le(),_e(N.info.name,`نمره ${t.value} (${t.skill}) دانش‌آموز «${o.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),Me(o),Q("✅ نمره به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{Me(o)}})})}),n.appendChild(a),n.appendChild(h),l.appendChild(n)}),s.appendChild(e),s.appendChild(l)}function xi(s){if(!Ee)return;const o=document.createElement("h4");o.textContent="تاریخچه یادداشت‌ها:",o.style.marginTop="20px";const e=document.createElement("ul");e.className="list-container",!Ee.profile.notes||Ee.profile.notes.length===0?e.innerHTML='<div class="no-content-message">هنوز یادداشتی ثبت نشده است.</div>':[...Ee.profile.notes].filter(r=>!r.isDeleted).sort((r,t)=>new Date(t.timestamp)-new Date(r.timestamp)).forEach(r=>{const t=document.createElement("li");t.className="note-history-item";const n=document.createElement("div");n.className="item-content";const a=document.createElement("div");a.className="note-info";const i=document.createElement("span");i.className="note-date",i.textContent=new Date(r.timestamp).toLocaleDateString("fa-IR");const u=document.createElement("button");u.className="btn-icon delete-item-btn",u.innerHTML="🗑️",u.title="حذف این یادداشت",u.addEventListener("click",()=>{const v=Ee;ke(()=>{Se("آیا از انتقال این یادداشت به سطل زباله مطمئن هستید؟",()=>{const h={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"note",description:`یادداشت برای دانش‌آموز «${v.identity.name}»`,restoreData:{noteId:r.id,studentId:v.identity.studentId,classId:N.info.scheduleCode}};pe.unshift(h),pe.length>50&&pe.pop(),r.isDeleted=!0,_e(N.info.name,`یادداشت دانش‌آموز «${v.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),le(),Me(v),Q("✅ یادداشت به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{Me(v)}})})}),a.appendChild(i),a.appendChild(u);const p=document.createElement("p");p.className="note-content",p.innerHTML=ii(r.content),p.addEventListener("click",()=>{const v=Ee;we.value=r.content,we.dispatchEvent(new Event("input",{bubbles:!0})),st(h=>{r.content=h,le(),_e(N.info.name,`یادداشت دانش‌آموز «${v.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:v.identity.studentId}),Me(v),Q("✅یادداشت با موفقیت ویرایش شد.")}),ke(()=>{ze("add-note-modal"),we.focus()})}),n.appendChild(a),n.appendChild(p),t.appendChild(n),e.appendChild(t)}),s.appendChild(o),s.appendChild(e)}function Li(s){Jn.innerHTML="",s.forEach((o,e)=>{const l=document.createElement("option");l.value=e,l.textContent=o.trim(),Jn.appendChild(l)})}function ls(){Kn.innerHTML="",fs.forEach(s=>{const o=document.createElement("li");o.className="preview-item";const e=document.createElement("input");e.type="checkbox",e.checked=!0,e.dataset.name=s;const l=document.createElement("label");l.textContent=s,o.appendChild(e),o.appendChild(l),Kn.appendChild(o)})}function Ja(s){const o=document.createElement("div");o.className="list-item-buttons";const e=document.createElement("button");return e.className="btn-icon",e.innerHTML="📝",e.title="ویرایش یادداشت کلاس",s.note||(e.style.display="none"),e.addEventListener("click",l=>{l.stopPropagation(),zn(s)}),o.appendChild(e),o}function Ya(s){const o=document.createElement("div");o.style.flexGrow="1",o.style.display="flex",o.style.flexDirection="column",o.style.alignItems="flex-start";const e=document.createElement("span");e.textContent=s.info.name,e.classList.add("class-name-display"),o.appendChild(e);const l=Le(s.students).length,r=Le(s.sessions).filter(u=>u.isFinished).length,t=ar(s.info.scheduleDays),n=document.createElement("div");n.classList.add("class-stats-row");const a=document.createElement("span");a.textContent=`${l} نفر`,a.classList.add("student-count-badge"),n.appendChild(a);const i=document.createElement("span");if(i.textContent=`${r} جلسه`,i.classList.add("session-count-badge"),n.appendChild(i),t){const u=document.createElement("span");u.textContent=t,u.classList.add("schedule-days-badge"),n.appendChild(u)}return o.appendChild(n),o.addEventListener("click",()=>{Pe(s),Ue(null),Qt(N.liveSession),We(),ge("session-page")}),o}function Xa(s){const o=document.createElement("li"),e=document.createElement("input");e.type="checkbox",e.className="mass-selection-checkbox",e.checked=rt.includes(s.info.name),e.addEventListener("click",i=>{i.stopPropagation()}),e.addEventListener("change",()=>{const i=s.info.name;if(e.checked)rt.includes(i)||rt.push(i);else{const u=rt.indexOf(i);u>-1&&rt.splice(u,1)}}),o.appendChild(e);const l=Ya(s);o.appendChild(l);const r=document.createElement("div");if(r.className="list-item-badges",s.liveSession&&!s.liveSession.isCancelled&&!s.liveSession.isDeleted){const i=document.createElement("span");i.className="warning-badge",i.textContent="جلسه باز",r.appendChild(i),o.classList.add("has-unfinished-session")}const t=document.createElement("span");if(t.className=`type-badge ${s.info.type}`,t.textContent=s.info.type==="online"?"آنلاین":"حضوری",t.title="نوع کلاس",r.appendChild(t),ds(s).type==="incomplete"){const i=document.createElement("span");i.className="type-badge cancelled-badge",i.textContent="نقص",i.style.cursor="pointer",i.title="برای تکمیل زمان‌بندی کلیک کنید",i.addEventListener("click",u=>{u.stopPropagation(),Se("زمان‌بندی این کلاس کامل نیست. برای نمایش صحیح در لیست، لطفاً روزها و ساعت برگزاری را مشخص کنید.",()=>{Dt(s)},{confirmText:"تنظیمات",confirmClass:"btn-primary"})}),r.appendChild(i)}else{const i=ir(s,oe);if(i){const u=document.createElement("span");u.className="type-badge conflict-badge",u.textContent="تداخل زمانی",u.style.cursor="pointer",u.title=`تداخل با کلاس: ${i}`,u.addEventListener("click",p=>{p.stopPropagation(),Se(`زمان برگزاری این کلاس با کلاس «${i}» تداخل دارد. لطفاً زمان‌بندی را بررسی کنید.`,()=>{Dt(s)},{confirmText:"تنظیمات",confirmClass:"btn-primary"})}),r.appendChild(u)}}const a=Ja(s);return o.appendChild(a),o.appendChild(r),o.addEventListener("contextmenu",i=>{const u={label:"پشتیبان‌گیری از این کلاس",icon:"📤",action:()=>{nn([s.info.name])}},p=rt.length;p>1&&rt.includes(s.info.name)&&(u.label=`پشتیبان‌گیری از ${p} کلاس`,u.action=()=>{nn(rt),qn([]),He()});const v=[{label:Bt.classList.contains("selection-mode-active")?"لغو انتخاب":"انتخاب چند کلاس",icon:"✔️",action:()=>{const h=Bt.classList.contains("selection-mode-active");Bt.classList.toggle("selection-mode-active"),h&&(qn([]),He())}},u,{label:"یادداشت کلاس",icon:"📝",action:()=>{zn(s)}},{label:"تنظیمات کلاس",icon:"⚙️",action:()=>{Dt(s)}},{label:"گزارش فعالیت‌ها",icon:"📋",action:()=>{_i(s.info.name)}},{label:"تغییر نام",icon:"✏️",action:()=>{const h=s.info.name,f=document.getElementById("add-note-modal-title");f.textContent="تغییر نام کلاس",we.value=h,we.rows=1,st(b=>{const m=b.trim();if(m&&m!==h){const y=Ws(h,m);y.success?(Wi(h,m),_e(m,`نام کلاس از «${h}» به «${m}» تغییر یافت.`,{type:"VIEW_SESSIONS"}),le(),He(),Q(`✅نام کلاس به «${m}» تغییر یافت.`)):Q(y.message)}f.textContent="ثبت یادداشت جدید",we.rows=4}),ze("add-note-modal"),we.focus(),we.select()}},{label:"حذف کلاس",icon:"🗑️",className:"danger",action:()=>{Se(`آیا از انتقال کلاس «${s.info.name}» به سطل زباله مطمئن هستید؟`,()=>{const h={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"classroom",description:`کلاس «${s.info.name}»`,restoreData:{name:s.info.name}};pe.unshift(h),pe.length>50&&pe.pop(),s.isDeleted=!0,le(),He(),Q(`✅ کلاس «${s.info.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}];an(i,v)}),o}function $n(){const s=document.getElementById("class-management-stats");if(!s)return;const o=Object.values(oe).filter(t=>!t.isDeleted),e=o.length,l=o.reduce((t,n)=>t+Le(n.students).length,0);let r="";je.lastBackupTimestamp&&(r=`
            <div class="stats-row backup-stat">
                <span>آخرین پشتیبان: <strong>${new Date(je.lastBackupTimestamp).toLocaleString("fa-IR",{year:"numeric",month:"numeric",day:"numeric",weekday:"long",hour:"2-digit",minute:"2-digit"})}</strong></span>
            </div>
        `),s.innerHTML=`
        <div class="stats-row main-stats">
            <span>کل کلاس‌ها: <strong>${e}</strong></span>
            <span>|</span>
            <span>کل دانش‌آموزان: <strong>${l}</strong></span>
        </div>
        ${r} 
    `}function He(){$n(),Bt.innerHTML="",Object.values(oe).sort((o,e)=>{const l=ds(o),r=ds(e);return l.sortIndex!==r.sortIndex?l.sortIndex-r.sortIndex:l.type==="upcoming"?l.nextTimestamp-r.nextTimestamp:new Date(o.info.creationDate)-new Date(e.info.creationDate)}).forEach(o=>{if(o.isDeleted)return;const e=Xa(o);Bt.appendChild(e)})}function lt(){Gn.innerHTML="",N&&Le(N.students).forEach(s=>{const o=document.createElement("li"),e=document.createElement("span");e.textContent=s.identity.name,e.style.flexGrow="1",e.className="student-name-link",e.addEventListener("click",()=>{Me(s)}),o.appendChild(e),o.addEventListener("contextmenu",l=>{an(l,[{label:"تغییر نام",icon:"✏️",action:()=>{Ts(s,N)}},{label:"انتقال دانش‌آموز",icon:"➡️",action:()=>{Ls(s,N)}},{label:"حذف دانش‌آموز",icon:"🗑️",className:"danger",action:()=>{Se(`آیا از انتقال دانش‌آموز «${s.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const t={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${s.identity.name}» از کلاس «${N.info.name}»`,restoreData:{studentId:s.identity.studentId,classId:N.info.scheduleCode}};pe.unshift(t),pe.length>50&&pe.pop(),s.isDeleted=!0,_e(N.info.name,`دانش‌آموز «${s.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),le(),lt(),Q(`✅ دانش‌آموز «${s.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}])}),Gn.appendChild(o)})}function Mt(){if(Vn.innerHTML="",!N)return;N.categories.filter(o=>!o.isDeleted).forEach(o=>{const e=document.createElement("li"),l=document.createElement("div");l.className="name-and-badge-container";const r=document.createElement("span");if(r.textContent=o.name,l.appendChild(r),o.isGradedCategory){const n=document.createElement("span");n.className="category-badge",n.textContent="نمره‌دار",l.appendChild(n)}const t=document.createElement("button");t.className="btn-icon",t.innerHTML="🗑️",t.style.color="var(--color-warning)",t.addEventListener("click",()=>{Se(`آیا از انتقال دسته‌بندی «${o.name}» به سطل زباله مطمئن هستید؟`,()=>{const n={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${o.name}» از کلاس «${N.info.name}»`,restoreData:{categoryId:o.id,classId:N.info.scheduleCode}};pe.unshift(n),pe.length>50&&pe.pop(),o.isDeleted=!0,_e(N.info.name,`دسته‌بندی «${o.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),le(),Mt(),Q(`✅ دسته‌بندی «${o.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}),e.appendChild(l),e.appendChild(t),Vn.appendChild(e)})}function Ti(){if(!N)return;const s=N.info.type||"in-person",o=document.querySelector(`#settings-page input[name="class-type-setting"][value="${s}"]`);o&&(o.checked=!0);const e=N.info.scheduleDays||[];document.querySelectorAll('input[name="schedule-day"]').forEach(l=>{l.checked=e.includes(parseInt(l.value))}),document.getElementById("settings-schedule-start").value=N.info.scheduleStartTime||"",document.getElementById("settings-schedule-end").value=N.info.scheduleEndTime||""}function Yt(s){document.querySelectorAll(".page").forEach(e=>{e.classList.remove("active")});const o=document.getElementById(s);o&&o.classList.add("active"),s==="class-management-page"?(Pe(null),Ue(null),Ve(null),He(),Yn.style.display="flex"):Yn.style.display="none",Ei()}function ge(s,o={}){const{tab:e}=o,l={pageId:s,currentClassName:N?N.info.name:null,selectedSessionNumber:J?J.sessionNumber:null,selectedStudentId:Ee?Ee.identity.studentId:null};let r=`#${s}`;const t=new URLSearchParams(window.location.hash.split("?")[1]||"");N?t.set("class",N.info.name):t.delete("class"),J?t.set("session",J.sessionNumber):t.delete("session"),Ee?t.set("student",Ee.identity.studentId):t.delete("student"),s==="session-dashboard-page"&&e?t.set("tab",e):s!=="session-dashboard-page"&&t.delete("tab");const n=t.toString();n&&(r+=`?${n}`),window.location.hash!==r&&history.pushState(l,"",r),Yt(s)}function Qa(s,o){const e=document.createElement("div");e.className="list-item-buttons";const l=document.createElement("button");if(l.className="btn-icon",l.innerHTML="📝",l.title="افزودن/ویرایش یادداشت جلسه",l.style.borderBottom="solid",s.note||(l.style.opacity="0.5",l.style.borderBottom="none"),l.addEventListener("click",r=>{r.stopPropagation(),we.value=s.note||"",st(t=>{s.note=t,le(),_e(N.info.name,`یادداشت جلسه ${o} ذخیره شد.`,{type:"VIEW_SESSIONS"}),We(),Q("✅یادداشت جلسه ذخیره شد.")}),ze("add-note-modal"),we.focus()}),e.appendChild(l),!s.isFinished&&!s.isCancelled){const r=document.createElement("button");r.className="btn-icon",r.innerHTML="✅",r.title="خاتمه جلسه",r.addEventListener("click",t=>{t.stopPropagation(),Se(`جلسه شماره ${o} خاتمه پیدا خواهد کرد!`,()=>{N.endSpecificSession(s.sessionNumber),le(),_e(N.info.name,`جلسه ${o} خاتمه یافت.`,{type:"VIEW_SESSIONS"}),We(),Se("جلسه با موفقیت خاتمه یافت. آیا مایل به ایجاد فایل پشتیبان هستید؟",()=>{if(ot){Q("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است.");return}nn(),Q("✅فایل پشتیبان با موفقیت ایجاد شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}),e.appendChild(r)}return e}function er(s,o){const e=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="flex-start",e.style.flexGrow="1";const l=new Date(s.startTime).toLocaleDateString("fa-IR"),r=document.createElement("span");r.className="session-list-title";const t=document.createElement("div");t.style.display="flex",t.style.gap="5px",t.style.marginTop="5px";const n=new Date(s.startTime).toLocaleDateString("fa-IR",{weekday:"long"}),a=document.createElement("span");if(a.className="type-badge day-badge",a.textContent=n,t.appendChild(a),s.isCancelled){r.textContent=`لغو شده - تاریخ: ${l}`,e.style.cursor="default";const i=document.createElement("span");i.className="type-badge cancelled-badge",i.textContent="لغو شده",t.appendChild(i)}else r.textContent=`جلسه ${o} - تاریخ: ${l}`,e.style.cursor="pointer",e.addEventListener("click",()=>{Ue(s),Rt()});if(e.appendChild(r),s.isFinished){const i=document.createElement("span");i.className="type-badge finished-badge",i.textContent="خاتمه یافته",t.appendChild(i)}if(s.isMakeup){const i=document.createElement("span");i.className="type-badge makeup-badge",i.textContent="جبرانی",t.appendChild(i)}return e.appendChild(t),e}function tr(s,o){const e=document.createElement("li"),l=o.get(s.sessionNumber),r=er(s,l);e.appendChild(r);const t=Qa(s,l);return e.appendChild(t),e.addEventListener("contextmenu",n=>{const a=[{label:s.isCancelled?"بازگردانی جلسه":"لغو جلسه",icon:"❌",action:()=>{const i=s.isCancelled?"بازگردانی جلسه":"لغو جلسه",u=s.isCancelled?"آیا از بازگردانی این جلسه مطمئن هستید؟":"آیا از لغو این جلسه مطمئن هستید؟ جلسه لغو شده در آمار تاثیری ندارد اما قابل بازگردانی است.";Se(u,()=>{s.isCancelled=!s.isCancelled;const p=s.isCancelled?`جلسه ${l} لغو شد.`:`جلسه لغو شده (تاریخ: ${new Date(s.startTime).toLocaleDateString("fa-IR")}) بازگردانی شد.`;_e(N.info.name,p,{type:"VIEW_SESSIONS"}),le(),We(),Q(s.isCancelled?"✅جلسه لغو شد.":"✅جلسه بازگردانی شد.")},{confirmText:i,confirmClass:"btn-warning"})}},{label:"تغییر وضعیت جبرانی",icon:"🔄",action:()=>{N.markAsMakeup(s.sessionNumber),le();const i=s.isMakeup?`جلسه ${l} به عنوان جبرانی علامت‌گذاری شد.`:`جلسه ${l} از حالت جبرانی خارج شد.`;_e(N.info.name,i,{type:"VIEW_SESSIONS"}),We()}},{label:"حذف جلسه",icon:"🗑️",className:"danger",action:()=>{const i=s.isCancelled?"لغو شده":l;Se(`آیا از انتقال جلسه ${i} به سطل زباله مطمئن هستید؟`,()=>{const u={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"session",description:`جلسه ${i} از کلاس «${N.info.name}»`,restoreData:{sessionNumber:s.sessionNumber,classId:N.info.scheduleCode}};pe.unshift(u),pe.length>50&&pe.pop(),s.isDeleted=!0,_e(N.info.name,`جلسه ${i} به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),le(),We(),Q(`✅ جلسه ${i} به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}];an(n,a)}),e}function We(){const s=document.getElementById("session-list");if(!N)return;if(s.innerHTML="",N.sessions.length===0){s.innerHTML="<li>هنوز جلسه‌ای شروع نشده است.</li>";return}const o=Xe(N);[...Le(N.sessions)].reverse().forEach(l=>{const r=tr(l,o);s.appendChild(r)})}function Zt(s){if(mt.innerHTML="",s.length>0)s.forEach(o=>{const e=document.createElement("div");e.textContent=o.identity.name,e.addEventListener("click",()=>{Me(o),mt.style.display="none",es.value=""}),mt.appendChild(e)}),mt.style.display="block";else if(es.value.trim()!==""){const o=document.createElement("div");o.className="no-results",o.textContent="پیدا نشد",mt.appendChild(o),mt.style.display="block"}else mt.style.display="none"}function vn(s){if(at.innerHTML="",s.length>0)s.forEach(o=>{const e=document.createElement("div");if(e.className="global-search-result",o.type==="student"){const l=document.createElement("span");l.className="student-name",l.textContent=o.student.identity.name;const r=document.createElement("span");r.className="class-name",r.textContent=`کلاس: ${o.classroom.info.name}`,e.addEventListener("click",()=>{Pe(o.classroom),Me(o.student),at.style.display="none",jt.value=""}),r.addEventListener("click",t=>{t.stopPropagation(),Pe(o.classroom),Ue(null),Qt(o.classroom.liveSession),We(),ge("session-page"),at.style.display="none",jt.value=""}),e.appendChild(l),e.appendChild(r)}else if(o.type==="classroom"){const l=document.createElement("span");l.className="student-name",l.textContent=`[کلاس] ${o.classroom.info.name}`,e.addEventListener("click",()=>{Pe(o.classroom),Ue(null),Qt(o.classroom.liveSession),We(),ge("session-page"),at.style.display="none",jt.value=""}),e.appendChild(l)}at.appendChild(e)}),at.style.display="block";else if(jt.value.trim()!==""){const o=document.createElement("div");o.className="no-results",o.textContent="پیدا نشد",at.appendChild(o),at.style.display="block"}else at.style.display="none"}function sn(){const s=document.getElementById("trashed-items-list");if(s.innerHTML="",pe.length===0){s.innerHTML='<li style="text-align: center; padding: 20px;">سطل زباله خالی است.</li>';return}pe.forEach((o,e)=>{const l=document.createElement("li"),r=document.createElement("span");r.textContent=o.description,r.style.flexGrow="1";const t=document.createElement("div");t.className="list-item-buttons";const n=document.createElement("button");n.className="btn-icon",n.innerHTML="🔄",n.title="بازیابی",n.addEventListener("click",()=>{var v;let i=!1,u=null;const p=o.restoreData;switch(o.type){case"classroom":{const h=oe[p.name];h&&!h.isDeleted?u=`کلاسی با نام «${p.name}» از قبل فعال است.`:h&&h.isDeleted&&(h.isDeleted=!1,i=!0);break}case"student":{const h=Object.values(oe).find(b=>b.info.scheduleCode===p.classId),f=h==null?void 0:h.students.find(b=>b.identity.studentId===p.studentId);f&&(f.isDeleted=!1,i=!0);break}case"session":{const h=Object.values(oe).find(b=>b.info.scheduleCode===p.classId),f=h==null?void 0:h.sessions.find(b=>b.sessionNumber===p.sessionNumber);f&&(f.isDeleted=!1,i=!0);break}case"category":{const h=Object.values(oe).find(b=>b.info.scheduleCode===p.classId),f=h==null?void 0:h.categories.find(b=>b.id===p.categoryId);f&&(f.isDeleted=!1,i=!0);break}case"score":{const h=Object.values(oe).find(m=>m.info.scheduleCode===p.classId),f=h==null?void 0:h.students.find(m=>m.identity.studentId===p.studentId),b=(v=f==null?void 0:f.logs.scores[p.skill.toLowerCase()])==null?void 0:v.find(m=>m.id===p.scoreId);b&&(b.isDeleted=!1,i=!0);break}case"note":{const h=Object.values(oe).find(m=>m.info.scheduleCode===p.classId),f=h==null?void 0:h.students.find(m=>m.identity.studentId===p.studentId),b=f==null?void 0:f.profile.notes.find(m=>m.id===p.noteId);b&&(b.isDeleted=!1,i=!0);break}}i?(pe.splice(e,1),le(),sn(),o.type==="classroom"&&He(),Q("✅ آیتم با موفقیت بازیابی شد.")):Q(u?`⚠️ ${u}`:"⚠️ آیتم اصلی برای بازیابی یافت نشد.")});const a=document.createElement("button");a.className="btn-icon",a.innerHTML="🔥",a.title="حذف دائمی",a.addEventListener("click",()=>{Se("آیا از حذف دائمی این آیتم مطمئن هستید؟ این عمل غیرقابل بازgشت است.",()=>{const i=o.restoreData,u=v=>Object.values(oe).find(h=>h.info.scheduleCode===v);let p;switch(o.type){case"classroom":delete oe[i.name];break;case"student":p=u(i.classId),Ln({identity:{studentId:i.studentId}},p);break;case"session":p=u(i.classId),p&&qs(p.info.name,i.sessionNumber);break;case"category":p=u(i.classId),p&&Gs(p.info.name,i.categoryId);break;case"score":p=u(i.classId),p&&Vs(p.info.name,i.studentId,i.skill,i.scoreId);break;case"note":p=u(i.classId),p&&Ks(p.info.name,i.studentId,i.noteId);break}pe.splice(e,1),le(),sn(),Q("✅ آیتم برای همیشه حذف شد.")},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),t.appendChild(n),t.appendChild(a),l.appendChild(r),l.appendChild(t),s.appendChild(l)})}function nr(){const s=document.getElementById("absentees-summary-container");s&&(s.innerHTML=`
        <div id="absentees-summary-box" class="absentees-summary">
            <div class="absentees-summary-header">
                <h4>لیست غایبین جلسه شماره <span id="absentee-summary-session-number"></span></h4>
                <button id="copy-absentees-btn" class="btn-icon" title="کپی لیست غایبین">📋</button>
            </div>
            <div id="absentees-summary-list" class="summary-list"></div>
        </div>
    `)}function Bi(){const s=document.getElementById("absentees-summary-box"),o=document.getElementById("absentees-summary-list"),e=document.getElementById("absentee-summary-session-number");if(!s||!o||!e){console.error("Could not find all absentee summary elements.");return}if(!N||!J){s.classList.remove("visible");return}const l=Le(N.students).filter(t=>{const n=J.studentRecords[t.identity.studentId];return n&&n.attendance==="absent"}),r=Xe(N);e.textContent=r.get(J.sessionNumber),l.length>0?s.classList.add("visible"):s.classList.remove("visible"),o.innerHTML="",l.forEach(t=>{const a=(u=>N.sessions.reduce((p,v)=>{if(v.isDeleted||v.isCancelled)return p;const h=v.studentRecords[u.identity.studentId];return p+(h&&h.attendance==="absent"?1:0)},0))(t),i=document.createElement("span");i.className="summary-name",i.textContent=`${t.identity.name} (غیبت: ${a})`,i.addEventListener("click",()=>{i.classList.add("fading-out"),setTimeout(()=>{J.setAttendance(t.identity.studentId,"present"),le(),ut()},200)}),o.appendChild(i)})}function sr(){const s=document.getElementById("copy-absentees-btn");if(!s){console.error("Could not find the copy absentees button to attach listener.");return}s.addEventListener("click",()=>{if(!N||!J)return;const o=Le(N.students).filter(r=>{const t=J.studentRecords[r.identity.studentId];return t&&t.attendance==="absent"});if(o.length===0){Q("⚠️لیست غایبین خالی است.");return}const e=r=>N.sessions.reduce((t,n)=>{if(n.isDeleted||n.isCancelled)return t;const a=n.studentRecords[r.identity.studentId];return t+(a&&a.attendance==="absent"?1:0)},0);let l=`لیست غایبین جلسه شماره ${Za()}:

`;o.forEach(r=>{const t=e(r);l+=`- ${r.identity.name} (تعداد غیبت‌ها: ${t})
`}),navigator.clipboard.writeText(l).then(()=>{Q("✅لیست غایبین با موفقیت کپی شد.")}).catch(r=>{console.error("Failed to copy text: ",r),Q("❌خطا در کپی کردن لیست.")})})}function Cn(){const s=document.getElementById("demo-mode-banner");s&&(ot?(s.classList.add("visible"),document.body.classList.add("demo-mode-active")):(s.classList.remove("visible"),document.body.classList.remove("demo-mode-active")))}function ds(s){const{scheduleDays:o,scheduleStartTime:e,scheduleEndTime:l}=s.info,r=o&&o.length>0,t=e&&l;if(!r&&!t)return{type:"unscheduled",sortIndex:3};if(!r||!t)return{type:"incomplete",sortIndex:2};const n=new Date,a=n.getDay(),i=n.getHours()*60+n.getMinutes(),[u,p]=e.split(":").map(Number),[v,h]=l.split(":").map(Number),f=u*60+p,b=v*60+h;if(o.includes(a)&&i>=f&&i<b)return{type:"active",sortIndex:0};for(let m=0;m<=7;m++){const y=(a+m)%7;if(o.includes(y)){if(m===0&&i>=f)continue;const g=new Date(n);return g.setDate(n.getDate()+m),g.setHours(u,p,0,0),{type:"upcoming",sortIndex:1,nextTimestamp:g.getTime()}}}return{type:"upcoming",sortIndex:1,nextTimestamp:9999999999999}}function ir(s,o){const{scheduleDays:e,scheduleStartTime:l,scheduleEndTime:r}=s.info;if(!e||!e.length||!l||!r)return null;const[t,n]=l.split(":").map(Number),[a,i]=r.split(":").map(Number),u=t*60+n,p=a*60+i;for(const v of Object.values(o)){if(v===s||v.isDeleted||v.info.name===s.info.name)continue;const h=v.info;if(!h.scheduleDays||!h.scheduleDays.length||!h.scheduleStartTime||!h.scheduleEndTime||!e.some(I=>h.scheduleDays.includes(I)))continue;const[b,m]=h.scheduleStartTime.split(":").map(Number),[y,g]=h.scheduleEndTime.split(":").map(Number),w=b*60+m,k=y*60+g;if(u<k&&p>w)return v.info.name}return null}function ar(s){if(!s||s.length===0)return"";const o={6:"شنبه",0:"۱شنبه",1:"۲شنبه",2:"۳شنبه",3:"۴شنبه",4:"۵شنبه",5:"جمعه"};return[...s].sort((l,r)=>{const t={6:0,0:1,1:2,2:3,3:4,4:5,5:6};return t[l]-t[r]}).map(l=>o[l]).join("، ")}const rr=Object.freeze(Object.defineProperty({__proto__:null,_internalShowPage:Yt,addCategoryBtn:ra,addClassBtn:ji,addNoteModal:va,addScoreBtn:Sa,addStudentBtn:Ki,appHeader:Yn,attendanceListUl:Gt,attendanceMassActionsContainer:gn,attendancePage:oa,attendancePane:Ot,attendanceSearchInput:vt,backToSessionsBtn:Gi,backToStudentPageBtn:_a,backupDataBtn:ha,breadcrumbContainer:Lt,cancelImportBtn:ia,cancelNoteBtn:wa,categoryListUl:Vn,categoryModal:Ra,categoryModalCancelBtn:Ma,categoryModalSaveBtn:gi,categoryModalTitle:pi,classListHeader:la,classListUl:Bt,classManagementPage:oi,classSaveNoteBtn:Ca,closeActiveModal:ke,closeContextMenu:Ct,closeNavBtn:fa,columnMappingPage:na,columnSelectDropdown:Jn,confirmColumnBtn:sa,confirmModalCancelBtn:Qn,confirmModalConfirmBtn:Ut,confirmModalMessage:ui,contextMenu:_t,csvCancelBtn:Qi,csvConfirmBtn:Xi,csvFileInput:ta,csvPreviewList:Kn,csvPreviewPage:Yi,customConfirmModal:ga,displayWinner:Fe,finishAttendanceBtn:ca,globalStudentSearchInput:jt,globalStudentSearchResultsDiv:at,gradedCategoryPillsContainer:Ea,hamburgerMenuBtn:da,handleUndo:vi,importCsvBtn:ea,initiateBackupProcess:nn,isGradedCheckbox:La,massCommentAppendCheckbox:xs,massCommentBtn:ns,massCommentCancelBtn:Fa,massCommentContent:Jt,massCommentModal:za,massCommentModalTitle:$a,massCommentSaveBtn:Pa,massCommentStudentCountMessage:yi,newCategoryModalIsGradedCheckbox:Is,newCategoryModalNameInput:Kt,newCategoryNameInput:aa,newClassNameInput:Ui,newNoteContent:we,newScoreCommentTextarea:hi,newScoreValueInput:ka,newStudentNameInput:Vi,openContextMenu:an,openModal:ze,overlay:ma,pasteArea:li,processMassHomeworkComment:as,processPasteBtn:Ji,profileScoresListUl:xa,profileStatsSummaryDiv:Ia,quickGradeFormWrapper:Tt,quickGradeSubmitBtn:wt,quickNoteTextarea:tt,quickScoreInput:ct,renderAttendancePage:ut,renderBreadcrumbs:Ei,renderClassList:He,renderClassManagementStats:$n,renderColumnSelector:Li,renderGlobalSearchResults:vn,renderImportPreview:ls,renderLogModal:_i,renderMassCommentControls:Bs,renderScoresHistory:Ii,renderSearchResults:Zt,renderSessionDashboard:Rt,renderSessions:We,renderSettingsCategories:Mt,renderSettingsOther:Ti,renderSettingsStudentList:lt,renderStudentNotes:xi,renderStudentStatsList:Re,renderTrashPage:sn,restoreDataBtn:pa,restoreFileInput:di,secureConfirmCancelBtn:ba,secureConfirmCode:mi,secureConfirmConfirmBtn:pn,secureConfirmInput:xt,secureConfirmMessage:fi,secureConfirmModal:ya,selectStudentBtn:nt,selectStudentBtnWrapper:At,sessionDashboardPage:Ha,setAutoDirectionOnInput:ki,settingsClassNameHeader:Ss,settingsPage:qi,settingsStudentListUl:Gn,setupDashboardTabs:bi,showCategoryModal:is,showClassNoteModal:zn,showCustomConfirm:Se,showMassCommentModal:wi,showMoveStudentModal:Ls,showNotification:Q,showPage:ge,showRenameStudentModal:Ts,showRestoreConfirmModal:ss,showSecureConfirm:Ci,showSettingsPage:Dt,showStudentProfile:Me,showUndoToast:Wa,sideNavMenu:ua,studentSearchInput:es,studentSearchResultsDiv:mt,studentStatsHeader:Xn,switchDashboardTab:tn,trashedCategoriesList:Da,trashedClassesList:Ta,trashedNotesList:Aa,trashedScoresList:Oa,trashedSessionsList:Na,trashedStudentsList:Ba,triggerFileDownload:rs,undoBtn:Zi,undoMessage:ci,undoToast:On,updateDemoModeBanner:Cn},Symbol.toStringTag,{value:"Module"}));function or(){const s=window.location.hash;if(!s||s==="#")return!1;const[o,e]=s.split("?"),l=o.substring(1),r=new URLSearchParams(e),t=r.get("class"),n=parseInt(r.get("session"),10),a=r.get("student"),i=r.get("tab")||"selector";if(t&&oe[t])Pe(oe[t]),n&&N.getSession(n)&&Ue(N.getSession(n)),a&&N.students.find(u=>u.identity.studentId===a)&&Ve(N.students.find(u=>u.identity.studentId===a));else return!1;switch(l){case"session-page":We(),ge("session-page");break;case"session-dashboard-page":Rt(l==="attendance-page"?"attendance":i);break;case"settings-page":Ss.textContent=`تنظیمات کلاس: ${N.info.name}`,lt(),Mt(),ge("settings-page");break;case"student-profile-page":Rt(i),Me(Ee);break;default:return!1}return!0}document.addEventListener("DOMContentLoaded",()=>{const{globalStudentSearchInput:s,newClassNameInput:o,addClassBtn:e,undoBtn:l,newStudentNameInput:r,addStudentBtn:t,pasteArea:n,processPasteBtn:a,csvPreviewList:i,csvConfirmBtn:u,csvCancelBtn:p,importCsvBtn:v,csvFileInput:h,columnSelectDropdown:f,confirmColumnBtn:b,cancelImportBtn:m,newCategoryNameInput:y,addCategoryBtn:g,selectStudentBtn:w,attendancePage:k,finishAttendanceBtn:I,classListHeader:S,studentStatsHeader:O,hamburgerMenuBtn:M,sideNavMenu:U,closeNavBtn:A,overlay:G,backupDataBtn:ie,restoreDataBtn:E,restoreFileInput:z,confirmModalCancelBtn:d,confirmModalConfirmBtn:F,secureConfirmCancelBtn:ue,secureConfirmConfirmBtn:j,newNoteContent:fe,classSaveNoteBtn:$,cancelNoteBtn:te,studentSearchInput:T,studentSearchResultsDiv:D,isGradedCheckbox:re,categoryModalSaveBtn:ee,categoryModalCancelBtn:Y,massCommentBtn:Te,massCommentCancelBtn:Ne,massCommentSaveBtn:be,massCommentContent:Ce,massCommentAppendCheckbox:Ae,attendanceSearchInput:Be}=rr,Ke=document.getElementById("trash-nav-btn");document.querySelector(".global-search-container .search-icon"),xn(),Cn(),or()||(He(),ge("class-management-page"));function c(L,q){const H=document.querySelector(L);if(!H)return;const X=H.querySelector(".search-icon"),ae=H.querySelector(".animated-search-input");!X||!ae||(X.addEventListener("mousedown",de=>{de.preventDefault()}),X.addEventListener("click",()=>{H.classList.contains("search-active")||(H.classList.add("search-active"),ae.focus())}),ae.addEventListener("blur",()=>{setTimeout(()=>{H.classList.remove("search-active"),ae.value="",q&&q([])},150)}))}Be.addEventListener("input",()=>{const L=Be.value.toLowerCase().trim(),q=Un(L);Gt.querySelectorAll(".attendance-list-item").forEach(X=>{const ae=X.querySelector(".student-name");if(ae){const de=ae.textContent,se=Ye(de.toLowerCase()),me=se.includes(Ye(L)),ve=se.includes(Ye(q));me||ve?X.style.display="flex":X.style.display="none"}})}),Y.addEventListener("click",()=>{ke(),Mn(null)}),ee.addEventListener("click",()=>{const L=Kt.value.trim(),q=Is.checked;typeof Sn=="function"&&Sn(L,q)}),window.addEventListener("scroll",Ct),document.addEventListener("click",L=>{_t.classList.contains("visible")&&!_t.contains(L.target)&&Ct(),T.contains(L.target)||(D.style.display="none");const q=L.target.closest(".log-action-link");if(q&&q.dataset.action)try{const H=JSON.parse(q.dataset.action);Qe(H)}catch(H){console.error("Could not parse log action:",H)}}),At.addEventListener("click",()=>{(At.classList.contains("disabled-wrapper")||nt.disabled)&&(nt.classList.add("shake-animation"),setTimeout(()=>{nt.classList.remove("shake-animation")},200))}),O.addEventListener("click",()=>{const L=new Date().getTime();L-ps>500?hn(1):hn(En+1),ti(L),En===5&&(hn(0),Se("آیا از صفر کردن تمام شمارنده‌های دانش‌آموزان مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{Zs(),Re(),Q("تمام آمارها صفر شدند ✅.")},{confirmText:"بله",confirmClass:"btn-warning"}))}),S.addEventListener("click",()=>{const L=new Date().getTime();L-hs>500?mn(1):mn(_n+1),ei(L),_n===5&&(mn(0),Se("آیا از ساخت یک کلاس تستی تصادفی مطمئن هستید؟",()=>{function q(){const H=`کلاس تستی ${Object.keys(oe).length+1}`,X=new Zn({name:H,type:"online"});["علی رضایی","مریم حسینی","زهرا احمدی","رضا محمدی","فاطمه کریمی"].forEach(de=>X.addStudent(new un({name:de}))),oe[H]=X,le(),He()}q(),Q("کلاس تستی با موفقیت ساخته شد ✅!")},{confirmText:"بساز",confirmClass:"btn-success"}))}),ue.addEventListener("click",()=>{ke(),en(null)}),j.addEventListener("click",()=>{typeof kn=="function"&&kn(),ke(),en(null)}),d.addEventListener("click",()=>{ke(ys)}),F.addEventListener("click",()=>{ke(gs)}),w.addEventListener("click",()=>{if(ct.value.trim()!==""||tt.value.trim()!==""){Q("⚠️لطفاً ابتدا با دکمه «ثبت»، تغییرات را ذخیره کنید و یا نمره و یادداشت را پاک کنید.");return}if(!N||!J||!Ge)return;const L=N.selectNextWinner(Ge.name,J);if(L){const q=J.studentRecords[L.identity.studentId];if(q&&q.attendance==="absent"&&L.statusCounters.missedChances++,q&&q.hadIssue){L.statusCounters.missedChances++;const X=Ge.name;L.categoryIssues[X]=(L.categoryIssues[X]||0)+1}q&&q.wasOutOfClass&&(L.statusCounters.outOfClassCount=(L.statusCounters.outOfClassCount||0)+1,L.statusCounters.missedChances++);const H={winner:L,categoryName:Ge.name};J.winnerHistory.push(H),J.winnerHistory.length>10&&J.winnerHistory.shift(),pt(J.winnerHistory.length-1),J.lastUsedCategoryId=Ge.id,J.lastSelectedWinnerId=L.identity.studentId,Re(),setTimeout(()=>Fe(),0),le()}else Q("❌دانش‌آموز واجد شرایطی برای انتخاب یافت نشد.")}),g.addEventListener("click",()=>{if(!N)return;const L=y.value.trim(),q=re.checked;if(!L){alert("⚠️لطفاً نام دسته‌بندی را وارد کنید.");return}const H=N.categories.find(ae=>ae.name.toLowerCase()===L.toLowerCase());if(H)if(H.isDeleted){const ae=N.categories.findIndex(de=>de===H);ae>-1&&N.categories.splice(ae,1)}else{alert("⚠️این دسته‌بندی از قبل وجود دارد.");return}const X=new dt(L,"",q);N.categories.push(X),le(),_e(N.info.name,`دسته‌بندی جدید «${L}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),Mt(),y.value="",re.checked=!1}),document.querySelectorAll('#settings-page input[name="class-type-setting"]').forEach(L=>{L.addEventListener("change",()=>{if(!N)return;const q=L.value,H=N.info.type||"in-person";if(q===H)return;const X=se=>se==="online"?"آنلاین":"حضوری",ae=X(H),de=X(q);Se(`آیا از تغییر نوع کلاس از «${ae}» به «${de}» مطمئن هستید؟`,()=>{N.info.type=q,le(),_e(N.info.name,`نوع کلاس به «${de}» تغییر یافت.`,{type:"VIEW_CLASS_SETTINGS"}),He(),Q(`✅ نوع کلاس به «${de}» تغییر یافت.`)},{confirmText:"بله",confirmClass:"btn-warning",onCancel:()=>{const se=document.querySelector(`#settings-page input[name="class-type-setting"][value="${H}"]`);se&&(se.checked=!0)}})})});const R=document.querySelectorAll('input[name="schedule-day"]'),_=document.getElementById("settings-schedule-start"),C=document.getElementById("settings-schedule-end");R.forEach(L=>{L.addEventListener("change",()=>{if(!N)return;const q=Array.from(R).filter(H=>H.checked).map(H=>parseInt(H.value));N.info.scheduleDays=q,le()})});const x=()=>{N&&(N.info.scheduleStartTime=_.value,N.info.scheduleEndTime=C.value,le())};_.addEventListener("change",x),C.addEventListener("change",x),y.addEventListener("keyup",L=>{L.key==="Enter"&&g.click()}),b.addEventListener("click",()=>{if(!wn){alert("❌خطایی رخ داده است. لطفاً فایل را دوباره انتخاب کنید."),ge("settings-page");return}const L=parseInt(f.value,10),X=wn.split(`
`).slice(1).map(ae=>{var se;return(se=ae.split(",")[L])==null?void 0:se.trim()}).filter(ae=>ae&&ae.length>0);X.length>0?(Wt(X),ls(),ge("csv-preview-page")):alert("هیچ نامی در ستون انتخاب شده پیدا نشد. لطفاً ستون دیگری را امتحان کنید یا فایل خود را بررسی کنید."),fn(null)}),v.addEventListener("click",()=>{h.click()}),h.addEventListener("change",L=>{const q=L.target.files[0];if(!q)return;const H=new FileReader;H.onload=X=>{const ae=X.target.result;fn(ae);const se=ae.split(`
`)[0].split(",");Li(se),ge("column-mapping-page")},H.readAsText(q),L.target.value=null}),m.addEventListener("click",()=>{fn(null),ge("settings-page")}),u.addEventListener("click",()=>{const L=i.querySelectorAll('input[type="checkbox"]:checked');let q=!1;L.forEach(H=>{const X=H.dataset.name,ae=N.students.find(se=>se.identity.name.toLowerCase()===X.toLowerCase());if(ae)if(ae.isDeleted)Ln(ae,N);else{console.log(`دانش‌آموز «${X}» به دلیل تکراری بودن اضافه نشد.`);return}const de=new un({name:X});N.addStudent(de),N.sessions.length>0&&(Le(N.sessions).filter(se=>se.isFinished&&!se.isCancelled).forEach(se=>{se.setAttendance(de.identity.studentId,"absent")}),ft(de,N),q=!0)}),le(),_e(N.info.name,`${L.length} دانش‌آموز جدید از لیست ورودی به کلاس اضافه شدند.`,{type:"VIEW_SESSIONS"}),lt(),q&&qe(L.length),ge("settings-page"),n.value="",Wt([])}),p.addEventListener("click",()=>{Wt([]),ge("settings-page")}),a.addEventListener("click",()=>{const L=n.value.trim();if(!L){alert("کادر متنی خالی است. لطفاً اسامی را وارد کنید.");return}const q=L.split(`
`).map(H=>H.trim()).filter(H=>H.length>0);q.length>0?(Wt(q),ls(),ge("csv-preview-page")):alert("هیچ نام معتبری برای ورود پیدا نشد.")}),r.addEventListener("keyup",L=>{L.key==="Enter"&&t.click()}),t.addEventListener("click",()=>{if(!N)return;const L=r.value.trim();if(!L){alert("لطفاً نام دانش‌آموز را وارد کنید.");return}const q=N.students.find(X=>X.identity.name.toLowerCase()===L.toLowerCase());if(q)if(q.isDeleted)Ln(q,N);else{alert("❌دانش‌آموزی با این نام از قبل در این کلاس وجود دارد.");return}const H=new un({name:L});N.addStudent(H),N.sessions.length>0&&(Le(N.sessions).filter(X=>X.isFinished&&!X.isCancelled).forEach(X=>{X.setAttendance(H.identity.studentId,"absent")}),ft(H,N),qe(1)),le(),_e(N.info.name,`دانش‌آموز «${L}» به کلاس اضافه شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:H.identity.studentId}),lt(),Re(),r.value="",r.focus()}),document.getElementById("new-session-btn").addEventListener("click",()=>{if(N){const L=N.sessions.find(H=>!H.isFinished&&!H.isCancelled&&!H.isDeleted);if(L){Q(`⚠️ جلسه ${L.sessionNumber} هنوز تمام نشده است. لطفاً ابتدا با دکمه ✅ آن را خاتمه دهید.`);return}const q=()=>{const H=X=>{const ae=N.startNewSession();Qt(ae),Ue(ae),N.students.forEach(me=>{us.setAttendance(me.identity.studentId,"present")}),le();const se=Xe(N).get(ae.sessionNumber);_e(N.info.name,`جلسه ${se} شروع شد.`,{type:"VIEW_SESSIONS"}),Rt(X?"attendance":"selector")};Se("آیا تمایل به انجام فرآیند حضور و غیاب دارید؟",()=>H(!0),{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success",onCancel:()=>H(!1)})};N.hasSessionToday()?Se("شما امروز یک جلسه برای این کلاس ثبت کرده‌اید. آیا از شروع یک جلسه جدید دیگر مطمئن هستید؟",q,{confirmText:"بله",confirmClass:"btn-warning"}):q()}}),e.addEventListener("click",()=>{const L=o.value.trim(),q=document.querySelector('input[name="class-type"]:checked');if(!L&&!q){Q("⚠️لطفاً نام و نوع کلاس را مشخص کنید.");return}if(!L){Q("⚠️لطفاً نام کلاس را وارد کنید.");return}if(!q){Q("⚠️لطفاً نوع کلاس را انتخاب کنید.");return}if(oe[L]){oe[L].isDeleted?Q("⚠️ کلاسی با این نام در سطل زباله است. ابتدا آن را بازیابی کنید و یا آن را پاک کنید."):Q("⚠️کلاسی با این نام از قبل وجود دارد.");return}const H=q.value,X=new Zn({name:L,type:H});oe[L]=X,le(),_e(L,`کلاس «${L}» ایجاد شد.`,{type:"VIEW_SESSIONS"}),He(),Q(`✅ کلاس «${L}» با موفقیت ایجاد شد.`),o.value="",q.checked=!1}),s.addEventListener("input",L=>{const q=L.target.value;if(q.length<2){vn([]);return}const H=q.toLowerCase(),X=Un(H),ae=[];for(const de in oe){const se=oe[de];if(se.isDeleted)continue;const me=Ye(de.toLowerCase()),ve=me.includes(Ye(H)),Ie=me.includes(Ye(X));(ve||Ie)&&ae.push({type:"classroom",classroom:se})}for(const de in oe){const se=oe[de];if(se.isDeleted)continue;Le(se.students).filter(ve=>{const Ie=Ye(ve.identity.name.toLowerCase()),Oe=Ie.includes(Ye(H)),Pt=Ie.includes(Ye(X));return Oe||Pt}).forEach(ve=>{ae.push({type:"student",student:ve,classroom:se})})}vn(ae)}),o.addEventListener("keyup",L=>{L.key==="Enter"&&e.click()}),l.addEventListener("click",vi),I.addEventListener("click",()=>{tn("selector")}),T.addEventListener("input",L=>{const q=L.target.value;if(!q){Zt([]);return}const H=q.toLowerCase(),X=Un(H),de=Le(N.students).filter(se=>{const me=Ye(se.identity.name.toLowerCase()),ve=me.includes(Ye(H)),Ie=me.includes(Ye(X));return ve||Ie});Zt(de)}),T.addEventListener("focus",()=>{T.value&&Zt(T.value)}),wt.addEventListener("click",()=>{const L=ct.value,q=tt.value.trim();let H;if(In)H=In.student;else{const ae=J==null?void 0:J.winnerHistory[et];H=ae==null?void 0:ae.winner}if(!H){Q("❌خطا: دانش‌آموز معتبری برای ثبت نمره یافت نشد.");return}const X=Ge;if(!H||!X){Q("⚠️لطفاً ابتدا یک دانش‌آموز و یک دسته‌بندی را انتخاب کنید.");return}if(!L){Q("⚠️لطفاً مقدار نمره را وارد کنید.");return}if(L>100||L<0){Q("❌نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}H&&(H.addScore(X.name,parseFloat(L),q),_e(N.info.name,`نمره ${L} در ${X.name} برای «${H.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:H.identity.studentId}),le(),Re(),Q(`✅نمره برای ${H.identity.name} در مهارت ${X.name} ثبت شد.`),ct.value="",tt.value="",Fe())});const W=L=>{L.key==="Enter"&&L.ctrlKey&&(L.preventDefault(),wt.click())};ct.addEventListener("keydown",W),tt.addEventListener("keydown",W),te.addEventListener("click",()=>{ke()}),$.addEventListener("click",()=>{const L=fe.value.trim(),q=bs;ke(()=>{typeof q=="function"&&q(L)})});const Z=document.getElementById("move-student-confirm-btn"),B=document.getElementById("move-student-cancel-btn"),V=document.getElementById("move-student-class-select");B.addEventListener("click",()=>{ke()}),Z.addEventListener("click",()=>{const L=V.value,q=oe[L],{studentToMove:H,sourceClassForMove:X}=Fi;if(!H||!X||!q){Q("خطایی رخ داد. لطفاً دوباره امتحان کنید⚠️.","error"),ke();return}const ae=js(H,X,q);ae.success?(_e(X.info.name,`دانش‌آموز «${H.identity.name}» به کلاس «${L}» منتقل شد.`,{type:"VIEW_SESSIONS"}),_e(L,`دانش‌آموز «${H.identity.name}» از کلاس «${X.info.name}» به این کلاس منتقل شد.`,{type:"VIEW_SESSIONS"}),le(),lt(),Re(),ut(),Q(`دانش‌آموز «${H.identity.name}» با موفقیت به کلاس «${L}» منتقل شد✅.`)):Q(ae.message,"error"),ke()}),M.addEventListener("click",()=>{U.style.width="300px",G.classList.add("modal-visible")}),M.addEventListener("click",()=>{U.style.width="300px",G.classList.add("modal-visible")});const ne=document.getElementById("header-settings-btn");ne&&ne.addEventListener("click",()=>{N&&Dt(N)}),A.addEventListener("click",he),A.addEventListener("click",he),G.addEventListener("click",he),Ke.addEventListener("click",()=>{sn(),ge("trash-page"),he()}),document.getElementById("demo-mode-btn").addEventListener("click",()=>{ot?ye():(he(),Se("شما در حال ورود به حالت نمایش (Demo) هستید. در این حالت، هیچ‌کدام از تغییرات شما ذخیره نخواهد شد. آیا ادامه می‌دهید؟",()=>{Js(),Cn(),he()},{confirmText:"تایید",confirmClass:"btn-warning",onCancel:he}))});const ce=document.getElementById("exit-demo-btn");ce&&ce.addEventListener("click",()=>{ot&&ye()}),ie.addEventListener("click",()=>{if(ot){Q("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است."),he();return}he(),nn()}),E.addEventListener("click",()=>{if(ot){Q("⚠️ بازیابی اطلاعات در حالت نمایش (Demo) غیرفعال است."),he();return}z.click(),he()}),z.addEventListener("change",L=>{const q=L.target.files[0];if(!q)return;const H=new FileReader;H.onload=async X=>{const ae=X.target.result;try{const de=JSON.parse(ae);if(de.metadata&&de.data)ss(de);else{const se=de.classrooms||de,me=de.trashBin||[];Se("آیا از بازیابی اطلاعات مطمئن هستید؟ تمام داده‌های فعلی شما بازنویسی خواهد شد.",()=>{kt(se),Dn(me),qt({lastRestoreTimestamp:new Date().toISOString()}),le(),He(),ge("class-management-page"),Q("✅اطلاعات با موفقیت بازیابی شد.")},{confirmText:"بازیابی کن",confirmClass:"btn-warning"})}}catch{try{const ve=(await new Ms().loadAsync(ae,{base64:!0})).file("backup.json");if(!ve)throw new Error("فایل backup.json در فایل پشتیبان یافت نشد.");const Ie=await ve.async("string"),Oe=JSON.parse(Ie);if(Oe.metadata&&Oe.metadata.version==="2.0-b64")ss(Oe);else throw new Error("فایل پشتیبان معتبر نیست (نسخه نامشخص).")}catch(se){Q("❌خطا در خواندن فایل. لطفاً فایل پشتیبان معتبر انتخاب کنید."),console.error("Restore error (zip/base64):",se)}}},H.readAsText(q),L.target.value=null}),window.addEventListener("popstate",L=>{if(ht){ke(null,!0);return}if(Ct(),L.state){const{pageId:q,currentClassName:H,selectedSessionNumber:X,selectedStudentId:ae}=L.state;H&&(Pe(oe[H]),X&&Ue(N.getSession(X)),ae&&Ve(N.students.find(de=>de.identity.studentId===ae))),q==="session-page"?(We(),Yt(q)):q==="student-profile-page"?(We(),ge("session-page"),Me(Ee)):Yt(q)}else Pe(null),Ue(null),Ve(null),Yt("class-management-page")}),document.addEventListener("keydown",L=>{var X;const q=document.activeElement;if(!["INPUT","TEXTAREA","SELECT"].includes(q.tagName)){if(L.key.toLowerCase()==="o"&&L.shiftKey&&oi.classList.contains("active")&&(L.preventDefault(),di.click()),L.key==="Escape"){if(_t.classList.contains("visible")){Ct();return}if(ht){ke();return}switch((X=document.querySelector(".page.active"))==null?void 0:X.id){case"csv-preview-page":case"column-mapping-page":ge("settings-page");break;case"student-profile-page":Ve(null),ge(J?"student-page":"session-page");break;case"attendance-page":ge("student-page");break;case"student-page":Ue(null),We(),ge("session-page");break;case"settings-page":case"session-page":Pe(null),ge("class-management-page");break}return}if(J){const ae=L.key.toLowerCase();switch(" ascfg".includes(ae)&&L.preventDefault(),ae){case" ":w.click();break;case"a":k.classList.contains("active")?history.back():(ut(),ge("attendance-page"));break;case"s":document.getElementById("session-page").classList.contains("active")&&history.back();break;case"c":document.querySelector(".back-to-classes-btn").click();break;case"f":const de=document.querySelector(".action-column .search-icon");de&&de.click();break;case"g":if(studentProfilePage.classList.contains("active"))history.back();else{const se=J.lastSelectedWinnerId;if(se){const me=N.students.find(ve=>ve.identity.studentId===se);me&&(Ve(me),(void 0)(),ge("student-profile-page"))}else Q("⚠️ابتدا یک نفر را انتخاب کنید تا پروفایل او نمایش داده شود.")}break;case"arrowleft":{const se=document.querySelector('button[title="برنده قبلی"]');se&&!se.disabled&&(L.preventDefault(),se.click());break}case"arrowright":{const se=document.querySelector('button[title="برنده بعدی"]');se&&!se.disabled&&(L.preventDefault(),se.click());break}}}}});function he(){U.style.width="0",G.classList.add("modal-closing"),setTimeout(()=>{G.classList.remove("modal-visible","modal-closing")},300)}function ye(){Se("آیا از خروج از حالت نمایش (Demo) مطمئن هستید؟ با خروج، تمام تغییرات آزمایشی شما حذف شده و داده‌های اصلی شما بازیابی خواهند شد.",()=>{Ys(),Pe(null),Ue(null),Ve(null),He(),ge("class-management-page"),Cn(),he()},{confirmText:"خروج",confirmClass:"btn-success"})}c(".global-search-container .animated-search-container",vn),c(".action-column-header .animated-search-container",Zt),lr(),[we,hi,tt,li].forEach(L=>{L&&ki(L)});function ft(L,q){const H=Le(q.students).filter(xe=>xe.identity.studentId!==L.identity.studentId);if(H.length===0)return;const X=H.reduce((xe,$e)=>$e.statusCounters.totalSelections>xe.statusCounters.totalSelections?$e:xe,H[0]);if(!X||X.statusCounters.totalSelections===0)return;L.categoryCounts=JSON.parse(JSON.stringify(X.categoryCounts)),L.statusCounters.totalSelections=X.statusCounters.totalSelections;const ae=H.reduce((xe,$e)=>xe+$e.statusCounters.totalSelections,0),de=H.reduce((xe,$e)=>xe+($e.statusCounters.missedChances||0),0),se=ae>0?de/ae:0;L.statusCounters.missedChances=Math.round(L.statusCounters.totalSelections*se);const me=Le(q.categories),ve={};me.forEach(xe=>{const $e=H.reduce((Hn,Wn)=>Hn+(Wn.categoryCounts[xe.name]||0),0),Pn=H.reduce((Hn,Wn)=>Hn+(Wn.categoryIssues[xe.name]||0),0);ve[xe.name]=$e>0?Pn/$e:0}),me.forEach(xe=>{const $e=L.categoryCounts[xe.name]||0,Pn=ve[xe.name]||0;L.categoryIssues[xe.name]=Math.round($e*Pn)});const Ie=q.liveSession;Ie?L.onboardingSession=Ie.sessionNumber:L.onboardingSession=q.sessions.length+1;const Oe=Le(q.sessions).filter(xe=>xe.isFinished&&!xe.isCancelled),Pt="📝 یادداشت خودکار سیستم",Di=`این دانش‌آموز  از جلسه شماره ${Oe.length} به کلاس اضافه شد. آمار مشارکت او بر اساس فعال‌ترین دانش‌آموز و آمار «فرصت از دست رفته» او بر اساس میانگین کلاس ثبت گردید:`,It=[];L.statusCounters.totalSelections>0&&It.push(`کل انتخاب‌ها: ${L.statusCounters.totalSelections}`),L.statusCounters.missedChances>0&&It.push(`فرصت‌های از دست رفته: ${L.statusCounters.missedChances}`);for(const xe in L.categoryCounts){const $e=L.categoryCounts[xe];$e>0&&It.push(`انتخاب در «${xe}»: ${$e}`)}for(const xe in L.categoryIssues){const $e=L.categoryIssues[xe];$e>0&&It.push(`مشکل در «${xe}»: ${$e}`)}if(It.length>0){const xe=`${Pt}
${Di}

- ${It.join(`
- `)}`;L.addNote(xe)}}function qe(L){const H=`چون این کلاس جلسات برگزار شده دارد، برای ${L>1?"دانش‌آموزان جدید":"دانش‌آموز جدید"} آمار پایه‌ای (متناسب با سایر دانش‌آموزان) ثبت شد تا در فرایند انتخاب اختلالی ایجاد نشود.`;Se(H,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}const gt="11.1.0";document.getElementById("app-version").textContent=`نسخه ${gt}`;function De(){console.log("Starting universal backfill for writing scores...");let L=0;for(const q in oe){const H=oe[q];if(H.isDeleted)continue;let X=0;Le(H.students).forEach(de=>{const se=de.logs.scores;if(!(se&&se.writing&&se.writing.length>0)){let ve=-1;for(const Ie in se)Ie!=="writing"&&se[Ie].forEach(Oe=>{Oe.value>ve&&(ve=Oe.value)});if(ve>-1){const Ie=`Automatically assigned based on the highest score (${ve}) from other skills.`;de.addScore("Writing",ve,Ie),X++}}}),X>0&&(console.log(`Updated ${X} student(s) in class: ${H.info.name}.`),L+=X)}L>0?(le(),console.log(`Update complete. A total of ${L} student(s) were updated across all classes. Data saved.`),document.getElementById("student-page").classList.contains("active")&&Re()):console.log("No students needed updating in any class.")}window.backfillWritingScoresForAll=De;function St(){console.log("Starting backfill for 'outOfClassCount' and 'wasOutOfClass' properties...");let L=0,q=0;const H=localStorage.getItem("teacherAssistantData_v2");if(!H){console.log("No data found in localStorage. Nothing to do.");return}const X=JSON.parse(H);for(const ae in X){const de=X[ae];de.students&&de.students.forEach(se=>{se.statusCounters&&typeof se.statusCounters.outOfClassCount>"u"&&(se.statusCounters.outOfClassCount=0,L++)}),de.sessions&&de.sessions.forEach(se=>{if(se.studentRecords)for(const me in se.studentRecords){const ve=se.studentRecords[me];typeof ve.wasOutOfClass>"u"&&(ve.wasOutOfClass=!1,q++)}})}localStorage.setItem("teacherAssistantData_v2",JSON.stringify(X)),console.log(`Backfill complete. Updated ${L} students and ${q} session records. Data saved.`),xn(),N&&Re()}window.backfillExitCounters=St;function zt(){console.log("🧹 Starting orphaned data cleanup...");let L=0;for(const q in oe){const H=oe[q];if(H.isDeleted)continue;let X=!1;const ae=new Set(H.students.filter(me=>!me.isDeleted).map(me=>me.identity.studentId)),de=new Map(H.students.map(me=>[me.identity.studentId,me.identity.name])),se=[];H.sessions.forEach(me=>{if(me.isDeleted)return;const ve=[];for(const Ie in me.studentRecords)if(!ae.has(Ie)){const Oe=de.get(Ie)||"Unknown/Deleted";ve.push(`  - Removed student record for: ${Oe} (ID: ${Ie})`),delete me.studentRecords[Ie],L++,X=!0}for(const Ie in me.lastWinnerByCategory){const Oe=me.lastWinnerByCategory[Ie];if(!ae.has(Oe)){const Pt=de.get(Oe)||"Unknown/Deleted";ve.push(`  - Removed '${Ie}' last winner: ${Pt} (ID: ${Oe})`),delete me.lastWinnerByCategory[Ie],L++,X=!0}}if(me.lastSelectedWinnerId&&!ae.has(me.lastSelectedWinnerId)){const Ie=me.lastSelectedWinnerId,Oe=de.get(Ie)||"Unknown/Deleted";ve.push(`  - Cleared 'lastSelectedWinnerId': ${Oe} (ID: ${Ie})`),me.lastSelectedWinnerId=null,L++,X=!0}if(ve.length>0){const Oe=Xe(H).get(me.sessionNumber)||`(#${me.sessionNumber})`;se.push({sessionDisplayNumber:Oe,logs:ve})}}),X&&(console.group(`➡️ Class: ${q}`),se.forEach(me=>{console.groupCollapsed(`  Session ${me.sessionDisplayNumber}`),me.logs.forEach(ve=>console.warn(ve)),console.groupEnd()}),console.groupEnd())}L>0?(le(),console.log(`✅ Cleanup complete! Found and removed ${L} orphaned references. Data saved.`)):console.log("✅ No orphaned data found. Your data is clean!")}window.cleanupOrphanedData=zt;function Qe(L){if(!L||!L.classroomName)return;const q=oe[L.classroomName];if(!q){Q("⚠️ کلاس مربوط به این گزارش یافت نشد.");return}Pe(q),ke(),setTimeout(()=>{switch(L.type){case"VIEW_STUDENT_PROFILE":{const H=q.students.find(X=>X.identity.studentId===L.studentId);H?Me(H):Q("⚠️ دانش‌آموز مورد نظر یافت نشد.");break}case"VIEW_TRASH":sn(),ge("trash-page");break;case"VIEW_SESSIONS":We(),ge("session-page");break;case"VIEW_CLASS_NOTE":zn(q);break;case"VIEW_CLASS_SETTINGS":Dt(q);break}},300)}Te.addEventListener("click",()=>{wi()}),Ne.addEventListener("click",()=>{ke()}),be.addEventListener("click",()=>{const L=Ce.value.trim(),q=Ae.checked;if(!L){xs.style.display==="flex"?Se("کادر یادداشت خالی است. آیا مطمئنید که می‌خواهید یادداشت‌های قبلی دانش‌آموزان انتخاب‌شده را پاک کنید؟",()=>{ke(),as("",!1)},{confirmText:"پاک کردن",confirmClass:"btn-warning"}):Q("⚠️ لطفاً متن یادداشت را وارد کنید.");return}ke(()=>{as(L,q)})});const it=document.getElementById("screen-saver-overlay"),rn=document.getElementById("screen-saver-toggle");let $t;const Fn=2*60*1e3,Ft=["mousemove","keypress","scroll","click","touchstart"];function yt(){it.classList.add("visible")}function bt(){it.classList.contains("visible")&&it.classList.remove("visible")}function on(){bt(),clearTimeout($t),$t=setTimeout(yt,Fn)}function cn(L){L.preventDefault(),L.stopPropagation(),setTimeout(on,0)}function Ds(){on(),Ft.forEach(q=>window.addEventListener(q,on)),it.addEventListener("click",cn),it.addEventListener("touchstart",cn);const L="11.1.0";{const q=document.getElementById("screen-saver-version");q&&(q.textContent=`v${L}`)}}function Ni(){clearTimeout($t),bt(),Ft.forEach(L=>window.removeEventListener(L,on)),it.removeEventListener("click",cn),it.removeEventListener("touchstart",cn)}rn.checked=je.isScreenSaverEnabled,je.isScreenSaverEnabled&&Ds(),rn.addEventListener("change",L=>{L.target.checked?(qt({isScreenSaverEnabled:!0}),Ds()):(he(),L.preventDefault(),Se(`نکته:
محافظ صفحه در تلفن های همراه جدید کمک می کند که دستگاه باطری کمتری مصرف کند و به دلیل ثابت ماندن صفحه نمایش در گوشی های قدیمی تر، صفحه نمایش دچار ماندگی رد پیکسل نگردد. آیا مطمئن هستید که می خواهید این ویژگی را غیر فعال کنید؟`,()=>{L.target.checked=!1,qt({isScreenSaverEnabled:!1}),Ni(),Q("توصیه می شود زمان خاموش شدن صفحه نمایش گوشی خود را به حداقل دو دقیقه تغییر دهید تا در استفاده های طولانی مدت صفحه نمایش گوشی اصطحلاک کمتری را تجربه کند",7e3)},{confirmText:"بله، غیرفعال کن",cancelText:"لغو",onCancel:()=>{L.target.checked=!0}}))})});function cr(s,o){if(!J||J.isFinished){Q("⚠️ امکان لغو انتخاب در جلسه خاتمه یافته وجود ندارد.");return}const e=J.winnerHistory;if(!(et===e.length-1)||e.length===0){Q("⚠️ فقط آخرین انتخاب قابل لغو است.");return}if(e[e.length-1].winner.identity.studentId!==s.identity.studentId){console.error("Undo mismatch!");return}Se(`آیا از حذف انتخاب «${s.identity.name}» برای «${o}» مطمئن هستید؟ آمار این انتخاب بازگردانی خواهد شد.`,()=>{const r=J.winnerHistory,t=r.pop();if(!t)return;const n=t.winner,a=t.categoryName,i=n.identity.studentId;n.statusCounters.totalSelections=Math.max(0,n.statusCounters.totalSelections-1),n.categoryCounts[a]&&(n.categoryCounts[a]=Math.max(0,n.categoryCounts[a]-1));const u=J.studentRecords[i];u&&u.selections[a]&&(u.selections[a]=Math.max(0,u.selections[a]-1));let p=null;for(let v=r.length-1;v>=0;v--)if(r[v].categoryName===a){p=r[v].winner.identity.studentId;break}p?J.lastWinnerByCategory[a]=p:delete J.lastWinnerByCategory[a],pt(r.length-1),Re(),Fe(),le(),Q(`✅ انتخاب «${n.identity.name}» لغو شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}function lr(){const s=document.getElementById("session-dashboard-page"),o=document.getElementById("student-stats-table-container");if(!s)return;let e=0,l=0;s.addEventListener("touchstart",t=>{if(o&&o.contains(t.target)){const n=t.target.closest("td, th");n&&n.parentElement.firstElementChild===n?e=t.changedTouches[0].screenX:e=0}else e=t.changedTouches[0].screenX},{passive:!0}),s.addEventListener("touchend",t=>{e!==0&&(l=t.changedTouches[0].screenX,r())});function r(){const n=e-l;Math.abs(n)>150&&(document.getElementById("selector-tab-btn").classList.contains("active")?(ge("session-dashboard-page",{tab:"attendance"}),tn("attendance")):(ge("session-dashboard-page",{tab:"selector"}),tn("selector"))),e=0,l=0}}
