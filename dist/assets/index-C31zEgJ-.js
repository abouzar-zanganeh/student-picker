(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function n(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(a){if(a.ep)return;a.ep=!0;const o=n(a);fetch(a.href,o)}})();class nt{constructor(t){this.identity={name:t.name,studentId:t.studentId||`id_${new Date().getTime()}_${Math.random()}`,branchName:t.branchName||null,ageGroup:t.ageGroup||"adult",level:t.level||null,contact:{social:t.socialContact||null,parent:t.parentContact||null}},this.isDeleted=!1,this.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0,outOfClassCount:0},this.categoryCounts={},this.categoryIssues={},this.logs={parentContacts:[],scores:{},discipline:{},sessionHistory:{}},this.profile={notes:[],tags:[]},this.finalClassActivityScore=null}addScore(t,n,s){if(n>100||n<0){console.log("نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}const a=t.toLowerCase();this.logs.scores[a]||(this.logs.scores[a]=[]);const o=new xs(t,n,s);this.logs.scores[a].push(o)}addNote(t,n=null){const s=new Ds(t,n);this.profile.notes.push(s)}getOverallAverageScore(){let t=0,n=0;for(const a in this.logs.scores)this.logs.scores[a].forEach(o=>{o.isDeleted||(t+=o.value,n++)});if(n===0)return null;const s=t/n;return Math.round(s*100)/100}}class xs{constructor(t,n,s=""){this.id=`score_${new Date().getTime()}`,this.skill=t,this.value=n,this.timestamp=new Date,this.comment=s,this.isDeleted=!1}}class Ds{constructor(t,n=null){this.id=`note_${new Date().getTime()}`,this.timestamp=new Date,this.content=t,this.isDeleted=!1,this.source=n}}class Pt{constructor(t="complete",n=""){this.status=t,this.comment=n,this.timestamp=new Date}}class Tn{constructor(t){this.sessionNumber=t,this.startTime=new Date,this.note="",this.isDeleted=!1,this.endTime=null,this.isFinished=!1,this.isMakeup=!1,this.isCancelled=!1,this.studentRecords={},this.lastWinnerByCategory={},this.lastUsedCategoryId=null,this.lastSelectedWinnerId=null,this.winnerHistory=[]}end(){this.isFinished=!0,this.endTime=new Date}markAsMakeup(){this.isMakeup=!this.isMakeup}initializeStudentRecord(t){this.studentRecords[t]||(this.studentRecords[t]={attendance:"present",homework:new Pt,selections:{},hadIssue:!1,wasOutOfClass:!1})}setAttendance(t,n){this.initializeStudentRecord(t),this.studentRecords[t].attendance=n}setHomeworkStatus(t,n){this.initializeStudentRecord(t),this.studentRecords[t].homework.status=n}selectNextWinner(t,n,s){if(!n||n.length===0)return console.log("هیچ دانش‌آموزی در کلاس برای انتخاب وجود ندارد."),null;const a=this.lastWinnerByCategory[t];let o=n.filter(d=>d.identity.studentId!==a);if(o.length===0&&(o=n),o.length===0)return null;const i=(d,p)=>d.categoryCounts[p]||0,l=Math.min(...o.map(d=>i(d,t))),r=o.filter(d=>i(d,t)===l);let f;if(r.length===1)f=r[0];else if(r.length>1){const d=s.filter(I=>!I.isDeleted&&I.name!==t).map(I=>I.name),p=r.map(I=>{const M=d.reduce((R,B)=>R+i(I,B),0);return{student:I,otherCategoriesTotal:M}}),S=Math.min(...p.map(I=>I.otherCategoriesTotal)),v=p.filter(I=>I.otherCategoriesTotal===S).map(I=>I.student);v.length===1?f=v[0]:f=v[Math.floor(Math.random()*v.length)]}else f=o[Math.floor(Math.random()*o.length)];const C=f.identity.studentId;this.initializeStudentRecord(C);const h=(this.studentRecords[C].selections[t]||0)+1;return this.studentRecords[C].selections[t]=h,f.statusCounters.totalSelections++,f.categoryCounts[t]=(f.categoryCounts[t]||0)+1,this.lastWinnerByCategory[t]=C,f}}class _t{constructor(t){this.info={name:t.name||"NotNamed",scheduleCode:t.scheduleCode||`code_${new Date().getTime()}`,teacherName:t.teacherName||null,type:t.type||"in-person",term:t.term||null,scheduleText:t.scheduleText||null,level:t.level||null,creationDate:t.creationDate?new Date(t.creationDate):new Date},this.students=[],this.sessions=[],this.note="",this.isDeleted=!1,this.categories=[new be("Vocabulary","Questions about words and meanings."),new be("Grammar","Questions about sentence structure and rules."),new be("Listening",void 0,!0),new be("Speaking",void 0,!0),new be("Reading",void 0,!0),new be("Writing",void 0,!0)],this.futurePlans={}}addStudent(t){this.students.push(t)}removeStudent(t){this.students=this.students.filter(n=>n.identity.studentId!==t)}startNewSession(){const t=this.sessions.length+1,n=new Tn(t);return this.sessions.push(n),n}endSpecificSession(t){const n=this.getSession(t);return n&&!n.isFinished?(n.end(),!0):!1}getSession(t){return this.sessions.find(n=>n.sessionNumber===t)}markAsMakeup(t){const n=this.getSession(t);n&&n.markAsMakeup()}planForSession(t,n){this.futurePlans[t]=n}hasSessionToday(){const t=new Date().toDateString();return this.sessions.some(n=>!n.isDeleted&&n.startTime.toDateString()===t)}selectNextWinner(t,n){return n?n.selectNextWinner(t,this.students,this.categories):null}get liveSession(){for(let t=this.sessions.length-1;t>=0;t--)if(!this.sessions[t].isFinished)return this.sessions[t];return null}endLiveSession(){const t=this.liveSession;return t?(t.end(),!0):!1}calculateFinalStudentScore(t){const n=t.logs.scores,s=["reading","writing"];for(const d of s)if(!n[d]||n[d].length===0)return null;const a=n.listening&&n.listening.length>0,o=n.speaking&&n.speaking.length>0;if(!a&&!o)return null;const i=d=>n[d].reduce((S,v)=>S+v.value,0)/n[d].length;let l;a&&o?l=(i("listening")+i("speaking"))/2:a?l=i("listening"):l=i("speaking");const r=i("reading"),f=i("writing"),h=(l*3+r*2+f*1)/6;return Math.trunc(h*10)/10}assignAllFinalScores(){let t=0,n=[];console.log("شروع عملیات محاسبه نمره نهایی برای تمام دانش‌آموزان..."),this.students.forEach(a=>{const o=this.calculateFinalStudentScore(a);o!==null?(a.finalClassActivityScore=o,t++):(a.finalClassActivityScore=null,n.push(a.identity.name))});const s=n.length;console.log(`عملیات پایان یافت. تعداد نمرات موفق: ${t} | تعداد ناموفق (نمرات ناقص): ${s}`),s>0&&(console.log("اسامی دانش‌آموزانی که نمراتشان ناقص است:"),n.forEach(a=>console.log(`- ${a}`)))}}class be{constructor(t,n="",s=!1){this.id=`cat_${new Date().getTime()}_${Math.random()}`,this.name=t,this.description=n,this.isDeleted=!1,this.isGradedCategory=s,this.isDeleted=!1}}let T={},u=null,Yt=null,E=null,O=null,ze=null,Dt=null,Zt=[],Et=null,en=null,re=null,vt=0,tn=0,bt=0,nn=0,sn=null,an=null,Lt=null,Le=null,ue=-1,St=null,It=null,Bn=null,xn=null,fe=!1;function k(){fe||localStorage.setItem("teacherAssistantData_v2",JSON.stringify(T))}function Dn(){const e=JSON.stringify(T,null,2),n=`SP-${new Date().toLocaleDateString("fa-IR-u-nu-latn").replace(/\//g,"-")}.txt`;return new File([e],n,{type:"text/plain"})}function kt(){const e=localStorage.getItem("teacherAssistantData_v2");if(e){const t=JSON.parse(e);Mt(t)}}function Mt(e){T={};for(const t in e){const n=e[t],s=new _t(n.info);s.isDeleted=n.isDeleted,s.note=n.note||"",s.students=n.students.map(a=>{const o=new nt(a.identity);return o.isDeleted=a.isDeleted,o.statusCounters=a.statusCounters,o.logs=a.logs,o.logs.scores||(o.logs.scores={}),o.profile=a.profile,o.finalClassActivityScore=a.finalClassActivityScore,o.categoryCounts=a.categoryCounts||{},o.categoryIssues=a.categoryIssues||{},o}),s.sessions=n.sessions.map(a=>{const o=new Tn(a.sessionNumber);o.isDeleted=a.isDeleted,o.note=a.note||"",o.startTime=new Date(a.startTime),o.endTime=a.endTime?new Date(a.endTime):null,o.isFinished=a.isFinished,o.isMakeup=a.isMakeup,o.isCancelled=a.isCancelled||!1,o.studentRecords=a.studentRecords;for(const l in o.studentRecords){const r=o.studentRecords[l];r.homework&&!(r.homework instanceof Pt)&&(o.studentRecords[l].homework=new Pt(r.homework.status,r.homework.comment))}o.lastWinnerByCategory=a.lastWinnerByCategory,o.lastUsedCategoryId=a.lastUsedCategoryId,o.lastSelectedWinnerId=a.lastSelectedWinnerId;const i=a.winnerHistory||[];return o.winnerHistory=i.map(l=>({winner:s.students.find(f=>f.identity.studentId===l.winner.identity.studentId),categoryName:l.categoryName})),o}),s.categories=n.categories.map(a=>{const o=new be(a.name,a.description,a.isGradedCategory);return o.id=a.id,o.isDeleted=a.isDeleted,o}),s.futurePlans=n.futurePlans,T[t]=s}}function Mn(e,t){if(T[t])return{success:!1,message:"کلاسی با این نام از قبل وجود دارد."};const n=T[e];return n?(n.info.name=t,T[t]=n,delete T[e],u===n&&J(n),{success:!0}):{success:!1,message:"کلاس مورد نظر یافت نشد."}}function $n(e,t,n){if(U(n.students).some(i=>i.identity.name.toLowerCase()===e.identity.name.toLowerCase()))return{success:!1,message:`دانش‌آموزی با نام «${e.identity.name}» از قبل در کلاس «${n.info.name}» وجود دارد.`};const a=JSON.parse(JSON.stringify(e));n.addStudent(a);const o=t.students.find(i=>i.identity.studentId===e.identity.studentId);return o&&(o.isDeleted=!0),{success:!0}}function J(e){u=e}function Ke(e){Yt=e}function Q(e){E=e}function q(e){O=e}function wt(e){ze=e}function Hn(e){Dt=e}function Ve(e){Zt=e}function st(e){Et=e}function On(e){en=e}function on(e){re=e}function at(e){vt=e}function An(e){tn=e}function ot(e){bt=e}function Rn(e){nn=e}function cn(e){sn=e}function ln(e){an=e}function Qe(e){Lt=e}function rn(e){Le=e}function Nt(e){It=e}function Pn(e){Bn=e}function _n(e){xn=e}function Wn(){for(const e in T){const t=T[e];t.students.forEach(n=>{n.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0},n.categoryCounts={},n.categoryIssues={},t.sessions.forEach(s=>{const a=n.identity.studentId;s.studentRecords[a]&&(s.studentRecords[a].attendance="present")})})}k()}function U(e){return Array.isArray(e)?e.filter(t=>!t.isDeleted):[]}function Ee(e){const t=new Map;return e&&U(e.sessions).filter(s=>!s.isCancelled).sort((s,a)=>s.sessionNumber-a.sessionNumber).forEach((s,a)=>{t.set(s.sessionNumber,a+1)}),t}function Te(e){ue=e}function pe(e){St=e}function Tt(e,t){if(!e||!t)return;const n=e.identity.studentId,s=t.students.findIndex(a=>a.identity.studentId===n);s>-1&&t.students.splice(s,1),t.sessions.forEach(a=>{a.studentRecords[n]&&delete a.studentRecords[n]})}function Fn(){JSON.parse(JSON.stringify(T)),fe=!0}function Un(){fe=!1,kt()}const Ms=Object.freeze(Object.defineProperty({__proto__:null,get activeModal(){return Le},get cancelCallback(){return an},get classrooms(){return T},get confirmCallback(){return sn},get currentClassroom(){return u},get easterEggClickCount(){return vt},get easterEggLastClickTime(){return tn},enterDemoMode:Fn,exitDemoMode:Un,getActiveItems:U,getSessionDisplayMap:Ee,get importedFileContent(){return Et},get isDemoMode(){return fe},get liveSession(){return Yt},loadData:kt,get manualSelection(){return It},moveStudent:$n,get namesToImport(){return Zt},get notificationTimeout(){return en},permanentlyDeleteStudent:Tt,prepareBackupData:Dn,get previousState(){return ze},rehydrateData:Mt,renameClassroom:Mn,resetAllStudentCounters:Wn,get resetEasterEggClickCount(){return bt},get resetEasterEggLastClickTime(){return nn},saveData:k,get saveNoteCallback(){return St},get secureConfirmCallback(){return Lt},get selectedCategory(){return re},get selectedSession(){return E},get selectedStudentForProfile(){return O},setActiveModal:rn,setCancelCallback:ln,setConfirmCallback:cn,setCurrentClassroom:J,setEasterEggClickCount:at,setEasterEggLastClickTime:An,setImportedFileContent:st,setLiveSession:Ke,setManualSelection:Nt,setNamesToImport:Ve,setNotificationTimeout:On,setPreviousState:wt,setResetEasterEggClickCount:ot,setResetEasterEggLastClickTime:Rn,setSaveNoteCallback:pe,setSecureConfirmCallback:Qe,setSelectedCategory:on,setSelectedSession:Q,setSelectedStudentForProfile:q,setSourceClassForMove:_n,setStudentToMove:Pn,setUndoTimeout:Hn,setWinnerHistoryIndex:Te,get sourceClassForMove(){return xn},get studentToMove(){return Bn},get undoTimeout(){return Dt},get winnerHistoryIndex(){return ue}},Symbol.toStringTag,{value:"Module"}));function $e(e){return typeof e!="string"?"":e.replace(/ي/g,"ی").replace(/ك/g,"ک")}function Xe(e){return typeof e!="string"||e.length===0?"ltr":/[\u0590-\u07FF]/.test(e)?"rtl":"ltr"}function Vn(e){return!e||!e.trim()?"":e.split(`
`).map(s=>`<div dir="${Xe(s)}">${s||"&nbsp;"}</div>`).join("")}function wn(e){if(typeof e!="string")return"";const t={q:"ض",w:"ص",e:"ث",r:"ق",t:"ف",y:"غ",u:"ع",i:"ه",o:"خ",p:"ح","[":"ج","]":"چ",a:"ش",s:"س",d:"ی",f:"ب",g:"ل",h:"ا",j:"ت",k:"ن",l:"م",";":"ک","'":"گ",z:"ظ",x:"ط",c:"ز",v:"ر",b:"ذ",n:"د",m:"پ",",":"و"};let n="";for(let s=0;s<e.length;s++){const a=e[s].toLowerCase();n+=t[a]||e[s]}return n}const qn="teacherAssistantLogs_v2",$s=100;function dn(){try{const e=localStorage.getItem(qn);return e?JSON.parse(e):{}}catch(e){return console.error("Error reading logs from localStorage:",e),{}}}function Gn(e){try{localStorage.setItem(qn,JSON.stringify(e))}catch(t){console.error("Error saving logs to localStorage:",t)}}function $(e,t,n=null){if(!e)return;const s=dn();s[e]||(s[e]=[]);const a={timestamp:new Date().toISOString(),message:t,action:n,classroomName:e};s[e].unshift(a),s[e].length>$s&&s[e].pop(),Gn(s)}function Hs(e){return dn()[e]||[]}function Os(e,t){const n=dn();n[e]&&!n[t]&&(n[t]=n[e],delete n[e],Gn(n))}const jn=document.getElementById("class-management-page"),As=document.getElementById("new-class-name"),Rs=document.getElementById("add-class-btn"),Wt=document.getElementById("class-list"),Bt=document.getElementById("undo-toast"),Jn=document.getElementById("undo-message"),Ps=document.getElementById("undo-btn"),_s=document.getElementById("settings-page"),un=document.getElementById("settings-class-name-header"),Ft=document.getElementById("settings-student-list"),Ut=document.getElementById("category-list"),Ws=document.getElementById("back-to-sessions-btn"),Fs=document.getElementById("new-student-name"),Us=document.getElementById("add-student-btn"),zn=document.getElementById("paste-area"),Vs=document.getElementById("process-paste-btn"),qs=document.getElementById("csv-preview-page"),Vt=document.getElementById("csv-preview-list"),Gs=document.getElementById("csv-confirm-btn"),js=document.getElementById("csv-cancel-btn"),Js=document.getElementById("import-csv-btn"),zs=document.getElementById("csv-file-input"),Ks=document.getElementById("column-mapping-page"),qt=document.getElementById("column-select-dropdown"),Qs=document.getElementById("confirm-column-btn"),Xs=document.getElementById("cancel-import-btn"),Ys=document.getElementById("new-category-name"),Zs=document.getElementById("add-category-btn"),Gt=document.querySelector(".app-header"),Se=document.getElementById("select-student-btn"),Ye=document.getElementById("select-student-btn-wrapper"),ea=document.getElementById("attendance-page"),it=document.getElementById("attendance-list"),ta=document.getElementById("finish-attendance-btn"),na=document.getElementById("back-to-sessions-from-attendance-btn"),sa=document.getElementById("back-to-attendance-btn"),aa=document.querySelector("#class-management-page h2"),jt=document.getElementById("student-stats-header"),oa=document.getElementById("hamburger-menu-btn"),ia=document.getElementById("side-nav-menu"),ca=document.getElementById("close-nav-btn"),la=document.getElementById("overlay"),ra=document.getElementById("backup-data-btn"),da=document.getElementById("restore-data-btn"),Kn=document.getElementById("restore-file-input"),ua=document.getElementById("custom-confirm-modal"),Qn=document.getElementById("confirm-modal-message"),Jt=document.getElementById("confirm-modal-cancel-btn"),qe=document.getElementById("confirm-modal-confirm-btn"),ma=document.getElementById("secure-confirm-modal"),Xn=document.getElementById("secure-confirm-message"),Yn=document.getElementById("secure-confirm-code"),He=document.getElementById("secure-confirm-input"),fa=document.getElementById("secure-confirm-cancel-btn"),ct=document.getElementById("secure-confirm-confirm-btn"),pa=document.getElementById("add-note-modal"),A=document.getElementById("new-note-content"),ga=document.getElementById("class-save-note-btn"),ha=document.getElementById("cancel-note-btn"),zt=document.getElementById("student-search-input"),ve=document.getElementById("student-search-results"),Ca=document.getElementById("student-profile-page"),Zn=document.getElementById("profile-student-name-header"),ya=document.getElementById("back-to-student-page-btn"),Oe=document.getElementById("graded-category-pills-container"),Kt=document.getElementById("new-score-value"),mn=document.getElementById("new-score-comment"),Ea=document.getElementById("add-score-btn"),Ge=document.getElementById("profile-stats-summary"),lt=document.getElementById("profile-scores-list"),rt=document.getElementById("global-student-search-input"),he=document.getElementById("global-student-search-results"),va=document.getElementById("is-graded-checkbox"),dt=document.getElementById("trashed-classes-list"),ut=document.getElementById("trashed-students-list"),mt=document.getElementById("trashed-sessions-list"),ft=document.getElementById("trashed-categories-list"),pt=document.getElementById("trashed-notes-list"),gt=document.getElementById("trashed-scores-list"),xt=document.getElementById("quick-grade-form-wrapper"),Ce=document.getElementById("quick-score-input"),me=document.getElementById("quick-note-textarea"),Pe=document.getElementById("quick-grade-submit-btn"),fn=document.getElementById("category-selection-container"),es=document.getElementById("selected-student-result"),Be=document.getElementById("custom-context-menu"),Ae=document.getElementById("breadcrumb-container");function et(e){clearTimeout(Dt),ze||wt(JSON.stringify(T)),Jn.textContent=e,Bt.classList.add("show"),Hn(setTimeout(()=>{Bt.classList.remove("show"),wt(null)},5e3))}function ts(){if(ze){const e=u?u.info.name:null,t=JSON.parse(ze);Mt(t),e&&T[e]?J(T[e]):J(null),u?(ye(),_e(),j()):ae(),Bt.classList.remove("show"),clearTimeout(Dt),wt(null)}}function b(e,t=3e3){const n=document.getElementById("notification-toast");n&&(n.textContent=e,n.classList.add("show"),clearTimeout(en),On(setTimeout(()=>{n.classList.remove("show")},t)))}function F(e,t,n={}){const{confirmText:s="تایید",cancelText:a="لغو",confirmClass:o="btn-success",onCancel:i=()=>{},isDelete:l=!1}=n,r=l?()=>ns(e,t):t;Qn.textContent=e,qe.textContent=s,Jt.textContent=a,qe.className="modal-action-btn",qe.classList.add(o),cn(r),ln(i);const f=qe.parentElement;Jt.style.display=i===null?"none":"inline-block",f.style.justifyContent=i===null?"center":"space-between",te("custom-confirm-modal")}function ns(e,t){const n=Math.floor(1e4+Math.random()*9e4).toString();Xn.textContent=e,Yn.textContent=n,He.value="",ct.disabled=!0,Qe(t),te("secure-confirm-modal"),He.focus();const s=()=>{He.value===n?ct.disabled=!1:ct.disabled=!0};return He.addEventListener("input",s),()=>{He.removeEventListener("input",s)}}function ss(e,t){const n=Object.values(T).filter(i=>!i.isDeleted&&i.info.name!==t.info.name),s=document.getElementById("move-student-modal-title"),a=document.getElementById("move-student-class-select"),o=document.getElementById("move-student-confirm-btn");s.textContent=`انتقال دانش‌آموز: ${e.identity.name}`,a.innerHTML="",n.length===0?(a.innerHTML='<option value="">کلاس دیگری برای انتقال وجود ندارد</option>',o.disabled=!0):(n.forEach(i=>{const l=document.createElement("option");l.value=i.info.name,l.textContent=i.info.name,a.appendChild(l)}),o.disabled=!1),Pn(e),_n(t),te("move-student-modal")}function pn(e,t){if(!e||!t)return;const n=e.identity.name,s=document.getElementById("add-note-modal-title");s.textContent="تغییر نام دانش‌آموز",A.value=n,A.rows=1,A.dispatchEvent(new Event("input",{bubbles:!0})),pe(a=>{const o=a.trim();o&&o!==n&&(U(t.students).some(l=>l.identity.studentId!==e.identity.studentId&&l.identity.name.toLowerCase()===o.toLowerCase())?b("دانش‌آموزی با این نام از قبل در این کلاس وجود دارد."):(e.identity.name=o,$(t.info.name,`نام دانش‌آموز «${n}» به «${o}» تغییر یافت.`,{type:"VIEW_STUDENT_PROFILE",studentId:e.identity.studentId}),k(),ye(),de(),O&&O.identity.studentId===e.identity.studentId&&X(),b(`✅نام دانش‌آموز به «${o}» تغییر یافت.`))),s.textContent="ثبت یادداشت جدید",A.rows=4}),te("add-note-modal"),A.focus(),A.select()}function te(e){const t=document.getElementById(e);if(t){if(Le)return;t.classList.add("modal-visible"),rn(e),history.pushState(null,"",location.href)}}function ee(e){if(!Le)return;const t=document.getElementById(Le),n=Le;rn(null),history.back(),t&&(t.classList.add("modal-closing"),setTimeout(()=>{t.classList.remove("modal-visible"),t.classList.remove("modal-closing"),n==="custom-confirm-modal"&&(cn(null),ln(null)),n==="secure-confirm-modal"&&Qe(null),n==="add-note-modal"&&pe(null),typeof e=="function"&&e()},300))}function gn(e){A.value=e.note||"",pe(t=>{e.note=t,k(),$(e.info.name,"یادداشت کلاس ذخیره شد.",{type:"VIEW_CLASS_NOTE"}),ae()}),te("add-note-modal"),A.focus()}function hn(e){J(e),un.textContent=`تنظیمات کلاس: ${e.info.name}`,ye(),_e(),w("settings-page")}function as(e){const t=document.getElementById("log-modal-title"),n=document.getElementById("log-list");t.textContent=`گزارش فعالیت‌های کلاس: ${e}`,n.innerHTML="";const s=Hs(e);s.length===0?n.innerHTML='<li class="no-content-message">هنوز فعالیتی برای این کلاس ثبت نشده است.</li>':s.forEach(a=>{const o=document.createElement("li");o.className="log-entry";const i=new Date(a.timestamp),l=`${i.toLocaleDateString("fa-IR")} - ${i.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}`,r=document.createElement("span");r.className="log-timestamp",r.textContent=l;const f=document.createElement("span");f.className="log-message",f.textContent=a.message,a.action&&(f.classList.add("log-action-link"),f.dataset.action=JSON.stringify({...a.action,classroomName:a.classroomName})),o.appendChild(r),o.appendChild(f),n.appendChild(o)}),te("log-modal")}document.getElementById("log-modal-close-btn").addEventListener("click",()=>{ee()});function Qt(e){const t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download=e.name,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t)}async function Cn(){const e=Dn();if(("ontouchstart"in window||navigator.maxTouchPoints>0)&&navigator.share&&navigator.canShare&&navigator.canShare({files:[e]}))try{await navigator.share({title:"پشتیبان دستیار معلم",text:"فایل پشتیبان داده‌های برنامه",files:[e]})}catch(n){n.name!=="AbortError"&&(console.error("Error sharing file:",n),Qt(e),b("⚠️اشتراک‌گذاری با خطا مواجه شد. فایل در حال دانلود است."))}else Qt(e),b("✅پشتیبان‌گیری با موفقیت انجام شد.")}function $t(e,t){e.preventDefault(),we(),setTimeout(()=>{const n=Be,s=n.querySelector("ul");s.innerHTML="",t.forEach(C=>{const h=document.createElement("li");C.isSeparator?h.className="separator":(h.innerHTML=`
                    <span class="icon">${C.icon||""}</span>
                    <span class="label">${C.label}</span>
                `,C.className&&h.classList.add(C.className),h.addEventListener("click",()=>{C.action(),we()})),s.appendChild(h)});const{clientX:a,clientY:o}=e,{innerWidth:i,innerHeight:l}=window;n.style.top=`${o}px`,n.style.left=`${a}px`,n.classList.add("visible");const{offsetWidth:r,offsetHeight:f}=n;a+r>i&&(n.style.left=`${i-r-5}px`),o+f>l&&(n.style.top=`${l-f-5}px`)},50)}function we(){Be.classList.contains("visible")&&Be.classList.remove("visible")}function os(){var t,n;Ae.innerHTML="";const e=[];if(e.push({label:"کلاس‌ها",handler:()=>{J(null),Q(null),q(null),w("class-management-page")}}),u){if(e.push({label:u.info.name,handler:()=>{Q(null),q(null),j(),w("session-page")}}),((t=document.querySelector(".page.active"))==null?void 0:t.id)==="settings-page")e.push({label:"تنظیمات"});else if(E){const o=Ee(u).get(E.sessionNumber)||` (#${E.sessionNumber})`;e.push({label:`جلسه ${o}`,handler:()=>{q(null),w("student-page")}});const i=(n=document.querySelector(".page.active"))==null?void 0:n.id;O?e.push({label:`پروفایل: ${O.identity.name}`}):i==="attendance-page"&&e.push({label:"حضور و غیاب"})}}if(e.length<=1){Ae.style.display="none";return}Ae.style.display="flex",e.forEach((s,a)=>{const o=document.createElement("a");if(o.textContent=s.label,o.className="breadcrumb-item",a===e.length-1||!s.handler?o.classList.add("active"):o.addEventListener("click",s.handler),Ae.appendChild(o),a<e.length-1){const i=document.createElement("span");i.className="breadcrumb-separator",i.textContent="/",Ae.appendChild(i)}})}function Nn(e,t,n){n.innerHTML="";const s=u.sessions.filter(a=>{var o;return!a.isDeleted&&!a.isCancelled&&((o=a.studentRecords[e.identity.studentId])==null?void 0:o.attendance)==="absent"}).map(a=>({number:t.get(a.sessionNumber),isMakeup:a.isMakeup})).filter(a=>a.number!==void 0);s.length>0?(n.appendChild(document.createTextNode("جلسات غایب: ")),s.forEach((a,o)=>{const i=document.createElement("span");i.textContent=a.number,a.isMakeup&&i.classList.add("makeup-absence"),n.appendChild(i),o<s.length-1&&n.appendChild(document.createTextNode("، "))})):n.textContent="جلسات غایب: بدون غیبت"}function ht(e,t,n,s={}){const{includePrefix:a=!0}=s;n.innerHTML="";const o=u.sessions.filter(i=>{if(i.isDeleted||i.isCancelled)return!1;const l=i.studentRecords[e.identity.studentId];return l&&l.homework&&(l.homework.status==="incomplete"||l.homework.status==="none")}).map(i=>({number:t.get(i.sessionNumber),status:i.studentRecords[e.identity.studentId].homework.status})).filter(i=>i.number!==void 0);o.length>0?(a&&n.appendChild(document.createTextNode("تکالیف ناقص: ")),o.forEach((i,l)=>{const r=document.createElement("span");r.textContent=i.number,i.status==="incomplete"&&r.classList.add("incomplete-homework"),n.appendChild(r),l<o.length-1&&n.appendChild(document.createTextNode("،"))})):a?n.textContent="تکالیف ناقص: ندارد":n.textContent="ندارد"}function ba(e,t){var I,M,R;const n=document.createElement("li");n.className="attendance-list-item";const s={none:"بدون تکلیف",complete:"تکلیف کامل",incomplete:"تکلیف ناقص"},a=document.createElement("div");a.className="student-info";const o=document.createElement("span");o.className="student-name",o.textContent=e.identity.name,o.addEventListener("click",()=>{q(e),X(),w("student-profile-page")});const i=document.createElement("span");i.className="absence-info";const l=document.createElement("span");l.className="homework-info",Nn(e,t,i),ht(e,t,l),a.appendChild(o),a.appendChild(i),a.appendChild(l);const r=document.createElement("div");r.className="homework-controls";const f=document.createElement("button"),C=((I=E.studentRecords[e.identity.studentId])==null?void 0:I.homework.status)||"none";f.className=`homework-status-btn ${C}`,f.title=s[C],f.addEventListener("click",()=>{const B=E.studentRecords[e.identity.studentId].homework,P={none:"incomplete",incomplete:"complete",complete:"none"}[B.status];f.title=s[P],E.setHomeworkStatus(e.identity.studentId,P),k(),f.className=`homework-status-btn ${P}`,ht(e,t,l)});const h=document.createElement("button");h.className="btn-icon",h.innerHTML="📝",h.title="افزودن یادداشت برای تکلیف",((M=E.studentRecords[e.identity.studentId])==null?void 0:M.homework.comment)||(h.style.opacity="0.3"),h.addEventListener("click",()=>{const B=E.studentRecords[e.identity.studentId].homework;A.value=B.comment||"",A.dispatchEvent(new Event("input",{bubbles:!0})),pe(H=>{B.comment=H;const P=Ee(u),oe=P.get(E.sessionNumber),Y={type:"fromAttendance",sessionNumber:E.sessionNumber},ge=`یادداشت حضور-غیاب ${oe}: `,G=e.profile.notes.find(ie=>!ie.isDeleted&&ie.source&&ie.source.type==="fromAttendance"&&ie.source.sessionNumber===Y.sessionNumber);G?H?G.content=ge+H:G.isDeleted=!0:H&&e.addNote(ge+H,Y),k(),$(u.info.name,`یادداشت تکلیف جلسه ${oe} برای دانش‌آموز «${e.identity.name}» ذخیره شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:e.identity.studentId}),b("✅یادداشت تکلیف ذخیره شد."),h.style.opacity=H?"1":"0.3",ht(e,P,l)}),te("add-note-modal"),A.focus()}),r.appendChild(f),r.appendChild(h);const p=document.createElement("button"),S=((R=E.studentRecords[e.identity.studentId])==null?void 0:R.attendance)||"present",v=B=>{B==="present"?(p.textContent="حاضر",p.className="attendance-status-btn present active"):(p.textContent="غایب",p.className="attendance-status-btn absent active")};return v(S),p.addEventListener("click",()=>{var P;const H=(((P=E.studentRecords[e.identity.studentId])==null?void 0:P.attendance)||"present")==="present"?"absent":"present";E.setAttendance(e.identity.studentId,H),H==="absent"&&(E.studentRecords[e.identity.studentId].hadIssue=!1),k(),v(H),Nn(e,t,i),rs()}),n.appendChild(a),n.appendChild(r),n.appendChild(p),n}function La(){return Ee(u).get(E.sessionNumber)}function Re(){if(!u||!E)return;const e=Ee(u);Ma(),it.innerHTML="";const t=document.createElement("li");t.className="attendance-list-header",t.innerHTML=`
    <span class="header-label-spacer"></span>
    <span class="header-label">تکلیف</span>
    <span class="header-label">حضور</span>
`,it.appendChild(t),U(u.students).forEach(n=>{const s=ba(n,e);it.appendChild(s)}),$a(),rs()}function de(){const e=document.getElementById("student-stats-table-container");if(!e||(e.innerHTML="",!u))return;U(u.students).length,jt.textContent="آمار عملکرد";const t=["نام"],n=["کل انتخاب ها","غیبت","خروج","فرصت ازدست‌رفته","مشکل","میانگین","نمره کلاسی (کانون)"],s=u.categories.filter(p=>p.isGradedCategory&&!p.isDeleted).map(p=>p.name),a=[...t,...s,...n],o=document.createElement("table");o.className="student-stats-table";const l=o.createTHead().insertRow();a.forEach((p,S)=>{const v=document.createElement("th");S===0?(v.innerHTML=`${p} <span style="opacity: 0.6;">🔗</span>`,v.title="ردیف‌های این ستون قابل کلیک هستند"):v.textContent=p,l.appendChild(v)});const r=o.createTBody(),f=U(u.students),C=p=>{let S=0;return u.sessions.forEach(v=>{if(v.isDeleted||v.isCancelled)return;const I=v.studentRecords[p.identity.studentId];I&&I.attendance==="absent"&&S++}),S};f.forEach(p=>{const S=r.insertRow();if(S.dataset.studentId=p.identity.studentId,E){const H=E.studentRecords[p.identity.studentId];H&&H.attendance==="absent"&&S.classList.add("absent-row-highlight")}const v=S.insertCell(),I=document.createElement("span");I.textContent=p.identity.name,I.className="student-name-link",I.addEventListener("click",()=>{q(p),X(),w("student-profile-page")}),v.appendChild(I),s.forEach(H=>{var ge;const P=S.insertCell(),oe=H.toLowerCase(),Y=((ge=p.logs.scores[oe])==null?void 0:ge.filter(G=>!G.isDeleted))||[];Y.length>0?Y.forEach((G,ie)=>{const ne=document.createElement("span");ne.textContent=G.value,ne.style.position="relative",G.comment&&(ne.dataset.tooltip=G.comment),P.appendChild(ne),ie<Y.length-1&&P.appendChild(document.createTextNode(","))}):P.textContent="",P.style.cursor="pointer",P.addEventListener("click",()=>{Ie(p,H);const G=document.getElementById("category-selection-container");G&&G.scrollIntoView({behavior:"smooth",block:"center"})})}),S.insertCell().textContent=p.statusCounters.totalSelections||0,S.insertCell().textContent=C(p),S.insertCell().textContent=p.statusCounters.outOfClassCount||0,S.insertCell().textContent=p.statusCounters.missedChances||0;const M=Object.values(p.categoryIssues||{}).reduce((H,P)=>H+P,0);S.insertCell().textContent=M;const R=p.getOverallAverageScore();S.insertCell().textContent=R!==null?R:"-";const B=u.calculateFinalStudentScore(p);S.insertCell().textContent=B!==null?B:"-"}),U(u.students),jt.setAttribute("data-student-count",f.length),e.appendChild(o);const h=e.querySelector(".student-stats-table"),d=h==null?void 0:h.querySelector("thead th:first-child");d&&d.addEventListener("click",()=>{h.classList.toggle("name-column-expanded")})}function Ie(e=null,t=null){const n=document.getElementById("selected-student-result");n.innerHTML="",n.classList.remove("absent");let s,a;if(e&&t)s=e,a=t,Nt({student:e,categoryName:t}),Te(-1);else{if(Nt(null),!E||ue<0||!E.winnerHistory[ue])return;const _=E.winnerHistory[ue];s=_.winner,a=_.categoryName}const o=document.querySelector(".current-winner-highlight");if(o&&o.classList.remove("current-winner-highlight"),s){const _=document.querySelector(`.student-stats-table tr[data-student-id="${s.identity.studentId}"]`);_&&_.classList.add("current-winner-highlight")}const i=u.categories.find(_=>_.name===a);if(i){on(i);const _=document.querySelectorAll("#category-selection-container .pill");_.forEach(z=>z.classList.remove("active"));const W=Array.from(_).find(z=>z.textContent===a);W&&W.classList.add("active"),cs(i)}const l=E.studentRecords[s.identity.studentId],r=(l==null?void 0:l.attendance)==="absent",f=document.createElement("div");f.className="winner-name-container";const C=document.createElement("button");C.className="btn-icon",C.innerHTML="˅",C.title="برنده قبلی";const h=!e;C.classList.toggle("is-disabled",!h||ue<=0),C.addEventListener("click",()=>{C.classList.contains("is-disabled")?(C.classList.add("shake-animation"),setTimeout(()=>C.classList.remove("shake-animation"),200)):(Te(ue-1),Ie())});const d=document.createElement("div");d.className="winner-name",d.innerHTML=`✨ <strong>${s.identity.name}</strong>✨`,d.classList.add("heartbeat-animation"),r&&(d.style.textDecoration="line-through",d.style.opacity="0.6",d.style.color="var(--color-secondary)"),(l==null?void 0:l.hadIssue)&&!r&&(d.style.color="var(--color-warning)",d.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"),(l==null?void 0:l.wasOutOfClass)&&!r&&(d.style.color="var(--color-strong-warning)",d.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود");const v=document.createElement("button");v.className="btn-icon",v.innerHTML="˄",v.title="برنده بعدی",v.classList.toggle("is-disabled",!h||ue>=E.winnerHistory.length-1),v.addEventListener("click",()=>{v.classList.contains("is-disabled")?(v.classList.add("shake-animation"),setTimeout(()=>v.classList.remove("shake-animation"),200)):(Te(ue+1),Ie())}),f.appendChild(v),f.appendChild(d),f.appendChild(C),n.appendChild(f),Se.disabled=h&&!v.classList.contains("is-disabled");const I=document.createElement("div");I.className="status-button-container";const M=document.createElement("button");M.textContent="غایب",M.classList.add("status-button","absent-btn"),r&&M.classList.add("active");const R=document.createElement("button");R.textContent="مشکل",R.classList.add("status-button","issue-btn"),l!=null&&l.hadIssue&&R.classList.add("active");const B=document.createElement("button");B.textContent="خروج",B.classList.add("status-button","exit-btn"),l!=null&&l.wasOutOfClass&&B.classList.add("active");const H=document.createElement("button");H.textContent="پروفایل",H.className="status-button profile-btn",M.addEventListener("click",()=>{const _=M.classList.contains("active");B.classList.contains("active")&&(B.classList.remove("active"),l.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),_?(M.classList.remove("active"),E.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),d.style.textDecoration="",d.style.opacity="",d.style.color=""):(R.classList.contains("active")&&(R.classList.remove("active"),l.hadIssue=!1,s.statusCounters.otherIssues=Math.max(0,s.statusCounters.otherIssues-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),M.classList.add("active"),E.setAttendance(s.identity.studentId,"absent"),s.statusCounters.missedChances++,d.style.textDecoration="line-through",d.style.opacity="0.6",d.style.color="var(--color-secondary)",d.title=""),de(),k()}),R.addEventListener("click",()=>{const _=R.classList.contains("active");if(B.classList.contains("active")&&(B.classList.remove("active"),l.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),_){R.classList.remove("active"),l.hadIssue=!1;const W=re.name;s.categoryIssues[W]&&(s.categoryIssues[W]=Math.max(0,s.categoryIssues[W]-1)),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),d.style.color="",d.title=""}else{M.classList.contains("active")&&(M.classList.remove("active"),E.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),R.classList.add("active"),l.hadIssue=!0;const W=re.name;s.categoryIssues[W]=(s.categoryIssues[W]||0)+1,s.statusCounters.missedChances++,d.style.textDecoration="",d.style.opacity="",d.style.color="var(--color-warning)",d.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"}de(),k()}),B.addEventListener("click",()=>{if(B.classList.contains("active"))B.classList.remove("active"),l.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),d.style.color="",d.title="";else{if(M.classList.contains("active")&&(M.classList.remove("active"),E.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),R.classList.contains("active")){R.classList.remove("active"),l.hadIssue=!1;const W=re.name;s.categoryIssues[W]&&(s.categoryIssues[W]=Math.max(0,s.categoryIssues[W]-1)),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)}B.classList.add("active"),l.wasOutOfClass=!0,s.statusCounters.outOfClassCount=(s.statusCounters.outOfClassCount||0)+1,s.statusCounters.missedChances++,d.style.textDecoration="",d.style.opacity="",d.style.color="var(--color-strong-warning)",d.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود"}de(),k()}),H.addEventListener("click",()=>{q(s),X(),w("student-profile-page")}),I.appendChild(M),I.appendChild(B),I.appendChild(R),I.appendChild(H),n.appendChild(I);const P=document.createElement("div");P.className="student-details-container";const oe=document.createElement("div");oe.className="student-details-scores",oe.innerHTML="<h4>آخرین نمرات</h4>";const Y=document.createElement("ul");Y.className="scores-list";const ge=["Reading","Writing","Speaking","Listening"];let G=!1;const ie=s.logs.scores||{};ge.forEach(_=>{const W=document.createElement("li"),z=document.createElement("span");z.className="skill-name",z.textContent=`${_}:`;const ke=document.createElement("span");ke.className="skill-scores";const Ht=_.toLowerCase(),We=ie[Ht];We&&We.length>0?(G=!0,ke.textContent=We.slice(-3).map(Ot=>Ot.value).join(",")):ke.textContent="none",W.appendChild(z),W.appendChild(ke),Y.appendChild(W)}),!G&&Object.keys(ie).length===0&&(Y.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>'),oe.appendChild(Y),P.appendChild(oe);const ne=document.createElement("div");ne.className="student-details-notes",ne.innerHTML="<h4>یادداشت‌ها</h4>";const xe=document.createElement("ul");xe.className="notes-list",s.profile.notes&&s.profile.notes.length>0?[...s.profile.notes].sort((W,z)=>new Date(z.timestamp)-new Date(W.timestamp)).forEach(W=>{const z=document.createElement("li");z.dir=Xe(W.content),z.textContent=W.content,xe.appendChild(z)}):xe.innerHTML='<div class="no-content-message">یادداشتی وجود ندارد.</div>',ne.appendChild(xe),P.appendChild(ne),n.appendChild(P)}function is(e){e.addEventListener("input",()=>{const t=e.value,n=Xe(t);e.setAttribute("dir",n)})}function Sa(){fn.innerHTML="",es.innerHTML="",xt.classList.add("tooltip-container"),Ce.disabled=!0,me.disabled=!0,Pe.disabled=!0,Ce.value="",me.value="",Ye.classList.add("disabled-wrapper"),Se.disabled=!0}function Ia(){u.categories.filter(t=>!t.isDeleted).forEach(t=>{const n=document.createElement("span");n.className="pill",n.textContent=t.name,n.dataset.categoryId=t.id,t.description&&(n.dataset.tooltip=t.description),n.addEventListener("click",()=>{document.querySelectorAll(".pill").forEach(a=>a.classList.remove("active")),n.classList.add("active"),on(t),cs(t),Ye.classList.remove("disabled-wrapper"),Se.disabled=!1;const s=E.lastWinnerByCategory[t.name];if(s){const a=u.students.find(o=>o.identity.studentId===s);a&&Ie(a,t.name)}else{es.innerHTML="",Nt(null),Te(-1),Se.disabled=!1;const a=document.querySelector(".current-winner-highlight");a&&a.classList.remove("current-winner-highlight")}}),fn.appendChild(n)})}function ka(){if(E.lastUsedCategoryId){const e=fn.querySelector(`.pill[data-category-id="${E.lastUsedCategoryId}"]`);e&&e.click()}E.winnerHistory&&E.winnerHistory.length>0&&(Te(E.winnerHistory.length-1),Ie())}function cs(e){e&&(e.isGradedCategory?(Ce.disabled=!1,me.disabled=!1,Pe.disabled=!1,xt.removeAttribute("data-tooltip")):(Ce.disabled=!0,me.disabled=!0,Pe.disabled=!0,xt.setAttribute("data-tooltip","برای این دسته‌بندی قابلیت نمره دهی تعریف نشده است")))}function Ne(){if(!u||!E){w("class-management-page");return}Sa(),Ia(),ka(),w("student-page"),de()}function X(){if(!O)return;const e=O;Zn.textContent=`پروفایل: ${e.identity.name}`;const t=u.sessions.reduce((d,p)=>{const S=p.studentRecords[e.identity.studentId];return d+(S&&S.attendance==="absent"?1:0)},0),n=Object.values(e.categoryIssues||{}).reduce((d,p)=>d+p,0);Ge.innerHTML=`
    <p><strong>کل انتخاب:</strong> ${e.statusCounters.totalSelections}</p>
    <p><strong>غیبت:</strong> ${t}</p>
    <p><strong>فرصت از دست رفته:</strong> ${e.statusCounters.missedChances||0}</p>
    <p><strong>مشکل:</strong> ${n}</p>`;const s=U(u.categories),a=document.createElement("div");if(a.className="stats-breakdown",s.length>0){s.forEach(p=>{var M;const S=p.name,v=((M=e.categoryCounts)==null?void 0:M[S])||0,I=document.createElement("p");I.className="stats-breakdown-item",I.innerHTML=`<strong>${S}:</strong> ${v}`,a.appendChild(I)});const d=Ge.querySelector("p:first-child");d&&d.after(a)}const o=document.createElement("div");o.className="stats-breakdown",s.length>0&&(s.forEach(d=>{var I;const p=d.name,S=((I=e.categoryIssues)==null?void 0:I[p])||0,v=document.createElement("p");v.className="stats-breakdown-item",v.innerHTML=`<strong>${p}:</strong> ${S}`,o.appendChild(v)}),Ge.appendChild(o));const i=document.createElement("p"),l=document.createElement("strong");l.textContent="تکالیف ناقص:";const r=document.createElement("span");r.style.marginRight="5px";const f=Ee(u);ht(e,f,r,{includePrefix:!1}),i.appendChild(l),i.appendChild(r),Ge.appendChild(i);const C=u.categories.filter(d=>d.isGradedCategory&&!d.isDeleted);Oe.innerHTML="",C.forEach(d=>{const p=document.createElement("span");p.className="pill",p.textContent=d.name,p.dataset.skillName=d.name,d.description&&(p.dataset.tooltip=d.description),Oe.appendChild(p),p.addEventListener("click",()=>{Oe.querySelectorAll(".pill").forEach(S=>S.classList.remove("active")),p.classList.add("active"),Kt.focus()})}),lt.innerHTML="";const h=[];for(const d in e.logs.scores)e.logs.scores[d].forEach(p=>{p.isDeleted||h.push(p)});h.sort((d,p)=>new Date(p.timestamp)-new Date(d.timestamp)),h.length===0?lt.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>':h.forEach(d=>{const p=document.createElement("li");p.className="score-history-item";const S=document.createElement("div");S.className="item-content";const v=document.createElement("div");if(v.className="score-info",v.innerHTML=`
        <span class="score-date">${new Date(d.timestamp).toLocaleDateString("fa-IR")}</span>
        <span class="score-value">نمره: <strong>${d.value}</strong></span>
        <span class="score-skill-badge">${d.skill}</span>
    `,S.appendChild(v),d.comment){const M=`توضیحات: ${d.comment}`,R=Xe(M);Xe(d.comment);const B=document.createElement("p");B.className="score-comment",B.dir=R,B.innerHTML=`<strong>توضیحات:</strong> <div>${Vn(d.comment)}</div>`,B.addEventListener("click",()=>{A.value=d.comment,A.dispatchEvent(new Event("input",{bubbles:!0})),pe(H=>{d.comment=H,k(),X()}),te("add-note-modal"),A.focus()}),S.appendChild(B)}const I=document.createElement("button");I.className="btn-icon delete-item-btn",I.innerHTML="🗑️",I.title="حذف این نمره",I.addEventListener("click",()=>{F(`آیا از حذف نمره ${d.value} برای مهارت ${d.skill} مطمئن هستید؟`,()=>{d.isDeleted=!0,$(u.info.name,`نمره ${d.value} در ${d.skill} برای «${e.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),k(),X(),b("✅نمره به سطل زباله منتقل شد.")},{confirmText:"تایید حذف",confirmClass:"btn-warning"})}),p.appendChild(S),p.appendChild(I),lt.appendChild(p)}),Kt.value="",mn.value="",Oe.querySelector(".pill.active")&&Oe.querySelector(".pill.active").classList.remove("active"),Ze()}function Ze(){const e=document.getElementById("profile-notes-list");if(e.innerHTML="",!O||!O.profile.notes||O.profile.notes.length===0){e.innerHTML='<div class="no-content-message">هنوز یادداشتی ثبت نشده است.</div>';return}[...O.profile.notes].filter(n=>!n.isDeleted).sort((n,s)=>new Date(s.timestamp)-new Date(n.timestamp)).forEach(n=>{const s=document.createElement("li");s.className="note-history-item";const a=document.createElement("div");a.className="item-content";const o=document.createElement("div");o.className="note-info";const i=document.createElement("span");i.className="note-date",i.textContent=new Date(n.timestamp).toLocaleDateString("fa-IR");const l=document.createElement("button");l.className="btn-icon delete-item-btn",l.innerHTML="🗑️",l.title="حذف این یادداشت",l.addEventListener("click",()=>{F("آیا از حذف این یادداشت مطمئن هستید؟",()=>{n.isDeleted=!0,$(u.info.name,`یادداشت دانش‌آموز «${O.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),k(),Ze(),b("✅یادداشت به سطل زباله منتقل شد.")},{confirmText:"تایید حذف",confirmClass:"btn-warning"})}),o.appendChild(i),o.appendChild(l);const r=document.createElement("p");r.className="note-content",r.innerHTML=Vn(n.content),r.addEventListener("click",()=>{A.value=n.content,A.dispatchEvent(new Event("input",{bubbles:!0})),pe(f=>{n.content=f,k(),$(u.info.name,`یادداشت دانش‌آموز «${O.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:O.identity.studentId}),Ze(),b("✅یادداشت با موفقیت ویرایش شد.")}),te("add-note-modal"),A.focus()}),a.appendChild(o),a.appendChild(r),s.appendChild(a),e.appendChild(s)})}function ls(e){qt.innerHTML="",e.forEach((t,n)=>{const s=document.createElement("option");s.value=n,s.textContent=t.trim(),qt.appendChild(s)})}function Xt(){Vt.innerHTML="",Zt.forEach(e=>{const t=document.createElement("li");t.className="preview-item";const n=document.createElement("input");n.type="checkbox",n.checked=!0,n.dataset.name=e;const s=document.createElement("label");s.textContent=e,t.appendChild(n),t.appendChild(s),Vt.appendChild(t)})}function wa(e){const t=document.createElement("div");t.className="list-item-buttons";const n=document.createElement("button");return n.className="btn-icon",n.innerHTML="📝",n.title="افزودن/ویرایش یادداشت کلاس",n.style.borderBottom="solid",e.note||(n.style.opacity="0.5",n.style.borderBottom="none"),n.addEventListener("click",s=>{s.stopPropagation(),gn(e)}),t.appendChild(n),t}function Na(e){const t=document.createElement("div");t.style.flexGrow="1",t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="flex-start";const n=document.createElement("span");n.textContent=e.info.name,n.classList.add("class-name-display"),t.appendChild(n);const s=U(e.students).length,a=U(e.sessions).filter(r=>r.isFinished).length,o=document.createElement("div");o.classList.add("class-stats-row");const i=document.createElement("span");i.textContent=`${s} نفر`,i.classList.add("student-count-badge"),o.appendChild(i);const l=document.createElement("span");return l.textContent=`${a} جلسه`,l.classList.add("session-count-badge"),o.appendChild(l),t.appendChild(o),t.addEventListener("click",()=>{J(e),Q(null),Ke(u.liveSession),j(),w("session-page")}),t}function Ta(e){const t=document.createElement("li"),n=Na(e);t.appendChild(n);const s=document.createElement("div");if(s.className="list-item-badges",e.liveSession&&!e.liveSession.isCancelled&&!e.liveSession.isDeleted){const i=document.createElement("span");i.className="warning-badge",i.textContent="جلسه باز",s.appendChild(i),t.classList.add("has-unfinished-session")}const a=document.createElement("span");a.className=`type-badge ${e.info.type}`,a.textContent=e.info.type==="online"?"آنلاین":"حضوری",a.title="نوع کلاس",s.appendChild(a),t.appendChild(s);const o=wa(e);return t.appendChild(o),t.addEventListener("contextmenu",i=>{$t(i,[{label:"تنظیمات کلاس",icon:"⚙️",action:()=>{hn(e)}},{label:"گزارش فعالیت‌ها",icon:"📋",action:()=>{as(e.info.name)}},{label:"تغییر نام",icon:"✏️",action:()=>{const r=e.info.name,f=document.getElementById("add-note-modal-title");f.textContent="تغییر نام کلاس",A.value=r,A.rows=1,pe(C=>{const h=C.trim();if(h&&h!==r){const d=Mn(r,h);d.success?(Os(r,h),$(h,`نام کلاس از «${r}» به «${h}» تغییر یافت.`,{type:"VIEW_SESSIONS"}),k(),ae(),b(`✅نام کلاس به «${h}» تغییر یافت.`)):b(d.message)}f.textContent="ثبت یادداشت جدید",A.rows=4}),te("add-note-modal"),A.focus(),A.select()}},{label:"حذف کلاس",icon:"🗑️",className:"danger",action:()=>{F(`آیا از حذف کلاس «${e.info.name}» مطمئن هستید؟ این عمل تمام جلسات و آمار مربوط به آن را نیز حذف می‌کند.`,()=>{et(`کلاس «${e.info.name}» حذف شد.`),e.isDeleted=!0,k(),ae()},{confirmText:"تایید حذف",confirmClass:"btn-warning",isDelete:!0})}}])}),t}function ae(){Wt.innerHTML="",Object.values(T).sort((t,n)=>new Date(t.info.creationDate)-new Date(n.info.creationDate)).forEach(t=>{if(t.isDeleted)return;const n=Ta(t);Wt.appendChild(n)})}function ye(){Ft.innerHTML="",u&&U(u.students).forEach(e=>{const t=document.createElement("li"),n=document.createElement("span");n.textContent=e.identity.name,n.style.flexGrow="1",n.className="student-name-link",n.addEventListener("click",()=>{q(e),X(),w("student-profile-page")}),t.appendChild(n),t.addEventListener("contextmenu",s=>{$t(s,[{label:"تغییر نام",icon:"✏️",action:()=>{pn(e,u)}},{label:"انتقال دانش‌آموز",icon:"➡️",action:()=>{ss(e,u)}},{label:"حذف دانش‌آموز",icon:"🗑️",className:"danger",action:()=>{F(`آیا از حذف دانش‌آموز «${e.identity.name}» مطمئن هستید؟`,()=>{et(`دانش‌آموز «${e.identity.name}» حذف شد.`),e.isDeleted=!0,$(u.info.name,`دانش‌آموز «${e.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),k(),ye()},{confirmText:"تایید حذف",confirmClass:"btn-warning"})}}])}),Ft.appendChild(t)})}function _e(){if(Ut.innerHTML="",!u)return;u.categories.filter(t=>!t.isDeleted).forEach(t=>{const n=document.createElement("li"),s=document.createElement("div");s.className="name-and-badge-container";const a=document.createElement("span");if(a.textContent=t.name,s.appendChild(a),t.isGradedCategory){const i=document.createElement("span");i.className="category-badge",i.textContent="قابل نمره‌دهی",s.appendChild(i)}const o=document.createElement("button");o.className="btn-icon",o.innerHTML="🗑️",o.style.color="var(--color-warning)",o.addEventListener("click",()=>{et(`دسته‌بندی «${t.name}» حذف شد.`),t.isDeleted=!0,$(u.info.name,`دسته‌بندی «${t.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),k(),_e()}),n.appendChild(s),n.appendChild(o),Ut.appendChild(n)})}function Je(e){document.querySelectorAll(".page").forEach(n=>{n.classList.remove("active")});const t=document.getElementById(e);t&&t.classList.add("active"),e==="class-management-page"?(ae(),Gt.style.display="flex"):Gt.style.display="none",os()}function w(e){const t={pageId:e,currentClassName:u?u.info.name:null,selectedSessionNumber:E?E.sessionNumber:null,selectedStudentId:O?O.identity.studentId:null};let n=`#${e}`;const s=new URLSearchParams;u&&s.set("class",u.info.name),E&&s.set("session",E.sessionNumber),O&&s.set("student",O.identity.studentId);const a=s.toString();a&&(n+=`?${a}`),window.location.hash!==n&&history.pushState(t,"",n),Je(e)}function Ba(e,t){const n=document.createElement("div");n.className="list-item-buttons";const s=document.createElement("button");if(s.className="btn-icon",s.innerHTML="📝",s.title="افزودن/ویرایش یادداشت جلسه",s.style.borderBottom="solid",e.note||(s.style.opacity="0.5",s.style.borderBottom="none"),s.addEventListener("click",a=>{a.stopPropagation(),A.value=e.note||"",pe(o=>{e.note=o,k(),$(u.info.name,`یادداشت جلسه ${t} ذخیره شد.`,{type:"VIEW_SESSIONS"}),j(),b("✅یادداشت جلسه ذخیره شد.")}),te("add-note-modal"),A.focus()}),n.appendChild(s),!e.isFinished&&!e.isCancelled){const a=document.createElement("button");a.className="btn-icon",a.innerHTML="✅",a.title="خاتمه جلسه",a.addEventListener("click",o=>{o.stopPropagation(),F(`جلسه شماره ${t} خاتمه پیدا خواهد کرد!`,()=>{u.endSpecificSession(e.sessionNumber),k(),$(u.info.name,`جلسه ${t} خاتمه یافت.`,{type:"VIEW_SESSIONS"}),j(),F("جلسه با موفقیت خاتمه یافت. آیا مایل به ایجاد فایل پشتیبان هستید؟",()=>{if(fe){b("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است.");return}Cn(),b("✅فایل پشتیبان با موفقیت ایجاد شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}),n.appendChild(a)}return n}function xa(e,t){const n=document.createElement("div");n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="flex-start",n.style.flexGrow="1";const s=new Date(e.startTime).toLocaleDateString("fa-IR"),a=document.createElement("span"),o=document.createElement("div");o.style.display="flex",o.style.gap="5px",o.style.marginTop="5px";const i=new Date(e.startTime).toLocaleDateString("fa-IR",{weekday:"long"}),l=document.createElement("span");if(l.className="type-badge day-badge",l.textContent=i,o.appendChild(l),e.isCancelled){a.textContent=`✅جلسه لغو شده - تاریخ: ${s}`,n.style.cursor="default";const r=document.createElement("span");r.className="type-badge cancelled-badge",r.textContent="لغو شده",o.appendChild(r)}else a.textContent=`جلسه ${t} - تاریخ: ${s}`,n.style.cursor="pointer",n.addEventListener("click",()=>{Q(e),Ne()});if(n.appendChild(a),e.isFinished){const r=document.createElement("span");r.className="type-badge",r.textContent="خاتمه یافته",r.style.backgroundColor="var(--color-secondary)",o.appendChild(r)}if(e.isMakeup){const r=document.createElement("span");r.className="type-badge",r.textContent="جبرانی",r.style.backgroundColor="var(--color-warning)",r.style.color="var(--color-text-dark)",o.appendChild(r)}return n.appendChild(o),n}function Da(e,t){const n=document.createElement("li"),s=t.get(e.sessionNumber),a=xa(e,s);n.appendChild(a);const o=Ba(e,s);return n.appendChild(o),n.addEventListener("contextmenu",i=>{const l=[{label:e.isCancelled?"بازگردانی جلسه":"لغو جلسه",icon:"❌",action:()=>{const r=e.isCancelled?"بازگردانی جلسه":"لغو جلسه",f=e.isCancelled?"آیا از بازگردانی این جلسه مطمئن هستید؟":"آیا از لغو این جلسه مطمئن هستید؟ جلسه لغو شده در آمار تاثیری ندارد اما قابل بازگردانی است.";F(f,()=>{e.isCancelled=!e.isCancelled;const C=e.isCancelled?`جلسه ${s} لغو شد.`:`جلسه لغو شده (تاریخ: ${new Date(e.startTime).toLocaleDateString("fa-IR")}) بازگردانی شد.`;$(u.info.name,C,{type:"VIEW_SESSIONS"}),k(),j(),b(e.isCancelled?"✅جلسه لغو شد.":"✅جلسه بازگردانی شد.")},{confirmText:r,confirmClass:"btn-warning"})}},{label:"تغییر وضعیت جبرانی",icon:"🔄",action:()=>{u.markAsMakeup(e.sessionNumber),k();const r=e.isMakeup?`جلسه ${s} به عنوان جبرانی علامت‌گذاری شد.`:`جلسه ${s} از حالت جبرانی خارج شد.`;$(u.info.name,r,{type:"VIEW_SESSIONS"}),j()}},{label:"حذف جلسه",icon:"🗑️",className:"danger",action:()=>{const r=e.isCancelled?"لغو شده":s;F(`آیا از حذف جلسه ${r} مطمئن هستید؟ این عمل آمار ثبت شده در این جلسه را نیز حذف می‌کند.`,()=>{et(`جلسه ${r} حذف شد.`),e.isDeleted=!0,$(u.info.name,`جلسه ${r} به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),k(),j()},{confirmText:"تایید حذف",confirmClass:"btn-warning",isDelete:!0})}}];$t(i,l)}),n}function j(){const e=document.getElementById("session-list");if(!u)return;if(e.innerHTML="",u.sessions.length===0){e.innerHTML="<li>هنوز جلسه‌ای شروع نشده است.</li>";return}const t=Ee(u);[...U(u.sessions)].reverse().forEach(s=>{const a=Da(s,t);e.appendChild(a)})}function je(e){if(ve.innerHTML="",e.length>0)e.forEach(t=>{const n=document.createElement("div");n.textContent=t.identity.name,n.addEventListener("click",()=>{q(t),X(),w("student-profile-page"),ve.style.display="none",zt.value=""}),ve.appendChild(n)}),ve.style.display="block";else if(zt.value.trim()!==""){const t=document.createElement("div");t.className="no-results",t.textContent="پیدا نشد",ve.appendChild(t),ve.style.display="block"}else ve.style.display="none"}function Ct(e){if(he.innerHTML="",e.length>0)e.forEach(t=>{const n=document.createElement("div");n.className="global-search-result";const s=document.createElement("span");s.className="student-name",s.textContent=t.student.identity.name;const a=document.createElement("span");a.className="class-name",a.textContent=`کلاس: ${t.classroom.info.name}`,n.addEventListener("click",()=>{J(t.classroom),q(t.student),X(),w("student-profile-page"),he.style.display="none",rt.value=""}),a.addEventListener("click",o=>{o.stopPropagation(),J(t.classroom),Q(null),Ke(t.classroom.liveSession),j(),w("session-page"),he.style.display="none",rt.value=""}),n.appendChild(s),n.appendChild(a),he.appendChild(n)}),he.style.display="block";else if(rt.value.trim()!==""){const t=document.createElement("div");t.className="no-results",t.textContent="پیدا نشد",he.appendChild(t),he.style.display="block"}else he.style.display="none"}function K(){dt.innerHTML="",ut.innerHTML="",mt.innerHTML="",ft.innerHTML="",pt.innerHTML="",gt.innerHTML="";const e=Object.values(T).filter(i=>i.isDeleted);e.length===0?dt.innerHTML="<li>هیچ کلاسی در سطل زباله نیست.</li>":e.forEach(i=>{const l=document.createElement("li");l.innerHTML=`<span>${i.info.name}</span>`;const r=document.createElement("div");r.className="list-item-buttons";const f=document.createElement("button");f.className="btn-icon",f.innerHTML="🔄",f.title="بازیابی",f.addEventListener("click",()=>{i.isDeleted=!1,$(i.info.name,`کلاس «${i.info.name}» از سطل زباله بازیابی شد.`,{type:"VIEW_SESSIONS"}),k(),K(),ae(),b(`✅کلاس «${i.info.name}» بازیابی شد.`)});const C=document.createElement("button");C.className="btn-icon",C.innerHTML="🔥",C.title="حذف دائمی",C.addEventListener("click",()=>{F(`آیا از حذف دائمی کلاس «${i.info.name}» مطمئن هستید؟ این عمل غیرقابل بازگشت است.`,()=>{delete T[i.info.name],k(),K(),b(`✅کلاس «${i.info.name}» برای همیشه حذف شد.`)},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),r.appendChild(f),r.appendChild(C),l.appendChild(r),dt.appendChild(l)});const t=[];Object.values(T).forEach(i=>{i.isDeleted||i.students.forEach(l=>{l.isDeleted&&t.push({student:l,classroom:i})})}),t.length===0?ut.innerHTML="<li>هیچ دانش‌آموزی در سطل زباله نیست.</li>":t.forEach(({student:i,classroom:l})=>{const r=document.createElement("li");r.innerHTML=`<span>${i.identity.name} <small>(از کلاس: ${l.info.name})</small></span>`;const f=document.createElement("div");f.className="list-item-buttons";const C=document.createElement("button");C.className="btn-icon",C.innerHTML="🔄",C.title="بازیابی",C.addEventListener("click",()=>{i.isDeleted=!1,$(l.info.name,`دانش‌آموز «${i.identity.name}» بازیابی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:i.identity.studentId}),k(),K(),b(`دانش‌آموز «${i.identity.name}» بازیابی شد.`)});const h=document.createElement("button");h.className="btn-icon",h.innerHTML="🔥",h.title="حذف دائمی",h.addEventListener("click",()=>{F(`آیا از حذف دائمی دانش‌آموز «${i.identity.name}» مطمئن هستید؟ این عمل غیرقابل بازگشت است.`,()=>{Tt(i,l),k(),K(),b(`دانش‌آموز «${i.identity.name}» برای همیشه حذف شد.`)},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),f.appendChild(C),f.appendChild(h),r.appendChild(f),ut.appendChild(r)});const n=[];Object.values(T).forEach(i=>{i.isDeleted||i.sessions.forEach(l=>{l.isDeleted&&n.push({session:l,classroom:i})})}),n.length===0?mt.innerHTML="<li>هیچ جلسه‌ای در سطل زباله نیست.</li>":n.forEach(({session:i,classroom:l})=>{const r=document.createElement("li");r.innerHTML=`<span>جلسه ${i.sessionNumber} <small>(از کلاس: ${l.info.name})</small></span>`;const f=document.createElement("div");f.className="list-item-buttons";const C=document.createElement("button");C.className="btn-icon",C.innerHTML="🔄",C.title="بازیابی",C.addEventListener("click",()=>{i.isDeleted=!1,$(l.info.name,`جلسه ${i.sessionNumber} بازیابی شد.`,{type:"VIEW_SESSIONS"}),k(),K(),b(`جلسه ${i.sessionNumber} بازیابی شد.`)});const h=document.createElement("button");h.className="btn-icon",h.innerHTML="🔥",h.title="حذف دائمی",h.addEventListener("click",()=>{F(`آیا از حذف دائمی جلسه ${i.sessionNumber} مطمئن هستید؟`,()=>{const d=l.sessions.findIndex(p=>p.sessionNumber===i.sessionNumber);d>-1&&l.sessions.splice(d,1),k(),K(),b(`جلسه ${i.sessionNumber} برای همیشه حذف شد.`)},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),f.appendChild(C),f.appendChild(h),r.appendChild(f),mt.appendChild(r)});const s=[];Object.values(T).forEach(i=>{i.isDeleted||i.categories.forEach(l=>{l.isDeleted&&s.push({category:l,classroom:i})})}),s.length===0?ft.innerHTML="<li>هیچ دسته‌بندی در سطل زباله نیست.</li>":s.forEach(({category:i,classroom:l})=>{const r=document.createElement("li");r.innerHTML=`<span>${i.name} <small>(از کلاس: ${l.info.name})</small></span>`;const f=document.createElement("div");f.className="list-item-buttons";const C=document.createElement("button");C.className="btn-icon",C.innerHTML="🔄",C.title="بازیابی",C.addEventListener("click",()=>{i.isDeleted=!1,$(l.info.name,`دسته‌بندی «${i.name}» بازیابی شد.`,{type:"VIEW_SESSIONS"}),k(),K(),b(`دسته‌بندی «${i.name}» بازیابی شد.`)});const h=document.createElement("button");h.className="btn-icon",h.innerHTML="🔥",h.title="حذف دائمی",h.addEventListener("click",()=>{F(`آیا از حذف دائمی دسته‌بندی «${i.name}» مطمئن هستید؟`,()=>{const d=i.name,p=d.toLowerCase();l.students.forEach(v=>{v.categoryCounts&&v.categoryCounts[d]&&delete v.categoryCounts[d],v.categoryIssues&&v.categoryIssues[d]&&delete v.categoryIssues[d],v.logs.scores&&v.logs.scores[p]&&delete v.logs.scores[p]});const S=l.categories.findIndex(v=>v.id===i.id);S>-1&&l.categories.splice(S,1),k(),K(),b(`دسته‌بندی «${d}» و تمام داده‌های مرتبط با آن برای همیشه حذف شد.`)},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),f.appendChild(C),f.appendChild(h),r.appendChild(f),ft.appendChild(r)});const a=[];Object.values(T).forEach(i=>{i.isDeleted||i.students.forEach(l=>{l.isDeleted||l.profile.notes.forEach(r=>{r.isDeleted&&a.push({note:r,student:l,classroom:i})})})}),a.length===0?pt.innerHTML="<li>هیچ یادداشتی در سطل زباله نیست.</li>":a.forEach(({note:i,student:l,classroom:r})=>{const f=document.createElement("li"),C=i.content.length>50?i.content.substring(0,50)+"...":i.content;f.innerHTML=`<span>"${C}" <small>(برای: ${l.identity.name}، کلاس: ${r.info.name})</small></span>`;const h=document.createElement("div");h.className="list-item-buttons";const d=document.createElement("button");d.className="btn-icon",d.innerHTML="🔄",d.title="بازیابی",d.addEventListener("click",()=>{i.isDeleted=!1,$(r.info.name,`یادداشت دانش‌آموز «${l.identity.name}» بازیابی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:l.identity.studentId}),k(),K(),b("یادداشت بازیابی شد.")});const p=document.createElement("button");p.className="btn-icon",p.innerHTML="🔥",p.title="حذف دائمی",p.addEventListener("click",()=>{F("آیا از حذف دائمی این یادداشت مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{const S=l.profile.notes.findIndex(v=>v.id===i.id);S>-1&&l.profile.notes.splice(S,1),k(),K(),b("یادداشت برای همیشه حذف شد.")},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),h.appendChild(d),h.appendChild(p),f.appendChild(h),pt.appendChild(f)});const o=[];Object.values(T).forEach(i=>{i.isDeleted||i.students.forEach(l=>{if(!l.isDeleted)for(const r in l.logs.scores)l.logs.scores[r].forEach(f=>{f.isDeleted&&o.push({score:f,student:l,classroom:i})})})}),o.length===0?gt.innerHTML="<li>هیچ توضیح نمره‌ای در سطل زباله نیست.</li>":o.forEach(({score:i,student:l,classroom:r})=>{const f=document.createElement("li");let C=`نمره ${i.value} در مهارت ${i.skill}`;if(i.comment){const S=i.comment.length>30?i.comment.substring(0,30)+"...":i.comment;C+=` (توضیحات: "${S}")`}f.innerHTML=`<span>${C} <small>(دانش‌آموز: ${l.identity.name}، کلاس: ${r.info.name})</small></span>`;const h=document.createElement("div");h.className="list-item-buttons";const d=document.createElement("button");d.className="btn-icon",d.innerHTML="🔄",d.title="بازیابی",d.addEventListener("click",()=>{i.isDeleted=!1,$(r.info.name,`نمره ${i.value} در ${i.skill} برای «${l.identity.name}» بازیابی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:l.identity.studentId}),k(),K(),b("توضیح نمره بازیابی شد.")});const p=document.createElement("button");p.className="btn-icon",p.innerHTML="🔥",p.title="حذف دائمی",p.addEventListener("click",()=>{F("آیا از حذف دائمی این توضیح مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{const S=i.skill.toLowerCase(),v=l.logs.scores[S];if(v){const I=v.findIndex(M=>M.id===i.id);I>-1&&v.splice(I,1)}k(),K(),b("توضیح نمره برای همیشه حذف شد.")},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),h.appendChild(d),h.appendChild(p),f.appendChild(h),gt.appendChild(f)})}function Ma(){const e=document.getElementById("absentees-summary-container");e&&(e.innerHTML=`
        <div id="absentees-summary-box" class="absentees-summary">
            <div class="absentees-summary-header">
                <h4>لیست غایبین جلسه شماره <span id="absentee-summary-session-number"></span></h4>
                <button id="copy-absentees-btn" class="btn-icon" title="کپی لیست غایبین">📋</button>
            </div>
            <div id="absentees-summary-list" class="summary-list"></div>
        </div>
    `)}function rs(){const e=document.getElementById("absentees-summary-box"),t=document.getElementById("absentees-summary-list"),n=document.getElementById("absentee-summary-session-number");if(!e||!t||!n){console.error("Could not find all absentee summary elements.");return}if(!u||!E){e.classList.remove("visible");return}const s=U(u.students).filter(o=>{const i=E.studentRecords[o.identity.studentId];return i&&i.attendance==="absent"}),a=Ee(u);n.textContent=a.get(E.sessionNumber),s.length>0?e.classList.add("visible"):e.classList.remove("visible"),t.innerHTML="",s.forEach(o=>{const l=(f=>u.sessions.reduce((C,h)=>{if(h.isDeleted||h.isCancelled)return C;const d=h.studentRecords[f.identity.studentId];return C+(d&&d.attendance==="absent"?1:0)},0))(o),r=document.createElement("span");r.className="summary-name",r.textContent=`${o.identity.name} (غیبت: ${l})`,r.addEventListener("click",()=>{r.classList.add("fading-out"),setTimeout(()=>{E.setAttendance(o.identity.studentId,"present"),k(),Re()},200)}),t.appendChild(r)})}function $a(){const e=document.getElementById("copy-absentees-btn");if(!e){console.error("Could not find the copy absentees button to attach listener.");return}e.addEventListener("click",()=>{if(!u||!E)return;const t=U(u.students).filter(a=>{const o=E.studentRecords[a.identity.studentId];return o&&o.attendance==="absent"});if(t.length===0){b("⚠️لیست غایبین خالی است.");return}const n=a=>u.sessions.reduce((o,i)=>{if(i.isDeleted||i.isCancelled)return o;const l=i.studentRecords[a.identity.studentId];return o+(l&&l.attendance==="absent"?1:0)},0);let s=`لیست غایبین جلسه شماره ${La()}:

`;t.forEach(a=>{const o=n(a);s+=`- ${a.identity.name} (تعداد غیبت‌ها: ${o})
`}),navigator.clipboard.writeText(s).then(()=>{b("✅لیست غایبین با موفقیت کپی شد.")}).catch(a=>{console.error("Failed to copy text: ",a),b("❌خطا در کپی کردن لیست.")})})}function yt(){const e=document.getElementById("demo-mode-banner");e&&(fe?(e.classList.add("visible"),document.body.classList.add("demo-mode-active")):(e.classList.remove("visible"),document.body.classList.remove("demo-mode-active")))}const Ha=Object.freeze(Object.defineProperty({__proto__:null,_internalShowPage:Je,addCategoryBtn:Zs,addClassBtn:Rs,addNoteModal:pa,addScoreBtn:Ea,addStudentBtn:Us,appHeader:Gt,attendanceListUl:it,attendancePage:ea,backToAttendanceBtn:sa,backToSessionsBtn:Ws,backToSessionsFromAttendanceBtn:na,backToStudentPageBtn:ya,backupDataBtn:ra,breadcrumbContainer:Ae,cancelImportBtn:Xs,cancelNoteBtn:ha,categoryListUl:Ut,classListHeader:aa,classListUl:Wt,classManagementPage:jn,classSaveNoteBtn:ga,closeActiveModal:ee,closeContextMenu:we,closeNavBtn:ca,columnMappingPage:Ks,columnSelectDropdown:qt,confirmColumnBtn:Qs,confirmModalCancelBtn:Jt,confirmModalConfirmBtn:qe,confirmModalMessage:Qn,contextMenu:Be,csvCancelBtn:js,csvConfirmBtn:Gs,csvFileInput:zs,csvPreviewList:Vt,csvPreviewPage:qs,customConfirmModal:ua,displayWinner:Ie,finishAttendanceBtn:ta,globalStudentSearchInput:rt,globalStudentSearchResultsDiv:he,gradedCategoryPillsContainer:Oe,hamburgerMenuBtn:oa,handleUndo:ts,importCsvBtn:Js,initiateBackupProcess:Cn,isGradedCheckbox:va,newCategoryNameInput:Ys,newClassNameInput:As,newNoteContent:A,newScoreCommentTextarea:mn,newScoreValueInput:Kt,newStudentNameInput:Fs,openContextMenu:$t,openModal:te,overlay:la,pasteArea:zn,processPasteBtn:Vs,profileScoresListUl:lt,profileStatsSummaryDiv:Ge,profileStudentNameHeader:Zn,quickGradeFormWrapper:xt,quickGradeSubmitBtn:Pe,quickNoteTextarea:me,quickScoreInput:Ce,renderAttendancePage:Re,renderBreadcrumbs:os,renderClassList:ae,renderColumnSelector:ls,renderGlobalSearchResults:Ct,renderImportPreview:Xt,renderLogModal:as,renderSearchResults:je,renderSessions:j,renderSettingsCategories:_e,renderSettingsStudentList:ye,renderStudentNotes:Ze,renderStudentPage:Ne,renderStudentProfilePage:X,renderStudentStatsList:de,renderTrashPage:K,restoreDataBtn:da,restoreFileInput:Kn,secureConfirmCancelBtn:fa,secureConfirmCode:Yn,secureConfirmConfirmBtn:ct,secureConfirmInput:He,secureConfirmMessage:Xn,secureConfirmModal:ma,selectStudentBtn:Se,selectStudentBtnWrapper:Ye,setAutoDirectionOnInput:is,settingsClassNameHeader:un,settingsPage:_s,settingsStudentListUl:Ft,showClassNoteModal:gn,showCustomConfirm:F,showMoveStudentModal:ss,showNotification:b,showPage:w,showRenameStudentModal:pn,showSecureConfirm:ns,showSettingsPage:hn,showUndoToast:et,sideNavMenu:ia,studentProfilePage:Ca,studentSearchInput:zt,studentSearchResultsDiv:ve,studentStatsHeader:jt,trashedCategoriesList:ft,trashedClassesList:dt,trashedNotesList:pt,trashedScoresList:gt,trashedSessionsList:mt,trashedStudentsList:ut,triggerFileDownload:Qt,undoBtn:Ps,undoMessage:Jn,undoToast:Bt,updateDemoModeBanner:yt},Symbol.toStringTag,{value:"Module"}));function Oa(){const e=window.location.hash;if(!e||e==="#")return!1;const[t,n]=e.split("?"),s=t.substring(1),a=new URLSearchParams(n),o=a.get("class"),i=parseInt(a.get("session"),10),l=a.get("student");if(o&&T[o])J(T[o]),i&&u.getSession(i)&&Q(u.getSession(i)),l&&u.students.find(r=>r.identity.studentId===l)&&q(u.students.find(r=>r.identity.studentId===l));else return!1;switch(s){case"session-page":j(),w("session-page");break;case"student-page":Ne();break;case"attendance-page":Re(),w("attendance-page");break;case"settings-page":un.textContent=`تنظیمات کلاس: ${u.info.name}`,ye(),_e(),w("settings-page");break;case"student-profile-page":X(),w("student-profile-page");break;default:return!1}return!0}document.addEventListener("DOMContentLoaded",()=>{const{globalStudentSearchInput:e,newClassNameInput:t,addClassBtn:n,undoBtn:s,backToSessionsBtn:a,newStudentNameInput:o,addStudentBtn:i,pasteArea:l,processPasteBtn:r,csvPreviewList:f,csvConfirmBtn:C,csvCancelBtn:h,importCsvBtn:d,csvFileInput:p,columnSelectDropdown:S,confirmColumnBtn:v,cancelImportBtn:I,newCategoryNameInput:M,addCategoryBtn:R,selectStudentBtn:B,attendancePage:H,finishAttendanceBtn:P,backToSessionsFromAttendanceBtn:oe,backToAttendanceBtn:Y,classListHeader:ge,studentStatsHeader:G,hamburgerMenuBtn:ie,sideNavMenu:ne,closeNavBtn:xe,overlay:_,backupDataBtn:W,restoreDataBtn:z,restoreFileInput:ke,confirmModalCancelBtn:Ht,confirmModalConfirmBtn:We,secureConfirmCancelBtn:Ot,secureConfirmConfirmBtn:ds,newNoteContent:tt,classSaveNoteBtn:us,cancelNoteBtn:ms,studentSearchInput:Fe,studentSearchResultsDiv:fs,studentProfilePage:ps,profileStudentNameHeader:gs,backToStudentPageBtn:hs,gradedCategoryPillsContainer:Cs,newScoreValueInput:ys,newScoreCommentTextarea:Es,addScoreBtn:vs,isGradedCheckbox:yn}=Ha,bs=document.getElementById("trash-nav-btn");document.querySelector(".global-search-container .search-icon"),kt(),yt(),Oa()||(ae(),w("class-management-page"));function En(c,g){const m=document.querySelector(c);if(!m)return;const y=m.querySelector(".search-icon"),L=m.querySelector(".animated-search-input");!y||!L||(y.addEventListener("mousedown",x=>{x.preventDefault()}),y.addEventListener("click",()=>{m.classList.contains("search-active")||(m.classList.add("search-active"),L.focus())}),L.addEventListener("blur",()=>{setTimeout(()=>{m.classList.remove("search-active"),L.value="",g&&g([])},150)}))}window.addEventListener("scroll",we),document.addEventListener("click",c=>{Be.classList.contains("visible")&&!Be.contains(c.target)&&we(),Fe.contains(c.target)||(fs.style.display="none");const g=c.target.closest(".log-action-link");if(g&&g.dataset.action)try{const m=JSON.parse(g.dataset.action);Ts(m)}catch(m){console.error("Could not parse log action:",m)}}),Ye.addEventListener("click",()=>{(Ye.classList.contains("disabled-wrapper")||Se.disabled)&&(Se.classList.add("shake-animation"),setTimeout(()=>{Se.classList.remove("shake-animation")},200))}),G.addEventListener("click",()=>{const c=new Date().getTime();c-nn>500?ot(1):ot(bt+1),Rn(c),bt===5&&(ot(0),F("آیا از صفر کردن تمام شمارنده‌های دانش‌آموزان مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{Wn(),de(),b("تمام آمارها صفر شدند ✅.")},{confirmText:"بله",confirmClass:"btn-warning"}))}),ge.addEventListener("click",()=>{const c=new Date().getTime();c-tn>500?at(1):at(vt+1),An(c),vt===5&&(at(0),F("آیا از ساخت یک کلاس تستی تصادفی مطمئن هستید؟",()=>{function g(){const m=`کلاس تستی ${Object.keys(T).length+1}`,y=new _t({name:m,type:"online"});["علی رضایی","مریم حسینی","زهرا احمدی","رضا محمدی","فاطمه کریمی"].forEach(x=>y.addStudent(new nt({name:x}))),T[m]=y,k(),ae()}g(),b("کلاس تستی با موفقیت ساخته شد ✅!")},{confirmText:"بساز",confirmClass:"btn-success"}))}),Ot.addEventListener("click",()=>{ee(),Qe(null)}),ds.addEventListener("click",()=>{typeof Lt=="function"&&Lt(),ee(),Qe(null)}),Ht.addEventListener("click",()=>{ee(an)}),We.addEventListener("click",()=>{ee(sn)}),Y.addEventListener("click",()=>{u&&E&&(Re(),w("attendance-page"))}),B.addEventListener("click",()=>{if(Ce.value.trim()!==""||me.value.trim()!==""){b("⚠️لطفاً ابتدا با دکمه «ثبت»، تغییرات را ذخیره کنید و یا نمره و یادداشت را پاک کنید.");return}if(!u||!E||!re)return;const c=u.selectNextWinner(re.name,E);if(c){const g=E.studentRecords[c.identity.studentId];if(g&&g.attendance==="absent"&&c.statusCounters.missedChances++,g&&g.hadIssue){c.statusCounters.missedChances++;const y=re.name;c.categoryIssues[y]=(c.categoryIssues[y]||0)+1}const m={winner:c,categoryName:re.name};E.winnerHistory.push(m),E.winnerHistory.length>10&&E.winnerHistory.shift(),Te(E.winnerHistory.length-1),E.lastUsedCategoryId=re.id,E.lastSelectedWinnerId=c.identity.studentId,de(),Ie(),k()}else b("❌دانش‌آموز واجد شرایطی برای انتخاب یافت نشد.")}),R.addEventListener("click",()=>{if(!u)return;const c=M.value.trim(),g=yn.checked;if(!c){alert("⚠️لطفاً نام دسته‌بندی را وارد کنید.");return}const m=u.categories.find(L=>L.name.toLowerCase()===c.toLowerCase());if(m)if(m.isDeleted){const L=u.categories.findIndex(x=>x===m);L>-1&&u.categories.splice(L,1)}else{alert("⚠️این دسته‌بندی از قبل وجود دارد.");return}const y=new be(c,"",g);u.categories.push(y),k(),$(u.info.name,`دسته‌بندی جدید «${c}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),_e(),M.value="",yn.checked=!1}),M.addEventListener("keyup",c=>{c.key==="Enter"&&R.click()}),v.addEventListener("click",()=>{if(!Et){alert("❌خطایی رخ داده است. لطفاً فایل را دوباره انتخاب کنید."),w("settings-page");return}const c=parseInt(S.value,10),y=Et.split(`
`).slice(1).map(L=>{var N;return(N=L.split(",")[c])==null?void 0:N.trim()}).filter(L=>L&&L.length>0);y.length>0?(Ve(y),Xt(),w("csv-preview-page")):alert("هیچ نامی در ستون انتخاب شده پیدا نشد. لطفاً ستون دیگری را امتحان کنید یا فایل خود را بررسی کنید."),st(null)}),d.addEventListener("click",()=>{p.click()}),p.addEventListener("change",c=>{const g=c.target.files[0];if(!g)return;const m=new FileReader;m.onload=y=>{const L=y.target.result;st(L);const N=L.split(`
`)[0].split(",");ls(N),w("column-mapping-page")},m.readAsText(g),c.target.value=null}),I.addEventListener("click",()=>{st(null),w("settings-page")}),C.addEventListener("click",()=>{const c=f.querySelectorAll('input[type="checkbox"]:checked');let g=!1;c.forEach(m=>{const y=m.dataset.name,L=u.students.find(N=>N.identity.name.toLowerCase()===y.toLowerCase());if(L)if(L.isDeleted)Tt(L,u);else{console.log(`دانش‌آموز «${y}» به دلیل تکراری بودن اضافه نشد.`);return}const x=new nt({name:y});u.addStudent(x),u.sessions.length>0&&(Sn(x,u),g=!0)}),k(),$(u.info.name,`${c.length} دانش‌آموز جدید از لیست ورودی به کلاس اضافه شدند.`,{type:"VIEW_SESSIONS"}),ye(),g&&In(c.length),w("settings-page"),l.value="",Ve([])}),h.addEventListener("click",()=>{Ve([]),w("settings-page")}),r.addEventListener("click",()=>{const c=l.value.trim();if(!c){alert("کادر متنی خالی است. لطفاً اسامی را وارد کنید.");return}const g=c.split(`
`).map(m=>m.trim()).filter(m=>m.length>0);g.length>0?(Ve(g),Xt(),w("csv-preview-page")):alert("هیچ نام معتبری برای ورود پیدا نشد.")}),o.addEventListener("keyup",c=>{c.key==="Enter"&&i.click()}),i.addEventListener("click",()=>{if(!u)return;const c=o.value.trim();if(!c){alert("لطفاً نام دانش‌آموز را وارد کنید.");return}const g=u.students.find(y=>y.identity.name.toLowerCase()===c.toLowerCase());if(g)if(g.isDeleted)Tt(g,u);else{alert("❌دانش‌آموزی با این نام از قبل در این کلاس وجود دارد.");return}const m=new nt({name:c});u.addStudent(m),u.sessions.length>0&&(Sn(m,u),In(1)),k(),$(u.info.name,`دانش‌آموز «${c}» به کلاس اضافه شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:m.identity.studentId}),ye(),o.value="",o.focus()}),a.addEventListener("click",()=>{j(),w("session-page")}),document.getElementById("new-session-btn").addEventListener("click",()=>{if(u){const c=u.sessions.find(m=>!m.isFinished&&!m.isCancelled&&!m.isDeleted);if(c){b(`⚠️ جلسه ${c.sessionNumber} هنوز تمام نشده است. لطفاً ابتدا با دکمه ✅ آن را خاتمه دهید.`);return}const g=()=>{const m=y=>{const L=u.startNewSession();Ke(L),Q(L),u.students.forEach(Z=>{Yt.setAttendance(Z.identity.studentId,"present")}),k();const N=Ee(u).get(L.sessionNumber);$(u.info.name,`جلسه ${N} شروع شد.`,{type:"VIEW_SESSIONS"}),y?(Re(),w("attendance-page")):Ne()};F("آیا تمایل به انجام فرآیند حضور و غیاب دارید؟",()=>m(!0),{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success",onCancel:()=>m(!1)})};u.hasSessionToday()?F("شما امروز یک جلسه برای این کلاس ثبت کرده‌اید. آیا از شروع یک جلسه جدید دیگر مطمئن هستید؟",g,{confirmText:"بله",confirmClass:"btn-warning"}):g()}}),n.addEventListener("click",()=>{const c=t.value.trim(),g=document.querySelector('input[name="class-type"]:checked');if(!c&&!g){b("⚠️لطفاً نام و نوع کلاس را مشخص کنید.");return}if(!c){b("⚠️لطفاً نام کلاس را وارد کنید.");return}if(!g){b("⚠️لطفاً نوع کلاس را انتخاب کنید.");return}if(T[c])if(T[c].isDeleted)delete T[c];else{b("⚠️کلاسی با این نام از قبل وجود دارد.");return}const m=g.value,y=new _t({name:c,type:m});T[c]=y,k(),$(c,`کلاس «${c}» ایجاد شد.`,{type:"VIEW_SESSIONS"}),ae(),t.value="",g.checked=!1}),e.addEventListener("input",c=>{const g=c.target.value;if(g.length<2){Ct([]);return}const m=g.toLowerCase(),y=wn(m),L=[];for(const x in T){const N=T[x];if(N.isDeleted)continue;U(N.students).filter(V=>{const se=$e(V.identity.name.toLowerCase()),De=se.includes($e(m)),kn=se.includes($e(y));return De||kn}).forEach(V=>{L.push({student:V,classroom:N})})}Ct(L)}),t.addEventListener("keyup",c=>{c.key==="Enter"&&n.click()}),s.addEventListener("click",ts),document.querySelectorAll(".back-to-classes-btn").forEach(c=>{c.addEventListener("click",()=>{J(null),Q(null),Ke(null),w("class-management-page")})}),P.addEventListener("click",()=>{Ne()}),oe.addEventListener("click",()=>{j(),w("session-page")}),hs.addEventListener("click",()=>{if(q(null),!E&&u&&u.sessions.length>0){const c=U(u.sessions).filter(g=>!g.isCancelled);if(c.length>0){const g=c[c.length-1];Q(g)}else{j(),w("session-page");return}}Ne()}),Fe.addEventListener("input",c=>{const g=c.target.value;if(!g){je([]);return}const m=g.toLowerCase(),y=wn(m),x=U(u.students).filter(N=>{const Z=$e(N.identity.name.toLowerCase()),V=Z.includes($e(m)),se=Z.includes($e(y));return V||se});je(x)}),Fe.addEventListener("focus",()=>{Fe.value&&je(Fe.value)}),Pe.addEventListener("click",()=>{const c=Ce.value,g=me.value.trim();let m;if(It)m=It.student;else{const L=E==null?void 0:E.winnerHistory[ue];m=L==null?void 0:L.winner}if(!m){b("❌خطا: دانش‌آموز معتبری برای ثبت نمره یافت نشد.");return}const y=re;if(!m||!y){b("⚠️لطفاً ابتدا یک دانش‌آموز و یک دسته‌بندی را انتخاب کنید.");return}if(!c){b("⚠️لطفاً مقدار نمره را وارد کنید.");return}if(c>100||c<0){b("❌نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}m&&(m.addScore(y.name,parseFloat(c),g),$(u.info.name,`نمره ${c} در ${y.name} برای «${m.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:m.identity.studentId}),k(),de(),b(`✅نمره برای ${m.identity.name} در مهارت ${y.name} ثبت شد.`),Ce.value="",me.value="",Ie(m,y.name))});const vn=c=>{c.key==="Enter"&&c.ctrlKey&&(c.preventDefault(),Pe.click())};Ce.addEventListener("keydown",vn),me.addEventListener("keydown",vn),vs.addEventListener("click",()=>{const c=Cs.querySelector(".pill.active");if(!c){b("⚠️لطفاً یک مهارت را برای نمره‌دهی انتخاب کنید.");return}const g=c.dataset.skillName,m=ys.value,y=Es.value.trim();if(!m){b("لطفاً مقدار نمره را وارد کنید.");return}O.addScore(g,parseFloat(m),y),k(),$(u.info.name,`نمره ${m} در ${g} برای «${O.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:O.identity.studentId}),X(),b(`✅نمره برای مهارت ${g} با موفقیت ثبت شد.`)}),document.getElementById("add-note-btn").addEventListener("click",()=>{O&&(tt.value="",tt.dispatchEvent(new Event("input",{bubbles:!0})),pe(c=>{c&&(O.addNote(c),k(),$(u.info.name,`یادداشت جدیدی برای دانش‌آموز «${O.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:O.identity.studentId}),Ze())}),te("add-note-modal"),tt.focus())}),ms.addEventListener("click",()=>{ee()}),us.addEventListener("click",()=>{const c=tt.value.trim();typeof St=="function"&&(St(c),ee(),b("یادداشت برای کلاس ذخیره شد✅"))});const Ls=document.getElementById("move-student-confirm-btn"),Ss=document.getElementById("move-student-cancel-btn"),Is=document.getElementById("move-student-class-select");Ss.addEventListener("click",()=>{ee()}),Ls.addEventListener("click",()=>{const c=Is.value,g=T[c],{studentToMove:m,sourceClassForMove:y}=Ms;if(!m||!y||!g){b("خطایی رخ داد. لطفاً دوباره امتحان کنید⚠️.","error"),ee();return}const L=$n(m,y,g);L.success?($(y.info.name,`دانش‌آموز «${m.identity.name}» به کلاس «${c}» منتقل شد.`,{type:"VIEW_SESSIONS"}),$(c,`دانش‌آموز «${m.identity.name}» از کلاس «${y.info.name}» به این کلاس منتقل شد.`,{type:"VIEW_SESSIONS"}),k(),ye(),b(`دانش‌آموز «${m.identity.name}» با موفقیت به کلاس «${c}» منتقل شد✅.`)):b(L.message,"error"),ee()}),ie.addEventListener("click",()=>{ne.style.width="250px",_.classList.add("modal-visible")}),xe.addEventListener("click",ce),_.addEventListener("click",ce),bs.addEventListener("click",()=>{K(),w("trash-page"),ce()}),document.getElementById("demo-mode-btn").addEventListener("click",()=>{fe?Ln():(ce(),F("شما در حال ورود به حالت نمایش (Demo) هستید. در این حالت، هیچ‌کدام از تغییرات شما ذخیره نخواهد شد. آیا ادامه می‌دهید؟",()=>{Fn(),yt(),ce()},{confirmText:"تایید",confirmClass:"btn-warning",onCancel:ce}))});const bn=document.getElementById("exit-demo-btn");bn&&bn.addEventListener("click",()=>{fe&&Ln()}),W.addEventListener("click",()=>{if(fe){b("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است."),ce();return}ce(),Cn()}),z.addEventListener("click",()=>{if(fe){b("⚠️ بازیابی اطلاعات در حالت نمایش (Demo) غیرفعال است."),ce();return}ke.click(),ce()}),ke.addEventListener("change",c=>{const g=c.target.files[0];if(!g)return;const m=new FileReader;m.onload=y=>{try{const L=JSON.parse(y.target.result);F("آیا از بازیابی اطلاعات مطمئن هستید؟ تمام داده‌های فعلی شما بازنویسی خواهد شد.",()=>{Mt(L),k(),ae(),w("class-management-page"),b("✅اطلاعات با موفقیت بازیابی شد.")},{confirmText:"بازیابی کن",confirmClass:"btn-warning"})}catch{b("❌خطا در خواندن فایل. لطفاً فایل پشتیبان معتبر انتخاب کنید.")}},m.readAsText(g),c.target.value=null}),window.addEventListener("popstate",c=>{if(Le&&history.pushState(null,"",location.href),we(),c.state){const{pageId:g,currentClassName:m,selectedSessionNumber:y,selectedStudentId:L}=c.state;m&&(J(T[m]),y&&Q(u.getSession(y)),L&&q(u.students.find(x=>x.identity.studentId===L))),g==="student-page"?Ne():(g==="session-page"&&j(),Je(g))}else J(null),Q(null),q(null),Je("class-management-page")}),document.addEventListener("keydown",c=>{var y;const g=document.activeElement;if(!["INPUT","TEXTAREA","SELECT"].includes(g.tagName)){if(c.key.toLowerCase()==="o"&&c.shiftKey&&jn.classList.contains("active")&&(c.preventDefault(),Kn.click()),c.key==="Escape"){if(Be.classList.contains("visible")){we();return}if(Le){ee();return}switch((y=document.querySelector(".page.active"))==null?void 0:y.id){case"csv-preview-page":case"column-mapping-page":w("settings-page");break;case"student-profile-page":q(null),w(E?"student-page":"session-page");break;case"attendance-page":w("student-page");break;case"student-page":Q(null),j(),w("session-page");break;case"settings-page":case"session-page":J(null),w("class-management-page");break}return}if(E){const L=c.key.toLowerCase();switch(" ascfg".includes(L)&&c.preventDefault(),L){case" ":B.click();break;case"a":H.classList.contains("active")?history.back():(Re(),w("attendance-page"));break;case"s":document.getElementById("session-page").classList.contains("active")?history.back():a.click();break;case"c":document.querySelector(".back-to-classes-btn").click();break;case"f":const x=document.querySelector(".action-column .search-icon");x&&x.click();break;case"g":if(ps.classList.contains("active"))history.back();else{const N=E.lastSelectedWinnerId;if(N){const Z=u.students.find(V=>V.identity.studentId===N);Z&&(q(Z),X(),w("student-profile-page"))}else b("⚠️ابتدا یک نفر را انتخاب کنید تا پروفایل او نمایش داده شود.")}break;case"arrowleft":{const N=document.querySelector('button[title="برنده قبلی"]');N&&!N.disabled&&(c.preventDefault(),N.click());break}case"arrowright":{const N=document.querySelector('button[title="برنده بعدی"]');N&&!N.disabled&&(c.preventDefault(),N.click());break}}}}});function ce(){ne.style.width="0",_.classList.add("modal-closing"),setTimeout(()=>{_.classList.remove("modal-visible","modal-closing")},300)}function Ln(){F("آیا از خروج از حالت نمایش (Demo) مطمئن هستید؟ با خروج، تمام تغییرات آزمایشی شما حذف شده و داده‌های اصلی شما بازیابی خواهند شد.",()=>{Un(),J(null),Q(null),q(null),ae(),w("class-management-page"),yt(),ce()},{confirmText:"خروج",confirmClass:"btn-success"})}En(".global-search-container .animated-search-container",Ct),En(".action-column-header .animated-search-container",je),[A,mn,me,zn].forEach(c=>{c&&is(c)}),gs.addEventListener("click",()=>{pn(O,u)});function Sn(c,g){const m=U(g.students).filter(D=>D.identity.studentId!==c.identity.studentId);if(m.length===0)return;let y=0;const L=U(g.categories);L.forEach(D=>{const le=Math.max(0,...m.map(Ue=>Ue.categoryCounts[D.name]||0));c.categoryCounts[D.name]=le,y+=le}),c.statusCounters.totalSelections=y;const x=m.reduce((D,le)=>D+le.statusCounters.totalSelections,0),N=m.reduce((D,le)=>D+(le.statusCounters.missedChances||0),0),Z=x>0?N/x:0,V={};L.forEach(D=>{const le=m.reduce((At,Rt)=>At+(Rt.categoryCounts[D.name]||0),0),Ue=m.reduce((At,Rt)=>At+(Rt.categoryIssues[D.name]||0),0);V[D.name]=le>0?Ue/le:0}),c.statusCounters.missedChances=Math.round(c.statusCounters.totalSelections*Z),L.forEach(D=>{const le=c.categoryCounts[D.name]||0,Ue=V[D.name]||0;c.categoryIssues[D.name]=Math.round(le*Ue)});const se=U(g.sessions).filter(D=>!D.isCancelled&&D.isFinished);se.forEach(D=>{D.setAttendance(c.identity.studentId,"absent")});const De="📝 یادداشت خودکار سیستم",Bs=`این دانش‌آموز پس از جلسه شماره ${se.length} به کلاس اضافه شد. آمار پایه‌ای زیر برای حفظ تعادل الگوریتم انتخاب برای او ثبت گردید:`,Me=[];c.statusCounters.totalSelections>0&&Me.push(`کل انتخاب‌ها: ${c.statusCounters.totalSelections}`),c.statusCounters.missedChances>0&&Me.push(`فرصت‌های از دست رفته: ${c.statusCounters.missedChances}`);for(const D in c.categoryCounts)c.categoryCounts[D]>0&&Me.push(`انتخاب در «${D}»: ${c.categoryCounts[D]}`);for(const D in c.categoryIssues)c.categoryIssues[D]>0&&Me.push(`مشکل در «${D}»: ${c.categoryIssues[D]}`);if(Me.length>0){const D=`${De}
${Bs}

- ${Me.join(`
- `)}`;c.addNote(D)}}function In(c){const m=`چون این کلاس جلسات برگزار شده دارد، برای ${c>1?"دانش‌آموزان جدید":"دانش‌آموز جدید"} آمار پایه‌ای (متناسب با سایر دانش‌آموزان) ثبت شد تا در فرایند انتخاب اختلالی ایجاد نشود.`;F(m,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}const ks="5.0.2";document.getElementById("app-version").textContent=`نسخه ${ks}`;function ws(){console.log("Starting universal backfill for writing scores...");let c=0;for(const g in T){const m=T[g];if(m.isDeleted)continue;let y=0;U(m.students).forEach(x=>{const N=x.logs.scores;if(!(N&&N.writing&&N.writing.length>0)){let V=-1;for(const se in N)se!=="writing"&&N[se].forEach(De=>{De.value>V&&(V=De.value)});if(V>-1){const se=`Automatically assigned based on the highest score (${V}) from other skills.`;x.addScore("Writing",V,se),y++}}}),y>0&&(console.log(`Updated ${y} student(s) in class: ${m.info.name}.`),c+=y)}c>0?(k(),console.log(`Update complete. A total of ${c} student(s) were updated across all classes. Data saved.`),document.getElementById("student-page").classList.contains("active")&&de()):console.log("No students needed updating in any class.")}window.backfillWritingScoresForAll=ws;function Ns(){console.log("Starting backfill for 'outOfClassCount' and 'wasOutOfClass' properties...");let c=0,g=0;const m=localStorage.getItem("teacherAssistantData_v2");if(!m){console.log("No data found in localStorage. Nothing to do.");return}const y=JSON.parse(m);for(const L in y){const x=y[L];x.students&&x.students.forEach(N=>{N.statusCounters&&typeof N.statusCounters.outOfClassCount>"u"&&(N.statusCounters.outOfClassCount=0,c++)}),x.sessions&&x.sessions.forEach(N=>{if(N.studentRecords)for(const Z in N.studentRecords){const V=N.studentRecords[Z];typeof V.wasOutOfClass>"u"&&(V.wasOutOfClass=!1,g++)}})}localStorage.setItem("teacherAssistantData_v2",JSON.stringify(y)),console.log(`Backfill complete. Updated ${c} students and ${g} session records. Data saved.`),kt(),u&&de()}window.backfillExitCounters=Ns;function Ts(c){if(!c||!c.classroomName)return;const g=T[c.classroomName];if(!g){b("⚠️ کلاس مربوط به این گزارش یافت نشد.");return}J(g),ee(),setTimeout(()=>{switch(c.type){case"VIEW_STUDENT_PROFILE":{const m=g.students.find(y=>y.identity.studentId===c.studentId);m?(q(m),X(),w("student-profile-page")):b("⚠️ دانش‌آموز مورد نظر یافت نشد.");break}case"VIEW_TRASH":K(),w("trash-page");break;case"VIEW_SESSIONS":j(),w("session-page");break;case"VIEW_CLASS_NOTE":gn(g);break;case"VIEW_CLASS_SETTINGS":hn(g);break}},300)}});
