(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))c(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&c(i)}).observe(document,{childList:!0,subtree:!0});function e(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function c(r){if(r.ep)return;r.ep=!0;const n=e(r);fetch(r.href,n)}})();const hi={ili:{id:"ili",label:"کانون زبان ایران",levels:["Basic 1","Basic 2","Basic 3","Elementary 1","Elementary 2","Elementary 3","Pre-intermediate 1","Pre-intermediate 2","Pre-intermediate 3","Intermediate 1","Intermediate 2","Intermediate 3","High-intermediate 1","High-intermediate 2","High-intermediate 3","Advanced 1","Advanced 2","Advanced 3"]},school:{id:"school",label:"آموزش و پرورش",levels:["کلاس اول","کلاس دوم","کلاس سوم","کلاس چهارم","کلاس پنجم","کلاس ششم","کلاس هفتم","کلاس هشتم","کلاس نهم","کلاس دهم","کلاس یازدهم","کلاس دوازدهم"]},custom:{id:"custom",label:"سایر / آزاد",levels:[]}};class wn{constructor(a){this.identity={name:a.name,firstName:a.firstName||null,lastName:a.lastName||null,studentId:a.studentId||`id_${new Date().getTime()}_${Math.random()}`,branchName:a.branchName||null,ageGroup:a.ageGroup||"adult",level:a.level||null,contact:{social:a.socialContact||null,parent:a.parentContact||null}},this.isDeleted=!1,this.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0,outOfClassCount:0},this.categoryCounts={},this.categoryIssues={},this.qualitativeStats={},this.logs={parentContacts:[],scores:{},discipline:{},sessionHistory:{}},this.profile={notes:[],tags:[]},this.finalClassActivityScore=null,this.onboardingSession=null}addScore(a,e,c){if(e>100||e<0){console.log("نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}const r=a.toLowerCase();this.logs.scores[r]||(this.logs.scores[r]=[]);const n=new Ia(a,e,c);this.logs.scores[r].push(n)}addNote(a,e=null){const c=new xa(a,e);this.profile.notes.push(c)}getOverallAverageScore(){let a=0,e=0;for(const r in this.logs.scores)this.logs.scores[r].forEach(n=>{n.isDeleted||(a+=n.value,e++)});if(e===0)return null;const c=a/e;return Math.round(c*100)/100}}class Ia{constructor(a,e,c=""){this.id=`score_${new Date().getTime()}`,this.skill=a,this.value=e,this.timestamp=new Date,this.comment=c,this.isDeleted=!1}}class xa{constructor(a,e=null){this.id=`note_${new Date().getTime()}`,this.timestamp=new Date,this.content=a,this.isDeleted=!1,this.source=e}}class ds{constructor(a="complete",e=""){this.status=a,this.comment=e,this.timestamp=new Date}}class vi{constructor(a){this.sessionNumber=a,this.startTime=new Date,this.createdAt=new Date,this.note="",this.isDeleted=!1,this.endTime=null,this.isFinished=!1,this.isMakeup=!1,this.isCancelled=!1,this.studentRecords={},this.lastWinnerByCategory={},this.lastUsedCategoryId=null,this.lastSelectedWinnerId=null,this.winnerHistory=[]}end(){this.isFinished=!0,this.endTime=new Date}markAsMakeup(){this.isMakeup=!this.isMakeup}initializeStudentRecord(a){this.studentRecords[a]||(this.studentRecords[a]={attendance:"present",homework:new ds,selections:{},hadIssue:!1,wasOutOfClass:!1,performanceRatings:{}})}setAttendance(a,e){this.initializeStudentRecord(a),this.studentRecords[a].attendance=e}setHomeworkStatus(a,e){this.initializeStudentRecord(a),this.studentRecords[a].homework.status=e}selectNextWinner(a,e,c){if(!e||e.length===0)return console.log("هیچ دانش‌آموزی در کلاس برای انتخاب وجود ندارد."),null;const r=this.lastWinnerByCategory[a];let n=e.filter(u=>u.identity.studentId!==r&&!u.isDeleted);if(n.length===0&&(n=e),n.length===0)return null;const i=(u,f)=>u.categoryCounts[f]||0,s=Math.min(...n.map(u=>i(u,a))),o=n.filter(u=>i(u,a)===s);let l;if(o.length===1)l=o[0];else if(o.length>1){const u=c.filter(b=>!b.isDeleted&&b.name!==a).map(b=>b.name),f=o.map(b=>{const v=u.reduce((C,k)=>C+i(b,k),0);return{student:b,otherCategoriesTotal:v}}),y=Math.min(...f.map(b=>b.otherCategoriesTotal)),m=f.filter(b=>b.otherCategoriesTotal===y).map(b=>b.student);m.length===1?l=m[0]:l=m[Math.floor(Math.random()*m.length)]}else l=n[Math.floor(Math.random()*n.length)];const h=l.identity.studentId;this.initializeStudentRecord(h);const p=(this.studentRecords[h].selections[a]||0)+1;return this.studentRecords[h].selections[a]=p,l.statusCounters.totalSelections++,l.categoryCounts[a]=(l.categoryCounts[a]||0)+1,this.lastWinnerByCategory[a]=h,l}}class us{constructor(a){this.info={name:a.name||"NotNamed",teacherName:a.teacherName||null,type:a.type||"in-person",educationalSystem:a.educationalSystem||"custom",term:a.term||null,scheduleText:a.scheduleText||null,level:a.level||null,creationDate:a.creationDate?new Date(a.creationDate):new Date,scheduleCode:a.scheduleCode||`code_${new Date().getTime()}`,scheduleDays:a.scheduleDays||[],scheduleStartTime:a.scheduleStartTime||null,scheduleEndTime:a.scheduleEndTime||null},this.students=[],this.sessions=[],this.note="",this.isDeleted=!1,this.categories=[new mt("Vocabulary","Questions about words and meanings."),new mt("Grammar","Questions about sentence structure and rules."),new mt("Listening",void 0,!0),new mt("Speaking",void 0,!0),new mt("Reading",void 0,!0),new mt("Writing",void 0,!0)],this.futurePlans={}}addStudent(a){this.students.push(a)}removeStudent(a){this.students=this.students.filter(e=>e.identity.studentId!==a)}startNewSession(){const a=this.sessions.length+1,e=new vi(a);return this.sessions.push(e),e}endSpecificSession(a){const e=this.getSession(a);return e&&!e.isFinished?(e.end(),!0):!1}getSession(a){return this.sessions.find(e=>e.sessionNumber===a)}markAsMakeup(a){const e=this.getSession(a);e&&e.markAsMakeup()}planForSession(a,e){this.futurePlans[a]=e}hasSessionToday(){const a=new Date().toDateString();return this.sessions.some(e=>!e.isDeleted&&e.startTime.toDateString()===a)}selectNextWinner(a,e){return e?e.selectNextWinner(a,this.students,this.categories):null}get liveSession(){for(let a=this.sessions.length-1;a>=0;a--)if(!this.sessions[a].isFinished)return this.sessions[a];return null}endLiveSession(){const a=this.liveSession;return a?(a.end(),!0):!1}calculateFinalStudentScore(a){const e=a.logs.scores,c=["reading","writing"];for(const u of c)if(!e[u]||e[u].length===0)return null;const r=e.listening&&e.listening.length>0,n=e.speaking&&e.speaking.length>0;if(!r&&!n)return null;const i=u=>e[u].reduce((y,m)=>y+m.value,0)/e[u].length;let s;r&&n?s=(i("listening")+i("speaking"))/2:r?s=i("listening"):s=i("speaking");const o=i("reading"),l=i("writing"),p=(s*3+o*2+l*1)/6;return Math.trunc(p*10)/10}assignAllFinalScores(){let a=0,e=[];console.log("شروع عملیات محاسبه نمره نهایی برای تمام دانش‌آموزان..."),this.students.forEach(r=>{const n=this.calculateFinalStudentScore(r);n!==null?(r.finalClassActivityScore=n,a++):(r.finalClassActivityScore=null,e.push(r.identity.name))});const c=e.length;console.log(`عملیات پایان یافت. تعداد نمرات موفق: ${a} | تعداد ناموفق (نمرات ناقص): ${c}`),c>0&&(console.log("اسامی دانش‌آموزانی که نمراتشان ناقص است:"),e.forEach(r=>console.log(`- ${r}`)))}}class mt{constructor(a,e="",c=!1){this.id=`cat_${new Date().getTime()}_${Math.random()}`,this.name=a,this.description=e,this.isDeleted=!1,this.isGradedCategory=c,this.isDeleted=!1}}var bn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function bi(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function Cn(t){throw new Error('Could not dynamically require "'+t+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Ci={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/(function(t,a){(function(e){t.exports=e()})(function(){return function e(c,r,n){function i(l,h){if(!r[l]){if(!c[l]){var p=typeof Cn=="function"&&Cn;if(!h&&p)return p(l,!0);if(s)return s(l,!0);var u=new Error("Cannot find module '"+l+"'");throw u.code="MODULE_NOT_FOUND",u}var f=r[l]={exports:{}};c[l][0].call(f.exports,function(y){var m=c[l][1][y];return i(m||y)},f,f.exports,e,c,r,n)}return r[l].exports}for(var s=typeof Cn=="function"&&Cn,o=0;o<n.length;o++)i(n[o]);return i}({1:[function(e,c,r){var n=e("./utils"),i=e("./support"),s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";r.encode=function(o){for(var l,h,p,u,f,y,m,b=[],v=0,C=o.length,k=C,_=n.getTypeOf(o)!=="string";v<o.length;)k=C-v,p=_?(l=o[v++],h=v<C?o[v++]:0,v<C?o[v++]:0):(l=o.charCodeAt(v++),h=v<C?o.charCodeAt(v++):0,v<C?o.charCodeAt(v++):0),u=l>>2,f=(3&l)<<4|h>>4,y=1<k?(15&h)<<2|p>>6:64,m=2<k?63&p:64,b.push(s.charAt(u)+s.charAt(f)+s.charAt(y)+s.charAt(m));return b.join("")},r.decode=function(o){var l,h,p,u,f,y,m=0,b=0,v="data:";if(o.substr(0,v.length)===v)throw new Error("Invalid base64 input, it looks like a data url.");var C,k=3*(o=o.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(o.charAt(o.length-1)===s.charAt(64)&&k--,o.charAt(o.length-2)===s.charAt(64)&&k--,k%1!=0)throw new Error("Invalid base64 input, bad content length.");for(C=i.uint8array?new Uint8Array(0|k):new Array(0|k);m<o.length;)l=s.indexOf(o.charAt(m++))<<2|(u=s.indexOf(o.charAt(m++)))>>4,h=(15&u)<<4|(f=s.indexOf(o.charAt(m++)))>>2,p=(3&f)<<6|(y=s.indexOf(o.charAt(m++))),C[b++]=l,f!==64&&(C[b++]=h),y!==64&&(C[b++]=p);return C}},{"./support":30,"./utils":32}],2:[function(e,c,r){var n=e("./external"),i=e("./stream/DataWorker"),s=e("./stream/Crc32Probe"),o=e("./stream/DataLengthProbe");function l(h,p,u,f,y){this.compressedSize=h,this.uncompressedSize=p,this.crc32=u,this.compression=f,this.compressedContent=y}l.prototype={getContentWorker:function(){var h=new i(n.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new o("data_length")),p=this;return h.on("end",function(){if(this.streamInfo.data_length!==p.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),h},getCompressedWorker:function(){return new i(n.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},l.createWorkerFrom=function(h,p,u){return h.pipe(new s).pipe(new o("uncompressedSize")).pipe(p.compressWorker(u)).pipe(new o("compressedSize")).withStreamInfo("compression",p)},c.exports=l},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,c,r){var n=e("./stream/GenericWorker");r.STORE={magic:"\0\0",compressWorker:function(){return new n("STORE compression")},uncompressWorker:function(){return new n("STORE decompression")}},r.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,c,r){var n=e("./utils"),i=function(){for(var s,o=[],l=0;l<256;l++){s=l;for(var h=0;h<8;h++)s=1&s?3988292384^s>>>1:s>>>1;o[l]=s}return o}();c.exports=function(s,o){return s!==void 0&&s.length?n.getTypeOf(s)!=="string"?function(l,h,p,u){var f=i,y=u+p;l^=-1;for(var m=u;m<y;m++)l=l>>>8^f[255&(l^h[m])];return-1^l}(0|o,s,s.length,0):function(l,h,p,u){var f=i,y=u+p;l^=-1;for(var m=u;m<y;m++)l=l>>>8^f[255&(l^h.charCodeAt(m))];return-1^l}(0|o,s,s.length,0):0}},{"./utils":32}],5:[function(e,c,r){r.base64=!1,r.binary=!1,r.dir=!1,r.createFolders=!0,r.date=null,r.compression=null,r.compressionOptions=null,r.comment=null,r.unixPermissions=null,r.dosPermissions=null},{}],6:[function(e,c,r){var n=null;n=typeof Promise<"u"?Promise:e("lie"),c.exports={Promise:n}},{lie:37}],7:[function(e,c,r){var n=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",i=e("pako"),s=e("./utils"),o=e("./stream/GenericWorker"),l=n?"uint8array":"array";function h(p,u){o.call(this,"FlateWorker/"+p),this._pako=null,this._pakoAction=p,this._pakoOptions=u,this.meta={}}r.magic="\b\0",s.inherits(h,o),h.prototype.processChunk=function(p){this.meta=p.meta,this._pako===null&&this._createPako(),this._pako.push(s.transformTo(l,p.data),!1)},h.prototype.flush=function(){o.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},h.prototype.cleanUp=function(){o.prototype.cleanUp.call(this),this._pako=null},h.prototype._createPako=function(){this._pako=new i[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var p=this;this._pako.onData=function(u){p.push({data:u,meta:p.meta})}},r.compressWorker=function(p){return new h("Deflate",p)},r.uncompressWorker=function(){return new h("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(e,c,r){function n(f,y){var m,b="";for(m=0;m<y;m++)b+=String.fromCharCode(255&f),f>>>=8;return b}function i(f,y,m,b,v,C){var k,_,I=f.file,x=f.compression,L=C!==l.utf8encode,N=s.transformTo("string",C(I.name)),R=s.transformTo("string",l.utf8encode(I.name)),P=I.comment,ee=s.transformTo("string",C(P)),S=s.transformTo("string",l.utf8encode(P)),z=R.length!==I.name.length,g=S.length!==P.length,H="",fe="",q="",me=I.dir,F=I.date,se={crc32:0,compressedSize:0,uncompressedSize:0};y&&!m||(se.crc32=f.crc32,se.compressedSize=f.compressedSize,se.uncompressedSize=f.uncompressedSize);var O=0;y&&(O|=8),L||!z&&!g||(O|=2048);var M=0,le=0;me&&(M|=16),v==="UNIX"?(le=798,M|=function(Q,Be){var Ae=Q;return Q||(Ae=Be?16893:33204),(65535&Ae)<<16}(I.unixPermissions,me)):(le=20,M|=function(Q){return 63&(Q||0)}(I.dosPermissions)),k=F.getUTCHours(),k<<=6,k|=F.getUTCMinutes(),k<<=5,k|=F.getUTCSeconds()/2,_=F.getUTCFullYear()-1980,_<<=4,_|=F.getUTCMonth()+1,_<<=5,_|=F.getUTCDate(),z&&(fe=n(1,1)+n(h(N),4)+R,H+="up"+n(fe.length,2)+fe),g&&(q=n(1,1)+n(h(ee),4)+S,H+="uc"+n(q.length,2)+q);var ne="";return ne+=`
\0`,ne+=n(O,2),ne+=x.magic,ne+=n(k,2),ne+=n(_,2),ne+=n(se.crc32,4),ne+=n(se.compressedSize,4),ne+=n(se.uncompressedSize,4),ne+=n(N.length,2),ne+=n(H.length,2),{fileRecord:p.LOCAL_FILE_HEADER+ne+N+H,dirRecord:p.CENTRAL_FILE_HEADER+n(le,2)+ne+n(ee.length,2)+"\0\0\0\0"+n(M,4)+n(b,4)+N+H+ee}}var s=e("../utils"),o=e("../stream/GenericWorker"),l=e("../utf8"),h=e("../crc32"),p=e("../signature");function u(f,y,m,b){o.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=y,this.zipPlatform=m,this.encodeFileName=b,this.streamFiles=f,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}s.inherits(u,o),u.prototype.push=function(f){var y=f.meta.percent||0,m=this.entriesCount,b=this._sources.length;this.accumulate?this.contentBuffer.push(f):(this.bytesWritten+=f.data.length,o.prototype.push.call(this,{data:f.data,meta:{currentFile:this.currentFile,percent:m?(y+100*(m-b-1))/m:100}}))},u.prototype.openedSource=function(f){this.currentSourceOffset=this.bytesWritten,this.currentFile=f.file.name;var y=this.streamFiles&&!f.file.dir;if(y){var m=i(f,y,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:m.fileRecord,meta:{percent:0}})}else this.accumulate=!0},u.prototype.closedSource=function(f){this.accumulate=!1;var y=this.streamFiles&&!f.file.dir,m=i(f,y,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(m.dirRecord),y)this.push({data:function(b){return p.DATA_DESCRIPTOR+n(b.crc32,4)+n(b.compressedSize,4)+n(b.uncompressedSize,4)}(f),meta:{percent:100}});else for(this.push({data:m.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},u.prototype.flush=function(){for(var f=this.bytesWritten,y=0;y<this.dirRecords.length;y++)this.push({data:this.dirRecords[y],meta:{percent:100}});var m=this.bytesWritten-f,b=function(v,C,k,_,I){var x=s.transformTo("string",I(_));return p.CENTRAL_DIRECTORY_END+"\0\0\0\0"+n(v,2)+n(v,2)+n(C,4)+n(k,4)+n(x.length,2)+x}(this.dirRecords.length,m,f,this.zipComment,this.encodeFileName);this.push({data:b,meta:{percent:100}})},u.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},u.prototype.registerPrevious=function(f){this._sources.push(f);var y=this;return f.on("data",function(m){y.processChunk(m)}),f.on("end",function(){y.closedSource(y.previous.streamInfo),y._sources.length?y.prepareNextSource():y.end()}),f.on("error",function(m){y.error(m)}),this},u.prototype.resume=function(){return!!o.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},u.prototype.error=function(f){var y=this._sources;if(!o.prototype.error.call(this,f))return!1;for(var m=0;m<y.length;m++)try{y[m].error(f)}catch{}return!0},u.prototype.lock=function(){o.prototype.lock.call(this);for(var f=this._sources,y=0;y<f.length;y++)f[y].lock()},c.exports=u},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,c,r){var n=e("../compressions"),i=e("./ZipFileWorker");r.generateWorker=function(s,o,l){var h=new i(o.streamFiles,l,o.platform,o.encodeFileName),p=0;try{s.forEach(function(u,f){p++;var y=function(C,k){var _=C||k,I=n[_];if(!I)throw new Error(_+" is not a valid compression method !");return I}(f.options.compression,o.compression),m=f.options.compressionOptions||o.compressionOptions||{},b=f.dir,v=f.date;f._compressWorker(y,m).withStreamInfo("file",{name:u,dir:b,date:v,comment:f.comment||"",unixPermissions:f.unixPermissions,dosPermissions:f.dosPermissions}).pipe(h)}),h.entriesCount=p}catch(u){h.error(u)}return h}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,c,r){function n(){if(!(this instanceof n))return new n;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var i=new n;for(var s in this)typeof this[s]!="function"&&(i[s]=this[s]);return i}}(n.prototype=e("./object")).loadAsync=e("./load"),n.support=e("./support"),n.defaults=e("./defaults"),n.version="3.10.1",n.loadAsync=function(i,s){return new n().loadAsync(i,s)},n.external=e("./external"),c.exports=n},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,c,r){var n=e("./utils"),i=e("./external"),s=e("./utf8"),o=e("./zipEntries"),l=e("./stream/Crc32Probe"),h=e("./nodejsUtils");function p(u){return new i.Promise(function(f,y){var m=u.decompressed.getContentWorker().pipe(new l);m.on("error",function(b){y(b)}).on("end",function(){m.streamInfo.crc32!==u.decompressed.crc32?y(new Error("Corrupted zip : CRC32 mismatch")):f()}).resume()})}c.exports=function(u,f){var y=this;return f=n.extend(f||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:s.utf8decode}),h.isNode&&h.isStream(u)?i.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):n.prepareContent("the loaded zip file",u,!0,f.optimizedBinaryString,f.base64).then(function(m){var b=new o(f);return b.load(m),b}).then(function(m){var b=[i.Promise.resolve(m)],v=m.files;if(f.checkCRC32)for(var C=0;C<v.length;C++)b.push(p(v[C]));return i.Promise.all(b)}).then(function(m){for(var b=m.shift(),v=b.files,C=0;C<v.length;C++){var k=v[C],_=k.fileNameStr,I=n.resolve(k.fileNameStr);y.file(I,k.decompressed,{binary:!0,optimizedBinaryString:!0,date:k.date,dir:k.dir,comment:k.fileCommentStr.length?k.fileCommentStr:null,unixPermissions:k.unixPermissions,dosPermissions:k.dosPermissions,createFolders:f.createFolders}),k.dir||(y.file(I).unsafeOriginalName=_)}return b.zipComment.length&&(y.comment=b.zipComment),y})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,c,r){var n=e("../utils"),i=e("../stream/GenericWorker");function s(o,l){i.call(this,"Nodejs stream input adapter for "+o),this._upstreamEnded=!1,this._bindStream(l)}n.inherits(s,i),s.prototype._bindStream=function(o){var l=this;(this._stream=o).pause(),o.on("data",function(h){l.push({data:h,meta:{percent:0}})}).on("error",function(h){l.isPaused?this.generatedError=h:l.error(h)}).on("end",function(){l.isPaused?l._upstreamEnded=!0:l.end()})},s.prototype.pause=function(){return!!i.prototype.pause.call(this)&&(this._stream.pause(),!0)},s.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},c.exports=s},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,c,r){var n=e("readable-stream").Readable;function i(s,o,l){n.call(this,o),this._helper=s;var h=this;s.on("data",function(p,u){h.push(p)||h._helper.pause(),l&&l(u)}).on("error",function(p){h.emit("error",p)}).on("end",function(){h.push(null)})}e("../utils").inherits(i,n),i.prototype._read=function(){this._helper.resume()},c.exports=i},{"../utils":32,"readable-stream":16}],14:[function(e,c,r){c.exports={isNode:typeof Buffer<"u",newBufferFrom:function(n,i){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(n,i);if(typeof n=="number")throw new Error('The "data" argument must not be a number');return new Buffer(n,i)},allocBuffer:function(n){if(Buffer.alloc)return Buffer.alloc(n);var i=new Buffer(n);return i.fill(0),i},isBuffer:function(n){return Buffer.isBuffer(n)},isStream:function(n){return n&&typeof n.on=="function"&&typeof n.pause=="function"&&typeof n.resume=="function"}}},{}],15:[function(e,c,r){function n(I,x,L){var N,R=s.getTypeOf(x),P=s.extend(L||{},h);P.date=P.date||new Date,P.compression!==null&&(P.compression=P.compression.toUpperCase()),typeof P.unixPermissions=="string"&&(P.unixPermissions=parseInt(P.unixPermissions,8)),P.unixPermissions&&16384&P.unixPermissions&&(P.dir=!0),P.dosPermissions&&16&P.dosPermissions&&(P.dir=!0),P.dir&&(I=v(I)),P.createFolders&&(N=b(I))&&C.call(this,N,!0);var ee=R==="string"&&P.binary===!1&&P.base64===!1;L&&L.binary!==void 0||(P.binary=!ee),(x instanceof p&&x.uncompressedSize===0||P.dir||!x||x.length===0)&&(P.base64=!1,P.binary=!0,x="",P.compression="STORE",R="string");var S=null;S=x instanceof p||x instanceof o?x:y.isNode&&y.isStream(x)?new m(I,x):s.prepareContent(I,x,P.binary,P.optimizedBinaryString,P.base64);var z=new u(I,S,P);this.files[I]=z}var i=e("./utf8"),s=e("./utils"),o=e("./stream/GenericWorker"),l=e("./stream/StreamHelper"),h=e("./defaults"),p=e("./compressedObject"),u=e("./zipObject"),f=e("./generate"),y=e("./nodejsUtils"),m=e("./nodejs/NodejsStreamInputAdapter"),b=function(I){I.slice(-1)==="/"&&(I=I.substring(0,I.length-1));var x=I.lastIndexOf("/");return 0<x?I.substring(0,x):""},v=function(I){return I.slice(-1)!=="/"&&(I+="/"),I},C=function(I,x){return x=x!==void 0?x:h.createFolders,I=v(I),this.files[I]||n.call(this,I,null,{dir:!0,createFolders:x}),this.files[I]};function k(I){return Object.prototype.toString.call(I)==="[object RegExp]"}var _={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(I){var x,L,N;for(x in this.files)N=this.files[x],(L=x.slice(this.root.length,x.length))&&x.slice(0,this.root.length)===this.root&&I(L,N)},filter:function(I){var x=[];return this.forEach(function(L,N){I(L,N)&&x.push(N)}),x},file:function(I,x,L){if(arguments.length!==1)return I=this.root+I,n.call(this,I,x,L),this;if(k(I)){var N=I;return this.filter(function(P,ee){return!ee.dir&&N.test(P)})}var R=this.files[this.root+I];return R&&!R.dir?R:null},folder:function(I){if(!I)return this;if(k(I))return this.filter(function(R,P){return P.dir&&I.test(R)});var x=this.root+I,L=C.call(this,x),N=this.clone();return N.root=L.name,N},remove:function(I){I=this.root+I;var x=this.files[I];if(x||(I.slice(-1)!=="/"&&(I+="/"),x=this.files[I]),x&&!x.dir)delete this.files[I];else for(var L=this.filter(function(R,P){return P.name.slice(0,I.length)===I}),N=0;N<L.length;N++)delete this.files[L[N].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(I){var x,L={};try{if((L=s.extend(I||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:i.utf8encode})).type=L.type.toLowerCase(),L.compression=L.compression.toUpperCase(),L.type==="binarystring"&&(L.type="string"),!L.type)throw new Error("No output type specified.");s.checkSupport(L.type),L.platform!=="darwin"&&L.platform!=="freebsd"&&L.platform!=="linux"&&L.platform!=="sunos"||(L.platform="UNIX"),L.platform==="win32"&&(L.platform="DOS");var N=L.comment||this.comment||"";x=f.generateWorker(this,L,N)}catch(R){(x=new o("error")).error(R)}return new l(x,L.type||"string",L.mimeType)},generateAsync:function(I,x){return this.generateInternalStream(I).accumulate(x)},generateNodeStream:function(I,x){return(I=I||{}).type||(I.type="nodebuffer"),this.generateInternalStream(I).toNodejsStream(x)}};c.exports=_},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,c,r){c.exports=e("stream")},{stream:void 0}],17:[function(e,c,r){var n=e("./DataReader");function i(s){n.call(this,s);for(var o=0;o<this.data.length;o++)s[o]=255&s[o]}e("../utils").inherits(i,n),i.prototype.byteAt=function(s){return this.data[this.zero+s]},i.prototype.lastIndexOfSignature=function(s){for(var o=s.charCodeAt(0),l=s.charCodeAt(1),h=s.charCodeAt(2),p=s.charCodeAt(3),u=this.length-4;0<=u;--u)if(this.data[u]===o&&this.data[u+1]===l&&this.data[u+2]===h&&this.data[u+3]===p)return u-this.zero;return-1},i.prototype.readAndCheckSignature=function(s){var o=s.charCodeAt(0),l=s.charCodeAt(1),h=s.charCodeAt(2),p=s.charCodeAt(3),u=this.readData(4);return o===u[0]&&l===u[1]&&h===u[2]&&p===u[3]},i.prototype.readData=function(s){if(this.checkOffset(s),s===0)return[];var o=this.data.slice(this.zero+this.index,this.zero+this.index+s);return this.index+=s,o},c.exports=i},{"../utils":32,"./DataReader":18}],18:[function(e,c,r){var n=e("../utils");function i(s){this.data=s,this.length=s.length,this.index=0,this.zero=0}i.prototype={checkOffset:function(s){this.checkIndex(this.index+s)},checkIndex:function(s){if(this.length<this.zero+s||s<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+s+"). Corrupted zip ?")},setIndex:function(s){this.checkIndex(s),this.index=s},skip:function(s){this.setIndex(this.index+s)},byteAt:function(){},readInt:function(s){var o,l=0;for(this.checkOffset(s),o=this.index+s-1;o>=this.index;o--)l=(l<<8)+this.byteAt(o);return this.index+=s,l},readString:function(s){return n.transformTo("string",this.readData(s))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var s=this.readInt(4);return new Date(Date.UTC(1980+(s>>25&127),(s>>21&15)-1,s>>16&31,s>>11&31,s>>5&63,(31&s)<<1))}},c.exports=i},{"../utils":32}],19:[function(e,c,r){var n=e("./Uint8ArrayReader");function i(s){n.call(this,s)}e("../utils").inherits(i,n),i.prototype.readData=function(s){this.checkOffset(s);var o=this.data.slice(this.zero+this.index,this.zero+this.index+s);return this.index+=s,o},c.exports=i},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,c,r){var n=e("./DataReader");function i(s){n.call(this,s)}e("../utils").inherits(i,n),i.prototype.byteAt=function(s){return this.data.charCodeAt(this.zero+s)},i.prototype.lastIndexOfSignature=function(s){return this.data.lastIndexOf(s)-this.zero},i.prototype.readAndCheckSignature=function(s){return s===this.readData(4)},i.prototype.readData=function(s){this.checkOffset(s);var o=this.data.slice(this.zero+this.index,this.zero+this.index+s);return this.index+=s,o},c.exports=i},{"../utils":32,"./DataReader":18}],21:[function(e,c,r){var n=e("./ArrayReader");function i(s){n.call(this,s)}e("../utils").inherits(i,n),i.prototype.readData=function(s){if(this.checkOffset(s),s===0)return new Uint8Array(0);var o=this.data.subarray(this.zero+this.index,this.zero+this.index+s);return this.index+=s,o},c.exports=i},{"../utils":32,"./ArrayReader":17}],22:[function(e,c,r){var n=e("../utils"),i=e("../support"),s=e("./ArrayReader"),o=e("./StringReader"),l=e("./NodeBufferReader"),h=e("./Uint8ArrayReader");c.exports=function(p){var u=n.getTypeOf(p);return n.checkSupport(u),u!=="string"||i.uint8array?u==="nodebuffer"?new l(p):i.uint8array?new h(n.transformTo("uint8array",p)):new s(n.transformTo("array",p)):new o(p)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,c,r){r.LOCAL_FILE_HEADER="PK",r.CENTRAL_FILE_HEADER="PK",r.CENTRAL_DIRECTORY_END="PK",r.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",r.ZIP64_CENTRAL_DIRECTORY_END="PK",r.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(e,c,r){var n=e("./GenericWorker"),i=e("../utils");function s(o){n.call(this,"ConvertWorker to "+o),this.destType=o}i.inherits(s,n),s.prototype.processChunk=function(o){this.push({data:i.transformTo(this.destType,o.data),meta:o.meta})},c.exports=s},{"../utils":32,"./GenericWorker":28}],25:[function(e,c,r){var n=e("./GenericWorker"),i=e("../crc32");function s(){n.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}e("../utils").inherits(s,n),s.prototype.processChunk=function(o){this.streamInfo.crc32=i(o.data,this.streamInfo.crc32||0),this.push(o)},c.exports=s},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,c,r){var n=e("../utils"),i=e("./GenericWorker");function s(o){i.call(this,"DataLengthProbe for "+o),this.propName=o,this.withStreamInfo(o,0)}n.inherits(s,i),s.prototype.processChunk=function(o){if(o){var l=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=l+o.data.length}i.prototype.processChunk.call(this,o)},c.exports=s},{"../utils":32,"./GenericWorker":28}],27:[function(e,c,r){var n=e("../utils"),i=e("./GenericWorker");function s(o){i.call(this,"DataWorker");var l=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,o.then(function(h){l.dataIsReady=!0,l.data=h,l.max=h&&h.length||0,l.type=n.getTypeOf(h),l.isPaused||l._tickAndRepeat()},function(h){l.error(h)})}n.inherits(s,i),s.prototype.cleanUp=function(){i.prototype.cleanUp.call(this),this.data=null},s.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,n.delay(this._tickAndRepeat,[],this)),!0)},s.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(n.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},s.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var o=null,l=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":o=this.data.substring(this.index,l);break;case"uint8array":o=this.data.subarray(this.index,l);break;case"array":case"nodebuffer":o=this.data.slice(this.index,l)}return this.index=l,this.push({data:o,meta:{percent:this.max?this.index/this.max*100:0}})},c.exports=s},{"../utils":32,"./GenericWorker":28}],28:[function(e,c,r){function n(i){this.name=i||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}n.prototype={push:function(i){this.emit("data",i)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(i){this.emit("error",i)}return!0},error:function(i){return!this.isFinished&&(this.isPaused?this.generatedError=i:(this.isFinished=!0,this.emit("error",i),this.previous&&this.previous.error(i),this.cleanUp()),!0)},on:function(i,s){return this._listeners[i].push(s),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(i,s){if(this._listeners[i])for(var o=0;o<this._listeners[i].length;o++)this._listeners[i][o].call(this,s)},pipe:function(i){return i.registerPrevious(this)},registerPrevious:function(i){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=i.streamInfo,this.mergeStreamInfo(),this.previous=i;var s=this;return i.on("data",function(o){s.processChunk(o)}),i.on("end",function(){s.end()}),i.on("error",function(o){s.error(o)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var i=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),i=!0),this.previous&&this.previous.resume(),!i},flush:function(){},processChunk:function(i){this.push(i)},withStreamInfo:function(i,s){return this.extraStreamInfo[i]=s,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var i in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,i)&&(this.streamInfo[i]=this.extraStreamInfo[i])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var i="Worker "+this.name;return this.previous?this.previous+" -> "+i:i}},c.exports=n},{}],29:[function(e,c,r){var n=e("../utils"),i=e("./ConvertWorker"),s=e("./GenericWorker"),o=e("../base64"),l=e("../support"),h=e("../external"),p=null;if(l.nodestream)try{p=e("../nodejs/NodejsStreamOutputAdapter")}catch{}function u(y,m){return new h.Promise(function(b,v){var C=[],k=y._internalType,_=y._outputType,I=y._mimeType;y.on("data",function(x,L){C.push(x),m&&m(L)}).on("error",function(x){C=[],v(x)}).on("end",function(){try{var x=function(L,N,R){switch(L){case"blob":return n.newBlob(n.transformTo("arraybuffer",N),R);case"base64":return o.encode(N);default:return n.transformTo(L,N)}}(_,function(L,N){var R,P=0,ee=null,S=0;for(R=0;R<N.length;R++)S+=N[R].length;switch(L){case"string":return N.join("");case"array":return Array.prototype.concat.apply([],N);case"uint8array":for(ee=new Uint8Array(S),R=0;R<N.length;R++)ee.set(N[R],P),P+=N[R].length;return ee;case"nodebuffer":return Buffer.concat(N);default:throw new Error("concat : unsupported type '"+L+"'")}}(k,C),I);b(x)}catch(L){v(L)}C=[]}).resume()})}function f(y,m,b){var v=m;switch(m){case"blob":case"arraybuffer":v="uint8array";break;case"base64":v="string"}try{this._internalType=v,this._outputType=m,this._mimeType=b,n.checkSupport(v),this._worker=y.pipe(new i(v)),y.lock()}catch(C){this._worker=new s("error"),this._worker.error(C)}}f.prototype={accumulate:function(y){return u(this,y)},on:function(y,m){var b=this;return y==="data"?this._worker.on(y,function(v){m.call(b,v.data,v.meta)}):this._worker.on(y,function(){n.delay(m,arguments,b)}),this},resume:function(){return n.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(y){if(n.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new p(this,{objectMode:this._outputType!=="nodebuffer"},y)}},c.exports=f},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,c,r){if(r.base64=!0,r.array=!0,r.string=!0,r.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",r.nodebuffer=typeof Buffer<"u",r.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")r.blob=!1;else{var n=new ArrayBuffer(0);try{r.blob=new Blob([n],{type:"application/zip"}).size===0}catch{try{var i=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);i.append(n),r.blob=i.getBlob("application/zip").size===0}catch{r.blob=!1}}}try{r.nodestream=!!e("readable-stream").Readable}catch{r.nodestream=!1}},{"readable-stream":16}],31:[function(e,c,r){for(var n=e("./utils"),i=e("./support"),s=e("./nodejsUtils"),o=e("./stream/GenericWorker"),l=new Array(256),h=0;h<256;h++)l[h]=252<=h?6:248<=h?5:240<=h?4:224<=h?3:192<=h?2:1;l[254]=l[254]=1;function p(){o.call(this,"utf-8 decode"),this.leftOver=null}function u(){o.call(this,"utf-8 encode")}r.utf8encode=function(f){return i.nodebuffer?s.newBufferFrom(f,"utf-8"):function(y){var m,b,v,C,k,_=y.length,I=0;for(C=0;C<_;C++)(64512&(b=y.charCodeAt(C)))==55296&&C+1<_&&(64512&(v=y.charCodeAt(C+1)))==56320&&(b=65536+(b-55296<<10)+(v-56320),C++),I+=b<128?1:b<2048?2:b<65536?3:4;for(m=i.uint8array?new Uint8Array(I):new Array(I),C=k=0;k<I;C++)(64512&(b=y.charCodeAt(C)))==55296&&C+1<_&&(64512&(v=y.charCodeAt(C+1)))==56320&&(b=65536+(b-55296<<10)+(v-56320),C++),b<128?m[k++]=b:(b<2048?m[k++]=192|b>>>6:(b<65536?m[k++]=224|b>>>12:(m[k++]=240|b>>>18,m[k++]=128|b>>>12&63),m[k++]=128|b>>>6&63),m[k++]=128|63&b);return m}(f)},r.utf8decode=function(f){return i.nodebuffer?n.transformTo("nodebuffer",f).toString("utf-8"):function(y){var m,b,v,C,k=y.length,_=new Array(2*k);for(m=b=0;m<k;)if((v=y[m++])<128)_[b++]=v;else if(4<(C=l[v]))_[b++]=65533,m+=C-1;else{for(v&=C===2?31:C===3?15:7;1<C&&m<k;)v=v<<6|63&y[m++],C--;1<C?_[b++]=65533:v<65536?_[b++]=v:(v-=65536,_[b++]=55296|v>>10&1023,_[b++]=56320|1023&v)}return _.length!==b&&(_.subarray?_=_.subarray(0,b):_.length=b),n.applyFromCharCode(_)}(f=n.transformTo(i.uint8array?"uint8array":"array",f))},n.inherits(p,o),p.prototype.processChunk=function(f){var y=n.transformTo(i.uint8array?"uint8array":"array",f.data);if(this.leftOver&&this.leftOver.length){if(i.uint8array){var m=y;(y=new Uint8Array(m.length+this.leftOver.length)).set(this.leftOver,0),y.set(m,this.leftOver.length)}else y=this.leftOver.concat(y);this.leftOver=null}var b=function(C,k){var _;for((k=k||C.length)>C.length&&(k=C.length),_=k-1;0<=_&&(192&C[_])==128;)_--;return _<0||_===0?k:_+l[C[_]]>k?_:k}(y),v=y;b!==y.length&&(i.uint8array?(v=y.subarray(0,b),this.leftOver=y.subarray(b,y.length)):(v=y.slice(0,b),this.leftOver=y.slice(b,y.length))),this.push({data:r.utf8decode(v),meta:f.meta})},p.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:r.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},r.Utf8DecodeWorker=p,n.inherits(u,o),u.prototype.processChunk=function(f){this.push({data:r.utf8encode(f.data),meta:f.meta})},r.Utf8EncodeWorker=u},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,c,r){var n=e("./support"),i=e("./base64"),s=e("./nodejsUtils"),o=e("./external");function l(m){return m}function h(m,b){for(var v=0;v<m.length;++v)b[v]=255&m.charCodeAt(v);return b}e("setimmediate"),r.newBlob=function(m,b){r.checkSupport("blob");try{return new Blob([m],{type:b})}catch{try{var v=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return v.append(m),v.getBlob(b)}catch{throw new Error("Bug : can't construct the Blob.")}}};var p={stringifyByChunk:function(m,b,v){var C=[],k=0,_=m.length;if(_<=v)return String.fromCharCode.apply(null,m);for(;k<_;)b==="array"||b==="nodebuffer"?C.push(String.fromCharCode.apply(null,m.slice(k,Math.min(k+v,_)))):C.push(String.fromCharCode.apply(null,m.subarray(k,Math.min(k+v,_)))),k+=v;return C.join("")},stringifyByChar:function(m){for(var b="",v=0;v<m.length;v++)b+=String.fromCharCode(m[v]);return b},applyCanBeUsed:{uint8array:function(){try{return n.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}}(),nodebuffer:function(){try{return n.nodebuffer&&String.fromCharCode.apply(null,s.allocBuffer(1)).length===1}catch{return!1}}()}};function u(m){var b=65536,v=r.getTypeOf(m),C=!0;if(v==="uint8array"?C=p.applyCanBeUsed.uint8array:v==="nodebuffer"&&(C=p.applyCanBeUsed.nodebuffer),C)for(;1<b;)try{return p.stringifyByChunk(m,v,b)}catch{b=Math.floor(b/2)}return p.stringifyByChar(m)}function f(m,b){for(var v=0;v<m.length;v++)b[v]=m[v];return b}r.applyFromCharCode=u;var y={};y.string={string:l,array:function(m){return h(m,new Array(m.length))},arraybuffer:function(m){return y.string.uint8array(m).buffer},uint8array:function(m){return h(m,new Uint8Array(m.length))},nodebuffer:function(m){return h(m,s.allocBuffer(m.length))}},y.array={string:u,array:l,arraybuffer:function(m){return new Uint8Array(m).buffer},uint8array:function(m){return new Uint8Array(m)},nodebuffer:function(m){return s.newBufferFrom(m)}},y.arraybuffer={string:function(m){return u(new Uint8Array(m))},array:function(m){return f(new Uint8Array(m),new Array(m.byteLength))},arraybuffer:l,uint8array:function(m){return new Uint8Array(m)},nodebuffer:function(m){return s.newBufferFrom(new Uint8Array(m))}},y.uint8array={string:u,array:function(m){return f(m,new Array(m.length))},arraybuffer:function(m){return m.buffer},uint8array:l,nodebuffer:function(m){return s.newBufferFrom(m)}},y.nodebuffer={string:u,array:function(m){return f(m,new Array(m.length))},arraybuffer:function(m){return y.nodebuffer.uint8array(m).buffer},uint8array:function(m){return f(m,new Uint8Array(m.length))},nodebuffer:l},r.transformTo=function(m,b){if(b=b||"",!m)return b;r.checkSupport(m);var v=r.getTypeOf(b);return y[v][m](b)},r.resolve=function(m){for(var b=m.split("/"),v=[],C=0;C<b.length;C++){var k=b[C];k==="."||k===""&&C!==0&&C!==b.length-1||(k===".."?v.pop():v.push(k))}return v.join("/")},r.getTypeOf=function(m){return typeof m=="string"?"string":Object.prototype.toString.call(m)==="[object Array]"?"array":n.nodebuffer&&s.isBuffer(m)?"nodebuffer":n.uint8array&&m instanceof Uint8Array?"uint8array":n.arraybuffer&&m instanceof ArrayBuffer?"arraybuffer":void 0},r.checkSupport=function(m){if(!n[m.toLowerCase()])throw new Error(m+" is not supported by this platform")},r.MAX_VALUE_16BITS=65535,r.MAX_VALUE_32BITS=-1,r.pretty=function(m){var b,v,C="";for(v=0;v<(m||"").length;v++)C+="\\x"+((b=m.charCodeAt(v))<16?"0":"")+b.toString(16).toUpperCase();return C},r.delay=function(m,b,v){setImmediate(function(){m.apply(v||null,b||[])})},r.inherits=function(m,b){function v(){}v.prototype=b.prototype,m.prototype=new v},r.extend=function(){var m,b,v={};for(m=0;m<arguments.length;m++)for(b in arguments[m])Object.prototype.hasOwnProperty.call(arguments[m],b)&&v[b]===void 0&&(v[b]=arguments[m][b]);return v},r.prepareContent=function(m,b,v,C,k){return o.Promise.resolve(b).then(function(_){return n.blob&&(_ instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(_))!==-1)&&typeof FileReader<"u"?new o.Promise(function(I,x){var L=new FileReader;L.onload=function(N){I(N.target.result)},L.onerror=function(N){x(N.target.error)},L.readAsArrayBuffer(_)}):_}).then(function(_){var I=r.getTypeOf(_);return I?(I==="arraybuffer"?_=r.transformTo("uint8array",_):I==="string"&&(k?_=i.decode(_):v&&C!==!0&&(_=function(x){return h(x,n.uint8array?new Uint8Array(x.length):new Array(x.length))}(_))),_):o.Promise.reject(new Error("Can't read the data of '"+m+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(e,c,r){var n=e("./reader/readerFor"),i=e("./utils"),s=e("./signature"),o=e("./zipEntry"),l=e("./support");function h(p){this.files=[],this.loadOptions=p}h.prototype={checkSignature:function(p){if(!this.reader.readAndCheckSignature(p)){this.reader.index-=4;var u=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+i.pretty(u)+", expected "+i.pretty(p)+")")}},isSignature:function(p,u){var f=this.reader.index;this.reader.setIndex(p);var y=this.reader.readString(4)===u;return this.reader.setIndex(f),y},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var p=this.reader.readData(this.zipCommentLength),u=l.uint8array?"uint8array":"array",f=i.transformTo(u,p);this.zipComment=this.loadOptions.decodeFileName(f)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var p,u,f,y=this.zip64EndOfCentralSize-44;0<y;)p=this.reader.readInt(2),u=this.reader.readInt(4),f=this.reader.readData(u),this.zip64ExtensibleData[p]={id:p,length:u,value:f}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var p,u;for(p=0;p<this.files.length;p++)u=this.files[p],this.reader.setIndex(u.localHeaderOffset),this.checkSignature(s.LOCAL_FILE_HEADER),u.readLocalPart(this.reader),u.handleUTF8(),u.processAttributes()},readCentralDir:function(){var p;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(s.CENTRAL_FILE_HEADER);)(p=new o({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(p);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var p=this.reader.lastIndexOfSignature(s.CENTRAL_DIRECTORY_END);if(p<0)throw this.isSignature(0,s.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(p);var u=p;if(this.checkSignature(s.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===i.MAX_VALUE_16BITS||this.diskWithCentralDirStart===i.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===i.MAX_VALUE_16BITS||this.centralDirRecords===i.MAX_VALUE_16BITS||this.centralDirSize===i.MAX_VALUE_32BITS||this.centralDirOffset===i.MAX_VALUE_32BITS){if(this.zip64=!0,(p=this.reader.lastIndexOfSignature(s.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(p),this.checkSignature(s.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,s.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(s.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(s.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var f=this.centralDirOffset+this.centralDirSize;this.zip64&&(f+=20,f+=12+this.zip64EndOfCentralSize);var y=u-f;if(0<y)this.isSignature(u,s.CENTRAL_FILE_HEADER)||(this.reader.zero=y);else if(y<0)throw new Error("Corrupted zip: missing "+Math.abs(y)+" bytes.")},prepareReader:function(p){this.reader=n(p)},load:function(p){this.prepareReader(p),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},c.exports=h},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(e,c,r){var n=e("./reader/readerFor"),i=e("./utils"),s=e("./compressedObject"),o=e("./crc32"),l=e("./utf8"),h=e("./compressions"),p=e("./support");function u(f,y){this.options=f,this.loadOptions=y}u.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(f){var y,m;if(f.skip(22),this.fileNameLength=f.readInt(2),m=f.readInt(2),this.fileName=f.readData(this.fileNameLength),f.skip(m),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((y=function(b){for(var v in h)if(Object.prototype.hasOwnProperty.call(h,v)&&h[v].magic===b)return h[v];return null}(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+i.pretty(this.compressionMethod)+" unknown (inner file : "+i.transformTo("string",this.fileName)+")");this.decompressed=new s(this.compressedSize,this.uncompressedSize,this.crc32,y,f.readData(this.compressedSize))},readCentralPart:function(f){this.versionMadeBy=f.readInt(2),f.skip(2),this.bitFlag=f.readInt(2),this.compressionMethod=f.readString(2),this.date=f.readDate(),this.crc32=f.readInt(4),this.compressedSize=f.readInt(4),this.uncompressedSize=f.readInt(4);var y=f.readInt(2);if(this.extraFieldsLength=f.readInt(2),this.fileCommentLength=f.readInt(2),this.diskNumberStart=f.readInt(2),this.internalFileAttributes=f.readInt(2),this.externalFileAttributes=f.readInt(4),this.localHeaderOffset=f.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");f.skip(y),this.readExtraFields(f),this.parseZIP64ExtraField(f),this.fileComment=f.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var f=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),f==0&&(this.dosPermissions=63&this.externalFileAttributes),f==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var f=n(this.extraFields[1].value);this.uncompressedSize===i.MAX_VALUE_32BITS&&(this.uncompressedSize=f.readInt(8)),this.compressedSize===i.MAX_VALUE_32BITS&&(this.compressedSize=f.readInt(8)),this.localHeaderOffset===i.MAX_VALUE_32BITS&&(this.localHeaderOffset=f.readInt(8)),this.diskNumberStart===i.MAX_VALUE_32BITS&&(this.diskNumberStart=f.readInt(4))}},readExtraFields:function(f){var y,m,b,v=f.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});f.index+4<v;)y=f.readInt(2),m=f.readInt(2),b=f.readData(m),this.extraFields[y]={id:y,length:m,value:b};f.setIndex(v)},handleUTF8:function(){var f=p.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=l.utf8decode(this.fileName),this.fileCommentStr=l.utf8decode(this.fileComment);else{var y=this.findExtraFieldUnicodePath();if(y!==null)this.fileNameStr=y;else{var m=i.transformTo(f,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(m)}var b=this.findExtraFieldUnicodeComment();if(b!==null)this.fileCommentStr=b;else{var v=i.transformTo(f,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(v)}}},findExtraFieldUnicodePath:function(){var f=this.extraFields[28789];if(f){var y=n(f.value);return y.readInt(1)!==1||o(this.fileName)!==y.readInt(4)?null:l.utf8decode(y.readData(f.length-5))}return null},findExtraFieldUnicodeComment:function(){var f=this.extraFields[25461];if(f){var y=n(f.value);return y.readInt(1)!==1||o(this.fileComment)!==y.readInt(4)?null:l.utf8decode(y.readData(f.length-5))}return null}},c.exports=u},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(e,c,r){function n(y,m,b){this.name=y,this.dir=b.dir,this.date=b.date,this.comment=b.comment,this.unixPermissions=b.unixPermissions,this.dosPermissions=b.dosPermissions,this._data=m,this._dataBinary=b.binary,this.options={compression:b.compression,compressionOptions:b.compressionOptions}}var i=e("./stream/StreamHelper"),s=e("./stream/DataWorker"),o=e("./utf8"),l=e("./compressedObject"),h=e("./stream/GenericWorker");n.prototype={internalStream:function(y){var m=null,b="string";try{if(!y)throw new Error("No output type specified.");var v=(b=y.toLowerCase())==="string"||b==="text";b!=="binarystring"&&b!=="text"||(b="string"),m=this._decompressWorker();var C=!this._dataBinary;C&&!v&&(m=m.pipe(new o.Utf8EncodeWorker)),!C&&v&&(m=m.pipe(new o.Utf8DecodeWorker))}catch(k){(m=new h("error")).error(k)}return new i(m,b,"")},async:function(y,m){return this.internalStream(y).accumulate(m)},nodeStream:function(y,m){return this.internalStream(y||"nodebuffer").toNodejsStream(m)},_compressWorker:function(y,m){if(this._data instanceof l&&this._data.compression.magic===y.magic)return this._data.getCompressedWorker();var b=this._decompressWorker();return this._dataBinary||(b=b.pipe(new o.Utf8EncodeWorker)),l.createWorkerFrom(b,y,m)},_decompressWorker:function(){return this._data instanceof l?this._data.getContentWorker():this._data instanceof h?this._data:new s(this._data)}};for(var p=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],u=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},f=0;f<p.length;f++)n.prototype[p[f]]=u;c.exports=n},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(e,c,r){(function(n){var i,s,o=n.MutationObserver||n.WebKitMutationObserver;if(o){var l=0,h=new o(y),p=n.document.createTextNode("");h.observe(p,{characterData:!0}),i=function(){p.data=l=++l%2}}else if(n.setImmediate||n.MessageChannel===void 0)i="document"in n&&"onreadystatechange"in n.document.createElement("script")?function(){var m=n.document.createElement("script");m.onreadystatechange=function(){y(),m.onreadystatechange=null,m.parentNode.removeChild(m),m=null},n.document.documentElement.appendChild(m)}:function(){setTimeout(y,0)};else{var u=new n.MessageChannel;u.port1.onmessage=y,i=function(){u.port2.postMessage(0)}}var f=[];function y(){var m,b;s=!0;for(var v=f.length;v;){for(b=f,f=[],m=-1;++m<v;)b[m]();v=f.length}s=!1}c.exports=function(m){f.push(m)!==1||s||i()}}).call(this,typeof bn<"u"?bn:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(e,c,r){var n=e("immediate");function i(){}var s={},o=["REJECTED"],l=["FULFILLED"],h=["PENDING"];function p(v){if(typeof v!="function")throw new TypeError("resolver must be a function");this.state=h,this.queue=[],this.outcome=void 0,v!==i&&m(this,v)}function u(v,C,k){this.promise=v,typeof C=="function"&&(this.onFulfilled=C,this.callFulfilled=this.otherCallFulfilled),typeof k=="function"&&(this.onRejected=k,this.callRejected=this.otherCallRejected)}function f(v,C,k){n(function(){var _;try{_=C(k)}catch(I){return s.reject(v,I)}_===v?s.reject(v,new TypeError("Cannot resolve promise with itself")):s.resolve(v,_)})}function y(v){var C=v&&v.then;if(v&&(typeof v=="object"||typeof v=="function")&&typeof C=="function")return function(){C.apply(v,arguments)}}function m(v,C){var k=!1;function _(L){k||(k=!0,s.reject(v,L))}function I(L){k||(k=!0,s.resolve(v,L))}var x=b(function(){C(I,_)});x.status==="error"&&_(x.value)}function b(v,C){var k={};try{k.value=v(C),k.status="success"}catch(_){k.status="error",k.value=_}return k}(c.exports=p).prototype.finally=function(v){if(typeof v!="function")return this;var C=this.constructor;return this.then(function(k){return C.resolve(v()).then(function(){return k})},function(k){return C.resolve(v()).then(function(){throw k})})},p.prototype.catch=function(v){return this.then(null,v)},p.prototype.then=function(v,C){if(typeof v!="function"&&this.state===l||typeof C!="function"&&this.state===o)return this;var k=new this.constructor(i);return this.state!==h?f(k,this.state===l?v:C,this.outcome):this.queue.push(new u(k,v,C)),k},u.prototype.callFulfilled=function(v){s.resolve(this.promise,v)},u.prototype.otherCallFulfilled=function(v){f(this.promise,this.onFulfilled,v)},u.prototype.callRejected=function(v){s.reject(this.promise,v)},u.prototype.otherCallRejected=function(v){f(this.promise,this.onRejected,v)},s.resolve=function(v,C){var k=b(y,C);if(k.status==="error")return s.reject(v,k.value);var _=k.value;if(_)m(v,_);else{v.state=l,v.outcome=C;for(var I=-1,x=v.queue.length;++I<x;)v.queue[I].callFulfilled(C)}return v},s.reject=function(v,C){v.state=o,v.outcome=C;for(var k=-1,_=v.queue.length;++k<_;)v.queue[k].callRejected(C);return v},p.resolve=function(v){return v instanceof this?v:s.resolve(new this(i),v)},p.reject=function(v){var C=new this(i);return s.reject(C,v)},p.all=function(v){var C=this;if(Object.prototype.toString.call(v)!=="[object Array]")return this.reject(new TypeError("must be an array"));var k=v.length,_=!1;if(!k)return this.resolve([]);for(var I=new Array(k),x=0,L=-1,N=new this(i);++L<k;)R(v[L],L);return N;function R(P,ee){C.resolve(P).then(function(S){I[ee]=S,++x!==k||_||(_=!0,s.resolve(N,I))},function(S){_||(_=!0,s.reject(N,S))})}},p.race=function(v){var C=this;if(Object.prototype.toString.call(v)!=="[object Array]")return this.reject(new TypeError("must be an array"));var k=v.length,_=!1;if(!k)return this.resolve([]);for(var I=-1,x=new this(i);++I<k;)L=v[I],C.resolve(L).then(function(N){_||(_=!0,s.resolve(x,N))},function(N){_||(_=!0,s.reject(x,N))});var L;return x}},{immediate:36}],38:[function(e,c,r){var n={};(0,e("./lib/utils/common").assign)(n,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),c.exports=n},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(e,c,r){var n=e("./zlib/deflate"),i=e("./utils/common"),s=e("./utils/strings"),o=e("./zlib/messages"),l=e("./zlib/zstream"),h=Object.prototype.toString,p=0,u=-1,f=0,y=8;function m(v){if(!(this instanceof m))return new m(v);this.options=i.assign({level:u,method:y,chunkSize:16384,windowBits:15,memLevel:8,strategy:f,to:""},v||{});var C=this.options;C.raw&&0<C.windowBits?C.windowBits=-C.windowBits:C.gzip&&0<C.windowBits&&C.windowBits<16&&(C.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new l,this.strm.avail_out=0;var k=n.deflateInit2(this.strm,C.level,C.method,C.windowBits,C.memLevel,C.strategy);if(k!==p)throw new Error(o[k]);if(C.header&&n.deflateSetHeader(this.strm,C.header),C.dictionary){var _;if(_=typeof C.dictionary=="string"?s.string2buf(C.dictionary):h.call(C.dictionary)==="[object ArrayBuffer]"?new Uint8Array(C.dictionary):C.dictionary,(k=n.deflateSetDictionary(this.strm,_))!==p)throw new Error(o[k]);this._dict_set=!0}}function b(v,C){var k=new m(C);if(k.push(v,!0),k.err)throw k.msg||o[k.err];return k.result}m.prototype.push=function(v,C){var k,_,I=this.strm,x=this.options.chunkSize;if(this.ended)return!1;_=C===~~C?C:C===!0?4:0,typeof v=="string"?I.input=s.string2buf(v):h.call(v)==="[object ArrayBuffer]"?I.input=new Uint8Array(v):I.input=v,I.next_in=0,I.avail_in=I.input.length;do{if(I.avail_out===0&&(I.output=new i.Buf8(x),I.next_out=0,I.avail_out=x),(k=n.deflate(I,_))!==1&&k!==p)return this.onEnd(k),!(this.ended=!0);I.avail_out!==0&&(I.avail_in!==0||_!==4&&_!==2)||(this.options.to==="string"?this.onData(s.buf2binstring(i.shrinkBuf(I.output,I.next_out))):this.onData(i.shrinkBuf(I.output,I.next_out)))}while((0<I.avail_in||I.avail_out===0)&&k!==1);return _===4?(k=n.deflateEnd(this.strm),this.onEnd(k),this.ended=!0,k===p):_!==2||(this.onEnd(p),!(I.avail_out=0))},m.prototype.onData=function(v){this.chunks.push(v)},m.prototype.onEnd=function(v){v===p&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=i.flattenChunks(this.chunks)),this.chunks=[],this.err=v,this.msg=this.strm.msg},r.Deflate=m,r.deflate=b,r.deflateRaw=function(v,C){return(C=C||{}).raw=!0,b(v,C)},r.gzip=function(v,C){return(C=C||{}).gzip=!0,b(v,C)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(e,c,r){var n=e("./zlib/inflate"),i=e("./utils/common"),s=e("./utils/strings"),o=e("./zlib/constants"),l=e("./zlib/messages"),h=e("./zlib/zstream"),p=e("./zlib/gzheader"),u=Object.prototype.toString;function f(m){if(!(this instanceof f))return new f(m);this.options=i.assign({chunkSize:16384,windowBits:0,to:""},m||{});var b=this.options;b.raw&&0<=b.windowBits&&b.windowBits<16&&(b.windowBits=-b.windowBits,b.windowBits===0&&(b.windowBits=-15)),!(0<=b.windowBits&&b.windowBits<16)||m&&m.windowBits||(b.windowBits+=32),15<b.windowBits&&b.windowBits<48&&!(15&b.windowBits)&&(b.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new h,this.strm.avail_out=0;var v=n.inflateInit2(this.strm,b.windowBits);if(v!==o.Z_OK)throw new Error(l[v]);this.header=new p,n.inflateGetHeader(this.strm,this.header)}function y(m,b){var v=new f(b);if(v.push(m,!0),v.err)throw v.msg||l[v.err];return v.result}f.prototype.push=function(m,b){var v,C,k,_,I,x,L=this.strm,N=this.options.chunkSize,R=this.options.dictionary,P=!1;if(this.ended)return!1;C=b===~~b?b:b===!0?o.Z_FINISH:o.Z_NO_FLUSH,typeof m=="string"?L.input=s.binstring2buf(m):u.call(m)==="[object ArrayBuffer]"?L.input=new Uint8Array(m):L.input=m,L.next_in=0,L.avail_in=L.input.length;do{if(L.avail_out===0&&(L.output=new i.Buf8(N),L.next_out=0,L.avail_out=N),(v=n.inflate(L,o.Z_NO_FLUSH))===o.Z_NEED_DICT&&R&&(x=typeof R=="string"?s.string2buf(R):u.call(R)==="[object ArrayBuffer]"?new Uint8Array(R):R,v=n.inflateSetDictionary(this.strm,x)),v===o.Z_BUF_ERROR&&P===!0&&(v=o.Z_OK,P=!1),v!==o.Z_STREAM_END&&v!==o.Z_OK)return this.onEnd(v),!(this.ended=!0);L.next_out&&(L.avail_out!==0&&v!==o.Z_STREAM_END&&(L.avail_in!==0||C!==o.Z_FINISH&&C!==o.Z_SYNC_FLUSH)||(this.options.to==="string"?(k=s.utf8border(L.output,L.next_out),_=L.next_out-k,I=s.buf2string(L.output,k),L.next_out=_,L.avail_out=N-_,_&&i.arraySet(L.output,L.output,k,_,0),this.onData(I)):this.onData(i.shrinkBuf(L.output,L.next_out)))),L.avail_in===0&&L.avail_out===0&&(P=!0)}while((0<L.avail_in||L.avail_out===0)&&v!==o.Z_STREAM_END);return v===o.Z_STREAM_END&&(C=o.Z_FINISH),C===o.Z_FINISH?(v=n.inflateEnd(this.strm),this.onEnd(v),this.ended=!0,v===o.Z_OK):C!==o.Z_SYNC_FLUSH||(this.onEnd(o.Z_OK),!(L.avail_out=0))},f.prototype.onData=function(m){this.chunks.push(m)},f.prototype.onEnd=function(m){m===o.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=i.flattenChunks(this.chunks)),this.chunks=[],this.err=m,this.msg=this.strm.msg},r.Inflate=f,r.inflate=y,r.inflateRaw=function(m,b){return(b=b||{}).raw=!0,y(m,b)},r.ungzip=y},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(e,c,r){var n=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";r.assign=function(o){for(var l=Array.prototype.slice.call(arguments,1);l.length;){var h=l.shift();if(h){if(typeof h!="object")throw new TypeError(h+"must be non-object");for(var p in h)h.hasOwnProperty(p)&&(o[p]=h[p])}}return o},r.shrinkBuf=function(o,l){return o.length===l?o:o.subarray?o.subarray(0,l):(o.length=l,o)};var i={arraySet:function(o,l,h,p,u){if(l.subarray&&o.subarray)o.set(l.subarray(h,h+p),u);else for(var f=0;f<p;f++)o[u+f]=l[h+f]},flattenChunks:function(o){var l,h,p,u,f,y;for(l=p=0,h=o.length;l<h;l++)p+=o[l].length;for(y=new Uint8Array(p),l=u=0,h=o.length;l<h;l++)f=o[l],y.set(f,u),u+=f.length;return y}},s={arraySet:function(o,l,h,p,u){for(var f=0;f<p;f++)o[u+f]=l[h+f]},flattenChunks:function(o){return[].concat.apply([],o)}};r.setTyped=function(o){o?(r.Buf8=Uint8Array,r.Buf16=Uint16Array,r.Buf32=Int32Array,r.assign(r,i)):(r.Buf8=Array,r.Buf16=Array,r.Buf32=Array,r.assign(r,s))},r.setTyped(n)},{}],42:[function(e,c,r){var n=e("./common"),i=!0,s=!0;try{String.fromCharCode.apply(null,[0])}catch{i=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{s=!1}for(var o=new n.Buf8(256),l=0;l<256;l++)o[l]=252<=l?6:248<=l?5:240<=l?4:224<=l?3:192<=l?2:1;function h(p,u){if(u<65537&&(p.subarray&&s||!p.subarray&&i))return String.fromCharCode.apply(null,n.shrinkBuf(p,u));for(var f="",y=0;y<u;y++)f+=String.fromCharCode(p[y]);return f}o[254]=o[254]=1,r.string2buf=function(p){var u,f,y,m,b,v=p.length,C=0;for(m=0;m<v;m++)(64512&(f=p.charCodeAt(m)))==55296&&m+1<v&&(64512&(y=p.charCodeAt(m+1)))==56320&&(f=65536+(f-55296<<10)+(y-56320),m++),C+=f<128?1:f<2048?2:f<65536?3:4;for(u=new n.Buf8(C),m=b=0;b<C;m++)(64512&(f=p.charCodeAt(m)))==55296&&m+1<v&&(64512&(y=p.charCodeAt(m+1)))==56320&&(f=65536+(f-55296<<10)+(y-56320),m++),f<128?u[b++]=f:(f<2048?u[b++]=192|f>>>6:(f<65536?u[b++]=224|f>>>12:(u[b++]=240|f>>>18,u[b++]=128|f>>>12&63),u[b++]=128|f>>>6&63),u[b++]=128|63&f);return u},r.buf2binstring=function(p){return h(p,p.length)},r.binstring2buf=function(p){for(var u=new n.Buf8(p.length),f=0,y=u.length;f<y;f++)u[f]=p.charCodeAt(f);return u},r.buf2string=function(p,u){var f,y,m,b,v=u||p.length,C=new Array(2*v);for(f=y=0;f<v;)if((m=p[f++])<128)C[y++]=m;else if(4<(b=o[m]))C[y++]=65533,f+=b-1;else{for(m&=b===2?31:b===3?15:7;1<b&&f<v;)m=m<<6|63&p[f++],b--;1<b?C[y++]=65533:m<65536?C[y++]=m:(m-=65536,C[y++]=55296|m>>10&1023,C[y++]=56320|1023&m)}return h(C,y)},r.utf8border=function(p,u){var f;for((u=u||p.length)>p.length&&(u=p.length),f=u-1;0<=f&&(192&p[f])==128;)f--;return f<0||f===0?u:f+o[p[f]]>u?f:u}},{"./common":41}],43:[function(e,c,r){c.exports=function(n,i,s,o){for(var l=65535&n|0,h=n>>>16&65535|0,p=0;s!==0;){for(s-=p=2e3<s?2e3:s;h=h+(l=l+i[o++]|0)|0,--p;);l%=65521,h%=65521}return l|h<<16|0}},{}],44:[function(e,c,r){c.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(e,c,r){var n=function(){for(var i,s=[],o=0;o<256;o++){i=o;for(var l=0;l<8;l++)i=1&i?3988292384^i>>>1:i>>>1;s[o]=i}return s}();c.exports=function(i,s,o,l){var h=n,p=l+o;i^=-1;for(var u=l;u<p;u++)i=i>>>8^h[255&(i^s[u])];return-1^i}},{}],46:[function(e,c,r){var n,i=e("../utils/common"),s=e("./trees"),o=e("./adler32"),l=e("./crc32"),h=e("./messages"),p=0,u=4,f=0,y=-2,m=-1,b=4,v=2,C=8,k=9,_=286,I=30,x=19,L=2*_+1,N=15,R=3,P=258,ee=P+R+1,S=42,z=113,g=1,H=2,fe=3,q=4;function me(d,U){return d.msg=h[U],U}function F(d){return(d<<1)-(4<d?9:0)}function se(d){for(var U=d.length;0<=--U;)d[U]=0}function O(d){var U=d.state,$=U.pending;$>d.avail_out&&($=d.avail_out),$!==0&&(i.arraySet(d.output,U.pending_buf,U.pending_out,$,d.next_out),d.next_out+=$,U.pending_out+=$,d.total_out+=$,d.avail_out-=$,U.pending-=$,U.pending===0&&(U.pending_out=0))}function M(d,U){s._tr_flush_block(d,0<=d.block_start?d.block_start:-1,d.strstart-d.block_start,U),d.block_start=d.strstart,O(d.strm)}function le(d,U){d.pending_buf[d.pending++]=U}function ne(d,U){d.pending_buf[d.pending++]=U>>>8&255,d.pending_buf[d.pending++]=255&U}function Q(d,U){var $,E,w=d.max_chain_length,B=d.strstart,Z=d.prev_length,G=d.nice_match,A=d.strstart>d.w_size-ee?d.strstart-(d.w_size-ee):0,K=d.window,ie=d.w_mask,Y=d.prev,de=d.strstart+P,xe=K[B+Z-1],ge=K[B+Z];d.prev_length>=d.good_match&&(w>>=2),G>d.lookahead&&(G=d.lookahead);do if(K[($=U)+Z]===ge&&K[$+Z-1]===xe&&K[$]===K[B]&&K[++$]===K[B+1]){B+=2,$++;do;while(K[++B]===K[++$]&&K[++B]===K[++$]&&K[++B]===K[++$]&&K[++B]===K[++$]&&K[++B]===K[++$]&&K[++B]===K[++$]&&K[++B]===K[++$]&&K[++B]===K[++$]&&B<de);if(E=P-(de-B),B=de-P,Z<E){if(d.match_start=U,G<=(Z=E))break;xe=K[B+Z-1],ge=K[B+Z]}}while((U=Y[U&ie])>A&&--w!=0);return Z<=d.lookahead?Z:d.lookahead}function Be(d){var U,$,E,w,B,Z,G,A,K,ie,Y=d.w_size;do{if(w=d.window_size-d.lookahead-d.strstart,d.strstart>=Y+(Y-ee)){for(i.arraySet(d.window,d.window,Y,Y,0),d.match_start-=Y,d.strstart-=Y,d.block_start-=Y,U=$=d.hash_size;E=d.head[--U],d.head[U]=Y<=E?E-Y:0,--$;);for(U=$=Y;E=d.prev[--U],d.prev[U]=Y<=E?E-Y:0,--$;);w+=Y}if(d.strm.avail_in===0)break;if(Z=d.strm,G=d.window,A=d.strstart+d.lookahead,K=w,ie=void 0,ie=Z.avail_in,K<ie&&(ie=K),$=ie===0?0:(Z.avail_in-=ie,i.arraySet(G,Z.input,Z.next_in,ie,A),Z.state.wrap===1?Z.adler=o(Z.adler,G,ie,A):Z.state.wrap===2&&(Z.adler=l(Z.adler,G,ie,A)),Z.next_in+=ie,Z.total_in+=ie,ie),d.lookahead+=$,d.lookahead+d.insert>=R)for(B=d.strstart-d.insert,d.ins_h=d.window[B],d.ins_h=(d.ins_h<<d.hash_shift^d.window[B+1])&d.hash_mask;d.insert&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[B+R-1])&d.hash_mask,d.prev[B&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=B,B++,d.insert--,!(d.lookahead+d.insert<R)););}while(d.lookahead<ee&&d.strm.avail_in!==0)}function Ae(d,U){for(var $,E;;){if(d.lookahead<ee){if(Be(d),d.lookahead<ee&&U===p)return g;if(d.lookahead===0)break}if($=0,d.lookahead>=R&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),$!==0&&d.strstart-$<=d.w_size-ee&&(d.match_length=Q(d,$)),d.match_length>=R)if(E=s._tr_tally(d,d.strstart-d.match_start,d.match_length-R),d.lookahead-=d.match_length,d.match_length<=d.max_lazy_match&&d.lookahead>=R){for(d.match_length--;d.strstart++,d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart,--d.match_length!=0;);d.strstart++}else d.strstart+=d.match_length,d.match_length=0,d.ins_h=d.window[d.strstart],d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+1])&d.hash_mask;else E=s._tr_tally(d,0,d.window[d.strstart]),d.lookahead--,d.strstart++;if(E&&(M(d,!1),d.strm.avail_out===0))return g}return d.insert=d.strstart<R-1?d.strstart:R-1,U===u?(M(d,!0),d.strm.avail_out===0?fe:q):d.last_lit&&(M(d,!1),d.strm.avail_out===0)?g:H}function he(d,U){for(var $,E,w;;){if(d.lookahead<ee){if(Be(d),d.lookahead<ee&&U===p)return g;if(d.lookahead===0)break}if($=0,d.lookahead>=R&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),d.prev_length=d.match_length,d.prev_match=d.match_start,d.match_length=R-1,$!==0&&d.prev_length<d.max_lazy_match&&d.strstart-$<=d.w_size-ee&&(d.match_length=Q(d,$),d.match_length<=5&&(d.strategy===1||d.match_length===R&&4096<d.strstart-d.match_start)&&(d.match_length=R-1)),d.prev_length>=R&&d.match_length<=d.prev_length){for(w=d.strstart+d.lookahead-R,E=s._tr_tally(d,d.strstart-1-d.prev_match,d.prev_length-R),d.lookahead-=d.prev_length-1,d.prev_length-=2;++d.strstart<=w&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),--d.prev_length!=0;);if(d.match_available=0,d.match_length=R-1,d.strstart++,E&&(M(d,!1),d.strm.avail_out===0))return g}else if(d.match_available){if((E=s._tr_tally(d,0,d.window[d.strstart-1]))&&M(d,!1),d.strstart++,d.lookahead--,d.strm.avail_out===0)return g}else d.match_available=1,d.strstart++,d.lookahead--}return d.match_available&&(E=s._tr_tally(d,0,d.window[d.strstart-1]),d.match_available=0),d.insert=d.strstart<R-1?d.strstart:R-1,U===u?(M(d,!0),d.strm.avail_out===0?fe:q):d.last_lit&&(M(d,!1),d.strm.avail_out===0)?g:H}function be(d,U,$,E,w){this.good_length=d,this.max_lazy=U,this.nice_length=$,this.max_chain=E,this.func=w}function Le(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=C,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new i.Buf16(2*L),this.dyn_dtree=new i.Buf16(2*(2*I+1)),this.bl_tree=new i.Buf16(2*(2*x+1)),se(this.dyn_ltree),se(this.dyn_dtree),se(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new i.Buf16(N+1),this.heap=new i.Buf16(2*_+1),se(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new i.Buf16(2*_+1),se(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function De(d){var U;return d&&d.state?(d.total_in=d.total_out=0,d.data_type=v,(U=d.state).pending=0,U.pending_out=0,U.wrap<0&&(U.wrap=-U.wrap),U.status=U.wrap?S:z,d.adler=U.wrap===2?0:1,U.last_flush=p,s._tr_init(U),f):me(d,y)}function Ye(d){var U=De(d);return U===f&&function($){$.window_size=2*$.w_size,se($.head),$.max_lazy_match=n[$.level].max_lazy,$.good_match=n[$.level].good_length,$.nice_match=n[$.level].nice_length,$.max_chain_length=n[$.level].max_chain,$.strstart=0,$.block_start=0,$.lookahead=0,$.insert=0,$.match_length=$.prev_length=R-1,$.match_available=0,$.ins_h=0}(d.state),U}function Xe(d,U,$,E,w,B){if(!d)return y;var Z=1;if(U===m&&(U=6),E<0?(Z=0,E=-E):15<E&&(Z=2,E-=16),w<1||k<w||$!==C||E<8||15<E||U<0||9<U||B<0||b<B)return me(d,y);E===8&&(E=9);var G=new Le;return(d.state=G).strm=d,G.wrap=Z,G.gzhead=null,G.w_bits=E,G.w_size=1<<G.w_bits,G.w_mask=G.w_size-1,G.hash_bits=w+7,G.hash_size=1<<G.hash_bits,G.hash_mask=G.hash_size-1,G.hash_shift=~~((G.hash_bits+R-1)/R),G.window=new i.Buf8(2*G.w_size),G.head=new i.Buf16(G.hash_size),G.prev=new i.Buf16(G.w_size),G.lit_bufsize=1<<w+6,G.pending_buf_size=4*G.lit_bufsize,G.pending_buf=new i.Buf8(G.pending_buf_size),G.d_buf=1*G.lit_bufsize,G.l_buf=3*G.lit_bufsize,G.level=U,G.strategy=B,G.method=$,Ye(d)}n=[new be(0,0,0,0,function(d,U){var $=65535;for($>d.pending_buf_size-5&&($=d.pending_buf_size-5);;){if(d.lookahead<=1){if(Be(d),d.lookahead===0&&U===p)return g;if(d.lookahead===0)break}d.strstart+=d.lookahead,d.lookahead=0;var E=d.block_start+$;if((d.strstart===0||d.strstart>=E)&&(d.lookahead=d.strstart-E,d.strstart=E,M(d,!1),d.strm.avail_out===0)||d.strstart-d.block_start>=d.w_size-ee&&(M(d,!1),d.strm.avail_out===0))return g}return d.insert=0,U===u?(M(d,!0),d.strm.avail_out===0?fe:q):(d.strstart>d.block_start&&(M(d,!1),d.strm.avail_out),g)}),new be(4,4,8,4,Ae),new be(4,5,16,8,Ae),new be(4,6,32,32,Ae),new be(4,4,16,16,he),new be(8,16,32,32,he),new be(8,16,128,128,he),new be(8,32,128,256,he),new be(32,128,258,1024,he),new be(32,258,258,4096,he)],r.deflateInit=function(d,U){return Xe(d,U,C,15,8,0)},r.deflateInit2=Xe,r.deflateReset=Ye,r.deflateResetKeep=De,r.deflateSetHeader=function(d,U){return d&&d.state?d.state.wrap!==2?y:(d.state.gzhead=U,f):y},r.deflate=function(d,U){var $,E,w,B;if(!d||!d.state||5<U||U<0)return d?me(d,y):y;if(E=d.state,!d.output||!d.input&&d.avail_in!==0||E.status===666&&U!==u)return me(d,d.avail_out===0?-5:y);if(E.strm=d,$=E.last_flush,E.last_flush=U,E.status===S)if(E.wrap===2)d.adler=0,le(E,31),le(E,139),le(E,8),E.gzhead?(le(E,(E.gzhead.text?1:0)+(E.gzhead.hcrc?2:0)+(E.gzhead.extra?4:0)+(E.gzhead.name?8:0)+(E.gzhead.comment?16:0)),le(E,255&E.gzhead.time),le(E,E.gzhead.time>>8&255),le(E,E.gzhead.time>>16&255),le(E,E.gzhead.time>>24&255),le(E,E.level===9?2:2<=E.strategy||E.level<2?4:0),le(E,255&E.gzhead.os),E.gzhead.extra&&E.gzhead.extra.length&&(le(E,255&E.gzhead.extra.length),le(E,E.gzhead.extra.length>>8&255)),E.gzhead.hcrc&&(d.adler=l(d.adler,E.pending_buf,E.pending,0)),E.gzindex=0,E.status=69):(le(E,0),le(E,0),le(E,0),le(E,0),le(E,0),le(E,E.level===9?2:2<=E.strategy||E.level<2?4:0),le(E,3),E.status=z);else{var Z=C+(E.w_bits-8<<4)<<8;Z|=(2<=E.strategy||E.level<2?0:E.level<6?1:E.level===6?2:3)<<6,E.strstart!==0&&(Z|=32),Z+=31-Z%31,E.status=z,ne(E,Z),E.strstart!==0&&(ne(E,d.adler>>>16),ne(E,65535&d.adler)),d.adler=1}if(E.status===69)if(E.gzhead.extra){for(w=E.pending;E.gzindex<(65535&E.gzhead.extra.length)&&(E.pending!==E.pending_buf_size||(E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),O(d),w=E.pending,E.pending!==E.pending_buf_size));)le(E,255&E.gzhead.extra[E.gzindex]),E.gzindex++;E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),E.gzindex===E.gzhead.extra.length&&(E.gzindex=0,E.status=73)}else E.status=73;if(E.status===73)if(E.gzhead.name){w=E.pending;do{if(E.pending===E.pending_buf_size&&(E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),O(d),w=E.pending,E.pending===E.pending_buf_size)){B=1;break}B=E.gzindex<E.gzhead.name.length?255&E.gzhead.name.charCodeAt(E.gzindex++):0,le(E,B)}while(B!==0);E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),B===0&&(E.gzindex=0,E.status=91)}else E.status=91;if(E.status===91)if(E.gzhead.comment){w=E.pending;do{if(E.pending===E.pending_buf_size&&(E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),O(d),w=E.pending,E.pending===E.pending_buf_size)){B=1;break}B=E.gzindex<E.gzhead.comment.length?255&E.gzhead.comment.charCodeAt(E.gzindex++):0,le(E,B)}while(B!==0);E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),B===0&&(E.status=103)}else E.status=103;if(E.status===103&&(E.gzhead.hcrc?(E.pending+2>E.pending_buf_size&&O(d),E.pending+2<=E.pending_buf_size&&(le(E,255&d.adler),le(E,d.adler>>8&255),d.adler=0,E.status=z)):E.status=z),E.pending!==0){if(O(d),d.avail_out===0)return E.last_flush=-1,f}else if(d.avail_in===0&&F(U)<=F($)&&U!==u)return me(d,-5);if(E.status===666&&d.avail_in!==0)return me(d,-5);if(d.avail_in!==0||E.lookahead!==0||U!==p&&E.status!==666){var G=E.strategy===2?function(A,K){for(var ie;;){if(A.lookahead===0&&(Be(A),A.lookahead===0)){if(K===p)return g;break}if(A.match_length=0,ie=s._tr_tally(A,0,A.window[A.strstart]),A.lookahead--,A.strstart++,ie&&(M(A,!1),A.strm.avail_out===0))return g}return A.insert=0,K===u?(M(A,!0),A.strm.avail_out===0?fe:q):A.last_lit&&(M(A,!1),A.strm.avail_out===0)?g:H}(E,U):E.strategy===3?function(A,K){for(var ie,Y,de,xe,ge=A.window;;){if(A.lookahead<=P){if(Be(A),A.lookahead<=P&&K===p)return g;if(A.lookahead===0)break}if(A.match_length=0,A.lookahead>=R&&0<A.strstart&&(Y=ge[de=A.strstart-1])===ge[++de]&&Y===ge[++de]&&Y===ge[++de]){xe=A.strstart+P;do;while(Y===ge[++de]&&Y===ge[++de]&&Y===ge[++de]&&Y===ge[++de]&&Y===ge[++de]&&Y===ge[++de]&&Y===ge[++de]&&Y===ge[++de]&&de<xe);A.match_length=P-(xe-de),A.match_length>A.lookahead&&(A.match_length=A.lookahead)}if(A.match_length>=R?(ie=s._tr_tally(A,1,A.match_length-R),A.lookahead-=A.match_length,A.strstart+=A.match_length,A.match_length=0):(ie=s._tr_tally(A,0,A.window[A.strstart]),A.lookahead--,A.strstart++),ie&&(M(A,!1),A.strm.avail_out===0))return g}return A.insert=0,K===u?(M(A,!0),A.strm.avail_out===0?fe:q):A.last_lit&&(M(A,!1),A.strm.avail_out===0)?g:H}(E,U):n[E.level].func(E,U);if(G!==fe&&G!==q||(E.status=666),G===g||G===fe)return d.avail_out===0&&(E.last_flush=-1),f;if(G===H&&(U===1?s._tr_align(E):U!==5&&(s._tr_stored_block(E,0,0,!1),U===3&&(se(E.head),E.lookahead===0&&(E.strstart=0,E.block_start=0,E.insert=0))),O(d),d.avail_out===0))return E.last_flush=-1,f}return U!==u?f:E.wrap<=0?1:(E.wrap===2?(le(E,255&d.adler),le(E,d.adler>>8&255),le(E,d.adler>>16&255),le(E,d.adler>>24&255),le(E,255&d.total_in),le(E,d.total_in>>8&255),le(E,d.total_in>>16&255),le(E,d.total_in>>24&255)):(ne(E,d.adler>>>16),ne(E,65535&d.adler)),O(d),0<E.wrap&&(E.wrap=-E.wrap),E.pending!==0?f:1)},r.deflateEnd=function(d){var U;return d&&d.state?(U=d.state.status)!==S&&U!==69&&U!==73&&U!==91&&U!==103&&U!==z&&U!==666?me(d,y):(d.state=null,U===z?me(d,-3):f):y},r.deflateSetDictionary=function(d,U){var $,E,w,B,Z,G,A,K,ie=U.length;if(!d||!d.state||(B=($=d.state).wrap)===2||B===1&&$.status!==S||$.lookahead)return y;for(B===1&&(d.adler=o(d.adler,U,ie,0)),$.wrap=0,ie>=$.w_size&&(B===0&&(se($.head),$.strstart=0,$.block_start=0,$.insert=0),K=new i.Buf8($.w_size),i.arraySet(K,U,ie-$.w_size,$.w_size,0),U=K,ie=$.w_size),Z=d.avail_in,G=d.next_in,A=d.input,d.avail_in=ie,d.next_in=0,d.input=U,Be($);$.lookahead>=R;){for(E=$.strstart,w=$.lookahead-(R-1);$.ins_h=($.ins_h<<$.hash_shift^$.window[E+R-1])&$.hash_mask,$.prev[E&$.w_mask]=$.head[$.ins_h],$.head[$.ins_h]=E,E++,--w;);$.strstart=E,$.lookahead=R-1,Be($)}return $.strstart+=$.lookahead,$.block_start=$.strstart,$.insert=$.lookahead,$.lookahead=0,$.match_length=$.prev_length=R-1,$.match_available=0,d.next_in=G,d.input=A,d.avail_in=Z,$.wrap=B,f},r.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(e,c,r){c.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(e,c,r){c.exports=function(n,i){var s,o,l,h,p,u,f,y,m,b,v,C,k,_,I,x,L,N,R,P,ee,S,z,g,H;s=n.state,o=n.next_in,g=n.input,l=o+(n.avail_in-5),h=n.next_out,H=n.output,p=h-(i-n.avail_out),u=h+(n.avail_out-257),f=s.dmax,y=s.wsize,m=s.whave,b=s.wnext,v=s.window,C=s.hold,k=s.bits,_=s.lencode,I=s.distcode,x=(1<<s.lenbits)-1,L=(1<<s.distbits)-1;e:do{k<15&&(C+=g[o++]<<k,k+=8,C+=g[o++]<<k,k+=8),N=_[C&x];t:for(;;){if(C>>>=R=N>>>24,k-=R,(R=N>>>16&255)===0)H[h++]=65535&N;else{if(!(16&R)){if(!(64&R)){N=_[(65535&N)+(C&(1<<R)-1)];continue t}if(32&R){s.mode=12;break e}n.msg="invalid literal/length code",s.mode=30;break e}P=65535&N,(R&=15)&&(k<R&&(C+=g[o++]<<k,k+=8),P+=C&(1<<R)-1,C>>>=R,k-=R),k<15&&(C+=g[o++]<<k,k+=8,C+=g[o++]<<k,k+=8),N=I[C&L];n:for(;;){if(C>>>=R=N>>>24,k-=R,!(16&(R=N>>>16&255))){if(!(64&R)){N=I[(65535&N)+(C&(1<<R)-1)];continue n}n.msg="invalid distance code",s.mode=30;break e}if(ee=65535&N,k<(R&=15)&&(C+=g[o++]<<k,(k+=8)<R&&(C+=g[o++]<<k,k+=8)),f<(ee+=C&(1<<R)-1)){n.msg="invalid distance too far back",s.mode=30;break e}if(C>>>=R,k-=R,(R=h-p)<ee){if(m<(R=ee-R)&&s.sane){n.msg="invalid distance too far back",s.mode=30;break e}if(z=v,(S=0)===b){if(S+=y-R,R<P){for(P-=R;H[h++]=v[S++],--R;);S=h-ee,z=H}}else if(b<R){if(S+=y+b-R,(R-=b)<P){for(P-=R;H[h++]=v[S++],--R;);if(S=0,b<P){for(P-=R=b;H[h++]=v[S++],--R;);S=h-ee,z=H}}}else if(S+=b-R,R<P){for(P-=R;H[h++]=v[S++],--R;);S=h-ee,z=H}for(;2<P;)H[h++]=z[S++],H[h++]=z[S++],H[h++]=z[S++],P-=3;P&&(H[h++]=z[S++],1<P&&(H[h++]=z[S++]))}else{for(S=h-ee;H[h++]=H[S++],H[h++]=H[S++],H[h++]=H[S++],2<(P-=3););P&&(H[h++]=H[S++],1<P&&(H[h++]=H[S++]))}break}}break}}while(o<l&&h<u);o-=P=k>>3,C&=(1<<(k-=P<<3))-1,n.next_in=o,n.next_out=h,n.avail_in=o<l?l-o+5:5-(o-l),n.avail_out=h<u?u-h+257:257-(h-u),s.hold=C,s.bits=k}},{}],49:[function(e,c,r){var n=e("../utils/common"),i=e("./adler32"),s=e("./crc32"),o=e("./inffast"),l=e("./inftrees"),h=1,p=2,u=0,f=-2,y=1,m=852,b=592;function v(S){return(S>>>24&255)+(S>>>8&65280)+((65280&S)<<8)+((255&S)<<24)}function C(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new n.Buf16(320),this.work=new n.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function k(S){var z;return S&&S.state?(z=S.state,S.total_in=S.total_out=z.total=0,S.msg="",z.wrap&&(S.adler=1&z.wrap),z.mode=y,z.last=0,z.havedict=0,z.dmax=32768,z.head=null,z.hold=0,z.bits=0,z.lencode=z.lendyn=new n.Buf32(m),z.distcode=z.distdyn=new n.Buf32(b),z.sane=1,z.back=-1,u):f}function _(S){var z;return S&&S.state?((z=S.state).wsize=0,z.whave=0,z.wnext=0,k(S)):f}function I(S,z){var g,H;return S&&S.state?(H=S.state,z<0?(g=0,z=-z):(g=1+(z>>4),z<48&&(z&=15)),z&&(z<8||15<z)?f:(H.window!==null&&H.wbits!==z&&(H.window=null),H.wrap=g,H.wbits=z,_(S))):f}function x(S,z){var g,H;return S?(H=new C,(S.state=H).window=null,(g=I(S,z))!==u&&(S.state=null),g):f}var L,N,R=!0;function P(S){if(R){var z;for(L=new n.Buf32(512),N=new n.Buf32(32),z=0;z<144;)S.lens[z++]=8;for(;z<256;)S.lens[z++]=9;for(;z<280;)S.lens[z++]=7;for(;z<288;)S.lens[z++]=8;for(l(h,S.lens,0,288,L,0,S.work,{bits:9}),z=0;z<32;)S.lens[z++]=5;l(p,S.lens,0,32,N,0,S.work,{bits:5}),R=!1}S.lencode=L,S.lenbits=9,S.distcode=N,S.distbits=5}function ee(S,z,g,H){var fe,q=S.state;return q.window===null&&(q.wsize=1<<q.wbits,q.wnext=0,q.whave=0,q.window=new n.Buf8(q.wsize)),H>=q.wsize?(n.arraySet(q.window,z,g-q.wsize,q.wsize,0),q.wnext=0,q.whave=q.wsize):(H<(fe=q.wsize-q.wnext)&&(fe=H),n.arraySet(q.window,z,g-H,fe,q.wnext),(H-=fe)?(n.arraySet(q.window,z,g-H,H,0),q.wnext=H,q.whave=q.wsize):(q.wnext+=fe,q.wnext===q.wsize&&(q.wnext=0),q.whave<q.wsize&&(q.whave+=fe))),0}r.inflateReset=_,r.inflateReset2=I,r.inflateResetKeep=k,r.inflateInit=function(S){return x(S,15)},r.inflateInit2=x,r.inflate=function(S,z){var g,H,fe,q,me,F,se,O,M,le,ne,Q,Be,Ae,he,be,Le,De,Ye,Xe,d,U,$,E,w=0,B=new n.Buf8(4),Z=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!S||!S.state||!S.output||!S.input&&S.avail_in!==0)return f;(g=S.state).mode===12&&(g.mode=13),me=S.next_out,fe=S.output,se=S.avail_out,q=S.next_in,H=S.input,F=S.avail_in,O=g.hold,M=g.bits,le=F,ne=se,U=u;e:for(;;)switch(g.mode){case y:if(g.wrap===0){g.mode=13;break}for(;M<16;){if(F===0)break e;F--,O+=H[q++]<<M,M+=8}if(2&g.wrap&&O===35615){B[g.check=0]=255&O,B[1]=O>>>8&255,g.check=s(g.check,B,2,0),M=O=0,g.mode=2;break}if(g.flags=0,g.head&&(g.head.done=!1),!(1&g.wrap)||(((255&O)<<8)+(O>>8))%31){S.msg="incorrect header check",g.mode=30;break}if((15&O)!=8){S.msg="unknown compression method",g.mode=30;break}if(M-=4,d=8+(15&(O>>>=4)),g.wbits===0)g.wbits=d;else if(d>g.wbits){S.msg="invalid window size",g.mode=30;break}g.dmax=1<<d,S.adler=g.check=1,g.mode=512&O?10:12,M=O=0;break;case 2:for(;M<16;){if(F===0)break e;F--,O+=H[q++]<<M,M+=8}if(g.flags=O,(255&g.flags)!=8){S.msg="unknown compression method",g.mode=30;break}if(57344&g.flags){S.msg="unknown header flags set",g.mode=30;break}g.head&&(g.head.text=O>>8&1),512&g.flags&&(B[0]=255&O,B[1]=O>>>8&255,g.check=s(g.check,B,2,0)),M=O=0,g.mode=3;case 3:for(;M<32;){if(F===0)break e;F--,O+=H[q++]<<M,M+=8}g.head&&(g.head.time=O),512&g.flags&&(B[0]=255&O,B[1]=O>>>8&255,B[2]=O>>>16&255,B[3]=O>>>24&255,g.check=s(g.check,B,4,0)),M=O=0,g.mode=4;case 4:for(;M<16;){if(F===0)break e;F--,O+=H[q++]<<M,M+=8}g.head&&(g.head.xflags=255&O,g.head.os=O>>8),512&g.flags&&(B[0]=255&O,B[1]=O>>>8&255,g.check=s(g.check,B,2,0)),M=O=0,g.mode=5;case 5:if(1024&g.flags){for(;M<16;){if(F===0)break e;F--,O+=H[q++]<<M,M+=8}g.length=O,g.head&&(g.head.extra_len=O),512&g.flags&&(B[0]=255&O,B[1]=O>>>8&255,g.check=s(g.check,B,2,0)),M=O=0}else g.head&&(g.head.extra=null);g.mode=6;case 6:if(1024&g.flags&&(F<(Q=g.length)&&(Q=F),Q&&(g.head&&(d=g.head.extra_len-g.length,g.head.extra||(g.head.extra=new Array(g.head.extra_len)),n.arraySet(g.head.extra,H,q,Q,d)),512&g.flags&&(g.check=s(g.check,H,Q,q)),F-=Q,q+=Q,g.length-=Q),g.length))break e;g.length=0,g.mode=7;case 7:if(2048&g.flags){if(F===0)break e;for(Q=0;d=H[q+Q++],g.head&&d&&g.length<65536&&(g.head.name+=String.fromCharCode(d)),d&&Q<F;);if(512&g.flags&&(g.check=s(g.check,H,Q,q)),F-=Q,q+=Q,d)break e}else g.head&&(g.head.name=null);g.length=0,g.mode=8;case 8:if(4096&g.flags){if(F===0)break e;for(Q=0;d=H[q+Q++],g.head&&d&&g.length<65536&&(g.head.comment+=String.fromCharCode(d)),d&&Q<F;);if(512&g.flags&&(g.check=s(g.check,H,Q,q)),F-=Q,q+=Q,d)break e}else g.head&&(g.head.comment=null);g.mode=9;case 9:if(512&g.flags){for(;M<16;){if(F===0)break e;F--,O+=H[q++]<<M,M+=8}if(O!==(65535&g.check)){S.msg="header crc mismatch",g.mode=30;break}M=O=0}g.head&&(g.head.hcrc=g.flags>>9&1,g.head.done=!0),S.adler=g.check=0,g.mode=12;break;case 10:for(;M<32;){if(F===0)break e;F--,O+=H[q++]<<M,M+=8}S.adler=g.check=v(O),M=O=0,g.mode=11;case 11:if(g.havedict===0)return S.next_out=me,S.avail_out=se,S.next_in=q,S.avail_in=F,g.hold=O,g.bits=M,2;S.adler=g.check=1,g.mode=12;case 12:if(z===5||z===6)break e;case 13:if(g.last){O>>>=7&M,M-=7&M,g.mode=27;break}for(;M<3;){if(F===0)break e;F--,O+=H[q++]<<M,M+=8}switch(g.last=1&O,M-=1,3&(O>>>=1)){case 0:g.mode=14;break;case 1:if(P(g),g.mode=20,z!==6)break;O>>>=2,M-=2;break e;case 2:g.mode=17;break;case 3:S.msg="invalid block type",g.mode=30}O>>>=2,M-=2;break;case 14:for(O>>>=7&M,M-=7&M;M<32;){if(F===0)break e;F--,O+=H[q++]<<M,M+=8}if((65535&O)!=(O>>>16^65535)){S.msg="invalid stored block lengths",g.mode=30;break}if(g.length=65535&O,M=O=0,g.mode=15,z===6)break e;case 15:g.mode=16;case 16:if(Q=g.length){if(F<Q&&(Q=F),se<Q&&(Q=se),Q===0)break e;n.arraySet(fe,H,q,Q,me),F-=Q,q+=Q,se-=Q,me+=Q,g.length-=Q;break}g.mode=12;break;case 17:for(;M<14;){if(F===0)break e;F--,O+=H[q++]<<M,M+=8}if(g.nlen=257+(31&O),O>>>=5,M-=5,g.ndist=1+(31&O),O>>>=5,M-=5,g.ncode=4+(15&O),O>>>=4,M-=4,286<g.nlen||30<g.ndist){S.msg="too many length or distance symbols",g.mode=30;break}g.have=0,g.mode=18;case 18:for(;g.have<g.ncode;){for(;M<3;){if(F===0)break e;F--,O+=H[q++]<<M,M+=8}g.lens[Z[g.have++]]=7&O,O>>>=3,M-=3}for(;g.have<19;)g.lens[Z[g.have++]]=0;if(g.lencode=g.lendyn,g.lenbits=7,$={bits:g.lenbits},U=l(0,g.lens,0,19,g.lencode,0,g.work,$),g.lenbits=$.bits,U){S.msg="invalid code lengths set",g.mode=30;break}g.have=0,g.mode=19;case 19:for(;g.have<g.nlen+g.ndist;){for(;be=(w=g.lencode[O&(1<<g.lenbits)-1])>>>16&255,Le=65535&w,!((he=w>>>24)<=M);){if(F===0)break e;F--,O+=H[q++]<<M,M+=8}if(Le<16)O>>>=he,M-=he,g.lens[g.have++]=Le;else{if(Le===16){for(E=he+2;M<E;){if(F===0)break e;F--,O+=H[q++]<<M,M+=8}if(O>>>=he,M-=he,g.have===0){S.msg="invalid bit length repeat",g.mode=30;break}d=g.lens[g.have-1],Q=3+(3&O),O>>>=2,M-=2}else if(Le===17){for(E=he+3;M<E;){if(F===0)break e;F--,O+=H[q++]<<M,M+=8}M-=he,d=0,Q=3+(7&(O>>>=he)),O>>>=3,M-=3}else{for(E=he+7;M<E;){if(F===0)break e;F--,O+=H[q++]<<M,M+=8}M-=he,d=0,Q=11+(127&(O>>>=he)),O>>>=7,M-=7}if(g.have+Q>g.nlen+g.ndist){S.msg="invalid bit length repeat",g.mode=30;break}for(;Q--;)g.lens[g.have++]=d}}if(g.mode===30)break;if(g.lens[256]===0){S.msg="invalid code -- missing end-of-block",g.mode=30;break}if(g.lenbits=9,$={bits:g.lenbits},U=l(h,g.lens,0,g.nlen,g.lencode,0,g.work,$),g.lenbits=$.bits,U){S.msg="invalid literal/lengths set",g.mode=30;break}if(g.distbits=6,g.distcode=g.distdyn,$={bits:g.distbits},U=l(p,g.lens,g.nlen,g.ndist,g.distcode,0,g.work,$),g.distbits=$.bits,U){S.msg="invalid distances set",g.mode=30;break}if(g.mode=20,z===6)break e;case 20:g.mode=21;case 21:if(6<=F&&258<=se){S.next_out=me,S.avail_out=se,S.next_in=q,S.avail_in=F,g.hold=O,g.bits=M,o(S,ne),me=S.next_out,fe=S.output,se=S.avail_out,q=S.next_in,H=S.input,F=S.avail_in,O=g.hold,M=g.bits,g.mode===12&&(g.back=-1);break}for(g.back=0;be=(w=g.lencode[O&(1<<g.lenbits)-1])>>>16&255,Le=65535&w,!((he=w>>>24)<=M);){if(F===0)break e;F--,O+=H[q++]<<M,M+=8}if(be&&!(240&be)){for(De=he,Ye=be,Xe=Le;be=(w=g.lencode[Xe+((O&(1<<De+Ye)-1)>>De)])>>>16&255,Le=65535&w,!(De+(he=w>>>24)<=M);){if(F===0)break e;F--,O+=H[q++]<<M,M+=8}O>>>=De,M-=De,g.back+=De}if(O>>>=he,M-=he,g.back+=he,g.length=Le,be===0){g.mode=26;break}if(32&be){g.back=-1,g.mode=12;break}if(64&be){S.msg="invalid literal/length code",g.mode=30;break}g.extra=15&be,g.mode=22;case 22:if(g.extra){for(E=g.extra;M<E;){if(F===0)break e;F--,O+=H[q++]<<M,M+=8}g.length+=O&(1<<g.extra)-1,O>>>=g.extra,M-=g.extra,g.back+=g.extra}g.was=g.length,g.mode=23;case 23:for(;be=(w=g.distcode[O&(1<<g.distbits)-1])>>>16&255,Le=65535&w,!((he=w>>>24)<=M);){if(F===0)break e;F--,O+=H[q++]<<M,M+=8}if(!(240&be)){for(De=he,Ye=be,Xe=Le;be=(w=g.distcode[Xe+((O&(1<<De+Ye)-1)>>De)])>>>16&255,Le=65535&w,!(De+(he=w>>>24)<=M);){if(F===0)break e;F--,O+=H[q++]<<M,M+=8}O>>>=De,M-=De,g.back+=De}if(O>>>=he,M-=he,g.back+=he,64&be){S.msg="invalid distance code",g.mode=30;break}g.offset=Le,g.extra=15&be,g.mode=24;case 24:if(g.extra){for(E=g.extra;M<E;){if(F===0)break e;F--,O+=H[q++]<<M,M+=8}g.offset+=O&(1<<g.extra)-1,O>>>=g.extra,M-=g.extra,g.back+=g.extra}if(g.offset>g.dmax){S.msg="invalid distance too far back",g.mode=30;break}g.mode=25;case 25:if(se===0)break e;if(Q=ne-se,g.offset>Q){if((Q=g.offset-Q)>g.whave&&g.sane){S.msg="invalid distance too far back",g.mode=30;break}Be=Q>g.wnext?(Q-=g.wnext,g.wsize-Q):g.wnext-Q,Q>g.length&&(Q=g.length),Ae=g.window}else Ae=fe,Be=me-g.offset,Q=g.length;for(se<Q&&(Q=se),se-=Q,g.length-=Q;fe[me++]=Ae[Be++],--Q;);g.length===0&&(g.mode=21);break;case 26:if(se===0)break e;fe[me++]=g.length,se--,g.mode=21;break;case 27:if(g.wrap){for(;M<32;){if(F===0)break e;F--,O|=H[q++]<<M,M+=8}if(ne-=se,S.total_out+=ne,g.total+=ne,ne&&(S.adler=g.check=g.flags?s(g.check,fe,ne,me-ne):i(g.check,fe,ne,me-ne)),ne=se,(g.flags?O:v(O))!==g.check){S.msg="incorrect data check",g.mode=30;break}M=O=0}g.mode=28;case 28:if(g.wrap&&g.flags){for(;M<32;){if(F===0)break e;F--,O+=H[q++]<<M,M+=8}if(O!==(4294967295&g.total)){S.msg="incorrect length check",g.mode=30;break}M=O=0}g.mode=29;case 29:U=1;break e;case 30:U=-3;break e;case 31:return-4;case 32:default:return f}return S.next_out=me,S.avail_out=se,S.next_in=q,S.avail_in=F,g.hold=O,g.bits=M,(g.wsize||ne!==S.avail_out&&g.mode<30&&(g.mode<27||z!==4))&&ee(S,S.output,S.next_out,ne-S.avail_out)?(g.mode=31,-4):(le-=S.avail_in,ne-=S.avail_out,S.total_in+=le,S.total_out+=ne,g.total+=ne,g.wrap&&ne&&(S.adler=g.check=g.flags?s(g.check,fe,ne,S.next_out-ne):i(g.check,fe,ne,S.next_out-ne)),S.data_type=g.bits+(g.last?64:0)+(g.mode===12?128:0)+(g.mode===20||g.mode===15?256:0),(le==0&&ne===0||z===4)&&U===u&&(U=-5),U)},r.inflateEnd=function(S){if(!S||!S.state)return f;var z=S.state;return z.window&&(z.window=null),S.state=null,u},r.inflateGetHeader=function(S,z){var g;return S&&S.state&&2&(g=S.state).wrap?((g.head=z).done=!1,u):f},r.inflateSetDictionary=function(S,z){var g,H=z.length;return S&&S.state?(g=S.state).wrap!==0&&g.mode!==11?f:g.mode===11&&i(1,z,H,0)!==g.check?-3:ee(S,z,H,H)?(g.mode=31,-4):(g.havedict=1,u):f},r.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(e,c,r){var n=e("../utils/common"),i=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],s=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],o=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],l=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];c.exports=function(h,p,u,f,y,m,b,v){var C,k,_,I,x,L,N,R,P,ee=v.bits,S=0,z=0,g=0,H=0,fe=0,q=0,me=0,F=0,se=0,O=0,M=null,le=0,ne=new n.Buf16(16),Q=new n.Buf16(16),Be=null,Ae=0;for(S=0;S<=15;S++)ne[S]=0;for(z=0;z<f;z++)ne[p[u+z]]++;for(fe=ee,H=15;1<=H&&ne[H]===0;H--);if(H<fe&&(fe=H),H===0)return y[m++]=20971520,y[m++]=20971520,v.bits=1,0;for(g=1;g<H&&ne[g]===0;g++);for(fe<g&&(fe=g),S=F=1;S<=15;S++)if(F<<=1,(F-=ne[S])<0)return-1;if(0<F&&(h===0||H!==1))return-1;for(Q[1]=0,S=1;S<15;S++)Q[S+1]=Q[S]+ne[S];for(z=0;z<f;z++)p[u+z]!==0&&(b[Q[p[u+z]]++]=z);if(L=h===0?(M=Be=b,19):h===1?(M=i,le-=257,Be=s,Ae-=257,256):(M=o,Be=l,-1),S=g,x=m,me=z=O=0,_=-1,I=(se=1<<(q=fe))-1,h===1&&852<se||h===2&&592<se)return 1;for(;;){for(N=S-me,P=b[z]<L?(R=0,b[z]):b[z]>L?(R=Be[Ae+b[z]],M[le+b[z]]):(R=96,0),C=1<<S-me,g=k=1<<q;y[x+(O>>me)+(k-=C)]=N<<24|R<<16|P|0,k!==0;);for(C=1<<S-1;O&C;)C>>=1;if(C!==0?(O&=C-1,O+=C):O=0,z++,--ne[S]==0){if(S===H)break;S=p[u+b[z]]}if(fe<S&&(O&I)!==_){for(me===0&&(me=fe),x+=g,F=1<<(q=S-me);q+me<H&&!((F-=ne[q+me])<=0);)q++,F<<=1;if(se+=1<<q,h===1&&852<se||h===2&&592<se)return 1;y[_=O&I]=fe<<24|q<<16|x-m|0}}return O!==0&&(y[x+O]=S-me<<24|64<<16|0),v.bits=fe,0}},{"../utils/common":41}],51:[function(e,c,r){c.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(e,c,r){var n=e("../utils/common"),i=0,s=1;function o(w){for(var B=w.length;0<=--B;)w[B]=0}var l=0,h=29,p=256,u=p+1+h,f=30,y=19,m=2*u+1,b=15,v=16,C=7,k=256,_=16,I=17,x=18,L=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],N=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],R=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],P=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],ee=new Array(2*(u+2));o(ee);var S=new Array(2*f);o(S);var z=new Array(512);o(z);var g=new Array(256);o(g);var H=new Array(h);o(H);var fe,q,me,F=new Array(f);function se(w,B,Z,G,A){this.static_tree=w,this.extra_bits=B,this.extra_base=Z,this.elems=G,this.max_length=A,this.has_stree=w&&w.length}function O(w,B){this.dyn_tree=w,this.max_code=0,this.stat_desc=B}function M(w){return w<256?z[w]:z[256+(w>>>7)]}function le(w,B){w.pending_buf[w.pending++]=255&B,w.pending_buf[w.pending++]=B>>>8&255}function ne(w,B,Z){w.bi_valid>v-Z?(w.bi_buf|=B<<w.bi_valid&65535,le(w,w.bi_buf),w.bi_buf=B>>v-w.bi_valid,w.bi_valid+=Z-v):(w.bi_buf|=B<<w.bi_valid&65535,w.bi_valid+=Z)}function Q(w,B,Z){ne(w,Z[2*B],Z[2*B+1])}function Be(w,B){for(var Z=0;Z|=1&w,w>>>=1,Z<<=1,0<--B;);return Z>>>1}function Ae(w,B,Z){var G,A,K=new Array(b+1),ie=0;for(G=1;G<=b;G++)K[G]=ie=ie+Z[G-1]<<1;for(A=0;A<=B;A++){var Y=w[2*A+1];Y!==0&&(w[2*A]=Be(K[Y]++,Y))}}function he(w){var B;for(B=0;B<u;B++)w.dyn_ltree[2*B]=0;for(B=0;B<f;B++)w.dyn_dtree[2*B]=0;for(B=0;B<y;B++)w.bl_tree[2*B]=0;w.dyn_ltree[2*k]=1,w.opt_len=w.static_len=0,w.last_lit=w.matches=0}function be(w){8<w.bi_valid?le(w,w.bi_buf):0<w.bi_valid&&(w.pending_buf[w.pending++]=w.bi_buf),w.bi_buf=0,w.bi_valid=0}function Le(w,B,Z,G){var A=2*B,K=2*Z;return w[A]<w[K]||w[A]===w[K]&&G[B]<=G[Z]}function De(w,B,Z){for(var G=w.heap[Z],A=Z<<1;A<=w.heap_len&&(A<w.heap_len&&Le(B,w.heap[A+1],w.heap[A],w.depth)&&A++,!Le(B,G,w.heap[A],w.depth));)w.heap[Z]=w.heap[A],Z=A,A<<=1;w.heap[Z]=G}function Ye(w,B,Z){var G,A,K,ie,Y=0;if(w.last_lit!==0)for(;G=w.pending_buf[w.d_buf+2*Y]<<8|w.pending_buf[w.d_buf+2*Y+1],A=w.pending_buf[w.l_buf+Y],Y++,G===0?Q(w,A,B):(Q(w,(K=g[A])+p+1,B),(ie=L[K])!==0&&ne(w,A-=H[K],ie),Q(w,K=M(--G),Z),(ie=N[K])!==0&&ne(w,G-=F[K],ie)),Y<w.last_lit;);Q(w,k,B)}function Xe(w,B){var Z,G,A,K=B.dyn_tree,ie=B.stat_desc.static_tree,Y=B.stat_desc.has_stree,de=B.stat_desc.elems,xe=-1;for(w.heap_len=0,w.heap_max=m,Z=0;Z<de;Z++)K[2*Z]!==0?(w.heap[++w.heap_len]=xe=Z,w.depth[Z]=0):K[2*Z+1]=0;for(;w.heap_len<2;)K[2*(A=w.heap[++w.heap_len]=xe<2?++xe:0)]=1,w.depth[A]=0,w.opt_len--,Y&&(w.static_len-=ie[2*A+1]);for(B.max_code=xe,Z=w.heap_len>>1;1<=Z;Z--)De(w,K,Z);for(A=de;Z=w.heap[1],w.heap[1]=w.heap[w.heap_len--],De(w,K,1),G=w.heap[1],w.heap[--w.heap_max]=Z,w.heap[--w.heap_max]=G,K[2*A]=K[2*Z]+K[2*G],w.depth[A]=(w.depth[Z]>=w.depth[G]?w.depth[Z]:w.depth[G])+1,K[2*Z+1]=K[2*G+1]=A,w.heap[1]=A++,De(w,K,1),2<=w.heap_len;);w.heap[--w.heap_max]=w.heap[1],function(ge,qe){var ht,it,pt,ye,_t,pn,Qe=qe.dyn_tree,Zt=qe.max_code,ts=qe.stat_desc.static_tree,ns=qe.stat_desc.has_stree,ss=qe.stat_desc.extra_bits,gn=qe.stat_desc.extra_base,St=qe.stat_desc.max_length,At=0;for(ye=0;ye<=b;ye++)ge.bl_count[ye]=0;for(Qe[2*ge.heap[ge.heap_max]+1]=0,ht=ge.heap_max+1;ht<m;ht++)St<(ye=Qe[2*Qe[2*(it=ge.heap[ht])+1]+1]+1)&&(ye=St,At++),Qe[2*it+1]=ye,Zt<it||(ge.bl_count[ye]++,_t=0,gn<=it&&(_t=ss[it-gn]),pn=Qe[2*it],ge.opt_len+=pn*(ye+_t),ns&&(ge.static_len+=pn*(ts[2*it+1]+_t)));if(At!==0){do{for(ye=St-1;ge.bl_count[ye]===0;)ye--;ge.bl_count[ye]--,ge.bl_count[ye+1]+=2,ge.bl_count[St]--,At-=2}while(0<At);for(ye=St;ye!==0;ye--)for(it=ge.bl_count[ye];it!==0;)Zt<(pt=ge.heap[--ht])||(Qe[2*pt+1]!==ye&&(ge.opt_len+=(ye-Qe[2*pt+1])*Qe[2*pt],Qe[2*pt+1]=ye),it--)}}(w,B),Ae(K,xe,w.bl_count)}function d(w,B,Z){var G,A,K=-1,ie=B[1],Y=0,de=7,xe=4;for(ie===0&&(de=138,xe=3),B[2*(Z+1)+1]=65535,G=0;G<=Z;G++)A=ie,ie=B[2*(G+1)+1],++Y<de&&A===ie||(Y<xe?w.bl_tree[2*A]+=Y:A!==0?(A!==K&&w.bl_tree[2*A]++,w.bl_tree[2*_]++):Y<=10?w.bl_tree[2*I]++:w.bl_tree[2*x]++,K=A,xe=(Y=0)===ie?(de=138,3):A===ie?(de=6,3):(de=7,4))}function U(w,B,Z){var G,A,K=-1,ie=B[1],Y=0,de=7,xe=4;for(ie===0&&(de=138,xe=3),G=0;G<=Z;G++)if(A=ie,ie=B[2*(G+1)+1],!(++Y<de&&A===ie)){if(Y<xe)for(;Q(w,A,w.bl_tree),--Y!=0;);else A!==0?(A!==K&&(Q(w,A,w.bl_tree),Y--),Q(w,_,w.bl_tree),ne(w,Y-3,2)):Y<=10?(Q(w,I,w.bl_tree),ne(w,Y-3,3)):(Q(w,x,w.bl_tree),ne(w,Y-11,7));K=A,xe=(Y=0)===ie?(de=138,3):A===ie?(de=6,3):(de=7,4)}}o(F);var $=!1;function E(w,B,Z,G){ne(w,(l<<1)+(G?1:0),3),function(A,K,ie,Y){be(A),le(A,ie),le(A,~ie),n.arraySet(A.pending_buf,A.window,K,ie,A.pending),A.pending+=ie}(w,B,Z)}r._tr_init=function(w){$||(function(){var B,Z,G,A,K,ie=new Array(b+1);for(A=G=0;A<h-1;A++)for(H[A]=G,B=0;B<1<<L[A];B++)g[G++]=A;for(g[G-1]=A,A=K=0;A<16;A++)for(F[A]=K,B=0;B<1<<N[A];B++)z[K++]=A;for(K>>=7;A<f;A++)for(F[A]=K<<7,B=0;B<1<<N[A]-7;B++)z[256+K++]=A;for(Z=0;Z<=b;Z++)ie[Z]=0;for(B=0;B<=143;)ee[2*B+1]=8,B++,ie[8]++;for(;B<=255;)ee[2*B+1]=9,B++,ie[9]++;for(;B<=279;)ee[2*B+1]=7,B++,ie[7]++;for(;B<=287;)ee[2*B+1]=8,B++,ie[8]++;for(Ae(ee,u+1,ie),B=0;B<f;B++)S[2*B+1]=5,S[2*B]=Be(B,5);fe=new se(ee,L,p+1,u,b),q=new se(S,N,0,f,b),me=new se(new Array(0),R,0,y,C)}(),$=!0),w.l_desc=new O(w.dyn_ltree,fe),w.d_desc=new O(w.dyn_dtree,q),w.bl_desc=new O(w.bl_tree,me),w.bi_buf=0,w.bi_valid=0,he(w)},r._tr_stored_block=E,r._tr_flush_block=function(w,B,Z,G){var A,K,ie=0;0<w.level?(w.strm.data_type===2&&(w.strm.data_type=function(Y){var de,xe=4093624447;for(de=0;de<=31;de++,xe>>>=1)if(1&xe&&Y.dyn_ltree[2*de]!==0)return i;if(Y.dyn_ltree[18]!==0||Y.dyn_ltree[20]!==0||Y.dyn_ltree[26]!==0)return s;for(de=32;de<p;de++)if(Y.dyn_ltree[2*de]!==0)return s;return i}(w)),Xe(w,w.l_desc),Xe(w,w.d_desc),ie=function(Y){var de;for(d(Y,Y.dyn_ltree,Y.l_desc.max_code),d(Y,Y.dyn_dtree,Y.d_desc.max_code),Xe(Y,Y.bl_desc),de=y-1;3<=de&&Y.bl_tree[2*P[de]+1]===0;de--);return Y.opt_len+=3*(de+1)+5+5+4,de}(w),A=w.opt_len+3+7>>>3,(K=w.static_len+3+7>>>3)<=A&&(A=K)):A=K=Z+5,Z+4<=A&&B!==-1?E(w,B,Z,G):w.strategy===4||K===A?(ne(w,2+(G?1:0),3),Ye(w,ee,S)):(ne(w,4+(G?1:0),3),function(Y,de,xe,ge){var qe;for(ne(Y,de-257,5),ne(Y,xe-1,5),ne(Y,ge-4,4),qe=0;qe<ge;qe++)ne(Y,Y.bl_tree[2*P[qe]+1],3);U(Y,Y.dyn_ltree,de-1),U(Y,Y.dyn_dtree,xe-1)}(w,w.l_desc.max_code+1,w.d_desc.max_code+1,ie+1),Ye(w,w.dyn_ltree,w.dyn_dtree)),he(w),G&&be(w)},r._tr_tally=function(w,B,Z){return w.pending_buf[w.d_buf+2*w.last_lit]=B>>>8&255,w.pending_buf[w.d_buf+2*w.last_lit+1]=255&B,w.pending_buf[w.l_buf+w.last_lit]=255&Z,w.last_lit++,B===0?w.dyn_ltree[2*Z]++:(w.matches++,B--,w.dyn_ltree[2*(g[Z]+p+1)]++,w.dyn_dtree[2*M(B)]++),w.last_lit===w.lit_bufsize-1},r._tr_align=function(w){ne(w,2,3),Q(w,k,ee),function(B){B.bi_valid===16?(le(B,B.bi_buf),B.bi_buf=0,B.bi_valid=0):8<=B.bi_valid&&(B.pending_buf[B.pending++]=255&B.bi_buf,B.bi_buf>>=8,B.bi_valid-=8)}(w)}},{"../utils/common":41}],53:[function(e,c,r){c.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(e,c,r){(function(n){(function(i,s){if(!i.setImmediate){var o,l,h,p,u=1,f={},y=!1,m=i.document,b=Object.getPrototypeOf&&Object.getPrototypeOf(i);b=b&&b.setTimeout?b:i,o={}.toString.call(i.process)==="[object process]"?function(_){process.nextTick(function(){C(_)})}:function(){if(i.postMessage&&!i.importScripts){var _=!0,I=i.onmessage;return i.onmessage=function(){_=!1},i.postMessage("","*"),i.onmessage=I,_}}()?(p="setImmediate$"+Math.random()+"$",i.addEventListener?i.addEventListener("message",k,!1):i.attachEvent("onmessage",k),function(_){i.postMessage(p+_,"*")}):i.MessageChannel?((h=new MessageChannel).port1.onmessage=function(_){C(_.data)},function(_){h.port2.postMessage(_)}):m&&"onreadystatechange"in m.createElement("script")?(l=m.documentElement,function(_){var I=m.createElement("script");I.onreadystatechange=function(){C(_),I.onreadystatechange=null,l.removeChild(I),I=null},l.appendChild(I)}):function(_){setTimeout(C,0,_)},b.setImmediate=function(_){typeof _!="function"&&(_=new Function(""+_));for(var I=new Array(arguments.length-1),x=0;x<I.length;x++)I[x]=arguments[x+1];var L={callback:_,args:I};return f[u]=L,o(u),u++},b.clearImmediate=v}function v(_){delete f[_]}function C(_){if(y)setTimeout(C,0,_);else{var I=f[_];if(I){y=!0;try{(function(x){var L=x.callback,N=x.args;switch(N.length){case 0:L();break;case 1:L(N[0]);break;case 2:L(N[0],N[1]);break;case 3:L(N[0],N[1],N[2]);break;default:L.apply(s,N)}})(I)}finally{v(_),y=!1}}}}function k(_){_.source===i&&typeof _.data=="string"&&_.data.indexOf(p)===0&&C(+_.data.slice(p.length))}})(typeof self>"u"?n===void 0?this:n:self)}).call(this,typeof bn<"u"?bn:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(Ci);var La=Ci.exports;const Ts=bi(La);var wi={exports:{}};(function(t){var a=function(){var e=String.fromCharCode,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",n={};function i(o,l){if(!n[o]){n[o]={};for(var h=0;h<o.length;h++)n[o][o.charAt(h)]=h}return n[o][l]}var s={compressToBase64:function(o){if(o==null)return"";var l=s._compress(o,6,function(h){return c.charAt(h)});switch(l.length%4){default:case 0:return l;case 1:return l+"===";case 2:return l+"==";case 3:return l+"="}},decompressFromBase64:function(o){return o==null?"":o==""?null:s._decompress(o.length,32,function(l){return i(c,o.charAt(l))})},compressToUTF16:function(o){return o==null?"":s._compress(o,15,function(l){return e(l+32)})+" "},decompressFromUTF16:function(o){return o==null?"":o==""?null:s._decompress(o.length,16384,function(l){return o.charCodeAt(l)-32})},compressToUint8Array:function(o){for(var l=s.compress(o),h=new Uint8Array(l.length*2),p=0,u=l.length;p<u;p++){var f=l.charCodeAt(p);h[p*2]=f>>>8,h[p*2+1]=f%256}return h},decompressFromUint8Array:function(o){if(o==null)return s.decompress(o);for(var l=new Array(o.length/2),h=0,p=l.length;h<p;h++)l[h]=o[h*2]*256+o[h*2+1];var u=[];return l.forEach(function(f){u.push(e(f))}),s.decompress(u.join(""))},compressToEncodedURIComponent:function(o){return o==null?"":s._compress(o,6,function(l){return r.charAt(l)})},decompressFromEncodedURIComponent:function(o){return o==null?"":o==""?null:(o=o.replace(/ /g,"+"),s._decompress(o.length,32,function(l){return i(r,o.charAt(l))}))},compress:function(o){return s._compress(o,16,function(l){return e(l)})},_compress:function(o,l,h){if(o==null)return"";var p,u,f={},y={},m="",b="",v="",C=2,k=3,_=2,I=[],x=0,L=0,N;for(N=0;N<o.length;N+=1)if(m=o.charAt(N),Object.prototype.hasOwnProperty.call(f,m)||(f[m]=k++,y[m]=!0),b=v+m,Object.prototype.hasOwnProperty.call(f,b))v=b;else{if(Object.prototype.hasOwnProperty.call(y,v)){if(v.charCodeAt(0)<256){for(p=0;p<_;p++)x=x<<1,L==l-1?(L=0,I.push(h(x)),x=0):L++;for(u=v.charCodeAt(0),p=0;p<8;p++)x=x<<1|u&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,u=u>>1}else{for(u=1,p=0;p<_;p++)x=x<<1|u,L==l-1?(L=0,I.push(h(x)),x=0):L++,u=0;for(u=v.charCodeAt(0),p=0;p<16;p++)x=x<<1|u&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,u=u>>1}C--,C==0&&(C=Math.pow(2,_),_++),delete y[v]}else for(u=f[v],p=0;p<_;p++)x=x<<1|u&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,u=u>>1;C--,C==0&&(C=Math.pow(2,_),_++),f[b]=k++,v=String(m)}if(v!==""){if(Object.prototype.hasOwnProperty.call(y,v)){if(v.charCodeAt(0)<256){for(p=0;p<_;p++)x=x<<1,L==l-1?(L=0,I.push(h(x)),x=0):L++;for(u=v.charCodeAt(0),p=0;p<8;p++)x=x<<1|u&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,u=u>>1}else{for(u=1,p=0;p<_;p++)x=x<<1|u,L==l-1?(L=0,I.push(h(x)),x=0):L++,u=0;for(u=v.charCodeAt(0),p=0;p<16;p++)x=x<<1|u&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,u=u>>1}C--,C==0&&(C=Math.pow(2,_),_++),delete y[v]}else for(u=f[v],p=0;p<_;p++)x=x<<1|u&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,u=u>>1;C--,C==0&&(C=Math.pow(2,_),_++)}for(u=2,p=0;p<_;p++)x=x<<1|u&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,u=u>>1;for(;;)if(x=x<<1,L==l-1){I.push(h(x));break}else L++;return I.join("")},decompress:function(o){return o==null?"":o==""?null:s._decompress(o.length,32768,function(l){return o.charCodeAt(l)})},_decompress:function(o,l,h){var p=[],u=4,f=4,y=3,m="",b=[],v,C,k,_,I,x,L,N={val:h(0),position:l,index:1};for(v=0;v<3;v+=1)p[v]=v;for(k=0,I=Math.pow(2,2),x=1;x!=I;)_=N.val&N.position,N.position>>=1,N.position==0&&(N.position=l,N.val=h(N.index++)),k|=(_>0?1:0)*x,x<<=1;switch(k){case 0:for(k=0,I=Math.pow(2,8),x=1;x!=I;)_=N.val&N.position,N.position>>=1,N.position==0&&(N.position=l,N.val=h(N.index++)),k|=(_>0?1:0)*x,x<<=1;L=e(k);break;case 1:for(k=0,I=Math.pow(2,16),x=1;x!=I;)_=N.val&N.position,N.position>>=1,N.position==0&&(N.position=l,N.val=h(N.index++)),k|=(_>0?1:0)*x,x<<=1;L=e(k);break;case 2:return""}for(p[3]=L,C=L,b.push(L);;){if(N.index>o)return"";for(k=0,I=Math.pow(2,y),x=1;x!=I;)_=N.val&N.position,N.position>>=1,N.position==0&&(N.position=l,N.val=h(N.index++)),k|=(_>0?1:0)*x,x<<=1;switch(L=k){case 0:for(k=0,I=Math.pow(2,8),x=1;x!=I;)_=N.val&N.position,N.position>>=1,N.position==0&&(N.position=l,N.val=h(N.index++)),k|=(_>0?1:0)*x,x<<=1;p[f++]=e(k),L=f-1,u--;break;case 1:for(k=0,I=Math.pow(2,16),x=1;x!=I;)_=N.val&N.position,N.position>>=1,N.position==0&&(N.position=l,N.val=h(N.index++)),k|=(_>0?1:0)*x,x<<=1;p[f++]=e(k),L=f-1,u--;break;case 2:return b.join("")}if(u==0&&(u=Math.pow(2,y),y++),p[L])m=p[L];else if(L===f)m=C+C.charAt(0);else return null;b.push(m),p[f++]=C+m.charAt(0),u--,C=m,u==0&&(u=Math.pow(2,y),y++)}}};return s}();t!=null?t.exports=a:typeof angular<"u"&&angular!=null&&angular.module("LZString",[]).factory("LZString",function(){return a})})(wi);var Ta=wi.exports;const Ei=bi(Ta);function Ba(t){return new Worker("/assets/compression.worker-B3kqe_bR.js",{name:t==null?void 0:t.name})}let ae={},D=null,Bs=null,J=null,Se=null,an=null,Kn=null,Ns=[],Dn=null,Ds=null,Ve=null,An=0,As=0,On=0,Os=0,Ms=null,Rs=null,Mn=null,Ct=null,Ze=-1,zs=null,Rn=null,zn=null,$n=null,ki=null,_i=null,ut=!1,Ue=[],tt=[],Nt=[],$e={isScreenSaverEnabled:!0,isSoundEnabled:!0,isVibrationEnabled:!0,lastRestoreTimestamp:null,lastBackupTimestamp:null},Mt=null;const $s=new Ba;$s.onmessage=t=>{const a=t.data;try{localStorage.setItem("teacherAssistantData_v2",a),console.log("Background save complete.")}catch(e){console.error("Background storage failed:",e)}};$s.onerror=t=>{console.error("❌ Worker Communication Error:",t.message,t)};function oe(t=!1){if(ut)return;const e=JSON.stringify({classrooms:ae,trashBin:Ue,userSettings:$e});if(t){Mt&&clearTimeout(Mt);try{const c=Ei.compressToUTF16(e);localStorage.setItem("teacherAssistantData_v2",c),console.log("Immediate save complete.")}catch(c){console.error("Immediate save failed:",c)}return}Mt&&clearTimeout(Mt),Mt=setTimeout(()=>{$s.postMessage(e),Mt=null},500)}function Na(t){return new Promise((a,e)=>{const c=new FileReader;c.onerror=e,c.onload=()=>{a(c.result.split(",")[1])},c.readAsDataURL(t)})}async function Si(t=[]){const a={};if(t.length>0)t.forEach(l=>{ae[l]&&(a[l]=ae[l])});else for(const l in ae)ae[l].isDeleted||(a[l]=ae[l]);const e={metadata:{version:"2.0-b64",createdAt:new Date().toISOString()},data:{classrooms:a,trashBin:Ue,userSettings:$e}},c=JSON.stringify(e),r=new Date,n=new Intl.DateTimeFormat("fa-IR-u-nu-latn",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(r).reduce((l,h)=>(l[h.type]=h.value,l),{}),s=`${n.year.slice(-2)}-${n.month}-${n.day}_${n.hour}-${n.minute}`;let o;t.length===0?o=`SP_Full_${s}.txt`:t.length===1?o=`SP_${t[0].replace(/[<>:"/\\|?*]/g,"").replace(/\s+/g,"_")}_${s}.txt`:o=`SP_Selected-${t.length}_${s}.txt`;try{const l=new Ts;l.file("backup.json",c);const h=await l.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:9}}),p=await Na(h);return new File([p],o,{type:"text/plain"})}catch(l){return console.error("Error creating base64 backup file:",l),null}}function Fn(){const t=localStorage.getItem("teacherAssistantData_v2");if(!t)return;let a;try{const e=Ei.decompressFromUTF16(t);e?a=JSON.parse(e):a=JSON.parse(t)}catch{console.log("Migration: Parsing legacy uncompressed data..."),a=JSON.parse(t)}a.classrooms!==void 0&&a.trashBin!==void 0?(Dt(a.classrooms),Ue=a.trashBin||[],$e={...$e,...a.userSettings}):(Dt(a),Da())}function Da(){const t=[];Object.values(ae).forEach(a=>{a.isDeleted?t.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:a.info.creationDate,type:"classroom",description:`کلاس «${a.info.name}»`,restoreData:{name:a.info.name}}):a.students.forEach(e=>{e.isDeleted&&t.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:e.identity.studentId.split("_")[1],type:"student",description:`دانش‌آموز «${e.identity.name}»`,restoreData:{studentId:e.identity.studentId,classroomName:a.info.name}})})}),Ue.length===0&&t.length>0&&(Ue=t,console.log(`Migrated ${t.length} previously deleted item(s) to the new trash bin.`),oe())}function Ii(t){const a=new wn(t.identity);return a.isDeleted=t.isDeleted,a.statusCounters=t.statusCounters,a.logs=t.logs,a.logs.scores||(a.logs.scores={}),a.profile=t.profile,a.finalClassActivityScore=t.finalClassActivityScore,a.categoryCounts=t.categoryCounts||{},a.categoryIssues=t.categoryIssues||{},a.qualitativeStats=t.qualitativeStats||{},a.onboardingSession=t.onboardingSession||null,a}function Dt(t){ae={};for(const a in t){const e=t[a];let c;e.info?c=e.info:c={...e,name:a};const r=new us(c);r.isDeleted=e.isDeleted,r.note=e.note||"",r.students=(e.students||[]).map(Ii),r.sessions=(e.sessions||[]).map(n=>{const i=new vi(n.sessionNumber);i.isDeleted=n.isDeleted,i.note=n.note||"",i.startTime=new Date(n.startTime),i.createdAt=n.createdAt?new Date(n.createdAt):new Date(n.startTime),i.endTime=n.endTime?new Date(n.endTime):null,i.isFinished=n.isFinished,i.isMakeup=n.isMakeup,i.isCancelled=n.isCancelled||!1,i.studentRecords=n.studentRecords;for(const o in i.studentRecords){const l=i.studentRecords[o];l.homework&&!(l.homework instanceof ds)&&(i.studentRecords[o].homework=new ds(l.homework.status,l.homework.comment))}i.lastWinnerByCategory=n.lastWinnerByCategory,i.lastUsedCategoryId=n.lastUsedCategoryId,i.lastSelectedWinnerId=n.lastSelectedWinnerId;const s=n.winnerHistory||[];return i.winnerHistory=s.filter(o=>o&&o.winner).map(o=>({winner:r.students.find(h=>h.identity.studentId===o.winner.identity.studentId),categoryName:o.categoryName,rating:o.rating||null})).filter(o=>o.winner),i}),r.categories=(e.categories||[]).map(n=>{const i=new mt(n.name,n.description,n.isGradedCategory);return i.id=n.id,i.isDeleted=n.isDeleted,i}),r.futurePlans=e.futurePlans,ae[a]=r}}function xi(t,a){if(a)Dt(t.data.classrooms),Zs(t.data.trashBin||[]);else{const e=t.data.classrooms,c=t.data.trashBin||[],r=new Map;for(const i in ae){const s=ae[i];s.info&&s.info.scheduleCode&&r.set(s.info.scheduleCode,i)}for(const i in e){const s=e[i],o=s.info.scheduleCode;if(r.has(o)){const l=r.get(o);l!==s.info.name&&delete ae[l],ae[s.info.name]=s}else{let l=s.info.name;for(;ae[l];)l=`${l} (Imported)`;l!==s.info.name&&(s.info.name=l),ae[l]=s}}const n=new Set(Ue.map(i=>i.id));c.forEach(i=>{n.has(i.id)||Ue.push(i)}),Dt(ae)}t.data.userSettings&&yt(t.data.userSettings),yt({lastRestoreTimestamp:new Date().toISOString()}),oe()}function Li(t,a){if(ae[a])return{success:!1,message:"کلاسی با این نام از قبل وجود دارد."};const e=ae[t];return e?(e.info.name=a,ae[a]=e,delete ae[t],D===e&&We(e),{success:!0}):{success:!1,message:"کلاس مورد نظر یافت نشد."}}function Ti(t,a,e){const c=e.trim();if(!c)return{success:!1,message:"نام دسته‌بندی نمی‌تواند خالی باشد."};if(t.categories.some(o=>o.id!==a.id&&!o.isDeleted&&o.name.toLowerCase()===c.toLowerCase()))return{success:!1,message:"دسته‌بندی دیگری با این نام وجود دارد."};const n=a.name,i=n.toLowerCase(),s=c.toLowerCase();return a.name=c,t.students.forEach(o=>{o.categoryCounts&&o.categoryCounts[n]!==void 0&&(o.categoryCounts[c]=o.categoryCounts[n],delete o.categoryCounts[n]),o.categoryIssues&&o.categoryIssues[n]!==void 0&&(o.categoryIssues[c]=o.categoryIssues[n],delete o.categoryIssues[n]),o.logs.scores&&o.logs.scores[i]&&(o.logs.scores[i].forEach(l=>l.skill=c),i!==s&&(o.logs.scores[s]=o.logs.scores[i],delete o.logs.scores[i]))}),t.sessions.forEach(o=>{o.lastWinnerByCategory&&o.lastWinnerByCategory[n]&&(o.lastWinnerByCategory[c]=o.lastWinnerByCategory[n],delete o.lastWinnerByCategory[n]),o.winnerHistory&&o.winnerHistory.forEach(l=>{l.categoryName===n&&(l.categoryName=c)})}),{success:!0}}function Bi(t,a,e){if(_e(e.students).some(l=>l.identity.name.toLowerCase()===t.identity.name.toLowerCase()))return{success:!1,message:`دانش‌آموزی با نام «${t.identity.name}» از قبل در کلاس «${e.info.name}» وجود دارد.`};const r=JSON.parse(JSON.stringify(t)),n=Ii(r),i=new Map;a.sessions.forEach(l=>{const h=l.studentRecords[t.identity.studentId];h&&i.set(l.sessionNumber,JSON.parse(JSON.stringify(h)))}),e.addStudent(n);try{const l=_e(e.sessions).filter(b=>!b.isCancelled).sort((b,v)=>v.sessionNumber-b.sessionNumber),h=l.length>0?l[0]:null;let p="؟",u={type:"system",description:"Student Move"};h&&(p=nt(e).get(h.sessionNumber)||h.sessionNumber,u={type:"fromSession",sessionNumber:h.sessionNumber});const f=new Date().toLocaleDateString("fa-IR"),y=a.info.name,m=`این دانش آموز در جلسه ${p} و در تاریخ ${f} از کلاس «${y}» به این کلاس انتقال پیدا کرد`;n.addNote(m,u)}catch(l){console.error("Failed to add automated move note:",l)}i.size>0&&e.sessions.forEach(l=>{const h=i.get(l.sessionNumber);h&&!l.isDeleted&&!l.isCancelled&&(l.studentRecords[n.identity.studentId]=h)});const s={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`(انتقال) دانش‌آموز «${t.identity.name}» از کلاس «${a.info.name}»`,restoreData:{studentId:t.identity.studentId,classId:a.info.scheduleCode}};ot(s);const o=a.students.find(l=>l.identity.studentId===t.identity.studentId);return o&&(o.isDeleted=!0),{success:!0}}function Ni(){for(const t in ae){const a=ae[t];a.students.forEach(e=>{e.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0},e.categoryCounts={},e.categoryIssues={},a.sessions.forEach(c=>{const r=e.identity.studentId;c.studentRecords[r]&&(c.studentRecords[r].attendance="present")})})}oe()}function _e(t){return Array.isArray(t)?t.filter(a=>!a.isDeleted):[]}function nt(t){const a=new Map;return t&&_e(t.sessions).filter(c=>!c.isCancelled).sort((c,r)=>c.sessionNumber-r.sessionNumber).forEach((c,r)=>{a.set(c.sessionNumber,r+1)}),a}function wt(t){Ze=t}function ct(t){zs=t}function rn(t,a){if(!t||!a)return;const e=t.identity.studentId,c=a.students.findIndex(r=>r.identity.studentId===e);c>-1&&a.students.splice(c,1),a.sessions.forEach(r=>{r.studentRecords[e]&&delete r.studentRecords[e];for(const n in r.lastWinnerByCategory)r.lastWinnerByCategory[n]===e&&delete r.lastWinnerByCategory[n];r.lastSelectedWinnerId===e&&(r.lastSelectedWinnerId=null),r.winnerHistory=r.winnerHistory.filter(n=>n.winner&&n.winner.identity.studentId!==e)})}function Fs(t,a){const e=ae[t];if(!e)return;const c=e.sessions.findIndex(r=>r.sessionNumber===a);c>-1&&(e.students.forEach(r=>{r.profile.notes&&r.profile.notes.length>0&&(r.profile.notes=r.profile.notes.filter(n=>!n.source||n.source.type!=="fromAttendance"||n.source.sessionNumber!==a)),r.onboardingSession===a&&(r.onboardingSession=null)}),e.sessions.splice(c,1))}function Ps(t,a){const e=ae[t];if(!e)return;const c=e.categories.findIndex(s=>s.id===a);if(c===-1)return;const n=e.categories[c].name,i=n.toLowerCase();e.students.forEach(s=>{s.categoryCounts&&delete s.categoryCounts[n],s.categoryIssues&&delete s.categoryIssues[n],s.logs.scores&&delete s.logs.scores[i]}),e.sessions.forEach(s=>{s.lastWinnerByCategory[n]&&delete s.lastWinnerByCategory[n],s.winnerHistory=s.winnerHistory.filter(o=>o.categoryName!==n)}),e.categories.splice(c,1)}function Hs(t,a,e,c){const r=ae[t];if(!r)return;const n=r.students.find(o=>o.identity.studentId===a);if(!n||!n.logs.scores[e.toLowerCase()])return;const i=n.logs.scores[e.toLowerCase()],s=i.findIndex(o=>o.id===c);s>-1&&i.splice(s,1)}function Ws(t,a,e){const c=ae[t];if(!c)return;const r=c.students.find(i=>i.identity.studentId===a);if(!r||!r.profile.notes)return;const n=r.profile.notes.findIndex(i=>i.id===e);n>-1&&r.profile.notes.splice(n,1)}function Di(){JSON.parse(JSON.stringify({classrooms:ae,trashBin:Ue})),ut=!0}function Ai(){ut=!1,Fn()}function ot(t){for(Ue.unshift(t);Ue.length>50;){const a=Ue.pop();Oi(a)}oe()}function Oi(t){var a;if(!(!t||!t.restoreData))switch(console.log(`🗑️ Auto-cleaning overflow item: ${t.description}`),t.type){case"classroom":t.restoreData.name&&ae[t.restoreData.name]&&delete ae[t.restoreData.name];break;case"student":(a=t.restoreData.identity)!=null&&a.studentId&&rn(t.restoreData.identity.studentId);break;case"session":t.restoreData.id&&Fs(t.restoreData.id);break;case"category":t.restoreData.id&&Ps(t.restoreData.id);break;case"score":Hs(t.restoreData);break;case"note":t.restoreData.id&&Ws(t.restoreData.id);break}}function We(t){D=t}function on(t){Bs=t}function Ge(t){J=t}function Je(t){Se=t}function Pn(t){an=t}function Mi(t){Kn=t}function Jt(t){Ns=t}function En(t){Dn=t}function Ri(t){Ds=t}function Hn(t){Ve=t}function kn(t){An=t}function zi(t){As=t}function _n(t){On=t}function $i(t){Os=t}function Us(t){Ms=t}function js(t){Rs=t}function cn(t){Mn=t}function qs(t){Ct=t}function Wn(t){zn=t}function Fi(t){ki=t}function Pi(t){_i=t}function Zs(t){Ue=t}function Yn(t){Rn=t}function ln(t){Nt=t}function yt(t){$e={...$e,...t},oe()}function Sn(t){tt=t}function Gs(){$e.lastBackupTimestamp=new Date().toISOString(),oe()}function Un(t){$n=t}const Aa=Object.freeze(Object.defineProperty({__proto__:null,get activeModal(){return Ct},addToTrashBin:ot,get cancelCallback(){return Rs},get classrooms(){return ae},get confirmCallback(){return Ms},get currentClassroom(){return D},get datePickerCallback(){return $n},get easterEggClickCount(){return An},get easterEggLastClickTime(){return As},enterDemoMode:Di,exitDemoMode:Ai,getActiveItems:_e,getSessionDisplayMap:nt,get importedFileContent(){return Dn},get isDemoMode(){return ut},get liveSession(){return Bs},loadData:Fn,get manualSelection(){return zn},moveStudent:Bi,get namesToImport(){return Ns},get notificationTimeout(){return Ds},permanentlyDeleteCategory:Ps,permanentlyDeleteFromTrash:Oi,permanentlyDeleteNote:Ws,permanentlyDeleteScore:Hs,permanentlyDeleteSession:Fs,permanentlyDeleteStudent:rn,prepareBackupData:Si,get previousState(){return an},processRestore:xi,rehydrateData:Dt,renameCategory:Ti,renameClassroom:Li,resetAllStudentCounters:Ni,get resetEasterEggClickCount(){return On},get resetEasterEggLastClickTime(){return Os},get saveCategoryCallback(){return Rn},saveData:oe,get saveNoteCallback(){return zs},get secureConfirmCallback(){return Mn},get selectedCategory(){return Ve},get selectedClassIds(){return tt},get selectedSession(){return J},get selectedStudentForProfile(){return Se},get selectedStudentsForMassComment(){return Nt},setActiveModal:qs,setCancelCallback:js,setConfirmCallback:Us,setCurrentClassroom:We,setDatePickerCallback:Un,setEasterEggClickCount:kn,setEasterEggLastClickTime:zi,setImportedFileContent:En,setLastBackupTimestamp:Gs,setLiveSession:on,setManualSelection:Wn,setNamesToImport:Jt,setNotificationTimeout:Ri,setPreviousState:Pn,setResetEasterEggClickCount:_n,setResetEasterEggLastClickTime:$i,setSaveCategoryCallback:Yn,setSaveNoteCallback:ct,setSecureConfirmCallback:cn,setSelectedCategory:Hn,setSelectedClassIds:Sn,setSelectedSession:Ge,setSelectedStudentForProfile:Je,setSelectedStudentsForMassComment:ln,setSourceClassForMove:Pi,setStudentToMove:Fi,setTrashBin:Zs,setUndoTimeout:Mi,setUserSettings:yt,setWinnerHistoryIndex:wt,get sourceClassForMove(){return _i},get studentToMove(){return ki},get trashBin(){return Ue},get undoTimeout(){return Kn},get userSettings(){return $e},get winnerHistoryIndex(){return Ze}},Symbol.toStringTag,{value:"Module"})),Oa="TeacherAssistantDB",Ma=1,vt="backups";function Hi(){return new Promise((t,a)=>{const e=indexedDB.open(Oa,Ma);e.onupgradeneeded=c=>{const r=c.target.result;r.objectStoreNames.contains(vt)||r.createObjectStore(vt,{keyPath:"id"})},e.onsuccess=c=>t(c.target.result),e.onerror=c=>a(c.target.error)})}async function Ra(t,a){const e=await Hi(),c=e.transaction(vt,"readwrite"),r=c.objectStore(vt),n={id:Date.now(),file:t,metadata:a,timestamp:new Date().toISOString()};r.add(n),c.oncomplete=()=>{const s=e.transaction(vt,"readwrite").objectStore(vt),o=s.count();o.onsuccess=()=>{if(o.result>10){const l=s.getAllKeys();l.onsuccess=()=>{const h=l.result;for(;h.length>10;){const p=h.shift();s.delete(p),console.log(`♻️ Auto-deleted old backup snapshot: ${p}`)}}}}}}async function za(){const t=await Hi();return new Promise((a,e)=>{const n=t.transaction(vt,"readonly").objectStore(vt).getAll();n.onsuccess=()=>{const i=n.result.sort((s,o)=>o.id-s.id);a(i)},n.onerror=()=>e(n.error)})}function et(t){return typeof t!="string"?"":t.replace(/ي/g,"ی").replace(/ك/g,"ک").replace(/[\s\u200c]/g,"")}function Vs(t){return typeof t!="string"||t.length===0?"ltr":/[\u0590-\u07FF]/.test(t)?"rtl":"ltr"}function Wi(t){return!t||!t.trim()?"":t.split(`
`).map(c=>`<div dir="${Vs(c)}">${c||"&nbsp;"}</div>`).join("")}function cs(t){if(typeof t!="string")return"";const a={q:"ض",w:"ص",e:"ث",r:"ق",t:"ف",y:"غ",u:"ع",i:"ه",o:"خ",p:"ح","[":"ج","]":"چ",a:"ش",s:"س",d:"ی",f:"ب",g:"ل",h:"ا",j:"ت",k:"ن",l:"م",";":"ک","'":"گ",z:"ظ",x:"ط",c:"ز",v:"ر",b:"ذ",n:"د",m:"پ",",":"و"};let e="";for(let c=0;c<t.length;c++){const r=t[c].toLowerCase();e+=a[r]||t[c]}return e}function fs(t){if(!t||typeof t!="string")return{name:"",firstName:null,lastName:null};const a=t.indexOf(".");if(a>0&&a<t.length-1){const e=t.substring(0,a).trim(),c=t.substring(a+1).trim();return{name:`${e} ${c}`,firstName:e,lastName:c}}return{name:t.trim(),firstName:null,lastName:null}}let ls=null;function pi(){if(!$e.isSoundEnabled)return;const t=window.AudioContext||window.webkitAudioContext;if(!t)return;ls||(ls=new t);const a=ls,e=()=>{const c=a.createOscillator(),r=a.createGain();c.connect(r),r.connect(a.destination),c.type="sine";const n=a.currentTime;c.frequency.setValueAtTime(450,n),r.gain.setValueAtTime(0,n),r.gain.linearRampToValueAtTime(.3,n+.002),r.gain.exponentialRampToValueAtTime(.001,n+.025),r.gain.linearRampToValueAtTime(0,n+.03),c.start(n),c.stop(n+.04)};a.state==="suspended"?a.resume().then(()=>{e()}).catch(c=>console.error("Audio resume failed:",c)):e()}const Ui="teacherAssistantLogs_v2",$a=100;function Js(){try{const t=localStorage.getItem(Ui);return t?JSON.parse(t):{}}catch(t){return console.error("Error reading logs from localStorage:",t),{}}}function ji(t){try{localStorage.setItem(Ui,JSON.stringify(t))}catch(a){console.error("Error saving logs to localStorage:",a)}}function Ee(t,a,e=null){if(!t)return;const c=Js();c[t]||(c[t]=[]);const r={timestamp:new Date().toISOString(),message:a,action:e,classroomName:t};c[t].unshift(r),c[t].length>$a&&c[t].pop(),ji(c)}function Fa(t){return Js()[t]||[]}function Pa(t,a){const e=Js();e[t]&&!e[a]&&(e[a]=e[t],delete e[t],ji(e))}var gi={toJalaali:Ha,toGregorian:qi,isValidJalaaliDate:Wa,isLeapJalaaliYear:Zi,jalaaliMonthLength:Gi,jalCal:Ks,j2d:jn,d2j:qn,g2d:Xn,d2g:Ys,jalaaliToDateObject:Vi,jalaaliWeek:ja},bt=[-61,9,38,199,426,686,756,818,1111,1181,1210,1635,2060,2097,2192,2262,2324,2394,2456,3178];function Ha(t,a,e){return Object.prototype.toString.call(t)==="[object Date]"&&(e=t.getDate(),a=t.getMonth()+1,t=t.getFullYear()),qn(Xn(t,a,e))}function qi(t,a,e){return Ys(jn(t,a,e))}function Wa(t,a,e){return t>=-61&&t<=3177&&a>=1&&a<=12&&e>=1&&e<=Gi(t,a)}function Zi(t){return Ua(t)===0}function Gi(t,a){return a<=6?31:a<=11||Zi(t)?30:29}function Ua(t){var a=bt.length,e=bt[0],c,r,n,i,s;if(t<e||t>=bt[a-1])throw new Error("Invalid Jalaali year "+t);for(s=1;s<a&&(c=bt[s],r=c-e,!(t<c));s+=1)e=c;return i=t-e,r-i<6&&(i=i-r+Ne(r+4,33)*33),n=Ke(Ke(i+1,33)-1,4),n===-1&&(n=4),n}function Ks(t,a){var e=bt.length,c=t+621,r=-14,n=bt[0],i,s,o,l,h,p,u;if(t<n||t>=bt[e-1])throw new Error("Invalid Jalaali year "+t);for(u=1;u<e&&(i=bt[u],s=i-n,!(t<i));u+=1)r=r+Ne(s,33)*8+Ne(Ke(s,33),4),n=i;return p=t-n,r=r+Ne(p,33)*8+Ne(Ke(p,33)+3,4),Ke(s,33)===4&&s-p===4&&(r+=1),l=Ne(c,4)-Ne((Ne(c,100)+1)*3,4)-150,h=20+r-l,a?{gy:c,march:h}:(s-p<6&&(p=p-s+Ne(s+4,33)*33),o=Ke(Ke(p+1,33)-1,4),o===-1&&(o=4),{leap:o,gy:c,march:h})}function jn(t,a,e){var c=Ks(t,!0);return Xn(c.gy,3,c.march)+(a-1)*31-Ne(a,7)*(a-7)+e-1}function qn(t){var a=Ys(t).gy,e=a-621,c=Ks(e,!1),r=Xn(a,3,c.march),n,i,s;if(s=t-r,s>=0){if(s<=185)return i=1+Ne(s,31),n=Ke(s,31)+1,{jy:e,jm:i,jd:n};s-=186}else e-=1,s+=179,c.leap===1&&(s+=1);return i=7+Ne(s,30),n=Ke(s,30)+1,{jy:e,jm:i,jd:n}}function Xn(t,a,e){var c=Ne((t+Ne(a-8,6)+100100)*1461,4)+Ne(153*Ke(a+9,12)+2,5)+e-34840408;return c=c-Ne(Ne(t+100100+Ne(a-8,6),100)*3,4)+752,c}function Ys(t){var a,e,c,r,n;return a=4*t+139361631,a=a+Ne(Ne(4*t+183187720,146097)*3,4)*4-3908,e=Ne(Ke(a,1461),4)*5+308,c=Ne(Ke(e,153),5)+1,r=Ke(Ne(e,153),12)+1,n=Ne(a,1461)-100100+Ne(8-r,6),{gy:n,gm:r,gd:c}}function ja(t,a,e){var c=Vi(t,a,e).getDay(),r=c==6?0:-(c+1),n=6+r;return{saturday:qn(jn(t,a,e+r)),friday:qn(jn(t,a,e+n))}}function Vi(t,a,e,c,r,n,i){var s=qi(t,a,e);return new Date(s.gy,s.gm-1,s.gd,c||0,r||0,n||0,i||0)}function Ne(t,a){return~~(t/a)}function Ke(t,a){return t-~~(t/a)*a}const Ji=document.getElementById("class-management-page"),qa=document.getElementById("new-class-name"),Za=document.getElementById("add-class-btn"),Ht=document.getElementById("class-list"),Zn=document.getElementById("undo-toast"),Ki=document.getElementById("undo-message"),Ga=document.getElementById("undo-btn"),Va=document.getElementById("settings-page"),Yi=document.getElementById("settings-class-name-header"),ms=document.getElementById("settings-student-list"),hs=document.getElementById("category-list"),Ja=document.getElementById("back-to-sessions-btn"),Ka=document.getElementById("new-student-name"),Ya=document.getElementById("add-student-btn"),Xi=document.getElementById("paste-area"),Xa=document.getElementById("process-paste-btn"),Qa=document.getElementById("csv-preview-page"),ps=document.getElementById("csv-preview-list"),er=document.getElementById("csv-confirm-btn"),tr=document.getElementById("csv-cancel-btn"),nr=document.getElementById("import-csv-btn"),sr=document.getElementById("csv-file-input"),ir=document.getElementById("column-mapping-page"),gs=document.getElementById("column-select-dropdown"),ar=document.getElementById("confirm-column-btn"),rr=document.getElementById("cancel-import-btn"),or=document.getElementById("new-category-name"),cr=document.getElementById("add-category-btn"),ys=document.querySelector(".app-header"),rt=document.getElementById("select-student-btn"),Ut=document.getElementById("select-student-btn-wrapper"),lr=document.getElementById("attendance-page"),Qt=document.getElementById("attendance-list"),dr=document.getElementById("finish-attendance-btn"),ur=document.querySelector("#class-management-page h2"),vs=document.getElementById("student-stats-header"),fr=document.getElementById("hamburger-menu-btn"),mr=document.getElementById("side-nav-menu"),hr=document.getElementById("close-nav-btn"),pr=document.getElementById("overlay"),gr=document.getElementById("backup-data-btn"),yr=document.getElementById("restore-data-btn"),Qi=document.getElementById("restore-file-input"),vr=document.getElementById("custom-confirm-modal"),ea=document.getElementById("confirm-modal-message"),bs=document.getElementById("confirm-modal-cancel-btn"),Kt=document.getElementById("confirm-modal-confirm-btn"),br=document.getElementById("secure-confirm-modal"),ta=document.getElementById("secure-confirm-message"),na=document.getElementById("secure-confirm-code"),Rt=document.getElementById("secure-confirm-input"),Cr=document.getElementById("secure-confirm-cancel-btn"),In=document.getElementById("secure-confirm-confirm-btn"),wr=document.getElementById("add-note-modal"),ke=document.getElementById("new-note-content"),Er=document.getElementById("class-save-note-btn"),kr=document.getElementById("cancel-note-btn"),Cs=document.getElementById("student-search-input"),gt=document.getElementById("student-search-results"),_r=document.getElementById("back-to-student-page-btn"),Sr=document.getElementById("graded-category-pills-container"),Ir=document.getElementById("new-score-value"),sa=document.getElementById("new-score-comment"),xr=document.getElementById("add-score-btn"),Lr=document.getElementById("profile-stats-summary"),Tr=document.getElementById("profile-scores-list"),Yt=document.getElementById("global-student-search-input"),lt=document.getElementById("global-student-search-results"),Br=document.getElementById("is-graded-checkbox"),Nr=document.getElementById("trashed-classes-list"),Dr=document.getElementById("trashed-students-list"),Ar=document.getElementById("trashed-sessions-list"),Or=document.getElementById("trashed-categories-list"),Mr=document.getElementById("trashed-notes-list"),Rr=document.getElementById("trashed-scores-list"),Ft=document.getElementById("quick-grade-form-wrapper"),ft=document.getElementById("quick-score-input"),at=document.getElementById("quick-note-textarea"),Tt=document.getElementById("quick-grade-submit-btn"),en=document.getElementById("category-selection-container"),ws=document.getElementById("selected-student-result"),Bt=document.getElementById("custom-context-menu"),zt=document.getElementById("breadcrumb-container"),zr=document.getElementById("report-config-modal"),ia=document.getElementById("report-columns-container"),aa=document.getElementById("report-print-btn"),ra=document.getElementById("report-cancel-btn");let Vt=null,Wt=null;const $r=document.getElementById("category-modal"),oa=document.getElementById("category-modal-title"),tn=document.getElementById("new-category-modal-name"),Xs=document.getElementById("new-category-modal-is-graded"),Fr=document.getElementById("category-modal-cancel-btn"),ca=document.getElementById("category-modal-save-btn"),Pr=document.getElementById("mass-comment-modal"),Hr=document.getElementById("mass-comment-modal-title"),la=document.getElementById("mass-comment-student-count-message"),nn=document.getElementById("mass-comment-content"),Qs=document.getElementById("mass-comment-append-checkbox"),Wr=document.getElementById("mass-comment-cancel-btn"),Ur=document.getElementById("mass-comment-save-btn"),Es=document.getElementById("mass-comment-btn"),xn=document.getElementById("attendance-mass-actions-container"),xt=document.createElement("input"),jr=document.getElementById("session-dashboard-page"),jt=document.getElementById("attendance-pane"),$t=document.getElementById("settings-edu-system"),dt=document.getElementById("settings-level");function Pt(t,a){let e;const r=i=>{e=setTimeout(()=>{$e.isVibrationEnabled&&navigator.vibrate&&navigator.vibrate(50),a(i)},800)},n=()=>{clearTimeout(e)};t.addEventListener("touchstart",r,{passive:!0}),t.addEventListener("touchend",n),t.addEventListener("touchmove",n),t.addEventListener("mousedown",r),t.addEventListener("mouseup",n),t.addEventListener("mouseleave",n)}function qt(t="selector"){if(!D||!J){pe("class-management-page");return}Jr(),Tn(),Me(),st(),pe("session-dashboard-page",{tab:t}),da(),dn(t),Kr()}function dn(t){const a=document.getElementById("selector-tab-btn"),e=document.getElementById("attendance-tab-btn"),c=document.getElementById("selector-pane"),r=t==="selector";a.classList.toggle("active",r),e.classList.toggle("active",!r),c.classList.toggle("active",r),jt.classList.toggle("active",!r)}function da(){const t=document.getElementById("selector-tab-btn"),a=document.getElementById("attendance-tab-btn"),e=document.getElementById("selector-pane");t.addEventListener("click",()=>{Me(),Oe(),t.classList.add("active"),a.classList.remove("active"),e.classList.add("active"),jt.classList.remove("active"),pe("session-dashboard-page",{tab:"selector"})}),a.addEventListener("click",()=>{st(),a.classList.add("active"),t.classList.remove("active"),jt.classList.add("active"),e.classList.remove("active"),pe("session-dashboard-page",{tab:"attendance"})})}function qr(t){clearTimeout(Kn),an||Pn(JSON.stringify(ae)),Ki.textContent=t,Zn.classList.add("show"),Mi(setTimeout(()=>{Zn.classList.remove("show"),Pn(null)},5e3))}function ua(){if(an){const t=D?D.info.name:null,a=JSON.parse(an);Dt(a),t&&ae[t]?We(ae[t]):We(null),D?(kt(),hn(),je()):He(),Zn.classList.remove("show"),clearTimeout(Kn),Pn(null)}}function V(t,a=3e3){const e=document.getElementById("notification-toast");e&&(e.textContent=t,e.classList.add("show"),clearTimeout(Ds),Ri(setTimeout(()=>{e.classList.remove("show")},a)))}function Gn(t){var b;const a=document.getElementById("restore-confirm-modal"),e=document.getElementById("restore-modal-message"),c=document.getElementById("restore-append-checkbox"),r=document.querySelector('label[for="restore-append-checkbox"]'),n=document.getElementById("restore-confirm-cancel-btn"),i=document.getElementById("restore-confirm-confirm-btn"),s=document.getElementById("restore-modal-warning");s.style.display="none";const o=((b=t.metadata)==null?void 0:b.createdAt)||0;if($e.lastRestoreTimestamp&&o<$e.lastRestoreTimestamp){const v=new Date(o).toLocaleDateString("fa-IR"),C=new Date($e.lastRestoreTimestamp).toLocaleDateString("fa-IR");s.textContent=`⚠️ هشدار: این فایل پشتیبان (${v}) قدیمی‌تر از آخرین بازیابی شما (${C}) است.`,s.style.display="block"}const l=t.data.classrooms||{},h=Object.values(l).map(v=>v.info.name),p=h.length,u="کلاس",f=h.map(v=>`<li style="margin-bottom: 4px;">🔹 ${v}</li>`).join("");e.innerHTML=`
        <div style="margin-bottom: 10px;">
            فایل پشتیبان شامل <strong>${p} ${u}</strong> زیر است:
        </div>
        <ul style="
            margin: 0; 
            padding: 10px; 
            background-color: #f8f9fa; 
            border-radius: 5px; 
            border: 1px solid #e9ecef;
            list-style: none; 
            max-height: 150px; 
            overflow-y: auto;
            text-align: right;
        ">
            ${f}
        </ul>
        <div style="margin-top: 15px;">
            لطفاً نحوه بازیابی را مشخص کنید.
        </div>
    `,c.checked=!1,r&&(r.textContent="جایگزینی کامل (حذف داده‌های فعلی)");const y=()=>{const v=c.checked;xi(t,v),i.onclick=null,n.onclick=null,a.removeEventListener("click",y),ve(),He(),pe("class-management-page"),V(`✅ اطلاعات با موفقیت بازیابی شد (${v?"پاک‌سازی و بازیابی":"همگام‌سازی هوشمند"}).`)},m=()=>{i.onclick=null,n.onclick=null,ve()};i.onclick=y,n.onclick=m,Re("restore-confirm-modal")}function we(t,a,e={}){const{confirmText:c="تایید",cancelText:r="لغو",confirmClass:n="btn-success",onCancel:i=()=>{},isDelete:s=!1}=e,o=s?()=>fa(t,a):a;ea.textContent=t,Kt.textContent=c,bs.textContent=r,Kt.className="modal-action-btn",Kt.classList.add(n),Us(o),js(i);const l=Kt.parentElement;bs.style.display=i===null?"none":"inline-block",l.style.justifyContent=i===null?"center":"space-between",Re("custom-confirm-modal")}function fa(t,a){const e=Math.floor(1e4+Math.random()*9e4).toString();ta.textContent=t,na.textContent=e,Rt.value="",In.disabled=!0,cn(a),Re("secure-confirm-modal"),Rt.focus();const c=()=>{Rt.value===e?In.disabled=!1:In.disabled=!0};return Rt.addEventListener("input",c),()=>{Rt.removeEventListener("input",c)}}function ks(t,a={}){const{title:e="ایجاد دسته‌بندی جدید",initialName:c="",initialIsGraded:r=!1,saveButtonText:n="ذخیره"}=a;oa.textContent=e,tn.value=c,Xs.checked=r,ca.textContent=n,Yn((i,s)=>{if(!i){V("⚠️ لطفاً نام دسته‌بندی را وارد کنید.");return}t(i,s),ve()}),Re("category-modal"),tn.focus(),c&&tn.select()}function ei(t,a){const e=Object.values(ae).filter(i=>!i.isDeleted&&i.info.name!==a.info.name),c=document.getElementById("move-student-modal-title"),r=document.getElementById("move-student-class-select"),n=document.getElementById("move-student-confirm-btn");c.textContent=`انتقال دانش‌آموز: ${t.identity.name}`,r.innerHTML="",e.length===0?(r.innerHTML='<option value="">کلاس دیگری برای انتقال وجود ندارد</option>',n.disabled=!0):(e.forEach(i=>{const s=document.createElement("option");s.value=i.info.name,s.textContent=i.info.name,r.appendChild(s)}),n.disabled=!1),Fi(t),Pi(a),Re("move-student-modal")}function Vn(t,a){if(!t||!a)return;const e=t.identity.name,c=t.identity.firstName||"";t.identity.lastName;const r=document.getElementById("add-note-modal-title");r.textContent="تغییر نام دانش‌ آموز";const n=t.identity.firstName&&t.identity.lastName?`${t.identity.firstName} . ${t.identity.lastName}`:e;ke.value=n,ke.rows=1,ke.dispatchEvent(new Event("input",{bubbles:!0})),ct(i=>{const s=i.indexOf(".");if(s<=0||s>=i.length-1)return V("لطفا نام و نام خانوادگی شخص را با یک نقطه از هم جدا کنید. مثال: علی . احمدی"),!1;const o=fs(i),l=o.name,h=o.firstName||"";if(t.identity.firstName&&t.identity.lastName&&!o.firstName)return V("⚠️ این دانش‌آموز دارای نام و نام‌خانوادگی تفکیک شده است. لطفاً حتماً از نقطه (.) بین نام و نام‌خانوادگی استفاده کنید."),!1;if(l&&(l!==e||h!==c)){if(_e(a.students).some(m=>m.identity.studentId!==t.identity.studentId&&m.identity.name.toLowerCase()===l.toLowerCase()))return V("دانش‌آموزی با این نام از قبل در این کلاس وجود دارد."),!1;{t.identity.name=l,t.identity.firstName=o.firstName,t.identity.lastName=o.lastName,Ee(a.info.name,`نام دانش‌آموز «${e}» به «${l}» تغییر یافت.`,{type:"VIEW_STUDENT_PROFILE",studentId:t.identity.studentId}),oe(),kt(),Me(),st(),Oe(),Se&&Se.identity.studentId===t.identity.studentId&&Fe(t);const m=document.querySelector(`#settings-student-list li[data-student-id="${t.identity.studentId}"]`);m&&(m.classList.add("recently-updated"),setTimeout(()=>{m&&m.classList.remove("recently-updated")},1e4),m.scrollIntoView({behavior:"smooth",block:"center"})),V(`✅ نام دانش‌آموز به «${l}» تغییر یافت.`)}}else if(!l)return V("⚠️ نام نمی‌تواند خالی باشد."),!1;const f=document.getElementById("add-note-modal-title");f.textContent="ثبت یادداشت جدید",ke.rows=4}),Re("add-note-modal"),ke.focus(),ke.select()}function Re(t){const a=document.getElementById(t);if(a){if(Ct)return;a.classList.add("modal-visible"),qs(t),history.pushState(null,"",location.href)}}function ve(t,a=!1){if(!Ct)return;const e=document.getElementById(Ct),c=Ct;qs(null),c==="student-profile-modal"&&Je(null),a||history.back(),e&&(e.classList.add("modal-closing"),setTimeout(()=>{e.classList.remove("modal-visible"),e.classList.remove("modal-closing"),c==="custom-confirm-modal"&&(Us(null),js(null)),c==="secure-confirm-modal"&&cn(null),c==="category-modal"&&Yn(null),c==="mass-comment-modal"&&(nn.value=""),c==="add-note-modal"&&ct(null),typeof t=="function"&&t()},300))}function ti(){if(!jt||!jt.classList.contains("active")){xn.style.display="none";return}const t=Nt.length;t<1?xn.style.display="none":xn.style.display="block",Es.disabled=t<1,Es.textContent=`📝 ثبت یادداشت گروهی (${t} نفر)`}function ni(){const t=Nt,a=t.length;let e=!1;a>0&&(e=t.some(r=>{var n;return(n=J.studentRecords[r])==null?void 0:n.homework.comment})),la.textContent=`یادداشت برای ${a} دانش‌آموز ثبت خواهد شد.`,nn.value="",nn.dispatchEvent(new Event("input",{bubbles:!0})),Qs.checked=!0;const c=document.querySelector("#mass-comment-modal .modal-options");c.style.display=e?"flex":"none",Re("mass-comment-modal"),nn.focus()}function _s(t,a){if(!D||!J)return;let e=0;const c=Nt,r=J;c.forEach(n=>{const i=r.studentRecords[n];if(i&&i.homework){const s=i.homework.comment||"";let o=t;a&&s.length>0?o=s+`
---
`+t:o=t,i.homework.comment=o.trim();const l=D.students.find(h=>h.identity.studentId===n);l&&Zr(l,r,o.trim()),e++}}),ln([]),oe(),st(),Ee(D.info.name,`${e} دانش‌آموز به صورت گروهی یادداشت تکلیف گرفتند.`,{type:"VIEW_SESSIONS"}),V(`✅ یادداشت برای ${e} دانش‌آموز ثبت شد.`)}function Zr(t,a,e){const r=nt(D).get(a.sessionNumber),n={type:"fromAttendance",sessionNumber:a.sessionNumber},i=`یادداشت جلسه ${r}:
`,s=t.profile.notes.find(o=>!o.isDeleted&&o.source&&o.source.type==="fromAttendance"&&o.source.sessionNumber===n.sessionNumber);s?e?(s.content=i+e,s.isDeleted=!1):s.isDeleted=!0:e&&t.addNote(i+e,n)}function Qn(t){ke.value=t.note||"",ct(a=>{t.note=a,oe(),Ee(t.info.name,"یادداشت کلاس ذخیره شد.",{type:"VIEW_CLASS_NOTE"}),He(),V("✅ یادداشت کلاس ذخیره شد.")}),Re("add-note-modal"),ke.focus()}function si(t,a){ke.value=t.note||"",ke.dispatchEvent(new Event("input",{bubbles:!0})),ct(e=>{t.note=e,oe(),Ee(D.info.name,`یادداشت جلسه ${a} ذخیره شد.`,{type:"VIEW_SESSIONS"}),je(),V("✅یادداشت جلسه ذخیره شد.")}),Re("add-note-modal"),ke.focus()}function Et(t){We(t),Yi.textContent=`تنظیمات کلاس: ${t.info.name}`,kt(),hn(),ba(),pe("settings-page")}function ma(t){const a=document.getElementById("log-modal-title"),e=document.getElementById("log-list");a.textContent=`گزارش فعالیت‌های کلاس: ${t}`,e.innerHTML="";const c=Fa(t);c.length===0?e.innerHTML='<li class="no-content-message">هنوز فعالیتی برای این کلاس ثبت نشده است.</li>':c.forEach(r=>{const n=document.createElement("li");n.className="log-entry";const i=new Date(r.timestamp),s=`${i.toLocaleDateString("fa-IR")} - ${i.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}`,o=document.createElement("span");o.className="log-timestamp",o.textContent=s;const l=document.createElement("span");l.className="log-message",l.textContent=r.message,r.action&&(l.classList.add("log-action-link"),l.dataset.action=JSON.stringify({...r.action,classroomName:r.classroomName})),n.appendChild(o),n.appendChild(l),e.appendChild(n)}),Re("log-modal")}document.getElementById("log-modal-close-btn").addEventListener("click",()=>{ve()});function Ss(t){const a=URL.createObjectURL(t),e=document.createElement("a");e.href=a,e.download=t.name,document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(a),setTimeout(()=>{we("آیا فایل پشتیبان با موفقیت ذخیره شد؟",()=>{Gs(),es(),V("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله، ذخیره شد",cancelText:"خیر",confirmClass:"btn-success"})},500)}async function un(t=[]){const a=await Si(t);if(!a){V("❌ خطا در ایجاد فایل پشتیبان.");return}let e="پشتیبان کامل سیستم";if(t.length>0){const r=t.join("، ");e=`${t.length===1?"پشتیبان کلاس:":"پشتیبان کلاس‌های:"} ${r}`}Ra(a,{name:a.name,description:e,version:"2.0-b64"}).catch(r=>console.error("Failed to save local snapshot:",r)),("ontouchstart"in window||navigator.maxTouchPoints>0)&&navigator.share&&navigator.canShare&&navigator.canShare({files:[a]})?we("فایل پشتیبان شما آماده است. آیا مایل به اشتراک‌گذاری آن هستید؟",()=>{try{navigator.share({title:a.name,text:"فایل پشتیبان داده‌های برنامه",files:[a]}).then(()=>{we("آیا فایل پشتیبان با موفقیت ارسال/ذخیره شد؟",()=>{Gs(),es(),V("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}catch(r){console.error("Error during sharing process:",r),Ss(a),V("⚠️خطا در فرآیند اشتراک‌گذاری. فایل در حال دانلود است.")}},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"}):(Ss(a),V("✅پشتیبان‌گیری با موفقیت انجام شد."))}function mn(t,a){t.preventDefault(),Lt(),Wt=t.target.closest("li"),Wt&&Wt.classList.add("context-menu-target"),setTimeout(()=>{const e=Bt,c=e.querySelector("ul");c.innerHTML="",a.forEach(l=>{const h=document.createElement("li");l.isSeparator?h.className="separator":(h.innerHTML=`
                    <span class="icon">${l.icon||""}</span>
                    <span class="label">${l.label}</span>
                `,l.className&&h.classList.add(l.className),h.addEventListener("click",()=>{l.action(),Lt()})),c.appendChild(h)}),e.classList.add("visible");const{offsetWidth:r,offsetHeight:n}=e,{innerHeight:i}=window,s=document.body.getBoundingClientRect();e.style.top=`${(i-n)/2}px`;const o=s.left+s.width/2;e.style.left=`${o-r/2}px`},50)}function Lt(){Bt.classList.contains("visible")&&Bt.classList.remove("visible"),Wt&&(Wt.classList.remove("context-menu-target"),Wt=null)}function ha(){var e;zt.innerHTML="";const t=document.getElementById("header-settings-btn");if(!t)return;const a=[];if(a.push({label:"کلاس‌ها",handler:()=>{We(null),Ge(null),Je(null),pe("class-management-page")}}),D){a.push({label:D.info.name,handler:()=>{Ge(null),Je(null),je(),pe("session-page")}});const c=(e=document.querySelector(".page.active"))==null?void 0:e.id;if(c==="session-page"?t.style.visibility="visible":t.style.visibility="hidden",c==="settings-page")a.push({label:"تنظیمات"});else if(J){const n=nt(D).get(J.sessionNumber)||` (#${J.sessionNumber})`;a.push({label:`جلسه ${n}`,handler:()=>{Je(null),qt("selector")}}),Se?a.push({label:`پروفایل: ${Se.identity.name}`}):c==="session-dashboard-page"&&(document.getElementById("attendance-tab-btn").classList.contains("active")?a.push({label:"حضور و غیاب"}):a.push({label:"انتخابگر"}))}}else t.style.visibility="hidden";if(a.length<=1){zt.style.display="none";return}zt.style.display="flex",a.forEach((c,r)=>{const n=document.createElement("a");if(n.textContent=c.label,n.className="breadcrumb-item",r===a.length-1||!c.handler?n.classList.add("active"):n.addEventListener("click",c.handler),zt.appendChild(n),r<a.length-1){const i=document.createElement("span");i.className="breadcrumb-separator",i.textContent="/",zt.appendChild(i)}})}function yi(t,a,e){e.innerHTML="";const c=D.sessions.filter(r=>{var n;return!r.isDeleted&&!r.isCancelled&&((n=r.studentRecords[t.identity.studentId])==null?void 0:n.attendance)==="absent"}).map(r=>({number:a.get(r.sessionNumber),isMakeup:r.isMakeup})).filter(r=>r.number!==void 0);c.length>0?(e.appendChild(document.createTextNode("جلسات غایب: ")),c.forEach((r,n)=>{const i=document.createElement("span");i.textContent=r.number,r.isMakeup&&i.classList.add("makeup-absence"),e.appendChild(i),n<c.length-1&&e.appendChild(document.createTextNode("، "))})):e.textContent="جلسات غایب: بدون غیبت"}function Ln(t,a,e,c={}){const{includePrefix:r=!0}=c;e.innerHTML="";const n=D.sessions.filter(i=>{if(i.isDeleted||i.isCancelled)return!1;const s=i.studentRecords[t.identity.studentId];return s&&s.homework&&(s.homework.status==="incomplete"||s.homework.status==="none")}).map(i=>({number:a.get(i.sessionNumber),status:i.studentRecords[t.identity.studentId].homework.status})).filter(i=>i.number!==void 0);n.length>0?(r&&e.appendChild(document.createTextNode("تکالیف ناقص: ")),n.forEach((i,s)=>{const o=document.createElement("span");o.textContent=i.number,i.status==="incomplete"&&o.classList.add("incomplete-homework"),e.appendChild(o),s<n.length-1&&e.appendChild(document.createTextNode("،"))})):r?e.textContent="تکالیف ناقص: ندارد":e.textContent="ندارد"}function Gr(t,a){var L,N,R;const e=document.createElement("li");e.className="attendance-list-item";const c=document.createElement("span");c.className="absence-info";const r=document.createElement("span");r.className="homework-info";const n=document.createElement("div");n.className="att-row-1";let i=!1;n.addEventListener("mousedown",()=>i=!1),n.addEventListener("touchstart",()=>i=!1,{passive:!0});const s=document.createElement("input");s.type="checkbox",s.className="mass-comment-checkbox",s.checked=Nt.includes(t.identity.studentId),s.addEventListener("change",()=>{const P=t.identity.studentId,ee=Nt;if(s.checked)ee.includes(P)||ee.push(P);else{const z=ee.indexOf(P);z>-1&&ee.splice(z,1)}ti();const S=document.getElementById("attendance-list");ee.length===0&&S.classList.contains("selection-mode-active")&&S.classList.remove("selection-mode-active")});const o=document.createElement("span");o.className="student-name",o.textContent=t.identity.name,o.addEventListener("click",P=>{if(i){P.stopPropagation(),P.preventDefault(),i=!1;return}Fe(t)}),Pt(n,P=>{i=!0;const ee=document.getElementById("attendance-list");ee.classList.contains("selection-mode-active")||ee.classList.add("selection-mode-active"),s.checked||(s.checked=!0,s.dispatchEvent(new Event("change")))}),n.appendChild(s),n.appendChild(o);const l=document.createElement("div");l.className="att-row-2";const h=document.createElement("button");let p=!1;h.addEventListener("mousedown",()=>p=!1),h.addEventListener("touchstart",()=>p=!1,{passive:!0});const u=((L=J.studentRecords[t.identity.studentId])==null?void 0:L.attendance)||"present",f=P=>{P==="present"?(h.textContent="حاضر",h.className="attendance-status-btn present active"):(h.textContent="غایب",h.className="attendance-status-btn absent active")};f(u),h.addEventListener("click",P=>{var z;if(p){P.stopPropagation();return}const S=(((z=J.studentRecords[t.identity.studentId])==null?void 0:z.attendance)||"present")==="present"?"absent":"present";J.setAttendance(t.identity.studentId,S),S==="absent"&&(J.studentRecords[t.identity.studentId].hadIssue=!1),oe(),f(S),yi(t,a,c),Me(),Ca()}),Pt(h,()=>{p=!0;const P=u==="present"?"absent":"present",ee=P==="present"?"حاضر":"غایب";we(`آیا مطمئن هستید که می‌خواهید وضعیت حضور تمام دانش‌آموزان را به «${ee}» تغییر دهید؟`,()=>{_e(D.students).forEach(S=>{J.setAttendance(S.identity.studentId,P),P==="absent"&&(J.studentRecords[S.identity.studentId].hadIssue=!1)}),oe(),st(),V(`✅ وضعیت تمام دانش‌آموزان به «${ee}» تغییر یافت.`)},{confirmText:"بله، اعمال کن",confirmClass:"btn-warning"})});const y=document.createElement("div");y.className="homework-controls";const m={none:"بدون تکلیف",complete:"تکلیف کامل",incomplete:"تکلیف ناقص"},b=document.createElement("button");let v=!1;b.addEventListener("mousedown",()=>v=!1),b.addEventListener("touchstart",()=>v=!1,{passive:!0});const C=((N=J.studentRecords[t.identity.studentId])==null?void 0:N.homework.status)||"none";b.className=`homework-status-btn ${C}`,b.title=m[C],b.addEventListener("click",P=>{if(v){P.stopPropagation();return}const ee=J.studentRecords[t.identity.studentId].homework,z={none:"incomplete",incomplete:"complete",complete:"none"}[ee.status];J.setHomeworkStatus(t.identity.studentId,z),oe(),b.className=`homework-status-btn ${z}`,b.title=m[z],Ln(t,a,r)}),Pt(b,()=>{v=!0;const ee={none:"incomplete",incomplete:"complete",complete:"none"}[C],S=m[ee];we(`آیا از تغییر وضعیت تکلیف تمام دانش‌آموزان به «${S}» مطمئن هستید؟`,()=>{_e(D.students).forEach(z=>{J.setHomeworkStatus(z.identity.studentId,ee)}),oe(),st(),V(`✅ وضعیت تکلیف همه به «${S}» تغییر یافت.`)},{confirmText:"بله",confirmClass:"btn-warning"})});const k=document.createElement("button");let _=!1;k.addEventListener("mousedown",()=>_=!1),k.addEventListener("touchstart",()=>_=!1,{passive:!0}),k.className="btn-icon",k.innerHTML="📝",k.title="افزودن یادداشت برای تکلیف",((R=J.studentRecords[t.identity.studentId])==null?void 0:R.homework.comment)||(k.style.opacity="0.3"),k.addEventListener("click",P=>{if(_){P.stopPropagation();return}const ee=J.studentRecords[t.identity.studentId].homework;ke.value=ee.comment||"",ke.dispatchEvent(new Event("input",{bubbles:!0})),ct(S=>{ee.comment=S;const z=nt(D),g=z.get(J.sessionNumber),H={type:"fromAttendance",sessionNumber:J.sessionNumber},fe=`یادداشت جلسه ${g}:
`,q=t.profile.notes.find(me=>!me.isDeleted&&me.source&&me.source.type==="fromAttendance"&&me.source.sessionNumber===H.sessionNumber);q?S?q.content=fe+S:q.isDeleted=!0:S&&t.addNote(fe+S,H),oe(),V("✅یادداشت تکلیف ذخیره شد."),k.style.opacity=S?"1":"0.3",Ln(t,z,r)}),Re("add-note-modal"),ke.focus()}),Pt(k,()=>{_=!0,we("آیا می‌خواهید برای **تمام** دانش‌آموزان کلاس یادداشت تکلیف ثبت کنید؟",()=>{const P=_e(D.students).map(ee=>ee.identity.studentId);ln(P),ni()},{confirmText:"بله",confirmClass:"btn-primary"})}),l.appendChild(h),y.appendChild(k),y.appendChild(b),l.appendChild(y);const x=document.createElement("div");return x.className="att-row-3",yi(t,a,c),Ln(t,a,r),x.appendChild(c),x.appendChild(r),e.appendChild(n),e.appendChild(l),e.appendChild(x),e}function Vr(){return nt(D).get(J.sessionNumber)}function st(){if(!D||!J)return;_e(D.students).forEach(r=>{J.initializeStudentRecord(r.identity.studentId)}),ln([]);const t=nt(D);ao(),Qt.innerHTML="";const a=document.createElement("li");a.className="attendance-list-header",xt.id="attendance-search-input",xt.type="text",xt.className="inline-search-input",xt.placeholder="جستجو...",xt.value="";const e=document.createElement("div");e.className="student-search-container",e.appendChild(xt);const c=document.createElement("div");c.className="header-labels-container",c.innerHTML=`
    <span class="header-label">تکلیف</span>
    <span class="header-label">حضور</span>
`,a.appendChild(e),a.appendChild(c),Qt.appendChild(a),_e(D.students).forEach(r=>{const n=Gr(r,t);Qt.appendChild(n)}),ln([]),ti(),ro(),Ca()}function Me(){const t=document.getElementById("student-stats-table-container");if(!t||(t.innerHTML="",!D))return;_e(D.students).length,vs.textContent="آمار عملکرد";const a=["نام"],e=["کل انتخاب ها","غیبت","خروج","فرصت ازدست‌رفته","مشکل","میانگین","نمره کلاسی (کانون)"],c=D.categories.filter(f=>f.isGradedCategory&&!f.isDeleted).map(f=>f.name),r=[...a,...c,...e],n=document.createElement("table");n.className="student-stats-table";const s=n.createTHead().insertRow();r.forEach((f,y)=>{const m=document.createElement("th");y===0?(m.innerHTML=`${f} <span style="opacity: 0.6;">🔗</span>`,m.title="ردیف‌های این ستون قابل کلیک هستند"):m.textContent=f,s.appendChild(m)});const o=n.createTBody(),l=_e(D.students),h=f=>{let y=0;return D.sessions.forEach(m=>{if(m.isDeleted||m.isCancelled)return;const b=m.studentRecords[f.identity.studentId];b&&b.attendance==="absent"&&y++}),y};l.forEach(f=>{const y=o.insertRow();if(y.dataset.studentId=f.identity.studentId,J){const _=J.studentRecords[f.identity.studentId];_&&_.attendance==="absent"&&y.classList.add("absent-row-highlight")}const m=y.insertCell(),b=document.createElement("span");b.textContent=f.identity.name,b.className="student-name-link",b.addEventListener("click",()=>{Fe(f)}),m.appendChild(b),c.forEach(_=>{var N;const I=y.insertCell();I.style.direction="ltr";const x=_.toLowerCase(),L=((N=f.logs.scores[x])==null?void 0:N.filter(R=>!R.isDeleted))||[];L.length>0?L.forEach((R,P)=>{const ee=document.createElement("span");ee.textContent=R.value+(R.comment?"'":""),ee.style.position="relative",R.comment&&(ee.dataset.tooltip=R.comment),I.appendChild(ee),P<L.length-1&&I.appendChild(document.createTextNode(","))}):I.textContent="",I.style.cursor="pointer",I.addEventListener("click",()=>{Oe(f,_);const R=document.getElementById("category-selection-container");R&&R.scrollIntoView({behavior:"smooth",block:"center"})})}),y.insertCell().textContent=f.statusCounters.totalSelections||0,y.insertCell().textContent=h(f),y.insertCell().textContent=f.statusCounters.outOfClassCount||0,y.insertCell().textContent=f.statusCounters.missedChances||0;const v=Object.values(f.categoryIssues||{}).reduce((_,I)=>_+I,0);y.insertCell().textContent=v;const C=f.getOverallAverageScore();y.insertCell().textContent=C!==null?C:"-";const k=D.calculateFinalStudentScore(f);y.insertCell().textContent=k!==null?k:"-"}),_e(D.students),vs.setAttribute("data-student-count",l.length),t.appendChild(n);const p=t.querySelector(".student-stats-table"),u=p==null?void 0:p.querySelector("thead th:first-child");u&&u.addEventListener("click",()=>{p.classList.toggle("name-column-expanded")})}function Oe(t=null,a=null){const e=document.getElementById("selected-student-result");e.innerHTML="",e.classList.remove("absent");let c,r;if(t&&a)c=t,r=a,Wn({student:t,categoryName:a}),wt(-1);else{if(Wn(null),!J||Ze<0||!J.winnerHistory[Ze])return;const F=J.winnerHistory[Ze];c=F.winner,r=F.categoryName}const n=document.querySelector(".current-winner-highlight");if(n&&n.classList.remove("current-winner-highlight"),c){const F=document.querySelector(`.student-stats-table tr[data-student-id="${c.identity.studentId}"]`);F&&F.classList.add("current-winner-highlight")}const i=D.categories.find(F=>F.name===r);if(i){Hn(i),ai(i);const F=document.querySelectorAll("#category-selection-container .pill");F.forEach(O=>O.classList.remove("active"));const se=Array.from(F).find(O=>O.textContent===r);se&&se.classList.add("active"),Is(i),xs(i.name)}const s=J.studentRecords[c.identity.studentId],o=(s==null?void 0:s.attendance)==="absent",l=document.createElement("div");l.className="winner-name-container";const h=document.createElement("button");h.className="btn-icon",h.innerHTML="˅",h.title="برنده قبلی";const p=!t;h.classList.toggle("is-disabled",!p||Ze<=0),h.addEventListener("click",()=>{h.classList.contains("is-disabled")?(h.classList.add("shake-animation"),setTimeout(()=>h.classList.remove("shake-animation"),200)):(wt(Ze-1),Oe())});const u=document.createElement("div");u.className="winner-name",u.innerHTML=`✨ <strong>${c.identity.name}</strong>✨`,u.classList.add("heartbeat-animation"),o&&(u.style.textDecoration="line-through",u.style.opacity="0.6",u.style.color="var(--color-secondary)"),(s==null?void 0:s.hadIssue)&&!o&&(u.style.color="var(--color-warning)",u.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"),(s==null?void 0:s.wasOutOfClass)&&!o&&(u.style.color="var(--color-strong-warning)",u.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود");const m=1e3,b=F=>{Vt=setTimeout(()=>{po(c,r),Vt=null},m)},v=()=>{Vt&&(clearTimeout(Vt),Vt=null)};u.addEventListener("mousedown",b),u.addEventListener("mouseup",v),u.addEventListener("mouseout",v),u.addEventListener("touchstart",b),u.addEventListener("touchmove",v),u.addEventListener("touchend",v),u.addEventListener("touchcancel",v);const C=document.createElement("button");if(C.className="btn-icon",C.innerHTML="˄",C.title="برنده بعدی",C.classList.toggle("is-disabled",!p||Ze>=J.winnerHistory.length-1),C.addEventListener("click",()=>{C.classList.contains("is-disabled")?(C.classList.add("shake-animation"),setTimeout(()=>C.classList.remove("shake-animation"),200)):(wt(Ze+1),Oe())}),l.appendChild(C),l.appendChild(u),c.onboardingSession===J.sessionNumber){const F=document.createElement("div");F.className="new-student-badge",F.textContent="دانش آموز جدید",l.appendChild(F)}l.appendChild(h),e.appendChild(l),rt.disabled=p&&!C.classList.contains("is-disabled");const k=document.createElement("div");k.className="status-button-container";const _=document.createElement("button");_.textContent="غایب",_.classList.add("status-button","absent-btn"),o&&_.classList.add("active");const I=document.createElement("button");I.textContent="مشکل",I.classList.add("status-button","issue-btn"),s!=null&&s.hadIssue&&I.classList.add("active");const x=document.createElement("button");x.textContent="خروج",x.classList.add("status-button","exit-btn"),s!=null&&s.wasOutOfClass&&x.classList.add("active");const L=document.createElement("button");if(L.textContent="پروفایل",L.className="status-button profile-btn",J.isFinished?_.disabled=!0:_.addEventListener("click",()=>{const F=_.classList.contains("active");x.classList.contains("active")&&(x.classList.remove("active"),s.wasOutOfClass=!1,c.statusCounters.outOfClassCount=Math.max(0,(c.statusCounters.outOfClassCount||0)-1),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)),F?(_.classList.remove("active"),J.setAttendance(c.identity.studentId,"present"),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1),u.style.textDecoration="",u.style.opacity="",u.style.color=""):(I.classList.contains("active")&&(I.classList.remove("active"),s.hadIssue=!1,c.statusCounters.otherIssues=Math.max(0,c.statusCounters.otherIssues-1),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)),_.classList.add("active"),J.setAttendance(c.identity.studentId,"absent"),c.statusCounters.missedChances++,u.style.textDecoration="line-through",u.style.opacity="0.6",u.style.color="var(--color-secondary)",u.title=""),Me(),setTimeout(()=>{Ze!==-1?Oe():Oe(c,r)},0),oe()}),J.isFinished?I.disabled=!0:I.addEventListener("click",()=>{const F=I.classList.contains("active");if(x.classList.contains("active")&&(x.classList.remove("active"),s.wasOutOfClass=!1,c.statusCounters.outOfClassCount=Math.max(0,(c.statusCounters.outOfClassCount||0)-1),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)),F){I.classList.remove("active"),s.hadIssue=!1;const se=Ve.name;c.categoryIssues[se]&&(c.categoryIssues[se]=Math.max(0,c.categoryIssues[se]-1)),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1),u.style.color="",u.title=""}else{_.classList.contains("active")&&(_.classList.remove("active"),J.setAttendance(c.identity.studentId,"present"),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)),I.classList.add("active"),s.hadIssue=!0;const se=Ve.name;c.categoryIssues[se]=(c.categoryIssues[se]||0)+1,c.statusCounters.missedChances++,u.style.textDecoration="",u.style.opacity="",u.style.color="var(--color-warning)",u.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"}Me(),setTimeout(()=>{Ze!==-1?Oe():Oe(c,r)},0),oe()}),J.isFinished?x.disabled=!0:x.addEventListener("click",()=>{if(x.classList.contains("active"))x.classList.remove("active"),s.wasOutOfClass=!1,c.statusCounters.outOfClassCount=Math.max(0,(c.statusCounters.outOfClassCount||0)-1),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1),u.style.color="",u.title="";else{if(_.classList.contains("active")&&(_.classList.remove("active"),J.setAttendance(c.identity.studentId,"present"),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)),I.classList.contains("active")){I.classList.remove("active"),s.hadIssue=!1;const se=Ve.name;c.categoryIssues[se]&&(c.categoryIssues[se]=Math.max(0,c.categoryIssues[se]-1)),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)}x.classList.add("active"),s.wasOutOfClass=!0,c.statusCounters.outOfClassCount=(c.statusCounters.outOfClassCount||0)+1,c.statusCounters.missedChances++,u.style.textDecoration="",u.style.opacity="",u.style.color="var(--color-strong-warning)",u.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود"}Me(),setTimeout(()=>{Ze!==-1?Oe():Oe(c,r)},0),oe()}),J.isFinished?L.disabled=!0:L.addEventListener("click",()=>{Fe(c)}),k.appendChild(_),k.appendChild(x),k.appendChild(I),k.appendChild(L),e.appendChild(k),r){const F=fo(c,r);e.appendChild(F)}const N=document.createElement("div");N.className="student-details-container";const R=document.createElement("div");R.className="student-details-scores",R.innerHTML="<h4>آخرین نمرات</h4>";const P=document.createElement("ul");P.className="scores-list";const ee=D.categories.filter(F=>F.isGradedCategory&&!F.isDeleted);let S=!1;const z=c.logs.scores||{};ee.forEach(F=>{var Be;const se=F.name,O=se.toLowerCase(),M=document.createElement("li"),le=document.createElement("span");le.className="skill-name",le.textContent=`${se}:`;const ne=document.createElement("span");ne.className="skill-scores";const Q=(Be=z[O])==null?void 0:Be.filter(Ae=>!Ae.isDeleted);if(Q&&Q.length>0){S=!0;const Ae=Q.slice(-3);Ae.forEach((he,be)=>{const Le=document.createElement("span");Le.textContent=he.value+(he.comment?"'":""),he.comment&&(Le.dataset.tooltip=he.comment,Le.style.position="relative",Le.style.cursor="help",Le.classList.add("tooltip-container")),ne.appendChild(Le),be<Ae.length-1&&ne.appendChild(document.createTextNode(","))})}else ne.textContent="none";M.appendChild(le),M.appendChild(ne),P.appendChild(M)}),S||(P.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>'),R.appendChild(P),N.appendChild(R);const g=document.createElement("div");g.className="student-details-notes";const H=document.createElement("div");H.className="history-section-header";const fe=document.createElement("h4");fe.textContent="یادداشت‌ها";const q=document.createElement("button");q.className="btn-icon",q.innerHTML="📝",q.title="افزودن یادداشت جدید",J.isFinished?q.disabled=!0:q.addEventListener("click",()=>{ke.value="",ke.dispatchEvent(new Event("input",{bubbles:!0})),ct(F=>{F&&(c.addNote(F),oe(),Oe(),V("✅ یادداشت با موفقیت ثبت شد."))}),Re("add-note-modal"),ke.focus()}),H.appendChild(fe),H.appendChild(q),g.appendChild(H);const me=document.createElement("ul");me.className="notes-list",c.profile.notes&&c.profile.notes.length>0?[...c.profile.notes].sort((se,O)=>new Date(O.timestamp)-new Date(se.timestamp)).forEach(se=>{const O=document.createElement("li");O.dir=Vs(se.content),O.textContent=se.content,me.appendChild(O)}):me.innerHTML='<div class="no-content-message">یادداشتی وجود ندارد.</div>',g.appendChild(me),N.appendChild(g),e.appendChild(N)}function ii(t){t.addEventListener("input",()=>{const a=t.value,e=Vs(a);t.setAttribute("dir",e)})}function Jr(){ai(null),en.innerHTML="",ws.innerHTML="",Ft.classList.add("tooltip-container"),ft.disabled=!0,at.disabled=!0,Tt.disabled=!0,ft.value="",at.value="",Ut.classList.add("disabled-wrapper"),rt.disabled=!0}function Tn(){en.innerHTML="",D.categories.filter(e=>!e.isDeleted).forEach(e=>{const c=document.createElement("span");c.className="pill",c.textContent=e.name,c.dataset.categoryId=e.id,e.description&&(c.dataset.tooltip=e.description),J.isFinished?c.classList.add("disabled"):c.addEventListener("click",()=>{document.querySelectorAll("#category-selection-container .pill").forEach(n=>n.classList.remove("active")),c.classList.add("active"),Hn(e),ai(e),Is(e),xs(e.name),Ut.classList.remove("disabled-wrapper"),rt.disabled=J.isFinished;const r=J.lastWinnerByCategory[e.name];if(r){const n=D.students.find(i=>i.identity.studentId===r);n&&Oe(n,e.name)}else{ws.innerHTML="",Wn(null),wt(-1),rt.disabled=!1;const n=document.querySelector(".current-winner-highlight");n&&n.classList.remove("current-winner-highlight")}}),J.isFinished||c.addEventListener("contextmenu",r=>{mn(r,[{label:"تغییر نام",icon:"✏️",action:()=>{ks((i,s)=>{const o=Ti(D,e,i);o.success?(e.isGradedCategory=s,oe(),Ee(D.info.name,`نام دسته‌بندی «${e.name}» به «${i}» تغییر یافت.`),Tn(),Me(),V(`✅ نام دسته‌بندی به «${i}» تغییر یافت.`)):V(`⚠️ ${o.message}`)},{title:"ویرایش دسته‌بندی",initialName:e.name,initialIsGraded:e.isGradedCategory,saveButtonText:"ذخیره تغییرات"})}},{label:"حذف دسته‌بندی",icon:"🗑️",className:"danger",action:()=>{we(`آیا از انتقال دسته‌بندی «${e.name}» به سطل زباله مطمئن هستید؟`,()=>{const i={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${e.name}» از کلاس «${D.info.name}»`,restoreData:{categoryId:e.id,classId:D.info.scheduleCode}};ot(i);const s=e.name.toLowerCase();if(D.students.forEach(o=>{o.logs.scores&&o.logs.scores[s]&&o.logs.scores[s].forEach(l=>{l.isDeleted=!0})}),Ve&&Ve.id===e.id){Hn(null),ws.innerHTML="",Is(null),xs(null),Ut.classList.add("disabled-wrapper"),rt.disabled=!0;const o=document.querySelector(".current-winner-highlight");o&&o.classList.remove("current-winner-highlight")}e.isDeleted=!0,Ee(D.info.name,`دسته‌بندی «${e.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),Tn(),Me(),V(`✅ دسته‌بندی «${e.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}}])}),en.appendChild(c)});const a=document.createElement("span");a.className="pill add-category-pill",a.textContent="+",a.title="افزودن دسته‌بندی جدید",J.isFinished?a.classList.add("disabled"):a.addEventListener("click",()=>{ks((e,c)=>{if(D.categories.find(i=>i.name.toLowerCase()===e.toLowerCase()&&!i.isDeleted)){V("⚠️ این دسته‌بندی از قبل وجود دارد.");return}const n=new mt(e,"",c);D.categories.push(n),oe(),Ee(D.info.name,`دسته‌بندی جدید «${e}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),Tn(),V(`✅ دسته‌بندی «${e}» اضافه شد.`)})}),en.appendChild(a)}function Kr(){if(J.lastUsedCategoryId){if(J.isFinished)return;const t=en.querySelector(`.pill[data-category-id="${J.lastUsedCategoryId}"]`);t&&t.click()}J.winnerHistory&&J.winnerHistory.length>0&&(wt(J.winnerHistory.length-1),Oe())}function ai(t){t?rt.textContent=`نفر بعدی در ${t.name}`:rt.textContent="نفر بعدی"}function Is(t){if(J.isFinished){ft.disabled=!0,at.disabled=!0,Tt.disabled=!0,Ft.setAttribute("title","جلسه خاتمه یافته است");return}t&&t.isGradedCategory?(ft.disabled=!1,at.disabled=!1,Tt.disabled=!1,Ft.removeAttribute("title")):(ft.disabled=!0,at.disabled=!0,Tt.disabled=!0,t?Ft.setAttribute("title","برای این دسته‌بندی قابلیت نمره دهی تعریف نشده است"):Ft.setAttribute("title","ابتدا یک دسته‌بندی را انتخاب کنید"))}function xs(t){const a=document.querySelector(".student-stats-table");if(!a||(a.querySelectorAll(".current-category-highlight").forEach(i=>{i.classList.remove("current-category-highlight")}),!t))return;let c=-1;const r=a.querySelectorAll("thead th");if(r.forEach((i,s)=>{i.textContent.trim()===t&&(c=s)}),c===-1)return;r[c].classList.add("current-category-highlight"),a.querySelectorAll("tbody tr").forEach(i=>{const s=i.cells[c];s&&s.classList.add("current-category-highlight")})}function Fe(t){Je(t);const a=document.getElementById("student-profile-modal"),e=document.getElementById("modal-profile-student-name"),c=document.getElementById("modal-profile-content-container"),r=document.getElementById("modal-profile-close-btn");if(!a||!e||!c||!r)return;e.textContent=`پروفایل: ${t.identity.name}`,e.style.cursor="pointer",e.onclick=()=>{const l=Se,h=D;ve(()=>{Vn(l,h)})},c.innerHTML="";const n=document.createElement("div");n.className="profile-header-actions";const i=document.createElement("button");i.className="btn-icon btn-icon-label",i.title="انتقال دانش‌آموز",i.innerHTML="<span>➡️</span><span>انتقال</span>",i.addEventListener("click",()=>{const l=Se,h=D;ve(()=>{ei(l,h)})});const s=document.createElement("button");s.className="btn-icon btn-icon-label",s.title="حذف دانش‌آموز",s.innerHTML="<span>🗑️</span><span>حذف</span>",s.style.color="var(--color-strong-warning)",s.addEventListener("click",()=>{const l=Se,h=D;ve(()=>{we(`آیا از انتقال دانش‌آموز «${l.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const p={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${l.identity.name}» از کلاس «${h.info.name}»`,restoreData:{studentId:l.identity.studentId,classId:h.info.scheduleCode}};ot(p),l.isDeleted=!0,Ee(h.info.name,`دانش‌آموز «${l.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),kt(),Me(),st(),V(`✅ دانش‌آموز «${l.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0,onCancel:()=>{Fe(l)}})})});const o=document.createElement("button");o.className="btn-icon btn-icon-label",o.title="افزودن یادداشت جدید",o.innerHTML="<span>📝</span><span>یادداشت</span>",o.addEventListener("click",()=>{const l=Se;ke.value="",ke.dispatchEvent(new Event("input",{bubbles:!0})),ct(h=>{if(h)return l.addNote(h),oe(),Ee(D.info.name,`یادداشت جدیدی برای دانش‌آموز «${l.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:l.identity.studentId}),Oe(),V("✅ یادداشت با موفقیت ثبت شد."),()=>Fe(l)}),ve(()=>{Re("add-note-modal"),ke.focus()})}),n.appendChild(i),n.appendChild(s),n.appendChild(o),c.appendChild(n),Yr(c),pa(c),r.onclick=()=>ve(),Re("student-profile-modal")}function Yr(t){if(!Se||!D)return;const a=document.createElement("div");a.className="scoring-section",a.innerHTML=`
    <h3>ثبت نمره جدید</h3>
    <div id="modal-graded-pills" class="category-pills"></div>
    <div class="input-group" style="margin-top: 15px; display: flex; gap: 10px;">
        <input type="number" id="modal-new-score-value" placeholder="نمره" style="width: 70px; text-align: center;">
        <input type="text" id="modal-new-score-comment" placeholder="توضیحات (اختیاری)..." style="flex-grow: 1;">
    </div>
    <button id="modal-add-score-btn" class="btn-success" style="width: 100%; margin-top: 10px;">ثبت نمره</button>
`,ii(a.querySelector("#modal-new-score-comment"));const e=a.querySelector("#modal-graded-pills");_e(D.categories).filter(n=>n.isGradedCategory).forEach(n=>{const i=document.createElement("span");i.className="pill",i.textContent=n.name,i.dataset.skillName=n.name,i.addEventListener("click",()=>{e.querySelectorAll(".pill").forEach(s=>s.classList.remove("active")),i.classList.add("active")}),e.appendChild(i)}),a.querySelector("#modal-add-score-btn").addEventListener("click",()=>{const n=e.querySelector(".pill.active");if(!n){V("⚠️لطفاً یک مهارت را برای نمره‌دهی انتخاب کنید.");return}const i=n.dataset.skillName,s=a.querySelector("#modal-new-score-value"),o=a.querySelector("#modal-new-score-comment"),l=s.value,h=o.value.trim();if(!l){V("لطفاً مقدار نمره را وارد کنید.");return}Se.addScore(i,parseFloat(l),h),oe(),Ee(D.info.name,`نمره ${l} در ${i} برای «${Se.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:Se.identity.studentId}),Me(),Oe(),s.value="",o.value="";const p=document.getElementById("modal-profile-content-container"),u=p.querySelector(".history-section");u&&u.remove(),pa(p),V(`✅ نمره برای مهارت ${i} با موفقیت ثبت شد.`)}),t.appendChild(a)}function pa(t){if(!Se)return;const a=document.createElement("div");a.className="history-section";const e=document.createElement("div");e.className="history-section-header";const c=document.createElement("h3");c.textContent="سوابق دانش‌آموز",e.appendChild(c),a.appendChild(e),Xr(a),ga(a),ya(a),t.appendChild(a)}function Xr(t){if(!Se)return;const a=Se,e=D.sessions.reduce((_,I)=>{const x=I.studentRecords[a.identity.studentId];return _+(x&&x.attendance==="absent"?1:0)},0),c=Object.values(a.categoryIssues||{}).reduce((_,I)=>_+I,0);let r=0,n=0,i=0;const s=a.qualitativeStats||{};Object.values(s).forEach(_=>{r+=_.effort||0,n+=_.good||0,i+=_.excellent||0});const o=r+n+i,l=document.createElement("div");l.className="stats-summary-box",l.innerHTML=`
        <p><strong>کل انتخاب:</strong> ${a.statusCounters.totalSelections}</p>
        <p><strong>غیبت:</strong> ${e}</p>
        <p><strong>فرصت از دست رفته:</strong> ${a.statusCounters.missedChances||0}</p>
        <p><strong>مشکل:</strong> ${c}</p>
        <p><strong>عملکرد کیفی:</strong> ${o}</p>
    `,t.appendChild(l),l.querySelector("p:nth-child(1)");const h=l.querySelector("p:nth-child(4)"),p=l.querySelector("p:nth-child(5)");t.appendChild(l);const u=_e(D.categories),f=document.createElement("div");if(f.className="stats-breakdown",u.length>0){u.forEach(I=>{var R;const x=I.name,L=((R=a.categoryCounts)==null?void 0:R[x])||0,N=document.createElement("p");N.className="stats-breakdown-item",N.innerHTML=`<strong>${x}:</strong> ${L}`,f.appendChild(N)});const _=l.querySelector("p:first-child");_&&(_.classList.add("collapsible-toggle"),_.onclick=()=>{f.classList.toggle("open"),_.classList.toggle("open")},_.after(f))}const y=document.createElement("div");y.className="stats-breakdown",u.length>0&&(u.forEach(_=>{var N;const I=_.name,x=((N=a.categoryIssues)==null?void 0:N[I])||0,L=document.createElement("p");L.className="stats-breakdown-item",L.innerHTML=`<strong>${I}:</strong> ${x}`,y.appendChild(L)}),h&&(h.classList.add("collapsible-toggle"),h.onclick=()=>{y.classList.toggle("open"),h.classList.toggle("open")},l.appendChild(y)));const m=document.createElement("div");if(m.className="stats-breakdown",o>0){for(const _ in s){const I=s[_];if((I.effort||0)+(I.good||0)+(I.excellent||0)>0){const L=document.createElement("p");L.className="stats-breakdown-item",L.innerHTML=`<strong>${_}:</strong> <span style="color:var(--color-primary)">عالی:${I.excellent}</span> | <span style="color:var(--color-success)">خوب:${I.good}</span> | <span style="color:#fd7e14">تلاش:${I.effort}</span>`,m.appendChild(L)}}p&&(p.classList.add("collapsible-toggle"),p.onclick=()=>{m.classList.toggle("open"),p.classList.toggle("open")},l.appendChild(m))}const b=document.createElement("p"),v=document.createElement("strong");v.textContent="تکالیف ناقص:";const C=document.createElement("span");C.style.marginRight="5px";const k=nt(D);Ln(a,k,C,{includePrefix:!1}),b.appendChild(v),b.appendChild(C),l.appendChild(b)}function ga(t){if(!Se)return;const a=Se,e=document.createElement("h4");e.textContent="تاریخچه نمرات:",e.style.marginTop="20px";const c=document.createElement("ul");c.className="list-container";const r=Object.values(a.logs.scores||{}).flat().filter(n=>!n.isDeleted).sort((n,i)=>new Date(i.timestamp)-new Date(n.timestamp));r.length===0?c.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>':r.forEach(n=>{const i=document.createElement("li");i.className="score-history-item";const s=document.createElement("div");s.className="item-content";const o=document.createElement("div");o.className="score-info";const l=document.createElement("span");l.className="score-skill-badge",l.textContent=n.skill;const h=document.createElement("span");h.className="score-value",h.textContent=`نمره: ${n.value}`;const p=document.createElement("span");if(p.className="score-date",p.textContent=new Date(n.timestamp).toLocaleDateString("fa-IR"),o.appendChild(l),o.appendChild(h),o.appendChild(p),s.appendChild(o),n.comment){const f=document.createElement("p");f.className="score-comment",f.innerHTML=Wi(n.comment),f.addEventListener("click",()=>{ke.value=n.comment,ke.dispatchEvent(new Event("input",{bubbles:!0})),ct(y=>{n.comment=y,oe(),Ee(D.info.name,`توضیحات نمره ${n.value} (${n.skill}) برای دانش‌آموز «${a.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:a.identity.studentId}),Fe(a),V("✅ توضیحات نمره با موفقیت ویرایش شد.")}),ve(()=>{Re("add-note-modal"),ke.focus()})}),s.appendChild(f)}const u=document.createElement("button");u.className="btn-icon delete-item-btn",u.innerHTML="🗑️",u.title="حذف این نمره",u.addEventListener("click",()=>{ve(()=>{we(`آیا از انتقال نمره ${n.value} در مهارت «${n.skill}» به سطل زباله مطمئن هستید؟`,()=>{const f={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"score",description:`نمره ${n.value} (${n.skill}) برای «${a.identity.name}»`,restoreData:{scoreId:n.id,skill:n.skill,studentId:a.identity.studentId,classId:D.info.scheduleCode}};ot(f),n.isDeleted=!0,oe(),Ee(D.info.name,`نمره ${n.value} (${n.skill}) دانش‌آموز «${a.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),Fe(a),V("✅ نمره به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{Fe(a)}})})}),i.appendChild(s),i.appendChild(u),c.appendChild(i)}),t.appendChild(e),t.appendChild(c)}function ya(t){if(!Se)return;const a=document.createElement("h4");a.textContent="تاریخچه یادداشت‌ها:",a.style.marginTop="20px";const e=document.createElement("ul");e.className="list-container",!Se.profile.notes||Se.profile.notes.length===0?e.innerHTML='<div class="no-content-message">هنوز یادداشتی ثبت نشده است.</div>':[...Se.profile.notes].filter(r=>!r.isDeleted).sort((r,n)=>new Date(n.timestamp)-new Date(r.timestamp)).forEach(r=>{const n=document.createElement("li");n.className="note-history-item";const i=document.createElement("div");i.className="item-content";const s=document.createElement("div");s.className="note-info";const o=document.createElement("span");o.className="note-date",o.textContent=new Date(r.timestamp).toLocaleDateString("fa-IR");const l=document.createElement("button");l.className="btn-icon delete-item-btn",l.innerHTML="🗑️",l.title="حذف این یادداشت",l.addEventListener("click",()=>{const p=Se;ve(()=>{we("آیا از انتقال این یادداشت به سطل زباله مطمئن هستید؟",()=>{const u={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"note",description:`یادداشت برای دانش‌آموز «${p.identity.name}»`,restoreData:{noteId:r.id,studentId:p.identity.studentId,classId:D.info.scheduleCode}};ot(u),r.isDeleted=!0,Ee(D.info.name,`یادداشت دانش‌آموز «${p.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),Fe(p),V("✅ یادداشت به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{Fe(p)}})})}),s.appendChild(o),s.appendChild(l);const h=document.createElement("p");h.className="note-content",h.innerHTML=Wi(r.content),h.addEventListener("click",()=>{const p=Se;ke.value=r.content,ke.dispatchEvent(new Event("input",{bubbles:!0})),ct(u=>{r.content=u,oe(),Ee(D.info.name,`یادداشت دانش‌آموز «${p.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:p.identity.studentId}),Fe(p),V("✅یادداشت با موفقیت ویرایش شد.")}),ve(()=>{Re("add-note-modal"),ke.focus()})}),i.appendChild(s),i.appendChild(h),n.appendChild(i),e.appendChild(n)}),t.appendChild(a),t.appendChild(e)}function va(t){gs.innerHTML="",t.forEach((a,e)=>{const c=document.createElement("option");c.value=e,c.textContent=a.trim(),gs.appendChild(c)})}function Ls(){ps.innerHTML="",Ns.forEach(t=>{const a=document.createElement("li");a.className="preview-item";const e=document.createElement("input");e.type="checkbox",e.checked=!0,e.dataset.name=t;const c=document.createElement("label");c.textContent=t,a.appendChild(e),a.appendChild(c),ps.appendChild(a)})}function Qr(t){const a=document.createElement("div");a.className="list-item-buttons";const e=document.createElement("button");return e.className="btn-icon",e.innerHTML="📝",e.title="ویرایش یادداشت کلاس",t.note||(e.style.display="none"),e.addEventListener("click",c=>{c.stopPropagation(),Qn(t)}),a.appendChild(e),a}function eo(t){const a=document.createElement("div");a.style.flexGrow="1",a.style.display="flex",a.style.flexDirection="column",a.style.alignItems="flex-start";const e=document.createElement("span");e.textContent=t.info.name,e.classList.add("class-name-display"),a.appendChild(e);const c=_e(t.students).length,r=_e(t.sessions).filter(l=>l.isFinished).length,n=co(t.info.scheduleDays),i=document.createElement("div");i.classList.add("class-stats-row");const s=document.createElement("span");s.textContent=`${c} نفر`,s.classList.add("student-count-badge"),i.appendChild(s);const o=document.createElement("span");if(o.textContent=`${r} جلسه`,o.classList.add("session-count-badge"),i.appendChild(o),n){const l=document.createElement("span");l.textContent=n,l.classList.add("schedule-days-badge"),i.appendChild(l)}return a.appendChild(i),a.addEventListener("click",()=>{We(t),Ge(null),on(D.liveSession),je(),pe("session-page")}),a}function to(t){const a=document.createElement("li");Jn(t).type==="active"&&(a.classList.add("active-class-card"),a.title="این کلاس هم‌اکنون در حال برگزاری است");const c=document.createElement("input");c.type="checkbox",c.className="mass-selection-checkbox",c.checked=tt.includes(t.info.name),c.addEventListener("click",h=>{h.stopPropagation()}),c.addEventListener("change",()=>{const h=t.info.name;if(c.checked)tt.includes(h)||tt.push(h);else{const p=tt.indexOf(h);p>-1&&tt.splice(p,1)}}),a.appendChild(c);const r=eo(t);a.appendChild(r);const n=document.createElement("div");n.style.display="flex",n.style.flexDirection="column",n.style.gap="5px",n.style.alignItems="flex-end",n.style.marginLeft="10px";const i=document.createElement("div");if(i.className="list-item-badges",t.liveSession&&!t.liveSession.isCancelled&&!t.liveSession.isDeleted){const h=document.createElement("span");h.className="warning-badge",h.textContent="جلسه باز",i.appendChild(h),a.classList.add("has-unfinished-session")}const s=document.createElement("span");if(s.className=`type-badge ${t.info.type}`,s.textContent=t.info.type==="online"?"آنلاین":"حضوری",s.title="نوع کلاس",i.appendChild(s),Jn(t).type==="incomplete"){const h=document.createElement("span");h.className="type-badge cancelled-badge",h.textContent="زمان‌بندی ناقص",h.style.cursor="pointer",h.title="برای تکمیل زمان‌بندی کلیک کنید",h.addEventListener("click",p=>{p.stopPropagation(),we("زمان‌بندی این کلاس کامل نیست. برای نمایش صحیح در لیست، لطفاً روزها و ساعت برگزاری را مشخص کنید.",()=>{Et(t)},{confirmText:"تنظیمات",confirmClass:"btn-primary"})}),i.appendChild(h)}else{const h=oo(t,ae);if(h){const p=document.createElement("span");p.className="type-badge conflict-badge",p.textContent="تداخل زمانی",p.style.cursor="pointer",p.title=`تداخل با کلاس: ${h}`,p.addEventListener("click",u=>{u.stopPropagation(),we(`زمان برگزاری این کلاس با کلاس «${h}» تداخل دارد. لطفاً زمان‌بندی را بررسی کنید.`,()=>{Et(t)},{confirmText:"تنظیمات",confirmClass:"btn-primary"})}),i.appendChild(p)}}n.appendChild(i);const l=Qr(t);return n.appendChild(l),a.appendChild(n),a.addEventListener("contextmenu",h=>{const p={label:"پشتیبان‌گیری از این کلاس",icon:"📤",action:()=>{un([t.info.name])}},u=tt.length;u>1&&tt.includes(t.info.name)&&(p.label=`پشتیبان‌گیری از ${u} کلاس`,p.action=()=>{un(tt),Sn([]),He()});const f={label:"حذف کلاس",icon:"🗑️",className:"danger",action:()=>{we(`آیا از انتقال کلاس «${t.info.name}» به سطل زباله مطمئن هستید؟`,()=>{const m={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"classroom",description:`کلاس «${t.info.name}»`,restoreData:{name:t.info.name}};ot(m),t.isDeleted=!0,Ee(t.info.name,`کلاس «${t.info.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),He(),V(`✅ کلاس «${t.info.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}};u>1&&tt.includes(t.info.name)&&(f.label=`حذف ${u} کلاس`,f.action=()=>{we(`آیا از انتقال ${u} کلاس انتخاب شده به سطل زباله مطمئن هستید؟`,()=>{tt.forEach(m=>{const b=ae[m];if(b&&!b.isDeleted){const v={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"classroom",description:`کلاس «${b.info.name}»`,restoreData:{name:b.info.name}};ot(v),b.isDeleted=!0,Ee(b.info.name,`کلاس «${b.info.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"})}}),Sn([]),oe(),He(),V(`✅ ${u} کلاس به سطل زباله منتقل شدند.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})});const y=[{label:"چاپ گزارش کلاس",icon:"🖨️",action:()=>{uo(t)}},{label:Ht.classList.contains("selection-mode-active")?"لغو انتخاب":"انتخاب چند کلاس",icon:"✔️",action:()=>{const m=Ht.classList.contains("selection-mode-active");Ht.classList.toggle("selection-mode-active"),m&&(Sn([]),He())}},p,{label:"یادداشت کلاس",icon:"📝",action:()=>{Qn(t)}},{label:"تنظیمات کلاس",icon:"⚙️",action:()=>{Et(t)}},{label:"گزارش فعالیت‌ها",icon:"📋",action:()=>{ma(t.info.name)}},{label:"تغییر نام",icon:"✏️",action:()=>{const m=t.info.name,b=document.getElementById("add-note-modal-title");b.textContent="تغییر نام کلاس",ke.value=m,ke.rows=1,ct(v=>{const C=v.trim();if(C&&C!==m){const k=Li(m,C);k.success?(Pa(m,C),Ee(C,`نام کلاس از «${m}» به «${C}» تغییر یافت.`,{type:"VIEW_SESSIONS"}),oe(),He(),V(`✅نام کلاس به «${C}» تغییر یافت.`)):V(k.message)}b.textContent="ثبت یادداشت جدید",ke.rows=4}),Re("add-note-modal"),ke.focus(),ke.select()}},f];mn(h,y)}),a}function es(){const t=document.getElementById("class-management-stats");if(!t)return;const a=Object.values(ae).filter(n=>!n.isDeleted),e=a.length,c=a.reduce((n,i)=>n+_e(i.students).length,0);let r="";$e.lastBackupTimestamp&&(r=`
            <div class="stats-row backup-stat">
                <span>آخرین پشتیبان: <strong>${new Date($e.lastBackupTimestamp).toLocaleString("fa-IR",{year:"numeric",month:"numeric",day:"numeric",weekday:"long",hour:"2-digit",minute:"2-digit"})}</strong></span>
            </div>
        `),t.innerHTML=`
        <div class="stats-row main-stats">
            <span>کل کلاس‌ها: <strong>${e}</strong></span>
            <span>|</span>
            <span>کل دانش‌آموزان: <strong>${c}</strong></span>
        </div>
        ${r} 
    `}function He(){es(),Ht.innerHTML="",Object.values(ae).sort((a,e)=>{const c=Jn(a),r=Jn(e);return c.sortIndex!==r.sortIndex?c.sortIndex-r.sortIndex:c.type==="upcoming"?c.nextTimestamp-r.nextTimestamp:new Date(a.info.creationDate)-new Date(e.info.creationDate)}).forEach(a=>{if(a.isDeleted)return;const e=to(a);Ht.appendChild(e)})}function kt(){if(!D)return;ms.innerHTML="";const t=_e(D.students),a=t.filter(r=>r.identity.firstName&&r.identity.lastName),e=t.filter(r=>!r.identity.firstName||!r.identity.lastName);a.sort((r,n)=>r.identity.lastName.localeCompare(n.identity.lastName,"fa")),[...a,...e].forEach(r=>{const n=document.createElement("li");n.dataset.studentId=r.identity.studentId;const i=document.createElement("span");i.className="student-name-link",i.style.flexGrow="1",r.identity.firstName&&r.identity.lastName?i.textContent=`${r.identity.firstName} ، ${r.identity.lastName}`:i.textContent=r.identity.name,i.addEventListener("click",()=>{Fe(r)}),Pt(n,s=>{Vn(r,D)}),n.addEventListener("contextmenu",s=>{mn(s,[{label:"تغییر نام",icon:"✏️",action:()=>{Vn(r,D)}},{label:"انتقال دانش‌آموز",icon:"➡️",action:()=>{ei(r,D)}},{label:"حذف دانش‌آموز",icon:"🗑️",className:"danger",action:()=>{we(`آیا از انتقال دانش‌آموز «${r.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const l={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${r.identity.name}» از کلاس «${D.info.name}»`,restoreData:{studentId:r.identity.studentId,classId:D.info.scheduleCode}};ot(l),r.isDeleted=!0,Ee(D.info.name,`دانش‌آموز «${r.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),kt(),Me(),st(),V(`✅ دانش‌آموز «${r.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}}])}),n.appendChild(i),ms.appendChild(n)})}function hn(){if(hs.innerHTML="",!D)return;D.categories.filter(a=>!a.isDeleted).forEach(a=>{const e=document.createElement("li"),c=document.createElement("div");c.className="name-and-badge-container";const r=document.createElement("span");if(r.textContent=a.name,c.appendChild(r),a.isGradedCategory){const i=document.createElement("span");i.className="category-badge",i.textContent="نمره‌دار",c.appendChild(i)}const n=document.createElement("button");n.className="btn-icon",n.innerHTML="🗑️",n.style.color="var(--color-warning)",n.addEventListener("click",()=>{we(`آیا از انتقال دسته‌بندی «${a.name}» به سطل زباله مطمئن هستید؟`,()=>{const i={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${a.name}» از کلاس «${D.info.name}»`,restoreData:{categoryId:a.id,classId:D.info.scheduleCode}};ot(i),a.isDeleted=!0,Ee(D.info.name,`دسته‌بندی «${a.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),hn(),V(`✅ دسته‌بندی «${a.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}),e.appendChild(c),e.appendChild(n),hs.appendChild(e)})}function ba(){if(!D)return;const t=D;$t.innerHTML="",Object.values(hi).forEach(n=>{const i=document.createElement("option");i.value=n.id,i.textContent=n.label,$t.appendChild(i)}),$t.value=t.info.educationalSystem||"custom";const a=n=>{dt.innerHTML="";const i=hi[n];if(i&&i.levels.length>0)i.levels.forEach(s=>{const o=document.createElement("option");o.value=s,o.textContent=s,dt.appendChild(o)}),dt.disabled=!1;else{const s=document.createElement("option");s.value="",s.textContent="---",dt.appendChild(s),dt.disabled=!0}};a(t.info.educationalSystem||"custom"),t.info.level&&(dt.value=t.info.level),$t.onchange=()=>{const n=$t.value;t.info.educationalSystem=n,a(n),t.info.level=dt.value,oe()},dt.onchange=()=>{t.info.level=dt.value,oe()};const e=t.info.type||"in-person",c=document.querySelector(`#settings-page input[name="class-type-setting"][value="${e}"]`);c&&(c.checked=!0);const r=t.info.scheduleDays||[];document.querySelectorAll('input[name="schedule-day"]').forEach(n=>{n.checked=r.includes(parseInt(n.value))}),document.getElementById("settings-schedule-start").value=t.info.scheduleStartTime||"",document.getElementById("settings-schedule-end").value=t.info.scheduleEndTime||""}function sn(t){document.querySelectorAll(".page").forEach(e=>{e.classList.remove("active")});const a=document.getElementById(t);a&&a.classList.add("active"),t==="class-management-page"?(We(null),Ge(null),Je(null),He(),ys.style.display="flex"):ys.style.display="none",ha()}function pe(t,a={}){const{tab:e}=a,c={pageId:t,currentClassName:D?D.info.name:null,selectedSessionNumber:J?J.sessionNumber:null,selectedStudentId:Se?Se.identity.studentId:null};let r=`#${t}`;const n=new URLSearchParams(window.location.hash.split("?")[1]||"");D?n.set("class",D.info.name):n.delete("class"),J?n.set("session",J.sessionNumber):n.delete("session"),Se?n.set("student",Se.identity.studentId):n.delete("student"),t==="session-dashboard-page"&&e?n.set("tab",e):t!=="session-dashboard-page"&&n.delete("tab");const i=n.toString();i&&(r+=`?${i}`),window.location.hash!==r&&history.pushState(c,"",r),sn(t)}function no(t,a){const e=document.createElement("div");e.className="list-item-buttons",e.style.gap="10px";const c=document.createElement("button");if(c.className="btn-icon",c.innerHTML="📝",c.title="ویرایش یادداشت جلسه",t.note||(c.style.display="none"),c.addEventListener("click",r=>{r.stopPropagation(),si(t,a)}),!t.isFinished&&!t.isCancelled){const r=document.createElement("button");r.className="btn-success",r.textContent="پایان جلسه",r.style.fontSize="12px",r.style.padding="4px 10px",r.style.whiteSpace="nowrap",r.addEventListener("click",n=>{n.stopPropagation(),we(`جلسه شماره ${a} خاتمه پیدا خواهد کرد!`,()=>{D.endSpecificSession(t.sessionNumber),oe(),Ee(D.info.name,`جلسه ${a} خاتمه یافت.`,{type:"VIEW_SESSIONS"}),je(),we("جلسه با موفقیت خاتمه یافت. آیا مایل به ایجاد فایل پشتیبان هستید؟",()=>{if(ut){V("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است.");return}un(),V("✅فایل پشتیبان با موفقیت ایجاد شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}),e.appendChild(r)}return e.appendChild(c),e}function so(t,a){const e=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="flex-start",e.style.flexGrow="1";const c=new Date(t.startTime).toLocaleDateString("fa-IR"),r=document.createElement("span");r.className="session-list-title";const n=document.createElement("div");n.style.display="flex",n.style.gap="5px",n.style.marginTop="5px";const i=new Date(t.startTime).toLocaleDateString("fa-IR",{weekday:"long"}),s=document.createElement("span");if(s.className="type-badge day-badge",s.textContent=i,n.appendChild(s),t.isCancelled){r.textContent=`لغو شده - تاریخ: ${c}`,e.style.cursor="default";const o=document.createElement("span");o.className="type-badge cancelled-badge",o.textContent="لغو شده",n.appendChild(o)}else r.textContent=`جلسه ${a} - تاریخ: ${c}`,e.style.cursor="pointer",e.addEventListener("click",()=>{Ge(t),qt()});if(e.appendChild(r),t.isFinished){const o=document.createElement("span");o.className="type-badge finished-badge",o.textContent="خاتمه یافته",n.appendChild(o)}if(t.isMakeup){const o=document.createElement("span");o.className="type-badge makeup-badge",o.textContent="جبرانی",n.appendChild(o)}return e.appendChild(n),e}function io(t,a){const e=document.createElement("li"),c=a.get(t.sessionNumber),r=so(t,c);e.appendChild(r);const n=no(t,c);return e.appendChild(n),e.addEventListener("contextmenu",i=>{const s=[{label:"یادداشت جلسه",icon:"📝",action:()=>{si(t,c)}},{label:t.isCancelled?"بازگردانی جلسه":"لغو جلسه",icon:"❌",action:()=>{const o=t.isCancelled?"بازگردانی جلسه":"لغو جلسه",l=t.isCancelled?"آیا از بازگردانی این جلسه مطمئن هستید؟":"آیا از لغو این جلسه مطمئن هستید؟ جلسه لغو شده در آمار تاثیری ندارد اما قابل بازگردانی است.";we(l,()=>{t.isCancelled=!t.isCancelled;const h=t.isCancelled?`جلسه ${c} لغو شد.`:`جلسه لغو شده (تاریخ: ${new Date(t.startTime).toLocaleDateString("fa-IR")}) بازگردانی شد.`;Ee(D.info.name,h,{type:"VIEW_SESSIONS"}),oe(),je(),V(t.isCancelled?"✅جلسه لغو شد.":"✅جلسه بازگردانی شد.")},{confirmText:o,confirmClass:"btn-warning"})}},{label:"تغییر وضعیت جبرانی",icon:"🔄",action:()=>{D.markAsMakeup(t.sessionNumber),oe();const o=t.isMakeup?`جلسه ${c} به عنوان جبرانی علامت‌گذاری شد.`:`جلسه ${c} از حالت جبرانی خارج شد.`;Ee(D.info.name,o,{type:"VIEW_SESSIONS"}),je()}},{label:"حذف جلسه",icon:"🗑️",className:"danger",action:()=>{const o=t.isCancelled?"لغو شده":c;we(`آیا از انتقال جلسه ${o} به سطل زباله مطمئن هستید؟`,()=>{const l={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"session",description:`جلسه ${o} از کلاس «${D.info.name}»`,restoreData:{sessionNumber:t.sessionNumber,classId:D.info.scheduleCode}};ot(l),t.isDeleted=!0,Ee(D.info.name,`جلسه ${o} به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),je(),V(`✅ جلسه ${o} به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}},{label:"تغییر تاریخ",icon:"📅",action:()=>{const o=document.getElementById("dp-day"),l=document.getElementById("dp-month"),h=document.getElementById("dp-year"),p=gi.toJalaali(t.startTime);o.innerHTML="";for(let y=1;y<=31;y++){const m=document.createElement("option");m.value=y,m.textContent=y.toLocaleString("fa-IR"),y===p.jd&&(m.selected=!0),o.appendChild(m)}const u=["فروردین","اردیبهشت","خرداد","تیر","مرداد","شهریور","مهر","آبان","آذر","دی","بهمن","اسفند"];l.innerHTML="",u.forEach((y,m)=>{const b=document.createElement("option");b.value=m+1,b.textContent=y,m+1===p.jm&&(b.selected=!0),l.appendChild(b)}),h.innerHTML="";const f=p.jy;for(let y=f-5;y<=f+5;y++){const m=document.createElement("option");m.value=y,m.textContent=y.toString().replace(/\d/g,b=>"۰۱۲۳۴۵۶۷۸۹"[b]),y===p.jy&&(m.selected=!0),h.appendChild(m)}Un(y=>{if(!y)return;const m=gi.toGregorian(parseInt(y.jy),parseInt(y.jm),parseInt(y.jd)),b=new Date(m.gy,m.gm-1,m.gd);b.setHours(t.startTime.getHours()),b.setMinutes(t.startTime.getMinutes()),b.setSeconds(t.startTime.getSeconds());const v=t.startTime.toLocaleDateString("fa-IR");t.startTime=b;const C=t.startTime.toLocaleDateString("fa-IR");Ee(D.info.name,`تاریخ جلسه ${c} از ${v} به ${C} تغییر یافت.`,{type:"VIEW_SESSIONS"}),oe(),je(),V(`✅ تاریخ جلسه به ${C} تغییر یافت.`)}),Re("date-picker-modal")}}];mn(i,s)}),e}function je(){const t=document.getElementById("session-list");if(!D)return;if(t.innerHTML="",D.sessions.length===0){t.innerHTML="<li>هنوز جلسه‌ای شروع نشده است.</li>";return}const a=nt(D);[..._e(D.sessions)].reverse().forEach(c=>{const r=io(c,a);t.appendChild(r)})}function Xt(t){if(gt.innerHTML="",t.length>0)t.forEach(a=>{const e=document.createElement("div");e.textContent=a.identity.name,e.addEventListener("click",()=>{Fe(a),gt.style.display="none",Cs.value=""}),gt.appendChild(e)}),gt.style.display="block";else if(Cs.value.trim()!==""){const a=document.createElement("div");a.className="no-results",a.textContent="پیدا نشد",gt.appendChild(a),gt.style.display="block"}else gt.style.display="none"}function Bn(t){if(lt.innerHTML="",t.length>0)t.forEach(a=>{const e=document.createElement("div");if(e.className="global-search-result",a.type==="student"){const c=document.createElement("span");c.className="student-name",c.textContent=a.student.identity.name;const r=document.createElement("span");r.className="class-name",r.textContent=`کلاس: ${a.classroom.info.name}`,e.addEventListener("click",()=>{We(a.classroom),Fe(a.student),lt.style.display="none",Yt.value=""}),r.addEventListener("click",n=>{n.stopPropagation(),We(a.classroom),Ge(null),on(a.classroom.liveSession),je(),pe("session-page"),lt.style.display="none",Yt.value=""}),e.appendChild(c),e.appendChild(r)}else if(a.type==="classroom"){const c=document.createElement("span");c.className="student-name",c.textContent=`[کلاس] ${a.classroom.info.name}`,e.addEventListener("click",()=>{We(a.classroom),Ge(null),on(a.classroom.liveSession),je(),pe("session-page"),lt.style.display="none",Yt.value=""}),e.appendChild(c)}lt.appendChild(e)}),lt.style.display="block";else if(Yt.value.trim()!==""){const a=document.createElement("div");a.className="no-results",a.textContent="پیدا نشد",lt.appendChild(a),lt.style.display="block"}else lt.style.display="none"}function fn(){const t=document.getElementById("trashed-items-list");if(t.innerHTML="",Ue.length===0){t.innerHTML='<li style="text-align: center; padding: 20px;">سطل زباله خالی است.</li>';return}Ue.forEach((a,e)=>{const c=document.createElement("li"),r=document.createElement("span");r.textContent=a.description,r.style.flexGrow="1";const n=document.createElement("div");n.className="list-item-buttons";const i=document.createElement("button");i.className="btn-icon",i.innerHTML="🔄",i.title="بازیابی",i.addEventListener("click",()=>{var p;let o=!1,l=null;const h=a.restoreData;switch(a.type){case"classroom":{const u=ae[h.name];u&&!u.isDeleted?l=`کلاسی با نام «${h.name}» از قبل فعال است.`:u&&u.isDeleted&&(u.isDeleted=!1,o=!0);break}case"student":{const u=Object.values(ae).find(y=>y.info.scheduleCode===h.classId),f=u==null?void 0:u.students.find(y=>y.identity.studentId===h.studentId);f&&(f.isDeleted=!1,o=!0);break}case"session":{const u=Object.values(ae).find(y=>y.info.scheduleCode===h.classId),f=u==null?void 0:u.sessions.find(y=>y.sessionNumber===h.sessionNumber);f&&(f.isDeleted=!1,o=!0);break}case"category":{const u=Object.values(ae).find(y=>y.info.scheduleCode===h.classId),f=u==null?void 0:u.categories.find(y=>y.id===h.categoryId);f&&(f.isDeleted=!1,o=!0);break}case"score":{const u=Object.values(ae).find(m=>m.info.scheduleCode===h.classId),f=u==null?void 0:u.students.find(m=>m.identity.studentId===h.studentId),y=(p=f==null?void 0:f.logs.scores[h.skill.toLowerCase()])==null?void 0:p.find(m=>m.id===h.scoreId);y&&(y.isDeleted=!1,o=!0);break}case"note":{const u=Object.values(ae).find(m=>m.info.scheduleCode===h.classId),f=u==null?void 0:u.students.find(m=>m.identity.studentId===h.studentId),y=f==null?void 0:f.profile.notes.find(m=>m.id===h.noteId);y&&(y.isDeleted=!1,o=!0);break}}o?(Ue.splice(e,1),oe(),fn(),a.type==="classroom"&&He(),V("✅ آیتم با موفقیت بازیابی شد.")):V(l?`⚠️ ${l}`:"⚠️ آیتم اصلی برای بازیابی یافت نشد.")});const s=document.createElement("button");s.className="btn-icon",s.innerHTML="🔥",s.title="حذف دائمی",s.addEventListener("click",()=>{we("آیا از حذف دائمی این آیتم مطمئن هستید؟ این عمل غیرقابل بازgشت است.",()=>{const o=a.restoreData,l=p=>Object.values(ae).find(u=>u.info.scheduleCode===p);let h;switch(a.type){case"classroom":delete ae[o.name];break;case"student":h=l(o.classId),rn({identity:{studentId:o.studentId}},h);break;case"session":h=l(o.classId),h&&Fs(h.info.name,o.sessionNumber);break;case"category":h=l(o.classId),h&&Ps(h.info.name,o.categoryId);break;case"score":h=l(o.classId),h&&Hs(h.info.name,o.studentId,o.skill,o.scoreId);break;case"note":h=l(o.classId),h&&Ws(h.info.name,o.studentId,o.noteId);break}Ue.splice(e,1),oe(),fn(),V("✅ آیتم برای همیشه حذف شد.")},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),n.appendChild(i),n.appendChild(s),c.appendChild(r),c.appendChild(n),t.appendChild(c)})}function ao(){const t=document.getElementById("absentees-summary-container");t&&(t.innerHTML=`
        <div id="absentees-summary-box" class="absentees-summary">
            <div class="absentees-summary-header">
                <h4>لیست غایبین جلسه شماره <span id="absentee-summary-session-number"></span></h4>
                <button id="copy-absentees-btn" class="btn-icon" title="کپی لیست غایبین">📋</button>
            </div>
            <div id="absentees-summary-list" class="summary-list"></div>
        </div>
    `)}function Ca(){const t=document.getElementById("absentees-summary-box"),a=document.getElementById("absentees-summary-list"),e=document.getElementById("absentee-summary-session-number");if(!t||!a||!e){console.error("Could not find all absentee summary elements.");return}if(!D||!J){t.classList.remove("visible");return}const c=_e(D.students).filter(n=>{const i=J.studentRecords[n.identity.studentId];return i&&i.attendance==="absent"}),r=nt(D);e.textContent=r.get(J.sessionNumber),c.length>0?t.classList.add("visible"):t.classList.remove("visible"),a.innerHTML="",c.forEach(n=>{const s=(l=>D.sessions.reduce((h,p)=>{if(p.isDeleted||p.isCancelled)return h;const u=p.studentRecords[l.identity.studentId];return h+(u&&u.attendance==="absent"?1:0)},0))(n),o=document.createElement("span");o.className="summary-name",o.textContent=`${n.identity.name} (غیبت: ${s})`,o.addEventListener("click",()=>{o.classList.add("fading-out"),setTimeout(()=>{J.setAttendance(n.identity.studentId,"present"),oe(),st()},200)}),a.appendChild(o)})}function ro(){const t=document.getElementById("copy-absentees-btn");if(!t){console.error("Could not find the copy absentees button to attach listener.");return}t.addEventListener("click",()=>{if(!D||!J)return;const a=_e(D.students).filter(r=>{const n=J.studentRecords[r.identity.studentId];return n&&n.attendance==="absent"});if(a.length===0){V("⚠️لیست غایبین خالی است.");return}const e=r=>D.sessions.reduce((n,i)=>{if(i.isDeleted||i.isCancelled)return n;const s=i.studentRecords[r.identity.studentId];return n+(s&&s.attendance==="absent"?1:0)},0);let c=`لیست غایبین جلسه شماره ${Vr()}:

`;a.forEach(r=>{const n=e(r);c+=`- ${r.identity.name} (تعداد غیبت‌ها: ${n})
`}),navigator.clipboard.writeText(c).then(()=>{V("✅لیست غایبین با موفقیت کپی شد.")}).catch(r=>{console.error("Failed to copy text: ",r),V("❌خطا در کپی کردن لیست.")})})}function Nn(){const t=document.getElementById("demo-mode-banner");t&&(ut?(t.classList.add("visible"),document.body.classList.add("demo-mode-active")):(t.classList.remove("visible"),document.body.classList.remove("demo-mode-active")))}function Jn(t){const{scheduleDays:a,scheduleStartTime:e,scheduleEndTime:c}=t.info,r=a&&a.length>0,n=e&&c;if(!r&&!n)return{type:"unscheduled",sortIndex:3};if(!r||!n)return{type:"incomplete",sortIndex:2};const i=new Date,s=i.getDay(),o=i.getHours()*60+i.getMinutes(),[l,h]=e.split(":").map(Number),[p,u]=c.split(":").map(Number),f=l*60+h,y=p*60+u;if(a.includes(s)&&o>=f&&o<y)return{type:"active",sortIndex:0};for(let m=0;m<=7;m++){const b=(s+m)%7;if(a.includes(b)){if(m===0&&o>=f)continue;const v=new Date(i);return v.setDate(i.getDate()+m),v.setHours(l,h,0,0),{type:"upcoming",sortIndex:1,nextTimestamp:v.getTime()}}}return{type:"upcoming",sortIndex:1,nextTimestamp:9999999999999}}function oo(t,a){const{scheduleDays:e,scheduleStartTime:c,scheduleEndTime:r}=t.info;if(!e||!e.length||!c||!r)return null;const[n,i]=c.split(":").map(Number),[s,o]=r.split(":").map(Number),l=n*60+i,h=s*60+o;for(const p of Object.values(a)){if(p===t||p.isDeleted||p.info.name===t.info.name)continue;const u=p.info;if(!u.scheduleDays||!u.scheduleDays.length||!u.scheduleStartTime||!u.scheduleEndTime||!e.some(_=>u.scheduleDays.includes(_)))continue;const[y,m]=u.scheduleStartTime.split(":").map(Number),[b,v]=u.scheduleEndTime.split(":").map(Number),C=y*60+m,k=b*60+v;if(l<k&&h>C)return p.info.name}return null}function co(t){if(!t||t.length===0)return"";const a={6:"شنبه",0:"۱شنبه",1:"۲شنبه",2:"۳شنبه",3:"۴شنبه",4:"۵شنبه",5:"جمعه"};return[...t].sort((c,r)=>{const n={6:0,0:1,1:2,2:3,3:4,4:5,5:6};return n[c]-n[r]}).map(c=>a[c]).join("، ")}async function wa(){const t=document.getElementById("restore-points-list");t.innerHTML='<li style="text-align:center; padding:20px;">در حال بارگذاری...</li>';try{const a=await za();if(a.length===0){t.innerHTML='<li style="text-align:center; padding:20px;">هیچ فایل پشتیبانی یافت نشد.</li>';return}t.innerHTML="",a.forEach(e=>{const c=document.createElement("li");c.className="restore-point-card";const r=new Date(e.timestamp).toLocaleString("fa-IR",{weekday:"long",year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"}),n=(e.file.size/1024).toFixed(1)+" KB";c.innerHTML=`
                <div class="restore-card-header">
                    <span class="restore-date">${r}</span>
                    <span class="restore-size">${n}</span>
                </div>
                <div class="restore-desc">${e.metadata.description||"بدون توضیحات"}</div>
                <div class="restore-actions">
                    <button class="btn-restore-action">بازگردانی</button>
                </div>
            `,c.querySelector(".btn-restore-action").addEventListener("click",async()=>{try{const s=await e.file.text(),h=(await new Ts().loadAsync(s,{base64:!0})).file("backup.json");if(!h)throw new Error("فایل backup.json یافت نشد.");const p=await h.async("string"),u=JSON.parse(p);Gn(u)}catch(s){console.error("Restore failed:",s),V("❌ فایل پشتیبان معتبر نیست.")}}),t.appendChild(c)})}catch(a){console.error("Failed to load snapshots:",a),t.innerHTML='<li style="text-align:center; color:red;">خطا در بارگذاری اطلاعات.</li>'}}function lo(t,a,e="default",c=!1){let r=[..._e(t.students)];const n=new Date().toLocaleDateString("fa-IR",{year:"numeric",month:"long",day:"numeric",weekday:"long"});if(e==="alpha"){const p=r.filter(f=>f.identity.firstName&&f.identity.lastName),u=r.filter(f=>!f.identity.firstName||!f.identity.lastName);p.sort((f,y)=>f.identity.lastName.localeCompare(y.identity.lastName,"fa")),r=[...p,...u]}let i="<tr>";a.forEach(p=>{i+=`<th>${p.label}</th>`}),i+="</tr>";let s="";r.forEach((p,u)=>{s+="<tr>",a.forEach(f=>{let y="-";f.id==="row_num"?y=u+1:f.id==="name"?p.identity.firstName&&p.identity.lastName?y=`${p.identity.firstName} ، ${p.identity.lastName}`:y=p.identity.name:f.id==="total_selections"?y=p.statusCounters.totalSelections:f.id==="missed_chances"?y=p.statusCounters.missedChances:f.id==="issues"?y=Object.values(p.categoryIssues||{}).reduce((b,v)=>b+v,0):f.id==="absences"?y=t.sessions.reduce((b,v)=>{if(v.isDeleted||v.isCancelled)return b;const C=v.studentRecords[p.identity.studentId];return b+(C&&C.attendance==="absent"?1:0)},0):f.id==="avg_score"?y=p.getOverallAverageScore()||"-":f.id==="final_score"?y=t.calculateFinalStudentScore(p)||"-":f.type==="category"&&(y=p.categoryCounts[f.id]||0);const m=f.id==="name"?'style="text-align: right;"':"";s+=`<td ${m}>${y}</td>`}),s+="</tr>"});let o="";c&&(o=`
            <div class="warning-footnote">
                ⚠️ <strong>توجه:</strong> ترتیب الفبایی این لیست ممکن است دقیق نباشد. (نام خانوادگی برخی دانش‌آموزان در سیستم تفکیک نشده است)
            </div>
        `);const l=window.open("","_blank");if(!l){V("⚠️ مرورگر شما پنجره جدید را مسدود کرد. لطفاً اجازه دهید.","error");return}const h=`
        <!DOCTYPE html>
        <html lang="fa" dir="rtl">
        <head>
            <title>گزارش کلاس ${t.info.name}</title>
            <style>
                @media print {
                    @page { size: A4; margin: 10mm; }
                    body { font-family: Tahoma, 'Vazirmatn', sans-serif; color: #000; }
                }
                body { font-family: Tahoma, sans-serif; padding: 20px; direction: rtl; }
                h1 { text-align: center; margin-bottom: 5px; font-size: 24px; }
                .meta { text-align: center; margin-bottom: 30px; font-size: 14px; color: #444; }
                table { width: 100%; border-collapse: collapse; font-size: 12px; }
                th, td { border: 1px solid #333; padding: 6px 8px; text-align: center; }
                th { background-color: #eee; font-weight: bold; }
                tr:nth-child(even) { background-color: #f9f9f9; }
                .signature { margin-top: 50px; display: flex; justify-content: space-between; padding: 0 50px; }
                
                .warning-footnote {
                    margin-top: 20px;
                    font-size: 11px;
                    color: #555;
                    font-style: italic;
                    border-top: 1px solid #ccc;
                    padding-top: 10px;
                }
            </style>
        </head>
        <body>
            <h1>گزارش وضعیت کلاس ${t.info.name}</h1>
            <div class="meta">
                تاریخ گزارش: ${n} | تعداد دانش‌آموزان: ${r.length}
            </div>
            <table>
                <thead>${i}</thead>
                <tbody>${s}</tbody>
            </table>
            ${o}
            <div class="signature">
                <div>امضای معلم</div>
                <div>مهر و امضای مدرسه</div>
            </div>
            <script>
                window.onload = function() { window.print(); }
            <\/script>
        </body>
        </html>
    `;l.document.write(h),l.document.close()}function uo(t){const a=ia;a.innerHTML="";const c=_e(t.students).filter(u=>!u.identity.lastName).length,r=[{id:"row_num",label:"ردیف",checked:!0},{id:"name",label:"نام دانش‌آموز",checked:!0},{id:"total_selections",label:"کل انتخاب‌ها",checked:!0},{id:"absences",label:"تعداد غیبت",checked:!0},{id:"missed_chances",label:"فرصت سوخته",checked:!1},{id:"issues",label:"موارد انضباطی",checked:!1},{id:"avg_score",label:"میانگین نمرات",checked:!0},{id:"final_score",label:"نمره نهایی (کانون)",checked:!0}];t.categories.forEach(u=>{u.isDeleted||r.push({id:u.name,label:`تعداد ${u.name}`,type:"category",checked:!1})}),r.forEach(u=>{const f=document.createElement("label");f.className="report-column-item";const y=document.createElement("input");y.type="checkbox",y.checked=u.checked,y.dataset.colId=u.id,y.dataset.colLabel=u.label,u.type&&(y.dataset.colType=u.type);const m=document.createElement("span");m.textContent=u.label,f.appendChild(y),f.appendChild(m),a.appendChild(f)});const n=a.parentElement,i=n.querySelector("#report-sort-options");i&&i.remove();const s=document.createElement("div");s.id="report-sort-options",s.style.marginTop="20px",s.style.padding="15px",s.style.backgroundColor="#f8f9fa",s.style.borderRadius="5px",s.style.border="1px solid #e9ecef",s.innerHTML=`
        <div style="margin-bottom: 10px; font-weight: bold; color: #333;">ترتیب نمایش لیست:</div>
        
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <label style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <input type="radio" name="report-sort" value="alpha" checked style="accent-color: var(--color-primary);">
                <span>بر اساس نام خانوادگی</span>
            </label>

            <label style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <input type="radio" name="report-sort" value="default" style="accent-color: var(--color-primary);">
                <span>بر اساس زمان ورود به کلاس</span>
            </label>
        </div>

        <div id="sort-warning" style="
            display: none; 
            margin-top: 12px; 
            background-color: #fff3cd; 
            color: #856404; 
            padding: 10px; 
            border-radius: 4px; 
            font-size: 13px; 
            border: 1px solid #ffeeba;
            line-height: 1.5;
        ">
            ⚠️ <strong>توجه:</strong> نام خانوادگی ${c} دانش‌آموز هنوز تفکیک نشده است. مرتب‌سازی این موارد ممکن است کاملاً دقیق نباشد.
        </div>
    `;const o=n.querySelector(".modal-actions");n.insertBefore(s,o);const l=s.querySelectorAll('input[name="report-sort"]'),h=s.querySelector("#sort-warning"),p=()=>{const u=s.querySelector('input[value="alpha"]').checked;h.style.display=u&&c>0?"block":"none"};l.forEach(u=>u.addEventListener("change",p)),p(),aa.onclick=()=>{const u=[];if(a.querySelectorAll('input[type="checkbox"]:checked').forEach(b=>{u.push({id:b.dataset.colId,label:b.dataset.colLabel,type:b.dataset.colType})}),u.length===0){V("⚠️ لطفاً حداقل یک ستون را انتخاب کنید.");return}const y=s.querySelector('input[name="report-sort"]:checked').value,m=y==="alpha"&&c>0;ve(),lo(t,u,y,m)},ra.onclick=()=>{ve()},Re("report-config-modal")}function fo(t,a){const e=document.createElement("div");e.className="qualitative-button-container";const c=Ze,r=c!==-1&&J.winnerHistory[c],n=r?J.winnerHistory[c]:null,i=J.studentRecords[t.identity.studentId];t.qualitativeStats||(t.qualitativeStats={}),t.qualitativeStats[a]||(t.qualitativeStats[a]={effort:0,good:0,excellent:0}),i.performanceRatings||(i.performanceRatings={});const s=r?n.rating:i.performanceRatings[a],o=J.isFinished||i.attendance==="absent"||i.hadIssue||i.wasOutOfClass;return[{key:"effort",label:"تلاش",className:"effort-btn"},{key:"good",label:"خوب",className:"good-btn"},{key:"excellent",label:"عالی",className:"excellent-btn"}].forEach(h=>{const p=document.createElement("button");p.className=`qualitative-btn ${h.className}`,p.textContent=h.label,p.disabled=o,s===h.key&&p.classList.add("active"),p.addEventListener("click",()=>{const u=h.key;s&&t.qualitativeStats[a][s]>0&&t.qualitativeStats[a][s]--,s!==u&&(t.qualitativeStats[a][u]=(t.qualitativeStats[a][u]||0)+1);const f=s===u?null:u;r?n.rating=f:f?i.performanceRatings[a]=f:delete i.performanceRatings[a],oe(),Oe()}),e.appendChild(p)}),e}const mo=Object.freeze(Object.defineProperty({__proto__:null,_internalShowPage:sn,addCategoryBtn:cr,addClassBtn:Za,addNoteModal:wr,addScoreBtn:xr,addStudentBtn:Ya,appHeader:ys,attendanceListUl:Qt,attendanceMassActionsContainer:xn,attendancePage:lr,attendancePane:jt,attendanceSearchInput:xt,backToSessionsBtn:Ja,backToStudentPageBtn:_r,backupDataBtn:gr,breadcrumbContainer:zt,cancelImportBtn:rr,cancelNoteBtn:kr,categoryListUl:hs,categoryModal:$r,categoryModalCancelBtn:Fr,categoryModalSaveBtn:ca,categoryModalTitle:oa,classListHeader:ur,classListUl:Ht,classManagementPage:Ji,classSaveNoteBtn:Er,closeActiveModal:ve,closeContextMenu:Lt,closeNavBtn:hr,columnMappingPage:ir,columnSelectDropdown:gs,confirmColumnBtn:ar,confirmModalCancelBtn:bs,confirmModalConfirmBtn:Kt,confirmModalMessage:ea,contextMenu:Bt,csvCancelBtn:tr,csvConfirmBtn:er,csvFileInput:sr,csvPreviewList:ps,csvPreviewPage:Qa,customConfirmModal:vr,displayWinner:Oe,finishAttendanceBtn:dr,globalStudentSearchInput:Yt,globalStudentSearchResultsDiv:lt,gradedCategoryPillsContainer:Sr,hamburgerMenuBtn:fr,handleUndo:ua,importCsvBtn:nr,initiateBackupProcess:un,isGradedCheckbox:Br,massCommentAppendCheckbox:Qs,massCommentBtn:Es,massCommentCancelBtn:Wr,massCommentContent:nn,massCommentModal:Pr,massCommentModalTitle:Hr,massCommentSaveBtn:Ur,massCommentStudentCountMessage:la,newCategoryModalIsGradedCheckbox:Xs,newCategoryModalNameInput:tn,newCategoryNameInput:or,newClassNameInput:qa,newNoteContent:ke,newScoreCommentTextarea:sa,newScoreValueInput:Ir,newStudentNameInput:Ka,openContextMenu:mn,openModal:Re,overlay:pr,pasteArea:Xi,processMassHomeworkComment:_s,processPasteBtn:Xa,profileScoresListUl:Tr,profileStatsSummaryDiv:Lr,quickGradeFormWrapper:Ft,quickGradeSubmitBtn:Tt,quickNoteTextarea:at,quickScoreInput:ft,renderAttendancePage:st,renderBreadcrumbs:ha,renderClassList:He,renderClassManagementStats:es,renderColumnSelector:va,renderGlobalSearchResults:Bn,renderImportPreview:Ls,renderLogModal:ma,renderMassCommentControls:ti,renderRestorePointsPage:wa,renderScoresHistory:ga,renderSearchResults:Xt,renderSessionDashboard:qt,renderSessions:je,renderSettingsCategories:hn,renderSettingsOther:ba,renderSettingsStudentList:kt,renderStudentNotes:ya,renderStudentStatsList:Me,renderTrashPage:fn,reportCancelBtn:ra,reportColumnsContainer:ia,reportConfigModal:zr,reportPrintBtn:aa,restoreDataBtn:yr,restoreFileInput:Qi,secureConfirmCancelBtn:Cr,secureConfirmCode:na,secureConfirmConfirmBtn:In,secureConfirmInput:Rt,secureConfirmMessage:ta,secureConfirmModal:br,selectStudentBtn:rt,selectStudentBtnWrapper:Ut,sessionDashboardPage:jr,setAutoDirectionOnInput:ii,settingsClassNameHeader:Yi,settingsEduSystemSelect:$t,settingsLevelSelect:dt,settingsPage:Va,settingsStudentListUl:ms,setupDashboardTabs:da,setupLongPress:Pt,showCategoryModal:ks,showClassNoteModal:Qn,showCustomConfirm:we,showMassCommentModal:ni,showMoveStudentModal:ei,showNotification:V,showPage:pe,showRenameStudentModal:Vn,showRestoreConfirmModal:Gn,showSecureConfirm:fa,showSessionNoteModal:si,showSettingsPage:Et,showStudentProfile:Fe,showUndoToast:qr,sideNavMenu:mr,studentSearchInput:Cs,studentSearchResultsDiv:gt,studentStatsHeader:vs,switchDashboardTab:dn,trashedCategoriesList:Or,trashedClassesList:Nr,trashedNotesList:Mr,trashedScoresList:Rr,trashedSessionsList:Ar,trashedStudentsList:Dr,triggerFileDownload:Ss,undoBtn:Ga,undoMessage:Ki,undoToast:Zn,updateDemoModeBanner:Nn},Symbol.toStringTag,{value:"Module"}));function ho(){const t=window.location.hash;if(!t||t==="#")return!1;const[a,e]=t.split("?"),c=a.substring(1),r=new URLSearchParams(e),n=r.get("class"),i=parseInt(r.get("session"),10),s=r.get("student"),o=r.get("tab")||"selector";if(n&&ae[n])We(ae[n]),i&&D.getSession(i)&&Ge(D.getSession(i)),s&&D.students.find(l=>l.identity.studentId===s)&&Je(D.students.find(l=>l.identity.studentId===s));else return!1;switch(c){case"session-page":je(),pe("session-page");break;case"session-dashboard-page":qt(c==="attendance-page"?"attendance":o);break;case"settings-page":Et(D);break;case"student-profile-page":qt(o),Fe(Se);break;default:return!1}return!0}document.addEventListener("DOMContentLoaded",()=>{const{globalStudentSearchInput:t,newClassNameInput:a,addClassBtn:e,undoBtn:c,newStudentNameInput:r,addStudentBtn:n,pasteArea:i,processPasteBtn:s,csvPreviewList:o,csvConfirmBtn:l,csvCancelBtn:h,importCsvBtn:p,csvFileInput:u,columnSelectDropdown:f,confirmColumnBtn:y,cancelImportBtn:m,newCategoryNameInput:b,addCategoryBtn:v,selectStudentBtn:C,attendancePage:k,finishAttendanceBtn:_,classListHeader:I,studentStatsHeader:x,hamburgerMenuBtn:L,sideNavMenu:N,closeNavBtn:R,overlay:P,backupDataBtn:ee,restoreDataBtn:S,restoreFileInput:z,confirmModalCancelBtn:g,confirmModalConfirmBtn:H,secureConfirmCancelBtn:fe,secureConfirmConfirmBtn:q,newNoteContent:me,classSaveNoteBtn:F,cancelNoteBtn:se,studentSearchInput:O,studentSearchResultsDiv:M,isGradedCheckbox:le,categoryModalSaveBtn:ne,categoryModalCancelBtn:Q,massCommentBtn:Be,massCommentCancelBtn:Ae,massCommentSaveBtn:he,massCommentContent:be,massCommentAppendCheckbox:Le,attendanceSearchInput:De}=mo,Ye=document.getElementById("trash-nav-btn");document.querySelector(".global-search-container .search-icon"),Fn(),Nn(),ho()||(He(),pe("class-management-page"));function d(T,j){const W=document.querySelector(T);if(!W)return;const X=W.querySelector(".search-icon"),te=W.querySelector(".animated-search-input");!X||!te||(X.addEventListener("mousedown",ce=>{ce.preventDefault()}),X.addEventListener("click",()=>{W.classList.contains("search-active")||(W.classList.add("search-active"),te.focus())}),te.addEventListener("blur",()=>{setTimeout(()=>{W.classList.remove("search-active"),te.value="",j&&j([])},150)}))}De.addEventListener("input",()=>{const T=De.value.toLowerCase().trim(),j=cs(T);Qt.querySelectorAll(".attendance-list-item").forEach(X=>{const te=X.querySelector(".student-name");if(te){const ce=te.textContent,re=et(ce.toLowerCase()),ue=re.includes(et(T)),Ce=re.includes(et(j));ue||Ce?X.style.display="flex":X.style.display="none"}})}),Q.addEventListener("click",()=>{ve(),Yn(null)}),ne.addEventListener("click",()=>{const T=tn.value.trim(),j=Xs.checked;typeof Rn=="function"&&Rn(T,j)}),window.addEventListener("scroll",Lt),document.addEventListener("click",T=>{Bt.classList.contains("visible")&&!Bt.contains(T.target)&&Lt(),O.contains(T.target)||(M.style.display="none");const j=T.target.closest(".log-action-link");if(j&&j.dataset.action)try{const W=JSON.parse(j.dataset.action);At(W)}catch(W){console.error("Could not parse log action:",W)}}),Ut.addEventListener("click",()=>{(Ut.classList.contains("disabled-wrapper")||rt.disabled)&&(rt.classList.add("shake-animation"),setTimeout(()=>{rt.classList.remove("shake-animation")},200))}),x.addEventListener("click",()=>{const T=new Date().getTime();T-Os>500?_n(1):_n(On+1),$i(T),On===5&&(_n(0),we("آیا از صفر کردن تمام شمارنده‌های دانش‌آموزان مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{Ni(),Me(),V("تمام آمارها صفر شدند ✅.")},{confirmText:"بله",confirmClass:"btn-warning"}))}),I.addEventListener("click",()=>{const T=new Date().getTime();T-As>500?kn(1):kn(An+1),zi(T),An===5&&(kn(0),we("آیا از ساخت یک کلاس تستی تصادفی مطمئن هستید؟",()=>{function j(){const W=`کلاس تستی ${Object.keys(ae).length+1}`,X=new us({name:W,type:"online"});["علی رضایی","مریم حسینی","زهرا احمدی","رضا محمدی","فاطمه کریمی"].forEach(ce=>X.addStudent(new wn({name:ce}))),ae[W]=X,oe(),He()}j(),V("کلاس تستی با موفقیت ساخته شد ✅!")},{confirmText:"بساز",confirmClass:"btn-success"}))}),fe.addEventListener("click",()=>{ve(),cn(null)});const U=document.getElementById("date-picker-confirm-btn"),$=document.getElementById("date-picker-cancel-btn"),E=document.getElementById("dp-day"),w=document.getElementById("dp-month"),B=document.getElementById("dp-year");U.addEventListener("click",()=>{const T=B.value,j=w.value,W=E.value;T&&j&&W&&typeof $n=="function"?($n({jy:T,jm:j,jd:W}),ve()):V("⚠️ خطا در انتخاب تاریخ."),Un(null)}),$&&$.addEventListener("click",()=>{ve(),Un(null)}),q.addEventListener("click",()=>{typeof Mn=="function"&&Mn(),ve(),cn(null)}),g.addEventListener("click",()=>{ve(Rs)}),H.addEventListener("click",()=>{ve(Ms)}),C.addEventListener("click",()=>{if(ft.value.trim()!==""||at.value.trim()!==""){V("⚠️لطفاً ابتدا با دکمه «ثبت»، تغییرات را ذخیره کنید و یا نمره و یادداشت را پاک کنید.");return}if(!D||!J||!Ve)return;const T=D.selectNextWinner(Ve.name,J);if(T){pi();const j=J.studentRecords[T.identity.studentId];if(j&&j.attendance==="absent"&&T.statusCounters.missedChances++,j&&j.hadIssue){T.statusCounters.missedChances++;const X=Ve.name;T.categoryIssues[X]=(T.categoryIssues[X]||0)+1}j&&j.wasOutOfClass&&(T.statusCounters.outOfClassCount=(T.statusCounters.outOfClassCount||0)+1,T.statusCounters.missedChances++);const W={winner:T,categoryName:Ve.name};J.winnerHistory.push(W),J.winnerHistory.length>10&&J.winnerHistory.shift(),wt(J.winnerHistory.length-1),J.lastUsedCategoryId=Ve.id,J.lastSelectedWinnerId=T.identity.studentId,Me(),setTimeout(()=>Oe(),0),oe()}else V("❌دانش‌آموز واجد شرایطی برای انتخاب یافت نشد.")}),v.addEventListener("click",()=>{if(!D)return;const T=b.value.trim(),j=le.checked;if(!T){alert("⚠️لطفاً نام دسته‌بندی را وارد کنید.");return}const W=D.categories.find(te=>te.name.toLowerCase()===T.toLowerCase());if(W)if(W.isDeleted){const te=D.categories.findIndex(ce=>ce===W);te>-1&&D.categories.splice(te,1)}else{alert("⚠️این دسته‌بندی از قبل وجود دارد.");return}const X=new mt(T,"",j);D.categories.push(X),oe(),Ee(D.info.name,`دسته‌بندی جدید «${T}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),hn(),b.value="",le.checked=!1}),document.querySelectorAll('#settings-page input[name="class-type-setting"]').forEach(T=>{T.addEventListener("change",()=>{if(!D)return;const j=T.value,W=D.info.type||"in-person";if(j===W)return;const X=re=>re==="online"?"آنلاین":"حضوری",te=X(W),ce=X(j);we(`آیا از تغییر نوع کلاس از «${te}» به «${ce}» مطمئن هستید؟`,()=>{D.info.type=j,oe(),Ee(D.info.name,`نوع کلاس به «${ce}» تغییر یافت.`,{type:"VIEW_CLASS_SETTINGS"}),He(),V(`✅ نوع کلاس به «${ce}» تغییر یافت.`)},{confirmText:"بله",confirmClass:"btn-warning",onCancel:()=>{const re=document.querySelector(`#settings-page input[name="class-type-setting"][value="${W}"]`);re&&(re.checked=!0)}})})});const G=document.querySelectorAll('input[name="schedule-day"]'),A=document.getElementById("settings-schedule-start"),K=document.getElementById("settings-schedule-end");G.forEach(T=>{T.addEventListener("change",()=>{if(!D)return;const j=Array.from(G).filter(W=>W.checked).map(W=>parseInt(W.value));D.info.scheduleDays=j,oe()})});const ie=()=>{D&&(D.info.scheduleStartTime=A.value,D.info.scheduleEndTime=K.value,oe())};A.addEventListener("change",ie),K.addEventListener("change",ie),b.addEventListener("keyup",T=>{T.key==="Enter"&&v.click()}),y.addEventListener("click",()=>{if(!Dn){alert("❌خطایی رخ داده است. لطفاً فایل را دوباره انتخاب کنید."),pe("settings-page");return}const T=parseInt(f.value,10),X=Dn.split(`
`).slice(1).map(te=>{var re;return(re=te.split(",")[T])==null?void 0:re.trim()}).filter(te=>te&&te.length>0);X.length>0?(Jt(X),Ls(),pe("csv-preview-page")):alert("هیچ نامی در ستون انتخاب شده پیدا نشد. لطفاً ستون دیگری را امتحان کنید یا فایل خود را بررسی کنید."),En(null)}),p.addEventListener("click",()=>{u.click()}),u.addEventListener("change",T=>{const j=T.target.files[0];if(!j)return;const W=new FileReader;W.onload=X=>{const te=X.target.result;En(te);const re=te.split(`
`)[0].split(",");va(re),pe("column-mapping-page")},W.readAsText(j),T.target.value=null}),m.addEventListener("click",()=>{En(null),pe("settings-page")}),l.addEventListener("click",()=>{const T=o.querySelectorAll('input[type="checkbox"]:checked');let j=!1;T.forEach(W=>{const X=W.dataset.name,te=D.students.find(ue=>ue.identity.name.toLowerCase()===X.toLowerCase());if(te)if(te.isDeleted)rn(te,D);else{console.log(`دانش‌آموز «${X}» به دلیل تکراری بودن اضافه نشد.`);return}const ce=fs(X),re=new wn(ce);D.addStudent(re),D.sessions.length>0&&(_e(D.sessions).filter(ue=>ue.isFinished&&!ue.isCancelled).forEach(ue=>{ue.setAttendance(re.identity.studentId,"absent")}),Qe(re,D),j=!0)}),oe(),Ee(D.info.name,`${T.length} دانش‌آموز جدید از لیست ورودی به کلاس اضافه شدند.`,{type:"VIEW_SESSIONS"}),Et(D),j&&Zt(T.length),i.value="",Jt([])}),h.addEventListener("click",()=>{Jt([]),pe("settings-page")}),i.addEventListener("keydown",T=>{if(T.key==="Enter"){const j=i.value,W=i.selectionStart,X=j.lastIndexOf(`
`,W-1),te=j.substring(X+1,W).trim(),ce=te.indexOf(".");te&&(ce<=0||ce>=te.length-1)&&(T.preventDefault(),V("لطفا نام و نام خانوادگی شخص را با یک نقطه از هم جدا کنید. مثال: علی . احمدی"))}}),s.addEventListener("click",()=>{const T=i.value.trim();if(!T){V("کادر متنی خالی است. لطفاً اسامی را وارد کنید.");return}const j=T.split(`
`).map(X=>X.trim()).filter(X=>X.length>0),W=j.find(X=>{const te=X.indexOf(".");return te<=0||te>=X.length-1});if(W){V(`فرمت نام «${W}» صحیح نیست. لطفا نام و نام خانوادگی را با نقطه جدا کنید.`);return}j.length>0?(Jt(j),Ls(),pe("csv-preview-page")):V("هیچ نام معتبری برای ورود پیدا نشد.")}),r.addEventListener("keyup",T=>{T.key==="Enter"&&n.click()}),n.addEventListener("click",()=>{if(!D)return;const T=r.value.trim();if(!T){alert("لطفاً نام دانش‌آموز را وارد کنید.");return}const j=T.indexOf(".");if(j<=0||j>=T.length-1){V("لطفا نام و نام خانوادگی شخص را با یک نقطه از هم جدا کنید. مثال: علی . احمدی");return}const W=D.students.find(ce=>ce.identity.name.toLowerCase()===T.toLowerCase());if(W)if(W.isDeleted)rn(W,D);else{alert("❌دانش‌آموزی با این نام از قبل در این کلاس وجود دارد.");return}const X=fs(T),te=new wn(X);D.addStudent(te),D.sessions.length>0&&(_e(D.sessions).filter(ce=>ce.isFinished&&!ce.isCancelled).forEach(ce=>{ce.setAttendance(te.identity.studentId,"absent")}),Qe(te,D),Zt(1)),oe(),Ee(D.info.name,`دانش‌آموز «${T}» به کلاس اضافه شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:te.identity.studentId}),kt(),Me(),r.value="",r.focus()}),document.getElementById("new-session-btn").addEventListener("click",()=>{if(D){const T=D.sessions.find(W=>!W.isFinished&&!W.isCancelled&&!W.isDeleted);if(T){V(`⚠️ جلسه ${T.sessionNumber} هنوز تمام نشده است. لطفاً ابتدا با دکمه ✅ آن را خاتمه دهید.`);return}const j=()=>{const W=X=>{const te=D.startNewSession();on(te),Ge(te),D.students.forEach(ue=>{Bs.setAttendance(ue.identity.studentId,"present")}),oe();const re=nt(D).get(te.sessionNumber);Ee(D.info.name,`جلسه ${re} شروع شد.`,{type:"VIEW_SESSIONS"}),qt(X?"attendance":"selector")};we("آیا تمایل به انجام فرآیند حضور و غیاب دارید؟",()=>W(!0),{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success",onCancel:()=>W(!1)})};D.hasSessionToday()?we("شما امروز یک جلسه برای این کلاس ثبت کرده‌اید. آیا از شروع یک جلسه جدید دیگر مطمئن هستید؟",j,{confirmText:"بله",confirmClass:"btn-warning"}):j()}}),e.addEventListener("click",()=>{const T=a.value.trim(),j=document.querySelector('input[name="class-type"]:checked');if(!T&&!j){V("⚠️لطفاً نام و نوع کلاس را مشخص کنید.");return}if(!T){V("⚠️لطفاً نام کلاس را وارد کنید.");return}if(!j){V("⚠️لطفاً نوع کلاس را انتخاب کنید.");return}if(ae[T]){ae[T].isDeleted?V("⚠️ کلاسی با این نام در سطل زباله است. ابتدا آن را بازیابی کنید و یا آن را پاک کنید."):V("⚠️کلاسی با این نام از قبل وجود دارد.");return}const W=j.value,X=new us({name:T,type:W});ae[T]=X,oe(),Ee(T,`کلاس «${T}» ایجاد شد.`,{type:"VIEW_SESSIONS"}),He(),V(`✅ کلاس «${T}» با موفقیت ایجاد شد.`),a.value="",j.checked=!1}),t.addEventListener("input",T=>{const j=T.target.value;if(j.length<2){Bn([]);return}const W=j.toLowerCase(),X=cs(W),te=[];for(const ce in ae){const re=ae[ce];if(re.isDeleted)continue;const ue=et(ce.toLowerCase()),Ce=ue.includes(et(W)),Ie=ue.includes(et(X));(Ce||Ie)&&te.push({type:"classroom",classroom:re})}for(const ce in ae){const re=ae[ce];if(re.isDeleted)continue;_e(re.students).filter(Ce=>{const Ie=et(Ce.identity.name.toLowerCase()),ze=Ie.includes(et(W)),Gt=Ie.includes(et(X));return ze||Gt}).forEach(Ce=>{te.push({type:"student",student:Ce,classroom:re})})}Bn(te)}),a.addEventListener("keyup",T=>{T.key==="Enter"&&e.click()}),c.addEventListener("click",ua),_.addEventListener("click",()=>{dn("selector")}),O.addEventListener("input",T=>{const j=T.target.value;if(!j){Xt([]);return}const W=j.toLowerCase(),X=cs(W),ce=_e(D.students).filter(re=>{const ue=et(re.identity.name.toLowerCase()),Ce=ue.includes(et(W)),Ie=ue.includes(et(X));return Ce||Ie});Xt(ce)}),O.addEventListener("focus",()=>{O.value&&Xt(O.value)}),Tt.addEventListener("click",()=>{const T=ft.value,j=at.value.trim();let W;if(zn)W=zn.student;else{const te=J==null?void 0:J.winnerHistory[Ze];W=te==null?void 0:te.winner}if(!W){V("❌خطا: دانش‌آموز معتبری برای ثبت نمره یافت نشد.");return}const X=Ve;if(!W||!X){V("⚠️لطفاً ابتدا یک دانش‌آموز و یک دسته‌بندی را انتخاب کنید.");return}if(!T){V("⚠️لطفاً مقدار نمره را وارد کنید.");return}if(T>100||T<0){V("❌نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}W&&(W.addScore(X.name,parseFloat(T),j),Ee(D.info.name,`نمره ${T} در ${X.name} برای «${W.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:W.identity.studentId}),oe(),Me(),V(`✅نمره برای ${W.identity.name} در مهارت ${X.name} ثبت شد.`),ft.value="",at.value="",Oe())});const Y=T=>{T.key==="Enter"&&T.ctrlKey&&(T.preventDefault(),Tt.click())};ft.addEventListener("keydown",Y),at.addEventListener("keydown",Y),se.addEventListener("click",()=>{ve()}),F.addEventListener("click",()=>{const T=me.value.trim(),j=zs;if(typeof j=="function"){const W=j(T);if(W===!1)return;ve(()=>{typeof W=="function"&&W()})}else ve()});const de=document.getElementById("move-student-confirm-btn"),xe=document.getElementById("move-student-cancel-btn"),ge=document.getElementById("move-student-class-select");xe.addEventListener("click",()=>{ve()}),de.addEventListener("click",()=>{const T=ge.value,j=ae[T],{studentToMove:W,sourceClassForMove:X}=Aa;if(!W||!X||!j){V("خطایی رخ داد. لطفاً دوباره امتحان کنید⚠️.","error"),ve();return}const te=Bi(W,X,j);te.success?(Ee(X.info.name,`دانش‌آموز «${W.identity.name}» به کلاس «${T}» منتقل شد.`,{type:"VIEW_SESSIONS"}),Ee(T,`دانش‌آموز «${W.identity.name}» از کلاس «${X.info.name}» به این کلاس منتقل شد.`,{type:"VIEW_SESSIONS"}),oe(),kt(),Me(),st(),V(`دانش‌آموز «${W.identity.name}» با موفقیت به کلاس «${T}» منتقل شد✅.`)):V(te.message,"error"),ve()}),L.addEventListener("click",()=>{N.style.width="300px",P.classList.add("modal-visible")}),L.addEventListener("click",()=>{N.style.width="300px",P.classList.add("modal-visible")});const qe=document.getElementById("header-settings-btn");qe&&qe.addEventListener("click",()=>{D&&Et(D)}),R.addEventListener("click",ye),R.addEventListener("click",ye),P.addEventListener("click",ye),Ye.addEventListener("click",()=>{fn(),pe("trash-page"),ye()});const ht=document.getElementById("restore-points-nav-btn");ht&&ht.addEventListener("click",()=>{wa(),pe("restore-points-page"),ye()}),document.getElementById("demo-mode-btn").addEventListener("click",()=>{ut?_t():(ye(),we("شما در حال ورود به حالت نمایش (Demo) هستید. در این حالت، هیچ‌کدام از تغییرات شما ذخیره نخواهد شد. آیا ادامه می‌دهید؟",()=>{Di(),Nn(),ye()},{confirmText:"تایید",confirmClass:"btn-warning",onCancel:ye}))});const pt=document.getElementById("exit-demo-btn");pt&&pt.addEventListener("click",()=>{ut&&_t()}),ee.addEventListener("click",()=>{if(ut){V("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است."),ye();return}ye(),un()}),S.addEventListener("click",()=>{if(ut){V("⚠️ بازیابی اطلاعات در حالت نمایش (Demo) غیرفعال است."),ye();return}z.click(),ye()}),z.addEventListener("change",T=>{const j=T.target.files[0];if(!j)return;const W=new FileReader;W.onload=async X=>{const te=X.target.result;try{const ce=JSON.parse(te);if(ce.metadata&&ce.data)Gn(ce);else{const re=ce.classrooms||ce,ue=ce.trashBin||[];we("آیا از بازیابی اطلاعات مطمئن هستید؟ تمام داده‌های فعلی شما بازنویسی خواهد شد.",()=>{Dt(re),Zs(ue),yt({lastRestoreTimestamp:new Date().toISOString()}),oe(),He(),pe("class-management-page"),V("✅اطلاعات با موفقیت بازیابی شد.")},{confirmText:"بازیابی کن",confirmClass:"btn-warning"})}}catch{try{const Ce=(await new Ts().loadAsync(te,{base64:!0})).file("backup.json");if(!Ce)throw new Error("فایل backup.json در فایل پشتیبان یافت نشد.");const Ie=await Ce.async("string"),ze=JSON.parse(Ie);if(ze.metadata&&ze.metadata.version==="2.0-b64")Gn(ze);else throw new Error("فایل پشتیبان معتبر نیست (نسخه نامشخص).")}catch(re){V("❌خطا در خواندن فایل. لطفاً فایل پشتیبان معتبر انتخاب کنید."),console.error("Restore error (zip/base64):",re)}}},W.readAsText(j),T.target.value=null}),window.addEventListener("popstate",T=>{if(Ct){ve(null,!0);return}if(Lt(),T.state){const{pageId:j,currentClassName:W,selectedSessionNumber:X,selectedStudentId:te}=T.state;W&&(We(ae[W]),X&&Ge(D.getSession(X)),te&&Je(D.students.find(ce=>ce.identity.studentId===te))),j==="session-page"?(je(),sn(j)):j==="student-profile-page"?(je(),pe("session-page"),Fe(Se)):sn(j)}else We(null),Ge(null),Je(null),sn("class-management-page")}),document.addEventListener("keydown",T=>{var X;const j=document.activeElement;if(!["INPUT","TEXTAREA","SELECT"].includes(j.tagName)){if(T.key.toLowerCase()==="o"&&T.shiftKey&&Ji.classList.contains("active")&&(T.preventDefault(),Qi.click()),T.key==="Escape"){if(Bt.classList.contains("visible")){Lt();return}if(Ct){ve();return}switch((X=document.querySelector(".page.active"))==null?void 0:X.id){case"csv-preview-page":case"column-mapping-page":pe("settings-page");break;case"student-profile-page":Je(null),pe(J?"student-page":"session-page");break;case"attendance-page":pe("student-page");break;case"student-page":Ge(null),je(),pe("session-page");break;case"settings-page":case"session-page":We(null),pe("class-management-page");break}return}if(J){const te=T.key.toLowerCase();switch(" ascfg".includes(te)&&T.preventDefault(),te){case" ":C.click();break;case"a":k.classList.contains("active")?history.back():(st(),pe("attendance-page"));break;case"s":document.getElementById("session-page").classList.contains("active")&&history.back();break;case"c":document.querySelector(".back-to-classes-btn").click();break;case"f":const ce=document.querySelector(".action-column .search-icon");ce&&ce.click();break;case"g":if(studentProfilePage.classList.contains("active"))history.back();else{const re=J.lastSelectedWinnerId;if(re){const ue=D.students.find(Ce=>Ce.identity.studentId===re);ue&&(Je(ue),(void 0)(),pe("student-profile-page"))}else V("⚠️ابتدا یک نفر را انتخاب کنید تا پروفایل او نمایش داده شود.")}break;case"arrowleft":{const re=document.querySelector('button[title="برنده قبلی"]');re&&!re.disabled&&(T.preventDefault(),re.click());break}case"arrowright":{const re=document.querySelector('button[title="برنده بعدی"]');re&&!re.disabled&&(T.preventDefault(),re.click());break}}}}});function ye(){N.style.width="0",P.classList.add("modal-closing"),setTimeout(()=>{P.classList.remove("modal-visible","modal-closing")},300)}function _t(){we("آیا از خروج از حالت نمایش (Demo) مطمئن هستید؟ با خروج، تمام تغییرات آزمایشی شما حذف شده و داده‌های اصلی شما بازیابی خواهند شد.",()=>{Ai(),We(null),Ge(null),Je(null),He(),pe("class-management-page"),Nn(),ye()},{confirmText:"خروج",confirmClass:"btn-success"})}d(".global-search-container .animated-search-container",Bn),d(".action-column-header .animated-search-container",Xt),go(),[ke,sa,at,Xi].forEach(T=>{T&&ii(T)});function Qe(T,j){const W=_e(j.students).filter(Te=>Te.identity.studentId!==T.identity.studentId);if(W.length===0)return;const X=W.reduce((Te,Pe)=>Pe.statusCounters.totalSelections>Te.statusCounters.totalSelections?Pe:Te,W[0]);if(!X||X.statusCounters.totalSelections===0)return;T.categoryCounts=JSON.parse(JSON.stringify(X.categoryCounts)),T.statusCounters.totalSelections=X.statusCounters.totalSelections;const te=W.reduce((Te,Pe)=>Te+Pe.statusCounters.totalSelections,0),ce=W.reduce((Te,Pe)=>Te+(Pe.statusCounters.missedChances||0),0),re=te>0?ce/te:0;T.statusCounters.missedChances=Math.round(T.statusCounters.totalSelections*re);const ue=_e(j.categories),Ce={};ue.forEach(Te=>{const Pe=W.reduce((rs,os)=>rs+(os.categoryCounts[Te.name]||0),0),as=W.reduce((rs,os)=>rs+(os.categoryIssues[Te.name]||0),0);Ce[Te.name]=Pe>0?as/Pe:0}),ue.forEach(Te=>{const Pe=T.categoryCounts[Te.name]||0,as=Ce[Te.name]||0;T.categoryIssues[Te.name]=Math.round(Pe*as)});const Ie=j.liveSession;Ie?T.onboardingSession=Ie.sessionNumber:T.onboardingSession=j.sessions.length+1;const ze=_e(j.sessions).filter(Te=>Te.isFinished&&!Te.isCancelled),Gt="📝 یادداشت خودکار سیستم",Sa=`این دانش‌آموز  از جلسه شماره ${ze.length} به کلاس اضافه شد. آمار مشارکت او بر اساس فعال‌ترین دانش‌آموز و آمار «فرصت از دست رفته» او بر اساس میانگین کلاس ثبت گردید:`,Ot=[];T.statusCounters.totalSelections>0&&Ot.push(`کل انتخاب‌ها: ${T.statusCounters.totalSelections}`),T.statusCounters.missedChances>0&&Ot.push(`فرصت‌های از دست رفته: ${T.statusCounters.missedChances}`);for(const Te in T.categoryCounts){const Pe=T.categoryCounts[Te];Pe>0&&Ot.push(`انتخاب در «${Te}»: ${Pe}`)}for(const Te in T.categoryIssues){const Pe=T.categoryIssues[Te];Pe>0&&Ot.push(`مشکل در «${Te}»: ${Pe}`)}if(Ot.length>0){const Te=`${Gt}
${Sa}

- ${Ot.join(`
- `)}`;T.addNote(Te)}}function Zt(T){const W=`چون این کلاس جلسات برگزار شده دارد، برای ${T>1?"دانش‌آموزان جدید":"دانش‌آموز جدید"} آمار پایه‌ای (متناسب با سایر دانش‌آموزان) ثبت شد تا در فرایند انتخاب اختلالی ایجاد نشود.`;we(W,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}const ts="19.0.1",ns="819";{const T=` (ساخت ${ns})`;document.getElementById("app-version").textContent=`نسخه ${ts}${T}`}function ss(){console.log("Starting universal backfill for writing scores...");let T=0;for(const j in ae){const W=ae[j];if(W.isDeleted)continue;let X=0;_e(W.students).forEach(ce=>{const re=ce.logs.scores;if(!(re&&re.writing&&re.writing.length>0)){let Ce=-1;for(const Ie in re)Ie!=="writing"&&re[Ie].forEach(ze=>{ze.value>Ce&&(Ce=ze.value)});if(Ce>-1){const Ie=`Automatically assigned based on the highest score (${Ce}) from other skills.`;ce.addScore("Writing",Ce,Ie),X++}}}),X>0&&(console.log(`Updated ${X} student(s) in class: ${W.info.name}.`),T+=X)}T>0?(oe(),console.log(`Update complete. A total of ${T} student(s) were updated across all classes. Data saved.`),document.getElementById("student-page").classList.contains("active")&&Me()):console.log("No students needed updating in any class.")}window.backfillWritingScoresForAll=ss;function gn(){console.log("Starting backfill for 'outOfClassCount' and 'wasOutOfClass' properties...");let T=0,j=0;const W=localStorage.getItem("teacherAssistantData_v2");if(!W){console.log("No data found in localStorage. Nothing to do.");return}const X=JSON.parse(W);for(const te in X){const ce=X[te];ce.students&&ce.students.forEach(re=>{re.statusCounters&&typeof re.statusCounters.outOfClassCount>"u"&&(re.statusCounters.outOfClassCount=0,T++)}),ce.sessions&&ce.sessions.forEach(re=>{if(re.studentRecords)for(const ue in re.studentRecords){const Ce=re.studentRecords[ue];typeof Ce.wasOutOfClass>"u"&&(Ce.wasOutOfClass=!1,j++)}})}localStorage.setItem("teacherAssistantData_v2",JSON.stringify(X)),console.log(`Backfill complete. Updated ${T} students and ${j} session records. Data saved.`),Fn(),D&&Me()}window.backfillExitCounters=gn;function St(){console.log("🧹 Starting orphaned data cleanup...");let T=0;for(const j in ae){const W=ae[j];if(W.isDeleted)continue;let X=!1;const te=new Set(W.students.filter(ue=>!ue.isDeleted).map(ue=>ue.identity.studentId)),ce=new Map(W.students.map(ue=>[ue.identity.studentId,ue.identity.name])),re=[];W.sessions.forEach(ue=>{if(ue.isDeleted)return;const Ce=[];for(const Ie in ue.studentRecords)if(!te.has(Ie)){const ze=ce.get(Ie)||"Unknown/Deleted";Ce.push(`  - Removed student record for: ${ze} (ID: ${Ie})`),delete ue.studentRecords[Ie],T++,X=!0}for(const Ie in ue.lastWinnerByCategory){const ze=ue.lastWinnerByCategory[Ie];if(!te.has(ze)){const Gt=ce.get(ze)||"Unknown/Deleted";Ce.push(`  - Removed '${Ie}' last winner: ${Gt} (ID: ${ze})`),delete ue.lastWinnerByCategory[Ie],T++,X=!0}}if(ue.lastSelectedWinnerId&&!te.has(ue.lastSelectedWinnerId)){const Ie=ue.lastSelectedWinnerId,ze=ce.get(Ie)||"Unknown/Deleted";Ce.push(`  - Cleared 'lastSelectedWinnerId': ${ze} (ID: ${Ie})`),ue.lastSelectedWinnerId=null,T++,X=!0}if(Ce.length>0){const ze=nt(W).get(ue.sessionNumber)||`(#${ue.sessionNumber})`;re.push({sessionDisplayNumber:ze,logs:Ce})}}),X&&(console.group(`➡️ Class: ${j}`),re.forEach(ue=>{console.groupCollapsed(`  Session ${ue.sessionDisplayNumber}`),ue.logs.forEach(Ce=>console.warn(Ce)),console.groupEnd()}),console.groupEnd())}T>0?(oe(),console.log(`✅ Cleanup complete! Found and removed ${T} orphaned references. Data saved.`)):console.log("✅ No orphaned data found. Your data is clean!")}window.cleanupOrphanedData=St;function At(T){if(!T||!T.classroomName)return;const j=ae[T.classroomName];if(!j){V("⚠️ کلاس مربوط به این گزارش یافت نشد.");return}We(j),ve(),setTimeout(()=>{switch(T.type){case"VIEW_STUDENT_PROFILE":{const W=j.students.find(X=>X.identity.studentId===T.studentId);W?Fe(W):V("⚠️ دانش‌آموز مورد نظر یافت نشد.");break}case"VIEW_TRASH":fn(),pe("trash-page");break;case"VIEW_SESSIONS":je(),pe("session-page");break;case"VIEW_CLASS_NOTE":Qn(j);break;case"VIEW_CLASS_SETTINGS":Et(j);break}},300)}Be.addEventListener("click",()=>{ni()}),Ae.addEventListener("click",()=>{ve()}),he.addEventListener("click",()=>{const T=be.value.trim(),j=Le.checked;if(!T){Qs.style.display==="flex"?we("کادر یادداشت خالی است. آیا مطمئنید که می‌خواهید یادداشت‌های قبلی دانش‌آموزان انتخاب‌شده را پاک کنید؟",()=>{ve(),_s("",!1)},{confirmText:"پاک کردن",confirmClass:"btn-warning"}):V("⚠️ لطفاً متن یادداشت را وارد کنید.");return}ve(()=>{_s(T,j)})});const It=document.getElementById("screen-saver-overlay");let is;const Ea=2*60*1e3,ri=["mousemove","keypress","scroll","click","touchstart"];function ka(){It.classList.add("visible")}function oi(){It.classList.contains("visible")&&It.classList.remove("visible")}function yn(){oi(),clearTimeout(is),is=setTimeout(ka,Ea)}function vn(T){T.preventDefault(),T.stopPropagation(),setTimeout(yn,0)}function ci(){yn(),ri.forEach(j=>window.addEventListener(j,yn)),It.addEventListener("click",vn),It.addEventListener("touchstart",vn);const T="19.0.1";{const j=document.getElementById("screen-saver-version");j&&(j.textContent=`v${T}`)}}function _a(){clearTimeout(is),oi(),ri.forEach(T=>window.removeEventListener(T,yn)),It.removeEventListener("click",vn),It.removeEventListener("touchstart",vn)}document.getElementById("app-settings-modal");const li=document.getElementById("app-settings-nav-btn"),di=document.getElementById("close-settings-btn"),ui=document.getElementById("setting-sound-toggle"),fi=document.getElementById("setting-vibration-toggle"),mi=document.getElementById("setting-screensaver-toggle");li&&li.addEventListener("click",()=>{ye(),ui.checked=$e.isSoundEnabled,fi.checked=$e.isVibrationEnabled,mi.checked=$e.isScreenSaverEnabled,Re("app-settings-modal")}),di&&di.addEventListener("click",()=>{ve()}),ui.addEventListener("change",T=>{yt({isSoundEnabled:T.target.checked}),T.target.checked&&pi()}),fi.addEventListener("change",T=>{yt({isVibrationEnabled:T.target.checked}),T.target.checked&&navigator.vibrate&&navigator.vibrate(50)}),$e.isScreenSaverEnabled&&ci(),mi.addEventListener("change",T=>{T.target.checked?(yt({isScreenSaverEnabled:!0}),ci()):(yt({isScreenSaverEnabled:!1}),_a())})});function po(t,a){if(!J||J.isFinished){V("⚠️ امکان لغو انتخاب در جلسه خاتمه یافته وجود ندارد.");return}const e=J.winnerHistory;if(!(Ze===e.length-1)||e.length===0){V("⚠️ فقط آخرین انتخاب قابل لغو است.");return}if(e[e.length-1].winner.identity.studentId!==t.identity.studentId){console.error("Undo mismatch!");return}we(`آیا از حذف انتخاب «${t.identity.name}» برای «${a}» مطمئن هستید؟ آمار این انتخاب بازگردانی خواهد شد.`,()=>{const r=J.winnerHistory,n=r.pop();if(!n)return;const i=n.winner,s=n.categoryName,o=i.identity.studentId;i.statusCounters.totalSelections=Math.max(0,i.statusCounters.totalSelections-1),i.categoryCounts[s]&&(i.categoryCounts[s]=Math.max(0,i.categoryCounts[s]-1));const l=J.studentRecords[o];if(l&&l.selections[s]&&(l.selections[s]=Math.max(0,l.selections[s]-1)),n.rating){const p=n.rating;i.qualitativeStats&&i.qualitativeStats[s]&&i.qualitativeStats[s][p]>0&&i.qualitativeStats[s][p]--}let h=null;for(let p=r.length-1;p>=0;p--)if(r[p].categoryName===s){h=r[p].winner.identity.studentId;break}h?J.lastWinnerByCategory[s]=h:delete J.lastWinnerByCategory[s],wt(r.length-1),Me(),Oe(),oe(),V(`✅ انتخاب «${i.identity.name}» لغو شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}function go(){const t=document.getElementById("session-dashboard-page"),a=document.getElementById("student-stats-table-container");if(!t)return;let e=0,c=0;t.addEventListener("touchstart",n=>{if(a&&a.contains(n.target)){const i=n.target.closest("td, th");i&&i.parentElement.firstElementChild===i?e=n.changedTouches[0].screenX:e=0}else e=n.changedTouches[0].screenX},{passive:!0}),t.addEventListener("touchend",n=>{e!==0&&(c=n.changedTouches[0].screenX,r())});function r(){const i=e-c;Math.abs(i)>150&&(document.getElementById("selector-tab-btn").classList.contains("active")?(pe("session-dashboard-page",{tab:"attendance"}),dn("attendance")):(pe("session-dashboard-page",{tab:"selector"}),dn("selector"))),e=0,c=0}}
