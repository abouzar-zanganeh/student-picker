(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))c(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&c(i)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function c(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();const Ra={ili:{id:"ili",label:"کانون زبان ایران",levels:["Primer 1","Primer 2","Step Up 1","Step Up 2","Step Up 3","Step Up 4","Move Up 1","Move Up 2","Move Up 3","Move Up 4","Jump Up 1","Jump Up 2","Jump Up 3","Jump Up 4","Start 1","Run 1","Run 2","Run 3","Run 4","Race 1","Race 2","Race 3","Reach 1","Reach 2","Reach 3","Reach 4","Basic 1","Basic 2","Basic 3","Elementary 1","Elementary 2","Elementary 3","Pre-intermediate 1","Pre-intermediate 2","Pre-intermediate 3","Intermediate 1","Intermediate 2","Intermediate 3","High-intermediate 1","High-intermediate 2","High-intermediate 3","Advanced 1","Advanced 2","Advanced 3"]},school:{id:"school",label:"آموزش و پرورش",levels:["کلاس اول","کلاس دوم","کلاس سوم","کلاس چهارم","کلاس پنجم","کلاس ششم","کلاس هفتم","کلاس هشتم","کلاس نهم","کلاس دهم","کلاس یازدهم","کلاس دوازدهم"]},custom:{id:"custom",label:"سایر / آزاد",levels:[]}};class Tn{constructor(r){this.identity={name:r.name,firstName:r.firstName||null,lastName:r.lastName||null,studentId:r.studentId||`id_${new Date().getTime()}_${Math.random()}`,branchName:r.branchName||null,ageGroup:r.ageGroup||"adult",level:r.level||null,contact:{social:r.socialContact||null,parent:r.parentContact||null}},this.isDeleted=!1,this.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0,outOfClassCount:0},this.categoryCounts={},this.categoryIssues={},this.qualitativeStats={},this.logs={parentContacts:[],scores:{},discipline:{},sessionHistory:{}},this.profile={notes:[],tags:[]},this.finalClassActivityScore=null,this.onboardingSession=null}addScore(r,e,c){if(e>100||e<0){console.log("نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}const s=r.toLowerCase();this.logs.scores[s]||(this.logs.scores[s]=[]);const n=new ar(r,e,c);this.logs.scores[s].push(n)}addNote(r,e=null){const c=new ir(r,e);this.profile.notes.push(c)}getOverallAverageScore(){let r=0,e=0;for(const s in this.logs.scores)this.logs.scores[s].forEach(n=>{n.isDeleted||(r+=n.value,e++)});if(e===0)return null;const c=r/e;return Math.trunc(c*10)/10}}class ar{constructor(r,e,c=""){this.id=`score_${new Date().getTime()}`,this.skill=r,this.value=e,this.timestamp=new Date,this.comment=c,this.isDeleted=!1}}class ir{constructor(r,e=null){this.id=`note_${new Date().getTime()}`,this.timestamp=new Date,this.content=r,this.isDeleted=!1,this.source=e}}class xs{constructor(r="complete",e=""){this.status=r,this.comment=e,this.timestamp=new Date}}class Ua{constructor(r){this.sessionNumber=r,this.startTime=new Date,this.createdAt=new Date,this.note="",this.isDeleted=!1,this.endTime=null,this.isFinished=!1,this.isMakeup=!1,this.isCancelled=!1,this.studentRecords={},this.lastWinnerByCategory={},this.lastUsedCategoryId=null,this.lastSelectedWinnerId=null,this.winnerHistory=[]}end(){this.isFinished=!0,this.endTime=new Date}markAsMakeup(){this.isMakeup=!this.isMakeup}initializeStudentRecord(r){this.studentRecords[r]||(this.studentRecords[r]={attendance:"present",homework:new xs,selections:{},hadIssue:!1,wasOutOfClass:!1,performanceRatings:{}})}setAttendance(r,e){this.initializeStudentRecord(r),this.studentRecords[r].attendance=e}setHomeworkStatus(r,e){this.initializeStudentRecord(r),this.studentRecords[r].homework.status=e}selectNextWinner(r,e,c){if(!e||e.length===0)return console.log("هیچ دانش‌آموزی در کلاس برای انتخاب وجود ندارد."),null;const s=this.lastWinnerByCategory[r];let n=e.filter(u=>u.identity.studentId!==s&&!u.isDeleted);if(n.length===0&&(n=e),n.length===0)return null;const i=(u,h)=>u.categoryCounts[h]||0,a=Math.min(...n.map(u=>i(u,r))),o=n.filter(u=>i(u,r)===a);let l;if(o.length===1)l=o[0];else if(o.length>1){const u=c.filter(v=>!v.isDeleted&&v.name!==r).map(v=>v.name),h=o.map(v=>{const b=u.reduce((C,S)=>C+i(v,S),0);return{student:v,otherCategoriesTotal:b}}),y=Math.min(...h.map(v=>v.otherCategoriesTotal)),f=h.filter(v=>v.otherCategoriesTotal===y).map(v=>v.student);f.length===1?l=f[0]:l=f[Math.floor(Math.random()*f.length)]}else l=n[Math.floor(Math.random()*n.length)];const m=l.identity.studentId;this.initializeStudentRecord(m);const p=(this.studentRecords[m].selections[r]||0)+1;return this.studentRecords[m].selections[r]=p,l.statusCounters.totalSelections++,l.categoryCounts[r]=(l.categoryCounts[r]||0)+1,this.lastWinnerByCategory[r]=m,l}}class Ls{constructor(r){this.info={name:r.name||"NotNamed",teacherName:r.teacherName||null,type:r.type||"in-person",educationalSystem:r.educationalSystem||"custom",term:r.term||null,scheduleText:r.scheduleText||null,level:r.level||null,creationDate:r.creationDate?new Date(r.creationDate):new Date,scheduleCode:r.scheduleCode||`code_${new Date().getTime()}`,scheduleDays:r.scheduleDays||[],scheduleStartTime:r.scheduleStartTime||null,scheduleEndTime:r.scheduleEndTime||null},this.students=[],this.sessions=[],this.note="",this.isDeleted=!1,this.categories=[new gt("Vocabulary","Questions about words and meanings."),new gt("Grammar","Questions about sentence structure and rules."),new gt("Listening",void 0,!0),new gt("Speaking",void 0,!0),new gt("Reading",void 0,!0),new gt("Writing",void 0,!0)],this.futurePlans={}}addStudent(r){this.students.push(r)}startNewSession(){const e=this.sessions.reduce((s,n)=>Math.max(s,n.sessionNumber),0)+1,c=new Ua(e);return this.sessions.push(c),c}endSpecificSession(r){const e=this.getSession(r);return e&&!e.isFinished?(e.end(),!0):!1}getSession(r){return this.sessions.find(e=>e.sessionNumber===r)}markAsMakeup(r){const e=this.getSession(r);e&&e.markAsMakeup()}planForSession(r,e){this.futurePlans[r]=e}hasSessionToday(){const r=new Date().toDateString();return this.sessions.some(e=>!e.isDeleted&&e.startTime.toDateString()===r)}selectNextWinner(r,e){return e?e.selectNextWinner(r,this.students,this.categories):null}get liveSession(){for(let r=this.sessions.length-1;r>=0;r--)if(!this.sessions[r].isFinished)return this.sessions[r];return null}calculateFinalStudentScore(r){var i;const e=this.categories.filter(a=>a.isGradedCategory&&!a.isDeleted);if(e.length===0)return null;let c=0,s=0;for(const a of e){const o=a.name.toLowerCase(),l=((i=r.logs.scores[o])==null?void 0:i.filter(p=>!p.isDeleted))||[];if(l.length===0)return null;const m=l.reduce((p,u)=>p+u.value,0)/l.length;c+=m*(a.weight||1),s+=a.weight||1}if(s===0)return null;const n=c/s;return Math.trunc(n*10)/10}}class gt{constructor(r,e="",c=!1,s=1){this.id=`cat_${new Date().getTime()}_${Math.random()}`,this.name=r,this.description=e,this.isDeleted=!1,this.isGradedCategory=c,this.weight=s,this.isDeleted=!1}}var xn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ja(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function Ln(t){throw new Error('Could not dynamically require "'+t+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var qa={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/(function(t,r){(function(e){t.exports=e()})(function(){return function e(c,s,n){function i(l,m){if(!s[l]){if(!c[l]){var p=typeof Ln=="function"&&Ln;if(!m&&p)return p(l,!0);if(a)return a(l,!0);var u=new Error("Cannot find module '"+l+"'");throw u.code="MODULE_NOT_FOUND",u}var h=s[l]={exports:{}};c[l][0].call(h.exports,function(y){var f=c[l][1][y];return i(f||y)},h,h.exports,e,c,s,n)}return s[l].exports}for(var a=typeof Ln=="function"&&Ln,o=0;o<n.length;o++)i(n[o]);return i}({1:[function(e,c,s){var n=e("./utils"),i=e("./support"),a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";s.encode=function(o){for(var l,m,p,u,h,y,f,v=[],b=0,C=o.length,S=C,k=n.getTypeOf(o)!=="string";b<o.length;)S=C-b,p=k?(l=o[b++],m=b<C?o[b++]:0,b<C?o[b++]:0):(l=o.charCodeAt(b++),m=b<C?o.charCodeAt(b++):0,b<C?o.charCodeAt(b++):0),u=l>>2,h=(3&l)<<4|m>>4,y=1<S?(15&m)<<2|p>>6:64,f=2<S?63&p:64,v.push(a.charAt(u)+a.charAt(h)+a.charAt(y)+a.charAt(f));return v.join("")},s.decode=function(o){var l,m,p,u,h,y,f=0,v=0,b="data:";if(o.substr(0,b.length)===b)throw new Error("Invalid base64 input, it looks like a data url.");var C,S=3*(o=o.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(o.charAt(o.length-1)===a.charAt(64)&&S--,o.charAt(o.length-2)===a.charAt(64)&&S--,S%1!=0)throw new Error("Invalid base64 input, bad content length.");for(C=i.uint8array?new Uint8Array(0|S):new Array(0|S);f<o.length;)l=a.indexOf(o.charAt(f++))<<2|(u=a.indexOf(o.charAt(f++)))>>4,m=(15&u)<<4|(h=a.indexOf(o.charAt(f++)))>>2,p=(3&h)<<6|(y=a.indexOf(o.charAt(f++))),C[v++]=l,h!==64&&(C[v++]=m),y!==64&&(C[v++]=p);return C}},{"./support":30,"./utils":32}],2:[function(e,c,s){var n=e("./external"),i=e("./stream/DataWorker"),a=e("./stream/Crc32Probe"),o=e("./stream/DataLengthProbe");function l(m,p,u,h,y){this.compressedSize=m,this.uncompressedSize=p,this.crc32=u,this.compression=h,this.compressedContent=y}l.prototype={getContentWorker:function(){var m=new i(n.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new o("data_length")),p=this;return m.on("end",function(){if(this.streamInfo.data_length!==p.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),m},getCompressedWorker:function(){return new i(n.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},l.createWorkerFrom=function(m,p,u){return m.pipe(new a).pipe(new o("uncompressedSize")).pipe(p.compressWorker(u)).pipe(new o("compressedSize")).withStreamInfo("compression",p)},c.exports=l},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,c,s){var n=e("./stream/GenericWorker");s.STORE={magic:"\0\0",compressWorker:function(){return new n("STORE compression")},uncompressWorker:function(){return new n("STORE decompression")}},s.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,c,s){var n=e("./utils"),i=function(){for(var a,o=[],l=0;l<256;l++){a=l;for(var m=0;m<8;m++)a=1&a?3988292384^a>>>1:a>>>1;o[l]=a}return o}();c.exports=function(a,o){return a!==void 0&&a.length?n.getTypeOf(a)!=="string"?function(l,m,p,u){var h=i,y=u+p;l^=-1;for(var f=u;f<y;f++)l=l>>>8^h[255&(l^m[f])];return-1^l}(0|o,a,a.length,0):function(l,m,p,u){var h=i,y=u+p;l^=-1;for(var f=u;f<y;f++)l=l>>>8^h[255&(l^m.charCodeAt(f))];return-1^l}(0|o,a,a.length,0):0}},{"./utils":32}],5:[function(e,c,s){s.base64=!1,s.binary=!1,s.dir=!1,s.createFolders=!0,s.date=null,s.compression=null,s.compressionOptions=null,s.comment=null,s.unixPermissions=null,s.dosPermissions=null},{}],6:[function(e,c,s){var n=null;n=typeof Promise<"u"?Promise:e("lie"),c.exports={Promise:n}},{lie:37}],7:[function(e,c,s){var n=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",i=e("pako"),a=e("./utils"),o=e("./stream/GenericWorker"),l=n?"uint8array":"array";function m(p,u){o.call(this,"FlateWorker/"+p),this._pako=null,this._pakoAction=p,this._pakoOptions=u,this.meta={}}s.magic="\b\0",a.inherits(m,o),m.prototype.processChunk=function(p){this.meta=p.meta,this._pako===null&&this._createPako(),this._pako.push(a.transformTo(l,p.data),!1)},m.prototype.flush=function(){o.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},m.prototype.cleanUp=function(){o.prototype.cleanUp.call(this),this._pako=null},m.prototype._createPako=function(){this._pako=new i[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var p=this;this._pako.onData=function(u){p.push({data:u,meta:p.meta})}},s.compressWorker=function(p){return new m("Deflate",p)},s.uncompressWorker=function(){return new m("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(e,c,s){function n(h,y){var f,v="";for(f=0;f<y;f++)v+=String.fromCharCode(255&h),h>>>=8;return v}function i(h,y,f,v,b,C){var S,k,_=h.file,x=h.compression,L=C!==l.utf8encode,N=a.transformTo("string",C(_.name)),R=a.transformTo("string",l.utf8encode(_.name)),j=_.comment,ee=a.transformTo("string",C(j)),I=a.transformTo("string",l.utf8encode(j)),z=R.length!==_.name.length,g=I.length!==j.length,H="",fe="",Z="",me=_.dir,P=_.date,se={crc32:0,compressedSize:0,uncompressedSize:0};y&&!f||(se.crc32=h.crc32,se.compressedSize=h.compressedSize,se.uncompressedSize=h.uncompressedSize);var O=0;y&&(O|=8),L||!z&&!g||(O|=2048);var M=0,de=0;me&&(M|=16),b==="UNIX"?(de=798,M|=function(Q,Be){var Me=Q;return Q||(Me=Be?16893:33204),(65535&Me)<<16}(_.unixPermissions,me)):(de=20,M|=function(Q){return 63&(Q||0)}(_.dosPermissions)),S=P.getUTCHours(),S<<=6,S|=P.getUTCMinutes(),S<<=5,S|=P.getUTCSeconds()/2,k=P.getUTCFullYear()-1980,k<<=4,k|=P.getUTCMonth()+1,k<<=5,k|=P.getUTCDate(),z&&(fe=n(1,1)+n(m(N),4)+R,H+="up"+n(fe.length,2)+fe),g&&(Z=n(1,1)+n(m(ee),4)+I,H+="uc"+n(Z.length,2)+Z);var te="";return te+=`
\0`,te+=n(O,2),te+=x.magic,te+=n(S,2),te+=n(k,2),te+=n(se.crc32,4),te+=n(se.compressedSize,4),te+=n(se.uncompressedSize,4),te+=n(N.length,2),te+=n(H.length,2),{fileRecord:p.LOCAL_FILE_HEADER+te+N+H,dirRecord:p.CENTRAL_FILE_HEADER+n(de,2)+te+n(ee.length,2)+"\0\0\0\0"+n(M,4)+n(v,4)+N+H+ee}}var a=e("../utils"),o=e("../stream/GenericWorker"),l=e("../utf8"),m=e("../crc32"),p=e("../signature");function u(h,y,f,v){o.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=y,this.zipPlatform=f,this.encodeFileName=v,this.streamFiles=h,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}a.inherits(u,o),u.prototype.push=function(h){var y=h.meta.percent||0,f=this.entriesCount,v=this._sources.length;this.accumulate?this.contentBuffer.push(h):(this.bytesWritten+=h.data.length,o.prototype.push.call(this,{data:h.data,meta:{currentFile:this.currentFile,percent:f?(y+100*(f-v-1))/f:100}}))},u.prototype.openedSource=function(h){this.currentSourceOffset=this.bytesWritten,this.currentFile=h.file.name;var y=this.streamFiles&&!h.file.dir;if(y){var f=i(h,y,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:f.fileRecord,meta:{percent:0}})}else this.accumulate=!0},u.prototype.closedSource=function(h){this.accumulate=!1;var y=this.streamFiles&&!h.file.dir,f=i(h,y,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(f.dirRecord),y)this.push({data:function(v){return p.DATA_DESCRIPTOR+n(v.crc32,4)+n(v.compressedSize,4)+n(v.uncompressedSize,4)}(h),meta:{percent:100}});else for(this.push({data:f.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},u.prototype.flush=function(){for(var h=this.bytesWritten,y=0;y<this.dirRecords.length;y++)this.push({data:this.dirRecords[y],meta:{percent:100}});var f=this.bytesWritten-h,v=function(b,C,S,k,_){var x=a.transformTo("string",_(k));return p.CENTRAL_DIRECTORY_END+"\0\0\0\0"+n(b,2)+n(b,2)+n(C,4)+n(S,4)+n(x.length,2)+x}(this.dirRecords.length,f,h,this.zipComment,this.encodeFileName);this.push({data:v,meta:{percent:100}})},u.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},u.prototype.registerPrevious=function(h){this._sources.push(h);var y=this;return h.on("data",function(f){y.processChunk(f)}),h.on("end",function(){y.closedSource(y.previous.streamInfo),y._sources.length?y.prepareNextSource():y.end()}),h.on("error",function(f){y.error(f)}),this},u.prototype.resume=function(){return!!o.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},u.prototype.error=function(h){var y=this._sources;if(!o.prototype.error.call(this,h))return!1;for(var f=0;f<y.length;f++)try{y[f].error(h)}catch{}return!0},u.prototype.lock=function(){o.prototype.lock.call(this);for(var h=this._sources,y=0;y<h.length;y++)h[y].lock()},c.exports=u},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,c,s){var n=e("../compressions"),i=e("./ZipFileWorker");s.generateWorker=function(a,o,l){var m=new i(o.streamFiles,l,o.platform,o.encodeFileName),p=0;try{a.forEach(function(u,h){p++;var y=function(C,S){var k=C||S,_=n[k];if(!_)throw new Error(k+" is not a valid compression method !");return _}(h.options.compression,o.compression),f=h.options.compressionOptions||o.compressionOptions||{},v=h.dir,b=h.date;h._compressWorker(y,f).withStreamInfo("file",{name:u,dir:v,date:b,comment:h.comment||"",unixPermissions:h.unixPermissions,dosPermissions:h.dosPermissions}).pipe(m)}),m.entriesCount=p}catch(u){m.error(u)}return m}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,c,s){function n(){if(!(this instanceof n))return new n;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var i=new n;for(var a in this)typeof this[a]!="function"&&(i[a]=this[a]);return i}}(n.prototype=e("./object")).loadAsync=e("./load"),n.support=e("./support"),n.defaults=e("./defaults"),n.version="3.10.1",n.loadAsync=function(i,a){return new n().loadAsync(i,a)},n.external=e("./external"),c.exports=n},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,c,s){var n=e("./utils"),i=e("./external"),a=e("./utf8"),o=e("./zipEntries"),l=e("./stream/Crc32Probe"),m=e("./nodejsUtils");function p(u){return new i.Promise(function(h,y){var f=u.decompressed.getContentWorker().pipe(new l);f.on("error",function(v){y(v)}).on("end",function(){f.streamInfo.crc32!==u.decompressed.crc32?y(new Error("Corrupted zip : CRC32 mismatch")):h()}).resume()})}c.exports=function(u,h){var y=this;return h=n.extend(h||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:a.utf8decode}),m.isNode&&m.isStream(u)?i.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):n.prepareContent("the loaded zip file",u,!0,h.optimizedBinaryString,h.base64).then(function(f){var v=new o(h);return v.load(f),v}).then(function(f){var v=[i.Promise.resolve(f)],b=f.files;if(h.checkCRC32)for(var C=0;C<b.length;C++)v.push(p(b[C]));return i.Promise.all(v)}).then(function(f){for(var v=f.shift(),b=v.files,C=0;C<b.length;C++){var S=b[C],k=S.fileNameStr,_=n.resolve(S.fileNameStr);y.file(_,S.decompressed,{binary:!0,optimizedBinaryString:!0,date:S.date,dir:S.dir,comment:S.fileCommentStr.length?S.fileCommentStr:null,unixPermissions:S.unixPermissions,dosPermissions:S.dosPermissions,createFolders:h.createFolders}),S.dir||(y.file(_).unsafeOriginalName=k)}return v.zipComment.length&&(y.comment=v.zipComment),y})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,c,s){var n=e("../utils"),i=e("../stream/GenericWorker");function a(o,l){i.call(this,"Nodejs stream input adapter for "+o),this._upstreamEnded=!1,this._bindStream(l)}n.inherits(a,i),a.prototype._bindStream=function(o){var l=this;(this._stream=o).pause(),o.on("data",function(m){l.push({data:m,meta:{percent:0}})}).on("error",function(m){l.isPaused?this.generatedError=m:l.error(m)}).on("end",function(){l.isPaused?l._upstreamEnded=!0:l.end()})},a.prototype.pause=function(){return!!i.prototype.pause.call(this)&&(this._stream.pause(),!0)},a.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},c.exports=a},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,c,s){var n=e("readable-stream").Readable;function i(a,o,l){n.call(this,o),this._helper=a;var m=this;a.on("data",function(p,u){m.push(p)||m._helper.pause(),l&&l(u)}).on("error",function(p){m.emit("error",p)}).on("end",function(){m.push(null)})}e("../utils").inherits(i,n),i.prototype._read=function(){this._helper.resume()},c.exports=i},{"../utils":32,"readable-stream":16}],14:[function(e,c,s){c.exports={isNode:typeof Buffer<"u",newBufferFrom:function(n,i){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(n,i);if(typeof n=="number")throw new Error('The "data" argument must not be a number');return new Buffer(n,i)},allocBuffer:function(n){if(Buffer.alloc)return Buffer.alloc(n);var i=new Buffer(n);return i.fill(0),i},isBuffer:function(n){return Buffer.isBuffer(n)},isStream:function(n){return n&&typeof n.on=="function"&&typeof n.pause=="function"&&typeof n.resume=="function"}}},{}],15:[function(e,c,s){function n(_,x,L){var N,R=a.getTypeOf(x),j=a.extend(L||{},m);j.date=j.date||new Date,j.compression!==null&&(j.compression=j.compression.toUpperCase()),typeof j.unixPermissions=="string"&&(j.unixPermissions=parseInt(j.unixPermissions,8)),j.unixPermissions&&16384&j.unixPermissions&&(j.dir=!0),j.dosPermissions&&16&j.dosPermissions&&(j.dir=!0),j.dir&&(_=b(_)),j.createFolders&&(N=v(_))&&C.call(this,N,!0);var ee=R==="string"&&j.binary===!1&&j.base64===!1;L&&L.binary!==void 0||(j.binary=!ee),(x instanceof p&&x.uncompressedSize===0||j.dir||!x||x.length===0)&&(j.base64=!1,j.binary=!0,x="",j.compression="STORE",R="string");var I=null;I=x instanceof p||x instanceof o?x:y.isNode&&y.isStream(x)?new f(_,x):a.prepareContent(_,x,j.binary,j.optimizedBinaryString,j.base64);var z=new u(_,I,j);this.files[_]=z}var i=e("./utf8"),a=e("./utils"),o=e("./stream/GenericWorker"),l=e("./stream/StreamHelper"),m=e("./defaults"),p=e("./compressedObject"),u=e("./zipObject"),h=e("./generate"),y=e("./nodejsUtils"),f=e("./nodejs/NodejsStreamInputAdapter"),v=function(_){_.slice(-1)==="/"&&(_=_.substring(0,_.length-1));var x=_.lastIndexOf("/");return 0<x?_.substring(0,x):""},b=function(_){return _.slice(-1)!=="/"&&(_+="/"),_},C=function(_,x){return x=x!==void 0?x:m.createFolders,_=b(_),this.files[_]||n.call(this,_,null,{dir:!0,createFolders:x}),this.files[_]};function S(_){return Object.prototype.toString.call(_)==="[object RegExp]"}var k={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(_){var x,L,N;for(x in this.files)N=this.files[x],(L=x.slice(this.root.length,x.length))&&x.slice(0,this.root.length)===this.root&&_(L,N)},filter:function(_){var x=[];return this.forEach(function(L,N){_(L,N)&&x.push(N)}),x},file:function(_,x,L){if(arguments.length!==1)return _=this.root+_,n.call(this,_,x,L),this;if(S(_)){var N=_;return this.filter(function(j,ee){return!ee.dir&&N.test(j)})}var R=this.files[this.root+_];return R&&!R.dir?R:null},folder:function(_){if(!_)return this;if(S(_))return this.filter(function(R,j){return j.dir&&_.test(R)});var x=this.root+_,L=C.call(this,x),N=this.clone();return N.root=L.name,N},remove:function(_){_=this.root+_;var x=this.files[_];if(x||(_.slice(-1)!=="/"&&(_+="/"),x=this.files[_]),x&&!x.dir)delete this.files[_];else for(var L=this.filter(function(R,j){return j.name.slice(0,_.length)===_}),N=0;N<L.length;N++)delete this.files[L[N].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(_){var x,L={};try{if((L=a.extend(_||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:i.utf8encode})).type=L.type.toLowerCase(),L.compression=L.compression.toUpperCase(),L.type==="binarystring"&&(L.type="string"),!L.type)throw new Error("No output type specified.");a.checkSupport(L.type),L.platform!=="darwin"&&L.platform!=="freebsd"&&L.platform!=="linux"&&L.platform!=="sunos"||(L.platform="UNIX"),L.platform==="win32"&&(L.platform="DOS");var N=L.comment||this.comment||"";x=h.generateWorker(this,L,N)}catch(R){(x=new o("error")).error(R)}return new l(x,L.type||"string",L.mimeType)},generateAsync:function(_,x){return this.generateInternalStream(_).accumulate(x)},generateNodeStream:function(_,x){return(_=_||{}).type||(_.type="nodebuffer"),this.generateInternalStream(_).toNodejsStream(x)}};c.exports=k},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,c,s){c.exports=e("stream")},{stream:void 0}],17:[function(e,c,s){var n=e("./DataReader");function i(a){n.call(this,a);for(var o=0;o<this.data.length;o++)a[o]=255&a[o]}e("../utils").inherits(i,n),i.prototype.byteAt=function(a){return this.data[this.zero+a]},i.prototype.lastIndexOfSignature=function(a){for(var o=a.charCodeAt(0),l=a.charCodeAt(1),m=a.charCodeAt(2),p=a.charCodeAt(3),u=this.length-4;0<=u;--u)if(this.data[u]===o&&this.data[u+1]===l&&this.data[u+2]===m&&this.data[u+3]===p)return u-this.zero;return-1},i.prototype.readAndCheckSignature=function(a){var o=a.charCodeAt(0),l=a.charCodeAt(1),m=a.charCodeAt(2),p=a.charCodeAt(3),u=this.readData(4);return o===u[0]&&l===u[1]&&m===u[2]&&p===u[3]},i.prototype.readData=function(a){if(this.checkOffset(a),a===0)return[];var o=this.data.slice(this.zero+this.index,this.zero+this.index+a);return this.index+=a,o},c.exports=i},{"../utils":32,"./DataReader":18}],18:[function(e,c,s){var n=e("../utils");function i(a){this.data=a,this.length=a.length,this.index=0,this.zero=0}i.prototype={checkOffset:function(a){this.checkIndex(this.index+a)},checkIndex:function(a){if(this.length<this.zero+a||a<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+a+"). Corrupted zip ?")},setIndex:function(a){this.checkIndex(a),this.index=a},skip:function(a){this.setIndex(this.index+a)},byteAt:function(){},readInt:function(a){var o,l=0;for(this.checkOffset(a),o=this.index+a-1;o>=this.index;o--)l=(l<<8)+this.byteAt(o);return this.index+=a,l},readString:function(a){return n.transformTo("string",this.readData(a))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var a=this.readInt(4);return new Date(Date.UTC(1980+(a>>25&127),(a>>21&15)-1,a>>16&31,a>>11&31,a>>5&63,(31&a)<<1))}},c.exports=i},{"../utils":32}],19:[function(e,c,s){var n=e("./Uint8ArrayReader");function i(a){n.call(this,a)}e("../utils").inherits(i,n),i.prototype.readData=function(a){this.checkOffset(a);var o=this.data.slice(this.zero+this.index,this.zero+this.index+a);return this.index+=a,o},c.exports=i},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,c,s){var n=e("./DataReader");function i(a){n.call(this,a)}e("../utils").inherits(i,n),i.prototype.byteAt=function(a){return this.data.charCodeAt(this.zero+a)},i.prototype.lastIndexOfSignature=function(a){return this.data.lastIndexOf(a)-this.zero},i.prototype.readAndCheckSignature=function(a){return a===this.readData(4)},i.prototype.readData=function(a){this.checkOffset(a);var o=this.data.slice(this.zero+this.index,this.zero+this.index+a);return this.index+=a,o},c.exports=i},{"../utils":32,"./DataReader":18}],21:[function(e,c,s){var n=e("./ArrayReader");function i(a){n.call(this,a)}e("../utils").inherits(i,n),i.prototype.readData=function(a){if(this.checkOffset(a),a===0)return new Uint8Array(0);var o=this.data.subarray(this.zero+this.index,this.zero+this.index+a);return this.index+=a,o},c.exports=i},{"../utils":32,"./ArrayReader":17}],22:[function(e,c,s){var n=e("../utils"),i=e("../support"),a=e("./ArrayReader"),o=e("./StringReader"),l=e("./NodeBufferReader"),m=e("./Uint8ArrayReader");c.exports=function(p){var u=n.getTypeOf(p);return n.checkSupport(u),u!=="string"||i.uint8array?u==="nodebuffer"?new l(p):i.uint8array?new m(n.transformTo("uint8array",p)):new a(n.transformTo("array",p)):new o(p)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,c,s){s.LOCAL_FILE_HEADER="PK",s.CENTRAL_FILE_HEADER="PK",s.CENTRAL_DIRECTORY_END="PK",s.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",s.ZIP64_CENTRAL_DIRECTORY_END="PK",s.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(e,c,s){var n=e("./GenericWorker"),i=e("../utils");function a(o){n.call(this,"ConvertWorker to "+o),this.destType=o}i.inherits(a,n),a.prototype.processChunk=function(o){this.push({data:i.transformTo(this.destType,o.data),meta:o.meta})},c.exports=a},{"../utils":32,"./GenericWorker":28}],25:[function(e,c,s){var n=e("./GenericWorker"),i=e("../crc32");function a(){n.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}e("../utils").inherits(a,n),a.prototype.processChunk=function(o){this.streamInfo.crc32=i(o.data,this.streamInfo.crc32||0),this.push(o)},c.exports=a},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,c,s){var n=e("../utils"),i=e("./GenericWorker");function a(o){i.call(this,"DataLengthProbe for "+o),this.propName=o,this.withStreamInfo(o,0)}n.inherits(a,i),a.prototype.processChunk=function(o){if(o){var l=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=l+o.data.length}i.prototype.processChunk.call(this,o)},c.exports=a},{"../utils":32,"./GenericWorker":28}],27:[function(e,c,s){var n=e("../utils"),i=e("./GenericWorker");function a(o){i.call(this,"DataWorker");var l=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,o.then(function(m){l.dataIsReady=!0,l.data=m,l.max=m&&m.length||0,l.type=n.getTypeOf(m),l.isPaused||l._tickAndRepeat()},function(m){l.error(m)})}n.inherits(a,i),a.prototype.cleanUp=function(){i.prototype.cleanUp.call(this),this.data=null},a.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,n.delay(this._tickAndRepeat,[],this)),!0)},a.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(n.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},a.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var o=null,l=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":o=this.data.substring(this.index,l);break;case"uint8array":o=this.data.subarray(this.index,l);break;case"array":case"nodebuffer":o=this.data.slice(this.index,l)}return this.index=l,this.push({data:o,meta:{percent:this.max?this.index/this.max*100:0}})},c.exports=a},{"../utils":32,"./GenericWorker":28}],28:[function(e,c,s){function n(i){this.name=i||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}n.prototype={push:function(i){this.emit("data",i)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(i){this.emit("error",i)}return!0},error:function(i){return!this.isFinished&&(this.isPaused?this.generatedError=i:(this.isFinished=!0,this.emit("error",i),this.previous&&this.previous.error(i),this.cleanUp()),!0)},on:function(i,a){return this._listeners[i].push(a),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(i,a){if(this._listeners[i])for(var o=0;o<this._listeners[i].length;o++)this._listeners[i][o].call(this,a)},pipe:function(i){return i.registerPrevious(this)},registerPrevious:function(i){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=i.streamInfo,this.mergeStreamInfo(),this.previous=i;var a=this;return i.on("data",function(o){a.processChunk(o)}),i.on("end",function(){a.end()}),i.on("error",function(o){a.error(o)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var i=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),i=!0),this.previous&&this.previous.resume(),!i},flush:function(){},processChunk:function(i){this.push(i)},withStreamInfo:function(i,a){return this.extraStreamInfo[i]=a,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var i in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,i)&&(this.streamInfo[i]=this.extraStreamInfo[i])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var i="Worker "+this.name;return this.previous?this.previous+" -> "+i:i}},c.exports=n},{}],29:[function(e,c,s){var n=e("../utils"),i=e("./ConvertWorker"),a=e("./GenericWorker"),o=e("../base64"),l=e("../support"),m=e("../external"),p=null;if(l.nodestream)try{p=e("../nodejs/NodejsStreamOutputAdapter")}catch{}function u(y,f){return new m.Promise(function(v,b){var C=[],S=y._internalType,k=y._outputType,_=y._mimeType;y.on("data",function(x,L){C.push(x),f&&f(L)}).on("error",function(x){C=[],b(x)}).on("end",function(){try{var x=function(L,N,R){switch(L){case"blob":return n.newBlob(n.transformTo("arraybuffer",N),R);case"base64":return o.encode(N);default:return n.transformTo(L,N)}}(k,function(L,N){var R,j=0,ee=null,I=0;for(R=0;R<N.length;R++)I+=N[R].length;switch(L){case"string":return N.join("");case"array":return Array.prototype.concat.apply([],N);case"uint8array":for(ee=new Uint8Array(I),R=0;R<N.length;R++)ee.set(N[R],j),j+=N[R].length;return ee;case"nodebuffer":return Buffer.concat(N);default:throw new Error("concat : unsupported type '"+L+"'")}}(S,C),_);v(x)}catch(L){b(L)}C=[]}).resume()})}function h(y,f,v){var b=f;switch(f){case"blob":case"arraybuffer":b="uint8array";break;case"base64":b="string"}try{this._internalType=b,this._outputType=f,this._mimeType=v,n.checkSupport(b),this._worker=y.pipe(new i(b)),y.lock()}catch(C){this._worker=new a("error"),this._worker.error(C)}}h.prototype={accumulate:function(y){return u(this,y)},on:function(y,f){var v=this;return y==="data"?this._worker.on(y,function(b){f.call(v,b.data,b.meta)}):this._worker.on(y,function(){n.delay(f,arguments,v)}),this},resume:function(){return n.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(y){if(n.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new p(this,{objectMode:this._outputType!=="nodebuffer"},y)}},c.exports=h},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,c,s){if(s.base64=!0,s.array=!0,s.string=!0,s.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",s.nodebuffer=typeof Buffer<"u",s.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")s.blob=!1;else{var n=new ArrayBuffer(0);try{s.blob=new Blob([n],{type:"application/zip"}).size===0}catch{try{var i=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);i.append(n),s.blob=i.getBlob("application/zip").size===0}catch{s.blob=!1}}}try{s.nodestream=!!e("readable-stream").Readable}catch{s.nodestream=!1}},{"readable-stream":16}],31:[function(e,c,s){for(var n=e("./utils"),i=e("./support"),a=e("./nodejsUtils"),o=e("./stream/GenericWorker"),l=new Array(256),m=0;m<256;m++)l[m]=252<=m?6:248<=m?5:240<=m?4:224<=m?3:192<=m?2:1;l[254]=l[254]=1;function p(){o.call(this,"utf-8 decode"),this.leftOver=null}function u(){o.call(this,"utf-8 encode")}s.utf8encode=function(h){return i.nodebuffer?a.newBufferFrom(h,"utf-8"):function(y){var f,v,b,C,S,k=y.length,_=0;for(C=0;C<k;C++)(64512&(v=y.charCodeAt(C)))==55296&&C+1<k&&(64512&(b=y.charCodeAt(C+1)))==56320&&(v=65536+(v-55296<<10)+(b-56320),C++),_+=v<128?1:v<2048?2:v<65536?3:4;for(f=i.uint8array?new Uint8Array(_):new Array(_),C=S=0;S<_;C++)(64512&(v=y.charCodeAt(C)))==55296&&C+1<k&&(64512&(b=y.charCodeAt(C+1)))==56320&&(v=65536+(v-55296<<10)+(b-56320),C++),v<128?f[S++]=v:(v<2048?f[S++]=192|v>>>6:(v<65536?f[S++]=224|v>>>12:(f[S++]=240|v>>>18,f[S++]=128|v>>>12&63),f[S++]=128|v>>>6&63),f[S++]=128|63&v);return f}(h)},s.utf8decode=function(h){return i.nodebuffer?n.transformTo("nodebuffer",h).toString("utf-8"):function(y){var f,v,b,C,S=y.length,k=new Array(2*S);for(f=v=0;f<S;)if((b=y[f++])<128)k[v++]=b;else if(4<(C=l[b]))k[v++]=65533,f+=C-1;else{for(b&=C===2?31:C===3?15:7;1<C&&f<S;)b=b<<6|63&y[f++],C--;1<C?k[v++]=65533:b<65536?k[v++]=b:(b-=65536,k[v++]=55296|b>>10&1023,k[v++]=56320|1023&b)}return k.length!==v&&(k.subarray?k=k.subarray(0,v):k.length=v),n.applyFromCharCode(k)}(h=n.transformTo(i.uint8array?"uint8array":"array",h))},n.inherits(p,o),p.prototype.processChunk=function(h){var y=n.transformTo(i.uint8array?"uint8array":"array",h.data);if(this.leftOver&&this.leftOver.length){if(i.uint8array){var f=y;(y=new Uint8Array(f.length+this.leftOver.length)).set(this.leftOver,0),y.set(f,this.leftOver.length)}else y=this.leftOver.concat(y);this.leftOver=null}var v=function(C,S){var k;for((S=S||C.length)>C.length&&(S=C.length),k=S-1;0<=k&&(192&C[k])==128;)k--;return k<0||k===0?S:k+l[C[k]]>S?k:S}(y),b=y;v!==y.length&&(i.uint8array?(b=y.subarray(0,v),this.leftOver=y.subarray(v,y.length)):(b=y.slice(0,v),this.leftOver=y.slice(v,y.length))),this.push({data:s.utf8decode(b),meta:h.meta})},p.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:s.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},s.Utf8DecodeWorker=p,n.inherits(u,o),u.prototype.processChunk=function(h){this.push({data:s.utf8encode(h.data),meta:h.meta})},s.Utf8EncodeWorker=u},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,c,s){var n=e("./support"),i=e("./base64"),a=e("./nodejsUtils"),o=e("./external");function l(f){return f}function m(f,v){for(var b=0;b<f.length;++b)v[b]=255&f.charCodeAt(b);return v}e("setimmediate"),s.newBlob=function(f,v){s.checkSupport("blob");try{return new Blob([f],{type:v})}catch{try{var b=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return b.append(f),b.getBlob(v)}catch{throw new Error("Bug : can't construct the Blob.")}}};var p={stringifyByChunk:function(f,v,b){var C=[],S=0,k=f.length;if(k<=b)return String.fromCharCode.apply(null,f);for(;S<k;)v==="array"||v==="nodebuffer"?C.push(String.fromCharCode.apply(null,f.slice(S,Math.min(S+b,k)))):C.push(String.fromCharCode.apply(null,f.subarray(S,Math.min(S+b,k)))),S+=b;return C.join("")},stringifyByChar:function(f){for(var v="",b=0;b<f.length;b++)v+=String.fromCharCode(f[b]);return v},applyCanBeUsed:{uint8array:function(){try{return n.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}}(),nodebuffer:function(){try{return n.nodebuffer&&String.fromCharCode.apply(null,a.allocBuffer(1)).length===1}catch{return!1}}()}};function u(f){var v=65536,b=s.getTypeOf(f),C=!0;if(b==="uint8array"?C=p.applyCanBeUsed.uint8array:b==="nodebuffer"&&(C=p.applyCanBeUsed.nodebuffer),C)for(;1<v;)try{return p.stringifyByChunk(f,b,v)}catch{v=Math.floor(v/2)}return p.stringifyByChar(f)}function h(f,v){for(var b=0;b<f.length;b++)v[b]=f[b];return v}s.applyFromCharCode=u;var y={};y.string={string:l,array:function(f){return m(f,new Array(f.length))},arraybuffer:function(f){return y.string.uint8array(f).buffer},uint8array:function(f){return m(f,new Uint8Array(f.length))},nodebuffer:function(f){return m(f,a.allocBuffer(f.length))}},y.array={string:u,array:l,arraybuffer:function(f){return new Uint8Array(f).buffer},uint8array:function(f){return new Uint8Array(f)},nodebuffer:function(f){return a.newBufferFrom(f)}},y.arraybuffer={string:function(f){return u(new Uint8Array(f))},array:function(f){return h(new Uint8Array(f),new Array(f.byteLength))},arraybuffer:l,uint8array:function(f){return new Uint8Array(f)},nodebuffer:function(f){return a.newBufferFrom(new Uint8Array(f))}},y.uint8array={string:u,array:function(f){return h(f,new Array(f.length))},arraybuffer:function(f){return f.buffer},uint8array:l,nodebuffer:function(f){return a.newBufferFrom(f)}},y.nodebuffer={string:u,array:function(f){return h(f,new Array(f.length))},arraybuffer:function(f){return y.nodebuffer.uint8array(f).buffer},uint8array:function(f){return h(f,new Uint8Array(f.length))},nodebuffer:l},s.transformTo=function(f,v){if(v=v||"",!f)return v;s.checkSupport(f);var b=s.getTypeOf(v);return y[b][f](v)},s.resolve=function(f){for(var v=f.split("/"),b=[],C=0;C<v.length;C++){var S=v[C];S==="."||S===""&&C!==0&&C!==v.length-1||(S===".."?b.pop():b.push(S))}return b.join("/")},s.getTypeOf=function(f){return typeof f=="string"?"string":Object.prototype.toString.call(f)==="[object Array]"?"array":n.nodebuffer&&a.isBuffer(f)?"nodebuffer":n.uint8array&&f instanceof Uint8Array?"uint8array":n.arraybuffer&&f instanceof ArrayBuffer?"arraybuffer":void 0},s.checkSupport=function(f){if(!n[f.toLowerCase()])throw new Error(f+" is not supported by this platform")},s.MAX_VALUE_16BITS=65535,s.MAX_VALUE_32BITS=-1,s.pretty=function(f){var v,b,C="";for(b=0;b<(f||"").length;b++)C+="\\x"+((v=f.charCodeAt(b))<16?"0":"")+v.toString(16).toUpperCase();return C},s.delay=function(f,v,b){setImmediate(function(){f.apply(b||null,v||[])})},s.inherits=function(f,v){function b(){}b.prototype=v.prototype,f.prototype=new b},s.extend=function(){var f,v,b={};for(f=0;f<arguments.length;f++)for(v in arguments[f])Object.prototype.hasOwnProperty.call(arguments[f],v)&&b[v]===void 0&&(b[v]=arguments[f][v]);return b},s.prepareContent=function(f,v,b,C,S){return o.Promise.resolve(v).then(function(k){return n.blob&&(k instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(k))!==-1)&&typeof FileReader<"u"?new o.Promise(function(_,x){var L=new FileReader;L.onload=function(N){_(N.target.result)},L.onerror=function(N){x(N.target.error)},L.readAsArrayBuffer(k)}):k}).then(function(k){var _=s.getTypeOf(k);return _?(_==="arraybuffer"?k=s.transformTo("uint8array",k):_==="string"&&(S?k=i.decode(k):b&&C!==!0&&(k=function(x){return m(x,n.uint8array?new Uint8Array(x.length):new Array(x.length))}(k))),k):o.Promise.reject(new Error("Can't read the data of '"+f+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(e,c,s){var n=e("./reader/readerFor"),i=e("./utils"),a=e("./signature"),o=e("./zipEntry"),l=e("./support");function m(p){this.files=[],this.loadOptions=p}m.prototype={checkSignature:function(p){if(!this.reader.readAndCheckSignature(p)){this.reader.index-=4;var u=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+i.pretty(u)+", expected "+i.pretty(p)+")")}},isSignature:function(p,u){var h=this.reader.index;this.reader.setIndex(p);var y=this.reader.readString(4)===u;return this.reader.setIndex(h),y},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var p=this.reader.readData(this.zipCommentLength),u=l.uint8array?"uint8array":"array",h=i.transformTo(u,p);this.zipComment=this.loadOptions.decodeFileName(h)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var p,u,h,y=this.zip64EndOfCentralSize-44;0<y;)p=this.reader.readInt(2),u=this.reader.readInt(4),h=this.reader.readData(u),this.zip64ExtensibleData[p]={id:p,length:u,value:h}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var p,u;for(p=0;p<this.files.length;p++)u=this.files[p],this.reader.setIndex(u.localHeaderOffset),this.checkSignature(a.LOCAL_FILE_HEADER),u.readLocalPart(this.reader),u.handleUTF8(),u.processAttributes()},readCentralDir:function(){var p;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(a.CENTRAL_FILE_HEADER);)(p=new o({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(p);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var p=this.reader.lastIndexOfSignature(a.CENTRAL_DIRECTORY_END);if(p<0)throw this.isSignature(0,a.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(p);var u=p;if(this.checkSignature(a.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===i.MAX_VALUE_16BITS||this.diskWithCentralDirStart===i.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===i.MAX_VALUE_16BITS||this.centralDirRecords===i.MAX_VALUE_16BITS||this.centralDirSize===i.MAX_VALUE_32BITS||this.centralDirOffset===i.MAX_VALUE_32BITS){if(this.zip64=!0,(p=this.reader.lastIndexOfSignature(a.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(p),this.checkSignature(a.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,a.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(a.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(a.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var h=this.centralDirOffset+this.centralDirSize;this.zip64&&(h+=20,h+=12+this.zip64EndOfCentralSize);var y=u-h;if(0<y)this.isSignature(u,a.CENTRAL_FILE_HEADER)||(this.reader.zero=y);else if(y<0)throw new Error("Corrupted zip: missing "+Math.abs(y)+" bytes.")},prepareReader:function(p){this.reader=n(p)},load:function(p){this.prepareReader(p),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},c.exports=m},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(e,c,s){var n=e("./reader/readerFor"),i=e("./utils"),a=e("./compressedObject"),o=e("./crc32"),l=e("./utf8"),m=e("./compressions"),p=e("./support");function u(h,y){this.options=h,this.loadOptions=y}u.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(h){var y,f;if(h.skip(22),this.fileNameLength=h.readInt(2),f=h.readInt(2),this.fileName=h.readData(this.fileNameLength),h.skip(f),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((y=function(v){for(var b in m)if(Object.prototype.hasOwnProperty.call(m,b)&&m[b].magic===v)return m[b];return null}(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+i.pretty(this.compressionMethod)+" unknown (inner file : "+i.transformTo("string",this.fileName)+")");this.decompressed=new a(this.compressedSize,this.uncompressedSize,this.crc32,y,h.readData(this.compressedSize))},readCentralPart:function(h){this.versionMadeBy=h.readInt(2),h.skip(2),this.bitFlag=h.readInt(2),this.compressionMethod=h.readString(2),this.date=h.readDate(),this.crc32=h.readInt(4),this.compressedSize=h.readInt(4),this.uncompressedSize=h.readInt(4);var y=h.readInt(2);if(this.extraFieldsLength=h.readInt(2),this.fileCommentLength=h.readInt(2),this.diskNumberStart=h.readInt(2),this.internalFileAttributes=h.readInt(2),this.externalFileAttributes=h.readInt(4),this.localHeaderOffset=h.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");h.skip(y),this.readExtraFields(h),this.parseZIP64ExtraField(h),this.fileComment=h.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var h=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),h==0&&(this.dosPermissions=63&this.externalFileAttributes),h==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var h=n(this.extraFields[1].value);this.uncompressedSize===i.MAX_VALUE_32BITS&&(this.uncompressedSize=h.readInt(8)),this.compressedSize===i.MAX_VALUE_32BITS&&(this.compressedSize=h.readInt(8)),this.localHeaderOffset===i.MAX_VALUE_32BITS&&(this.localHeaderOffset=h.readInt(8)),this.diskNumberStart===i.MAX_VALUE_32BITS&&(this.diskNumberStart=h.readInt(4))}},readExtraFields:function(h){var y,f,v,b=h.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});h.index+4<b;)y=h.readInt(2),f=h.readInt(2),v=h.readData(f),this.extraFields[y]={id:y,length:f,value:v};h.setIndex(b)},handleUTF8:function(){var h=p.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=l.utf8decode(this.fileName),this.fileCommentStr=l.utf8decode(this.fileComment);else{var y=this.findExtraFieldUnicodePath();if(y!==null)this.fileNameStr=y;else{var f=i.transformTo(h,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(f)}var v=this.findExtraFieldUnicodeComment();if(v!==null)this.fileCommentStr=v;else{var b=i.transformTo(h,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(b)}}},findExtraFieldUnicodePath:function(){var h=this.extraFields[28789];if(h){var y=n(h.value);return y.readInt(1)!==1||o(this.fileName)!==y.readInt(4)?null:l.utf8decode(y.readData(h.length-5))}return null},findExtraFieldUnicodeComment:function(){var h=this.extraFields[25461];if(h){var y=n(h.value);return y.readInt(1)!==1||o(this.fileComment)!==y.readInt(4)?null:l.utf8decode(y.readData(h.length-5))}return null}},c.exports=u},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(e,c,s){function n(y,f,v){this.name=y,this.dir=v.dir,this.date=v.date,this.comment=v.comment,this.unixPermissions=v.unixPermissions,this.dosPermissions=v.dosPermissions,this._data=f,this._dataBinary=v.binary,this.options={compression:v.compression,compressionOptions:v.compressionOptions}}var i=e("./stream/StreamHelper"),a=e("./stream/DataWorker"),o=e("./utf8"),l=e("./compressedObject"),m=e("./stream/GenericWorker");n.prototype={internalStream:function(y){var f=null,v="string";try{if(!y)throw new Error("No output type specified.");var b=(v=y.toLowerCase())==="string"||v==="text";v!=="binarystring"&&v!=="text"||(v="string"),f=this._decompressWorker();var C=!this._dataBinary;C&&!b&&(f=f.pipe(new o.Utf8EncodeWorker)),!C&&b&&(f=f.pipe(new o.Utf8DecodeWorker))}catch(S){(f=new m("error")).error(S)}return new i(f,v,"")},async:function(y,f){return this.internalStream(y).accumulate(f)},nodeStream:function(y,f){return this.internalStream(y||"nodebuffer").toNodejsStream(f)},_compressWorker:function(y,f){if(this._data instanceof l&&this._data.compression.magic===y.magic)return this._data.getCompressedWorker();var v=this._decompressWorker();return this._dataBinary||(v=v.pipe(new o.Utf8EncodeWorker)),l.createWorkerFrom(v,y,f)},_decompressWorker:function(){return this._data instanceof l?this._data.getContentWorker():this._data instanceof m?this._data:new a(this._data)}};for(var p=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],u=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},h=0;h<p.length;h++)n.prototype[p[h]]=u;c.exports=n},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(e,c,s){(function(n){var i,a,o=n.MutationObserver||n.WebKitMutationObserver;if(o){var l=0,m=new o(y),p=n.document.createTextNode("");m.observe(p,{characterData:!0}),i=function(){p.data=l=++l%2}}else if(n.setImmediate||n.MessageChannel===void 0)i="document"in n&&"onreadystatechange"in n.document.createElement("script")?function(){var f=n.document.createElement("script");f.onreadystatechange=function(){y(),f.onreadystatechange=null,f.parentNode.removeChild(f),f=null},n.document.documentElement.appendChild(f)}:function(){setTimeout(y,0)};else{var u=new n.MessageChannel;u.port1.onmessage=y,i=function(){u.port2.postMessage(0)}}var h=[];function y(){var f,v;a=!0;for(var b=h.length;b;){for(v=h,h=[],f=-1;++f<b;)v[f]();b=h.length}a=!1}c.exports=function(f){h.push(f)!==1||a||i()}}).call(this,typeof xn<"u"?xn:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(e,c,s){var n=e("immediate");function i(){}var a={},o=["REJECTED"],l=["FULFILLED"],m=["PENDING"];function p(b){if(typeof b!="function")throw new TypeError("resolver must be a function");this.state=m,this.queue=[],this.outcome=void 0,b!==i&&f(this,b)}function u(b,C,S){this.promise=b,typeof C=="function"&&(this.onFulfilled=C,this.callFulfilled=this.otherCallFulfilled),typeof S=="function"&&(this.onRejected=S,this.callRejected=this.otherCallRejected)}function h(b,C,S){n(function(){var k;try{k=C(S)}catch(_){return a.reject(b,_)}k===b?a.reject(b,new TypeError("Cannot resolve promise with itself")):a.resolve(b,k)})}function y(b){var C=b&&b.then;if(b&&(typeof b=="object"||typeof b=="function")&&typeof C=="function")return function(){C.apply(b,arguments)}}function f(b,C){var S=!1;function k(L){S||(S=!0,a.reject(b,L))}function _(L){S||(S=!0,a.resolve(b,L))}var x=v(function(){C(_,k)});x.status==="error"&&k(x.value)}function v(b,C){var S={};try{S.value=b(C),S.status="success"}catch(k){S.status="error",S.value=k}return S}(c.exports=p).prototype.finally=function(b){if(typeof b!="function")return this;var C=this.constructor;return this.then(function(S){return C.resolve(b()).then(function(){return S})},function(S){return C.resolve(b()).then(function(){throw S})})},p.prototype.catch=function(b){return this.then(null,b)},p.prototype.then=function(b,C){if(typeof b!="function"&&this.state===l||typeof C!="function"&&this.state===o)return this;var S=new this.constructor(i);return this.state!==m?h(S,this.state===l?b:C,this.outcome):this.queue.push(new u(S,b,C)),S},u.prototype.callFulfilled=function(b){a.resolve(this.promise,b)},u.prototype.otherCallFulfilled=function(b){h(this.promise,this.onFulfilled,b)},u.prototype.callRejected=function(b){a.reject(this.promise,b)},u.prototype.otherCallRejected=function(b){h(this.promise,this.onRejected,b)},a.resolve=function(b,C){var S=v(y,C);if(S.status==="error")return a.reject(b,S.value);var k=S.value;if(k)f(b,k);else{b.state=l,b.outcome=C;for(var _=-1,x=b.queue.length;++_<x;)b.queue[_].callFulfilled(C)}return b},a.reject=function(b,C){b.state=o,b.outcome=C;for(var S=-1,k=b.queue.length;++S<k;)b.queue[S].callRejected(C);return b},p.resolve=function(b){return b instanceof this?b:a.resolve(new this(i),b)},p.reject=function(b){var C=new this(i);return a.reject(C,b)},p.all=function(b){var C=this;if(Object.prototype.toString.call(b)!=="[object Array]")return this.reject(new TypeError("must be an array"));var S=b.length,k=!1;if(!S)return this.resolve([]);for(var _=new Array(S),x=0,L=-1,N=new this(i);++L<S;)R(b[L],L);return N;function R(j,ee){C.resolve(j).then(function(I){_[ee]=I,++x!==S||k||(k=!0,a.resolve(N,_))},function(I){k||(k=!0,a.reject(N,I))})}},p.race=function(b){var C=this;if(Object.prototype.toString.call(b)!=="[object Array]")return this.reject(new TypeError("must be an array"));var S=b.length,k=!1;if(!S)return this.resolve([]);for(var _=-1,x=new this(i);++_<S;)L=b[_],C.resolve(L).then(function(N){k||(k=!0,a.resolve(x,N))},function(N){k||(k=!0,a.reject(x,N))});var L;return x}},{immediate:36}],38:[function(e,c,s){var n={};(0,e("./lib/utils/common").assign)(n,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),c.exports=n},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(e,c,s){var n=e("./zlib/deflate"),i=e("./utils/common"),a=e("./utils/strings"),o=e("./zlib/messages"),l=e("./zlib/zstream"),m=Object.prototype.toString,p=0,u=-1,h=0,y=8;function f(b){if(!(this instanceof f))return new f(b);this.options=i.assign({level:u,method:y,chunkSize:16384,windowBits:15,memLevel:8,strategy:h,to:""},b||{});var C=this.options;C.raw&&0<C.windowBits?C.windowBits=-C.windowBits:C.gzip&&0<C.windowBits&&C.windowBits<16&&(C.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new l,this.strm.avail_out=0;var S=n.deflateInit2(this.strm,C.level,C.method,C.windowBits,C.memLevel,C.strategy);if(S!==p)throw new Error(o[S]);if(C.header&&n.deflateSetHeader(this.strm,C.header),C.dictionary){var k;if(k=typeof C.dictionary=="string"?a.string2buf(C.dictionary):m.call(C.dictionary)==="[object ArrayBuffer]"?new Uint8Array(C.dictionary):C.dictionary,(S=n.deflateSetDictionary(this.strm,k))!==p)throw new Error(o[S]);this._dict_set=!0}}function v(b,C){var S=new f(C);if(S.push(b,!0),S.err)throw S.msg||o[S.err];return S.result}f.prototype.push=function(b,C){var S,k,_=this.strm,x=this.options.chunkSize;if(this.ended)return!1;k=C===~~C?C:C===!0?4:0,typeof b=="string"?_.input=a.string2buf(b):m.call(b)==="[object ArrayBuffer]"?_.input=new Uint8Array(b):_.input=b,_.next_in=0,_.avail_in=_.input.length;do{if(_.avail_out===0&&(_.output=new i.Buf8(x),_.next_out=0,_.avail_out=x),(S=n.deflate(_,k))!==1&&S!==p)return this.onEnd(S),!(this.ended=!0);_.avail_out!==0&&(_.avail_in!==0||k!==4&&k!==2)||(this.options.to==="string"?this.onData(a.buf2binstring(i.shrinkBuf(_.output,_.next_out))):this.onData(i.shrinkBuf(_.output,_.next_out)))}while((0<_.avail_in||_.avail_out===0)&&S!==1);return k===4?(S=n.deflateEnd(this.strm),this.onEnd(S),this.ended=!0,S===p):k!==2||(this.onEnd(p),!(_.avail_out=0))},f.prototype.onData=function(b){this.chunks.push(b)},f.prototype.onEnd=function(b){b===p&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=i.flattenChunks(this.chunks)),this.chunks=[],this.err=b,this.msg=this.strm.msg},s.Deflate=f,s.deflate=v,s.deflateRaw=function(b,C){return(C=C||{}).raw=!0,v(b,C)},s.gzip=function(b,C){return(C=C||{}).gzip=!0,v(b,C)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(e,c,s){var n=e("./zlib/inflate"),i=e("./utils/common"),a=e("./utils/strings"),o=e("./zlib/constants"),l=e("./zlib/messages"),m=e("./zlib/zstream"),p=e("./zlib/gzheader"),u=Object.prototype.toString;function h(f){if(!(this instanceof h))return new h(f);this.options=i.assign({chunkSize:16384,windowBits:0,to:""},f||{});var v=this.options;v.raw&&0<=v.windowBits&&v.windowBits<16&&(v.windowBits=-v.windowBits,v.windowBits===0&&(v.windowBits=-15)),!(0<=v.windowBits&&v.windowBits<16)||f&&f.windowBits||(v.windowBits+=32),15<v.windowBits&&v.windowBits<48&&!(15&v.windowBits)&&(v.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new m,this.strm.avail_out=0;var b=n.inflateInit2(this.strm,v.windowBits);if(b!==o.Z_OK)throw new Error(l[b]);this.header=new p,n.inflateGetHeader(this.strm,this.header)}function y(f,v){var b=new h(v);if(b.push(f,!0),b.err)throw b.msg||l[b.err];return b.result}h.prototype.push=function(f,v){var b,C,S,k,_,x,L=this.strm,N=this.options.chunkSize,R=this.options.dictionary,j=!1;if(this.ended)return!1;C=v===~~v?v:v===!0?o.Z_FINISH:o.Z_NO_FLUSH,typeof f=="string"?L.input=a.binstring2buf(f):u.call(f)==="[object ArrayBuffer]"?L.input=new Uint8Array(f):L.input=f,L.next_in=0,L.avail_in=L.input.length;do{if(L.avail_out===0&&(L.output=new i.Buf8(N),L.next_out=0,L.avail_out=N),(b=n.inflate(L,o.Z_NO_FLUSH))===o.Z_NEED_DICT&&R&&(x=typeof R=="string"?a.string2buf(R):u.call(R)==="[object ArrayBuffer]"?new Uint8Array(R):R,b=n.inflateSetDictionary(this.strm,x)),b===o.Z_BUF_ERROR&&j===!0&&(b=o.Z_OK,j=!1),b!==o.Z_STREAM_END&&b!==o.Z_OK)return this.onEnd(b),!(this.ended=!0);L.next_out&&(L.avail_out!==0&&b!==o.Z_STREAM_END&&(L.avail_in!==0||C!==o.Z_FINISH&&C!==o.Z_SYNC_FLUSH)||(this.options.to==="string"?(S=a.utf8border(L.output,L.next_out),k=L.next_out-S,_=a.buf2string(L.output,S),L.next_out=k,L.avail_out=N-k,k&&i.arraySet(L.output,L.output,S,k,0),this.onData(_)):this.onData(i.shrinkBuf(L.output,L.next_out)))),L.avail_in===0&&L.avail_out===0&&(j=!0)}while((0<L.avail_in||L.avail_out===0)&&b!==o.Z_STREAM_END);return b===o.Z_STREAM_END&&(C=o.Z_FINISH),C===o.Z_FINISH?(b=n.inflateEnd(this.strm),this.onEnd(b),this.ended=!0,b===o.Z_OK):C!==o.Z_SYNC_FLUSH||(this.onEnd(o.Z_OK),!(L.avail_out=0))},h.prototype.onData=function(f){this.chunks.push(f)},h.prototype.onEnd=function(f){f===o.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=i.flattenChunks(this.chunks)),this.chunks=[],this.err=f,this.msg=this.strm.msg},s.Inflate=h,s.inflate=y,s.inflateRaw=function(f,v){return(v=v||{}).raw=!0,y(f,v)},s.ungzip=y},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(e,c,s){var n=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";s.assign=function(o){for(var l=Array.prototype.slice.call(arguments,1);l.length;){var m=l.shift();if(m){if(typeof m!="object")throw new TypeError(m+"must be non-object");for(var p in m)m.hasOwnProperty(p)&&(o[p]=m[p])}}return o},s.shrinkBuf=function(o,l){return o.length===l?o:o.subarray?o.subarray(0,l):(o.length=l,o)};var i={arraySet:function(o,l,m,p,u){if(l.subarray&&o.subarray)o.set(l.subarray(m,m+p),u);else for(var h=0;h<p;h++)o[u+h]=l[m+h]},flattenChunks:function(o){var l,m,p,u,h,y;for(l=p=0,m=o.length;l<m;l++)p+=o[l].length;for(y=new Uint8Array(p),l=u=0,m=o.length;l<m;l++)h=o[l],y.set(h,u),u+=h.length;return y}},a={arraySet:function(o,l,m,p,u){for(var h=0;h<p;h++)o[u+h]=l[m+h]},flattenChunks:function(o){return[].concat.apply([],o)}};s.setTyped=function(o){o?(s.Buf8=Uint8Array,s.Buf16=Uint16Array,s.Buf32=Int32Array,s.assign(s,i)):(s.Buf8=Array,s.Buf16=Array,s.Buf32=Array,s.assign(s,a))},s.setTyped(n)},{}],42:[function(e,c,s){var n=e("./common"),i=!0,a=!0;try{String.fromCharCode.apply(null,[0])}catch{i=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{a=!1}for(var o=new n.Buf8(256),l=0;l<256;l++)o[l]=252<=l?6:248<=l?5:240<=l?4:224<=l?3:192<=l?2:1;function m(p,u){if(u<65537&&(p.subarray&&a||!p.subarray&&i))return String.fromCharCode.apply(null,n.shrinkBuf(p,u));for(var h="",y=0;y<u;y++)h+=String.fromCharCode(p[y]);return h}o[254]=o[254]=1,s.string2buf=function(p){var u,h,y,f,v,b=p.length,C=0;for(f=0;f<b;f++)(64512&(h=p.charCodeAt(f)))==55296&&f+1<b&&(64512&(y=p.charCodeAt(f+1)))==56320&&(h=65536+(h-55296<<10)+(y-56320),f++),C+=h<128?1:h<2048?2:h<65536?3:4;for(u=new n.Buf8(C),f=v=0;v<C;f++)(64512&(h=p.charCodeAt(f)))==55296&&f+1<b&&(64512&(y=p.charCodeAt(f+1)))==56320&&(h=65536+(h-55296<<10)+(y-56320),f++),h<128?u[v++]=h:(h<2048?u[v++]=192|h>>>6:(h<65536?u[v++]=224|h>>>12:(u[v++]=240|h>>>18,u[v++]=128|h>>>12&63),u[v++]=128|h>>>6&63),u[v++]=128|63&h);return u},s.buf2binstring=function(p){return m(p,p.length)},s.binstring2buf=function(p){for(var u=new n.Buf8(p.length),h=0,y=u.length;h<y;h++)u[h]=p.charCodeAt(h);return u},s.buf2string=function(p,u){var h,y,f,v,b=u||p.length,C=new Array(2*b);for(h=y=0;h<b;)if((f=p[h++])<128)C[y++]=f;else if(4<(v=o[f]))C[y++]=65533,h+=v-1;else{for(f&=v===2?31:v===3?15:7;1<v&&h<b;)f=f<<6|63&p[h++],v--;1<v?C[y++]=65533:f<65536?C[y++]=f:(f-=65536,C[y++]=55296|f>>10&1023,C[y++]=56320|1023&f)}return m(C,y)},s.utf8border=function(p,u){var h;for((u=u||p.length)>p.length&&(u=p.length),h=u-1;0<=h&&(192&p[h])==128;)h--;return h<0||h===0?u:h+o[p[h]]>u?h:u}},{"./common":41}],43:[function(e,c,s){c.exports=function(n,i,a,o){for(var l=65535&n|0,m=n>>>16&65535|0,p=0;a!==0;){for(a-=p=2e3<a?2e3:a;m=m+(l=l+i[o++]|0)|0,--p;);l%=65521,m%=65521}return l|m<<16|0}},{}],44:[function(e,c,s){c.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(e,c,s){var n=function(){for(var i,a=[],o=0;o<256;o++){i=o;for(var l=0;l<8;l++)i=1&i?3988292384^i>>>1:i>>>1;a[o]=i}return a}();c.exports=function(i,a,o,l){var m=n,p=l+o;i^=-1;for(var u=l;u<p;u++)i=i>>>8^m[255&(i^a[u])];return-1^i}},{}],46:[function(e,c,s){var n,i=e("../utils/common"),a=e("./trees"),o=e("./adler32"),l=e("./crc32"),m=e("./messages"),p=0,u=4,h=0,y=-2,f=-1,v=4,b=2,C=8,S=9,k=286,_=30,x=19,L=2*k+1,N=15,R=3,j=258,ee=j+R+1,I=42,z=113,g=1,H=2,fe=3,Z=4;function me(d,U){return d.msg=m[U],U}function P(d){return(d<<1)-(4<d?9:0)}function se(d){for(var U=d.length;0<=--U;)d[U]=0}function O(d){var U=d.state,$=U.pending;$>d.avail_out&&($=d.avail_out),$!==0&&(i.arraySet(d.output,U.pending_buf,U.pending_out,$,d.next_out),d.next_out+=$,U.pending_out+=$,d.total_out+=$,d.avail_out-=$,U.pending-=$,U.pending===0&&(U.pending_out=0))}function M(d,U){a._tr_flush_block(d,0<=d.block_start?d.block_start:-1,d.strstart-d.block_start,U),d.block_start=d.strstart,O(d.strm)}function de(d,U){d.pending_buf[d.pending++]=U}function te(d,U){d.pending_buf[d.pending++]=U>>>8&255,d.pending_buf[d.pending++]=255&U}function Q(d,U){var $,E,w=d.max_chain_length,T=d.strstart,q=d.prev_length,G=d.nice_match,D=d.strstart>d.w_size-ee?d.strstart-(d.w_size-ee):0,Y=d.window,ae=d.w_mask,X=d.prev,ue=d.strstart+j,Le=Y[T+q-1],ve=Y[T+q];d.prev_length>=d.good_match&&(w>>=2),G>d.lookahead&&(G=d.lookahead);do if(Y[($=U)+q]===ve&&Y[$+q-1]===Le&&Y[$]===Y[T]&&Y[++$]===Y[T+1]){T+=2,$++;do;while(Y[++T]===Y[++$]&&Y[++T]===Y[++$]&&Y[++T]===Y[++$]&&Y[++T]===Y[++$]&&Y[++T]===Y[++$]&&Y[++T]===Y[++$]&&Y[++T]===Y[++$]&&Y[++T]===Y[++$]&&T<ue);if(E=j-(ue-T),T=ue-j,q<E){if(d.match_start=U,G<=(q=E))break;Le=Y[T+q-1],ve=Y[T+q]}}while((U=X[U&ae])>D&&--w!=0);return q<=d.lookahead?q:d.lookahead}function Be(d){var U,$,E,w,T,q,G,D,Y,ae,X=d.w_size;do{if(w=d.window_size-d.lookahead-d.strstart,d.strstart>=X+(X-ee)){for(i.arraySet(d.window,d.window,X,X,0),d.match_start-=X,d.strstart-=X,d.block_start-=X,U=$=d.hash_size;E=d.head[--U],d.head[U]=X<=E?E-X:0,--$;);for(U=$=X;E=d.prev[--U],d.prev[U]=X<=E?E-X:0,--$;);w+=X}if(d.strm.avail_in===0)break;if(q=d.strm,G=d.window,D=d.strstart+d.lookahead,Y=w,ae=void 0,ae=q.avail_in,Y<ae&&(ae=Y),$=ae===0?0:(q.avail_in-=ae,i.arraySet(G,q.input,q.next_in,ae,D),q.state.wrap===1?q.adler=o(q.adler,G,ae,D):q.state.wrap===2&&(q.adler=l(q.adler,G,ae,D)),q.next_in+=ae,q.total_in+=ae,ae),d.lookahead+=$,d.lookahead+d.insert>=R)for(T=d.strstart-d.insert,d.ins_h=d.window[T],d.ins_h=(d.ins_h<<d.hash_shift^d.window[T+1])&d.hash_mask;d.insert&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[T+R-1])&d.hash_mask,d.prev[T&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=T,T++,d.insert--,!(d.lookahead+d.insert<R)););}while(d.lookahead<ee&&d.strm.avail_in!==0)}function Me(d,U){for(var $,E;;){if(d.lookahead<ee){if(Be(d),d.lookahead<ee&&U===p)return g;if(d.lookahead===0)break}if($=0,d.lookahead>=R&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),$!==0&&d.strstart-$<=d.w_size-ee&&(d.match_length=Q(d,$)),d.match_length>=R)if(E=a._tr_tally(d,d.strstart-d.match_start,d.match_length-R),d.lookahead-=d.match_length,d.match_length<=d.max_lazy_match&&d.lookahead>=R){for(d.match_length--;d.strstart++,d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart,--d.match_length!=0;);d.strstart++}else d.strstart+=d.match_length,d.match_length=0,d.ins_h=d.window[d.strstart],d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+1])&d.hash_mask;else E=a._tr_tally(d,0,d.window[d.strstart]),d.lookahead--,d.strstart++;if(E&&(M(d,!1),d.strm.avail_out===0))return g}return d.insert=d.strstart<R-1?d.strstart:R-1,U===u?(M(d,!0),d.strm.avail_out===0?fe:Z):d.last_lit&&(M(d,!1),d.strm.avail_out===0)?g:H}function he(d,U){for(var $,E,w;;){if(d.lookahead<ee){if(Be(d),d.lookahead<ee&&U===p)return g;if(d.lookahead===0)break}if($=0,d.lookahead>=R&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),d.prev_length=d.match_length,d.prev_match=d.match_start,d.match_length=R-1,$!==0&&d.prev_length<d.max_lazy_match&&d.strstart-$<=d.w_size-ee&&(d.match_length=Q(d,$),d.match_length<=5&&(d.strategy===1||d.match_length===R&&4096<d.strstart-d.match_start)&&(d.match_length=R-1)),d.prev_length>=R&&d.match_length<=d.prev_length){for(w=d.strstart+d.lookahead-R,E=a._tr_tally(d,d.strstart-1-d.prev_match,d.prev_length-R),d.lookahead-=d.prev_length-1,d.prev_length-=2;++d.strstart<=w&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),--d.prev_length!=0;);if(d.match_available=0,d.match_length=R-1,d.strstart++,E&&(M(d,!1),d.strm.avail_out===0))return g}else if(d.match_available){if((E=a._tr_tally(d,0,d.window[d.strstart-1]))&&M(d,!1),d.strstart++,d.lookahead--,d.strm.avail_out===0)return g}else d.match_available=1,d.strstart++,d.lookahead--}return d.match_available&&(E=a._tr_tally(d,0,d.window[d.strstart-1]),d.match_available=0),d.insert=d.strstart<R-1?d.strstart:R-1,U===u?(M(d,!0),d.strm.avail_out===0?fe:Z):d.last_lit&&(M(d,!1),d.strm.avail_out===0)?g:H}function we(d,U,$,E,w){this.good_length=d,this.max_lazy=U,this.nice_length=$,this.max_chain=E,this.func=w}function Te(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=C,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new i.Buf16(2*L),this.dyn_dtree=new i.Buf16(2*(2*_+1)),this.bl_tree=new i.Buf16(2*(2*x+1)),se(this.dyn_ltree),se(this.dyn_dtree),se(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new i.Buf16(N+1),this.heap=new i.Buf16(2*k+1),se(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new i.Buf16(2*k+1),se(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function Re(d){var U;return d&&d.state?(d.total_in=d.total_out=0,d.data_type=b,(U=d.state).pending=0,U.pending_out=0,U.wrap<0&&(U.wrap=-U.wrap),U.status=U.wrap?I:z,d.adler=U.wrap===2?0:1,U.last_flush=p,a._tr_init(U),h):me(d,y)}function rt(d){var U=Re(d);return U===h&&function($){$.window_size=2*$.w_size,se($.head),$.max_lazy_match=n[$.level].max_lazy,$.good_match=n[$.level].good_length,$.nice_match=n[$.level].nice_length,$.max_chain_length=n[$.level].max_chain,$.strstart=0,$.block_start=0,$.lookahead=0,$.insert=0,$.match_length=$.prev_length=R-1,$.match_available=0,$.ins_h=0}(d.state),U}function Je(d,U,$,E,w,T){if(!d)return y;var q=1;if(U===f&&(U=6),E<0?(q=0,E=-E):15<E&&(q=2,E-=16),w<1||S<w||$!==C||E<8||15<E||U<0||9<U||T<0||v<T)return me(d,y);E===8&&(E=9);var G=new Te;return(d.state=G).strm=d,G.wrap=q,G.gzhead=null,G.w_bits=E,G.w_size=1<<G.w_bits,G.w_mask=G.w_size-1,G.hash_bits=w+7,G.hash_size=1<<G.hash_bits,G.hash_mask=G.hash_size-1,G.hash_shift=~~((G.hash_bits+R-1)/R),G.window=new i.Buf8(2*G.w_size),G.head=new i.Buf16(G.hash_size),G.prev=new i.Buf16(G.w_size),G.lit_bufsize=1<<w+6,G.pending_buf_size=4*G.lit_bufsize,G.pending_buf=new i.Buf8(G.pending_buf_size),G.d_buf=1*G.lit_bufsize,G.l_buf=3*G.lit_bufsize,G.level=U,G.strategy=T,G.method=$,rt(d)}n=[new we(0,0,0,0,function(d,U){var $=65535;for($>d.pending_buf_size-5&&($=d.pending_buf_size-5);;){if(d.lookahead<=1){if(Be(d),d.lookahead===0&&U===p)return g;if(d.lookahead===0)break}d.strstart+=d.lookahead,d.lookahead=0;var E=d.block_start+$;if((d.strstart===0||d.strstart>=E)&&(d.lookahead=d.strstart-E,d.strstart=E,M(d,!1),d.strm.avail_out===0)||d.strstart-d.block_start>=d.w_size-ee&&(M(d,!1),d.strm.avail_out===0))return g}return d.insert=0,U===u?(M(d,!0),d.strm.avail_out===0?fe:Z):(d.strstart>d.block_start&&(M(d,!1),d.strm.avail_out),g)}),new we(4,4,8,4,Me),new we(4,5,16,8,Me),new we(4,6,32,32,Me),new we(4,4,16,16,he),new we(8,16,32,32,he),new we(8,16,128,128,he),new we(8,32,128,256,he),new we(32,128,258,1024,he),new we(32,258,258,4096,he)],s.deflateInit=function(d,U){return Je(d,U,C,15,8,0)},s.deflateInit2=Je,s.deflateReset=rt,s.deflateResetKeep=Re,s.deflateSetHeader=function(d,U){return d&&d.state?d.state.wrap!==2?y:(d.state.gzhead=U,h):y},s.deflate=function(d,U){var $,E,w,T;if(!d||!d.state||5<U||U<0)return d?me(d,y):y;if(E=d.state,!d.output||!d.input&&d.avail_in!==0||E.status===666&&U!==u)return me(d,d.avail_out===0?-5:y);if(E.strm=d,$=E.last_flush,E.last_flush=U,E.status===I)if(E.wrap===2)d.adler=0,de(E,31),de(E,139),de(E,8),E.gzhead?(de(E,(E.gzhead.text?1:0)+(E.gzhead.hcrc?2:0)+(E.gzhead.extra?4:0)+(E.gzhead.name?8:0)+(E.gzhead.comment?16:0)),de(E,255&E.gzhead.time),de(E,E.gzhead.time>>8&255),de(E,E.gzhead.time>>16&255),de(E,E.gzhead.time>>24&255),de(E,E.level===9?2:2<=E.strategy||E.level<2?4:0),de(E,255&E.gzhead.os),E.gzhead.extra&&E.gzhead.extra.length&&(de(E,255&E.gzhead.extra.length),de(E,E.gzhead.extra.length>>8&255)),E.gzhead.hcrc&&(d.adler=l(d.adler,E.pending_buf,E.pending,0)),E.gzindex=0,E.status=69):(de(E,0),de(E,0),de(E,0),de(E,0),de(E,0),de(E,E.level===9?2:2<=E.strategy||E.level<2?4:0),de(E,3),E.status=z);else{var q=C+(E.w_bits-8<<4)<<8;q|=(2<=E.strategy||E.level<2?0:E.level<6?1:E.level===6?2:3)<<6,E.strstart!==0&&(q|=32),q+=31-q%31,E.status=z,te(E,q),E.strstart!==0&&(te(E,d.adler>>>16),te(E,65535&d.adler)),d.adler=1}if(E.status===69)if(E.gzhead.extra){for(w=E.pending;E.gzindex<(65535&E.gzhead.extra.length)&&(E.pending!==E.pending_buf_size||(E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),O(d),w=E.pending,E.pending!==E.pending_buf_size));)de(E,255&E.gzhead.extra[E.gzindex]),E.gzindex++;E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),E.gzindex===E.gzhead.extra.length&&(E.gzindex=0,E.status=73)}else E.status=73;if(E.status===73)if(E.gzhead.name){w=E.pending;do{if(E.pending===E.pending_buf_size&&(E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),O(d),w=E.pending,E.pending===E.pending_buf_size)){T=1;break}T=E.gzindex<E.gzhead.name.length?255&E.gzhead.name.charCodeAt(E.gzindex++):0,de(E,T)}while(T!==0);E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),T===0&&(E.gzindex=0,E.status=91)}else E.status=91;if(E.status===91)if(E.gzhead.comment){w=E.pending;do{if(E.pending===E.pending_buf_size&&(E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),O(d),w=E.pending,E.pending===E.pending_buf_size)){T=1;break}T=E.gzindex<E.gzhead.comment.length?255&E.gzhead.comment.charCodeAt(E.gzindex++):0,de(E,T)}while(T!==0);E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),T===0&&(E.status=103)}else E.status=103;if(E.status===103&&(E.gzhead.hcrc?(E.pending+2>E.pending_buf_size&&O(d),E.pending+2<=E.pending_buf_size&&(de(E,255&d.adler),de(E,d.adler>>8&255),d.adler=0,E.status=z)):E.status=z),E.pending!==0){if(O(d),d.avail_out===0)return E.last_flush=-1,h}else if(d.avail_in===0&&P(U)<=P($)&&U!==u)return me(d,-5);if(E.status===666&&d.avail_in!==0)return me(d,-5);if(d.avail_in!==0||E.lookahead!==0||U!==p&&E.status!==666){var G=E.strategy===2?function(D,Y){for(var ae;;){if(D.lookahead===0&&(Be(D),D.lookahead===0)){if(Y===p)return g;break}if(D.match_length=0,ae=a._tr_tally(D,0,D.window[D.strstart]),D.lookahead--,D.strstart++,ae&&(M(D,!1),D.strm.avail_out===0))return g}return D.insert=0,Y===u?(M(D,!0),D.strm.avail_out===0?fe:Z):D.last_lit&&(M(D,!1),D.strm.avail_out===0)?g:H}(E,U):E.strategy===3?function(D,Y){for(var ae,X,ue,Le,ve=D.window;;){if(D.lookahead<=j){if(Be(D),D.lookahead<=j&&Y===p)return g;if(D.lookahead===0)break}if(D.match_length=0,D.lookahead>=R&&0<D.strstart&&(X=ve[ue=D.strstart-1])===ve[++ue]&&X===ve[++ue]&&X===ve[++ue]){Le=D.strstart+j;do;while(X===ve[++ue]&&X===ve[++ue]&&X===ve[++ue]&&X===ve[++ue]&&X===ve[++ue]&&X===ve[++ue]&&X===ve[++ue]&&X===ve[++ue]&&ue<Le);D.match_length=j-(Le-ue),D.match_length>D.lookahead&&(D.match_length=D.lookahead)}if(D.match_length>=R?(ae=a._tr_tally(D,1,D.match_length-R),D.lookahead-=D.match_length,D.strstart+=D.match_length,D.match_length=0):(ae=a._tr_tally(D,0,D.window[D.strstart]),D.lookahead--,D.strstart++),ae&&(M(D,!1),D.strm.avail_out===0))return g}return D.insert=0,Y===u?(M(D,!0),D.strm.avail_out===0?fe:Z):D.last_lit&&(M(D,!1),D.strm.avail_out===0)?g:H}(E,U):n[E.level].func(E,U);if(G!==fe&&G!==Z||(E.status=666),G===g||G===fe)return d.avail_out===0&&(E.last_flush=-1),h;if(G===H&&(U===1?a._tr_align(E):U!==5&&(a._tr_stored_block(E,0,0,!1),U===3&&(se(E.head),E.lookahead===0&&(E.strstart=0,E.block_start=0,E.insert=0))),O(d),d.avail_out===0))return E.last_flush=-1,h}return U!==u?h:E.wrap<=0?1:(E.wrap===2?(de(E,255&d.adler),de(E,d.adler>>8&255),de(E,d.adler>>16&255),de(E,d.adler>>24&255),de(E,255&d.total_in),de(E,d.total_in>>8&255),de(E,d.total_in>>16&255),de(E,d.total_in>>24&255)):(te(E,d.adler>>>16),te(E,65535&d.adler)),O(d),0<E.wrap&&(E.wrap=-E.wrap),E.pending!==0?h:1)},s.deflateEnd=function(d){var U;return d&&d.state?(U=d.state.status)!==I&&U!==69&&U!==73&&U!==91&&U!==103&&U!==z&&U!==666?me(d,y):(d.state=null,U===z?me(d,-3):h):y},s.deflateSetDictionary=function(d,U){var $,E,w,T,q,G,D,Y,ae=U.length;if(!d||!d.state||(T=($=d.state).wrap)===2||T===1&&$.status!==I||$.lookahead)return y;for(T===1&&(d.adler=o(d.adler,U,ae,0)),$.wrap=0,ae>=$.w_size&&(T===0&&(se($.head),$.strstart=0,$.block_start=0,$.insert=0),Y=new i.Buf8($.w_size),i.arraySet(Y,U,ae-$.w_size,$.w_size,0),U=Y,ae=$.w_size),q=d.avail_in,G=d.next_in,D=d.input,d.avail_in=ae,d.next_in=0,d.input=U,Be($);$.lookahead>=R;){for(E=$.strstart,w=$.lookahead-(R-1);$.ins_h=($.ins_h<<$.hash_shift^$.window[E+R-1])&$.hash_mask,$.prev[E&$.w_mask]=$.head[$.ins_h],$.head[$.ins_h]=E,E++,--w;);$.strstart=E,$.lookahead=R-1,Be($)}return $.strstart+=$.lookahead,$.block_start=$.strstart,$.insert=$.lookahead,$.lookahead=0,$.match_length=$.prev_length=R-1,$.match_available=0,d.next_in=G,d.input=D,d.avail_in=q,$.wrap=T,h},s.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(e,c,s){c.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(e,c,s){c.exports=function(n,i){var a,o,l,m,p,u,h,y,f,v,b,C,S,k,_,x,L,N,R,j,ee,I,z,g,H;a=n.state,o=n.next_in,g=n.input,l=o+(n.avail_in-5),m=n.next_out,H=n.output,p=m-(i-n.avail_out),u=m+(n.avail_out-257),h=a.dmax,y=a.wsize,f=a.whave,v=a.wnext,b=a.window,C=a.hold,S=a.bits,k=a.lencode,_=a.distcode,x=(1<<a.lenbits)-1,L=(1<<a.distbits)-1;e:do{S<15&&(C+=g[o++]<<S,S+=8,C+=g[o++]<<S,S+=8),N=k[C&x];t:for(;;){if(C>>>=R=N>>>24,S-=R,(R=N>>>16&255)===0)H[m++]=65535&N;else{if(!(16&R)){if(!(64&R)){N=k[(65535&N)+(C&(1<<R)-1)];continue t}if(32&R){a.mode=12;break e}n.msg="invalid literal/length code",a.mode=30;break e}j=65535&N,(R&=15)&&(S<R&&(C+=g[o++]<<S,S+=8),j+=C&(1<<R)-1,C>>>=R,S-=R),S<15&&(C+=g[o++]<<S,S+=8,C+=g[o++]<<S,S+=8),N=_[C&L];n:for(;;){if(C>>>=R=N>>>24,S-=R,!(16&(R=N>>>16&255))){if(!(64&R)){N=_[(65535&N)+(C&(1<<R)-1)];continue n}n.msg="invalid distance code",a.mode=30;break e}if(ee=65535&N,S<(R&=15)&&(C+=g[o++]<<S,(S+=8)<R&&(C+=g[o++]<<S,S+=8)),h<(ee+=C&(1<<R)-1)){n.msg="invalid distance too far back",a.mode=30;break e}if(C>>>=R,S-=R,(R=m-p)<ee){if(f<(R=ee-R)&&a.sane){n.msg="invalid distance too far back",a.mode=30;break e}if(z=b,(I=0)===v){if(I+=y-R,R<j){for(j-=R;H[m++]=b[I++],--R;);I=m-ee,z=H}}else if(v<R){if(I+=y+v-R,(R-=v)<j){for(j-=R;H[m++]=b[I++],--R;);if(I=0,v<j){for(j-=R=v;H[m++]=b[I++],--R;);I=m-ee,z=H}}}else if(I+=v-R,R<j){for(j-=R;H[m++]=b[I++],--R;);I=m-ee,z=H}for(;2<j;)H[m++]=z[I++],H[m++]=z[I++],H[m++]=z[I++],j-=3;j&&(H[m++]=z[I++],1<j&&(H[m++]=z[I++]))}else{for(I=m-ee;H[m++]=H[I++],H[m++]=H[I++],H[m++]=H[I++],2<(j-=3););j&&(H[m++]=H[I++],1<j&&(H[m++]=H[I++]))}break}}break}}while(o<l&&m<u);o-=j=S>>3,C&=(1<<(S-=j<<3))-1,n.next_in=o,n.next_out=m,n.avail_in=o<l?l-o+5:5-(o-l),n.avail_out=m<u?u-m+257:257-(m-u),a.hold=C,a.bits=S}},{}],49:[function(e,c,s){var n=e("../utils/common"),i=e("./adler32"),a=e("./crc32"),o=e("./inffast"),l=e("./inftrees"),m=1,p=2,u=0,h=-2,y=1,f=852,v=592;function b(I){return(I>>>24&255)+(I>>>8&65280)+((65280&I)<<8)+((255&I)<<24)}function C(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new n.Buf16(320),this.work=new n.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function S(I){var z;return I&&I.state?(z=I.state,I.total_in=I.total_out=z.total=0,I.msg="",z.wrap&&(I.adler=1&z.wrap),z.mode=y,z.last=0,z.havedict=0,z.dmax=32768,z.head=null,z.hold=0,z.bits=0,z.lencode=z.lendyn=new n.Buf32(f),z.distcode=z.distdyn=new n.Buf32(v),z.sane=1,z.back=-1,u):h}function k(I){var z;return I&&I.state?((z=I.state).wsize=0,z.whave=0,z.wnext=0,S(I)):h}function _(I,z){var g,H;return I&&I.state?(H=I.state,z<0?(g=0,z=-z):(g=1+(z>>4),z<48&&(z&=15)),z&&(z<8||15<z)?h:(H.window!==null&&H.wbits!==z&&(H.window=null),H.wrap=g,H.wbits=z,k(I))):h}function x(I,z){var g,H;return I?(H=new C,(I.state=H).window=null,(g=_(I,z))!==u&&(I.state=null),g):h}var L,N,R=!0;function j(I){if(R){var z;for(L=new n.Buf32(512),N=new n.Buf32(32),z=0;z<144;)I.lens[z++]=8;for(;z<256;)I.lens[z++]=9;for(;z<280;)I.lens[z++]=7;for(;z<288;)I.lens[z++]=8;for(l(m,I.lens,0,288,L,0,I.work,{bits:9}),z=0;z<32;)I.lens[z++]=5;l(p,I.lens,0,32,N,0,I.work,{bits:5}),R=!1}I.lencode=L,I.lenbits=9,I.distcode=N,I.distbits=5}function ee(I,z,g,H){var fe,Z=I.state;return Z.window===null&&(Z.wsize=1<<Z.wbits,Z.wnext=0,Z.whave=0,Z.window=new n.Buf8(Z.wsize)),H>=Z.wsize?(n.arraySet(Z.window,z,g-Z.wsize,Z.wsize,0),Z.wnext=0,Z.whave=Z.wsize):(H<(fe=Z.wsize-Z.wnext)&&(fe=H),n.arraySet(Z.window,z,g-H,fe,Z.wnext),(H-=fe)?(n.arraySet(Z.window,z,g-H,H,0),Z.wnext=H,Z.whave=Z.wsize):(Z.wnext+=fe,Z.wnext===Z.wsize&&(Z.wnext=0),Z.whave<Z.wsize&&(Z.whave+=fe))),0}s.inflateReset=k,s.inflateReset2=_,s.inflateResetKeep=S,s.inflateInit=function(I){return x(I,15)},s.inflateInit2=x,s.inflate=function(I,z){var g,H,fe,Z,me,P,se,O,M,de,te,Q,Be,Me,he,we,Te,Re,rt,Je,d,U,$,E,w=0,T=new n.Buf8(4),q=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!I||!I.state||!I.output||!I.input&&I.avail_in!==0)return h;(g=I.state).mode===12&&(g.mode=13),me=I.next_out,fe=I.output,se=I.avail_out,Z=I.next_in,H=I.input,P=I.avail_in,O=g.hold,M=g.bits,de=P,te=se,U=u;e:for(;;)switch(g.mode){case y:if(g.wrap===0){g.mode=13;break}for(;M<16;){if(P===0)break e;P--,O+=H[Z++]<<M,M+=8}if(2&g.wrap&&O===35615){T[g.check=0]=255&O,T[1]=O>>>8&255,g.check=a(g.check,T,2,0),M=O=0,g.mode=2;break}if(g.flags=0,g.head&&(g.head.done=!1),!(1&g.wrap)||(((255&O)<<8)+(O>>8))%31){I.msg="incorrect header check",g.mode=30;break}if((15&O)!=8){I.msg="unknown compression method",g.mode=30;break}if(M-=4,d=8+(15&(O>>>=4)),g.wbits===0)g.wbits=d;else if(d>g.wbits){I.msg="invalid window size",g.mode=30;break}g.dmax=1<<d,I.adler=g.check=1,g.mode=512&O?10:12,M=O=0;break;case 2:for(;M<16;){if(P===0)break e;P--,O+=H[Z++]<<M,M+=8}if(g.flags=O,(255&g.flags)!=8){I.msg="unknown compression method",g.mode=30;break}if(57344&g.flags){I.msg="unknown header flags set",g.mode=30;break}g.head&&(g.head.text=O>>8&1),512&g.flags&&(T[0]=255&O,T[1]=O>>>8&255,g.check=a(g.check,T,2,0)),M=O=0,g.mode=3;case 3:for(;M<32;){if(P===0)break e;P--,O+=H[Z++]<<M,M+=8}g.head&&(g.head.time=O),512&g.flags&&(T[0]=255&O,T[1]=O>>>8&255,T[2]=O>>>16&255,T[3]=O>>>24&255,g.check=a(g.check,T,4,0)),M=O=0,g.mode=4;case 4:for(;M<16;){if(P===0)break e;P--,O+=H[Z++]<<M,M+=8}g.head&&(g.head.xflags=255&O,g.head.os=O>>8),512&g.flags&&(T[0]=255&O,T[1]=O>>>8&255,g.check=a(g.check,T,2,0)),M=O=0,g.mode=5;case 5:if(1024&g.flags){for(;M<16;){if(P===0)break e;P--,O+=H[Z++]<<M,M+=8}g.length=O,g.head&&(g.head.extra_len=O),512&g.flags&&(T[0]=255&O,T[1]=O>>>8&255,g.check=a(g.check,T,2,0)),M=O=0}else g.head&&(g.head.extra=null);g.mode=6;case 6:if(1024&g.flags&&(P<(Q=g.length)&&(Q=P),Q&&(g.head&&(d=g.head.extra_len-g.length,g.head.extra||(g.head.extra=new Array(g.head.extra_len)),n.arraySet(g.head.extra,H,Z,Q,d)),512&g.flags&&(g.check=a(g.check,H,Q,Z)),P-=Q,Z+=Q,g.length-=Q),g.length))break e;g.length=0,g.mode=7;case 7:if(2048&g.flags){if(P===0)break e;for(Q=0;d=H[Z+Q++],g.head&&d&&g.length<65536&&(g.head.name+=String.fromCharCode(d)),d&&Q<P;);if(512&g.flags&&(g.check=a(g.check,H,Q,Z)),P-=Q,Z+=Q,d)break e}else g.head&&(g.head.name=null);g.length=0,g.mode=8;case 8:if(4096&g.flags){if(P===0)break e;for(Q=0;d=H[Z+Q++],g.head&&d&&g.length<65536&&(g.head.comment+=String.fromCharCode(d)),d&&Q<P;);if(512&g.flags&&(g.check=a(g.check,H,Q,Z)),P-=Q,Z+=Q,d)break e}else g.head&&(g.head.comment=null);g.mode=9;case 9:if(512&g.flags){for(;M<16;){if(P===0)break e;P--,O+=H[Z++]<<M,M+=8}if(O!==(65535&g.check)){I.msg="header crc mismatch",g.mode=30;break}M=O=0}g.head&&(g.head.hcrc=g.flags>>9&1,g.head.done=!0),I.adler=g.check=0,g.mode=12;break;case 10:for(;M<32;){if(P===0)break e;P--,O+=H[Z++]<<M,M+=8}I.adler=g.check=b(O),M=O=0,g.mode=11;case 11:if(g.havedict===0)return I.next_out=me,I.avail_out=se,I.next_in=Z,I.avail_in=P,g.hold=O,g.bits=M,2;I.adler=g.check=1,g.mode=12;case 12:if(z===5||z===6)break e;case 13:if(g.last){O>>>=7&M,M-=7&M,g.mode=27;break}for(;M<3;){if(P===0)break e;P--,O+=H[Z++]<<M,M+=8}switch(g.last=1&O,M-=1,3&(O>>>=1)){case 0:g.mode=14;break;case 1:if(j(g),g.mode=20,z!==6)break;O>>>=2,M-=2;break e;case 2:g.mode=17;break;case 3:I.msg="invalid block type",g.mode=30}O>>>=2,M-=2;break;case 14:for(O>>>=7&M,M-=7&M;M<32;){if(P===0)break e;P--,O+=H[Z++]<<M,M+=8}if((65535&O)!=(O>>>16^65535)){I.msg="invalid stored block lengths",g.mode=30;break}if(g.length=65535&O,M=O=0,g.mode=15,z===6)break e;case 15:g.mode=16;case 16:if(Q=g.length){if(P<Q&&(Q=P),se<Q&&(Q=se),Q===0)break e;n.arraySet(fe,H,Z,Q,me),P-=Q,Z+=Q,se-=Q,me+=Q,g.length-=Q;break}g.mode=12;break;case 17:for(;M<14;){if(P===0)break e;P--,O+=H[Z++]<<M,M+=8}if(g.nlen=257+(31&O),O>>>=5,M-=5,g.ndist=1+(31&O),O>>>=5,M-=5,g.ncode=4+(15&O),O>>>=4,M-=4,286<g.nlen||30<g.ndist){I.msg="too many length or distance symbols",g.mode=30;break}g.have=0,g.mode=18;case 18:for(;g.have<g.ncode;){for(;M<3;){if(P===0)break e;P--,O+=H[Z++]<<M,M+=8}g.lens[q[g.have++]]=7&O,O>>>=3,M-=3}for(;g.have<19;)g.lens[q[g.have++]]=0;if(g.lencode=g.lendyn,g.lenbits=7,$={bits:g.lenbits},U=l(0,g.lens,0,19,g.lencode,0,g.work,$),g.lenbits=$.bits,U){I.msg="invalid code lengths set",g.mode=30;break}g.have=0,g.mode=19;case 19:for(;g.have<g.nlen+g.ndist;){for(;we=(w=g.lencode[O&(1<<g.lenbits)-1])>>>16&255,Te=65535&w,!((he=w>>>24)<=M);){if(P===0)break e;P--,O+=H[Z++]<<M,M+=8}if(Te<16)O>>>=he,M-=he,g.lens[g.have++]=Te;else{if(Te===16){for(E=he+2;M<E;){if(P===0)break e;P--,O+=H[Z++]<<M,M+=8}if(O>>>=he,M-=he,g.have===0){I.msg="invalid bit length repeat",g.mode=30;break}d=g.lens[g.have-1],Q=3+(3&O),O>>>=2,M-=2}else if(Te===17){for(E=he+3;M<E;){if(P===0)break e;P--,O+=H[Z++]<<M,M+=8}M-=he,d=0,Q=3+(7&(O>>>=he)),O>>>=3,M-=3}else{for(E=he+7;M<E;){if(P===0)break e;P--,O+=H[Z++]<<M,M+=8}M-=he,d=0,Q=11+(127&(O>>>=he)),O>>>=7,M-=7}if(g.have+Q>g.nlen+g.ndist){I.msg="invalid bit length repeat",g.mode=30;break}for(;Q--;)g.lens[g.have++]=d}}if(g.mode===30)break;if(g.lens[256]===0){I.msg="invalid code -- missing end-of-block",g.mode=30;break}if(g.lenbits=9,$={bits:g.lenbits},U=l(m,g.lens,0,g.nlen,g.lencode,0,g.work,$),g.lenbits=$.bits,U){I.msg="invalid literal/lengths set",g.mode=30;break}if(g.distbits=6,g.distcode=g.distdyn,$={bits:g.distbits},U=l(p,g.lens,g.nlen,g.ndist,g.distcode,0,g.work,$),g.distbits=$.bits,U){I.msg="invalid distances set",g.mode=30;break}if(g.mode=20,z===6)break e;case 20:g.mode=21;case 21:if(6<=P&&258<=se){I.next_out=me,I.avail_out=se,I.next_in=Z,I.avail_in=P,g.hold=O,g.bits=M,o(I,te),me=I.next_out,fe=I.output,se=I.avail_out,Z=I.next_in,H=I.input,P=I.avail_in,O=g.hold,M=g.bits,g.mode===12&&(g.back=-1);break}for(g.back=0;we=(w=g.lencode[O&(1<<g.lenbits)-1])>>>16&255,Te=65535&w,!((he=w>>>24)<=M);){if(P===0)break e;P--,O+=H[Z++]<<M,M+=8}if(we&&!(240&we)){for(Re=he,rt=we,Je=Te;we=(w=g.lencode[Je+((O&(1<<Re+rt)-1)>>Re)])>>>16&255,Te=65535&w,!(Re+(he=w>>>24)<=M);){if(P===0)break e;P--,O+=H[Z++]<<M,M+=8}O>>>=Re,M-=Re,g.back+=Re}if(O>>>=he,M-=he,g.back+=he,g.length=Te,we===0){g.mode=26;break}if(32&we){g.back=-1,g.mode=12;break}if(64&we){I.msg="invalid literal/length code",g.mode=30;break}g.extra=15&we,g.mode=22;case 22:if(g.extra){for(E=g.extra;M<E;){if(P===0)break e;P--,O+=H[Z++]<<M,M+=8}g.length+=O&(1<<g.extra)-1,O>>>=g.extra,M-=g.extra,g.back+=g.extra}g.was=g.length,g.mode=23;case 23:for(;we=(w=g.distcode[O&(1<<g.distbits)-1])>>>16&255,Te=65535&w,!((he=w>>>24)<=M);){if(P===0)break e;P--,O+=H[Z++]<<M,M+=8}if(!(240&we)){for(Re=he,rt=we,Je=Te;we=(w=g.distcode[Je+((O&(1<<Re+rt)-1)>>Re)])>>>16&255,Te=65535&w,!(Re+(he=w>>>24)<=M);){if(P===0)break e;P--,O+=H[Z++]<<M,M+=8}O>>>=Re,M-=Re,g.back+=Re}if(O>>>=he,M-=he,g.back+=he,64&we){I.msg="invalid distance code",g.mode=30;break}g.offset=Te,g.extra=15&we,g.mode=24;case 24:if(g.extra){for(E=g.extra;M<E;){if(P===0)break e;P--,O+=H[Z++]<<M,M+=8}g.offset+=O&(1<<g.extra)-1,O>>>=g.extra,M-=g.extra,g.back+=g.extra}if(g.offset>g.dmax){I.msg="invalid distance too far back",g.mode=30;break}g.mode=25;case 25:if(se===0)break e;if(Q=te-se,g.offset>Q){if((Q=g.offset-Q)>g.whave&&g.sane){I.msg="invalid distance too far back",g.mode=30;break}Be=Q>g.wnext?(Q-=g.wnext,g.wsize-Q):g.wnext-Q,Q>g.length&&(Q=g.length),Me=g.window}else Me=fe,Be=me-g.offset,Q=g.length;for(se<Q&&(Q=se),se-=Q,g.length-=Q;fe[me++]=Me[Be++],--Q;);g.length===0&&(g.mode=21);break;case 26:if(se===0)break e;fe[me++]=g.length,se--,g.mode=21;break;case 27:if(g.wrap){for(;M<32;){if(P===0)break e;P--,O|=H[Z++]<<M,M+=8}if(te-=se,I.total_out+=te,g.total+=te,te&&(I.adler=g.check=g.flags?a(g.check,fe,te,me-te):i(g.check,fe,te,me-te)),te=se,(g.flags?O:b(O))!==g.check){I.msg="incorrect data check",g.mode=30;break}M=O=0}g.mode=28;case 28:if(g.wrap&&g.flags){for(;M<32;){if(P===0)break e;P--,O+=H[Z++]<<M,M+=8}if(O!==(4294967295&g.total)){I.msg="incorrect length check",g.mode=30;break}M=O=0}g.mode=29;case 29:U=1;break e;case 30:U=-3;break e;case 31:return-4;case 32:default:return h}return I.next_out=me,I.avail_out=se,I.next_in=Z,I.avail_in=P,g.hold=O,g.bits=M,(g.wsize||te!==I.avail_out&&g.mode<30&&(g.mode<27||z!==4))&&ee(I,I.output,I.next_out,te-I.avail_out)?(g.mode=31,-4):(de-=I.avail_in,te-=I.avail_out,I.total_in+=de,I.total_out+=te,g.total+=te,g.wrap&&te&&(I.adler=g.check=g.flags?a(g.check,fe,te,I.next_out-te):i(g.check,fe,te,I.next_out-te)),I.data_type=g.bits+(g.last?64:0)+(g.mode===12?128:0)+(g.mode===20||g.mode===15?256:0),(de==0&&te===0||z===4)&&U===u&&(U=-5),U)},s.inflateEnd=function(I){if(!I||!I.state)return h;var z=I.state;return z.window&&(z.window=null),I.state=null,u},s.inflateGetHeader=function(I,z){var g;return I&&I.state&&2&(g=I.state).wrap?((g.head=z).done=!1,u):h},s.inflateSetDictionary=function(I,z){var g,H=z.length;return I&&I.state?(g=I.state).wrap!==0&&g.mode!==11?h:g.mode===11&&i(1,z,H,0)!==g.check?-3:ee(I,z,H,H)?(g.mode=31,-4):(g.havedict=1,u):h},s.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(e,c,s){var n=e("../utils/common"),i=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],a=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],o=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],l=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];c.exports=function(m,p,u,h,y,f,v,b){var C,S,k,_,x,L,N,R,j,ee=b.bits,I=0,z=0,g=0,H=0,fe=0,Z=0,me=0,P=0,se=0,O=0,M=null,de=0,te=new n.Buf16(16),Q=new n.Buf16(16),Be=null,Me=0;for(I=0;I<=15;I++)te[I]=0;for(z=0;z<h;z++)te[p[u+z]]++;for(fe=ee,H=15;1<=H&&te[H]===0;H--);if(H<fe&&(fe=H),H===0)return y[f++]=20971520,y[f++]=20971520,b.bits=1,0;for(g=1;g<H&&te[g]===0;g++);for(fe<g&&(fe=g),I=P=1;I<=15;I++)if(P<<=1,(P-=te[I])<0)return-1;if(0<P&&(m===0||H!==1))return-1;for(Q[1]=0,I=1;I<15;I++)Q[I+1]=Q[I]+te[I];for(z=0;z<h;z++)p[u+z]!==0&&(v[Q[p[u+z]]++]=z);if(L=m===0?(M=Be=v,19):m===1?(M=i,de-=257,Be=a,Me-=257,256):(M=o,Be=l,-1),I=g,x=f,me=z=O=0,k=-1,_=(se=1<<(Z=fe))-1,m===1&&852<se||m===2&&592<se)return 1;for(;;){for(N=I-me,j=v[z]<L?(R=0,v[z]):v[z]>L?(R=Be[Me+v[z]],M[de+v[z]]):(R=96,0),C=1<<I-me,g=S=1<<Z;y[x+(O>>me)+(S-=C)]=N<<24|R<<16|j|0,S!==0;);for(C=1<<I-1;O&C;)C>>=1;if(C!==0?(O&=C-1,O+=C):O=0,z++,--te[I]==0){if(I===H)break;I=p[u+v[z]]}if(fe<I&&(O&_)!==k){for(me===0&&(me=fe),x+=g,P=1<<(Z=I-me);Z+me<H&&!((P-=te[Z+me])<=0);)Z++,P<<=1;if(se+=1<<Z,m===1&&852<se||m===2&&592<se)return 1;y[k=O&_]=fe<<24|Z<<16|x-f|0}}return O!==0&&(y[x+O]=I-me<<24|64<<16|0),b.bits=fe,0}},{"../utils/common":41}],51:[function(e,c,s){c.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(e,c,s){var n=e("../utils/common"),i=0,a=1;function o(w){for(var T=w.length;0<=--T;)w[T]=0}var l=0,m=29,p=256,u=p+1+m,h=30,y=19,f=2*u+1,v=15,b=16,C=7,S=256,k=16,_=17,x=18,L=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],N=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],R=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],j=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],ee=new Array(2*(u+2));o(ee);var I=new Array(2*h);o(I);var z=new Array(512);o(z);var g=new Array(256);o(g);var H=new Array(m);o(H);var fe,Z,me,P=new Array(h);function se(w,T,q,G,D){this.static_tree=w,this.extra_bits=T,this.extra_base=q,this.elems=G,this.max_length=D,this.has_stree=w&&w.length}function O(w,T){this.dyn_tree=w,this.max_code=0,this.stat_desc=T}function M(w){return w<256?z[w]:z[256+(w>>>7)]}function de(w,T){w.pending_buf[w.pending++]=255&T,w.pending_buf[w.pending++]=T>>>8&255}function te(w,T,q){w.bi_valid>b-q?(w.bi_buf|=T<<w.bi_valid&65535,de(w,w.bi_buf),w.bi_buf=T>>b-w.bi_valid,w.bi_valid+=q-b):(w.bi_buf|=T<<w.bi_valid&65535,w.bi_valid+=q)}function Q(w,T,q){te(w,q[2*T],q[2*T+1])}function Be(w,T){for(var q=0;q|=1&w,w>>>=1,q<<=1,0<--T;);return q>>>1}function Me(w,T,q){var G,D,Y=new Array(v+1),ae=0;for(G=1;G<=v;G++)Y[G]=ae=ae+q[G-1]<<1;for(D=0;D<=T;D++){var X=w[2*D+1];X!==0&&(w[2*D]=Be(Y[X]++,X))}}function he(w){var T;for(T=0;T<u;T++)w.dyn_ltree[2*T]=0;for(T=0;T<h;T++)w.dyn_dtree[2*T]=0;for(T=0;T<y;T++)w.bl_tree[2*T]=0;w.dyn_ltree[2*S]=1,w.opt_len=w.static_len=0,w.last_lit=w.matches=0}function we(w){8<w.bi_valid?de(w,w.bi_buf):0<w.bi_valid&&(w.pending_buf[w.pending++]=w.bi_buf),w.bi_buf=0,w.bi_valid=0}function Te(w,T,q,G){var D=2*T,Y=2*q;return w[D]<w[Y]||w[D]===w[Y]&&G[T]<=G[q]}function Re(w,T,q){for(var G=w.heap[q],D=q<<1;D<=w.heap_len&&(D<w.heap_len&&Te(T,w.heap[D+1],w.heap[D],w.depth)&&D++,!Te(T,G,w.heap[D],w.depth));)w.heap[q]=w.heap[D],q=D,D<<=1;w.heap[q]=G}function rt(w,T,q){var G,D,Y,ae,X=0;if(w.last_lit!==0)for(;G=w.pending_buf[w.d_buf+2*X]<<8|w.pending_buf[w.d_buf+2*X+1],D=w.pending_buf[w.l_buf+X],X++,G===0?Q(w,D,T):(Q(w,(Y=g[D])+p+1,T),(ae=L[Y])!==0&&te(w,D-=H[Y],ae),Q(w,Y=M(--G),q),(ae=N[Y])!==0&&te(w,G-=P[Y],ae)),X<w.last_lit;);Q(w,S,T)}function Je(w,T){var q,G,D,Y=T.dyn_tree,ae=T.stat_desc.static_tree,X=T.stat_desc.has_stree,ue=T.stat_desc.elems,Le=-1;for(w.heap_len=0,w.heap_max=f,q=0;q<ue;q++)Y[2*q]!==0?(w.heap[++w.heap_len]=Le=q,w.depth[q]=0):Y[2*q+1]=0;for(;w.heap_len<2;)Y[2*(D=w.heap[++w.heap_len]=Le<2?++Le:0)]=1,w.depth[D]=0,w.opt_len--,X&&(w.static_len-=ae[2*D+1]);for(T.max_code=Le,q=w.heap_len>>1;1<=q;q--)Re(w,Y,q);for(D=ue;q=w.heap[1],w.heap[1]=w.heap[w.heap_len--],Re(w,Y,1),G=w.heap[1],w.heap[--w.heap_max]=q,w.heap[--w.heap_max]=G,Y[2*D]=Y[2*q]+Y[2*G],w.depth[D]=(w.depth[q]>=w.depth[G]?w.depth[q]:w.depth[G])+1,Y[2*q+1]=Y[2*G+1]=D,w.heap[1]=D++,Re(w,Y,1),2<=w.heap_len;);w.heap[--w.heap_max]=w.heap[1],function(ve,Ge){var vt,ot,bt,be,It,Sn,tt=Ge.dyn_tree,Kt=Ge.max_code,ps=Ge.stat_desc.static_tree,gs=Ge.stat_desc.has_stree,ys=Ge.stat_desc.extra_bits,kn=Ge.stat_desc.extra_base,xt=Ge.stat_desc.max_length,Ft=0;for(be=0;be<=v;be++)ve.bl_count[be]=0;for(tt[2*ve.heap[ve.heap_max]+1]=0,vt=ve.heap_max+1;vt<f;vt++)xt<(be=tt[2*tt[2*(ot=ve.heap[vt])+1]+1]+1)&&(be=xt,Ft++),tt[2*ot+1]=be,Kt<ot||(ve.bl_count[be]++,It=0,kn<=ot&&(It=ys[ot-kn]),Sn=tt[2*ot],ve.opt_len+=Sn*(be+It),gs&&(ve.static_len+=Sn*(ps[2*ot+1]+It)));if(Ft!==0){do{for(be=xt-1;ve.bl_count[be]===0;)be--;ve.bl_count[be]--,ve.bl_count[be+1]+=2,ve.bl_count[xt]--,Ft-=2}while(0<Ft);for(be=xt;be!==0;be--)for(ot=ve.bl_count[be];ot!==0;)Kt<(bt=ve.heap[--vt])||(tt[2*bt+1]!==be&&(ve.opt_len+=(be-tt[2*bt+1])*tt[2*bt],tt[2*bt+1]=be),ot--)}}(w,T),Me(Y,Le,w.bl_count)}function d(w,T,q){var G,D,Y=-1,ae=T[1],X=0,ue=7,Le=4;for(ae===0&&(ue=138,Le=3),T[2*(q+1)+1]=65535,G=0;G<=q;G++)D=ae,ae=T[2*(G+1)+1],++X<ue&&D===ae||(X<Le?w.bl_tree[2*D]+=X:D!==0?(D!==Y&&w.bl_tree[2*D]++,w.bl_tree[2*k]++):X<=10?w.bl_tree[2*_]++:w.bl_tree[2*x]++,Y=D,Le=(X=0)===ae?(ue=138,3):D===ae?(ue=6,3):(ue=7,4))}function U(w,T,q){var G,D,Y=-1,ae=T[1],X=0,ue=7,Le=4;for(ae===0&&(ue=138,Le=3),G=0;G<=q;G++)if(D=ae,ae=T[2*(G+1)+1],!(++X<ue&&D===ae)){if(X<Le)for(;Q(w,D,w.bl_tree),--X!=0;);else D!==0?(D!==Y&&(Q(w,D,w.bl_tree),X--),Q(w,k,w.bl_tree),te(w,X-3,2)):X<=10?(Q(w,_,w.bl_tree),te(w,X-3,3)):(Q(w,x,w.bl_tree),te(w,X-11,7));Y=D,Le=(X=0)===ae?(ue=138,3):D===ae?(ue=6,3):(ue=7,4)}}o(P);var $=!1;function E(w,T,q,G){te(w,(l<<1)+(G?1:0),3),function(D,Y,ae,X){we(D),de(D,ae),de(D,~ae),n.arraySet(D.pending_buf,D.window,Y,ae,D.pending),D.pending+=ae}(w,T,q)}s._tr_init=function(w){$||(function(){var T,q,G,D,Y,ae=new Array(v+1);for(D=G=0;D<m-1;D++)for(H[D]=G,T=0;T<1<<L[D];T++)g[G++]=D;for(g[G-1]=D,D=Y=0;D<16;D++)for(P[D]=Y,T=0;T<1<<N[D];T++)z[Y++]=D;for(Y>>=7;D<h;D++)for(P[D]=Y<<7,T=0;T<1<<N[D]-7;T++)z[256+Y++]=D;for(q=0;q<=v;q++)ae[q]=0;for(T=0;T<=143;)ee[2*T+1]=8,T++,ae[8]++;for(;T<=255;)ee[2*T+1]=9,T++,ae[9]++;for(;T<=279;)ee[2*T+1]=7,T++,ae[7]++;for(;T<=287;)ee[2*T+1]=8,T++,ae[8]++;for(Me(ee,u+1,ae),T=0;T<h;T++)I[2*T+1]=5,I[2*T]=Be(T,5);fe=new se(ee,L,p+1,u,v),Z=new se(I,N,0,h,v),me=new se(new Array(0),R,0,y,C)}(),$=!0),w.l_desc=new O(w.dyn_ltree,fe),w.d_desc=new O(w.dyn_dtree,Z),w.bl_desc=new O(w.bl_tree,me),w.bi_buf=0,w.bi_valid=0,he(w)},s._tr_stored_block=E,s._tr_flush_block=function(w,T,q,G){var D,Y,ae=0;0<w.level?(w.strm.data_type===2&&(w.strm.data_type=function(X){var ue,Le=4093624447;for(ue=0;ue<=31;ue++,Le>>>=1)if(1&Le&&X.dyn_ltree[2*ue]!==0)return i;if(X.dyn_ltree[18]!==0||X.dyn_ltree[20]!==0||X.dyn_ltree[26]!==0)return a;for(ue=32;ue<p;ue++)if(X.dyn_ltree[2*ue]!==0)return a;return i}(w)),Je(w,w.l_desc),Je(w,w.d_desc),ae=function(X){var ue;for(d(X,X.dyn_ltree,X.l_desc.max_code),d(X,X.dyn_dtree,X.d_desc.max_code),Je(X,X.bl_desc),ue=y-1;3<=ue&&X.bl_tree[2*j[ue]+1]===0;ue--);return X.opt_len+=3*(ue+1)+5+5+4,ue}(w),D=w.opt_len+3+7>>>3,(Y=w.static_len+3+7>>>3)<=D&&(D=Y)):D=Y=q+5,q+4<=D&&T!==-1?E(w,T,q,G):w.strategy===4||Y===D?(te(w,2+(G?1:0),3),rt(w,ee,I)):(te(w,4+(G?1:0),3),function(X,ue,Le,ve){var Ge;for(te(X,ue-257,5),te(X,Le-1,5),te(X,ve-4,4),Ge=0;Ge<ve;Ge++)te(X,X.bl_tree[2*j[Ge]+1],3);U(X,X.dyn_ltree,ue-1),U(X,X.dyn_dtree,Le-1)}(w,w.l_desc.max_code+1,w.d_desc.max_code+1,ae+1),rt(w,w.dyn_ltree,w.dyn_dtree)),he(w),G&&we(w)},s._tr_tally=function(w,T,q){return w.pending_buf[w.d_buf+2*w.last_lit]=T>>>8&255,w.pending_buf[w.d_buf+2*w.last_lit+1]=255&T,w.pending_buf[w.l_buf+w.last_lit]=255&q,w.last_lit++,T===0?w.dyn_ltree[2*q]++:(w.matches++,T--,w.dyn_ltree[2*(g[q]+p+1)]++,w.dyn_dtree[2*M(T)]++),w.last_lit===w.lit_bufsize-1},s._tr_align=function(w){te(w,2,3),Q(w,S,ee),function(T){T.bi_valid===16?(de(T,T.bi_buf),T.bi_buf=0,T.bi_valid=0):8<=T.bi_valid&&(T.pending_buf[T.pending++]=255&T.bi_buf,T.bi_buf>>=8,T.bi_valid-=8)}(w)}},{"../utils/common":41}],53:[function(e,c,s){c.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(e,c,s){(function(n){(function(i,a){if(!i.setImmediate){var o,l,m,p,u=1,h={},y=!1,f=i.document,v=Object.getPrototypeOf&&Object.getPrototypeOf(i);v=v&&v.setTimeout?v:i,o={}.toString.call(i.process)==="[object process]"?function(k){process.nextTick(function(){C(k)})}:function(){if(i.postMessage&&!i.importScripts){var k=!0,_=i.onmessage;return i.onmessage=function(){k=!1},i.postMessage("","*"),i.onmessage=_,k}}()?(p="setImmediate$"+Math.random()+"$",i.addEventListener?i.addEventListener("message",S,!1):i.attachEvent("onmessage",S),function(k){i.postMessage(p+k,"*")}):i.MessageChannel?((m=new MessageChannel).port1.onmessage=function(k){C(k.data)},function(k){m.port2.postMessage(k)}):f&&"onreadystatechange"in f.createElement("script")?(l=f.documentElement,function(k){var _=f.createElement("script");_.onreadystatechange=function(){C(k),_.onreadystatechange=null,l.removeChild(_),_=null},l.appendChild(_)}):function(k){setTimeout(C,0,k)},v.setImmediate=function(k){typeof k!="function"&&(k=new Function(""+k));for(var _=new Array(arguments.length-1),x=0;x<_.length;x++)_[x]=arguments[x+1];var L={callback:k,args:_};return h[u]=L,o(u),u++},v.clearImmediate=b}function b(k){delete h[k]}function C(k){if(y)setTimeout(C,0,k);else{var _=h[k];if(_){y=!0;try{(function(x){var L=x.callback,N=x.args;switch(N.length){case 0:L();break;case 1:L(N[0]);break;case 2:L(N[0],N[1]);break;case 3:L(N[0],N[1],N[2]);break;default:L.apply(a,N)}})(_)}finally{b(k),y=!1}}}}function S(k){k.source===i&&typeof k.data=="string"&&k.data.indexOf(p)===0&&C(+k.data.slice(p.length))}})(typeof self>"u"?n===void 0?this:n:self)}).call(this,typeof xn<"u"?xn:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(qa);var rr=qa.exports;const Vs=ja(rr);var Za={exports:{}};(function(t){var r=function(){var e=String.fromCharCode,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",n={};function i(o,l){if(!n[o]){n[o]={};for(var m=0;m<o.length;m++)n[o][o.charAt(m)]=m}return n[o][l]}var a={compressToBase64:function(o){if(o==null)return"";var l=a._compress(o,6,function(m){return c.charAt(m)});switch(l.length%4){default:case 0:return l;case 1:return l+"===";case 2:return l+"==";case 3:return l+"="}},decompressFromBase64:function(o){return o==null?"":o==""?null:a._decompress(o.length,32,function(l){return i(c,o.charAt(l))})},compressToUTF16:function(o){return o==null?"":a._compress(o,15,function(l){return e(l+32)})+" "},decompressFromUTF16:function(o){return o==null?"":o==""?null:a._decompress(o.length,16384,function(l){return o.charCodeAt(l)-32})},compressToUint8Array:function(o){for(var l=a.compress(o),m=new Uint8Array(l.length*2),p=0,u=l.length;p<u;p++){var h=l.charCodeAt(p);m[p*2]=h>>>8,m[p*2+1]=h%256}return m},decompressFromUint8Array:function(o){if(o==null)return a.decompress(o);for(var l=new Array(o.length/2),m=0,p=l.length;m<p;m++)l[m]=o[m*2]*256+o[m*2+1];var u=[];return l.forEach(function(h){u.push(e(h))}),a.decompress(u.join(""))},compressToEncodedURIComponent:function(o){return o==null?"":a._compress(o,6,function(l){return s.charAt(l)})},decompressFromEncodedURIComponent:function(o){return o==null?"":o==""?null:(o=o.replace(/ /g,"+"),a._decompress(o.length,32,function(l){return i(s,o.charAt(l))}))},compress:function(o){return a._compress(o,16,function(l){return e(l)})},_compress:function(o,l,m){if(o==null)return"";var p,u,h={},y={},f="",v="",b="",C=2,S=3,k=2,_=[],x=0,L=0,N;for(N=0;N<o.length;N+=1)if(f=o.charAt(N),Object.prototype.hasOwnProperty.call(h,f)||(h[f]=S++,y[f]=!0),v=b+f,Object.prototype.hasOwnProperty.call(h,v))b=v;else{if(Object.prototype.hasOwnProperty.call(y,b)){if(b.charCodeAt(0)<256){for(p=0;p<k;p++)x=x<<1,L==l-1?(L=0,_.push(m(x)),x=0):L++;for(u=b.charCodeAt(0),p=0;p<8;p++)x=x<<1|u&1,L==l-1?(L=0,_.push(m(x)),x=0):L++,u=u>>1}else{for(u=1,p=0;p<k;p++)x=x<<1|u,L==l-1?(L=0,_.push(m(x)),x=0):L++,u=0;for(u=b.charCodeAt(0),p=0;p<16;p++)x=x<<1|u&1,L==l-1?(L=0,_.push(m(x)),x=0):L++,u=u>>1}C--,C==0&&(C=Math.pow(2,k),k++),delete y[b]}else for(u=h[b],p=0;p<k;p++)x=x<<1|u&1,L==l-1?(L=0,_.push(m(x)),x=0):L++,u=u>>1;C--,C==0&&(C=Math.pow(2,k),k++),h[v]=S++,b=String(f)}if(b!==""){if(Object.prototype.hasOwnProperty.call(y,b)){if(b.charCodeAt(0)<256){for(p=0;p<k;p++)x=x<<1,L==l-1?(L=0,_.push(m(x)),x=0):L++;for(u=b.charCodeAt(0),p=0;p<8;p++)x=x<<1|u&1,L==l-1?(L=0,_.push(m(x)),x=0):L++,u=u>>1}else{for(u=1,p=0;p<k;p++)x=x<<1|u,L==l-1?(L=0,_.push(m(x)),x=0):L++,u=0;for(u=b.charCodeAt(0),p=0;p<16;p++)x=x<<1|u&1,L==l-1?(L=0,_.push(m(x)),x=0):L++,u=u>>1}C--,C==0&&(C=Math.pow(2,k),k++),delete y[b]}else for(u=h[b],p=0;p<k;p++)x=x<<1|u&1,L==l-1?(L=0,_.push(m(x)),x=0):L++,u=u>>1;C--,C==0&&(C=Math.pow(2,k),k++)}for(u=2,p=0;p<k;p++)x=x<<1|u&1,L==l-1?(L=0,_.push(m(x)),x=0):L++,u=u>>1;for(;;)if(x=x<<1,L==l-1){_.push(m(x));break}else L++;return _.join("")},decompress:function(o){return o==null?"":o==""?null:a._decompress(o.length,32768,function(l){return o.charCodeAt(l)})},_decompress:function(o,l,m){var p=[],u=4,h=4,y=3,f="",v=[],b,C,S,k,_,x,L,N={val:m(0),position:l,index:1};for(b=0;b<3;b+=1)p[b]=b;for(S=0,_=Math.pow(2,2),x=1;x!=_;)k=N.val&N.position,N.position>>=1,N.position==0&&(N.position=l,N.val=m(N.index++)),S|=(k>0?1:0)*x,x<<=1;switch(S){case 0:for(S=0,_=Math.pow(2,8),x=1;x!=_;)k=N.val&N.position,N.position>>=1,N.position==0&&(N.position=l,N.val=m(N.index++)),S|=(k>0?1:0)*x,x<<=1;L=e(S);break;case 1:for(S=0,_=Math.pow(2,16),x=1;x!=_;)k=N.val&N.position,N.position>>=1,N.position==0&&(N.position=l,N.val=m(N.index++)),S|=(k>0?1:0)*x,x<<=1;L=e(S);break;case 2:return""}for(p[3]=L,C=L,v.push(L);;){if(N.index>o)return"";for(S=0,_=Math.pow(2,y),x=1;x!=_;)k=N.val&N.position,N.position>>=1,N.position==0&&(N.position=l,N.val=m(N.index++)),S|=(k>0?1:0)*x,x<<=1;switch(L=S){case 0:for(S=0,_=Math.pow(2,8),x=1;x!=_;)k=N.val&N.position,N.position>>=1,N.position==0&&(N.position=l,N.val=m(N.index++)),S|=(k>0?1:0)*x,x<<=1;p[h++]=e(S),L=h-1,u--;break;case 1:for(S=0,_=Math.pow(2,16),x=1;x!=_;)k=N.val&N.position,N.position>>=1,N.position==0&&(N.position=l,N.val=m(N.index++)),S|=(k>0?1:0)*x,x<<=1;p[h++]=e(S),L=h-1,u--;break;case 2:return v.join("")}if(u==0&&(u=Math.pow(2,y),y++),p[L])f=p[L];else if(L===h)f=C+C.charAt(0);else return null;v.push(f),p[h++]=C+f.charAt(0),u--,C=f,u==0&&(u=Math.pow(2,y),y++)}}};return a}();t!=null?t.exports=r:typeof angular<"u"&&angular!=null&&angular.module("LZString",[]).factory("LZString",function(){return r})})(Za);var or=Za.exports;const Ga=ja(or);function cr(t){return new Worker("/assets/compression.worker-B3kqe_bR.js",{name:t==null?void 0:t.name})}let re={},A=null,Js=null,K=null,Ie=null,un=null,cs=null,Ks=[],Un=null,Ys=null,ze=null,st={},jn=0,Xs=0,qn=0,Qs=0,ea=null,ta=null,Zn=null,St=null,Ve=-1,na=null,Gn=null,Vn=null,Jn=null,Va=null,Ja=null,ft=!1,qe=[],nt=[],$t=[],Pe={isScreenSaverEnabled:!0,isSoundEnabled:!0,isVibrationEnabled:!0,lastRestoreTimestamp:null,lastBackupTimestamp:null},Ka=new Set,Bt=!1;function Ya(t){Bt=t}let Ht=null;const sa=new cr;sa.onmessage=t=>{const r=t.data;try{localStorage.setItem("teacherAssistantData_v2",r),console.log("Background save complete.")}catch(e){console.error("Background storage failed:",e)}};sa.onerror=t=>{console.error("❌ Worker Communication Error:",t.message,t)};function oe(t=!1){if(ft)return;const e=JSON.stringify({classrooms:re,trashBin:qe,userSettings:Pe});if(t){Ht&&clearTimeout(Ht);try{const c=Ga.compressToUTF16(e);localStorage.setItem("teacherAssistantData_v2",c),console.log("Immediate save complete.")}catch(c){console.error("Immediate save failed:",c)}return}Ht&&clearTimeout(Ht),Ht=setTimeout(()=>{sa.postMessage(e),Ht=null},500)}function lr(t){return new Promise((r,e)=>{const c=new FileReader;c.onerror=e,c.onload=()=>{r(c.result.split(",")[1])},c.readAsDataURL(t)})}async function Xa(t=[]){const r={};if(t.length>0)t.forEach(l=>{re[l]&&(r[l]=re[l])});else for(const l in re)re[l].isDeleted||(r[l]=re[l]);const e={metadata:{version:"2.0-b64",createdAt:new Date().toISOString()},data:{classrooms:r,trashBin:qe,userSettings:Pe}},c=JSON.stringify(e),s=new Date,n=new Intl.DateTimeFormat("fa-IR-u-nu-latn",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(s).reduce((l,m)=>(l[m.type]=m.value,l),{}),a=`${n.year.slice(-2)}-${n.month}-${n.day}_${n.hour}-${n.minute}`;let o;t.length===0?o=`SP_Full_${a}.txt`:t.length===1?o=`SP_${t[0].replace(/[<>:"/\\|?*]/g,"").replace(/\s+/g,"_")}_${a}.txt`:o=`SP_Selected-${t.length}_${a}.txt`;try{const l=new Vs;l.file("backup.json",c);const m=await l.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:9}}),p=await lr(m);return new File([p],o,{type:"text/plain"})}catch(l){return console.error("Error creating base64 backup file:",l),null}}function Kn(){const t=localStorage.getItem("teacherAssistantData_v2");if(!t)return;let r;try{const e=Ga.decompressFromUTF16(t);e?r=JSON.parse(e):r=JSON.parse(t)}catch{console.log("Migration: Parsing legacy uncompressed data..."),r=JSON.parse(t)}r.classrooms!==void 0&&r.trashBin!==void 0?(Pt(r.classrooms),qe=r.trashBin||[],Pe={...Pe,...r.userSettings}):(Pt(r),dr())}function dr(){const t=[];Object.values(re).forEach(r=>{r.isDeleted?t.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:r.info.creationDate,type:"classroom",description:`کلاس «${r.info.name}»`,restoreData:{name:r.info.name}}):r.students.forEach(e=>{e.isDeleted&&t.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:e.identity.studentId.split("_")[1],type:"student",description:`دانش‌آموز «${e.identity.name}»`,restoreData:{studentId:e.identity.studentId,classroomName:r.info.name}})})}),qe.length===0&&t.length>0&&(qe=t,console.log(`Migrated ${t.length} previously deleted item(s) to the new trash bin.`),oe())}function Qa(t){const r=new Tn(t.identity);return r.isDeleted=t.isDeleted,r.statusCounters=t.statusCounters,r.logs=t.logs,r.logs.scores||(r.logs.scores={}),r.profile=t.profile,r.finalClassActivityScore=t.finalClassActivityScore,r.categoryCounts=t.categoryCounts||{},r.categoryIssues=t.categoryIssues||{},r.qualitativeStats=t.qualitativeStats||{},r.onboardingSession=t.onboardingSession||null,r}function Pt(t){re={};for(const r in t){const e=t[r];let c;e.info?c=e.info:c={...e,name:r};const s=new Ls(c);s.isDeleted=e.isDeleted,s.note=e.note||"",s.students=(e.students||[]).map(Qa),s.sessions=(e.sessions||[]).map(n=>{const i=new Ua(n.sessionNumber);i.isDeleted=n.isDeleted,i.note=n.note||"",i.startTime=new Date(n.startTime),i.createdAt=n.createdAt?new Date(n.createdAt):new Date(n.startTime),i.endTime=n.endTime?new Date(n.endTime):null,i.isFinished=n.isFinished,i.isMakeup=n.isMakeup,i.isCancelled=n.isCancelled||!1,i.studentRecords=n.studentRecords;for(const o in i.studentRecords){const l=i.studentRecords[o];l.homework&&!(l.homework instanceof xs)&&(i.studentRecords[o].homework=new xs(l.homework.status,l.homework.comment))}i.lastWinnerByCategory=n.lastWinnerByCategory,i.lastUsedCategoryId=n.lastUsedCategoryId,i.lastSelectedWinnerId=n.lastSelectedWinnerId;const a=n.winnerHistory||[];return i.winnerHistory=a.filter(o=>o&&o.winner).map(o=>({winner:s.students.find(m=>m.identity.studentId===o.winner.identity.studentId),categoryName:o.categoryName,rating:o.rating||null})).filter(o=>o.winner),i}),s.categories=(e.categories||[]).map(n=>{const i=new gt(n.name,n.description,n.isGradedCategory,n.weight||1);return i.id=n.id,i.isDeleted=n.isDeleted,i}),s.futurePlans=e.futurePlans,re[r]=s}}function ei(t,r){if(r)Pt(t.data.classrooms),ua(t.data.trashBin||[]);else{const e=t.data.classrooms,c=t.data.trashBin||[],s=new Map;for(const i in re){const a=re[i];a.info&&a.info.scheduleCode&&s.set(a.info.scheduleCode,i)}for(const i in e){const a=e[i],o=a.info.scheduleCode;if(s.has(o)){const l=s.get(o);l!==a.info.name&&delete re[l],re[a.info.name]=a}else{let l=a.info.name;for(;re[l];)l=`${l} (Imported)`;l!==a.info.name&&(a.info.name=l),re[l]=a}}const n=new Set(qe.map(i=>i.id));c.forEach(i=>{n.has(i.id)||qe.push(i)}),Pt(re)}t.data.userSettings&&wt(t.data.userSettings),wt({lastRestoreTimestamp:new Date().toISOString()}),oe()}function ti(t,r){if(re[r])return{success:!1,message:"کلاسی با این نام از قبل وجود دارد."};const e=re[t];return e?(e.info.name=r,re[r]=e,delete re[t],A===e&&je(e),{success:!0}):{success:!1,message:"کلاس مورد نظر یافت نشد."}}function ni(t,r,e){const c=e.trim();if(!c)return{success:!1,message:"نام دسته‌بندی نمی‌تواند خالی باشد."};if(t.categories.some(o=>o.id!==r.id&&!o.isDeleted&&o.name.toLowerCase()===c.toLowerCase()))return{success:!1,message:"دسته‌بندی دیگری با این نام وجود دارد."};const n=r.name,i=n.toLowerCase(),a=c.toLowerCase();return r.name=c,t.students.forEach(o=>{o.categoryCounts&&o.categoryCounts[n]!==void 0&&(o.categoryCounts[c]=o.categoryCounts[n],delete o.categoryCounts[n]),o.categoryIssues&&o.categoryIssues[n]!==void 0&&(o.categoryIssues[c]=o.categoryIssues[n],delete o.categoryIssues[n]),o.logs.scores&&o.logs.scores[i]&&(o.logs.scores[i].forEach(l=>l.skill=c),i!==a&&(o.logs.scores[a]=o.logs.scores[i],delete o.logs.scores[i]))}),t.sessions.forEach(o=>{o.lastWinnerByCategory&&o.lastWinnerByCategory[n]&&(o.lastWinnerByCategory[c]=o.lastWinnerByCategory[n],delete o.lastWinnerByCategory[n]),o.winnerHistory&&o.winnerHistory.forEach(l=>{l.categoryName===n&&(l.categoryName=c)})}),{success:!0}}function si(t,r,e){if(Se(e.students).some(l=>l.identity.name.toLowerCase()===t.identity.name.toLowerCase()))return{success:!1,message:`دانش‌آموزی با نام «${t.identity.name}» از قبل در کلاس «${e.info.name}» وجود دارد.`};const s=JSON.parse(JSON.stringify(t)),n=Qa(s),i=new Map;r.sessions.forEach(l=>{const m=l.studentRecords[t.identity.studentId];m&&i.set(l.sessionNumber,JSON.parse(JSON.stringify(m)))}),e.addStudent(n);try{const l=Se(e.sessions).filter(v=>!v.isCancelled).sort((v,b)=>b.sessionNumber-v.sessionNumber),m=l.length>0?l[0]:null;let p="؟",u={type:"system",description:"Student Move"};m&&(p=at(e).get(m.sessionNumber)||m.sessionNumber,u={type:"fromSession",sessionNumber:m.sessionNumber});const h=new Date().toLocaleDateString("fa-IR"),y=r.info.name,f=`این دانش آموز در جلسه ${p} و در تاریخ ${h} از کلاس «${y}» به این کلاس انتقال پیدا کرد`;n.addNote(f,u)}catch(l){console.error("Failed to add automated move note:",l)}i.size>0&&e.sessions.forEach(l=>{const m=i.get(l.sessionNumber);m&&!l.isDeleted&&!l.isCancelled&&(l.studentRecords[n.identity.studentId]=m)});const a={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`(انتقال) دانش‌آموز «${t.identity.name}» از کلاس «${r.info.name}»`,restoreData:{studentId:t.identity.studentId,classId:r.info.scheduleCode}};lt(a);const o=r.students.find(l=>l.identity.studentId===t.identity.studentId);return o&&(o.isDeleted=!0),{success:!0}}function ai(){for(const t in re){const r=re[t];r.students.forEach(e=>{e.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0},e.categoryCounts={},e.categoryIssues={},r.sessions.forEach(c=>{const s=e.identity.studentId;c.studentRecords[s]&&(c.studentRecords[s].attendance="present")})})}oe()}function Se(t){return Array.isArray(t)?t.filter(r=>!r.isDeleted):[]}function at(t){const r=new Map;return t&&Se(t.sessions).filter(c=>!c.isCancelled).sort((c,s)=>c.sessionNumber-s.sessionNumber).forEach((c,s)=>{r.set(c.sessionNumber,s+1)}),r}function yt(t){Ve=t}function dt(t){na=t}function ls(t,r){if(!t||!r)return;const e=t.identity.studentId,c=r.students.findIndex(s=>s.identity.studentId===e);c>-1&&r.students.splice(c,1),r.sessions.forEach(s=>{s.studentRecords[e]&&delete s.studentRecords[e];for(const n in s.lastWinnerByCategory)s.lastWinnerByCategory[n]===e&&delete s.lastWinnerByCategory[n];s.lastSelectedWinnerId===e&&(s.lastSelectedWinnerId=null),s.winnerHistory=s.winnerHistory.filter(n=>n.winner&&n.winner.identity.studentId!==e)})}function aa(t,r){const e=re[t];if(!e)return;const c=e.sessions.findIndex(s=>s.sessionNumber===r);c>-1&&(e.students.forEach(s=>{s.profile.notes&&s.profile.notes.length>0&&(s.profile.notes=s.profile.notes.filter(n=>!n.source||n.source.type!=="fromAttendance"||n.source.sessionNumber!==r)),s.onboardingSession===r&&(s.onboardingSession=null)}),e.sessions.splice(c,1))}function ia(t,r){const e=re[t];if(!e)return;const c=e.categories.findIndex(a=>a.id===r);if(c===-1)return;const n=e.categories[c].name,i=n.toLowerCase();e.students.forEach(a=>{a.categoryCounts&&delete a.categoryCounts[n],a.categoryIssues&&delete a.categoryIssues[n],a.logs.scores&&delete a.logs.scores[i]}),e.sessions.forEach(a=>{a.lastWinnerByCategory[n]&&delete a.lastWinnerByCategory[n],a.winnerHistory=a.winnerHistory.filter(o=>o.categoryName!==n)}),e.categories.splice(c,1)}function ra(t,r,e,c){const s=re[t];if(!s)return;const n=s.students.find(o=>o.identity.studentId===r);if(!n||!n.logs.scores[e.toLowerCase()])return;const i=n.logs.scores[e.toLowerCase()],a=i.findIndex(o=>o.id===c);a>-1&&i.splice(a,1)}function oa(t,r,e){const c=re[t];if(!c)return;const s=c.students.find(i=>i.identity.studentId===r);if(!s||!s.profile.notes)return;const n=s.profile.notes.findIndex(i=>i.id===e);n>-1&&s.profile.notes.splice(n,1)}function ii(){JSON.parse(JSON.stringify({classrooms:re,trashBin:qe})),ft=!0}function ri(){ft=!1,Kn()}function lt(t){for(qe.unshift(t);qe.length>50;){const r=qe.pop();oi(r)}oe()}function oi(t){var r;if(!(!t||!t.restoreData))switch(console.log(`🗑️ Auto-cleaning overflow item: ${t.description}`),t.type){case"classroom":t.restoreData.name&&re[t.restoreData.name]&&delete re[t.restoreData.name];break;case"student":(r=t.restoreData.identity)!=null&&r.studentId&&ls(t.restoreData.identity.studentId);break;case"session":t.restoreData.id&&aa(t.restoreData.id);break;case"category":t.restoreData.id&&ia(t.restoreData.id);break;case"score":ra(t.restoreData);break;case"note":t.restoreData.id&&oa(t.restoreData.id);break}}function je(t){A=t}function fn(t){Js=t}function Xe(t){K=t}function Qe(t){Ie=t}function Yn(t){un=t}function ci(t){cs=t}function Xt(t){Ks=t}function Bn(t){Un=t}function li(t){Ys=t}function Xn(t){ze=t}function Nn(t){jn=t}function di(t){Xs=t}function Dn(t){qn=t}function ui(t){Qs=t}function ca(t){ea=t}function la(t){ta=t}function mn(t){Zn=t}function da(t){St=t}function Zt(t){Vn=t}function fi(t){Va=t}function mi(t){Ja=t}function ua(t){qe=t}function ds(t){Gn=t}function hn(t){$t=t}function wt(t){Pe={...Pe,...t},oe()}function An(t){nt=t}function fa(){Pe.lastBackupTimestamp=new Date().toISOString(),oe()}function Qn(t){Jn=t}function ur(){Ka.clear()}function fr(t){st=t}function mr(){st={}}function ma(t,r){st[t]||(st[t]={toBeScored:[],scoredThisSession:[]}),st[t].scoredThisSession.includes(r)||st[t].scoredThisSession.push(r)}const za=Object.freeze(Object.defineProperty({__proto__:null,get activeModal(){return St},addToTrashBin:lt,get assessmentPools(){return st},assessmentSessionExclusions:Ka,get cancelCallback(){return ta},get classrooms(){return re},get confirmCallback(){return ea},get currentClassroom(){return A},get datePickerCallback(){return Jn},get easterEggClickCount(){return jn},get easterEggLastClickTime(){return Xs},enterDemoMode:ii,exitDemoMode:ri,getActiveItems:Se,getSessionDisplayMap:at,get importedFileContent(){return Un},get isAssessmentModeActive(){return Bt},get isDemoMode(){return ft},get liveSession(){return Js},loadData:Kn,get manualSelection(){return Vn},markStudentAsScoredInSession:ma,moveStudent:si,get namesToImport(){return Ks},get notificationTimeout(){return Ys},permanentlyDeleteCategory:ia,permanentlyDeleteFromTrash:oi,permanentlyDeleteNote:oa,permanentlyDeleteScore:ra,permanentlyDeleteSession:aa,permanentlyDeleteStudent:ls,prepareBackupData:Xa,get previousState(){return un},processRestore:ei,rehydrateData:Pt,renameCategory:ni,renameClassroom:ti,resetAllStudentCounters:ai,resetAssessmentExclusions:ur,resetAssessmentPools:mr,get resetEasterEggClickCount(){return qn},get resetEasterEggLastClickTime(){return Qs},get saveCategoryCallback(){return Gn},saveData:oe,get saveNoteCallback(){return na},get secureConfirmCallback(){return Zn},get selectedCategory(){return ze},get selectedClassIds(){return nt},get selectedSession(){return K},get selectedStudentForProfile(){return Ie},get selectedStudentsForMassComment(){return $t},setActiveModal:da,setAssessmentPools:fr,setCancelCallback:la,setConfirmCallback:ca,setCurrentClassroom:je,setDatePickerCallback:Qn,setEasterEggClickCount:Nn,setEasterEggLastClickTime:di,setImportedFileContent:Bn,setIsAssessmentModeActive:Ya,setLastBackupTimestamp:fa,setLiveSession:fn,setManualSelection:Zt,setNamesToImport:Xt,setNotificationTimeout:li,setPreviousState:Yn,setResetEasterEggClickCount:Dn,setResetEasterEggLastClickTime:ui,setSaveCategoryCallback:ds,setSaveNoteCallback:dt,setSecureConfirmCallback:mn,setSelectedCategory:Xn,setSelectedClassIds:An,setSelectedSession:Xe,setSelectedStudentForProfile:Qe,setSelectedStudentsForMassComment:hn,setSourceClassForMove:mi,setStudentToMove:fi,setTrashBin:ua,setUndoTimeout:ci,setUserSettings:wt,setWinnerHistoryIndex:yt,get sourceClassForMove(){return Ja},get studentToMove(){return Va},get trashBin(){return qe},get undoTimeout(){return cs},get userSettings(){return Pe},get winnerHistoryIndex(){return Ve}},Symbol.toStringTag,{value:"Module"})),hr="TeacherAssistantDB",pr=1,mt="backups";function ha(){return new Promise((t,r)=>{const e=indexedDB.open(hr,pr);e.onupgradeneeded=c=>{const s=c.target.result;s.objectStoreNames.contains(mt)||s.createObjectStore(mt,{keyPath:"id"})},e.onsuccess=c=>t(c.target.result),e.onerror=c=>r(c.target.error)})}async function hi(t,r){const e=await ha(),c=e.transaction(mt,"readwrite"),s=c.objectStore(mt),n={id:Date.now(),file:t,metadata:r,timestamp:new Date().toISOString()};s.add(n),c.oncomplete=()=>{const a=e.transaction(mt,"readwrite").objectStore(mt),o=a.count();o.onsuccess=()=>{if(o.result>10){const l=a.getAllKeys();l.onsuccess=()=>{const m=l.result;for(;m.length>10;){const p=m.shift();a.delete(p),console.log(`♻️ Auto-deleted old backup snapshot: ${p}`)}}}}}}async function pi(){const t=await ha();return new Promise((r,e)=>{const n=t.transaction(mt,"readonly").objectStore(mt).getAll();n.onsuccess=()=>{const i=n.result.sort((a,o)=>o.id-a.id);r(i)},n.onerror=()=>e(n.error)})}async function gr(t){(await ha()).transaction(mt,"readwrite").objectStore(mt).delete(t)}const yr=Object.freeze(Object.defineProperty({__proto__:null,addBackupSnapshot:hi,deleteBackupSnapshot:gr,getBackupSnapshots:pi},Symbol.toStringTag,{value:"Module"}));function Ue(t){return typeof t!="string"?"":t.replace(/ي/g,"ی").replace(/ك/g,"ک").replace(/[\s\u200c]/g,"")}function us(t){return typeof t!="string"||t.length===0?"ltr":/[\u0590-\u07FF]/.test(t)?"rtl":"ltr"}function pa(t){return!t||!t.trim()?"":t.split(`
`).map(c=>`<div dir="${us(c)}">${c||"&nbsp;"}</div>`).join("")}function On(t){if(typeof t!="string")return"";const r={q:"ض",w:"ص",e:"ث",r:"ق",t:"ف",y:"غ",u:"ع",i:"ه",o:"خ",p:"ح","[":"ج","]":"چ",a:"ش",s:"س",d:"ی",f:"ب",g:"ل",h:"ا",j:"ت",k:"ن",l:"م",";":"ک","'":"گ",z:"ظ",x:"ط",c:"ز",v:"ر",b:"ذ",n:"د",m:"پ",",":"و"};let e="";for(let c=0;c<t.length;c++){const s=t[c].toLowerCase();e+=r[s]||t[c]}return e}function an(t){if(!t||typeof t!="string")return{name:"",firstName:"",lastName:""};const r=t.split(".").map(e=>e.trim());if(r.length>1){const e=r[0],c=r.slice(1).join(" ");return{firstName:e,lastName:c,name:`${e} ${c}`.trim()}}return{name:t.trim(),firstName:"",lastName:""}}let _s=null;function Ts(){if(!Pe.isSoundEnabled)return;const t=window.AudioContext||window.webkitAudioContext;if(!t)return;_s||(_s=new t);const r=_s,e=()=>{const c=r.createOscillator(),s=r.createGain();c.connect(s),s.connect(r.destination),c.type="sine";const n=r.currentTime;c.frequency.setValueAtTime(450,n),s.gain.setValueAtTime(0,n),s.gain.linearRampToValueAtTime(.3,n+.002),s.gain.exponentialRampToValueAtTime(.001,n+.025),s.gain.linearRampToValueAtTime(0,n+.03),c.start(n),c.stop(n+.04)};r.state==="suspended"?r.resume().then(()=>{e()}).catch(c=>console.error("Audio resume failed:",c)):e()}function Cn(t){const r=t.filter(s=>s.identity.firstName&&s.identity.lastName),e=t.filter(s=>(!s.identity.firstName||!s.identity.lastName)&&typeof s.identity.name=="string"),c=t.filter(s=>(!s.identity.firstName||!s.identity.lastName)&&!s.identity.name);return r.sort((s,n)=>{const i=s.identity.lastName.localeCompare(n.identity.lastName,"fa");return i!==0?i:s.identity.firstName.localeCompare(n.identity.firstName,"fa")}),e.sort((s,n)=>s.identity.name.localeCompare(n.identity.name,"fa")),[...r,...e,...c]}const vr=Object.freeze(Object.defineProperty({__proto__:null,detectTextDirection:us,normalizeKeyboard:On,normalizeText:Ue,parseStudentName:an,playSuccessSound:Ts,renderMultiLineText:pa,sortStudents:Cn},Symbol.toStringTag,{value:"Module"})),gi="teacherAssistantLogs_v2",br=100;function ga(){try{const t=localStorage.getItem(gi);return t?JSON.parse(t):{}}catch(t){return console.error("Error reading logs from localStorage:",t),{}}}function yi(t){try{localStorage.setItem(gi,JSON.stringify(t))}catch(r){console.error("Error saving logs to localStorage:",r)}}function _e(t,r,e=null){if(!t)return;const c=ga();c[t]||(c[t]=[]);const s={timestamp:new Date().toISOString(),message:r,action:e,classroomName:t};c[t].unshift(s),c[t].length>br&&c[t].pop(),yi(c)}function Cr(t){return ga()[t]||[]}function wr(t,r){const e=ga();e[t]&&!e[r]&&(e[r]=e[t],delete e[t],yi(e))}var $a={toJalaali:Er,toGregorian:vi,isValidJalaaliDate:Sr,isLeapJalaaliYear:bi,jalaaliMonthLength:Ci,jalCal:ya,j2d:es,d2j:ts,g2d:fs,d2g:va,jalaaliToDateObject:wi,jalaaliWeek:_r},Et=[-61,9,38,199,426,686,756,818,1111,1181,1210,1635,2060,2097,2192,2262,2324,2394,2456,3178];function Er(t,r,e){return Object.prototype.toString.call(t)==="[object Date]"&&(e=t.getDate(),r=t.getMonth()+1,t=t.getFullYear()),ts(fs(t,r,e))}function vi(t,r,e){return va(es(t,r,e))}function Sr(t,r,e){return t>=-61&&t<=3177&&r>=1&&r<=12&&e>=1&&e<=Ci(t,r)}function bi(t){return kr(t)===0}function Ci(t,r){return r<=6?31:r<=11||bi(t)?30:29}function kr(t){var r=Et.length,e=Et[0],c,s,n,i,a;if(t<e||t>=Et[r-1])throw new Error("Invalid Jalaali year "+t);for(a=1;a<r&&(c=Et[a],s=c-e,!(t<c));a+=1)e=c;return i=t-e,s-i<6&&(i=i-s+De(s+4,33)*33),n=et(et(i+1,33)-1,4),n===-1&&(n=4),n}function ya(t,r){var e=Et.length,c=t+621,s=-14,n=Et[0],i,a,o,l,m,p,u;if(t<n||t>=Et[e-1])throw new Error("Invalid Jalaali year "+t);for(u=1;u<e&&(i=Et[u],a=i-n,!(t<i));u+=1)s=s+De(a,33)*8+De(et(a,33),4),n=i;return p=t-n,s=s+De(p,33)*8+De(et(p,33)+3,4),et(a,33)===4&&a-p===4&&(s+=1),l=De(c,4)-De((De(c,100)+1)*3,4)-150,m=20+s-l,r?{gy:c,march:m}:(a-p<6&&(p=p-a+De(a+4,33)*33),o=et(et(p+1,33)-1,4),o===-1&&(o=4),{leap:o,gy:c,march:m})}function es(t,r,e){var c=ya(t,!0);return fs(c.gy,3,c.march)+(r-1)*31-De(r,7)*(r-7)+e-1}function ts(t){var r=va(t).gy,e=r-621,c=ya(e,!1),s=fs(r,3,c.march),n,i,a;if(a=t-s,a>=0){if(a<=185)return i=1+De(a,31),n=et(a,31)+1,{jy:e,jm:i,jd:n};a-=186}else e-=1,a+=179,c.leap===1&&(a+=1);return i=7+De(a,30),n=et(a,30)+1,{jy:e,jm:i,jd:n}}function fs(t,r,e){var c=De((t+De(r-8,6)+100100)*1461,4)+De(153*et(r+9,12)+2,5)+e-34840408;return c=c-De(De(t+100100+De(r-8,6),100)*3,4)+752,c}function va(t){var r,e,c,s,n;return r=4*t+139361631,r=r+De(De(4*t+183187720,146097)*3,4)*4-3908,e=De(et(r,1461),4)*5+308,c=De(et(e,153),5)+1,s=et(De(e,153),12)+1,n=De(r,1461)-100100+De(8-s,6),{gy:n,gm:s,gd:c}}function _r(t,r,e){var c=wi(t,r,e).getDay(),s=c==6?0:-(c+1),n=6+s;return{saturday:ts(es(t,r,e+s)),friday:ts(es(t,r,e+n))}}function wi(t,r,e,c,s,n,i){var a=vi(t,r,e);return new Date(a.gy,a.gm-1,a.gd,c||0,s||0,n||0,i||0)}function De(t,r){return~~(t/r)}function et(t,r){return t-~~(t/r)*r}const Ei=document.getElementById("class-management-page"),Ir=document.getElementById("open-add-class-modal-btn"),xr=document.getElementById("add-class-modal"),pn=document.getElementById("modal-new-class-name"),ns=document.getElementById("modal-add-class-system"),ba=document.getElementById("modal-add-class-level"),Bs=document.getElementById("confirm-add-class-btn"),Ns=document.getElementById("cancel-add-class-btn"),Ot=document.getElementById("class-list"),ss=document.getElementById("undo-toast"),Si=document.getElementById("undo-message"),Lr=document.getElementById("undo-btn"),Tr=document.getElementById("settings-page"),ki=document.getElementById("settings-class-name-header"),Ds=document.getElementById("settings-student-list"),As=document.getElementById("category-list"),Br=document.getElementById("back-to-sessions-btn"),Nr=document.getElementById("new-student-name"),Dr=document.getElementById("add-student-btn"),_i=document.getElementById("paste-area"),Ar=document.getElementById("process-paste-btn"),Or=document.getElementById("csv-preview-page"),Os=document.getElementById("csv-preview-list"),Mr=document.getElementById("csv-confirm-btn"),Rr=document.getElementById("csv-cancel-btn"),zr=document.getElementById("import-csv-btn"),$r=document.getElementById("csv-file-input"),Pr=document.getElementById("column-mapping-page"),Ms=document.getElementById("column-select-dropdown"),Fr=document.getElementById("confirm-column-btn"),Hr=document.getElementById("cancel-import-btn"),Wr=document.getElementById("new-category-name"),Ur=document.getElementById("add-category-btn"),Rs=document.querySelector(".app-header"),Ye=document.getElementById("select-student-btn"),Mt=document.getElementById("select-student-btn-wrapper"),jr=document.getElementById("assessment-mode-label"),Mn=document.getElementById("category-weight-label"),qr=document.getElementById("attendance-page"),rn=document.getElementById("attendance-list"),Zr=document.getElementById("finish-attendance-btn"),Gr=document.querySelector("#class-management-page h2"),zs=document.getElementById("student-stats-header"),Vr=document.getElementById("hamburger-menu-btn"),Jr=document.getElementById("side-nav-menu"),Kr=document.getElementById("close-nav-btn"),Yr=document.getElementById("overlay"),Xr=document.getElementById("backup-data-btn"),Qr=document.getElementById("restore-data-btn"),Ii=document.getElementById("restore-file-input"),eo=document.getElementById("custom-confirm-modal"),xi=document.getElementById("confirm-modal-message"),$s=document.getElementById("confirm-modal-cancel-btn"),Qt=document.getElementById("confirm-modal-confirm-btn"),to=document.getElementById("secure-confirm-modal"),Li=document.getElementById("secure-confirm-message"),Ti=document.getElementById("secure-confirm-code"),Wt=document.getElementById("secure-confirm-input"),no=document.getElementById("secure-confirm-cancel-btn"),Rn=document.getElementById("secure-confirm-confirm-btn"),so=document.getElementById("add-note-modal"),ke=document.getElementById("new-note-content"),ao=document.getElementById("class-save-note-btn"),io=document.getElementById("cancel-note-btn"),Ps=document.getElementById("student-search-input"),Ct=document.getElementById("student-search-results"),ro=document.getElementById("back-to-student-page-btn"),oo=document.getElementById("graded-category-pills-container"),co=document.getElementById("new-score-value"),Bi=document.getElementById("new-score-comment"),lo=document.getElementById("add-score-btn"),uo=document.getElementById("profile-stats-summary"),fo=document.getElementById("profile-scores-list"),en=document.getElementById("global-student-search-input"),ut=document.getElementById("global-student-search-results"),mo=document.getElementById("is-graded-checkbox"),ho=document.getElementById("trashed-classes-list"),po=document.getElementById("trashed-students-list"),go=document.getElementById("trashed-sessions-list"),yo=document.getElementById("trashed-categories-list"),vo=document.getElementById("trashed-notes-list"),bo=document.getElementById("trashed-scores-list"),jt=document.getElementById("quick-grade-form-wrapper"),ht=document.getElementById("quick-score-input"),ct=document.getElementById("quick-note-textarea"),Rt=document.getElementById("quick-grade-submit-btn"),on=document.getElementById("category-selection-container"),Fs=document.getElementById("selected-student-result"),zt=document.getElementById("custom-context-menu"),Ut=document.getElementById("breadcrumb-container"),Co=document.getElementById("report-config-modal"),Ni=document.getElementById("report-columns-container"),Di=document.getElementById("report-print-btn"),Ai=document.getElementById("report-cancel-btn");let Yt=null,qt=null;const wo=document.getElementById("category-modal"),Oi=document.getElementById("category-modal-title"),cn=document.getElementById("new-category-modal-name"),Nt=document.getElementById("new-category-modal-is-graded"),Eo=document.getElementById("category-modal-cancel-btn"),Mi=document.getElementById("category-modal-save-btn"),So=document.getElementById("mass-comment-modal"),ko=document.getElementById("mass-comment-modal-title"),Ri=document.getElementById("mass-comment-student-count-message"),ln=document.getElementById("mass-comment-content"),Ca=document.getElementById("mass-comment-append-checkbox"),_o=document.getElementById("mass-comment-cancel-btn"),Io=document.getElementById("mass-comment-save-btn"),Hs=document.getElementById("mass-comment-btn"),zn=document.getElementById("attendance-mass-actions-container"),Tt=document.createElement("input"),xo=document.getElementById("session-dashboard-page"),Gt=document.getElementById("attendance-pane"),$n=document.getElementById("settings-edu-system"),tn=document.getElementById("settings-level"),zi=document.getElementById("modal-schedule-text"),as=document.getElementById("modal-schedule-days"),$i=document.getElementById("modal-schedule-start-time"),Pi=document.getElementById("modal-schedule-end-time"),nn=document.getElementById("modal-schedule-toggle"),Fi=document.getElementById("modal-schedule-content"),Lo=document.getElementById("new-category-weight"),Ws=document.getElementById("new-category-modal-weight");function Dt(t,r){let e;const s=i=>{e=setTimeout(()=>{Pe.isVibrationEnabled&&navigator.vibrate&&navigator.vibrate(50),r(i)},800)},n=()=>{clearTimeout(e)};t.addEventListener("touchstart",s,{passive:!0}),t.addEventListener("touchend",n),t.addEventListener("touchmove",n),t.addEventListener("mousedown",s),t.addEventListener("mouseup",n),t.addEventListener("mouseleave",n)}function Vt(t="selector"){if(!A||!K){ye("class-management-page");return}Ao(),Fn(),Ae(),it(),ye("session-dashboard-page",{tab:t}),Hi(),gn(t),Oo()}function gn(t){const r=document.getElementById("selector-tab-btn"),e=document.getElementById("attendance-tab-btn"),c=document.getElementById("selector-pane"),s=t==="selector";r.classList.toggle("active",s),e.classList.toggle("active",!s),c.classList.toggle("active",s),Gt.classList.toggle("active",!s)}function Hi(){const t=document.getElementById("selector-tab-btn"),r=document.getElementById("attendance-tab-btn"),e=document.getElementById("selector-pane");t.addEventListener("click",()=>{Ae(),Oe(),t.classList.add("active"),r.classList.remove("active"),e.classList.add("active"),Gt.classList.remove("active"),ye("session-dashboard-page",{tab:"selector"})}),r.addEventListener("click",()=>{it(),r.classList.add("active"),t.classList.remove("active"),Gt.classList.add("active"),e.classList.remove("active"),ye("session-dashboard-page",{tab:"attendance"})})}function To(t){clearTimeout(cs),un||Yn(JSON.stringify(re)),Si.textContent=t,ss.classList.add("show"),ci(setTimeout(()=>{ss.classList.remove("show"),Yn(null)},5e3))}function Wi(){if(un){const t=A?A.info.name:null,r=JSON.parse(un);Pt(r),t&&re[t]?je(re[t]):je(null),A?(_t(),En(),Ze()):He(),ss.classList.remove("show"),clearTimeout(cs),Yn(null)}}function V(t,r=3e3){const e=document.getElementById("notification-toast");e&&(e.textContent=t,e.classList.add("show"),clearTimeout(Ys),li(setTimeout(()=>{e.classList.remove("show")},r)))}function is(t){var v;const r=document.getElementById("restore-confirm-modal"),e=document.getElementById("restore-modal-message"),c=document.getElementById("restore-append-checkbox"),s=document.querySelector('label[for="restore-append-checkbox"]'),n=document.getElementById("restore-confirm-cancel-btn"),i=document.getElementById("restore-confirm-confirm-btn"),a=document.getElementById("restore-modal-warning");a.style.display="none";const o=((v=t.metadata)==null?void 0:v.createdAt)||0;if(Pe.lastRestoreTimestamp&&o<Pe.lastRestoreTimestamp){const b=new Date(o).toLocaleDateString("fa-IR"),C=new Date(Pe.lastRestoreTimestamp).toLocaleDateString("fa-IR");a.textContent=`⚠️ هشدار: این فایل پشتیبان (${b}) قدیمی‌تر از آخرین بازیابی شما (${C}) است.`,a.style.display="block"}const l=t.data.classrooms||{},m=Object.values(l).map(b=>b.info.name),p=m.length,u="کلاس",h=m.map(b=>`<li style="margin-bottom: 4px;">🔹 ${b}</li>`).join("");e.innerHTML=`
        <div style="margin-bottom: 10px;">
            فایل پشتیبان شامل <strong>${p} ${u}</strong> زیر است:
        </div>
        <ul style="
            margin: 0; 
            padding: 10px; 
            background-color: #f8f9fa; 
            border-radius: 5px; 
            border: 1px solid #e9ecef;
            list-style: none; 
            max-height: 150px; 
            overflow-y: auto;
            text-align: right;
        ">
            ${h}
        </ul>
        <div style="margin-top: 15px;">
            لطفاً نحوه بازیابی را مشخص کنید.
        </div>
    `,c.checked=!1,s&&(s.textContent="جایگزینی کامل (حذف داده‌های فعلی)");const y=()=>{const b=c.checked;ei(t,b),i.onclick=null,n.onclick=null,r.removeEventListener("click",y),ge(),He(),ye("class-management-page"),V(`✅ اطلاعات با موفقیت بازیابی شد (${b?"پاک‌سازی و بازیابی":"همگام‌سازی هوشمند"}).`)},f=()=>{i.onclick=null,n.onclick=null,ge()};i.onclick=y,n.onclick=f,$e("restore-confirm-modal")}function Ce(t,r,e={}){const{confirmText:c="تایید",cancelText:s="لغو",confirmClass:n="btn-success",onCancel:i=()=>{},isDelete:a=!1}=e,o=a?()=>Ui(t,r):r;xi.innerHTML=t.replace(/\n/g,"<br>"),Qt.textContent=c,$s.textContent=s,Qt.className="modal-action-btn",Qt.classList.add(n),ca(o),la(i);const l=Qt.parentElement;$s.style.display=i===null?"none":"inline-block",l.style.justifyContent=i===null?"center":"space-between",$e("custom-confirm-modal")}function Ui(t,r){const e=Math.floor(1e4+Math.random()*9e4).toString();Li.textContent=t,Ti.textContent=e,Wt.value="",Rn.disabled=!0,mn(r),$e("secure-confirm-modal"),Wt.focus();const c=()=>{Wt.value===e?Rn.disabled=!1:Rn.disabled=!0};return Wt.addEventListener("input",c),()=>{Wt.removeEventListener("input",c)}}function Us(t,r={}){const{title:e="ایجاد دسته‌بندی جدید",initialName:c="",initialIsGraded:s=!1,initialWeight:n=1,saveButtonText:i="ذخیره"}=r;Oi.textContent=e,cn.value=c,Nt.checked=s,Ws.value=n,Mi.textContent=i,ds((a,o)=>{const l=parseFloat(Ws.value)||1;if(!a){V("⚠️ لطفاً نام دسته‌بندی را وارد کنید.");return}t(a,o,l),ge()}),$e("category-modal"),cn.focus(),c&&cn.select()}function wa(t,r){const e=Object.values(re).filter(i=>!i.isDeleted&&i.info.name!==r.info.name),c=document.getElementById("move-student-modal-title"),s=document.getElementById("move-student-class-select"),n=document.getElementById("move-student-confirm-btn");c.textContent=`انتقال دانش‌آموز: ${t.identity.name}`,s.innerHTML="",e.length===0?(s.innerHTML='<option value="">کلاس دیگری برای انتقال وجود ندارد</option>',n.disabled=!0):(e.forEach(i=>{const a=document.createElement("option");a.value=i.info.name,a.textContent=i.info.name,s.appendChild(a)}),n.disabled=!1),fi(t),mi(r),$e("move-student-modal")}function rs(t,r){if(!t||!r)return;const e=t.identity.name,c=t.identity.firstName||"";t.identity.lastName;const s=document.getElementById("add-note-modal-title");s.textContent="تغییر نام دانش‌ آموز";const n=t.identity.firstName&&t.identity.lastName?`${t.identity.firstName} . ${t.identity.lastName}`:e;ke.value=n,ke.rows=1,ke.dispatchEvent(new Event("input",{bubbles:!0})),dt(i=>{const a=i.indexOf(".");if(a<=0||a>=i.length-1)return V("لطفا نام و نام خانوادگی شخص را با یک نقطه از هم جدا کنید. مثال: علی . احمدی"),!1;const o=an(i),l=o.name,m=o.firstName||"";if(t.identity.firstName&&t.identity.lastName&&!o.firstName)return V("⚠️ این دانش‌آموز دارای نام و نام‌خانوادگی تفکیک شده است. لطفاً حتماً از نقطه (.) بین نام و نام‌خانوادگی استفاده کنید."),!1;if(l&&(l!==e||m!==c)){if(Se(r.students).some(f=>f.identity.studentId!==t.identity.studentId&&f.identity.name.toLowerCase()===l.toLowerCase()))return V("دانش‌آموزی با این نام از قبل در این کلاس وجود دارد."),!1;{t.identity.name=l,t.identity.firstName=o.firstName,t.identity.lastName=o.lastName,_e(r.info.name,`نام دانش‌آموز «${e}» به «${l}» تغییر یافت.`,{type:"VIEW_STUDENT_PROFILE",studentId:t.identity.studentId}),oe(),_t(),Ae(),it(),Oe(),Ie&&Ie.identity.studentId===t.identity.studentId&&Fe(t);const f=document.querySelector(`#settings-student-list li[data-student-id="${t.identity.studentId}"]`);f&&(f.classList.add("recently-updated"),setTimeout(()=>{f&&f.classList.remove("recently-updated")},1e4),f.scrollIntoView({behavior:"smooth",block:"center"})),V(`✅ نام دانش‌آموز به «${l}» تغییر یافت.`)}}else if(!l)return V("⚠️ نام نمی‌تواند خالی باشد."),!1;const h=document.getElementById("add-note-modal-title");h.textContent="ثبت یادداشت جدید",ke.rows=4}),$e("add-note-modal"),ke.focus(),ke.select()}function $e(t){const r=document.getElementById(t);if(r){if(St)return;r.classList.add("modal-visible"),da(t),history.pushState(null,"",location.href)}}function ge(t,r=!1){if(!St)return;const e=document.getElementById(St),c=St;da(null),c==="student-profile-modal"&&Qe(null),r||history.back(),e&&(e.classList.add("modal-closing"),setTimeout(()=>{e.classList.remove("modal-visible"),e.classList.remove("modal-closing"),c==="custom-confirm-modal"&&(ca(null),la(null)),c==="secure-confirm-modal"&&mn(null),c==="category-modal"&&ds(null),c==="mass-comment-modal"&&(ln.value=""),c==="add-note-modal"&&dt(null),typeof t=="function"&&t()},300))}function Ea(){if(!Gt||!Gt.classList.contains("active")){zn.style.display="none";return}const t=$t.length;t<1?zn.style.display="none":zn.style.display="block",Hs.disabled=t<1,Hs.textContent=`📝 ثبت یادداشت گروهی (${t} نفر)`}function Sa(){const t=$t,r=t.length;let e=!1;r>0&&(e=t.some(s=>{var n;return(n=K.studentRecords[s])==null?void 0:n.homework.comment})),Ri.textContent=`یادداشت برای ${r} دانش‌آموز ثبت خواهد شد.`,ln.value="",ln.dispatchEvent(new Event("input",{bubbles:!0})),Ca.checked=!0;const c=document.querySelector("#mass-comment-modal .modal-options");c.style.display=e?"flex":"none",$e("mass-comment-modal"),ln.focus()}function js(t,r){if(!A||!K)return;let e=0;const c=$t,s=K;c.forEach(n=>{const i=s.studentRecords[n];if(i&&i.homework){const a=i.homework.comment||"";let o=t;r&&a.length>0?o=a+`
---
`+t:o=t,i.homework.comment=o.trim();const l=A.students.find(m=>m.identity.studentId===n);l&&Bo(l,s,o.trim()),e++}}),hn([]),oe(),it(),_e(A.info.name,`${e} دانش‌آموز به صورت گروهی یادداشت تکلیف گرفتند.`,{type:"VIEW_SESSIONS"}),V(`✅ یادداشت برای ${e} دانش‌آموز ثبت شد.`)}function Bo(t,r,e){const s=at(A).get(r.sessionNumber),n={type:"fromAttendance",sessionNumber:r.sessionNumber},i=`یادداشت جلسه ${s}:
`,a=t.profile.notes.find(o=>!o.isDeleted&&o.source&&o.source.type==="fromAttendance"&&o.source.sessionNumber===n.sessionNumber);a?e?(a.content=i+e,a.isDeleted=!1):a.isDeleted=!0:e&&t.addNote(i+e,n)}function ms(t){ke.value=t.note||"",dt(r=>{t.note=r,oe(),_e(t.info.name,"یادداشت کلاس ذخیره شد.",{type:"VIEW_CLASS_NOTE"}),He(),V("✅ یادداشت کلاس ذخیره شد.")}),$e("add-note-modal"),ke.focus()}function ka(t,r){ke.value=t.note||"",ke.dispatchEvent(new Event("input",{bubbles:!0})),dt(e=>{t.note=e,oe(),_e(A.info.name,`یادداشت جلسه ${r} ذخیره شد.`,{type:"VIEW_SESSIONS"}),Ze(),V("✅یادداشت جلسه ذخیره شد.")}),$e("add-note-modal"),ke.focus()}function kt(t){je(t),ki.textContent=`تنظیمات کلاس: ${t.info.name}`,_t(),En(),Yi(),ye("settings-page")}function ji(t){const r=document.getElementById("log-modal-title"),e=document.getElementById("log-list");r.textContent=`گزارش فعالیت‌های کلاس: ${t}`,e.innerHTML="";const c=Cr(t);c.length===0?e.innerHTML='<li class="no-content-message">هنوز فعالیتی برای این کلاس ثبت نشده است.</li>':c.forEach(s=>{const n=document.createElement("li");n.className="log-entry";const i=new Date(s.timestamp),a=`${i.toLocaleDateString("fa-IR")} - ${i.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}`,o=document.createElement("span");o.className="log-timestamp",o.textContent=a;const l=document.createElement("span");l.className="log-message",l.textContent=s.message,s.action&&(l.classList.add("log-action-link"),l.dataset.action=JSON.stringify({...s.action,classroomName:s.classroomName})),n.appendChild(o),n.appendChild(l),e.appendChild(n)}),$e("log-modal")}document.getElementById("log-modal-close-btn").addEventListener("click",()=>{ge()});function qs(t){const r=URL.createObjectURL(t),e=document.createElement("a");e.href=r,e.download=t.name,document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(r),setTimeout(()=>{Ce("آیا فایل پشتیبان با موفقیت ذخیره شد؟",()=>{fa(),hs(),V("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله، ذخیره شد",cancelText:"خیر",confirmClass:"btn-success"})},500)}async function yn(t=[]){const r=await Xa(t);if(!r){V("❌ خطا در ایجاد فایل پشتیبان.");return}let e="پشتیبان کامل سیستم";if(t.length>0){const s=t.join("، ");e=`${t.length===1?"پشتیبان کلاس:":"پشتیبان کلاس‌های:"} ${s}`}hi(r,{name:r.name,description:e,version:"2.0-b64"}).catch(s=>console.error("Failed to save local snapshot:",s)),("ontouchstart"in window||navigator.maxTouchPoints>0)&&navigator.share&&navigator.canShare&&navigator.canShare({files:[r]})?Ce("فایل پشتیبان شما آماده است. آیا مایل به اشتراک‌گذاری آن هستید؟",()=>{try{navigator.share({title:r.name,text:"فایل پشتیبان داده‌های برنامه",files:[r]}).then(()=>{Ce("آیا فایل پشتیبان با موفقیت ارسال/ذخیره شد؟",()=>{fa(),hs(),V("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}catch(s){console.error("Error during sharing process:",s),qs(r),V("⚠️خطا در فرآیند اشتراک‌گذاری. فایل در حال دانلود است.")}},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"}):(qs(r),V("✅پشتیبان‌گیری با موفقیت انجام شد."))}function wn(t,r){t.preventDefault(),At(),qt=t.target.closest("li"),qt&&qt.classList.add("context-menu-target"),setTimeout(()=>{const e=zt,c=e.querySelector("ul");c.innerHTML="",r.forEach(l=>{const m=document.createElement("li");l.isSeparator?m.className="separator":(m.innerHTML=`
                    <span class="icon">${l.icon||""}</span>
                    <span class="label">${l.label}</span>
                `,l.className&&m.classList.add(l.className),m.addEventListener("click",()=>{l.action(),At()})),c.appendChild(m)}),e.classList.add("visible");const{offsetWidth:s,offsetHeight:n}=e,{innerHeight:i}=window,a=document.body.getBoundingClientRect();e.style.top=`${(i-n)/2}px`;const o=a.left+a.width/2;e.style.left=`${o-s/2}px`},50)}function At(){zt.classList.contains("visible")&&zt.classList.remove("visible"),qt&&(qt.classList.remove("context-menu-target"),qt=null)}function qi(){var e;Ut.innerHTML="";const t=document.getElementById("header-settings-btn");if(!t)return;const r=[];if(r.push({label:"کلاس‌ها",handler:()=>{je(null),Xe(null),Qe(null),ye("class-management-page")}}),A){r.push({label:A.info.name,handler:()=>{Xe(null),Qe(null),Ze(),ye("session-page")}});const c=(e=document.querySelector(".page.active"))==null?void 0:e.id;if(c==="session-page"?t.style.visibility="visible":t.style.visibility="hidden",c==="settings-page")r.push({label:"تنظیمات"});else if(K){const n=at(A).get(K.sessionNumber)||` (#${K.sessionNumber})`;r.push({label:`جلسه ${n}`,handler:()=>{Qe(null),Vt("selector")}}),Ie?r.push({label:`پروفایل: ${Ie.identity.name}`}):c==="session-dashboard-page"&&(document.getElementById("attendance-tab-btn").classList.contains("active")?r.push({label:"حضور و غیاب"}):r.push({label:"انتخابگر"}))}}else t.style.visibility="hidden";if(r.length<=1){Ut.style.display="none";return}Ut.style.display="flex",r.forEach((c,s)=>{const n=document.createElement("a");if(n.textContent=c.label,n.className="breadcrumb-item",s===r.length-1||!c.handler?n.classList.add("active"):n.addEventListener("click",c.handler),Ut.appendChild(n),s<r.length-1){const i=document.createElement("span");i.className="breadcrumb-separator",i.textContent="/",Ut.appendChild(i)}})}function Pa(t,r,e){e.innerHTML="";const c=A.sessions.filter(s=>{var n;return!s.isDeleted&&!s.isCancelled&&((n=s.studentRecords[t.identity.studentId])==null?void 0:n.attendance)==="absent"}).map(s=>({number:r.get(s.sessionNumber),isMakeup:s.isMakeup})).filter(s=>s.number!==void 0);c.length>0?(e.appendChild(document.createTextNode("جلسات غایب: ")),c.forEach((s,n)=>{const i=document.createElement("span");i.textContent=s.number,s.isMakeup&&i.classList.add("makeup-absence"),e.appendChild(i),n<c.length-1&&e.appendChild(document.createTextNode("، "))})):e.textContent="جلسات غایب: بدون غیبت"}function Pn(t,r,e,c={}){const{includePrefix:s=!0}=c;e.innerHTML="";const n=A.sessions.filter(i=>{if(i.isDeleted||i.isCancelled)return!1;const a=i.studentRecords[t.identity.studentId];return a&&a.homework&&(a.homework.status==="incomplete"||a.homework.status==="none")}).map(i=>({number:r.get(i.sessionNumber),status:i.studentRecords[t.identity.studentId].homework.status})).filter(i=>i.number!==void 0);n.length>0?(s&&e.appendChild(document.createTextNode("تکالیف ناقص: ")),n.forEach((i,a)=>{const o=document.createElement("span");o.textContent=i.number,i.status==="incomplete"&&o.classList.add("incomplete-homework"),e.appendChild(o),a<n.length-1&&e.appendChild(document.createTextNode("،"))})):s?e.textContent="تکالیف ناقص: ندارد":e.textContent="ندارد"}function No(t,r){var L,N,R;const e=document.createElement("li");e.className="attendance-list-item";const c=document.createElement("span");c.className="absence-info";const s=document.createElement("span");s.className="homework-info";const n=document.createElement("div");n.className="att-row-1";let i=!1;n.addEventListener("mousedown",()=>i=!1),n.addEventListener("touchstart",()=>i=!1,{passive:!0});const a=document.createElement("input");a.type="checkbox",a.className="mass-comment-checkbox",a.checked=$t.includes(t.identity.studentId),a.addEventListener("change",()=>{const j=t.identity.studentId,ee=$t;if(a.checked)ee.includes(j)||ee.push(j);else{const z=ee.indexOf(j);z>-1&&ee.splice(z,1)}Ea();const I=document.getElementById("attendance-list");ee.length===0&&I.classList.contains("selection-mode-active")&&I.classList.remove("selection-mode-active")});const o=document.createElement("span");o.className="student-name",o.textContent=t.identity.firstName&&t.identity.lastName?`${t.identity.lastName}، ${t.identity.firstName}`:t.identity.name,o.addEventListener("click",j=>{if(i){j.stopPropagation(),j.preventDefault(),i=!1;return}Fe(t)}),Dt(n,j=>{i=!0;const ee=document.getElementById("attendance-list");ee.classList.contains("selection-mode-active")||ee.classList.add("selection-mode-active"),a.checked||(a.checked=!0,a.dispatchEvent(new Event("change")))}),n.appendChild(a),n.appendChild(o);const l=document.createElement("div");l.className="att-row-2";const m=document.createElement("button");let p=!1;m.addEventListener("mousedown",()=>p=!1),m.addEventListener("touchstart",()=>p=!1,{passive:!0});const u=((L=K.studentRecords[t.identity.studentId])==null?void 0:L.attendance)||"present",h=j=>{j==="present"?(m.textContent="حاضر",m.className="attendance-status-btn present active"):(m.textContent="غایب",m.className="attendance-status-btn absent active")};h(u),m.addEventListener("click",j=>{var z;if(p){j.stopPropagation();return}const I=(((z=K.studentRecords[t.identity.studentId])==null?void 0:z.attendance)||"present")==="present"?"absent":"present";K.setAttendance(t.identity.studentId,I),I==="absent"&&(K.studentRecords[t.identity.studentId].hadIssue=!1),oe(),h(I),Pa(t,r,c),Ae(),Xi()}),Dt(m,()=>{p=!0;const j=u==="present"?"absent":"present",ee=j==="present"?"حاضر":"غایب";Ce(`آیا مطمئن هستید که می‌خواهید وضعیت حضور تمام دانش‌آموزان را به «${ee}» تغییر دهید؟`,()=>{Se(A.students).forEach(I=>{K.setAttendance(I.identity.studentId,j),j==="absent"&&(K.studentRecords[I.identity.studentId].hadIssue=!1)}),oe(),it(),V(`✅ وضعیت تمام دانش‌آموزان به «${ee}» تغییر یافت.`)},{confirmText:"بله، اعمال کن",confirmClass:"btn-warning"})});const y=document.createElement("div");y.className="homework-controls";const f={none:"بدون تکلیف",complete:"تکلیف کامل",incomplete:"تکلیف ناقص"},v=document.createElement("button");let b=!1;v.addEventListener("mousedown",()=>b=!1),v.addEventListener("touchstart",()=>b=!1,{passive:!0});const C=((N=K.studentRecords[t.identity.studentId])==null?void 0:N.homework.status)||"none";v.className=`homework-status-btn ${C}`,v.title=f[C],v.addEventListener("click",j=>{if(b){j.stopPropagation();return}const ee=K.studentRecords[t.identity.studentId].homework,z={none:"incomplete",incomplete:"complete",complete:"none"}[ee.status];K.setHomeworkStatus(t.identity.studentId,z),oe(),v.className=`homework-status-btn ${z}`,v.title=f[z],Pn(t,r,s)}),Dt(v,()=>{b=!0;const ee={none:"incomplete",incomplete:"complete",complete:"none"}[C],I=f[ee];Ce(`آیا از تغییر وضعیت تکلیف تمام دانش‌آموزان به «${I}» مطمئن هستید؟`,()=>{Se(A.students).forEach(z=>{K.setHomeworkStatus(z.identity.studentId,ee)}),oe(),it(),V(`✅ وضعیت تکلیف همه به «${I}» تغییر یافت.`)},{confirmText:"بله",confirmClass:"btn-warning"})});const S=document.createElement("button");let k=!1;S.addEventListener("mousedown",()=>k=!1),S.addEventListener("touchstart",()=>k=!1,{passive:!0}),S.className="btn-icon",S.innerHTML="📝",S.title="افزودن یادداشت برای تکلیف",((R=K.studentRecords[t.identity.studentId])==null?void 0:R.homework.comment)||(S.style.opacity="0.3"),S.addEventListener("click",j=>{if(k){j.stopPropagation();return}const ee=K.studentRecords[t.identity.studentId].homework;ke.value=ee.comment||"",ke.dispatchEvent(new Event("input",{bubbles:!0})),dt(I=>{ee.comment=I;const z=at(A),g=z.get(K.sessionNumber),H={type:"fromAttendance",sessionNumber:K.sessionNumber},fe=`یادداشت جلسه ${g}:
`,Z=t.profile.notes.find(me=>!me.isDeleted&&me.source&&me.source.type==="fromAttendance"&&me.source.sessionNumber===H.sessionNumber);Z?I?Z.content=fe+I:Z.isDeleted=!0:I&&t.addNote(fe+I,H),oe(),V("✅یادداشت تکلیف ذخیره شد."),S.style.opacity=I?"1":"0.3",Pn(t,z,s)}),$e("add-note-modal"),ke.focus()}),Dt(S,()=>{k=!0,Ce("آیا می‌خواهید برای **تمام** دانش‌آموزان کلاس یادداشت تکلیف ثبت کنید؟",()=>{const j=Se(A.students).map(ee=>ee.identity.studentId);hn(j),Sa()},{confirmText:"بله",confirmClass:"btn-primary"})}),l.appendChild(m),y.appendChild(S),y.appendChild(v),l.appendChild(y);const x=document.createElement("div");return x.className="att-row-3",Pa(t,r,c),Pn(t,r,s),x.appendChild(c),x.appendChild(s),e.appendChild(n),e.appendChild(l),e.appendChild(x),e}function Do(){return at(A).get(K.sessionNumber)}function it(){const t=Se(A.students),r=Cn(t);if(!A||!K)return;r.forEach(i=>{K.initializeStudentRecord(i.identity.studentId)}),hn([]);const e=at(A);Uo(),rn.innerHTML="";const c=document.createElement("li");c.className="attendance-list-header",Tt.id="attendance-search-input",Tt.type="text",Tt.className="inline-search-input",Tt.placeholder="جستجو...",Tt.value="";const s=document.createElement("div");s.className="student-search-container",s.appendChild(Tt);const n=document.createElement("div");n.className="header-labels-container",n.innerHTML=`
    <span class="header-label">تکلیف</span>
    <span class="header-label">حضور</span>
`,c.appendChild(s),c.appendChild(n),rn.appendChild(c),r.forEach(i=>{const a=No(i,e);rn.appendChild(a)}),hn([]),Ea(),jo(),Xi()}function Ae(){const t=document.getElementById("student-stats-table-container");if(!t||(t.innerHTML="",!A))return;Se(A.students).length,zs.textContent="آمار عملکرد";const r=["نام"],e=["کل انتخاب ها","غیبت","خروج","فرصت ازدست‌رفته","مشکل","میانگین","نمره نهایی"],c=A.categories.filter(h=>h.isGradedCategory&&!h.isDeleted).map(h=>h.name),s=[...r,...c,...e],n=document.createElement("table");n.className="student-stats-table";const a=n.createTHead().insertRow();s.forEach((h,y)=>{const f=document.createElement("th");y===0?(f.innerHTML=`${h} <span style="opacity: 0.6;">🔗</span>`,f.title="ردیف‌های این ستون قابل کلیک هستند"):f.textContent=h,a.appendChild(f)});const o=n.createTBody(),l=Cn(Se(A.students)),m=h=>{let y=0;return A.sessions.forEach(f=>{if(f.isDeleted||f.isCancelled)return;const v=f.studentRecords[h.identity.studentId];v&&v.attendance==="absent"&&y++}),y};l.forEach(h=>{const y=o.insertRow();if(y.dataset.studentId=h.identity.studentId,K){const k=K.studentRecords[h.identity.studentId];k&&k.attendance==="absent"&&y.classList.add("absent-row-highlight")}const f=y.insertCell(),v=document.createElement("span");v.textContent=`${h.identity.lastName}، ${h.identity.firstName}`,v.className="student-name-link",v.addEventListener("click",()=>{Fe(h)}),f.appendChild(v),c.forEach(k=>{var N;const _=y.insertCell();_.style.direction="ltr";const x=k.toLowerCase(),L=((N=h.logs.scores[x])==null?void 0:N.filter(R=>!R.isDeleted))||[];L.length>0?L.forEach((R,j)=>{const ee=document.createElement("span");ee.textContent=R.value+(R.comment?"'":""),ee.style.position="relative",R.comment&&(ee.dataset.tooltip=R.comment),_.appendChild(ee),j<L.length-1&&_.appendChild(document.createTextNode(","))}):_.textContent="",_.style.cursor="pointer",_.addEventListener("click",()=>{Oe(h,k);const R=document.getElementById("category-selection-container");R&&R.scrollIntoView({behavior:"smooth",block:"center"})})}),y.insertCell().textContent=h.statusCounters.totalSelections||0,y.insertCell().textContent=m(h),y.insertCell().textContent=h.statusCounters.outOfClassCount||0,y.insertCell().textContent=h.statusCounters.missedChances||0;const b=Object.values(h.categoryIssues||{}).reduce((k,_)=>k+_,0);y.insertCell().textContent=b;const C=h.getOverallAverageScore();y.insertCell().textContent=C!==null?C:"-";const S=A.calculateFinalStudentScore(h);y.insertCell().textContent=S!==null?S:"-"}),Se(A.students),zs.setAttribute("data-student-count",l.length),t.appendChild(n);const p=t.querySelector(".student-stats-table"),u=p==null?void 0:p.querySelector("thead th:first-child");u&&u.addEventListener("click",()=>{p.classList.toggle("name-column-expanded")})}function Oe(t=null,r=null){const e=document.getElementById("selected-student-result");e.innerHTML="";const c=document.querySelector(".current-winner-highlight");c&&c.classList.remove("current-winner-highlight"),e.classList.remove("absent");let s,n;if(t&&r)s=t,n=r,Zt({student:t,categoryName:r}),yt(-1);else{if(Zt(null),Jt(null),!K||Ve<0||!K.winnerHistory[Ve])return;const P=K.winnerHistory[Ve];s=P.winner,n=P.categoryName}if(s){const P=document.querySelector(`.student-stats-table tr[data-student-id="${s.identity.studentId}"]`);P&&P.classList.add("current-winner-highlight")}const i=A.categories.find(P=>P.name===n);if(i){Xn(i),Ia(i),Zi(i);const P=document.querySelectorAll("#category-selection-container .pill");P.forEach(O=>O.classList.remove("active"));const se=Array.from(P).find(O=>O.textContent===n);se&&se.classList.add("active"),vn(i),Jt(i.name)}const a=K.studentRecords[s.identity.studentId],o=(a==null?void 0:a.attendance)==="absent",l=document.createElement("div");l.className="winner-name-container";const m=document.createElement("button");m.className="btn-icon",m.innerHTML="˅",m.title="برنده قبلی";const p=!t;m.classList.toggle("is-disabled",!p||Ve<=0),m.addEventListener("click",()=>{m.classList.contains("is-disabled")?(m.classList.add("shake-animation"),setTimeout(()=>m.classList.remove("shake-animation"),200)):(yt(Ve-1),Oe())});const u=document.createElement("div");u.className="winner-name",u.innerHTML=`✨ <strong>${s.identity.name}</strong>✨`,u.classList.add("heartbeat-animation"),o&&(u.style.textDecoration="line-through",u.style.opacity="0.6",u.style.color="var(--color-secondary)"),(a==null?void 0:a.hadIssue)&&!o&&(u.style.color="var(--color-warning)",u.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"),(a==null?void 0:a.wasOutOfClass)&&!o&&(u.style.color="var(--color-strong-warning)",u.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود");const f=1e3,v=P=>{Yt=setTimeout(()=>{Yo(s,n),Yt=null},f)},b=()=>{Yt&&(clearTimeout(Yt),Yt=null)};u.addEventListener("mousedown",v),u.addEventListener("mouseup",b),u.addEventListener("mouseout",b),u.addEventListener("touchstart",v),u.addEventListener("touchmove",b),u.addEventListener("touchend",b),u.addEventListener("touchcancel",b);const C=document.createElement("button");if(C.className="btn-icon",C.innerHTML="˄",C.title="برنده بعدی",C.classList.toggle("is-disabled",!p||Ve>=K.winnerHistory.length-1),C.addEventListener("click",()=>{C.classList.contains("is-disabled")?(C.classList.add("shake-animation"),setTimeout(()=>C.classList.remove("shake-animation"),200)):(yt(Ve+1),Oe())}),l.appendChild(C),l.appendChild(u),s.onboardingSession===K.sessionNumber){const P=document.createElement("div");P.className="new-student-badge",P.textContent="دانش آموز جدید",l.appendChild(P)}l.appendChild(m),e.appendChild(l),Ye.disabled=p&&!C.classList.contains("is-disabled");const S=document.createElement("div");S.className="status-button-container";const k=document.createElement("button");k.textContent="غایب",k.classList.add("status-button","absent-btn"),o&&k.classList.add("active");const _=document.createElement("button");_.textContent="مشکل",_.classList.add("status-button","issue-btn"),a!=null&&a.hadIssue&&_.classList.add("active");const x=document.createElement("button");x.textContent="خروج",x.classList.add("status-button","exit-btn"),a!=null&&a.wasOutOfClass&&x.classList.add("active");const L=document.createElement("button");if(L.textContent="پروفایل",L.className="status-button profile-btn",K.isFinished?k.disabled=!0:k.addEventListener("click",()=>{const P=k.classList.contains("active");x.classList.contains("active")&&(x.classList.remove("active"),a.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),P?(k.classList.remove("active"),K.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),u.style.textDecoration="",u.style.opacity="",u.style.color=""):(_.classList.contains("active")&&(_.classList.remove("active"),a.hadIssue=!1,s.statusCounters.otherIssues=Math.max(0,s.statusCounters.otherIssues-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),k.classList.add("active"),K.setAttendance(s.identity.studentId,"absent"),s.statusCounters.missedChances++,u.style.textDecoration="line-through",u.style.opacity="0.6",u.style.color="var(--color-secondary)",u.title=""),Ae(),setTimeout(()=>{Ve!==-1?Oe():Oe(s,n)},0),oe()}),K.isFinished?_.disabled=!0:_.addEventListener("click",()=>{const P=_.classList.contains("active");if(x.classList.contains("active")&&(x.classList.remove("active"),a.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),P){_.classList.remove("active"),a.hadIssue=!1;const se=ze.name;s.categoryIssues[se]&&(s.categoryIssues[se]=Math.max(0,s.categoryIssues[se]-1)),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),u.style.color="",u.title=""}else{k.classList.contains("active")&&(k.classList.remove("active"),K.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),_.classList.add("active"),a.hadIssue=!0;const se=ze.name;s.categoryIssues[se]=(s.categoryIssues[se]||0)+1,s.statusCounters.missedChances++,u.style.textDecoration="",u.style.opacity="",u.style.color="var(--color-warning)",u.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"}Ae(),setTimeout(()=>{Ve!==-1?Oe():Oe(s,n)},0),oe()}),K.isFinished?x.disabled=!0:x.addEventListener("click",()=>{if(x.classList.contains("active"))x.classList.remove("active"),a.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),u.style.color="",u.title="";else{if(k.classList.contains("active")&&(k.classList.remove("active"),K.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),_.classList.contains("active")){_.classList.remove("active"),a.hadIssue=!1;const se=ze.name;s.categoryIssues[se]&&(s.categoryIssues[se]=Math.max(0,s.categoryIssues[se]-1)),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)}x.classList.add("active"),a.wasOutOfClass=!0,s.statusCounters.outOfClassCount=(s.statusCounters.outOfClassCount||0)+1,s.statusCounters.missedChances++,u.style.textDecoration="",u.style.opacity="",u.style.color="var(--color-strong-warning)",u.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود"}Ae(),setTimeout(()=>{Ve!==-1?Oe():Oe(s,n)},0),oe()}),K.isFinished?L.disabled=!0:L.addEventListener("click",()=>{Fe(s)}),S.appendChild(k),S.appendChild(x),S.appendChild(_),S.appendChild(L),e.appendChild(S),n){const P=Jo(s,n);e.appendChild(P)}const N=document.createElement("div");N.className="student-details-container";const R=document.createElement("div");R.className="student-details-scores",R.innerHTML="<h4>آخرین نمرات</h4>";const j=document.createElement("ul");j.className="scores-list";const ee=A.categories.filter(P=>P.isGradedCategory&&!P.isDeleted);let I=!1;const z=s.logs.scores||{};ee.forEach(P=>{var Be;const se=P.name,O=se.toLowerCase(),M=document.createElement("li"),de=document.createElement("span");de.className="skill-name",de.textContent=`${se}:`;const te=document.createElement("span");te.className="skill-scores";const Q=(Be=z[O])==null?void 0:Be.filter(Me=>!Me.isDeleted);if(Q&&Q.length>0){I=!0;const Me=Q.slice(-3);Me.forEach((he,we)=>{const Te=document.createElement("span");Te.textContent=he.value+(he.comment?"'":""),he.comment&&(Te.dataset.tooltip=he.comment,Te.style.position="relative",Te.style.cursor="help",Te.classList.add("tooltip-container")),te.appendChild(Te),we<Me.length-1&&te.appendChild(document.createTextNode(","))})}else te.textContent="none";M.appendChild(de),M.appendChild(te),j.appendChild(M)}),I||(j.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>'),R.appendChild(j),N.appendChild(R);const g=document.createElement("div");g.className="student-details-notes";const H=document.createElement("div");H.className="history-section-header";const fe=document.createElement("h4");fe.textContent="یادداشت‌ها";const Z=document.createElement("button");Z.className="btn-icon",Z.innerHTML="📝",Z.title="افزودن یادداشت جدید",K.isFinished?Z.disabled=!0:Z.addEventListener("click",()=>{ke.value="",ke.dispatchEvent(new Event("input",{bubbles:!0})),dt(P=>{P&&(s.addNote(P),oe(),Oe(),V("✅ یادداشت با موفقیت ثبت شد."))}),$e("add-note-modal"),ke.focus()}),H.appendChild(fe),H.appendChild(Z),g.appendChild(H);const me=document.createElement("ul");me.className="notes-list",s.profile.notes&&s.profile.notes.length>0?[...s.profile.notes].sort((se,O)=>new Date(O.timestamp)-new Date(se.timestamp)).forEach(se=>{const O=document.createElement("li");O.dir=us(se.content),O.textContent=se.content,me.appendChild(O)}):me.innerHTML='<div class="no-content-message">یادداشتی وجود ندارد.</div>',g.appendChild(me),N.appendChild(g),e.appendChild(N)}function _a(t){t.addEventListener("input",()=>{const r=t.value,e=us(r);t.setAttribute("dir",e)})}function Ao(){Ia(null),on.innerHTML="",Fs.innerHTML="",jt.classList.add("tooltip-container"),ht.disabled=!0,ct.disabled=!0,Rt.disabled=!0,ht.value="",ct.value="",Mt.classList.add("disabled-wrapper"),Ye.disabled=!0}function Fn(){on.innerHTML="",A.categories.filter(e=>!e.isDeleted).forEach(e=>{const c=document.createElement("span");c.className="pill",c.textContent=e.name,c.dataset.categoryId=e.id,e.description&&(c.dataset.tooltip=e.description),K.isFinished?c.classList.add("disabled"):c.addEventListener("click",()=>{document.querySelectorAll("#category-selection-container .pill").forEach(n=>n.classList.remove("active")),c.classList.add("active"),Xn(e),Ia(e),Zi(e),vn(e),Jt(e.name),Mt.classList.remove("disabled-wrapper"),Ye.disabled=K.isFinished;const s=K.lastWinnerByCategory[e.name];if(s){const n=A.students.find(i=>i.identity.studentId===s);n&&Oe(n,e.name)}else{Fs.innerHTML="",Zt(null),yt(-1),Ye.disabled=!1;const n=document.querySelector(".current-winner-highlight");n&&n.classList.remove("current-winner-highlight")}}),K.isFinished||c.addEventListener("contextmenu",s=>{wn(s,[{label:"تغییر نام",icon:"✏️",action:()=>{Us((i,a,o)=>{const l=ni(A,e,i);l.success?(e.isGradedCategory=a,e.weight=o,oe(),_e(A.info.name,`نام دسته‌بندی «${e.name}» به «${i}» تغییر یافت.`),Fn(),Ae(),V(`✅ نام دسته‌بندی به «${i}» تغییر یافت.`)):V(`⚠️ ${l.message}`)},{title:"ویرایش دسته‌بندی",initialName:e.name,initialIsGraded:e.isGradedCategory,initialWeight:e.weight||1,saveButtonText:"ذخیره تغییرات"})}},{label:"حذف دسته‌بندی",icon:"🗑️",className:"danger",action:()=>{Ce(`آیا از انتقال دسته‌بندی «${e.name}» به سطل زباله مطمئن هستید؟`,()=>{const i={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${e.name}» از کلاس «${A.info.name}»`,restoreData:{categoryId:e.id,classId:A.info.scheduleCode}};lt(i);const a=e.name.toLowerCase();if(A.students.forEach(o=>{o.logs.scores&&o.logs.scores[a]&&o.logs.scores[a].forEach(l=>{l.isDeleted=!0})}),ze&&ze.id===e.id){Xn(null),Fs.innerHTML="",vn(null),Jt(null),Mt.classList.add("disabled-wrapper"),Ye.disabled=!0;const o=document.querySelector(".current-winner-highlight");o&&o.classList.remove("current-winner-highlight")}e.isDeleted=!0,_e(A.info.name,`دسته‌بندی «${e.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),Fn(),Ae(),V(`✅ دسته‌بندی «${e.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}}])}),on.appendChild(c)});const r=document.createElement("span");r.className="pill add-category-pill",r.textContent="+",r.title="افزودن دسته‌بندی جدید",K.isFinished?r.classList.add("disabled"):r.addEventListener("click",()=>{Nt.checked=!1,document.getElementById("new-category-modal-weight-group").style.display="none",Us((e,c,s)=>{if(A.categories.find(a=>a.name.toLowerCase()===e.toLowerCase()&&!a.isDeleted)){V("⚠️ این دسته‌بندی از قبل وجود دارد.");return}const i=new gt(e,"",c,s);A.categories.push(i),oe(),_e(A.info.name,`دسته‌بندی جدید «${e}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),Fn(),V(`✅ دسته‌بندی «${e}» اضافه شد.`)},{initialWeight:1})}),on.appendChild(r)}function Oo(){if(K.lastUsedCategoryId){if(K.isFinished)return;const t=on.querySelector(`.pill[data-category-id="${K.lastUsedCategoryId}"]`);t&&t.click()}K.winnerHistory&&K.winnerHistory.length>0&&(yt(K.winnerHistory.length-1),Oe())}function Ia(t){t?Ye.textContent=`نفر بعدی در ${t.name}`:Ye.textContent="نفر بعدی"}function Zi(t){t&&t.isGradedCategory?(Mn.textContent=`ضریب: ${t.weight||1}`,Mn.style.display="block"):Mn.style.display="none"}function vn(t){if(K.isFinished){ht.disabled=!0,ct.disabled=!0,Rt.disabled=!0,jt.setAttribute("title","جلسه خاتمه یافته است");return}t&&t.isGradedCategory?(ht.disabled=!1,ct.disabled=!1,Rt.disabled=!1,jt.removeAttribute("title")):(ht.disabled=!0,ct.disabled=!0,Rt.disabled=!0,t?jt.setAttribute("title","برای این دسته‌بندی قابلیت نمره دهی تعریف نشده است"):jt.setAttribute("title","ابتدا یک دسته‌بندی را انتخاب کنید"))}function Jt(t){const r=document.querySelector(".student-stats-table");if(!r||(r.querySelectorAll(".current-category-highlight").forEach(i=>{i.classList.remove("current-category-highlight")}),!t))return;let c=-1;const s=r.querySelectorAll("thead th");if(s.forEach((i,a)=>{i.textContent.trim()===t&&(c=a)}),c===-1)return;s[c].classList.add("current-category-highlight"),r.querySelectorAll("tbody tr").forEach(i=>{const a=i.cells[c];a&&a.classList.add("current-category-highlight")})}function Fe(t){Qe(t);const r=document.getElementById("student-profile-modal"),e=document.getElementById("modal-profile-student-name"),c=document.getElementById("modal-profile-content-container"),s=document.getElementById("modal-profile-close-btn");if(!r||!e||!c||!s)return;e.textContent=`پروفایل: ${t.identity.name}`,e.style.cursor="pointer",e.onclick=()=>{const l=Ie,m=A;ge(()=>{rs(l,m)})},c.innerHTML="";const n=document.createElement("div");n.className="profile-header-actions";const i=document.createElement("button");i.className="btn-icon btn-icon-label",i.title="انتقال دانش‌آموز",i.innerHTML="<span>➡️</span><span>انتقال</span>",i.addEventListener("click",()=>{const l=Ie,m=A;ge(()=>{wa(l,m)})});const a=document.createElement("button");a.className="btn-icon btn-icon-label",a.title="حذف دانش‌آموز",a.innerHTML="<span>🗑️</span><span>حذف</span>",a.style.color="var(--color-strong-warning)",a.addEventListener("click",()=>{const l=Ie,m=A;ge(()=>{Ce(`آیا از انتقال دانش‌آموز «${l.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const p={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${l.identity.name}» از کلاس «${m.info.name}»`,restoreData:{studentId:l.identity.studentId,classId:m.info.scheduleCode}};lt(p),l.isDeleted=!0,_e(m.info.name,`دانش‌آموز «${l.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),_t(),Ae(),it(),V(`✅ دانش‌آموز «${l.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0,onCancel:()=>{Fe(l)}})})});const o=document.createElement("button");o.className="btn-icon btn-icon-label",o.title="افزودن یادداشت جدید",o.innerHTML="<span>📝</span><span>یادداشت</span>",o.addEventListener("click",()=>{const l=Ie;ke.value="",ke.dispatchEvent(new Event("input",{bubbles:!0})),dt(m=>{if(m)return l.addNote(m),oe(),_e(A.info.name,`یادداشت جدیدی برای دانش‌آموز «${l.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:l.identity.studentId}),Oe(),V("✅ یادداشت با موفقیت ثبت شد."),()=>Fe(l)}),ge(()=>{$e("add-note-modal"),ke.focus()})}),n.appendChild(i),n.appendChild(a),n.appendChild(o),c.appendChild(n),Mo(c),Gi(c),s.onclick=()=>ge(),$e("student-profile-modal")}function Mo(t){if(!Ie||!A)return;const r=document.createElement("div");r.className="scoring-section",r.innerHTML=`
    <h3>ثبت نمره جدید</h3>
    <div id="modal-graded-pills" class="category-pills"></div>
    <div class="input-group" style="margin-top: 15px; display: flex; gap: 10px;">
        <input type="number" id="modal-new-score-value" placeholder="نمره" style="width: 70px; text-align: center;">
        <input type="text" id="modal-new-score-comment" placeholder="توضیحات (اختیاری)..." style="flex-grow: 1;">
    </div>
    <button id="modal-add-score-btn" class="btn-success" style="width: 100%; margin-top: 10px;">ثبت نمره</button>
`,_a(r.querySelector("#modal-new-score-comment"));const e=r.querySelector("#modal-graded-pills");Se(A.categories).filter(n=>n.isGradedCategory).forEach(n=>{const i=document.createElement("span");i.className="pill",i.textContent=n.name,i.dataset.skillName=n.name,i.addEventListener("click",()=>{e.querySelectorAll(".pill").forEach(a=>a.classList.remove("active")),i.classList.add("active")}),e.appendChild(i)}),r.querySelector("#modal-add-score-btn").addEventListener("click",()=>{const n=e.querySelector(".pill.active");if(!n){V("⚠️لطفاً یک مهارت را برای نمره‌دهی انتخاب کنید.");return}const i=n.dataset.skillName,a=r.querySelector("#modal-new-score-value"),o=r.querySelector("#modal-new-score-comment"),l=a.value,m=o.value.trim();if(!l){V("لطفاً مقدار نمره را وارد کنید.");return}Ie.addScore(i,parseFloat(l),m),oe(),_e(A.info.name,`نمره ${l} در ${i} برای «${Ie.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:Ie.identity.studentId}),Ae(),Oe(),a.value="",o.value="";const p=document.getElementById("modal-profile-content-container"),u=p.querySelector(".history-section");u&&u.remove(),Gi(p),V(`✅ نمره برای مهارت ${i} با موفقیت ثبت شد.`)}),t.appendChild(r)}function Gi(t){if(!Ie)return;const r=document.createElement("div");r.className="history-section";const e=document.createElement("div");e.className="history-section-header";const c=document.createElement("h3");c.textContent="سوابق دانش‌آموز",e.appendChild(c),r.appendChild(e),Ro(r),Vi(r),Ji(r),t.appendChild(r)}function Ro(t){if(!Ie)return;const r=Ie,e=A.sessions.reduce((k,_)=>{const x=_.studentRecords[r.identity.studentId];return k+(x&&x.attendance==="absent"?1:0)},0),c=Object.values(r.categoryIssues||{}).reduce((k,_)=>k+_,0);let s=0,n=0,i=0;const a=r.qualitativeStats||{};Object.values(a).forEach(k=>{s+=k.effort||0,n+=k.good||0,i+=k.excellent||0});const o=s+n+i,l=document.createElement("div");l.className="stats-summary-box",l.innerHTML=`
        <p><strong>کل انتخاب:</strong> ${r.statusCounters.totalSelections}</p>
        <p><strong>غیبت:</strong> ${e}</p>
        <p><strong>فرصت از دست رفته:</strong> ${r.statusCounters.missedChances||0}</p>
        <p><strong>مشکل:</strong> ${c}</p>
        <p><strong>عملکرد کیفی:</strong> ${o}</p>
    `,t.appendChild(l),l.querySelector("p:nth-child(1)");const m=l.querySelector("p:nth-child(4)"),p=l.querySelector("p:nth-child(5)");t.appendChild(l);const u=Se(A.categories),h=document.createElement("div");if(h.className="stats-breakdown",u.length>0){u.forEach(_=>{var R;const x=_.name,L=((R=r.categoryCounts)==null?void 0:R[x])||0,N=document.createElement("p");N.className="stats-breakdown-item",N.innerHTML=`<strong>${x}:</strong> ${L}`,h.appendChild(N)});const k=l.querySelector("p:first-child");k&&(k.classList.add("collapsible-toggle"),k.onclick=()=>{h.classList.toggle("open"),k.classList.toggle("open")},k.after(h))}const y=document.createElement("div");y.className="stats-breakdown",u.length>0&&(u.forEach(k=>{var N;const _=k.name,x=((N=r.categoryIssues)==null?void 0:N[_])||0,L=document.createElement("p");L.className="stats-breakdown-item",L.innerHTML=`<strong>${_}:</strong> ${x}`,y.appendChild(L)}),m&&(m.classList.add("collapsible-toggle"),m.onclick=()=>{y.classList.toggle("open"),m.classList.toggle("open")},l.appendChild(y)));const f=document.createElement("div");if(f.className="stats-breakdown",o>0){for(const k in a){const _=a[k];if((_.effort||0)+(_.good||0)+(_.excellent||0)>0){const L=document.createElement("p");L.className="stats-breakdown-item",L.innerHTML=`<strong>${k}:</strong> <span style="color:var(--color-primary)">عالی:${_.excellent}</span> | <span style="color:var(--color-success)">خوب:${_.good}</span> | <span style="color:#fd7e14">تلاش:${_.effort}</span>`,f.appendChild(L)}}p&&(p.classList.add("collapsible-toggle"),p.onclick=()=>{f.classList.toggle("open"),p.classList.toggle("open")},l.appendChild(f))}const v=document.createElement("p"),b=document.createElement("strong");b.textContent="تکالیف ناقص:";const C=document.createElement("span");C.style.marginRight="5px";const S=at(A);Pn(r,S,C,{includePrefix:!1}),v.appendChild(b),v.appendChild(C),l.appendChild(v)}function Vi(t){if(!Ie)return;const r=Ie,e=document.createElement("h4");e.textContent="تاریخچه نمرات:",e.style.marginTop="20px";const c=document.createElement("ul");c.className="list-container";const s=Object.values(r.logs.scores||{}).flat().filter(n=>!n.isDeleted).sort((n,i)=>new Date(i.timestamp)-new Date(n.timestamp));s.length===0?c.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>':s.forEach(n=>{const i=document.createElement("li");i.className="score-history-item";const a=document.createElement("div");a.className="item-content";const o=document.createElement("div");o.className="score-info";const l=document.createElement("span");l.className="score-skill-badge",l.textContent=n.skill;const m=document.createElement("span");m.className="score-value",m.textContent=`نمره: ${n.value}`;const p=document.createElement("span");if(p.className="score-date",p.textContent=new Date(n.timestamp).toLocaleDateString("fa-IR"),o.appendChild(l),o.appendChild(m),o.appendChild(p),a.appendChild(o),n.comment){const h=document.createElement("p");h.className="score-comment",h.innerHTML=pa(n.comment),h.addEventListener("click",()=>{ke.value=n.comment,ke.dispatchEvent(new Event("input",{bubbles:!0})),dt(y=>{n.comment=y,oe(),_e(A.info.name,`توضیحات نمره ${n.value} (${n.skill}) برای دانش‌آموز «${r.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:r.identity.studentId}),Fe(r),V("✅ توضیحات نمره با موفقیت ویرایش شد.")}),ge(()=>{$e("add-note-modal"),ke.focus()})}),a.appendChild(h)}const u=document.createElement("button");u.className="btn-icon delete-item-btn",u.innerHTML="🗑️",u.title="حذف این نمره",u.addEventListener("click",()=>{ge(()=>{Ce(`آیا از انتقال نمره ${n.value} در مهارت «${n.skill}» به سطل زباله مطمئن هستید؟`,()=>{const h={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"score",description:`نمره ${n.value} (${n.skill}) برای «${r.identity.name}»`,restoreData:{scoreId:n.id,skill:n.skill,studentId:r.identity.studentId,classId:A.info.scheduleCode}};lt(h),n.isDeleted=!0,oe(),_e(A.info.name,`نمره ${n.value} (${n.skill}) دانش‌آموز «${r.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),Fe(r),V("✅ نمره به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{Fe(r)}})})}),i.appendChild(a),i.appendChild(u),c.appendChild(i)}),t.appendChild(e),t.appendChild(c)}function Ji(t){if(!Ie)return;const r=document.createElement("h4");r.textContent="تاریخچه یادداشت‌ها:",r.style.marginTop="20px";const e=document.createElement("ul");e.className="list-container",!Ie.profile.notes||Ie.profile.notes.length===0?e.innerHTML='<div class="no-content-message">هنوز یادداشتی ثبت نشده است.</div>':[...Ie.profile.notes].filter(s=>!s.isDeleted).sort((s,n)=>new Date(n.timestamp)-new Date(s.timestamp)).forEach(s=>{const n=document.createElement("li");n.className="note-history-item";const i=document.createElement("div");i.className="item-content";const a=document.createElement("div");a.className="note-info";const o=document.createElement("span");o.className="note-date",o.textContent=new Date(s.timestamp).toLocaleDateString("fa-IR");const l=document.createElement("button");l.className="btn-icon delete-item-btn",l.innerHTML="🗑️",l.title="حذف این یادداشت",l.addEventListener("click",()=>{const p=Ie;ge(()=>{Ce("آیا از انتقال این یادداشت به سطل زباله مطمئن هستید؟",()=>{const u={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"note",description:`یادداشت برای دانش‌آموز «${p.identity.name}»`,restoreData:{noteId:s.id,studentId:p.identity.studentId,classId:A.info.scheduleCode}};lt(u),s.isDeleted=!0,_e(A.info.name,`یادداشت دانش‌آموز «${p.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),Fe(p),V("✅ یادداشت به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{Fe(p)}})})}),a.appendChild(o),a.appendChild(l);const m=document.createElement("p");m.className="note-content",m.innerHTML=pa(s.content),m.addEventListener("click",()=>{const p=Ie;ke.value=s.content,ke.dispatchEvent(new Event("input",{bubbles:!0})),dt(u=>{s.content=u,oe(),_e(A.info.name,`یادداشت دانش‌آموز «${p.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:p.identity.studentId}),Fe(p),V("✅یادداشت با موفقیت ویرایش شد.")}),ge(()=>{$e("add-note-modal"),ke.focus()})}),i.appendChild(a),i.appendChild(m),n.appendChild(i),e.appendChild(n)}),t.appendChild(r),t.appendChild(e)}function Ki(t){Ms.innerHTML="",t.forEach((r,e)=>{const c=document.createElement("option");c.value=e,c.textContent=r.trim(),Ms.appendChild(c)})}function Zs(){Os.innerHTML="",Ks.forEach(t=>{const r=document.createElement("li");r.className="preview-item";const e=document.createElement("input");e.type="checkbox",e.checked=!0,e.dataset.name=t;const c=document.createElement("label");c.textContent=t,r.appendChild(e),r.appendChild(c),Os.appendChild(r)})}function zo(t){const r=document.createElement("div");r.className="list-item-buttons";const e=document.createElement("button");return e.className="btn-icon",e.innerHTML="📝",e.title="ویرایش یادداشت کلاس",t.note||(e.style.display="none"),e.addEventListener("click",c=>{c.stopPropagation(),ms(t)}),r.appendChild(e),r}function $o(t){const r=document.createElement("div");r.style.flexGrow="1",r.style.display="flex",r.style.flexDirection="column",r.style.alignItems="flex-start";const e=document.createElement("span");e.textContent=t.info.name,e.classList.add("class-name-display"),r.appendChild(e);const c=Se(t.students).length,s=Se(t.sessions).filter(l=>l.isFinished).length,n=Zo(t.info.scheduleDays),i=document.createElement("div");i.classList.add("class-stats-row");const a=document.createElement("span");a.textContent=`${c} نفر`,a.classList.add("student-count-badge"),i.appendChild(a);const o=document.createElement("span");if(o.textContent=`${s} جلسه`,o.classList.add("session-count-badge"),i.appendChild(o),n){const l=document.createElement("span");l.textContent=n,l.classList.add("schedule-days-badge"),i.appendChild(l)}return r.appendChild(i),r.addEventListener("click",()=>{je(t),Xe(null),fn(A.liveSession),Ze(),ye("session-page")}),r}function Po(t){const r=document.createElement("li");os(t).type==="active"&&(r.classList.add("active-class-card"),r.title="این کلاس هم‌اکنون در حال برگزاری است");const c=document.createElement("input");c.type="checkbox",c.className="mass-selection-checkbox",c.checked=nt.includes(t.info.name),c.addEventListener("click",m=>{m.stopPropagation()}),c.addEventListener("change",()=>{const m=t.info.name;if(c.checked)nt.includes(m)||nt.push(m);else{const p=nt.indexOf(m);p>-1&&nt.splice(p,1)}}),r.appendChild(c);const s=$o(t);r.appendChild(s);const n=document.createElement("div");n.style.display="flex",n.style.flexDirection="column",n.style.gap="5px",n.style.alignItems="flex-end",n.style.marginLeft="10px";const i=document.createElement("div");if(i.className="list-item-badges",t.liveSession&&!t.liveSession.isCancelled&&!t.liveSession.isDeleted){const m=document.createElement("span");m.className="warning-badge",m.textContent="جلسه باز",i.appendChild(m),r.classList.add("has-unfinished-session")}const a=document.createElement("span");if(a.className=`type-badge ${t.info.type}`,a.textContent=t.info.type==="online"?"آنلاین":"حضوری",a.title="نوع کلاس",i.appendChild(a),os(t).type==="incomplete"){const m=document.createElement("span");m.className="type-badge cancelled-badge",m.textContent="زمان‌بندی ناقص",m.style.cursor="pointer",m.title="برای تکمیل زمان‌بندی کلیک کنید",m.addEventListener("click",p=>{p.stopPropagation(),Ce("زمان‌بندی این کلاس کامل نیست. برای نمایش صحیح در لیست، لطفاً روزها و ساعت برگزاری را مشخص کنید.",()=>{kt(t)},{confirmText:"تنظیمات",confirmClass:"btn-primary"})}),i.appendChild(m)}else{const m=qo(t,re);if(m){const p=document.createElement("span");p.className="type-badge conflict-badge",p.textContent="تداخل زمانی",p.style.cursor="pointer",p.title=`تداخل با کلاس: ${m}`,p.addEventListener("click",u=>{u.stopPropagation(),Ce(`زمان برگزاری این کلاس با کلاس «${m}» تداخل دارد. لطفاً زمان‌بندی را بررسی کنید.`,()=>{kt(t)},{confirmText:"تنظیمات",confirmClass:"btn-primary"})}),i.appendChild(p)}}n.appendChild(i);const l=zo(t);return n.appendChild(l),r.appendChild(n),r.addEventListener("contextmenu",m=>{const p={label:"پشتیبان‌گیری از این کلاس",icon:"📤",action:()=>{yn([t.info.name])}},u=nt.length;u>1&&nt.includes(t.info.name)&&(p.label=`پشتیبان‌گیری از ${u} کلاس`,p.action=()=>{yn(nt),An([]),He()});const h={label:"حذف کلاس",icon:"🗑️",className:"danger",action:()=>{Ce(`آیا از انتقال کلاس «${t.info.name}» به سطل زباله مطمئن هستید؟`,()=>{const f={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"classroom",description:`کلاس «${t.info.name}»`,restoreData:{name:t.info.name}};lt(f),t.isDeleted=!0,_e(t.info.name,`کلاس «${t.info.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),He(),V(`✅ کلاس «${t.info.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}};u>1&&nt.includes(t.info.name)&&(h.label=`حذف ${u} کلاس`,h.action=()=>{Ce(`آیا از انتقال ${u} کلاس انتخاب شده به سطل زباله مطمئن هستید؟`,()=>{nt.forEach(f=>{const v=re[f];if(v&&!v.isDeleted){const b={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"classroom",description:`کلاس «${v.info.name}»`,restoreData:{name:v.info.name}};lt(b),v.isDeleted=!0,_e(v.info.name,`کلاس «${v.info.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"})}}),An([]),oe(),He(),V(`✅ ${u} کلاس به سطل زباله منتقل شدند.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})});const y=[{label:"چاپ گزارش کلاس",icon:"🖨️",action:()=>{Vo(t)}},{label:Ot.classList.contains("selection-mode-active")?"لغو انتخاب":"انتخاب چند کلاس",icon:"✔️",action:()=>{const f=Ot.classList.contains("selection-mode-active");Ot.classList.toggle("selection-mode-active"),f&&(An([]),He())}},p,{label:"یادداشت کلاس",icon:"📝",action:()=>{ms(t)}},{label:"تنظیمات کلاس",icon:"⚙️",action:()=>{kt(t)}},{label:"گزارش فعالیت‌ها",icon:"📋",action:()=>{ji(t.info.name)}},{label:"تغییر نام",icon:"✏️",action:()=>{const f=t.info.name,v=document.getElementById("add-note-modal-title");v.textContent="تغییر نام کلاس",ke.value=f,ke.rows=1,dt(b=>{const C=b.trim();if(C&&C!==f){const S=ti(f,C);S.success?(wr(f,C),_e(C,`نام کلاس از «${f}» به «${C}» تغییر یافت.`,{type:"VIEW_SESSIONS"}),oe(),He(),V(`✅نام کلاس به «${C}» تغییر یافت.`)):V(S.message)}v.textContent="ثبت یادداشت جدید",ke.rows=4}),$e("add-note-modal"),ke.focus(),ke.select()}},h];wn(m,y)}),r}function hs(){const t=document.getElementById("class-management-stats");if(!t)return;const r=Object.values(re).filter(n=>!n.isDeleted),e=r.length,c=r.reduce((n,i)=>n+Se(i.students).length,0);let s="";Pe.lastBackupTimestamp&&(s=`
            <div class="stats-row backup-stat">
                <span>آخرین پشتیبان: <strong>${new Date(Pe.lastBackupTimestamp).toLocaleString("fa-IR",{year:"numeric",month:"numeric",day:"numeric",weekday:"long",hour:"2-digit",minute:"2-digit"})}</strong></span>
            </div>
        `),t.innerHTML=`
        <div class="stats-row main-stats">
            <span>کل کلاس‌ها: <strong>${e}</strong></span>
            <span>|</span>
            <span>کل دانش‌آموزان: <strong>${c}</strong></span>
        </div>
        ${s} 
    `}function He(){hs(),Ot.innerHTML="";const t=Object.values(re).filter(s=>!s.isDeleted),r=document.querySelector(".fab-container"),e=document.querySelector(".global-search-container");if(t.length===0){r&&r.classList.add("center-empty-state"),e&&(e.style.display="none"),Ot.innerHTML='<li class="no-content-message" style="text-align:center; margin-top:20px;">هنوز کلاسی ایجاد نشده است.</li>';return}else r&&r.classList.remove("center-empty-state"),e&&(e.style.display="");t.sort((s,n)=>{const i=os(s),a=os(n);return i.sortIndex!==a.sortIndex?i.sortIndex-a.sortIndex:i.type==="upcoming"?i.nextTimestamp-a.nextTimestamp:new Date(s.info.creationDate)-new Date(n.info.creationDate)}).forEach(s=>{const n=Po(s);Ot.appendChild(n)})}function _t(){if(!A)return;Ds.innerHTML="";const t=Se(A.students);Cn(t).forEach(e=>{const c=document.createElement("li");c.dataset.studentId=e.identity.studentId;const s=document.createElement("span");s.className="student-name-link",s.style.flexGrow="1",e.identity.firstName&&e.identity.lastName?s.textContent=`${e.identity.lastName}، ${e.identity.firstName}`:s.textContent=e.identity.name,s.addEventListener("click",()=>{Fe(e)}),Dt(c,n=>{rs(e,A)}),c.addEventListener("contextmenu",n=>{wn(n,[{label:"تغییر نام",icon:"✏️",action:()=>{rs(e,A)}},{label:"انتقال دانش‌آموز",icon:"➡️",action:()=>{wa(e,A)}},{label:"حذف دانش‌آموز",icon:"🗑️",className:"danger",action:()=>{Ce(`آیا از انتقال دانش‌آموز «${e.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const a={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${e.identity.name}» از کلاس «${A.info.name}»`,restoreData:{studentId:e.identity.studentId,classId:A.info.scheduleCode}};lt(a),e.isDeleted=!0,_e(A.info.name,`دانش‌آموز «${e.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),_t(),Ae(),it(),V(`✅ دانش‌آموز «${e.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}}])}),c.appendChild(s),Ds.appendChild(c)})}function En(){if(As.innerHTML="",!A)return;A.categories.filter(r=>!r.isDeleted).forEach(r=>{const e=document.createElement("li"),c=document.createElement("div");c.className="name-and-badge-container";const s=document.createElement("span");if(s.textContent=r.name,c.appendChild(s),r.isGradedCategory){const i=document.createElement("span");i.className="category-badge",i.textContent="نمره‌دار",c.appendChild(i)}if(r.isGradedCategory){const i=document.createElement("span");i.className="category-badge weight-badge",i.textContent=`ضریب: ${r.weight||1}`,c.appendChild(i)}const n=document.createElement("button");n.className="btn-icon",n.innerHTML="🗑️",n.style.color="var(--color-warning)",n.addEventListener("click",()=>{Ce(`آیا از انتقال دسته‌بندی «${r.name}» به سطل زباله مطمئن هستید؟`,()=>{const i={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${r.name}» از کلاس «${A.info.name}»`,restoreData:{categoryId:r.id,classId:A.info.scheduleCode}};lt(i),r.isDeleted=!0,_e(A.info.name,`دسته‌بندی «${r.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),En(),V(`✅ دسته‌بندی «${r.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}),e.appendChild(c),e.appendChild(n),As.appendChild(e)})}function Yi(){if(!A)return;const t=A;xa($n,tn,t.info.educationalSystem,t.info.level),$n.addEventListener("change",()=>{t.info.educationalSystem=$n.value,t.info.level=tn.value,oe()}),tn.addEventListener("change",()=>{t.info.level=tn.value,oe()});const r=t.info.type||"in-person",e=document.querySelector(`#settings-page input[name="class-type-setting"][value="${r}"]`);e&&(e.checked=!0);const c=t.info.scheduleDays||[];document.querySelectorAll('input[name="schedule-day"]').forEach(s=>{s.checked=c.includes(parseInt(s.value))}),document.getElementById("settings-schedule-start").value=t.info.scheduleStartTime||"",document.getElementById("settings-schedule-end").value=t.info.scheduleEndTime||""}function dn(t){document.querySelectorAll(".page").forEach(e=>{e.classList.remove("active")});const r=document.getElementById(t);r&&r.classList.add("active"),t==="class-management-page"?(je(null),Xe(null),Qe(null),He(),Rs.style.display="flex"):Rs.style.display="none",qi()}function ye(t,r={}){const{tab:e}=r,c={pageId:t,currentClassName:A?A.info.name:null,selectedSessionNumber:K?K.sessionNumber:null,selectedStudentId:Ie?Ie.identity.studentId:null};let s=`#${t}`;const n=new URLSearchParams(window.location.hash.split("?")[1]||"");A?n.set("class",A.info.name):n.delete("class"),K?n.set("session",K.sessionNumber):n.delete("session"),Ie?n.set("student",Ie.identity.studentId):n.delete("student"),t==="session-dashboard-page"&&e?n.set("tab",e):t!=="session-dashboard-page"&&n.delete("tab");const i=n.toString();i&&(s+=`?${i}`),window.location.hash!==s&&history.pushState(c,"",s),dn(t)}function Fo(t,r){const e=document.createElement("div");e.className="list-item-buttons",e.style.gap="10px";const c=document.createElement("button");if(c.className="btn-icon",c.innerHTML="📝",c.title="ویرایش یادداشت جلسه",t.note||(c.style.display="none"),c.addEventListener("click",s=>{s.stopPropagation(),ka(t,r)}),!t.isFinished&&!t.isCancelled){const s=document.createElement("button");s.className="btn-success",s.textContent="پایان جلسه",s.style.fontSize="12px",s.style.padding="4px 10px",s.style.whiteSpace="nowrap",s.addEventListener("click",n=>{n.stopPropagation(),Ce(`جلسه شماره ${r} خاتمه پیدا خواهد کرد!`,()=>{A.endSpecificSession(t.sessionNumber),oe(),_e(A.info.name,`جلسه ${r} خاتمه یافت.`,{type:"VIEW_SESSIONS"}),Ze(),Ce("جلسه با موفقیت خاتمه یافت. آیا مایل به ایجاد فایل پشتیبان هستید؟",()=>{if(ft){V("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است.");return}yn(),V("✅فایل پشتیبان با موفقیت ایجاد شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}),e.appendChild(s)}return e.appendChild(c),e}function Ho(t,r){const e=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="flex-start",e.style.flexGrow="1";const c=new Date(t.startTime).toLocaleDateString("fa-IR"),s=document.createElement("span");s.className="session-list-title";const n=document.createElement("div");n.style.display="flex",n.style.gap="5px",n.style.marginTop="5px";const i=new Date(t.startTime).toLocaleDateString("fa-IR",{weekday:"long"}),a=document.createElement("span");if(a.className="type-badge day-badge",a.textContent=i,n.appendChild(a),t.isCancelled){s.textContent=`لغو شده - تاریخ: ${c}`,e.style.cursor="default";const o=document.createElement("span");o.className="type-badge cancelled-badge",o.textContent="لغو شده",n.appendChild(o)}else s.textContent=`جلسه ${r} - تاریخ: ${c}`,e.style.cursor="pointer",e.addEventListener("click",()=>{Xe(t),Vt()});if(e.appendChild(s),t.isFinished){const o=document.createElement("span");o.className="type-badge finished-badge",o.textContent="خاتمه یافته",n.appendChild(o)}if(t.isMakeup){const o=document.createElement("span");o.className="type-badge makeup-badge",o.textContent="جبرانی",n.appendChild(o)}return e.appendChild(n),e}function Wo(t,r){const e=document.createElement("li"),c=r.get(t.sessionNumber),s=Ho(t,c);e.appendChild(s);const n=Fo(t,c);return e.appendChild(n),e.addEventListener("contextmenu",i=>{const a=[{label:"یادداشت جلسه",icon:"📝",action:()=>{ka(t,c)}},{label:t.isCancelled?"بازگردانی جلسه":"لغو جلسه",icon:"❌",action:()=>{const o=t.isCancelled?"بازگردانی جلسه":"لغو جلسه",l=t.isCancelled?"آیا از بازگردانی این جلسه مطمئن هستید؟":"آیا از لغو این جلسه مطمئن هستید؟ جلسه لغو شده در آمار تاثیری ندارد اما قابل بازگردانی است.";Ce(l,()=>{t.isCancelled=!t.isCancelled;const m=t.isCancelled?`جلسه ${c} لغو شد.`:`جلسه لغو شده (تاریخ: ${new Date(t.startTime).toLocaleDateString("fa-IR")}) بازگردانی شد.`;_e(A.info.name,m,{type:"VIEW_SESSIONS"}),oe(),Ze(),V(t.isCancelled?"✅جلسه لغو شد.":"✅جلسه بازگردانی شد.")},{confirmText:o,confirmClass:"btn-warning"})}},{label:"تغییر وضعیت جبرانی",icon:"🔄",action:()=>{A.markAsMakeup(t.sessionNumber),oe();const o=t.isMakeup?`جلسه ${c} به عنوان جبرانی علامت‌گذاری شد.`:`جلسه ${c} از حالت جبرانی خارج شد.`;_e(A.info.name,o,{type:"VIEW_SESSIONS"}),Ze()}},{label:"حذف جلسه",icon:"🗑️",className:"danger",action:()=>{const o=t.isCancelled?"لغو شده":c;Ce(`آیا از انتقال جلسه ${o} به سطل زباله مطمئن هستید؟`,()=>{const l={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"session",description:`جلسه ${o} از کلاس «${A.info.name}»`,restoreData:{sessionNumber:t.sessionNumber,classId:A.info.scheduleCode}};lt(l),t.isDeleted=!0,_e(A.info.name,`جلسه ${o} به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),Ze(),V(`✅ جلسه ${o} به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}},{label:"تغییر تاریخ",icon:"📅",action:()=>{const o=document.getElementById("dp-day"),l=document.getElementById("dp-month"),m=document.getElementById("dp-year"),p=$a.toJalaali(t.startTime);o.innerHTML="";for(let y=1;y<=31;y++){const f=document.createElement("option");f.value=y,f.textContent=y.toLocaleString("fa-IR"),y===p.jd&&(f.selected=!0),o.appendChild(f)}const u=["فروردین","اردیبهشت","خرداد","تیر","مرداد","شهریور","مهر","آبان","آذر","دی","بهمن","اسفند"];l.innerHTML="",u.forEach((y,f)=>{const v=document.createElement("option");v.value=f+1,v.textContent=y,f+1===p.jm&&(v.selected=!0),l.appendChild(v)}),m.innerHTML="";const h=p.jy;for(let y=h-5;y<=h+5;y++){const f=document.createElement("option");f.value=y,f.textContent=y.toString().replace(/\d/g,v=>"۰۱۲۳۴۵۶۷۸۹"[v]),y===p.jy&&(f.selected=!0),m.appendChild(f)}Qn(y=>{if(!y)return;const f=$a.toGregorian(parseInt(y.jy),parseInt(y.jm),parseInt(y.jd)),v=new Date(f.gy,f.gm-1,f.gd);v.setHours(t.startTime.getHours()),v.setMinutes(t.startTime.getMinutes()),v.setSeconds(t.startTime.getSeconds());const b=t.startTime.toLocaleDateString("fa-IR");t.startTime=v;const C=t.startTime.toLocaleDateString("fa-IR");_e(A.info.name,`تاریخ جلسه ${c} از ${b} به ${C} تغییر یافت.`,{type:"VIEW_SESSIONS"}),oe(),Ze(),V(`✅ تاریخ جلسه به ${C} تغییر یافت.`)}),$e("date-picker-modal")}}];wn(i,a)}),e}function Ze(){const t=document.getElementById("session-list");if(!A)return;if(t.innerHTML="",A.sessions.length===0){t.innerHTML="<li>هنوز جلسه‌ای شروع نشده است.</li>";return}const r=at(A);[...Se(A.sessions)].reverse().forEach(c=>{const s=Wo(c,r);t.appendChild(s)})}function sn(t){if(Ct.innerHTML="",t.length>0)t.forEach(r=>{const e=document.createElement("div");e.textContent=r.identity.name,e.addEventListener("click",()=>{Fe(r),Ct.style.display="none",Ps.value=""}),Ct.appendChild(e)}),Ct.style.display="block";else if(Ps.value.trim()!==""){const r=document.createElement("div");r.className="no-results",r.textContent="پیدا نشد",Ct.appendChild(r),Ct.style.display="block"}else Ct.style.display="none"}function Hn(t){if(ut.innerHTML="",t.length>0)t.forEach(r=>{const e=document.createElement("div");if(e.className="global-search-result",r.type==="student"){const c=document.createElement("span");c.className="student-name",c.textContent=r.student.identity.name;const s=document.createElement("span");s.className="class-name",s.textContent=`کلاس: ${r.classroom.info.name}`,e.addEventListener("click",()=>{je(r.classroom),Fe(r.student),ut.style.display="none",en.value=""}),s.addEventListener("click",n=>{n.stopPropagation(),je(r.classroom),Xe(null),fn(r.classroom.liveSession),Ze(),ye("session-page"),ut.style.display="none",en.value=""}),e.appendChild(c),e.appendChild(s)}else if(r.type==="classroom"){const c=document.createElement("span");c.className="student-name",c.textContent=`[کلاس] ${r.classroom.info.name}`,e.addEventListener("click",()=>{je(r.classroom),Xe(null),fn(r.classroom.liveSession),Ze(),ye("session-page"),ut.style.display="none",en.value=""}),e.appendChild(c)}ut.appendChild(e)}),ut.style.display="block";else if(en.value.trim()!==""){const r=document.createElement("div");r.className="no-results",r.textContent="پیدا نشد",ut.appendChild(r),ut.style.display="block"}else ut.style.display="none"}function bn(){const t=document.getElementById("trashed-items-list");if(t.innerHTML="",qe.length===0){t.innerHTML='<li style="text-align: center; padding: 20px;">سطل زباله خالی است.</li>';return}qe.forEach((r,e)=>{const c=document.createElement("li"),s=document.createElement("span");s.textContent=r.description,s.style.flexGrow="1";const n=document.createElement("div");n.className="list-item-buttons";const i=document.createElement("button");i.className="btn-icon",i.innerHTML="🔄",i.title="بازیابی",i.addEventListener("click",()=>{var p;let o=!1,l=null;const m=r.restoreData;switch(r.type){case"classroom":{const u=re[m.name];u&&!u.isDeleted?l=`کلاسی با نام «${m.name}» از قبل فعال است.`:u&&u.isDeleted&&(u.isDeleted=!1,o=!0);break}case"student":{const u=Object.values(re).find(y=>y.info.scheduleCode===m.classId),h=u==null?void 0:u.students.find(y=>y.identity.studentId===m.studentId);h&&(h.isDeleted=!1,o=!0);break}case"session":{const u=Object.values(re).find(y=>y.info.scheduleCode===m.classId),h=u==null?void 0:u.sessions.find(y=>y.sessionNumber===m.sessionNumber);h&&(h.isDeleted=!1,o=!0);break}case"category":{const u=Object.values(re).find(y=>y.info.scheduleCode===m.classId),h=u==null?void 0:u.categories.find(y=>y.id===m.categoryId);h&&(h.isDeleted=!1,o=!0);break}case"score":{const u=Object.values(re).find(f=>f.info.scheduleCode===m.classId),h=u==null?void 0:u.students.find(f=>f.identity.studentId===m.studentId),y=(p=h==null?void 0:h.logs.scores[m.skill.toLowerCase()])==null?void 0:p.find(f=>f.id===m.scoreId);y&&(y.isDeleted=!1,o=!0);break}case"note":{const u=Object.values(re).find(f=>f.info.scheduleCode===m.classId),h=u==null?void 0:u.students.find(f=>f.identity.studentId===m.studentId),y=h==null?void 0:h.profile.notes.find(f=>f.id===m.noteId);y&&(y.isDeleted=!1,o=!0);break}}o?(qe.splice(e,1),oe(),bn(),r.type==="classroom"&&He(),V("✅ آیتم با موفقیت بازیابی شد.")):V(l?`⚠️ ${l}`:"⚠️ آیتم اصلی برای بازیابی یافت نشد.")});const a=document.createElement("button");a.className="btn-icon",a.innerHTML="🔥",a.title="حذف دائمی",a.addEventListener("click",()=>{Ce("آیا از حذف دائمی این آیتم مطمئن هستید؟ این عمل غیرقابل بازgشت است.",()=>{const o=r.restoreData,l=p=>Object.values(re).find(u=>u.info.scheduleCode===p);let m;switch(r.type){case"classroom":delete re[o.name];break;case"student":m=l(o.classId),ls({identity:{studentId:o.studentId}},m);break;case"session":m=l(o.classId),m&&aa(m.info.name,o.sessionNumber);break;case"category":m=l(o.classId),m&&ia(m.info.name,o.categoryId);break;case"score":m=l(o.classId),m&&ra(m.info.name,o.studentId,o.skill,o.scoreId);break;case"note":m=l(o.classId),m&&oa(m.info.name,o.studentId,o.noteId);break}qe.splice(e,1),oe(),bn(),V("✅ آیتم برای همیشه حذف شد.")},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),n.appendChild(i),n.appendChild(a),c.appendChild(s),c.appendChild(n),t.appendChild(c)})}function Uo(){const t=document.getElementById("absentees-summary-container");t&&(t.innerHTML=`
        <div id="absentees-summary-box" class="absentees-summary">
            <div class="absentees-summary-header">
                <h4>لیست غایبین جلسه شماره <span id="absentee-summary-session-number"></span></h4>
                <button id="copy-absentees-btn" class="btn-icon" title="کپی لیست غایبین">📋</button>
            </div>
            <div id="absentees-summary-list" class="summary-list"></div>
        </div>
    `)}function Xi(){const t=document.getElementById("absentees-summary-box"),r=document.getElementById("absentees-summary-list"),e=document.getElementById("absentee-summary-session-number");if(!t||!r||!e){console.error("Could not find all absentee summary elements.");return}if(!A||!K){t.classList.remove("visible");return}const c=Se(A.students).filter(n=>{const i=K.studentRecords[n.identity.studentId];return i&&i.attendance==="absent"}),s=at(A);e.textContent=s.get(K.sessionNumber),c.length>0?t.classList.add("visible"):t.classList.remove("visible"),r.innerHTML="",c.forEach(n=>{const a=(l=>A.sessions.reduce((m,p)=>{if(p.isDeleted||p.isCancelled)return m;const u=p.studentRecords[l.identity.studentId];return m+(u&&u.attendance==="absent"?1:0)},0))(n),o=document.createElement("span");o.className="summary-name",o.textContent=`${n.identity.name} (غیبت: ${a})`,o.addEventListener("click",()=>{o.classList.add("fading-out"),setTimeout(()=>{K.setAttendance(n.identity.studentId,"present"),oe(),it()},200)}),r.appendChild(o)})}function jo(){const t=document.getElementById("copy-absentees-btn");if(!t){console.error("Could not find the copy absentees button to attach listener.");return}t.addEventListener("click",()=>{if(!A||!K)return;const r=Se(A.students).filter(s=>{const n=K.studentRecords[s.identity.studentId];return n&&n.attendance==="absent"});if(r.length===0){V("⚠️لیست غایبین خالی است.");return}const e=s=>A.sessions.reduce((n,i)=>{if(i.isDeleted||i.isCancelled)return n;const a=i.studentRecords[s.identity.studentId];return n+(a&&a.attendance==="absent"?1:0)},0);let c=`لیست غایبین جلسه شماره ${Do()}:

`;r.forEach(s=>{const n=e(s);c+=`- ${s.identity.name} (تعداد غیبت‌ها: ${n})
`}),navigator.clipboard.writeText(c).then(()=>{V("✅لیست غایبین با موفقیت کپی شد.")}).catch(s=>{console.error("Failed to copy text: ",s),V("❌خطا در کپی کردن لیست.")})})}function Wn(){const t=document.getElementById("demo-mode-banner");t&&(ft?(t.classList.add("visible"),document.body.classList.add("demo-mode-active")):(t.classList.remove("visible"),document.body.classList.remove("demo-mode-active")))}function os(t){const{scheduleDays:r,scheduleStartTime:e,scheduleEndTime:c}=t.info,s=r&&r.length>0,n=e&&c;if(!s&&!n)return{type:"unscheduled",sortIndex:3};if(!s||!n)return{type:"incomplete",sortIndex:2};const i=new Date,a=i.getDay(),o=i.getHours()*60+i.getMinutes(),[l,m]=e.split(":").map(Number),[p,u]=c.split(":").map(Number),h=l*60+m,y=p*60+u;if(r.includes(a)&&o>=h&&o<y)return{type:"active",sortIndex:0};for(let f=0;f<=7;f++){const v=(a+f)%7;if(r.includes(v)){if(f===0&&o>=h)continue;const b=new Date(i);return b.setDate(i.getDate()+f),b.setHours(l,m,0,0),{type:"upcoming",sortIndex:1,nextTimestamp:b.getTime()}}}return{type:"upcoming",sortIndex:1,nextTimestamp:9999999999999}}function qo(t,r){const{scheduleDays:e,scheduleStartTime:c,scheduleEndTime:s}=t.info;if(!e||!e.length||!c||!s)return null;const[n,i]=c.split(":").map(Number),[a,o]=s.split(":").map(Number),l=n*60+i,m=a*60+o;for(const p of Object.values(r)){if(p===t||p.isDeleted||p.info.name===t.info.name)continue;const u=p.info;if(!u.scheduleDays||!u.scheduleDays.length||!u.scheduleStartTime||!u.scheduleEndTime||!e.some(k=>u.scheduleDays.includes(k)))continue;const[y,f]=u.scheduleStartTime.split(":").map(Number),[v,b]=u.scheduleEndTime.split(":").map(Number),C=y*60+f,S=v*60+b;if(l<S&&m>C)return p.info.name}return null}function Zo(t){if(!t||t.length===0)return"";const r={6:"شنبه",0:"۱شنبه",1:"۲شنبه",2:"۳شنبه",3:"۴شنبه",4:"۵شنبه",5:"جمعه"};return[...t].sort((c,s)=>{const n={6:0,0:1,1:2,2:3,3:4,4:5,5:6};return n[c]-n[s]}).map(c=>r[c]).join("، ")}async function Qi(){const t=document.getElementById("restore-points-list");t.innerHTML='<li style="text-align:center; padding:20px;">در حال بارگذاری...</li>';try{const r=await pi();if(r.length===0){t.innerHTML='<li style="text-align:center; padding:20px;">هیچ فایل پشتیبانی یافت نشد.</li>';return}t.innerHTML="",r.forEach(e=>{const c=document.createElement("li");c.className="restore-point-card";const s=new Date(e.timestamp).toLocaleString("fa-IR",{weekday:"long",year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"}),n=(e.file.size/1024).toFixed(1)+" KB";c.innerHTML=`
                <div class="restore-card-header">
                    <span class="restore-date">${s}</span>
                    <span class="restore-size">${n}</span>
                </div>
                <div class="restore-desc">${e.metadata.description||"بدون توضیحات"}</div>
                <div class="restore-actions">
                    <button class="btn-restore-action">بازگردانی</button>
                </div>
            `,c.querySelector(".btn-restore-action").addEventListener("click",async()=>{try{const a=await e.file.text(),m=(await new Vs().loadAsync(a,{base64:!0})).file("backup.json");if(!m)throw new Error("فایل backup.json یافت نشد.");const p=await m.async("string"),u=JSON.parse(p);is(u)}catch(a){console.error("Restore failed:",a),V("❌ فایل پشتیبان معتبر نیست.")}}),t.appendChild(c)})}catch(r){console.error("Failed to load snapshots:",r),t.innerHTML='<li style="text-align:center; color:red;">خطا در بارگذاری اطلاعات.</li>'}}function Go(t,r,e="default",c=!1){let s=[...Se(t.students)];const n=new Date().toLocaleDateString("fa-IR",{year:"numeric",month:"long",day:"numeric",weekday:"long"});e==="alpha"&&(s=Cn(s));let i="<tr>";r.forEach(u=>{i+=`<th>${u.label}</th>`}),i+="</tr>";let a="";s.forEach((u,h)=>{a+="<tr>",r.forEach(y=>{var C;let f="-";if(y.id==="row_num")f=h+1;else if(y.id==="name")u.identity.firstName&&u.identity.lastName?f=`${u.identity.lastName}، ${u.identity.firstName}`:f=u.identity.name;else if(y.id==="total_selections")f=u.statusCounters.totalSelections;else if(y.id==="absences")f=t.sessions.reduce((S,k)=>{if(k.isDeleted||k.isCancelled)return S;const _=k.studentRecords[u.identity.studentId];return S+(_&&_.attendance==="absent"?1:0)},0);else if(y.id==="exit_count")f=u.statusCounters.outOfClassCount||0;else if(y.id==="missed_chances")f=u.statusCounters.missedChances;else if(y.id==="issues")f=Object.values(u.categoryIssues||{}).reduce((S,k)=>S+k,0);else if(y.id==="avg_score")f=u.getOverallAverageScore()||"-";else if(y.id==="final_score")f=t.calculateFinalStudentScore(u)||"-";else if(y.type==="category")f=u.categoryCounts[y.id]||0;else if(y.type==="category_scores"){const S=y.id.toLowerCase(),k=((C=u.logs.scores[S])==null?void 0:C.filter(_=>!_.isDeleted))||[];f=k.length>0?k.map(_=>_.value).join("، "):"-"}let v="text-align: center;";y.id==="name"?v="text-align: right; white-space: nowrap;":y.type==="category_scores"&&(v="text-align: center; white-space: nowrap;");const b=`style="${v}"`;a+=`<td ${b}>${f}</td>`}),a+="</tr>"});let o="";c&&(o=`
            <div class="warning-footnote">
                ⚠️ <strong>توجه:</strong> ترتیب الفبایی این لیست ممکن است دقیق نباشد. (نام خانوادگی برخی دانش‌آموزان در سیستم تفکیک نشده است)
            </div>
        `);const l=Array.from(document.querySelectorAll('link[rel="stylesheet"]')).map(u=>u.outerHTML).join(""),m=window.open("","_blank");if(!m){V("⚠️ مرورگر شما پنجره جدید را مسدود کرد. لطفاً اجازه دهید.","error");return}const p=`
        <!DOCTYPE html>
        <html lang="fa" dir="rtl">
        <head>
            <title>گزارش کلاس ${t.info.name}</title>
            ${l} <style>
                @media print {
                    @page { size: A4; margin: 10mm; }
                    /* Updated Font Family */
                    body { font-family: 'Vazirmatn', 'Vazir', Tahoma, sans-serif; color: #000; }
                }
                /* Updated Font Family */
                body { font-family: 'Vazirmatn', 'Vazir', Tahoma, sans-serif; padding: 20px; direction: rtl; }
                h1 { text-align: center; margin-bottom: 5px; font-size: 24px; }
                .meta { text-align: center; margin-bottom: 30px; font-size: 14px; color: #444; }
                table { width: 100%; border-collapse: collapse; font-size: 12px; }
                th, td { border: 1px solid #333; padding: 6px 8px; text-align: center; }
                th { background-color: #eee; font-weight: bold; }
                tr:nth-child(even) { background-color: #f9f9f9; }
                .signature { margin-top: 50px; display: flex; justify-content: space-between; padding: 0 50px; }
                
                .warning-footnote {
                    margin-top: 20px;
                    font-size: 11px;
                    color: #555;
                    font-style: italic;
                    border-top: 1px solid #ccc;
                    padding-top: 10px;
                }
            </style>
        </head>
        <body>
            <h1>گزارش وضعیت کلاس ${t.info.name}</h1>
            <div class="meta">
                تاریخ گزارش: ${n} | تعداد دانش‌آموزان: ${s.length}
            </div>
            <table>
                <thead>${i}</thead>
                <tbody>${a}</tbody>
            </table>
            ${o}
            <div class="signature">
                <div>امضای معلم</div>
                <div>مهر و امضای مدرسه</div>
            </div>
            <script>
                window.onload = function() { window.print(); }
            <\/script>
        </body>
        </html>
    `;m.document.write(p),m.document.close()}function Vo(t){const r=Ni;r.innerHTML="";const c=Se(t.students).filter(u=>!u.identity.lastName).length,s=[{id:"row_num",label:"ردیف",checked:!0},{id:"name",label:"نام دانش‌آموز",checked:!0},{id:"total_selections",label:"کل انتخاب‌ها",checked:!0},{id:"absences",label:"تعداد غیبت",checked:!0},{id:"exit_count",label:"تعداد خروج",checked:!1},{id:"missed_chances",label:"فرصت سوخته",checked:!1},{id:"issues",label:"مشکل‌پاسخگویی",checked:!1},{id:"avg_score",label:"میانگین نمرات",checked:!0},{id:"final_score",label:"نمره نهایی (کانون)",checked:!0}];t.categories.forEach(u=>{u.isDeleted||(s.push({id:u.name,label:`تعداد ${u.name}`,type:"category",checked:!1}),u.isGradedCategory&&s.push({id:u.name,label:`نمرات ${u.name}`,type:"category_scores",checked:!1}))}),s.forEach(u=>{const h=document.createElement("label");h.className="report-column-item";const y=document.createElement("input");y.type="checkbox",y.checked=u.checked,y.dataset.colId=u.id,y.dataset.colLabel=u.label,u.type&&(y.dataset.colType=u.type);const f=document.createElement("span");f.textContent=u.label,h.appendChild(y),h.appendChild(f),r.appendChild(h)});const n=r.parentElement,i=n.querySelector("#report-sort-options");i&&i.remove();const a=document.createElement("div");a.id="report-sort-options",a.style.marginTop="20px",a.style.padding="15px",a.style.backgroundColor="#f8f9fa",a.style.borderRadius="5px",a.style.border="1px solid #e9ecef",a.innerHTML=`
        <div style="margin-bottom: 10px; font-weight: bold; color: #333;">ترتیب نمایش لیست:</div>
        
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <label style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <input type="radio" name="report-sort" value="alpha" checked style="accent-color: var(--color-primary);">
                <span>بر اساس نام خانوادگی</span>
            </label>

            <label style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <input type="radio" name="report-sort" value="default" style="accent-color: var(--color-primary);">
                <span>بر اساس زمان ورود به کلاس</span>
            </label>
        </div>

        <div id="sort-warning" style="
            display: none; 
            margin-top: 12px; 
            background-color: #fff3cd; 
            color: #856404; 
            padding: 10px; 
            border-radius: 4px; 
            font-size: 13px; 
            border: 1px solid #ffeeba;
            line-height: 1.5;
        ">
            ⚠️ <strong>توجه:</strong> نام خانوادگی ${c} دانش‌آموز هنوز تفکیک نشده است. مرتب‌سازی این موارد ممکن است کاملاً دقیق نباشد.
        </div>
    `;const o=n.querySelector(".modal-actions");n.insertBefore(a,o);const l=a.querySelectorAll('input[name="report-sort"]'),m=a.querySelector("#sort-warning"),p=()=>{const u=a.querySelector('input[value="alpha"]').checked;m.style.display=u&&c>0?"block":"none"};l.forEach(u=>u.addEventListener("change",p)),p(),Di.onclick=()=>{const u=[];if(r.querySelectorAll('input[type="checkbox"]:checked').forEach(v=>{u.push({id:v.dataset.colId,label:v.dataset.colLabel,type:v.dataset.colType})}),u.length===0){V("⚠️ لطفاً حداقل یک ستون را انتخاب کنید.");return}const y=a.querySelector('input[name="report-sort"]:checked').value,f=y==="alpha"&&c>0;ge(),Go(t,u,y,f)},Ai.onclick=()=>{ge()},$e("report-config-modal")}function Jo(t,r){const e=document.createElement("div");e.className="qualitative-button-container";const c=Ve,s=c!==-1&&K.winnerHistory[c],n=s?K.winnerHistory[c]:null,i=K.studentRecords[t.identity.studentId];t.qualitativeStats||(t.qualitativeStats={}),t.qualitativeStats[r]||(t.qualitativeStats[r]={effort:0,good:0,excellent:0}),i.performanceRatings||(i.performanceRatings={});const a=s?n.rating:i.performanceRatings[r],o=K.isFinished||i.attendance==="absent"||i.hadIssue||i.wasOutOfClass;return[{key:"effort",label:"تلاش",className:"effort-btn"},{key:"good",label:"خوب",className:"good-btn"},{key:"excellent",label:"عالی",className:"excellent-btn"}].forEach(m=>{const p=document.createElement("button");p.className=`qualitative-btn ${m.className}`,p.textContent=m.label,p.disabled=o,a===m.key&&p.classList.add("active"),p.addEventListener("click",()=>{const u=m.key;a&&t.qualitativeStats[r][a]>0&&t.qualitativeStats[r][a]--,a!==u&&(t.qualitativeStats[r][u]=(t.qualitativeStats[r][u]||0)+1);const h=a===u?null:u;s?n.rating=h:h?i.performanceRatings[r]=h:delete i.performanceRatings[r],oe(),Oe()}),e.appendChild(p)}),e}function xa(t,r,e="custom",c=null){t.innerHTML="",Object.values(Ra).forEach(n=>{const i=document.createElement("option");i.value=n.id,i.textContent=n.label,t.appendChild(i)}),t.value=e;const s=n=>{r.innerHTML="";const i=Ra[n];if(i&&i.levels.length>0)i.levels.forEach(a=>{const o=document.createElement("option");o.value=a,o.textContent=a,r.appendChild(o)}),r.disabled=!1;else{const a=document.createElement("option");a.value="",a.textContent="---",r.appendChild(a),r.disabled=!0}};s(e),c&&(r.value=c),t.onchange=()=>{s(t.value),r.dispatchEvent(new Event("change"))}}function er(){pn.value="",xa(ns,ba,"custom"),$e("add-class-modal");const t=[{label:"شنبه",value:6},{label:"یکشنبه",value:0},{label:"دوشنبه",value:1},{label:"سه‌شنبه",value:2},{label:"چهارشنبه",value:3},{label:"پنج‌شنبه",value:4},{label:"جمعه",value:5}];as.innerHTML="",t.forEach(r=>{const e=document.createElement("label"),c=document.createElement("input");c.type="checkbox",c.value=r.value,e.appendChild(c),e.appendChild(document.createTextNode(r.label)),as.appendChild(e)}),nn.addEventListener("click",()=>{nn.classList.toggle("open"),Fi.classList.toggle("open");const r=nn.querySelector(".arrow");r.textContent=nn.classList.contains("open")?"▼":"▶"}),pn.focus()}function Gs(){ge()}const Fa=Object.freeze(Object.defineProperty({__proto__:null,_internalShowPage:dn,addCategoryBtn:Ur,addClassModal:xr,addNoteModal:so,addScoreBtn:lo,addStudentBtn:Dr,appHeader:Rs,assessmentModeLabel:jr,attendanceListUl:rn,attendanceMassActionsContainer:zn,attendancePage:qr,attendancePane:Gt,attendanceSearchInput:Tt,backToSessionsBtn:Br,backToStudentPageBtn:ro,backupDataBtn:Xr,breadcrumbContainer:Ut,cancelAddClassBtn:Ns,cancelImportBtn:Hr,cancelNoteBtn:io,categoryListUl:As,categoryModal:wo,categoryModalCancelBtn:Eo,categoryModalSaveBtn:Mi,categoryModalTitle:Oi,categoryWeightLabel:Mn,classListHeader:Gr,classListUl:Ot,classManagementPage:Ei,classSaveNoteBtn:ao,closeActiveModal:ge,closeAddClassModal:Gs,closeContextMenu:At,closeNavBtn:Kr,columnMappingPage:Pr,columnSelectDropdown:Ms,confirmAddClassBtn:Bs,confirmColumnBtn:Fr,confirmModalCancelBtn:$s,confirmModalConfirmBtn:Qt,confirmModalMessage:xi,contextMenu:zt,csvCancelBtn:Rr,csvConfirmBtn:Mr,csvFileInput:$r,csvPreviewList:Os,csvPreviewPage:Or,customConfirmModal:eo,displayWinner:Oe,finishAttendanceBtn:Zr,globalStudentSearchInput:en,globalStudentSearchResultsDiv:ut,gradedCategoryPillsContainer:oo,hamburgerMenuBtn:Vr,handleUndo:Wi,importCsvBtn:zr,initiateBackupProcess:yn,isGradedCheckbox:mo,massCommentAppendCheckbox:Ca,massCommentBtn:Hs,massCommentCancelBtn:_o,massCommentContent:ln,massCommentModal:So,massCommentModalTitle:ko,massCommentSaveBtn:Io,massCommentStudentCountMessage:Ri,modalAddClassLevelSelect:ba,modalAddClassSystemSelect:ns,modalNewClassNameInput:pn,modalScheduleContent:Fi,modalScheduleDaysContainer:as,modalScheduleEndTimeInput:Pi,modalScheduleStartTimeInput:$i,modalScheduleTextInput:zi,modalScheduleToggle:nn,newCategoryModalIsGradedCheckbox:Nt,newCategoryModalNameInput:cn,newCategoryModalWeightInput:Ws,newCategoryNameInput:Wr,newCategoryWeightInput:Lo,newNoteContent:ke,newScoreCommentTextarea:Bi,newScoreValueInput:co,newStudentNameInput:Nr,openAddClassModal:er,openAddClassModalBtn:Ir,openContextMenu:wn,openModal:$e,overlay:Yr,pasteArea:_i,populateSystemLevelSelects:xa,processMassHomeworkComment:js,processPasteBtn:Ar,profileScoresListUl:fo,profileStatsSummaryDiv:uo,quickGradeFormWrapper:jt,quickGradeSubmitBtn:Rt,quickNoteTextarea:ct,quickScoreInput:ht,renderAttendancePage:it,renderBreadcrumbs:qi,renderClassList:He,renderClassManagementStats:hs,renderColumnSelector:Ki,renderGlobalSearchResults:Hn,renderImportPreview:Zs,renderLogModal:ji,renderMassCommentControls:Ea,renderRestorePointsPage:Qi,renderScoresHistory:Vi,renderSearchResults:sn,renderSessionDashboard:Vt,renderSessions:Ze,renderSettingsCategories:En,renderSettingsOther:Yi,renderSettingsStudentList:_t,renderStudentNotes:Ji,renderStudentStatsList:Ae,renderTrashPage:bn,reportCancelBtn:Ai,reportColumnsContainer:Ni,reportConfigModal:Co,reportPrintBtn:Di,restoreDataBtn:Qr,restoreFileInput:Ii,secureConfirmCancelBtn:no,secureConfirmCode:Ti,secureConfirmConfirmBtn:Rn,secureConfirmInput:Wt,secureConfirmMessage:Li,secureConfirmModal:to,selectStudentBtn:Ye,selectStudentBtnWrapper:Mt,sessionDashboardPage:xo,setAutoDirectionOnInput:_a,settingsClassNameHeader:ki,settingsEduSystemSelect:$n,settingsLevelSelect:tn,settingsPage:Tr,settingsStudentListUl:Ds,setupDashboardTabs:Hi,setupLongPress:Dt,showCategoryModal:Us,showClassNoteModal:ms,showCustomConfirm:Ce,showMassCommentModal:Sa,showMoveStudentModal:wa,showNotification:V,showPage:ye,showRenameStudentModal:rs,showRestoreConfirmModal:is,showSecureConfirm:Ui,showSessionNoteModal:ka,showSettingsPage:kt,showStudentProfile:Fe,showUndoToast:To,sideNavMenu:Jr,studentSearchInput:Ps,studentSearchResultsDiv:Ct,studentStatsHeader:zs,switchDashboardTab:gn,trashedCategoriesList:yo,trashedClassesList:ho,trashedNotesList:vo,trashedScoresList:bo,trashedSessionsList:go,trashedStudentsList:po,triggerFileDownload:qs,undoBtn:Lr,undoMessage:Si,undoToast:ss,updateCategoryColumnHighlight:Jt,updateDemoModeBanner:Wn,updateQuickGradeUIForCategory:vn},Symbol.toStringTag,{value:"Module"}));let Ha=0,Is=!1;function Ko(){const t=window.location.hash;if(!t||t==="#")return!1;const[r,e]=t.split("?"),c=r.substring(1),s=new URLSearchParams(e),n=s.get("class"),i=parseInt(s.get("session"),10),a=s.get("student"),o=s.get("tab")||"selector";if(n&&re[n])je(re[n]),i&&A.getSession(i)&&Xe(A.getSession(i)),a&&A.students.find(l=>l.identity.studentId===a)&&Qe(A.students.find(l=>l.identity.studentId===a));else return!1;switch(c){case"session-page":Ze(),ye("session-page");break;case"session-dashboard-page":Vt(c==="attendance-page"?"attendance":o);break;case"settings-page":kt(A);break;case"student-profile-page":Vt(o),Fe(Ie);break;default:return!1}return!0}document.addEventListener("DOMContentLoaded",()=>{const{globalStudentSearchInput:t,undoBtn:r,newStudentNameInput:e,addStudentBtn:c,pasteArea:s,processPasteBtn:n,csvPreviewList:i,csvConfirmBtn:a,csvCancelBtn:o,importCsvBtn:l,csvFileInput:m,columnSelectDropdown:p,confirmColumnBtn:u,cancelImportBtn:h,newCategoryNameInput:y,addCategoryBtn:f,selectStudentBtn:v,attendancePage:b,finishAttendanceBtn:C,classListHeader:S,studentStatsHeader:k,hamburgerMenuBtn:_,sideNavMenu:x,closeNavBtn:L,overlay:N,backupDataBtn:R,restoreDataBtn:j,restoreFileInput:ee,confirmModalCancelBtn:I,confirmModalConfirmBtn:z,secureConfirmCancelBtn:g,secureConfirmConfirmBtn:H,newNoteContent:fe,classSaveNoteBtn:Z,cancelNoteBtn:me,studentSearchInput:P,studentSearchResultsDiv:se,isGradedCheckbox:O,categoryModalSaveBtn:M,categoryModalCancelBtn:de,massCommentBtn:te,massCommentCancelBtn:Q,massCommentSaveBtn:Be,massCommentContent:Me,massCommentAppendCheckbox:he,attendanceSearchInput:we,newCategoryWeightInput:Te}=Fa,Re=document.getElementById("trash-nav-btn");document.querySelector(".global-search-container .search-icon"),Kn(),Wn(),Ko()||(He(),ye("class-management-page"));function Je(B,F){const W=document.querySelector(B);if(!W)return;const J=W.querySelector(".search-icon"),ie=W.querySelector(".animated-search-input");!J||!ie||(J.addEventListener("mousedown",ce=>{ce.preventDefault()}),J.addEventListener("click",()=>{W.classList.contains("search-active")||(W.classList.add("search-active"),ie.focus())}),ie.addEventListener("blur",()=>{setTimeout(()=>{W.classList.remove("search-active"),ie.value="",F&&F([])},150)}))}we.addEventListener("input",()=>{const B=we.value.toLowerCase().trim(),F=On(B);rn.querySelectorAll(".attendance-list-item").forEach(J=>{const ie=J.querySelector(".student-name");if(ie){const ce=ie.textContent,ne=Ue(ce.toLowerCase()),le=ne.includes(Ue(B)),pe=ne.includes(Ue(F));le||pe?J.style.display="flex":J.style.display="none"}})}),de.addEventListener("click",()=>{ge(),ds(null)}),M.addEventListener("click",()=>{const B=cn.value.trim(),F=Nt.checked;typeof Gn=="function"&&Gn(B,F),Ae()}),window.addEventListener("scroll",At),document.addEventListener("click",B=>{zt.classList.contains("visible")&&!zt.contains(B.target)&&At(),P.contains(B.target)||(se.style.display="none");const F=B.target.closest(".log-action-link");if(F&&F.dataset.action)try{const W=JSON.parse(F.dataset.action);Ft(W)}catch(W){console.error("Could not parse log action:",W)}}),Mt.addEventListener("click",()=>{(Mt.classList.contains("disabled-wrapper")||Ye.disabled)&&(Ye.classList.add("shake-animation"),setTimeout(()=>{Ye.classList.remove("shake-animation")},200))}),k.addEventListener("click",()=>{const B=new Date().getTime();B-Qs>500?Dn(1):Dn(qn+1),ui(B),qn===5&&(Dn(0),Ce("آیا از صفر کردن تمام شمارنده‌های دانش‌آموزان مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{ai(),Ae(),V("تمام آمارها صفر شدند ✅.")},{confirmText:"بله",confirmClass:"btn-warning"}))}),S.addEventListener("click",()=>{const B=new Date().getTime();B-Xs>500?Nn(1):Nn(jn+1),di(B),jn===5&&(Nn(0),Ce("آیا از ساخت یک کلاس تستی تصادفی مطمئن هستید؟",()=>{function F(){const W=`کلاس تستی ${Object.keys(re).length+1}`,J=new Ls({name:W,type:"online"});["علی رضایی","مریم حسینی","زهرا احمدی","رضا محمدی","فاطمه کریمی"].forEach(ce=>J.addStudent(new Tn({name:ce}))),re[W]=J,oe(),He()}F(),V("کلاس تستی با موفقیت ساخته شد ✅!")},{confirmText:"بساز",confirmClass:"btn-success"}))}),document.querySelector(".app-header h1").addEventListener("click",()=>{Ha++,Ha===10&&(window.dev={state:za,ui:Fa,utils:vr,db:yr},console.log("🛠️ Developer Mode Activated! Access modules via the 'dev' object (e.g., dev.state.currentClassroom)"),V("🛠️ حالت توسعه‌دهنده فعال شد."),document.querySelector(".app-header h1").style.color="var(--color-primary)",document.querySelector(".app-header h1").classList.add("dev-mode-tilt"))}),g.addEventListener("click",()=>{ge(),mn(null)});const d=document.getElementById("date-picker-confirm-btn"),U=document.getElementById("date-picker-cancel-btn"),$=document.getElementById("dp-day"),E=document.getElementById("dp-month"),w=document.getElementById("dp-year");d.addEventListener("click",()=>{const B=w.value,F=E.value,W=$.value;B&&F&&W&&typeof Jn=="function"?(Jn({jy:B,jm:F,jd:W}),ge()):V("⚠️ خطا در انتخاب تاریخ."),Qn(null)}),U&&U.addEventListener("click",()=>{ge(),Qn(null)}),H.addEventListener("click",()=>{typeof Zn=="function"&&Zn(),ge(),mn(null)}),I.addEventListener("click",()=>{ge(ta)}),z.addEventListener("click",()=>{ge(ea)}),Ye.addEventListener("click",()=>{if(Is){Is=!1;return}if(ht.value.trim()!==""||ct.value.trim()!==""){V("⚠️لطفاً ابتدا با دکمه «ثبت»، تغییرات را ذخیره کنید و یا نمره و یادداشت را پاک کنید.");return}if(Bt){const B=ec(A,ze);B?(Ae(),Oe(B,ze.name),Jt(ze.name),oe()):Ce("برای تمام دانش‌آموزان در این جلسه یک بار فرصت نمره‌گیری فراهم شده؛ آیا می‌خواهید برای بار دوم این کار را تکرار کنید؟",()=>{const F=ze.id;st[F].scoredThisSession=[],Ye.click()},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})}else{if(!A||!K||!ze)return;const B=A.selectNextWinner(ze.name,K);if(B){Ts();const F=K.studentRecords[B.identity.studentId];(F==null?void 0:F.attendance)==="absent"&&B.statusCounters.missedChances++,F!=null&&F.hadIssue&&(B.statusCounters.missedChances++,B.categoryIssues[ze.name]=(B.categoryIssues[ze.name]||0)+1),F!=null&&F.wasOutOfClass&&(B.statusCounters.outOfClassCount=(B.statusCounters.outOfClassCount||0)+1,B.statusCounters.missedChances++);const W={winner:B,categoryName:ze.name};K.winnerHistory.push(W),K.winnerHistory.length>10&&K.winnerHistory.shift(),yt(K.winnerHistory.length-1),K.lastUsedCategoryId=ze.id,K.lastSelectedWinnerId=B.identity.studentId,Ae(),setTimeout(()=>Oe(),0),oe()}else V("❌دانش‌آموز واجد شرایطی برای انتخاب یافت نشد.")}}),f.addEventListener("click",()=>{if(!A)return;const B=y.value.trim(),F=O.checked,W=parseFloat(Te.value)||1;if(!B){alert("⚠️لطفاً نام دسته‌بندی را وارد کنید.");return}const J=A.categories.find(ce=>ce.name.toLowerCase()===B.toLowerCase());if(J)if(J.isDeleted){const ce=A.categories.findIndex(ne=>ne===J);ce>-1&&A.categories.splice(ce,1)}else{alert("⚠️این دسته‌بندی از قبل وجود دارد.");return}const ie=new gt(B,"",F,W);A.categories.push(ie),oe(),_e(A.info.name,`دسته‌بندی جدید «${B}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),En(),y.value="",O.checked=!1}),document.querySelectorAll('#settings-page input[name="class-type-setting"]').forEach(B=>{B.addEventListener("change",()=>{if(!A)return;const F=B.value,W=A.info.type||"in-person";if(F===W)return;const J=ne=>ne==="online"?"آنلاین":"حضوری",ie=J(W),ce=J(F);Ce(`آیا از تغییر نوع کلاس از «${ie}» به «${ce}» مطمئن هستید؟`,()=>{A.info.type=F,oe(),_e(A.info.name,`نوع کلاس به «${ce}» تغییر یافت.`,{type:"VIEW_CLASS_SETTINGS"}),He(),V(`✅ نوع کلاس به «${ce}» تغییر یافت.`)},{confirmText:"بله",confirmClass:"btn-warning",onCancel:()=>{const ne=document.querySelector(`#settings-page input[name="class-type-setting"][value="${W}"]`);ne&&(ne.checked=!0)}})})});const q=document.querySelectorAll('input[name="schedule-day"]'),G=document.getElementById("settings-schedule-start"),D=document.getElementById("settings-schedule-end");q.forEach(B=>{B.addEventListener("change",()=>{if(!A)return;const F=Array.from(q).filter(W=>W.checked).map(W=>parseInt(W.value));A.info.scheduleDays=F,oe()})});const Y=()=>{A&&(A.info.scheduleStartTime=G.value,A.info.scheduleEndTime=D.value,oe())};G.addEventListener("change",Y),D.addEventListener("change",Y),y.addEventListener("keyup",B=>{B.key==="Enter"&&f.click()}),u.addEventListener("click",()=>{if(!Un){alert("❌خطایی رخ داده است. لطفاً فایل را دوباره انتخاب کنید."),ye("settings-page");return}const B=parseInt(p.value,10),J=Un.split(`
`).slice(1).map(ie=>{var ne;return(ne=ie.split(",")[B])==null?void 0:ne.trim()}).filter(ie=>ie&&ie.length>0);J.length>0?(Xt(J),Zs(),ye("csv-preview-page")):alert("هیچ نامی در ستون انتخاب شده پیدا نشد. لطفاً ستون دیگری را امتحان کنید یا فایل خود را بررسی کنید."),Bn(null)}),l.addEventListener("click",()=>{m.click()}),m.addEventListener("change",B=>{const F=B.target.files[0];if(!F)return;const W=new FileReader;W.onload=J=>{const ie=J.target.result;Bn(ie);const ne=ie.split(`
`)[0].split(",");Ki(ne),ye("column-mapping-page")},W.readAsText(F),B.target.value=null}),h.addEventListener("click",()=>{Bn(null),ye("settings-page")}),a.addEventListener("click",()=>{const B=i.querySelectorAll('input[type="checkbox"]:checked');let F=0,W=[],J=!1;B.forEach(ce=>{const ne=ce.dataset.name,le=an(ne),pe=Ue(le.name),Ee=A.students.find(Ke=>Ue(Ke.identity.name)===pe&&pe!=="");if(Ee)if(Ee.isDeleted)ls(Ee,A);else{W.push(le.name);return}const Ne=new Tn(le);A.addStudent(Ne),A.sessions.length>0&&(Se(A.sessions).filter(Ke=>Ke.isFinished&&!Ke.isCancelled).forEach(Ke=>{Ke.setAttendance(Ne.identity.studentId,"absent")}),tt(Ne,A),J=!0),F++}),oe(),F>0&&_e(A.info.name,`${F} دانش‌آموز جدید از لیست ورودی به کلاس اضافه شدند.`,{type:"VIEW_SESSIONS"}),kt(A);let ie=W.length>0?`⚠️ موارد زیر به دلیل تکراری بودن نادیده گرفته شدند:
- ${W.join(`
- `)}`:"";if(J)Kt(F,ie);else if(W.length>0||F>0){const ce=F>0?`✅ ${F} دانش‌آموز با موفقیت اضافه شدند.
${ie}`:ie;Ce(ce,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}s.value="",Xt([])}),o.addEventListener("click",()=>{Xt([]),ye("settings-page")}),s.addEventListener("keydown",B=>{if(B.key==="Enter"){const F=s.value,W=s.selectionStart,J=F.lastIndexOf(`
`,W-1),ie=F.substring(J+1,W).trim(),ce=ie.indexOf(".");ie&&(ce<=0||ce>=ie.length-1)&&(B.preventDefault(),V("لطفا یک نقطه بین نام و نام خانوادگی قرار دهید. مثال: علی . احمدی"))}}),n.addEventListener("click",()=>{const B=s.value.trim();if(!B){V("کادر متنی خالی است. لطفاً اسامی را وارد کنید.");return}const F=B.split(`
`).map(J=>J.trim()).filter(J=>J.length>0),W=F.find(J=>{const ie=J.indexOf(".");return ie<=0||ie>=J.length-1});if(W){V(`فرمت نام «${W}» صحیح نیست. لطفا نام و نام خانوادگی را با نقطه جدا کنید.`);return}F.length>0?(Xt(F),Zs(),ye("csv-preview-page")):V("هیچ نام معتبری برای ورود پیدا نشد.")}),e.addEventListener("keyup",B=>{B.key==="Enter"&&c.click()}),c.addEventListener("click",()=>{if(!A)return;const B=e.value.trim();if(!B){alert("لطفاً نام دانش‌آموز را وارد کنید.");return}const F=B.indexOf(".");if(F<=0||F>=B.length-1){V("لطفا یک نقطه بین نام و نام خانوادگی قرار دهید. مثال: علی . احمدی");return}const W=an(e.value),J=Ue(W.name);if(Se(A.students).some(le=>Ue(le.identity.name)===J)){alert(`دانش‌آموز «${W.name}» قبلاً در لیست وجود دارد.`);return}const ce=an(B),ne=new Tn(ce);A.addStudent(ne),A.sessions.length>0&&(Se(A.sessions).filter(le=>le.isFinished&&!le.isCancelled).forEach(le=>{le.setAttendance(ne.identity.studentId,"absent")}),tt(ne,A),Kt(1)),oe(),_e(A.info.name,`دانش‌آموز «${B}» به کلاس اضافه شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:ne.identity.studentId}),_t(),Ae(),e.value="",e.focus()}),document.getElementById("new-session-btn").addEventListener("click",()=>{if(A){const B=A.sessions.find(W=>!W.isFinished&&!W.isCancelled&&!W.isDeleted);if(B){V(`⚠️ جلسه ${B.sessionNumber} هنوز تمام نشده است. لطفاً ابتدا با دکمه ✅ آن را خاتمه دهید.`);return}const F=()=>{const W=J=>{const ie=A.startNewSession();fn(ie),Xe(ie),A.students.forEach(le=>{Js.setAttendance(le.identity.studentId,"present")}),oe();const ne=at(A).get(ie.sessionNumber);_e(A.info.name,`جلسه ${ne} شروع شد.`,{type:"VIEW_SESSIONS"}),Vt(J?"attendance":"selector")};Ce("آیا تمایل به انجام فرآیند حضور و غیاب دارید؟",()=>W(!0),{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success",onCancel:()=>W(!1)})};A.hasSessionToday()?Ce("شما امروز یک جلسه برای این کلاس ثبت کرده‌اید. آیا از شروع یک جلسه جدید دیگر مطمئن هستید؟",F,{confirmText:"بله",confirmClass:"btn-warning"}):F()}});const ae=document.getElementById("open-add-class-modal-btn");ae&&ae.addEventListener("click",()=>{er()}),Ns&&Ns.addEventListener("click",()=>{Gs()}),Bs?Bs.addEventListener("click",()=>{var W;const B=pn;if(!B){console.error("❌ DEBUG: Name Input element is missing!");return}const F=B.value.trim();if(!F){alert("لطفاً نام کلاس را وارد کنید.");return}if(re[F]){alert("کلاسی با این نام قبلاً ایجاد شده است.");return}try{const J=document.querySelector('input[name="modal-class-type"]:checked');if(!J){console.error("❌ DEBUG: Class Type radio not selected or found!");return}const ie=J.value,ce=ns.value,ne=pn.value.trim();if(!ne){V("⚠️ لطفاً نام کلاس را وارد کنید.");return}if(re[ne]){V("⚠️ کلاسی با این نام وجود دارد.");return}const le=((W=document.querySelector('input[name="modal-class-type"]:checked'))==null?void 0:W.value)||"in-person",pe=ns.value,Ee=ba.value||null,Ne=zi.value.trim()||null,Ke=Array.from(as.querySelectorAll("input:checked")).map(xe=>parseInt(xe.value,10)),Cs=$i.value||null,ws=Pi.value||null,pt=new Ls({name:ne,type:le,educationalSystem:pe,level:Ee,scheduleText:Ne,scheduleDays:Ke,scheduleStartTime:Cs,scheduleEndTime:ws});re[ne]=pt,oe(),ge(),He(),V(`✅ کلاس «${ne}» ایجاد شد.`),re[F]=pt,oe(),He(),Gs()}catch(J){console.error("❌ CRASH ERROR:",J),alert("خطایی رخ داد: "+J.message)}}):console.error("❌ DEBUG: Create Button (ui.confirmAddClassBtn) is NOT found!"),t.addEventListener("input",B=>{const F=B.target.value;if(F.length<2){Hn([]);return}const W=F.toLowerCase(),J=On(W),ie=[];for(const ce in re){const ne=re[ce];if(ne.isDeleted)continue;const le=Ue(ce.toLowerCase()),pe=le.includes(Ue(W)),Ee=le.includes(Ue(J));(pe||Ee)&&ie.push({type:"classroom",classroom:ne})}for(const ce in re){const ne=re[ce];if(ne.isDeleted)continue;Se(ne.students).filter(pe=>{const Ee=Ue(pe.identity.name.toLowerCase()),Ne=Ee.includes(Ue(W)),Ke=Ee.includes(Ue(J));return Ne||Ke}).forEach(pe=>{ie.push({type:"student",student:pe,classroom:ne})})}Hn(ie)}),r.addEventListener("click",Wi),C.addEventListener("click",()=>{gn("selector")}),P.addEventListener("input",B=>{const F=B.target.value;if(!F){sn([]);return}const W=F.toLowerCase(),J=On(W),ce=Se(A.students).filter(ne=>{const le=Ue(ne.identity.name.toLowerCase()),pe=le.includes(Ue(W)),Ee=le.includes(Ue(J));return pe||Ee});sn(ce)}),P.addEventListener("focus",()=>{P.value&&sn(P.value)}),Rt.addEventListener("click",()=>{const B=ht.value,F=ct.value.trim();let W;if(Vn)W=Vn.student;else{const ie=K==null?void 0:K.winnerHistory[Ve];W=ie==null?void 0:ie.winner}if(!W){V("❌خطا: دانش‌آموز معتبری برای ثبت نمره یافت نشد.");return}const J=ze;if(!W||!J){V("⚠️لطفاً ابتدا یک دانش‌آموز و یک دسته‌بندی را انتخاب کنید.");return}if(!B){V("⚠️لطفاً مقدار نمره را وارد کنید.");return}if(B>100||B<0){V("❌نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}W&&(W.addScore(J.name,parseFloat(B),F),_e(A.info.name,`نمره ${B} در ${J.name} برای «${W.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:W.identity.studentId}),oe(),Ae(),V(`✅نمره برای ${W.identity.name} در مهارت ${J.name} ثبت شد.`),ma(ze.id,W.identity.studentId),ht.value="",ct.value="",Oe())});const X=B=>{B.key==="Enter"&&B.ctrlKey&&(B.preventDefault(),Rt.click())};ht.addEventListener("keydown",X),ct.addEventListener("keydown",X),me.addEventListener("click",()=>{ge()}),Z.addEventListener("click",()=>{const B=fe.value.trim(),F=na;if(typeof F=="function"){const W=F(B);if(W===!1)return;ge(()=>{typeof W=="function"&&W()})}else ge()});const ue=document.getElementById("move-student-confirm-btn"),Le=document.getElementById("move-student-cancel-btn"),ve=document.getElementById("move-student-class-select");Le.addEventListener("click",()=>{ge()}),ue.addEventListener("click",()=>{const B=ve.value,F=re[B],{studentToMove:W,sourceClassForMove:J}=za;if(!W||!J||!F){V("خطایی رخ داد. لطفاً دوباره امتحان کنید⚠️.","error"),ge();return}const ie=si(W,J,F);ie.success?(_e(J.info.name,`دانش‌آموز «${W.identity.name}» به کلاس «${B}» منتقل شد.`,{type:"VIEW_SESSIONS"}),_e(B,`دانش‌آموز «${W.identity.name}» از کلاس «${J.info.name}» به این کلاس منتقل شد.`,{type:"VIEW_SESSIONS"}),oe(),_t(),Ae(),it(),V(`دانش‌آموز «${W.identity.name}» با موفقیت به کلاس «${B}» منتقل شد✅.`)):V(ie.message,"error"),ge()}),_.addEventListener("click",()=>{x.style.width="300px",N.classList.add("modal-visible")}),_.addEventListener("click",()=>{x.style.width="300px",N.classList.add("modal-visible")});const Ge=document.getElementById("header-settings-btn");Ge&&Ge.addEventListener("click",()=>{A&&kt(A)}),L.addEventListener("click",be),L.addEventListener("click",be),N.addEventListener("click",be),Re.addEventListener("click",()=>{bn(),ye("trash-page"),be()});const vt=document.getElementById("restore-points-nav-btn");vt&&vt.addEventListener("click",()=>{Qi(),ye("restore-points-page"),be()}),document.getElementById("demo-mode-btn").addEventListener("click",()=>{ft?It():(be(),Ce("شما در حال ورود به حالت نمایش (Demo) هستید. در این حالت، هیچ‌کدام از تغییرات شما ذخیره نخواهد شد. آیا ادامه می‌دهید؟",()=>{ii(),Wn(),be()},{confirmText:"تایید",confirmClass:"btn-warning",onCancel:be}))});const bt=document.getElementById("exit-demo-btn");bt&&bt.addEventListener("click",()=>{ft&&It()}),R.addEventListener("click",()=>{if(ft){V("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است."),be();return}be(),yn()}),j.addEventListener("click",()=>{if(ft){V("⚠️ بازیابی اطلاعات در حالت نمایش (Demo) غیرفعال است."),be();return}ee.click(),be()}),ee.addEventListener("change",B=>{const F=B.target.files[0];if(!F)return;const W=new FileReader;W.onload=async J=>{const ie=J.target.result;try{const ce=JSON.parse(ie);if(ce.metadata&&ce.data)is(ce);else{const ne=ce.classrooms||ce,le=ce.trashBin||[];Ce("آیا از بازیابی اطلاعات مطمئن هستید؟ تمام داده‌های فعلی شما بازنویسی خواهد شد.",()=>{Pt(ne),ua(le),wt({lastRestoreTimestamp:new Date().toISOString()}),oe(),He(),ye("class-management-page"),V("✅اطلاعات با موفقیت بازیابی شد.")},{confirmText:"بازیابی کن",confirmClass:"btn-warning"})}}catch{try{const pe=(await new Vs().loadAsync(ie,{base64:!0})).file("backup.json");if(!pe)throw new Error("فایل backup.json در فایل پشتیبان یافت نشد.");const Ee=await pe.async("string"),Ne=JSON.parse(Ee);if(Ne.metadata&&Ne.metadata.version==="2.0-b64")is(Ne);else throw new Error("فایل پشتیبان معتبر نیست (نسخه نامشخص).")}catch(ne){V("❌خطا در خواندن فایل. لطفاً فایل پشتیبان معتبر انتخاب کنید."),console.error("Restore error (zip/base64):",ne)}}},W.readAsText(F),B.target.value=null}),window.addEventListener("popstate",B=>{if(St){ge(null,!0);return}if(At(),B.state){const{pageId:F,currentClassName:W,selectedSessionNumber:J,selectedStudentId:ie}=B.state;W&&(je(re[W]),J&&Xe(A.getSession(J)),ie&&Qe(A.students.find(ce=>ce.identity.studentId===ie))),F==="session-page"?(Ze(),dn(F)):F==="student-profile-page"?(Ze(),ye("session-page"),Fe(Ie)):dn(F)}else je(null),Xe(null),Qe(null),dn("class-management-page")}),document.addEventListener("keydown",B=>{var J;const F=document.activeElement;if(!["INPUT","TEXTAREA","SELECT"].includes(F.tagName)){if(B.key.toLowerCase()==="o"&&B.shiftKey&&Ei.classList.contains("active")&&(B.preventDefault(),Ii.click()),B.key==="Escape"){if(zt.classList.contains("visible")){At();return}if(St){ge();return}switch((J=document.querySelector(".page.active"))==null?void 0:J.id){case"csv-preview-page":case"column-mapping-page":ye("settings-page");break;case"student-profile-page":Qe(null),ye(K?"student-page":"session-page");break;case"attendance-page":ye("student-page");break;case"student-page":Xe(null),Ze(),ye("session-page");break;case"settings-page":case"session-page":je(null),ye("class-management-page");break}return}if(K){const ie=B.key.toLowerCase();switch(" ascfg".includes(ie)&&B.preventDefault(),ie){case" ":v.click();break;case"a":b.classList.contains("active")?history.back():(it(),ye("attendance-page"));break;case"s":document.getElementById("session-page").classList.contains("active")&&history.back();break;case"c":document.querySelector(".back-to-classes-btn").click();break;case"f":const ce=document.querySelector(".action-column .search-icon");ce&&ce.click();break;case"g":if(studentProfilePage.classList.contains("active"))history.back();else{const ne=K.lastSelectedWinnerId;if(ne){const le=A.students.find(pe=>pe.identity.studentId===ne);le&&(Qe(le),(void 0)(),ye("student-profile-page"))}else V("⚠️ابتدا یک نفر را انتخاب کنید تا پروفایل او نمایش داده شود.")}break;case"arrowleft":{const ne=document.querySelector('button[title="برنده قبلی"]');ne&&!ne.disabled&&(B.preventDefault(),ne.click());break}case"arrowright":{const ne=document.querySelector('button[title="برنده بعدی"]');ne&&!ne.disabled&&(B.preventDefault(),ne.click());break}}}}});function be(){x.style.width="0",N.classList.add("modal-closing"),setTimeout(()=>{N.classList.remove("modal-visible","modal-closing")},300)}function It(){Ce("آیا از خروج از حالت نمایش (Demo) مطمئن هستید؟ با خروج، تمام تغییرات آزمایشی شما حذف شده و داده‌های اصلی شما بازیابی خواهند شد.",()=>{ri(),je(null),Xe(null),Qe(null),He(),ye("class-management-page"),Wn(),be()},{confirmText:"خروج",confirmClass:"btn-success"})}Je(".global-search-container .animated-search-container",Hn),Je(".action-column-header .animated-search-container",sn),Xo(),[ke,Bi,ct,_i].forEach(B=>{B&&_a(B)});function tt(B,F){const W=Se(F.students).filter(xe=>xe.identity.studentId!==B.identity.studentId);if(W.length===0)return;const J=W.reduce((xe,We)=>We.statusCounters.totalSelections>xe.statusCounters.totalSelections?We:xe,W[0]);if(!J||J.statusCounters.totalSelections===0)return;B.categoryCounts=JSON.parse(JSON.stringify(J.categoryCounts)),B.statusCounters.totalSelections=J.statusCounters.totalSelections;const ie=W.reduce((xe,We)=>xe+We.statusCounters.totalSelections,0),ce=W.reduce((xe,We)=>xe+(We.statusCounters.missedChances||0),0),ne=ie>0?ce/ie:0;B.statusCounters.missedChances=Math.round(B.statusCounters.totalSelections*ne);const le=Se(F.categories),pe={};le.forEach(xe=>{const We=W.reduce((Ss,ks)=>Ss+(ks.categoryCounts[xe.name]||0),0),Es=W.reduce((Ss,ks)=>Ss+(ks.categoryIssues[xe.name]||0),0);pe[xe.name]=We>0?Es/We:0}),le.forEach(xe=>{const We=B.categoryCounts[xe.name]||0,Es=pe[xe.name]||0;B.categoryIssues[xe.name]=Math.round(We*Es)});const Ee=F.liveSession;Ee?B.onboardingSession=Ee.sessionNumber:B.onboardingSession=F.sessions.length+1;const Ne=Se(F.sessions).filter(xe=>xe.isFinished&&!xe.isCancelled),Ke="📝 یادداشت خودکار سیستم",ws=`این دانش‌آموز  از جلسه شماره ${Ne.length} به کلاس اضافه شد. آمار مشارکت او بر اساس فعال‌ترین دانش‌آموز و آمار «فرصت از دست رفته» او بر اساس میانگین کلاس ثبت گردید:`,pt=[];B.statusCounters.totalSelections>0&&pt.push(`کل انتخاب‌ها: ${B.statusCounters.totalSelections}`),B.statusCounters.missedChances>0&&pt.push(`فرصت‌های از دست رفته: ${B.statusCounters.missedChances}`);for(const xe in B.categoryCounts){const We=B.categoryCounts[xe];We>0&&pt.push(`انتخاب در «${xe}»: ${We}`)}for(const xe in B.categoryIssues){const We=B.categoryIssues[xe];We>0&&pt.push(`مشکل در «${xe}»: ${We}`)}if(pt.length>0){const xe=`${Ke}
${ws}

- ${pt.join(`
- `)}`;B.addNote(xe)}}function Kt(B,F=""){const W=B>1?"دانش‌آموزان جدید":"دانش‌آموز جدید";let J=`✅ ${B} ${W} با موفقیت اضافه شدند.
`;J+="💡 چون این کلاس جلسات برگزار شده دارد، برای این افراد آمار پایه‌ای (متناسب با کلاس) ثبت شد تا در فرایند انتخاب اختلالی ایجاد نشود.",F&&(J+=`
${F}`),Ce(J,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}const ps="22.0.1",gs="878";{const B=` (ساخت ${gs})`;document.getElementById("app-version").textContent=`نسخه ${ps}${B}`}function ys(){console.log("Starting universal backfill for writing scores...");let B=0;for(const F in re){const W=re[F];if(W.isDeleted)continue;let J=0;Se(W.students).forEach(ce=>{const ne=ce.logs.scores;if(!(ne&&ne.writing&&ne.writing.length>0)){let pe=-1;for(const Ee in ne)Ee!=="writing"&&ne[Ee].forEach(Ne=>{Ne.value>pe&&(pe=Ne.value)});if(pe>-1){const Ee=`Automatically assigned based on the highest score (${pe}) from other skills.`;ce.addScore("Writing",pe,Ee),J++}}}),J>0&&(console.log(`Updated ${J} student(s) in class: ${W.info.name}.`),B+=J)}B>0?(oe(),console.log(`Update complete. A total of ${B} student(s) were updated across all classes. Data saved.`),document.getElementById("student-page").classList.contains("active")&&Ae()):console.log("No students needed updating in any class.")}window.backfillWritingScoresForAll=ys;function kn(){console.log("Starting backfill for 'outOfClassCount' and 'wasOutOfClass' properties...");let B=0,F=0;const W=localStorage.getItem("teacherAssistantData_v2");if(!W){console.log("No data found in localStorage. Nothing to do.");return}const J=JSON.parse(W);for(const ie in J){const ce=J[ie];ce.students&&ce.students.forEach(ne=>{ne.statusCounters&&typeof ne.statusCounters.outOfClassCount>"u"&&(ne.statusCounters.outOfClassCount=0,B++)}),ce.sessions&&ce.sessions.forEach(ne=>{if(ne.studentRecords)for(const le in ne.studentRecords){const pe=ne.studentRecords[le];typeof pe.wasOutOfClass>"u"&&(pe.wasOutOfClass=!1,F++)}})}localStorage.setItem("teacherAssistantData_v2",JSON.stringify(J)),console.log(`Backfill complete. Updated ${B} students and ${F} session records. Data saved.`),Kn(),A&&Ae()}window.backfillExitCounters=kn;function xt(){console.log("🧹 Starting orphaned data cleanup...");let B=0;for(const F in re){const W=re[F];if(W.isDeleted)continue;let J=!1;const ie=new Set(W.students.filter(le=>!le.isDeleted).map(le=>le.identity.studentId)),ce=new Map(W.students.map(le=>[le.identity.studentId,le.identity.name])),ne=[];W.sessions.forEach(le=>{if(le.isDeleted)return;const pe=[];for(const Ee in le.studentRecords)if(!ie.has(Ee)){const Ne=ce.get(Ee)||"Unknown/Deleted";pe.push(`  - Removed student record for: ${Ne} (ID: ${Ee})`),delete le.studentRecords[Ee],B++,J=!0}for(const Ee in le.lastWinnerByCategory){const Ne=le.lastWinnerByCategory[Ee];if(!ie.has(Ne)){const Ke=ce.get(Ne)||"Unknown/Deleted";pe.push(`  - Removed '${Ee}' last winner: ${Ke} (ID: ${Ne})`),delete le.lastWinnerByCategory[Ee],B++,J=!0}}if(le.lastSelectedWinnerId&&!ie.has(le.lastSelectedWinnerId)){const Ee=le.lastSelectedWinnerId,Ne=ce.get(Ee)||"Unknown/Deleted";pe.push(`  - Cleared 'lastSelectedWinnerId': ${Ne} (ID: ${Ee})`),le.lastSelectedWinnerId=null,B++,J=!0}if(pe.length>0){const Ne=at(W).get(le.sessionNumber)||`(#${le.sessionNumber})`;ne.push({sessionDisplayNumber:Ne,logs:pe})}}),J&&(console.group(`➡️ Class: ${F}`),ne.forEach(le=>{console.groupCollapsed(`  Session ${le.sessionDisplayNumber}`),le.logs.forEach(pe=>console.warn(pe)),console.groupEnd()}),console.groupEnd())}B>0?(oe(),console.log(`✅ Cleanup complete! Found and removed ${B} orphaned references. Data saved.`)):console.log("✅ No orphaned data found. Your data is clean!")}window.cleanupOrphanedData=xt;function Ft(B){if(!B||!B.classroomName)return;const F=re[B.classroomName];if(!F){V("⚠️ کلاس مربوط به این گزارش یافت نشد.");return}je(F),ge(),setTimeout(()=>{switch(B.type){case"VIEW_STUDENT_PROFILE":{const W=F.students.find(J=>J.identity.studentId===B.studentId);W?Fe(W):V("⚠️ دانش‌آموز مورد نظر یافت نشد.");break}case"VIEW_TRASH":bn(),ye("trash-page");break;case"VIEW_SESSIONS":Ze(),ye("session-page");break;case"VIEW_CLASS_NOTE":ms(F);break;case"VIEW_CLASS_SETTINGS":kt(F);break}},300)}te.addEventListener("click",()=>{Sa()}),Q.addEventListener("click",()=>{ge()}),Be.addEventListener("click",()=>{const B=Me.value.trim(),F=he.checked;if(!B){Ca.style.display==="flex"?Ce("کادر یادداشت خالی است. آیا مطمئنید که می‌خواهید یادداشت‌های قبلی دانش‌آموزان انتخاب‌شده را پاک کنید؟",()=>{ge(),js("",!1)},{confirmText:"پاک کردن",confirmClass:"btn-warning"}):V("⚠️ لطفاً متن یادداشت را وارد کنید.");return}ge(()=>{js(B,F)})});const Lt=document.getElementById("screen-saver-overlay");let vs;const tr=2*60*1e3,La=["mousemove","keypress","scroll","click","touchstart"];function nr(){Lt.classList.add("visible")}function Ta(){Lt.classList.contains("visible")&&Lt.classList.remove("visible")}function _n(){Ta(),clearTimeout(vs),vs=setTimeout(nr,tr)}function In(B){B.preventDefault(),B.stopPropagation(),setTimeout(_n,0)}function Ba(){_n(),La.forEach(F=>window.addEventListener(F,_n)),Lt.addEventListener("click",In),Lt.addEventListener("touchstart",In);const B="22.0.1";{const F=document.getElementById("screen-saver-version");F&&(F.textContent=`v${B}`)}}function sr(){clearTimeout(vs),Ta(),La.forEach(B=>window.removeEventListener(B,_n)),Lt.removeEventListener("click",In),Lt.removeEventListener("touchstart",In)}document.getElementById("app-settings-modal");const Na=document.getElementById("app-settings-nav-btn"),Da=document.getElementById("close-settings-btn"),Aa=document.getElementById("setting-sound-toggle"),Oa=document.getElementById("setting-vibration-toggle"),Ma=document.getElementById("setting-screensaver-toggle");Na&&Na.addEventListener("click",()=>{be(),Aa.checked=Pe.isSoundEnabled,Oa.checked=Pe.isVibrationEnabled,Ma.checked=Pe.isScreenSaverEnabled,$e("app-settings-modal")}),Da&&Da.addEventListener("click",()=>{ge()}),Aa.addEventListener("change",B=>{wt({isSoundEnabled:B.target.checked}),B.target.checked&&Ts()}),Oa.addEventListener("change",B=>{wt({isVibrationEnabled:B.target.checked}),B.target.checked&&navigator.vibrate&&navigator.vibrate(50)}),Pe.isScreenSaverEnabled&&Ba(),Ma.addEventListener("change",B=>{B.target.checked?(wt({isScreenSaverEnabled:!0}),Ba()):(wt({isScreenSaverEnabled:!1}),sr())}),Dt(Ye,()=>{if(Is=!0,!ze){V("⚠️ ابتدا یک دسته‌بندی انتخاب کنید.");return}if(!ze.isGradedCategory){V("⚠️ این دسته‌بندی نمره‌دار نیست.");return}Ya(!Bt),yt(-1),Zt(null),Oe(),vn(ze),Mt.classList.toggle("assessment-mode-active",Bt),V(Bt?"حالت انتخاب برای نمره‌دهی فعال شد.":"حالت انتخاب معمولی فعال شد.")});const bs=document.getElementById("new-category-modal-weight-group");if(Nt&&bs){Nt.addEventListener("change",F=>{bs.style.display=F.target.checked?"flex":"none"});const B=Nt.checked;bs.style.display=B?"flex":"none"}});function Yo(t,r){if(!K||K.isFinished){V("⚠️ امکان لغو انتخاب در جلسه خاتمه یافته وجود ندارد.");return}if(Bt){Ce(`آیا از لغو وضعیت نمره‌دهی «${t.identity.name}» مطمئن هستید؟ این دانش‌آموز به لیست انتظار بازمی‌گردد.`,()=>{const s=ze.id,n=st[s];n&&(n.scoredThisSession=n.scoredThisSession.filter(i=>i!==t.identity.studentId)),Zt(null),Ae(),Oe(),oe(),V(`✅ «${t.identity.name}» به لیست انتظار نمره بازگشت.`)});return}const e=K.winnerHistory;if(!(Ve===e.length-1)||e.length===0){V("⚠️ فقط آخرین انتخاب قابل لغو است.");return}if(e[e.length-1].winner.identity.studentId!==t.identity.studentId){console.error("Undo mismatch!");return}Ce(`آیا از حذف انتخاب «${t.identity.name}» برای «${r}» مطمئن هستید؟ آمار این انتخاب بازگردانی خواهد شد.`,()=>{const s=K.winnerHistory,n=s.pop();if(!n)return;const i=n.winner,a=n.categoryName,o=i.identity.studentId;i.statusCounters.totalSelections=Math.max(0,i.statusCounters.totalSelections-1),i.categoryCounts[a]&&(i.categoryCounts[a]=Math.max(0,i.categoryCounts[a]-1));const l=K.studentRecords[o];if(l&&l.selections[a]&&(l.selections[a]=Math.max(0,l.selections[a]-1)),n.rating){const p=n.rating;i.qualitativeStats&&i.qualitativeStats[a]&&i.qualitativeStats[a][p]>0&&i.qualitativeStats[a][p]--}let m=null;for(let p=s.length-1;p>=0;p--)if(s[p].categoryName===a){m=s[p].winner.identity.studentId;break}m?K.lastWinnerByCategory[a]=m:delete K.lastWinnerByCategory[a],yt(s.length-1),Ae(),Oe(),oe(),V(`✅ انتخاب «${i.identity.name}» لغو شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}function Xo(){const t=document.getElementById("session-dashboard-page"),r=document.getElementById("student-stats-table-container");if(!t)return;let e=0,c=0;t.addEventListener("touchstart",n=>{if(r&&r.contains(n.target)){const i=n.target.closest("td, th");i&&i.parentElement.firstElementChild===i?e=n.changedTouches[0].screenX:e=0}else e=n.changedTouches[0].screenX},{passive:!0}),t.addEventListener("touchend",n=>{e!==0&&(c=n.changedTouches[0].screenX,s())});function s(){const i=e-c;Math.abs(i)>150&&(document.getElementById("selector-tab-btn").classList.contains("active")?(ye("session-dashboard-page",{tab:"attendance"}),gn("attendance")):(ye("session-dashboard-page",{tab:"selector"}),gn("selector"))),e=0,c=0}}function Wa(t,r){const e=r.toLowerCase();return(t.logs.scores[e]||[]).filter(s=>!s.isDeleted).length}function Qo(t,r){const e=r.id;st[e]||(st[e]={toBeScored:[],scoredThisSession:[]});const c=st[e],n=Se(t.students).filter(o=>!c.scoredThisSession.includes(o.identity.studentId));if(n.length===0)return c.toBeScored=[],[];const i=n.map(o=>Wa(o,r.name)),a=Math.min(...i);return c.toBeScored=n.filter(o=>Wa(o,r.name)===a).map(o=>o.identity.studentId),c.toBeScored}function ec(t,r){const e=Qo(t,r);if(e.length===0)return null;const c=Math.floor(Math.random()*e.length),s=e[c];return ma(r.id,s),t.students.find(n=>n.identity.studentId===s)}
