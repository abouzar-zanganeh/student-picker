(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function t(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(o){if(o.ep)return;o.ep=!0;const a=t(o);fetch(o.href,a)}})();class ct{constructor(n){this.identity={name:n.name,studentId:n.studentId||`id_${new Date().getTime()}_${Math.random()}`,branchName:n.branchName||null,ageGroup:n.ageGroup||"adult",level:n.level||null,contact:{social:n.socialContact||null,parent:n.parentContact||null}},this.isDeleted=!1,this.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0,outOfClassCount:0},this.categoryCounts={},this.categoryIssues={},this.logs={parentContacts:[],scores:{},discipline:{},sessionHistory:{}},this.profile={notes:[],tags:[]},this.finalClassActivityScore=null}addScore(n,t,s){if(t>100||t<0){console.log("نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}const o=n.toLowerCase();this.logs.scores[o]||(this.logs.scores[o]=[]);const a=new Ws(n,t,s);this.logs.scores[o].push(a)}addNote(n,t=null){const s=new Fs(n,t);this.profile.notes.push(s)}getOverallAverageScore(){let n=0,t=0;for(const o in this.logs.scores)this.logs.scores[o].forEach(a=>{a.isDeleted||(n+=a.value,t++)});if(t===0)return null;const s=n/t;return Math.round(s*100)/100}}class Ws{constructor(n,t,s=""){this.id=`score_${new Date().getTime()}`,this.skill=n,this.value=t,this.timestamp=new Date,this.comment=s,this.isDeleted=!1}}class Fs{constructor(n,t=null){this.id=`note_${new Date().getTime()}`,this.timestamp=new Date,this.content=n,this.isDeleted=!1,this.source=t}}class Rt{constructor(n="complete",t=""){this.status=n,this.comment=t,this.timestamp=new Date}}class Tn{constructor(n){this.sessionNumber=n,this.startTime=new Date,this.note="",this.isDeleted=!1,this.endTime=null,this.isFinished=!1,this.isMakeup=!1,this.isCancelled=!1,this.studentRecords={},this.lastWinnerByCategory={},this.lastUsedCategoryId=null,this.lastSelectedWinnerId=null,this.winnerHistory=[]}end(){this.isFinished=!0,this.endTime=new Date}markAsMakeup(){this.isMakeup=!this.isMakeup}initializeStudentRecord(n){this.studentRecords[n]||(this.studentRecords[n]={attendance:"present",homework:new Rt,selections:{},hadIssue:!1,wasOutOfClass:!1})}setAttendance(n,t){this.initializeStudentRecord(n),this.studentRecords[n].attendance=t}setHomeworkStatus(n,t){this.initializeStudentRecord(n),this.studentRecords[n].homework.status=t}selectNextWinner(n,t,s){if(!t||t.length===0)return console.log("هیچ دانش‌آموزی در کلاس برای انتخاب وجود ندارد."),null;const o=this.lastWinnerByCategory[n];let a=t.filter(u=>u.identity.studentId!==o&&!u.isDeleted);if(a.length===0&&(a=t),a.length===0)return null;const l=(u,p)=>u.categoryCounts[p]||0,d=Math.min(...a.map(u=>l(u,n))),i=a.filter(u=>l(u,n)===d);let g;if(i.length===1)g=i[0];else if(i.length>1){const u=s.filter(k=>!k.isDeleted&&k.name!==n).map(k=>k.name),p=i.map(k=>{const $=u.reduce((_,T)=>_+l(k,T),0);return{student:k,otherCategoriesTotal:$}}),b=Math.min(...p.map(k=>k.otherCategoriesTotal)),I=p.filter(k=>k.otherCategoriesTotal===b).map(k=>k.student);I.length===1?g=I[0]:g=I[Math.floor(Math.random()*I.length)]}else g=a[Math.floor(Math.random()*a.length)];const v=g.identity.studentId;this.initializeStudentRecord(v);const S=(this.studentRecords[v].selections[n]||0)+1;return this.studentRecords[v].selections[n]=S,g.statusCounters.totalSelections++,g.categoryCounts[n]=(g.categoryCounts[n]||0)+1,this.lastWinnerByCategory[n]=v,g}}class _t{constructor(n){this.info={name:n.name||"NotNamed",scheduleCode:n.scheduleCode||`code_${new Date().getTime()}`,teacherName:n.teacherName||null,type:n.type||"in-person",term:n.term||null,scheduleText:n.scheduleText||null,level:n.level||null,creationDate:n.creationDate?new Date(n.creationDate):new Date},this.students=[],this.sessions=[],this.note="",this.isDeleted=!1,this.categories=[new ye("Vocabulary","Questions about words and meanings."),new ye("Grammar","Questions about sentence structure and rules."),new ye("Listening",void 0,!0),new ye("Speaking",void 0,!0),new ye("Reading",void 0,!0),new ye("Writing",void 0,!0)],this.futurePlans={}}addStudent(n){this.students.push(n)}removeStudent(n){this.students=this.students.filter(t=>t.identity.studentId!==n)}startNewSession(){const n=this.sessions.length+1,t=new Tn(n);return this.sessions.push(t),t}endSpecificSession(n){const t=this.getSession(n);return t&&!t.isFinished?(t.end(),!0):!1}getSession(n){return this.sessions.find(t=>t.sessionNumber===n)}markAsMakeup(n){const t=this.getSession(n);t&&t.markAsMakeup()}planForSession(n,t){this.futurePlans[n]=t}hasSessionToday(){const n=new Date().toDateString();return this.sessions.some(t=>!t.isDeleted&&t.startTime.toDateString()===n)}selectNextWinner(n,t){return t?t.selectNextWinner(n,this.students,this.categories):null}get liveSession(){for(let n=this.sessions.length-1;n>=0;n--)if(!this.sessions[n].isFinished)return this.sessions[n];return null}endLiveSession(){const n=this.liveSession;return n?(n.end(),!0):!1}calculateFinalStudentScore(n){const t=n.logs.scores,s=["reading","writing"];for(const u of s)if(!t[u]||t[u].length===0)return null;const o=t.listening&&t.listening.length>0,a=t.speaking&&t.speaking.length>0;if(!o&&!a)return null;const l=u=>t[u].reduce((b,I)=>b+I.value,0)/t[u].length;let d;o&&a?d=(l("listening")+l("speaking"))/2:o?d=l("listening"):d=l("speaking");const i=l("reading"),g=l("writing"),S=(d*3+i*2+g*1)/6;return Math.trunc(S*10)/10}assignAllFinalScores(){let n=0,t=[];console.log("شروع عملیات محاسبه نمره نهایی برای تمام دانش‌آموزان..."),this.students.forEach(o=>{const a=this.calculateFinalStudentScore(o);a!==null?(o.finalClassActivityScore=a,n++):(o.finalClassActivityScore=null,t.push(o.identity.name))});const s=t.length;console.log(`عملیات پایان یافت. تعداد نمرات موفق: ${n} | تعداد ناموفق (نمرات ناقص): ${s}`),s>0&&(console.log("اسامی دانش‌آموزانی که نمراتشان ناقص است:"),t.forEach(o=>console.log(`- ${o}`)))}}class ye{constructor(n,t="",s=!1){this.id=`cat_${new Date().getTime()}_${Math.random()}`,this.name=n,this.description=t,this.isDeleted=!1,this.isGradedCategory=s,this.isDeleted=!1}}let w={},r=null,Zt=null,C=null,O=null,Xe=null,xt=null,en=[],Et=null,tn=null,de=null,vt=0,nn=0,bt=0,sn=0,an=null,on=null,It=null,Ie=null,ue=-1,St=null,Lt=null,kt=null,Dn=null,xn=null,fe=!1,D=[];function N(){if(fe)return;const e={classrooms:w,trashBin:D};localStorage.setItem("teacherAssistantData_v2",JSON.stringify(e))}function Mn(){const n=JSON.stringify({classrooms:w,trashBin:D},null,2),s=`SP-${new Date().toLocaleDateString("fa-IR-u-nu-latn").replace(/\//g,"-")}.txt`;return new File([n],s,{type:"text/plain"})}function wt(){const e=localStorage.getItem("teacherAssistantData_v2");if(!e)return;const n=JSON.parse(e);n.classrooms?(_e(n.classrooms),D=n.trashBin||[]):(_e(n),qs())}function qs(){const e=[];Object.values(w).forEach(n=>{n.isDeleted?e.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:n.info.creationDate,type:"classroom",description:`کلاس «${n.info.name}»`,restoreData:{name:n.info.name}}):n.students.forEach(t=>{t.isDeleted&&e.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:t.identity.studentId.split("_")[1],type:"student",description:`دانش‌آموز «${t.identity.name}»`,restoreData:{studentId:t.identity.studentId,classroomName:n.info.name}})})}),D.length===0&&e.length>0&&(D=e,console.log(`Migrated ${e.length} previously deleted item(s) to the new trash bin.`),N())}function _e(e){w={};for(const n in e){const t=e[n],s=new _t(t.info);s.isDeleted=t.isDeleted,s.note=t.note||"",s.students=t.students.map(o=>{const a=new ct(o.identity);return a.isDeleted=o.isDeleted,a.statusCounters=o.statusCounters,a.logs=o.logs,a.logs.scores||(a.logs.scores={}),a.profile=o.profile,a.finalClassActivityScore=o.finalClassActivityScore,a.categoryCounts=o.categoryCounts||{},a.categoryIssues=o.categoryIssues||{},a}),s.sessions=t.sessions.map(o=>{const a=new Tn(o.sessionNumber);a.isDeleted=o.isDeleted,a.note=o.note||"",a.startTime=new Date(o.startTime),a.endTime=o.endTime?new Date(o.endTime):null,a.isFinished=o.isFinished,a.isMakeup=o.isMakeup,a.isCancelled=o.isCancelled||!1,a.studentRecords=o.studentRecords;for(const d in a.studentRecords){const i=a.studentRecords[d];i.homework&&!(i.homework instanceof Rt)&&(a.studentRecords[d].homework=new Rt(i.homework.status,i.homework.comment))}a.lastWinnerByCategory=o.lastWinnerByCategory,a.lastUsedCategoryId=o.lastUsedCategoryId,a.lastSelectedWinnerId=o.lastSelectedWinnerId;const l=o.winnerHistory||[];return a.winnerHistory=l.map(d=>({winner:s.students.find(g=>g.identity.studentId===d.winner.identity.studentId),categoryName:d.categoryName})),a}),s.categories=t.categories.map(o=>{const a=new ye(o.name,o.description,o.isGradedCategory);return a.id=o.id,a.isDeleted=o.isDeleted,a}),s.futurePlans=t.futurePlans,w[n]=s}}function $n(e,n){if(w[n])return{success:!1,message:"کلاسی با این نام از قبل وجود دارد."};const t=w[e];return t?(t.info.name=n,w[n]=t,delete w[e],r===t&&z(t),{success:!0}):{success:!1,message:"کلاس مورد نظر یافت نشد."}}function On(e,n,t){const s=t.trim();if(!s)return{success:!1,message:"نام دسته‌بندی نمی‌تواند خالی باشد."};if(e.categories.some(i=>i.id!==n.id&&!i.isDeleted&&i.name.toLowerCase()===s.toLowerCase()))return{success:!1,message:"دسته‌بندی دیگری با این نام وجود دارد."};const a=n.name,l=a.toLowerCase(),d=s.toLowerCase();return n.name=s,e.students.forEach(i=>{i.categoryCounts&&i.categoryCounts[a]!==void 0&&(i.categoryCounts[s]=i.categoryCounts[a],delete i.categoryCounts[a]),i.categoryIssues&&i.categoryIssues[a]!==void 0&&(i.categoryIssues[s]=i.categoryIssues[a],delete i.categoryIssues[a]),i.logs.scores&&i.logs.scores[l]&&(i.logs.scores[l].forEach(g=>g.skill=s),l!==d&&(i.logs.scores[d]=i.logs.scores[l],delete i.logs.scores[l]))}),e.sessions.forEach(i=>{i.lastWinnerByCategory&&i.lastWinnerByCategory[a]&&(i.lastWinnerByCategory[s]=i.lastWinnerByCategory[a],delete i.lastWinnerByCategory[a]),i.winnerHistory&&i.winnerHistory.forEach(g=>{g.categoryName===a&&(g.categoryName=s)})}),{success:!0}}function Hn(e,n,t){if(q(t.students).some(l=>l.identity.name.toLowerCase()===e.identity.name.toLowerCase()))return{success:!1,message:`دانش‌آموزی با نام «${e.identity.name}» از قبل در کلاس «${t.info.name}» وجود دارد.`};const o=JSON.parse(JSON.stringify(e));t.addStudent(o);const a=n.students.find(l=>l.identity.studentId===e.identity.studentId);return a&&Ye(a,n),{success:!0}}function An(){for(const e in w){const n=w[e];n.students.forEach(t=>{t.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0},t.categoryCounts={},t.categoryIssues={},n.sessions.forEach(s=>{const o=t.identity.studentId;s.studentRecords[o]&&(s.studentRecords[o].attendance="present")})})}N()}function q(e){return Array.isArray(e)?e.filter(n=>!n.isDeleted):[]}function ve(e){const n=new Map;return e&&q(e.sessions).filter(s=>!s.isCancelled).sort((s,o)=>s.sessionNumber-o.sessionNumber).forEach((s,o)=>{n.set(s.sessionNumber,o+1)}),n}function Te(e){ue=e}function pe(e){St=e}function Ye(e,n){if(!e||!n)return;const t=e.identity.studentId,s=n.students.findIndex(o=>o.identity.studentId===t);s>-1&&n.students.splice(s,1),n.sessions.forEach(o=>{o.studentRecords[t]&&delete o.studentRecords[t]})}function Rn(e,n){const t=w[e];if(!t)return;const s=t.sessions.findIndex(o=>o.sessionNumber===n);s>-1&&t.sessions.splice(s,1)}function _n(e,n){const t=w[e];if(!t)return;const s=t.categories.findIndex(d=>d.id===n);if(s===-1)return;const a=t.categories[s].name,l=a.toLowerCase();t.students.forEach(d=>{d.categoryCounts&&delete d.categoryCounts[a],d.categoryIssues&&delete d.categoryIssues[a],d.logs.scores&&delete d.logs.scores[l]}),t.categories.splice(s,1)}function Pn(e,n,t,s){const o=w[e];if(!o)return;const a=o.students.find(i=>i.identity.studentId===n);if(!a||!a.logs.scores[t.toLowerCase()])return;const l=a.logs.scores[t.toLowerCase()],d=l.findIndex(i=>i.id===s);d>-1&&l.splice(d,1)}function Wn(e,n,t){const s=w[e];if(!s)return;const o=s.students.find(l=>l.identity.studentId===n);if(!o||!o.profile.notes)return;const a=o.profile.notes.findIndex(l=>l.id===t);a>-1&&o.profile.notes.splice(a,1)}function Fn(){JSON.parse(JSON.stringify({classrooms:w,trashBin:D})),fe=!0}function qn(){fe=!1,wt()}function z(e){r=e}function Ze(e){Zt=e}function X(e){C=e}function G(e){O=e}function Nt(e){Xe=e}function Un(e){xt=e}function Ve(e){en=e}function lt(e){Et=e}function Vn(e){tn=e}function cn(e){de=e}function rt(e){vt=e}function Gn(e){nn=e}function dt(e){bt=e}function jn(e){sn=e}function ln(e){an=e}function rn(e){on=e}function et(e){It=e}function dn(e){Ie=e}function Bt(e){kt=e}function Jn(e){Dn=e}function zn(e){xn=e}function Pt(e){D=e}function Mt(e){Lt=e}const Us=Object.freeze(Object.defineProperty({__proto__:null,get activeModal(){return Ie},get cancelCallback(){return on},get classrooms(){return w},get confirmCallback(){return an},get currentClassroom(){return r},get easterEggClickCount(){return vt},get easterEggLastClickTime(){return nn},enterDemoMode:Fn,exitDemoMode:qn,getActiveItems:q,getSessionDisplayMap:ve,get importedFileContent(){return Et},get isDemoMode(){return fe},get liveSession(){return Zt},loadData:wt,get manualSelection(){return kt},moveStudent:Hn,get namesToImport(){return en},get notificationTimeout(){return tn},permanentlyDeleteCategory:_n,permanentlyDeleteNote:Wn,permanentlyDeleteScore:Pn,permanentlyDeleteSession:Rn,permanentlyDeleteStudent:Ye,prepareBackupData:Mn,get previousState(){return Xe},rehydrateData:_e,renameCategory:On,renameClassroom:$n,resetAllStudentCounters:An,get resetEasterEggClickCount(){return bt},get resetEasterEggLastClickTime(){return sn},get saveCategoryCallback(){return Lt},saveData:N,get saveNoteCallback(){return St},get secureConfirmCallback(){return It},get selectedCategory(){return de},get selectedSession(){return C},get selectedStudentForProfile(){return O},setActiveModal:dn,setCancelCallback:rn,setConfirmCallback:ln,setCurrentClassroom:z,setEasterEggClickCount:rt,setEasterEggLastClickTime:Gn,setImportedFileContent:lt,setLiveSession:Ze,setManualSelection:Bt,setNamesToImport:Ve,setNotificationTimeout:Vn,setPreviousState:Nt,setResetEasterEggClickCount:dt,setResetEasterEggLastClickTime:jn,setSaveCategoryCallback:Mt,setSaveNoteCallback:pe,setSecureConfirmCallback:et,setSelectedCategory:cn,setSelectedSession:X,setSelectedStudentForProfile:G,setSourceClassForMove:zn,setStudentToMove:Jn,setTrashBin:Pt,setUndoTimeout:Un,setWinnerHistoryIndex:Te,get sourceClassForMove(){return xn},get studentToMove(){return Dn},get trashBin(){return D},get undoTimeout(){return xt},get winnerHistoryIndex(){return ue}},Symbol.toStringTag,{value:"Module"}));function Oe(e){return typeof e!="string"?"":e.replace(/ي/g,"ی").replace(/ك/g,"ک").replace(/[\s\u200c]/g,"")}function tt(e){return typeof e!="string"||e.length===0?"ltr":/[\u0590-\u07FF]/.test(e)?"rtl":"ltr"}function Kn(e){return!e||!e.trim()?"":e.split(`
`).map(s=>`<div dir="${tt(s)}">${s||"&nbsp;"}</div>`).join("")}function Nn(e){if(typeof e!="string")return"";const n={q:"ض",w:"ص",e:"ث",r:"ق",t:"ف",y:"غ",u:"ع",i:"ه",o:"خ",p:"ح","[":"ج","]":"چ",a:"ش",s:"س",d:"ی",f:"ب",g:"ل",h:"ا",j:"ت",k:"ن",l:"م",";":"ک","'":"گ",z:"ظ",x:"ط",c:"ز",v:"ر",b:"ذ",n:"د",m:"پ",",":"و"};let t="";for(let s=0;s<e.length;s++){const o=e[s].toLowerCase();t+=n[o]||e[s]}return t}const Qn="teacherAssistantLogs_v2",Vs=100;function un(){try{const e=localStorage.getItem(Qn);return e?JSON.parse(e):{}}catch(e){return console.error("Error reading logs from localStorage:",e),{}}}function Xn(e){try{localStorage.setItem(Qn,JSON.stringify(e))}catch(n){console.error("Error saving logs to localStorage:",n)}}function A(e,n,t=null){if(!e)return;const s=un();s[e]||(s[e]=[]);const o={timestamp:new Date().toISOString(),message:n,action:t,classroomName:e};s[e].unshift(o),s[e].length>Vs&&s[e].pop(),Xn(s)}function Gs(e){return un()[e]||[]}function js(e,n){const t=un();t[e]&&!t[n]&&(t[n]=t[e],delete t[e],Xn(t))}const Yn=document.getElementById("class-management-page"),Js=document.getElementById("new-class-name"),zs=document.getElementById("add-class-btn"),Wt=document.getElementById("class-list"),Tt=document.getElementById("undo-toast"),Zn=document.getElementById("undo-message"),Ks=document.getElementById("undo-btn"),Qs=document.getElementById("settings-page"),mn=document.getElementById("settings-class-name-header"),Ft=document.getElementById("settings-student-list"),qt=document.getElementById("category-list"),Xs=document.getElementById("back-to-sessions-btn"),Ys=document.getElementById("new-student-name"),Zs=document.getElementById("add-student-btn"),es=document.getElementById("paste-area"),ea=document.getElementById("process-paste-btn"),ta=document.getElementById("csv-preview-page"),Ut=document.getElementById("csv-preview-list"),na=document.getElementById("csv-confirm-btn"),sa=document.getElementById("csv-cancel-btn"),aa=document.getElementById("import-csv-btn"),oa=document.getElementById("csv-file-input"),ia=document.getElementById("column-mapping-page"),Vt=document.getElementById("column-select-dropdown"),ca=document.getElementById("confirm-column-btn"),la=document.getElementById("cancel-import-btn"),ra=document.getElementById("new-category-name"),da=document.getElementById("add-category-btn"),Gt=document.querySelector(".app-header"),Se=document.getElementById("select-student-btn"),nt=document.getElementById("select-student-btn-wrapper"),ua=document.getElementById("attendance-page"),ut=document.getElementById("attendance-list"),ma=document.getElementById("finish-attendance-btn"),fa=document.getElementById("back-to-sessions-from-attendance-btn"),pa=document.getElementById("back-to-attendance-btn"),ga=document.querySelector("#class-management-page h2"),jt=document.getElementById("student-stats-header"),ha=document.getElementById("hamburger-menu-btn"),ya=document.getElementById("side-nav-menu"),Ca=document.getElementById("close-nav-btn"),Ea=document.getElementById("overlay"),va=document.getElementById("backup-data-btn"),ba=document.getElementById("restore-data-btn"),ts=document.getElementById("restore-file-input"),Ia=document.getElementById("custom-confirm-modal"),ns=document.getElementById("confirm-modal-message"),Jt=document.getElementById("confirm-modal-cancel-btn"),Ge=document.getElementById("confirm-modal-confirm-btn"),Sa=document.getElementById("secure-confirm-modal"),ss=document.getElementById("secure-confirm-message"),as=document.getElementById("secure-confirm-code"),He=document.getElementById("secure-confirm-input"),La=document.getElementById("secure-confirm-cancel-btn"),mt=document.getElementById("secure-confirm-confirm-btn"),ka=document.getElementById("add-note-modal"),R=document.getElementById("new-note-content"),wa=document.getElementById("class-save-note-btn"),Na=document.getElementById("cancel-note-btn"),zt=document.getElementById("student-search-input"),be=document.getElementById("student-search-results"),Ba=document.getElementById("student-profile-page"),os=document.getElementById("profile-student-name-header"),Ta=document.getElementById("back-to-student-page-btn"),Ae=document.getElementById("graded-category-pills-container"),Kt=document.getElementById("new-score-value"),fn=document.getElementById("new-score-comment"),Da=document.getElementById("add-score-btn"),je=document.getElementById("profile-stats-summary"),ft=document.getElementById("profile-scores-list"),pt=document.getElementById("global-student-search-input"),he=document.getElementById("global-student-search-results"),xa=document.getElementById("is-graded-checkbox"),Ma=document.getElementById("trashed-classes-list"),$a=document.getElementById("trashed-students-list"),Oa=document.getElementById("trashed-sessions-list"),Ha=document.getElementById("trashed-categories-list"),Aa=document.getElementById("trashed-notes-list"),Ra=document.getElementById("trashed-scores-list"),Dt=document.getElementById("quick-grade-form-wrapper"),Ce=document.getElementById("quick-score-input"),me=document.getElementById("quick-note-textarea"),Pe=document.getElementById("quick-grade-submit-btn"),ze=document.getElementById("category-selection-container"),is=document.getElementById("selected-student-result"),De=document.getElementById("custom-context-menu"),Re=document.getElementById("breadcrumb-container"),_a=document.getElementById("category-modal"),cs=document.getElementById("category-modal-title"),Ke=document.getElementById("new-category-modal-name"),pn=document.getElementById("new-category-modal-is-graded"),Pa=document.getElementById("category-modal-cancel-btn"),ls=document.getElementById("category-modal-save-btn");function Wa(e){clearTimeout(xt),Xe||Nt(JSON.stringify(w)),Zn.textContent=e,Tt.classList.add("show"),Un(setTimeout(()=>{Tt.classList.remove("show"),Nt(null)},5e3))}function rs(){if(Xe){const e=r?r.info.name:null,n=JSON.parse(Xe);_e(n),e&&w[e]?z(w[e]):z(null),r?(Ee(),We(),J()):oe(),Tt.classList.remove("show"),clearTimeout(xt),Nt(null)}}function y(e,n=3e3){const t=document.getElementById("notification-toast");t&&(t.textContent=e,t.classList.add("show"),clearTimeout(tn),Vn(setTimeout(()=>{t.classList.remove("show")},n)))}function U(e,n,t={}){const{confirmText:s="تایید",cancelText:o="لغو",confirmClass:a="btn-success",onCancel:l=()=>{},isDelete:d=!1}=t,i=d?()=>ds(e,n):n;ns.textContent=e,Ge.textContent=s,Jt.textContent=o,Ge.className="modal-action-btn",Ge.classList.add(a),ln(i),rn(l);const g=Ge.parentElement;Jt.style.display=l===null?"none":"inline-block",g.style.justifyContent=l===null?"center":"space-between",Z("custom-confirm-modal")}function ds(e,n){const t=Math.floor(1e4+Math.random()*9e4).toString();ss.textContent=e,as.textContent=t,He.value="",mt.disabled=!0,et(n),Z("secure-confirm-modal"),He.focus();const s=()=>{He.value===t?mt.disabled=!1:mt.disabled=!0};return He.addEventListener("input",s),()=>{He.removeEventListener("input",s)}}function Qt(e,n={}){const{title:t="ایجاد دسته‌بندی جدید",initialName:s="",initialIsGraded:o=!1,saveButtonText:a="ذخیره"}=n;cs.textContent=t,Ke.value=s,pn.checked=o,ls.textContent=a,Mt((l,d)=>{if(!l){y("⚠️ لطفاً نام دسته‌بندی را وارد کنید.");return}e(l,d),Q()}),Z("category-modal"),Ke.focus(),s&&Ke.select()}function us(e,n){const t=Object.values(w).filter(l=>!l.isDeleted&&l.info.name!==n.info.name),s=document.getElementById("move-student-modal-title"),o=document.getElementById("move-student-class-select"),a=document.getElementById("move-student-confirm-btn");s.textContent=`انتقال دانش‌آموز: ${e.identity.name}`,o.innerHTML="",t.length===0?(o.innerHTML='<option value="">کلاس دیگری برای انتقال وجود ندارد</option>',a.disabled=!0):(t.forEach(l=>{const d=document.createElement("option");d.value=l.info.name,d.textContent=l.info.name,o.appendChild(d)}),a.disabled=!1),Jn(e),zn(n),Z("move-student-modal")}function gn(e,n){if(!e||!n)return;const t=e.identity.name,s=document.getElementById("add-note-modal-title");s.textContent="تغییر نام دانش‌آموز",R.value=t,R.rows=1,R.dispatchEvent(new Event("input",{bubbles:!0})),pe(o=>{const a=o.trim();a&&a!==t&&(q(n.students).some(d=>d.identity.studentId!==e.identity.studentId&&d.identity.name.toLowerCase()===a.toLowerCase())?y("دانش‌آموزی با این نام از قبل در این کلاس وجود دارد."):(e.identity.name=a,A(n.info.name,`نام دانش‌آموز «${t}» به «${a}» تغییر یافت.`,{type:"VIEW_STUDENT_PROFILE",studentId:e.identity.studentId}),N(),Ee(),ne(),O&&O.identity.studentId===e.identity.studentId&&Y(),y(`✅نام دانش‌آموز به «${a}» تغییر یافت.`))),s.textContent="ثبت یادداشت جدید",R.rows=4}),Z("add-note-modal"),R.focus(),R.select()}function Z(e){const n=document.getElementById(e);if(n){if(Ie)return;n.classList.add("modal-visible"),dn(e),history.pushState(null,"",location.href)}}function Q(e){if(!Ie)return;const n=document.getElementById(Ie),t=Ie;dn(null),history.back(),n&&(n.classList.add("modal-closing"),setTimeout(()=>{n.classList.remove("modal-visible"),n.classList.remove("modal-closing"),t==="custom-confirm-modal"&&(ln(null),rn(null)),t==="secure-confirm-modal"&&et(null),t==="category-modal"&&Mt(null),t==="add-note-modal"&&pe(null),typeof e=="function"&&e()},300))}function hn(e){R.value=e.note||"",pe(n=>{e.note=n,N(),A(e.info.name,"یادداشت کلاس ذخیره شد.",{type:"VIEW_CLASS_NOTE"}),oe(),y("✅ یادداشت کلاس ذخیره شد.")}),Z("add-note-modal"),R.focus()}function yn(e){z(e),mn.textContent=`تنظیمات کلاس: ${e.info.name}`,Ee(),We(),L("settings-page")}function ms(e){const n=document.getElementById("log-modal-title"),t=document.getElementById("log-list");n.textContent=`گزارش فعالیت‌های کلاس: ${e}`,t.innerHTML="";const s=Gs(e);s.length===0?t.innerHTML='<li class="no-content-message">هنوز فعالیتی برای این کلاس ثبت نشده است.</li>':s.forEach(o=>{const a=document.createElement("li");a.className="log-entry";const l=new Date(o.timestamp),d=`${l.toLocaleDateString("fa-IR")} - ${l.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}`,i=document.createElement("span");i.className="log-timestamp",i.textContent=d;const g=document.createElement("span");g.className="log-message",g.textContent=o.message,o.action&&(g.classList.add("log-action-link"),g.dataset.action=JSON.stringify({...o.action,classroomName:o.classroomName})),a.appendChild(i),a.appendChild(g),t.appendChild(a)}),Z("log-modal")}document.getElementById("log-modal-close-btn").addEventListener("click",()=>{Q()});function Xt(e){const n=URL.createObjectURL(e),t=document.createElement("a");t.href=n,t.download=e.name,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(n)}async function Cn(){const e=Mn();if(("ontouchstart"in window||navigator.maxTouchPoints>0)&&navigator.share&&navigator.canShare&&navigator.canShare({files:[e]}))try{await navigator.share({title:"پشتیبان دستیار معلم",text:"فایل پشتیبان داده‌های برنامه",files:[e]})}catch(t){t.name!=="AbortError"&&(console.error("Error sharing file:",t),Xt(e),y("⚠️اشتراک‌گذاری با خطا مواجه شد. فایل در حال دانلود است."))}else Xt(e),y("✅پشتیبان‌گیری با موفقیت انجام شد.")}function ot(e,n){e.preventDefault(),we(),setTimeout(()=>{const t=De,s=t.querySelector("ul");s.innerHTML="",n.forEach(v=>{const S=document.createElement("li");v.isSeparator?S.className="separator":(S.innerHTML=`
                    <span class="icon">${v.icon||""}</span>
                    <span class="label">${v.label}</span>
                `,v.className&&S.classList.add(v.className),S.addEventListener("click",()=>{v.action(),we()})),s.appendChild(S)});const{clientX:o,clientY:a}=e,{innerWidth:l,innerHeight:d}=window;t.style.top=`${a}px`,t.style.left=`${o}px`,t.classList.add("visible");const{offsetWidth:i,offsetHeight:g}=t;o+i>l&&(t.style.left=`${l-i-5}px`),a+g>d&&(t.style.top=`${d-g-5}px`)},50)}function we(){De.classList.contains("visible")&&De.classList.remove("visible")}function fs(){var n,t;Re.innerHTML="";const e=[];if(e.push({label:"کلاس‌ها",handler:()=>{z(null),X(null),G(null),L("class-management-page")}}),r){if(e.push({label:r.info.name,handler:()=>{X(null),G(null),J(),L("session-page")}}),((n=document.querySelector(".page.active"))==null?void 0:n.id)==="settings-page")e.push({label:"تنظیمات"});else if(C){const a=ve(r).get(C.sessionNumber)||` (#${C.sessionNumber})`;e.push({label:`جلسه ${a}`,handler:()=>{G(null),L("student-page")}});const l=(t=document.querySelector(".page.active"))==null?void 0:t.id;O?e.push({label:`پروفایل: ${O.identity.name}`}):l==="attendance-page"&&e.push({label:"حضور و غیاب"})}}if(e.length<=1){Re.style.display="none";return}Re.style.display="flex",e.forEach((s,o)=>{const a=document.createElement("a");if(a.textContent=s.label,a.className="breadcrumb-item",o===e.length-1||!s.handler?a.classList.add("active"):a.addEventListener("click",s.handler),Re.appendChild(a),o<e.length-1){const l=document.createElement("span");l.className="breadcrumb-separator",l.textContent="/",Re.appendChild(l)}})}function Bn(e,n,t){t.innerHTML="";const s=r.sessions.filter(o=>{var a;return!o.isDeleted&&!o.isCancelled&&((a=o.studentRecords[e.identity.studentId])==null?void 0:a.attendance)==="absent"}).map(o=>({number:n.get(o.sessionNumber),isMakeup:o.isMakeup})).filter(o=>o.number!==void 0);s.length>0?(t.appendChild(document.createTextNode("جلسات غایب: ")),s.forEach((o,a)=>{const l=document.createElement("span");l.textContent=o.number,o.isMakeup&&l.classList.add("makeup-absence"),t.appendChild(l),a<s.length-1&&t.appendChild(document.createTextNode("، "))})):t.textContent="جلسات غایب: بدون غیبت"}function gt(e,n,t,s={}){const{includePrefix:o=!0}=s;t.innerHTML="";const a=r.sessions.filter(l=>{if(l.isDeleted||l.isCancelled)return!1;const d=l.studentRecords[e.identity.studentId];return d&&d.homework&&(d.homework.status==="incomplete"||d.homework.status==="none")}).map(l=>({number:n.get(l.sessionNumber),status:l.studentRecords[e.identity.studentId].homework.status})).filter(l=>l.number!==void 0);a.length>0?(o&&t.appendChild(document.createTextNode("تکالیف ناقص: ")),a.forEach((l,d)=>{const i=document.createElement("span");i.textContent=l.number,l.status==="incomplete"&&i.classList.add("incomplete-homework"),t.appendChild(i),d<a.length-1&&t.appendChild(document.createTextNode("،"))})):o?t.textContent="تکالیف ناقص: ندارد":t.textContent="ندارد"}function Fa(e,n){var k,$,_;const t=document.createElement("li");t.className="attendance-list-item";const s={none:"بدون تکلیف",complete:"تکلیف کامل",incomplete:"تکلیف ناقص"},o=document.createElement("div");o.className="student-info";const a=document.createElement("span");a.className="student-name",a.textContent=e.identity.name,a.addEventListener("click",()=>{G(e),Y(),L("student-profile-page")});const l=document.createElement("span");l.className="absence-info";const d=document.createElement("span");d.className="homework-info",Bn(e,n,l),gt(e,n,d),o.appendChild(a),o.appendChild(l),o.appendChild(d);const i=document.createElement("div");i.className="homework-controls";const g=document.createElement("button"),v=((k=C.studentRecords[e.identity.studentId])==null?void 0:k.homework.status)||"none";g.className=`homework-status-btn ${v}`,g.title=s[v],g.addEventListener("click",()=>{const T=C.studentRecords[e.identity.studentId].homework,P={none:"incomplete",incomplete:"complete",complete:"none"}[T.status];g.title=s[P],C.setHomeworkStatus(e.identity.studentId,P),N(),g.className=`homework-status-btn ${P}`,gt(e,n,d)});const S=document.createElement("button");S.className="btn-icon",S.innerHTML="📝",S.title="افزودن یادداشت برای تکلیف",(($=C.studentRecords[e.identity.studentId])==null?void 0:$.homework.comment)||(S.style.opacity="0.3"),S.addEventListener("click",()=>{const T=C.studentRecords[e.identity.studentId].homework;R.value=T.comment||"",R.dispatchEvent(new Event("input",{bubbles:!0})),pe(H=>{T.comment=H;const P=ve(r),ie=P.get(C.sessionNumber),ee={type:"fromAttendance",sessionNumber:C.sessionNumber},ge=`یادداشت حضور-غیاب ${ie}: `,j=e.profile.notes.find(ce=>!ce.isDeleted&&ce.source&&ce.source.type==="fromAttendance"&&ce.source.sessionNumber===ee.sessionNumber);j?H?j.content=ge+H:j.isDeleted=!0:H&&e.addNote(ge+H,ee),N(),A(r.info.name,`یادداشت تکلیف جلسه ${ie} برای دانش‌آموز «${e.identity.name}» ذخیره شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:e.identity.studentId}),y("✅یادداشت تکلیف ذخیره شد."),S.style.opacity=H?"1":"0.3",gt(e,P,d)}),Z("add-note-modal"),R.focus()}),i.appendChild(g),i.appendChild(S);const p=document.createElement("button"),b=((_=C.studentRecords[e.identity.studentId])==null?void 0:_.attendance)||"present",I=T=>{T==="present"?(p.textContent="حاضر",p.className="attendance-status-btn present active"):(p.textContent="غایب",p.className="attendance-status-btn absent active")};return I(b),p.addEventListener("click",()=>{var P;const H=(((P=C.studentRecords[e.identity.studentId])==null?void 0:P.attendance)||"present")==="present"?"absent":"present";C.setAttendance(e.identity.studentId,H),H==="absent"&&(C.studentRecords[e.identity.studentId].hadIssue=!1),N(),I(H),Bn(e,n,l),ys()}),t.appendChild(o),t.appendChild(i),t.appendChild(p),t}function qa(){return ve(r).get(C.sessionNumber)}function Ne(){if(!r||!C)return;const e=ve(r);Xa(),ut.innerHTML="";const n=document.createElement("li");n.className="attendance-list-header",n.innerHTML=`
    <span class="header-label-spacer"></span>
    <span class="header-label">تکلیف</span>
    <span class="header-label">حضور</span>
`,ut.appendChild(n),q(r.students).forEach(t=>{const s=Fa(t,e);ut.appendChild(s)}),Ya(),ys()}function ne(){const e=document.getElementById("student-stats-table-container");if(!e||(e.innerHTML="",!r))return;q(r.students).length,jt.textContent="آمار عملکرد";const n=["نام"],t=["کل انتخاب ها","غیبت","خروج","فرصت ازدست‌رفته","مشکل","میانگین","نمره کلاسی (کانون)"],s=r.categories.filter(p=>p.isGradedCategory&&!p.isDeleted).map(p=>p.name),o=[...n,...s,...t],a=document.createElement("table");a.className="student-stats-table";const d=a.createTHead().insertRow();o.forEach((p,b)=>{const I=document.createElement("th");b===0?(I.innerHTML=`${p} <span style="opacity: 0.6;">🔗</span>`,I.title="ردیف‌های این ستون قابل کلیک هستند"):I.textContent=p,d.appendChild(I)});const i=a.createTBody(),g=q(r.students),v=p=>{let b=0;return r.sessions.forEach(I=>{if(I.isDeleted||I.isCancelled)return;const k=I.studentRecords[p.identity.studentId];k&&k.attendance==="absent"&&b++}),b};g.forEach(p=>{const b=i.insertRow();if(b.dataset.studentId=p.identity.studentId,C){const H=C.studentRecords[p.identity.studentId];H&&H.attendance==="absent"&&b.classList.add("absent-row-highlight")}const I=b.insertCell(),k=document.createElement("span");k.textContent=p.identity.name,k.className="student-name-link",k.addEventListener("click",()=>{G(p),Y(),L("student-profile-page")}),I.appendChild(k),s.forEach(H=>{var ge;const P=b.insertCell(),ie=H.toLowerCase(),ee=((ge=p.logs.scores[ie])==null?void 0:ge.filter(j=>!j.isDeleted))||[];ee.length>0?ee.forEach((j,ce)=>{const se=document.createElement("span");se.textContent=j.value,se.style.position="relative",j.comment&&(se.dataset.tooltip=j.comment),P.appendChild(se),ce<ee.length-1&&P.appendChild(document.createTextNode(","))}):P.textContent="",P.style.cursor="pointer",P.addEventListener("click",()=>{Le(p,H);const j=document.getElementById("category-selection-container");j&&j.scrollIntoView({behavior:"smooth",block:"center"})})}),b.insertCell().textContent=p.statusCounters.totalSelections||0,b.insertCell().textContent=v(p),b.insertCell().textContent=p.statusCounters.outOfClassCount||0,b.insertCell().textContent=p.statusCounters.missedChances||0;const $=Object.values(p.categoryIssues||{}).reduce((H,P)=>H+P,0);b.insertCell().textContent=$;const _=p.getOverallAverageScore();b.insertCell().textContent=_!==null?_:"-";const T=r.calculateFinalStudentScore(p);b.insertCell().textContent=T!==null?T:"-"}),q(r.students),jt.setAttribute("data-student-count",g.length),e.appendChild(a);const S=e.querySelector(".student-stats-table"),u=S==null?void 0:S.querySelector("thead th:first-child");u&&u.addEventListener("click",()=>{S.classList.toggle("name-column-expanded")})}function Le(e=null,n=null){const t=document.getElementById("selected-student-result");t.innerHTML="",t.classList.remove("absent");let s,o;if(e&&n)s=e,o=n,Bt({student:e,categoryName:n}),Te(-1);else{if(Bt(null),!C||ue<0||!C.winnerHistory[ue])return;const W=C.winnerHistory[ue];s=W.winner,o=W.categoryName}const a=document.querySelector(".current-winner-highlight");if(a&&a.classList.remove("current-winner-highlight"),s){const W=document.querySelector(`.student-stats-table tr[data-student-id="${s.identity.studentId}"]`);W&&W.classList.add("current-winner-highlight")}const l=r.categories.find(W=>W.name===o);if(l){cn(l);const W=document.querySelectorAll("#category-selection-container .pill");W.forEach(K=>K.classList.remove("active"));const F=Array.from(W).find(K=>K.textContent===o);F&&F.classList.add("active"),gs(l)}const d=C.studentRecords[s.identity.studentId],i=(d==null?void 0:d.attendance)==="absent",g=document.createElement("div");g.className="winner-name-container";const v=document.createElement("button");v.className="btn-icon",v.innerHTML="˅",v.title="برنده قبلی";const S=!e;v.classList.toggle("is-disabled",!S||ue<=0),v.addEventListener("click",()=>{v.classList.contains("is-disabled")?(v.classList.add("shake-animation"),setTimeout(()=>v.classList.remove("shake-animation"),200)):(Te(ue-1),Le())});const u=document.createElement("div");u.className="winner-name",u.innerHTML=`✨ <strong>${s.identity.name}</strong>✨`,u.classList.add("heartbeat-animation"),i&&(u.style.textDecoration="line-through",u.style.opacity="0.6",u.style.color="var(--color-secondary)"),(d==null?void 0:d.hadIssue)&&!i&&(u.style.color="var(--color-warning)",u.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"),(d==null?void 0:d.wasOutOfClass)&&!i&&(u.style.color="var(--color-strong-warning)",u.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود");const I=document.createElement("button");I.className="btn-icon",I.innerHTML="˄",I.title="برنده بعدی",I.classList.toggle("is-disabled",!S||ue>=C.winnerHistory.length-1),I.addEventListener("click",()=>{I.classList.contains("is-disabled")?(I.classList.add("shake-animation"),setTimeout(()=>I.classList.remove("shake-animation"),200)):(Te(ue+1),Le())}),g.appendChild(I),g.appendChild(u),g.appendChild(v),t.appendChild(g),Se.disabled=S&&!I.classList.contains("is-disabled");const k=document.createElement("div");k.className="status-button-container";const $=document.createElement("button");$.textContent="غایب",$.classList.add("status-button","absent-btn"),i&&$.classList.add("active");const _=document.createElement("button");_.textContent="مشکل",_.classList.add("status-button","issue-btn"),d!=null&&d.hadIssue&&_.classList.add("active");const T=document.createElement("button");T.textContent="خروج",T.classList.add("status-button","exit-btn"),d!=null&&d.wasOutOfClass&&T.classList.add("active");const H=document.createElement("button");H.textContent="پروفایل",H.className="status-button profile-btn",$.addEventListener("click",()=>{const W=$.classList.contains("active");T.classList.contains("active")&&(T.classList.remove("active"),d.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),W?($.classList.remove("active"),C.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),u.style.textDecoration="",u.style.opacity="",u.style.color=""):(_.classList.contains("active")&&(_.classList.remove("active"),d.hadIssue=!1,s.statusCounters.otherIssues=Math.max(0,s.statusCounters.otherIssues-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),$.classList.add("active"),C.setAttendance(s.identity.studentId,"absent"),s.statusCounters.missedChances++,u.style.textDecoration="line-through",u.style.opacity="0.6",u.style.color="var(--color-secondary)",u.title=""),ne(),N()}),_.addEventListener("click",()=>{const W=_.classList.contains("active");if(T.classList.contains("active")&&(T.classList.remove("active"),d.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),W){_.classList.remove("active"),d.hadIssue=!1;const F=de.name;s.categoryIssues[F]&&(s.categoryIssues[F]=Math.max(0,s.categoryIssues[F]-1)),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),u.style.color="",u.title=""}else{$.classList.contains("active")&&($.classList.remove("active"),C.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),_.classList.add("active"),d.hadIssue=!0;const F=de.name;s.categoryIssues[F]=(s.categoryIssues[F]||0)+1,s.statusCounters.missedChances++,u.style.textDecoration="",u.style.opacity="",u.style.color="var(--color-warning)",u.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"}ne(),N()}),T.addEventListener("click",()=>{if(T.classList.contains("active"))T.classList.remove("active"),d.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),u.style.color="",u.title="";else{if($.classList.contains("active")&&($.classList.remove("active"),C.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),_.classList.contains("active")){_.classList.remove("active"),d.hadIssue=!1;const F=de.name;s.categoryIssues[F]&&(s.categoryIssues[F]=Math.max(0,s.categoryIssues[F]-1)),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)}T.classList.add("active"),d.wasOutOfClass=!0,s.statusCounters.outOfClassCount=(s.statusCounters.outOfClassCount||0)+1,s.statusCounters.missedChances++,u.style.textDecoration="",u.style.opacity="",u.style.color="var(--color-strong-warning)",u.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود"}ne(),N()}),H.addEventListener("click",()=>{G(s),Y(),L("student-profile-page")}),k.appendChild($),k.appendChild(T),k.appendChild(_),k.appendChild(H),t.appendChild(k);const P=document.createElement("div");P.className="student-details-container";const ie=document.createElement("div");ie.className="student-details-scores",ie.innerHTML="<h4>آخرین نمرات</h4>";const ee=document.createElement("ul");ee.className="scores-list";const ge=["Reading","Writing","Speaking","Listening"];let j=!1;const ce=s.logs.scores||{};ge.forEach(W=>{const F=document.createElement("li"),K=document.createElement("span");K.className="skill-name",K.textContent=`${W}:`;const ke=document.createElement("span");ke.className="skill-scores";const $t=W.toLowerCase(),Fe=ce[$t];Fe&&Fe.length>0?(j=!0,ke.textContent=Fe.slice(-3).map(Ot=>Ot.value).join(",")):ke.textContent="none",F.appendChild(K),F.appendChild(ke),ee.appendChild(F)}),!j&&Object.keys(ce).length===0&&(ee.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>'),ie.appendChild(ee),P.appendChild(ie);const se=document.createElement("div");se.className="student-details-notes",se.innerHTML="<h4>یادداشت‌ها</h4>";const xe=document.createElement("ul");xe.className="notes-list",s.profile.notes&&s.profile.notes.length>0?[...s.profile.notes].sort((F,K)=>new Date(K.timestamp)-new Date(F.timestamp)).forEach(F=>{const K=document.createElement("li");K.dir=tt(F.content),K.textContent=F.content,xe.appendChild(K)}):xe.innerHTML='<div class="no-content-message">یادداشتی وجود ندارد.</div>',se.appendChild(xe),P.appendChild(se),t.appendChild(P)}function ps(e){e.addEventListener("input",()=>{const n=e.value,t=tt(n);e.setAttribute("dir",t)})}function Ua(){ze.innerHTML="",is.innerHTML="",Dt.classList.add("tooltip-container"),Ce.disabled=!0,me.disabled=!0,Pe.disabled=!0,Ce.value="",me.value="",nt.classList.add("disabled-wrapper"),Se.disabled=!0}function ht(){ze.innerHTML="",r.categories.filter(t=>!t.isDeleted).forEach(t=>{const s=document.createElement("span");s.className="pill",s.textContent=t.name,s.dataset.categoryId=t.id,t.description&&(s.dataset.tooltip=t.description),s.addEventListener("click",()=>{document.querySelectorAll("#category-selection-container .pill").forEach(a=>a.classList.remove("active")),s.classList.add("active"),cn(t),gs(t),nt.classList.remove("disabled-wrapper"),Se.disabled=!1;const o=C.lastWinnerByCategory[t.name];if(o){const a=r.students.find(l=>l.identity.studentId===o);a&&Le(a,t.name)}else{is.innerHTML="",Bt(null),Te(-1),Se.disabled=!1;const a=document.querySelector(".current-winner-highlight");a&&a.classList.remove("current-winner-highlight")}}),s.addEventListener("contextmenu",o=>{ot(o,[{label:"تغییر نام",icon:"✏️",action:()=>{Qt((l,d)=>{const i=On(r,t,l);i.success?(t.isGradedCategory=d,N(),A(r.info.name,`نام دسته‌بندی «${t.name}» به «${l}» تغییر یافت.`),ht(),ne(),y(`✅ نام دسته‌بندی به «${l}» تغییر یافت.`)):y(`⚠️ ${i.message}`)},{title:"ویرایش دسته‌بندی",initialName:t.name,initialIsGraded:t.isGradedCategory,saveButtonText:"ذخیره تغییرات"})}},{label:"حذف دسته‌بندی",icon:"🗑️",className:"danger",action:()=>{U(`آیا از انتقال دسته‌بندی «${t.name}» به سطل زباله مطمئن هستید؟`,()=>{const l={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${t.name}» از کلاس «${r.info.name}»`,restoreData:{categoryId:t.id,classroomName:r.info.name}};D.unshift(l),D.length>50&&D.pop();const d=t.name.toLowerCase();r.students.forEach(i=>{i.logs.scores&&i.logs.scores[d]&&i.logs.scores[d].forEach(g=>{g.isDeleted=!0})}),t.isDeleted=!0,A(r.info.name,`دسته‌بندی «${t.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),N(),ht(),ne(),y(`✅ دسته‌بندی «${t.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}}])}),ze.appendChild(s)});const n=document.createElement("span");n.className="pill add-category-pill",n.textContent="+",n.title="افزودن دسته‌بندی جدید",n.addEventListener("click",()=>{Qt((t,s)=>{if(r.categories.find(l=>l.name.toLowerCase()===t.toLowerCase()&&!l.isDeleted)){y("⚠️ این دسته‌بندی از قبل وجود دارد.");return}const a=new ye(t,"",s);r.categories.push(a),N(),A(r.info.name,`دسته‌بندی جدید «${t}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),ht(),y(`✅ دسته‌بندی «${t}» اضافه شد.`)})}),ze.appendChild(n)}function Va(){if(C.lastUsedCategoryId){const e=ze.querySelector(`.pill[data-category-id="${C.lastUsedCategoryId}"]`);e&&e.click()}C.winnerHistory&&C.winnerHistory.length>0&&(Te(C.winnerHistory.length-1),Le())}function gs(e){e&&(e.isGradedCategory?(Ce.disabled=!1,me.disabled=!1,Pe.disabled=!1,Dt.removeAttribute("title")):(Ce.disabled=!0,me.disabled=!0,Pe.disabled=!0,Dt.setAttribute("title","برای این دسته‌بندی قابلیت نمره دهی تعریف نشده است")))}function Be(){if(!r||!C){L("class-management-page");return}Ua(),ht(),Va(),L("student-page"),ne()}function Y(){if(!O)return;const e=O;os.textContent=`پروفایل: ${e.identity.name}`;const n=r.sessions.reduce((u,p)=>{const b=p.studentRecords[e.identity.studentId];return u+(b&&b.attendance==="absent"?1:0)},0),t=Object.values(e.categoryIssues||{}).reduce((u,p)=>u+p,0);je.innerHTML=`
    <p><strong>کل انتخاب:</strong> ${e.statusCounters.totalSelections}</p>
    <p><strong>غیبت:</strong> ${n}</p>
    <p><strong>فرصت از دست رفته:</strong> ${e.statusCounters.missedChances||0}</p>
    <p><strong>مشکل:</strong> ${t}</p>`;const s=q(r.categories),o=document.createElement("div");if(o.className="stats-breakdown",s.length>0){s.forEach(p=>{var $;const b=p.name,I=(($=e.categoryCounts)==null?void 0:$[b])||0,k=document.createElement("p");k.className="stats-breakdown-item",k.innerHTML=`<strong>${b}:</strong> ${I}`,o.appendChild(k)});const u=je.querySelector("p:first-child");u&&u.after(o)}const a=document.createElement("div");a.className="stats-breakdown",s.length>0&&(s.forEach(u=>{var k;const p=u.name,b=((k=e.categoryIssues)==null?void 0:k[p])||0,I=document.createElement("p");I.className="stats-breakdown-item",I.innerHTML=`<strong>${p}:</strong> ${b}`,a.appendChild(I)}),je.appendChild(a));const l=document.createElement("p"),d=document.createElement("strong");d.textContent="تکالیف ناقص:";const i=document.createElement("span");i.style.marginRight="5px";const g=ve(r);gt(e,g,i,{includePrefix:!1}),l.appendChild(d),l.appendChild(i),je.appendChild(l);const v=r.categories.filter(u=>u.isGradedCategory&&!u.isDeleted);Ae.innerHTML="",v.forEach(u=>{const p=document.createElement("span");p.className="pill",p.textContent=u.name,p.dataset.skillName=u.name,u.description&&(p.dataset.tooltip=u.description),Ae.appendChild(p),p.addEventListener("click",()=>{Ae.querySelectorAll(".pill").forEach(b=>b.classList.remove("active")),p.classList.add("active"),Kt.focus()})}),ft.innerHTML="";const S=[];for(const u in e.logs.scores)e.logs.scores[u].forEach(p=>{p.isDeleted||S.push(p)});S.sort((u,p)=>new Date(p.timestamp)-new Date(u.timestamp)),S.length===0?ft.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>':S.forEach(u=>{const p=document.createElement("li");p.className="score-history-item";const b=document.createElement("div");b.className="item-content";const I=document.createElement("div");if(I.className="score-info",I.innerHTML=`
        <span class="score-date">${new Date(u.timestamp).toLocaleDateString("fa-IR")}</span>
        <span class="score-value">نمره: <strong>${u.value}</strong></span>
        <span class="score-skill-badge">${u.skill}</span>
    `,b.appendChild(I),u.comment){const $=`توضیحات: ${u.comment}`,_=tt($);tt(u.comment);const T=document.createElement("p");T.className="score-comment",T.dir=_,T.innerHTML=`<strong>توضیحات:</strong> <div>${Kn(u.comment)}</div>`,T.addEventListener("click",()=>{R.value=u.comment,R.dispatchEvent(new Event("input",{bubbles:!0})),pe(H=>{u.comment=H,N(),Y(),y("✅ توضیحات نمره ویرایش شد.")}),Z("add-note-modal"),R.focus()}),b.appendChild(T)}const k=document.createElement("button");k.className="btn-icon delete-item-btn",k.innerHTML="🗑️",k.title="حذف این نمره",k.addEventListener("click",()=>{U(`آیا از حذف نمره ${u.value} برای مهارت ${u.skill} مطمئن هستید؟`,()=>{const $={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"score",description:`نمره ${u.value} (${u.skill}) برای دانش‌آموز «${e.identity.name}»`,restoreData:{scoreId:u.id,skill:u.skill,studentId:e.identity.studentId,classroomName:r.info.name}};D.unshift($),D.length>50&&D.pop(),u.isDeleted=!0,A(r.info.name,`نمره ${u.value} در ${u.skill} برای «${e.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),N(),Y(),y("✅ نمره به سطل زباله منتقل شد.")},{confirmText:"تایید حذف",confirmClass:"btn-warning"})}),p.appendChild(b),p.appendChild(k),ft.appendChild(p)}),Kt.value="",fn.value="",Ae.querySelector(".pill.active")&&Ae.querySelector(".pill.active").classList.remove("active"),st()}function st(){const e=document.getElementById("profile-notes-list");if(e.innerHTML="",!O||!O.profile.notes||O.profile.notes.length===0){e.innerHTML='<div class="no-content-message">هنوز یادداشتی ثبت نشده است.</div>';return}[...O.profile.notes].filter(t=>!t.isDeleted).sort((t,s)=>new Date(s.timestamp)-new Date(t.timestamp)).forEach(t=>{const s=document.createElement("li");s.className="note-history-item";const o=document.createElement("div");o.className="item-content";const a=document.createElement("div");a.className="note-info";const l=document.createElement("span");l.className="note-date",l.textContent=new Date(t.timestamp).toLocaleDateString("fa-IR");const d=document.createElement("button");d.className="btn-icon delete-item-btn",d.innerHTML="🗑️",d.title="حذف این یادداشت",d.addEventListener("click",()=>{U("آیا از حذف این یادداشت مطمئن هستید؟",()=>{const g={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"note",description:`یادداشت برای دانش‌آموز «${O.identity.name}»`,restoreData:{noteId:t.id,studentId:O.identity.studentId,classroomName:r.info.name}};D.unshift(g),D.length>50&&D.pop(),t.isDeleted=!0,A(r.info.name,`یادداشت دانش‌آموز «${O.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),N(),st(),y("✅ یادداشت به سطل زباله منتقل شد.")},{confirmText:"تایید حذف",confirmClass:"btn-warning"})}),a.appendChild(l),a.appendChild(d);const i=document.createElement("p");i.className="note-content",i.innerHTML=Kn(t.content),i.addEventListener("click",()=>{R.value=t.content,R.dispatchEvent(new Event("input",{bubbles:!0})),pe(g=>{t.content=g,N(),A(r.info.name,`یادداشت دانش‌آموز «${O.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:O.identity.studentId}),st(),y("✅یادداشت با موفقیت ویرایش شد.")}),Z("add-note-modal"),R.focus()}),o.appendChild(a),o.appendChild(i),s.appendChild(o),e.appendChild(s)})}function hs(e){Vt.innerHTML="",e.forEach((n,t)=>{const s=document.createElement("option");s.value=t,s.textContent=n.trim(),Vt.appendChild(s)})}function Yt(){Ut.innerHTML="",en.forEach(e=>{const n=document.createElement("li");n.className="preview-item";const t=document.createElement("input");t.type="checkbox",t.checked=!0,t.dataset.name=e;const s=document.createElement("label");s.textContent=e,n.appendChild(t),n.appendChild(s),Ut.appendChild(n)})}function Ga(e){const n=document.createElement("div");n.className="list-item-buttons";const t=document.createElement("button");return t.className="btn-icon",t.innerHTML="📝",t.title="افزودن/ویرایش یادداشت کلاس",t.style.borderBottom="solid",e.note||(t.style.opacity="0.5",t.style.borderBottom="none"),t.addEventListener("click",s=>{s.stopPropagation(),hn(e)}),n.appendChild(t),n}function ja(e){const n=document.createElement("div");n.style.flexGrow="1",n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="flex-start";const t=document.createElement("span");t.textContent=e.info.name,t.classList.add("class-name-display"),n.appendChild(t);const s=q(e.students).length,o=q(e.sessions).filter(i=>i.isFinished).length,a=document.createElement("div");a.classList.add("class-stats-row");const l=document.createElement("span");l.textContent=`${s} نفر`,l.classList.add("student-count-badge"),a.appendChild(l);const d=document.createElement("span");return d.textContent=`${o} جلسه`,d.classList.add("session-count-badge"),a.appendChild(d),n.appendChild(a),n.addEventListener("click",()=>{z(e),X(null),Ze(r.liveSession),J(),L("session-page")}),n}function Ja(e){const n=document.createElement("li"),t=ja(e);n.appendChild(t);const s=document.createElement("div");if(s.className="list-item-badges",e.liveSession&&!e.liveSession.isCancelled&&!e.liveSession.isDeleted){const l=document.createElement("span");l.className="warning-badge",l.textContent="جلسه باز",s.appendChild(l),n.classList.add("has-unfinished-session")}const o=document.createElement("span");o.className=`type-badge ${e.info.type}`,o.textContent=e.info.type==="online"?"آنلاین":"حضوری",o.title="نوع کلاس",s.appendChild(o),n.appendChild(s);const a=Ga(e);return n.appendChild(a),n.addEventListener("contextmenu",l=>{ot(l,[{label:"تنظیمات کلاس",icon:"⚙️",action:()=>{yn(e)}},{label:"گزارش فعالیت‌ها",icon:"📋",action:()=>{ms(e.info.name)}},{label:"تغییر نام",icon:"✏️",action:()=>{const i=e.info.name,g=document.getElementById("add-note-modal-title");g.textContent="تغییر نام کلاس",R.value=i,R.rows=1,pe(v=>{const S=v.trim();if(S&&S!==i){const u=$n(i,S);u.success?(js(i,S),A(S,`نام کلاس از «${i}» به «${S}» تغییر یافت.`,{type:"VIEW_SESSIONS"}),N(),oe(),y(`✅نام کلاس به «${S}» تغییر یافت.`)):y(u.message)}g.textContent="ثبت یادداشت جدید",R.rows=4}),Z("add-note-modal"),R.focus(),R.select()}},{label:"حذف کلاس",icon:"🗑️",className:"danger",action:()=>{U(`آیا از انتقال کلاس «${e.info.name}» به سطل زباله مطمئن هستید؟`,()=>{const i={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"classroom",description:`کلاس «${e.info.name}»`,restoreData:{name:e.info.name}};D.unshift(i),D.length>50&&D.pop(),e.isDeleted=!0,N(),oe(),y(`✅ کلاس «${e.info.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}])}),n}function oe(){Wt.innerHTML="",Object.values(w).sort((n,t)=>new Date(n.info.creationDate)-new Date(t.info.creationDate)).forEach(n=>{if(n.isDeleted)return;const t=Ja(n);Wt.appendChild(t)})}function Ee(){Ft.innerHTML="",r&&q(r.students).forEach(e=>{const n=document.createElement("li"),t=document.createElement("span");t.textContent=e.identity.name,t.style.flexGrow="1",t.className="student-name-link",t.addEventListener("click",()=>{G(e),Y(),L("student-profile-page")}),n.appendChild(t),n.addEventListener("contextmenu",s=>{ot(s,[{label:"تغییر نام",icon:"✏️",action:()=>{gn(e,r)}},{label:"انتقال دانش‌آموز",icon:"➡️",action:()=>{us(e,r)}},{label:"حذف دانش‌آموز",icon:"🗑️",className:"danger",action:()=>{U(`آیا از انتقال دانش‌آموز «${e.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const a={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${e.identity.name}» از کلاس «${r.info.name}»`,restoreData:{studentId:e.identity.studentId,classroomName:r.info.name}};D.unshift(a),D.length>50&&D.pop(),e.isDeleted=!0,A(r.info.name,`دانش‌آموز «${e.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),N(),Ee(),y(`✅ دانش‌آموز «${e.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}])}),Ft.appendChild(n)})}function We(){if(qt.innerHTML="",!r)return;r.categories.filter(n=>!n.isDeleted).forEach(n=>{const t=document.createElement("li"),s=document.createElement("div");s.className="name-and-badge-container";const o=document.createElement("span");if(o.textContent=n.name,s.appendChild(o),n.isGradedCategory){const l=document.createElement("span");l.className="category-badge",l.textContent="قابل نمره‌دهی",s.appendChild(l)}const a=document.createElement("button");a.className="btn-icon",a.innerHTML="🗑️",a.style.color="var(--color-warning)",a.addEventListener("click",()=>{U(`آیا از انتقال دسته‌بندی «${n.name}» به سطل زباله مطمئن هستید؟`,()=>{const l={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${n.name}» از کلاس «${r.info.name}»`,restoreData:{categoryId:n.id,classroomName:r.info.name}};D.unshift(l),D.length>50&&D.pop(),n.isDeleted=!0,A(r.info.name,`دسته‌بندی «${n.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),N(),We(),y(`✅ دسته‌بندی «${n.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}),t.appendChild(s),t.appendChild(a),qt.appendChild(t)})}function Qe(e){document.querySelectorAll(".page").forEach(t=>{t.classList.remove("active")});const n=document.getElementById(e);n&&n.classList.add("active"),e==="class-management-page"?(oe(),Gt.style.display="flex"):Gt.style.display="none",fs()}function L(e){const n={pageId:e,currentClassName:r?r.info.name:null,selectedSessionNumber:C?C.sessionNumber:null,selectedStudentId:O?O.identity.studentId:null};let t=`#${e}`;const s=new URLSearchParams;r&&s.set("class",r.info.name),C&&s.set("session",C.sessionNumber),O&&s.set("student",O.identity.studentId);const o=s.toString();o&&(t+=`?${o}`),window.location.hash!==t&&history.pushState(n,"",t),Qe(e)}function za(e,n){const t=document.createElement("div");t.className="list-item-buttons";const s=document.createElement("button");if(s.className="btn-icon",s.innerHTML="📝",s.title="افزودن/ویرایش یادداشت جلسه",s.style.borderBottom="solid",e.note||(s.style.opacity="0.5",s.style.borderBottom="none"),s.addEventListener("click",o=>{o.stopPropagation(),R.value=e.note||"",pe(a=>{e.note=a,N(),A(r.info.name,`یادداشت جلسه ${n} ذخیره شد.`,{type:"VIEW_SESSIONS"}),J(),y("✅یادداشت جلسه ذخیره شد.")}),Z("add-note-modal"),R.focus()}),t.appendChild(s),!e.isFinished&&!e.isCancelled){const o=document.createElement("button");o.className="btn-icon",o.innerHTML="✅",o.title="خاتمه جلسه",o.addEventListener("click",a=>{a.stopPropagation(),U(`جلسه شماره ${n} خاتمه پیدا خواهد کرد!`,()=>{r.endSpecificSession(e.sessionNumber),N(),A(r.info.name,`جلسه ${n} خاتمه یافت.`,{type:"VIEW_SESSIONS"}),J(),U("جلسه با موفقیت خاتمه یافت. آیا مایل به ایجاد فایل پشتیبان هستید؟",()=>{if(fe){y("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است.");return}Cn(),y("✅فایل پشتیبان با موفقیت ایجاد شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}),t.appendChild(o)}return t}function Ka(e,n){const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="flex-start",t.style.flexGrow="1";const s=new Date(e.startTime).toLocaleDateString("fa-IR"),o=document.createElement("span"),a=document.createElement("div");a.style.display="flex",a.style.gap="5px",a.style.marginTop="5px";const l=new Date(e.startTime).toLocaleDateString("fa-IR",{weekday:"long"}),d=document.createElement("span");if(d.className="type-badge day-badge",d.textContent=l,a.appendChild(d),e.isCancelled){o.textContent=`✅جلسه لغو شده - تاریخ: ${s}`,t.style.cursor="default";const i=document.createElement("span");i.className="type-badge cancelled-badge",i.textContent="لغو شده",a.appendChild(i)}else o.textContent=`جلسه ${n} - تاریخ: ${s}`,t.style.cursor="pointer",t.addEventListener("click",()=>{X(e),Be()});if(t.appendChild(o),e.isFinished){const i=document.createElement("span");i.className="type-badge",i.textContent="خاتمه یافته",i.style.backgroundColor="var(--color-secondary)",a.appendChild(i)}if(e.isMakeup){const i=document.createElement("span");i.className="type-badge",i.textContent="جبرانی",i.style.backgroundColor="var(--color-warning)",i.style.color="var(--color-text-dark)",a.appendChild(i)}return t.appendChild(a),t}function Qa(e,n){const t=document.createElement("li"),s=n.get(e.sessionNumber),o=Ka(e,s);t.appendChild(o);const a=za(e,s);return t.appendChild(a),t.addEventListener("contextmenu",l=>{const d=[{label:e.isCancelled?"بازگردانی جلسه":"لغو جلسه",icon:"❌",action:()=>{const i=e.isCancelled?"بازگردانی جلسه":"لغو جلسه",g=e.isCancelled?"آیا از بازگردانی این جلسه مطمئن هستید؟":"آیا از لغو این جلسه مطمئن هستید؟ جلسه لغو شده در آمار تاثیری ندارد اما قابل بازگردانی است.";U(g,()=>{e.isCancelled=!e.isCancelled;const v=e.isCancelled?`جلسه ${s} لغو شد.`:`جلسه لغو شده (تاریخ: ${new Date(e.startTime).toLocaleDateString("fa-IR")}) بازگردانی شد.`;A(r.info.name,v,{type:"VIEW_SESSIONS"}),N(),J(),y(e.isCancelled?"✅جلسه لغو شد.":"✅جلسه بازگردانی شد.")},{confirmText:i,confirmClass:"btn-warning"})}},{label:"تغییر وضعیت جبرانی",icon:"🔄",action:()=>{r.markAsMakeup(e.sessionNumber),N();const i=e.isMakeup?`جلسه ${s} به عنوان جبرانی علامت‌گذاری شد.`:`جلسه ${s} از حالت جبرانی خارج شد.`;A(r.info.name,i,{type:"VIEW_SESSIONS"}),J()}},{label:"حذف جلسه",icon:"🗑️",className:"danger",action:()=>{const i=e.isCancelled?"لغو شده":s;U(`آیا از انتقال جلسه ${i} به سطل زباله مطمئن هستید؟`,()=>{const g={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"session",description:`جلسه ${i} از کلاس «${r.info.name}»`,restoreData:{sessionNumber:e.sessionNumber,classroomName:r.info.name}};D.unshift(g),D.length>50&&D.pop(),e.isDeleted=!0,A(r.info.name,`جلسه ${i} به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),N(),J(),y(`✅ جلسه ${i} به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}];ot(l,d)}),t}function J(){const e=document.getElementById("session-list");if(!r)return;if(e.innerHTML="",r.sessions.length===0){e.innerHTML="<li>هنوز جلسه‌ای شروع نشده است.</li>";return}const n=ve(r);[...q(r.sessions)].reverse().forEach(s=>{const o=Qa(s,n);e.appendChild(o)})}function Je(e){if(be.innerHTML="",e.length>0)e.forEach(n=>{const t=document.createElement("div");t.textContent=n.identity.name,t.addEventListener("click",()=>{G(n),Y(),L("student-profile-page"),be.style.display="none",zt.value=""}),be.appendChild(t)}),be.style.display="block";else if(zt.value.trim()!==""){const n=document.createElement("div");n.className="no-results",n.textContent="پیدا نشد",be.appendChild(n),be.style.display="block"}else be.style.display="none"}function yt(e){if(he.innerHTML="",e.length>0)e.forEach(n=>{const t=document.createElement("div");t.className="global-search-result";const s=document.createElement("span");s.className="student-name",s.textContent=n.student.identity.name;const o=document.createElement("span");o.className="class-name",o.textContent=`کلاس: ${n.classroom.info.name}`,t.addEventListener("click",()=>{z(n.classroom),G(n.student),Y(),L("student-profile-page"),he.style.display="none",pt.value=""}),o.addEventListener("click",a=>{a.stopPropagation(),z(n.classroom),X(null),Ze(n.classroom.liveSession),J(),L("session-page"),he.style.display="none",pt.value=""}),t.appendChild(s),t.appendChild(o),he.appendChild(t)}),he.style.display="block";else if(pt.value.trim()!==""){const n=document.createElement("div");n.className="no-results",n.textContent="پیدا نشد",he.appendChild(n),he.style.display="block"}else he.style.display="none"}function at(){const e=document.getElementById("trashed-items-list");if(e.innerHTML="",D.length===0){e.innerHTML='<li style="text-align: center; padding: 20px;">سطل زباله خالی است.</li>';return}D.forEach((n,t)=>{const s=document.createElement("li"),o=document.createElement("span");o.textContent=n.description,o.style.flexGrow="1";const a=document.createElement("div");a.className="list-item-buttons";const l=document.createElement("button");l.className="btn-icon",l.innerHTML="🔄",l.title="بازیابی",l.addEventListener("click",()=>{var S;let i=!1,g=null;const v=n.restoreData;switch(n.type){case"classroom":{const u=w[v.name];u&&!u.isDeleted?g=`کلاسی با نام «${v.name}» از قبل فعال است.`:u&&u.isDeleted&&(u.isDeleted=!1,i=!0);break}case"student":{const u=w[v.classroomName],p=u==null?void 0:u.students.find(b=>b.identity.studentId===v.studentId);p&&(p.isDeleted=!1,i=!0);break}case"session":{const u=w[v.classroomName],p=u==null?void 0:u.sessions.find(b=>b.sessionNumber===v.sessionNumber);p&&(p.isDeleted=!1,i=!0);break}case"category":{const u=w[v.classroomName],p=u==null?void 0:u.categories.find(b=>b.id===v.categoryId);p&&(p.isDeleted=!1,i=!0);break}case"score":{const u=w[v.classroomName],p=u==null?void 0:u.students.find(I=>I.identity.studentId===v.studentId),b=(S=p==null?void 0:p.logs.scores[v.skill.toLowerCase()])==null?void 0:S.find(I=>I.id===v.scoreId);b&&(b.isDeleted=!1,i=!0);break}case"note":{const u=w[v.classroomName],p=u==null?void 0:u.students.find(I=>I.identity.studentId===v.studentId),b=p==null?void 0:p.profile.notes.find(I=>I.id===v.noteId);b&&(b.isDeleted=!1,i=!0);break}}i?(D.splice(t,1),N(),at(),n.type==="classroom"&&oe(),y("✅ آیتم با موفقیت بازیابی شد.")):y(g?`⚠️ ${g}`:"⚠️ آیتم اصلی برای بازیابی یافت نشد.")});const d=document.createElement("button");d.className="btn-icon",d.innerHTML="🔥",d.title="حذف دائمی",d.addEventListener("click",()=>{U("آیا از حذف دائمی این آیتم مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{const i=n.restoreData;switch(n.type){case"classroom":delete w[i.name];break;case"student":Ye({identity:{studentId:i.studentId}},w[i.classroomName]);break;case"session":Rn(i.classroomName,i.sessionNumber);break;case"category":_n(i.classroomName,i.categoryId);break;case"score":Pn(i.classroomName,i.studentId,i.skill,i.scoreId);break;case"note":Wn(i.classroomName,i.studentId,i.noteId);break}D.splice(t,1),N(),at(),y("✅ آیتم برای همیشه حذف شد.")},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),a.appendChild(l),a.appendChild(d),s.appendChild(o),s.appendChild(a),e.appendChild(s)})}function Xa(){const e=document.getElementById("absentees-summary-container");e&&(e.innerHTML=`
        <div id="absentees-summary-box" class="absentees-summary">
            <div class="absentees-summary-header">
                <h4>لیست غایبین جلسه شماره <span id="absentee-summary-session-number"></span></h4>
                <button id="copy-absentees-btn" class="btn-icon" title="کپی لیست غایبین">📋</button>
            </div>
            <div id="absentees-summary-list" class="summary-list"></div>
        </div>
    `)}function ys(){const e=document.getElementById("absentees-summary-box"),n=document.getElementById("absentees-summary-list"),t=document.getElementById("absentee-summary-session-number");if(!e||!n||!t){console.error("Could not find all absentee summary elements.");return}if(!r||!C){e.classList.remove("visible");return}const s=q(r.students).filter(a=>{const l=C.studentRecords[a.identity.studentId];return l&&l.attendance==="absent"}),o=ve(r);t.textContent=o.get(C.sessionNumber),s.length>0?e.classList.add("visible"):e.classList.remove("visible"),n.innerHTML="",s.forEach(a=>{const d=(g=>r.sessions.reduce((v,S)=>{if(S.isDeleted||S.isCancelled)return v;const u=S.studentRecords[g.identity.studentId];return v+(u&&u.attendance==="absent"?1:0)},0))(a),i=document.createElement("span");i.className="summary-name",i.textContent=`${a.identity.name} (غیبت: ${d})`,i.addEventListener("click",()=>{i.classList.add("fading-out"),setTimeout(()=>{C.setAttendance(a.identity.studentId,"present"),N(),Ne()},200)}),n.appendChild(i)})}function Ya(){const e=document.getElementById("copy-absentees-btn");if(!e){console.error("Could not find the copy absentees button to attach listener.");return}e.addEventListener("click",()=>{if(!r||!C)return;const n=q(r.students).filter(o=>{const a=C.studentRecords[o.identity.studentId];return a&&a.attendance==="absent"});if(n.length===0){y("⚠️لیست غایبین خالی است.");return}const t=o=>r.sessions.reduce((a,l)=>{if(l.isDeleted||l.isCancelled)return a;const d=l.studentRecords[o.identity.studentId];return a+(d&&d.attendance==="absent"?1:0)},0);let s=`لیست غایبین جلسه شماره ${qa()}:

`;n.forEach(o=>{const a=t(o);s+=`- ${o.identity.name} (تعداد غیبت‌ها: ${a})
`}),navigator.clipboard.writeText(s).then(()=>{y("✅لیست غایبین با موفقیت کپی شد.")}).catch(o=>{console.error("Failed to copy text: ",o),y("❌خطا در کپی کردن لیست.")})})}function Ct(){const e=document.getElementById("demo-mode-banner");e&&(fe?(e.classList.add("visible"),document.body.classList.add("demo-mode-active")):(e.classList.remove("visible"),document.body.classList.remove("demo-mode-active")))}const Za=Object.freeze(Object.defineProperty({__proto__:null,_internalShowPage:Qe,addCategoryBtn:da,addClassBtn:zs,addNoteModal:ka,addScoreBtn:Da,addStudentBtn:Zs,appHeader:Gt,attendanceListUl:ut,attendancePage:ua,backToAttendanceBtn:pa,backToSessionsBtn:Xs,backToSessionsFromAttendanceBtn:fa,backToStudentPageBtn:Ta,backupDataBtn:va,breadcrumbContainer:Re,cancelImportBtn:la,cancelNoteBtn:Na,categoryListUl:qt,categoryModal:_a,categoryModalCancelBtn:Pa,categoryModalSaveBtn:ls,categoryModalTitle:cs,classListHeader:ga,classListUl:Wt,classManagementPage:Yn,classSaveNoteBtn:wa,closeActiveModal:Q,closeContextMenu:we,closeNavBtn:Ca,columnMappingPage:ia,columnSelectDropdown:Vt,confirmColumnBtn:ca,confirmModalCancelBtn:Jt,confirmModalConfirmBtn:Ge,confirmModalMessage:ns,contextMenu:De,csvCancelBtn:sa,csvConfirmBtn:na,csvFileInput:oa,csvPreviewList:Ut,csvPreviewPage:ta,customConfirmModal:Ia,displayWinner:Le,finishAttendanceBtn:ma,globalStudentSearchInput:pt,globalStudentSearchResultsDiv:he,gradedCategoryPillsContainer:Ae,hamburgerMenuBtn:ha,handleUndo:rs,importCsvBtn:aa,initiateBackupProcess:Cn,isGradedCheckbox:xa,newCategoryModalIsGradedCheckbox:pn,newCategoryModalNameInput:Ke,newCategoryNameInput:ra,newClassNameInput:Js,newNoteContent:R,newScoreCommentTextarea:fn,newScoreValueInput:Kt,newStudentNameInput:Ys,openContextMenu:ot,openModal:Z,overlay:Ea,pasteArea:es,processPasteBtn:ea,profileScoresListUl:ft,profileStatsSummaryDiv:je,profileStudentNameHeader:os,quickGradeFormWrapper:Dt,quickGradeSubmitBtn:Pe,quickNoteTextarea:me,quickScoreInput:Ce,renderAttendancePage:Ne,renderBreadcrumbs:fs,renderClassList:oe,renderColumnSelector:hs,renderGlobalSearchResults:yt,renderImportPreview:Yt,renderLogModal:ms,renderSearchResults:Je,renderSessions:J,renderSettingsCategories:We,renderSettingsStudentList:Ee,renderStudentNotes:st,renderStudentPage:Be,renderStudentProfilePage:Y,renderStudentStatsList:ne,renderTrashPage:at,restoreDataBtn:ba,restoreFileInput:ts,secureConfirmCancelBtn:La,secureConfirmCode:as,secureConfirmConfirmBtn:mt,secureConfirmInput:He,secureConfirmMessage:ss,secureConfirmModal:Sa,selectStudentBtn:Se,selectStudentBtnWrapper:nt,setAutoDirectionOnInput:ps,settingsClassNameHeader:mn,settingsPage:Qs,settingsStudentListUl:Ft,showCategoryModal:Qt,showClassNoteModal:hn,showCustomConfirm:U,showMoveStudentModal:us,showNotification:y,showPage:L,showRenameStudentModal:gn,showSecureConfirm:ds,showSettingsPage:yn,showUndoToast:Wa,sideNavMenu:ya,studentProfilePage:Ba,studentSearchInput:zt,studentSearchResultsDiv:be,studentStatsHeader:jt,trashedCategoriesList:Ha,trashedClassesList:Ma,trashedNotesList:Aa,trashedScoresList:Ra,trashedSessionsList:Oa,trashedStudentsList:$a,triggerFileDownload:Xt,undoBtn:Ks,undoMessage:Zn,undoToast:Tt,updateDemoModeBanner:Ct},Symbol.toStringTag,{value:"Module"}));function eo(){const e=window.location.hash;if(!e||e==="#")return!1;const[n,t]=e.split("?"),s=n.substring(1),o=new URLSearchParams(t),a=o.get("class"),l=parseInt(o.get("session"),10),d=o.get("student");if(a&&w[a])z(w[a]),l&&r.getSession(l)&&X(r.getSession(l)),d&&r.students.find(i=>i.identity.studentId===d)&&G(r.students.find(i=>i.identity.studentId===d));else return!1;switch(s){case"session-page":J(),L("session-page");break;case"student-page":Be();break;case"attendance-page":Ne(),L("attendance-page");break;case"settings-page":mn.textContent=`تنظیمات کلاس: ${r.info.name}`,Ee(),We(),L("settings-page");break;case"student-profile-page":Y(),L("student-profile-page");break;default:return!1}return!0}document.addEventListener("DOMContentLoaded",()=>{const{globalStudentSearchInput:e,newClassNameInput:n,addClassBtn:t,undoBtn:s,backToSessionsBtn:o,newStudentNameInput:a,addStudentBtn:l,pasteArea:d,processPasteBtn:i,csvPreviewList:g,csvConfirmBtn:v,csvCancelBtn:S,importCsvBtn:u,csvFileInput:p,columnSelectDropdown:b,confirmColumnBtn:I,cancelImportBtn:k,newCategoryNameInput:$,addCategoryBtn:_,selectStudentBtn:T,attendancePage:H,finishAttendanceBtn:P,backToSessionsFromAttendanceBtn:ie,backToAttendanceBtn:ee,classListHeader:ge,studentStatsHeader:j,hamburgerMenuBtn:ce,sideNavMenu:se,closeNavBtn:xe,overlay:W,backupDataBtn:F,restoreDataBtn:K,restoreFileInput:ke,confirmModalCancelBtn:$t,confirmModalConfirmBtn:Fe,secureConfirmCancelBtn:Ot,secureConfirmConfirmBtn:Cs,newNoteContent:it,classSaveNoteBtn:Es,cancelNoteBtn:vs,studentSearchInput:qe,studentSearchResultsDiv:bs,studentProfilePage:Is,profileStudentNameHeader:Ss,backToStudentPageBtn:Ls,gradedCategoryPillsContainer:ks,newScoreValueInput:ws,newScoreCommentTextarea:Ns,addScoreBtn:Bs,isGradedCheckbox:En,categoryModalSaveBtn:Ts,categoryModalCancelBtn:Ds}=Za,xs=document.getElementById("trash-nav-btn");document.querySelector(".global-search-container .search-icon"),wt(),Ct(),eo()||(oe(),L("class-management-page"));function vn(c,f){const m=document.querySelector(c);if(!m)return;const h=m.querySelector(".search-icon"),E=m.querySelector(".animated-search-input");!h||!E||(h.addEventListener("mousedown",x=>{x.preventDefault()}),h.addEventListener("click",()=>{m.classList.contains("search-active")||(m.classList.add("search-active"),E.focus())}),E.addEventListener("blur",()=>{setTimeout(()=>{m.classList.remove("search-active"),E.value="",f&&f([])},150)}))}Ds.addEventListener("click",()=>{Q(),Mt(null)}),Ts.addEventListener("click",()=>{const c=Ke.value.trim(),f=pn.checked;typeof Lt=="function"&&Lt(c,f)}),window.addEventListener("scroll",we),document.addEventListener("click",c=>{De.classList.contains("visible")&&!De.contains(c.target)&&we(),qe.contains(c.target)||(bs.style.display="none");const f=c.target.closest(".log-action-link");if(f&&f.dataset.action)try{const m=JSON.parse(f.dataset.action);_s(m)}catch(m){console.error("Could not parse log action:",m)}}),nt.addEventListener("click",()=>{(nt.classList.contains("disabled-wrapper")||Se.disabled)&&(Se.classList.add("shake-animation"),setTimeout(()=>{Se.classList.remove("shake-animation")},200))}),j.addEventListener("click",()=>{const c=new Date().getTime();c-sn>500?dt(1):dt(bt+1),jn(c),bt===5&&(dt(0),U("آیا از صفر کردن تمام شمارنده‌های دانش‌آموزان مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{An(),ne(),y("تمام آمارها صفر شدند ✅.")},{confirmText:"بله",confirmClass:"btn-warning"}))}),ge.addEventListener("click",()=>{const c=new Date().getTime();c-nn>500?rt(1):rt(vt+1),Gn(c),vt===5&&(rt(0),U("آیا از ساخت یک کلاس تستی تصادفی مطمئن هستید؟",()=>{function f(){const m=`کلاس تستی ${Object.keys(w).length+1}`,h=new _t({name:m,type:"online"});["علی رضایی","مریم حسینی","زهرا احمدی","رضا محمدی","فاطمه کریمی"].forEach(x=>h.addStudent(new ct({name:x}))),w[m]=h,N(),oe()}f(),y("کلاس تستی با موفقیت ساخته شد ✅!")},{confirmText:"بساز",confirmClass:"btn-success"}))}),Ot.addEventListener("click",()=>{Q(),et(null)}),Cs.addEventListener("click",()=>{typeof It=="function"&&It(),Q(),et(null)}),$t.addEventListener("click",()=>{Q(on)}),Fe.addEventListener("click",()=>{Q(an)}),ee.addEventListener("click",()=>{r&&C&&(Ne(),L("attendance-page"))}),T.addEventListener("click",()=>{if(Ce.value.trim()!==""||me.value.trim()!==""){y("⚠️لطفاً ابتدا با دکمه «ثبت»، تغییرات را ذخیره کنید و یا نمره و یادداشت را پاک کنید.");return}if(!r||!C||!de)return;const c=r.selectNextWinner(de.name,C);if(c){const f=C.studentRecords[c.identity.studentId];if(f&&f.attendance==="absent"&&c.statusCounters.missedChances++,f&&f.hadIssue){c.statusCounters.missedChances++;const h=de.name;c.categoryIssues[h]=(c.categoryIssues[h]||0)+1}const m={winner:c,categoryName:de.name};C.winnerHistory.push(m),C.winnerHistory.length>10&&C.winnerHistory.shift(),Te(C.winnerHistory.length-1),C.lastUsedCategoryId=de.id,C.lastSelectedWinnerId=c.identity.studentId,ne(),Le(),N()}else y("❌دانش‌آموز واجد شرایطی برای انتخاب یافت نشد.")}),_.addEventListener("click",()=>{if(!r)return;const c=$.value.trim(),f=En.checked;if(!c){alert("⚠️لطفاً نام دسته‌بندی را وارد کنید.");return}const m=r.categories.find(E=>E.name.toLowerCase()===c.toLowerCase());if(m)if(m.isDeleted){const E=r.categories.findIndex(x=>x===m);E>-1&&r.categories.splice(E,1)}else{alert("⚠️این دسته‌بندی از قبل وجود دارد.");return}const h=new ye(c,"",f);r.categories.push(h),N(),A(r.info.name,`دسته‌بندی جدید «${c}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),We(),$.value="",En.checked=!1}),$.addEventListener("keyup",c=>{c.key==="Enter"&&_.click()}),I.addEventListener("click",()=>{if(!Et){alert("❌خطایی رخ داده است. لطفاً فایل را دوباره انتخاب کنید."),L("settings-page");return}const c=parseInt(b.value,10),h=Et.split(`
`).slice(1).map(E=>{var B;return(B=E.split(",")[c])==null?void 0:B.trim()}).filter(E=>E&&E.length>0);h.length>0?(Ve(h),Yt(),L("csv-preview-page")):alert("هیچ نامی در ستون انتخاب شده پیدا نشد. لطفاً ستون دیگری را امتحان کنید یا فایل خود را بررسی کنید."),lt(null)}),u.addEventListener("click",()=>{p.click()}),p.addEventListener("change",c=>{const f=c.target.files[0];if(!f)return;const m=new FileReader;m.onload=h=>{const E=h.target.result;lt(E);const B=E.split(`
`)[0].split(",");hs(B),L("column-mapping-page")},m.readAsText(f),c.target.value=null}),k.addEventListener("click",()=>{lt(null),L("settings-page")}),v.addEventListener("click",()=>{const c=g.querySelectorAll('input[type="checkbox"]:checked');let f=!1;c.forEach(m=>{const h=m.dataset.name,E=r.students.find(B=>B.identity.name.toLowerCase()===h.toLowerCase());if(E)if(E.isDeleted)Ye(E,r);else{console.log(`دانش‌آموز «${h}» به دلیل تکراری بودن اضافه نشد.`);return}const x=new ct({name:h});r.addStudent(x),r.sessions.length>0&&(Ln(x,r),f=!0)}),N(),A(r.info.name,`${c.length} دانش‌آموز جدید از لیست ورودی به کلاس اضافه شدند.`,{type:"VIEW_SESSIONS"}),Ee(),f&&kn(c.length),L("settings-page"),d.value="",Ve([])}),S.addEventListener("click",()=>{Ve([]),L("settings-page")}),i.addEventListener("click",()=>{const c=d.value.trim();if(!c){alert("کادر متنی خالی است. لطفاً اسامی را وارد کنید.");return}const f=c.split(`
`).map(m=>m.trim()).filter(m=>m.length>0);f.length>0?(Ve(f),Yt(),L("csv-preview-page")):alert("هیچ نام معتبری برای ورود پیدا نشد.")}),a.addEventListener("keyup",c=>{c.key==="Enter"&&l.click()}),l.addEventListener("click",()=>{if(!r)return;const c=a.value.trim();if(!c){alert("لطفاً نام دانش‌آموز را وارد کنید.");return}const f=r.students.find(h=>h.identity.name.toLowerCase()===c.toLowerCase());if(f)if(f.isDeleted)Ye(f,r);else{alert("❌دانش‌آموزی با این نام از قبل در این کلاس وجود دارد.");return}const m=new ct({name:c});r.addStudent(m),r.sessions.length>0&&(Ln(m,r),kn(1)),N(),A(r.info.name,`دانش‌آموز «${c}» به کلاس اضافه شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:m.identity.studentId}),Ee(),a.value="",a.focus()}),o.addEventListener("click",()=>{J(),L("session-page")}),document.getElementById("new-session-btn").addEventListener("click",()=>{if(r){const c=r.sessions.find(m=>!m.isFinished&&!m.isCancelled&&!m.isDeleted);if(c){y(`⚠️ جلسه ${c.sessionNumber} هنوز تمام نشده است. لطفاً ابتدا با دکمه ✅ آن را خاتمه دهید.`);return}const f=()=>{const m=h=>{const E=r.startNewSession();Ze(E),X(E),r.students.forEach(te=>{Zt.setAttendance(te.identity.studentId,"present")}),N();const B=ve(r).get(E.sessionNumber);A(r.info.name,`جلسه ${B} شروع شد.`,{type:"VIEW_SESSIONS"}),h?(Ne(),L("attendance-page")):Be()};U("آیا تمایل به انجام فرآیند حضور و غیاب دارید؟",()=>m(!0),{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success",onCancel:()=>m(!1)})};r.hasSessionToday()?U("شما امروز یک جلسه برای این کلاس ثبت کرده‌اید. آیا از شروع یک جلسه جدید دیگر مطمئن هستید؟",f,{confirmText:"بله",confirmClass:"btn-warning"}):f()}}),t.addEventListener("click",()=>{const c=n.value.trim(),f=document.querySelector('input[name="class-type"]:checked');if(!c&&!f){y("⚠️لطفاً نام و نوع کلاس را مشخص کنید.");return}if(!c){y("⚠️لطفاً نام کلاس را وارد کنید.");return}if(!f){y("⚠️لطفاً نوع کلاس را انتخاب کنید.");return}if(w[c]){w[c].isDeleted?y("⚠️ کلاسی با این نام در سطل زباله است. ابتدا آن را بازیابی کنید و یا آن را پاک کنید."):y("⚠️کلاسی با این نام از قبل وجود دارد.");return}const m=f.value,h=new _t({name:c,type:m});w[c]=h,N(),A(c,`کلاس «${c}» ایجاد شد.`,{type:"VIEW_SESSIONS"}),oe(),y(`✅ کلاس «${c}» با موفقیت ایجاد شد.`),n.value="",f.checked=!1}),e.addEventListener("input",c=>{const f=c.target.value;if(f.length<2){yt([]);return}const m=f.toLowerCase(),h=Nn(m),E=[];for(const x in w){const B=w[x];if(B.isDeleted)continue;q(B.students).filter(V=>{const ae=Oe(V.identity.name.toLowerCase()),Me=ae.includes(Oe(m)),wn=ae.includes(Oe(h));return Me||wn}).forEach(V=>{E.push({student:V,classroom:B})})}yt(E)}),n.addEventListener("keyup",c=>{c.key==="Enter"&&t.click()}),s.addEventListener("click",rs),document.querySelectorAll(".back-to-classes-btn").forEach(c=>{c.addEventListener("click",()=>{z(null),X(null),Ze(null),L("class-management-page")})}),P.addEventListener("click",()=>{Be()}),ie.addEventListener("click",()=>{J(),L("session-page")}),Ls.addEventListener("click",()=>{if(G(null),!C&&r&&r.sessions.length>0){const c=q(r.sessions).filter(f=>!f.isCancelled);if(c.length>0){const f=c[c.length-1];X(f)}else{J(),L("session-page");return}}Be()}),qe.addEventListener("input",c=>{const f=c.target.value;if(!f){Je([]);return}const m=f.toLowerCase(),h=Nn(m),x=q(r.students).filter(B=>{const te=Oe(B.identity.name.toLowerCase()),V=te.includes(Oe(m)),ae=te.includes(Oe(h));return V||ae});Je(x)}),qe.addEventListener("focus",()=>{qe.value&&Je(qe.value)}),Pe.addEventListener("click",()=>{const c=Ce.value,f=me.value.trim();let m;if(kt)m=kt.student;else{const E=C==null?void 0:C.winnerHistory[ue];m=E==null?void 0:E.winner}if(!m){y("❌خطا: دانش‌آموز معتبری برای ثبت نمره یافت نشد.");return}const h=de;if(!m||!h){y("⚠️لطفاً ابتدا یک دانش‌آموز و یک دسته‌بندی را انتخاب کنید.");return}if(!c){y("⚠️لطفاً مقدار نمره را وارد کنید.");return}if(c>100||c<0){y("❌نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}m&&(m.addScore(h.name,parseFloat(c),f),A(r.info.name,`نمره ${c} در ${h.name} برای «${m.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:m.identity.studentId}),N(),ne(),y(`✅نمره برای ${m.identity.name} در مهارت ${h.name} ثبت شد.`),Ce.value="",me.value="",Le(m,h.name))});const bn=c=>{c.key==="Enter"&&c.ctrlKey&&(c.preventDefault(),Pe.click())};Ce.addEventListener("keydown",bn),me.addEventListener("keydown",bn),Bs.addEventListener("click",()=>{const c=ks.querySelector(".pill.active");if(!c){y("⚠️لطفاً یک مهارت را برای نمره‌دهی انتخاب کنید.");return}const f=c.dataset.skillName,m=ws.value,h=Ns.value.trim();if(!m){y("لطفاً مقدار نمره را وارد کنید.");return}O.addScore(f,parseFloat(m),h),N(),A(r.info.name,`نمره ${m} در ${f} برای «${O.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:O.identity.studentId}),Y(),y(`✅نمره برای مهارت ${f} با موفقیت ثبت شد.`)}),document.getElementById("add-note-btn").addEventListener("click",()=>{O&&(it.value="",it.dispatchEvent(new Event("input",{bubbles:!0})),pe(c=>{c&&(O.addNote(c),N(),A(r.info.name,`یادداشت جدیدی برای دانش‌آموز «${O.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:O.identity.studentId}),st())}),Z("add-note-modal"),it.focus())}),vs.addEventListener("click",()=>{Q()}),Es.addEventListener("click",()=>{const c=it.value.trim();typeof St=="function"&&(St(c),Ne(),Q())});const Ms=document.getElementById("move-student-confirm-btn"),$s=document.getElementById("move-student-cancel-btn"),Os=document.getElementById("move-student-class-select");$s.addEventListener("click",()=>{Q()}),Ms.addEventListener("click",()=>{const c=Os.value,f=w[c],{studentToMove:m,sourceClassForMove:h}=Us;if(!m||!h||!f){y("خطایی رخ داد. لطفاً دوباره امتحان کنید⚠️.","error"),Q();return}const E=Hn(m,h,f);E.success?(A(h.info.name,`دانش‌آموز «${m.identity.name}» به کلاس «${c}» منتقل شد.`,{type:"VIEW_SESSIONS"}),A(c,`دانش‌آموز «${m.identity.name}» از کلاس «${h.info.name}» به این کلاس منتقل شد.`,{type:"VIEW_SESSIONS"}),N(),Ee(),y(`دانش‌آموز «${m.identity.name}» با موفقیت به کلاس «${c}» منتقل شد✅.`)):y(E.message,"error"),Q()}),ce.addEventListener("click",()=>{se.style.width="250px",W.classList.add("modal-visible")}),xe.addEventListener("click",le),W.addEventListener("click",le),xs.addEventListener("click",()=>{at(),L("trash-page"),le()}),document.getElementById("demo-mode-btn").addEventListener("click",()=>{fe?Sn():(le(),U("شما در حال ورود به حالت نمایش (Demo) هستید. در این حالت، هیچ‌کدام از تغییرات شما ذخیره نخواهد شد. آیا ادامه می‌دهید؟",()=>{Fn(),Ct(),le()},{confirmText:"تایید",confirmClass:"btn-warning",onCancel:le}))});const In=document.getElementById("exit-demo-btn");In&&In.addEventListener("click",()=>{fe&&Sn()}),F.addEventListener("click",()=>{if(fe){y("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است."),le();return}le(),Cn()}),K.addEventListener("click",()=>{if(fe){y("⚠️ بازیابی اطلاعات در حالت نمایش (Demo) غیرفعال است."),le();return}ke.click(),le()}),ke.addEventListener("change",c=>{const f=c.target.files[0];if(!f)return;const m=new FileReader;m.onload=h=>{try{const E=JSON.parse(h.target.result);U("آیا از بازیابی اطلاعات مطمئن هستید؟ تمام داده‌های فعلی شما بازنویسی خواهد شد.",()=>{E.classrooms?(_e(E.classrooms),Pt(E.trashBin||[])):(_e(E),Pt([])),N(),oe(),L("class-management-page"),y("✅اطلاعات با موفقیت بازیابی شد.")},{confirmText:"بازیابی کن",confirmClass:"btn-warning"})}catch{y("❌خطا در خواندن فایل. لطفاً فایل پشتیبان معتبر انتخاب کنید.")}},m.readAsText(f),c.target.value=null}),window.addEventListener("popstate",c=>{if(Ie&&history.pushState(null,"",location.href),we(),c.state){const{pageId:f,currentClassName:m,selectedSessionNumber:h,selectedStudentId:E}=c.state;m&&(z(w[m]),h&&X(r.getSession(h)),E&&G(r.students.find(x=>x.identity.studentId===E))),f==="student-page"?Be():(f==="session-page"&&J(),Qe(f))}else z(null),X(null),G(null),Qe("class-management-page")}),document.addEventListener("keydown",c=>{var h;const f=document.activeElement;if(!["INPUT","TEXTAREA","SELECT"].includes(f.tagName)){if(c.key.toLowerCase()==="o"&&c.shiftKey&&Yn.classList.contains("active")&&(c.preventDefault(),ts.click()),c.key==="Escape"){if(De.classList.contains("visible")){we();return}if(Ie){Q();return}switch((h=document.querySelector(".page.active"))==null?void 0:h.id){case"csv-preview-page":case"column-mapping-page":L("settings-page");break;case"student-profile-page":G(null),L(C?"student-page":"session-page");break;case"attendance-page":L("student-page");break;case"student-page":X(null),J(),L("session-page");break;case"settings-page":case"session-page":z(null),L("class-management-page");break}return}if(C){const E=c.key.toLowerCase();switch(" ascfg".includes(E)&&c.preventDefault(),E){case" ":T.click();break;case"a":H.classList.contains("active")?history.back():(Ne(),L("attendance-page"));break;case"s":document.getElementById("session-page").classList.contains("active")?history.back():o.click();break;case"c":document.querySelector(".back-to-classes-btn").click();break;case"f":const x=document.querySelector(".action-column .search-icon");x&&x.click();break;case"g":if(Is.classList.contains("active"))history.back();else{const B=C.lastSelectedWinnerId;if(B){const te=r.students.find(V=>V.identity.studentId===B);te&&(G(te),Y(),L("student-profile-page"))}else y("⚠️ابتدا یک نفر را انتخاب کنید تا پروفایل او نمایش داده شود.")}break;case"arrowleft":{const B=document.querySelector('button[title="برنده قبلی"]');B&&!B.disabled&&(c.preventDefault(),B.click());break}case"arrowright":{const B=document.querySelector('button[title="برنده بعدی"]');B&&!B.disabled&&(c.preventDefault(),B.click());break}}}}});function le(){se.style.width="0",W.classList.add("modal-closing"),setTimeout(()=>{W.classList.remove("modal-visible","modal-closing")},300)}function Sn(){U("آیا از خروج از حالت نمایش (Demo) مطمئن هستید؟ با خروج، تمام تغییرات آزمایشی شما حذف شده و داده‌های اصلی شما بازیابی خواهند شد.",()=>{qn(),z(null),X(null),G(null),oe(),L("class-management-page"),Ct(),le()},{confirmText:"خروج",confirmClass:"btn-success"})}vn(".global-search-container .animated-search-container",yt),vn(".action-column-header .animated-search-container",Je),[R,fn,me,es].forEach(c=>{c&&ps(c)}),Ss.addEventListener("click",()=>{gn(O,r)});function Ln(c,f){const m=q(f.students).filter(M=>M.identity.studentId!==c.identity.studentId);if(m.length===0)return;let h=0;const E=q(f.categories);E.forEach(M=>{const re=Math.max(0,...m.map(Ue=>Ue.categoryCounts[M.name]||0));c.categoryCounts[M.name]=re,h+=re}),c.statusCounters.totalSelections=h;const x=m.reduce((M,re)=>M+re.statusCounters.totalSelections,0),B=m.reduce((M,re)=>M+(re.statusCounters.missedChances||0),0),te=x>0?B/x:0,V={};E.forEach(M=>{const re=m.reduce((Ht,At)=>Ht+(At.categoryCounts[M.name]||0),0),Ue=m.reduce((Ht,At)=>Ht+(At.categoryIssues[M.name]||0),0);V[M.name]=re>0?Ue/re:0}),c.statusCounters.missedChances=Math.round(c.statusCounters.totalSelections*te),E.forEach(M=>{const re=c.categoryCounts[M.name]||0,Ue=V[M.name]||0;c.categoryIssues[M.name]=Math.round(re*Ue)});const ae=q(f.sessions).filter(M=>!M.isCancelled&&M.isFinished);ae.forEach(M=>{M.setAttendance(c.identity.studentId,"absent")});const Me="📝 یادداشت خودکار سیستم",Ps=`این دانش‌آموز پس از جلسه شماره ${ae.length} به کلاس اضافه شد. آمار پایه‌ای زیر برای حفظ تعادل الگوریتم انتخاب برای او ثبت گردید:`,$e=[];c.statusCounters.totalSelections>0&&$e.push(`کل انتخاب‌ها: ${c.statusCounters.totalSelections}`),c.statusCounters.missedChances>0&&$e.push(`فرصت‌های از دست رفته: ${c.statusCounters.missedChances}`);for(const M in c.categoryCounts)c.categoryCounts[M]>0&&$e.push(`انتخاب در «${M}»: ${c.categoryCounts[M]}`);for(const M in c.categoryIssues)c.categoryIssues[M]>0&&$e.push(`مشکل در «${M}»: ${c.categoryIssues[M]}`);if($e.length>0){const M=`${Me}
${Ps}

- ${$e.join(`
- `)}`;c.addNote(M)}}function kn(c){const m=`چون این کلاس جلسات برگزار شده دارد، برای ${c>1?"دانش‌آموزان جدید":"دانش‌آموز جدید"} آمار پایه‌ای (متناسب با سایر دانش‌آموزان) ثبت شد تا در فرایند انتخاب اختلالی ایجاد نشود.`;U(m,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}const Hs="6.0.5";document.getElementById("app-version").textContent=`نسخه ${Hs}`;function As(){console.log("Starting universal backfill for writing scores...");let c=0;for(const f in w){const m=w[f];if(m.isDeleted)continue;let h=0;q(m.students).forEach(x=>{const B=x.logs.scores;if(!(B&&B.writing&&B.writing.length>0)){let V=-1;for(const ae in B)ae!=="writing"&&B[ae].forEach(Me=>{Me.value>V&&(V=Me.value)});if(V>-1){const ae=`Automatically assigned based on the highest score (${V}) from other skills.`;x.addScore("Writing",V,ae),h++}}}),h>0&&(console.log(`Updated ${h} student(s) in class: ${m.info.name}.`),c+=h)}c>0?(N(),console.log(`Update complete. A total of ${c} student(s) were updated across all classes. Data saved.`),document.getElementById("student-page").classList.contains("active")&&ne()):console.log("No students needed updating in any class.")}window.backfillWritingScoresForAll=As;function Rs(){console.log("Starting backfill for 'outOfClassCount' and 'wasOutOfClass' properties...");let c=0,f=0;const m=localStorage.getItem("teacherAssistantData_v2");if(!m){console.log("No data found in localStorage. Nothing to do.");return}const h=JSON.parse(m);for(const E in h){const x=h[E];x.students&&x.students.forEach(B=>{B.statusCounters&&typeof B.statusCounters.outOfClassCount>"u"&&(B.statusCounters.outOfClassCount=0,c++)}),x.sessions&&x.sessions.forEach(B=>{if(B.studentRecords)for(const te in B.studentRecords){const V=B.studentRecords[te];typeof V.wasOutOfClass>"u"&&(V.wasOutOfClass=!1,f++)}})}localStorage.setItem("teacherAssistantData_v2",JSON.stringify(h)),console.log(`Backfill complete. Updated ${c} students and ${f} session records. Data saved.`),wt(),r&&ne()}window.backfillExitCounters=Rs;function _s(c){if(!c||!c.classroomName)return;const f=w[c.classroomName];if(!f){y("⚠️ کلاس مربوط به این گزارش یافت نشد.");return}z(f),Q(),setTimeout(()=>{switch(c.type){case"VIEW_STUDENT_PROFILE":{const m=f.students.find(h=>h.identity.studentId===c.studentId);m?(G(m),Y(),L("student-profile-page")):y("⚠️ دانش‌آموز مورد نظر یافت نشد.");break}case"VIEW_TRASH":at(),L("trash-page");break;case"VIEW_SESSIONS":J(),L("session-page");break;case"VIEW_CLASS_NOTE":hn(f);break;case"VIEW_CLASS_SETTINGS":yn(f);break}},300)}});
