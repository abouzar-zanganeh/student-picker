(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function n(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(a){if(a.ep)return;a.ep=!0;const o=n(a);fetch(a.href,o)}})();class vt{constructor(t){this.identity={name:t.name,studentId:t.studentId||`id_${new Date().getTime()}_${Math.random()}`,branchName:t.branchName||null,ageGroup:t.ageGroup||"adult",level:t.level||null,contact:{social:t.socialContact||null,parent:t.parentContact||null}},this.isDeleted=!1,this.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0,outOfClassCount:0},this.categoryCounts={},this.categoryIssues={},this.logs={parentContacts:[],scores:{},discipline:{},sessionHistory:{}},this.profile={notes:[],tags:[]},this.finalClassActivityScore=null,this.onboardingSession=null}addScore(t,n,s){if(n>100||n<0){console.log("نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}const a=t.toLowerCase();this.logs.scores[a]||(this.logs.scores[a]=[]);const o=new po(t,n,s);this.logs.scores[a].push(o)}addNote(t,n=null){const s=new go(t,n);this.profile.notes.push(s)}getOverallAverageScore(){let t=0,n=0;for(const a in this.logs.scores)this.logs.scores[a].forEach(o=>{o.isDeleted||(t+=o.value,n++)});if(n===0)return null;const s=t/n;return Math.round(s*100)/100}}class po{constructor(t,n,s=""){this.id=`score_${new Date().getTime()}`,this.skill=t,this.value=n,this.timestamp=new Date,this.comment=s,this.isDeleted=!1}}class go{constructor(t,n=null){this.id=`note_${new Date().getTime()}`,this.timestamp=new Date,this.content=t,this.isDeleted=!1,this.source=n}}class Xt{constructor(t="complete",n=""){this.status=t,this.comment=n,this.timestamp=new Date}}class Xn{constructor(t){this.sessionNumber=t,this.startTime=new Date,this.note="",this.isDeleted=!1,this.endTime=null,this.isFinished=!1,this.isMakeup=!1,this.isCancelled=!1,this.studentRecords={},this.lastWinnerByCategory={},this.lastUsedCategoryId=null,this.lastSelectedWinnerId=null,this.winnerHistory=[]}end(){this.isFinished=!0,this.endTime=new Date}markAsMakeup(){this.isMakeup=!this.isMakeup}initializeStudentRecord(t){this.studentRecords[t]||(this.studentRecords[t]={attendance:"present",homework:new Xt,selections:{},hadIssue:!1,wasOutOfClass:!1})}setAttendance(t,n){this.initializeStudentRecord(t),this.studentRecords[t].attendance=n}setHomeworkStatus(t,n){this.initializeStudentRecord(t),this.studentRecords[t].homework.status=n}selectNextWinner(t,n,s){if(!n||n.length===0)return console.log("هیچ دانش‌آموزی در کلاس برای انتخاب وجود ندارد."),null;const a=this.lastWinnerByCategory[t];let o=n.filter(u=>u.identity.studentId!==a&&!u.isDeleted);if(o.length===0&&(o=n),o.length===0)return null;const i=(u,y)=>u.categoryCounts[y]||0,r=Math.min(...o.map(u=>i(u,t))),c=o.filter(u=>i(u,t)===r);let f;if(c.length===1)f=c[0];else if(c.length>1){const u=s.filter(N=>!N.isDeleted&&N.name!==t).map(N=>N.name),y=c.map(N=>{const _=u.reduce((G,j)=>G+i(N,j),0);return{student:N,otherCategoriesTotal:_}}),b=Math.min(...y.map(N=>N.otherCategoriesTotal)),L=y.filter(N=>N.otherCategoriesTotal===b).map(N=>N.student);L.length===1?f=L[0]:f=L[Math.floor(Math.random()*L.length)]}else f=o[Math.floor(Math.random()*o.length)];const p=f.identity.studentId;this.initializeStudentRecord(p);const w=(this.studentRecords[p].selections[t]||0)+1;return this.studentRecords[p].selections[t]=w,f.statusCounters.totalSelections++,f.categoryCounts[t]=(f.categoryCounts[t]||0)+1,this.lastWinnerByCategory[t]=p,f}}class Zt{constructor(t){this.info={name:t.name||"NotNamed",scheduleCode:t.scheduleCode||`code_${new Date().getTime()}`,teacherName:t.teacherName||null,type:t.type||"in-person",term:t.term||null,scheduleText:t.scheduleText||null,level:t.level||null,creationDate:t.creationDate?new Date(t.creationDate):new Date},this.students=[],this.sessions=[],this.note="",this.isDeleted=!1,this.categories=[new Se("Vocabulary","Questions about words and meanings."),new Se("Grammar","Questions about sentence structure and rules."),new Se("Listening",void 0,!0),new Se("Speaking",void 0,!0),new Se("Reading",void 0,!0),new Se("Writing",void 0,!0)],this.futurePlans={}}addStudent(t){this.students.push(t)}removeStudent(t){this.students=this.students.filter(n=>n.identity.studentId!==t)}startNewSession(){const t=this.sessions.length+1,n=new Xn(t);return this.sessions.push(n),n}endSpecificSession(t){const n=this.getSession(t);return n&&!n.isFinished?(n.end(),!0):!1}getSession(t){return this.sessions.find(n=>n.sessionNumber===t)}markAsMakeup(t){const n=this.getSession(t);n&&n.markAsMakeup()}planForSession(t,n){this.futurePlans[t]=n}hasSessionToday(){const t=new Date().toDateString();return this.sessions.some(n=>!n.isDeleted&&n.startTime.toDateString()===t)}selectNextWinner(t,n){return n?n.selectNextWinner(t,this.students,this.categories):null}get liveSession(){for(let t=this.sessions.length-1;t>=0;t--)if(!this.sessions[t].isFinished)return this.sessions[t];return null}endLiveSession(){const t=this.liveSession;return t?(t.end(),!0):!1}calculateFinalStudentScore(t){const n=t.logs.scores,s=["reading","writing"];for(const u of s)if(!n[u]||n[u].length===0)return null;const a=n.listening&&n.listening.length>0,o=n.speaking&&n.speaking.length>0;if(!a&&!o)return null;const i=u=>n[u].reduce((b,L)=>b+L.value,0)/n[u].length;let r;a&&o?r=(i("listening")+i("speaking"))/2:a?r=i("listening"):r=i("speaking");const c=i("reading"),f=i("writing"),w=(r*3+c*2+f*1)/6;return Math.trunc(w*10)/10}assignAllFinalScores(){let t=0,n=[];console.log("شروع عملیات محاسبه نمره نهایی برای تمام دانش‌آموزان..."),this.students.forEach(a=>{const o=this.calculateFinalStudentScore(a);o!==null?(a.finalClassActivityScore=o,t++):(a.finalClassActivityScore=null,n.push(a.identity.name))});const s=n.length;console.log(`عملیات پایان یافت. تعداد نمرات موفق: ${t} | تعداد ناموفق (نمرات ناقص): ${s}`),s>0&&(console.log("اسامی دانش‌آموزانی که نمراتشان ناقص است:"),n.forEach(a=>console.log(`- ${a}`)))}}class Se{constructor(t,n="",s=!1){this.id=`cat_${new Date().getTime()}_${Math.random()}`,this.name=t,this.description=n,this.isDeleted=!1,this.isGradedCategory=s,this.isDeleted=!1}}let S={},d=null,yn=null,v=null,D=null,rt=null,Vt=null,Cn=[],Tt=null,vn=null,le=null,Dt=0,En=0,Mt=0,bn=0,In=null,Sn=null,$t=null,Te=null,he=-1,Ot=null,Ht=null,Rt=null,Zn=null,es=null,Ce=!1,M=[],ge=[],Re=[],ue={isScreenSaverEnabled:!0,lastRestoreTimestamp:null};function k(){if(Ce)return;const e={classrooms:S,trashBin:M,userSettings:ue};localStorage.setItem("teacherAssistantData_v2",JSON.stringify(e))}function ts(e=[]){const t={};if(e.length>0)e.forEach(i=>{S[i]&&(t[i]=S[i])});else for(const i in S)S[i].isDeleted||(t[i]=S[i]);const n={metadata:{version:"2.0",createdAt:new Date().toISOString()},data:{classrooms:t,trashBin:M}},s=JSON.stringify(n,null,2),o=`SP-Backup-${new Date().toLocaleDateString("fa-IR-u-nu-latn").replace(/\//g,"-")}.txt`;return new File([s],o,{type:"text/plain"})}function At(){const e=localStorage.getItem("teacherAssistantData_v2");if(!e)return;const t=JSON.parse(e);t.classrooms?(Ae(t.classrooms),M=t.trashBin||[],ue={...ue,...t.userSettings}):(Ae(t),ho())}function ho(){const e=[];Object.values(S).forEach(t=>{t.isDeleted?e.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:t.info.creationDate,type:"classroom",description:`کلاس «${t.info.name}»`,restoreData:{name:t.info.name}}):t.students.forEach(n=>{n.isDeleted&&e.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:n.identity.studentId.split("_")[1],type:"student",description:`دانش‌آموز «${n.identity.name}»`,restoreData:{studentId:n.identity.studentId,classroomName:t.info.name}})})}),M.length===0&&e.length>0&&(M=e,console.log(`Migrated ${e.length} previously deleted item(s) to the new trash bin.`),k())}function Ae(e){S={};for(const t in e){const n=e[t];let s;n.info?s=n.info:s={...n,name:t};const a=new Zt(s);a.isDeleted=n.isDeleted,a.note=n.note||"",a.students=(n.students||[]).map(o=>{const i=new vt(o.identity);return i.isDeleted=o.isDeleted,i.statusCounters=o.statusCounters,i.logs=o.logs,i.logs.scores||(i.logs.scores={}),i.profile=o.profile,i.finalClassActivityScore=o.finalClassActivityScore,i.categoryCounts=o.categoryCounts||{},i.categoryIssues=o.categoryIssues||{},i.onboardingSession=o.onboardingSession||null,i}),a.sessions=(n.sessions||[]).map(o=>{const i=new Xn(o.sessionNumber);i.isDeleted=o.isDeleted,i.note=o.note||"",i.startTime=new Date(o.startTime),i.endTime=o.endTime?new Date(o.endTime):null,i.isFinished=o.isFinished,i.isMakeup=o.isMakeup,i.isCancelled=o.isCancelled||!1,i.studentRecords=o.studentRecords;for(const c in i.studentRecords){const f=i.studentRecords[c];f.homework&&!(f.homework instanceof Xt)&&(i.studentRecords[c].homework=new Xt(f.homework.status,f.homework.comment))}i.lastWinnerByCategory=o.lastWinnerByCategory,i.lastUsedCategoryId=o.lastUsedCategoryId,i.lastSelectedWinnerId=o.lastSelectedWinnerId;const r=o.winnerHistory||[];return i.winnerHistory=r.filter(c=>c&&c.winner).map(c=>({winner:a.students.find(p=>p.identity.studentId===c.winner.identity.studentId),categoryName:c.categoryName})).filter(c=>c.winner),i}),a.categories=(n.categories||[]).map(o=>{const i=new Se(o.name,o.description,o.isGradedCategory);return i.id=o.id,i.isDeleted=o.isDeleted,i}),a.futurePlans=n.futurePlans,S[t]=a}}function ns(e,t){if(t){const n=e.data.classrooms;for(let s in n){let a=s;const o=n[s];for(;S[a];)a=`${a} (Restored)`;a!==s&&(o.info.name=a),S[a]=o}if(e.data.trashBin){const s=[...M,...e.data.trashBin],a=[...new Map(s.map(o=>[o.id,o])).values()];Ft(a)}Ae(S)}else Ae(e.data.classrooms),Ft(e.data.trashBin||[]);nt({lastRestoreTimestamp:new Date().toISOString()}),k()}function ss(e,t){if(S[t])return{success:!1,message:"کلاسی با این نام از قبل وجود دارد."};const n=S[e];return n?(n.info.name=t,S[t]=n,delete S[e],d===n&&X(n),{success:!0}):{success:!1,message:"کلاس مورد نظر یافت نشد."}}function os(e,t,n){const s=n.trim();if(!s)return{success:!1,message:"نام دسته‌بندی نمی‌تواند خالی باشد."};if(e.categories.some(c=>c.id!==t.id&&!c.isDeleted&&c.name.toLowerCase()===s.toLowerCase()))return{success:!1,message:"دسته‌بندی دیگری با این نام وجود دارد."};const o=t.name,i=o.toLowerCase(),r=s.toLowerCase();return t.name=s,e.students.forEach(c=>{c.categoryCounts&&c.categoryCounts[o]!==void 0&&(c.categoryCounts[s]=c.categoryCounts[o],delete c.categoryCounts[o]),c.categoryIssues&&c.categoryIssues[o]!==void 0&&(c.categoryIssues[s]=c.categoryIssues[o],delete c.categoryIssues[o]),c.logs.scores&&c.logs.scores[i]&&(c.logs.scores[i].forEach(f=>f.skill=s),i!==r&&(c.logs.scores[r]=c.logs.scores[i],delete c.logs.scores[i]))}),e.sessions.forEach(c=>{c.lastWinnerByCategory&&c.lastWinnerByCategory[o]&&(c.lastWinnerByCategory[s]=c.lastWinnerByCategory[o],delete c.lastWinnerByCategory[o]),c.winnerHistory&&c.winnerHistory.forEach(f=>{f.categoryName===o&&(f.categoryName=s)})}),{success:!0}}function as(e,t,n){if(q(n.students).some(i=>i.identity.name.toLowerCase()===e.identity.name.toLowerCase()))return{success:!1,message:`دانش‌آموزی با نام «${e.identity.name}» از قبل در کلاس «${n.info.name}» وجود دارد.`};const a=JSON.parse(JSON.stringify(e));n.addStudent(a);const o=t.students.find(i=>i.identity.studentId===e.identity.studentId);return o&&dt(o,t),{success:!0}}function is(){for(const e in S){const t=S[e];t.students.forEach(n=>{n.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0},n.categoryCounts={},n.categoryIssues={},t.sessions.forEach(s=>{const a=n.identity.studentId;s.studentRecords[a]&&(s.studentRecords[a].attendance="present")})})}k()}function q(e){return Array.isArray(e)?e.filter(t=>!t.isDeleted):[]}function fe(e){const t=new Map;return e&&q(e.sessions).filter(s=>!s.isCancelled).sort((s,a)=>s.sessionNumber-a.sessionNumber).forEach((s,a)=>{t.set(s.sessionNumber,a+1)}),t}function Oe(e){he=e}function ve(e){Ot=e}function dt(e,t){if(!e||!t)return;const n=e.identity.studentId,s=t.students.findIndex(a=>a.identity.studentId===n);s>-1&&t.students.splice(s,1),t.sessions.forEach(a=>{a.studentRecords[n]&&delete a.studentRecords[n];for(const o in a.lastWinnerByCategory)a.lastWinnerByCategory[o]===n&&delete a.lastWinnerByCategory[o];a.lastSelectedWinnerId===n&&(a.lastSelectedWinnerId=null),a.winnerHistory=a.winnerHistory.filter(o=>o.winner&&o.winner.identity.studentId!==n)})}function cs(e,t){const n=S[e];if(!n)return;const s=n.sessions.findIndex(a=>a.sessionNumber===t);s>-1&&(n.students.forEach(a=>{a.profile.notes&&a.profile.notes.length>0&&(a.profile.notes=a.profile.notes.filter(o=>!o.source||o.source.type!=="fromAttendance"||o.source.sessionNumber!==t)),a.onboardingSession===t&&(a.onboardingSession=null)}),n.sessions.splice(s,1))}function ls(e,t){const n=S[e];if(!n)return;const s=n.categories.findIndex(r=>r.id===t);if(s===-1)return;const o=n.categories[s].name,i=o.toLowerCase();n.students.forEach(r=>{r.categoryCounts&&delete r.categoryCounts[o],r.categoryIssues&&delete r.categoryIssues[o],r.logs.scores&&delete r.logs.scores[i]}),n.sessions.forEach(r=>{r.lastWinnerByCategory[o]&&delete r.lastWinnerByCategory[o],r.winnerHistory=r.winnerHistory.filter(c=>c.categoryName!==o)}),n.categories.splice(s,1)}function rs(e,t,n,s){const a=S[e];if(!a)return;const o=a.students.find(c=>c.identity.studentId===t);if(!o||!o.logs.scores[n.toLowerCase()])return;const i=o.logs.scores[n.toLowerCase()],r=i.findIndex(c=>c.id===s);r>-1&&i.splice(r,1)}function ds(e,t,n){const s=S[e];if(!s)return;const a=s.students.find(i=>i.identity.studentId===t);if(!a||!a.profile.notes)return;const o=a.profile.notes.findIndex(i=>i.id===n);o>-1&&a.profile.notes.splice(o,1)}function us(){JSON.parse(JSON.stringify({classrooms:S,trashBin:M})),Ce=!0}function ms(){Ce=!1,At()}function X(e){d=e}function ut(e){yn=e}function ie(e){v=e}function de(e){D=e}function Wt(e){rt=e}function fs(e){Vt=e}function Ze(e){Cn=e}function Et(e){Tt=e}function ps(e){vn=e}function _t(e){le=e}function bt(e){Dt=e}function gs(e){En=e}function It(e){Mt=e}function hs(e){bn=e}function Ln(e){In=e}function wn(e){Sn=e}function mt(e){$t=e}function kn(e){Te=e}function Pt(e){Rt=e}function ys(e){Zn=e}function Cs(e){es=e}function Ft(e){M=e}function Gt(e){Ht=e}function qt(e){Re=e}function nt(e){ue={...ue,...e},k()}function en(e){ge=e}const yo=Object.freeze(Object.defineProperty({__proto__:null,get activeModal(){return Te},get cancelCallback(){return Sn},get classrooms(){return S},get confirmCallback(){return In},get currentClassroom(){return d},get easterEggClickCount(){return Dt},get easterEggLastClickTime(){return En},enterDemoMode:us,exitDemoMode:ms,getActiveItems:q,getSessionDisplayMap:fe,get importedFileContent(){return Tt},get isDemoMode(){return Ce},get liveSession(){return yn},loadData:At,get manualSelection(){return Rt},moveStudent:as,get namesToImport(){return Cn},get notificationTimeout(){return vn},permanentlyDeleteCategory:ls,permanentlyDeleteNote:ds,permanentlyDeleteScore:rs,permanentlyDeleteSession:cs,permanentlyDeleteStudent:dt,prepareBackupData:ts,get previousState(){return rt},processRestore:ns,rehydrateData:Ae,renameCategory:os,renameClassroom:ss,resetAllStudentCounters:is,get resetEasterEggClickCount(){return Mt},get resetEasterEggLastClickTime(){return bn},get saveCategoryCallback(){return Ht},saveData:k,get saveNoteCallback(){return Ot},get secureConfirmCallback(){return $t},get selectedCategory(){return le},get selectedClassIds(){return ge},get selectedSession(){return v},get selectedStudentForProfile(){return D},get selectedStudentsForMassComment(){return Re},setActiveModal:kn,setCancelCallback:wn,setConfirmCallback:Ln,setCurrentClassroom:X,setEasterEggClickCount:bt,setEasterEggLastClickTime:gs,setImportedFileContent:Et,setLiveSession:ut,setManualSelection:Pt,setNamesToImport:Ze,setNotificationTimeout:ps,setPreviousState:Wt,setResetEasterEggClickCount:It,setResetEasterEggLastClickTime:hs,setSaveCategoryCallback:Gt,setSaveNoteCallback:ve,setSecureConfirmCallback:mt,setSelectedCategory:_t,setSelectedClassIds:en,setSelectedSession:ie,setSelectedStudentForProfile:de,setSelectedStudentsForMassComment:qt,setSourceClassForMove:Cs,setStudentToMove:ys,setTrashBin:Ft,setUndoTimeout:fs,setUserSettings:nt,setWinnerHistoryIndex:Oe,get sourceClassForMove(){return es},get studentToMove(){return Zn},get trashBin(){return M},get undoTimeout(){return Vt},get userSettings(){return ue},get winnerHistoryIndex(){return he}},Symbol.toStringTag,{value:"Module"}));function be(e){return typeof e!="string"?"":e.replace(/ي/g,"ی").replace(/ك/g,"ک").replace(/[\s\u200c]/g,"")}function Nn(e){return typeof e!="string"||e.length===0?"ltr":/[\u0590-\u07FF]/.test(e)?"rtl":"ltr"}function vs(e){return!e||!e.trim()?"":e.split(`
`).map(s=>`<div dir="${Nn(s)}">${s||"&nbsp;"}</div>`).join("")}function Yt(e){if(typeof e!="string")return"";const t={q:"ض",w:"ص",e:"ث",r:"ق",t:"ف",y:"غ",u:"ع",i:"ه",o:"خ",p:"ح","[":"ج","]":"چ",a:"ش",s:"س",d:"ی",f:"ب",g:"ل",h:"ا",j:"ت",k:"ن",l:"م",";":"ک","'":"گ",z:"ظ",x:"ط",c:"ز",v:"ر",b:"ذ",n:"د",m:"پ",",":"و"};let n="";for(let s=0;s<e.length;s++){const a=e[s].toLowerCase();n+=t[a]||e[s]}return n}const Es="teacherAssistantLogs_v2",Co=100;function Bn(){try{const e=localStorage.getItem(Es);return e?JSON.parse(e):{}}catch(e){return console.error("Error reading logs from localStorage:",e),{}}}function bs(e){try{localStorage.setItem(Es,JSON.stringify(e))}catch(t){console.error("Error saving logs to localStorage:",t)}}function A(e,t,n=null){if(!e)return;const s=Bn();s[e]||(s[e]=[]);const a={timestamp:new Date().toISOString(),message:t,action:n,classroomName:e};s[e].unshift(a),s[e].length>Co&&s[e].pop(),bs(s)}function vo(e){return Bn()[e]||[]}function Eo(e,t){const n=Bn();n[e]&&!n[t]&&(n[t]=n[e],delete n[e],bs(n))}const Is=document.getElementById("class-management-page"),bo=document.getElementById("new-class-name"),Io=document.getElementById("add-class-btn"),Ge=document.getElementById("class-list"),Ut=document.getElementById("undo-toast"),Ss=document.getElementById("undo-message"),So=document.getElementById("undo-btn"),Lo=document.getElementById("settings-page"),xn=document.getElementById("settings-class-name-header"),tn=document.getElementById("settings-student-list"),nn=document.getElementById("category-list"),wo=document.getElementById("back-to-sessions-btn"),ko=document.getElementById("new-student-name"),No=document.getElementById("add-student-btn"),Ls=document.getElementById("paste-area"),Bo=document.getElementById("process-paste-btn"),xo=document.getElementById("csv-preview-page"),sn=document.getElementById("csv-preview-list"),To=document.getElementById("csv-confirm-btn"),Do=document.getElementById("csv-cancel-btn"),Mo=document.getElementById("import-csv-btn"),$o=document.getElementById("csv-file-input"),Oo=document.getElementById("column-mapping-page"),on=document.getElementById("column-select-dropdown"),Ho=document.getElementById("confirm-column-btn"),Ro=document.getElementById("cancel-import-btn"),Ao=document.getElementById("new-category-name"),Wo=document.getElementById("add-category-btn"),an=document.querySelector(".app-header"),we=document.getElementById("select-student-btn"),ze=document.getElementById("select-student-btn-wrapper"),_o=document.getElementById("attendance-page"),st=document.getElementById("attendance-list"),Po=document.getElementById("finish-attendance-btn"),Fo=document.querySelector("#class-management-page h2"),cn=document.getElementById("student-stats-header"),qo=document.getElementById("hamburger-menu-btn"),Uo=document.getElementById("side-nav-menu"),Vo=document.getElementById("close-nav-btn"),Go=document.getElementById("overlay"),jo=document.getElementById("backup-data-btn"),zo=document.getElementById("restore-data-btn"),ws=document.getElementById("restore-file-input"),Jo=document.getElementById("custom-confirm-modal"),ks=document.getElementById("confirm-modal-message"),ln=document.getElementById("confirm-modal-cancel-btn"),et=document.getElementById("confirm-modal-confirm-btn"),Ko=document.getElementById("secure-confirm-modal"),Ns=document.getElementById("secure-confirm-message"),Bs=document.getElementById("secure-confirm-code"),Ue=document.getElementById("secure-confirm-input"),Qo=document.getElementById("secure-confirm-cancel-btn"),St=document.getElementById("secure-confirm-confirm-btn"),Yo=document.getElementById("add-note-modal"),H=document.getElementById("new-note-content"),Xo=document.getElementById("class-save-note-btn"),Zo=document.getElementById("cancel-note-btn"),rn=document.getElementById("student-search-input"),xe=document.getElementById("student-search-results"),ea=document.getElementById("back-to-student-page-btn"),ta=document.getElementById("graded-category-pills-container"),na=document.getElementById("new-score-value"),xs=document.getElementById("new-score-comment"),sa=document.getElementById("add-score-btn"),oa=document.getElementById("profile-stats-summary"),aa=document.getElementById("profile-scores-list"),Lt=document.getElementById("global-student-search-input"),Ie=document.getElementById("global-student-search-results"),ia=document.getElementById("is-graded-checkbox"),ca=document.getElementById("trashed-classes-list"),la=document.getElementById("trashed-students-list"),ra=document.getElementById("trashed-sessions-list"),da=document.getElementById("trashed-categories-list"),ua=document.getElementById("trashed-notes-list"),ma=document.getElementById("trashed-scores-list"),ot=document.getElementById("quick-grade-form-wrapper"),Le=document.getElementById("quick-score-input"),ye=document.getElementById("quick-note-textarea"),Je=document.getElementById("quick-grade-submit-btn"),at=document.getElementById("category-selection-container"),dn=document.getElementById("selected-student-result"),He=document.getElementById("custom-context-menu"),Ve=document.getElementById("breadcrumb-container");let je=null;const fa=document.getElementById("category-modal"),Ts=document.getElementById("category-modal-title"),it=document.getElementById("new-category-modal-name"),Tn=document.getElementById("new-category-modal-is-graded"),pa=document.getElementById("category-modal-cancel-btn"),Ds=document.getElementById("category-modal-save-btn"),ga=document.getElementById("mass-comment-modal"),ha=document.getElementById("mass-comment-modal-title"),Ms=document.getElementById("mass-comment-student-count-message"),ct=document.getElementById("mass-comment-content"),Dn=document.getElementById("mass-comment-append-checkbox"),ya=document.getElementById("mass-comment-cancel-btn"),Ca=document.getElementById("mass-comment-save-btn"),un=document.getElementById("mass-comment-btn"),wt=document.getElementById("attendance-mass-actions-container"),Me=document.createElement("input"),va=document.getElementById("session-dashboard-page");function Mn(e="selector"){if(!d||!v){T("class-management-page");return}La(),Nt(),oe(),We(),T("session-dashboard-page"),$s(),$n(e),wa()}function $n(e){const t=document.getElementById("selector-tab-btn"),n=document.getElementById("attendance-tab-btn"),s=document.getElementById("selector-pane"),a=document.getElementById("attendance-pane"),o=e==="selector";t.classList.toggle("active",o),n.classList.toggle("active",!o),s.classList.toggle("active",o),a.classList.toggle("active",!o)}function $s(){const e=document.getElementById("selector-tab-btn"),t=document.getElementById("attendance-tab-btn"),n=document.getElementById("selector-pane"),s=document.getElementById("attendance-pane");e.addEventListener("click",()=>{e.classList.add("active"),t.classList.remove("active"),n.classList.add("active"),s.classList.remove("active")}),t.addEventListener("click",()=>{t.classList.add("active"),e.classList.remove("active"),s.classList.add("active"),n.classList.remove("active")})}function Ea(e){clearTimeout(Vt),rt||Wt(JSON.stringify(S)),Ss.textContent=e,Ut.classList.add("show"),fs(setTimeout(()=>{Ut.classList.remove("show"),Wt(null)},5e3))}function Os(){if(rt){const e=d?d.info.name:null,t=JSON.parse(rt);Ae(t),e&&S[e]?X(S[e]):X(null),d?(ke(),Ke(),te()):ae(),Ut.classList.remove("show"),clearTimeout(Vt),Wt(null)}}function C(e,t=3e3){const n=document.getElementById("notification-toast");n&&(n.textContent=e,n.classList.add("show"),clearTimeout(vn),ps(setTimeout(()=>{n.classList.remove("show")},t)))}function Hs(e){const t=document.getElementById("restore-confirm-modal"),n=document.getElementById("restore-modal-message"),s=document.getElementById("restore-append-checkbox"),a=document.getElementById("restore-confirm-cancel-btn"),o=document.getElementById("restore-confirm-confirm-btn"),i=document.getElementById("restore-modal-warning");i.style.display="none";const r=e.metadata.createdAt;if(ue.lastRestoreTimestamp&&r<ue.lastRestoreTimestamp){const u=new Date(r).toLocaleDateString("fa-IR"),y=new Date(ue.lastRestoreTimestamp).toLocaleDateString("fa-IR");i.textContent=`⚠️ هشدار: این فایل پشتیبان (${u}) قدیمی‌تر از آخرین بازیابی شما (${y}) است.`,i.style.display="block"}const c=Object.keys(e.data.classrooms).length,f="کلاس";n.textContent=`فایل پشتیبان شما حاوی ${c} ${f} است. لطفاً نحوه بازیابی را مشخص کنید.`,s.checked=!0;const p=()=>{const u=s.checked;ns(e,u),t.removeEventListener("click",p),F(),ae(),T("class-management-page"),C("✅ اطلاعات با موفقیت بازیابی شد.")},w=()=>{F()};o.onclick=p,a.onclick=w,Z("restore-confirm-modal")}function z(e,t,n={}){const{confirmText:s="تایید",cancelText:a="لغو",confirmClass:o="btn-success",onCancel:i=()=>{},isDelete:r=!1}=n,c=r?()=>Rs(e,t):t;ks.textContent=e,et.textContent=s,ln.textContent=a,et.className="modal-action-btn",et.classList.add(o),Ln(c),wn(i);const f=et.parentElement;ln.style.display=i===null?"none":"inline-block",f.style.justifyContent=i===null?"center":"space-between",Z("custom-confirm-modal")}function Rs(e,t){const n=Math.floor(1e4+Math.random()*9e4).toString();Ns.textContent=e,Bs.textContent=n,Ue.value="",St.disabled=!0,mt(t),Z("secure-confirm-modal"),Ue.focus();const s=()=>{Ue.value===n?St.disabled=!1:St.disabled=!0};return Ue.addEventListener("input",s),()=>{Ue.removeEventListener("input",s)}}function mn(e,t={}){const{title:n="ایجاد دسته‌بندی جدید",initialName:s="",initialIsGraded:a=!1,saveButtonText:o="ذخیره"}=t;Ts.textContent=n,it.value=s,Tn.checked=a,Ds.textContent=o,Gt((i,r)=>{if(!i){C("⚠️ لطفاً نام دسته‌بندی را وارد کنید.");return}e(i,r),F()}),Z("category-modal"),it.focus(),s&&it.select()}function As(e,t){const n=Object.values(S).filter(i=>!i.isDeleted&&i.info.name!==t.info.name),s=document.getElementById("move-student-modal-title"),a=document.getElementById("move-student-class-select"),o=document.getElementById("move-student-confirm-btn");s.textContent=`انتقال دانش‌آموز: ${e.identity.name}`,a.innerHTML="",n.length===0?(a.innerHTML='<option value="">کلاس دیگری برای انتقال وجود ندارد</option>',o.disabled=!0):(n.forEach(i=>{const r=document.createElement("option");r.value=i.info.name,r.textContent=i.info.name,a.appendChild(r)}),o.disabled=!1),ys(e),Cs(t),Z("move-student-modal")}function On(e,t){if(!e||!t)return;const n=e.identity.name,s=document.getElementById("add-note-modal-title");s.textContent="تغییر نام دانش‌آموز",H.value=n,H.rows=1,H.dispatchEvent(new Event("input",{bubbles:!0})),ve(a=>{const o=a.trim();o&&o!==n&&(q(t.students).some(r=>r.identity.studentId!==e.identity.studentId&&r.identity.name.toLowerCase()===o.toLowerCase())?C("دانش‌آموزی با این نام از قبل در این کلاس وجود دارد."):(e.identity.name=o,A(t.info.name,`نام دانش‌آموز «${n}» به «${o}» تغییر یافت.`,{type:"VIEW_STUDENT_PROFILE",studentId:e.identity.studentId}),k(),ke(),oe(),D&&D.identity.studentId===e.identity.studentId&&ne(e),C(`✅نام دانش‌آموز به «${o}» تغییر یافت.`))),s.textContent="ثبت یادداشت جدید",H.rows=4}),Z("add-note-modal"),H.focus(),H.select()}function Z(e){const t=document.getElementById(e);if(t){if(Te)return;document.body.classList.add("modal-active"),t.classList.add("modal-visible"),kn(e),history.pushState(null,"",location.href)}}function F(e,t=!1){if(!Te)return;const n=document.getElementById(Te),s=Te;kn(null),t||history.back(),n&&(n.classList.add("modal-closing"),setTimeout(()=>{n.classList.remove("modal-visible"),n.classList.remove("modal-closing"),document.body.classList.remove("modal-active"),s==="custom-confirm-modal"&&(Ln(null),wn(null)),s==="secure-confirm-modal"&&mt(null),s==="category-modal"&&Gt(null),s==="mass-comment-modal"&&(ct.value=""),s==="add-note-modal"&&ve(null),typeof e=="function"&&e()},300))}function Hn(){var t;if(((t=document.querySelector(".page.active"))==null?void 0:t.id)!=="attendance-page"){wt.style.display="none";return}const e=Re.length;e<1?wt.style.display="none":wt.style.display="block",un.disabled=e<1,un.textContent=`📝 ثبت یادداشت گروهی (${e} نفر)`}function Ws(){const e=Re,t=e.length;let n=!1;t>0&&(n=e.some(a=>{var o;return(o=v.studentRecords[a])==null?void 0:o.homework.comment})),Ms.textContent=`یادداشت برای ${t} دانش‌آموز ثبت خواهد شد.`,ct.value="",ct.dispatchEvent(new Event("input",{bubbles:!0})),Dn.checked=!0;const s=document.querySelector("#mass-comment-modal .modal-options");s.style.display=n?"flex":"none",Z("mass-comment-modal"),ct.focus()}function fn(e,t){if(!d||!v)return;let n=0;const s=Re,a=v;s.forEach(o=>{const i=a.studentRecords[o];if(i&&i.homework){const r=i.homework.comment||"";let c=e;t&&r.length>0?c=r+`
---
`+e:c=e,i.homework.comment=c.trim();const f=d.students.find(p=>p.identity.studentId===o);f&&ba(f,a,c.trim()),n++}}),qt([]),k(),We(),A(d.info.name,`${n} دانش‌آموز به صورت گروهی یادداشت تکلیف گرفتند.`,{type:"VIEW_SESSIONS"}),C(`✅ یادداشت برای ${n} دانش‌آموز ثبت شد.`)}function ba(e,t,n){const a=fe(d).get(t.sessionNumber),o={type:"fromAttendance",sessionNumber:t.sessionNumber},i=`یادداشت مربوط به جلسه ${a}: `,r=e.profile.notes.find(c=>!c.isDeleted&&c.source&&c.source.type==="fromAttendance"&&c.source.sessionNumber===o.sessionNumber);r?n?(r.content=i+n,r.isDeleted=!1):r.isDeleted=!0:n&&e.addNote(i+n,o)}function Rn(e){H.value=e.note||"",ve(t=>{e.note=t,k(),A(e.info.name,"یادداشت کلاس ذخیره شد.",{type:"VIEW_CLASS_NOTE"}),ae(),C("✅ یادداشت کلاس ذخیره شد.")}),Z("add-note-modal"),H.focus()}function An(e){X(e),xn.textContent=`تنظیمات کلاس: ${e.info.name}`,ke(),Ke(),T("settings-page")}function _s(e){const t=document.getElementById("log-modal-title"),n=document.getElementById("log-list");t.textContent=`گزارش فعالیت‌های کلاس: ${e}`,n.innerHTML="";const s=vo(e);s.length===0?n.innerHTML='<li class="no-content-message">هنوز فعالیتی برای این کلاس ثبت نشده است.</li>':s.forEach(a=>{const o=document.createElement("li");o.className="log-entry";const i=new Date(a.timestamp),r=`${i.toLocaleDateString("fa-IR")} - ${i.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}`,c=document.createElement("span");c.className="log-timestamp",c.textContent=r;const f=document.createElement("span");f.className="log-message",f.textContent=a.message,a.action&&(f.classList.add("log-action-link"),f.dataset.action=JSON.stringify({...a.action,classroomName:a.classroomName})),o.appendChild(c),o.appendChild(f),n.appendChild(o)}),Z("log-modal")}document.getElementById("log-modal-close-btn").addEventListener("click",()=>{F()});function pn(e){const t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download=e.name,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t)}async function ft(e=[]){const t=ts(e);if(("ontouchstart"in window||navigator.maxTouchPoints>0)&&navigator.share&&navigator.canShare&&navigator.canShare({files:[t]}))try{await navigator.share({title:"پشتیبان دستیار معلم",text:"فایل پشتیبان داده‌های برنامه",files:[t]})}catch(s){s.name!=="AbortError"&&(console.error("Error sharing file:",s),pn(t),C("⚠️اشتراک‌گذاری با خطا مواجه شد. فایل در حال دانلود است."))}else pn(t),C("✅پشتیبان‌گیری با موفقیت انجام شد.")}function gt(e,t){e.preventDefault(),$e(),je=e.target.closest("li"),je&&je.classList.add("context-menu-target"),setTimeout(()=>{const n=He,s=n.querySelector("ul");s.innerHTML="",t.forEach(f=>{const p=document.createElement("li");f.isSeparator?p.className="separator":(p.innerHTML=`
                    <span class="icon">${f.icon||""}</span>
                    <span class="label">${f.label}</span>
                `,f.className&&p.classList.add(f.className),p.addEventListener("click",()=>{f.action(),$e()})),s.appendChild(p)}),n.classList.add("visible");const{offsetWidth:a,offsetHeight:o}=n,{innerHeight:i}=window,r=document.body.getBoundingClientRect();n.style.top=`${(i-o)/2}px`;const c=r.left+r.width/2;n.style.left=`${c-a/2}px`},50)}function $e(){He.classList.contains("visible")&&He.classList.remove("visible"),je&&(je.classList.remove("context-menu-target"),je=null)}function Ps(){var t,n;Ve.innerHTML="";const e=[];if(e.push({label:"کلاس‌ها",handler:()=>{X(null),ie(null),de(null),T("class-management-page")}}),d){if(e.push({label:d.info.name,handler:()=>{ie(null),de(null),te(),T("session-page")}}),((t=document.querySelector(".page.active"))==null?void 0:t.id)==="settings-page")e.push({label:"تنظیمات"});else if(v){const o=fe(d).get(v.sessionNumber)||` (#${v.sessionNumber})`;e.push({label:`جلسه ${o}`,handler:()=>{de(null),T("student-page")}});const i=(n=document.querySelector(".page.active"))==null?void 0:n.id;D?e.push({label:`پروفایل: ${D.identity.name}`}):i==="attendance-page"&&e.push({label:"حضور و غیاب"})}}if(e.length<=1){Ve.style.display="none";return}Ve.style.display="flex",e.forEach((s,a)=>{const o=document.createElement("a");if(o.textContent=s.label,o.className="breadcrumb-item",a===e.length-1||!s.handler?o.classList.add("active"):o.addEventListener("click",s.handler),Ve.appendChild(o),a<e.length-1){const i=document.createElement("span");i.className="breadcrumb-separator",i.textContent="/",Ve.appendChild(i)}})}function Yn(e,t,n){n.innerHTML="";const s=d.sessions.filter(a=>{var o;return!a.isDeleted&&!a.isCancelled&&((o=a.studentRecords[e.identity.studentId])==null?void 0:o.attendance)==="absent"}).map(a=>({number:t.get(a.sessionNumber),isMakeup:a.isMakeup})).filter(a=>a.number!==void 0);s.length>0?(n.appendChild(document.createTextNode("جلسات غایب: ")),s.forEach((a,o)=>{const i=document.createElement("span");i.textContent=a.number,a.isMakeup&&i.classList.add("makeup-absence"),n.appendChild(i),o<s.length-1&&n.appendChild(document.createTextNode("، "))})):n.textContent="جلسات غایب: بدون غیبت"}function kt(e,t,n,s={}){const{includePrefix:a=!0}=s;n.innerHTML="";const o=d.sessions.filter(i=>{if(i.isDeleted||i.isCancelled)return!1;const r=i.studentRecords[e.identity.studentId];return r&&r.homework&&(r.homework.status==="incomplete"||r.homework.status==="none")}).map(i=>({number:t.get(i.sessionNumber),status:i.studentRecords[e.identity.studentId].homework.status})).filter(i=>i.number!==void 0);o.length>0?(a&&n.appendChild(document.createTextNode("تکالیف ناقص: ")),o.forEach((i,r)=>{const c=document.createElement("span");c.textContent=i.number,i.status==="incomplete"&&c.classList.add("incomplete-homework"),n.appendChild(c),r<o.length-1&&n.appendChild(document.createTextNode("،"))})):a?n.textContent="تکالیف ناقص: ندارد":n.textContent="ندارد"}function Ia(e,t){var _,G,j;const n=document.createElement("li");n.className="attendance-list-item";const s=document.createElement("input");s.type="checkbox",s.className="mass-comment-checkbox",s.checked=Re.includes(e.identity.studentId),s.addEventListener("change",()=>{const P=e.identity.studentId,$=Re;if(s.checked)$.includes(P)||$.push(P);else{const J=$.indexOf(P);J>-1&&$.splice(J,1)}Hn()}),n.appendChild(s);const a={none:"بدون تکلیف",complete:"تکلیف کامل",incomplete:"تکلیف ناقص"},o=document.createElement("div");o.className="student-info";const i=document.createElement("span");i.className="student-name",i.textContent=e.identity.name,i.addEventListener("click",()=>{ne(e)});const r=document.createElement("span");r.className="absence-info";const c=document.createElement("span");c.className="homework-info",Yn(e,t,r),kt(e,t,c),o.appendChild(i),o.appendChild(r),o.appendChild(c);const f=document.createElement("div");f.className="homework-controls";const p=document.createElement("button"),w=((_=v.studentRecords[e.identity.studentId])==null?void 0:_.homework.status)||"none";p.className=`homework-status-btn ${w}`,p.title=a[w],p.addEventListener("click",()=>{const P=v.studentRecords[e.identity.studentId].homework,J={none:"incomplete",incomplete:"complete",complete:"none"}[P.status];p.title=a[J],v.setHomeworkStatus(e.identity.studentId,J),k(),p.className=`homework-status-btn ${J}`,kt(e,t,c)});const u=document.createElement("button");u.className="btn-icon",u.innerHTML="📝",u.title="افزودن یادداشت برای تکلیف",((G=v.studentRecords[e.identity.studentId])==null?void 0:G.homework.comment)||(u.style.opacity="0.3"),u.addEventListener("click",()=>{const P=v.studentRecords[e.identity.studentId].homework;H.value=P.comment||"",H.dispatchEvent(new Event("input",{bubbles:!0})),ve($=>{P.comment=$;const J=fe(d),ce=J.get(v.sessionNumber),Ee={type:"fromAttendance",sessionNumber:v.sessionNumber},Q=`یادداشت مربوط به جلسه ${ce}: `,pe=e.profile.notes.find(K=>!K.isDeleted&&K.source&&K.source.type==="fromAttendance"&&K.source.sessionNumber===Ee.sessionNumber);pe?$?pe.content=Q+$:pe.isDeleted=!0:$&&e.addNote(Q+$,Ee),k(),A(d.info.name,`یادداشت تکلیف جلسه ${ce} برای دانش‌آموز «${e.identity.name}» ذخیره شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:e.identity.studentId}),C("✅یادداشت تکلیف ذخیره شد."),u.style.opacity=$?"1":"0.3",kt(e,J,c)}),Z("add-note-modal"),H.focus()}),f.appendChild(p),f.appendChild(u);const b=document.createElement("button"),L=((j=v.studentRecords[e.identity.studentId])==null?void 0:j.attendance)||"present",N=P=>{P==="present"?(b.textContent="حاضر",b.className="attendance-status-btn present active"):(b.textContent="غایب",b.className="attendance-status-btn absent active")};return N(L),b.addEventListener("click",()=>{var J;const $=(((J=v.studentRecords[e.identity.studentId])==null?void 0:J.attendance)||"present")==="present"?"absent":"present";v.setAttendance(e.identity.studentId,$),$==="absent"&&(v.studentRecords[e.identity.studentId].hadIssue=!1),k(),N($),Yn(e,t,r),js()}),n.appendChild(o),n.appendChild(f),n.appendChild(b),n}function Sa(){return fe(d).get(v.sessionNumber)}function We(){if(!d||!v)return;q(d.students).forEach(a=>{v.initializeStudentRecord(a.identity.studentId)}),qt([]);const e=fe(d);Oa(),st.innerHTML="";const t=document.createElement("li");t.className="attendance-list-header",Me.id="attendance-search-input",Me.type="text",Me.className="inline-search-input",Me.placeholder="جستجو...",Me.value="";const n=document.createElement("div");n.className="student-search-container",n.appendChild(Me);const s=document.createElement("div");s.className="header-labels-container",s.innerHTML=`
    <span class="header-label">تکلیف</span>
    <span class="header-label">حضور</span>
`,t.appendChild(n),t.appendChild(s),st.appendChild(t),q(d.students).forEach(a=>{const o=Ia(a,e);st.appendChild(o)}),qt([]),Hn(),Ha(),js()}function oe(){const e=document.getElementById("student-stats-table-container");if(!e||(e.innerHTML="",!d))return;q(d.students).length,cn.textContent="آمار عملکرد";const t=["نام"],n=["کل انتخاب ها","غیبت","خروج","فرصت ازدست‌رفته","مشکل","میانگین","نمره کلاسی (کانون)"],s=d.categories.filter(y=>y.isGradedCategory&&!y.isDeleted).map(y=>y.name),a=[...t,...s,...n],o=document.createElement("table");o.className="student-stats-table";const r=o.createTHead().insertRow();a.forEach((y,b)=>{const L=document.createElement("th");b===0?(L.innerHTML=`${y} <span style="opacity: 0.6;">🔗</span>`,L.title="ردیف‌های این ستون قابل کلیک هستند"):L.textContent=y,r.appendChild(L)});const c=o.createTBody(),f=q(d.students),p=y=>{let b=0;return d.sessions.forEach(L=>{if(L.isDeleted||L.isCancelled)return;const N=L.studentRecords[y.identity.studentId];N&&N.attendance==="absent"&&b++}),b};f.forEach(y=>{const b=c.insertRow();if(b.dataset.studentId=y.identity.studentId,v){const P=v.studentRecords[y.identity.studentId];P&&P.attendance==="absent"&&b.classList.add("absent-row-highlight")}const L=b.insertCell(),N=document.createElement("span");N.textContent=y.identity.name,N.className="student-name-link",N.addEventListener("click",()=>{ne(y)}),L.appendChild(N),s.forEach(P=>{var Ee;const $=b.insertCell(),J=P.toLowerCase(),ce=((Ee=y.logs.scores[J])==null?void 0:Ee.filter(Q=>!Q.isDeleted))||[];ce.length>0?ce.forEach((Q,pe)=>{const K=document.createElement("span");K.textContent=Q.value,K.style.position="relative",Q.comment&&(K.dataset.tooltip=Q.comment),$.appendChild(K),pe<ce.length-1&&$.appendChild(document.createTextNode(","))}):$.textContent="",$.style.cursor="pointer",$.addEventListener("click",()=>{me(y,P);const Q=document.getElementById("category-selection-container");Q&&Q.scrollIntoView({behavior:"smooth",block:"center"})})}),b.insertCell().textContent=y.statusCounters.totalSelections||0,b.insertCell().textContent=p(y),b.insertCell().textContent=y.statusCounters.outOfClassCount||0,b.insertCell().textContent=y.statusCounters.missedChances||0;const _=Object.values(y.categoryIssues||{}).reduce((P,$)=>P+$,0);b.insertCell().textContent=_;const G=y.getOverallAverageScore();b.insertCell().textContent=G!==null?G:"-";const j=d.calculateFinalStudentScore(y);b.insertCell().textContent=j!==null?j:"-"}),q(d.students),cn.setAttribute("data-student-count",f.length),e.appendChild(o);const w=e.querySelector(".student-stats-table"),u=w==null?void 0:w.querySelector("thead th:first-child");u&&u.addEventListener("click",()=>{w.classList.toggle("name-column-expanded")})}function me(e=null,t=null){const n=document.getElementById("selected-student-result");n.innerHTML="",n.classList.remove("absent");let s,a;if(e&&t)s=e,a=t,Pt({student:e,categoryName:t}),Oe(-1);else{if(Pt(null),!v||he<0||!v.winnerHistory[he])return;const R=v.winnerHistory[he];s=R.winner,a=R.categoryName}const o=document.querySelector(".current-winner-highlight");if(o&&o.classList.remove("current-winner-highlight"),s){const R=document.querySelector(`.student-stats-table tr[data-student-id="${s.identity.studentId}"]`);R&&R.classList.add("current-winner-highlight")}const i=d.categories.find(R=>R.name===a);if(i){_t(i);const R=document.querySelectorAll("#category-selection-container .pill");R.forEach(se=>se.classList.remove("active"));const V=Array.from(R).find(se=>se.textContent===a);V&&V.classList.add("active"),gn(i)}const r=v.studentRecords[s.identity.studentId],c=(r==null?void 0:r.attendance)==="absent",f=document.createElement("div");f.className="winner-name-container";const p=document.createElement("button");p.className="btn-icon",p.innerHTML="˅",p.title="برنده قبلی";const w=!e;p.classList.toggle("is-disabled",!w||he<=0),p.addEventListener("click",()=>{p.classList.contains("is-disabled")?(p.classList.add("shake-animation"),setTimeout(()=>p.classList.remove("shake-animation"),200)):(Oe(he-1),me())});const u=document.createElement("div");u.className="winner-name",u.innerHTML=`✨ <strong>${s.identity.name}</strong>✨`,u.classList.add("heartbeat-animation"),c&&(u.style.textDecoration="line-through",u.style.opacity="0.6",u.style.color="var(--color-secondary)"),(r==null?void 0:r.hadIssue)&&!c&&(u.style.color="var(--color-warning)",u.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"),(r==null?void 0:r.wasOutOfClass)&&!c&&(u.style.color="var(--color-strong-warning)",u.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود");const L=document.createElement("button");if(L.className="btn-icon",L.innerHTML="˄",L.title="برنده بعدی",L.classList.toggle("is-disabled",!w||he>=v.winnerHistory.length-1),L.addEventListener("click",()=>{L.classList.contains("is-disabled")?(L.classList.add("shake-animation"),setTimeout(()=>L.classList.remove("shake-animation"),200)):(Oe(he+1),me())}),f.appendChild(L),f.appendChild(u),s.onboardingSession===v.sessionNumber){const R=document.createElement("div");R.className="new-student-badge",R.textContent="دانش آموز جدید",f.appendChild(R)}f.appendChild(p),n.appendChild(f),we.disabled=w&&!L.classList.contains("is-disabled");const N=document.createElement("div");N.className="status-button-container";const _=document.createElement("button");_.textContent="غایب",_.classList.add("status-button","absent-btn"),c&&_.classList.add("active");const G=document.createElement("button");G.textContent="مشکل",G.classList.add("status-button","issue-btn"),r!=null&&r.hadIssue&&G.classList.add("active");const j=document.createElement("button");j.textContent="خروج",j.classList.add("status-button","exit-btn"),r!=null&&r.wasOutOfClass&&j.classList.add("active");const P=document.createElement("button");P.textContent="پروفایل",P.className="status-button profile-btn",_.addEventListener("click",()=>{const R=_.classList.contains("active");j.classList.contains("active")&&(j.classList.remove("active"),r.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),R?(_.classList.remove("active"),v.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),u.style.textDecoration="",u.style.opacity="",u.style.color=""):(G.classList.contains("active")&&(G.classList.remove("active"),r.hadIssue=!1,s.statusCounters.otherIssues=Math.max(0,s.statusCounters.otherIssues-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),_.classList.add("active"),v.setAttendance(s.identity.studentId,"absent"),s.statusCounters.missedChances++,u.style.textDecoration="line-through",u.style.opacity="0.6",u.style.color="var(--color-secondary)",u.title=""),oe(),k()}),G.addEventListener("click",()=>{const R=G.classList.contains("active");if(j.classList.contains("active")&&(j.classList.remove("active"),r.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),R){G.classList.remove("active"),r.hadIssue=!1;const V=le.name;s.categoryIssues[V]&&(s.categoryIssues[V]=Math.max(0,s.categoryIssues[V]-1)),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),u.style.color="",u.title=""}else{_.classList.contains("active")&&(_.classList.remove("active"),v.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),G.classList.add("active"),r.hadIssue=!0;const V=le.name;s.categoryIssues[V]=(s.categoryIssues[V]||0)+1,s.statusCounters.missedChances++,u.style.textDecoration="",u.style.opacity="",u.style.color="var(--color-warning)",u.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"}oe(),k()}),j.addEventListener("click",()=>{if(j.classList.contains("active"))j.classList.remove("active"),r.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),u.style.color="",u.title="";else{if(_.classList.contains("active")&&(_.classList.remove("active"),v.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),G.classList.contains("active")){G.classList.remove("active"),r.hadIssue=!1;const V=le.name;s.categoryIssues[V]&&(s.categoryIssues[V]=Math.max(0,s.categoryIssues[V]-1)),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)}j.classList.add("active"),r.wasOutOfClass=!0,s.statusCounters.outOfClassCount=(s.statusCounters.outOfClassCount||0)+1,s.statusCounters.missedChances++,u.style.textDecoration="",u.style.opacity="",u.style.color="var(--color-strong-warning)",u.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود"}oe(),k()}),P.addEventListener("click",()=>{ne(s)}),N.appendChild(_),N.appendChild(j),N.appendChild(G),N.appendChild(P),n.appendChild(N);const $=document.createElement("div");$.className="student-details-container";const J=document.createElement("div");J.className="student-details-scores",J.innerHTML="<h4>آخرین نمرات</h4>";const ce=document.createElement("ul");ce.className="scores-list";const Ee=["Reading","Writing","Speaking","Listening"];let Q=!1;const pe=s.logs.scores||{};Ee.forEach(R=>{var Be;const V=document.createElement("li"),se=document.createElement("span");se.className="skill-name",se.textContent=`${R}:`;const Fe=document.createElement("span");Fe.className="skill-scores";const jt=R.toLowerCase(),Qe=(Be=pe[jt])==null?void 0:Be.filter(Ye=>!Ye.isDeleted);Qe&&Qe.length>0?(Q=!0,Fe.textContent=Qe.slice(-3).map(Ye=>Ye.value).join(",")):Fe.textContent="none",V.appendChild(se),V.appendChild(Fe),ce.appendChild(V)}),!Q&&Object.keys(pe).length===0&&(ce.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>'),J.appendChild(ce),$.appendChild(J);const K=document.createElement("div");K.className="student-details-notes";const _e=document.createElement("div");_e.className="history-section-header";const ht=document.createElement("h4");ht.textContent="یادداشت‌ها";const Ne=document.createElement("button");Ne.className="btn-icon",Ne.innerHTML="📝",Ne.title="افزودن یادداشت جدید",Ne.addEventListener("click",()=>{H.value="",H.dispatchEvent(new Event("input",{bubbles:!0})),ve(R=>{R&&(s.addNote(R),k(),me(),C("✅ یادداشت با موفقیت ثبت شد."))}),Z("add-note-modal"),H.focus()}),_e.appendChild(ht),_e.appendChild(Ne),K.appendChild(_e);const Pe=document.createElement("ul");Pe.className="notes-list",s.profile.notes&&s.profile.notes.length>0?[...s.profile.notes].sort((V,se)=>new Date(se.timestamp)-new Date(V.timestamp)).forEach(V=>{const se=document.createElement("li");se.dir=Nn(V.content),se.textContent=V.content,Pe.appendChild(se)}):Pe.innerHTML='<div class="no-content-message">یادداشتی وجود ندارد.</div>',K.appendChild(Pe),$.appendChild(K),n.appendChild($)}function Fs(e){e.addEventListener("input",()=>{const t=e.value,n=Nn(t);e.setAttribute("dir",n)})}function La(){at.innerHTML="",dn.innerHTML="",ot.classList.add("tooltip-container"),Le.disabled=!0,ye.disabled=!0,Je.disabled=!0,Le.value="",ye.value="",ze.classList.add("disabled-wrapper"),we.disabled=!0}function Nt(){at.innerHTML="",d.categories.filter(n=>!n.isDeleted).forEach(n=>{const s=document.createElement("span");s.className="pill",s.textContent=n.name,s.dataset.categoryId=n.id,n.description&&(s.dataset.tooltip=n.description),s.addEventListener("click",()=>{document.querySelectorAll("#category-selection-container .pill").forEach(o=>o.classList.remove("active")),s.classList.add("active"),_t(n),gn(n),ze.classList.remove("disabled-wrapper"),we.disabled=!1;const a=v.lastWinnerByCategory[n.name];if(a){const o=d.students.find(i=>i.identity.studentId===a);o&&me(o,n.name)}else{dn.innerHTML="",Pt(null),Oe(-1),we.disabled=!1;const o=document.querySelector(".current-winner-highlight");o&&o.classList.remove("current-winner-highlight")}}),s.addEventListener("contextmenu",a=>{gt(a,[{label:"تغییر نام",icon:"✏️",action:()=>{mn((i,r)=>{const c=os(d,n,i);c.success?(n.isGradedCategory=r,k(),A(d.info.name,`نام دسته‌بندی «${n.name}» به «${i}» تغییر یافت.`),Nt(),oe(),C(`✅ نام دسته‌بندی به «${i}» تغییر یافت.`)):C(`⚠️ ${c.message}`)},{title:"ویرایش دسته‌بندی",initialName:n.name,initialIsGraded:n.isGradedCategory,saveButtonText:"ذخیره تغییرات"})}},{label:"حذف دسته‌بندی",icon:"🗑️",className:"danger",action:()=>{z(`آیا از انتقال دسته‌بندی «${n.name}» به سطل زباله مطمئن هستید؟`,()=>{const i={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${n.name}» از کلاس «${d.info.name}»`,restoreData:{categoryId:n.id,classId:d.info.scheduleCode}};M.unshift(i),M.length>50&&M.pop();const r=n.name.toLowerCase();if(d.students.forEach(c=>{c.logs.scores&&c.logs.scores[r]&&c.logs.scores[r].forEach(f=>{f.isDeleted=!0})}),le&&le.id===n.id){_t(null),dn.innerHTML="",gn(null),ze.classList.add("disabled-wrapper"),we.disabled=!0;const c=document.querySelector(".current-winner-highlight");c&&c.classList.remove("current-winner-highlight")}n.isDeleted=!0,A(d.info.name,`دسته‌بندی «${n.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),k(),Nt(),oe(),C(`✅ دسته‌بندی «${n.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}}])}),at.appendChild(s)});const t=document.createElement("span");t.className="pill add-category-pill",t.textContent="+",t.title="افزودن دسته‌بندی جدید",t.addEventListener("click",()=>{mn((n,s)=>{if(d.categories.find(i=>i.name.toLowerCase()===n.toLowerCase()&&!i.isDeleted)){C("⚠️ این دسته‌بندی از قبل وجود دارد.");return}const o=new Se(n,"",s);d.categories.push(o),k(),A(d.info.name,`دسته‌بندی جدید «${n}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),Nt(),C(`✅ دسته‌بندی «${n}» اضافه شد.`)})}),at.appendChild(t)}function wa(){if(v.lastUsedCategoryId){if(v.isFinished)return;const e=at.querySelector(`.pill[data-category-id="${v.lastUsedCategoryId}"]`);e&&e.click()}v.winnerHistory&&v.winnerHistory.length>0&&(Oe(v.winnerHistory.length-1),me())}function gn(e){e&&e.isGradedCategory?(Le.disabled=!1,ye.disabled=!1,Je.disabled=!1,ot.removeAttribute("title")):(Le.disabled=!0,ye.disabled=!0,Je.disabled=!0,e?ot.setAttribute("title","برای این دسته‌بندی قابلیت نمره دهی تعریف نشده است"):ot.setAttribute("title","ابتدا یک دسته‌بندی را انتخاب کنید"))}function ne(e){de(e);const t=document.getElementById("student-profile-modal"),n=document.getElementById("modal-profile-student-name"),s=document.getElementById("modal-profile-content-container"),a=document.getElementById("modal-profile-close-btn");!t||!n||!s||!a||(n.textContent=`پروفایل: ${e.identity.name}`,n.style.cursor="pointer",n.onclick=()=>{const o=D,i=d;F(()=>{On(o,i)})},s.innerHTML="",ka(s),Wn(s),a.onclick=()=>F(),Z("student-profile-modal"))}function ka(e){if(!D||!d)return;const t=document.createElement("div");t.className="scoring-section",t.innerHTML=`
        <h3>ثبت نمره جدید</h3>
        <div id="modal-graded-pills" class="category-pills"></div>
        <div class="input-group centered-input-group" style="margin-top: 15px;">
            <input type="number" id="modal-new-score-value" placeholder="نمره (مثلا: 85)">
        </div>
        <textarea id="modal-new-score-comment" placeholder="توضیحات این نمره (اختیاری)..." style="margin-top: 10px;"></textarea>
        <button id="modal-add-score-btn" class="btn-success" style="width: 100%; margin-top: 10px;">ثبت نمره</button>
    `;const n=t.querySelector("#modal-graded-pills");q(d.categories).filter(o=>o.isGradedCategory).forEach(o=>{const i=document.createElement("span");i.className="pill",i.textContent=o.name,i.dataset.skillName=o.name,i.addEventListener("click",()=>{n.querySelectorAll(".pill").forEach(r=>r.classList.remove("active")),i.classList.add("active")}),n.appendChild(i)}),t.querySelector("#modal-add-score-btn").addEventListener("click",()=>{const o=n.querySelector(".pill.active");if(!o){C("⚠️لطفاً یک مهارت را برای نمره‌دهی انتخاب کنید.");return}const i=o.dataset.skillName,r=t.querySelector("#modal-new-score-value"),c=t.querySelector("#modal-new-score-comment"),f=r.value,p=c.value.trim();if(!f){C("لطفاً مقدار نمره را وارد کنید.");return}D.addScore(i,parseFloat(f),p),k(),A(d.info.name,`نمره ${f} در ${i} برای «${D.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:D.identity.studentId}),oe(),me(),r.value="",c.value="";const w=document.getElementById("modal-profile-content-container"),u=w.querySelector(".history-section");u&&u.remove(),Wn(w),C(`✅ نمره برای مهارت ${i} با موفقیت ثبت شد.`)}),e.appendChild(t)}function Wn(e){if(!D)return;const t=document.createElement("div");t.className="history-section";const n=document.createElement("div");n.className="history-section-header";const s=document.createElement("h3");s.textContent="سوابق دانش‌آموز";const a=document.createElement("button");a.className="btn-icon",a.title="افزودن یادداشت جدید",a.innerHTML="📝",a.addEventListener("click",()=>{H.value="",H.dispatchEvent(new Event("input",{bubbles:!0})),ve(o=>{if(o){D.addNote(o),k(),A(d.info.name,`یادداشت جدیدی برای دانش‌آموز «${D.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:D.identity.studentId}),me();const i=document.getElementById("modal-profile-content-container");if(i){const r=i.querySelector(".history-section");r&&r.remove(),Wn(i)}C("✅ یادداشت با موفقیت ثبت شد.")}}),F(()=>{Z("add-note-modal"),H.focus()})}),n.appendChild(s),n.appendChild(a),t.appendChild(n),Na(t),qs(t),Us(t),e.appendChild(t)}function Na(e){if(!D)return;const t=D,n=d.sessions.reduce((u,y)=>{const b=y.studentRecords[t.identity.studentId];return u+(b&&b.attendance==="absent"?1:0)},0),s=Object.values(t.categoryIssues||{}).reduce((u,y)=>u+y,0),a=document.createElement("div");a.className="stats-summary-box",a.innerHTML=`
        <p><strong>کل انتخاب:</strong> ${t.statusCounters.totalSelections}</p>
        <p><strong>غیبت:</strong> ${n}</p>
        <p><strong>فرصت از دست رفته:</strong> ${t.statusCounters.missedChances||0}</p>
        <p><strong>مشکل:</strong> ${s}</p>
    `,e.appendChild(a);const o=q(d.categories),i=document.createElement("div");if(i.className="stats-breakdown",o.length>0){o.forEach(y=>{var _;const b=y.name,L=((_=t.categoryCounts)==null?void 0:_[b])||0,N=document.createElement("p");N.className="stats-breakdown-item",N.innerHTML=`<strong>${b}:</strong> ${L}`,i.appendChild(N)});const u=a.querySelector("p:first-child");u&&u.after(i)}const r=document.createElement("div");r.className="stats-breakdown",o.length>0&&(o.forEach(u=>{var N;const y=u.name,b=((N=t.categoryIssues)==null?void 0:N[y])||0,L=document.createElement("p");L.className="stats-breakdown-item",L.innerHTML=`<strong>${y}:</strong> ${b}`,r.appendChild(L)}),a.appendChild(r));const c=document.createElement("p"),f=document.createElement("strong");f.textContent="تکالیف ناقص:";const p=document.createElement("span");p.style.marginRight="5px";const w=fe(d);kt(t,w,p,{includePrefix:!1}),c.appendChild(f),c.appendChild(p),a.appendChild(c)}function qs(e){if(!D)return;const t=D,n=document.createElement("h4");n.textContent="تاریخچه نمرات:",n.style.marginTop="20px";const s=document.createElement("ul");s.className="list-container";const a=Object.values(t.logs.scores||{}).flat().filter(o=>!o.isDeleted).sort((o,i)=>new Date(i.timestamp)-new Date(o.timestamp));a.length===0?s.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>':a.forEach(o=>{const i=document.createElement("li");i.className="score-history-item";const r=document.createElement("div");r.className="item-content";const c=document.createElement("div");c.className="score-info";const f=document.createElement("span");f.className="score-skill-badge",f.textContent=o.skill;const p=document.createElement("span");p.className="score-value",p.textContent=`نمره: ${o.value}`;const w=document.createElement("span");if(w.className="score-date",w.textContent=new Date(o.timestamp).toLocaleDateString("fa-IR"),c.appendChild(f),c.appendChild(p),c.appendChild(w),r.appendChild(c),o.comment){const y=document.createElement("p");y.className="score-comment",y.innerHTML=vs(o.comment),r.appendChild(y)}const u=document.createElement("button");u.className="btn-icon delete-item-btn",u.innerHTML="🗑️",u.title="حذف این نمره",u.addEventListener("click",()=>{F(()=>{z(`آیا از انتقال نمره ${o.value} در مهارت «${o.skill}» به سطل زباله مطمئن هستید؟`,()=>{const y={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"score",description:`نمره ${o.value} (${o.skill}) برای «${t.identity.name}»`,restoreData:{scoreId:o.id,skill:o.skill,studentId:t.identity.studentId,classId:d.info.scheduleCode}};M.unshift(y),M.length>50&&M.pop(),o.isDeleted=!0,k(),A(d.info.name,`نمره ${o.value} (${o.skill}) دانش‌آموز «${t.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ne(t),C("✅ نمره به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{ne(t)}})})}),i.appendChild(r),i.appendChild(u),s.appendChild(i)}),e.appendChild(n),e.appendChild(s)}function Us(e){if(!D)return;const t=document.createElement("h4");t.textContent="تاریخچه یادداشت‌ها:",t.style.marginTop="20px";const n=document.createElement("ul");n.className="list-container",!D.profile.notes||D.profile.notes.length===0?n.innerHTML='<div class="no-content-message">هنوز یادداشتی ثبت نشده است.</div>':[...D.profile.notes].filter(a=>!a.isDeleted).sort((a,o)=>new Date(o.timestamp)-new Date(a.timestamp)).forEach(a=>{const o=document.createElement("li");o.className="note-history-item";const i=document.createElement("div");i.className="item-content";const r=document.createElement("div");r.className="note-info";const c=document.createElement("span");c.className="note-date",c.textContent=new Date(a.timestamp).toLocaleDateString("fa-IR");const f=document.createElement("button");f.className="btn-icon delete-item-btn",f.innerHTML="🗑️",f.title="حذف این یادداشت",f.addEventListener("click",()=>{F(()=>{z("آیا از انتقال این یادداشت به سطل زباله مطمئن هستید؟",()=>{const w={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"note",description:`یادداشت برای دانش‌آموز «${D.identity.name}»`,restoreData:{noteId:a.id,studentId:D.identity.studentId,classId:d.info.scheduleCode}};M.unshift(w),M.length>50&&M.pop(),a.isDeleted=!0,A(d.info.name,`یادداشت دانش‌آموز «${D.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),k(),ne(D),C("✅ یادداشت به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{ne(D)}})})}),r.appendChild(c),r.appendChild(f);const p=document.createElement("p");p.className="note-content",p.innerHTML=vs(a.content),p.addEventListener("click",()=>{H.value=a.content,H.dispatchEvent(new Event("input",{bubbles:!0})),ve(w=>{a.content=w,k(),A(d.info.name,`یادداشت دانش‌آموز «${D.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:D.identity.studentId}),ne(D),C("✅یادداشت با موفقیت ویرایش شد.")}),Z("add-note-modal"),H.focus()}),i.appendChild(r),i.appendChild(p),o.appendChild(i),n.appendChild(o)}),e.appendChild(t),e.appendChild(n)}function Vs(e){on.innerHTML="",e.forEach((t,n)=>{const s=document.createElement("option");s.value=n,s.textContent=t.trim(),on.appendChild(s)})}function hn(){sn.innerHTML="",Cn.forEach(e=>{const t=document.createElement("li");t.className="preview-item";const n=document.createElement("input");n.type="checkbox",n.checked=!0,n.dataset.name=e;const s=document.createElement("label");s.textContent=e,t.appendChild(n),t.appendChild(s),sn.appendChild(t)})}function Ba(e){const t=document.createElement("div");t.className="list-item-buttons";const n=document.createElement("button");return n.className="btn-icon",n.innerHTML="📝",n.title="افزودن/ویرایش یادداشت کلاس",n.style.borderBottom="solid",e.note||(n.style.opacity="0.5",n.style.borderBottom="none"),n.addEventListener("click",s=>{s.stopPropagation(),Rn(e)}),t.appendChild(n),t}function xa(e){const t=document.createElement("div");t.style.flexGrow="1",t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="flex-start";const n=document.createElement("span");n.textContent=e.info.name,n.classList.add("class-name-display"),t.appendChild(n);const s=q(e.students).length,a=q(e.sessions).filter(c=>c.isFinished).length,o=document.createElement("div");o.classList.add("class-stats-row");const i=document.createElement("span");i.textContent=`${s} نفر`,i.classList.add("student-count-badge"),o.appendChild(i);const r=document.createElement("span");return r.textContent=`${a} جلسه`,r.classList.add("session-count-badge"),o.appendChild(r),t.appendChild(o),t.addEventListener("click",()=>{X(e),ie(null),ut(d.liveSession),te(),T("session-page")}),t}function Ta(e){const t=document.createElement("li"),n=document.createElement("input");n.type="checkbox",n.className="mass-selection-checkbox",n.checked=ge.includes(e.info.name),n.addEventListener("click",r=>{r.stopPropagation()}),n.addEventListener("change",()=>{const r=e.info.name;if(n.checked)ge.includes(r)||ge.push(r);else{const c=ge.indexOf(r);c>-1&&ge.splice(c,1)}}),t.appendChild(n);const s=xa(e);t.appendChild(s);const a=document.createElement("div");if(a.className="list-item-badges",e.liveSession&&!e.liveSession.isCancelled&&!e.liveSession.isDeleted){const r=document.createElement("span");r.className="warning-badge",r.textContent="جلسه باز",a.appendChild(r),t.classList.add("has-unfinished-session")}const o=document.createElement("span");o.className=`type-badge ${e.info.type}`,o.textContent=e.info.type==="online"?"آنلاین":"حضوری",o.title="نوع کلاس",a.appendChild(o),t.appendChild(a);const i=Ba(e);return t.appendChild(i),t.addEventListener("contextmenu",r=>{const c={label:"پشتیبان‌گیری از این کلاس",icon:"📤",action:()=>{ft([e.info.name])}},f=ge.length;f>1&&ge.includes(e.info.name)&&(c.label=`پشتیبان‌گیری از ${f} کلاس`,c.action=()=>{ft(ge),en([]),ae()});const p=[{label:Ge.classList.contains("selection-mode-active")?"لغو انتخاب":"انتخاب چند کلاس",icon:"✔️",action:()=>{const w=Ge.classList.contains("selection-mode-active");Ge.classList.toggle("selection-mode-active"),w&&(en([]),ae())}},c,{label:"تنظیمات کلاس",icon:"⚙️",action:()=>{An(e)}},{label:"گزارش فعالیت‌ها",icon:"📋",action:()=>{_s(e.info.name)}},{label:"تغییر نام",icon:"✏️",action:()=>{const w=e.info.name,u=document.getElementById("add-note-modal-title");u.textContent="تغییر نام کلاس",H.value=w,H.rows=1,ve(y=>{const b=y.trim();if(b&&b!==w){const L=ss(w,b);L.success?(Eo(w,b),A(b,`نام کلاس از «${w}» به «${b}» تغییر یافت.`,{type:"VIEW_SESSIONS"}),k(),ae(),C(`✅نام کلاس به «${b}» تغییر یافت.`)):C(L.message)}u.textContent="ثبت یادداشت جدید",H.rows=4}),Z("add-note-modal"),H.focus(),H.select()}},{label:"حذف کلاس",icon:"🗑️",className:"danger",action:()=>{z(`آیا از انتقال کلاس «${e.info.name}» به سطل زباله مطمئن هستید؟`,()=>{const w={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"classroom",description:`کلاس «${e.info.name}»`,restoreData:{name:e.info.name}};M.unshift(w),M.length>50&&M.pop(),e.isDeleted=!0,k(),ae(),C(`✅ کلاس «${e.info.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}];gt(r,p)}),t}function Gs(){const e=document.getElementById("class-management-stats");if(!e)return;const t=Object.values(S).filter(a=>!a.isDeleted),n=t.length,s=t.reduce((a,o)=>a+q(o.students).length,0);e.innerHTML=`
        <span>کل کلاس‌ها: <strong>${n}</strong></span>
        <span>|</span>
        <span>کل دانش‌آموزان: <strong>${s}</strong></span>
    `}function ae(){Gs(),Ge.innerHTML="",Object.values(S).sort((t,n)=>new Date(t.info.creationDate)-new Date(n.info.creationDate)).forEach(t=>{if(t.isDeleted)return;const n=Ta(t);Ge.appendChild(n)})}function ke(){tn.innerHTML="",d&&q(d.students).forEach(e=>{const t=document.createElement("li"),n=document.createElement("span");n.textContent=e.identity.name,n.style.flexGrow="1",n.className="student-name-link",n.addEventListener("click",()=>{ne(e)}),t.appendChild(n),t.addEventListener("contextmenu",s=>{gt(s,[{label:"تغییر نام",icon:"✏️",action:()=>{On(e,d)}},{label:"انتقال دانش‌آموز",icon:"➡️",action:()=>{As(e,d)}},{label:"حذف دانش‌آموز",icon:"🗑️",className:"danger",action:()=>{z(`آیا از انتقال دانش‌آموز «${e.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const o={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${e.identity.name}» از کلاس «${d.info.name}»`,restoreData:{studentId:e.identity.studentId,classId:d.info.scheduleCode}};M.unshift(o),M.length>50&&M.pop(),e.isDeleted=!0,A(d.info.name,`دانش‌آموز «${e.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),k(),ke(),C(`✅ دانش‌آموز «${e.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}])}),tn.appendChild(t)})}function Ke(){if(nn.innerHTML="",!d)return;d.categories.filter(t=>!t.isDeleted).forEach(t=>{const n=document.createElement("li"),s=document.createElement("div");s.className="name-and-badge-container";const a=document.createElement("span");if(a.textContent=t.name,s.appendChild(a),t.isGradedCategory){const i=document.createElement("span");i.className="category-badge",i.textContent="قابل نمره‌دهی",s.appendChild(i)}const o=document.createElement("button");o.className="btn-icon",o.innerHTML="🗑️",o.style.color="var(--color-warning)",o.addEventListener("click",()=>{z(`آیا از انتقال دسته‌بندی «${t.name}» به سطل زباله مطمئن هستید؟`,()=>{const i={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${t.name}» از کلاس «${d.info.name}»`,restoreData:{categoryId:t.id,classId:d.info.scheduleCode}};M.unshift(i),M.length>50&&M.pop(),t.isDeleted=!0,A(d.info.name,`دسته‌بندی «${t.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),k(),Ke(),C(`✅ دسته‌بندی «${t.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}),n.appendChild(s),n.appendChild(o),nn.appendChild(n)})}function lt(e){document.querySelectorAll(".page").forEach(n=>{n.classList.remove("active")});const t=document.getElementById(e);t&&t.classList.add("active"),e==="class-management-page"?(X(null),ie(null),de(null),ae(),an.style.display="flex"):an.style.display="none",Ps()}function T(e){const t={pageId:e,currentClassName:d?d.info.name:null,selectedSessionNumber:v?v.sessionNumber:null,selectedStudentId:D?D.identity.studentId:null};let n=`#${e}`;const s=new URLSearchParams;d&&s.set("class",d.info.name),v&&s.set("session",v.sessionNumber),D&&s.set("student",D.identity.studentId);const a=s.toString();a&&(n+=`?${a}`),window.location.hash!==n&&history.pushState(t,"",n),lt(e)}function Da(e,t){const n=document.createElement("div");n.className="list-item-buttons";const s=document.createElement("button");if(s.className="btn-icon",s.innerHTML="📝",s.title="افزودن/ویرایش یادداشت جلسه",s.style.borderBottom="solid",e.note||(s.style.opacity="0.5",s.style.borderBottom="none"),s.addEventListener("click",a=>{a.stopPropagation(),H.value=e.note||"",ve(o=>{e.note=o,k(),A(d.info.name,`یادداشت جلسه ${t} ذخیره شد.`,{type:"VIEW_SESSIONS"}),te(),C("✅یادداشت جلسه ذخیره شد.")}),Z("add-note-modal"),H.focus()}),n.appendChild(s),!e.isFinished&&!e.isCancelled){const a=document.createElement("button");a.className="btn-icon",a.innerHTML="✅",a.title="خاتمه جلسه",a.addEventListener("click",o=>{o.stopPropagation(),z(`جلسه شماره ${t} خاتمه پیدا خواهد کرد!`,()=>{d.endSpecificSession(e.sessionNumber),k(),A(d.info.name,`جلسه ${t} خاتمه یافت.`,{type:"VIEW_SESSIONS"}),te(),z("جلسه با موفقیت خاتمه یافت. آیا مایل به ایجاد فایل پشتیبان هستید؟",()=>{if(Ce){C("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است.");return}ft(),C("✅فایل پشتیبان با موفقیت ایجاد شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}),n.appendChild(a)}return n}function Ma(e,t){const n=document.createElement("div");n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="flex-start",n.style.flexGrow="1";const s=new Date(e.startTime).toLocaleDateString("fa-IR"),a=document.createElement("span"),o=document.createElement("div");o.style.display="flex",o.style.gap="5px",o.style.marginTop="5px";const i=new Date(e.startTime).toLocaleDateString("fa-IR",{weekday:"long"}),r=document.createElement("span");if(r.className="type-badge day-badge",r.textContent=i,o.appendChild(r),e.isCancelled){a.textContent=`✅جلسه لغو شده - تاریخ: ${s}`,n.style.cursor="default";const c=document.createElement("span");c.className="type-badge cancelled-badge",c.textContent="لغو شده",o.appendChild(c)}else a.textContent=`جلسه ${t} - تاریخ: ${s}`,n.style.cursor="pointer",n.addEventListener("click",()=>{ie(e),Mn()});if(n.appendChild(a),e.isFinished){const c=document.createElement("span");c.className="type-badge",c.textContent="خاتمه یافته",c.style.backgroundColor="var(--color-secondary)",o.appendChild(c)}if(e.isMakeup){const c=document.createElement("span");c.className="type-badge",c.textContent="جبرانی",c.style.backgroundColor="var(--color-warning)",c.style.color="var(--color-text-dark)",o.appendChild(c)}return n.appendChild(o),n}function $a(e,t){const n=document.createElement("li"),s=t.get(e.sessionNumber),a=Ma(e,s);n.appendChild(a);const o=Da(e,s);return n.appendChild(o),n.addEventListener("contextmenu",i=>{const r=[{label:e.isCancelled?"بازگردانی جلسه":"لغو جلسه",icon:"❌",action:()=>{const c=e.isCancelled?"بازگردانی جلسه":"لغو جلسه",f=e.isCancelled?"آیا از بازگردانی این جلسه مطمئن هستید؟":"آیا از لغو این جلسه مطمئن هستید؟ جلسه لغو شده در آمار تاثیری ندارد اما قابل بازگردانی است.";z(f,()=>{e.isCancelled=!e.isCancelled;const p=e.isCancelled?`جلسه ${s} لغو شد.`:`جلسه لغو شده (تاریخ: ${new Date(e.startTime).toLocaleDateString("fa-IR")}) بازگردانی شد.`;A(d.info.name,p,{type:"VIEW_SESSIONS"}),k(),te(),C(e.isCancelled?"✅جلسه لغو شد.":"✅جلسه بازگردانی شد.")},{confirmText:c,confirmClass:"btn-warning"})}},{label:"تغییر وضعیت جبرانی",icon:"🔄",action:()=>{d.markAsMakeup(e.sessionNumber),k();const c=e.isMakeup?`جلسه ${s} به عنوان جبرانی علامت‌گذاری شد.`:`جلسه ${s} از حالت جبرانی خارج شد.`;A(d.info.name,c,{type:"VIEW_SESSIONS"}),te()}},{label:"حذف جلسه",icon:"🗑️",className:"danger",action:()=>{const c=e.isCancelled?"لغو شده":s;z(`آیا از انتقال جلسه ${c} به سطل زباله مطمئن هستید؟`,()=>{const f={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"session",description:`جلسه ${c} از کلاس «${d.info.name}»`,restoreData:{sessionNumber:e.sessionNumber,classId:d.info.scheduleCode}};M.unshift(f),M.length>50&&M.pop(),e.isDeleted=!0,A(d.info.name,`جلسه ${c} به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),k(),te(),C(`✅ جلسه ${c} به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}];gt(i,r)}),n}function te(){const e=document.getElementById("session-list");if(!d)return;if(e.innerHTML="",d.sessions.length===0){e.innerHTML="<li>هنوز جلسه‌ای شروع نشده است.</li>";return}const t=fe(d);[...q(d.sessions)].reverse().forEach(s=>{const a=$a(s,t);e.appendChild(a)})}function tt(e){if(xe.innerHTML="",e.length>0)e.forEach(t=>{const n=document.createElement("div");n.textContent=t.identity.name,n.addEventListener("click",()=>{ne(t),xe.style.display="none",rn.value=""}),xe.appendChild(n)}),xe.style.display="block";else if(rn.value.trim()!==""){const t=document.createElement("div");t.className="no-results",t.textContent="پیدا نشد",xe.appendChild(t),xe.style.display="block"}else xe.style.display="none"}function Bt(e){if(Ie.innerHTML="",e.length>0)e.forEach(t=>{const n=document.createElement("div");n.className="global-search-result";const s=document.createElement("span");s.className="student-name",s.textContent=t.student.identity.name;const a=document.createElement("span");a.className="class-name",a.textContent=`کلاس: ${t.classroom.info.name}`,n.addEventListener("click",()=>{X(t.classroom),ne(t.student),Ie.style.display="none",Lt.value=""}),a.addEventListener("click",o=>{o.stopPropagation(),X(t.classroom),ie(null),ut(t.classroom.liveSession),te(),T("session-page"),Ie.style.display="none",Lt.value=""}),n.appendChild(s),n.appendChild(a),Ie.appendChild(n)}),Ie.style.display="block";else if(Lt.value.trim()!==""){const t=document.createElement("div");t.className="no-results",t.textContent="پیدا نشد",Ie.appendChild(t),Ie.style.display="block"}else Ie.style.display="none"}function pt(){const e=document.getElementById("trashed-items-list");if(e.innerHTML="",M.length===0){e.innerHTML='<li style="text-align: center; padding: 20px;">سطل زباله خالی است.</li>';return}M.forEach((t,n)=>{const s=document.createElement("li"),a=document.createElement("span");a.textContent=t.description,a.style.flexGrow="1";const o=document.createElement("div");o.className="list-item-buttons";const i=document.createElement("button");i.className="btn-icon",i.innerHTML="🔄",i.title="بازیابی",i.addEventListener("click",()=>{var w;let c=!1,f=null;const p=t.restoreData;switch(t.type){case"classroom":{const u=S[p.name];u&&!u.isDeleted?f=`کلاسی با نام «${p.name}» از قبل فعال است.`:u&&u.isDeleted&&(u.isDeleted=!1,c=!0);break}case"student":{const u=Object.values(S).find(b=>b.info.scheduleCode===p.classId),y=u==null?void 0:u.students.find(b=>b.identity.studentId===p.studentId);y&&(y.isDeleted=!1,c=!0);break}case"session":{const u=Object.values(S).find(b=>b.info.scheduleCode===p.classId),y=u==null?void 0:u.sessions.find(b=>b.sessionNumber===p.sessionNumber);y&&(y.isDeleted=!1,c=!0);break}case"category":{const u=Object.values(S).find(b=>b.info.scheduleCode===p.classId),y=u==null?void 0:u.categories.find(b=>b.id===p.categoryId);y&&(y.isDeleted=!1,c=!0);break}case"score":{const u=Object.values(S).find(L=>L.info.scheduleCode===p.classId),y=u==null?void 0:u.students.find(L=>L.identity.studentId===p.studentId),b=(w=y==null?void 0:y.logs.scores[p.skill.toLowerCase()])==null?void 0:w.find(L=>L.id===p.scoreId);b&&(b.isDeleted=!1,c=!0);break}case"note":{const u=Object.values(S).find(L=>L.info.scheduleCode===p.classId),y=u==null?void 0:u.students.find(L=>L.identity.studentId===p.studentId),b=y==null?void 0:y.profile.notes.find(L=>L.id===p.noteId);b&&(b.isDeleted=!1,c=!0);break}}c?(M.splice(n,1),k(),pt(),t.type==="classroom"&&ae(),C("✅ آیتم با موفقیت بازیابی شد.")):C(f?`⚠️ ${f}`:"⚠️ آیتم اصلی برای بازیابی یافت نشد.")});const r=document.createElement("button");r.className="btn-icon",r.innerHTML="🔥",r.title="حذف دائمی",r.addEventListener("click",()=>{z("آیا از حذف دائمی این آیتم مطمئن هستید؟ این عمل غیرقابل بازgشت است.",()=>{const c=t.restoreData,f=w=>Object.values(S).find(u=>u.info.scheduleCode===w);let p;switch(t.type){case"classroom":delete S[c.name];break;case"student":p=f(c.classId),dt({identity:{studentId:c.studentId}},p);break;case"session":p=f(c.classId),p&&cs(p.info.name,c.sessionNumber);break;case"category":p=f(c.classId),p&&ls(p.info.name,c.categoryId);break;case"score":p=f(c.classId),p&&rs(p.info.name,c.studentId,c.skill,c.scoreId);break;case"note":p=f(c.classId),p&&ds(p.info.name,c.studentId,c.noteId);break}M.splice(n,1),k(),pt(),C("✅ آیتم برای همیشه حذف شد.")},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),o.appendChild(i),o.appendChild(r),s.appendChild(a),s.appendChild(o),e.appendChild(s)})}function Oa(){const e=document.getElementById("absentees-summary-container");e&&(e.innerHTML=`
        <div id="absentees-summary-box" class="absentees-summary">
            <div class="absentees-summary-header">
                <h4>لیست غایبین جلسه شماره <span id="absentee-summary-session-number"></span></h4>
                <button id="copy-absentees-btn" class="btn-icon" title="کپی لیست غایبین">📋</button>
            </div>
            <div id="absentees-summary-list" class="summary-list"></div>
        </div>
    `)}function js(){const e=document.getElementById("absentees-summary-box"),t=document.getElementById("absentees-summary-list"),n=document.getElementById("absentee-summary-session-number");if(!e||!t||!n){console.error("Could not find all absentee summary elements.");return}if(!d||!v){e.classList.remove("visible");return}const s=q(d.students).filter(o=>{const i=v.studentRecords[o.identity.studentId];return i&&i.attendance==="absent"}),a=fe(d);n.textContent=a.get(v.sessionNumber),s.length>0?e.classList.add("visible"):e.classList.remove("visible"),t.innerHTML="",s.forEach(o=>{const r=(f=>d.sessions.reduce((p,w)=>{if(w.isDeleted||w.isCancelled)return p;const u=w.studentRecords[f.identity.studentId];return p+(u&&u.attendance==="absent"?1:0)},0))(o),c=document.createElement("span");c.className="summary-name",c.textContent=`${o.identity.name} (غیبت: ${r})`,c.addEventListener("click",()=>{c.classList.add("fading-out"),setTimeout(()=>{v.setAttendance(o.identity.studentId,"present"),k(),We()},200)}),t.appendChild(c)})}function Ha(){const e=document.getElementById("copy-absentees-btn");if(!e){console.error("Could not find the copy absentees button to attach listener.");return}e.addEventListener("click",()=>{if(!d||!v)return;const t=q(d.students).filter(a=>{const o=v.studentRecords[a.identity.studentId];return o&&o.attendance==="absent"});if(t.length===0){C("⚠️لیست غایبین خالی است.");return}const n=a=>d.sessions.reduce((o,i)=>{if(i.isDeleted||i.isCancelled)return o;const r=i.studentRecords[a.identity.studentId];return o+(r&&r.attendance==="absent"?1:0)},0);let s=`لیست غایبین جلسه شماره ${Sa()}:

`;t.forEach(a=>{const o=n(a);s+=`- ${a.identity.name} (تعداد غیبت‌ها: ${o})
`}),navigator.clipboard.writeText(s).then(()=>{C("✅لیست غایبین با موفقیت کپی شد.")}).catch(a=>{console.error("Failed to copy text: ",a),C("❌خطا در کپی کردن لیست.")})})}function xt(){const e=document.getElementById("demo-mode-banner");e&&(Ce?(e.classList.add("visible"),document.body.classList.add("demo-mode-active")):(e.classList.remove("visible"),document.body.classList.remove("demo-mode-active")))}const Ra=Object.freeze(Object.defineProperty({__proto__:null,_internalShowPage:lt,addCategoryBtn:Wo,addClassBtn:Io,addNoteModal:Yo,addScoreBtn:sa,addStudentBtn:No,appHeader:an,attendanceListUl:st,attendanceMassActionsContainer:wt,attendancePage:_o,attendanceSearchInput:Me,backToSessionsBtn:wo,backToStudentPageBtn:ea,backupDataBtn:jo,breadcrumbContainer:Ve,cancelImportBtn:Ro,cancelNoteBtn:Zo,categoryListUl:nn,categoryModal:fa,categoryModalCancelBtn:pa,categoryModalSaveBtn:Ds,categoryModalTitle:Ts,classListHeader:Fo,classListUl:Ge,classManagementPage:Is,classSaveNoteBtn:Xo,closeActiveModal:F,closeContextMenu:$e,closeNavBtn:Vo,columnMappingPage:Oo,columnSelectDropdown:on,confirmColumnBtn:Ho,confirmModalCancelBtn:ln,confirmModalConfirmBtn:et,confirmModalMessage:ks,contextMenu:He,csvCancelBtn:Do,csvConfirmBtn:To,csvFileInput:$o,csvPreviewList:sn,csvPreviewPage:xo,customConfirmModal:Jo,displayWinner:me,finishAttendanceBtn:Po,globalStudentSearchInput:Lt,globalStudentSearchResultsDiv:Ie,gradedCategoryPillsContainer:ta,hamburgerMenuBtn:qo,handleUndo:Os,importCsvBtn:Mo,initiateBackupProcess:ft,isGradedCheckbox:ia,massCommentAppendCheckbox:Dn,massCommentBtn:un,massCommentCancelBtn:ya,massCommentContent:ct,massCommentModal:ga,massCommentModalTitle:ha,massCommentSaveBtn:Ca,massCommentStudentCountMessage:Ms,newCategoryModalIsGradedCheckbox:Tn,newCategoryModalNameInput:it,newCategoryNameInput:Ao,newClassNameInput:bo,newNoteContent:H,newScoreCommentTextarea:xs,newScoreValueInput:na,newStudentNameInput:ko,openContextMenu:gt,openModal:Z,overlay:Go,pasteArea:Ls,processMassHomeworkComment:fn,processPasteBtn:Bo,profileScoresListUl:aa,profileStatsSummaryDiv:oa,quickGradeFormWrapper:ot,quickGradeSubmitBtn:Je,quickNoteTextarea:ye,quickScoreInput:Le,renderAttendancePage:We,renderBreadcrumbs:Ps,renderClassList:ae,renderClassManagementStats:Gs,renderColumnSelector:Vs,renderGlobalSearchResults:Bt,renderImportPreview:hn,renderLogModal:_s,renderMassCommentControls:Hn,renderScoresHistory:qs,renderSearchResults:tt,renderSessionDashboard:Mn,renderSessions:te,renderSettingsCategories:Ke,renderSettingsStudentList:ke,renderStudentNotes:Us,renderStudentStatsList:oe,renderTrashPage:pt,restoreDataBtn:zo,restoreFileInput:ws,secureConfirmCancelBtn:Qo,secureConfirmCode:Bs,secureConfirmConfirmBtn:St,secureConfirmInput:Ue,secureConfirmMessage:Ns,secureConfirmModal:Ko,selectStudentBtn:we,selectStudentBtnWrapper:ze,sessionDashboardPage:va,setAutoDirectionOnInput:Fs,settingsClassNameHeader:xn,settingsPage:Lo,settingsStudentListUl:tn,setupDashboardTabs:$s,showCategoryModal:mn,showClassNoteModal:Rn,showCustomConfirm:z,showMassCommentModal:Ws,showMoveStudentModal:As,showNotification:C,showPage:T,showRenameStudentModal:On,showRestoreConfirmModal:Hs,showSecureConfirm:Rs,showSettingsPage:An,showStudentProfile:ne,showUndoToast:Ea,sideNavMenu:Uo,studentSearchInput:rn,studentSearchResultsDiv:xe,studentStatsHeader:cn,switchDashboardTab:$n,trashedCategoriesList:da,trashedClassesList:ca,trashedNotesList:ua,trashedScoresList:ma,trashedSessionsList:ra,trashedStudentsList:la,triggerFileDownload:pn,undoBtn:So,undoMessage:Ss,undoToast:Ut,updateDemoModeBanner:xt},Symbol.toStringTag,{value:"Module"}));function Aa(){const e=window.location.hash;if(!e||e==="#")return!1;const[t,n]=e.split("?"),s=t.substring(1),a=new URLSearchParams(n),o=a.get("class"),i=parseInt(a.get("session"),10),r=a.get("student");if(o&&S[o])X(S[o]),i&&d.getSession(i)&&ie(d.getSession(i)),r&&d.students.find(c=>c.identity.studentId===r)&&de(d.students.find(c=>c.identity.studentId===r));else return!1;switch(s){case"session-page":te(),T("session-page");break;case"student-page":(void 0)();break;case"attendance-page":We(),T("attendance-page");break;case"settings-page":xn.textContent=`تنظیمات کلاس: ${d.info.name}`,ke(),Ke(),T("settings-page");break;case"student-profile-page":ne(D),T("session-page");break;default:return!1}return!0}document.addEventListener("DOMContentLoaded",()=>{const{globalStudentSearchInput:e,newClassNameInput:t,addClassBtn:n,undoBtn:s,backToSessionsBtn:a,newStudentNameInput:o,addStudentBtn:i,pasteArea:r,processPasteBtn:c,csvPreviewList:f,csvConfirmBtn:p,csvCancelBtn:w,importCsvBtn:u,csvFileInput:y,columnSelectDropdown:b,confirmColumnBtn:L,cancelImportBtn:N,newCategoryNameInput:_,addCategoryBtn:G,selectStudentBtn:j,attendancePage:P,finishAttendanceBtn:$,classListHeader:J,studentStatsHeader:ce,hamburgerMenuBtn:Ee,sideNavMenu:Q,closeNavBtn:pe,overlay:K,backupDataBtn:_e,restoreDataBtn:ht,restoreFileInput:Ne,confirmModalCancelBtn:Pe,confirmModalConfirmBtn:R,secureConfirmCancelBtn:V,secureConfirmConfirmBtn:se,newNoteContent:Fe,classSaveNoteBtn:jt,cancelNoteBtn:Qe,studentSearchInput:Be,studentSearchResultsDiv:Ye,isGradedCheckbox:_n,categoryModalSaveBtn:zs,categoryModalCancelBtn:Js,massCommentBtn:Ks,massCommentCancelBtn:Qs,massCommentSaveBtn:Ys,massCommentContent:Xs,massCommentAppendCheckbox:Zs,attendanceSearchInput:Pn}=Ra,eo=document.getElementById("trash-nav-btn");document.querySelector(".global-search-container .search-icon"),At(),xt(),Aa()||(ae(),T("class-management-page"));function Fn(l,g){const m=document.querySelector(l);if(!m)return;const h=m.querySelector(".search-icon"),E=m.querySelector(".animated-search-input");!h||!E||(h.addEventListener("mousedown",B=>{B.preventDefault()}),h.addEventListener("click",()=>{m.classList.contains("search-active")||(m.classList.add("search-active"),E.focus())}),E.addEventListener("blur",()=>{setTimeout(()=>{m.classList.remove("search-active"),E.value="",g&&g([])},150)}))}Pn.addEventListener("input",()=>{const l=Pn.value.toLowerCase().trim(),g=Yt(l);st.querySelectorAll(".attendance-list-item").forEach(h=>{const E=h.querySelector(".student-name");if(E){const B=E.textContent,I=be(B.toLowerCase()),x=I.includes(be(l)),O=I.includes(be(g));x||O?h.style.display="flex":h.style.display="none"}})}),Js.addEventListener("click",()=>{F(),Gt(null)}),zs.addEventListener("click",()=>{const l=it.value.trim(),g=Tn.checked;typeof Ht=="function"&&Ht(l,g)}),window.addEventListener("scroll",$e),document.addEventListener("click",l=>{He.classList.contains("visible")&&!He.contains(l.target)&&$e(),Be.contains(l.target)||(Ye.style.display="none");const g=l.target.closest(".log-action-link");if(g&&g.dataset.action)try{const m=JSON.parse(g.dataset.action);lo(m)}catch(m){console.error("Could not parse log action:",m)}}),ze.addEventListener("click",()=>{(ze.classList.contains("disabled-wrapper")||we.disabled)&&(we.classList.add("shake-animation"),setTimeout(()=>{we.classList.remove("shake-animation")},200))}),ce.addEventListener("click",()=>{const l=new Date().getTime();l-bn>500?It(1):It(Mt+1),hs(l),Mt===5&&(It(0),z("آیا از صفر کردن تمام شمارنده‌های دانش‌آموزان مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{is(),oe(),C("تمام آمارها صفر شدند ✅.")},{confirmText:"بله",confirmClass:"btn-warning"}))}),J.addEventListener("click",()=>{const l=new Date().getTime();l-En>500?bt(1):bt(Dt+1),gs(l),Dt===5&&(bt(0),z("آیا از ساخت یک کلاس تستی تصادفی مطمئن هستید؟",()=>{function g(){const m=`کلاس تستی ${Object.keys(S).length+1}`,h=new Zt({name:m,type:"online"});["علی رضایی","مریم حسینی","زهرا احمدی","رضا محمدی","فاطمه کریمی"].forEach(B=>h.addStudent(new vt({name:B}))),S[m]=h,k(),ae()}g(),C("کلاس تستی با موفقیت ساخته شد ✅!")},{confirmText:"بساز",confirmClass:"btn-success"}))}),V.addEventListener("click",()=>{F(),mt(null)}),se.addEventListener("click",()=>{typeof $t=="function"&&$t(),F(),mt(null)}),Pe.addEventListener("click",()=>{F(Sn)}),R.addEventListener("click",()=>{F(In)}),j.addEventListener("click",()=>{if(Le.value.trim()!==""||ye.value.trim()!==""){C("⚠️لطفاً ابتدا با دکمه «ثبت»، تغییرات را ذخیره کنید و یا نمره و یادداشت را پاک کنید.");return}if(!d||!v||!le)return;const l=d.selectNextWinner(le.name,v);if(l){const g=v.studentRecords[l.identity.studentId];if(g&&g.attendance==="absent"&&l.statusCounters.missedChances++,g&&g.hadIssue){l.statusCounters.missedChances++;const h=le.name;l.categoryIssues[h]=(l.categoryIssues[h]||0)+1}const m={winner:l,categoryName:le.name};v.winnerHistory.push(m),v.winnerHistory.length>10&&v.winnerHistory.shift(),Oe(v.winnerHistory.length-1),v.lastUsedCategoryId=le.id,v.lastSelectedWinnerId=l.identity.studentId,oe(),me(),k()}else C("❌دانش‌آموز واجد شرایطی برای انتخاب یافت نشد.")}),G.addEventListener("click",()=>{if(!d)return;const l=_.value.trim(),g=_n.checked;if(!l){alert("⚠️لطفاً نام دسته‌بندی را وارد کنید.");return}const m=d.categories.find(E=>E.name.toLowerCase()===l.toLowerCase());if(m)if(m.isDeleted){const E=d.categories.findIndex(B=>B===m);E>-1&&d.categories.splice(E,1)}else{alert("⚠️این دسته‌بندی از قبل وجود دارد.");return}const h=new Se(l,"",g);d.categories.push(h),k(),A(d.info.name,`دسته‌بندی جدید «${l}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),Ke(),_.value="",_n.checked=!1}),_.addEventListener("keyup",l=>{l.key==="Enter"&&G.click()}),L.addEventListener("click",()=>{if(!Tt){alert("❌خطایی رخ داده است. لطفاً فایل را دوباره انتخاب کنید."),T("settings-page");return}const l=parseInt(b.value,10),h=Tt.split(`
`).slice(1).map(E=>{var I;return(I=E.split(",")[l])==null?void 0:I.trim()}).filter(E=>E&&E.length>0);h.length>0?(Ze(h),hn(),T("csv-preview-page")):alert("هیچ نامی در ستون انتخاب شده پیدا نشد. لطفاً ستون دیگری را امتحان کنید یا فایل خود را بررسی کنید."),Et(null)}),u.addEventListener("click",()=>{y.click()}),y.addEventListener("change",l=>{const g=l.target.files[0];if(!g)return;const m=new FileReader;m.onload=h=>{const E=h.target.result;Et(E);const I=E.split(`
`)[0].split(",");Vs(I),T("column-mapping-page")},m.readAsText(g),l.target.value=null}),N.addEventListener("click",()=>{Et(null),T("settings-page")}),p.addEventListener("click",()=>{const l=f.querySelectorAll('input[type="checkbox"]:checked');let g=!1;l.forEach(m=>{const h=m.dataset.name,E=d.students.find(I=>I.identity.name.toLowerCase()===h.toLowerCase());if(E)if(E.isDeleted)dt(E,d);else{console.log(`دانش‌آموز «${h}» به دلیل تکراری بودن اضافه نشد.`);return}const B=new vt({name:h});d.addStudent(B),d.sessions.length>0&&(q(d.sessions).filter(I=>I.isFinished&&!I.isCancelled).forEach(I=>{I.setAttendance(B.identity.studentId,"absent")}),Gn(B,d),g=!0)}),k(),A(d.info.name,`${l.length} دانش‌آموز جدید از لیست ورودی به کلاس اضافه شدند.`,{type:"VIEW_SESSIONS"}),ke(),g&&jn(l.length),T("settings-page"),r.value="",Ze([])}),w.addEventListener("click",()=>{Ze([]),T("settings-page")}),c.addEventListener("click",()=>{const l=r.value.trim();if(!l){alert("کادر متنی خالی است. لطفاً اسامی را وارد کنید.");return}const g=l.split(`
`).map(m=>m.trim()).filter(m=>m.length>0);g.length>0?(Ze(g),hn(),T("csv-preview-page")):alert("هیچ نام معتبری برای ورود پیدا نشد.")}),o.addEventListener("keyup",l=>{l.key==="Enter"&&i.click()}),i.addEventListener("click",()=>{if(!d)return;const l=o.value.trim();if(!l){alert("لطفاً نام دانش‌آموز را وارد کنید.");return}const g=d.students.find(h=>h.identity.name.toLowerCase()===l.toLowerCase());if(g)if(g.isDeleted)dt(g,d);else{alert("❌دانش‌آموزی با این نام از قبل در این کلاس وجود دارد.");return}const m=new vt({name:l});d.addStudent(m),d.sessions.length>0&&(q(d.sessions).filter(h=>h.isFinished&&!h.isCancelled).forEach(h=>{h.setAttendance(m.identity.studentId,"absent")}),Gn(m,d),jn(1)),k(),A(d.info.name,`دانش‌آموز «${l}» به کلاس اضافه شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:m.identity.studentId}),ke(),oe(),o.value="",o.focus()}),a.addEventListener("click",()=>{te(),T("session-page")}),document.getElementById("new-session-btn").addEventListener("click",()=>{if(d){const l=d.sessions.find(m=>!m.isFinished&&!m.isCancelled&&!m.isDeleted);if(l){C(`⚠️ جلسه ${l.sessionNumber} هنوز تمام نشده است. لطفاً ابتدا با دکمه ✅ آن را خاتمه دهید.`);return}const g=()=>{const m=h=>{const E=d.startNewSession();ut(E),ie(E),d.students.forEach(x=>{yn.setAttendance(x.identity.studentId,"present")}),k();const I=fe(d).get(E.sessionNumber);A(d.info.name,`جلسه ${I} شروع شد.`,{type:"VIEW_SESSIONS"}),Mn(h?"attendance":"selector")};z("آیا تمایل به انجام فرآیند حضور و غیاب دارید؟",()=>m(!0),{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success",onCancel:()=>m(!1)})};d.hasSessionToday()?z("شما امروز یک جلسه برای این کلاس ثبت کرده‌اید. آیا از شروع یک جلسه جدید دیگر مطمئن هستید؟",g,{confirmText:"بله",confirmClass:"btn-warning"}):g()}}),n.addEventListener("click",()=>{const l=t.value.trim(),g=document.querySelector('input[name="class-type"]:checked');if(!l&&!g){C("⚠️لطفاً نام و نوع کلاس را مشخص کنید.");return}if(!l){C("⚠️لطفاً نام کلاس را وارد کنید.");return}if(!g){C("⚠️لطفاً نوع کلاس را انتخاب کنید.");return}if(S[l]){S[l].isDeleted?C("⚠️ کلاسی با این نام در سطل زباله است. ابتدا آن را بازیابی کنید و یا آن را پاک کنید."):C("⚠️کلاسی با این نام از قبل وجود دارد.");return}const m=g.value,h=new Zt({name:l,type:m});S[l]=h,k(),A(l,`کلاس «${l}» ایجاد شد.`,{type:"VIEW_SESSIONS"}),ae(),C(`✅ کلاس «${l}» با موفقیت ایجاد شد.`),t.value="",g.checked=!1}),e.addEventListener("input",l=>{const g=l.target.value;if(g.length<2){Bt([]);return}const m=g.toLowerCase(),h=Yt(m),E=[];for(const B in S){const I=S[B];if(I.isDeleted)continue;q(I.students).filter(O=>{const U=be(O.identity.name.toLowerCase()),ee=U.includes(be(m)),Xe=U.includes(be(h));return ee||Xe}).forEach(O=>{E.push({student:O,classroom:I})})}Bt(E)}),t.addEventListener("keyup",l=>{l.key==="Enter"&&n.click()}),s.addEventListener("click",Os),document.querySelectorAll(".back-to-classes-btn").forEach(l=>{l.addEventListener("click",()=>{X(null),ie(null),ut(null),T("class-management-page")})}),$.addEventListener("click",()=>{$n("selector")}),Be.addEventListener("input",l=>{const g=l.target.value;if(!g){tt([]);return}const m=g.toLowerCase(),h=Yt(m),B=q(d.students).filter(I=>{const x=be(I.identity.name.toLowerCase()),O=x.includes(be(m)),U=x.includes(be(h));return O||U});tt(B)}),Be.addEventListener("focus",()=>{Be.value&&tt(Be.value)}),Je.addEventListener("click",()=>{const l=Le.value,g=ye.value.trim();let m;if(Rt)m=Rt.student;else{const E=v==null?void 0:v.winnerHistory[he];m=E==null?void 0:E.winner}if(!m){C("❌خطا: دانش‌آموز معتبری برای ثبت نمره یافت نشد.");return}const h=le;if(!m||!h){C("⚠️لطفاً ابتدا یک دانش‌آموز و یک دسته‌بندی را انتخاب کنید.");return}if(!l){C("⚠️لطفاً مقدار نمره را وارد کنید.");return}if(l>100||l<0){C("❌نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}m&&(m.addScore(h.name,parseFloat(l),g),A(d.info.name,`نمره ${l} در ${h.name} برای «${m.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:m.identity.studentId}),k(),oe(),C(`✅نمره برای ${m.identity.name} در مهارت ${h.name} ثبت شد.`),Le.value="",ye.value="",me(m,h.name))});const qn=l=>{l.key==="Enter"&&l.ctrlKey&&(l.preventDefault(),Je.click())};Le.addEventListener("keydown",qn),ye.addEventListener("keydown",qn),Qe.addEventListener("click",()=>{F()}),jt.addEventListener("click",()=>{const l=Fe.value.trim();typeof Ot=="function"&&(Ot(l),We(),F())});const to=document.getElementById("move-student-confirm-btn"),no=document.getElementById("move-student-cancel-btn"),so=document.getElementById("move-student-class-select");no.addEventListener("click",()=>{F()}),to.addEventListener("click",()=>{const l=so.value,g=S[l],{studentToMove:m,sourceClassForMove:h}=yo;if(!m||!h||!g){C("خطایی رخ داد. لطفاً دوباره امتحان کنید⚠️.","error"),F();return}const E=as(m,h,g);E.success?(A(h.info.name,`دانش‌آموز «${m.identity.name}» به کلاس «${l}» منتقل شد.`,{type:"VIEW_SESSIONS"}),A(l,`دانش‌آموز «${m.identity.name}» از کلاس «${h.info.name}» به این کلاس منتقل شد.`,{type:"VIEW_SESSIONS"}),k(),ke(),C(`دانش‌آموز «${m.identity.name}» با موفقیت به کلاس «${l}» منتقل شد✅.`)):C(E.message,"error"),F()}),Ee.addEventListener("click",()=>{Q.style.width="300px",K.classList.add("modal-visible")}),pe.addEventListener("click",re),K.addEventListener("click",re),eo.addEventListener("click",()=>{pt(),T("trash-page"),re()}),document.getElementById("demo-mode-btn").addEventListener("click",()=>{Ce?Vn():(re(),z("شما در حال ورود به حالت نمایش (Demo) هستید. در این حالت، هیچ‌کدام از تغییرات شما ذخیره نخواهد شد. آیا ادامه می‌دهید؟",()=>{us(),xt(),re()},{confirmText:"تایید",confirmClass:"btn-warning",onCancel:re}))});const Un=document.getElementById("exit-demo-btn");Un&&Un.addEventListener("click",()=>{Ce&&Vn()}),_e.addEventListener("click",()=>{if(Ce){C("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است."),re();return}re(),ft()}),ht.addEventListener("click",()=>{if(Ce){C("⚠️ بازیابی اطلاعات در حالت نمایش (Demo) غیرفعال است."),re();return}Ne.click(),re()}),Ne.addEventListener("change",l=>{const g=l.target.files[0];if(!g)return;const m=new FileReader;m.onload=h=>{try{const E=JSON.parse(h.target.result);if(E.metadata&&E.data)Hs(E);else{const B=E.classrooms||E,I=E.trashBin||[];z("آیا از بازیابی اطلاعات مطمئن هستید؟ تمام داده‌های فعلی شما بازنویسی خواهد شد.",()=>{Ae(B),Ft(I),nt({lastRestoreTimestamp:new Date().toISOString()}),k(),ae(),T("class-management-page"),C("✅اطلاعات با موفقیت بازیابی شد.")},{confirmText:"بازیابی کن",confirmClass:"btn-warning"})}}catch(E){C("❌خطا در خواندن فایل. لطفاً فایل پشتیبان معتبر انتخاب کنید."),console.error("Restore error:",E)}},m.readAsText(g),l.target.value=null}),window.addEventListener("popstate",l=>{if(Te){F(null,!0);return}if($e(),l.state){const{pageId:g,currentClassName:m,selectedSessionNumber:h,selectedStudentId:E}=l.state;m&&(X(S[m]),h&&ie(d.getSession(h)),E&&de(d.students.find(B=>B.identity.studentId===E))),g==="session-page"?(te(),lt(g)):g==="student-profile-page"?(te(),T("session-page"),ne(D)):lt(g)}else X(null),ie(null),de(null),lt("class-management-page")}),document.addEventListener("keydown",l=>{var h;const g=document.activeElement;if(!["INPUT","TEXTAREA","SELECT"].includes(g.tagName)){if(l.key.toLowerCase()==="o"&&l.shiftKey&&Is.classList.contains("active")&&(l.preventDefault(),ws.click()),l.key==="Escape"){if(He.classList.contains("visible")){$e();return}if(Te){F();return}switch((h=document.querySelector(".page.active"))==null?void 0:h.id){case"csv-preview-page":case"column-mapping-page":T("settings-page");break;case"student-profile-page":de(null),T(v?"student-page":"session-page");break;case"attendance-page":T("student-page");break;case"student-page":ie(null),te(),T("session-page");break;case"settings-page":case"session-page":X(null),T("class-management-page");break}return}if(v){const E=l.key.toLowerCase();switch(" ascfg".includes(E)&&l.preventDefault(),E){case" ":j.click();break;case"a":P.classList.contains("active")?history.back():(We(),T("attendance-page"));break;case"s":document.getElementById("session-page").classList.contains("active")?history.back():a.click();break;case"c":document.querySelector(".back-to-classes-btn").click();break;case"f":const B=document.querySelector(".action-column .search-icon");B&&B.click();break;case"g":if(studentProfilePage.classList.contains("active"))history.back();else{const I=v.lastSelectedWinnerId;if(I){const x=d.students.find(O=>O.identity.studentId===I);x&&(de(x),(void 0)(),T("student-profile-page"))}else C("⚠️ابتدا یک نفر را انتخاب کنید تا پروفایل او نمایش داده شود.")}break;case"arrowleft":{const I=document.querySelector('button[title="برنده قبلی"]');I&&!I.disabled&&(l.preventDefault(),I.click());break}case"arrowright":{const I=document.querySelector('button[title="برنده بعدی"]');I&&!I.disabled&&(l.preventDefault(),I.click());break}}}}});function re(){Q.style.width="0",K.classList.add("modal-closing"),setTimeout(()=>{K.classList.remove("modal-visible","modal-closing")},300)}function Vn(){z("آیا از خروج از حالت نمایش (Demo) مطمئن هستید؟ با خروج، تمام تغییرات آزمایشی شما حذف شده و داده‌های اصلی شما بازیابی خواهند شد.",()=>{ms(),X(null),ie(null),de(null),ae(),T("class-management-page"),xt(),re()},{confirmText:"خروج",confirmClass:"btn-success"})}Fn(".global-search-container .animated-search-container",Bt),Fn(".action-column-header .animated-search-container",tt),[H,xs,ye,Ls].forEach(l=>{l&&Fs(l)});function Gn(l,g){const m=q(g.students).filter(W=>W.identity.studentId!==l.identity.studentId);if(m.length===0)return;const h=m.reduce((W,Y)=>Y.statusCounters.totalSelections>W.statusCounters.totalSelections?Y:W,m[0]);if(!h||h.statusCounters.totalSelections===0)return;l.categoryCounts=JSON.parse(JSON.stringify(h.categoryCounts)),l.statusCounters.totalSelections=h.statusCounters.totalSelections;const E=m.reduce((W,Y)=>W+Y.statusCounters.totalSelections,0),B=m.reduce((W,Y)=>W+(Y.statusCounters.missedChances||0),0),I=E>0?B/E:0;l.statusCounters.missedChances=Math.round(l.statusCounters.totalSelections*I);const x=q(g.categories),O={};x.forEach(W=>{const Y=m.reduce((Kt,Qt)=>Kt+(Qt.categoryCounts[W.name]||0),0),Jt=m.reduce((Kt,Qt)=>Kt+(Qt.categoryIssues[W.name]||0),0);O[W.name]=Y>0?Jt/Y:0}),x.forEach(W=>{const Y=l.categoryCounts[W.name]||0,Jt=O[W.name]||0;l.categoryIssues[W.name]=Math.round(Y*Jt)});const U=g.liveSession;U?l.onboardingSession=U.sessionNumber:l.onboardingSession=g.sessions.length+1;const ee=q(g.sessions).filter(W=>W.isFinished&&!W.isCancelled),Xe="📝 یادداشت خودکار سیستم",fo=`این دانش‌آموز  از جلسه شماره ${ee.length} به کلاس اضافه شد. آمار مشارکت او بر اساس فعال‌ترین دانش‌آموز و آمار «فرصت از دست رفته» او بر اساس میانگین کلاس ثبت گردید:`,qe=[];l.statusCounters.totalSelections>0&&qe.push(`کل انتخاب‌ها: ${l.statusCounters.totalSelections}`),l.statusCounters.missedChances>0&&qe.push(`فرصت‌های از دست رفته: ${l.statusCounters.missedChances}`);for(const W in l.categoryCounts){const Y=l.categoryCounts[W];Y>0&&qe.push(`انتخاب در «${W}»: ${Y}`)}for(const W in l.categoryIssues){const Y=l.categoryIssues[W];Y>0&&qe.push(`مشکل در «${W}»: ${Y}`)}if(qe.length>0){const W=`${Xe}
${fo}

- ${qe.join(`
- `)}`;l.addNote(W)}}function jn(l){const m=`چون این کلاس جلسات برگزار شده دارد، برای ${l>1?"دانش‌آموزان جدید":"دانش‌آموز جدید"} آمار پایه‌ای (متناسب با سایر دانش‌آموزان) ثبت شد تا در فرایند انتخاب اختلالی ایجاد نشود.`;z(m,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}const oo="9.0.0";document.getElementById("app-version").textContent=`نسخه ${oo}`;function ao(){console.log("Starting universal backfill for writing scores...");let l=0;for(const g in S){const m=S[g];if(m.isDeleted)continue;let h=0;q(m.students).forEach(B=>{const I=B.logs.scores;if(!(I&&I.writing&&I.writing.length>0)){let O=-1;for(const U in I)U!=="writing"&&I[U].forEach(ee=>{ee.value>O&&(O=ee.value)});if(O>-1){const U=`Automatically assigned based on the highest score (${O}) from other skills.`;B.addScore("Writing",O,U),h++}}}),h>0&&(console.log(`Updated ${h} student(s) in class: ${m.info.name}.`),l+=h)}l>0?(k(),console.log(`Update complete. A total of ${l} student(s) were updated across all classes. Data saved.`),document.getElementById("student-page").classList.contains("active")&&oe()):console.log("No students needed updating in any class.")}window.backfillWritingScoresForAll=ao;function io(){console.log("Starting backfill for 'outOfClassCount' and 'wasOutOfClass' properties...");let l=0,g=0;const m=localStorage.getItem("teacherAssistantData_v2");if(!m){console.log("No data found in localStorage. Nothing to do.");return}const h=JSON.parse(m);for(const E in h){const B=h[E];B.students&&B.students.forEach(I=>{I.statusCounters&&typeof I.statusCounters.outOfClassCount>"u"&&(I.statusCounters.outOfClassCount=0,l++)}),B.sessions&&B.sessions.forEach(I=>{if(I.studentRecords)for(const x in I.studentRecords){const O=I.studentRecords[x];typeof O.wasOutOfClass>"u"&&(O.wasOutOfClass=!1,g++)}})}localStorage.setItem("teacherAssistantData_v2",JSON.stringify(h)),console.log(`Backfill complete. Updated ${l} students and ${g} session records. Data saved.`),At(),d&&oe()}window.backfillExitCounters=io;function co(){console.log("🧹 Starting orphaned data cleanup...");let l=0;for(const g in S){const m=S[g];if(m.isDeleted)continue;let h=!1;const E=new Set(m.students.filter(x=>!x.isDeleted).map(x=>x.identity.studentId)),B=new Map(m.students.map(x=>[x.identity.studentId,x.identity.name])),I=[];m.sessions.forEach(x=>{if(x.isDeleted)return;const O=[];for(const U in x.studentRecords)if(!E.has(U)){const ee=B.get(U)||"Unknown/Deleted";O.push(`  - Removed student record for: ${ee} (ID: ${U})`),delete x.studentRecords[U],l++,h=!0}for(const U in x.lastWinnerByCategory){const ee=x.lastWinnerByCategory[U];if(!E.has(ee)){const Xe=B.get(ee)||"Unknown/Deleted";O.push(`  - Removed '${U}' last winner: ${Xe} (ID: ${ee})`),delete x.lastWinnerByCategory[U],l++,h=!0}}if(x.lastSelectedWinnerId&&!E.has(x.lastSelectedWinnerId)){const U=x.lastSelectedWinnerId,ee=B.get(U)||"Unknown/Deleted";O.push(`  - Cleared 'lastSelectedWinnerId': ${ee} (ID: ${U})`),x.lastSelectedWinnerId=null,l++,h=!0}if(O.length>0){const ee=fe(m).get(x.sessionNumber)||`(#${x.sessionNumber})`;I.push({sessionDisplayNumber:ee,logs:O})}}),h&&(console.group(`➡️ Class: ${g}`),I.forEach(x=>{console.groupCollapsed(`  Session ${x.sessionDisplayNumber}`),x.logs.forEach(O=>console.warn(O)),console.groupEnd()}),console.groupEnd())}l>0?(k(),console.log(`✅ Cleanup complete! Found and removed ${l} orphaned references. Data saved.`)):console.log("✅ No orphaned data found. Your data is clean!")}window.cleanupOrphanedData=co;function lo(l){if(!l||!l.classroomName)return;const g=S[l.classroomName];if(!g){C("⚠️ کلاس مربوط به این گزارش یافت نشد.");return}X(g),F(),setTimeout(()=>{switch(l.type){case"VIEW_STUDENT_PROFILE":{const m=g.students.find(h=>h.identity.studentId===l.studentId);m?ne(m):C("⚠️ دانش‌آموز مورد نظر یافت نشد.");break}case"VIEW_TRASH":pt(),T("trash-page");break;case"VIEW_SESSIONS":te(),T("session-page");break;case"VIEW_CLASS_NOTE":Rn(g);break;case"VIEW_CLASS_SETTINGS":An(g);break}},300)}Ks.addEventListener("click",()=>{Ws()}),Qs.addEventListener("click",()=>{F()}),Ys.addEventListener("click",()=>{const l=Xs.value.trim(),g=Zs.checked;if(!l){Dn.style.display==="flex"?z("کادر یادداشت خالی است. آیا مطمئنید که می‌خواهید یادداشت‌های قبلی دانش‌آموزان انتخاب‌شده را پاک کنید؟",()=>{F(),fn("",!1)},{confirmText:"پاک کردن",confirmClass:"btn-warning"}):C("⚠️ لطفاً متن یادداشت را وارد کنید.");return}F(()=>{fn(l,g)})});const De=document.getElementById("screen-saver-overlay"),zn=document.getElementById("screen-saver-toggle");let zt;const ro=2*60*1e3,Jn=["mousemove","keypress","scroll","click","touchstart"];function uo(){De.classList.add("visible")}function Kn(){De.classList.contains("visible")&&De.classList.remove("visible")}function yt(){Kn(),clearTimeout(zt),zt=setTimeout(uo,ro)}function Ct(l){l.preventDefault(),l.stopPropagation(),setTimeout(yt,0)}function Qn(){yt(),Jn.forEach(g=>window.addEventListener(g,yt)),De.addEventListener("click",Ct),De.addEventListener("touchstart",Ct);const l="9.0.0";{const g=document.getElementById("screen-saver-version");g&&(g.textContent=`v${l}`)}}function mo(){clearTimeout(zt),Kn(),Jn.forEach(l=>window.removeEventListener(l,yt)),De.removeEventListener("click",Ct),De.removeEventListener("touchstart",Ct)}zn.checked=ue.isScreenSaverEnabled,ue.isScreenSaverEnabled&&Qn(),zn.addEventListener("change",l=>{l.target.checked?(nt({isScreenSaverEnabled:!0}),Qn()):(re(),l.preventDefault(),z(`نکته:
محافظ صفحه در تلفن های همراه جدید کمک می کند که دستگاه باطری کمتری مصرف کند و به دلیل ثابت ماندن صفحه نمایش در گوشی های قدیمی تر، صفحه نمایش دچار ماندگی رد پیکسل نگردد. آیا مطمئن هستید که می خواهید این ویژگی را غیر فعال کنید؟`,()=>{l.target.checked=!1,nt({isScreenSaverEnabled:!1}),mo(),C("توصیه می شود زمان خاموش شدن صفحه نمایش گوشی خود را به حداقل دو دقیقه تغییر دهید تا در استفاده های طولانی مدت صفحه نمایش گوشی اصطحلاک کمتری را تجربه کند",7e3)},{confirmText:"بله، غیرفعال کن",cancelText:"لغو",onCancel:()=>{l.target.checked=!0}}))})});
