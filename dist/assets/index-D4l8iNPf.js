(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))c(r);new MutationObserver(r=>{for(const t of r)if(t.type==="childList")for(const a of t.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&c(a)}).observe(document,{childList:!0,subtree:!0});function e(r){const t={};return r.integrity&&(t.integrity=r.integrity),r.referrerPolicy&&(t.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?t.credentials="include":r.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function c(r){if(r.ep)return;r.ep=!0;const t=e(r);fetch(r.href,t)}})();class pn{constructor(o){this.identity={name:o.name,studentId:o.studentId||`id_${new Date().getTime()}_${Math.random()}`,branchName:o.branchName||null,ageGroup:o.ageGroup||"adult",level:o.level||null,contact:{social:o.socialContact||null,parent:o.parentContact||null}},this.isDeleted=!1,this.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0,outOfClassCount:0},this.categoryCounts={},this.categoryIssues={},this.logs={parentContacts:[],scores:{},discipline:{},sessionHistory:{}},this.profile={notes:[],tags:[]},this.finalClassActivityScore=null,this.onboardingSession=null}addScore(o,e,c){if(e>100||e<0){console.log("نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}const r=o.toLowerCase();this.logs.scores[r]||(this.logs.scores[r]=[]);const t=new Zi(o,e,c);this.logs.scores[r].push(t)}addNote(o,e=null){const c=new qi(o,e);this.profile.notes.push(c)}getOverallAverageScore(){let o=0,e=0;for(const r in this.logs.scores)this.logs.scores[r].forEach(t=>{t.isDeleted||(o+=t.value,e++)});if(e===0)return null;const c=o/e;return Math.round(c*100)/100}}class Zi{constructor(o,e,c=""){this.id=`score_${new Date().getTime()}`,this.skill=o,this.value=e,this.timestamp=new Date,this.comment=c,this.isDeleted=!1}}class qi{constructor(o,e=null){this.id=`note_${new Date().getTime()}`,this.timestamp=new Date,this.content=o,this.isDeleted=!1,this.source=e}}class Vn{constructor(o="complete",e=""){this.status=o,this.comment=e,this.timestamp=new Date}}class Ws{constructor(o){this.sessionNumber=o,this.startTime=new Date,this.note="",this.isDeleted=!1,this.endTime=null,this.isFinished=!1,this.isMakeup=!1,this.isCancelled=!1,this.studentRecords={},this.lastWinnerByCategory={},this.lastUsedCategoryId=null,this.lastSelectedWinnerId=null,this.winnerHistory=[]}end(){this.isFinished=!0,this.endTime=new Date}markAsMakeup(){this.isMakeup=!this.isMakeup}initializeStudentRecord(o){this.studentRecords[o]||(this.studentRecords[o]={attendance:"present",homework:new Vn,selections:{},hadIssue:!1,wasOutOfClass:!1})}setAttendance(o,e){this.initializeStudentRecord(o),this.studentRecords[o].attendance=e}setHomeworkStatus(o,e){this.initializeStudentRecord(o),this.studentRecords[o].homework.status=e}selectNextWinner(o,e,c){if(!e||e.length===0)return console.log("هیچ دانش‌آموزی در کلاس برای انتخاب وجود ندارد."),null;const r=this.lastWinnerByCategory[o];let t=e.filter(p=>p.identity.studentId!==r&&!p.isDeleted);if(t.length===0&&(t=e),t.length===0)return null;const a=(p,u)=>p.categoryCounts[u]||0,i=Math.min(...t.map(p=>a(p,o))),s=t.filter(p=>a(p,o)===i);let l;if(s.length===1)l=s[0];else if(s.length>1){const p=c.filter(v=>!v.isDeleted&&v.name!==o).map(v=>v.name),u=s.map(v=>{const y=p.reduce((C,E)=>C+a(v,E),0);return{student:v,otherCategoriesTotal:y}}),b=Math.min(...u.map(v=>v.otherCategoriesTotal)),f=u.filter(v=>v.otherCategoriesTotal===b).map(v=>v.student);f.length===1?l=f[0]:l=f[Math.floor(Math.random()*f.length)]}else l=t[Math.floor(Math.random()*t.length)];const h=l.identity.studentId;this.initializeStudentRecord(h);const g=(this.studentRecords[h].selections[o]||0)+1;return this.studentRecords[h].selections[o]=g,l.statusCounters.totalSelections++,l.categoryCounts[o]=(l.categoryCounts[o]||0)+1,this.lastWinnerByCategory[o]=h,l}}class Kn{constructor(o){this.info={name:o.name||"NotNamed",teacherName:o.teacherName||null,type:o.type||"in-person",term:o.term||null,scheduleText:o.scheduleText||null,level:o.level||null,creationDate:o.creationDate?new Date(o.creationDate):new Date,scheduleCode:o.scheduleCode||`code_${new Date().getTime()}`,scheduleDays:o.scheduleDays||[],scheduleStartTime:o.scheduleStartTime||null,scheduleEndTime:o.scheduleEndTime||null},this.students=[],this.sessions=[],this.note="",this.isDeleted=!1,this.categories=[new ut("Vocabulary","Questions about words and meanings."),new ut("Grammar","Questions about sentence structure and rules."),new ut("Listening",void 0,!0),new ut("Speaking",void 0,!0),new ut("Reading",void 0,!0),new ut("Writing",void 0,!0)],this.futurePlans={}}addStudent(o){this.students.push(o)}removeStudent(o){this.students=this.students.filter(e=>e.identity.studentId!==o)}startNewSession(){const o=this.sessions.length+1,e=new Ws(o);return this.sessions.push(e),e}endSpecificSession(o){const e=this.getSession(o);return e&&!e.isFinished?(e.end(),!0):!1}getSession(o){return this.sessions.find(e=>e.sessionNumber===o)}markAsMakeup(o){const e=this.getSession(o);e&&e.markAsMakeup()}planForSession(o,e){this.futurePlans[o]=e}hasSessionToday(){const o=new Date().toDateString();return this.sessions.some(e=>!e.isDeleted&&e.startTime.toDateString()===o)}selectNextWinner(o,e){return e?e.selectNextWinner(o,this.students,this.categories):null}get liveSession(){for(let o=this.sessions.length-1;o>=0;o--)if(!this.sessions[o].isFinished)return this.sessions[o];return null}endLiveSession(){const o=this.liveSession;return o?(o.end(),!0):!1}calculateFinalStudentScore(o){const e=o.logs.scores,c=["reading","writing"];for(const p of c)if(!e[p]||e[p].length===0)return null;const r=e.listening&&e.listening.length>0,t=e.speaking&&e.speaking.length>0;if(!r&&!t)return null;const a=p=>e[p].reduce((b,f)=>b+f.value,0)/e[p].length;let i;r&&t?i=(a("listening")+a("speaking"))/2:r?i=a("listening"):i=a("speaking");const s=a("reading"),l=a("writing"),g=(i*3+s*2+l*1)/6;return Math.trunc(g*10)/10}assignAllFinalScores(){let o=0,e=[];console.log("شروع عملیات محاسبه نمره نهایی برای تمام دانش‌آموزان..."),this.students.forEach(r=>{const t=this.calculateFinalStudentScore(r);t!==null?(r.finalClassActivityScore=t,o++):(r.finalClassActivityScore=null,e.push(r.identity.name))});const c=e.length;console.log(`عملیات پایان یافت. تعداد نمرات موفق: ${o} | تعداد ناموفق (نمرات ناقص): ${c}`),c>0&&(console.log("اسامی دانش‌آموزانی که نمراتشان ناقص است:"),e.forEach(r=>console.log(`- ${r}`)))}}class ut{constructor(o,e="",c=!1){this.id=`cat_${new Date().getTime()}_${Math.random()}`,this.name=o,this.description=e,this.isDeleted=!1,this.isGradedCategory=c,this.isDeleted=!1}}var mn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Us(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}function hn(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var js={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/(function(n,o){(function(e){n.exports=e()})(function(){return function e(c,r,t){function a(l,h){if(!r[l]){if(!c[l]){var g=typeof hn=="function"&&hn;if(!h&&g)return g(l,!0);if(i)return i(l,!0);var p=new Error("Cannot find module '"+l+"'");throw p.code="MODULE_NOT_FOUND",p}var u=r[l]={exports:{}};c[l][0].call(u.exports,function(b){var f=c[l][1][b];return a(f||b)},u,u.exports,e,c,r,t)}return r[l].exports}for(var i=typeof hn=="function"&&hn,s=0;s<t.length;s++)a(t[s]);return a}({1:[function(e,c,r){var t=e("./utils"),a=e("./support"),i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";r.encode=function(s){for(var l,h,g,p,u,b,f,v=[],y=0,C=s.length,E=C,S=t.getTypeOf(s)!=="string";y<s.length;)E=C-y,g=S?(l=s[y++],h=y<C?s[y++]:0,y<C?s[y++]:0):(l=s.charCodeAt(y++),h=y<C?s.charCodeAt(y++):0,y<C?s.charCodeAt(y++):0),p=l>>2,u=(3&l)<<4|h>>4,b=1<E?(15&h)<<2|g>>6:64,f=2<E?63&g:64,v.push(i.charAt(p)+i.charAt(u)+i.charAt(b)+i.charAt(f));return v.join("")},r.decode=function(s){var l,h,g,p,u,b,f=0,v=0,y="data:";if(s.substr(0,y.length)===y)throw new Error("Invalid base64 input, it looks like a data url.");var C,E=3*(s=s.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(s.charAt(s.length-1)===i.charAt(64)&&E--,s.charAt(s.length-2)===i.charAt(64)&&E--,E%1!=0)throw new Error("Invalid base64 input, bad content length.");for(C=a.uint8array?new Uint8Array(0|E):new Array(0|E);f<s.length;)l=i.indexOf(s.charAt(f++))<<2|(p=i.indexOf(s.charAt(f++)))>>4,h=(15&p)<<4|(u=i.indexOf(s.charAt(f++)))>>2,g=(3&u)<<6|(b=i.indexOf(s.charAt(f++))),C[v++]=l,u!==64&&(C[v++]=h),b!==64&&(C[v++]=g);return C}},{"./support":30,"./utils":32}],2:[function(e,c,r){var t=e("./external"),a=e("./stream/DataWorker"),i=e("./stream/Crc32Probe"),s=e("./stream/DataLengthProbe");function l(h,g,p,u,b){this.compressedSize=h,this.uncompressedSize=g,this.crc32=p,this.compression=u,this.compressedContent=b}l.prototype={getContentWorker:function(){var h=new a(t.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new s("data_length")),g=this;return h.on("end",function(){if(this.streamInfo.data_length!==g.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),h},getCompressedWorker:function(){return new a(t.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},l.createWorkerFrom=function(h,g,p){return h.pipe(new i).pipe(new s("uncompressedSize")).pipe(g.compressWorker(p)).pipe(new s("compressedSize")).withStreamInfo("compression",g)},c.exports=l},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,c,r){var t=e("./stream/GenericWorker");r.STORE={magic:"\0\0",compressWorker:function(){return new t("STORE compression")},uncompressWorker:function(){return new t("STORE decompression")}},r.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,c,r){var t=e("./utils"),a=function(){for(var i,s=[],l=0;l<256;l++){i=l;for(var h=0;h<8;h++)i=1&i?3988292384^i>>>1:i>>>1;s[l]=i}return s}();c.exports=function(i,s){return i!==void 0&&i.length?t.getTypeOf(i)!=="string"?function(l,h,g,p){var u=a,b=p+g;l^=-1;for(var f=p;f<b;f++)l=l>>>8^u[255&(l^h[f])];return-1^l}(0|s,i,i.length,0):function(l,h,g,p){var u=a,b=p+g;l^=-1;for(var f=p;f<b;f++)l=l>>>8^u[255&(l^h.charCodeAt(f))];return-1^l}(0|s,i,i.length,0):0}},{"./utils":32}],5:[function(e,c,r){r.base64=!1,r.binary=!1,r.dir=!1,r.createFolders=!0,r.date=null,r.compression=null,r.compressionOptions=null,r.comment=null,r.unixPermissions=null,r.dosPermissions=null},{}],6:[function(e,c,r){var t=null;t=typeof Promise<"u"?Promise:e("lie"),c.exports={Promise:t}},{lie:37}],7:[function(e,c,r){var t=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",a=e("pako"),i=e("./utils"),s=e("./stream/GenericWorker"),l=t?"uint8array":"array";function h(g,p){s.call(this,"FlateWorker/"+g),this._pako=null,this._pakoAction=g,this._pakoOptions=p,this.meta={}}r.magic="\b\0",i.inherits(h,s),h.prototype.processChunk=function(g){this.meta=g.meta,this._pako===null&&this._createPako(),this._pako.push(i.transformTo(l,g.data),!1)},h.prototype.flush=function(){s.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},h.prototype.cleanUp=function(){s.prototype.cleanUp.call(this),this._pako=null},h.prototype._createPako=function(){this._pako=new a[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var g=this;this._pako.onData=function(p){g.push({data:p,meta:g.meta})}},r.compressWorker=function(g){return new h("Deflate",g)},r.uncompressWorker=function(){return new h("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(e,c,r){function t(u,b){var f,v="";for(f=0;f<b;f++)v+=String.fromCharCode(255&u),u>>>=8;return v}function a(u,b,f,v,y,C){var E,S,I=u.file,x=u.compression,L=C!==l.utf8encode,N=i.transformTo("string",C(I.name)),R=i.transformTo("string",l.utf8encode(I.name)),P=I.comment,Q=i.transformTo("string",C(P)),k=i.transformTo("string",l.utf8encode(P)),z=R.length!==I.name.length,m=k.length!==P.length,H="",ue="",Z="",fe=I.dir,F=I.date,ne={crc32:0,compressedSize:0,uncompressedSize:0};b&&!f||(ne.crc32=u.crc32,ne.compressedSize=u.compressedSize,ne.uncompressedSize=u.uncompressedSize);var A=0;b&&(A|=8),L||!z&&!m||(A|=2048);var M=0,re=0;fe&&(M|=16),y==="UNIX"?(re=798,M|=function(Y,Be){var Ne=Y;return Y||(Ne=Be?16893:33204),(65535&Ne)<<16}(I.unixPermissions,fe)):(re=20,M|=function(Y){return 63&(Y||0)}(I.dosPermissions)),E=F.getUTCHours(),E<<=6,E|=F.getUTCMinutes(),E<<=5,E|=F.getUTCSeconds()/2,S=F.getUTCFullYear()-1980,S<<=4,S|=F.getUTCMonth()+1,S<<=5,S|=F.getUTCDate(),z&&(ue=t(1,1)+t(h(N),4)+R,H+="up"+t(ue.length,2)+ue),m&&(Z=t(1,1)+t(h(Q),4)+k,H+="uc"+t(Z.length,2)+Z);var te="";return te+=`
\0`,te+=t(A,2),te+=x.magic,te+=t(E,2),te+=t(S,2),te+=t(ne.crc32,4),te+=t(ne.compressedSize,4),te+=t(ne.uncompressedSize,4),te+=t(N.length,2),te+=t(H.length,2),{fileRecord:g.LOCAL_FILE_HEADER+te+N+H,dirRecord:g.CENTRAL_FILE_HEADER+t(re,2)+te+t(Q.length,2)+"\0\0\0\0"+t(M,4)+t(v,4)+N+H+Q}}var i=e("../utils"),s=e("../stream/GenericWorker"),l=e("../utf8"),h=e("../crc32"),g=e("../signature");function p(u,b,f,v){s.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=b,this.zipPlatform=f,this.encodeFileName=v,this.streamFiles=u,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}i.inherits(p,s),p.prototype.push=function(u){var b=u.meta.percent||0,f=this.entriesCount,v=this._sources.length;this.accumulate?this.contentBuffer.push(u):(this.bytesWritten+=u.data.length,s.prototype.push.call(this,{data:u.data,meta:{currentFile:this.currentFile,percent:f?(b+100*(f-v-1))/f:100}}))},p.prototype.openedSource=function(u){this.currentSourceOffset=this.bytesWritten,this.currentFile=u.file.name;var b=this.streamFiles&&!u.file.dir;if(b){var f=a(u,b,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:f.fileRecord,meta:{percent:0}})}else this.accumulate=!0},p.prototype.closedSource=function(u){this.accumulate=!1;var b=this.streamFiles&&!u.file.dir,f=a(u,b,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(f.dirRecord),b)this.push({data:function(v){return g.DATA_DESCRIPTOR+t(v.crc32,4)+t(v.compressedSize,4)+t(v.uncompressedSize,4)}(u),meta:{percent:100}});else for(this.push({data:f.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},p.prototype.flush=function(){for(var u=this.bytesWritten,b=0;b<this.dirRecords.length;b++)this.push({data:this.dirRecords[b],meta:{percent:100}});var f=this.bytesWritten-u,v=function(y,C,E,S,I){var x=i.transformTo("string",I(S));return g.CENTRAL_DIRECTORY_END+"\0\0\0\0"+t(y,2)+t(y,2)+t(C,4)+t(E,4)+t(x.length,2)+x}(this.dirRecords.length,f,u,this.zipComment,this.encodeFileName);this.push({data:v,meta:{percent:100}})},p.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},p.prototype.registerPrevious=function(u){this._sources.push(u);var b=this;return u.on("data",function(f){b.processChunk(f)}),u.on("end",function(){b.closedSource(b.previous.streamInfo),b._sources.length?b.prepareNextSource():b.end()}),u.on("error",function(f){b.error(f)}),this},p.prototype.resume=function(){return!!s.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},p.prototype.error=function(u){var b=this._sources;if(!s.prototype.error.call(this,u))return!1;for(var f=0;f<b.length;f++)try{b[f].error(u)}catch{}return!0},p.prototype.lock=function(){s.prototype.lock.call(this);for(var u=this._sources,b=0;b<u.length;b++)u[b].lock()},c.exports=p},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,c,r){var t=e("../compressions"),a=e("./ZipFileWorker");r.generateWorker=function(i,s,l){var h=new a(s.streamFiles,l,s.platform,s.encodeFileName),g=0;try{i.forEach(function(p,u){g++;var b=function(C,E){var S=C||E,I=t[S];if(!I)throw new Error(S+" is not a valid compression method !");return I}(u.options.compression,s.compression),f=u.options.compressionOptions||s.compressionOptions||{},v=u.dir,y=u.date;u._compressWorker(b,f).withStreamInfo("file",{name:p,dir:v,date:y,comment:u.comment||"",unixPermissions:u.unixPermissions,dosPermissions:u.dosPermissions}).pipe(h)}),h.entriesCount=g}catch(p){h.error(p)}return h}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,c,r){function t(){if(!(this instanceof t))return new t;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var a=new t;for(var i in this)typeof this[i]!="function"&&(a[i]=this[i]);return a}}(t.prototype=e("./object")).loadAsync=e("./load"),t.support=e("./support"),t.defaults=e("./defaults"),t.version="3.10.1",t.loadAsync=function(a,i){return new t().loadAsync(a,i)},t.external=e("./external"),c.exports=t},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,c,r){var t=e("./utils"),a=e("./external"),i=e("./utf8"),s=e("./zipEntries"),l=e("./stream/Crc32Probe"),h=e("./nodejsUtils");function g(p){return new a.Promise(function(u,b){var f=p.decompressed.getContentWorker().pipe(new l);f.on("error",function(v){b(v)}).on("end",function(){f.streamInfo.crc32!==p.decompressed.crc32?b(new Error("Corrupted zip : CRC32 mismatch")):u()}).resume()})}c.exports=function(p,u){var b=this;return u=t.extend(u||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:i.utf8decode}),h.isNode&&h.isStream(p)?a.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):t.prepareContent("the loaded zip file",p,!0,u.optimizedBinaryString,u.base64).then(function(f){var v=new s(u);return v.load(f),v}).then(function(f){var v=[a.Promise.resolve(f)],y=f.files;if(u.checkCRC32)for(var C=0;C<y.length;C++)v.push(g(y[C]));return a.Promise.all(v)}).then(function(f){for(var v=f.shift(),y=v.files,C=0;C<y.length;C++){var E=y[C],S=E.fileNameStr,I=t.resolve(E.fileNameStr);b.file(I,E.decompressed,{binary:!0,optimizedBinaryString:!0,date:E.date,dir:E.dir,comment:E.fileCommentStr.length?E.fileCommentStr:null,unixPermissions:E.unixPermissions,dosPermissions:E.dosPermissions,createFolders:u.createFolders}),E.dir||(b.file(I).unsafeOriginalName=S)}return v.zipComment.length&&(b.comment=v.zipComment),b})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,c,r){var t=e("../utils"),a=e("../stream/GenericWorker");function i(s,l){a.call(this,"Nodejs stream input adapter for "+s),this._upstreamEnded=!1,this._bindStream(l)}t.inherits(i,a),i.prototype._bindStream=function(s){var l=this;(this._stream=s).pause(),s.on("data",function(h){l.push({data:h,meta:{percent:0}})}).on("error",function(h){l.isPaused?this.generatedError=h:l.error(h)}).on("end",function(){l.isPaused?l._upstreamEnded=!0:l.end()})},i.prototype.pause=function(){return!!a.prototype.pause.call(this)&&(this._stream.pause(),!0)},i.prototype.resume=function(){return!!a.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},c.exports=i},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,c,r){var t=e("readable-stream").Readable;function a(i,s,l){t.call(this,s),this._helper=i;var h=this;i.on("data",function(g,p){h.push(g)||h._helper.pause(),l&&l(p)}).on("error",function(g){h.emit("error",g)}).on("end",function(){h.push(null)})}e("../utils").inherits(a,t),a.prototype._read=function(){this._helper.resume()},c.exports=a},{"../utils":32,"readable-stream":16}],14:[function(e,c,r){c.exports={isNode:typeof Buffer<"u",newBufferFrom:function(t,a){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(t,a);if(typeof t=="number")throw new Error('The "data" argument must not be a number');return new Buffer(t,a)},allocBuffer:function(t){if(Buffer.alloc)return Buffer.alloc(t);var a=new Buffer(t);return a.fill(0),a},isBuffer:function(t){return Buffer.isBuffer(t)},isStream:function(t){return t&&typeof t.on=="function"&&typeof t.pause=="function"&&typeof t.resume=="function"}}},{}],15:[function(e,c,r){function t(I,x,L){var N,R=i.getTypeOf(x),P=i.extend(L||{},h);P.date=P.date||new Date,P.compression!==null&&(P.compression=P.compression.toUpperCase()),typeof P.unixPermissions=="string"&&(P.unixPermissions=parseInt(P.unixPermissions,8)),P.unixPermissions&&16384&P.unixPermissions&&(P.dir=!0),P.dosPermissions&&16&P.dosPermissions&&(P.dir=!0),P.dir&&(I=y(I)),P.createFolders&&(N=v(I))&&C.call(this,N,!0);var Q=R==="string"&&P.binary===!1&&P.base64===!1;L&&L.binary!==void 0||(P.binary=!Q),(x instanceof g&&x.uncompressedSize===0||P.dir||!x||x.length===0)&&(P.base64=!1,P.binary=!0,x="",P.compression="STORE",R="string");var k=null;k=x instanceof g||x instanceof s?x:b.isNode&&b.isStream(x)?new f(I,x):i.prepareContent(I,x,P.binary,P.optimizedBinaryString,P.base64);var z=new p(I,k,P);this.files[I]=z}var a=e("./utf8"),i=e("./utils"),s=e("./stream/GenericWorker"),l=e("./stream/StreamHelper"),h=e("./defaults"),g=e("./compressedObject"),p=e("./zipObject"),u=e("./generate"),b=e("./nodejsUtils"),f=e("./nodejs/NodejsStreamInputAdapter"),v=function(I){I.slice(-1)==="/"&&(I=I.substring(0,I.length-1));var x=I.lastIndexOf("/");return 0<x?I.substring(0,x):""},y=function(I){return I.slice(-1)!=="/"&&(I+="/"),I},C=function(I,x){return x=x!==void 0?x:h.createFolders,I=y(I),this.files[I]||t.call(this,I,null,{dir:!0,createFolders:x}),this.files[I]};function E(I){return Object.prototype.toString.call(I)==="[object RegExp]"}var S={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(I){var x,L,N;for(x in this.files)N=this.files[x],(L=x.slice(this.root.length,x.length))&&x.slice(0,this.root.length)===this.root&&I(L,N)},filter:function(I){var x=[];return this.forEach(function(L,N){I(L,N)&&x.push(N)}),x},file:function(I,x,L){if(arguments.length!==1)return I=this.root+I,t.call(this,I,x,L),this;if(E(I)){var N=I;return this.filter(function(P,Q){return!Q.dir&&N.test(P)})}var R=this.files[this.root+I];return R&&!R.dir?R:null},folder:function(I){if(!I)return this;if(E(I))return this.filter(function(R,P){return P.dir&&I.test(R)});var x=this.root+I,L=C.call(this,x),N=this.clone();return N.root=L.name,N},remove:function(I){I=this.root+I;var x=this.files[I];if(x||(I.slice(-1)!=="/"&&(I+="/"),x=this.files[I]),x&&!x.dir)delete this.files[I];else for(var L=this.filter(function(R,P){return P.name.slice(0,I.length)===I}),N=0;N<L.length;N++)delete this.files[L[N].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(I){var x,L={};try{if((L=i.extend(I||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:a.utf8encode})).type=L.type.toLowerCase(),L.compression=L.compression.toUpperCase(),L.type==="binarystring"&&(L.type="string"),!L.type)throw new Error("No output type specified.");i.checkSupport(L.type),L.platform!=="darwin"&&L.platform!=="freebsd"&&L.platform!=="linux"&&L.platform!=="sunos"||(L.platform="UNIX"),L.platform==="win32"&&(L.platform="DOS");var N=L.comment||this.comment||"";x=u.generateWorker(this,L,N)}catch(R){(x=new s("error")).error(R)}return new l(x,L.type||"string",L.mimeType)},generateAsync:function(I,x){return this.generateInternalStream(I).accumulate(x)},generateNodeStream:function(I,x){return(I=I||{}).type||(I.type="nodebuffer"),this.generateInternalStream(I).toNodejsStream(x)}};c.exports=S},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,c,r){c.exports=e("stream")},{stream:void 0}],17:[function(e,c,r){var t=e("./DataReader");function a(i){t.call(this,i);for(var s=0;s<this.data.length;s++)i[s]=255&i[s]}e("../utils").inherits(a,t),a.prototype.byteAt=function(i){return this.data[this.zero+i]},a.prototype.lastIndexOfSignature=function(i){for(var s=i.charCodeAt(0),l=i.charCodeAt(1),h=i.charCodeAt(2),g=i.charCodeAt(3),p=this.length-4;0<=p;--p)if(this.data[p]===s&&this.data[p+1]===l&&this.data[p+2]===h&&this.data[p+3]===g)return p-this.zero;return-1},a.prototype.readAndCheckSignature=function(i){var s=i.charCodeAt(0),l=i.charCodeAt(1),h=i.charCodeAt(2),g=i.charCodeAt(3),p=this.readData(4);return s===p[0]&&l===p[1]&&h===p[2]&&g===p[3]},a.prototype.readData=function(i){if(this.checkOffset(i),i===0)return[];var s=this.data.slice(this.zero+this.index,this.zero+this.index+i);return this.index+=i,s},c.exports=a},{"../utils":32,"./DataReader":18}],18:[function(e,c,r){var t=e("../utils");function a(i){this.data=i,this.length=i.length,this.index=0,this.zero=0}a.prototype={checkOffset:function(i){this.checkIndex(this.index+i)},checkIndex:function(i){if(this.length<this.zero+i||i<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+i+"). Corrupted zip ?")},setIndex:function(i){this.checkIndex(i),this.index=i},skip:function(i){this.setIndex(this.index+i)},byteAt:function(){},readInt:function(i){var s,l=0;for(this.checkOffset(i),s=this.index+i-1;s>=this.index;s--)l=(l<<8)+this.byteAt(s);return this.index+=i,l},readString:function(i){return t.transformTo("string",this.readData(i))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var i=this.readInt(4);return new Date(Date.UTC(1980+(i>>25&127),(i>>21&15)-1,i>>16&31,i>>11&31,i>>5&63,(31&i)<<1))}},c.exports=a},{"../utils":32}],19:[function(e,c,r){var t=e("./Uint8ArrayReader");function a(i){t.call(this,i)}e("../utils").inherits(a,t),a.prototype.readData=function(i){this.checkOffset(i);var s=this.data.slice(this.zero+this.index,this.zero+this.index+i);return this.index+=i,s},c.exports=a},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,c,r){var t=e("./DataReader");function a(i){t.call(this,i)}e("../utils").inherits(a,t),a.prototype.byteAt=function(i){return this.data.charCodeAt(this.zero+i)},a.prototype.lastIndexOfSignature=function(i){return this.data.lastIndexOf(i)-this.zero},a.prototype.readAndCheckSignature=function(i){return i===this.readData(4)},a.prototype.readData=function(i){this.checkOffset(i);var s=this.data.slice(this.zero+this.index,this.zero+this.index+i);return this.index+=i,s},c.exports=a},{"../utils":32,"./DataReader":18}],21:[function(e,c,r){var t=e("./ArrayReader");function a(i){t.call(this,i)}e("../utils").inherits(a,t),a.prototype.readData=function(i){if(this.checkOffset(i),i===0)return new Uint8Array(0);var s=this.data.subarray(this.zero+this.index,this.zero+this.index+i);return this.index+=i,s},c.exports=a},{"../utils":32,"./ArrayReader":17}],22:[function(e,c,r){var t=e("../utils"),a=e("../support"),i=e("./ArrayReader"),s=e("./StringReader"),l=e("./NodeBufferReader"),h=e("./Uint8ArrayReader");c.exports=function(g){var p=t.getTypeOf(g);return t.checkSupport(p),p!=="string"||a.uint8array?p==="nodebuffer"?new l(g):a.uint8array?new h(t.transformTo("uint8array",g)):new i(t.transformTo("array",g)):new s(g)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,c,r){r.LOCAL_FILE_HEADER="PK",r.CENTRAL_FILE_HEADER="PK",r.CENTRAL_DIRECTORY_END="PK",r.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",r.ZIP64_CENTRAL_DIRECTORY_END="PK",r.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(e,c,r){var t=e("./GenericWorker"),a=e("../utils");function i(s){t.call(this,"ConvertWorker to "+s),this.destType=s}a.inherits(i,t),i.prototype.processChunk=function(s){this.push({data:a.transformTo(this.destType,s.data),meta:s.meta})},c.exports=i},{"../utils":32,"./GenericWorker":28}],25:[function(e,c,r){var t=e("./GenericWorker"),a=e("../crc32");function i(){t.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}e("../utils").inherits(i,t),i.prototype.processChunk=function(s){this.streamInfo.crc32=a(s.data,this.streamInfo.crc32||0),this.push(s)},c.exports=i},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,c,r){var t=e("../utils"),a=e("./GenericWorker");function i(s){a.call(this,"DataLengthProbe for "+s),this.propName=s,this.withStreamInfo(s,0)}t.inherits(i,a),i.prototype.processChunk=function(s){if(s){var l=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=l+s.data.length}a.prototype.processChunk.call(this,s)},c.exports=i},{"../utils":32,"./GenericWorker":28}],27:[function(e,c,r){var t=e("../utils"),a=e("./GenericWorker");function i(s){a.call(this,"DataWorker");var l=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,s.then(function(h){l.dataIsReady=!0,l.data=h,l.max=h&&h.length||0,l.type=t.getTypeOf(h),l.isPaused||l._tickAndRepeat()},function(h){l.error(h)})}t.inherits(i,a),i.prototype.cleanUp=function(){a.prototype.cleanUp.call(this),this.data=null},i.prototype.resume=function(){return!!a.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,t.delay(this._tickAndRepeat,[],this)),!0)},i.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(t.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},i.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var s=null,l=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":s=this.data.substring(this.index,l);break;case"uint8array":s=this.data.subarray(this.index,l);break;case"array":case"nodebuffer":s=this.data.slice(this.index,l)}return this.index=l,this.push({data:s,meta:{percent:this.max?this.index/this.max*100:0}})},c.exports=i},{"../utils":32,"./GenericWorker":28}],28:[function(e,c,r){function t(a){this.name=a||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}t.prototype={push:function(a){this.emit("data",a)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(a){this.emit("error",a)}return!0},error:function(a){return!this.isFinished&&(this.isPaused?this.generatedError=a:(this.isFinished=!0,this.emit("error",a),this.previous&&this.previous.error(a),this.cleanUp()),!0)},on:function(a,i){return this._listeners[a].push(i),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(a,i){if(this._listeners[a])for(var s=0;s<this._listeners[a].length;s++)this._listeners[a][s].call(this,i)},pipe:function(a){return a.registerPrevious(this)},registerPrevious:function(a){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=a.streamInfo,this.mergeStreamInfo(),this.previous=a;var i=this;return a.on("data",function(s){i.processChunk(s)}),a.on("end",function(){i.end()}),a.on("error",function(s){i.error(s)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var a=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),a=!0),this.previous&&this.previous.resume(),!a},flush:function(){},processChunk:function(a){this.push(a)},withStreamInfo:function(a,i){return this.extraStreamInfo[a]=i,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var a in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,a)&&(this.streamInfo[a]=this.extraStreamInfo[a])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var a="Worker "+this.name;return this.previous?this.previous+" -> "+a:a}},c.exports=t},{}],29:[function(e,c,r){var t=e("../utils"),a=e("./ConvertWorker"),i=e("./GenericWorker"),s=e("../base64"),l=e("../support"),h=e("../external"),g=null;if(l.nodestream)try{g=e("../nodejs/NodejsStreamOutputAdapter")}catch{}function p(b,f){return new h.Promise(function(v,y){var C=[],E=b._internalType,S=b._outputType,I=b._mimeType;b.on("data",function(x,L){C.push(x),f&&f(L)}).on("error",function(x){C=[],y(x)}).on("end",function(){try{var x=function(L,N,R){switch(L){case"blob":return t.newBlob(t.transformTo("arraybuffer",N),R);case"base64":return s.encode(N);default:return t.transformTo(L,N)}}(S,function(L,N){var R,P=0,Q=null,k=0;for(R=0;R<N.length;R++)k+=N[R].length;switch(L){case"string":return N.join("");case"array":return Array.prototype.concat.apply([],N);case"uint8array":for(Q=new Uint8Array(k),R=0;R<N.length;R++)Q.set(N[R],P),P+=N[R].length;return Q;case"nodebuffer":return Buffer.concat(N);default:throw new Error("concat : unsupported type '"+L+"'")}}(E,C),I);v(x)}catch(L){y(L)}C=[]}).resume()})}function u(b,f,v){var y=f;switch(f){case"blob":case"arraybuffer":y="uint8array";break;case"base64":y="string"}try{this._internalType=y,this._outputType=f,this._mimeType=v,t.checkSupport(y),this._worker=b.pipe(new a(y)),b.lock()}catch(C){this._worker=new i("error"),this._worker.error(C)}}u.prototype={accumulate:function(b){return p(this,b)},on:function(b,f){var v=this;return b==="data"?this._worker.on(b,function(y){f.call(v,y.data,y.meta)}):this._worker.on(b,function(){t.delay(f,arguments,v)}),this},resume:function(){return t.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(b){if(t.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new g(this,{objectMode:this._outputType!=="nodebuffer"},b)}},c.exports=u},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,c,r){if(r.base64=!0,r.array=!0,r.string=!0,r.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",r.nodebuffer=typeof Buffer<"u",r.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")r.blob=!1;else{var t=new ArrayBuffer(0);try{r.blob=new Blob([t],{type:"application/zip"}).size===0}catch{try{var a=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);a.append(t),r.blob=a.getBlob("application/zip").size===0}catch{r.blob=!1}}}try{r.nodestream=!!e("readable-stream").Readable}catch{r.nodestream=!1}},{"readable-stream":16}],31:[function(e,c,r){for(var t=e("./utils"),a=e("./support"),i=e("./nodejsUtils"),s=e("./stream/GenericWorker"),l=new Array(256),h=0;h<256;h++)l[h]=252<=h?6:248<=h?5:240<=h?4:224<=h?3:192<=h?2:1;l[254]=l[254]=1;function g(){s.call(this,"utf-8 decode"),this.leftOver=null}function p(){s.call(this,"utf-8 encode")}r.utf8encode=function(u){return a.nodebuffer?i.newBufferFrom(u,"utf-8"):function(b){var f,v,y,C,E,S=b.length,I=0;for(C=0;C<S;C++)(64512&(v=b.charCodeAt(C)))==55296&&C+1<S&&(64512&(y=b.charCodeAt(C+1)))==56320&&(v=65536+(v-55296<<10)+(y-56320),C++),I+=v<128?1:v<2048?2:v<65536?3:4;for(f=a.uint8array?new Uint8Array(I):new Array(I),C=E=0;E<I;C++)(64512&(v=b.charCodeAt(C)))==55296&&C+1<S&&(64512&(y=b.charCodeAt(C+1)))==56320&&(v=65536+(v-55296<<10)+(y-56320),C++),v<128?f[E++]=v:(v<2048?f[E++]=192|v>>>6:(v<65536?f[E++]=224|v>>>12:(f[E++]=240|v>>>18,f[E++]=128|v>>>12&63),f[E++]=128|v>>>6&63),f[E++]=128|63&v);return f}(u)},r.utf8decode=function(u){return a.nodebuffer?t.transformTo("nodebuffer",u).toString("utf-8"):function(b){var f,v,y,C,E=b.length,S=new Array(2*E);for(f=v=0;f<E;)if((y=b[f++])<128)S[v++]=y;else if(4<(C=l[y]))S[v++]=65533,f+=C-1;else{for(y&=C===2?31:C===3?15:7;1<C&&f<E;)y=y<<6|63&b[f++],C--;1<C?S[v++]=65533:y<65536?S[v++]=y:(y-=65536,S[v++]=55296|y>>10&1023,S[v++]=56320|1023&y)}return S.length!==v&&(S.subarray?S=S.subarray(0,v):S.length=v),t.applyFromCharCode(S)}(u=t.transformTo(a.uint8array?"uint8array":"array",u))},t.inherits(g,s),g.prototype.processChunk=function(u){var b=t.transformTo(a.uint8array?"uint8array":"array",u.data);if(this.leftOver&&this.leftOver.length){if(a.uint8array){var f=b;(b=new Uint8Array(f.length+this.leftOver.length)).set(this.leftOver,0),b.set(f,this.leftOver.length)}else b=this.leftOver.concat(b);this.leftOver=null}var v=function(C,E){var S;for((E=E||C.length)>C.length&&(E=C.length),S=E-1;0<=S&&(192&C[S])==128;)S--;return S<0||S===0?E:S+l[C[S]]>E?S:E}(b),y=b;v!==b.length&&(a.uint8array?(y=b.subarray(0,v),this.leftOver=b.subarray(v,b.length)):(y=b.slice(0,v),this.leftOver=b.slice(v,b.length))),this.push({data:r.utf8decode(y),meta:u.meta})},g.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:r.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},r.Utf8DecodeWorker=g,t.inherits(p,s),p.prototype.processChunk=function(u){this.push({data:r.utf8encode(u.data),meta:u.meta})},r.Utf8EncodeWorker=p},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,c,r){var t=e("./support"),a=e("./base64"),i=e("./nodejsUtils"),s=e("./external");function l(f){return f}function h(f,v){for(var y=0;y<f.length;++y)v[y]=255&f.charCodeAt(y);return v}e("setimmediate"),r.newBlob=function(f,v){r.checkSupport("blob");try{return new Blob([f],{type:v})}catch{try{var y=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return y.append(f),y.getBlob(v)}catch{throw new Error("Bug : can't construct the Blob.")}}};var g={stringifyByChunk:function(f,v,y){var C=[],E=0,S=f.length;if(S<=y)return String.fromCharCode.apply(null,f);for(;E<S;)v==="array"||v==="nodebuffer"?C.push(String.fromCharCode.apply(null,f.slice(E,Math.min(E+y,S)))):C.push(String.fromCharCode.apply(null,f.subarray(E,Math.min(E+y,S)))),E+=y;return C.join("")},stringifyByChar:function(f){for(var v="",y=0;y<f.length;y++)v+=String.fromCharCode(f[y]);return v},applyCanBeUsed:{uint8array:function(){try{return t.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}}(),nodebuffer:function(){try{return t.nodebuffer&&String.fromCharCode.apply(null,i.allocBuffer(1)).length===1}catch{return!1}}()}};function p(f){var v=65536,y=r.getTypeOf(f),C=!0;if(y==="uint8array"?C=g.applyCanBeUsed.uint8array:y==="nodebuffer"&&(C=g.applyCanBeUsed.nodebuffer),C)for(;1<v;)try{return g.stringifyByChunk(f,y,v)}catch{v=Math.floor(v/2)}return g.stringifyByChar(f)}function u(f,v){for(var y=0;y<f.length;y++)v[y]=f[y];return v}r.applyFromCharCode=p;var b={};b.string={string:l,array:function(f){return h(f,new Array(f.length))},arraybuffer:function(f){return b.string.uint8array(f).buffer},uint8array:function(f){return h(f,new Uint8Array(f.length))},nodebuffer:function(f){return h(f,i.allocBuffer(f.length))}},b.array={string:p,array:l,arraybuffer:function(f){return new Uint8Array(f).buffer},uint8array:function(f){return new Uint8Array(f)},nodebuffer:function(f){return i.newBufferFrom(f)}},b.arraybuffer={string:function(f){return p(new Uint8Array(f))},array:function(f){return u(new Uint8Array(f),new Array(f.byteLength))},arraybuffer:l,uint8array:function(f){return new Uint8Array(f)},nodebuffer:function(f){return i.newBufferFrom(new Uint8Array(f))}},b.uint8array={string:p,array:function(f){return u(f,new Array(f.length))},arraybuffer:function(f){return f.buffer},uint8array:l,nodebuffer:function(f){return i.newBufferFrom(f)}},b.nodebuffer={string:p,array:function(f){return u(f,new Array(f.length))},arraybuffer:function(f){return b.nodebuffer.uint8array(f).buffer},uint8array:function(f){return u(f,new Uint8Array(f.length))},nodebuffer:l},r.transformTo=function(f,v){if(v=v||"",!f)return v;r.checkSupport(f);var y=r.getTypeOf(v);return b[y][f](v)},r.resolve=function(f){for(var v=f.split("/"),y=[],C=0;C<v.length;C++){var E=v[C];E==="."||E===""&&C!==0&&C!==v.length-1||(E===".."?y.pop():y.push(E))}return y.join("/")},r.getTypeOf=function(f){return typeof f=="string"?"string":Object.prototype.toString.call(f)==="[object Array]"?"array":t.nodebuffer&&i.isBuffer(f)?"nodebuffer":t.uint8array&&f instanceof Uint8Array?"uint8array":t.arraybuffer&&f instanceof ArrayBuffer?"arraybuffer":void 0},r.checkSupport=function(f){if(!t[f.toLowerCase()])throw new Error(f+" is not supported by this platform")},r.MAX_VALUE_16BITS=65535,r.MAX_VALUE_32BITS=-1,r.pretty=function(f){var v,y,C="";for(y=0;y<(f||"").length;y++)C+="\\x"+((v=f.charCodeAt(y))<16?"0":"")+v.toString(16).toUpperCase();return C},r.delay=function(f,v,y){setImmediate(function(){f.apply(y||null,v||[])})},r.inherits=function(f,v){function y(){}y.prototype=v.prototype,f.prototype=new y},r.extend=function(){var f,v,y={};for(f=0;f<arguments.length;f++)for(v in arguments[f])Object.prototype.hasOwnProperty.call(arguments[f],v)&&y[v]===void 0&&(y[v]=arguments[f][v]);return y},r.prepareContent=function(f,v,y,C,E){return s.Promise.resolve(v).then(function(S){return t.blob&&(S instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(S))!==-1)&&typeof FileReader<"u"?new s.Promise(function(I,x){var L=new FileReader;L.onload=function(N){I(N.target.result)},L.onerror=function(N){x(N.target.error)},L.readAsArrayBuffer(S)}):S}).then(function(S){var I=r.getTypeOf(S);return I?(I==="arraybuffer"?S=r.transformTo("uint8array",S):I==="string"&&(E?S=a.decode(S):y&&C!==!0&&(S=function(x){return h(x,t.uint8array?new Uint8Array(x.length):new Array(x.length))}(S))),S):s.Promise.reject(new Error("Can't read the data of '"+f+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(e,c,r){var t=e("./reader/readerFor"),a=e("./utils"),i=e("./signature"),s=e("./zipEntry"),l=e("./support");function h(g){this.files=[],this.loadOptions=g}h.prototype={checkSignature:function(g){if(!this.reader.readAndCheckSignature(g)){this.reader.index-=4;var p=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+a.pretty(p)+", expected "+a.pretty(g)+")")}},isSignature:function(g,p){var u=this.reader.index;this.reader.setIndex(g);var b=this.reader.readString(4)===p;return this.reader.setIndex(u),b},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var g=this.reader.readData(this.zipCommentLength),p=l.uint8array?"uint8array":"array",u=a.transformTo(p,g);this.zipComment=this.loadOptions.decodeFileName(u)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var g,p,u,b=this.zip64EndOfCentralSize-44;0<b;)g=this.reader.readInt(2),p=this.reader.readInt(4),u=this.reader.readData(p),this.zip64ExtensibleData[g]={id:g,length:p,value:u}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var g,p;for(g=0;g<this.files.length;g++)p=this.files[g],this.reader.setIndex(p.localHeaderOffset),this.checkSignature(i.LOCAL_FILE_HEADER),p.readLocalPart(this.reader),p.handleUTF8(),p.processAttributes()},readCentralDir:function(){var g;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(i.CENTRAL_FILE_HEADER);)(g=new s({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(g);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var g=this.reader.lastIndexOfSignature(i.CENTRAL_DIRECTORY_END);if(g<0)throw this.isSignature(0,i.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(g);var p=g;if(this.checkSignature(i.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===a.MAX_VALUE_16BITS||this.diskWithCentralDirStart===a.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===a.MAX_VALUE_16BITS||this.centralDirRecords===a.MAX_VALUE_16BITS||this.centralDirSize===a.MAX_VALUE_32BITS||this.centralDirOffset===a.MAX_VALUE_32BITS){if(this.zip64=!0,(g=this.reader.lastIndexOfSignature(i.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(g),this.checkSignature(i.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,i.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(i.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(i.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var u=this.centralDirOffset+this.centralDirSize;this.zip64&&(u+=20,u+=12+this.zip64EndOfCentralSize);var b=p-u;if(0<b)this.isSignature(p,i.CENTRAL_FILE_HEADER)||(this.reader.zero=b);else if(b<0)throw new Error("Corrupted zip: missing "+Math.abs(b)+" bytes.")},prepareReader:function(g){this.reader=t(g)},load:function(g){this.prepareReader(g),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},c.exports=h},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(e,c,r){var t=e("./reader/readerFor"),a=e("./utils"),i=e("./compressedObject"),s=e("./crc32"),l=e("./utf8"),h=e("./compressions"),g=e("./support");function p(u,b){this.options=u,this.loadOptions=b}p.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(u){var b,f;if(u.skip(22),this.fileNameLength=u.readInt(2),f=u.readInt(2),this.fileName=u.readData(this.fileNameLength),u.skip(f),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((b=function(v){for(var y in h)if(Object.prototype.hasOwnProperty.call(h,y)&&h[y].magic===v)return h[y];return null}(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+a.pretty(this.compressionMethod)+" unknown (inner file : "+a.transformTo("string",this.fileName)+")");this.decompressed=new i(this.compressedSize,this.uncompressedSize,this.crc32,b,u.readData(this.compressedSize))},readCentralPart:function(u){this.versionMadeBy=u.readInt(2),u.skip(2),this.bitFlag=u.readInt(2),this.compressionMethod=u.readString(2),this.date=u.readDate(),this.crc32=u.readInt(4),this.compressedSize=u.readInt(4),this.uncompressedSize=u.readInt(4);var b=u.readInt(2);if(this.extraFieldsLength=u.readInt(2),this.fileCommentLength=u.readInt(2),this.diskNumberStart=u.readInt(2),this.internalFileAttributes=u.readInt(2),this.externalFileAttributes=u.readInt(4),this.localHeaderOffset=u.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");u.skip(b),this.readExtraFields(u),this.parseZIP64ExtraField(u),this.fileComment=u.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var u=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),u==0&&(this.dosPermissions=63&this.externalFileAttributes),u==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var u=t(this.extraFields[1].value);this.uncompressedSize===a.MAX_VALUE_32BITS&&(this.uncompressedSize=u.readInt(8)),this.compressedSize===a.MAX_VALUE_32BITS&&(this.compressedSize=u.readInt(8)),this.localHeaderOffset===a.MAX_VALUE_32BITS&&(this.localHeaderOffset=u.readInt(8)),this.diskNumberStart===a.MAX_VALUE_32BITS&&(this.diskNumberStart=u.readInt(4))}},readExtraFields:function(u){var b,f,v,y=u.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});u.index+4<y;)b=u.readInt(2),f=u.readInt(2),v=u.readData(f),this.extraFields[b]={id:b,length:f,value:v};u.setIndex(y)},handleUTF8:function(){var u=g.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=l.utf8decode(this.fileName),this.fileCommentStr=l.utf8decode(this.fileComment);else{var b=this.findExtraFieldUnicodePath();if(b!==null)this.fileNameStr=b;else{var f=a.transformTo(u,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(f)}var v=this.findExtraFieldUnicodeComment();if(v!==null)this.fileCommentStr=v;else{var y=a.transformTo(u,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(y)}}},findExtraFieldUnicodePath:function(){var u=this.extraFields[28789];if(u){var b=t(u.value);return b.readInt(1)!==1||s(this.fileName)!==b.readInt(4)?null:l.utf8decode(b.readData(u.length-5))}return null},findExtraFieldUnicodeComment:function(){var u=this.extraFields[25461];if(u){var b=t(u.value);return b.readInt(1)!==1||s(this.fileComment)!==b.readInt(4)?null:l.utf8decode(b.readData(u.length-5))}return null}},c.exports=p},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(e,c,r){function t(b,f,v){this.name=b,this.dir=v.dir,this.date=v.date,this.comment=v.comment,this.unixPermissions=v.unixPermissions,this.dosPermissions=v.dosPermissions,this._data=f,this._dataBinary=v.binary,this.options={compression:v.compression,compressionOptions:v.compressionOptions}}var a=e("./stream/StreamHelper"),i=e("./stream/DataWorker"),s=e("./utf8"),l=e("./compressedObject"),h=e("./stream/GenericWorker");t.prototype={internalStream:function(b){var f=null,v="string";try{if(!b)throw new Error("No output type specified.");var y=(v=b.toLowerCase())==="string"||v==="text";v!=="binarystring"&&v!=="text"||(v="string"),f=this._decompressWorker();var C=!this._dataBinary;C&&!y&&(f=f.pipe(new s.Utf8EncodeWorker)),!C&&y&&(f=f.pipe(new s.Utf8DecodeWorker))}catch(E){(f=new h("error")).error(E)}return new a(f,v,"")},async:function(b,f){return this.internalStream(b).accumulate(f)},nodeStream:function(b,f){return this.internalStream(b||"nodebuffer").toNodejsStream(f)},_compressWorker:function(b,f){if(this._data instanceof l&&this._data.compression.magic===b.magic)return this._data.getCompressedWorker();var v=this._decompressWorker();return this._dataBinary||(v=v.pipe(new s.Utf8EncodeWorker)),l.createWorkerFrom(v,b,f)},_decompressWorker:function(){return this._data instanceof l?this._data.getContentWorker():this._data instanceof h?this._data:new i(this._data)}};for(var g=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],p=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},u=0;u<g.length;u++)t.prototype[g[u]]=p;c.exports=t},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(e,c,r){(function(t){var a,i,s=t.MutationObserver||t.WebKitMutationObserver;if(s){var l=0,h=new s(b),g=t.document.createTextNode("");h.observe(g,{characterData:!0}),a=function(){g.data=l=++l%2}}else if(t.setImmediate||t.MessageChannel===void 0)a="document"in t&&"onreadystatechange"in t.document.createElement("script")?function(){var f=t.document.createElement("script");f.onreadystatechange=function(){b(),f.onreadystatechange=null,f.parentNode.removeChild(f),f=null},t.document.documentElement.appendChild(f)}:function(){setTimeout(b,0)};else{var p=new t.MessageChannel;p.port1.onmessage=b,a=function(){p.port2.postMessage(0)}}var u=[];function b(){var f,v;i=!0;for(var y=u.length;y;){for(v=u,u=[],f=-1;++f<y;)v[f]();y=u.length}i=!1}c.exports=function(f){u.push(f)!==1||i||a()}}).call(this,typeof mn<"u"?mn:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(e,c,r){var t=e("immediate");function a(){}var i={},s=["REJECTED"],l=["FULFILLED"],h=["PENDING"];function g(y){if(typeof y!="function")throw new TypeError("resolver must be a function");this.state=h,this.queue=[],this.outcome=void 0,y!==a&&f(this,y)}function p(y,C,E){this.promise=y,typeof C=="function"&&(this.onFulfilled=C,this.callFulfilled=this.otherCallFulfilled),typeof E=="function"&&(this.onRejected=E,this.callRejected=this.otherCallRejected)}function u(y,C,E){t(function(){var S;try{S=C(E)}catch(I){return i.reject(y,I)}S===y?i.reject(y,new TypeError("Cannot resolve promise with itself")):i.resolve(y,S)})}function b(y){var C=y&&y.then;if(y&&(typeof y=="object"||typeof y=="function")&&typeof C=="function")return function(){C.apply(y,arguments)}}function f(y,C){var E=!1;function S(L){E||(E=!0,i.reject(y,L))}function I(L){E||(E=!0,i.resolve(y,L))}var x=v(function(){C(I,S)});x.status==="error"&&S(x.value)}function v(y,C){var E={};try{E.value=y(C),E.status="success"}catch(S){E.status="error",E.value=S}return E}(c.exports=g).prototype.finally=function(y){if(typeof y!="function")return this;var C=this.constructor;return this.then(function(E){return C.resolve(y()).then(function(){return E})},function(E){return C.resolve(y()).then(function(){throw E})})},g.prototype.catch=function(y){return this.then(null,y)},g.prototype.then=function(y,C){if(typeof y!="function"&&this.state===l||typeof C!="function"&&this.state===s)return this;var E=new this.constructor(a);return this.state!==h?u(E,this.state===l?y:C,this.outcome):this.queue.push(new p(E,y,C)),E},p.prototype.callFulfilled=function(y){i.resolve(this.promise,y)},p.prototype.otherCallFulfilled=function(y){u(this.promise,this.onFulfilled,y)},p.prototype.callRejected=function(y){i.reject(this.promise,y)},p.prototype.otherCallRejected=function(y){u(this.promise,this.onRejected,y)},i.resolve=function(y,C){var E=v(b,C);if(E.status==="error")return i.reject(y,E.value);var S=E.value;if(S)f(y,S);else{y.state=l,y.outcome=C;for(var I=-1,x=y.queue.length;++I<x;)y.queue[I].callFulfilled(C)}return y},i.reject=function(y,C){y.state=s,y.outcome=C;for(var E=-1,S=y.queue.length;++E<S;)y.queue[E].callRejected(C);return y},g.resolve=function(y){return y instanceof this?y:i.resolve(new this(a),y)},g.reject=function(y){var C=new this(a);return i.reject(C,y)},g.all=function(y){var C=this;if(Object.prototype.toString.call(y)!=="[object Array]")return this.reject(new TypeError("must be an array"));var E=y.length,S=!1;if(!E)return this.resolve([]);for(var I=new Array(E),x=0,L=-1,N=new this(a);++L<E;)R(y[L],L);return N;function R(P,Q){C.resolve(P).then(function(k){I[Q]=k,++x!==E||S||(S=!0,i.resolve(N,I))},function(k){S||(S=!0,i.reject(N,k))})}},g.race=function(y){var C=this;if(Object.prototype.toString.call(y)!=="[object Array]")return this.reject(new TypeError("must be an array"));var E=y.length,S=!1;if(!E)return this.resolve([]);for(var I=-1,x=new this(a);++I<E;)L=y[I],C.resolve(L).then(function(N){S||(S=!0,i.resolve(x,N))},function(N){S||(S=!0,i.reject(x,N))});var L;return x}},{immediate:36}],38:[function(e,c,r){var t={};(0,e("./lib/utils/common").assign)(t,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),c.exports=t},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(e,c,r){var t=e("./zlib/deflate"),a=e("./utils/common"),i=e("./utils/strings"),s=e("./zlib/messages"),l=e("./zlib/zstream"),h=Object.prototype.toString,g=0,p=-1,u=0,b=8;function f(y){if(!(this instanceof f))return new f(y);this.options=a.assign({level:p,method:b,chunkSize:16384,windowBits:15,memLevel:8,strategy:u,to:""},y||{});var C=this.options;C.raw&&0<C.windowBits?C.windowBits=-C.windowBits:C.gzip&&0<C.windowBits&&C.windowBits<16&&(C.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new l,this.strm.avail_out=0;var E=t.deflateInit2(this.strm,C.level,C.method,C.windowBits,C.memLevel,C.strategy);if(E!==g)throw new Error(s[E]);if(C.header&&t.deflateSetHeader(this.strm,C.header),C.dictionary){var S;if(S=typeof C.dictionary=="string"?i.string2buf(C.dictionary):h.call(C.dictionary)==="[object ArrayBuffer]"?new Uint8Array(C.dictionary):C.dictionary,(E=t.deflateSetDictionary(this.strm,S))!==g)throw new Error(s[E]);this._dict_set=!0}}function v(y,C){var E=new f(C);if(E.push(y,!0),E.err)throw E.msg||s[E.err];return E.result}f.prototype.push=function(y,C){var E,S,I=this.strm,x=this.options.chunkSize;if(this.ended)return!1;S=C===~~C?C:C===!0?4:0,typeof y=="string"?I.input=i.string2buf(y):h.call(y)==="[object ArrayBuffer]"?I.input=new Uint8Array(y):I.input=y,I.next_in=0,I.avail_in=I.input.length;do{if(I.avail_out===0&&(I.output=new a.Buf8(x),I.next_out=0,I.avail_out=x),(E=t.deflate(I,S))!==1&&E!==g)return this.onEnd(E),!(this.ended=!0);I.avail_out!==0&&(I.avail_in!==0||S!==4&&S!==2)||(this.options.to==="string"?this.onData(i.buf2binstring(a.shrinkBuf(I.output,I.next_out))):this.onData(a.shrinkBuf(I.output,I.next_out)))}while((0<I.avail_in||I.avail_out===0)&&E!==1);return S===4?(E=t.deflateEnd(this.strm),this.onEnd(E),this.ended=!0,E===g):S!==2||(this.onEnd(g),!(I.avail_out=0))},f.prototype.onData=function(y){this.chunks.push(y)},f.prototype.onEnd=function(y){y===g&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=a.flattenChunks(this.chunks)),this.chunks=[],this.err=y,this.msg=this.strm.msg},r.Deflate=f,r.deflate=v,r.deflateRaw=function(y,C){return(C=C||{}).raw=!0,v(y,C)},r.gzip=function(y,C){return(C=C||{}).gzip=!0,v(y,C)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(e,c,r){var t=e("./zlib/inflate"),a=e("./utils/common"),i=e("./utils/strings"),s=e("./zlib/constants"),l=e("./zlib/messages"),h=e("./zlib/zstream"),g=e("./zlib/gzheader"),p=Object.prototype.toString;function u(f){if(!(this instanceof u))return new u(f);this.options=a.assign({chunkSize:16384,windowBits:0,to:""},f||{});var v=this.options;v.raw&&0<=v.windowBits&&v.windowBits<16&&(v.windowBits=-v.windowBits,v.windowBits===0&&(v.windowBits=-15)),!(0<=v.windowBits&&v.windowBits<16)||f&&f.windowBits||(v.windowBits+=32),15<v.windowBits&&v.windowBits<48&&!(15&v.windowBits)&&(v.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new h,this.strm.avail_out=0;var y=t.inflateInit2(this.strm,v.windowBits);if(y!==s.Z_OK)throw new Error(l[y]);this.header=new g,t.inflateGetHeader(this.strm,this.header)}function b(f,v){var y=new u(v);if(y.push(f,!0),y.err)throw y.msg||l[y.err];return y.result}u.prototype.push=function(f,v){var y,C,E,S,I,x,L=this.strm,N=this.options.chunkSize,R=this.options.dictionary,P=!1;if(this.ended)return!1;C=v===~~v?v:v===!0?s.Z_FINISH:s.Z_NO_FLUSH,typeof f=="string"?L.input=i.binstring2buf(f):p.call(f)==="[object ArrayBuffer]"?L.input=new Uint8Array(f):L.input=f,L.next_in=0,L.avail_in=L.input.length;do{if(L.avail_out===0&&(L.output=new a.Buf8(N),L.next_out=0,L.avail_out=N),(y=t.inflate(L,s.Z_NO_FLUSH))===s.Z_NEED_DICT&&R&&(x=typeof R=="string"?i.string2buf(R):p.call(R)==="[object ArrayBuffer]"?new Uint8Array(R):R,y=t.inflateSetDictionary(this.strm,x)),y===s.Z_BUF_ERROR&&P===!0&&(y=s.Z_OK,P=!1),y!==s.Z_STREAM_END&&y!==s.Z_OK)return this.onEnd(y),!(this.ended=!0);L.next_out&&(L.avail_out!==0&&y!==s.Z_STREAM_END&&(L.avail_in!==0||C!==s.Z_FINISH&&C!==s.Z_SYNC_FLUSH)||(this.options.to==="string"?(E=i.utf8border(L.output,L.next_out),S=L.next_out-E,I=i.buf2string(L.output,E),L.next_out=S,L.avail_out=N-S,S&&a.arraySet(L.output,L.output,E,S,0),this.onData(I)):this.onData(a.shrinkBuf(L.output,L.next_out)))),L.avail_in===0&&L.avail_out===0&&(P=!0)}while((0<L.avail_in||L.avail_out===0)&&y!==s.Z_STREAM_END);return y===s.Z_STREAM_END&&(C=s.Z_FINISH),C===s.Z_FINISH?(y=t.inflateEnd(this.strm),this.onEnd(y),this.ended=!0,y===s.Z_OK):C!==s.Z_SYNC_FLUSH||(this.onEnd(s.Z_OK),!(L.avail_out=0))},u.prototype.onData=function(f){this.chunks.push(f)},u.prototype.onEnd=function(f){f===s.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=a.flattenChunks(this.chunks)),this.chunks=[],this.err=f,this.msg=this.strm.msg},r.Inflate=u,r.inflate=b,r.inflateRaw=function(f,v){return(v=v||{}).raw=!0,b(f,v)},r.ungzip=b},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(e,c,r){var t=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";r.assign=function(s){for(var l=Array.prototype.slice.call(arguments,1);l.length;){var h=l.shift();if(h){if(typeof h!="object")throw new TypeError(h+"must be non-object");for(var g in h)h.hasOwnProperty(g)&&(s[g]=h[g])}}return s},r.shrinkBuf=function(s,l){return s.length===l?s:s.subarray?s.subarray(0,l):(s.length=l,s)};var a={arraySet:function(s,l,h,g,p){if(l.subarray&&s.subarray)s.set(l.subarray(h,h+g),p);else for(var u=0;u<g;u++)s[p+u]=l[h+u]},flattenChunks:function(s){var l,h,g,p,u,b;for(l=g=0,h=s.length;l<h;l++)g+=s[l].length;for(b=new Uint8Array(g),l=p=0,h=s.length;l<h;l++)u=s[l],b.set(u,p),p+=u.length;return b}},i={arraySet:function(s,l,h,g,p){for(var u=0;u<g;u++)s[p+u]=l[h+u]},flattenChunks:function(s){return[].concat.apply([],s)}};r.setTyped=function(s){s?(r.Buf8=Uint8Array,r.Buf16=Uint16Array,r.Buf32=Int32Array,r.assign(r,a)):(r.Buf8=Array,r.Buf16=Array,r.Buf32=Array,r.assign(r,i))},r.setTyped(t)},{}],42:[function(e,c,r){var t=e("./common"),a=!0,i=!0;try{String.fromCharCode.apply(null,[0])}catch{a=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{i=!1}for(var s=new t.Buf8(256),l=0;l<256;l++)s[l]=252<=l?6:248<=l?5:240<=l?4:224<=l?3:192<=l?2:1;function h(g,p){if(p<65537&&(g.subarray&&i||!g.subarray&&a))return String.fromCharCode.apply(null,t.shrinkBuf(g,p));for(var u="",b=0;b<p;b++)u+=String.fromCharCode(g[b]);return u}s[254]=s[254]=1,r.string2buf=function(g){var p,u,b,f,v,y=g.length,C=0;for(f=0;f<y;f++)(64512&(u=g.charCodeAt(f)))==55296&&f+1<y&&(64512&(b=g.charCodeAt(f+1)))==56320&&(u=65536+(u-55296<<10)+(b-56320),f++),C+=u<128?1:u<2048?2:u<65536?3:4;for(p=new t.Buf8(C),f=v=0;v<C;f++)(64512&(u=g.charCodeAt(f)))==55296&&f+1<y&&(64512&(b=g.charCodeAt(f+1)))==56320&&(u=65536+(u-55296<<10)+(b-56320),f++),u<128?p[v++]=u:(u<2048?p[v++]=192|u>>>6:(u<65536?p[v++]=224|u>>>12:(p[v++]=240|u>>>18,p[v++]=128|u>>>12&63),p[v++]=128|u>>>6&63),p[v++]=128|63&u);return p},r.buf2binstring=function(g){return h(g,g.length)},r.binstring2buf=function(g){for(var p=new t.Buf8(g.length),u=0,b=p.length;u<b;u++)p[u]=g.charCodeAt(u);return p},r.buf2string=function(g,p){var u,b,f,v,y=p||g.length,C=new Array(2*y);for(u=b=0;u<y;)if((f=g[u++])<128)C[b++]=f;else if(4<(v=s[f]))C[b++]=65533,u+=v-1;else{for(f&=v===2?31:v===3?15:7;1<v&&u<y;)f=f<<6|63&g[u++],v--;1<v?C[b++]=65533:f<65536?C[b++]=f:(f-=65536,C[b++]=55296|f>>10&1023,C[b++]=56320|1023&f)}return h(C,b)},r.utf8border=function(g,p){var u;for((p=p||g.length)>g.length&&(p=g.length),u=p-1;0<=u&&(192&g[u])==128;)u--;return u<0||u===0?p:u+s[g[u]]>p?u:p}},{"./common":41}],43:[function(e,c,r){c.exports=function(t,a,i,s){for(var l=65535&t|0,h=t>>>16&65535|0,g=0;i!==0;){for(i-=g=2e3<i?2e3:i;h=h+(l=l+a[s++]|0)|0,--g;);l%=65521,h%=65521}return l|h<<16|0}},{}],44:[function(e,c,r){c.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(e,c,r){var t=function(){for(var a,i=[],s=0;s<256;s++){a=s;for(var l=0;l<8;l++)a=1&a?3988292384^a>>>1:a>>>1;i[s]=a}return i}();c.exports=function(a,i,s,l){var h=t,g=l+s;a^=-1;for(var p=l;p<g;p++)a=a>>>8^h[255&(a^i[p])];return-1^a}},{}],46:[function(e,c,r){var t,a=e("../utils/common"),i=e("./trees"),s=e("./adler32"),l=e("./crc32"),h=e("./messages"),g=0,p=4,u=0,b=-2,f=-1,v=4,y=2,C=8,E=9,S=286,I=30,x=19,L=2*S+1,N=15,R=3,P=258,Q=P+R+1,k=42,z=113,m=1,H=2,ue=3,Z=4;function fe(d,W){return d.msg=h[W],W}function F(d){return(d<<1)-(4<d?9:0)}function ne(d){for(var W=d.length;0<=--W;)d[W]=0}function A(d){var W=d.state,$=W.pending;$>d.avail_out&&($=d.avail_out),$!==0&&(a.arraySet(d.output,W.pending_buf,W.pending_out,$,d.next_out),d.next_out+=$,W.pending_out+=$,d.total_out+=$,d.avail_out-=$,W.pending-=$,W.pending===0&&(W.pending_out=0))}function M(d,W){i._tr_flush_block(d,0<=d.block_start?d.block_start:-1,d.strstart-d.block_start,W),d.block_start=d.strstart,A(d.strm)}function re(d,W){d.pending_buf[d.pending++]=W}function te(d,W){d.pending_buf[d.pending++]=W>>>8&255,d.pending_buf[d.pending++]=255&W}function Y(d,W){var $,_,w=d.max_chain_length,T=d.strstart,j=d.prev_length,q=d.nice_match,O=d.strstart>d.w_size-Q?d.strstart-(d.w_size-Q):0,V=d.window,se=d.w_mask,J=d.prev,le=d.strstart+P,Ie=V[T+j-1],me=V[T+j];d.prev_length>=d.good_match&&(w>>=2),q>d.lookahead&&(q=d.lookahead);do if(V[($=W)+j]===me&&V[$+j-1]===Ie&&V[$]===V[T]&&V[++$]===V[T+1]){T+=2,$++;do;while(V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&T<le);if(_=P-(le-T),T=le-P,j<_){if(d.match_start=W,q<=(j=_))break;Ie=V[T+j-1],me=V[T+j]}}while((W=J[W&se])>O&&--w!=0);return j<=d.lookahead?j:d.lookahead}function Be(d){var W,$,_,w,T,j,q,O,V,se,J=d.w_size;do{if(w=d.window_size-d.lookahead-d.strstart,d.strstart>=J+(J-Q)){for(a.arraySet(d.window,d.window,J,J,0),d.match_start-=J,d.strstart-=J,d.block_start-=J,W=$=d.hash_size;_=d.head[--W],d.head[W]=J<=_?_-J:0,--$;);for(W=$=J;_=d.prev[--W],d.prev[W]=J<=_?_-J:0,--$;);w+=J}if(d.strm.avail_in===0)break;if(j=d.strm,q=d.window,O=d.strstart+d.lookahead,V=w,se=void 0,se=j.avail_in,V<se&&(se=V),$=se===0?0:(j.avail_in-=se,a.arraySet(q,j.input,j.next_in,se,O),j.state.wrap===1?j.adler=s(j.adler,q,se,O):j.state.wrap===2&&(j.adler=l(j.adler,q,se,O)),j.next_in+=se,j.total_in+=se,se),d.lookahead+=$,d.lookahead+d.insert>=R)for(T=d.strstart-d.insert,d.ins_h=d.window[T],d.ins_h=(d.ins_h<<d.hash_shift^d.window[T+1])&d.hash_mask;d.insert&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[T+R-1])&d.hash_mask,d.prev[T&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=T,T++,d.insert--,!(d.lookahead+d.insert<R)););}while(d.lookahead<Q&&d.strm.avail_in!==0)}function Ne(d,W){for(var $,_;;){if(d.lookahead<Q){if(Be(d),d.lookahead<Q&&W===g)return m;if(d.lookahead===0)break}if($=0,d.lookahead>=R&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),$!==0&&d.strstart-$<=d.w_size-Q&&(d.match_length=Y(d,$)),d.match_length>=R)if(_=i._tr_tally(d,d.strstart-d.match_start,d.match_length-R),d.lookahead-=d.match_length,d.match_length<=d.max_lazy_match&&d.lookahead>=R){for(d.match_length--;d.strstart++,d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart,--d.match_length!=0;);d.strstart++}else d.strstart+=d.match_length,d.match_length=0,d.ins_h=d.window[d.strstart],d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+1])&d.hash_mask;else _=i._tr_tally(d,0,d.window[d.strstart]),d.lookahead--,d.strstart++;if(_&&(M(d,!1),d.strm.avail_out===0))return m}return d.insert=d.strstart<R-1?d.strstart:R-1,W===p?(M(d,!0),d.strm.avail_out===0?ue:Z):d.last_lit&&(M(d,!1),d.strm.avail_out===0)?m:H}function pe(d,W){for(var $,_,w;;){if(d.lookahead<Q){if(Be(d),d.lookahead<Q&&W===g)return m;if(d.lookahead===0)break}if($=0,d.lookahead>=R&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),d.prev_length=d.match_length,d.prev_match=d.match_start,d.match_length=R-1,$!==0&&d.prev_length<d.max_lazy_match&&d.strstart-$<=d.w_size-Q&&(d.match_length=Y(d,$),d.match_length<=5&&(d.strategy===1||d.match_length===R&&4096<d.strstart-d.match_start)&&(d.match_length=R-1)),d.prev_length>=R&&d.match_length<=d.prev_length){for(w=d.strstart+d.lookahead-R,_=i._tr_tally(d,d.strstart-1-d.prev_match,d.prev_length-R),d.lookahead-=d.prev_length-1,d.prev_length-=2;++d.strstart<=w&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),--d.prev_length!=0;);if(d.match_available=0,d.match_length=R-1,d.strstart++,_&&(M(d,!1),d.strm.avail_out===0))return m}else if(d.match_available){if((_=i._tr_tally(d,0,d.window[d.strstart-1]))&&M(d,!1),d.strstart++,d.lookahead--,d.strm.avail_out===0)return m}else d.match_available=1,d.strstart++,d.lookahead--}return d.match_available&&(_=i._tr_tally(d,0,d.window[d.strstart-1]),d.match_available=0),d.insert=d.strstart<R-1?d.strstart:R-1,W===p?(M(d,!0),d.strm.avail_out===0?ue:Z):d.last_lit&&(M(d,!1),d.strm.avail_out===0)?m:H}function ve(d,W,$,_,w){this.good_length=d,this.max_lazy=W,this.nice_length=$,this.max_chain=_,this.func=w}function Le(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=C,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new a.Buf16(2*L),this.dyn_dtree=new a.Buf16(2*(2*I+1)),this.bl_tree=new a.Buf16(2*(2*x+1)),ne(this.dyn_ltree),ne(this.dyn_dtree),ne(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new a.Buf16(N+1),this.heap=new a.Buf16(2*S+1),ne(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new a.Buf16(2*S+1),ne(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function De(d){var W;return d&&d.state?(d.total_in=d.total_out=0,d.data_type=y,(W=d.state).pending=0,W.pending_out=0,W.wrap<0&&(W.wrap=-W.wrap),W.status=W.wrap?k:z,d.adler=W.wrap===2?0:1,W.last_flush=g,i._tr_init(W),u):fe(d,b)}function Je(d){var W=De(d);return W===u&&function($){$.window_size=2*$.w_size,ne($.head),$.max_lazy_match=t[$.level].max_lazy,$.good_match=t[$.level].good_length,$.nice_match=t[$.level].nice_length,$.max_chain_length=t[$.level].max_chain,$.strstart=0,$.block_start=0,$.lookahead=0,$.insert=0,$.match_length=$.prev_length=R-1,$.match_available=0,$.ins_h=0}(d.state),W}function Ye(d,W,$,_,w,T){if(!d)return b;var j=1;if(W===f&&(W=6),_<0?(j=0,_=-_):15<_&&(j=2,_-=16),w<1||E<w||$!==C||_<8||15<_||W<0||9<W||T<0||v<T)return fe(d,b);_===8&&(_=9);var q=new Le;return(d.state=q).strm=d,q.wrap=j,q.gzhead=null,q.w_bits=_,q.w_size=1<<q.w_bits,q.w_mask=q.w_size-1,q.hash_bits=w+7,q.hash_size=1<<q.hash_bits,q.hash_mask=q.hash_size-1,q.hash_shift=~~((q.hash_bits+R-1)/R),q.window=new a.Buf8(2*q.w_size),q.head=new a.Buf16(q.hash_size),q.prev=new a.Buf16(q.w_size),q.lit_bufsize=1<<w+6,q.pending_buf_size=4*q.lit_bufsize,q.pending_buf=new a.Buf8(q.pending_buf_size),q.d_buf=1*q.lit_bufsize,q.l_buf=3*q.lit_bufsize,q.level=W,q.strategy=T,q.method=$,Je(d)}t=[new ve(0,0,0,0,function(d,W){var $=65535;for($>d.pending_buf_size-5&&($=d.pending_buf_size-5);;){if(d.lookahead<=1){if(Be(d),d.lookahead===0&&W===g)return m;if(d.lookahead===0)break}d.strstart+=d.lookahead,d.lookahead=0;var _=d.block_start+$;if((d.strstart===0||d.strstart>=_)&&(d.lookahead=d.strstart-_,d.strstart=_,M(d,!1),d.strm.avail_out===0)||d.strstart-d.block_start>=d.w_size-Q&&(M(d,!1),d.strm.avail_out===0))return m}return d.insert=0,W===p?(M(d,!0),d.strm.avail_out===0?ue:Z):(d.strstart>d.block_start&&(M(d,!1),d.strm.avail_out),m)}),new ve(4,4,8,4,Ne),new ve(4,5,16,8,Ne),new ve(4,6,32,32,Ne),new ve(4,4,16,16,pe),new ve(8,16,32,32,pe),new ve(8,16,128,128,pe),new ve(8,32,128,256,pe),new ve(32,128,258,1024,pe),new ve(32,258,258,4096,pe)],r.deflateInit=function(d,W){return Ye(d,W,C,15,8,0)},r.deflateInit2=Ye,r.deflateReset=Je,r.deflateResetKeep=De,r.deflateSetHeader=function(d,W){return d&&d.state?d.state.wrap!==2?b:(d.state.gzhead=W,u):b},r.deflate=function(d,W){var $,_,w,T;if(!d||!d.state||5<W||W<0)return d?fe(d,b):b;if(_=d.state,!d.output||!d.input&&d.avail_in!==0||_.status===666&&W!==p)return fe(d,d.avail_out===0?-5:b);if(_.strm=d,$=_.last_flush,_.last_flush=W,_.status===k)if(_.wrap===2)d.adler=0,re(_,31),re(_,139),re(_,8),_.gzhead?(re(_,(_.gzhead.text?1:0)+(_.gzhead.hcrc?2:0)+(_.gzhead.extra?4:0)+(_.gzhead.name?8:0)+(_.gzhead.comment?16:0)),re(_,255&_.gzhead.time),re(_,_.gzhead.time>>8&255),re(_,_.gzhead.time>>16&255),re(_,_.gzhead.time>>24&255),re(_,_.level===9?2:2<=_.strategy||_.level<2?4:0),re(_,255&_.gzhead.os),_.gzhead.extra&&_.gzhead.extra.length&&(re(_,255&_.gzhead.extra.length),re(_,_.gzhead.extra.length>>8&255)),_.gzhead.hcrc&&(d.adler=l(d.adler,_.pending_buf,_.pending,0)),_.gzindex=0,_.status=69):(re(_,0),re(_,0),re(_,0),re(_,0),re(_,0),re(_,_.level===9?2:2<=_.strategy||_.level<2?4:0),re(_,3),_.status=z);else{var j=C+(_.w_bits-8<<4)<<8;j|=(2<=_.strategy||_.level<2?0:_.level<6?1:_.level===6?2:3)<<6,_.strstart!==0&&(j|=32),j+=31-j%31,_.status=z,te(_,j),_.strstart!==0&&(te(_,d.adler>>>16),te(_,65535&d.adler)),d.adler=1}if(_.status===69)if(_.gzhead.extra){for(w=_.pending;_.gzindex<(65535&_.gzhead.extra.length)&&(_.pending!==_.pending_buf_size||(_.gzhead.hcrc&&_.pending>w&&(d.adler=l(d.adler,_.pending_buf,_.pending-w,w)),A(d),w=_.pending,_.pending!==_.pending_buf_size));)re(_,255&_.gzhead.extra[_.gzindex]),_.gzindex++;_.gzhead.hcrc&&_.pending>w&&(d.adler=l(d.adler,_.pending_buf,_.pending-w,w)),_.gzindex===_.gzhead.extra.length&&(_.gzindex=0,_.status=73)}else _.status=73;if(_.status===73)if(_.gzhead.name){w=_.pending;do{if(_.pending===_.pending_buf_size&&(_.gzhead.hcrc&&_.pending>w&&(d.adler=l(d.adler,_.pending_buf,_.pending-w,w)),A(d),w=_.pending,_.pending===_.pending_buf_size)){T=1;break}T=_.gzindex<_.gzhead.name.length?255&_.gzhead.name.charCodeAt(_.gzindex++):0,re(_,T)}while(T!==0);_.gzhead.hcrc&&_.pending>w&&(d.adler=l(d.adler,_.pending_buf,_.pending-w,w)),T===0&&(_.gzindex=0,_.status=91)}else _.status=91;if(_.status===91)if(_.gzhead.comment){w=_.pending;do{if(_.pending===_.pending_buf_size&&(_.gzhead.hcrc&&_.pending>w&&(d.adler=l(d.adler,_.pending_buf,_.pending-w,w)),A(d),w=_.pending,_.pending===_.pending_buf_size)){T=1;break}T=_.gzindex<_.gzhead.comment.length?255&_.gzhead.comment.charCodeAt(_.gzindex++):0,re(_,T)}while(T!==0);_.gzhead.hcrc&&_.pending>w&&(d.adler=l(d.adler,_.pending_buf,_.pending-w,w)),T===0&&(_.status=103)}else _.status=103;if(_.status===103&&(_.gzhead.hcrc?(_.pending+2>_.pending_buf_size&&A(d),_.pending+2<=_.pending_buf_size&&(re(_,255&d.adler),re(_,d.adler>>8&255),d.adler=0,_.status=z)):_.status=z),_.pending!==0){if(A(d),d.avail_out===0)return _.last_flush=-1,u}else if(d.avail_in===0&&F(W)<=F($)&&W!==p)return fe(d,-5);if(_.status===666&&d.avail_in!==0)return fe(d,-5);if(d.avail_in!==0||_.lookahead!==0||W!==g&&_.status!==666){var q=_.strategy===2?function(O,V){for(var se;;){if(O.lookahead===0&&(Be(O),O.lookahead===0)){if(V===g)return m;break}if(O.match_length=0,se=i._tr_tally(O,0,O.window[O.strstart]),O.lookahead--,O.strstart++,se&&(M(O,!1),O.strm.avail_out===0))return m}return O.insert=0,V===p?(M(O,!0),O.strm.avail_out===0?ue:Z):O.last_lit&&(M(O,!1),O.strm.avail_out===0)?m:H}(_,W):_.strategy===3?function(O,V){for(var se,J,le,Ie,me=O.window;;){if(O.lookahead<=P){if(Be(O),O.lookahead<=P&&V===g)return m;if(O.lookahead===0)break}if(O.match_length=0,O.lookahead>=R&&0<O.strstart&&(J=me[le=O.strstart-1])===me[++le]&&J===me[++le]&&J===me[++le]){Ie=O.strstart+P;do;while(J===me[++le]&&J===me[++le]&&J===me[++le]&&J===me[++le]&&J===me[++le]&&J===me[++le]&&J===me[++le]&&J===me[++le]&&le<Ie);O.match_length=P-(Ie-le),O.match_length>O.lookahead&&(O.match_length=O.lookahead)}if(O.match_length>=R?(se=i._tr_tally(O,1,O.match_length-R),O.lookahead-=O.match_length,O.strstart+=O.match_length,O.match_length=0):(se=i._tr_tally(O,0,O.window[O.strstart]),O.lookahead--,O.strstart++),se&&(M(O,!1),O.strm.avail_out===0))return m}return O.insert=0,V===p?(M(O,!0),O.strm.avail_out===0?ue:Z):O.last_lit&&(M(O,!1),O.strm.avail_out===0)?m:H}(_,W):t[_.level].func(_,W);if(q!==ue&&q!==Z||(_.status=666),q===m||q===ue)return d.avail_out===0&&(_.last_flush=-1),u;if(q===H&&(W===1?i._tr_align(_):W!==5&&(i._tr_stored_block(_,0,0,!1),W===3&&(ne(_.head),_.lookahead===0&&(_.strstart=0,_.block_start=0,_.insert=0))),A(d),d.avail_out===0))return _.last_flush=-1,u}return W!==p?u:_.wrap<=0?1:(_.wrap===2?(re(_,255&d.adler),re(_,d.adler>>8&255),re(_,d.adler>>16&255),re(_,d.adler>>24&255),re(_,255&d.total_in),re(_,d.total_in>>8&255),re(_,d.total_in>>16&255),re(_,d.total_in>>24&255)):(te(_,d.adler>>>16),te(_,65535&d.adler)),A(d),0<_.wrap&&(_.wrap=-_.wrap),_.pending!==0?u:1)},r.deflateEnd=function(d){var W;return d&&d.state?(W=d.state.status)!==k&&W!==69&&W!==73&&W!==91&&W!==103&&W!==z&&W!==666?fe(d,b):(d.state=null,W===z?fe(d,-3):u):b},r.deflateSetDictionary=function(d,W){var $,_,w,T,j,q,O,V,se=W.length;if(!d||!d.state||(T=($=d.state).wrap)===2||T===1&&$.status!==k||$.lookahead)return b;for(T===1&&(d.adler=s(d.adler,W,se,0)),$.wrap=0,se>=$.w_size&&(T===0&&(ne($.head),$.strstart=0,$.block_start=0,$.insert=0),V=new a.Buf8($.w_size),a.arraySet(V,W,se-$.w_size,$.w_size,0),W=V,se=$.w_size),j=d.avail_in,q=d.next_in,O=d.input,d.avail_in=se,d.next_in=0,d.input=W,Be($);$.lookahead>=R;){for(_=$.strstart,w=$.lookahead-(R-1);$.ins_h=($.ins_h<<$.hash_shift^$.window[_+R-1])&$.hash_mask,$.prev[_&$.w_mask]=$.head[$.ins_h],$.head[$.ins_h]=_,_++,--w;);$.strstart=_,$.lookahead=R-1,Be($)}return $.strstart+=$.lookahead,$.block_start=$.strstart,$.insert=$.lookahead,$.lookahead=0,$.match_length=$.prev_length=R-1,$.match_available=0,d.next_in=q,d.input=O,d.avail_in=j,$.wrap=T,u},r.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(e,c,r){c.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(e,c,r){c.exports=function(t,a){var i,s,l,h,g,p,u,b,f,v,y,C,E,S,I,x,L,N,R,P,Q,k,z,m,H;i=t.state,s=t.next_in,m=t.input,l=s+(t.avail_in-5),h=t.next_out,H=t.output,g=h-(a-t.avail_out),p=h+(t.avail_out-257),u=i.dmax,b=i.wsize,f=i.whave,v=i.wnext,y=i.window,C=i.hold,E=i.bits,S=i.lencode,I=i.distcode,x=(1<<i.lenbits)-1,L=(1<<i.distbits)-1;e:do{E<15&&(C+=m[s++]<<E,E+=8,C+=m[s++]<<E,E+=8),N=S[C&x];t:for(;;){if(C>>>=R=N>>>24,E-=R,(R=N>>>16&255)===0)H[h++]=65535&N;else{if(!(16&R)){if(!(64&R)){N=S[(65535&N)+(C&(1<<R)-1)];continue t}if(32&R){i.mode=12;break e}t.msg="invalid literal/length code",i.mode=30;break e}P=65535&N,(R&=15)&&(E<R&&(C+=m[s++]<<E,E+=8),P+=C&(1<<R)-1,C>>>=R,E-=R),E<15&&(C+=m[s++]<<E,E+=8,C+=m[s++]<<E,E+=8),N=I[C&L];n:for(;;){if(C>>>=R=N>>>24,E-=R,!(16&(R=N>>>16&255))){if(!(64&R)){N=I[(65535&N)+(C&(1<<R)-1)];continue n}t.msg="invalid distance code",i.mode=30;break e}if(Q=65535&N,E<(R&=15)&&(C+=m[s++]<<E,(E+=8)<R&&(C+=m[s++]<<E,E+=8)),u<(Q+=C&(1<<R)-1)){t.msg="invalid distance too far back",i.mode=30;break e}if(C>>>=R,E-=R,(R=h-g)<Q){if(f<(R=Q-R)&&i.sane){t.msg="invalid distance too far back",i.mode=30;break e}if(z=y,(k=0)===v){if(k+=b-R,R<P){for(P-=R;H[h++]=y[k++],--R;);k=h-Q,z=H}}else if(v<R){if(k+=b+v-R,(R-=v)<P){for(P-=R;H[h++]=y[k++],--R;);if(k=0,v<P){for(P-=R=v;H[h++]=y[k++],--R;);k=h-Q,z=H}}}else if(k+=v-R,R<P){for(P-=R;H[h++]=y[k++],--R;);k=h-Q,z=H}for(;2<P;)H[h++]=z[k++],H[h++]=z[k++],H[h++]=z[k++],P-=3;P&&(H[h++]=z[k++],1<P&&(H[h++]=z[k++]))}else{for(k=h-Q;H[h++]=H[k++],H[h++]=H[k++],H[h++]=H[k++],2<(P-=3););P&&(H[h++]=H[k++],1<P&&(H[h++]=H[k++]))}break}}break}}while(s<l&&h<p);s-=P=E>>3,C&=(1<<(E-=P<<3))-1,t.next_in=s,t.next_out=h,t.avail_in=s<l?l-s+5:5-(s-l),t.avail_out=h<p?p-h+257:257-(h-p),i.hold=C,i.bits=E}},{}],49:[function(e,c,r){var t=e("../utils/common"),a=e("./adler32"),i=e("./crc32"),s=e("./inffast"),l=e("./inftrees"),h=1,g=2,p=0,u=-2,b=1,f=852,v=592;function y(k){return(k>>>24&255)+(k>>>8&65280)+((65280&k)<<8)+((255&k)<<24)}function C(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new t.Buf16(320),this.work=new t.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function E(k){var z;return k&&k.state?(z=k.state,k.total_in=k.total_out=z.total=0,k.msg="",z.wrap&&(k.adler=1&z.wrap),z.mode=b,z.last=0,z.havedict=0,z.dmax=32768,z.head=null,z.hold=0,z.bits=0,z.lencode=z.lendyn=new t.Buf32(f),z.distcode=z.distdyn=new t.Buf32(v),z.sane=1,z.back=-1,p):u}function S(k){var z;return k&&k.state?((z=k.state).wsize=0,z.whave=0,z.wnext=0,E(k)):u}function I(k,z){var m,H;return k&&k.state?(H=k.state,z<0?(m=0,z=-z):(m=1+(z>>4),z<48&&(z&=15)),z&&(z<8||15<z)?u:(H.window!==null&&H.wbits!==z&&(H.window=null),H.wrap=m,H.wbits=z,S(k))):u}function x(k,z){var m,H;return k?(H=new C,(k.state=H).window=null,(m=I(k,z))!==p&&(k.state=null),m):u}var L,N,R=!0;function P(k){if(R){var z;for(L=new t.Buf32(512),N=new t.Buf32(32),z=0;z<144;)k.lens[z++]=8;for(;z<256;)k.lens[z++]=9;for(;z<280;)k.lens[z++]=7;for(;z<288;)k.lens[z++]=8;for(l(h,k.lens,0,288,L,0,k.work,{bits:9}),z=0;z<32;)k.lens[z++]=5;l(g,k.lens,0,32,N,0,k.work,{bits:5}),R=!1}k.lencode=L,k.lenbits=9,k.distcode=N,k.distbits=5}function Q(k,z,m,H){var ue,Z=k.state;return Z.window===null&&(Z.wsize=1<<Z.wbits,Z.wnext=0,Z.whave=0,Z.window=new t.Buf8(Z.wsize)),H>=Z.wsize?(t.arraySet(Z.window,z,m-Z.wsize,Z.wsize,0),Z.wnext=0,Z.whave=Z.wsize):(H<(ue=Z.wsize-Z.wnext)&&(ue=H),t.arraySet(Z.window,z,m-H,ue,Z.wnext),(H-=ue)?(t.arraySet(Z.window,z,m-H,H,0),Z.wnext=H,Z.whave=Z.wsize):(Z.wnext+=ue,Z.wnext===Z.wsize&&(Z.wnext=0),Z.whave<Z.wsize&&(Z.whave+=ue))),0}r.inflateReset=S,r.inflateReset2=I,r.inflateResetKeep=E,r.inflateInit=function(k){return x(k,15)},r.inflateInit2=x,r.inflate=function(k,z){var m,H,ue,Z,fe,F,ne,A,M,re,te,Y,Be,Ne,pe,ve,Le,De,Je,Ye,d,W,$,_,w=0,T=new t.Buf8(4),j=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!k||!k.state||!k.output||!k.input&&k.avail_in!==0)return u;(m=k.state).mode===12&&(m.mode=13),fe=k.next_out,ue=k.output,ne=k.avail_out,Z=k.next_in,H=k.input,F=k.avail_in,A=m.hold,M=m.bits,re=F,te=ne,W=p;e:for(;;)switch(m.mode){case b:if(m.wrap===0){m.mode=13;break}for(;M<16;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}if(2&m.wrap&&A===35615){T[m.check=0]=255&A,T[1]=A>>>8&255,m.check=i(m.check,T,2,0),M=A=0,m.mode=2;break}if(m.flags=0,m.head&&(m.head.done=!1),!(1&m.wrap)||(((255&A)<<8)+(A>>8))%31){k.msg="incorrect header check",m.mode=30;break}if((15&A)!=8){k.msg="unknown compression method",m.mode=30;break}if(M-=4,d=8+(15&(A>>>=4)),m.wbits===0)m.wbits=d;else if(d>m.wbits){k.msg="invalid window size",m.mode=30;break}m.dmax=1<<d,k.adler=m.check=1,m.mode=512&A?10:12,M=A=0;break;case 2:for(;M<16;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}if(m.flags=A,(255&m.flags)!=8){k.msg="unknown compression method",m.mode=30;break}if(57344&m.flags){k.msg="unknown header flags set",m.mode=30;break}m.head&&(m.head.text=A>>8&1),512&m.flags&&(T[0]=255&A,T[1]=A>>>8&255,m.check=i(m.check,T,2,0)),M=A=0,m.mode=3;case 3:for(;M<32;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}m.head&&(m.head.time=A),512&m.flags&&(T[0]=255&A,T[1]=A>>>8&255,T[2]=A>>>16&255,T[3]=A>>>24&255,m.check=i(m.check,T,4,0)),M=A=0,m.mode=4;case 4:for(;M<16;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}m.head&&(m.head.xflags=255&A,m.head.os=A>>8),512&m.flags&&(T[0]=255&A,T[1]=A>>>8&255,m.check=i(m.check,T,2,0)),M=A=0,m.mode=5;case 5:if(1024&m.flags){for(;M<16;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}m.length=A,m.head&&(m.head.extra_len=A),512&m.flags&&(T[0]=255&A,T[1]=A>>>8&255,m.check=i(m.check,T,2,0)),M=A=0}else m.head&&(m.head.extra=null);m.mode=6;case 6:if(1024&m.flags&&(F<(Y=m.length)&&(Y=F),Y&&(m.head&&(d=m.head.extra_len-m.length,m.head.extra||(m.head.extra=new Array(m.head.extra_len)),t.arraySet(m.head.extra,H,Z,Y,d)),512&m.flags&&(m.check=i(m.check,H,Y,Z)),F-=Y,Z+=Y,m.length-=Y),m.length))break e;m.length=0,m.mode=7;case 7:if(2048&m.flags){if(F===0)break e;for(Y=0;d=H[Z+Y++],m.head&&d&&m.length<65536&&(m.head.name+=String.fromCharCode(d)),d&&Y<F;);if(512&m.flags&&(m.check=i(m.check,H,Y,Z)),F-=Y,Z+=Y,d)break e}else m.head&&(m.head.name=null);m.length=0,m.mode=8;case 8:if(4096&m.flags){if(F===0)break e;for(Y=0;d=H[Z+Y++],m.head&&d&&m.length<65536&&(m.head.comment+=String.fromCharCode(d)),d&&Y<F;);if(512&m.flags&&(m.check=i(m.check,H,Y,Z)),F-=Y,Z+=Y,d)break e}else m.head&&(m.head.comment=null);m.mode=9;case 9:if(512&m.flags){for(;M<16;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}if(A!==(65535&m.check)){k.msg="header crc mismatch",m.mode=30;break}M=A=0}m.head&&(m.head.hcrc=m.flags>>9&1,m.head.done=!0),k.adler=m.check=0,m.mode=12;break;case 10:for(;M<32;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}k.adler=m.check=y(A),M=A=0,m.mode=11;case 11:if(m.havedict===0)return k.next_out=fe,k.avail_out=ne,k.next_in=Z,k.avail_in=F,m.hold=A,m.bits=M,2;k.adler=m.check=1,m.mode=12;case 12:if(z===5||z===6)break e;case 13:if(m.last){A>>>=7&M,M-=7&M,m.mode=27;break}for(;M<3;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}switch(m.last=1&A,M-=1,3&(A>>>=1)){case 0:m.mode=14;break;case 1:if(P(m),m.mode=20,z!==6)break;A>>>=2,M-=2;break e;case 2:m.mode=17;break;case 3:k.msg="invalid block type",m.mode=30}A>>>=2,M-=2;break;case 14:for(A>>>=7&M,M-=7&M;M<32;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}if((65535&A)!=(A>>>16^65535)){k.msg="invalid stored block lengths",m.mode=30;break}if(m.length=65535&A,M=A=0,m.mode=15,z===6)break e;case 15:m.mode=16;case 16:if(Y=m.length){if(F<Y&&(Y=F),ne<Y&&(Y=ne),Y===0)break e;t.arraySet(ue,H,Z,Y,fe),F-=Y,Z+=Y,ne-=Y,fe+=Y,m.length-=Y;break}m.mode=12;break;case 17:for(;M<14;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}if(m.nlen=257+(31&A),A>>>=5,M-=5,m.ndist=1+(31&A),A>>>=5,M-=5,m.ncode=4+(15&A),A>>>=4,M-=4,286<m.nlen||30<m.ndist){k.msg="too many length or distance symbols",m.mode=30;break}m.have=0,m.mode=18;case 18:for(;m.have<m.ncode;){for(;M<3;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}m.lens[j[m.have++]]=7&A,A>>>=3,M-=3}for(;m.have<19;)m.lens[j[m.have++]]=0;if(m.lencode=m.lendyn,m.lenbits=7,$={bits:m.lenbits},W=l(0,m.lens,0,19,m.lencode,0,m.work,$),m.lenbits=$.bits,W){k.msg="invalid code lengths set",m.mode=30;break}m.have=0,m.mode=19;case 19:for(;m.have<m.nlen+m.ndist;){for(;ve=(w=m.lencode[A&(1<<m.lenbits)-1])>>>16&255,Le=65535&w,!((pe=w>>>24)<=M);){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}if(Le<16)A>>>=pe,M-=pe,m.lens[m.have++]=Le;else{if(Le===16){for(_=pe+2;M<_;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}if(A>>>=pe,M-=pe,m.have===0){k.msg="invalid bit length repeat",m.mode=30;break}d=m.lens[m.have-1],Y=3+(3&A),A>>>=2,M-=2}else if(Le===17){for(_=pe+3;M<_;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}M-=pe,d=0,Y=3+(7&(A>>>=pe)),A>>>=3,M-=3}else{for(_=pe+7;M<_;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}M-=pe,d=0,Y=11+(127&(A>>>=pe)),A>>>=7,M-=7}if(m.have+Y>m.nlen+m.ndist){k.msg="invalid bit length repeat",m.mode=30;break}for(;Y--;)m.lens[m.have++]=d}}if(m.mode===30)break;if(m.lens[256]===0){k.msg="invalid code -- missing end-of-block",m.mode=30;break}if(m.lenbits=9,$={bits:m.lenbits},W=l(h,m.lens,0,m.nlen,m.lencode,0,m.work,$),m.lenbits=$.bits,W){k.msg="invalid literal/lengths set",m.mode=30;break}if(m.distbits=6,m.distcode=m.distdyn,$={bits:m.distbits},W=l(g,m.lens,m.nlen,m.ndist,m.distcode,0,m.work,$),m.distbits=$.bits,W){k.msg="invalid distances set",m.mode=30;break}if(m.mode=20,z===6)break e;case 20:m.mode=21;case 21:if(6<=F&&258<=ne){k.next_out=fe,k.avail_out=ne,k.next_in=Z,k.avail_in=F,m.hold=A,m.bits=M,s(k,te),fe=k.next_out,ue=k.output,ne=k.avail_out,Z=k.next_in,H=k.input,F=k.avail_in,A=m.hold,M=m.bits,m.mode===12&&(m.back=-1);break}for(m.back=0;ve=(w=m.lencode[A&(1<<m.lenbits)-1])>>>16&255,Le=65535&w,!((pe=w>>>24)<=M);){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}if(ve&&!(240&ve)){for(De=pe,Je=ve,Ye=Le;ve=(w=m.lencode[Ye+((A&(1<<De+Je)-1)>>De)])>>>16&255,Le=65535&w,!(De+(pe=w>>>24)<=M);){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}A>>>=De,M-=De,m.back+=De}if(A>>>=pe,M-=pe,m.back+=pe,m.length=Le,ve===0){m.mode=26;break}if(32&ve){m.back=-1,m.mode=12;break}if(64&ve){k.msg="invalid literal/length code",m.mode=30;break}m.extra=15&ve,m.mode=22;case 22:if(m.extra){for(_=m.extra;M<_;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}m.length+=A&(1<<m.extra)-1,A>>>=m.extra,M-=m.extra,m.back+=m.extra}m.was=m.length,m.mode=23;case 23:for(;ve=(w=m.distcode[A&(1<<m.distbits)-1])>>>16&255,Le=65535&w,!((pe=w>>>24)<=M);){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}if(!(240&ve)){for(De=pe,Je=ve,Ye=Le;ve=(w=m.distcode[Ye+((A&(1<<De+Je)-1)>>De)])>>>16&255,Le=65535&w,!(De+(pe=w>>>24)<=M);){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}A>>>=De,M-=De,m.back+=De}if(A>>>=pe,M-=pe,m.back+=pe,64&ve){k.msg="invalid distance code",m.mode=30;break}m.offset=Le,m.extra=15&ve,m.mode=24;case 24:if(m.extra){for(_=m.extra;M<_;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}m.offset+=A&(1<<m.extra)-1,A>>>=m.extra,M-=m.extra,m.back+=m.extra}if(m.offset>m.dmax){k.msg="invalid distance too far back",m.mode=30;break}m.mode=25;case 25:if(ne===0)break e;if(Y=te-ne,m.offset>Y){if((Y=m.offset-Y)>m.whave&&m.sane){k.msg="invalid distance too far back",m.mode=30;break}Be=Y>m.wnext?(Y-=m.wnext,m.wsize-Y):m.wnext-Y,Y>m.length&&(Y=m.length),Ne=m.window}else Ne=ue,Be=fe-m.offset,Y=m.length;for(ne<Y&&(Y=ne),ne-=Y,m.length-=Y;ue[fe++]=Ne[Be++],--Y;);m.length===0&&(m.mode=21);break;case 26:if(ne===0)break e;ue[fe++]=m.length,ne--,m.mode=21;break;case 27:if(m.wrap){for(;M<32;){if(F===0)break e;F--,A|=H[Z++]<<M,M+=8}if(te-=ne,k.total_out+=te,m.total+=te,te&&(k.adler=m.check=m.flags?i(m.check,ue,te,fe-te):a(m.check,ue,te,fe-te)),te=ne,(m.flags?A:y(A))!==m.check){k.msg="incorrect data check",m.mode=30;break}M=A=0}m.mode=28;case 28:if(m.wrap&&m.flags){for(;M<32;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}if(A!==(4294967295&m.total)){k.msg="incorrect length check",m.mode=30;break}M=A=0}m.mode=29;case 29:W=1;break e;case 30:W=-3;break e;case 31:return-4;case 32:default:return u}return k.next_out=fe,k.avail_out=ne,k.next_in=Z,k.avail_in=F,m.hold=A,m.bits=M,(m.wsize||te!==k.avail_out&&m.mode<30&&(m.mode<27||z!==4))&&Q(k,k.output,k.next_out,te-k.avail_out)?(m.mode=31,-4):(re-=k.avail_in,te-=k.avail_out,k.total_in+=re,k.total_out+=te,m.total+=te,m.wrap&&te&&(k.adler=m.check=m.flags?i(m.check,ue,te,k.next_out-te):a(m.check,ue,te,k.next_out-te)),k.data_type=m.bits+(m.last?64:0)+(m.mode===12?128:0)+(m.mode===20||m.mode===15?256:0),(re==0&&te===0||z===4)&&W===p&&(W=-5),W)},r.inflateEnd=function(k){if(!k||!k.state)return u;var z=k.state;return z.window&&(z.window=null),k.state=null,p},r.inflateGetHeader=function(k,z){var m;return k&&k.state&&2&(m=k.state).wrap?((m.head=z).done=!1,p):u},r.inflateSetDictionary=function(k,z){var m,H=z.length;return k&&k.state?(m=k.state).wrap!==0&&m.mode!==11?u:m.mode===11&&a(1,z,H,0)!==m.check?-3:Q(k,z,H,H)?(m.mode=31,-4):(m.havedict=1,p):u},r.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(e,c,r){var t=e("../utils/common"),a=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],i=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],s=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],l=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];c.exports=function(h,g,p,u,b,f,v,y){var C,E,S,I,x,L,N,R,P,Q=y.bits,k=0,z=0,m=0,H=0,ue=0,Z=0,fe=0,F=0,ne=0,A=0,M=null,re=0,te=new t.Buf16(16),Y=new t.Buf16(16),Be=null,Ne=0;for(k=0;k<=15;k++)te[k]=0;for(z=0;z<u;z++)te[g[p+z]]++;for(ue=Q,H=15;1<=H&&te[H]===0;H--);if(H<ue&&(ue=H),H===0)return b[f++]=20971520,b[f++]=20971520,y.bits=1,0;for(m=1;m<H&&te[m]===0;m++);for(ue<m&&(ue=m),k=F=1;k<=15;k++)if(F<<=1,(F-=te[k])<0)return-1;if(0<F&&(h===0||H!==1))return-1;for(Y[1]=0,k=1;k<15;k++)Y[k+1]=Y[k]+te[k];for(z=0;z<u;z++)g[p+z]!==0&&(v[Y[g[p+z]]++]=z);if(L=h===0?(M=Be=v,19):h===1?(M=a,re-=257,Be=i,Ne-=257,256):(M=s,Be=l,-1),k=m,x=f,fe=z=A=0,S=-1,I=(ne=1<<(Z=ue))-1,h===1&&852<ne||h===2&&592<ne)return 1;for(;;){for(N=k-fe,P=v[z]<L?(R=0,v[z]):v[z]>L?(R=Be[Ne+v[z]],M[re+v[z]]):(R=96,0),C=1<<k-fe,m=E=1<<Z;b[x+(A>>fe)+(E-=C)]=N<<24|R<<16|P|0,E!==0;);for(C=1<<k-1;A&C;)C>>=1;if(C!==0?(A&=C-1,A+=C):A=0,z++,--te[k]==0){if(k===H)break;k=g[p+v[z]]}if(ue<k&&(A&I)!==S){for(fe===0&&(fe=ue),x+=m,F=1<<(Z=k-fe);Z+fe<H&&!((F-=te[Z+fe])<=0);)Z++,F<<=1;if(ne+=1<<Z,h===1&&852<ne||h===2&&592<ne)return 1;b[S=A&I]=ue<<24|Z<<16|x-f|0}}return A!==0&&(b[x+A]=k-fe<<24|64<<16|0),y.bits=ue,0}},{"../utils/common":41}],51:[function(e,c,r){c.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(e,c,r){var t=e("../utils/common"),a=0,i=1;function s(w){for(var T=w.length;0<=--T;)w[T]=0}var l=0,h=29,g=256,p=g+1+h,u=30,b=19,f=2*p+1,v=15,y=16,C=7,E=256,S=16,I=17,x=18,L=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],N=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],R=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],P=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Q=new Array(2*(p+2));s(Q);var k=new Array(2*u);s(k);var z=new Array(512);s(z);var m=new Array(256);s(m);var H=new Array(h);s(H);var ue,Z,fe,F=new Array(u);function ne(w,T,j,q,O){this.static_tree=w,this.extra_bits=T,this.extra_base=j,this.elems=q,this.max_length=O,this.has_stree=w&&w.length}function A(w,T){this.dyn_tree=w,this.max_code=0,this.stat_desc=T}function M(w){return w<256?z[w]:z[256+(w>>>7)]}function re(w,T){w.pending_buf[w.pending++]=255&T,w.pending_buf[w.pending++]=T>>>8&255}function te(w,T,j){w.bi_valid>y-j?(w.bi_buf|=T<<w.bi_valid&65535,re(w,w.bi_buf),w.bi_buf=T>>y-w.bi_valid,w.bi_valid+=j-y):(w.bi_buf|=T<<w.bi_valid&65535,w.bi_valid+=j)}function Y(w,T,j){te(w,j[2*T],j[2*T+1])}function Be(w,T){for(var j=0;j|=1&w,w>>>=1,j<<=1,0<--T;);return j>>>1}function Ne(w,T,j){var q,O,V=new Array(v+1),se=0;for(q=1;q<=v;q++)V[q]=se=se+j[q-1]<<1;for(O=0;O<=T;O++){var J=w[2*O+1];J!==0&&(w[2*O]=Be(V[J]++,J))}}function pe(w){var T;for(T=0;T<p;T++)w.dyn_ltree[2*T]=0;for(T=0;T<u;T++)w.dyn_dtree[2*T]=0;for(T=0;T<b;T++)w.bl_tree[2*T]=0;w.dyn_ltree[2*E]=1,w.opt_len=w.static_len=0,w.last_lit=w.matches=0}function ve(w){8<w.bi_valid?re(w,w.bi_buf):0<w.bi_valid&&(w.pending_buf[w.pending++]=w.bi_buf),w.bi_buf=0,w.bi_valid=0}function Le(w,T,j,q){var O=2*T,V=2*j;return w[O]<w[V]||w[O]===w[V]&&q[T]<=q[j]}function De(w,T,j){for(var q=w.heap[j],O=j<<1;O<=w.heap_len&&(O<w.heap_len&&Le(T,w.heap[O+1],w.heap[O],w.depth)&&O++,!Le(T,q,w.heap[O],w.depth));)w.heap[j]=w.heap[O],j=O,O<<=1;w.heap[j]=q}function Je(w,T,j){var q,O,V,se,J=0;if(w.last_lit!==0)for(;q=w.pending_buf[w.d_buf+2*J]<<8|w.pending_buf[w.d_buf+2*J+1],O=w.pending_buf[w.l_buf+J],J++,q===0?Y(w,O,T):(Y(w,(V=m[O])+g+1,T),(se=L[V])!==0&&te(w,O-=H[V],se),Y(w,V=M(--q),j),(se=N[V])!==0&&te(w,q-=F[V],se)),J<w.last_lit;);Y(w,E,T)}function Ye(w,T){var j,q,O,V=T.dyn_tree,se=T.stat_desc.static_tree,J=T.stat_desc.has_stree,le=T.stat_desc.elems,Ie=-1;for(w.heap_len=0,w.heap_max=f,j=0;j<le;j++)V[2*j]!==0?(w.heap[++w.heap_len]=Ie=j,w.depth[j]=0):V[2*j+1]=0;for(;w.heap_len<2;)V[2*(O=w.heap[++w.heap_len]=Ie<2?++Ie:0)]=1,w.depth[O]=0,w.opt_len--,J&&(w.static_len-=se[2*O+1]);for(T.max_code=Ie,j=w.heap_len>>1;1<=j;j--)De(w,V,j);for(O=le;j=w.heap[1],w.heap[1]=w.heap[w.heap_len--],De(w,V,1),q=w.heap[1],w.heap[--w.heap_max]=j,w.heap[--w.heap_max]=q,V[2*O]=V[2*j]+V[2*q],w.depth[O]=(w.depth[j]>=w.depth[q]?w.depth[j]:w.depth[q])+1,V[2*j+1]=V[2*q+1]=O,w.heap[1]=O++,De(w,V,1),2<=w.heap_len;);w.heap[--w.heap_max]=w.heap[1],function(me,Ue){var St,Ge,ft,Ae,It,Pt,et=Ue.dyn_tree,ln=Ue.max_code,Un=Ue.stat_desc.static_tree,dt=Ue.stat_desc.has_stree,dn=Ue.stat_desc.extra_bits,xt=Ue.stat_desc.extra_base,yt=Ue.stat_desc.max_length,vt=0;for(Ae=0;Ae<=v;Ae++)me.bl_count[Ae]=0;for(et[2*me.heap[me.heap_max]+1]=0,St=me.heap_max+1;St<f;St++)yt<(Ae=et[2*et[2*(Ge=me.heap[St])+1]+1]+1)&&(Ae=yt,vt++),et[2*Ge+1]=Ae,ln<Ge||(me.bl_count[Ae]++,It=0,xt<=Ge&&(It=dn[Ge-xt]),Pt=et[2*Ge],me.opt_len+=Pt*(Ae+It),dt&&(me.static_len+=Pt*(Un[2*Ge+1]+It)));if(vt!==0){do{for(Ae=yt-1;me.bl_count[Ae]===0;)Ae--;me.bl_count[Ae]--,me.bl_count[Ae+1]+=2,me.bl_count[yt]--,vt-=2}while(0<vt);for(Ae=yt;Ae!==0;Ae--)for(Ge=me.bl_count[Ae];Ge!==0;)ln<(ft=me.heap[--St])||(et[2*ft+1]!==Ae&&(me.opt_len+=(Ae-et[2*ft+1])*et[2*ft],et[2*ft+1]=Ae),Ge--)}}(w,T),Ne(V,Ie,w.bl_count)}function d(w,T,j){var q,O,V=-1,se=T[1],J=0,le=7,Ie=4;for(se===0&&(le=138,Ie=3),T[2*(j+1)+1]=65535,q=0;q<=j;q++)O=se,se=T[2*(q+1)+1],++J<le&&O===se||(J<Ie?w.bl_tree[2*O]+=J:O!==0?(O!==V&&w.bl_tree[2*O]++,w.bl_tree[2*S]++):J<=10?w.bl_tree[2*I]++:w.bl_tree[2*x]++,V=O,Ie=(J=0)===se?(le=138,3):O===se?(le=6,3):(le=7,4))}function W(w,T,j){var q,O,V=-1,se=T[1],J=0,le=7,Ie=4;for(se===0&&(le=138,Ie=3),q=0;q<=j;q++)if(O=se,se=T[2*(q+1)+1],!(++J<le&&O===se)){if(J<Ie)for(;Y(w,O,w.bl_tree),--J!=0;);else O!==0?(O!==V&&(Y(w,O,w.bl_tree),J--),Y(w,S,w.bl_tree),te(w,J-3,2)):J<=10?(Y(w,I,w.bl_tree),te(w,J-3,3)):(Y(w,x,w.bl_tree),te(w,J-11,7));V=O,Ie=(J=0)===se?(le=138,3):O===se?(le=6,3):(le=7,4)}}s(F);var $=!1;function _(w,T,j,q){te(w,(l<<1)+(q?1:0),3),function(O,V,se,J){ve(O),re(O,se),re(O,~se),t.arraySet(O.pending_buf,O.window,V,se,O.pending),O.pending+=se}(w,T,j)}r._tr_init=function(w){$||(function(){var T,j,q,O,V,se=new Array(v+1);for(O=q=0;O<h-1;O++)for(H[O]=q,T=0;T<1<<L[O];T++)m[q++]=O;for(m[q-1]=O,O=V=0;O<16;O++)for(F[O]=V,T=0;T<1<<N[O];T++)z[V++]=O;for(V>>=7;O<u;O++)for(F[O]=V<<7,T=0;T<1<<N[O]-7;T++)z[256+V++]=O;for(j=0;j<=v;j++)se[j]=0;for(T=0;T<=143;)Q[2*T+1]=8,T++,se[8]++;for(;T<=255;)Q[2*T+1]=9,T++,se[9]++;for(;T<=279;)Q[2*T+1]=7,T++,se[7]++;for(;T<=287;)Q[2*T+1]=8,T++,se[8]++;for(Ne(Q,p+1,se),T=0;T<u;T++)k[2*T+1]=5,k[2*T]=Be(T,5);ue=new ne(Q,L,g+1,p,v),Z=new ne(k,N,0,u,v),fe=new ne(new Array(0),R,0,b,C)}(),$=!0),w.l_desc=new A(w.dyn_ltree,ue),w.d_desc=new A(w.dyn_dtree,Z),w.bl_desc=new A(w.bl_tree,fe),w.bi_buf=0,w.bi_valid=0,pe(w)},r._tr_stored_block=_,r._tr_flush_block=function(w,T,j,q){var O,V,se=0;0<w.level?(w.strm.data_type===2&&(w.strm.data_type=function(J){var le,Ie=4093624447;for(le=0;le<=31;le++,Ie>>>=1)if(1&Ie&&J.dyn_ltree[2*le]!==0)return a;if(J.dyn_ltree[18]!==0||J.dyn_ltree[20]!==0||J.dyn_ltree[26]!==0)return i;for(le=32;le<g;le++)if(J.dyn_ltree[2*le]!==0)return i;return a}(w)),Ye(w,w.l_desc),Ye(w,w.d_desc),se=function(J){var le;for(d(J,J.dyn_ltree,J.l_desc.max_code),d(J,J.dyn_dtree,J.d_desc.max_code),Ye(J,J.bl_desc),le=b-1;3<=le&&J.bl_tree[2*P[le]+1]===0;le--);return J.opt_len+=3*(le+1)+5+5+4,le}(w),O=w.opt_len+3+7>>>3,(V=w.static_len+3+7>>>3)<=O&&(O=V)):O=V=j+5,j+4<=O&&T!==-1?_(w,T,j,q):w.strategy===4||V===O?(te(w,2+(q?1:0),3),Je(w,Q,k)):(te(w,4+(q?1:0),3),function(J,le,Ie,me){var Ue;for(te(J,le-257,5),te(J,Ie-1,5),te(J,me-4,4),Ue=0;Ue<me;Ue++)te(J,J.bl_tree[2*P[Ue]+1],3);W(J,J.dyn_ltree,le-1),W(J,J.dyn_dtree,Ie-1)}(w,w.l_desc.max_code+1,w.d_desc.max_code+1,se+1),Je(w,w.dyn_ltree,w.dyn_dtree)),pe(w),q&&ve(w)},r._tr_tally=function(w,T,j){return w.pending_buf[w.d_buf+2*w.last_lit]=T>>>8&255,w.pending_buf[w.d_buf+2*w.last_lit+1]=255&T,w.pending_buf[w.l_buf+w.last_lit]=255&j,w.last_lit++,T===0?w.dyn_ltree[2*j]++:(w.matches++,T--,w.dyn_ltree[2*(m[j]+g+1)]++,w.dyn_dtree[2*M(T)]++),w.last_lit===w.lit_bufsize-1},r._tr_align=function(w){te(w,2,3),Y(w,E,Q),function(T){T.bi_valid===16?(re(T,T.bi_buf),T.bi_buf=0,T.bi_valid=0):8<=T.bi_valid&&(T.pending_buf[T.pending++]=255&T.bi_buf,T.bi_buf>>=8,T.bi_valid-=8)}(w)}},{"../utils/common":41}],53:[function(e,c,r){c.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(e,c,r){(function(t){(function(a,i){if(!a.setImmediate){var s,l,h,g,p=1,u={},b=!1,f=a.document,v=Object.getPrototypeOf&&Object.getPrototypeOf(a);v=v&&v.setTimeout?v:a,s={}.toString.call(a.process)==="[object process]"?function(S){process.nextTick(function(){C(S)})}:function(){if(a.postMessage&&!a.importScripts){var S=!0,I=a.onmessage;return a.onmessage=function(){S=!1},a.postMessage("","*"),a.onmessage=I,S}}()?(g="setImmediate$"+Math.random()+"$",a.addEventListener?a.addEventListener("message",E,!1):a.attachEvent("onmessage",E),function(S){a.postMessage(g+S,"*")}):a.MessageChannel?((h=new MessageChannel).port1.onmessage=function(S){C(S.data)},function(S){h.port2.postMessage(S)}):f&&"onreadystatechange"in f.createElement("script")?(l=f.documentElement,function(S){var I=f.createElement("script");I.onreadystatechange=function(){C(S),I.onreadystatechange=null,l.removeChild(I),I=null},l.appendChild(I)}):function(S){setTimeout(C,0,S)},v.setImmediate=function(S){typeof S!="function"&&(S=new Function(""+S));for(var I=new Array(arguments.length-1),x=0;x<I.length;x++)I[x]=arguments[x+1];var L={callback:S,args:I};return u[p]=L,s(p),p++},v.clearImmediate=y}function y(S){delete u[S]}function C(S){if(b)setTimeout(C,0,S);else{var I=u[S];if(I){b=!0;try{(function(x){var L=x.callback,N=x.args;switch(N.length){case 0:L();break;case 1:L(N[0]);break;case 2:L(N[0],N[1]);break;case 3:L(N[0],N[1],N[2]);break;default:L.apply(i,N)}})(I)}finally{y(S),b=!1}}}}function E(S){S.source===a&&typeof S.data=="string"&&S.data.indexOf(g)===0&&C(+S.data.slice(g.length))}})(typeof self>"u"?t===void 0?this:t:self)}).call(this,typeof mn<"u"?mn:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(js);var Gi=js.exports;const hs=Us(Gi);var Zs={exports:{}};(function(n){var o=function(){var e=String.fromCharCode,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",t={};function a(s,l){if(!t[s]){t[s]={};for(var h=0;h<s.length;h++)t[s][s.charAt(h)]=h}return t[s][l]}var i={compressToBase64:function(s){if(s==null)return"";var l=i._compress(s,6,function(h){return c.charAt(h)});switch(l.length%4){default:case 0:return l;case 1:return l+"===";case 2:return l+"==";case 3:return l+"="}},decompressFromBase64:function(s){return s==null?"":s==""?null:i._decompress(s.length,32,function(l){return a(c,s.charAt(l))})},compressToUTF16:function(s){return s==null?"":i._compress(s,15,function(l){return e(l+32)})+" "},decompressFromUTF16:function(s){return s==null?"":s==""?null:i._decompress(s.length,16384,function(l){return s.charCodeAt(l)-32})},compressToUint8Array:function(s){for(var l=i.compress(s),h=new Uint8Array(l.length*2),g=0,p=l.length;g<p;g++){var u=l.charCodeAt(g);h[g*2]=u>>>8,h[g*2+1]=u%256}return h},decompressFromUint8Array:function(s){if(s==null)return i.decompress(s);for(var l=new Array(s.length/2),h=0,g=l.length;h<g;h++)l[h]=s[h*2]*256+s[h*2+1];var p=[];return l.forEach(function(u){p.push(e(u))}),i.decompress(p.join(""))},compressToEncodedURIComponent:function(s){return s==null?"":i._compress(s,6,function(l){return r.charAt(l)})},decompressFromEncodedURIComponent:function(s){return s==null?"":s==""?null:(s=s.replace(/ /g,"+"),i._decompress(s.length,32,function(l){return a(r,s.charAt(l))}))},compress:function(s){return i._compress(s,16,function(l){return e(l)})},_compress:function(s,l,h){if(s==null)return"";var g,p,u={},b={},f="",v="",y="",C=2,E=3,S=2,I=[],x=0,L=0,N;for(N=0;N<s.length;N+=1)if(f=s.charAt(N),Object.prototype.hasOwnProperty.call(u,f)||(u[f]=E++,b[f]=!0),v=y+f,Object.prototype.hasOwnProperty.call(u,v))y=v;else{if(Object.prototype.hasOwnProperty.call(b,y)){if(y.charCodeAt(0)<256){for(g=0;g<S;g++)x=x<<1,L==l-1?(L=0,I.push(h(x)),x=0):L++;for(p=y.charCodeAt(0),g=0;g<8;g++)x=x<<1|p&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,p=p>>1}else{for(p=1,g=0;g<S;g++)x=x<<1|p,L==l-1?(L=0,I.push(h(x)),x=0):L++,p=0;for(p=y.charCodeAt(0),g=0;g<16;g++)x=x<<1|p&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,p=p>>1}C--,C==0&&(C=Math.pow(2,S),S++),delete b[y]}else for(p=u[y],g=0;g<S;g++)x=x<<1|p&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,p=p>>1;C--,C==0&&(C=Math.pow(2,S),S++),u[v]=E++,y=String(f)}if(y!==""){if(Object.prototype.hasOwnProperty.call(b,y)){if(y.charCodeAt(0)<256){for(g=0;g<S;g++)x=x<<1,L==l-1?(L=0,I.push(h(x)),x=0):L++;for(p=y.charCodeAt(0),g=0;g<8;g++)x=x<<1|p&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,p=p>>1}else{for(p=1,g=0;g<S;g++)x=x<<1|p,L==l-1?(L=0,I.push(h(x)),x=0):L++,p=0;for(p=y.charCodeAt(0),g=0;g<16;g++)x=x<<1|p&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,p=p>>1}C--,C==0&&(C=Math.pow(2,S),S++),delete b[y]}else for(p=u[y],g=0;g<S;g++)x=x<<1|p&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,p=p>>1;C--,C==0&&(C=Math.pow(2,S),S++)}for(p=2,g=0;g<S;g++)x=x<<1|p&1,L==l-1?(L=0,I.push(h(x)),x=0):L++,p=p>>1;for(;;)if(x=x<<1,L==l-1){I.push(h(x));break}else L++;return I.join("")},decompress:function(s){return s==null?"":s==""?null:i._decompress(s.length,32768,function(l){return s.charCodeAt(l)})},_decompress:function(s,l,h){var g=[],p=4,u=4,b=3,f="",v=[],y,C,E,S,I,x,L,N={val:h(0),position:l,index:1};for(y=0;y<3;y+=1)g[y]=y;for(E=0,I=Math.pow(2,2),x=1;x!=I;)S=N.val&N.position,N.position>>=1,N.position==0&&(N.position=l,N.val=h(N.index++)),E|=(S>0?1:0)*x,x<<=1;switch(E){case 0:for(E=0,I=Math.pow(2,8),x=1;x!=I;)S=N.val&N.position,N.position>>=1,N.position==0&&(N.position=l,N.val=h(N.index++)),E|=(S>0?1:0)*x,x<<=1;L=e(E);break;case 1:for(E=0,I=Math.pow(2,16),x=1;x!=I;)S=N.val&N.position,N.position>>=1,N.position==0&&(N.position=l,N.val=h(N.index++)),E|=(S>0?1:0)*x,x<<=1;L=e(E);break;case 2:return""}for(g[3]=L,C=L,v.push(L);;){if(N.index>s)return"";for(E=0,I=Math.pow(2,b),x=1;x!=I;)S=N.val&N.position,N.position>>=1,N.position==0&&(N.position=l,N.val=h(N.index++)),E|=(S>0?1:0)*x,x<<=1;switch(L=E){case 0:for(E=0,I=Math.pow(2,8),x=1;x!=I;)S=N.val&N.position,N.position>>=1,N.position==0&&(N.position=l,N.val=h(N.index++)),E|=(S>0?1:0)*x,x<<=1;g[u++]=e(E),L=u-1,p--;break;case 1:for(E=0,I=Math.pow(2,16),x=1;x!=I;)S=N.val&N.position,N.position>>=1,N.position==0&&(N.position=l,N.val=h(N.index++)),E|=(S>0?1:0)*x,x<<=1;g[u++]=e(E),L=u-1,p--;break;case 2:return v.join("")}if(p==0&&(p=Math.pow(2,b),b++),g[L])f=g[L];else if(L===u)f=C+C.charAt(0);else return null;v.push(f),g[u++]=C+f.charAt(0),p--,C=f,p==0&&(p=Math.pow(2,b),b++)}}};return i}();n!=null?n.exports=o:typeof angular<"u"&&angular!=null&&angular.module("LZString",[]).factory("LZString",function(){return o})})(Zs);var Vi=Zs.exports;const qs=Us(Vi);function Ki(n){return new Worker("/assets/compression.worker-B3kqe_bR.js",{name:n==null?void 0:n.name})}let oe={},D=null,ps=null,K=null,_e=null,en=null,Fn=null,gs=[],Sn=null,ys=null,Ve=null,In=0,vs=0,xn=0,bs=0,Cs=null,ws=null,Ln=null,pt=null,je=-1,_s=null,Tn=null,Bn=null,Gs=null,Vs=null,ot=!1,ge=[],rt=[],Et=[],qe={isScreenSaverEnabled:!0,lastRestoreTimestamp:null,lastBackupTimestamp:null},Tt=null;const Es=new Ki;Es.onmessage=n=>{const o=n.data;try{localStorage.setItem("teacherAssistantData_v2",o),console.log("Background save complete.")}catch(e){console.error("Background storage failed:",e)}};Es.onerror=n=>{console.error("❌ Worker Communication Error:",n.message,n)};function ce(n=!1){if(ot)return;const e=JSON.stringify({classrooms:oe,trashBin:ge,userSettings:qe});if(n){Tt&&clearTimeout(Tt);try{const c=qs.compressToUTF16(e);localStorage.setItem("teacherAssistantData_v2",c),console.log("Immediate save complete.")}catch(c){console.error("Immediate save failed:",c)}return}Tt&&clearTimeout(Tt),Tt=setTimeout(()=>{Es.postMessage(e),Tt=null},500)}function Ji(n){return new Promise((o,e)=>{const c=new FileReader;c.onerror=e,c.onload=()=>{o(c.result.split(",")[1])},c.readAsDataURL(n)})}async function Ks(n=[]){const o={};if(n.length>0)n.forEach(l=>{oe[l]&&(o[l]=oe[l])});else for(const l in oe)oe[l].isDeleted||(o[l]=oe[l]);const e={metadata:{version:"2.0-b64",createdAt:new Date().toISOString()},data:{classrooms:o,trashBin:ge}},c=JSON.stringify(e),r=new Date,t=new Intl.DateTimeFormat("fa-IR-u-nu-latn",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(r).reduce((l,h)=>(l[h.type]=h.value,l),{}),i=`${t.year.slice(-2)}-${t.month}-${t.day}_${t.hour}-${t.minute}`;let s;n.length===0?s=`SP_Full_${i}.txt`:n.length===1?s=`SP_${n[0].replace(/[<>:"/\\|?*]/g,"").replace(/\s+/g,"_")}_${i}.txt`:s=`SP_Selected-${n.length}_${i}.txt`;try{const l=new hs;l.file("backup.json",c);const h=await l.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:9}}),g=await Ji(h);return new File([g],s,{type:"text/plain"})}catch(l){return console.error("Error creating base64 backup file:",l),null}}function Dn(){const n=localStorage.getItem("teacherAssistantData_v2");if(!n)return;let o;try{const e=qs.decompressFromUTF16(n);e?o=JSON.parse(e):o=JSON.parse(n)}catch{console.log("Migration: Parsing legacy uncompressed data..."),o=JSON.parse(n)}o.classrooms!==void 0&&o.trashBin!==void 0?(kt(o.classrooms),ge=o.trashBin||[],qe={...qe,...o.userSettings}):(kt(o),Yi())}function Yi(){const n=[];Object.values(oe).forEach(o=>{o.isDeleted?n.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:o.info.creationDate,type:"classroom",description:`کلاس «${o.info.name}»`,restoreData:{name:o.info.name}}):o.students.forEach(e=>{e.isDeleted&&n.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:e.identity.studentId.split("_")[1],type:"student",description:`دانش‌آموز «${e.identity.name}»`,restoreData:{studentId:e.identity.studentId,classroomName:o.info.name}})})}),ge.length===0&&n.length>0&&(ge=n,console.log(`Migrated ${n.length} previously deleted item(s) to the new trash bin.`),ce())}function Js(n){const o=new pn(n.identity);return o.isDeleted=n.isDeleted,o.statusCounters=n.statusCounters,o.logs=n.logs,o.logs.scores||(o.logs.scores={}),o.profile=n.profile,o.finalClassActivityScore=n.finalClassActivityScore,o.categoryCounts=n.categoryCounts||{},o.categoryIssues=n.categoryIssues||{},o.onboardingSession=n.onboardingSession||null,o}function kt(n){oe={};for(const o in n){const e=n[o];let c;e.info?c=e.info:c={...e,name:o};const r=new Kn(c);r.isDeleted=e.isDeleted,r.note=e.note||"",r.students=(e.students||[]).map(Js),r.sessions=(e.sessions||[]).map(t=>{const a=new Ws(t.sessionNumber);a.isDeleted=t.isDeleted,a.note=t.note||"",a.startTime=new Date(t.startTime),a.endTime=t.endTime?new Date(t.endTime):null,a.isFinished=t.isFinished,a.isMakeup=t.isMakeup,a.isCancelled=t.isCancelled||!1,a.studentRecords=t.studentRecords;for(const s in a.studentRecords){const l=a.studentRecords[s];l.homework&&!(l.homework instanceof Vn)&&(a.studentRecords[s].homework=new Vn(l.homework.status,l.homework.comment))}a.lastWinnerByCategory=t.lastWinnerByCategory,a.lastUsedCategoryId=t.lastUsedCategoryId,a.lastSelectedWinnerId=t.lastSelectedWinnerId;const i=t.winnerHistory||[];return a.winnerHistory=i.filter(s=>s&&s.winner).map(s=>({winner:r.students.find(h=>h.identity.studentId===s.winner.identity.studentId),categoryName:s.categoryName})).filter(s=>s.winner),a}),r.categories=(e.categories||[]).map(t=>{const a=new ut(t.name,t.description,t.isGradedCategory);return a.id=t.id,a.isDeleted=t.isDeleted,a}),r.futurePlans=e.futurePlans,oe[o]=r}}function Ys(n,o){if(o){const e=n.data.classrooms;for(let c in e){let r=c;const t=e[c];for(;oe[r];)r=`${r} (Restored)`;r!==c&&(t.info.name=r),oe[r]=t}if(n.data.trashBin){const c=[...ge,...n.data.trashBin],r=[...new Map(c.map(t=>[t.id,t])).values()];Rn(r)}kt(oe)}else kt(n.data.classrooms),Rn(n.data.trashBin||[]);Vt({lastRestoreTimestamp:new Date().toISOString()}),ce()}function Xs(n,o){if(oe[o])return{success:!1,message:"کلاسی با این نام از قبل وجود دارد."};const e=oe[n];return e?(e.info.name=o,oe[o]=e,delete oe[n],D===e&&Pe(e),{success:!0}):{success:!1,message:"کلاس مورد نظر یافت نشد."}}function Qs(n,o,e){const c=e.trim();if(!c)return{success:!1,message:"نام دسته‌بندی نمی‌تواند خالی باشد."};if(n.categories.some(s=>s.id!==o.id&&!s.isDeleted&&s.name.toLowerCase()===c.toLowerCase()))return{success:!1,message:"دسته‌بندی دیگری با این نام وجود دارد."};const t=o.name,a=t.toLowerCase(),i=c.toLowerCase();return o.name=c,n.students.forEach(s=>{s.categoryCounts&&s.categoryCounts[t]!==void 0&&(s.categoryCounts[c]=s.categoryCounts[t],delete s.categoryCounts[t]),s.categoryIssues&&s.categoryIssues[t]!==void 0&&(s.categoryIssues[c]=s.categoryIssues[t],delete s.categoryIssues[t]),s.logs.scores&&s.logs.scores[a]&&(s.logs.scores[a].forEach(l=>l.skill=c),a!==i&&(s.logs.scores[i]=s.logs.scores[a],delete s.logs.scores[a]))}),n.sessions.forEach(s=>{s.lastWinnerByCategory&&s.lastWinnerByCategory[t]&&(s.lastWinnerByCategory[c]=s.lastWinnerByCategory[t],delete s.lastWinnerByCategory[t]),s.winnerHistory&&s.winnerHistory.forEach(l=>{l.categoryName===t&&(l.categoryName=c)})}),{success:!0}}function ei(n,o,e){if(Se(e.students).some(l=>l.identity.name.toLowerCase()===n.identity.name.toLowerCase()))return{success:!1,message:`دانش‌آموزی با نام «${n.identity.name}» از قبل در کلاس «${e.info.name}» وجود دارد.`};const r=JSON.parse(JSON.stringify(n)),t=Js(r),a=new Map;o.sessions.forEach(l=>{const h=l.studentRecords[n.identity.studentId];h&&a.set(l.sessionNumber,JSON.parse(JSON.stringify(h)))}),e.addStudent(t);try{const l=Se(e.sessions).filter(v=>!v.isCancelled).sort((v,y)=>y.sessionNumber-v.sessionNumber),h=l.length>0?l[0]:null;let g="؟",p={type:"system",description:"Student Move"};h&&(g=Qe(e).get(h.sessionNumber)||h.sessionNumber,p={type:"fromSession",sessionNumber:h.sessionNumber});const u=new Date().toLocaleDateString("fa-IR"),b=o.info.name,f=`این دانش آموز در جلسه ${g} و در تاریخ ${u} از کلاس «${b}» به این کلاس انتقال پیدا کرد`;t.addNote(f,p)}catch(l){console.error("Failed to add automated move note:",l)}a.size>0&&e.sessions.forEach(l=>{const h=a.get(l.sessionNumber);h&&!l.isDeleted&&!l.isCancelled&&(l.studentRecords[t.identity.studentId]=h)});const i={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`(انتقال) دانش‌آموز «${n.identity.name}» از کلاس «${o.info.name}»`,restoreData:{studentId:n.identity.studentId,classId:o.info.scheduleCode}};ge.unshift(i),ge.length>50&&ge.pop();const s=o.students.find(l=>l.identity.studentId===n.identity.studentId);return s&&(s.isDeleted=!0),{success:!0}}function ti(){for(const n in oe){const o=oe[n];o.students.forEach(e=>{e.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0},e.categoryCounts={},e.categoryIssues={},o.sessions.forEach(c=>{const r=e.identity.studentId;c.studentRecords[r]&&(c.studentRecords[r].attendance="present")})})}ce()}function Se(n){return Array.isArray(n)?n.filter(o=>!o.isDeleted):[]}function Qe(n){const o=new Map;return n&&Se(n.sessions).filter(c=>!c.isCancelled).sort((c,r)=>c.sessionNumber-r.sessionNumber).forEach((c,r)=>{o.set(c.sessionNumber,r+1)}),o}function gt(n){je=n}function it(n){_s=n}function Nn(n,o){if(!n||!o)return;const e=n.identity.studentId,c=o.students.findIndex(r=>r.identity.studentId===e);c>-1&&o.students.splice(c,1),o.sessions.forEach(r=>{r.studentRecords[e]&&delete r.studentRecords[e];for(const t in r.lastWinnerByCategory)r.lastWinnerByCategory[t]===e&&delete r.lastWinnerByCategory[t];r.lastSelectedWinnerId===e&&(r.lastSelectedWinnerId=null),r.winnerHistory=r.winnerHistory.filter(t=>t.winner&&t.winner.identity.studentId!==e)})}function ni(n,o){const e=oe[n];if(!e)return;const c=e.sessions.findIndex(r=>r.sessionNumber===o);c>-1&&(e.students.forEach(r=>{r.profile.notes&&r.profile.notes.length>0&&(r.profile.notes=r.profile.notes.filter(t=>!t.source||t.source.type!=="fromAttendance"||t.source.sessionNumber!==o)),r.onboardingSession===o&&(r.onboardingSession=null)}),e.sessions.splice(c,1))}function si(n,o){const e=oe[n];if(!e)return;const c=e.categories.findIndex(i=>i.id===o);if(c===-1)return;const t=e.categories[c].name,a=t.toLowerCase();e.students.forEach(i=>{i.categoryCounts&&delete i.categoryCounts[t],i.categoryIssues&&delete i.categoryIssues[t],i.logs.scores&&delete i.logs.scores[a]}),e.sessions.forEach(i=>{i.lastWinnerByCategory[t]&&delete i.lastWinnerByCategory[t],i.winnerHistory=i.winnerHistory.filter(s=>s.categoryName!==t)}),e.categories.splice(c,1)}function ii(n,o,e,c){const r=oe[n];if(!r)return;const t=r.students.find(s=>s.identity.studentId===o);if(!t||!t.logs.scores[e.toLowerCase()])return;const a=t.logs.scores[e.toLowerCase()],i=a.findIndex(s=>s.id===c);i>-1&&a.splice(i,1)}function ai(n,o,e){const c=oe[n];if(!c)return;const r=c.students.find(a=>a.identity.studentId===o);if(!r||!r.profile.notes)return;const t=r.profile.notes.findIndex(a=>a.id===e);t>-1&&r.profile.notes.splice(t,1)}function ri(){JSON.parse(JSON.stringify({classrooms:oe,trashBin:ge})),ot=!0}function oi(){ot=!1,Dn()}function Pe(n){D=n}function tn(n){ps=n}function Ze(n){K=n}function Ke(n){_e=n}function An(n){en=n}function ci(n){Fn=n}function Ut(n){gs=n}function gn(n){Sn=n}function li(n){ys=n}function On(n){Ve=n}function yn(n){In=n}function di(n){vs=n}function vn(n){xn=n}function ui(n){bs=n}function ks(n){Cs=n}function Ss(n){ws=n}function nn(n){Ln=n}function Is(n){pt=n}function Mn(n){Bn=n}function fi(n){Gs=n}function mi(n){Vs=n}function Rn(n){ge=n}function Pn(n){Tn=n}function sn(n){Et=n}function Vt(n){qe={...qe,...n},ce()}function Jn(n){rt=n}function xs(){qe.lastBackupTimestamp=new Date().toISOString(),ce()}const Xi=Object.freeze(Object.defineProperty({__proto__:null,get activeModal(){return pt},get cancelCallback(){return ws},get classrooms(){return oe},get confirmCallback(){return Cs},get currentClassroom(){return D},get easterEggClickCount(){return In},get easterEggLastClickTime(){return vs},enterDemoMode:ri,exitDemoMode:oi,getActiveItems:Se,getSessionDisplayMap:Qe,get importedFileContent(){return Sn},get isDemoMode(){return ot},get liveSession(){return ps},loadData:Dn,get manualSelection(){return Bn},moveStudent:ei,get namesToImport(){return gs},get notificationTimeout(){return ys},permanentlyDeleteCategory:si,permanentlyDeleteNote:ai,permanentlyDeleteScore:ii,permanentlyDeleteSession:ni,permanentlyDeleteStudent:Nn,prepareBackupData:Ks,get previousState(){return en},processRestore:Ys,rehydrateData:kt,renameCategory:Qs,renameClassroom:Xs,resetAllStudentCounters:ti,get resetEasterEggClickCount(){return xn},get resetEasterEggLastClickTime(){return bs},get saveCategoryCallback(){return Tn},saveData:ce,get saveNoteCallback(){return _s},get secureConfirmCallback(){return Ln},get selectedCategory(){return Ve},get selectedClassIds(){return rt},get selectedSession(){return K},get selectedStudentForProfile(){return _e},get selectedStudentsForMassComment(){return Et},setActiveModal:Is,setCancelCallback:Ss,setConfirmCallback:ks,setCurrentClassroom:Pe,setEasterEggClickCount:yn,setEasterEggLastClickTime:di,setImportedFileContent:gn,setLastBackupTimestamp:xs,setLiveSession:tn,setManualSelection:Mn,setNamesToImport:Ut,setNotificationTimeout:li,setPreviousState:An,setResetEasterEggClickCount:vn,setResetEasterEggLastClickTime:ui,setSaveCategoryCallback:Pn,setSaveNoteCallback:it,setSecureConfirmCallback:nn,setSelectedCategory:On,setSelectedClassIds:Jn,setSelectedSession:Ze,setSelectedStudentForProfile:Ke,setSelectedStudentsForMassComment:sn,setSourceClassForMove:mi,setStudentToMove:fi,setTrashBin:Rn,setUndoTimeout:ci,setUserSettings:Vt,setWinnerHistoryIndex:gt,get sourceClassForMove(){return Vs},get studentToMove(){return Gs},get trashBin(){return ge},get undoTimeout(){return Fn},get userSettings(){return qe},get winnerHistoryIndex(){return je}},Symbol.toStringTag,{value:"Module"})),Qi="TeacherAssistantDB",ea=1,ht="backups";function hi(){return new Promise((n,o)=>{const e=indexedDB.open(Qi,ea);e.onupgradeneeded=c=>{const r=c.target.result;r.objectStoreNames.contains(ht)||r.createObjectStore(ht,{keyPath:"id"})},e.onsuccess=c=>n(c.target.result),e.onerror=c=>o(c.target.error)})}async function ta(n,o){const e=await hi(),c=e.transaction(ht,"readwrite"),r=c.objectStore(ht),t={id:Date.now(),file:n,metadata:o,timestamp:new Date().toISOString()};r.add(t),c.oncomplete=()=>{const i=e.transaction(ht,"readwrite").objectStore(ht),s=i.count();s.onsuccess=()=>{if(s.result>3){const l=i.getAllKeys();l.onsuccess=()=>{const h=l.result;for(;h.length>3;){const g=h.shift();i.delete(g),console.log(`♻️ Auto-deleted old backup snapshot: ${g}`)}}}}}}async function na(){const n=await hi();return new Promise((o,e)=>{const t=n.transaction(ht,"readonly").objectStore(ht).getAll();t.onsuccess=()=>{const a=t.result.sort((i,s)=>s.id-i.id);o(a)},t.onerror=()=>e(t.error)})}function Xe(n){return typeof n!="string"?"":n.replace(/ي/g,"ی").replace(/ك/g,"ک").replace(/[\s\u200c]/g,"")}function Ls(n){return typeof n!="string"||n.length===0?"ltr":/[\u0590-\u07FF]/.test(n)?"rtl":"ltr"}function pi(n){return!n||!n.trim()?"":n.split(`
`).map(c=>`<div dir="${Ls(c)}">${c||"&nbsp;"}</div>`).join("")}function Gn(n){if(typeof n!="string")return"";const o={q:"ض",w:"ص",e:"ث",r:"ق",t:"ف",y:"غ",u:"ع",i:"ه",o:"خ",p:"ح","[":"ج","]":"چ",a:"ش",s:"س",d:"ی",f:"ب",g:"ل",h:"ا",j:"ت",k:"ن",l:"م",";":"ک","'":"گ",z:"ظ",x:"ط",c:"ز",v:"ر",b:"ذ",n:"د",m:"پ",",":"و"};let e="";for(let c=0;c<n.length;c++){const r=n[c].toLowerCase();e+=o[r]||n[c]}return e}const gi="teacherAssistantLogs_v2",sa=100;function Ts(){try{const n=localStorage.getItem(gi);return n?JSON.parse(n):{}}catch(n){return console.error("Error reading logs from localStorage:",n),{}}}function yi(n){try{localStorage.setItem(gi,JSON.stringify(n))}catch(o){console.error("Error saving logs to localStorage:",o)}}function ke(n,o,e=null){if(!n)return;const c=Ts();c[n]||(c[n]=[]);const r={timestamp:new Date().toISOString(),message:o,action:e,classroomName:n};c[n].unshift(r),c[n].length>sa&&c[n].pop(),yi(c)}function ia(n){return Ts()[n]||[]}function aa(n,o){const e=Ts();e[n]&&!e[o]&&(e[o]=e[n],delete e[n],yi(e))}const vi=document.getElementById("class-management-page"),ra=document.getElementById("new-class-name"),oa=document.getElementById("add-class-btn"),At=document.getElementById("class-list"),zn=document.getElementById("undo-toast"),bi=document.getElementById("undo-message"),ca=document.getElementById("undo-btn"),la=document.getElementById("settings-page"),Bs=document.getElementById("settings-class-name-header"),Yn=document.getElementById("settings-student-list"),Xn=document.getElementById("category-list"),da=document.getElementById("back-to-sessions-btn"),ua=document.getElementById("new-student-name"),fa=document.getElementById("add-student-btn"),Ci=document.getElementById("paste-area"),ma=document.getElementById("process-paste-btn"),ha=document.getElementById("csv-preview-page"),Qn=document.getElementById("csv-preview-list"),pa=document.getElementById("csv-confirm-btn"),ga=document.getElementById("csv-cancel-btn"),ya=document.getElementById("import-csv-btn"),va=document.getElementById("csv-file-input"),ba=document.getElementById("column-mapping-page"),es=document.getElementById("column-select-dropdown"),Ca=document.getElementById("confirm-column-btn"),wa=document.getElementById("cancel-import-btn"),_a=document.getElementById("new-category-name"),Ea=document.getElementById("add-category-btn"),ts=document.querySelector(".app-header"),nt=document.getElementById("select-student-btn"),Rt=document.getElementById("select-student-btn-wrapper"),ka=document.getElementById("attendance-page"),Kt=document.getElementById("attendance-list"),Sa=document.getElementById("finish-attendance-btn"),Ia=document.querySelector("#class-management-page h2"),ns=document.getElementById("student-stats-header"),xa=document.getElementById("hamburger-menu-btn"),La=document.getElementById("side-nav-menu"),Ta=document.getElementById("close-nav-btn"),Ba=document.getElementById("overlay"),Da=document.getElementById("backup-data-btn"),Na=document.getElementById("restore-data-btn"),wi=document.getElementById("restore-file-input"),Aa=document.getElementById("custom-confirm-modal"),_i=document.getElementById("confirm-modal-message"),ss=document.getElementById("confirm-modal-cancel-btn"),jt=document.getElementById("confirm-modal-confirm-btn"),Oa=document.getElementById("secure-confirm-modal"),Ei=document.getElementById("secure-confirm-message"),ki=document.getElementById("secure-confirm-code"),Bt=document.getElementById("secure-confirm-input"),Ma=document.getElementById("secure-confirm-cancel-btn"),bn=document.getElementById("secure-confirm-confirm-btn"),Ra=document.getElementById("add-note-modal"),we=document.getElementById("new-note-content"),za=document.getElementById("class-save-note-btn"),$a=document.getElementById("cancel-note-btn"),is=document.getElementById("student-search-input"),mt=document.getElementById("student-search-results"),Fa=document.getElementById("back-to-student-page-btn"),Pa=document.getElementById("graded-category-pills-container"),Ha=document.getElementById("new-score-value"),Si=document.getElementById("new-score-comment"),Wa=document.getElementById("add-score-btn"),Ua=document.getElementById("profile-stats-summary"),ja=document.getElementById("profile-scores-list"),Zt=document.getElementById("global-student-search-input"),at=document.getElementById("global-student-search-results"),Za=document.getElementById("is-graded-checkbox"),qa=document.getElementById("trashed-classes-list"),Ga=document.getElementById("trashed-students-list"),Va=document.getElementById("trashed-sessions-list"),Ka=document.getElementById("trashed-categories-list"),Ja=document.getElementById("trashed-notes-list"),Ya=document.getElementById("trashed-scores-list"),Nt=document.getElementById("quick-grade-form-wrapper"),ct=document.getElementById("quick-score-input"),tt=document.getElementById("quick-note-textarea"),wt=document.getElementById("quick-grade-submit-btn"),Jt=document.getElementById("category-selection-container"),as=document.getElementById("selected-student-result"),_t=document.getElementById("custom-context-menu"),Dt=document.getElementById("breadcrumb-container");let Wt=null,Ot=null;const Xa=document.getElementById("category-modal"),Ii=document.getElementById("category-modal-title"),Yt=document.getElementById("new-category-modal-name"),Ds=document.getElementById("new-category-modal-is-graded"),Qa=document.getElementById("category-modal-cancel-btn"),xi=document.getElementById("category-modal-save-btn"),er=document.getElementById("mass-comment-modal"),tr=document.getElementById("mass-comment-modal-title"),Li=document.getElementById("mass-comment-student-count-message"),Xt=document.getElementById("mass-comment-content"),Ns=document.getElementById("mass-comment-append-checkbox"),nr=document.getElementById("mass-comment-cancel-btn"),sr=document.getElementById("mass-comment-save-btn"),rs=document.getElementById("mass-comment-btn"),Cn=document.getElementById("attendance-mass-actions-container"),bt=document.createElement("input"),ir=document.getElementById("session-dashboard-page"),zt=document.getElementById("attendance-pane");function qt(n,o){let e;const r=a=>{e=setTimeout(()=>{navigator.vibrate&&navigator.vibrate(50),o(a)},800)},t=()=>{clearTimeout(e)};n.addEventListener("touchstart",r,{passive:!0}),n.addEventListener("touchend",t),n.addEventListener("touchmove",t),n.addEventListener("mousedown",r),n.addEventListener("mouseup",t),n.addEventListener("mouseleave",t)}function $t(n="selector"){if(!D||!K){ye("class-management-page");return}lr(),_n(),Re(),st(),ye("session-dashboard-page",{tab:n}),Ti(),an(n),dr()}function an(n){const o=document.getElementById("selector-tab-btn"),e=document.getElementById("attendance-tab-btn"),c=document.getElementById("selector-pane"),r=n==="selector";o.classList.toggle("active",r),e.classList.toggle("active",!r),c.classList.toggle("active",r),zt.classList.toggle("active",!r)}function Ti(){const n=document.getElementById("selector-tab-btn"),o=document.getElementById("attendance-tab-btn"),e=document.getElementById("selector-pane");n.addEventListener("click",()=>{Re(),Me(),n.classList.add("active"),o.classList.remove("active"),e.classList.add("active"),zt.classList.remove("active"),ye("session-dashboard-page",{tab:"selector"})}),o.addEventListener("click",()=>{st(),o.classList.add("active"),n.classList.remove("active"),zt.classList.add("active"),e.classList.remove("active"),ye("session-dashboard-page",{tab:"attendance"})})}function ar(n){clearTimeout(Fn),en||An(JSON.stringify(oe)),bi.textContent=n,zn.classList.add("show"),ci(setTimeout(()=>{zn.classList.remove("show"),An(null)},5e3))}function Bi(){if(en){const n=D?D.info.name:null,o=JSON.parse(en);kt(o),n&&oe[n]?Pe(oe[n]):Pe(null),D?(lt(),Ft(),We()):He(),zn.classList.remove("show"),clearTimeout(Fn),An(null)}}function ee(n,o=3e3){const e=document.getElementById("notification-toast");e&&(e.textContent=n,e.classList.add("show"),clearTimeout(ys),li(setTimeout(()=>{e.classList.remove("show")},o)))}function $n(n){const o=document.getElementById("restore-confirm-modal"),e=document.getElementById("restore-modal-message"),c=document.getElementById("restore-append-checkbox"),r=document.getElementById("restore-confirm-cancel-btn"),t=document.getElementById("restore-confirm-confirm-btn"),a=document.getElementById("restore-modal-warning");a.style.display="none";const i=n.metadata.createdAt;if(qe.lastRestoreTimestamp&&i<qe.lastRestoreTimestamp){const f=new Date(i).toLocaleDateString("fa-IR"),v=new Date(qe.lastRestoreTimestamp).toLocaleDateString("fa-IR");a.textContent=`⚠️ هشدار: این فایل پشتیبان (${f}) قدیمی‌تر از آخرین بازیابی شما (${v}) است.`,a.style.display="block"}const s=n.data.classrooms||{},l=Object.values(s).map(f=>f.info.name),h=l.length,g="کلاس",p=l.map(f=>`<li style="margin-bottom: 4px;">🔹 ${f}</li>`).join("");e.innerHTML=`
        <div style="margin-bottom: 10px;">
            فایل پشتیبان شامل <strong>${h} ${g}</strong> زیر است:
        </div>
        <ul style="
            margin: 0; 
            padding: 10px; 
            background-color: #f8f9fa; 
            border-radius: 5px; 
            border: 1px solid #e9ecef;
            list-style: none; 
            max-height: 150px; 
            overflow-y: auto;
            text-align: right;
        ">
            ${p}
        </ul>
        <div style="margin-top: 15px;">
            لطفاً نحوه بازیابی را مشخص کنید.
        </div>
    `,c.checked=!0,c.checked=!0;const u=()=>{const f=c.checked;Ys(n,f),o.removeEventListener("click",u),Ee(),He(),ye("class-management-page"),ee("✅ اطلاعات با موفقیت بازیابی شد.")},b=()=>{Ee()};t.onclick=u,r.onclick=b,$e("restore-confirm-modal")}function Ce(n,o,e={}){const{confirmText:c="تایید",cancelText:r="لغو",confirmClass:t="btn-success",onCancel:a=()=>{},isDelete:i=!1}=e,s=i?()=>Di(n,o):o;_i.textContent=n,jt.textContent=c,ss.textContent=r,jt.className="modal-action-btn",jt.classList.add(t),ks(s),Ss(a);const l=jt.parentElement;ss.style.display=a===null?"none":"inline-block",l.style.justifyContent=a===null?"center":"space-between",$e("custom-confirm-modal")}function Di(n,o){const e=Math.floor(1e4+Math.random()*9e4).toString();Ei.textContent=n,ki.textContent=e,Bt.value="",bn.disabled=!0,nn(o),$e("secure-confirm-modal"),Bt.focus();const c=()=>{Bt.value===e?bn.disabled=!1:bn.disabled=!0};return Bt.addEventListener("input",c),()=>{Bt.removeEventListener("input",c)}}function os(n,o={}){const{title:e="ایجاد دسته‌بندی جدید",initialName:c="",initialIsGraded:r=!1,saveButtonText:t="ذخیره"}=o;Ii.textContent=e,Yt.value=c,Ds.checked=r,xi.textContent=t,Pn((a,i)=>{if(!a){ee("⚠️ لطفاً نام دسته‌بندی را وارد کنید.");return}n(a,i),Ee()}),$e("category-modal"),Yt.focus(),c&&Yt.select()}function As(n,o){const e=Object.values(oe).filter(a=>!a.isDeleted&&a.info.name!==o.info.name),c=document.getElementById("move-student-modal-title"),r=document.getElementById("move-student-class-select"),t=document.getElementById("move-student-confirm-btn");c.textContent=`انتقال دانش‌آموز: ${n.identity.name}`,r.innerHTML="",e.length===0?(r.innerHTML='<option value="">کلاس دیگری برای انتقال وجود ندارد</option>',t.disabled=!0):(e.forEach(a=>{const i=document.createElement("option");i.value=a.info.name,i.textContent=a.info.name,r.appendChild(i)}),t.disabled=!1),fi(n),mi(o),$e("move-student-modal")}function Os(n,o){if(!n||!o)return;const e=n.identity.name,c=document.getElementById("add-note-modal-title");c.textContent="تغییر نام دانش‌آموز",we.value=e,we.rows=1,we.dispatchEvent(new Event("input",{bubbles:!0})),it(r=>{const t=r.trim();t&&t!==e&&(Se(o.students).some(i=>i.identity.studentId!==n.identity.studentId&&i.identity.name.toLowerCase()===t.toLowerCase())?ee("دانش‌آموزی با این نام از قبل در این کلاس وجود دارد."):(n.identity.name=t,ke(o.info.name,`نام دانش‌آموز «${e}» به «${t}» تغییر یافت.`,{type:"VIEW_STUDENT_PROFILE",studentId:n.identity.studentId}),ce(),lt(),Re(),st(),Me(),_e&&_e.identity.studentId===n.identity.studentId&&ze(n),ee(`✅نام دانش‌آموز به «${t}» تغییر یافت.`))),c.textContent="ثبت یادداشت جدید",we.rows=4}),$e("add-note-modal"),we.focus(),we.select()}function $e(n){const o=document.getElementById(n);if(o){if(pt)return;document.body.classList.add("modal-active"),o.classList.add("modal-visible"),Is(n),history.pushState(null,"",location.href)}}function Ee(n,o=!1){if(!pt)return;const e=document.getElementById(pt),c=pt;Is(null),c==="student-profile-modal"&&Ke(null),o||history.back(),e&&(e.classList.add("modal-closing"),setTimeout(()=>{e.classList.remove("modal-visible"),e.classList.remove("modal-closing"),document.body.classList.remove("modal-active"),c==="custom-confirm-modal"&&(ks(null),Ss(null)),c==="secure-confirm-modal"&&nn(null),c==="category-modal"&&Pn(null),c==="mass-comment-modal"&&(Xt.value=""),c==="add-note-modal"&&it(null),typeof n=="function"&&n()},300))}function Ms(){if(!zt||!zt.classList.contains("active")){Cn.style.display="none";return}const n=Et.length;n<1?Cn.style.display="none":Cn.style.display="block",rs.disabled=n<1,rs.textContent=`📝 ثبت یادداشت گروهی (${n} نفر)`}function Rs(){const n=Et,o=n.length;let e=!1;o>0&&(e=n.some(r=>{var t;return(t=K.studentRecords[r])==null?void 0:t.homework.comment})),Li.textContent=`یادداشت برای ${o} دانش‌آموز ثبت خواهد شد.`,Xt.value="",Xt.dispatchEvent(new Event("input",{bubbles:!0})),Ns.checked=!0;const c=document.querySelector("#mass-comment-modal .modal-options");c.style.display=e?"flex":"none",$e("mass-comment-modal"),Xt.focus()}function cs(n,o){if(!D||!K)return;let e=0;const c=Et,r=K;c.forEach(t=>{const a=r.studentRecords[t];if(a&&a.homework){const i=a.homework.comment||"";let s=n;o&&i.length>0?s=i+`
---
`+n:s=n,a.homework.comment=s.trim();const l=D.students.find(h=>h.identity.studentId===t);l&&rr(l,r,s.trim()),e++}}),sn([]),ce(),st(),ke(D.info.name,`${e} دانش‌آموز به صورت گروهی یادداشت تکلیف گرفتند.`,{type:"VIEW_SESSIONS"}),ee(`✅ یادداشت برای ${e} دانش‌آموز ثبت شد.`)}function rr(n,o,e){const r=Qe(D).get(o.sessionNumber),t={type:"fromAttendance",sessionNumber:o.sessionNumber},a=`یادداشت مربوط به جلسه ${r}: `,i=n.profile.notes.find(s=>!s.isDeleted&&s.source&&s.source.type==="fromAttendance"&&s.source.sessionNumber===t.sessionNumber);i?e?(i.content=a+e,i.isDeleted=!1):i.isDeleted=!0:e&&n.addNote(a+e,t)}function Hn(n){we.value=n.note||"",it(o=>{n.note=o,ce(),ke(n.info.name,"یادداشت کلاس ذخیره شد.",{type:"VIEW_CLASS_NOTE"}),He(),ee("✅ یادداشت کلاس ذخیره شد.")}),$e("add-note-modal"),we.focus()}function zs(n,o){we.value=n.note||"",we.dispatchEvent(new Event("input",{bubbles:!0})),it(e=>{n.note=e,ce(),ke(D.info.name,`یادداشت جلسه ${o} ذخیره شد.`,{type:"VIEW_SESSIONS"}),We(),ee("✅یادداشت جلسه ذخیره شد.")}),$e("add-note-modal"),we.focus()}function Mt(n){Pe(n),Bs.textContent=`تنظیمات کلاس: ${n.info.name}`,lt(),Ft(),Fi(),ye("settings-page")}function Ni(n){const o=document.getElementById("log-modal-title"),e=document.getElementById("log-list");o.textContent=`گزارش فعالیت‌های کلاس: ${n}`,e.innerHTML="";const c=ia(n);c.length===0?e.innerHTML='<li class="no-content-message">هنوز فعالیتی برای این کلاس ثبت نشده است.</li>':c.forEach(r=>{const t=document.createElement("li");t.className="log-entry";const a=new Date(r.timestamp),i=`${a.toLocaleDateString("fa-IR")} - ${a.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}`,s=document.createElement("span");s.className="log-timestamp",s.textContent=i;const l=document.createElement("span");l.className="log-message",l.textContent=r.message,r.action&&(l.classList.add("log-action-link"),l.dataset.action=JSON.stringify({...r.action,classroomName:r.classroomName})),t.appendChild(s),t.appendChild(l),e.appendChild(t)}),$e("log-modal")}document.getElementById("log-modal-close-btn").addEventListener("click",()=>{Ee()});function ls(n){const o=URL.createObjectURL(n),e=document.createElement("a");e.href=o,e.download=n.name,document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(o),setTimeout(()=>{Ce("آیا فایل پشتیبان با موفقیت ذخیره شد؟",()=>{xs(),Wn(),ee("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله، ذخیره شد",cancelText:"خیر",confirmClass:"btn-success"})},500)}async function rn(n=[]){const o=await Ks(n);if(!o){ee("❌ خطا در ایجاد فایل پشتیبان.");return}let e="پشتیبان کامل سیستم";if(n.length>0){const r=n.join("، ");e=`${n.length===1?"پشتیبان کلاس:":"پشتیبان کلاس‌های:"} ${r}`}ta(o,{name:o.name,description:e,version:"2.0-b64"}).catch(r=>console.error("Failed to save local snapshot:",r)),("ontouchstart"in window||navigator.maxTouchPoints>0)&&navigator.share&&navigator.canShare&&navigator.canShare({files:[o]})?Ce("فایل پشتیبان شما آماده است. آیا مایل به اشتراک‌گذاری آن هستید؟",()=>{try{navigator.share({title:o.name,text:"فایل پشتیبان داده‌های برنامه",files:[o]}).then(()=>{Ce("آیا فایل پشتیبان با موفقیت ارسال/ذخیره شد؟",()=>{xs(),Wn(),ee("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}catch(r){console.error("Error during sharing process:",r),ls(o),ee("⚠️خطا در فرآیند اشتراک‌گذاری. فایل در حال دانلود است.")}},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"}):(ls(o),ee("✅پشتیبان‌گیری با موفقیت انجام شد."))}function cn(n,o){n.preventDefault(),Ct(),Ot=n.target.closest("li"),Ot&&Ot.classList.add("context-menu-target"),setTimeout(()=>{const e=_t,c=e.querySelector("ul");c.innerHTML="",o.forEach(l=>{const h=document.createElement("li");l.isSeparator?h.className="separator":(h.innerHTML=`
                    <span class="icon">${l.icon||""}</span>
                    <span class="label">${l.label}</span>
                `,l.className&&h.classList.add(l.className),h.addEventListener("click",()=>{l.action(),Ct()})),c.appendChild(h)}),e.classList.add("visible");const{offsetWidth:r,offsetHeight:t}=e,{innerHeight:a}=window,i=document.body.getBoundingClientRect();e.style.top=`${(a-t)/2}px`;const s=i.left+i.width/2;e.style.left=`${s-r/2}px`},50)}function Ct(){_t.classList.contains("visible")&&_t.classList.remove("visible"),Ot&&(Ot.classList.remove("context-menu-target"),Ot=null)}function Ai(){var e;Dt.innerHTML="";const n=document.getElementById("header-settings-btn");if(!n)return;const o=[];if(o.push({label:"کلاس‌ها",handler:()=>{Pe(null),Ze(null),Ke(null),ye("class-management-page")}}),D){o.push({label:D.info.name,handler:()=>{Ze(null),Ke(null),We(),ye("session-page")}});const c=(e=document.querySelector(".page.active"))==null?void 0:e.id;if(c==="session-page"?n.style.visibility="visible":n.style.visibility="hidden",c==="settings-page")o.push({label:"تنظیمات"});else if(K){const t=Qe(D).get(K.sessionNumber)||` (#${K.sessionNumber})`;o.push({label:`جلسه ${t}`,handler:()=>{Ke(null),$t("selector")}}),_e?o.push({label:`پروفایل: ${_e.identity.name}`}):c==="session-dashboard-page"&&(document.getElementById("attendance-tab-btn").classList.contains("active")?o.push({label:"حضور و غیاب"}):o.push({label:"انتخابگر"}))}}else n.style.visibility="hidden";if(o.length<=1){Dt.style.display="none";return}Dt.style.display="flex",o.forEach((c,r)=>{const t=document.createElement("a");if(t.textContent=c.label,t.className="breadcrumb-item",r===o.length-1||!c.handler?t.classList.add("active"):t.addEventListener("click",c.handler),Dt.appendChild(t),r<o.length-1){const a=document.createElement("span");a.className="breadcrumb-separator",a.textContent="/",Dt.appendChild(a)}})}function Hs(n,o,e){e.innerHTML="";const c=D.sessions.filter(r=>{var t;return!r.isDeleted&&!r.isCancelled&&((t=r.studentRecords[n.identity.studentId])==null?void 0:t.attendance)==="absent"}).map(r=>({number:o.get(r.sessionNumber),isMakeup:r.isMakeup})).filter(r=>r.number!==void 0);c.length>0?(e.appendChild(document.createTextNode("جلسات غایب: ")),c.forEach((r,t)=>{const a=document.createElement("span");a.textContent=r.number,r.isMakeup&&a.classList.add("makeup-absence"),e.appendChild(a),t<c.length-1&&e.appendChild(document.createTextNode("، "))})):e.textContent="جلسات غایب: بدون غیبت"}function wn(n,o,e,c={}){const{includePrefix:r=!0}=c;e.innerHTML="";const t=D.sessions.filter(a=>{if(a.isDeleted||a.isCancelled)return!1;const i=a.studentRecords[n.identity.studentId];return i&&i.homework&&(i.homework.status==="incomplete"||i.homework.status==="none")}).map(a=>({number:o.get(a.sessionNumber),status:a.studentRecords[n.identity.studentId].homework.status})).filter(a=>a.number!==void 0);t.length>0?(r&&e.appendChild(document.createTextNode("تکالیف ناقص: ")),t.forEach((a,i)=>{const s=document.createElement("span");s.textContent=a.number,a.status==="incomplete"&&s.classList.add("incomplete-homework"),e.appendChild(s),i<t.length-1&&e.appendChild(document.createTextNode("،"))})):r?e.textContent="تکالیف ناقص: ندارد":e.textContent="ندارد"}function or(n,o){var L,N,R;const e=document.createElement("li");e.className="attendance-list-item";const c=document.createElement("span");c.className="absence-info";const r=document.createElement("span");r.className="homework-info";const t=document.createElement("div");t.className="att-row-1";let a=!1;t.addEventListener("mousedown",()=>a=!1),t.addEventListener("touchstart",()=>a=!1,{passive:!0});const i=document.createElement("input");i.type="checkbox",i.className="mass-comment-checkbox",i.checked=Et.includes(n.identity.studentId),i.addEventListener("change",()=>{const P=n.identity.studentId,Q=Et;if(i.checked)Q.includes(P)||Q.push(P);else{const z=Q.indexOf(P);z>-1&&Q.splice(z,1)}Ms();const k=document.getElementById("attendance-list");Q.length===0&&k.classList.contains("selection-mode-active")&&k.classList.remove("selection-mode-active")});const s=document.createElement("span");s.className="student-name",s.textContent=n.identity.name,s.addEventListener("click",P=>{if(a){P.stopPropagation(),P.preventDefault(),a=!1;return}ze(n)}),qt(t,P=>{a=!0;const Q=document.getElementById("attendance-list");Q.classList.contains("selection-mode-active")||Q.classList.add("selection-mode-active"),i.checked||(i.checked=!0,i.dispatchEvent(new Event("change")))}),t.appendChild(i),t.appendChild(s);const l=document.createElement("div");l.className="att-row-2";const h=document.createElement("button");let g=!1;h.addEventListener("mousedown",()=>g=!1),h.addEventListener("touchstart",()=>g=!1,{passive:!0});const p=((L=K.studentRecords[n.identity.studentId])==null?void 0:L.attendance)||"present",u=P=>{P==="present"?(h.textContent="حاضر",h.className="attendance-status-btn present active"):(h.textContent="غایب",h.className="attendance-status-btn absent active")};u(p),h.addEventListener("click",P=>{var z;if(g){P.stopPropagation();return}const k=(((z=K.studentRecords[n.identity.studentId])==null?void 0:z.attendance)||"present")==="present"?"absent":"present";K.setAttendance(n.identity.studentId,k),k==="absent"&&(K.studentRecords[n.identity.studentId].hadIssue=!1),ce(),u(k),Hs(n,o,c),Re(),Pi()}),qt(h,()=>{g=!0;const P=p==="present"?"absent":"present",Q=P==="present"?"حاضر":"غایب";Ce(`آیا مطمئن هستید که می‌خواهید وضعیت حضور تمام دانش‌آموزان را به «${Q}» تغییر دهید؟`,()=>{Se(D.students).forEach(k=>{K.setAttendance(k.identity.studentId,P),P==="absent"&&(K.studentRecords[k.identity.studentId].hadIssue=!1)}),ce(),st(),ee(`✅ وضعیت تمام دانش‌آموزان به «${Q}» تغییر یافت.`)},{confirmText:"بله، اعمال کن",confirmClass:"btn-warning"})});const b=document.createElement("div");b.className="homework-controls";const f={none:"بدون تکلیف",complete:"تکلیف کامل",incomplete:"تکلیف ناقص"},v=document.createElement("button");let y=!1;v.addEventListener("mousedown",()=>y=!1),v.addEventListener("touchstart",()=>y=!1,{passive:!0});const C=((N=K.studentRecords[n.identity.studentId])==null?void 0:N.homework.status)||"none";v.className=`homework-status-btn ${C}`,v.title=f[C],v.addEventListener("click",P=>{if(y){P.stopPropagation();return}const Q=K.studentRecords[n.identity.studentId].homework,z={none:"incomplete",incomplete:"complete",complete:"none"}[Q.status];K.setHomeworkStatus(n.identity.studentId,z),ce(),v.className=`homework-status-btn ${z}`,v.title=f[z],wn(n,o,r)}),qt(v,()=>{y=!0;const Q={none:"incomplete",incomplete:"complete",complete:"none"}[C],k=f[Q];Ce(`آیا از تغییر وضعیت تکلیف تمام دانش‌آموزان به «${k}» مطمئن هستید؟`,()=>{Se(D.students).forEach(z=>{K.setHomeworkStatus(z.identity.studentId,Q)}),ce(),st(),ee(`✅ وضعیت تکلیف همه به «${k}» تغییر یافت.`)},{confirmText:"بله",confirmClass:"btn-warning"})});const E=document.createElement("button");let S=!1;E.addEventListener("mousedown",()=>S=!1),E.addEventListener("touchstart",()=>S=!1,{passive:!0}),E.className="btn-icon",E.innerHTML="📝",E.title="افزودن یادداشت برای تکلیف",((R=K.studentRecords[n.identity.studentId])==null?void 0:R.homework.comment)||(E.style.opacity="0.3"),E.addEventListener("click",P=>{if(S){P.stopPropagation();return}const Q=K.studentRecords[n.identity.studentId].homework;we.value=Q.comment||"",we.dispatchEvent(new Event("input",{bubbles:!0})),it(k=>{Q.comment=k;const z=Qe(D),m=z.get(K.sessionNumber),H={type:"fromAttendance",sessionNumber:K.sessionNumber},ue=`یادداشت مربوط به جلسه ${m}: `,Z=n.profile.notes.find(fe=>!fe.isDeleted&&fe.source&&fe.source.type==="fromAttendance"&&fe.source.sessionNumber===H.sessionNumber);Z?k?Z.content=ue+k:Z.isDeleted=!0:k&&n.addNote(ue+k,H),ce(),ee("✅یادداشت تکلیف ذخیره شد."),E.style.opacity=k?"1":"0.3",wn(n,z,r)}),$e("add-note-modal"),we.focus()}),qt(E,()=>{S=!0,Ce("آیا می‌خواهید برای **تمام** دانش‌آموزان کلاس یادداشت تکلیف ثبت کنید؟",()=>{const P=Se(D.students).map(Q=>Q.identity.studentId);sn(P),Rs()},{confirmText:"بله",confirmClass:"btn-primary"})}),l.appendChild(h),b.appendChild(E),b.appendChild(v),l.appendChild(b);const x=document.createElement("div");return x.className="att-row-3",Hs(n,o,c),wn(n,o,r),x.appendChild(c),x.appendChild(r),e.appendChild(t),e.appendChild(l),e.appendChild(x),e}function cr(){return Qe(D).get(K.sessionNumber)}function st(){if(!D||!K)return;Se(D.students).forEach(r=>{K.initializeStudentRecord(r.identity.studentId)}),sn([]);const n=Qe(D);br(),Kt.innerHTML="";const o=document.createElement("li");o.className="attendance-list-header",bt.id="attendance-search-input",bt.type="text",bt.className="inline-search-input",bt.placeholder="جستجو...",bt.value="";const e=document.createElement("div");e.className="student-search-container",e.appendChild(bt);const c=document.createElement("div");c.className="header-labels-container",c.innerHTML=`
    <span class="header-label">تکلیف</span>
    <span class="header-label">حضور</span>
`,o.appendChild(e),o.appendChild(c),Kt.appendChild(o),Se(D.students).forEach(r=>{const t=or(r,n);Kt.appendChild(t)}),sn([]),Ms(),Cr(),Pi()}function Re(){const n=document.getElementById("student-stats-table-container");if(!n||(n.innerHTML="",!D))return;Se(D.students).length,ns.textContent="آمار عملکرد";const o=["نام"],e=["کل انتخاب ها","غیبت","خروج","فرصت ازدست‌رفته","مشکل","میانگین","نمره کلاسی (کانون)"],c=D.categories.filter(u=>u.isGradedCategory&&!u.isDeleted).map(u=>u.name),r=[...o,...c,...e],t=document.createElement("table");t.className="student-stats-table";const i=t.createTHead().insertRow();r.forEach((u,b)=>{const f=document.createElement("th");b===0?(f.innerHTML=`${u} <span style="opacity: 0.6;">🔗</span>`,f.title="ردیف‌های این ستون قابل کلیک هستند"):f.textContent=u,i.appendChild(f)});const s=t.createTBody(),l=Se(D.students),h=u=>{let b=0;return D.sessions.forEach(f=>{if(f.isDeleted||f.isCancelled)return;const v=f.studentRecords[u.identity.studentId];v&&v.attendance==="absent"&&b++}),b};l.forEach(u=>{const b=s.insertRow();if(b.dataset.studentId=u.identity.studentId,K){const S=K.studentRecords[u.identity.studentId];S&&S.attendance==="absent"&&b.classList.add("absent-row-highlight")}const f=b.insertCell(),v=document.createElement("span");v.textContent=u.identity.name,v.className="student-name-link",v.addEventListener("click",()=>{ze(u)}),f.appendChild(v),c.forEach(S=>{var N;const I=b.insertCell();I.style.direction="ltr";const x=S.toLowerCase(),L=((N=u.logs.scores[x])==null?void 0:N.filter(R=>!R.isDeleted))||[];L.length>0?L.forEach((R,P)=>{const Q=document.createElement("span");Q.textContent=R.value+(R.comment?"'":""),Q.style.position="relative",R.comment&&(Q.dataset.tooltip=R.comment),I.appendChild(Q),P<L.length-1&&I.appendChild(document.createTextNode(","))}):I.textContent="",I.style.cursor="pointer",I.addEventListener("click",()=>{Me(u,S);const R=document.getElementById("category-selection-container");R&&R.scrollIntoView({behavior:"smooth",block:"center"})})}),b.insertCell().textContent=u.statusCounters.totalSelections||0,b.insertCell().textContent=h(u),b.insertCell().textContent=u.statusCounters.outOfClassCount||0,b.insertCell().textContent=u.statusCounters.missedChances||0;const y=Object.values(u.categoryIssues||{}).reduce((S,I)=>S+I,0);b.insertCell().textContent=y;const C=u.getOverallAverageScore();b.insertCell().textContent=C!==null?C:"-";const E=D.calculateFinalStudentScore(u);b.insertCell().textContent=E!==null?E:"-"}),Se(D.students),ns.setAttribute("data-student-count",l.length),n.appendChild(t);const g=n.querySelector(".student-stats-table"),p=g==null?void 0:g.querySelector("thead th:first-child");p&&p.addEventListener("click",()=>{g.classList.toggle("name-column-expanded")})}function Me(n=null,o=null){const e=document.getElementById("selected-student-result");e.innerHTML="",e.classList.remove("absent");let c,r;if(n&&o)c=n,r=o,Mn({student:n,categoryName:o}),gt(-1);else{if(Mn(null),!K||je<0||!K.winnerHistory[je])return;const F=K.winnerHistory[je];c=F.winner,r=F.categoryName}const t=document.querySelector(".current-winner-highlight");if(t&&t.classList.remove("current-winner-highlight"),c){const F=document.querySelector(`.student-stats-table tr[data-student-id="${c.identity.studentId}"]`);F&&F.classList.add("current-winner-highlight")}const a=D.categories.find(F=>F.name===r);if(a){On(a),$s(a);const F=document.querySelectorAll("#category-selection-container .pill");F.forEach(A=>A.classList.remove("active"));const ne=Array.from(F).find(A=>A.textContent===r);ne&&ne.classList.add("active"),ds(a),us(a.name)}const i=K.studentRecords[c.identity.studentId],s=(i==null?void 0:i.attendance)==="absent",l=document.createElement("div");l.className="winner-name-container";const h=document.createElement("button");h.className="btn-icon",h.innerHTML="˅",h.title="برنده قبلی";const g=!n;h.classList.toggle("is-disabled",!g||je<=0),h.addEventListener("click",()=>{h.classList.contains("is-disabled")?(h.classList.add("shake-animation"),setTimeout(()=>h.classList.remove("shake-animation"),200)):(gt(je-1),Me())});const p=document.createElement("div");p.className="winner-name",p.innerHTML=`✨ <strong>${c.identity.name}</strong>✨`,p.classList.add("heartbeat-animation"),s&&(p.style.textDecoration="line-through",p.style.opacity="0.6",p.style.color="var(--color-secondary)"),(i==null?void 0:i.hadIssue)&&!s&&(p.style.color="var(--color-warning)",p.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"),(i==null?void 0:i.wasOutOfClass)&&!s&&(p.style.color="var(--color-strong-warning)",p.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود");const f=1e3,v=F=>{Wt=setTimeout(()=>{Sr(c,r),Wt=null},f)},y=()=>{Wt&&(clearTimeout(Wt),Wt=null)};p.addEventListener("mousedown",v),p.addEventListener("mouseup",y),p.addEventListener("mouseout",y),p.addEventListener("touchstart",v),p.addEventListener("touchmove",y),p.addEventListener("touchend",y),p.addEventListener("touchcancel",y);const C=document.createElement("button");if(C.className="btn-icon",C.innerHTML="˄",C.title="برنده بعدی",C.classList.toggle("is-disabled",!g||je>=K.winnerHistory.length-1),C.addEventListener("click",()=>{C.classList.contains("is-disabled")?(C.classList.add("shake-animation"),setTimeout(()=>C.classList.remove("shake-animation"),200)):(gt(je+1),Me())}),l.appendChild(C),l.appendChild(p),c.onboardingSession===K.sessionNumber){const F=document.createElement("div");F.className="new-student-badge",F.textContent="دانش آموز جدید",l.appendChild(F)}l.appendChild(h),e.appendChild(l),nt.disabled=g&&!C.classList.contains("is-disabled");const E=document.createElement("div");E.className="status-button-container";const S=document.createElement("button");S.textContent="غایب",S.classList.add("status-button","absent-btn"),s&&S.classList.add("active");const I=document.createElement("button");I.textContent="مشکل",I.classList.add("status-button","issue-btn"),i!=null&&i.hadIssue&&I.classList.add("active");const x=document.createElement("button");x.textContent="خروج",x.classList.add("status-button","exit-btn"),i!=null&&i.wasOutOfClass&&x.classList.add("active");const L=document.createElement("button");L.textContent="پروفایل",L.className="status-button profile-btn",K.isFinished?S.disabled=!0:S.addEventListener("click",()=>{const F=S.classList.contains("active");x.classList.contains("active")&&(x.classList.remove("active"),i.wasOutOfClass=!1,c.statusCounters.outOfClassCount=Math.max(0,(c.statusCounters.outOfClassCount||0)-1),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)),F?(S.classList.remove("active"),K.setAttendance(c.identity.studentId,"present"),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1),p.style.textDecoration="",p.style.opacity="",p.style.color=""):(I.classList.contains("active")&&(I.classList.remove("active"),i.hadIssue=!1,c.statusCounters.otherIssues=Math.max(0,c.statusCounters.otherIssues-1),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)),S.classList.add("active"),K.setAttendance(c.identity.studentId,"absent"),c.statusCounters.missedChances++,p.style.textDecoration="line-through",p.style.opacity="0.6",p.style.color="var(--color-secondary)",p.title=""),Re(),setTimeout(()=>{je!==-1?Me():Me(c,r)},0),ce()}),K.isFinished?I.disabled=!0:I.addEventListener("click",()=>{const F=I.classList.contains("active");if(x.classList.contains("active")&&(x.classList.remove("active"),i.wasOutOfClass=!1,c.statusCounters.outOfClassCount=Math.max(0,(c.statusCounters.outOfClassCount||0)-1),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)),F){I.classList.remove("active"),i.hadIssue=!1;const ne=Ve.name;c.categoryIssues[ne]&&(c.categoryIssues[ne]=Math.max(0,c.categoryIssues[ne]-1)),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1),p.style.color="",p.title=""}else{S.classList.contains("active")&&(S.classList.remove("active"),K.setAttendance(c.identity.studentId,"present"),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)),I.classList.add("active"),i.hadIssue=!0;const ne=Ve.name;c.categoryIssues[ne]=(c.categoryIssues[ne]||0)+1,c.statusCounters.missedChances++,p.style.textDecoration="",p.style.opacity="",p.style.color="var(--color-warning)",p.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"}Re(),setTimeout(()=>{je!==-1?Me():Me(c,r)},0),ce()}),K.isFinished?x.disabled=!0:x.addEventListener("click",()=>{if(x.classList.contains("active"))x.classList.remove("active"),i.wasOutOfClass=!1,c.statusCounters.outOfClassCount=Math.max(0,(c.statusCounters.outOfClassCount||0)-1),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1),p.style.color="",p.title="";else{if(S.classList.contains("active")&&(S.classList.remove("active"),K.setAttendance(c.identity.studentId,"present"),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)),I.classList.contains("active")){I.classList.remove("active"),i.hadIssue=!1;const ne=Ve.name;c.categoryIssues[ne]&&(c.categoryIssues[ne]=Math.max(0,c.categoryIssues[ne]-1)),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)}x.classList.add("active"),i.wasOutOfClass=!0,c.statusCounters.outOfClassCount=(c.statusCounters.outOfClassCount||0)+1,c.statusCounters.missedChances++,p.style.textDecoration="",p.style.opacity="",p.style.color="var(--color-strong-warning)",p.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود"}Re(),setTimeout(()=>{je!==-1?Me():Me(c,r)},0),ce()}),K.isFinished?L.disabled=!0:L.addEventListener("click",()=>{ze(c)}),E.appendChild(S),E.appendChild(x),E.appendChild(I),E.appendChild(L),e.appendChild(E);const N=document.createElement("div");N.className="student-details-container";const R=document.createElement("div");R.className="student-details-scores",R.innerHTML="<h4>آخرین نمرات</h4>";const P=document.createElement("ul");P.className="scores-list";const Q=D.categories.filter(F=>F.isGradedCategory&&!F.isDeleted);let k=!1;const z=c.logs.scores||{};Q.forEach(F=>{var Be;const ne=F.name,A=ne.toLowerCase(),M=document.createElement("li"),re=document.createElement("span");re.className="skill-name",re.textContent=`${ne}:`;const te=document.createElement("span");te.className="skill-scores";const Y=(Be=z[A])==null?void 0:Be.filter(Ne=>!Ne.isDeleted);if(Y&&Y.length>0){k=!0;const Ne=Y.slice(-3);Ne.forEach((pe,ve)=>{const Le=document.createElement("span");Le.textContent=pe.value+(pe.comment?"'":""),pe.comment&&(Le.dataset.tooltip=pe.comment,Le.style.position="relative",Le.style.cursor="help",Le.classList.add("tooltip-container")),te.appendChild(Le),ve<Ne.length-1&&te.appendChild(document.createTextNode(","))})}else te.textContent="none";M.appendChild(re),M.appendChild(te),P.appendChild(M)}),k||(P.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>'),R.appendChild(P),N.appendChild(R);const m=document.createElement("div");m.className="student-details-notes";const H=document.createElement("div");H.className="history-section-header";const ue=document.createElement("h4");ue.textContent="یادداشت‌ها";const Z=document.createElement("button");Z.className="btn-icon",Z.innerHTML="📝",Z.title="افزودن یادداشت جدید",K.isFinished?Z.disabled=!0:Z.addEventListener("click",()=>{we.value="",we.dispatchEvent(new Event("input",{bubbles:!0})),it(F=>{F&&(c.addNote(F),ce(),Me(),ee("✅ یادداشت با موفقیت ثبت شد."))}),$e("add-note-modal"),we.focus()}),H.appendChild(ue),H.appendChild(Z),m.appendChild(H);const fe=document.createElement("ul");fe.className="notes-list",c.profile.notes&&c.profile.notes.length>0?[...c.profile.notes].sort((ne,A)=>new Date(A.timestamp)-new Date(ne.timestamp)).forEach(ne=>{const A=document.createElement("li");A.dir=Ls(ne.content),A.textContent=ne.content,fe.appendChild(A)}):fe.innerHTML='<div class="no-content-message">یادداشتی وجود ندارد.</div>',m.appendChild(fe),N.appendChild(m),e.appendChild(N)}function Oi(n){n.addEventListener("input",()=>{const o=n.value,e=Ls(o);n.setAttribute("dir",e)})}function lr(){$s(null),Jt.innerHTML="",as.innerHTML="",Nt.classList.add("tooltip-container"),ct.disabled=!0,tt.disabled=!0,wt.disabled=!0,ct.value="",tt.value="",Rt.classList.add("disabled-wrapper"),nt.disabled=!0}function _n(){Jt.innerHTML="",D.categories.filter(e=>!e.isDeleted).forEach(e=>{const c=document.createElement("span");c.className="pill",c.textContent=e.name,c.dataset.categoryId=e.id,e.description&&(c.dataset.tooltip=e.description),K.isFinished?c.classList.add("disabled"):c.addEventListener("click",()=>{document.querySelectorAll("#category-selection-container .pill").forEach(t=>t.classList.remove("active")),c.classList.add("active"),On(e),$s(e),ds(e),us(e.name),Rt.classList.remove("disabled-wrapper"),nt.disabled=K.isFinished;const r=K.lastWinnerByCategory[e.name];if(r){const t=D.students.find(a=>a.identity.studentId===r);t&&Me(t,e.name)}else{as.innerHTML="",Mn(null),gt(-1),nt.disabled=!1;const t=document.querySelector(".current-winner-highlight");t&&t.classList.remove("current-winner-highlight")}}),K.isFinished||c.addEventListener("contextmenu",r=>{cn(r,[{label:"تغییر نام",icon:"✏️",action:()=>{os((a,i)=>{const s=Qs(D,e,a);s.success?(e.isGradedCategory=i,ce(),ke(D.info.name,`نام دسته‌بندی «${e.name}» به «${a}» تغییر یافت.`),_n(),Re(),ee(`✅ نام دسته‌بندی به «${a}» تغییر یافت.`)):ee(`⚠️ ${s.message}`)},{title:"ویرایش دسته‌بندی",initialName:e.name,initialIsGraded:e.isGradedCategory,saveButtonText:"ذخیره تغییرات"})}},{label:"حذف دسته‌بندی",icon:"🗑️",className:"danger",action:()=>{Ce(`آیا از انتقال دسته‌بندی «${e.name}» به سطل زباله مطمئن هستید؟`,()=>{const a={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${e.name}» از کلاس «${D.info.name}»`,restoreData:{categoryId:e.id,classId:D.info.scheduleCode}};ge.unshift(a),ge.length>50&&ge.pop();const i=e.name.toLowerCase();if(D.students.forEach(s=>{s.logs.scores&&s.logs.scores[i]&&s.logs.scores[i].forEach(l=>{l.isDeleted=!0})}),Ve&&Ve.id===e.id){On(null),as.innerHTML="",ds(null),us(null),Rt.classList.add("disabled-wrapper"),nt.disabled=!0;const s=document.querySelector(".current-winner-highlight");s&&s.classList.remove("current-winner-highlight")}e.isDeleted=!0,ke(D.info.name,`دسته‌بندی «${e.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),_n(),Re(),ee(`✅ دسته‌بندی «${e.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}}])}),Jt.appendChild(c)});const o=document.createElement("span");o.className="pill add-category-pill",o.textContent="+",o.title="افزودن دسته‌بندی جدید",K.isFinished?o.classList.add("disabled"):o.addEventListener("click",()=>{os((e,c)=>{if(D.categories.find(a=>a.name.toLowerCase()===e.toLowerCase()&&!a.isDeleted)){ee("⚠️ این دسته‌بندی از قبل وجود دارد.");return}const t=new ut(e,"",c);D.categories.push(t),ce(),ke(D.info.name,`دسته‌بندی جدید «${e}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),_n(),ee(`✅ دسته‌بندی «${e}» اضافه شد.`)})}),Jt.appendChild(o)}function dr(){if(K.lastUsedCategoryId){if(K.isFinished)return;const n=Jt.querySelector(`.pill[data-category-id="${K.lastUsedCategoryId}"]`);n&&n.click()}K.winnerHistory&&K.winnerHistory.length>0&&(gt(K.winnerHistory.length-1),Me())}function $s(n){n?nt.textContent=`نفر بعدی در ${n.name}`:nt.textContent="نفر بعدی"}function ds(n){if(K.isFinished){ct.disabled=!0,tt.disabled=!0,wt.disabled=!0,Nt.setAttribute("title","جلسه خاتمه یافته است");return}n&&n.isGradedCategory?(ct.disabled=!1,tt.disabled=!1,wt.disabled=!1,Nt.removeAttribute("title")):(ct.disabled=!0,tt.disabled=!0,wt.disabled=!0,n?Nt.setAttribute("title","برای این دسته‌بندی قابلیت نمره دهی تعریف نشده است"):Nt.setAttribute("title","ابتدا یک دسته‌بندی را انتخاب کنید"))}function us(n){const o=document.querySelector(".student-stats-table");if(!o||(o.querySelectorAll(".current-category-highlight").forEach(a=>{a.classList.remove("current-category-highlight")}),!n))return;let c=-1;const r=o.querySelectorAll("thead th");if(r.forEach((a,i)=>{a.textContent.trim()===n&&(c=i)}),c===-1)return;r[c].classList.add("current-category-highlight"),o.querySelectorAll("tbody tr").forEach(a=>{const i=a.cells[c];i&&i.classList.add("current-category-highlight")})}function ze(n){Ke(n);const o=document.getElementById("student-profile-modal"),e=document.getElementById("modal-profile-student-name"),c=document.getElementById("modal-profile-content-container"),r=document.getElementById("modal-profile-close-btn");if(!o||!e||!c||!r)return;e.textContent=`پروفایل: ${n.identity.name}`,e.style.cursor="pointer",e.onclick=()=>{const l=_e,h=D;Ee(()=>{Os(l,h)})},c.innerHTML="";const t=document.createElement("div");t.className="profile-header-actions";const a=document.createElement("button");a.className="btn-icon btn-icon-label",a.title="انتقال دانش‌آموز",a.innerHTML="<span>➡️</span><span>انتقال</span>",a.addEventListener("click",()=>{const l=_e,h=D;Ee(()=>{As(l,h)})});const i=document.createElement("button");i.className="btn-icon btn-icon-label",i.title="حذف دانش‌آموز",i.innerHTML="<span>🗑️</span><span>حذف</span>",i.style.color="var(--color-strong-warning)",i.addEventListener("click",()=>{const l=_e,h=D;Ee(()=>{Ce(`آیا از انتقال دانش‌آموز «${l.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const g={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${l.identity.name}» از کلاس «${h.info.name}»`,restoreData:{studentId:l.identity.studentId,classId:h.info.scheduleCode}};ge.unshift(g),ge.length>50&&ge.pop(),l.isDeleted=!0,ke(h.info.name,`دانش‌آموز «${l.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),lt(),Re(),st(),ee(`✅ دانش‌آموز «${l.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0,onCancel:()=>{ze(l)}})})});const s=document.createElement("button");s.className="btn-icon btn-icon-label",s.title="افزودن یادداشت جدید",s.innerHTML="<span>📝</span><span>یادداشت</span>",s.addEventListener("click",()=>{const l=_e;we.value="",we.dispatchEvent(new Event("input",{bubbles:!0})),it(h=>{h&&(l.addNote(h),ce(),ke(D.info.name,`یادداشت جدیدی برای دانش‌آموز «${l.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:l.identity.studentId}),Me(),ee("✅ یادداشت با موفقیت ثبت شد.")),ze(l)}),Ee(()=>{$e("add-note-modal"),we.focus()})}),t.appendChild(a),t.appendChild(i),t.appendChild(s),c.appendChild(t),ur(c),Mi(c),r.onclick=()=>Ee(),$e("student-profile-modal")}function ur(n){if(!_e||!D)return;const o=document.createElement("div");o.className="scoring-section",o.innerHTML=`
        <h3>ثبت نمره جدید</h3>
        <div id="modal-graded-pills" class="category-pills"></div>
        <div class="input-group centered-input-group" style="margin-top: 15px;">
            <input type="number" id="modal-new-score-value" placeholder="نمره (مثلا: 85)">
        </div>
        <textarea id="modal-new-score-comment" placeholder="توضیحات این نمره (اختیاری)..." style="margin-top: 10px;"></textarea>
        <button id="modal-add-score-btn" class="btn-success" style="width: 100%; margin-top: 10px;">ثبت نمره</button>
    `;const e=o.querySelector("#modal-graded-pills");Se(D.categories).filter(t=>t.isGradedCategory).forEach(t=>{const a=document.createElement("span");a.className="pill",a.textContent=t.name,a.dataset.skillName=t.name,a.addEventListener("click",()=>{e.querySelectorAll(".pill").forEach(i=>i.classList.remove("active")),a.classList.add("active")}),e.appendChild(a)}),o.querySelector("#modal-add-score-btn").addEventListener("click",()=>{const t=e.querySelector(".pill.active");if(!t){ee("⚠️لطفاً یک مهارت را برای نمره‌دهی انتخاب کنید.");return}const a=t.dataset.skillName,i=o.querySelector("#modal-new-score-value"),s=o.querySelector("#modal-new-score-comment"),l=i.value,h=s.value.trim();if(!l){ee("لطفاً مقدار نمره را وارد کنید.");return}_e.addScore(a,parseFloat(l),h),ce(),ke(D.info.name,`نمره ${l} در ${a} برای «${_e.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:_e.identity.studentId}),Re(),Me(),i.value="",s.value="";const g=document.getElementById("modal-profile-content-container"),p=g.querySelector(".history-section");p&&p.remove(),Mi(g),ee(`✅ نمره برای مهارت ${a} با موفقیت ثبت شد.`)}),n.appendChild(o)}function Mi(n){if(!_e)return;const o=document.createElement("div");o.className="history-section";const e=document.createElement("div");e.className="history-section-header";const c=document.createElement("h3");c.textContent="سوابق دانش‌آموز",e.appendChild(c),o.appendChild(e),fr(o),Ri(o),zi(o),n.appendChild(o)}function fr(n){if(!_e)return;const o=_e,e=D.sessions.reduce((u,b)=>{const f=b.studentRecords[o.identity.studentId];return u+(f&&f.attendance==="absent"?1:0)},0),c=Object.values(o.categoryIssues||{}).reduce((u,b)=>u+b,0),r=document.createElement("div");r.className="stats-summary-box",r.innerHTML=`
        <p><strong>کل انتخاب:</strong> ${o.statusCounters.totalSelections}</p>
        <p><strong>غیبت:</strong> ${e}</p>
        <p><strong>فرصت از دست رفته:</strong> ${o.statusCounters.missedChances||0}</p>
        <p><strong>مشکل:</strong> ${c}</p>
    `,n.appendChild(r),r.querySelector("p:nth-child(1)");const t=r.querySelector("p:nth-child(4)"),a=Se(D.categories),i=document.createElement("div");if(i.className="stats-breakdown",a.length>0){a.forEach(b=>{var C;const f=b.name,v=((C=o.categoryCounts)==null?void 0:C[f])||0,y=document.createElement("p");y.className="stats-breakdown-item",y.innerHTML=`<strong>${f}:</strong> ${v}`,i.appendChild(y)});const u=r.querySelector("p:first-child");u&&(u.classList.add("collapsible-toggle"),u.onclick=()=>{i.classList.toggle("open"),u.classList.toggle("open")},u.after(i))}const s=document.createElement("div");s.className="stats-breakdown",a.length>0&&(a.forEach(u=>{var y;const b=u.name,f=((y=o.categoryIssues)==null?void 0:y[b])||0,v=document.createElement("p");v.className="stats-breakdown-item",v.innerHTML=`<strong>${b}:</strong> ${f}`,s.appendChild(v)}),t&&(t.classList.add("collapsible-toggle"),t.onclick=()=>{s.classList.toggle("open"),t.classList.toggle("open")},r.appendChild(s)));const l=document.createElement("p"),h=document.createElement("strong");h.textContent="تکالیف ناقص:";const g=document.createElement("span");g.style.marginRight="5px";const p=Qe(D);wn(o,p,g,{includePrefix:!1}),l.appendChild(h),l.appendChild(g),r.appendChild(l)}function Ri(n){if(!_e)return;const o=_e,e=document.createElement("h4");e.textContent="تاریخچه نمرات:",e.style.marginTop="20px";const c=document.createElement("ul");c.className="list-container";const r=Object.values(o.logs.scores||{}).flat().filter(t=>!t.isDeleted).sort((t,a)=>new Date(a.timestamp)-new Date(t.timestamp));r.length===0?c.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>':r.forEach(t=>{const a=document.createElement("li");a.className="score-history-item";const i=document.createElement("div");i.className="item-content";const s=document.createElement("div");s.className="score-info";const l=document.createElement("span");l.className="score-skill-badge",l.textContent=t.skill;const h=document.createElement("span");h.className="score-value",h.textContent=`نمره: ${t.value}`;const g=document.createElement("span");if(g.className="score-date",g.textContent=new Date(t.timestamp).toLocaleDateString("fa-IR"),s.appendChild(l),s.appendChild(h),s.appendChild(g),i.appendChild(s),t.comment){const u=document.createElement("p");u.className="score-comment",u.innerHTML=pi(t.comment),u.addEventListener("click",()=>{we.value=t.comment,we.dispatchEvent(new Event("input",{bubbles:!0})),it(b=>{t.comment=b,ce(),ke(D.info.name,`توضیحات نمره ${t.value} (${t.skill}) برای دانش‌آموز «${o.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:o.identity.studentId}),ze(o),ee("✅ توضیحات نمره با موفقیت ویرایش شد.")}),Ee(()=>{$e("add-note-modal"),we.focus()})}),i.appendChild(u)}const p=document.createElement("button");p.className="btn-icon delete-item-btn",p.innerHTML="🗑️",p.title="حذف این نمره",p.addEventListener("click",()=>{Ee(()=>{Ce(`آیا از انتقال نمره ${t.value} در مهارت «${t.skill}» به سطل زباله مطمئن هستید؟`,()=>{const u={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"score",description:`نمره ${t.value} (${t.skill}) برای «${o.identity.name}»`,restoreData:{scoreId:t.id,skill:t.skill,studentId:o.identity.studentId,classId:D.info.scheduleCode}};ge.unshift(u),ge.length>50&&ge.pop(),t.isDeleted=!0,ce(),ke(D.info.name,`نمره ${t.value} (${t.skill}) دانش‌آموز «${o.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ze(o),ee("✅ نمره به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{ze(o)}})})}),a.appendChild(i),a.appendChild(p),c.appendChild(a)}),n.appendChild(e),n.appendChild(c)}function zi(n){if(!_e)return;const o=document.createElement("h4");o.textContent="تاریخچه یادداشت‌ها:",o.style.marginTop="20px";const e=document.createElement("ul");e.className="list-container",!_e.profile.notes||_e.profile.notes.length===0?e.innerHTML='<div class="no-content-message">هنوز یادداشتی ثبت نشده است.</div>':[..._e.profile.notes].filter(r=>!r.isDeleted).sort((r,t)=>new Date(t.timestamp)-new Date(r.timestamp)).forEach(r=>{const t=document.createElement("li");t.className="note-history-item";const a=document.createElement("div");a.className="item-content";const i=document.createElement("div");i.className="note-info";const s=document.createElement("span");s.className="note-date",s.textContent=new Date(r.timestamp).toLocaleDateString("fa-IR");const l=document.createElement("button");l.className="btn-icon delete-item-btn",l.innerHTML="🗑️",l.title="حذف این یادداشت",l.addEventListener("click",()=>{const g=_e;Ee(()=>{Ce("آیا از انتقال این یادداشت به سطل زباله مطمئن هستید؟",()=>{const p={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"note",description:`یادداشت برای دانش‌آموز «${g.identity.name}»`,restoreData:{noteId:r.id,studentId:g.identity.studentId,classId:D.info.scheduleCode}};ge.unshift(p),ge.length>50&&ge.pop(),r.isDeleted=!0,ke(D.info.name,`یادداشت دانش‌آموز «${g.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),ze(g),ee("✅ یادداشت به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{ze(g)}})})}),i.appendChild(s),i.appendChild(l);const h=document.createElement("p");h.className="note-content",h.innerHTML=pi(r.content),h.addEventListener("click",()=>{const g=_e;we.value=r.content,we.dispatchEvent(new Event("input",{bubbles:!0})),it(p=>{r.content=p,ce(),ke(D.info.name,`یادداشت دانش‌آموز «${g.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:g.identity.studentId}),ze(g),ee("✅یادداشت با موفقیت ویرایش شد.")}),Ee(()=>{$e("add-note-modal"),we.focus()})}),a.appendChild(i),a.appendChild(h),t.appendChild(a),e.appendChild(t)}),n.appendChild(o),n.appendChild(e)}function $i(n){es.innerHTML="",n.forEach((o,e)=>{const c=document.createElement("option");c.value=e,c.textContent=o.trim(),es.appendChild(c)})}function fs(){Qn.innerHTML="",gs.forEach(n=>{const o=document.createElement("li");o.className="preview-item";const e=document.createElement("input");e.type="checkbox",e.checked=!0,e.dataset.name=n;const c=document.createElement("label");c.textContent=n,o.appendChild(e),o.appendChild(c),Qn.appendChild(o)})}function mr(n){const o=document.createElement("div");o.className="list-item-buttons";const e=document.createElement("button");return e.className="btn-icon",e.innerHTML="📝",e.title="ویرایش یادداشت کلاس",n.note||(e.style.display="none"),e.addEventListener("click",c=>{c.stopPropagation(),Hn(n)}),o.appendChild(e),o}function hr(n){const o=document.createElement("div");o.style.flexGrow="1",o.style.display="flex",o.style.flexDirection="column",o.style.alignItems="flex-start";const e=document.createElement("span");e.textContent=n.info.name,e.classList.add("class-name-display"),o.appendChild(e);const c=Se(n.students).length,r=Se(n.sessions).filter(l=>l.isFinished).length,t=_r(n.info.scheduleDays),a=document.createElement("div");a.classList.add("class-stats-row");const i=document.createElement("span");i.textContent=`${c} نفر`,i.classList.add("student-count-badge"),a.appendChild(i);const s=document.createElement("span");if(s.textContent=`${r} جلسه`,s.classList.add("session-count-badge"),a.appendChild(s),t){const l=document.createElement("span");l.textContent=t,l.classList.add("schedule-days-badge"),a.appendChild(l)}return o.appendChild(a),o.addEventListener("click",()=>{Pe(n),Ze(null),tn(D.liveSession),We(),ye("session-page")}),o}function pr(n){const o=document.createElement("li"),e=document.createElement("input");e.type="checkbox",e.className="mass-selection-checkbox",e.checked=rt.includes(n.info.name),e.addEventListener("click",l=>{l.stopPropagation()}),e.addEventListener("change",()=>{const l=n.info.name;if(e.checked)rt.includes(l)||rt.push(l);else{const h=rt.indexOf(l);h>-1&&rt.splice(h,1)}}),o.appendChild(e);const c=hr(n);o.appendChild(c);const r=document.createElement("div");r.style.display="flex",r.style.flexDirection="column",r.style.gap="5px",r.style.alignItems="flex-end",r.style.marginLeft="10px";const t=document.createElement("div");if(t.className="list-item-badges",n.liveSession&&!n.liveSession.isCancelled&&!n.liveSession.isDeleted){const l=document.createElement("span");l.className="warning-badge",l.textContent="جلسه باز",t.appendChild(l),o.classList.add("has-unfinished-session")}const a=document.createElement("span");if(a.className=`type-badge ${n.info.type}`,a.textContent=n.info.type==="online"?"آنلاین":"حضوری",a.title="نوع کلاس",t.appendChild(a),ms(n).type==="incomplete"){const l=document.createElement("span");l.className="type-badge cancelled-badge",l.textContent="زمان‌بندی ناقص",l.style.cursor="pointer",l.title="برای تکمیل زمان‌بندی کلیک کنید",l.addEventListener("click",h=>{h.stopPropagation(),Ce("زمان‌بندی این کلاس کامل نیست. برای نمایش صحیح در لیست، لطفاً روزها و ساعت برگزاری را مشخص کنید.",()=>{Mt(n)},{confirmText:"تنظیمات",confirmClass:"btn-primary"})}),t.appendChild(l)}else{const l=wr(n,oe);if(l){const h=document.createElement("span");h.className="type-badge conflict-badge",h.textContent="تداخل زمانی",h.style.cursor="pointer",h.title=`تداخل با کلاس: ${l}`,h.addEventListener("click",g=>{g.stopPropagation(),Ce(`زمان برگزاری این کلاس با کلاس «${l}» تداخل دارد. لطفاً زمان‌بندی را بررسی کنید.`,()=>{Mt(n)},{confirmText:"تنظیمات",confirmClass:"btn-primary"})}),t.appendChild(h)}}r.appendChild(t);const s=mr(n);return r.appendChild(s),o.appendChild(r),o.addEventListener("contextmenu",l=>{const h={label:"پشتیبان‌گیری از این کلاس",icon:"📤",action:()=>{rn([n.info.name])}},g=rt.length;g>1&&rt.includes(n.info.name)&&(h.label=`پشتیبان‌گیری از ${g} کلاس`,h.action=()=>{rn(rt),Jn([]),He()});const p=[{label:At.classList.contains("selection-mode-active")?"لغو انتخاب":"انتخاب چند کلاس",icon:"✔️",action:()=>{const u=At.classList.contains("selection-mode-active");At.classList.toggle("selection-mode-active"),u&&(Jn([]),He())}},h,{label:"یادداشت کلاس",icon:"📝",action:()=>{Hn(n)}},{label:"تنظیمات کلاس",icon:"⚙️",action:()=>{Mt(n)}},{label:"گزارش فعالیت‌ها",icon:"📋",action:()=>{Ni(n.info.name)}},{label:"تغییر نام",icon:"✏️",action:()=>{const u=n.info.name,b=document.getElementById("add-note-modal-title");b.textContent="تغییر نام کلاس",we.value=u,we.rows=1,it(f=>{const v=f.trim();if(v&&v!==u){const y=Xs(u,v);y.success?(aa(u,v),ke(v,`نام کلاس از «${u}» به «${v}» تغییر یافت.`,{type:"VIEW_SESSIONS"}),ce(),He(),ee(`✅نام کلاس به «${v}» تغییر یافت.`)):ee(y.message)}b.textContent="ثبت یادداشت جدید",we.rows=4}),$e("add-note-modal"),we.focus(),we.select()}},{label:"حذف کلاس",icon:"🗑️",className:"danger",action:()=>{Ce(`آیا از انتقال کلاس «${n.info.name}» به سطل زباله مطمئن هستید؟`,()=>{const u={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"classroom",description:`کلاس «${n.info.name}»`,restoreData:{name:n.info.name}};ge.unshift(u),ge.length>50&&ge.pop(),n.isDeleted=!0,ce(),He(),ee(`✅ کلاس «${n.info.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}];cn(l,p)}),o}function Wn(){const n=document.getElementById("class-management-stats");if(!n)return;const o=Object.values(oe).filter(t=>!t.isDeleted),e=o.length,c=o.reduce((t,a)=>t+Se(a.students).length,0);let r="";qe.lastBackupTimestamp&&(r=`
            <div class="stats-row backup-stat">
                <span>آخرین پشتیبان: <strong>${new Date(qe.lastBackupTimestamp).toLocaleString("fa-IR",{year:"numeric",month:"numeric",day:"numeric",weekday:"long",hour:"2-digit",minute:"2-digit"})}</strong></span>
            </div>
        `),n.innerHTML=`
        <div class="stats-row main-stats">
            <span>کل کلاس‌ها: <strong>${e}</strong></span>
            <span>|</span>
            <span>کل دانش‌آموزان: <strong>${c}</strong></span>
        </div>
        ${r} 
    `}function He(){Wn(),At.innerHTML="",Object.values(oe).sort((o,e)=>{const c=ms(o),r=ms(e);return c.sortIndex!==r.sortIndex?c.sortIndex-r.sortIndex:c.type==="upcoming"?c.nextTimestamp-r.nextTimestamp:new Date(o.info.creationDate)-new Date(e.info.creationDate)}).forEach(o=>{if(o.isDeleted)return;const e=pr(o);At.appendChild(e)})}function lt(){Yn.innerHTML="",D&&Se(D.students).forEach(n=>{const o=document.createElement("li"),e=document.createElement("span");e.textContent=n.identity.name,e.style.flexGrow="1",e.className="student-name-link",e.addEventListener("click",()=>{ze(n)}),o.appendChild(e),o.addEventListener("contextmenu",c=>{cn(c,[{label:"تغییر نام",icon:"✏️",action:()=>{Os(n,D)}},{label:"انتقال دانش‌آموز",icon:"➡️",action:()=>{As(n,D)}},{label:"حذف دانش‌آموز",icon:"🗑️",className:"danger",action:()=>{Ce(`آیا از انتقال دانش‌آموز «${n.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const t={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${n.identity.name}» از کلاس «${D.info.name}»`,restoreData:{studentId:n.identity.studentId,classId:D.info.scheduleCode}};ge.unshift(t),ge.length>50&&ge.pop(),n.isDeleted=!0,ke(D.info.name,`دانش‌آموز «${n.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),lt(),ee(`✅ دانش‌آموز «${n.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}])}),Yn.appendChild(o)})}function Ft(){if(Xn.innerHTML="",!D)return;D.categories.filter(o=>!o.isDeleted).forEach(o=>{const e=document.createElement("li"),c=document.createElement("div");c.className="name-and-badge-container";const r=document.createElement("span");if(r.textContent=o.name,c.appendChild(r),o.isGradedCategory){const a=document.createElement("span");a.className="category-badge",a.textContent="نمره‌دار",c.appendChild(a)}const t=document.createElement("button");t.className="btn-icon",t.innerHTML="🗑️",t.style.color="var(--color-warning)",t.addEventListener("click",()=>{Ce(`آیا از انتقال دسته‌بندی «${o.name}» به سطل زباله مطمئن هستید؟`,()=>{const a={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${o.name}» از کلاس «${D.info.name}»`,restoreData:{categoryId:o.id,classId:D.info.scheduleCode}};ge.unshift(a),ge.length>50&&ge.pop(),o.isDeleted=!0,ke(D.info.name,`دسته‌بندی «${o.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),Ft(),ee(`✅ دسته‌بندی «${o.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}),e.appendChild(c),e.appendChild(t),Xn.appendChild(e)})}function Fi(){if(!D)return;const n=D.info.type||"in-person",o=document.querySelector(`#settings-page input[name="class-type-setting"][value="${n}"]`);o&&(o.checked=!0);const e=D.info.scheduleDays||[];document.querySelectorAll('input[name="schedule-day"]').forEach(c=>{c.checked=e.includes(parseInt(c.value))}),document.getElementById("settings-schedule-start").value=D.info.scheduleStartTime||"",document.getElementById("settings-schedule-end").value=D.info.scheduleEndTime||""}function Qt(n){document.querySelectorAll(".page").forEach(e=>{e.classList.remove("active")});const o=document.getElementById(n);o&&o.classList.add("active"),n==="class-management-page"?(Pe(null),Ze(null),Ke(null),He(),ts.style.display="flex"):ts.style.display="none",Ai()}function ye(n,o={}){const{tab:e}=o,c={pageId:n,currentClassName:D?D.info.name:null,selectedSessionNumber:K?K.sessionNumber:null,selectedStudentId:_e?_e.identity.studentId:null};let r=`#${n}`;const t=new URLSearchParams(window.location.hash.split("?")[1]||"");D?t.set("class",D.info.name):t.delete("class"),K?t.set("session",K.sessionNumber):t.delete("session"),_e?t.set("student",_e.identity.studentId):t.delete("student"),n==="session-dashboard-page"&&e?t.set("tab",e):n!=="session-dashboard-page"&&t.delete("tab");const a=t.toString();a&&(r+=`?${a}`),window.location.hash!==r&&history.pushState(c,"",r),Qt(n)}function gr(n,o){const e=document.createElement("div");e.className="list-item-buttons",e.style.gap="10px";const c=document.createElement("button");if(c.className="btn-icon",c.innerHTML="📝",c.title="ویرایش یادداشت جلسه",n.note||(c.style.display="none"),c.addEventListener("click",r=>{r.stopPropagation(),zs(n,o)}),!n.isFinished&&!n.isCancelled){const r=document.createElement("button");r.className="btn-success",r.textContent="پایان جلسه",r.style.fontSize="12px",r.style.padding="4px 10px",r.style.whiteSpace="nowrap",r.addEventListener("click",t=>{t.stopPropagation(),Ce(`جلسه شماره ${o} خاتمه پیدا خواهد کرد!`,()=>{D.endSpecificSession(n.sessionNumber),ce(),ke(D.info.name,`جلسه ${o} خاتمه یافت.`,{type:"VIEW_SESSIONS"}),We(),Ce("جلسه با موفقیت خاتمه یافت. آیا مایل به ایجاد فایل پشتیبان هستید؟",()=>{if(ot){ee("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است.");return}rn(),ee("✅فایل پشتیبان با موفقیت ایجاد شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}),e.appendChild(r)}return e.appendChild(c),e}function yr(n,o){const e=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="flex-start",e.style.flexGrow="1";const c=new Date(n.startTime).toLocaleDateString("fa-IR"),r=document.createElement("span");r.className="session-list-title";const t=document.createElement("div");t.style.display="flex",t.style.gap="5px",t.style.marginTop="5px";const a=new Date(n.startTime).toLocaleDateString("fa-IR",{weekday:"long"}),i=document.createElement("span");if(i.className="type-badge day-badge",i.textContent=a,t.appendChild(i),n.isCancelled){r.textContent=`لغو شده - تاریخ: ${c}`,e.style.cursor="default";const s=document.createElement("span");s.className="type-badge cancelled-badge",s.textContent="لغو شده",t.appendChild(s)}else r.textContent=`جلسه ${o} - تاریخ: ${c}`,e.style.cursor="pointer",e.addEventListener("click",()=>{Ze(n),$t()});if(e.appendChild(r),n.isFinished){const s=document.createElement("span");s.className="type-badge finished-badge",s.textContent="خاتمه یافته",t.appendChild(s)}if(n.isMakeup){const s=document.createElement("span");s.className="type-badge makeup-badge",s.textContent="جبرانی",t.appendChild(s)}return e.appendChild(t),e}function vr(n,o){const e=document.createElement("li"),c=o.get(n.sessionNumber),r=yr(n,c);e.appendChild(r);const t=gr(n,c);return e.appendChild(t),e.addEventListener("contextmenu",a=>{const i=[{label:"یادداشت جلسه",icon:"📝",action:()=>{zs(n,c)}},{label:n.isCancelled?"بازگردانی جلسه":"لغو جلسه",icon:"❌",action:()=>{const s=n.isCancelled?"بازگردانی جلسه":"لغو جلسه",l=n.isCancelled?"آیا از بازگردانی این جلسه مطمئن هستید؟":"آیا از لغو این جلسه مطمئن هستید؟ جلسه لغو شده در آمار تاثیری ندارد اما قابل بازگردانی است.";Ce(l,()=>{n.isCancelled=!n.isCancelled;const h=n.isCancelled?`جلسه ${c} لغو شد.`:`جلسه لغو شده (تاریخ: ${new Date(n.startTime).toLocaleDateString("fa-IR")}) بازگردانی شد.`;ke(D.info.name,h,{type:"VIEW_SESSIONS"}),ce(),We(),ee(n.isCancelled?"✅جلسه لغو شد.":"✅جلسه بازگردانی شد.")},{confirmText:s,confirmClass:"btn-warning"})}},{label:"تغییر وضعیت جبرانی",icon:"🔄",action:()=>{D.markAsMakeup(n.sessionNumber),ce();const s=n.isMakeup?`جلسه ${c} به عنوان جبرانی علامت‌گذاری شد.`:`جلسه ${c} از حالت جبرانی خارج شد.`;ke(D.info.name,s,{type:"VIEW_SESSIONS"}),We()}},{label:"حذف جلسه",icon:"🗑️",className:"danger",action:()=>{const s=n.isCancelled?"لغو شده":c;Ce(`آیا از انتقال جلسه ${s} به سطل زباله مطمئن هستید؟`,()=>{const l={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"session",description:`جلسه ${s} از کلاس «${D.info.name}»`,restoreData:{sessionNumber:n.sessionNumber,classId:D.info.scheduleCode}};ge.unshift(l),ge.length>50&&ge.pop(),n.isDeleted=!0,ke(D.info.name,`جلسه ${s} به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),We(),ee(`✅ جلسه ${s} به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}];cn(a,i)}),e}function We(){const n=document.getElementById("session-list");if(!D)return;if(n.innerHTML="",D.sessions.length===0){n.innerHTML="<li>هنوز جلسه‌ای شروع نشده است.</li>";return}const o=Qe(D);[...Se(D.sessions)].reverse().forEach(c=>{const r=vr(c,o);n.appendChild(r)})}function Gt(n){if(mt.innerHTML="",n.length>0)n.forEach(o=>{const e=document.createElement("div");e.textContent=o.identity.name,e.addEventListener("click",()=>{ze(o),mt.style.display="none",is.value=""}),mt.appendChild(e)}),mt.style.display="block";else if(is.value.trim()!==""){const o=document.createElement("div");o.className="no-results",o.textContent="پیدا نشد",mt.appendChild(o),mt.style.display="block"}else mt.style.display="none"}function En(n){if(at.innerHTML="",n.length>0)n.forEach(o=>{const e=document.createElement("div");if(e.className="global-search-result",o.type==="student"){const c=document.createElement("span");c.className="student-name",c.textContent=o.student.identity.name;const r=document.createElement("span");r.className="class-name",r.textContent=`کلاس: ${o.classroom.info.name}`,e.addEventListener("click",()=>{Pe(o.classroom),ze(o.student),at.style.display="none",Zt.value=""}),r.addEventListener("click",t=>{t.stopPropagation(),Pe(o.classroom),Ze(null),tn(o.classroom.liveSession),We(),ye("session-page"),at.style.display="none",Zt.value=""}),e.appendChild(c),e.appendChild(r)}else if(o.type==="classroom"){const c=document.createElement("span");c.className="student-name",c.textContent=`[کلاس] ${o.classroom.info.name}`,e.addEventListener("click",()=>{Pe(o.classroom),Ze(null),tn(o.classroom.liveSession),We(),ye("session-page"),at.style.display="none",Zt.value=""}),e.appendChild(c)}at.appendChild(e)}),at.style.display="block";else if(Zt.value.trim()!==""){const o=document.createElement("div");o.className="no-results",o.textContent="پیدا نشد",at.appendChild(o),at.style.display="block"}else at.style.display="none"}function on(){const n=document.getElementById("trashed-items-list");if(n.innerHTML="",ge.length===0){n.innerHTML='<li style="text-align: center; padding: 20px;">سطل زباله خالی است.</li>';return}ge.forEach((o,e)=>{const c=document.createElement("li"),r=document.createElement("span");r.textContent=o.description,r.style.flexGrow="1";const t=document.createElement("div");t.className="list-item-buttons";const a=document.createElement("button");a.className="btn-icon",a.innerHTML="🔄",a.title="بازیابی",a.addEventListener("click",()=>{var g;let s=!1,l=null;const h=o.restoreData;switch(o.type){case"classroom":{const p=oe[h.name];p&&!p.isDeleted?l=`کلاسی با نام «${h.name}» از قبل فعال است.`:p&&p.isDeleted&&(p.isDeleted=!1,s=!0);break}case"student":{const p=Object.values(oe).find(b=>b.info.scheduleCode===h.classId),u=p==null?void 0:p.students.find(b=>b.identity.studentId===h.studentId);u&&(u.isDeleted=!1,s=!0);break}case"session":{const p=Object.values(oe).find(b=>b.info.scheduleCode===h.classId),u=p==null?void 0:p.sessions.find(b=>b.sessionNumber===h.sessionNumber);u&&(u.isDeleted=!1,s=!0);break}case"category":{const p=Object.values(oe).find(b=>b.info.scheduleCode===h.classId),u=p==null?void 0:p.categories.find(b=>b.id===h.categoryId);u&&(u.isDeleted=!1,s=!0);break}case"score":{const p=Object.values(oe).find(f=>f.info.scheduleCode===h.classId),u=p==null?void 0:p.students.find(f=>f.identity.studentId===h.studentId),b=(g=u==null?void 0:u.logs.scores[h.skill.toLowerCase()])==null?void 0:g.find(f=>f.id===h.scoreId);b&&(b.isDeleted=!1,s=!0);break}case"note":{const p=Object.values(oe).find(f=>f.info.scheduleCode===h.classId),u=p==null?void 0:p.students.find(f=>f.identity.studentId===h.studentId),b=u==null?void 0:u.profile.notes.find(f=>f.id===h.noteId);b&&(b.isDeleted=!1,s=!0);break}}s?(ge.splice(e,1),ce(),on(),o.type==="classroom"&&He(),ee("✅ آیتم با موفقیت بازیابی شد.")):ee(l?`⚠️ ${l}`:"⚠️ آیتم اصلی برای بازیابی یافت نشد.")});const i=document.createElement("button");i.className="btn-icon",i.innerHTML="🔥",i.title="حذف دائمی",i.addEventListener("click",()=>{Ce("آیا از حذف دائمی این آیتم مطمئن هستید؟ این عمل غیرقابل بازgشت است.",()=>{const s=o.restoreData,l=g=>Object.values(oe).find(p=>p.info.scheduleCode===g);let h;switch(o.type){case"classroom":delete oe[s.name];break;case"student":h=l(s.classId),Nn({identity:{studentId:s.studentId}},h);break;case"session":h=l(s.classId),h&&ni(h.info.name,s.sessionNumber);break;case"category":h=l(s.classId),h&&si(h.info.name,s.categoryId);break;case"score":h=l(s.classId),h&&ii(h.info.name,s.studentId,s.skill,s.scoreId);break;case"note":h=l(s.classId),h&&ai(h.info.name,s.studentId,s.noteId);break}ge.splice(e,1),ce(),on(),ee("✅ آیتم برای همیشه حذف شد.")},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),t.appendChild(a),t.appendChild(i),c.appendChild(r),c.appendChild(t),n.appendChild(c)})}function br(){const n=document.getElementById("absentees-summary-container");n&&(n.innerHTML=`
        <div id="absentees-summary-box" class="absentees-summary">
            <div class="absentees-summary-header">
                <h4>لیست غایبین جلسه شماره <span id="absentee-summary-session-number"></span></h4>
                <button id="copy-absentees-btn" class="btn-icon" title="کپی لیست غایبین">📋</button>
            </div>
            <div id="absentees-summary-list" class="summary-list"></div>
        </div>
    `)}function Pi(){const n=document.getElementById("absentees-summary-box"),o=document.getElementById("absentees-summary-list"),e=document.getElementById("absentee-summary-session-number");if(!n||!o||!e){console.error("Could not find all absentee summary elements.");return}if(!D||!K){n.classList.remove("visible");return}const c=Se(D.students).filter(t=>{const a=K.studentRecords[t.identity.studentId];return a&&a.attendance==="absent"}),r=Qe(D);e.textContent=r.get(K.sessionNumber),c.length>0?n.classList.add("visible"):n.classList.remove("visible"),o.innerHTML="",c.forEach(t=>{const i=(l=>D.sessions.reduce((h,g)=>{if(g.isDeleted||g.isCancelled)return h;const p=g.studentRecords[l.identity.studentId];return h+(p&&p.attendance==="absent"?1:0)},0))(t),s=document.createElement("span");s.className="summary-name",s.textContent=`${t.identity.name} (غیبت: ${i})`,s.addEventListener("click",()=>{s.classList.add("fading-out"),setTimeout(()=>{K.setAttendance(t.identity.studentId,"present"),ce(),st()},200)}),o.appendChild(s)})}function Cr(){const n=document.getElementById("copy-absentees-btn");if(!n){console.error("Could not find the copy absentees button to attach listener.");return}n.addEventListener("click",()=>{if(!D||!K)return;const o=Se(D.students).filter(r=>{const t=K.studentRecords[r.identity.studentId];return t&&t.attendance==="absent"});if(o.length===0){ee("⚠️لیست غایبین خالی است.");return}const e=r=>D.sessions.reduce((t,a)=>{if(a.isDeleted||a.isCancelled)return t;const i=a.studentRecords[r.identity.studentId];return t+(i&&i.attendance==="absent"?1:0)},0);let c=`لیست غایبین جلسه شماره ${cr()}:

`;o.forEach(r=>{const t=e(r);c+=`- ${r.identity.name} (تعداد غیبت‌ها: ${t})
`}),navigator.clipboard.writeText(c).then(()=>{ee("✅لیست غایبین با موفقیت کپی شد.")}).catch(r=>{console.error("Failed to copy text: ",r),ee("❌خطا در کپی کردن لیست.")})})}function kn(){const n=document.getElementById("demo-mode-banner");n&&(ot?(n.classList.add("visible"),document.body.classList.add("demo-mode-active")):(n.classList.remove("visible"),document.body.classList.remove("demo-mode-active")))}function ms(n){const{scheduleDays:o,scheduleStartTime:e,scheduleEndTime:c}=n.info,r=o&&o.length>0,t=e&&c;if(!r&&!t)return{type:"unscheduled",sortIndex:3};if(!r||!t)return{type:"incomplete",sortIndex:2};const a=new Date,i=a.getDay(),s=a.getHours()*60+a.getMinutes(),[l,h]=e.split(":").map(Number),[g,p]=c.split(":").map(Number),u=l*60+h,b=g*60+p;if(o.includes(i)&&s>=u&&s<b)return{type:"active",sortIndex:0};for(let f=0;f<=7;f++){const v=(i+f)%7;if(o.includes(v)){if(f===0&&s>=u)continue;const y=new Date(a);return y.setDate(a.getDate()+f),y.setHours(l,h,0,0),{type:"upcoming",sortIndex:1,nextTimestamp:y.getTime()}}}return{type:"upcoming",sortIndex:1,nextTimestamp:9999999999999}}function wr(n,o){const{scheduleDays:e,scheduleStartTime:c,scheduleEndTime:r}=n.info;if(!e||!e.length||!c||!r)return null;const[t,a]=c.split(":").map(Number),[i,s]=r.split(":").map(Number),l=t*60+a,h=i*60+s;for(const g of Object.values(o)){if(g===n||g.isDeleted||g.info.name===n.info.name)continue;const p=g.info;if(!p.scheduleDays||!p.scheduleDays.length||!p.scheduleStartTime||!p.scheduleEndTime||!e.some(S=>p.scheduleDays.includes(S)))continue;const[b,f]=p.scheduleStartTime.split(":").map(Number),[v,y]=p.scheduleEndTime.split(":").map(Number),C=b*60+f,E=v*60+y;if(l<E&&h>C)return g.info.name}return null}function _r(n){if(!n||n.length===0)return"";const o={6:"شنبه",0:"۱شنبه",1:"۲شنبه",2:"۳شنبه",3:"۴شنبه",4:"۵شنبه",5:"جمعه"};return[...n].sort((c,r)=>{const t={6:0,0:1,1:2,2:3,3:4,4:5,5:6};return t[c]-t[r]}).map(c=>o[c]).join("، ")}async function Hi(){const n=document.getElementById("restore-points-list");n.innerHTML='<li style="text-align:center; padding:20px;">در حال بارگذاری...</li>';try{const o=await na();if(o.length===0){n.innerHTML='<li style="text-align:center; padding:20px;">هیچ فایل پشتیبانی یافت نشد.</li>';return}n.innerHTML="",o.forEach(e=>{const c=document.createElement("li");c.className="restore-point-card";const r=new Date(e.timestamp).toLocaleString("fa-IR"),t=(e.file.size/1024).toFixed(1)+" KB";c.innerHTML=`
                <div class="restore-card-header">
                    <span class="restore-date">${r}</span>
                    <span class="restore-size">${t}</span>
                </div>
                <div class="restore-desc">${e.metadata.description||"بدون توضیحات"}</div>
                <div class="restore-actions">
                    <button class="btn-restore-action">بازگردانی</button>
                </div>
            `,c.querySelector(".btn-restore-action").addEventListener("click",async()=>{try{const i=await e.file.text(),h=(await new hs().loadAsync(i,{base64:!0})).file("backup.json");if(!h)throw new Error("فایل backup.json یافت نشد.");const g=await h.async("string"),p=JSON.parse(g);$n(p)}catch(i){console.error("Restore failed:",i),ee("❌ فایل پشتیبان معتبر نیست.")}}),n.appendChild(c)})}catch(o){console.error("Failed to load snapshots:",o),n.innerHTML='<li style="text-align:center; color:red;">خطا در بارگذاری اطلاعات.</li>'}}const Er=Object.freeze(Object.defineProperty({__proto__:null,_internalShowPage:Qt,addCategoryBtn:Ea,addClassBtn:oa,addNoteModal:Ra,addScoreBtn:Wa,addStudentBtn:fa,appHeader:ts,attendanceListUl:Kt,attendanceMassActionsContainer:Cn,attendancePage:ka,attendancePane:zt,attendanceSearchInput:bt,backToSessionsBtn:da,backToStudentPageBtn:Fa,backupDataBtn:Da,breadcrumbContainer:Dt,cancelImportBtn:wa,cancelNoteBtn:$a,categoryListUl:Xn,categoryModal:Xa,categoryModalCancelBtn:Qa,categoryModalSaveBtn:xi,categoryModalTitle:Ii,classListHeader:Ia,classListUl:At,classManagementPage:vi,classSaveNoteBtn:za,closeActiveModal:Ee,closeContextMenu:Ct,closeNavBtn:Ta,columnMappingPage:ba,columnSelectDropdown:es,confirmColumnBtn:Ca,confirmModalCancelBtn:ss,confirmModalConfirmBtn:jt,confirmModalMessage:_i,contextMenu:_t,csvCancelBtn:ga,csvConfirmBtn:pa,csvFileInput:va,csvPreviewList:Qn,csvPreviewPage:ha,customConfirmModal:Aa,displayWinner:Me,finishAttendanceBtn:Sa,globalStudentSearchInput:Zt,globalStudentSearchResultsDiv:at,gradedCategoryPillsContainer:Pa,hamburgerMenuBtn:xa,handleUndo:Bi,importCsvBtn:ya,initiateBackupProcess:rn,isGradedCheckbox:Za,massCommentAppendCheckbox:Ns,massCommentBtn:rs,massCommentCancelBtn:nr,massCommentContent:Xt,massCommentModal:er,massCommentModalTitle:tr,massCommentSaveBtn:sr,massCommentStudentCountMessage:Li,newCategoryModalIsGradedCheckbox:Ds,newCategoryModalNameInput:Yt,newCategoryNameInput:_a,newClassNameInput:ra,newNoteContent:we,newScoreCommentTextarea:Si,newScoreValueInput:Ha,newStudentNameInput:ua,openContextMenu:cn,openModal:$e,overlay:Ba,pasteArea:Ci,processMassHomeworkComment:cs,processPasteBtn:ma,profileScoresListUl:ja,profileStatsSummaryDiv:Ua,quickGradeFormWrapper:Nt,quickGradeSubmitBtn:wt,quickNoteTextarea:tt,quickScoreInput:ct,renderAttendancePage:st,renderBreadcrumbs:Ai,renderClassList:He,renderClassManagementStats:Wn,renderColumnSelector:$i,renderGlobalSearchResults:En,renderImportPreview:fs,renderLogModal:Ni,renderMassCommentControls:Ms,renderRestorePointsPage:Hi,renderScoresHistory:Ri,renderSearchResults:Gt,renderSessionDashboard:$t,renderSessions:We,renderSettingsCategories:Ft,renderSettingsOther:Fi,renderSettingsStudentList:lt,renderStudentNotes:zi,renderStudentStatsList:Re,renderTrashPage:on,restoreDataBtn:Na,restoreFileInput:wi,secureConfirmCancelBtn:Ma,secureConfirmCode:ki,secureConfirmConfirmBtn:bn,secureConfirmInput:Bt,secureConfirmMessage:Ei,secureConfirmModal:Oa,selectStudentBtn:nt,selectStudentBtnWrapper:Rt,sessionDashboardPage:ir,setAutoDirectionOnInput:Oi,settingsClassNameHeader:Bs,settingsPage:la,settingsStudentListUl:Yn,setupDashboardTabs:Ti,setupLongPress:qt,showCategoryModal:os,showClassNoteModal:Hn,showCustomConfirm:Ce,showMassCommentModal:Rs,showMoveStudentModal:As,showNotification:ee,showPage:ye,showRenameStudentModal:Os,showRestoreConfirmModal:$n,showSecureConfirm:Di,showSessionNoteModal:zs,showSettingsPage:Mt,showStudentProfile:ze,showUndoToast:ar,sideNavMenu:La,studentSearchInput:is,studentSearchResultsDiv:mt,studentStatsHeader:ns,switchDashboardTab:an,trashedCategoriesList:Ka,trashedClassesList:qa,trashedNotesList:Ja,trashedScoresList:Ya,trashedSessionsList:Va,trashedStudentsList:Ga,triggerFileDownload:ls,undoBtn:ca,undoMessage:bi,undoToast:zn,updateDemoModeBanner:kn},Symbol.toStringTag,{value:"Module"}));function kr(){const n=window.location.hash;if(!n||n==="#")return!1;const[o,e]=n.split("?"),c=o.substring(1),r=new URLSearchParams(e),t=r.get("class"),a=parseInt(r.get("session"),10),i=r.get("student"),s=r.get("tab")||"selector";if(t&&oe[t])Pe(oe[t]),a&&D.getSession(a)&&Ze(D.getSession(a)),i&&D.students.find(l=>l.identity.studentId===i)&&Ke(D.students.find(l=>l.identity.studentId===i));else return!1;switch(c){case"session-page":We(),ye("session-page");break;case"session-dashboard-page":$t(c==="attendance-page"?"attendance":s);break;case"settings-page":Bs.textContent=`تنظیمات کلاس: ${D.info.name}`,lt(),Ft(),ye("settings-page");break;case"student-profile-page":$t(s),ze(_e);break;default:return!1}return!0}document.addEventListener("DOMContentLoaded",()=>{const{globalStudentSearchInput:n,newClassNameInput:o,addClassBtn:e,undoBtn:c,newStudentNameInput:r,addStudentBtn:t,pasteArea:a,processPasteBtn:i,csvPreviewList:s,csvConfirmBtn:l,csvCancelBtn:h,importCsvBtn:g,csvFileInput:p,columnSelectDropdown:u,confirmColumnBtn:b,cancelImportBtn:f,newCategoryNameInput:v,addCategoryBtn:y,selectStudentBtn:C,attendancePage:E,finishAttendanceBtn:S,classListHeader:I,studentStatsHeader:x,hamburgerMenuBtn:L,sideNavMenu:N,closeNavBtn:R,overlay:P,backupDataBtn:Q,restoreDataBtn:k,restoreFileInput:z,confirmModalCancelBtn:m,confirmModalConfirmBtn:H,secureConfirmCancelBtn:ue,secureConfirmConfirmBtn:Z,newNoteContent:fe,classSaveNoteBtn:F,cancelNoteBtn:ne,studentSearchInput:A,studentSearchResultsDiv:M,isGradedCheckbox:re,categoryModalSaveBtn:te,categoryModalCancelBtn:Y,massCommentBtn:Be,massCommentCancelBtn:Ne,massCommentSaveBtn:pe,massCommentContent:ve,massCommentAppendCheckbox:Le,attendanceSearchInput:De}=Er,Je=document.getElementById("trash-nav-btn");document.querySelector(".global-search-container .search-icon"),Dn(),kn(),kr()||(He(),ye("class-management-page"));function d(B,G){const U=document.querySelector(B);if(!U)return;const X=U.querySelector(".search-icon"),ae=U.querySelector(".animated-search-input");!X||!ae||(X.addEventListener("mousedown",de=>{de.preventDefault()}),X.addEventListener("click",()=>{U.classList.contains("search-active")||(U.classList.add("search-active"),ae.focus())}),ae.addEventListener("blur",()=>{setTimeout(()=>{U.classList.remove("search-active"),ae.value="",G&&G([])},150)}))}De.addEventListener("input",()=>{const B=De.value.toLowerCase().trim(),G=Gn(B);Kt.querySelectorAll(".attendance-list-item").forEach(X=>{const ae=X.querySelector(".student-name");if(ae){const de=ae.textContent,ie=Xe(de.toLowerCase()),he=ie.includes(Xe(B)),be=ie.includes(Xe(G));he||be?X.style.display="flex":X.style.display="none"}})}),Y.addEventListener("click",()=>{Ee(),Pn(null)}),te.addEventListener("click",()=>{const B=Yt.value.trim(),G=Ds.checked;typeof Tn=="function"&&Tn(B,G)}),window.addEventListener("scroll",Ct),document.addEventListener("click",B=>{_t.classList.contains("visible")&&!_t.contains(B.target)&&Ct(),A.contains(B.target)||(M.style.display="none");const G=B.target.closest(".log-action-link");if(G&&G.dataset.action)try{const U=JSON.parse(G.dataset.action);Un(U)}catch(U){console.error("Could not parse log action:",U)}}),Rt.addEventListener("click",()=>{(Rt.classList.contains("disabled-wrapper")||nt.disabled)&&(nt.classList.add("shake-animation"),setTimeout(()=>{nt.classList.remove("shake-animation")},200))}),x.addEventListener("click",()=>{const B=new Date().getTime();B-bs>500?vn(1):vn(xn+1),ui(B),xn===5&&(vn(0),Ce("آیا از صفر کردن تمام شمارنده‌های دانش‌آموزان مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{ti(),Re(),ee("تمام آمارها صفر شدند ✅.")},{confirmText:"بله",confirmClass:"btn-warning"}))}),I.addEventListener("click",()=>{const B=new Date().getTime();B-vs>500?yn(1):yn(In+1),di(B),In===5&&(yn(0),Ce("آیا از ساخت یک کلاس تستی تصادفی مطمئن هستید؟",()=>{function G(){const U=`کلاس تستی ${Object.keys(oe).length+1}`,X=new Kn({name:U,type:"online"});["علی رضایی","مریم حسینی","زهرا احمدی","رضا محمدی","فاطمه کریمی"].forEach(de=>X.addStudent(new pn({name:de}))),oe[U]=X,ce(),He()}G(),ee("کلاس تستی با موفقیت ساخته شد ✅!")},{confirmText:"بساز",confirmClass:"btn-success"}))}),ue.addEventListener("click",()=>{Ee(),nn(null)}),Z.addEventListener("click",()=>{typeof Ln=="function"&&Ln(),Ee(),nn(null)}),m.addEventListener("click",()=>{Ee(ws)}),H.addEventListener("click",()=>{Ee(Cs)}),C.addEventListener("click",()=>{if(ct.value.trim()!==""||tt.value.trim()!==""){ee("⚠️لطفاً ابتدا با دکمه «ثبت»، تغییرات را ذخیره کنید و یا نمره و یادداشت را پاک کنید.");return}if(!D||!K||!Ve)return;const B=D.selectNextWinner(Ve.name,K);if(B){const G=K.studentRecords[B.identity.studentId];if(G&&G.attendance==="absent"&&B.statusCounters.missedChances++,G&&G.hadIssue){B.statusCounters.missedChances++;const X=Ve.name;B.categoryIssues[X]=(B.categoryIssues[X]||0)+1}G&&G.wasOutOfClass&&(B.statusCounters.outOfClassCount=(B.statusCounters.outOfClassCount||0)+1,B.statusCounters.missedChances++);const U={winner:B,categoryName:Ve.name};K.winnerHistory.push(U),K.winnerHistory.length>10&&K.winnerHistory.shift(),gt(K.winnerHistory.length-1),K.lastUsedCategoryId=Ve.id,K.lastSelectedWinnerId=B.identity.studentId,Re(),setTimeout(()=>Me(),0),ce()}else ee("❌دانش‌آموز واجد شرایطی برای انتخاب یافت نشد.")}),y.addEventListener("click",()=>{if(!D)return;const B=v.value.trim(),G=re.checked;if(!B){alert("⚠️لطفاً نام دسته‌بندی را وارد کنید.");return}const U=D.categories.find(ae=>ae.name.toLowerCase()===B.toLowerCase());if(U)if(U.isDeleted){const ae=D.categories.findIndex(de=>de===U);ae>-1&&D.categories.splice(ae,1)}else{alert("⚠️این دسته‌بندی از قبل وجود دارد.");return}const X=new ut(B,"",G);D.categories.push(X),ce(),ke(D.info.name,`دسته‌بندی جدید «${B}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),Ft(),v.value="",re.checked=!1}),document.querySelectorAll('#settings-page input[name="class-type-setting"]').forEach(B=>{B.addEventListener("change",()=>{if(!D)return;const G=B.value,U=D.info.type||"in-person";if(G===U)return;const X=ie=>ie==="online"?"آنلاین":"حضوری",ae=X(U),de=X(G);Ce(`آیا از تغییر نوع کلاس از «${ae}» به «${de}» مطمئن هستید؟`,()=>{D.info.type=G,ce(),ke(D.info.name,`نوع کلاس به «${de}» تغییر یافت.`,{type:"VIEW_CLASS_SETTINGS"}),He(),ee(`✅ نوع کلاس به «${de}» تغییر یافت.`)},{confirmText:"بله",confirmClass:"btn-warning",onCancel:()=>{const ie=document.querySelector(`#settings-page input[name="class-type-setting"][value="${U}"]`);ie&&(ie.checked=!0)}})})});const $=document.querySelectorAll('input[name="schedule-day"]'),_=document.getElementById("settings-schedule-start"),w=document.getElementById("settings-schedule-end");$.forEach(B=>{B.addEventListener("change",()=>{if(!D)return;const G=Array.from($).filter(U=>U.checked).map(U=>parseInt(U.value));D.info.scheduleDays=G,ce()})});const T=()=>{D&&(D.info.scheduleStartTime=_.value,D.info.scheduleEndTime=w.value,ce())};_.addEventListener("change",T),w.addEventListener("change",T),v.addEventListener("keyup",B=>{B.key==="Enter"&&y.click()}),b.addEventListener("click",()=>{if(!Sn){alert("❌خطایی رخ داده است. لطفاً فایل را دوباره انتخاب کنید."),ye("settings-page");return}const B=parseInt(u.value,10),X=Sn.split(`
`).slice(1).map(ae=>{var ie;return(ie=ae.split(",")[B])==null?void 0:ie.trim()}).filter(ae=>ae&&ae.length>0);X.length>0?(Ut(X),fs(),ye("csv-preview-page")):alert("هیچ نامی در ستون انتخاب شده پیدا نشد. لطفاً ستون دیگری را امتحان کنید یا فایل خود را بررسی کنید."),gn(null)}),g.addEventListener("click",()=>{p.click()}),p.addEventListener("change",B=>{const G=B.target.files[0];if(!G)return;const U=new FileReader;U.onload=X=>{const ae=X.target.result;gn(ae);const ie=ae.split(`
`)[0].split(",");$i(ie),ye("column-mapping-page")},U.readAsText(G),B.target.value=null}),f.addEventListener("click",()=>{gn(null),ye("settings-page")}),l.addEventListener("click",()=>{const B=s.querySelectorAll('input[type="checkbox"]:checked');let G=!1;B.forEach(U=>{const X=U.dataset.name,ae=D.students.find(ie=>ie.identity.name.toLowerCase()===X.toLowerCase());if(ae)if(ae.isDeleted)Nn(ae,D);else{console.log(`دانش‌آموز «${X}» به دلیل تکراری بودن اضافه نشد.`);return}const de=new pn({name:X});D.addStudent(de),D.sessions.length>0&&(Se(D.sessions).filter(ie=>ie.isFinished&&!ie.isCancelled).forEach(ie=>{ie.setAttendance(de.identity.studentId,"absent")}),Ge(de,D),G=!0)}),ce(),ke(D.info.name,`${B.length} دانش‌آموز جدید از لیست ورودی به کلاس اضافه شدند.`,{type:"VIEW_SESSIONS"}),lt(),G&&ft(B.length),ye("settings-page"),a.value="",Ut([])}),h.addEventListener("click",()=>{Ut([]),ye("settings-page")}),i.addEventListener("click",()=>{const B=a.value.trim();if(!B){alert("کادر متنی خالی است. لطفاً اسامی را وارد کنید.");return}const G=B.split(`
`).map(U=>U.trim()).filter(U=>U.length>0);G.length>0?(Ut(G),fs(),ye("csv-preview-page")):alert("هیچ نام معتبری برای ورود پیدا نشد.")}),r.addEventListener("keyup",B=>{B.key==="Enter"&&t.click()}),t.addEventListener("click",()=>{if(!D)return;const B=r.value.trim();if(!B){alert("لطفاً نام دانش‌آموز را وارد کنید.");return}const G=D.students.find(X=>X.identity.name.toLowerCase()===B.toLowerCase());if(G)if(G.isDeleted)Nn(G,D);else{alert("❌دانش‌آموزی با این نام از قبل در این کلاس وجود دارد.");return}const U=new pn({name:B});D.addStudent(U),D.sessions.length>0&&(Se(D.sessions).filter(X=>X.isFinished&&!X.isCancelled).forEach(X=>{X.setAttendance(U.identity.studentId,"absent")}),Ge(U,D),ft(1)),ce(),ke(D.info.name,`دانش‌آموز «${B}» به کلاس اضافه شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:U.identity.studentId}),lt(),Re(),r.value="",r.focus()}),document.getElementById("new-session-btn").addEventListener("click",()=>{if(D){const B=D.sessions.find(U=>!U.isFinished&&!U.isCancelled&&!U.isDeleted);if(B){ee(`⚠️ جلسه ${B.sessionNumber} هنوز تمام نشده است. لطفاً ابتدا با دکمه ✅ آن را خاتمه دهید.`);return}const G=()=>{const U=X=>{const ae=D.startNewSession();tn(ae),Ze(ae),D.students.forEach(he=>{ps.setAttendance(he.identity.studentId,"present")}),ce();const ie=Qe(D).get(ae.sessionNumber);ke(D.info.name,`جلسه ${ie} شروع شد.`,{type:"VIEW_SESSIONS"}),$t(X?"attendance":"selector")};Ce("آیا تمایل به انجام فرآیند حضور و غیاب دارید؟",()=>U(!0),{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success",onCancel:()=>U(!1)})};D.hasSessionToday()?Ce("شما امروز یک جلسه برای این کلاس ثبت کرده‌اید. آیا از شروع یک جلسه جدید دیگر مطمئن هستید؟",G,{confirmText:"بله",confirmClass:"btn-warning"}):G()}}),e.addEventListener("click",()=>{const B=o.value.trim(),G=document.querySelector('input[name="class-type"]:checked');if(!B&&!G){ee("⚠️لطفاً نام و نوع کلاس را مشخص کنید.");return}if(!B){ee("⚠️لطفاً نام کلاس را وارد کنید.");return}if(!G){ee("⚠️لطفاً نوع کلاس را انتخاب کنید.");return}if(oe[B]){oe[B].isDeleted?ee("⚠️ کلاسی با این نام در سطل زباله است. ابتدا آن را بازیابی کنید و یا آن را پاک کنید."):ee("⚠️کلاسی با این نام از قبل وجود دارد.");return}const U=G.value,X=new Kn({name:B,type:U});oe[B]=X,ce(),ke(B,`کلاس «${B}» ایجاد شد.`,{type:"VIEW_SESSIONS"}),He(),ee(`✅ کلاس «${B}» با موفقیت ایجاد شد.`),o.value="",G.checked=!1}),n.addEventListener("input",B=>{const G=B.target.value;if(G.length<2){En([]);return}const U=G.toLowerCase(),X=Gn(U),ae=[];for(const de in oe){const ie=oe[de];if(ie.isDeleted)continue;const he=Xe(de.toLowerCase()),be=he.includes(Xe(U)),xe=he.includes(Xe(X));(be||xe)&&ae.push({type:"classroom",classroom:ie})}for(const de in oe){const ie=oe[de];if(ie.isDeleted)continue;Se(ie.students).filter(be=>{const xe=Xe(be.identity.name.toLowerCase()),Oe=xe.includes(Xe(U)),Ht=xe.includes(Xe(X));return Oe||Ht}).forEach(be=>{ae.push({type:"student",student:be,classroom:ie})})}En(ae)}),o.addEventListener("keyup",B=>{B.key==="Enter"&&e.click()}),c.addEventListener("click",Bi),S.addEventListener("click",()=>{an("selector")}),A.addEventListener("input",B=>{const G=B.target.value;if(!G){Gt([]);return}const U=G.toLowerCase(),X=Gn(U),de=Se(D.students).filter(ie=>{const he=Xe(ie.identity.name.toLowerCase()),be=he.includes(Xe(U)),xe=he.includes(Xe(X));return be||xe});Gt(de)}),A.addEventListener("focus",()=>{A.value&&Gt(A.value)}),wt.addEventListener("click",()=>{const B=ct.value,G=tt.value.trim();let U;if(Bn)U=Bn.student;else{const ae=K==null?void 0:K.winnerHistory[je];U=ae==null?void 0:ae.winner}if(!U){ee("❌خطا: دانش‌آموز معتبری برای ثبت نمره یافت نشد.");return}const X=Ve;if(!U||!X){ee("⚠️لطفاً ابتدا یک دانش‌آموز و یک دسته‌بندی را انتخاب کنید.");return}if(!B){ee("⚠️لطفاً مقدار نمره را وارد کنید.");return}if(B>100||B<0){ee("❌نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}U&&(U.addScore(X.name,parseFloat(B),G),ke(D.info.name,`نمره ${B} در ${X.name} برای «${U.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:U.identity.studentId}),ce(),Re(),ee(`✅نمره برای ${U.identity.name} در مهارت ${X.name} ثبت شد.`),ct.value="",tt.value="",Me())});const j=B=>{B.key==="Enter"&&B.ctrlKey&&(B.preventDefault(),wt.click())};ct.addEventListener("keydown",j),tt.addEventListener("keydown",j),ne.addEventListener("click",()=>{Ee()}),F.addEventListener("click",()=>{const B=fe.value.trim(),G=_s;Ee(()=>{typeof G=="function"&&G(B)})});const q=document.getElementById("move-student-confirm-btn"),O=document.getElementById("move-student-cancel-btn"),V=document.getElementById("move-student-class-select");O.addEventListener("click",()=>{Ee()}),q.addEventListener("click",()=>{const B=V.value,G=oe[B],{studentToMove:U,sourceClassForMove:X}=Xi;if(!U||!X||!G){ee("خطایی رخ داد. لطفاً دوباره امتحان کنید⚠️.","error"),Ee();return}const ae=ei(U,X,G);ae.success?(ke(X.info.name,`دانش‌آموز «${U.identity.name}» به کلاس «${B}» منتقل شد.`,{type:"VIEW_SESSIONS"}),ke(B,`دانش‌آموز «${U.identity.name}» از کلاس «${X.info.name}» به این کلاس منتقل شد.`,{type:"VIEW_SESSIONS"}),ce(),lt(),Re(),st(),ee(`دانش‌آموز «${U.identity.name}» با موفقیت به کلاس «${B}» منتقل شد✅.`)):ee(ae.message,"error"),Ee()}),L.addEventListener("click",()=>{N.style.width="300px",P.classList.add("modal-visible")}),L.addEventListener("click",()=>{N.style.width="300px",P.classList.add("modal-visible")});const se=document.getElementById("header-settings-btn");se&&se.addEventListener("click",()=>{D&&Mt(D)}),R.addEventListener("click",me),R.addEventListener("click",me),P.addEventListener("click",me),Je.addEventListener("click",()=>{on(),ye("trash-page"),me()});const J=document.getElementById("restore-points-nav-btn");J&&J.addEventListener("click",()=>{Hi(),ye("restore-points-page"),me()}),document.getElementById("demo-mode-btn").addEventListener("click",()=>{ot?Ue():(me(),Ce("شما در حال ورود به حالت نمایش (Demo) هستید. در این حالت، هیچ‌کدام از تغییرات شما ذخیره نخواهد شد. آیا ادامه می‌دهید؟",()=>{ri(),kn(),me()},{confirmText:"تایید",confirmClass:"btn-warning",onCancel:me}))});const Ie=document.getElementById("exit-demo-btn");Ie&&Ie.addEventListener("click",()=>{ot&&Ue()}),Q.addEventListener("click",()=>{if(ot){ee("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است."),me();return}me(),rn()}),k.addEventListener("click",()=>{if(ot){ee("⚠️ بازیابی اطلاعات در حالت نمایش (Demo) غیرفعال است."),me();return}z.click(),me()}),z.addEventListener("change",B=>{const G=B.target.files[0];if(!G)return;const U=new FileReader;U.onload=async X=>{const ae=X.target.result;try{const de=JSON.parse(ae);if(de.metadata&&de.data)$n(de);else{const ie=de.classrooms||de,he=de.trashBin||[];Ce("آیا از بازیابی اطلاعات مطمئن هستید؟ تمام داده‌های فعلی شما بازنویسی خواهد شد.",()=>{kt(ie),Rn(he),Vt({lastRestoreTimestamp:new Date().toISOString()}),ce(),He(),ye("class-management-page"),ee("✅اطلاعات با موفقیت بازیابی شد.")},{confirmText:"بازیابی کن",confirmClass:"btn-warning"})}}catch{try{const be=(await new hs().loadAsync(ae,{base64:!0})).file("backup.json");if(!be)throw new Error("فایل backup.json در فایل پشتیبان یافت نشد.");const xe=await be.async("string"),Oe=JSON.parse(xe);if(Oe.metadata&&Oe.metadata.version==="2.0-b64")$n(Oe);else throw new Error("فایل پشتیبان معتبر نیست (نسخه نامشخص).")}catch(ie){ee("❌خطا در خواندن فایل. لطفاً فایل پشتیبان معتبر انتخاب کنید."),console.error("Restore error (zip/base64):",ie)}}},U.readAsText(G),B.target.value=null}),window.addEventListener("popstate",B=>{if(pt){Ee(null,!0);return}if(Ct(),B.state){const{pageId:G,currentClassName:U,selectedSessionNumber:X,selectedStudentId:ae}=B.state;U&&(Pe(oe[U]),X&&Ze(D.getSession(X)),ae&&Ke(D.students.find(de=>de.identity.studentId===ae))),G==="session-page"?(We(),Qt(G)):G==="student-profile-page"?(We(),ye("session-page"),ze(_e)):Qt(G)}else Pe(null),Ze(null),Ke(null),Qt("class-management-page")}),document.addEventListener("keydown",B=>{var X;const G=document.activeElement;if(!["INPUT","TEXTAREA","SELECT"].includes(G.tagName)){if(B.key.toLowerCase()==="o"&&B.shiftKey&&vi.classList.contains("active")&&(B.preventDefault(),wi.click()),B.key==="Escape"){if(_t.classList.contains("visible")){Ct();return}if(pt){Ee();return}switch((X=document.querySelector(".page.active"))==null?void 0:X.id){case"csv-preview-page":case"column-mapping-page":ye("settings-page");break;case"student-profile-page":Ke(null),ye(K?"student-page":"session-page");break;case"attendance-page":ye("student-page");break;case"student-page":Ze(null),We(),ye("session-page");break;case"settings-page":case"session-page":Pe(null),ye("class-management-page");break}return}if(K){const ae=B.key.toLowerCase();switch(" ascfg".includes(ae)&&B.preventDefault(),ae){case" ":C.click();break;case"a":E.classList.contains("active")?history.back():(st(),ye("attendance-page"));break;case"s":document.getElementById("session-page").classList.contains("active")&&history.back();break;case"c":document.querySelector(".back-to-classes-btn").click();break;case"f":const de=document.querySelector(".action-column .search-icon");de&&de.click();break;case"g":if(studentProfilePage.classList.contains("active"))history.back();else{const ie=K.lastSelectedWinnerId;if(ie){const he=D.students.find(be=>be.identity.studentId===ie);he&&(Ke(he),(void 0)(),ye("student-profile-page"))}else ee("⚠️ابتدا یک نفر را انتخاب کنید تا پروفایل او نمایش داده شود.")}break;case"arrowleft":{const ie=document.querySelector('button[title="برنده قبلی"]');ie&&!ie.disabled&&(B.preventDefault(),ie.click());break}case"arrowright":{const ie=document.querySelector('button[title="برنده بعدی"]');ie&&!ie.disabled&&(B.preventDefault(),ie.click());break}}}}});function me(){N.style.width="0",P.classList.add("modal-closing"),setTimeout(()=>{P.classList.remove("modal-visible","modal-closing")},300)}function Ue(){Ce("آیا از خروج از حالت نمایش (Demo) مطمئن هستید؟ با خروج، تمام تغییرات آزمایشی شما حذف شده و داده‌های اصلی شما بازیابی خواهند شد.",()=>{oi(),Pe(null),Ze(null),Ke(null),He(),ye("class-management-page"),kn(),me()},{confirmText:"خروج",confirmClass:"btn-success"})}d(".global-search-container .animated-search-container",En),d(".action-column-header .animated-search-container",Gt),Ir(),[we,Si,tt,Ci].forEach(B=>{B&&Oi(B)});function Ge(B,G){const U=Se(G.students).filter(Te=>Te.identity.studentId!==B.identity.studentId);if(U.length===0)return;const X=U.reduce((Te,Fe)=>Fe.statusCounters.totalSelections>Te.statusCounters.totalSelections?Fe:Te,U[0]);if(!X||X.statusCounters.totalSelections===0)return;B.categoryCounts=JSON.parse(JSON.stringify(X.categoryCounts)),B.statusCounters.totalSelections=X.statusCounters.totalSelections;const ae=U.reduce((Te,Fe)=>Te+Fe.statusCounters.totalSelections,0),de=U.reduce((Te,Fe)=>Te+(Fe.statusCounters.missedChances||0),0),ie=ae>0?de/ae:0;B.statusCounters.missedChances=Math.round(B.statusCounters.totalSelections*ie);const he=Se(G.categories),be={};he.forEach(Te=>{const Fe=U.reduce((Zn,qn)=>Zn+(qn.categoryCounts[Te.name]||0),0),jn=U.reduce((Zn,qn)=>Zn+(qn.categoryIssues[Te.name]||0),0);be[Te.name]=Fe>0?jn/Fe:0}),he.forEach(Te=>{const Fe=B.categoryCounts[Te.name]||0,jn=be[Te.name]||0;B.categoryIssues[Te.name]=Math.round(Fe*jn)});const xe=G.liveSession;xe?B.onboardingSession=xe.sessionNumber:B.onboardingSession=G.sessions.length+1;const Oe=Se(G.sessions).filter(Te=>Te.isFinished&&!Te.isCancelled),Ht="📝 یادداشت خودکار سیستم",ji=`این دانش‌آموز  از جلسه شماره ${Oe.length} به کلاس اضافه شد. آمار مشارکت او بر اساس فعال‌ترین دانش‌آموز و آمار «فرصت از دست رفته» او بر اساس میانگین کلاس ثبت گردید:`,Lt=[];B.statusCounters.totalSelections>0&&Lt.push(`کل انتخاب‌ها: ${B.statusCounters.totalSelections}`),B.statusCounters.missedChances>0&&Lt.push(`فرصت‌های از دست رفته: ${B.statusCounters.missedChances}`);for(const Te in B.categoryCounts){const Fe=B.categoryCounts[Te];Fe>0&&Lt.push(`انتخاب در «${Te}»: ${Fe}`)}for(const Te in B.categoryIssues){const Fe=B.categoryIssues[Te];Fe>0&&Lt.push(`مشکل در «${Te}»: ${Fe}`)}if(Lt.length>0){const Te=`${Ht}
${ji}

- ${Lt.join(`
- `)}`;B.addNote(Te)}}function ft(B){const U=`چون این کلاس جلسات برگزار شده دارد، برای ${B>1?"دانش‌آموزان جدید":"دانش‌آموز جدید"} آمار پایه‌ای (متناسب با سایر دانش‌آموزان) ثبت شد تا در فرایند انتخاب اختلالی ایجاد نشود.`;Ce(U,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}const Ae="13.1.0",It="748";{const B=` (ساخت ${It})`;document.getElementById("app-version").textContent=`نسخه ${Ae}${B}`}function Pt(){console.log("Starting universal backfill for writing scores...");let B=0;for(const G in oe){const U=oe[G];if(U.isDeleted)continue;let X=0;Se(U.students).forEach(de=>{const ie=de.logs.scores;if(!(ie&&ie.writing&&ie.writing.length>0)){let be=-1;for(const xe in ie)xe!=="writing"&&ie[xe].forEach(Oe=>{Oe.value>be&&(be=Oe.value)});if(be>-1){const xe=`Automatically assigned based on the highest score (${be}) from other skills.`;de.addScore("Writing",be,xe),X++}}}),X>0&&(console.log(`Updated ${X} student(s) in class: ${U.info.name}.`),B+=X)}B>0?(ce(),console.log(`Update complete. A total of ${B} student(s) were updated across all classes. Data saved.`),document.getElementById("student-page").classList.contains("active")&&Re()):console.log("No students needed updating in any class.")}window.backfillWritingScoresForAll=Pt;function et(){console.log("Starting backfill for 'outOfClassCount' and 'wasOutOfClass' properties...");let B=0,G=0;const U=localStorage.getItem("teacherAssistantData_v2");if(!U){console.log("No data found in localStorage. Nothing to do.");return}const X=JSON.parse(U);for(const ae in X){const de=X[ae];de.students&&de.students.forEach(ie=>{ie.statusCounters&&typeof ie.statusCounters.outOfClassCount>"u"&&(ie.statusCounters.outOfClassCount=0,B++)}),de.sessions&&de.sessions.forEach(ie=>{if(ie.studentRecords)for(const he in ie.studentRecords){const be=ie.studentRecords[he];typeof be.wasOutOfClass>"u"&&(be.wasOutOfClass=!1,G++)}})}localStorage.setItem("teacherAssistantData_v2",JSON.stringify(X)),console.log(`Backfill complete. Updated ${B} students and ${G} session records. Data saved.`),Dn(),D&&Re()}window.backfillExitCounters=et;function ln(){console.log("🧹 Starting orphaned data cleanup...");let B=0;for(const G in oe){const U=oe[G];if(U.isDeleted)continue;let X=!1;const ae=new Set(U.students.filter(he=>!he.isDeleted).map(he=>he.identity.studentId)),de=new Map(U.students.map(he=>[he.identity.studentId,he.identity.name])),ie=[];U.sessions.forEach(he=>{if(he.isDeleted)return;const be=[];for(const xe in he.studentRecords)if(!ae.has(xe)){const Oe=de.get(xe)||"Unknown/Deleted";be.push(`  - Removed student record for: ${Oe} (ID: ${xe})`),delete he.studentRecords[xe],B++,X=!0}for(const xe in he.lastWinnerByCategory){const Oe=he.lastWinnerByCategory[xe];if(!ae.has(Oe)){const Ht=de.get(Oe)||"Unknown/Deleted";be.push(`  - Removed '${xe}' last winner: ${Ht} (ID: ${Oe})`),delete he.lastWinnerByCategory[xe],B++,X=!0}}if(he.lastSelectedWinnerId&&!ae.has(he.lastSelectedWinnerId)){const xe=he.lastSelectedWinnerId,Oe=de.get(xe)||"Unknown/Deleted";be.push(`  - Cleared 'lastSelectedWinnerId': ${Oe} (ID: ${xe})`),he.lastSelectedWinnerId=null,B++,X=!0}if(be.length>0){const Oe=Qe(U).get(he.sessionNumber)||`(#${he.sessionNumber})`;ie.push({sessionDisplayNumber:Oe,logs:be})}}),X&&(console.group(`➡️ Class: ${G}`),ie.forEach(he=>{console.groupCollapsed(`  Session ${he.sessionDisplayNumber}`),he.logs.forEach(be=>console.warn(be)),console.groupEnd()}),console.groupEnd())}B>0?(ce(),console.log(`✅ Cleanup complete! Found and removed ${B} orphaned references. Data saved.`)):console.log("✅ No orphaned data found. Your data is clean!")}window.cleanupOrphanedData=ln;function Un(B){if(!B||!B.classroomName)return;const G=oe[B.classroomName];if(!G){ee("⚠️ کلاس مربوط به این گزارش یافت نشد.");return}Pe(G),Ee(),setTimeout(()=>{switch(B.type){case"VIEW_STUDENT_PROFILE":{const U=G.students.find(X=>X.identity.studentId===B.studentId);U?ze(U):ee("⚠️ دانش‌آموز مورد نظر یافت نشد.");break}case"VIEW_TRASH":on(),ye("trash-page");break;case"VIEW_SESSIONS":We(),ye("session-page");break;case"VIEW_CLASS_NOTE":Hn(G);break;case"VIEW_CLASS_SETTINGS":Mt(G);break}},300)}Be.addEventListener("click",()=>{Rs()}),Ne.addEventListener("click",()=>{Ee()}),pe.addEventListener("click",()=>{const B=ve.value.trim(),G=Le.checked;if(!B){Ns.style.display==="flex"?Ce("کادر یادداشت خالی است. آیا مطمئنید که می‌خواهید یادداشت‌های قبلی دانش‌آموزان انتخاب‌شده را پاک کنید؟",()=>{Ee(),cs("",!1)},{confirmText:"پاک کردن",confirmClass:"btn-warning"}):ee("⚠️ لطفاً متن یادداشت را وارد کنید.");return}Ee(()=>{cs(B,G)})});const dt=document.getElementById("screen-saver-overlay"),dn=document.getElementById("screen-saver-toggle");let xt;const yt=2*60*1e3,vt=["mousemove","keypress","scroll","click","touchstart"];function Wi(){dt.classList.add("visible")}function Fs(){dt.classList.contains("visible")&&dt.classList.remove("visible")}function un(){Fs(),clearTimeout(xt),xt=setTimeout(Wi,yt)}function fn(B){B.preventDefault(),B.stopPropagation(),setTimeout(un,0)}function Ps(){un(),vt.forEach(G=>window.addEventListener(G,un)),dt.addEventListener("click",fn),dt.addEventListener("touchstart",fn);const B="13.1.0";{const G=document.getElementById("screen-saver-version");G&&(G.textContent=`v${B}`)}}function Ui(){clearTimeout(xt),Fs(),vt.forEach(B=>window.removeEventListener(B,un)),dt.removeEventListener("click",fn),dt.removeEventListener("touchstart",fn)}dn.checked=qe.isScreenSaverEnabled,qe.isScreenSaverEnabled&&Ps(),dn.addEventListener("change",B=>{B.target.checked?(Vt({isScreenSaverEnabled:!0}),Ps()):(me(),B.preventDefault(),Ce(`نکته:
محافظ صفحه در تلفن های همراه جدید کمک می کند که دستگاه باطری کمتری مصرف کند و به دلیل ثابت ماندن صفحه نمایش در گوشی های قدیمی تر، صفحه نمایش دچار ماندگی رد پیکسل نگردد. آیا مطمئن هستید که می خواهید این ویژگی را غیر فعال کنید؟`,()=>{B.target.checked=!1,Vt({isScreenSaverEnabled:!1}),Ui(),ee("توصیه می شود زمان خاموش شدن صفحه نمایش گوشی خود را به حداقل دو دقیقه تغییر دهید تا در استفاده های طولانی مدت صفحه نمایش گوشی اصطحلاک کمتری را تجربه کند",7e3)},{confirmText:"بله، غیرفعال کن",cancelText:"لغو",onCancel:()=>{B.target.checked=!0}}))})});function Sr(n,o){if(!K||K.isFinished){ee("⚠️ امکان لغو انتخاب در جلسه خاتمه یافته وجود ندارد.");return}const e=K.winnerHistory;if(!(je===e.length-1)||e.length===0){ee("⚠️ فقط آخرین انتخاب قابل لغو است.");return}if(e[e.length-1].winner.identity.studentId!==n.identity.studentId){console.error("Undo mismatch!");return}Ce(`آیا از حذف انتخاب «${n.identity.name}» برای «${o}» مطمئن هستید؟ آمار این انتخاب بازگردانی خواهد شد.`,()=>{const r=K.winnerHistory,t=r.pop();if(!t)return;const a=t.winner,i=t.categoryName,s=a.identity.studentId;a.statusCounters.totalSelections=Math.max(0,a.statusCounters.totalSelections-1),a.categoryCounts[i]&&(a.categoryCounts[i]=Math.max(0,a.categoryCounts[i]-1));const l=K.studentRecords[s];l&&l.selections[i]&&(l.selections[i]=Math.max(0,l.selections[i]-1));let h=null;for(let g=r.length-1;g>=0;g--)if(r[g].categoryName===i){h=r[g].winner.identity.studentId;break}h?K.lastWinnerByCategory[i]=h:delete K.lastWinnerByCategory[i],gt(r.length-1),Re(),Me(),ce(),ee(`✅ انتخاب «${a.identity.name}» لغو شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}function Ir(){const n=document.getElementById("session-dashboard-page"),o=document.getElementById("student-stats-table-container");if(!n)return;let e=0,c=0;n.addEventListener("touchstart",t=>{if(o&&o.contains(t.target)){const a=t.target.closest("td, th");a&&a.parentElement.firstElementChild===a?e=t.changedTouches[0].screenX:e=0}else e=t.changedTouches[0].screenX},{passive:!0}),n.addEventListener("touchend",t=>{e!==0&&(c=t.changedTouches[0].screenX,r())});function r(){const a=e-c;Math.abs(a)>150&&(document.getElementById("selector-tab-btn").classList.contains("active")?(ye("session-dashboard-page",{tab:"attendance"}),an("attendance")):(ye("session-dashboard-page",{tab:"selector"}),an("selector"))),e=0,c=0}}
