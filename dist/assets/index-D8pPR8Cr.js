(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(a){if(a.ep)return;a.ep=!0;const o=t(a);fetch(a.href,o)}})();class yt{constructor(n){this.identity={name:n.name,studentId:n.studentId||`id_${new Date().getTime()}_${Math.random()}`,branchName:n.branchName||null,ageGroup:n.ageGroup||"adult",level:n.level||null,contact:{social:n.socialContact||null,parent:n.parentContact||null}},this.isDeleted=!1,this.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0,outOfClassCount:0},this.categoryCounts={},this.categoryIssues={},this.logs={parentContacts:[],scores:{},discipline:{},sessionHistory:{}},this.profile={notes:[],tags:[]},this.finalClassActivityScore=null,this.onboardingSession=null}addScore(n,t,s){if(t>100||t<0){console.log("نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}const a=n.toLowerCase();this.logs.scores[a]||(this.logs.scores[a]=[]);const o=new So(n,t,s);this.logs.scores[a].push(o)}addNote(n,t=null){const s=new Io(n,t);this.profile.notes.push(s)}getOverallAverageScore(){let n=0,t=0;for(const a in this.logs.scores)this.logs.scores[a].forEach(o=>{o.isDeleted||(n+=o.value,t++)});if(t===0)return null;const s=n/t;return Math.round(s*100)/100}}class So{constructor(n,t,s=""){this.id=`score_${new Date().getTime()}`,this.skill=n,this.value=t,this.timestamp=new Date,this.comment=s,this.isDeleted=!1}}class Io{constructor(n,t=null){this.id=`note_${new Date().getTime()}`,this.timestamp=new Date,this.content=n,this.isDeleted=!1,this.source=t}}class Zt{constructor(n="complete",t=""){this.status=n,this.comment=t,this.timestamp=new Date}}class Qn{constructor(n){this.sessionNumber=n,this.startTime=new Date,this.note="",this.isDeleted=!1,this.endTime=null,this.isFinished=!1,this.isMakeup=!1,this.isCancelled=!1,this.studentRecords={},this.lastWinnerByCategory={},this.lastUsedCategoryId=null,this.lastSelectedWinnerId=null,this.winnerHistory=[]}end(){this.isFinished=!0,this.endTime=new Date}markAsMakeup(){this.isMakeup=!this.isMakeup}initializeStudentRecord(n){this.studentRecords[n]||(this.studentRecords[n]={attendance:"present",homework:new Zt,selections:{},hadIssue:!1,wasOutOfClass:!1})}setAttendance(n,t){this.initializeStudentRecord(n),this.studentRecords[n].attendance=t}setHomeworkStatus(n,t){this.initializeStudentRecord(n),this.studentRecords[n].homework.status=t}selectNextWinner(n,t,s){if(!t||t.length===0)return console.log("هیچ دانش‌آموزی در کلاس برای انتخاب وجود ندارد."),null;const a=this.lastWinnerByCategory[n];let o=t.filter(d=>d.identity.studentId!==a&&!d.isDeleted);if(o.length===0&&(o=t),o.length===0)return null;const i=(d,p)=>d.categoryCounts[p]||0,l=Math.min(...o.map(d=>i(d,n))),c=o.filter(d=>i(d,n)===l);let g;if(c.length===1)g=c[0];else if(c.length>1){const d=s.filter(w=>!w.isDeleted&&w.name!==n).map(w=>w.name),p=c.map(w=>{const M=d.reduce((F,$)=>F+i(w,$),0);return{student:w,otherCategoriesTotal:M}}),v=Math.min(...p.map(w=>w.otherCategoriesTotal)),S=p.filter(w=>w.otherCategoriesTotal===v).map(w=>w.student);S.length===1?g=S[0]:g=S[Math.floor(Math.random()*S.length)]}else g=o[Math.floor(Math.random()*o.length)];const E=g.identity.studentId;this.initializeStudentRecord(E);const B=(this.studentRecords[E].selections[n]||0)+1;return this.studentRecords[E].selections[n]=B,g.statusCounters.totalSelections++,g.categoryCounts[n]=(g.categoryCounts[n]||0)+1,this.lastWinnerByCategory[n]=E,g}}class en{constructor(n){this.info={name:n.name||"NotNamed",scheduleCode:n.scheduleCode||`code_${new Date().getTime()}`,teacherName:n.teacherName||null,type:n.type||"in-person",term:n.term||null,scheduleText:n.scheduleText||null,level:n.level||null,creationDate:n.creationDate?new Date(n.creationDate):new Date},this.students=[],this.sessions=[],this.note="",this.isDeleted=!1,this.categories=[new be("Vocabulary","Questions about words and meanings."),new be("Grammar","Questions about sentence structure and rules."),new be("Listening",void 0,!0),new be("Speaking",void 0,!0),new be("Reading",void 0,!0),new be("Writing",void 0,!0)],this.futurePlans={}}addStudent(n){this.students.push(n)}removeStudent(n){this.students=this.students.filter(t=>t.identity.studentId!==n)}startNewSession(){const n=this.sessions.length+1,t=new Qn(n);return this.sessions.push(t),t}endSpecificSession(n){const t=this.getSession(n);return t&&!t.isFinished?(t.end(),!0):!1}getSession(n){return this.sessions.find(t=>t.sessionNumber===n)}markAsMakeup(n){const t=this.getSession(n);t&&t.markAsMakeup()}planForSession(n,t){this.futurePlans[n]=t}hasSessionToday(){const n=new Date().toDateString();return this.sessions.some(t=>!t.isDeleted&&t.startTime.toDateString()===n)}selectNextWinner(n,t){return t?t.selectNextWinner(n,this.students,this.categories):null}get liveSession(){for(let n=this.sessions.length-1;n>=0;n--)if(!this.sessions[n].isFinished)return this.sessions[n];return null}endLiveSession(){const n=this.liveSession;return n?(n.end(),!0):!1}calculateFinalStudentScore(n){const t=n.logs.scores,s=["reading","writing"];for(const d of s)if(!t[d]||t[d].length===0)return null;const a=t.listening&&t.listening.length>0,o=t.speaking&&t.speaking.length>0;if(!a&&!o)return null;const i=d=>t[d].reduce((v,S)=>v+S.value,0)/t[d].length;let l;a&&o?l=(i("listening")+i("speaking"))/2:a?l=i("listening"):l=i("speaking");const c=i("reading"),g=i("writing"),B=(l*3+c*2+g*1)/6;return Math.trunc(B*10)/10}assignAllFinalScores(){let n=0,t=[];console.log("شروع عملیات محاسبه نمره نهایی برای تمام دانش‌آموزان..."),this.students.forEach(a=>{const o=this.calculateFinalStudentScore(a);o!==null?(a.finalClassActivityScore=o,n++):(a.finalClassActivityScore=null,t.push(a.identity.name))});const s=t.length;console.log(`عملیات پایان یافت. تعداد نمرات موفق: ${n} | تعداد ناموفق (نمرات ناقص): ${s}`),s>0&&(console.log("اسامی دانش‌آموزانی که نمراتشان ناقص است:"),t.forEach(a=>console.log(`- ${a}`)))}}class be{constructor(n,t="",s=!1){this.id=`cat_${new Date().getTime()}_${Math.random()}`,this.name=n,this.description=t,this.isDeleted=!1,this.isGradedCategory=s,this.isDeleted=!1}}let I={},u=null,yn=null,y=null,O=null,ot=null,Ut=null,Cn=[],Tt=null,vn=null,le=null,xt=0,En=0,Dt=0,bn=0,Sn=null,In=null,Mt=null,we=null,fe=-1,$t=null,Ot=null,At=null,Xn=null,Yn=null,ge=!1,x=[],me=[],Re=[],de={isScreenSaverEnabled:!0,lastRestoreTimestamp:null};function N(){if(ge)return;const e={classrooms:I,trashBin:x,userSettings:de};localStorage.setItem("teacherAssistantData_v2",JSON.stringify(e))}function Zn(e=[]){const n={};if(e.length>0)e.forEach(i=>{I[i]&&(n[i]=I[i])});else for(const i in I)I[i].isDeleted||(n[i]=I[i]);const t={metadata:{version:"2.0",createdAt:new Date().toISOString()},data:{classrooms:n,trashBin:x}},s=JSON.stringify(t,null,2),o=`SP-Backup-${new Date().toLocaleDateString("fa-IR-u-nu-latn").replace(/\//g,"-")}.txt`;return new File([s],o,{type:"text/plain"})}function Rt(){const e=localStorage.getItem("teacherAssistantData_v2");if(!e)return;const n=JSON.parse(e);n.classrooms?(He(n.classrooms),x=n.trashBin||[],de={...de,...n.userSettings}):(He(n),Lo())}function Lo(){const e=[];Object.values(I).forEach(n=>{n.isDeleted?e.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:n.info.creationDate,type:"classroom",description:`کلاس «${n.info.name}»`,restoreData:{name:n.info.name}}):n.students.forEach(t=>{t.isDeleted&&e.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:t.identity.studentId.split("_")[1],type:"student",description:`دانش‌آموز «${t.identity.name}»`,restoreData:{studentId:t.identity.studentId,classroomName:n.info.name}})})}),x.length===0&&e.length>0&&(x=e,console.log(`Migrated ${e.length} previously deleted item(s) to the new trash bin.`),N())}function He(e){I={};for(const n in e){const t=e[n];let s;t.info?s=t.info:s={...t,name:n};const a=new en(s);a.isDeleted=t.isDeleted,a.note=t.note||"",a.students=(t.students||[]).map(o=>{const i=new yt(o.identity);return i.isDeleted=o.isDeleted,i.statusCounters=o.statusCounters,i.logs=o.logs,i.logs.scores||(i.logs.scores={}),i.profile=o.profile,i.finalClassActivityScore=o.finalClassActivityScore,i.categoryCounts=o.categoryCounts||{},i.categoryIssues=o.categoryIssues||{},i.onboardingSession=o.onboardingSession||null,i}),a.sessions=(t.sessions||[]).map(o=>{const i=new Qn(o.sessionNumber);i.isDeleted=o.isDeleted,i.note=o.note||"",i.startTime=new Date(o.startTime),i.endTime=o.endTime?new Date(o.endTime):null,i.isFinished=o.isFinished,i.isMakeup=o.isMakeup,i.isCancelled=o.isCancelled||!1,i.studentRecords=o.studentRecords;for(const c in i.studentRecords){const g=i.studentRecords[c];g.homework&&!(g.homework instanceof Zt)&&(i.studentRecords[c].homework=new Zt(g.homework.status,g.homework.comment))}i.lastWinnerByCategory=o.lastWinnerByCategory,i.lastUsedCategoryId=o.lastUsedCategoryId,i.lastSelectedWinnerId=o.lastSelectedWinnerId;const l=o.winnerHistory||[];return i.winnerHistory=l.filter(c=>c&&c.winner).map(c=>({winner:a.students.find(E=>E.identity.studentId===c.winner.identity.studentId),categoryName:c.categoryName})).filter(c=>c.winner),i}),a.categories=(t.categories||[]).map(o=>{const i=new be(o.name,o.description,o.isGradedCategory);return i.id=o.id,i.isDeleted=o.isDeleted,i}),a.futurePlans=t.futurePlans,I[n]=a}}function es(e,n){if(n){const t=e.data.classrooms;for(let s in t){let a=s;const o=t[s];for(;I[a];)a=`${a} (Restored)`;a!==s&&(o.info.name=a),I[a]=o}if(e.data.trashBin){const s=[...x,...e.data.trashBin],a=[...new Map(s.map(o=>[o.id,o])).values()];Pt(a)}He(I)}else He(e.data.classrooms),Pt(e.data.trashBin||[]);Ye({lastRestoreTimestamp:new Date().toISOString()}),N()}function ts(e,n){if(I[n])return{success:!1,message:"کلاسی با این نام از قبل وجود دارد."};const t=I[e];return t?(t.info.name=n,I[n]=t,delete I[e],u===t&&Z(t),{success:!0}):{success:!1,message:"کلاس مورد نظر یافت نشد."}}function ns(e,n,t){const s=t.trim();if(!s)return{success:!1,message:"نام دسته‌بندی نمی‌تواند خالی باشد."};if(e.categories.some(c=>c.id!==n.id&&!c.isDeleted&&c.name.toLowerCase()===s.toLowerCase()))return{success:!1,message:"دسته‌بندی دیگری با این نام وجود دارد."};const o=n.name,i=o.toLowerCase(),l=s.toLowerCase();return n.name=s,e.students.forEach(c=>{c.categoryCounts&&c.categoryCounts[o]!==void 0&&(c.categoryCounts[s]=c.categoryCounts[o],delete c.categoryCounts[o]),c.categoryIssues&&c.categoryIssues[o]!==void 0&&(c.categoryIssues[s]=c.categoryIssues[o],delete c.categoryIssues[o]),c.logs.scores&&c.logs.scores[i]&&(c.logs.scores[i].forEach(g=>g.skill=s),i!==l&&(c.logs.scores[l]=c.logs.scores[i],delete c.logs.scores[i]))}),e.sessions.forEach(c=>{c.lastWinnerByCategory&&c.lastWinnerByCategory[o]&&(c.lastWinnerByCategory[s]=c.lastWinnerByCategory[o],delete c.lastWinnerByCategory[o]),c.winnerHistory&&c.winnerHistory.forEach(g=>{g.categoryName===o&&(g.categoryName=s)})}),{success:!0}}function ss(e,n,t){if(P(t.students).some(i=>i.identity.name.toLowerCase()===e.identity.name.toLowerCase()))return{success:!1,message:`دانش‌آموزی با نام «${e.identity.name}» از قبل در کلاس «${t.info.name}» وجود دارد.`};const a=JSON.parse(JSON.stringify(e));t.addStudent(a);const o=n.students.find(i=>i.identity.studentId===e.identity.studentId);return o&&at(o,n),{success:!0}}function os(){for(const e in I){const n=I[e];n.students.forEach(t=>{t.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0},t.categoryCounts={},t.categoryIssues={},n.sessions.forEach(s=>{const a=t.identity.studentId;s.studentRecords[a]&&(s.studentRecords[a].attendance="present")})})}N()}function P(e){return Array.isArray(e)?e.filter(n=>!n.isDeleted):[]}function he(e){const n=new Map;return e&&P(e.sessions).filter(s=>!s.isCancelled).sort((s,a)=>s.sessionNumber-a.sessionNumber).forEach((s,a)=>{n.set(s.sessionNumber,a+1)}),n}function Oe(e){fe=e}function ye(e){$t=e}function at(e,n){if(!e||!n)return;const t=e.identity.studentId,s=n.students.findIndex(a=>a.identity.studentId===t);s>-1&&n.students.splice(s,1),n.sessions.forEach(a=>{a.studentRecords[t]&&delete a.studentRecords[t]})}function as(e,n){const t=I[e];if(!t)return;const s=t.sessions.findIndex(a=>a.sessionNumber===n);s>-1&&t.sessions.splice(s,1)}function is(e,n){const t=I[e];if(!t)return;const s=t.categories.findIndex(l=>l.id===n);if(s===-1)return;const o=t.categories[s].name,i=o.toLowerCase();t.students.forEach(l=>{l.categoryCounts&&delete l.categoryCounts[o],l.categoryIssues&&delete l.categoryIssues[o],l.logs.scores&&delete l.logs.scores[i]}),t.categories.splice(s,1)}function cs(e,n,t,s){const a=I[e];if(!a)return;const o=a.students.find(c=>c.identity.studentId===n);if(!o||!o.logs.scores[t.toLowerCase()])return;const i=o.logs.scores[t.toLowerCase()],l=i.findIndex(c=>c.id===s);l>-1&&i.splice(l,1)}function rs(e,n,t){const s=I[e];if(!s)return;const a=s.students.find(i=>i.identity.studentId===n);if(!a||!a.profile.notes)return;const o=a.profile.notes.findIndex(i=>i.id===t);o>-1&&a.profile.notes.splice(o,1)}function ls(){JSON.parse(JSON.stringify({classrooms:I,trashBin:x})),ge=!0}function ds(){ge=!1,Rt()}function Z(e){u=e}function it(e){yn=e}function ne(e){y=e}function j(e){O=e}function Ht(e){ot=e}function us(e){Ut=e}function Je(e){Cn=e}function Ct(e){Tt=e}function ms(e){vn=e}function Ln(e){le=e}function vt(e){xt=e}function fs(e){En=e}function Et(e){Dt=e}function ps(e){bn=e}function kn(e){Sn=e}function wn(e){In=e}function ct(e){Mt=e}function Nn(e){we=e}function _t(e){At=e}function gs(e){Xn=e}function hs(e){Yn=e}function Pt(e){x=e}function Vt(e){Ot=e}function Wt(e){Re=e}function Ye(e){de={...de,...e},N()}function ys(e){me=e}const ko=Object.freeze(Object.defineProperty({__proto__:null,get activeModal(){return we},get cancelCallback(){return In},get classrooms(){return I},get confirmCallback(){return Sn},get currentClassroom(){return u},get easterEggClickCount(){return xt},get easterEggLastClickTime(){return En},enterDemoMode:ls,exitDemoMode:ds,getActiveItems:P,getSessionDisplayMap:he,get importedFileContent(){return Tt},get isDemoMode(){return ge},get liveSession(){return yn},loadData:Rt,get manualSelection(){return At},moveStudent:ss,get namesToImport(){return Cn},get notificationTimeout(){return vn},permanentlyDeleteCategory:is,permanentlyDeleteNote:rs,permanentlyDeleteScore:cs,permanentlyDeleteSession:as,permanentlyDeleteStudent:at,prepareBackupData:Zn,get previousState(){return ot},processRestore:es,rehydrateData:He,renameCategory:ns,renameClassroom:ts,resetAllStudentCounters:os,get resetEasterEggClickCount(){return Dt},get resetEasterEggLastClickTime(){return bn},get saveCategoryCallback(){return Ot},saveData:N,get saveNoteCallback(){return $t},get secureConfirmCallback(){return Mt},get selectedCategory(){return le},get selectedClassIds(){return me},get selectedSession(){return y},get selectedStudentForProfile(){return O},get selectedStudentsForMassComment(){return Re},setActiveModal:Nn,setCancelCallback:wn,setConfirmCallback:kn,setCurrentClassroom:Z,setEasterEggClickCount:vt,setEasterEggLastClickTime:fs,setImportedFileContent:Ct,setLiveSession:it,setManualSelection:_t,setNamesToImport:Je,setNotificationTimeout:ms,setPreviousState:Ht,setResetEasterEggClickCount:Et,setResetEasterEggLastClickTime:ps,setSaveCategoryCallback:Vt,setSaveNoteCallback:ye,setSecureConfirmCallback:ct,setSelectedCategory:Ln,setSelectedClassIds:ys,setSelectedSession:ne,setSelectedStudentForProfile:j,setSelectedStudentsForMassComment:Wt,setSourceClassForMove:hs,setStudentToMove:gs,setTrashBin:Pt,setUndoTimeout:us,setUserSettings:Ye,setWinnerHistoryIndex:Oe,get sourceClassForMove(){return Yn},get studentToMove(){return Xn},get trashBin(){return x},get undoTimeout(){return Ut},get userSettings(){return de},get winnerHistoryIndex(){return fe}},Symbol.toStringTag,{value:"Module"}));function ve(e){return typeof e!="string"?"":e.replace(/ي/g,"ی").replace(/ك/g,"ک").replace(/[\s\u200c]/g,"")}function rt(e){return typeof e!="string"||e.length===0?"ltr":/[\u0590-\u07FF]/.test(e)?"rtl":"ltr"}function Cs(e){return!e||!e.trim()?"":e.split(`
`).map(s=>`<div dir="${rt(s)}">${s||"&nbsp;"}</div>`).join("")}function Yt(e){if(typeof e!="string")return"";const n={q:"ض",w:"ص",e:"ث",r:"ق",t:"ف",y:"غ",u:"ع",i:"ه",o:"خ",p:"ح","[":"ج","]":"چ",a:"ش",s:"س",d:"ی",f:"ب",g:"ل",h:"ا",j:"ت",k:"ن",l:"م",";":"ک","'":"گ",z:"ظ",x:"ط",c:"ز",v:"ر",b:"ذ",n:"د",m:"پ",",":"و"};let t="";for(let s=0;s<e.length;s++){const a=e[s].toLowerCase();t+=n[a]||e[s]}return t}const vs="teacherAssistantLogs_v2",wo=100;function Bn(){try{const e=localStorage.getItem(vs);return e?JSON.parse(e):{}}catch(e){return console.error("Error reading logs from localStorage:",e),{}}}function Es(e){try{localStorage.setItem(vs,JSON.stringify(e))}catch(n){console.error("Error saving logs to localStorage:",n)}}function H(e,n,t=null){if(!e)return;const s=Bn();s[e]||(s[e]=[]);const a={timestamp:new Date().toISOString(),message:n,action:t,classroomName:e};s[e].unshift(a),s[e].length>wo&&s[e].pop(),Es(s)}function No(e){return Bn()[e]||[]}function Bo(e,n){const t=Bn();t[e]&&!t[n]&&(t[n]=t[e],delete t[e],Es(t))}const bs=document.getElementById("class-management-page"),To=document.getElementById("new-class-name"),xo=document.getElementById("add-class-btn"),tn=document.getElementById("class-list"),Ft=document.getElementById("undo-toast"),Ss=document.getElementById("undo-message"),Do=document.getElementById("undo-btn"),Mo=document.getElementById("settings-page"),Tn=document.getElementById("settings-class-name-header"),nn=document.getElementById("settings-student-list"),sn=document.getElementById("category-list"),$o=document.getElementById("back-to-sessions-btn"),Oo=document.getElementById("new-student-name"),Ao=document.getElementById("add-student-btn"),Is=document.getElementById("paste-area"),Ro=document.getElementById("process-paste-btn"),Ho=document.getElementById("csv-preview-page"),on=document.getElementById("csv-preview-list"),_o=document.getElementById("csv-confirm-btn"),Po=document.getElementById("csv-cancel-btn"),Wo=document.getElementById("import-csv-btn"),Fo=document.getElementById("csv-file-input"),qo=document.getElementById("column-mapping-page"),an=document.getElementById("column-select-dropdown"),Uo=document.getElementById("confirm-column-btn"),Vo=document.getElementById("cancel-import-btn"),Go=document.getElementById("new-category-name"),zo=document.getElementById("add-category-btn"),cn=document.querySelector(".app-header"),Ne=document.getElementById("select-student-btn"),lt=document.getElementById("select-student-btn-wrapper"),jo=document.getElementById("attendance-page"),Ze=document.getElementById("attendance-list"),Jo=document.getElementById("finish-attendance-btn"),Ko=document.getElementById("back-to-sessions-from-attendance-btn"),Qo=document.getElementById("back-to-attendance-btn"),Xo=document.querySelector("#class-management-page h2"),rn=document.getElementById("student-stats-header"),Yo=document.getElementById("hamburger-menu-btn"),Zo=document.getElementById("side-nav-menu"),ea=document.getElementById("close-nav-btn"),ta=document.getElementById("overlay"),na=document.getElementById("backup-data-btn"),sa=document.getElementById("restore-data-btn"),Ls=document.getElementById("restore-file-input"),oa=document.getElementById("custom-confirm-modal"),ks=document.getElementById("confirm-modal-message"),ln=document.getElementById("confirm-modal-cancel-btn"),Ke=document.getElementById("confirm-modal-confirm-btn"),aa=document.getElementById("secure-confirm-modal"),ws=document.getElementById("secure-confirm-message"),Ns=document.getElementById("secure-confirm-code"),Fe=document.getElementById("secure-confirm-input"),ia=document.getElementById("secure-confirm-cancel-btn"),bt=document.getElementById("secure-confirm-confirm-btn"),ca=document.getElementById("add-note-modal"),W=document.getElementById("new-note-content"),ra=document.getElementById("class-save-note-btn"),la=document.getElementById("cancel-note-btn"),dn=document.getElementById("student-search-input"),Le=document.getElementById("student-search-results"),da=document.getElementById("student-profile-page"),Bs=document.getElementById("profile-student-name-header"),ua=document.getElementById("back-to-student-page-btn"),qe=document.getElementById("graded-category-pills-container"),un=document.getElementById("new-score-value"),xn=document.getElementById("new-score-comment"),ma=document.getElementById("add-score-btn"),Qe=document.getElementById("profile-stats-summary"),St=document.getElementById("profile-scores-list"),It=document.getElementById("global-student-search-input"),Ee=document.getElementById("global-student-search-results"),fa=document.getElementById("is-graded-checkbox"),pa=document.getElementById("trashed-classes-list"),ga=document.getElementById("trashed-students-list"),ha=document.getElementById("trashed-sessions-list"),ya=document.getElementById("trashed-categories-list"),Ca=document.getElementById("trashed-notes-list"),va=document.getElementById("trashed-scores-list"),qt=document.getElementById("quick-grade-form-wrapper"),Se=document.getElementById("quick-score-input"),pe=document.getElementById("quick-note-textarea"),Ve=document.getElementById("quick-grade-submit-btn"),et=document.getElementById("category-selection-container"),Ts=document.getElementById("selected-student-result"),Ae=document.getElementById("custom-context-menu"),Ue=document.getElementById("breadcrumb-container"),Ea=document.getElementById("category-modal"),xs=document.getElementById("category-modal-title"),tt=document.getElementById("new-category-modal-name"),Dn=document.getElementById("new-category-modal-is-graded"),ba=document.getElementById("category-modal-cancel-btn"),Ds=document.getElementById("category-modal-save-btn"),Sa=document.getElementById("mass-comment-modal"),Ia=document.getElementById("mass-comment-modal-title"),Ms=document.getElementById("mass-comment-student-count-message"),nt=document.getElementById("mass-comment-content"),Mn=document.getElementById("mass-comment-append-checkbox"),La=document.getElementById("mass-comment-cancel-btn"),ka=document.getElementById("mass-comment-save-btn"),mn=document.getElementById("mass-comment-btn"),Lt=document.getElementById("attendance-mass-actions-container"),De=document.createElement("input");function wa(e){clearTimeout(Ut),ot||Ht(JSON.stringify(I)),Ss.textContent=e,Ft.classList.add("show"),us(setTimeout(()=>{Ft.classList.remove("show"),Ht(null)},5e3))}function $s(){if(ot){const e=u?u.info.name:null,n=JSON.parse(ot);He(n),e&&I[e]?Z(I[e]):Z(null),u?(Ie(),Ge(),Q()):oe(),Ft.classList.remove("show"),clearTimeout(Ut),Ht(null)}}function C(e,n=3e3){const t=document.getElementById("notification-toast");t&&(t.textContent=e,t.classList.add("show"),clearTimeout(vn),ms(setTimeout(()=>{t.classList.remove("show")},n)))}function Os(e){const n=document.getElementById("restore-confirm-modal"),t=document.getElementById("restore-modal-message"),s=document.getElementById("restore-append-checkbox"),a=document.getElementById("restore-confirm-cancel-btn"),o=document.getElementById("restore-confirm-confirm-btn"),i=document.getElementById("restore-modal-warning");i.style.display="none";const l=e.metadata.createdAt;if(de.lastRestoreTimestamp&&l<de.lastRestoreTimestamp){const d=new Date(l).toLocaleDateString("fa-IR"),p=new Date(de.lastRestoreTimestamp).toLocaleDateString("fa-IR");i.textContent=`⚠️ هشدار: این فایل پشتیبان (${d}) قدیمی‌تر از آخرین بازیابی شما (${p}) است.`,i.style.display="block"}const c=Object.keys(e.data.classrooms).length,g="کلاس";t.textContent=`فایل پشتیبان شما حاوی ${c} ${g} است. لطفاً نحوه بازیابی را مشخص کنید.`,s.checked=!0;const E=()=>{const d=s.checked;es(e,d),n.removeEventListener("click",E),z(),oe(),k("class-management-page"),C("✅ اطلاعات با موفقیت بازیابی شد.")},B=()=>{z()};o.onclick=E,a.onclick=B,ee("restore-confirm-modal")}function U(e,n,t={}){const{confirmText:s="تایید",cancelText:a="لغو",confirmClass:o="btn-success",onCancel:i=()=>{},isDelete:l=!1}=t,c=l?()=>As(e,n):n;ks.textContent=e,Ke.textContent=s,ln.textContent=a,Ke.className="modal-action-btn",Ke.classList.add(o),kn(c),wn(i);const g=Ke.parentElement;ln.style.display=i===null?"none":"inline-block",g.style.justifyContent=i===null?"center":"space-between",ee("custom-confirm-modal")}function As(e,n){const t=Math.floor(1e4+Math.random()*9e4).toString();ws.textContent=e,Ns.textContent=t,Fe.value="",bt.disabled=!0,ct(n),ee("secure-confirm-modal"),Fe.focus();const s=()=>{Fe.value===t?bt.disabled=!1:bt.disabled=!0};return Fe.addEventListener("input",s),()=>{Fe.removeEventListener("input",s)}}function fn(e,n={}){const{title:t="ایجاد دسته‌بندی جدید",initialName:s="",initialIsGraded:a=!1,saveButtonText:o="ذخیره"}=n;xs.textContent=t,tt.value=s,Dn.checked=a,Ds.textContent=o,Vt((i,l)=>{if(!i){C("⚠️ لطفاً نام دسته‌بندی را وارد کنید.");return}e(i,l),z()}),ee("category-modal"),tt.focus(),s&&tt.select()}function Rs(e,n){const t=Object.values(I).filter(i=>!i.isDeleted&&i.info.name!==n.info.name),s=document.getElementById("move-student-modal-title"),a=document.getElementById("move-student-class-select"),o=document.getElementById("move-student-confirm-btn");s.textContent=`انتقال دانش‌آموز: ${e.identity.name}`,a.innerHTML="",t.length===0?(a.innerHTML='<option value="">کلاس دیگری برای انتقال وجود ندارد</option>',o.disabled=!0):(t.forEach(i=>{const l=document.createElement("option");l.value=i.info.name,l.textContent=i.info.name,a.appendChild(l)}),o.disabled=!1),gs(e),hs(n),ee("move-student-modal")}function $n(e,n){if(!e||!n)return;const t=e.identity.name,s=document.getElementById("add-note-modal-title");s.textContent="تغییر نام دانش‌آموز",W.value=t,W.rows=1,W.dispatchEvent(new Event("input",{bubbles:!0})),ye(a=>{const o=a.trim();o&&o!==t&&(P(n.students).some(l=>l.identity.studentId!==e.identity.studentId&&l.identity.name.toLowerCase()===o.toLowerCase())?C("دانش‌آموزی با این نام از قبل در این کلاس وجود دارد."):(e.identity.name=o,H(n.info.name,`نام دانش‌آموز «${t}» به «${o}» تغییر یافت.`,{type:"VIEW_STUDENT_PROFILE",studentId:e.identity.studentId}),N(),Ie(),se(),O&&O.identity.studentId===e.identity.studentId&&ae(),C(`✅نام دانش‌آموز به «${o}» تغییر یافت.`))),s.textContent="ثبت یادداشت جدید",W.rows=4}),ee("add-note-modal"),W.focus(),W.select()}function ee(e){const n=document.getElementById(e);if(n){if(we)return;n.classList.add("modal-visible"),Nn(e),history.pushState(null,"",location.href)}}function z(e){if(!we)return;const n=document.getElementById(we),t=we;Nn(null),history.back(),n&&(n.classList.add("modal-closing"),setTimeout(()=>{n.classList.remove("modal-visible"),n.classList.remove("modal-closing"),t==="custom-confirm-modal"&&(kn(null),wn(null)),t==="secure-confirm-modal"&&ct(null),t==="category-modal"&&Vt(null),t==="mass-comment-modal"&&(nt.value=""),t==="add-note-modal"&&ye(null),typeof e=="function"&&e()},300))}function On(){var n;if(((n=document.querySelector(".page.active"))==null?void 0:n.id)!=="attendance-page"){Lt.style.display="none";return}const e=Re.length;e<1?Lt.style.display="none":Lt.style.display="block",mn.disabled=e<1,mn.textContent=`📝 ثبت یادداشت گروهی (${e} نفر)`}function Hs(){const e=Re,n=e.length;let t=!1;n>0&&(t=e.some(a=>{var o;return(o=y.studentRecords[a])==null?void 0:o.homework.comment})),Ms.textContent=`یادداشت برای ${n} دانش‌آموز ثبت خواهد شد.`,nt.value="",nt.dispatchEvent(new Event("input",{bubbles:!0})),Mn.checked=!0;const s=document.querySelector("#mass-comment-modal .modal-options");s.style.display=t?"flex":"none",ee("mass-comment-modal"),nt.focus()}function pn(e,n){if(!u||!y)return;let t=0;const s=Re,a=y;s.forEach(o=>{const i=a.studentRecords[o];if(i&&i.homework){const l=i.homework.comment||"";let c=e;n&&l.length>0?c=l+`
---
`+e:c=e,i.homework.comment=c.trim();const g=u.students.find(E=>E.identity.studentId===o);g&&Na(g,a,c.trim()),t++}}),Wt([]),N(),ke(),H(u.info.name,`${t} دانش‌آموز به صورت گروهی یادداشت تکلیف گرفتند.`,{type:"VIEW_SESSIONS"}),C(`✅ یادداشت برای ${t} دانش‌آموز ثبت شد.`)}function Na(e,n,t){const a=he(u).get(n.sessionNumber),o={type:"fromAttendance",sessionNumber:n.sessionNumber},i=`یادداشت مربوط به جلسه ${a}: `,l=e.profile.notes.find(c=>!c.isDeleted&&c.source&&c.source.type==="fromAttendance"&&c.source.sessionNumber===o.sessionNumber);l?t?(l.content=i+t,l.isDeleted=!1):l.isDeleted=!0:t&&e.addNote(i+t,o)}function An(e){W.value=e.note||"",ye(n=>{e.note=n,N(),H(e.info.name,"یادداشت کلاس ذخیره شد.",{type:"VIEW_CLASS_NOTE"}),oe(),C("✅ یادداشت کلاس ذخیره شد.")}),ee("add-note-modal"),W.focus()}function Rn(e){Z(e),Tn.textContent=`تنظیمات کلاس: ${e.info.name}`,Ie(),Ge(),k("settings-page")}function _s(e){const n=document.getElementById("log-modal-title"),t=document.getElementById("log-list");n.textContent=`گزارش فعالیت‌های کلاس: ${e}`,t.innerHTML="";const s=No(e);s.length===0?t.innerHTML='<li class="no-content-message">هنوز فعالیتی برای این کلاس ثبت نشده است.</li>':s.forEach(a=>{const o=document.createElement("li");o.className="log-entry";const i=new Date(a.timestamp),l=`${i.toLocaleDateString("fa-IR")} - ${i.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}`,c=document.createElement("span");c.className="log-timestamp",c.textContent=l;const g=document.createElement("span");g.className="log-message",g.textContent=a.message,a.action&&(g.classList.add("log-action-link"),g.dataset.action=JSON.stringify({...a.action,classroomName:a.classroomName})),o.appendChild(c),o.appendChild(g),t.appendChild(o)}),ee("log-modal")}document.getElementById("log-modal-close-btn").addEventListener("click",()=>{z()});function gn(e){const n=URL.createObjectURL(e),t=document.createElement("a");t.href=n,t.download=e.name,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(n)}async function dt(e=[]){const n=Zn(e);if(("ontouchstart"in window||navigator.maxTouchPoints>0)&&navigator.share&&navigator.canShare&&navigator.canShare({files:[n]}))try{await navigator.share({title:"پشتیبان دستیار معلم",text:"فایل پشتیبان داده‌های برنامه",files:[n]})}catch(s){s.name!=="AbortError"&&(console.error("Error sharing file:",s),gn(n),C("⚠️اشتراک‌گذاری با خطا مواجه شد. فایل در حال دانلود است."))}else gn(n),C("✅پشتیبان‌گیری با موفقیت انجام شد.")}function ft(e,n){e.preventDefault(),Me(),setTimeout(()=>{const t=Ae,s=t.querySelector("ul");s.innerHTML="",n.forEach(E=>{const B=document.createElement("li");E.isSeparator?B.className="separator":(B.innerHTML=`
                    <span class="icon">${E.icon||""}</span>
                    <span class="label">${E.label}</span>
                `,E.className&&B.classList.add(E.className),B.addEventListener("click",()=>{E.action(),Me()})),s.appendChild(B)});const{clientX:a,clientY:o}=e,{innerWidth:i,innerHeight:l}=window;t.style.top=`${o}px`,t.style.left=`${a}px`,t.classList.add("visible");const{offsetWidth:c,offsetHeight:g}=t;a+c>i&&(t.style.left=`${i-c-5}px`),o+g>l&&(t.style.top=`${l-g-5}px`)},50)}function Me(){Ae.classList.contains("visible")&&Ae.classList.remove("visible")}function Ps(){var n,t;Ue.innerHTML="";const e=[];if(e.push({label:"کلاس‌ها",handler:()=>{Z(null),ne(null),j(null),k("class-management-page")}}),u){if(e.push({label:u.info.name,handler:()=>{ne(null),j(null),Q(),k("session-page")}}),((n=document.querySelector(".page.active"))==null?void 0:n.id)==="settings-page")e.push({label:"تنظیمات"});else if(y){const o=he(u).get(y.sessionNumber)||` (#${y.sessionNumber})`;e.push({label:`جلسه ${o}`,handler:()=>{j(null),k("student-page")}});const i=(t=document.querySelector(".page.active"))==null?void 0:t.id;O?e.push({label:`پروفایل: ${O.identity.name}`}):i==="attendance-page"&&e.push({label:"حضور و غیاب"})}}if(e.length<=1){Ue.style.display="none";return}Ue.style.display="flex",e.forEach((s,a)=>{const o=document.createElement("a");if(o.textContent=s.label,o.className="breadcrumb-item",a===e.length-1||!s.handler?o.classList.add("active"):o.addEventListener("click",s.handler),Ue.appendChild(o),a<e.length-1){const i=document.createElement("span");i.className="breadcrumb-separator",i.textContent="/",Ue.appendChild(i)}})}function Kn(e,n,t){t.innerHTML="";const s=u.sessions.filter(a=>{var o;return!a.isDeleted&&!a.isCancelled&&((o=a.studentRecords[e.identity.studentId])==null?void 0:o.attendance)==="absent"}).map(a=>({number:n.get(a.sessionNumber),isMakeup:a.isMakeup})).filter(a=>a.number!==void 0);s.length>0?(t.appendChild(document.createTextNode("جلسات غایب: ")),s.forEach((a,o)=>{const i=document.createElement("span");i.textContent=a.number,a.isMakeup&&i.classList.add("makeup-absence"),t.appendChild(i),o<s.length-1&&t.appendChild(document.createTextNode("، "))})):t.textContent="جلسات غایب: بدون غیبت"}function kt(e,n,t,s={}){const{includePrefix:a=!0}=s;t.innerHTML="";const o=u.sessions.filter(i=>{if(i.isDeleted||i.isCancelled)return!1;const l=i.studentRecords[e.identity.studentId];return l&&l.homework&&(l.homework.status==="incomplete"||l.homework.status==="none")}).map(i=>({number:n.get(i.sessionNumber),status:i.studentRecords[e.identity.studentId].homework.status})).filter(i=>i.number!==void 0);o.length>0?(a&&t.appendChild(document.createTextNode("تکالیف ناقص: ")),o.forEach((i,l)=>{const c=document.createElement("span");c.textContent=i.number,i.status==="incomplete"&&c.classList.add("incomplete-homework"),t.appendChild(c),l<o.length-1&&t.appendChild(document.createTextNode("،"))})):a?t.textContent="تکالیف ناقص: ندارد":t.textContent="ندارد"}function Ba(e,n){var M,F,$;const t=document.createElement("li");t.className="attendance-list-item";const s=document.createElement("input");s.type="checkbox",s.className="mass-comment-checkbox",s.checked=Re.includes(e.identity.studentId),s.addEventListener("change",()=>{const A=e.identity.studentId,D=Re;if(s.checked)D.includes(A)||D.push(A);else{const V=D.indexOf(A);V>-1&&D.splice(V,1)}On()}),t.appendChild(s);const a={none:"بدون تکلیف",complete:"تکلیف کامل",incomplete:"تکلیف ناقص"},o=document.createElement("div");o.className="student-info";const i=document.createElement("span");i.className="student-name",i.textContent=e.identity.name,i.addEventListener("click",()=>{j(e),ae(),k("student-profile-page")});const l=document.createElement("span");l.className="absence-info";const c=document.createElement("span");c.className="homework-info",Kn(e,n,l),kt(e,n,c),o.appendChild(i),o.appendChild(l),o.appendChild(c);const g=document.createElement("div");g.className="homework-controls";const E=document.createElement("button"),B=((M=y.studentRecords[e.identity.studentId])==null?void 0:M.homework.status)||"none";E.className=`homework-status-btn ${B}`,E.title=a[B],E.addEventListener("click",()=>{const A=y.studentRecords[e.identity.studentId].homework,V={none:"incomplete",incomplete:"complete",complete:"none"}[A.status];E.title=a[V],y.setHomeworkStatus(e.identity.studentId,V),N(),E.className=`homework-status-btn ${V}`,kt(e,n,c)});const d=document.createElement("button");d.className="btn-icon",d.innerHTML="📝",d.title="افزودن یادداشت برای تکلیف",((F=y.studentRecords[e.identity.studentId])==null?void 0:F.homework.comment)||(d.style.opacity="0.3"),d.addEventListener("click",()=>{const A=y.studentRecords[e.identity.studentId].homework;W.value=A.comment||"",W.dispatchEvent(new Event("input",{bubbles:!0})),ye(D=>{A.comment=D;const V=he(u),ie=V.get(y.sessionNumber),Ce={type:"fromAttendance",sessionNumber:y.sessionNumber},X=`یادداشت مربوط به جلسه ${ie}: `,ue=e.profile.notes.find(J=>!J.isDeleted&&J.source&&J.source.type==="fromAttendance"&&J.source.sessionNumber===Ce.sessionNumber);ue?D?ue.content=X+D:ue.isDeleted=!0:D&&e.addNote(X+D,Ce),N(),H(u.info.name,`یادداشت تکلیف جلسه ${ie} برای دانش‌آموز «${e.identity.name}» ذخیره شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:e.identity.studentId}),C("✅یادداشت تکلیف ذخیره شد."),d.style.opacity=D?"1":"0.3",kt(e,V,c)}),ee("add-note-modal"),W.focus()}),g.appendChild(E),g.appendChild(d);const v=document.createElement("button"),S=(($=y.studentRecords[e.identity.studentId])==null?void 0:$.attendance)||"present",w=A=>{A==="present"?(v.textContent="حاضر",v.className="attendance-status-btn present active"):(v.textContent="غایب",v.className="attendance-status-btn absent active")};return w(S),v.addEventListener("click",()=>{var V;const D=(((V=y.studentRecords[e.identity.studentId])==null?void 0:V.attendance)||"present")==="present"?"absent":"present";y.setAttendance(e.identity.studentId,D),D==="absent"&&(y.studentRecords[e.identity.studentId].hadIssue=!1),N(),w(D),Kn(e,n,l),Vs()}),t.appendChild(o),t.appendChild(g),t.appendChild(v),t}function Ta(){return he(u).get(y.sessionNumber)}function ke(){if(!u||!y)return;P(u.students).forEach(a=>{y.initializeStudentRecord(a.identity.studentId)}),Wt([]);const e=he(u);_a(),Ze.innerHTML="";const n=document.createElement("li");n.className="attendance-list-header",De.id="attendance-search-input",De.type="text",De.className="inline-search-input",De.placeholder="جستجو...",De.value="";const t=document.createElement("div");t.className="student-search-container",t.appendChild(De);const s=document.createElement("div");s.className="header-labels-container",s.innerHTML=`
    <span class="header-label">تکلیف</span>
    <span class="header-label">حضور</span>
`,n.appendChild(t),n.appendChild(s),Ze.appendChild(n),P(u.students).forEach(a=>{const o=Ba(a,e);Ze.appendChild(o)}),Wt([]),On(),Pa(),Vs()}function se(){const e=document.getElementById("student-stats-table-container");if(!e||(e.innerHTML="",!u))return;P(u.students).length,rn.textContent="آمار عملکرد";const n=["نام"],t=["کل انتخاب ها","غیبت","خروج","فرصت ازدست‌رفته","مشکل","میانگین","نمره کلاسی (کانون)"],s=u.categories.filter(p=>p.isGradedCategory&&!p.isDeleted).map(p=>p.name),a=[...n,...s,...t],o=document.createElement("table");o.className="student-stats-table";const l=o.createTHead().insertRow();a.forEach((p,v)=>{const S=document.createElement("th");v===0?(S.innerHTML=`${p} <span style="opacity: 0.6;">🔗</span>`,S.title="ردیف‌های این ستون قابل کلیک هستند"):S.textContent=p,l.appendChild(S)});const c=o.createTBody(),g=P(u.students),E=p=>{let v=0;return u.sessions.forEach(S=>{if(S.isDeleted||S.isCancelled)return;const w=S.studentRecords[p.identity.studentId];w&&w.attendance==="absent"&&v++}),v};g.forEach(p=>{const v=c.insertRow();if(v.dataset.studentId=p.identity.studentId,y){const A=y.studentRecords[p.identity.studentId];A&&A.attendance==="absent"&&v.classList.add("absent-row-highlight")}const S=v.insertCell(),w=document.createElement("span");w.textContent=p.identity.name,w.className="student-name-link",w.addEventListener("click",()=>{j(p),ae(),k("student-profile-page")}),S.appendChild(w),s.forEach(A=>{var Ce;const D=v.insertCell(),V=A.toLowerCase(),ie=((Ce=p.logs.scores[V])==null?void 0:Ce.filter(X=>!X.isDeleted))||[];ie.length>0?ie.forEach((X,ue)=>{const J=document.createElement("span");J.textContent=X.value,J.style.position="relative",X.comment&&(J.dataset.tooltip=X.comment),D.appendChild(J),ue<ie.length-1&&D.appendChild(document.createTextNode(","))}):D.textContent="",D.style.cursor="pointer",D.addEventListener("click",()=>{Be(p,A);const X=document.getElementById("category-selection-container");X&&X.scrollIntoView({behavior:"smooth",block:"center"})})}),v.insertCell().textContent=p.statusCounters.totalSelections||0,v.insertCell().textContent=E(p),v.insertCell().textContent=p.statusCounters.outOfClassCount||0,v.insertCell().textContent=p.statusCounters.missedChances||0;const M=Object.values(p.categoryIssues||{}).reduce((A,D)=>A+D,0);v.insertCell().textContent=M;const F=p.getOverallAverageScore();v.insertCell().textContent=F!==null?F:"-";const $=u.calculateFinalStudentScore(p);v.insertCell().textContent=$!==null?$:"-"}),P(u.students),rn.setAttribute("data-student-count",g.length),e.appendChild(o);const B=e.querySelector(".student-stats-table"),d=B==null?void 0:B.querySelector("thead th:first-child");d&&d.addEventListener("click",()=>{B.classList.toggle("name-column-expanded")})}function Be(e=null,n=null){const t=document.getElementById("selected-student-result");t.innerHTML="",t.classList.remove("absent");let s,a;if(e&&n)s=e,a=n,_t({student:e,categoryName:n}),Oe(-1);else{if(_t(null),!y||fe<0||!y.winnerHistory[fe])return;const R=y.winnerHistory[fe];s=R.winner,a=R.categoryName}const o=document.querySelector(".current-winner-highlight");if(o&&o.classList.remove("current-winner-highlight"),s){const R=document.querySelector(`.student-stats-table tr[data-student-id="${s.identity.studentId}"]`);R&&R.classList.add("current-winner-highlight")}const i=u.categories.find(R=>R.name===a);if(i){Ln(i);const R=document.querySelectorAll("#category-selection-container .pill");R.forEach(te=>te.classList.remove("active"));const q=Array.from(R).find(te=>te.textContent===a);q&&q.classList.add("active"),Fs(i)}const l=y.studentRecords[s.identity.studentId],c=(l==null?void 0:l.attendance)==="absent",g=document.createElement("div");g.className="winner-name-container";const E=document.createElement("button");E.className="btn-icon",E.innerHTML="˅",E.title="برنده قبلی";const B=!e;E.classList.toggle("is-disabled",!B||fe<=0),E.addEventListener("click",()=>{E.classList.contains("is-disabled")?(E.classList.add("shake-animation"),setTimeout(()=>E.classList.remove("shake-animation"),200)):(Oe(fe-1),Be())});const d=document.createElement("div");d.className="winner-name",d.innerHTML=`✨ <strong>${s.identity.name}</strong>✨`,d.classList.add("heartbeat-animation"),c&&(d.style.textDecoration="line-through",d.style.opacity="0.6",d.style.color="var(--color-secondary)"),(l==null?void 0:l.hadIssue)&&!c&&(d.style.color="var(--color-warning)",d.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"),(l==null?void 0:l.wasOutOfClass)&&!c&&(d.style.color="var(--color-strong-warning)",d.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود");const S=document.createElement("button");if(S.className="btn-icon",S.innerHTML="˄",S.title="برنده بعدی",S.classList.toggle("is-disabled",!B||fe>=y.winnerHistory.length-1),S.addEventListener("click",()=>{S.classList.contains("is-disabled")?(S.classList.add("shake-animation"),setTimeout(()=>S.classList.remove("shake-animation"),200)):(Oe(fe+1),Be())}),g.appendChild(S),g.appendChild(d),s.onboardingSession===y.sessionNumber){const R=document.createElement("div");R.className="new-student-badge",R.textContent="دانش آموز جدید",g.appendChild(R)}g.appendChild(E),t.appendChild(g),Ne.disabled=B&&!S.classList.contains("is-disabled");const w=document.createElement("div");w.className="status-button-container";const M=document.createElement("button");M.textContent="غایب",M.classList.add("status-button","absent-btn"),c&&M.classList.add("active");const F=document.createElement("button");F.textContent="مشکل",F.classList.add("status-button","issue-btn"),l!=null&&l.hadIssue&&F.classList.add("active");const $=document.createElement("button");$.textContent="خروج",$.classList.add("status-button","exit-btn"),l!=null&&l.wasOutOfClass&&$.classList.add("active");const A=document.createElement("button");A.textContent="پروفایل",A.className="status-button profile-btn",M.addEventListener("click",()=>{const R=M.classList.contains("active");$.classList.contains("active")&&($.classList.remove("active"),l.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),R?(M.classList.remove("active"),y.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),d.style.textDecoration="",d.style.opacity="",d.style.color=""):(F.classList.contains("active")&&(F.classList.remove("active"),l.hadIssue=!1,s.statusCounters.otherIssues=Math.max(0,s.statusCounters.otherIssues-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),M.classList.add("active"),y.setAttendance(s.identity.studentId,"absent"),s.statusCounters.missedChances++,d.style.textDecoration="line-through",d.style.opacity="0.6",d.style.color="var(--color-secondary)",d.title=""),se(),N()}),F.addEventListener("click",()=>{const R=F.classList.contains("active");if($.classList.contains("active")&&($.classList.remove("active"),l.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),R){F.classList.remove("active"),l.hadIssue=!1;const q=le.name;s.categoryIssues[q]&&(s.categoryIssues[q]=Math.max(0,s.categoryIssues[q]-1)),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),d.style.color="",d.title=""}else{M.classList.contains("active")&&(M.classList.remove("active"),y.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),F.classList.add("active"),l.hadIssue=!0;const q=le.name;s.categoryIssues[q]=(s.categoryIssues[q]||0)+1,s.statusCounters.missedChances++,d.style.textDecoration="",d.style.opacity="",d.style.color="var(--color-warning)",d.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"}se(),N()}),$.addEventListener("click",()=>{if($.classList.contains("active"))$.classList.remove("active"),l.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),d.style.color="",d.title="";else{if(M.classList.contains("active")&&(M.classList.remove("active"),y.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),F.classList.contains("active")){F.classList.remove("active"),l.hadIssue=!1;const q=le.name;s.categoryIssues[q]&&(s.categoryIssues[q]=Math.max(0,s.categoryIssues[q]-1)),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)}$.classList.add("active"),l.wasOutOfClass=!0,s.statusCounters.outOfClassCount=(s.statusCounters.outOfClassCount||0)+1,s.statusCounters.missedChances++,d.style.textDecoration="",d.style.opacity="",d.style.color="var(--color-strong-warning)",d.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود"}se(),N()}),A.addEventListener("click",()=>{j(s),ae(),k("student-profile-page")}),w.appendChild(M),w.appendChild($),w.appendChild(F),w.appendChild(A),t.appendChild(w);const D=document.createElement("div");D.className="student-details-container";const V=document.createElement("div");V.className="student-details-scores",V.innerHTML="<h4>آخرین نمرات</h4>";const ie=document.createElement("ul");ie.className="scores-list";const Ce=["Reading","Writing","Speaking","Listening"];let X=!1;const ue=s.logs.scores||{};Ce.forEach(R=>{const q=document.createElement("li"),te=document.createElement("span");te.className="skill-name",te.textContent=`${R}:`;const Te=document.createElement("span");Te.className="skill-scores";const Gt=R.toLowerCase(),ze=ue[Gt];ze&&ze.length>0?(X=!0,Te.textContent=ze.slice(-3).map(zt=>zt.value).join(",")):Te.textContent="none",q.appendChild(te),q.appendChild(Te),ie.appendChild(q)}),!X&&Object.keys(ue).length===0&&(ie.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>'),V.appendChild(ie),D.appendChild(V);const J=document.createElement("div");J.className="student-details-notes",J.innerHTML="<h4>یادداشت‌ها</h4>";const _e=document.createElement("ul");_e.className="notes-list",s.profile.notes&&s.profile.notes.length>0?[...s.profile.notes].sort((q,te)=>new Date(te.timestamp)-new Date(q.timestamp)).forEach(q=>{const te=document.createElement("li");te.dir=rt(q.content),te.textContent=q.content,_e.appendChild(te)}):_e.innerHTML='<div class="no-content-message">یادداشتی وجود ندارد.</div>',J.appendChild(_e),D.appendChild(J),t.appendChild(D)}function Ws(e){e.addEventListener("input",()=>{const n=e.value,t=rt(n);e.setAttribute("dir",t)})}function xa(){et.innerHTML="",Ts.innerHTML="",qt.classList.add("tooltip-container"),Se.disabled=!0,pe.disabled=!0,Ve.disabled=!0,Se.value="",pe.value="",lt.classList.add("disabled-wrapper"),Ne.disabled=!0}function wt(){et.innerHTML="",u.categories.filter(t=>!t.isDeleted).forEach(t=>{const s=document.createElement("span");s.className="pill",s.textContent=t.name,s.dataset.categoryId=t.id,t.description&&(s.dataset.tooltip=t.description),s.addEventListener("click",()=>{document.querySelectorAll("#category-selection-container .pill").forEach(o=>o.classList.remove("active")),s.classList.add("active"),Ln(t),Fs(t),lt.classList.remove("disabled-wrapper"),Ne.disabled=!1;const a=y.lastWinnerByCategory[t.name];if(a){const o=u.students.find(i=>i.identity.studentId===a);o&&Be(o,t.name)}else{Ts.innerHTML="",_t(null),Oe(-1),Ne.disabled=!1;const o=document.querySelector(".current-winner-highlight");o&&o.classList.remove("current-winner-highlight")}}),s.addEventListener("contextmenu",a=>{ft(a,[{label:"تغییر نام",icon:"✏️",action:()=>{fn((i,l)=>{const c=ns(u,t,i);c.success?(t.isGradedCategory=l,N(),H(u.info.name,`نام دسته‌بندی «${t.name}» به «${i}» تغییر یافت.`),wt(),se(),C(`✅ نام دسته‌بندی به «${i}» تغییر یافت.`)):C(`⚠️ ${c.message}`)},{title:"ویرایش دسته‌بندی",initialName:t.name,initialIsGraded:t.isGradedCategory,saveButtonText:"ذخیره تغییرات"})}},{label:"حذف دسته‌بندی",icon:"🗑️",className:"danger",action:()=>{U(`آیا از انتقال دسته‌بندی «${t.name}» به سطل زباله مطمئن هستید؟`,()=>{const i={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${t.name}» از کلاس «${u.info.name}»`,restoreData:{categoryId:t.id,classroomName:u.info.name}};x.unshift(i),x.length>50&&x.pop();const l=t.name.toLowerCase();u.students.forEach(c=>{c.logs.scores&&c.logs.scores[l]&&c.logs.scores[l].forEach(g=>{g.isDeleted=!0})}),t.isDeleted=!0,H(u.info.name,`دسته‌بندی «${t.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),N(),wt(),se(),C(`✅ دسته‌بندی «${t.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}}])}),et.appendChild(s)});const n=document.createElement("span");n.className="pill add-category-pill",n.textContent="+",n.title="افزودن دسته‌بندی جدید",n.addEventListener("click",()=>{fn((t,s)=>{if(u.categories.find(i=>i.name.toLowerCase()===t.toLowerCase()&&!i.isDeleted)){C("⚠️ این دسته‌بندی از قبل وجود دارد.");return}const o=new be(t,"",s);u.categories.push(o),N(),H(u.info.name,`دسته‌بندی جدید «${t}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),wt(),C(`✅ دسته‌بندی «${t}» اضافه شد.`)})}),et.appendChild(n)}function Da(){if(y.lastUsedCategoryId){const e=et.querySelector(`.pill[data-category-id="${y.lastUsedCategoryId}"]`);e&&e.click()}y.winnerHistory&&y.winnerHistory.length>0&&(Oe(y.winnerHistory.length-1),Be())}function Fs(e){e&&(e.isGradedCategory?(Se.disabled=!1,pe.disabled=!1,Ve.disabled=!1,qt.removeAttribute("title")):(Se.disabled=!0,pe.disabled=!0,Ve.disabled=!0,qt.setAttribute("title","برای این دسته‌بندی قابلیت نمره دهی تعریف نشده است")))}function $e(){if(!u||!y){k("class-management-page");return}xa(),wt(),Da(),k("student-page"),se()}function ae(){if(!O)return;const e=O;Bs.textContent=`پروفایل: ${e.identity.name}`;const n=u.sessions.reduce((d,p)=>{const v=p.studentRecords[e.identity.studentId];return d+(v&&v.attendance==="absent"?1:0)},0),t=Object.values(e.categoryIssues||{}).reduce((d,p)=>d+p,0);Qe.innerHTML=`
    <p><strong>کل انتخاب:</strong> ${e.statusCounters.totalSelections}</p>
    <p><strong>غیبت:</strong> ${n}</p>
    <p><strong>فرصت از دست رفته:</strong> ${e.statusCounters.missedChances||0}</p>
    <p><strong>مشکل:</strong> ${t}</p>`;const s=P(u.categories),a=document.createElement("div");if(a.className="stats-breakdown",s.length>0){s.forEach(p=>{var M;const v=p.name,S=((M=e.categoryCounts)==null?void 0:M[v])||0,w=document.createElement("p");w.className="stats-breakdown-item",w.innerHTML=`<strong>${v}:</strong> ${S}`,a.appendChild(w)});const d=Qe.querySelector("p:first-child");d&&d.after(a)}const o=document.createElement("div");o.className="stats-breakdown",s.length>0&&(s.forEach(d=>{var w;const p=d.name,v=((w=e.categoryIssues)==null?void 0:w[p])||0,S=document.createElement("p");S.className="stats-breakdown-item",S.innerHTML=`<strong>${p}:</strong> ${v}`,o.appendChild(S)}),Qe.appendChild(o));const i=document.createElement("p"),l=document.createElement("strong");l.textContent="تکالیف ناقص:";const c=document.createElement("span");c.style.marginRight="5px";const g=he(u);kt(e,g,c,{includePrefix:!1}),i.appendChild(l),i.appendChild(c),Qe.appendChild(i);const E=u.categories.filter(d=>d.isGradedCategory&&!d.isDeleted);qe.innerHTML="",E.forEach(d=>{const p=document.createElement("span");p.className="pill",p.textContent=d.name,p.dataset.skillName=d.name,d.description&&(p.dataset.tooltip=d.description),qe.appendChild(p),p.addEventListener("click",()=>{qe.querySelectorAll(".pill").forEach(v=>v.classList.remove("active")),p.classList.add("active"),un.focus()})}),St.innerHTML="";const B=[];for(const d in e.logs.scores)e.logs.scores[d].forEach(p=>{p.isDeleted||B.push(p)});B.sort((d,p)=>new Date(p.timestamp)-new Date(d.timestamp)),B.length===0?St.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>':B.forEach(d=>{const p=document.createElement("li");p.className="score-history-item";const v=document.createElement("div");v.className="item-content";const S=document.createElement("div");if(S.className="score-info",S.innerHTML=`
        <span class="score-date">${new Date(d.timestamp).toLocaleDateString("fa-IR")}</span>
        <span class="score-value">نمره: <strong>${d.value}</strong></span>
        <span class="score-skill-badge">${d.skill}</span>
    `,v.appendChild(S),d.comment){const M=`توضیحات: ${d.comment}`,F=rt(M);rt(d.comment);const $=document.createElement("p");$.className="score-comment",$.dir=F,$.innerHTML=`<strong>توضیحات:</strong> <div>${Cs(d.comment)}</div>`,$.addEventListener("click",()=>{W.value=d.comment,W.dispatchEvent(new Event("input",{bubbles:!0})),ye(A=>{d.comment=A,N(),ae(),C("✅ توضیحات نمره ویرایش شد.")}),ee("add-note-modal"),W.focus()}),v.appendChild($)}const w=document.createElement("button");w.className="btn-icon delete-item-btn",w.innerHTML="🗑️",w.title="حذف این نمره",w.addEventListener("click",()=>{U(`آیا از حذف نمره ${d.value} برای مهارت ${d.skill} مطمئن هستید؟`,()=>{const M={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"score",description:`نمره ${d.value} (${d.skill}) برای دانش‌آموز «${e.identity.name}»`,restoreData:{scoreId:d.id,skill:d.skill,studentId:e.identity.studentId,classroomName:u.info.name}};x.unshift(M),x.length>50&&x.pop(),d.isDeleted=!0,H(u.info.name,`نمره ${d.value} در ${d.skill} برای «${e.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),N(),ae(),C("✅ نمره به سطل زباله منتقل شد.")},{confirmText:"تایید حذف",confirmClass:"btn-warning"})}),p.appendChild(v),p.appendChild(w),St.appendChild(p)}),un.value="",xn.value="",qe.querySelector(".pill.active")&&qe.querySelector(".pill.active").classList.remove("active"),ut()}function ut(){const e=document.getElementById("profile-notes-list");if(e.innerHTML="",!O||!O.profile.notes||O.profile.notes.length===0){e.innerHTML='<div class="no-content-message">هنوز یادداشتی ثبت نشده است.</div>';return}[...O.profile.notes].filter(t=>!t.isDeleted).sort((t,s)=>new Date(s.timestamp)-new Date(t.timestamp)).forEach(t=>{const s=document.createElement("li");s.className="note-history-item";const a=document.createElement("div");a.className="item-content";const o=document.createElement("div");o.className="note-info";const i=document.createElement("span");i.className="note-date",i.textContent=new Date(t.timestamp).toLocaleDateString("fa-IR");const l=document.createElement("button");l.className="btn-icon delete-item-btn",l.innerHTML="🗑️",l.title="حذف این یادداشت",l.addEventListener("click",()=>{U("آیا از حذف این یادداشت مطمئن هستید؟",()=>{const g={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"note",description:`یادداشت برای دانش‌آموز «${O.identity.name}»`,restoreData:{noteId:t.id,studentId:O.identity.studentId,classroomName:u.info.name}};x.unshift(g),x.length>50&&x.pop(),t.isDeleted=!0,H(u.info.name,`یادداشت دانش‌آموز «${O.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),N(),ut(),C("✅ یادداشت به سطل زباله منتقل شد.")},{confirmText:"تایید حذف",confirmClass:"btn-warning"})}),o.appendChild(i),o.appendChild(l);const c=document.createElement("p");c.className="note-content",c.innerHTML=Cs(t.content),c.addEventListener("click",()=>{W.value=t.content,W.dispatchEvent(new Event("input",{bubbles:!0})),ye(g=>{t.content=g,N(),H(u.info.name,`یادداشت دانش‌آموز «${O.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:O.identity.studentId}),ut(),C("✅یادداشت با موفقیت ویرایش شد.")}),ee("add-note-modal"),W.focus()}),a.appendChild(o),a.appendChild(c),s.appendChild(a),e.appendChild(s)})}function qs(e){an.innerHTML="",e.forEach((n,t)=>{const s=document.createElement("option");s.value=t,s.textContent=n.trim(),an.appendChild(s)})}function hn(){on.innerHTML="",Cn.forEach(e=>{const n=document.createElement("li");n.className="preview-item";const t=document.createElement("input");t.type="checkbox",t.checked=!0,t.dataset.name=e;const s=document.createElement("label");s.textContent=e,n.appendChild(t),n.appendChild(s),on.appendChild(n)})}function Ma(e){const n=document.createElement("div");n.className="list-item-buttons";const t=document.createElement("button");return t.className="btn-icon",t.innerHTML="📝",t.title="افزودن/ویرایش یادداشت کلاس",t.style.borderBottom="solid",e.note||(t.style.opacity="0.5",t.style.borderBottom="none"),t.addEventListener("click",s=>{s.stopPropagation(),An(e)}),n.appendChild(t),n}function $a(e){const n=document.createElement("div");n.style.flexGrow="1",n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="flex-start";const t=document.createElement("span");t.textContent=e.info.name,t.classList.add("class-name-display"),n.appendChild(t);const s=P(e.students).length,a=P(e.sessions).filter(c=>c.isFinished).length,o=document.createElement("div");o.classList.add("class-stats-row");const i=document.createElement("span");i.textContent=`${s} نفر`,i.classList.add("student-count-badge"),o.appendChild(i);const l=document.createElement("span");return l.textContent=`${a} جلسه`,l.classList.add("session-count-badge"),o.appendChild(l),n.appendChild(o),n.addEventListener("click",()=>{Z(e),ne(null),it(u.liveSession),Q(),k("session-page")}),n}function Oa(e){const n=document.createElement("li"),t=document.createElement("input");t.type="checkbox",t.className="mass-selection-checkbox",t.checked=me.includes(e.info.name),t.addEventListener("click",l=>{l.stopPropagation()}),t.addEventListener("change",()=>{const l=e.info.name;if(t.checked)me.includes(l)||me.push(l);else{const c=me.indexOf(l);c>-1&&me.splice(c,1)}}),n.appendChild(t);const s=$a(e);n.appendChild(s);const a=document.createElement("div");if(a.className="list-item-badges",e.liveSession&&!e.liveSession.isCancelled&&!e.liveSession.isDeleted){const l=document.createElement("span");l.className="warning-badge",l.textContent="جلسه باز",a.appendChild(l),n.classList.add("has-unfinished-session")}const o=document.createElement("span");o.className=`type-badge ${e.info.type}`,o.textContent=e.info.type==="online"?"آنلاین":"حضوری",o.title="نوع کلاس",a.appendChild(o),n.appendChild(a);const i=Ma(e);return n.appendChild(i),n.addEventListener("contextmenu",l=>{const c={label:"پشتیبان‌گیری از این کلاس",icon:"📤",action:()=>{dt([e.info.name])}},g=me.length;g>1&&me.includes(e.info.name)&&(c.label=`پشتیبان‌گیری از ${g} کلاس`,c.action=()=>{dt(me),ys([]),oe()}),ft(l,[c,{label:"تنظیمات کلاس",icon:"⚙️",action:()=>{Rn(e)}},{label:"گزارش فعالیت‌ها",icon:"📋",action:()=>{_s(e.info.name)}},{label:"تغییر نام",icon:"✏️",action:()=>{const B=e.info.name,d=document.getElementById("add-note-modal-title");d.textContent="تغییر نام کلاس",W.value=B,W.rows=1,ye(p=>{const v=p.trim();if(v&&v!==B){const S=ts(B,v);S.success?(Bo(B,v),H(v,`نام کلاس از «${B}» به «${v}» تغییر یافت.`,{type:"VIEW_SESSIONS"}),N(),oe(),C(`✅نام کلاس به «${v}» تغییر یافت.`)):C(S.message)}d.textContent="ثبت یادداشت جدید",W.rows=4}),ee("add-note-modal"),W.focus(),W.select()}},{label:"حذف کلاس",icon:"🗑️",className:"danger",action:()=>{U(`آیا از انتقال کلاس «${e.info.name}» به سطل زباله مطمئن هستید؟`,()=>{const B={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"classroom",description:`کلاس «${e.info.name}»`,restoreData:{name:e.info.name}};x.unshift(B),x.length>50&&x.pop(),e.isDeleted=!0,N(),oe(),C(`✅ کلاس «${e.info.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}])}),n}function Us(){const e=document.getElementById("class-management-stats");if(!e)return;const n=Object.values(I).filter(a=>!a.isDeleted),t=n.length,s=n.reduce((a,o)=>a+P(o.students).length,0);e.innerHTML=`
        <span>کل کلاس‌ها: <strong>${t}</strong></span>
        <span>|</span>
        <span>کل دانش‌آموزان: <strong>${s}</strong></span>
    `}function oe(){Us(),tn.innerHTML="",Object.values(I).sort((n,t)=>new Date(n.info.creationDate)-new Date(t.info.creationDate)).forEach(n=>{if(n.isDeleted)return;const t=Oa(n);tn.appendChild(t)})}function Ie(){nn.innerHTML="",u&&P(u.students).forEach(e=>{const n=document.createElement("li"),t=document.createElement("span");t.textContent=e.identity.name,t.style.flexGrow="1",t.className="student-name-link",t.addEventListener("click",()=>{j(e),ae(),k("student-profile-page")}),n.appendChild(t),n.addEventListener("contextmenu",s=>{ft(s,[{label:"تغییر نام",icon:"✏️",action:()=>{$n(e,u)}},{label:"انتقال دانش‌آموز",icon:"➡️",action:()=>{Rs(e,u)}},{label:"حذف دانش‌آموز",icon:"🗑️",className:"danger",action:()=>{U(`آیا از انتقال دانش‌آموز «${e.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const o={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${e.identity.name}» از کلاس «${u.info.name}»`,restoreData:{studentId:e.identity.studentId,classroomName:u.info.name}};x.unshift(o),x.length>50&&x.pop(),e.isDeleted=!0,H(u.info.name,`دانش‌آموز «${e.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),N(),Ie(),C(`✅ دانش‌آموز «${e.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}])}),nn.appendChild(n)})}function Ge(){if(sn.innerHTML="",!u)return;u.categories.filter(n=>!n.isDeleted).forEach(n=>{const t=document.createElement("li"),s=document.createElement("div");s.className="name-and-badge-container";const a=document.createElement("span");if(a.textContent=n.name,s.appendChild(a),n.isGradedCategory){const i=document.createElement("span");i.className="category-badge",i.textContent="قابل نمره‌دهی",s.appendChild(i)}const o=document.createElement("button");o.className="btn-icon",o.innerHTML="🗑️",o.style.color="var(--color-warning)",o.addEventListener("click",()=>{U(`آیا از انتقال دسته‌بندی «${n.name}» به سطل زباله مطمئن هستید؟`,()=>{const i={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${n.name}» از کلاس «${u.info.name}»`,restoreData:{categoryId:n.id,classroomName:u.info.name}};x.unshift(i),x.length>50&&x.pop(),n.isDeleted=!0,H(u.info.name,`دسته‌بندی «${n.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),N(),Ge(),C(`✅ دسته‌بندی «${n.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}),t.appendChild(s),t.appendChild(o),sn.appendChild(t)})}function st(e){document.querySelectorAll(".page").forEach(t=>{t.classList.remove("active")});const n=document.getElementById(e);n&&n.classList.add("active"),e==="class-management-page"?(oe(),cn.style.display="flex"):cn.style.display="none",Ps()}function k(e){const n={pageId:e,currentClassName:u?u.info.name:null,selectedSessionNumber:y?y.sessionNumber:null,selectedStudentId:O?O.identity.studentId:null};let t=`#${e}`;const s=new URLSearchParams;u&&s.set("class",u.info.name),y&&s.set("session",y.sessionNumber),O&&s.set("student",O.identity.studentId);const a=s.toString();a&&(t+=`?${a}`),window.location.hash!==t&&history.pushState(n,"",t),st(e)}function Aa(e,n){const t=document.createElement("div");t.className="list-item-buttons";const s=document.createElement("button");if(s.className="btn-icon",s.innerHTML="📝",s.title="افزودن/ویرایش یادداشت جلسه",s.style.borderBottom="solid",e.note||(s.style.opacity="0.5",s.style.borderBottom="none"),s.addEventListener("click",a=>{a.stopPropagation(),W.value=e.note||"",ye(o=>{e.note=o,N(),H(u.info.name,`یادداشت جلسه ${n} ذخیره شد.`,{type:"VIEW_SESSIONS"}),Q(),C("✅یادداشت جلسه ذخیره شد.")}),ee("add-note-modal"),W.focus()}),t.appendChild(s),!e.isFinished&&!e.isCancelled){const a=document.createElement("button");a.className="btn-icon",a.innerHTML="✅",a.title="خاتمه جلسه",a.addEventListener("click",o=>{o.stopPropagation(),U(`جلسه شماره ${n} خاتمه پیدا خواهد کرد!`,()=>{u.endSpecificSession(e.sessionNumber),N(),H(u.info.name,`جلسه ${n} خاتمه یافت.`,{type:"VIEW_SESSIONS"}),Q(),U("جلسه با موفقیت خاتمه یافت. آیا مایل به ایجاد فایل پشتیبان هستید؟",()=>{if(ge){C("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است.");return}dt(),C("✅فایل پشتیبان با موفقیت ایجاد شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}),t.appendChild(a)}return t}function Ra(e,n){const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="flex-start",t.style.flexGrow="1";const s=new Date(e.startTime).toLocaleDateString("fa-IR"),a=document.createElement("span"),o=document.createElement("div");o.style.display="flex",o.style.gap="5px",o.style.marginTop="5px";const i=new Date(e.startTime).toLocaleDateString("fa-IR",{weekday:"long"}),l=document.createElement("span");if(l.className="type-badge day-badge",l.textContent=i,o.appendChild(l),e.isCancelled){a.textContent=`✅جلسه لغو شده - تاریخ: ${s}`,t.style.cursor="default";const c=document.createElement("span");c.className="type-badge cancelled-badge",c.textContent="لغو شده",o.appendChild(c)}else a.textContent=`جلسه ${n} - تاریخ: ${s}`,t.style.cursor="pointer",t.addEventListener("click",()=>{ne(e),$e()});if(t.appendChild(a),e.isFinished){const c=document.createElement("span");c.className="type-badge",c.textContent="خاتمه یافته",c.style.backgroundColor="var(--color-secondary)",o.appendChild(c)}if(e.isMakeup){const c=document.createElement("span");c.className="type-badge",c.textContent="جبرانی",c.style.backgroundColor="var(--color-warning)",c.style.color="var(--color-text-dark)",o.appendChild(c)}return t.appendChild(o),t}function Ha(e,n){const t=document.createElement("li"),s=n.get(e.sessionNumber),a=Ra(e,s);t.appendChild(a);const o=Aa(e,s);return t.appendChild(o),t.addEventListener("contextmenu",i=>{const l=[{label:e.isCancelled?"بازگردانی جلسه":"لغو جلسه",icon:"❌",action:()=>{const c=e.isCancelled?"بازگردانی جلسه":"لغو جلسه",g=e.isCancelled?"آیا از بازگردانی این جلسه مطمئن هستید؟":"آیا از لغو این جلسه مطمئن هستید؟ جلسه لغو شده در آمار تاثیری ندارد اما قابل بازگردانی است.";U(g,()=>{e.isCancelled=!e.isCancelled;const E=e.isCancelled?`جلسه ${s} لغو شد.`:`جلسه لغو شده (تاریخ: ${new Date(e.startTime).toLocaleDateString("fa-IR")}) بازگردانی شد.`;H(u.info.name,E,{type:"VIEW_SESSIONS"}),N(),Q(),C(e.isCancelled?"✅جلسه لغو شد.":"✅جلسه بازگردانی شد.")},{confirmText:c,confirmClass:"btn-warning"})}},{label:"تغییر وضعیت جبرانی",icon:"🔄",action:()=>{u.markAsMakeup(e.sessionNumber),N();const c=e.isMakeup?`جلسه ${s} به عنوان جبرانی علامت‌گذاری شد.`:`جلسه ${s} از حالت جبرانی خارج شد.`;H(u.info.name,c,{type:"VIEW_SESSIONS"}),Q()}},{label:"حذف جلسه",icon:"🗑️",className:"danger",action:()=>{const c=e.isCancelled?"لغو شده":s;U(`آیا از انتقال جلسه ${c} به سطل زباله مطمئن هستید؟`,()=>{const g={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"session",description:`جلسه ${c} از کلاس «${u.info.name}»`,restoreData:{sessionNumber:e.sessionNumber,classroomName:u.info.name}};x.unshift(g),x.length>50&&x.pop(),e.isDeleted=!0,H(u.info.name,`جلسه ${c} به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),N(),Q(),C(`✅ جلسه ${c} به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}];ft(i,l)}),t}function Q(){const e=document.getElementById("session-list");if(!u)return;if(e.innerHTML="",u.sessions.length===0){e.innerHTML="<li>هنوز جلسه‌ای شروع نشده است.</li>";return}const n=he(u);[...P(u.sessions)].reverse().forEach(s=>{const a=Ha(s,n);e.appendChild(a)})}function Xe(e){if(Le.innerHTML="",e.length>0)e.forEach(n=>{const t=document.createElement("div");t.textContent=n.identity.name,t.addEventListener("click",()=>{j(n),ae(),k("student-profile-page"),Le.style.display="none",dn.value=""}),Le.appendChild(t)}),Le.style.display="block";else if(dn.value.trim()!==""){const n=document.createElement("div");n.className="no-results",n.textContent="پیدا نشد",Le.appendChild(n),Le.style.display="block"}else Le.style.display="none"}function Nt(e){if(Ee.innerHTML="",e.length>0)e.forEach(n=>{const t=document.createElement("div");t.className="global-search-result";const s=document.createElement("span");s.className="student-name",s.textContent=n.student.identity.name;const a=document.createElement("span");a.className="class-name",a.textContent=`کلاس: ${n.classroom.info.name}`,t.addEventListener("click",()=>{Z(n.classroom),j(n.student),ae(),k("student-profile-page"),Ee.style.display="none",It.value=""}),a.addEventListener("click",o=>{o.stopPropagation(),Z(n.classroom),ne(null),it(n.classroom.liveSession),Q(),k("session-page"),Ee.style.display="none",It.value=""}),t.appendChild(s),t.appendChild(a),Ee.appendChild(t)}),Ee.style.display="block";else if(It.value.trim()!==""){const n=document.createElement("div");n.className="no-results",n.textContent="پیدا نشد",Ee.appendChild(n),Ee.style.display="block"}else Ee.style.display="none"}function mt(){const e=document.getElementById("trashed-items-list");if(e.innerHTML="",x.length===0){e.innerHTML='<li style="text-align: center; padding: 20px;">سطل زباله خالی است.</li>';return}x.forEach((n,t)=>{const s=document.createElement("li"),a=document.createElement("span");a.textContent=n.description,a.style.flexGrow="1";const o=document.createElement("div");o.className="list-item-buttons";const i=document.createElement("button");i.className="btn-icon",i.innerHTML="🔄",i.title="بازیابی",i.addEventListener("click",()=>{var B;let c=!1,g=null;const E=n.restoreData;switch(n.type){case"classroom":{const d=I[E.name];d&&!d.isDeleted?g=`کلاسی با نام «${E.name}» از قبل فعال است.`:d&&d.isDeleted&&(d.isDeleted=!1,c=!0);break}case"student":{const d=I[E.classroomName],p=d==null?void 0:d.students.find(v=>v.identity.studentId===E.studentId);p&&(p.isDeleted=!1,c=!0);break}case"session":{const d=I[E.classroomName],p=d==null?void 0:d.sessions.find(v=>v.sessionNumber===E.sessionNumber);p&&(p.isDeleted=!1,c=!0);break}case"category":{const d=I[E.classroomName],p=d==null?void 0:d.categories.find(v=>v.id===E.categoryId);p&&(p.isDeleted=!1,c=!0);break}case"score":{const d=I[E.classroomName],p=d==null?void 0:d.students.find(S=>S.identity.studentId===E.studentId),v=(B=p==null?void 0:p.logs.scores[E.skill.toLowerCase()])==null?void 0:B.find(S=>S.id===E.scoreId);v&&(v.isDeleted=!1,c=!0);break}case"note":{const d=I[E.classroomName],p=d==null?void 0:d.students.find(S=>S.identity.studentId===E.studentId),v=p==null?void 0:p.profile.notes.find(S=>S.id===E.noteId);v&&(v.isDeleted=!1,c=!0);break}}c?(x.splice(t,1),N(),mt(),n.type==="classroom"&&oe(),C("✅ آیتم با موفقیت بازیابی شد.")):C(g?`⚠️ ${g}`:"⚠️ آیتم اصلی برای بازیابی یافت نشد.")});const l=document.createElement("button");l.className="btn-icon",l.innerHTML="🔥",l.title="حذف دائمی",l.addEventListener("click",()=>{U("آیا از حذف دائمی این آیتم مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{const c=n.restoreData;switch(n.type){case"classroom":delete I[c.name];break;case"student":at({identity:{studentId:c.studentId}},I[c.classroomName]);break;case"session":as(c.classroomName,c.sessionNumber);break;case"category":is(c.classroomName,c.categoryId);break;case"score":cs(c.classroomName,c.studentId,c.skill,c.scoreId);break;case"note":rs(c.classroomName,c.studentId,c.noteId);break}x.splice(t,1),N(),mt(),C("✅ آیتم برای همیشه حذف شد.")},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),o.appendChild(i),o.appendChild(l),s.appendChild(a),s.appendChild(o),e.appendChild(s)})}function _a(){const e=document.getElementById("absentees-summary-container");e&&(e.innerHTML=`
        <div id="absentees-summary-box" class="absentees-summary">
            <div class="absentees-summary-header">
                <h4>لیست غایبین جلسه شماره <span id="absentee-summary-session-number"></span></h4>
                <button id="copy-absentees-btn" class="btn-icon" title="کپی لیست غایبین">📋</button>
            </div>
            <div id="absentees-summary-list" class="summary-list"></div>
        </div>
    `)}function Vs(){const e=document.getElementById("absentees-summary-box"),n=document.getElementById("absentees-summary-list"),t=document.getElementById("absentee-summary-session-number");if(!e||!n||!t){console.error("Could not find all absentee summary elements.");return}if(!u||!y){e.classList.remove("visible");return}const s=P(u.students).filter(o=>{const i=y.studentRecords[o.identity.studentId];return i&&i.attendance==="absent"}),a=he(u);t.textContent=a.get(y.sessionNumber),s.length>0?e.classList.add("visible"):e.classList.remove("visible"),n.innerHTML="",s.forEach(o=>{const l=(g=>u.sessions.reduce((E,B)=>{if(B.isDeleted||B.isCancelled)return E;const d=B.studentRecords[g.identity.studentId];return E+(d&&d.attendance==="absent"?1:0)},0))(o),c=document.createElement("span");c.className="summary-name",c.textContent=`${o.identity.name} (غیبت: ${l})`,c.addEventListener("click",()=>{c.classList.add("fading-out"),setTimeout(()=>{y.setAttendance(o.identity.studentId,"present"),N(),ke()},200)}),n.appendChild(c)})}function Pa(){const e=document.getElementById("copy-absentees-btn");if(!e){console.error("Could not find the copy absentees button to attach listener.");return}e.addEventListener("click",()=>{if(!u||!y)return;const n=P(u.students).filter(a=>{const o=y.studentRecords[a.identity.studentId];return o&&o.attendance==="absent"});if(n.length===0){C("⚠️لیست غایبین خالی است.");return}const t=a=>u.sessions.reduce((o,i)=>{if(i.isDeleted||i.isCancelled)return o;const l=i.studentRecords[a.identity.studentId];return o+(l&&l.attendance==="absent"?1:0)},0);let s=`لیست غایبین جلسه شماره ${Ta()}:

`;n.forEach(a=>{const o=t(a);s+=`- ${a.identity.name} (تعداد غیبت‌ها: ${o})
`}),navigator.clipboard.writeText(s).then(()=>{C("✅لیست غایبین با موفقیت کپی شد.")}).catch(a=>{console.error("Failed to copy text: ",a),C("❌خطا در کپی کردن لیست.")})})}function Bt(){const e=document.getElementById("demo-mode-banner");e&&(ge?(e.classList.add("visible"),document.body.classList.add("demo-mode-active")):(e.classList.remove("visible"),document.body.classList.remove("demo-mode-active")))}const Wa=Object.freeze(Object.defineProperty({__proto__:null,_internalShowPage:st,addCategoryBtn:zo,addClassBtn:xo,addNoteModal:ca,addScoreBtn:ma,addStudentBtn:Ao,appHeader:cn,attendanceListUl:Ze,attendanceMassActionsContainer:Lt,attendancePage:jo,attendanceSearchInput:De,backToAttendanceBtn:Qo,backToSessionsBtn:$o,backToSessionsFromAttendanceBtn:Ko,backToStudentPageBtn:ua,backupDataBtn:na,breadcrumbContainer:Ue,cancelImportBtn:Vo,cancelNoteBtn:la,categoryListUl:sn,categoryModal:Ea,categoryModalCancelBtn:ba,categoryModalSaveBtn:Ds,categoryModalTitle:xs,classListHeader:Xo,classListUl:tn,classManagementPage:bs,classSaveNoteBtn:ra,closeActiveModal:z,closeContextMenu:Me,closeNavBtn:ea,columnMappingPage:qo,columnSelectDropdown:an,confirmColumnBtn:Uo,confirmModalCancelBtn:ln,confirmModalConfirmBtn:Ke,confirmModalMessage:ks,contextMenu:Ae,csvCancelBtn:Po,csvConfirmBtn:_o,csvFileInput:Fo,csvPreviewList:on,csvPreviewPage:Ho,customConfirmModal:oa,displayWinner:Be,finishAttendanceBtn:Jo,globalStudentSearchInput:It,globalStudentSearchResultsDiv:Ee,gradedCategoryPillsContainer:qe,hamburgerMenuBtn:Yo,handleUndo:$s,importCsvBtn:Wo,initiateBackupProcess:dt,isGradedCheckbox:fa,massCommentAppendCheckbox:Mn,massCommentBtn:mn,massCommentCancelBtn:La,massCommentContent:nt,massCommentModal:Sa,massCommentModalTitle:Ia,massCommentSaveBtn:ka,massCommentStudentCountMessage:Ms,newCategoryModalIsGradedCheckbox:Dn,newCategoryModalNameInput:tt,newCategoryNameInput:Go,newClassNameInput:To,newNoteContent:W,newScoreCommentTextarea:xn,newScoreValueInput:un,newStudentNameInput:Oo,openContextMenu:ft,openModal:ee,overlay:ta,pasteArea:Is,processMassHomeworkComment:pn,processPasteBtn:Ro,profileScoresListUl:St,profileStatsSummaryDiv:Qe,profileStudentNameHeader:Bs,quickGradeFormWrapper:qt,quickGradeSubmitBtn:Ve,quickNoteTextarea:pe,quickScoreInput:Se,renderAttendancePage:ke,renderBreadcrumbs:Ps,renderClassList:oe,renderClassManagementStats:Us,renderColumnSelector:qs,renderGlobalSearchResults:Nt,renderImportPreview:hn,renderLogModal:_s,renderMassCommentControls:On,renderSearchResults:Xe,renderSessions:Q,renderSettingsCategories:Ge,renderSettingsStudentList:Ie,renderStudentNotes:ut,renderStudentPage:$e,renderStudentProfilePage:ae,renderStudentStatsList:se,renderTrashPage:mt,restoreDataBtn:sa,restoreFileInput:Ls,secureConfirmCancelBtn:ia,secureConfirmCode:Ns,secureConfirmConfirmBtn:bt,secureConfirmInput:Fe,secureConfirmMessage:ws,secureConfirmModal:aa,selectStudentBtn:Ne,selectStudentBtnWrapper:lt,setAutoDirectionOnInput:Ws,settingsClassNameHeader:Tn,settingsPage:Mo,settingsStudentListUl:nn,showCategoryModal:fn,showClassNoteModal:An,showCustomConfirm:U,showMassCommentModal:Hs,showMoveStudentModal:Rs,showNotification:C,showPage:k,showRenameStudentModal:$n,showRestoreConfirmModal:Os,showSecureConfirm:As,showSettingsPage:Rn,showUndoToast:wa,sideNavMenu:Zo,studentProfilePage:da,studentSearchInput:dn,studentSearchResultsDiv:Le,studentStatsHeader:rn,trashedCategoriesList:ya,trashedClassesList:pa,trashedNotesList:Ca,trashedScoresList:va,trashedSessionsList:ha,trashedStudentsList:ga,triggerFileDownload:gn,undoBtn:Do,undoMessage:Ss,undoToast:Ft,updateDemoModeBanner:Bt},Symbol.toStringTag,{value:"Module"}));function Fa(){const e=window.location.hash;if(!e||e==="#")return!1;const[n,t]=e.split("?"),s=n.substring(1),a=new URLSearchParams(t),o=a.get("class"),i=parseInt(a.get("session"),10),l=a.get("student");if(o&&I[o])Z(I[o]),i&&u.getSession(i)&&ne(u.getSession(i)),l&&u.students.find(c=>c.identity.studentId===l)&&j(u.students.find(c=>c.identity.studentId===l));else return!1;switch(s){case"session-page":Q(),k("session-page");break;case"student-page":$e();break;case"attendance-page":ke(),k("attendance-page");break;case"settings-page":Tn.textContent=`تنظیمات کلاس: ${u.info.name}`,Ie(),Ge(),k("settings-page");break;case"student-profile-page":ae(),k("student-profile-page");break;default:return!1}return!0}document.addEventListener("DOMContentLoaded",()=>{const{globalStudentSearchInput:e,newClassNameInput:n,addClassBtn:t,undoBtn:s,backToSessionsBtn:a,newStudentNameInput:o,addStudentBtn:i,pasteArea:l,processPasteBtn:c,csvPreviewList:g,csvConfirmBtn:E,csvCancelBtn:B,importCsvBtn:d,csvFileInput:p,columnSelectDropdown:v,confirmColumnBtn:S,cancelImportBtn:w,newCategoryNameInput:M,addCategoryBtn:F,selectStudentBtn:$,attendancePage:A,finishAttendanceBtn:D,backToSessionsFromAttendanceBtn:V,backToAttendanceBtn:ie,classListHeader:Ce,studentStatsHeader:X,hamburgerMenuBtn:ue,sideNavMenu:J,closeNavBtn:_e,overlay:R,backupDataBtn:q,restoreDataBtn:te,restoreFileInput:Te,confirmModalCancelBtn:Gt,confirmModalConfirmBtn:ze,secureConfirmCancelBtn:zt,secureConfirmConfirmBtn:Gs,newNoteContent:pt,classSaveNoteBtn:zs,cancelNoteBtn:js,studentSearchInput:je,studentSearchResultsDiv:Js,studentProfilePage:Ks,profileStudentNameHeader:Qs,backToStudentPageBtn:Xs,gradedCategoryPillsContainer:Ys,newScoreValueInput:Zs,newScoreCommentTextarea:eo,addScoreBtn:to,isGradedCheckbox:Hn,categoryModalSaveBtn:no,categoryModalCancelBtn:so,massCommentBtn:oo,massCommentCancelBtn:ao,massCommentSaveBtn:io,massCommentContent:co,massCommentAppendCheckbox:ro,attendanceSearchInput:_n}=Wa,lo=document.getElementById("trash-nav-btn");document.querySelector(".global-search-container .search-icon"),Rt(),Bt(),Fa()||(oe(),k("class-management-page"));function Pn(r,f){const m=document.querySelector(r);if(!m)return;const h=m.querySelector(".search-icon"),b=m.querySelector(".animated-search-input");!h||!b||(h.addEventListener("mousedown",T=>{T.preventDefault()}),h.addEventListener("click",()=>{m.classList.contains("search-active")||(m.classList.add("search-active"),b.focus())}),b.addEventListener("blur",()=>{setTimeout(()=>{m.classList.remove("search-active"),b.value="",f&&f([])},150)}))}_n.addEventListener("input",()=>{const r=_n.value.toLowerCase().trim(),f=Yt(r);Ze.querySelectorAll(".attendance-list-item").forEach(h=>{const b=h.querySelector(".student-name");if(b){const T=b.textContent,L=ve(T.toLowerCase()),Y=L.includes(ve(r)),G=L.includes(ve(f));Y||G?h.style.display="flex":h.style.display="none"}})}),so.addEventListener("click",()=>{z(),Vt(null)}),no.addEventListener("click",()=>{const r=tt.value.trim(),f=Dn.checked;typeof Ot=="function"&&Ot(r,f)}),window.addEventListener("scroll",Me),document.addEventListener("click",r=>{Ae.classList.contains("visible")&&!Ae.contains(r.target)&&Me(),je.contains(r.target)||(Js.style.display="none");const f=r.target.closest(".log-action-link");if(f&&f.dataset.action)try{const m=JSON.parse(f.dataset.action);yo(m)}catch(m){console.error("Could not parse log action:",m)}}),lt.addEventListener("click",()=>{(lt.classList.contains("disabled-wrapper")||Ne.disabled)&&(Ne.classList.add("shake-animation"),setTimeout(()=>{Ne.classList.remove("shake-animation")},200))}),X.addEventListener("click",()=>{const r=new Date().getTime();r-bn>500?Et(1):Et(Dt+1),ps(r),Dt===5&&(Et(0),U("آیا از صفر کردن تمام شمارنده‌های دانش‌آموزان مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{os(),se(),C("تمام آمارها صفر شدند ✅.")},{confirmText:"بله",confirmClass:"btn-warning"}))}),Ce.addEventListener("click",()=>{const r=new Date().getTime();r-En>500?vt(1):vt(xt+1),fs(r),xt===5&&(vt(0),U("آیا از ساخت یک کلاس تستی تصادفی مطمئن هستید؟",()=>{function f(){const m=`کلاس تستی ${Object.keys(I).length+1}`,h=new en({name:m,type:"online"});["علی رضایی","مریم حسینی","زهرا احمدی","رضا محمدی","فاطمه کریمی"].forEach(T=>h.addStudent(new yt({name:T}))),I[m]=h,N(),oe()}f(),C("کلاس تستی با موفقیت ساخته شد ✅!")},{confirmText:"بساز",confirmClass:"btn-success"}))}),zt.addEventListener("click",()=>{z(),ct(null)}),Gs.addEventListener("click",()=>{typeof Mt=="function"&&Mt(),z(),ct(null)}),Gt.addEventListener("click",()=>{z(In)}),ze.addEventListener("click",()=>{z(Sn)}),ie.addEventListener("click",()=>{u&&y&&(ke(),k("attendance-page"))}),$.addEventListener("click",()=>{if(Se.value.trim()!==""||pe.value.trim()!==""){C("⚠️لطفاً ابتدا با دکمه «ثبت»، تغییرات را ذخیره کنید و یا نمره و یادداشت را پاک کنید.");return}if(!u||!y||!le)return;const r=u.selectNextWinner(le.name,y);if(r){const f=y.studentRecords[r.identity.studentId];if(f&&f.attendance==="absent"&&r.statusCounters.missedChances++,f&&f.hadIssue){r.statusCounters.missedChances++;const h=le.name;r.categoryIssues[h]=(r.categoryIssues[h]||0)+1}const m={winner:r,categoryName:le.name};y.winnerHistory.push(m),y.winnerHistory.length>10&&y.winnerHistory.shift(),Oe(y.winnerHistory.length-1),y.lastUsedCategoryId=le.id,y.lastSelectedWinnerId=r.identity.studentId,se(),Be(),N()}else C("❌دانش‌آموز واجد شرایطی برای انتخاب یافت نشد.")}),F.addEventListener("click",()=>{if(!u)return;const r=M.value.trim(),f=Hn.checked;if(!r){alert("⚠️لطفاً نام دسته‌بندی را وارد کنید.");return}const m=u.categories.find(b=>b.name.toLowerCase()===r.toLowerCase());if(m)if(m.isDeleted){const b=u.categories.findIndex(T=>T===m);b>-1&&u.categories.splice(b,1)}else{alert("⚠️این دسته‌بندی از قبل وجود دارد.");return}const h=new be(r,"",f);u.categories.push(h),N(),H(u.info.name,`دسته‌بندی جدید «${r}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),Ge(),M.value="",Hn.checked=!1}),M.addEventListener("keyup",r=>{r.key==="Enter"&&F.click()}),S.addEventListener("click",()=>{if(!Tt){alert("❌خطایی رخ داده است. لطفاً فایل را دوباره انتخاب کنید."),k("settings-page");return}const r=parseInt(v.value,10),h=Tt.split(`
`).slice(1).map(b=>{var L;return(L=b.split(",")[r])==null?void 0:L.trim()}).filter(b=>b&&b.length>0);h.length>0?(Je(h),hn(),k("csv-preview-page")):alert("هیچ نامی در ستون انتخاب شده پیدا نشد. لطفاً ستون دیگری را امتحان کنید یا فایل خود را بررسی کنید."),Ct(null)}),d.addEventListener("click",()=>{p.click()}),p.addEventListener("change",r=>{const f=r.target.files[0];if(!f)return;const m=new FileReader;m.onload=h=>{const b=h.target.result;Ct(b);const L=b.split(`
`)[0].split(",");qs(L),k("column-mapping-page")},m.readAsText(f),r.target.value=null}),w.addEventListener("click",()=>{Ct(null),k("settings-page")}),E.addEventListener("click",()=>{const r=g.querySelectorAll('input[type="checkbox"]:checked');let f=!1;r.forEach(m=>{const h=m.dataset.name,b=u.students.find(L=>L.identity.name.toLowerCase()===h.toLowerCase());if(b)if(b.isDeleted)at(b,u);else{console.log(`دانش‌آموز «${h}» به دلیل تکراری بودن اضافه نشد.`);return}const T=new yt({name:h});u.addStudent(T),u.sessions.length>0&&(P(u.sessions).filter(L=>L.isFinished&&!L.isCancelled).forEach(L=>{L.setAttendance(T.identity.studentId,"absent")}),Un(T,u),f=!0)}),N(),H(u.info.name,`${r.length} دانش‌آموز جدید از لیست ورودی به کلاس اضافه شدند.`,{type:"VIEW_SESSIONS"}),Ie(),f&&Vn(r.length),k("settings-page"),l.value="",Je([])}),B.addEventListener("click",()=>{Je([]),k("settings-page")}),c.addEventListener("click",()=>{const r=l.value.trim();if(!r){alert("کادر متنی خالی است. لطفاً اسامی را وارد کنید.");return}const f=r.split(`
`).map(m=>m.trim()).filter(m=>m.length>0);f.length>0?(Je(f),hn(),k("csv-preview-page")):alert("هیچ نام معتبری برای ورود پیدا نشد.")}),o.addEventListener("keyup",r=>{r.key==="Enter"&&i.click()}),i.addEventListener("click",()=>{if(!u)return;const r=o.value.trim();if(!r){alert("لطفاً نام دانش‌آموز را وارد کنید.");return}const f=u.students.find(h=>h.identity.name.toLowerCase()===r.toLowerCase());if(f)if(f.isDeleted)at(f,u);else{alert("❌دانش‌آموزی با این نام از قبل در این کلاس وجود دارد.");return}const m=new yt({name:r});u.addStudent(m),u.sessions.length>0&&(P(u.sessions).filter(h=>h.isFinished&&!h.isCancelled).forEach(h=>{h.setAttendance(m.identity.studentId,"absent")}),Un(m,u),Vn(1)),N(),H(u.info.name,`دانش‌آموز «${r}» به کلاس اضافه شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:m.identity.studentId}),Ie(),se(),o.value="",o.focus()}),a.addEventListener("click",()=>{Q(),k("session-page")}),document.getElementById("new-session-btn").addEventListener("click",()=>{if(u){const r=u.sessions.find(m=>!m.isFinished&&!m.isCancelled&&!m.isDeleted);if(r){C(`⚠️ جلسه ${r.sessionNumber} هنوز تمام نشده است. لطفاً ابتدا با دکمه ✅ آن را خاتمه دهید.`);return}const f=()=>{const m=h=>{const b=u.startNewSession();it(b),ne(b),u.students.forEach(Y=>{yn.setAttendance(Y.identity.studentId,"present")}),N();const L=he(u).get(b.sessionNumber);H(u.info.name,`جلسه ${L} شروع شد.`,{type:"VIEW_SESSIONS"}),h?(ke(),k("attendance-page")):$e()};U("آیا تمایل به انجام فرآیند حضور و غیاب دارید؟",()=>m(!0),{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success",onCancel:()=>m(!1)})};u.hasSessionToday()?U("شما امروز یک جلسه برای این کلاس ثبت کرده‌اید. آیا از شروع یک جلسه جدید دیگر مطمئن هستید؟",f,{confirmText:"بله",confirmClass:"btn-warning"}):f()}}),t.addEventListener("click",()=>{const r=n.value.trim(),f=document.querySelector('input[name="class-type"]:checked');if(!r&&!f){C("⚠️لطفاً نام و نوع کلاس را مشخص کنید.");return}if(!r){C("⚠️لطفاً نام کلاس را وارد کنید.");return}if(!f){C("⚠️لطفاً نوع کلاس را انتخاب کنید.");return}if(I[r]){I[r].isDeleted?C("⚠️ کلاسی با این نام در سطل زباله است. ابتدا آن را بازیابی کنید و یا آن را پاک کنید."):C("⚠️کلاسی با این نام از قبل وجود دارد.");return}const m=f.value,h=new en({name:r,type:m});I[r]=h,N(),H(r,`کلاس «${r}» ایجاد شد.`,{type:"VIEW_SESSIONS"}),oe(),C(`✅ کلاس «${r}» با موفقیت ایجاد شد.`),n.value="",f.checked=!1}),e.addEventListener("input",r=>{const f=r.target.value;if(f.length<2){Nt([]);return}const m=f.toLowerCase(),h=Yt(m),b=[];for(const T in I){const L=I[T];if(L.isDeleted)continue;P(L.students).filter(G=>{const re=ve(G.identity.name.toLowerCase()),Pe=re.includes(ve(m)),Jt=re.includes(ve(h));return Pe||Jt}).forEach(G=>{b.push({student:G,classroom:L})})}Nt(b)}),n.addEventListener("keyup",r=>{r.key==="Enter"&&t.click()}),s.addEventListener("click",$s),document.querySelectorAll(".back-to-classes-btn").forEach(r=>{r.addEventListener("click",()=>{Z(null),ne(null),it(null),k("class-management-page")})}),D.addEventListener("click",()=>{$e()}),V.addEventListener("click",()=>{Q(),k("session-page")}),Xs.addEventListener("click",()=>{if(j(null),!y&&u&&u.sessions.length>0){const r=P(u.sessions).filter(f=>!f.isCancelled);if(r.length>0){const f=r[r.length-1];ne(f)}else{Q(),k("session-page");return}}$e()}),je.addEventListener("input",r=>{const f=r.target.value;if(!f){Xe([]);return}const m=f.toLowerCase(),h=Yt(m),T=P(u.students).filter(L=>{const Y=ve(L.identity.name.toLowerCase()),G=Y.includes(ve(m)),re=Y.includes(ve(h));return G||re});Xe(T)}),je.addEventListener("focus",()=>{je.value&&Xe(je.value)}),Ve.addEventListener("click",()=>{const r=Se.value,f=pe.value.trim();let m;if(At)m=At.student;else{const b=y==null?void 0:y.winnerHistory[fe];m=b==null?void 0:b.winner}if(!m){C("❌خطا: دانش‌آموز معتبری برای ثبت نمره یافت نشد.");return}const h=le;if(!m||!h){C("⚠️لطفاً ابتدا یک دانش‌آموز و یک دسته‌بندی را انتخاب کنید.");return}if(!r){C("⚠️لطفاً مقدار نمره را وارد کنید.");return}if(r>100||r<0){C("❌نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}m&&(m.addScore(h.name,parseFloat(r),f),H(u.info.name,`نمره ${r} در ${h.name} برای «${m.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:m.identity.studentId}),N(),se(),C(`✅نمره برای ${m.identity.name} در مهارت ${h.name} ثبت شد.`),Se.value="",pe.value="",Be(m,h.name))});const Wn=r=>{r.key==="Enter"&&r.ctrlKey&&(r.preventDefault(),Ve.click())};Se.addEventListener("keydown",Wn),pe.addEventListener("keydown",Wn),to.addEventListener("click",()=>{const r=Ys.querySelector(".pill.active");if(!r){C("⚠️لطفاً یک مهارت را برای نمره‌دهی انتخاب کنید.");return}const f=r.dataset.skillName,m=Zs.value,h=eo.value.trim();if(!m){C("لطفاً مقدار نمره را وارد کنید.");return}O.addScore(f,parseFloat(m),h),N(),H(u.info.name,`نمره ${m} در ${f} برای «${O.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:O.identity.studentId}),ae(),C(`✅نمره برای مهارت ${f} با موفقیت ثبت شد.`)}),document.getElementById("add-note-btn").addEventListener("click",()=>{O&&(pt.value="",pt.dispatchEvent(new Event("input",{bubbles:!0})),ye(r=>{r&&(O.addNote(r),N(),H(u.info.name,`یادداشت جدیدی برای دانش‌آموز «${O.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:O.identity.studentId}),ut())}),ee("add-note-modal"),pt.focus())}),js.addEventListener("click",()=>{z()}),zs.addEventListener("click",()=>{const r=pt.value.trim();typeof $t=="function"&&($t(r),ke(),z())});const uo=document.getElementById("move-student-confirm-btn"),mo=document.getElementById("move-student-cancel-btn"),fo=document.getElementById("move-student-class-select");mo.addEventListener("click",()=>{z()}),uo.addEventListener("click",()=>{const r=fo.value,f=I[r],{studentToMove:m,sourceClassForMove:h}=ko;if(!m||!h||!f){C("خطایی رخ داد. لطفاً دوباره امتحان کنید⚠️.","error"),z();return}const b=ss(m,h,f);b.success?(H(h.info.name,`دانش‌آموز «${m.identity.name}» به کلاس «${r}» منتقل شد.`,{type:"VIEW_SESSIONS"}),H(r,`دانش‌آموز «${m.identity.name}» از کلاس «${h.info.name}» به این کلاس منتقل شد.`,{type:"VIEW_SESSIONS"}),N(),Ie(),C(`دانش‌آموز «${m.identity.name}» با موفقیت به کلاس «${r}» منتقل شد✅.`)):C(b.message,"error"),z()}),ue.addEventListener("click",()=>{J.style.width="300px",R.classList.add("modal-visible")}),_e.addEventListener("click",ce),R.addEventListener("click",ce),lo.addEventListener("click",()=>{mt(),k("trash-page"),ce()}),document.getElementById("demo-mode-btn").addEventListener("click",()=>{ge?qn():(ce(),U("شما در حال ورود به حالت نمایش (Demo) هستید. در این حالت، هیچ‌کدام از تغییرات شما ذخیره نخواهد شد. آیا ادامه می‌دهید؟",()=>{ls(),Bt(),ce()},{confirmText:"تایید",confirmClass:"btn-warning",onCancel:ce}))});const Fn=document.getElementById("exit-demo-btn");Fn&&Fn.addEventListener("click",()=>{ge&&qn()}),q.addEventListener("click",()=>{if(ge){C("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است."),ce();return}ce(),dt()}),te.addEventListener("click",()=>{if(ge){C("⚠️ بازیابی اطلاعات در حالت نمایش (Demo) غیرفعال است."),ce();return}Te.click(),ce()}),Te.addEventListener("change",r=>{const f=r.target.files[0];if(!f)return;const m=new FileReader;m.onload=h=>{try{const b=JSON.parse(h.target.result);if(b.metadata&&b.data)Os(b);else{const T=b.classrooms||b,L=b.trashBin||[];U("آیا از بازیابی اطلاعات مطمئن هستید؟ تمام داده‌های فعلی شما بازنویسی خواهد شد.",()=>{He(T),Pt(L),Ye({lastRestoreTimestamp:new Date().toISOString()}),N(),oe(),k("class-management-page"),C("✅اطلاعات با موفقیت بازیابی شد.")},{confirmText:"بازیابی کن",confirmClass:"btn-warning"})}}catch(b){C("❌خطا در خواندن فایل. لطفاً فایل پشتیبان معتبر انتخاب کنید."),console.error("Restore error:",b)}},m.readAsText(f),r.target.value=null}),window.addEventListener("popstate",r=>{if(we&&history.pushState(null,"",location.href),Me(),r.state){const{pageId:f,currentClassName:m,selectedSessionNumber:h,selectedStudentId:b}=r.state;m&&(Z(I[m]),h&&ne(u.getSession(h)),b&&j(u.students.find(T=>T.identity.studentId===b))),f==="student-page"?$e():(f==="session-page"&&Q(),st(f))}else Z(null),ne(null),j(null),st("class-management-page")}),document.addEventListener("keydown",r=>{var h;const f=document.activeElement;if(!["INPUT","TEXTAREA","SELECT"].includes(f.tagName)){if(r.key.toLowerCase()==="o"&&r.shiftKey&&bs.classList.contains("active")&&(r.preventDefault(),Ls.click()),r.key==="Escape"){if(Ae.classList.contains("visible")){Me();return}if(we){z();return}switch((h=document.querySelector(".page.active"))==null?void 0:h.id){case"csv-preview-page":case"column-mapping-page":k("settings-page");break;case"student-profile-page":j(null),k(y?"student-page":"session-page");break;case"attendance-page":k("student-page");break;case"student-page":ne(null),Q(),k("session-page");break;case"settings-page":case"session-page":Z(null),k("class-management-page");break}return}if(y){const b=r.key.toLowerCase();switch(" ascfg".includes(b)&&r.preventDefault(),b){case" ":$.click();break;case"a":A.classList.contains("active")?history.back():(ke(),k("attendance-page"));break;case"s":document.getElementById("session-page").classList.contains("active")?history.back():a.click();break;case"c":document.querySelector(".back-to-classes-btn").click();break;case"f":const T=document.querySelector(".action-column .search-icon");T&&T.click();break;case"g":if(Ks.classList.contains("active"))history.back();else{const L=y.lastSelectedWinnerId;if(L){const Y=u.students.find(G=>G.identity.studentId===L);Y&&(j(Y),ae(),k("student-profile-page"))}else C("⚠️ابتدا یک نفر را انتخاب کنید تا پروفایل او نمایش داده شود.")}break;case"arrowleft":{const L=document.querySelector('button[title="برنده قبلی"]');L&&!L.disabled&&(r.preventDefault(),L.click());break}case"arrowright":{const L=document.querySelector('button[title="برنده بعدی"]');L&&!L.disabled&&(r.preventDefault(),L.click());break}}}}});function ce(){J.style.width="0",R.classList.add("modal-closing"),setTimeout(()=>{R.classList.remove("modal-visible","modal-closing")},300)}function qn(){U("آیا از خروج از حالت نمایش (Demo) مطمئن هستید؟ با خروج، تمام تغییرات آزمایشی شما حذف شده و داده‌های اصلی شما بازیابی خواهند شد.",()=>{ds(),Z(null),ne(null),j(null),oe(),k("class-management-page"),Bt(),ce()},{confirmText:"خروج",confirmClass:"btn-success"})}Pn(".global-search-container .animated-search-container",Nt),Pn(".action-column-header .animated-search-container",Xe),[W,xn,pe,Is].forEach(r=>{r&&Ws(r)}),Qs.addEventListener("click",()=>{$n(O,u)});function Un(r,f){const m=P(f.students).filter(_=>_.identity.studentId!==r.identity.studentId);if(m.length===0)return;const h=m.reduce((_,K)=>K.statusCounters.totalSelections>_.statusCounters.totalSelections?K:_,m[0]);if(!h||h.statusCounters.totalSelections===0)return;r.categoryCounts=JSON.parse(JSON.stringify(h.categoryCounts)),r.statusCounters.totalSelections=h.statusCounters.totalSelections;const b=m.reduce((_,K)=>_+K.statusCounters.totalSelections,0),T=m.reduce((_,K)=>_+(K.statusCounters.missedChances||0),0),L=b>0?T/b:0;r.statusCounters.missedChances=Math.round(r.statusCounters.totalSelections*L);const Y=P(f.categories),G={};Y.forEach(_=>{const K=m.reduce((Qt,Xt)=>Qt+(Xt.categoryCounts[_.name]||0),0),Kt=m.reduce((Qt,Xt)=>Qt+(Xt.categoryIssues[_.name]||0),0);G[_.name]=K>0?Kt/K:0}),Y.forEach(_=>{const K=r.categoryCounts[_.name]||0,Kt=G[_.name]||0;r.categoryIssues[_.name]=Math.round(K*Kt)});const re=f.liveSession;re?r.onboardingSession=re.sessionNumber:r.onboardingSession=f.sessions.length+1;const Pe=P(f.sessions).filter(_=>_.isFinished&&!_.isCancelled),Jt="📝 یادداشت خودکار سیستم",bo=`این دانش‌آموز  از جلسه شماره ${Pe.length} به کلاس اضافه شد. آمار مشارکت او بر اساس فعال‌ترین دانش‌آموز و آمار «فرصت از دست رفته» او بر اساس میانگین کلاس ثبت گردید:`,We=[];r.statusCounters.totalSelections>0&&We.push(`کل انتخاب‌ها: ${r.statusCounters.totalSelections}`),r.statusCounters.missedChances>0&&We.push(`فرصت‌های از دست رفته: ${r.statusCounters.missedChances}`);for(const _ in r.categoryCounts){const K=r.categoryCounts[_];K>0&&We.push(`انتخاب در «${_}»: ${K}`)}for(const _ in r.categoryIssues){const K=r.categoryIssues[_];K>0&&We.push(`مشکل در «${_}»: ${K}`)}if(We.length>0){const _=`${Jt}
${bo}

- ${We.join(`
- `)}`;r.addNote(_)}}function Vn(r){const m=`چون این کلاس جلسات برگزار شده دارد، برای ${r>1?"دانش‌آموزان جدید":"دانش‌آموز جدید"} آمار پایه‌ای (متناسب با سایر دانش‌آموزان) ثبت شد تا در فرایند انتخاب اختلالی ایجاد نشود.`;U(m,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}const po="8.0.0";document.getElementById("app-version").textContent=`نسخه ${po}`;function go(){console.log("Starting universal backfill for writing scores...");let r=0;for(const f in I){const m=I[f];if(m.isDeleted)continue;let h=0;P(m.students).forEach(T=>{const L=T.logs.scores;if(!(L&&L.writing&&L.writing.length>0)){let G=-1;for(const re in L)re!=="writing"&&L[re].forEach(Pe=>{Pe.value>G&&(G=Pe.value)});if(G>-1){const re=`Automatically assigned based on the highest score (${G}) from other skills.`;T.addScore("Writing",G,re),h++}}}),h>0&&(console.log(`Updated ${h} student(s) in class: ${m.info.name}.`),r+=h)}r>0?(N(),console.log(`Update complete. A total of ${r} student(s) were updated across all classes. Data saved.`),document.getElementById("student-page").classList.contains("active")&&se()):console.log("No students needed updating in any class.")}window.backfillWritingScoresForAll=go;function ho(){console.log("Starting backfill for 'outOfClassCount' and 'wasOutOfClass' properties...");let r=0,f=0;const m=localStorage.getItem("teacherAssistantData_v2");if(!m){console.log("No data found in localStorage. Nothing to do.");return}const h=JSON.parse(m);for(const b in h){const T=h[b];T.students&&T.students.forEach(L=>{L.statusCounters&&typeof L.statusCounters.outOfClassCount>"u"&&(L.statusCounters.outOfClassCount=0,r++)}),T.sessions&&T.sessions.forEach(L=>{if(L.studentRecords)for(const Y in L.studentRecords){const G=L.studentRecords[Y];typeof G.wasOutOfClass>"u"&&(G.wasOutOfClass=!1,f++)}})}localStorage.setItem("teacherAssistantData_v2",JSON.stringify(h)),console.log(`Backfill complete. Updated ${r} students and ${f} session records. Data saved.`),Rt(),u&&se()}window.backfillExitCounters=ho;function yo(r){if(!r||!r.classroomName)return;const f=I[r.classroomName];if(!f){C("⚠️ کلاس مربوط به این گزارش یافت نشد.");return}Z(f),z(),setTimeout(()=>{switch(r.type){case"VIEW_STUDENT_PROFILE":{const m=f.students.find(h=>h.identity.studentId===r.studentId);m?(j(m),ae(),k("student-profile-page")):C("⚠️ دانش‌آموز مورد نظر یافت نشد.");break}case"VIEW_TRASH":mt(),k("trash-page");break;case"VIEW_SESSIONS":Q(),k("session-page");break;case"VIEW_CLASS_NOTE":An(f);break;case"VIEW_CLASS_SETTINGS":Rn(f);break}},300)}oo.addEventListener("click",()=>{Hs()}),ao.addEventListener("click",()=>{z()}),io.addEventListener("click",()=>{const r=co.value.trim(),f=ro.checked;if(!r){Mn.style.display==="flex"?U("کادر یادداشت خالی است. آیا مطمئنید که می‌خواهید یادداشت‌های قبلی دانش‌آموزان انتخاب‌شده را پاک کنید؟",()=>{z(),pn("",!1)},{confirmText:"پاک کردن",confirmClass:"btn-warning"}):C("⚠️ لطفاً متن یادداشت را وارد کنید.");return}z(()=>{pn(r,f)})});const xe=document.getElementById("screen-saver-overlay"),Gn=document.getElementById("screen-saver-toggle");let jt;const Co=2*60*1e3,zn=["mousemove","keypress","scroll","click","touchstart"];function vo(){xe.classList.add("visible")}function jn(){xe.classList.contains("visible")&&xe.classList.remove("visible")}function gt(){jn(),clearTimeout(jt),jt=setTimeout(vo,Co)}function ht(r){r.preventDefault(),r.stopPropagation(),setTimeout(gt,0)}function Jn(){gt(),zn.forEach(f=>window.addEventListener(f,gt)),xe.addEventListener("click",ht),xe.addEventListener("touchstart",ht);const r="8.0.0";{const f=document.getElementById("screen-saver-version");f&&(f.textContent=`v${r}`)}}function Eo(){clearTimeout(jt),jn(),zn.forEach(r=>window.removeEventListener(r,gt)),xe.removeEventListener("click",ht),xe.removeEventListener("touchstart",ht)}Gn.checked=de.isScreenSaverEnabled,de.isScreenSaverEnabled&&Jn(),Gn.addEventListener("change",r=>{r.target.checked?(Ye({isScreenSaverEnabled:!0}),Jn()):(ce(),r.preventDefault(),U(`نکته:
محافظ صفحه در تلفن های همراه جدید کمک می کند که دستگاه باطری کمتری مصرف کند و به دلیل ثابت ماندن صفحه نمایش در گوشی های قدیمی تر، صفحه نمایش دچار ماندگی رد پیکسل نگردد. آیا مطمئن هستید که می خواهید این ویژگی را غیر فعال کنید؟`,()=>{r.target.checked=!1,Ye({isScreenSaverEnabled:!1}),Eo(),C("توصیه می شود زمان خاموش شدن صفحه نمایش گوشی خود را به حداقل دو دقیقه تغییر دهید تا در استفاده های طولانی مدت صفحه نمایش گوشی اصطحلاک کمتری را تجربه کند",7e3)},{confirmText:"بله، غیرفعال کن",cancelText:"لغو",onCancel:()=>{r.target.checked=!0}}))})});
