(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(a){if(a.ep)return;a.ep=!0;const s=n(a);fetch(a.href,s)}})();class wt{constructor(t){this.identity={name:t.name,studentId:t.studentId||`id_${new Date().getTime()}_${Math.random()}`,branchName:t.branchName||null,ageGroup:t.ageGroup||"adult",level:t.level||null,contact:{social:t.socialContact||null,parent:t.parentContact||null}},this.isDeleted=!1,this.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0,outOfClassCount:0},this.categoryCounts={},this.categoryIssues={},this.logs={parentContacts:[],scores:{},discipline:{},sessionHistory:{}},this.profile={notes:[],tags:[]},this.finalClassActivityScore=null,this.onboardingSession=null}addScore(t,n,o){if(n>100||n<0){console.log("نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}const a=t.toLowerCase();this.logs.scores[a]||(this.logs.scores[a]=[]);const s=new ho(t,n,o);this.logs.scores[a].push(s)}addNote(t,n=null){const o=new yo(t,n);this.profile.notes.push(o)}getOverallAverageScore(){let t=0,n=0;for(const a in this.logs.scores)this.logs.scores[a].forEach(s=>{s.isDeleted||(t+=s.value,n++)});if(n===0)return null;const o=t/n;return Math.round(o*100)/100}}class ho{constructor(t,n,o=""){this.id=`score_${new Date().getTime()}`,this.skill=t,this.value=n,this.timestamp=new Date,this.comment=o,this.isDeleted=!1}}class yo{constructor(t,n=null){this.id=`note_${new Date().getTime()}`,this.timestamp=new Date,this.content=t,this.isDeleted=!1,this.source=n}}class on{constructor(t="complete",n=""){this.status=t,this.comment=n,this.timestamp=new Date}}class ns{constructor(t){this.sessionNumber=t,this.startTime=new Date,this.note="",this.isDeleted=!1,this.endTime=null,this.isFinished=!1,this.isMakeup=!1,this.isCancelled=!1,this.studentRecords={},this.lastWinnerByCategory={},this.lastUsedCategoryId=null,this.lastSelectedWinnerId=null,this.winnerHistory=[]}end(){this.isFinished=!0,this.endTime=new Date}markAsMakeup(){this.isMakeup=!this.isMakeup}initializeStudentRecord(t){this.studentRecords[t]||(this.studentRecords[t]={attendance:"present",homework:new on,selections:{},hadIssue:!1,wasOutOfClass:!1})}setAttendance(t,n){this.initializeStudentRecord(t),this.studentRecords[t].attendance=n}setHomeworkStatus(t,n){this.initializeStudentRecord(t),this.studentRecords[t].homework.status=n}selectNextWinner(t,n,o){if(!n||n.length===0)return console.log("هیچ دانش‌آموزی در کلاس برای انتخاب وجود ندارد."),null;const a=this.lastWinnerByCategory[t];let s=n.filter(u=>u.identity.studentId!==a&&!u.isDeleted);if(s.length===0&&(s=n),s.length===0)return null;const i=(u,v)=>u.categoryCounts[v]||0,l=Math.min(...s.map(u=>i(u,t))),c=s.filter(u=>i(u,t)===l);let m;if(c.length===1)m=c[0];else if(c.length>1){const u=o.filter(M=>!M.isDeleted&&M.name!==t).map(M=>M.name),v=c.map(M=>{const J=u.reduce((j,Q)=>j+i(M,Q),0);return{student:M,otherCategoriesTotal:J}}),b=Math.min(...v.map(M=>M.otherCategoriesTotal)),k=v.filter(M=>M.otherCategoriesTotal===b).map(M=>M.student);k.length===1?m=k[0]:m=k[Math.floor(Math.random()*k.length)]}else m=s[Math.floor(Math.random()*s.length)];const p=m.identity.studentId;this.initializeStudentRecord(p);const I=(this.studentRecords[p].selections[t]||0)+1;return this.studentRecords[p].selections[t]=I,m.statusCounters.totalSelections++,m.categoryCounts[t]=(m.categoryCounts[t]||0)+1,this.lastWinnerByCategory[t]=p,m}}class an{constructor(t){this.info={name:t.name||"NotNamed",scheduleCode:t.scheduleCode||`code_${new Date().getTime()}`,teacherName:t.teacherName||null,type:t.type||"in-person",term:t.term||null,scheduleText:t.scheduleText||null,level:t.level||null,creationDate:t.creationDate?new Date(t.creationDate):new Date},this.students=[],this.sessions=[],this.note="",this.isDeleted=!1,this.categories=[new we("Vocabulary","Questions about words and meanings."),new we("Grammar","Questions about sentence structure and rules."),new we("Listening",void 0,!0),new we("Speaking",void 0,!0),new we("Reading",void 0,!0),new we("Writing",void 0,!0)],this.futurePlans={}}addStudent(t){this.students.push(t)}removeStudent(t){this.students=this.students.filter(n=>n.identity.studentId!==t)}startNewSession(){const t=this.sessions.length+1,n=new ns(t);return this.sessions.push(n),n}endSpecificSession(t){const n=this.getSession(t);return n&&!n.isFinished?(n.end(),!0):!1}getSession(t){return this.sessions.find(n=>n.sessionNumber===t)}markAsMakeup(t){const n=this.getSession(t);n&&n.markAsMakeup()}planForSession(t,n){this.futurePlans[t]=n}hasSessionToday(){const t=new Date().toDateString();return this.sessions.some(n=>!n.isDeleted&&n.startTime.toDateString()===t)}selectNextWinner(t,n){return n?n.selectNextWinner(t,this.students,this.categories):null}get liveSession(){for(let t=this.sessions.length-1;t>=0;t--)if(!this.sessions[t].isFinished)return this.sessions[t];return null}endLiveSession(){const t=this.liveSession;return t?(t.end(),!0):!1}calculateFinalStudentScore(t){const n=t.logs.scores,o=["reading","writing"];for(const u of o)if(!n[u]||n[u].length===0)return null;const a=n.listening&&n.listening.length>0,s=n.speaking&&n.speaking.length>0;if(!a&&!s)return null;const i=u=>n[u].reduce((b,k)=>b+k.value,0)/n[u].length;let l;a&&s?l=(i("listening")+i("speaking"))/2:a?l=i("listening"):l=i("speaking");const c=i("reading"),m=i("writing"),I=(l*3+c*2+m*1)/6;return Math.trunc(I*10)/10}assignAllFinalScores(){let t=0,n=[];console.log("شروع عملیات محاسبه نمره نهایی برای تمام دانش‌آموزان..."),this.students.forEach(a=>{const s=this.calculateFinalStudentScore(a);s!==null?(a.finalClassActivityScore=s,t++):(a.finalClassActivityScore=null,n.push(a.identity.name))});const o=n.length;console.log(`عملیات پایان یافت. تعداد نمرات موفق: ${t} | تعداد ناموفق (نمرات ناقص): ${o}`),o>0&&(console.log("اسامی دانش‌آموزانی که نمراتشان ناقص است:"),n.forEach(a=>console.log(`- ${a}`)))}}class we{constructor(t,n="",o=!1){this.id=`cat_${new Date().getTime()}_${Math.random()}`,this.name=t,this.description=n,this.isDeleted=!1,this.isGradedCategory=o,this.isDeleted=!1}}let L={},d=null,Sn=null,h=null,D=null,ut=null,Qt=null,Ln=[],Rt=null,wn=null,le=null,At=0,kn=0,Wt=0,Nn=0,Bn=null,xn=null,_t=null,Te=null,pe=-1,Pt=null,Ft=null,Ut=null,ss=null,os=null,Ee=!1,O=[],be=[],We=[],he={isScreenSaverEnabled:!0,lastRestoreTimestamp:null};function w(){if(Ee)return;const e={classrooms:L,trashBin:O,userSettings:he};localStorage.setItem("teacherAssistantData_v2",JSON.stringify(e))}function as(e=[]){const t={};if(e.length>0)e.forEach(i=>{L[i]&&(t[i]=L[i])});else for(const i in L)L[i].isDeleted||(t[i]=L[i]);const n={metadata:{version:"2.0",createdAt:new Date().toISOString()},data:{classrooms:t,trashBin:O}},o=JSON.stringify(n,null,2),s=`SP-Backup-${new Date().toLocaleDateString("fa-IR-u-nu-latn").replace(/\//g,"-")}.txt`;return new File([o],s,{type:"text/plain"})}function qt(){const e=localStorage.getItem("teacherAssistantData_v2");if(!e)return;const t=JSON.parse(e);t.classrooms?(_e(t.classrooms),O=t.trashBin||[],he={...he,...t.userSettings}):(_e(t),Co())}function Co(){const e=[];Object.values(L).forEach(t=>{t.isDeleted?e.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:t.info.creationDate,type:"classroom",description:`کلاس «${t.info.name}»`,restoreData:{name:t.info.name}}):t.students.forEach(n=>{n.isDeleted&&e.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:n.identity.studentId.split("_")[1],type:"student",description:`دانش‌آموز «${n.identity.name}»`,restoreData:{studentId:n.identity.studentId,classroomName:t.info.name}})})}),O.length===0&&e.length>0&&(O=e,console.log(`Migrated ${e.length} previously deleted item(s) to the new trash bin.`),w())}function _e(e){L={};for(const t in e){const n=e[t];let o;n.info?o=n.info:o={...n,name:t};const a=new an(o);a.isDeleted=n.isDeleted,a.note=n.note||"",a.students=(n.students||[]).map(s=>{const i=new wt(s.identity);return i.isDeleted=s.isDeleted,i.statusCounters=s.statusCounters,i.logs=s.logs,i.logs.scores||(i.logs.scores={}),i.profile=s.profile,i.finalClassActivityScore=s.finalClassActivityScore,i.categoryCounts=s.categoryCounts||{},i.categoryIssues=s.categoryIssues||{},i.onboardingSession=s.onboardingSession||null,i}),a.sessions=(n.sessions||[]).map(s=>{const i=new ns(s.sessionNumber);i.isDeleted=s.isDeleted,i.note=s.note||"",i.startTime=new Date(s.startTime),i.endTime=s.endTime?new Date(s.endTime):null,i.isFinished=s.isFinished,i.isMakeup=s.isMakeup,i.isCancelled=s.isCancelled||!1,i.studentRecords=s.studentRecords;for(const c in i.studentRecords){const m=i.studentRecords[c];m.homework&&!(m.homework instanceof on)&&(i.studentRecords[c].homework=new on(m.homework.status,m.homework.comment))}i.lastWinnerByCategory=s.lastWinnerByCategory,i.lastUsedCategoryId=s.lastUsedCategoryId,i.lastSelectedWinnerId=s.lastSelectedWinnerId;const l=s.winnerHistory||[];return i.winnerHistory=l.filter(c=>c&&c.winner).map(c=>({winner:a.students.find(p=>p.identity.studentId===c.winner.identity.studentId),categoryName:c.categoryName})).filter(c=>c.winner),i}),a.categories=(n.categories||[]).map(s=>{const i=new we(s.name,s.description,s.isGradedCategory);return i.id=s.id,i.isDeleted=s.isDeleted,i}),a.futurePlans=n.futurePlans,L[t]=a}}function is(e,t){if(t){const n=e.data.classrooms;for(let o in n){let a=o;const s=n[o];for(;L[a];)a=`${a} (Restored)`;a!==o&&(s.info.name=a),L[a]=s}if(e.data.trashBin){const o=[...O,...e.data.trashBin],a=[...new Map(o.map(s=>[s.id,s])).values()];zt(a)}_e(L)}else _e(e.data.classrooms),zt(e.data.trashBin||[]);at({lastRestoreTimestamp:new Date().toISOString()}),w()}function cs(e,t){if(L[t])return{success:!1,message:"کلاسی با این نام از قبل وجود دارد."};const n=L[e];return n?(n.info.name=t,L[t]=n,delete L[e],d===n&&X(n),{success:!0}):{success:!1,message:"کلاس مورد نظر یافت نشد."}}function ls(e,t,n){const o=n.trim();if(!o)return{success:!1,message:"نام دسته‌بندی نمی‌تواند خالی باشد."};if(e.categories.some(c=>c.id!==t.id&&!c.isDeleted&&c.name.toLowerCase()===o.toLowerCase()))return{success:!1,message:"دسته‌بندی دیگری با این نام وجود دارد."};const s=t.name,i=s.toLowerCase(),l=o.toLowerCase();return t.name=o,e.students.forEach(c=>{c.categoryCounts&&c.categoryCounts[s]!==void 0&&(c.categoryCounts[o]=c.categoryCounts[s],delete c.categoryCounts[s]),c.categoryIssues&&c.categoryIssues[s]!==void 0&&(c.categoryIssues[o]=c.categoryIssues[s],delete c.categoryIssues[s]),c.logs.scores&&c.logs.scores[i]&&(c.logs.scores[i].forEach(m=>m.skill=o),i!==l&&(c.logs.scores[l]=c.logs.scores[i],delete c.logs.scores[i]))}),e.sessions.forEach(c=>{c.lastWinnerByCategory&&c.lastWinnerByCategory[s]&&(c.lastWinnerByCategory[o]=c.lastWinnerByCategory[s],delete c.lastWinnerByCategory[s]),c.winnerHistory&&c.winnerHistory.forEach(m=>{m.categoryName===s&&(m.categoryName=o)})}),{success:!0}}function rs(e,t,n){if(U(n.students).some(i=>i.identity.name.toLowerCase()===e.identity.name.toLowerCase()))return{success:!1,message:`دانش‌آموزی با نام «${e.identity.name}» از قبل در کلاس «${n.info.name}» وجود دارد.`};const a=JSON.parse(JSON.stringify(e));n.addStudent(a);const s=t.students.find(i=>i.identity.studentId===e.identity.studentId);return s&&mt(s,t),{success:!0}}function ds(){for(const e in L){const t=L[e];t.students.forEach(n=>{n.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0},n.categoryCounts={},n.categoryIssues={},t.sessions.forEach(o=>{const a=n.identity.studentId;o.studentRecords[a]&&(o.studentRecords[a].attendance="present")})})}w()}function U(e){return Array.isArray(e)?e.filter(t=>!t.isDeleted):[]}function ye(e){const t=new Map;return e&&U(e.sessions).filter(o=>!o.isCancelled).sort((o,a)=>o.sessionNumber-a.sessionNumber).forEach((o,a)=>{t.set(o.sessionNumber,a+1)}),t}function De(e){pe=e}function Ce(e){Pt=e}function mt(e,t){if(!e||!t)return;const n=e.identity.studentId,o=t.students.findIndex(a=>a.identity.studentId===n);o>-1&&t.students.splice(o,1),t.sessions.forEach(a=>{a.studentRecords[n]&&delete a.studentRecords[n];for(const s in a.lastWinnerByCategory)a.lastWinnerByCategory[s]===n&&delete a.lastWinnerByCategory[s];a.lastSelectedWinnerId===n&&(a.lastSelectedWinnerId=null),a.winnerHistory=a.winnerHistory.filter(s=>s.winner&&s.winner.identity.studentId!==n)})}function us(e,t){const n=L[e];if(!n)return;const o=n.sessions.findIndex(a=>a.sessionNumber===t);o>-1&&(n.students.forEach(a=>{a.profile.notes&&a.profile.notes.length>0&&(a.profile.notes=a.profile.notes.filter(s=>!s.source||s.source.type!=="fromAttendance"||s.source.sessionNumber!==t)),a.onboardingSession===t&&(a.onboardingSession=null)}),n.sessions.splice(o,1))}function ms(e,t){const n=L[e];if(!n)return;const o=n.categories.findIndex(l=>l.id===t);if(o===-1)return;const s=n.categories[o].name,i=s.toLowerCase();n.students.forEach(l=>{l.categoryCounts&&delete l.categoryCounts[s],l.categoryIssues&&delete l.categoryIssues[s],l.logs.scores&&delete l.logs.scores[i]}),n.sessions.forEach(l=>{l.lastWinnerByCategory[s]&&delete l.lastWinnerByCategory[s],l.winnerHistory=l.winnerHistory.filter(c=>c.categoryName!==s)}),n.categories.splice(o,1)}function fs(e,t,n,o){const a=L[e];if(!a)return;const s=a.students.find(c=>c.identity.studentId===t);if(!s||!s.logs.scores[n.toLowerCase()])return;const i=s.logs.scores[n.toLowerCase()],l=i.findIndex(c=>c.id===o);l>-1&&i.splice(l,1)}function ps(e,t,n){const o=L[e];if(!o)return;const a=o.students.find(i=>i.identity.studentId===t);if(!a||!a.profile.notes)return;const s=a.profile.notes.findIndex(i=>i.id===n);s>-1&&a.profile.notes.splice(s,1)}function gs(){JSON.parse(JSON.stringify({classrooms:L,trashBin:O})),Ee=!0}function hs(){Ee=!1,qt()}function X(e){d=e}function ft(e){Sn=e}function ce(e){h=e}function re(e){D=e}function Vt(e){ut=e}function ys(e){Qt=e}function nt(e){Ln=e}function kt(e){Rt=e}function Cs(e){wn=e}function Gt(e){le=e}function Nt(e){At=e}function vs(e){kn=e}function Bt(e){Wt=e}function bs(e){Nn=e}function Tn(e){Bn=e}function Dn(e){xn=e}function pt(e){_t=e}function Mn(e){Te=e}function jt(e){Ut=e}function Es(e){ss=e}function Is(e){os=e}function zt(e){O=e}function Yt(e){Ft=e}function Jt(e){We=e}function at(e){he={...he,...e},w()}function cn(e){be=e}const vo=Object.freeze(Object.defineProperty({__proto__:null,get activeModal(){return Te},get cancelCallback(){return xn},get classrooms(){return L},get confirmCallback(){return Bn},get currentClassroom(){return d},get easterEggClickCount(){return At},get easterEggLastClickTime(){return kn},enterDemoMode:gs,exitDemoMode:hs,getActiveItems:U,getSessionDisplayMap:ye,get importedFileContent(){return Rt},get isDemoMode(){return Ee},get liveSession(){return Sn},loadData:qt,get manualSelection(){return Ut},moveStudent:rs,get namesToImport(){return Ln},get notificationTimeout(){return wn},permanentlyDeleteCategory:ms,permanentlyDeleteNote:ps,permanentlyDeleteScore:fs,permanentlyDeleteSession:us,permanentlyDeleteStudent:mt,prepareBackupData:as,get previousState(){return ut},processRestore:is,rehydrateData:_e,renameCategory:ls,renameClassroom:cs,resetAllStudentCounters:ds,get resetEasterEggClickCount(){return Wt},get resetEasterEggLastClickTime(){return Nn},get saveCategoryCallback(){return Ft},saveData:w,get saveNoteCallback(){return Pt},get secureConfirmCallback(){return _t},get selectedCategory(){return le},get selectedClassIds(){return be},get selectedSession(){return h},get selectedStudentForProfile(){return D},get selectedStudentsForMassComment(){return We},setActiveModal:Mn,setCancelCallback:Dn,setConfirmCallback:Tn,setCurrentClassroom:X,setEasterEggClickCount:Nt,setEasterEggLastClickTime:vs,setImportedFileContent:kt,setLiveSession:ft,setManualSelection:jt,setNamesToImport:nt,setNotificationTimeout:Cs,setPreviousState:Vt,setResetEasterEggClickCount:Bt,setResetEasterEggLastClickTime:bs,setSaveCategoryCallback:Yt,setSaveNoteCallback:Ce,setSecureConfirmCallback:pt,setSelectedCategory:Gt,setSelectedClassIds:cn,setSelectedSession:ce,setSelectedStudentForProfile:re,setSelectedStudentsForMassComment:Jt,setSourceClassForMove:Is,setStudentToMove:Es,setTrashBin:zt,setUndoTimeout:ys,setUserSettings:at,setWinnerHistoryIndex:De,get sourceClassForMove(){return os},get studentToMove(){return ss},get trashBin(){return O},get undoTimeout(){return Qt},get userSettings(){return he},get winnerHistoryIndex(){return pe}},Symbol.toStringTag,{value:"Module"}));function Se(e){return typeof e!="string"?"":e.replace(/ي/g,"ی").replace(/ك/g,"ک").replace(/[\s\u200c]/g,"")}function $n(e){return typeof e!="string"||e.length===0?"ltr":/[\u0590-\u07FF]/.test(e)?"rtl":"ltr"}function Ss(e){return!e||!e.trim()?"":e.split(`
`).map(o=>`<div dir="${$n(o)}">${o||"&nbsp;"}</div>`).join("")}function sn(e){if(typeof e!="string")return"";const t={q:"ض",w:"ص",e:"ث",r:"ق",t:"ف",y:"غ",u:"ع",i:"ه",o:"خ",p:"ح","[":"ج","]":"چ",a:"ش",s:"س",d:"ی",f:"ب",g:"ل",h:"ا",j:"ت",k:"ن",l:"م",";":"ک","'":"گ",z:"ظ",x:"ط",c:"ز",v:"ر",b:"ذ",n:"د",m:"پ",",":"و"};let n="";for(let o=0;o<e.length;o++){const a=e[o].toLowerCase();n+=t[a]||e[o]}return n}const Ls="teacherAssistantLogs_v2",bo=100;function On(){try{const e=localStorage.getItem(Ls);return e?JSON.parse(e):{}}catch(e){return console.error("Error reading logs from localStorage:",e),{}}}function ws(e){try{localStorage.setItem(Ls,JSON.stringify(e))}catch(t){console.error("Error saving logs to localStorage:",t)}}function _(e,t,n=null){if(!e)return;const o=On();o[e]||(o[e]=[]);const a={timestamp:new Date().toISOString(),message:t,action:n,classroomName:e};o[e].unshift(a),o[e].length>bo&&o[e].pop(),ws(o)}function Eo(e){return On()[e]||[]}function Io(e,t){const n=On();n[e]&&!n[t]&&(n[t]=n[e],delete n[e],ws(n))}const ks=document.getElementById("class-management-page"),So=document.getElementById("new-class-name"),Lo=document.getElementById("add-class-btn"),ze=document.getElementById("class-list"),Kt=document.getElementById("undo-toast"),Ns=document.getElementById("undo-message"),wo=document.getElementById("undo-btn"),ko=document.getElementById("settings-page"),Hn=document.getElementById("settings-class-name-header"),ln=document.getElementById("settings-student-list"),rn=document.getElementById("category-list"),No=document.getElementById("back-to-sessions-btn"),Bo=document.getElementById("new-student-name"),xo=document.getElementById("add-student-btn"),Bs=document.getElementById("paste-area"),To=document.getElementById("process-paste-btn"),Do=document.getElementById("csv-preview-page"),dn=document.getElementById("csv-preview-list"),Mo=document.getElementById("csv-confirm-btn"),$o=document.getElementById("csv-cancel-btn"),Oo=document.getElementById("import-csv-btn"),Ho=document.getElementById("csv-file-input"),Ro=document.getElementById("column-mapping-page"),un=document.getElementById("column-select-dropdown"),Ao=document.getElementById("confirm-column-btn"),Wo=document.getElementById("cancel-import-btn"),_o=document.getElementById("new-category-name"),Po=document.getElementById("add-category-btn"),mn=document.querySelector(".app-header"),ke=document.getElementById("select-student-btn"),Ke=document.getElementById("select-student-btn-wrapper"),Fo=document.getElementById("attendance-page"),it=document.getElementById("attendance-list"),Uo=document.getElementById("finish-attendance-btn"),qo=document.querySelector("#class-management-page h2"),fn=document.getElementById("student-stats-header"),Vo=document.getElementById("hamburger-menu-btn"),Go=document.getElementById("side-nav-menu"),jo=document.getElementById("close-nav-btn"),zo=document.getElementById("overlay"),Jo=document.getElementById("backup-data-btn"),Ko=document.getElementById("restore-data-btn"),xs=document.getElementById("restore-file-input"),Qo=document.getElementById("custom-confirm-modal"),Ts=document.getElementById("confirm-modal-message"),pn=document.getElementById("confirm-modal-cancel-btn"),st=document.getElementById("confirm-modal-confirm-btn"),Yo=document.getElementById("secure-confirm-modal"),Ds=document.getElementById("secure-confirm-message"),Ms=document.getElementById("secure-confirm-code"),Ve=document.getElementById("secure-confirm-input"),Xo=document.getElementById("secure-confirm-cancel-btn"),xt=document.getElementById("secure-confirm-confirm-btn"),Zo=document.getElementById("add-note-modal"),H=document.getElementById("new-note-content"),ea=document.getElementById("class-save-note-btn"),ta=document.getElementById("cancel-note-btn"),gn=document.getElementById("student-search-input"),xe=document.getElementById("student-search-results"),na=document.getElementById("back-to-student-page-btn"),sa=document.getElementById("graded-category-pills-container"),oa=document.getElementById("new-score-value"),$s=document.getElementById("new-score-comment"),aa=document.getElementById("add-score-btn"),ia=document.getElementById("profile-stats-summary"),ca=document.getElementById("profile-scores-list"),Tt=document.getElementById("global-student-search-input"),Le=document.getElementById("global-student-search-results"),la=document.getElementById("is-graded-checkbox"),ra=document.getElementById("trashed-classes-list"),da=document.getElementById("trashed-students-list"),ua=document.getElementById("trashed-sessions-list"),ma=document.getElementById("trashed-categories-list"),fa=document.getElementById("trashed-notes-list"),pa=document.getElementById("trashed-scores-list"),je=document.getElementById("quick-grade-form-wrapper"),Ie=document.getElementById("quick-score-input"),ge=document.getElementById("quick-note-textarea"),Re=document.getElementById("quick-grade-submit-btn"),ct=document.getElementById("category-selection-container"),hn=document.getElementById("selected-student-result"),Ae=document.getElementById("custom-context-menu"),Ge=document.getElementById("breadcrumb-container");let tt=null,Je=null;const ga=document.getElementById("category-modal"),Os=document.getElementById("category-modal-title"),lt=document.getElementById("new-category-modal-name"),Rn=document.getElementById("new-category-modal-is-graded"),ha=document.getElementById("category-modal-cancel-btn"),Hs=document.getElementById("category-modal-save-btn"),ya=document.getElementById("mass-comment-modal"),Ca=document.getElementById("mass-comment-modal-title"),Rs=document.getElementById("mass-comment-student-count-message"),rt=document.getElementById("mass-comment-content"),An=document.getElementById("mass-comment-append-checkbox"),va=document.getElementById("mass-comment-cancel-btn"),ba=document.getElementById("mass-comment-save-btn"),yn=document.getElementById("mass-comment-btn"),Dt=document.getElementById("attendance-mass-actions-container"),Oe=document.createElement("input"),Ea=document.getElementById("session-dashboard-page"),Qe=document.getElementById("attendance-pane");function gt(e="selector"){if(!d||!h){T("class-management-page");return}ka(),$t(),ne(),Ye(),T("session-dashboard-page",{tab:e}),As(),Wn(e),Na()}function Wn(e){const t=document.getElementById("selector-tab-btn"),n=document.getElementById("attendance-tab-btn"),o=document.getElementById("selector-pane"),a=e==="selector";t.classList.toggle("active",a),n.classList.toggle("active",!a),o.classList.toggle("active",a),Qe.classList.toggle("active",!a)}function As(){const e=document.getElementById("selector-tab-btn"),t=document.getElementById("attendance-tab-btn"),n=document.getElementById("selector-pane");e.addEventListener("click",()=>{e.classList.add("active"),t.classList.remove("active"),n.classList.add("active"),Qe.classList.remove("active"),T("session-dashboard-page",{tab:"selector"})}),t.addEventListener("click",()=>{t.classList.add("active"),e.classList.remove("active"),Qe.classList.add("active"),n.classList.remove("active"),T("session-dashboard-page",{tab:"attendance"})})}function Ia(e){clearTimeout(Qt),ut||Vt(JSON.stringify(L)),Ns.textContent=e,Kt.classList.add("show"),ys(setTimeout(()=>{Kt.classList.remove("show"),Vt(null)},5e3))}function Ws(){if(ut){const e=d?d.info.name:null,t=JSON.parse(ut);_e(t),e&&L[e]?X(L[e]):X(null),d?(Ne(),Xe(),se()):ae(),Kt.classList.remove("show"),clearTimeout(Qt),Vt(null)}}function C(e,t=3e3){const n=document.getElementById("notification-toast");n&&(n.textContent=e,n.classList.add("show"),clearTimeout(wn),Cs(setTimeout(()=>{n.classList.remove("show")},t)))}function _s(e){const t=document.getElementById("restore-confirm-modal"),n=document.getElementById("restore-modal-message"),o=document.getElementById("restore-append-checkbox"),a=document.getElementById("restore-confirm-cancel-btn"),s=document.getElementById("restore-confirm-confirm-btn"),i=document.getElementById("restore-modal-warning");i.style.display="none";const l=e.metadata.createdAt;if(he.lastRestoreTimestamp&&l<he.lastRestoreTimestamp){const u=new Date(l).toLocaleDateString("fa-IR"),v=new Date(he.lastRestoreTimestamp).toLocaleDateString("fa-IR");i.textContent=`⚠️ هشدار: این فایل پشتیبان (${u}) قدیمی‌تر از آخرین بازیابی شما (${v}) است.`,i.style.display="block"}const c=Object.keys(e.data.classrooms).length,m="کلاس";n.textContent=`فایل پشتیبان شما حاوی ${c} ${m} است. لطفاً نحوه بازیابی را مشخص کنید.`,o.checked=!0;const p=()=>{const u=o.checked;is(e,u),t.removeEventListener("click",p),P(),ae(),T("class-management-page"),C("✅ اطلاعات با موفقیت بازیابی شد.")},I=()=>{P()};s.onclick=p,a.onclick=I,K("restore-confirm-modal")}function G(e,t,n={}){const{confirmText:o="تایید",cancelText:a="لغو",confirmClass:s="btn-success",onCancel:i=()=>{},isDelete:l=!1}=n,c=l?()=>Ps(e,t):t;Ts.textContent=e,st.textContent=o,pn.textContent=a,st.className="modal-action-btn",st.classList.add(s),Tn(c),Dn(i);const m=st.parentElement;pn.style.display=i===null?"none":"inline-block",m.style.justifyContent=i===null?"center":"space-between",K("custom-confirm-modal")}function Ps(e,t){const n=Math.floor(1e4+Math.random()*9e4).toString();Ds.textContent=e,Ms.textContent=n,Ve.value="",xt.disabled=!0,pt(t),K("secure-confirm-modal"),Ve.focus();const o=()=>{Ve.value===n?xt.disabled=!1:xt.disabled=!0};return Ve.addEventListener("input",o),()=>{Ve.removeEventListener("input",o)}}function Cn(e,t={}){const{title:n="ایجاد دسته‌بندی جدید",initialName:o="",initialIsGraded:a=!1,saveButtonText:s="ذخیره"}=t;Os.textContent=n,lt.value=o,Rn.checked=a,Hs.textContent=s,Yt((i,l)=>{if(!i){C("⚠️ لطفاً نام دسته‌بندی را وارد کنید.");return}e(i,l),P()}),K("category-modal"),lt.focus(),o&&lt.select()}function Fs(e,t){const n=Object.values(L).filter(i=>!i.isDeleted&&i.info.name!==t.info.name),o=document.getElementById("move-student-modal-title"),a=document.getElementById("move-student-class-select"),s=document.getElementById("move-student-confirm-btn");o.textContent=`انتقال دانش‌آموز: ${e.identity.name}`,a.innerHTML="",n.length===0?(a.innerHTML='<option value="">کلاس دیگری برای انتقال وجود ندارد</option>',s.disabled=!0):(n.forEach(i=>{const l=document.createElement("option");l.value=i.info.name,l.textContent=i.info.name,a.appendChild(l)}),s.disabled=!1),Es(e),Is(t),K("move-student-modal")}function _n(e,t){if(!e||!t)return;const n=e.identity.name,o=document.getElementById("add-note-modal-title");o.textContent="تغییر نام دانش‌آموز",H.value=n,H.rows=1,H.dispatchEvent(new Event("input",{bubbles:!0})),Ce(a=>{const s=a.trim();s&&s!==n&&(U(t.students).some(l=>l.identity.studentId!==e.identity.studentId&&l.identity.name.toLowerCase()===s.toLowerCase())?C("دانش‌آموزی با این نام از قبل در این کلاس وجود دارد."):(e.identity.name=s,_(t.info.name,`نام دانش‌آموز «${n}» به «${s}» تغییر یافت.`,{type:"VIEW_STUDENT_PROFILE",studentId:e.identity.studentId}),w(),Ne(),ne(),D&&D.identity.studentId===e.identity.studentId&&Z(e),C(`✅نام دانش‌آموز به «${s}» تغییر یافت.`))),o.textContent="ثبت یادداشت جدید",H.rows=4}),K("add-note-modal"),H.focus(),H.select()}function K(e){const t=document.getElementById(e);if(t){if(Te)return;document.body.classList.add("modal-active"),t.classList.add("modal-visible"),Mn(e),history.pushState(null,"",location.href)}}function P(e,t=!1){if(!Te)return;const n=document.getElementById(Te),o=Te;Mn(null),o==="student-profile-modal"&&re(null),t||history.back(),n&&(n.classList.add("modal-closing"),setTimeout(()=>{n.classList.remove("modal-visible"),n.classList.remove("modal-closing"),document.body.classList.remove("modal-active"),o==="custom-confirm-modal"&&(Tn(null),Dn(null)),o==="secure-confirm-modal"&&pt(null),o==="category-modal"&&Yt(null),o==="mass-comment-modal"&&(rt.value=""),o==="add-note-modal"&&Ce(null),typeof e=="function"&&e()},300))}function Pn(){if(!Qe||!Qe.classList.contains("active")){Dt.style.display="none";return}const e=We.length;e<1?Dt.style.display="none":Dt.style.display="block",yn.disabled=e<1,yn.textContent=`📝 ثبت یادداشت گروهی (${e} نفر)`}function Us(){const e=We,t=e.length;let n=!1;t>0&&(n=e.some(a=>{var s;return(s=h.studentRecords[a])==null?void 0:s.homework.comment})),Rs.textContent=`یادداشت برای ${t} دانش‌آموز ثبت خواهد شد.`,rt.value="",rt.dispatchEvent(new Event("input",{bubbles:!0})),An.checked=!0;const o=document.querySelector("#mass-comment-modal .modal-options");o.style.display=n?"flex":"none",K("mass-comment-modal"),rt.focus()}function vn(e,t){if(!d||!h)return;let n=0;const o=We,a=h;o.forEach(s=>{const i=a.studentRecords[s];if(i&&i.homework){const l=i.homework.comment||"";let c=e;t&&l.length>0?c=l+`
---
`+e:c=e,i.homework.comment=c.trim();const m=d.students.find(p=>p.identity.studentId===s);m&&Sa(m,a,c.trim()),n++}}),Jt([]),w(),Ye(),_(d.info.name,`${n} دانش‌آموز به صورت گروهی یادداشت تکلیف گرفتند.`,{type:"VIEW_SESSIONS"}),C(`✅ یادداشت برای ${n} دانش‌آموز ثبت شد.`)}function Sa(e,t,n){const a=ye(d).get(t.sessionNumber),s={type:"fromAttendance",sessionNumber:t.sessionNumber},i=`یادداشت مربوط به جلسه ${a}: `,l=e.profile.notes.find(c=>!c.isDeleted&&c.source&&c.source.type==="fromAttendance"&&c.source.sessionNumber===s.sessionNumber);l?n?(l.content=i+n,l.isDeleted=!1):l.isDeleted=!0:n&&e.addNote(i+n,s)}function Fn(e){H.value=e.note||"",Ce(t=>{e.note=t,w(),_(e.info.name,"یادداشت کلاس ذخیره شد.",{type:"VIEW_CLASS_NOTE"}),ae(),C("✅ یادداشت کلاس ذخیره شد.")}),K("add-note-modal"),H.focus()}function Un(e){X(e),Hn.textContent=`تنظیمات کلاس: ${e.info.name}`,Ne(),Xe(),T("settings-page")}function qs(e){const t=document.getElementById("log-modal-title"),n=document.getElementById("log-list");t.textContent=`گزارش فعالیت‌های کلاس: ${e}`,n.innerHTML="";const o=Eo(e);o.length===0?n.innerHTML='<li class="no-content-message">هنوز فعالیتی برای این کلاس ثبت نشده است.</li>':o.forEach(a=>{const s=document.createElement("li");s.className="log-entry";const i=new Date(a.timestamp),l=`${i.toLocaleDateString("fa-IR")} - ${i.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}`,c=document.createElement("span");c.className="log-timestamp",c.textContent=l;const m=document.createElement("span");m.className="log-message",m.textContent=a.message,a.action&&(m.classList.add("log-action-link"),m.dataset.action=JSON.stringify({...a.action,classroomName:a.classroomName})),s.appendChild(c),s.appendChild(m),n.appendChild(s)}),K("log-modal")}document.getElementById("log-modal-close-btn").addEventListener("click",()=>{P()});function bn(e){const t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download=e.name,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t)}async function ht(e=[]){const t=as(e);if(("ontouchstart"in window||navigator.maxTouchPoints>0)&&navigator.share&&navigator.canShare&&navigator.canShare({files:[t]}))try{await navigator.share({title:"پشتیبان دستیار معلم",text:"فایل پشتیبان داده‌های برنامه",files:[t]})}catch(o){o.name!=="AbortError"&&(console.error("Error sharing file:",o),bn(t),C("⚠️اشتراک‌گذاری با خطا مواجه شد. فایل در حال دانلود است."))}else bn(t),C("✅پشتیبان‌گیری با موفقیت انجام شد.")}function Ct(e,t){e.preventDefault(),He(),Je=e.target.closest("li"),Je&&Je.classList.add("context-menu-target"),setTimeout(()=>{const n=Ae,o=n.querySelector("ul");o.innerHTML="",t.forEach(m=>{const p=document.createElement("li");m.isSeparator?p.className="separator":(p.innerHTML=`
                    <span class="icon">${m.icon||""}</span>
                    <span class="label">${m.label}</span>
                `,m.className&&p.classList.add(m.className),p.addEventListener("click",()=>{m.action(),He()})),o.appendChild(p)}),n.classList.add("visible");const{offsetWidth:a,offsetHeight:s}=n,{innerHeight:i}=window,l=document.body.getBoundingClientRect();n.style.top=`${(i-s)/2}px`;const c=l.left+l.width/2;n.style.left=`${c-a/2}px`},50)}function He(){Ae.classList.contains("visible")&&Ae.classList.remove("visible"),Je&&(Je.classList.remove("context-menu-target"),Je=null)}function Vs(){var t,n;Ge.innerHTML="";const e=[];if(e.push({label:"کلاس‌ها",handler:()=>{X(null),ce(null),re(null),T("class-management-page")}}),d){if(e.push({label:d.info.name,handler:()=>{ce(null),re(null),se(),T("session-page")}}),((t=document.querySelector(".page.active"))==null?void 0:t.id)==="settings-page")e.push({label:"تنظیمات"});else if(h){const s=ye(d).get(h.sessionNumber)||` (#${h.sessionNumber})`;e.push({label:`جلسه ${s}`,handler:()=>{re(null),T("student-page")}});const i=(n=document.querySelector(".page.active"))==null?void 0:n.id;D?e.push({label:`پروفایل: ${D.identity.name}`}):i==="attendance-page"&&e.push({label:"حضور و غیاب"})}}if(e.length<=1){Ge.style.display="none";return}Ge.style.display="flex",e.forEach((o,a)=>{const s=document.createElement("a");if(s.textContent=o.label,s.className="breadcrumb-item",a===e.length-1||!o.handler?s.classList.add("active"):s.addEventListener("click",o.handler),Ge.appendChild(s),a<e.length-1){const i=document.createElement("span");i.className="breadcrumb-separator",i.textContent="/",Ge.appendChild(i)}})}function ts(e,t,n){n.innerHTML="";const o=d.sessions.filter(a=>{var s;return!a.isDeleted&&!a.isCancelled&&((s=a.studentRecords[e.identity.studentId])==null?void 0:s.attendance)==="absent"}).map(a=>({number:t.get(a.sessionNumber),isMakeup:a.isMakeup})).filter(a=>a.number!==void 0);o.length>0?(n.appendChild(document.createTextNode("جلسات غایب: ")),o.forEach((a,s)=>{const i=document.createElement("span");i.textContent=a.number,a.isMakeup&&i.classList.add("makeup-absence"),n.appendChild(i),s<o.length-1&&n.appendChild(document.createTextNode("، "))})):n.textContent="جلسات غایب: بدون غیبت"}function Mt(e,t,n,o={}){const{includePrefix:a=!0}=o;n.innerHTML="";const s=d.sessions.filter(i=>{if(i.isDeleted||i.isCancelled)return!1;const l=i.studentRecords[e.identity.studentId];return l&&l.homework&&(l.homework.status==="incomplete"||l.homework.status==="none")}).map(i=>({number:t.get(i.sessionNumber),status:i.studentRecords[e.identity.studentId].homework.status})).filter(i=>i.number!==void 0);s.length>0?(a&&n.appendChild(document.createTextNode("تکالیف ناقص: ")),s.forEach((i,l)=>{const c=document.createElement("span");c.textContent=i.number,i.status==="incomplete"&&c.classList.add("incomplete-homework"),n.appendChild(c),l<s.length-1&&n.appendChild(document.createTextNode("،"))})):a?n.textContent="تکالیف ناقص: ندارد":n.textContent="ندارد"}function La(e,t){var J,j,Q;const n=document.createElement("li");n.className="attendance-list-item";const o=document.createElement("input");o.type="checkbox",o.className="mass-comment-checkbox",o.checked=We.includes(e.identity.studentId),o.addEventListener("change",()=>{const $=e.identity.studentId,N=We;if(o.checked)N.includes($)||N.push($);else{const R=N.indexOf($);R>-1&&N.splice(R,1)}Pn()}),n.appendChild(o);const a={none:"بدون تکلیف",complete:"تکلیف کامل",incomplete:"تکلیف ناقص"},s=document.createElement("div");s.className="student-info";const i=document.createElement("span");i.className="student-name",i.textContent=e.identity.name,i.addEventListener("click",()=>{Z(e)});const l=document.createElement("span");l.className="absence-info";const c=document.createElement("span");c.className="homework-info",ts(e,t,l),Mt(e,t,c),s.appendChild(i),s.appendChild(l),s.appendChild(c);const m=document.createElement("div");m.className="homework-controls";const p=document.createElement("button"),I=((J=h.studentRecords[e.identity.studentId])==null?void 0:J.homework.status)||"none";p.className=`homework-status-btn ${I}`,p.title=a[I],p.addEventListener("click",()=>{const $=h.studentRecords[e.identity.studentId].homework,R={none:"incomplete",incomplete:"complete",complete:"none"}[$.status];p.title=a[R],h.setHomeworkStatus(e.identity.studentId,R),w(),p.className=`homework-status-btn ${R}`,Mt(e,t,c)});const u=document.createElement("button");u.className="btn-icon",u.innerHTML="📝",u.title="افزودن یادداشت برای تکلیف",((j=h.studentRecords[e.identity.studentId])==null?void 0:j.homework.comment)||(u.style.opacity="0.3"),u.addEventListener("click",()=>{const $=h.studentRecords[e.identity.studentId].homework;H.value=$.comment||"",H.dispatchEvent(new Event("input",{bubbles:!0})),Ce(N=>{$.comment=N;const R=ye(d),ie=R.get(h.sessionNumber),de={type:"fromAttendance",sessionNumber:h.sessionNumber},z=`یادداشت مربوط به جلسه ${ie}: `,ue=e.profile.notes.find(ee=>!ee.isDeleted&&ee.source&&ee.source.type==="fromAttendance"&&ee.source.sessionNumber===de.sessionNumber);ue?N?ue.content=z+N:ue.isDeleted=!0:N&&e.addNote(z+N,de),w(),_(d.info.name,`یادداشت تکلیف جلسه ${ie} برای دانش‌آموز «${e.identity.name}» ذخیره شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:e.identity.studentId}),C("✅یادداشت تکلیف ذخیره شد."),u.style.opacity=N?"1":"0.3",Mt(e,R,c)}),K("add-note-modal"),H.focus()}),m.appendChild(p),m.appendChild(u);const b=document.createElement("button"),k=((Q=h.studentRecords[e.identity.studentId])==null?void 0:Q.attendance)||"present",M=$=>{$==="present"?(b.textContent="حاضر",b.className="attendance-status-btn present active"):(b.textContent="غایب",b.className="attendance-status-btn absent active")};return M(k),b.addEventListener("click",()=>{var R;const N=(((R=h.studentRecords[e.identity.studentId])==null?void 0:R.attendance)||"present")==="present"?"absent":"present";h.setAttendance(e.identity.studentId,N),N==="absent"&&(h.studentRecords[e.identity.studentId].hadIssue=!1),w(),M(N),ts(e,t,l),Qs()}),n.appendChild(s),n.appendChild(m),n.appendChild(b),n}function wa(){return ye(d).get(h.sessionNumber)}function Ye(){if(!d||!h)return;U(d.students).forEach(a=>{h.initializeStudentRecord(a.identity.studentId)}),Jt([]);const e=ye(d);Ra(),it.innerHTML="";const t=document.createElement("li");t.className="attendance-list-header",Oe.id="attendance-search-input",Oe.type="text",Oe.className="inline-search-input",Oe.placeholder="جستجو...",Oe.value="";const n=document.createElement("div");n.className="student-search-container",n.appendChild(Oe);const o=document.createElement("div");o.className="header-labels-container",o.innerHTML=`
    <span class="header-label">تکلیف</span>
    <span class="header-label">حضور</span>
`,t.appendChild(n),t.appendChild(o),it.appendChild(t),U(d.students).forEach(a=>{const s=La(a,e);it.appendChild(s)}),Jt([]),Pn(),Aa(),Qs()}function ne(){const e=document.getElementById("student-stats-table-container");if(!e||(e.innerHTML="",!d))return;U(d.students).length,fn.textContent="آمار عملکرد";const t=["نام"],n=["کل انتخاب ها","غیبت","خروج","فرصت ازدست‌رفته","مشکل","میانگین","نمره کلاسی (کانون)"],o=d.categories.filter(v=>v.isGradedCategory&&!v.isDeleted).map(v=>v.name),a=[...t,...o,...n],s=document.createElement("table");s.className="student-stats-table";const l=s.createTHead().insertRow();a.forEach((v,b)=>{const k=document.createElement("th");b===0?(k.innerHTML=`${v} <span style="opacity: 0.6;">🔗</span>`,k.title="ردیف‌های این ستون قابل کلیک هستند"):k.textContent=v,l.appendChild(k)});const c=s.createTBody(),m=U(d.students),p=v=>{let b=0;return d.sessions.forEach(k=>{if(k.isDeleted||k.isCancelled)return;const M=k.studentRecords[v.identity.studentId];M&&M.attendance==="absent"&&b++}),b};m.forEach(v=>{const b=c.insertRow();if(b.dataset.studentId=v.identity.studentId,h){const $=h.studentRecords[v.identity.studentId];$&&$.attendance==="absent"&&b.classList.add("absent-row-highlight")}const k=b.insertCell(),M=document.createElement("span");M.textContent=v.identity.name,M.className="student-name-link",M.addEventListener("click",()=>{Z(v)}),k.appendChild(M),o.forEach($=>{var de;const N=b.insertCell(),R=$.toLowerCase(),ie=((de=v.logs.scores[R])==null?void 0:de.filter(z=>!z.isDeleted))||[];ie.length>0?ie.forEach((z,ue)=>{const ee=document.createElement("span");ee.textContent=z.value,ee.style.position="relative",z.comment&&(ee.dataset.tooltip=z.comment),N.appendChild(ee),ue<ie.length-1&&N.appendChild(document.createTextNode(","))}):N.textContent="",N.style.cursor="pointer",N.addEventListener("click",()=>{fe(v,$);const z=document.getElementById("category-selection-container");z&&z.scrollIntoView({behavior:"smooth",block:"center"})})}),b.insertCell().textContent=v.statusCounters.totalSelections||0,b.insertCell().textContent=p(v),b.insertCell().textContent=v.statusCounters.outOfClassCount||0,b.insertCell().textContent=v.statusCounters.missedChances||0;const J=Object.values(v.categoryIssues||{}).reduce(($,N)=>$+N,0);b.insertCell().textContent=J;const j=v.getOverallAverageScore();b.insertCell().textContent=j!==null?j:"-";const Q=d.calculateFinalStudentScore(v);b.insertCell().textContent=Q!==null?Q:"-"}),U(d.students),fn.setAttribute("data-student-count",m.length),e.appendChild(s);const I=e.querySelector(".student-stats-table"),u=I==null?void 0:I.querySelector("thead th:first-child");u&&u.addEventListener("click",()=>{I.classList.toggle("name-column-expanded")})}function fe(e=null,t=null){const n=document.getElementById("selected-student-result");n.innerHTML="",n.classList.remove("absent");let o,a;if(e&&t)o=e,a=t,jt({student:e,categoryName:t}),De(-1);else{if(jt(null),!h||pe<0||!h.winnerHistory[pe])return;const A=h.winnerHistory[pe];o=A.winner,a=A.categoryName}const s=document.querySelector(".current-winner-highlight");if(s&&s.classList.remove("current-winner-highlight"),o){const A=document.querySelector(`.student-stats-table tr[data-student-id="${o.identity.studentId}"]`);A&&A.classList.add("current-winner-highlight")}const i=d.categories.find(A=>A.name===a);if(i){Gt(i);const A=document.querySelectorAll("#category-selection-container .pill");A.forEach(oe=>oe.classList.remove("active"));const V=Array.from(A).find(oe=>oe.textContent===a);V&&V.classList.add("active"),En(i)}const l=h.studentRecords[o.identity.studentId],c=(l==null?void 0:l.attendance)==="absent",m=document.createElement("div");m.className="winner-name-container";const p=document.createElement("button");p.className="btn-icon",p.innerHTML="˅",p.title="برنده قبلی";const I=!e;p.classList.toggle("is-disabled",!I||pe<=0),p.addEventListener("click",()=>{p.classList.contains("is-disabled")?(p.classList.add("shake-animation"),setTimeout(()=>p.classList.remove("shake-animation"),200)):(De(pe-1),fe())});const u=document.createElement("div");u.className="winner-name",u.innerHTML=`✨ <strong>${o.identity.name}</strong>✨`,u.classList.add("heartbeat-animation"),c&&(u.style.textDecoration="line-through",u.style.opacity="0.6",u.style.color="var(--color-secondary)"),(l==null?void 0:l.hadIssue)&&!c&&(u.style.color="var(--color-warning)",u.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"),(l==null?void 0:l.wasOutOfClass)&&!c&&(u.style.color="var(--color-strong-warning)",u.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود");const k=1e3,M=A=>{A.preventDefault(),tt=setTimeout(()=>{Pa(o,a),tt=null},k)},J=()=>{tt&&(clearTimeout(tt),tt=null)};u.addEventListener("mousedown",M),u.addEventListener("mouseup",J),u.addEventListener("mouseout",J),u.addEventListener("touchstart",M),u.addEventListener("touchend",J),u.addEventListener("touchcancel",J);const j=document.createElement("button");if(j.className="btn-icon",j.innerHTML="˄",j.title="برنده بعدی",j.classList.toggle("is-disabled",!I||pe>=h.winnerHistory.length-1),j.addEventListener("click",()=>{j.classList.contains("is-disabled")?(j.classList.add("shake-animation"),setTimeout(()=>j.classList.remove("shake-animation"),200)):(De(pe+1),fe())}),m.appendChild(j),m.appendChild(u),o.onboardingSession===h.sessionNumber){const A=document.createElement("div");A.className="new-student-badge",A.textContent="دانش آموز جدید",m.appendChild(A)}m.appendChild(p),n.appendChild(m),ke.disabled=I&&!j.classList.contains("is-disabled");const Q=document.createElement("div");Q.className="status-button-container";const $=document.createElement("button");$.textContent="غایب",$.classList.add("status-button","absent-btn"),c&&$.classList.add("active");const N=document.createElement("button");N.textContent="مشکل",N.classList.add("status-button","issue-btn"),l!=null&&l.hadIssue&&N.classList.add("active");const R=document.createElement("button");R.textContent="خروج",R.classList.add("status-button","exit-btn"),l!=null&&l.wasOutOfClass&&R.classList.add("active");const ie=document.createElement("button");ie.textContent="پروفایل",ie.className="status-button profile-btn",h.isFinished?$.disabled=!0:$.addEventListener("click",()=>{const A=$.classList.contains("active");R.classList.contains("active")&&(R.classList.remove("active"),l.wasOutOfClass=!1,o.statusCounters.outOfClassCount=Math.max(0,(o.statusCounters.outOfClassCount||0)-1),o.statusCounters.missedChances=Math.max(0,o.statusCounters.missedChances-1)),A?($.classList.remove("active"),h.setAttendance(o.identity.studentId,"present"),o.statusCounters.missedChances=Math.max(0,o.statusCounters.missedChances-1),u.style.textDecoration="",u.style.opacity="",u.style.color=""):(N.classList.contains("active")&&(N.classList.remove("active"),l.hadIssue=!1,o.statusCounters.otherIssues=Math.max(0,o.statusCounters.otherIssues-1),o.statusCounters.missedChances=Math.max(0,o.statusCounters.missedChances-1)),$.classList.add("active"),h.setAttendance(o.identity.studentId,"absent"),o.statusCounters.missedChances++,u.style.textDecoration="line-through",u.style.opacity="0.6",u.style.color="var(--color-secondary)",u.title=""),ne(),w()}),h.isFinished?N.disabled=!0:N.addEventListener("click",()=>{const A=N.classList.contains("active");if(R.classList.contains("active")&&(R.classList.remove("active"),l.wasOutOfClass=!1,o.statusCounters.outOfClassCount=Math.max(0,(o.statusCounters.outOfClassCount||0)-1),o.statusCounters.missedChances=Math.max(0,o.statusCounters.missedChances-1)),A){N.classList.remove("active"),l.hadIssue=!1;const V=le.name;o.categoryIssues[V]&&(o.categoryIssues[V]=Math.max(0,o.categoryIssues[V]-1)),o.statusCounters.missedChances=Math.max(0,o.statusCounters.missedChances-1),u.style.color="",u.title=""}else{$.classList.contains("active")&&($.classList.remove("active"),h.setAttendance(o.identity.studentId,"present"),o.statusCounters.missedChances=Math.max(0,o.statusCounters.missedChances-1)),N.classList.add("active"),l.hadIssue=!0;const V=le.name;o.categoryIssues[V]=(o.categoryIssues[V]||0)+1,o.statusCounters.missedChances++,u.style.textDecoration="",u.style.opacity="",u.style.color="var(--color-warning)",u.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"}ne(),w()}),h.isFinished?R.disabled=!0:R.addEventListener("click",()=>{if(R.classList.contains("active"))R.classList.remove("active"),l.wasOutOfClass=!1,o.statusCounters.outOfClassCount=Math.max(0,(o.statusCounters.outOfClassCount||0)-1),o.statusCounters.missedChances=Math.max(0,o.statusCounters.missedChances-1),u.style.color="",u.title="";else{if($.classList.contains("active")&&($.classList.remove("active"),h.setAttendance(o.identity.studentId,"present"),o.statusCounters.missedChances=Math.max(0,o.statusCounters.missedChances-1)),N.classList.contains("active")){N.classList.remove("active"),l.hadIssue=!1;const V=le.name;o.categoryIssues[V]&&(o.categoryIssues[V]=Math.max(0,o.categoryIssues[V]-1)),o.statusCounters.missedChances=Math.max(0,o.statusCounters.missedChances-1)}R.classList.add("active"),l.wasOutOfClass=!0,o.statusCounters.outOfClassCount=(o.statusCounters.outOfClassCount||0)+1,o.statusCounters.missedChances++,u.style.textDecoration="",u.style.opacity="",u.style.color="var(--color-strong-warning)",u.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود"}ne(),w()}),h.isFinished?ie.disabled=!0:ie.addEventListener("click",()=>{Z(o)}),Q.appendChild($),Q.appendChild(R),Q.appendChild(N),Q.appendChild(ie),n.appendChild(Q);const de=document.createElement("div");de.className="student-details-container";const z=document.createElement("div");z.className="student-details-scores",z.innerHTML="<h4>آخرین نمرات</h4>";const ue=document.createElement("ul");ue.className="scores-list";const ee=["Reading","Writing","Speaking","Listening"];let vt=!1;const bt=o.logs.scores||{};ee.forEach(A=>{var It;const V=document.createElement("li"),oe=document.createElement("span");oe.className="skill-name",oe.textContent=`${A}:`;const ve=document.createElement("span");ve.className="skill-scores";const Xt=A.toLowerCase(),Ue=(It=bt[Xt])==null?void 0:It.filter(Ze=>!Ze.isDeleted);Ue&&Ue.length>0?(vt=!0,ve.textContent=Ue.slice(-3).map(Ze=>Ze.value).join(",")):ve.textContent="none",V.appendChild(oe),V.appendChild(ve),ue.appendChild(V)}),!vt&&Object.keys(bt).length===0&&(ue.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>'),z.appendChild(ue),de.appendChild(z);const Me=document.createElement("div");Me.className="student-details-notes";const Pe=document.createElement("div");Pe.className="history-section-header";const Et=document.createElement("h4");Et.textContent="یادداشت‌ها";const Be=document.createElement("button");Be.className="btn-icon",Be.innerHTML="📝",Be.title="افزودن یادداشت جدید",h.isFinished?Be.disabled=!0:Be.addEventListener("click",()=>{H.value="",H.dispatchEvent(new Event("input",{bubbles:!0})),Ce(A=>{A&&(o.addNote(A),w(),fe(),C("✅ یادداشت با موفقیت ثبت شد."))}),K("add-note-modal"),H.focus()}),Pe.appendChild(Et),Pe.appendChild(Be),Me.appendChild(Pe);const Fe=document.createElement("ul");Fe.className="notes-list",o.profile.notes&&o.profile.notes.length>0?[...o.profile.notes].sort((V,oe)=>new Date(oe.timestamp)-new Date(V.timestamp)).forEach(V=>{const oe=document.createElement("li");oe.dir=$n(V.content),oe.textContent=V.content,Fe.appendChild(oe)}):Fe.innerHTML='<div class="no-content-message">یادداشتی وجود ندارد.</div>',Me.appendChild(Fe),de.appendChild(Me),n.appendChild(de)}function Gs(e){e.addEventListener("input",()=>{const t=e.value,n=$n(t);e.setAttribute("dir",n)})}function ka(){ct.innerHTML="",hn.innerHTML="",je.classList.add("tooltip-container"),Ie.disabled=!0,ge.disabled=!0,Re.disabled=!0,Ie.value="",ge.value="",Ke.classList.add("disabled-wrapper"),ke.disabled=!0}function $t(){ct.innerHTML="",d.categories.filter(n=>!n.isDeleted).forEach(n=>{const o=document.createElement("span");o.className="pill",o.textContent=n.name,o.dataset.categoryId=n.id,n.description&&(o.dataset.tooltip=n.description),h.isFinished?o.classList.add("disabled"):o.addEventListener("click",()=>{document.querySelectorAll("#category-selection-container .pill").forEach(s=>s.classList.remove("active")),o.classList.add("active"),Gt(n),En(n),Ke.classList.remove("disabled-wrapper"),ke.disabled=h.isFinished;const a=h.lastWinnerByCategory[n.name];if(a){const s=d.students.find(i=>i.identity.studentId===a);s&&fe(s,n.name)}else{hn.innerHTML="",jt(null),De(-1),ke.disabled=!1;const s=document.querySelector(".current-winner-highlight");s&&s.classList.remove("current-winner-highlight")}}),h.isFinished||o.addEventListener("contextmenu",a=>{Ct(a,[{label:"تغییر نام",icon:"✏️",action:()=>{Cn((i,l)=>{const c=ls(d,n,i);c.success?(n.isGradedCategory=l,w(),_(d.info.name,`نام دسته‌بندی «${n.name}» به «${i}» تغییر یافت.`),$t(),ne(),C(`✅ نام دسته‌بندی به «${i}» تغییر یافت.`)):C(`⚠️ ${c.message}`)},{title:"ویرایش دسته‌بندی",initialName:n.name,initialIsGraded:n.isGradedCategory,saveButtonText:"ذخیره تغییرات"})}},{label:"حذف دسته‌بندی",icon:"🗑️",className:"danger",action:()=>{G(`آیا از انتقال دسته‌بندی «${n.name}» به سطل زباله مطمئن هستید؟`,()=>{const i={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${n.name}» از کلاس «${d.info.name}»`,restoreData:{categoryId:n.id,classId:d.info.scheduleCode}};O.unshift(i),O.length>50&&O.pop();const l=n.name.toLowerCase();if(d.students.forEach(c=>{c.logs.scores&&c.logs.scores[l]&&c.logs.scores[l].forEach(m=>{m.isDeleted=!0})}),le&&le.id===n.id){Gt(null),hn.innerHTML="",En(null),Ke.classList.add("disabled-wrapper"),ke.disabled=!0;const c=document.querySelector(".current-winner-highlight");c&&c.classList.remove("current-winner-highlight")}n.isDeleted=!0,_(d.info.name,`دسته‌بندی «${n.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),w(),$t(),ne(),C(`✅ دسته‌بندی «${n.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}}])}),ct.appendChild(o)});const t=document.createElement("span");t.className="pill add-category-pill",t.textContent="+",t.title="افزودن دسته‌بندی جدید",h.isFinished?t.classList.add("disabled"):t.addEventListener("click",()=>{Cn((n,o)=>{if(d.categories.find(i=>i.name.toLowerCase()===n.toLowerCase()&&!i.isDeleted)){C("⚠️ این دسته‌بندی از قبل وجود دارد.");return}const s=new we(n,"",o);d.categories.push(s),w(),_(d.info.name,`دسته‌بندی جدید «${n}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),$t(),C(`✅ دسته‌بندی «${n}» اضافه شد.`)})}),ct.appendChild(t)}function Na(){if(h.lastUsedCategoryId){if(h.isFinished)return;const e=ct.querySelector(`.pill[data-category-id="${h.lastUsedCategoryId}"]`);e&&e.click()}h.winnerHistory&&h.winnerHistory.length>0&&(De(h.winnerHistory.length-1),fe())}function En(e){if(h.isFinished){Ie.disabled=!0,ge.disabled=!0,Re.disabled=!0,je.setAttribute("title","جلسه خاتمه یافته است");return}e&&e.isGradedCategory?(Ie.disabled=!1,ge.disabled=!1,Re.disabled=!1,je.removeAttribute("title")):(Ie.disabled=!0,ge.disabled=!0,Re.disabled=!0,e?je.setAttribute("title","برای این دسته‌بندی قابلیت نمره دهی تعریف نشده است"):je.setAttribute("title","ابتدا یک دسته‌بندی را انتخاب کنید"))}function Z(e){re(e);const t=document.getElementById("student-profile-modal"),n=document.getElementById("modal-profile-student-name"),o=document.getElementById("modal-profile-content-container"),a=document.getElementById("modal-profile-close-btn");!t||!n||!o||!a||(n.textContent=`پروفایل: ${e.identity.name}`,n.style.cursor="pointer",n.onclick=()=>{const s=D,i=d;P(()=>{_n(s,i)})},o.innerHTML="",Ba(o),qn(o),a.onclick=()=>P(),K("student-profile-modal"))}function Ba(e){if(!D||!d)return;const t=document.createElement("div");t.className="scoring-section",t.innerHTML=`
        <h3>ثبت نمره جدید</h3>
        <div id="modal-graded-pills" class="category-pills"></div>
        <div class="input-group centered-input-group" style="margin-top: 15px;">
            <input type="number" id="modal-new-score-value" placeholder="نمره (مثلا: 85)">
        </div>
        <textarea id="modal-new-score-comment" placeholder="توضیحات این نمره (اختیاری)..." style="margin-top: 10px;"></textarea>
        <button id="modal-add-score-btn" class="btn-success" style="width: 100%; margin-top: 10px;">ثبت نمره</button>
    `;const n=t.querySelector("#modal-graded-pills");U(d.categories).filter(s=>s.isGradedCategory).forEach(s=>{const i=document.createElement("span");i.className="pill",i.textContent=s.name,i.dataset.skillName=s.name,i.addEventListener("click",()=>{n.querySelectorAll(".pill").forEach(l=>l.classList.remove("active")),i.classList.add("active")}),n.appendChild(i)}),t.querySelector("#modal-add-score-btn").addEventListener("click",()=>{const s=n.querySelector(".pill.active");if(!s){C("⚠️لطفاً یک مهارت را برای نمره‌دهی انتخاب کنید.");return}const i=s.dataset.skillName,l=t.querySelector("#modal-new-score-value"),c=t.querySelector("#modal-new-score-comment"),m=l.value,p=c.value.trim();if(!m){C("لطفاً مقدار نمره را وارد کنید.");return}D.addScore(i,parseFloat(m),p),w(),_(d.info.name,`نمره ${m} در ${i} برای «${D.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:D.identity.studentId}),ne(),fe(),l.value="",c.value="";const I=document.getElementById("modal-profile-content-container"),u=I.querySelector(".history-section");u&&u.remove(),qn(I),C(`✅ نمره برای مهارت ${i} با موفقیت ثبت شد.`)}),e.appendChild(t)}function qn(e){if(!D)return;const t=document.createElement("div");t.className="history-section";const n=document.createElement("div");n.className="history-section-header";const o=document.createElement("h3");o.textContent="سوابق دانش‌آموز";const a=document.createElement("button");a.className="btn-icon",a.title="افزودن یادداشت جدید",a.innerHTML="📝",a.addEventListener("click",()=>{H.value="",H.dispatchEvent(new Event("input",{bubbles:!0})),Ce(s=>{if(s){D.addNote(s),w(),_(d.info.name,`یادداشت جدیدی برای دانش‌آموز «${D.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:D.identity.studentId}),fe();const i=document.getElementById("modal-profile-content-container");if(i){const l=i.querySelector(".history-section");l&&l.remove(),qn(i)}C("✅ یادداشت با موفقیت ثبت شد.")}}),P(()=>{K("add-note-modal"),H.focus()})}),n.appendChild(o),n.appendChild(a),t.appendChild(n),xa(t),js(t),zs(t),e.appendChild(t)}function xa(e){if(!D)return;const t=D,n=d.sessions.reduce((u,v)=>{const b=v.studentRecords[t.identity.studentId];return u+(b&&b.attendance==="absent"?1:0)},0),o=Object.values(t.categoryIssues||{}).reduce((u,v)=>u+v,0),a=document.createElement("div");a.className="stats-summary-box",a.innerHTML=`
        <p><strong>کل انتخاب:</strong> ${t.statusCounters.totalSelections}</p>
        <p><strong>غیبت:</strong> ${n}</p>
        <p><strong>فرصت از دست رفته:</strong> ${t.statusCounters.missedChances||0}</p>
        <p><strong>مشکل:</strong> ${o}</p>
    `,e.appendChild(a);const s=U(d.categories),i=document.createElement("div");if(i.className="stats-breakdown",s.length>0){s.forEach(v=>{var J;const b=v.name,k=((J=t.categoryCounts)==null?void 0:J[b])||0,M=document.createElement("p");M.className="stats-breakdown-item",M.innerHTML=`<strong>${b}:</strong> ${k}`,i.appendChild(M)});const u=a.querySelector("p:first-child");u&&u.after(i)}const l=document.createElement("div");l.className="stats-breakdown",s.length>0&&(s.forEach(u=>{var M;const v=u.name,b=((M=t.categoryIssues)==null?void 0:M[v])||0,k=document.createElement("p");k.className="stats-breakdown-item",k.innerHTML=`<strong>${v}:</strong> ${b}`,l.appendChild(k)}),a.appendChild(l));const c=document.createElement("p"),m=document.createElement("strong");m.textContent="تکالیف ناقص:";const p=document.createElement("span");p.style.marginRight="5px";const I=ye(d);Mt(t,I,p,{includePrefix:!1}),c.appendChild(m),c.appendChild(p),a.appendChild(c)}function js(e){if(!D)return;const t=D,n=document.createElement("h4");n.textContent="تاریخچه نمرات:",n.style.marginTop="20px";const o=document.createElement("ul");o.className="list-container";const a=Object.values(t.logs.scores||{}).flat().filter(s=>!s.isDeleted).sort((s,i)=>new Date(i.timestamp)-new Date(s.timestamp));a.length===0?o.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>':a.forEach(s=>{const i=document.createElement("li");i.className="score-history-item";const l=document.createElement("div");l.className="item-content";const c=document.createElement("div");c.className="score-info";const m=document.createElement("span");m.className="score-skill-badge",m.textContent=s.skill;const p=document.createElement("span");p.className="score-value",p.textContent=`نمره: ${s.value}`;const I=document.createElement("span");if(I.className="score-date",I.textContent=new Date(s.timestamp).toLocaleDateString("fa-IR"),c.appendChild(m),c.appendChild(p),c.appendChild(I),l.appendChild(c),s.comment){const v=document.createElement("p");v.className="score-comment",v.innerHTML=Ss(s.comment),v.addEventListener("click",()=>{H.value=s.comment,H.dispatchEvent(new Event("input",{bubbles:!0})),Ce(b=>{s.comment=b,w(),_(d.info.name,`توضیحات نمره ${s.value} (${s.skill}) برای دانش‌آموز «${t.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:t.identity.studentId}),Z(t),C("✅ توضیحات نمره با موفقیت ویرایش شد.")}),P(()=>{K("add-note-modal"),H.focus()})}),l.appendChild(v)}const u=document.createElement("button");u.className="btn-icon delete-item-btn",u.innerHTML="🗑️",u.title="حذف این نمره",u.addEventListener("click",()=>{P(()=>{G(`آیا از انتقال نمره ${s.value} در مهارت «${s.skill}» به سطل زباله مطمئن هستید؟`,()=>{const v={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"score",description:`نمره ${s.value} (${s.skill}) برای «${t.identity.name}»`,restoreData:{scoreId:s.id,skill:s.skill,studentId:t.identity.studentId,classId:d.info.scheduleCode}};O.unshift(v),O.length>50&&O.pop(),s.isDeleted=!0,w(),_(d.info.name,`نمره ${s.value} (${s.skill}) دانش‌آموز «${t.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),Z(t),C("✅ نمره به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{Z(t)}})})}),i.appendChild(l),i.appendChild(u),o.appendChild(i)}),e.appendChild(n),e.appendChild(o)}function zs(e){if(!D)return;const t=document.createElement("h4");t.textContent="تاریخچه یادداشت‌ها:",t.style.marginTop="20px";const n=document.createElement("ul");n.className="list-container",!D.profile.notes||D.profile.notes.length===0?n.innerHTML='<div class="no-content-message">هنوز یادداشتی ثبت نشده است.</div>':[...D.profile.notes].filter(a=>!a.isDeleted).sort((a,s)=>new Date(s.timestamp)-new Date(a.timestamp)).forEach(a=>{const s=document.createElement("li");s.className="note-history-item";const i=document.createElement("div");i.className="item-content";const l=document.createElement("div");l.className="note-info";const c=document.createElement("span");c.className="note-date",c.textContent=new Date(a.timestamp).toLocaleDateString("fa-IR");const m=document.createElement("button");m.className="btn-icon delete-item-btn",m.innerHTML="🗑️",m.title="حذف این یادداشت",m.addEventListener("click",()=>{P(()=>{G("آیا از انتقال این یادداشت به سطل زباله مطمئن هستید؟",()=>{const I={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"note",description:`یادداشت برای دانش‌آموز «${D.identity.name}»`,restoreData:{noteId:a.id,studentId:D.identity.studentId,classId:d.info.scheduleCode}};O.unshift(I),O.length>50&&O.pop(),a.isDeleted=!0,_(d.info.name,`یادداشت دانش‌آموز «${D.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),w(),Z(D),C("✅ یادداشت به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{Z(D)}})})}),l.appendChild(c),l.appendChild(m);const p=document.createElement("p");p.className="note-content",p.innerHTML=Ss(a.content),p.addEventListener("click",()=>{H.value=a.content,H.dispatchEvent(new Event("input",{bubbles:!0})),Ce(I=>{a.content=I,w(),_(d.info.name,`یادداشت دانش‌آموز «${D.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:D.identity.studentId}),Z(D),C("✅یادداشت با موفقیت ویرایش شد.")}),P(()=>{K("add-note-modal"),H.focus()})}),i.appendChild(l),i.appendChild(p),s.appendChild(i),n.appendChild(s)}),e.appendChild(t),e.appendChild(n)}function Js(e){un.innerHTML="",e.forEach((t,n)=>{const o=document.createElement("option");o.value=n,o.textContent=t.trim(),un.appendChild(o)})}function In(){dn.innerHTML="",Ln.forEach(e=>{const t=document.createElement("li");t.className="preview-item";const n=document.createElement("input");n.type="checkbox",n.checked=!0,n.dataset.name=e;const o=document.createElement("label");o.textContent=e,t.appendChild(n),t.appendChild(o),dn.appendChild(t)})}function Ta(e){const t=document.createElement("div");t.className="list-item-buttons";const n=document.createElement("button");return n.className="btn-icon",n.innerHTML="📝",n.title="افزودن/ویرایش یادداشت کلاس",n.style.borderBottom="solid",e.note||(n.style.opacity="0.5",n.style.borderBottom="none"),n.addEventListener("click",o=>{o.stopPropagation(),Fn(e)}),t.appendChild(n),t}function Da(e){const t=document.createElement("div");t.style.flexGrow="1",t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="flex-start";const n=document.createElement("span");n.textContent=e.info.name,n.classList.add("class-name-display"),t.appendChild(n);const o=U(e.students).length,a=U(e.sessions).filter(c=>c.isFinished).length,s=document.createElement("div");s.classList.add("class-stats-row");const i=document.createElement("span");i.textContent=`${o} نفر`,i.classList.add("student-count-badge"),s.appendChild(i);const l=document.createElement("span");return l.textContent=`${a} جلسه`,l.classList.add("session-count-badge"),s.appendChild(l),t.appendChild(s),t.addEventListener("click",()=>{X(e),ce(null),ft(d.liveSession),se(),T("session-page")}),t}function Ma(e){const t=document.createElement("li"),n=document.createElement("input");n.type="checkbox",n.className="mass-selection-checkbox",n.checked=be.includes(e.info.name),n.addEventListener("click",l=>{l.stopPropagation()}),n.addEventListener("change",()=>{const l=e.info.name;if(n.checked)be.includes(l)||be.push(l);else{const c=be.indexOf(l);c>-1&&be.splice(c,1)}}),t.appendChild(n);const o=Da(e);t.appendChild(o);const a=document.createElement("div");if(a.className="list-item-badges",e.liveSession&&!e.liveSession.isCancelled&&!e.liveSession.isDeleted){const l=document.createElement("span");l.className="warning-badge",l.textContent="جلسه باز",a.appendChild(l),t.classList.add("has-unfinished-session")}const s=document.createElement("span");s.className=`type-badge ${e.info.type}`,s.textContent=e.info.type==="online"?"آنلاین":"حضوری",s.title="نوع کلاس",a.appendChild(s),t.appendChild(a);const i=Ta(e);return t.appendChild(i),t.addEventListener("contextmenu",l=>{const c={label:"پشتیبان‌گیری از این کلاس",icon:"📤",action:()=>{ht([e.info.name])}},m=be.length;m>1&&be.includes(e.info.name)&&(c.label=`پشتیبان‌گیری از ${m} کلاس`,c.action=()=>{ht(be),cn([]),ae()});const p=[{label:ze.classList.contains("selection-mode-active")?"لغو انتخاب":"انتخاب چند کلاس",icon:"✔️",action:()=>{const I=ze.classList.contains("selection-mode-active");ze.classList.toggle("selection-mode-active"),I&&(cn([]),ae())}},c,{label:"تنظیمات کلاس",icon:"⚙️",action:()=>{Un(e)}},{label:"گزارش فعالیت‌ها",icon:"📋",action:()=>{qs(e.info.name)}},{label:"تغییر نام",icon:"✏️",action:()=>{const I=e.info.name,u=document.getElementById("add-note-modal-title");u.textContent="تغییر نام کلاس",H.value=I,H.rows=1,Ce(v=>{const b=v.trim();if(b&&b!==I){const k=cs(I,b);k.success?(Io(I,b),_(b,`نام کلاس از «${I}» به «${b}» تغییر یافت.`,{type:"VIEW_SESSIONS"}),w(),ae(),C(`✅نام کلاس به «${b}» تغییر یافت.`)):C(k.message)}u.textContent="ثبت یادداشت جدید",H.rows=4}),K("add-note-modal"),H.focus(),H.select()}},{label:"حذف کلاس",icon:"🗑️",className:"danger",action:()=>{G(`آیا از انتقال کلاس «${e.info.name}» به سطل زباله مطمئن هستید؟`,()=>{const I={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"classroom",description:`کلاس «${e.info.name}»`,restoreData:{name:e.info.name}};O.unshift(I),O.length>50&&O.pop(),e.isDeleted=!0,w(),ae(),C(`✅ کلاس «${e.info.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}];Ct(l,p)}),t}function Ks(){const e=document.getElementById("class-management-stats");if(!e)return;const t=Object.values(L).filter(a=>!a.isDeleted),n=t.length,o=t.reduce((a,s)=>a+U(s.students).length,0);e.innerHTML=`
        <span>کل کلاس‌ها: <strong>${n}</strong></span>
        <span>|</span>
        <span>کل دانش‌آموزان: <strong>${o}</strong></span>
    `}function ae(){Ks(),ze.innerHTML="",Object.values(L).sort((t,n)=>new Date(t.info.creationDate)-new Date(n.info.creationDate)).forEach(t=>{if(t.isDeleted)return;const n=Ma(t);ze.appendChild(n)})}function Ne(){ln.innerHTML="",d&&U(d.students).forEach(e=>{const t=document.createElement("li"),n=document.createElement("span");n.textContent=e.identity.name,n.style.flexGrow="1",n.className="student-name-link",n.addEventListener("click",()=>{Z(e)}),t.appendChild(n),t.addEventListener("contextmenu",o=>{Ct(o,[{label:"تغییر نام",icon:"✏️",action:()=>{_n(e,d)}},{label:"انتقال دانش‌آموز",icon:"➡️",action:()=>{Fs(e,d)}},{label:"حذف دانش‌آموز",icon:"🗑️",className:"danger",action:()=>{G(`آیا از انتقال دانش‌آموز «${e.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const s={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${e.identity.name}» از کلاس «${d.info.name}»`,restoreData:{studentId:e.identity.studentId,classId:d.info.scheduleCode}};O.unshift(s),O.length>50&&O.pop(),e.isDeleted=!0,_(d.info.name,`دانش‌آموز «${e.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),w(),Ne(),C(`✅ دانش‌آموز «${e.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}])}),ln.appendChild(t)})}function Xe(){if(rn.innerHTML="",!d)return;d.categories.filter(t=>!t.isDeleted).forEach(t=>{const n=document.createElement("li"),o=document.createElement("div");o.className="name-and-badge-container";const a=document.createElement("span");if(a.textContent=t.name,o.appendChild(a),t.isGradedCategory){const i=document.createElement("span");i.className="category-badge",i.textContent="قابل نمره‌دهی",o.appendChild(i)}const s=document.createElement("button");s.className="btn-icon",s.innerHTML="🗑️",s.style.color="var(--color-warning)",s.addEventListener("click",()=>{G(`آیا از انتقال دسته‌بندی «${t.name}» به سطل زباله مطمئن هستید؟`,()=>{const i={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${t.name}» از کلاس «${d.info.name}»`,restoreData:{categoryId:t.id,classId:d.info.scheduleCode}};O.unshift(i),O.length>50&&O.pop(),t.isDeleted=!0,_(d.info.name,`دسته‌بندی «${t.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),w(),Xe(),C(`✅ دسته‌بندی «${t.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}),n.appendChild(o),n.appendChild(s),rn.appendChild(n)})}function dt(e){document.querySelectorAll(".page").forEach(n=>{n.classList.remove("active")});const t=document.getElementById(e);t&&t.classList.add("active"),e==="class-management-page"?(X(null),ce(null),re(null),ae(),mn.style.display="flex"):mn.style.display="none",Vs()}function T(e,t={}){const{tab:n}=t,o={pageId:e,currentClassName:d?d.info.name:null,selectedSessionNumber:h?h.sessionNumber:null,selectedStudentId:D?D.identity.studentId:null};let a=`#${e}`;const s=new URLSearchParams(window.location.hash.split("?")[1]||"");d&&s.set("class",d.info.name),h&&s.set("session",h.sessionNumber),D&&s.set("student",D.identity.studentId),e==="session-dashboard-page"&&n&&s.set("tab",n);const i=s.toString();i&&(a+=`?${i}`),window.location.hash!==a&&history.pushState(o,"",a),dt(e)}function $a(e,t){const n=document.createElement("div");n.className="list-item-buttons";const o=document.createElement("button");if(o.className="btn-icon",o.innerHTML="📝",o.title="افزودن/ویرایش یادداشت جلسه",o.style.borderBottom="solid",e.note||(o.style.opacity="0.5",o.style.borderBottom="none"),o.addEventListener("click",a=>{a.stopPropagation(),H.value=e.note||"",Ce(s=>{e.note=s,w(),_(d.info.name,`یادداشت جلسه ${t} ذخیره شد.`,{type:"VIEW_SESSIONS"}),se(),C("✅یادداشت جلسه ذخیره شد.")}),K("add-note-modal"),H.focus()}),n.appendChild(o),!e.isFinished&&!e.isCancelled){const a=document.createElement("button");a.className="btn-icon",a.innerHTML="✅",a.title="خاتمه جلسه",a.addEventListener("click",s=>{s.stopPropagation(),G(`جلسه شماره ${t} خاتمه پیدا خواهد کرد!`,()=>{d.endSpecificSession(e.sessionNumber),w(),_(d.info.name,`جلسه ${t} خاتمه یافت.`,{type:"VIEW_SESSIONS"}),se(),G("جلسه با موفقیت خاتمه یافت. آیا مایل به ایجاد فایل پشتیبان هستید؟",()=>{if(Ee){C("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است.");return}ht(),C("✅فایل پشتیبان با موفقیت ایجاد شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}),n.appendChild(a)}return n}function Oa(e,t){const n=document.createElement("div");n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="flex-start",n.style.flexGrow="1";const o=new Date(e.startTime).toLocaleDateString("fa-IR"),a=document.createElement("span"),s=document.createElement("div");s.style.display="flex",s.style.gap="5px",s.style.marginTop="5px";const i=new Date(e.startTime).toLocaleDateString("fa-IR",{weekday:"long"}),l=document.createElement("span");if(l.className="type-badge day-badge",l.textContent=i,s.appendChild(l),e.isCancelled){a.textContent=`✅جلسه لغو شده - تاریخ: ${o}`,n.style.cursor="default";const c=document.createElement("span");c.className="type-badge cancelled-badge",c.textContent="لغو شده",s.appendChild(c)}else a.textContent=`جلسه ${t} - تاریخ: ${o}`,n.style.cursor="pointer",n.addEventListener("click",()=>{ce(e),gt()});if(n.appendChild(a),e.isFinished){const c=document.createElement("span");c.className="type-badge",c.textContent="خاتمه یافته",c.style.backgroundColor="var(--color-secondary)",s.appendChild(c)}if(e.isMakeup){const c=document.createElement("span");c.className="type-badge",c.textContent="جبرانی",c.style.backgroundColor="var(--color-warning)",c.style.color="var(--color-text-dark)",s.appendChild(c)}return n.appendChild(s),n}function Ha(e,t){const n=document.createElement("li"),o=t.get(e.sessionNumber),a=Oa(e,o);n.appendChild(a);const s=$a(e,o);return n.appendChild(s),n.addEventListener("contextmenu",i=>{const l=[{label:e.isCancelled?"بازگردانی جلسه":"لغو جلسه",icon:"❌",action:()=>{const c=e.isCancelled?"بازگردانی جلسه":"لغو جلسه",m=e.isCancelled?"آیا از بازگردانی این جلسه مطمئن هستید؟":"آیا از لغو این جلسه مطمئن هستید؟ جلسه لغو شده در آمار تاثیری ندارد اما قابل بازگردانی است.";G(m,()=>{e.isCancelled=!e.isCancelled;const p=e.isCancelled?`جلسه ${o} لغو شد.`:`جلسه لغو شده (تاریخ: ${new Date(e.startTime).toLocaleDateString("fa-IR")}) بازگردانی شد.`;_(d.info.name,p,{type:"VIEW_SESSIONS"}),w(),se(),C(e.isCancelled?"✅جلسه لغو شد.":"✅جلسه بازگردانی شد.")},{confirmText:c,confirmClass:"btn-warning"})}},{label:"تغییر وضعیت جبرانی",icon:"🔄",action:()=>{d.markAsMakeup(e.sessionNumber),w();const c=e.isMakeup?`جلسه ${o} به عنوان جبرانی علامت‌گذاری شد.`:`جلسه ${o} از حالت جبرانی خارج شد.`;_(d.info.name,c,{type:"VIEW_SESSIONS"}),se()}},{label:"حذف جلسه",icon:"🗑️",className:"danger",action:()=>{const c=e.isCancelled?"لغو شده":o;G(`آیا از انتقال جلسه ${c} به سطل زباله مطمئن هستید؟`,()=>{const m={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"session",description:`جلسه ${c} از کلاس «${d.info.name}»`,restoreData:{sessionNumber:e.sessionNumber,classId:d.info.scheduleCode}};O.unshift(m),O.length>50&&O.pop(),e.isDeleted=!0,_(d.info.name,`جلسه ${c} به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),w(),se(),C(`✅ جلسه ${c} به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}];Ct(i,l)}),n}function se(){const e=document.getElementById("session-list");if(!d)return;if(e.innerHTML="",d.sessions.length===0){e.innerHTML="<li>هنوز جلسه‌ای شروع نشده است.</li>";return}const t=ye(d);[...U(d.sessions)].reverse().forEach(o=>{const a=Ha(o,t);e.appendChild(a)})}function ot(e){if(xe.innerHTML="",e.length>0)e.forEach(t=>{const n=document.createElement("div");n.textContent=t.identity.name,n.addEventListener("click",()=>{Z(t),xe.style.display="none",gn.value=""}),xe.appendChild(n)}),xe.style.display="block";else if(gn.value.trim()!==""){const t=document.createElement("div");t.className="no-results",t.textContent="پیدا نشد",xe.appendChild(t),xe.style.display="block"}else xe.style.display="none"}function Ot(e){if(Le.innerHTML="",e.length>0)e.forEach(t=>{const n=document.createElement("div");n.className="global-search-result";const o=document.createElement("span");o.className="student-name",o.textContent=t.student.identity.name;const a=document.createElement("span");a.className="class-name",a.textContent=`کلاس: ${t.classroom.info.name}`,n.addEventListener("click",()=>{X(t.classroom),Z(t.student),Le.style.display="none",Tt.value=""}),a.addEventListener("click",s=>{s.stopPropagation(),X(t.classroom),ce(null),ft(t.classroom.liveSession),se(),T("session-page"),Le.style.display="none",Tt.value=""}),n.appendChild(o),n.appendChild(a),Le.appendChild(n)}),Le.style.display="block";else if(Tt.value.trim()!==""){const t=document.createElement("div");t.className="no-results",t.textContent="پیدا نشد",Le.appendChild(t),Le.style.display="block"}else Le.style.display="none"}function yt(){const e=document.getElementById("trashed-items-list");if(e.innerHTML="",O.length===0){e.innerHTML='<li style="text-align: center; padding: 20px;">سطل زباله خالی است.</li>';return}O.forEach((t,n)=>{const o=document.createElement("li"),a=document.createElement("span");a.textContent=t.description,a.style.flexGrow="1";const s=document.createElement("div");s.className="list-item-buttons";const i=document.createElement("button");i.className="btn-icon",i.innerHTML="🔄",i.title="بازیابی",i.addEventListener("click",()=>{var I;let c=!1,m=null;const p=t.restoreData;switch(t.type){case"classroom":{const u=L[p.name];u&&!u.isDeleted?m=`کلاسی با نام «${p.name}» از قبل فعال است.`:u&&u.isDeleted&&(u.isDeleted=!1,c=!0);break}case"student":{const u=Object.values(L).find(b=>b.info.scheduleCode===p.classId),v=u==null?void 0:u.students.find(b=>b.identity.studentId===p.studentId);v&&(v.isDeleted=!1,c=!0);break}case"session":{const u=Object.values(L).find(b=>b.info.scheduleCode===p.classId),v=u==null?void 0:u.sessions.find(b=>b.sessionNumber===p.sessionNumber);v&&(v.isDeleted=!1,c=!0);break}case"category":{const u=Object.values(L).find(b=>b.info.scheduleCode===p.classId),v=u==null?void 0:u.categories.find(b=>b.id===p.categoryId);v&&(v.isDeleted=!1,c=!0);break}case"score":{const u=Object.values(L).find(k=>k.info.scheduleCode===p.classId),v=u==null?void 0:u.students.find(k=>k.identity.studentId===p.studentId),b=(I=v==null?void 0:v.logs.scores[p.skill.toLowerCase()])==null?void 0:I.find(k=>k.id===p.scoreId);b&&(b.isDeleted=!1,c=!0);break}case"note":{const u=Object.values(L).find(k=>k.info.scheduleCode===p.classId),v=u==null?void 0:u.students.find(k=>k.identity.studentId===p.studentId),b=v==null?void 0:v.profile.notes.find(k=>k.id===p.noteId);b&&(b.isDeleted=!1,c=!0);break}}c?(O.splice(n,1),w(),yt(),t.type==="classroom"&&ae(),C("✅ آیتم با موفقیت بازیابی شد.")):C(m?`⚠️ ${m}`:"⚠️ آیتم اصلی برای بازیابی یافت نشد.")});const l=document.createElement("button");l.className="btn-icon",l.innerHTML="🔥",l.title="حذف دائمی",l.addEventListener("click",()=>{G("آیا از حذف دائمی این آیتم مطمئن هستید؟ این عمل غیرقابل بازgشت است.",()=>{const c=t.restoreData,m=I=>Object.values(L).find(u=>u.info.scheduleCode===I);let p;switch(t.type){case"classroom":delete L[c.name];break;case"student":p=m(c.classId),mt({identity:{studentId:c.studentId}},p);break;case"session":p=m(c.classId),p&&us(p.info.name,c.sessionNumber);break;case"category":p=m(c.classId),p&&ms(p.info.name,c.categoryId);break;case"score":p=m(c.classId),p&&fs(p.info.name,c.studentId,c.skill,c.scoreId);break;case"note":p=m(c.classId),p&&ps(p.info.name,c.studentId,c.noteId);break}O.splice(n,1),w(),yt(),C("✅ آیتم برای همیشه حذف شد.")},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),s.appendChild(i),s.appendChild(l),o.appendChild(a),o.appendChild(s),e.appendChild(o)})}function Ra(){const e=document.getElementById("absentees-summary-container");e&&(e.innerHTML=`
        <div id="absentees-summary-box" class="absentees-summary">
            <div class="absentees-summary-header">
                <h4>لیست غایبین جلسه شماره <span id="absentee-summary-session-number"></span></h4>
                <button id="copy-absentees-btn" class="btn-icon" title="کپی لیست غایبین">📋</button>
            </div>
            <div id="absentees-summary-list" class="summary-list"></div>
        </div>
    `)}function Qs(){const e=document.getElementById("absentees-summary-box"),t=document.getElementById("absentees-summary-list"),n=document.getElementById("absentee-summary-session-number");if(!e||!t||!n){console.error("Could not find all absentee summary elements.");return}if(!d||!h){e.classList.remove("visible");return}const o=U(d.students).filter(s=>{const i=h.studentRecords[s.identity.studentId];return i&&i.attendance==="absent"}),a=ye(d);n.textContent=a.get(h.sessionNumber),o.length>0?e.classList.add("visible"):e.classList.remove("visible"),t.innerHTML="",o.forEach(s=>{const l=(m=>d.sessions.reduce((p,I)=>{if(I.isDeleted||I.isCancelled)return p;const u=I.studentRecords[m.identity.studentId];return p+(u&&u.attendance==="absent"?1:0)},0))(s),c=document.createElement("span");c.className="summary-name",c.textContent=`${s.identity.name} (غیبت: ${l})`,c.addEventListener("click",()=>{c.classList.add("fading-out"),setTimeout(()=>{h.setAttendance(s.identity.studentId,"present"),w(),Ye()},200)}),t.appendChild(c)})}function Aa(){const e=document.getElementById("copy-absentees-btn");if(!e){console.error("Could not find the copy absentees button to attach listener.");return}e.addEventListener("click",()=>{if(!d||!h)return;const t=U(d.students).filter(a=>{const s=h.studentRecords[a.identity.studentId];return s&&s.attendance==="absent"});if(t.length===0){C("⚠️لیست غایبین خالی است.");return}const n=a=>d.sessions.reduce((s,i)=>{if(i.isDeleted||i.isCancelled)return s;const l=i.studentRecords[a.identity.studentId];return s+(l&&l.attendance==="absent"?1:0)},0);let o=`لیست غایبین جلسه شماره ${wa()}:

`;t.forEach(a=>{const s=n(a);o+=`- ${a.identity.name} (تعداد غیبت‌ها: ${s})
`}),navigator.clipboard.writeText(o).then(()=>{C("✅لیست غایبین با موفقیت کپی شد.")}).catch(a=>{console.error("Failed to copy text: ",a),C("❌خطا در کپی کردن لیست.")})})}function Ht(){const e=document.getElementById("demo-mode-banner");e&&(Ee?(e.classList.add("visible"),document.body.classList.add("demo-mode-active")):(e.classList.remove("visible"),document.body.classList.remove("demo-mode-active")))}const Wa=Object.freeze(Object.defineProperty({__proto__:null,_internalShowPage:dt,addCategoryBtn:Po,addClassBtn:Lo,addNoteModal:Zo,addScoreBtn:aa,addStudentBtn:xo,appHeader:mn,attendanceListUl:it,attendanceMassActionsContainer:Dt,attendancePage:Fo,attendancePane:Qe,attendanceSearchInput:Oe,backToSessionsBtn:No,backToStudentPageBtn:na,backupDataBtn:Jo,breadcrumbContainer:Ge,cancelImportBtn:Wo,cancelNoteBtn:ta,categoryListUl:rn,categoryModal:ga,categoryModalCancelBtn:ha,categoryModalSaveBtn:Hs,categoryModalTitle:Os,classListHeader:qo,classListUl:ze,classManagementPage:ks,classSaveNoteBtn:ea,closeActiveModal:P,closeContextMenu:He,closeNavBtn:jo,columnMappingPage:Ro,columnSelectDropdown:un,confirmColumnBtn:Ao,confirmModalCancelBtn:pn,confirmModalConfirmBtn:st,confirmModalMessage:Ts,contextMenu:Ae,csvCancelBtn:$o,csvConfirmBtn:Mo,csvFileInput:Ho,csvPreviewList:dn,csvPreviewPage:Do,customConfirmModal:Qo,displayWinner:fe,finishAttendanceBtn:Uo,globalStudentSearchInput:Tt,globalStudentSearchResultsDiv:Le,gradedCategoryPillsContainer:sa,hamburgerMenuBtn:Vo,handleUndo:Ws,importCsvBtn:Oo,initiateBackupProcess:ht,isGradedCheckbox:la,massCommentAppendCheckbox:An,massCommentBtn:yn,massCommentCancelBtn:va,massCommentContent:rt,massCommentModal:ya,massCommentModalTitle:Ca,massCommentSaveBtn:ba,massCommentStudentCountMessage:Rs,newCategoryModalIsGradedCheckbox:Rn,newCategoryModalNameInput:lt,newCategoryNameInput:_o,newClassNameInput:So,newNoteContent:H,newScoreCommentTextarea:$s,newScoreValueInput:oa,newStudentNameInput:Bo,openContextMenu:Ct,openModal:K,overlay:zo,pasteArea:Bs,processMassHomeworkComment:vn,processPasteBtn:To,profileScoresListUl:ca,profileStatsSummaryDiv:ia,quickGradeFormWrapper:je,quickGradeSubmitBtn:Re,quickNoteTextarea:ge,quickScoreInput:Ie,renderAttendancePage:Ye,renderBreadcrumbs:Vs,renderClassList:ae,renderClassManagementStats:Ks,renderColumnSelector:Js,renderGlobalSearchResults:Ot,renderImportPreview:In,renderLogModal:qs,renderMassCommentControls:Pn,renderScoresHistory:js,renderSearchResults:ot,renderSessionDashboard:gt,renderSessions:se,renderSettingsCategories:Xe,renderSettingsStudentList:Ne,renderStudentNotes:zs,renderStudentStatsList:ne,renderTrashPage:yt,restoreDataBtn:Ko,restoreFileInput:xs,secureConfirmCancelBtn:Xo,secureConfirmCode:Ms,secureConfirmConfirmBtn:xt,secureConfirmInput:Ve,secureConfirmMessage:Ds,secureConfirmModal:Yo,selectStudentBtn:ke,selectStudentBtnWrapper:Ke,sessionDashboardPage:Ea,setAutoDirectionOnInput:Gs,settingsClassNameHeader:Hn,settingsPage:ko,settingsStudentListUl:ln,setupDashboardTabs:As,showCategoryModal:Cn,showClassNoteModal:Fn,showCustomConfirm:G,showMassCommentModal:Us,showMoveStudentModal:Fs,showNotification:C,showPage:T,showRenameStudentModal:_n,showRestoreConfirmModal:_s,showSecureConfirm:Ps,showSettingsPage:Un,showStudentProfile:Z,showUndoToast:Ia,sideNavMenu:Go,studentSearchInput:gn,studentSearchResultsDiv:xe,studentStatsHeader:fn,switchDashboardTab:Wn,trashedCategoriesList:ma,trashedClassesList:ra,trashedNotesList:fa,trashedScoresList:pa,trashedSessionsList:ua,trashedStudentsList:da,triggerFileDownload:bn,undoBtn:wo,undoMessage:Ns,undoToast:Kt,updateDemoModeBanner:Ht},Symbol.toStringTag,{value:"Module"}));function _a(){const e=window.location.hash;if(!e||e==="#")return!1;const[t,n]=e.split("?"),o=t.substring(1),a=new URLSearchParams(n),s=a.get("class"),i=parseInt(a.get("session"),10),l=a.get("student"),c=a.get("tab")||"selector";if(s&&L[s])X(L[s]),i&&d.getSession(i)&&ce(d.getSession(i)),l&&d.students.find(m=>m.identity.studentId===l)&&re(d.students.find(m=>m.identity.studentId===l));else return!1;switch(o){case"session-page":se(),T("session-page");break;case"session-dashboard-page":gt(o==="attendance-page"?"attendance":c);break;case"settings-page":Hn.textContent=`تنظیمات کلاس: ${d.info.name}`,Ne(),Xe(),T("settings-page");break;case"student-profile-page":gt(c),Z(D);break;default:return!1}return!0}document.addEventListener("DOMContentLoaded",()=>{const{globalStudentSearchInput:e,newClassNameInput:t,addClassBtn:n,undoBtn:o,backToSessionsBtn:a,newStudentNameInput:s,addStudentBtn:i,pasteArea:l,processPasteBtn:c,csvPreviewList:m,csvConfirmBtn:p,csvCancelBtn:I,importCsvBtn:u,csvFileInput:v,columnSelectDropdown:b,confirmColumnBtn:k,cancelImportBtn:M,newCategoryNameInput:J,addCategoryBtn:j,selectStudentBtn:Q,attendancePage:$,finishAttendanceBtn:N,classListHeader:R,studentStatsHeader:ie,hamburgerMenuBtn:de,sideNavMenu:z,closeNavBtn:ue,overlay:ee,backupDataBtn:vt,restoreDataBtn:bt,restoreFileInput:Me,confirmModalCancelBtn:Pe,confirmModalConfirmBtn:Et,secureConfirmCancelBtn:Be,secureConfirmConfirmBtn:Fe,newNoteContent:A,classSaveNoteBtn:V,cancelNoteBtn:oe,studentSearchInput:ve,studentSearchResultsDiv:Xt,isGradedCheckbox:Ue,categoryModalSaveBtn:It,categoryModalCancelBtn:Ze,massCommentBtn:Ys,massCommentCancelBtn:Xs,massCommentSaveBtn:Zs,massCommentContent:eo,massCommentAppendCheckbox:to,attendanceSearchInput:Vn}=Wa,no=document.getElementById("trash-nav-btn");document.querySelector(".global-search-container .search-icon"),qt(),Ht(),_a()||(ae(),T("class-management-page"));function Gn(r,g){const f=document.querySelector(r);if(!f)return;const y=f.querySelector(".search-icon"),E=f.querySelector(".animated-search-input");!y||!E||(y.addEventListener("mousedown",B=>{B.preventDefault()}),y.addEventListener("click",()=>{f.classList.contains("search-active")||(f.classList.add("search-active"),E.focus())}),E.addEventListener("blur",()=>{setTimeout(()=>{f.classList.remove("search-active"),E.value="",g&&g([])},150)}))}Vn.addEventListener("input",()=>{const r=Vn.value.toLowerCase().trim(),g=sn(r);it.querySelectorAll(".attendance-list-item").forEach(y=>{const E=y.querySelector(".student-name");if(E){const B=E.textContent,S=Se(B.toLowerCase()),x=S.includes(Se(r)),W=S.includes(Se(g));x||W?y.style.display="flex":y.style.display="none"}})}),Ze.addEventListener("click",()=>{P(),Yt(null)}),It.addEventListener("click",()=>{const r=lt.value.trim(),g=Rn.checked;typeof Ft=="function"&&Ft(r,g)}),window.addEventListener("scroll",He),document.addEventListener("click",r=>{Ae.classList.contains("visible")&&!Ae.contains(r.target)&&He(),ve.contains(r.target)||(Xt.style.display="none");const g=r.target.closest(".log-action-link");if(g&&g.dataset.action)try{const f=JSON.parse(g.dataset.action);uo(f)}catch(f){console.error("Could not parse log action:",f)}}),Ke.addEventListener("click",()=>{(Ke.classList.contains("disabled-wrapper")||ke.disabled)&&(ke.classList.add("shake-animation"),setTimeout(()=>{ke.classList.remove("shake-animation")},200))}),ie.addEventListener("click",()=>{const r=new Date().getTime();r-Nn>500?Bt(1):Bt(Wt+1),bs(r),Wt===5&&(Bt(0),G("آیا از صفر کردن تمام شمارنده‌های دانش‌آموزان مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{ds(),ne(),C("تمام آمارها صفر شدند ✅.")},{confirmText:"بله",confirmClass:"btn-warning"}))}),R.addEventListener("click",()=>{const r=new Date().getTime();r-kn>500?Nt(1):Nt(At+1),vs(r),At===5&&(Nt(0),G("آیا از ساخت یک کلاس تستی تصادفی مطمئن هستید؟",()=>{function g(){const f=`کلاس تستی ${Object.keys(L).length+1}`,y=new an({name:f,type:"online"});["علی رضایی","مریم حسینی","زهرا احمدی","رضا محمدی","فاطمه کریمی"].forEach(B=>y.addStudent(new wt({name:B}))),L[f]=y,w(),ae()}g(),C("کلاس تستی با موفقیت ساخته شد ✅!")},{confirmText:"بساز",confirmClass:"btn-success"}))}),Be.addEventListener("click",()=>{P(),pt(null)}),Fe.addEventListener("click",()=>{typeof _t=="function"&&_t(),P(),pt(null)}),Pe.addEventListener("click",()=>{P(xn)}),Et.addEventListener("click",()=>{P(Bn)}),Q.addEventListener("click",()=>{if(Ie.value.trim()!==""||ge.value.trim()!==""){C("⚠️لطفاً ابتدا با دکمه «ثبت»، تغییرات را ذخیره کنید و یا نمره و یادداشت را پاک کنید.");return}if(!d||!h||!le)return;const r=d.selectNextWinner(le.name,h);if(r){const g=h.studentRecords[r.identity.studentId];if(g&&g.attendance==="absent"&&r.statusCounters.missedChances++,g&&g.hadIssue){r.statusCounters.missedChances++;const y=le.name;r.categoryIssues[y]=(r.categoryIssues[y]||0)+1}const f={winner:r,categoryName:le.name};h.winnerHistory.push(f),h.winnerHistory.length>10&&h.winnerHistory.shift(),De(h.winnerHistory.length-1),h.lastUsedCategoryId=le.id,h.lastSelectedWinnerId=r.identity.studentId,ne(),fe(),w()}else C("❌دانش‌آموز واجد شرایطی برای انتخاب یافت نشد.")}),j.addEventListener("click",()=>{if(!d)return;const r=J.value.trim(),g=Ue.checked;if(!r){alert("⚠️لطفاً نام دسته‌بندی را وارد کنید.");return}const f=d.categories.find(E=>E.name.toLowerCase()===r.toLowerCase());if(f)if(f.isDeleted){const E=d.categories.findIndex(B=>B===f);E>-1&&d.categories.splice(E,1)}else{alert("⚠️این دسته‌بندی از قبل وجود دارد.");return}const y=new we(r,"",g);d.categories.push(y),w(),_(d.info.name,`دسته‌بندی جدید «${r}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),Xe(),J.value="",Ue.checked=!1}),J.addEventListener("keyup",r=>{r.key==="Enter"&&j.click()}),k.addEventListener("click",()=>{if(!Rt){alert("❌خطایی رخ داده است. لطفاً فایل را دوباره انتخاب کنید."),T("settings-page");return}const r=parseInt(b.value,10),y=Rt.split(`
`).slice(1).map(E=>{var S;return(S=E.split(",")[r])==null?void 0:S.trim()}).filter(E=>E&&E.length>0);y.length>0?(nt(y),In(),T("csv-preview-page")):alert("هیچ نامی در ستون انتخاب شده پیدا نشد. لطفاً ستون دیگری را امتحان کنید یا فایل خود را بررسی کنید."),kt(null)}),u.addEventListener("click",()=>{v.click()}),v.addEventListener("change",r=>{const g=r.target.files[0];if(!g)return;const f=new FileReader;f.onload=y=>{const E=y.target.result;kt(E);const S=E.split(`
`)[0].split(",");Js(S),T("column-mapping-page")},f.readAsText(g),r.target.value=null}),M.addEventListener("click",()=>{kt(null),T("settings-page")}),p.addEventListener("click",()=>{const r=m.querySelectorAll('input[type="checkbox"]:checked');let g=!1;r.forEach(f=>{const y=f.dataset.name,E=d.students.find(S=>S.identity.name.toLowerCase()===y.toLowerCase());if(E)if(E.isDeleted)mt(E,d);else{console.log(`دانش‌آموز «${y}» به دلیل تکراری بودن اضافه نشد.`);return}const B=new wt({name:y});d.addStudent(B),d.sessions.length>0&&(U(d.sessions).filter(S=>S.isFinished&&!S.isCancelled).forEach(S=>{S.setAttendance(B.identity.studentId,"absent")}),Kn(B,d),g=!0)}),w(),_(d.info.name,`${r.length} دانش‌آموز جدید از لیست ورودی به کلاس اضافه شدند.`,{type:"VIEW_SESSIONS"}),Ne(),g&&Qn(r.length),T("settings-page"),l.value="",nt([])}),I.addEventListener("click",()=>{nt([]),T("settings-page")}),c.addEventListener("click",()=>{const r=l.value.trim();if(!r){alert("کادر متنی خالی است. لطفاً اسامی را وارد کنید.");return}const g=r.split(`
`).map(f=>f.trim()).filter(f=>f.length>0);g.length>0?(nt(g),In(),T("csv-preview-page")):alert("هیچ نام معتبری برای ورود پیدا نشد.")}),s.addEventListener("keyup",r=>{r.key==="Enter"&&i.click()}),i.addEventListener("click",()=>{if(!d)return;const r=s.value.trim();if(!r){alert("لطفاً نام دانش‌آموز را وارد کنید.");return}const g=d.students.find(y=>y.identity.name.toLowerCase()===r.toLowerCase());if(g)if(g.isDeleted)mt(g,d);else{alert("❌دانش‌آموزی با این نام از قبل در این کلاس وجود دارد.");return}const f=new wt({name:r});d.addStudent(f),d.sessions.length>0&&(U(d.sessions).filter(y=>y.isFinished&&!y.isCancelled).forEach(y=>{y.setAttendance(f.identity.studentId,"absent")}),Kn(f,d),Qn(1)),w(),_(d.info.name,`دانش‌آموز «${r}» به کلاس اضافه شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:f.identity.studentId}),Ne(),ne(),s.value="",s.focus()}),a.addEventListener("click",()=>{se(),T("session-page")}),document.getElementById("new-session-btn").addEventListener("click",()=>{if(d){const r=d.sessions.find(f=>!f.isFinished&&!f.isCancelled&&!f.isDeleted);if(r){C(`⚠️ جلسه ${r.sessionNumber} هنوز تمام نشده است. لطفاً ابتدا با دکمه ✅ آن را خاتمه دهید.`);return}const g=()=>{const f=y=>{const E=d.startNewSession();ft(E),ce(E),d.students.forEach(x=>{Sn.setAttendance(x.identity.studentId,"present")}),w();const S=ye(d).get(E.sessionNumber);_(d.info.name,`جلسه ${S} شروع شد.`,{type:"VIEW_SESSIONS"}),gt(y?"attendance":"selector")};G("آیا تمایل به انجام فرآیند حضور و غیاب دارید؟",()=>f(!0),{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success",onCancel:()=>f(!1)})};d.hasSessionToday()?G("شما امروز یک جلسه برای این کلاس ثبت کرده‌اید. آیا از شروع یک جلسه جدید دیگر مطمئن هستید؟",g,{confirmText:"بله",confirmClass:"btn-warning"}):g()}}),n.addEventListener("click",()=>{const r=t.value.trim(),g=document.querySelector('input[name="class-type"]:checked');if(!r&&!g){C("⚠️لطفاً نام و نوع کلاس را مشخص کنید.");return}if(!r){C("⚠️لطفاً نام کلاس را وارد کنید.");return}if(!g){C("⚠️لطفاً نوع کلاس را انتخاب کنید.");return}if(L[r]){L[r].isDeleted?C("⚠️ کلاسی با این نام در سطل زباله است. ابتدا آن را بازیابی کنید و یا آن را پاک کنید."):C("⚠️کلاسی با این نام از قبل وجود دارد.");return}const f=g.value,y=new an({name:r,type:f});L[r]=y,w(),_(r,`کلاس «${r}» ایجاد شد.`,{type:"VIEW_SESSIONS"}),ae(),C(`✅ کلاس «${r}» با موفقیت ایجاد شد.`),t.value="",g.checked=!1}),e.addEventListener("input",r=>{const g=r.target.value;if(g.length<2){Ot([]);return}const f=g.toLowerCase(),y=sn(f),E=[];for(const B in L){const S=L[B];if(S.isDeleted)continue;U(S.students).filter(W=>{const q=Se(W.identity.name.toLowerCase()),te=q.includes(Se(f)),et=q.includes(Se(y));return te||et}).forEach(W=>{E.push({student:W,classroom:S})})}Ot(E)}),t.addEventListener("keyup",r=>{r.key==="Enter"&&n.click()}),o.addEventListener("click",Ws),document.querySelectorAll(".back-to-classes-btn").forEach(r=>{r.addEventListener("click",()=>{X(null),ce(null),ft(null),T("class-management-page")})}),N.addEventListener("click",()=>{Wn("selector")}),ve.addEventListener("input",r=>{const g=r.target.value;if(!g){ot([]);return}const f=g.toLowerCase(),y=sn(f),B=U(d.students).filter(S=>{const x=Se(S.identity.name.toLowerCase()),W=x.includes(Se(f)),q=x.includes(Se(y));return W||q});ot(B)}),ve.addEventListener("focus",()=>{ve.value&&ot(ve.value)}),Re.addEventListener("click",()=>{const r=Ie.value,g=ge.value.trim();let f;if(Ut)f=Ut.student;else{const E=h==null?void 0:h.winnerHistory[pe];f=E==null?void 0:E.winner}if(!f){C("❌خطا: دانش‌آموز معتبری برای ثبت نمره یافت نشد.");return}const y=le;if(!f||!y){C("⚠️لطفاً ابتدا یک دانش‌آموز و یک دسته‌بندی را انتخاب کنید.");return}if(!r){C("⚠️لطفاً مقدار نمره را وارد کنید.");return}if(r>100||r<0){C("❌نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}f&&(f.addScore(y.name,parseFloat(r),g),_(d.info.name,`نمره ${r} در ${y.name} برای «${f.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:f.identity.studentId}),w(),ne(),C(`✅نمره برای ${f.identity.name} در مهارت ${y.name} ثبت شد.`),Ie.value="",ge.value="",fe(f,y.name))});const jn=r=>{r.key==="Enter"&&r.ctrlKey&&(r.preventDefault(),Re.click())};Ie.addEventListener("keydown",jn),ge.addEventListener("keydown",jn),oe.addEventListener("click",()=>{P()}),V.addEventListener("click",()=>{const r=A.value.trim();typeof Pt=="function"&&(Pt(r),Ye(),P())});const so=document.getElementById("move-student-confirm-btn"),oo=document.getElementById("move-student-cancel-btn"),ao=document.getElementById("move-student-class-select");oo.addEventListener("click",()=>{P()}),so.addEventListener("click",()=>{const r=ao.value,g=L[r],{studentToMove:f,sourceClassForMove:y}=vo;if(!f||!y||!g){C("خطایی رخ داد. لطفاً دوباره امتحان کنید⚠️.","error"),P();return}const E=rs(f,y,g);E.success?(_(y.info.name,`دانش‌آموز «${f.identity.name}» به کلاس «${r}» منتقل شد.`,{type:"VIEW_SESSIONS"}),_(r,`دانش‌آموز «${f.identity.name}» از کلاس «${y.info.name}» به این کلاس منتقل شد.`,{type:"VIEW_SESSIONS"}),w(),Ne(),C(`دانش‌آموز «${f.identity.name}» با موفقیت به کلاس «${r}» منتقل شد✅.`)):C(E.message,"error"),P()}),de.addEventListener("click",()=>{z.style.width="300px",ee.classList.add("modal-visible")}),ue.addEventListener("click",me),ee.addEventListener("click",me),no.addEventListener("click",()=>{yt(),T("trash-page"),me()}),document.getElementById("demo-mode-btn").addEventListener("click",()=>{Ee?Jn():(me(),G("شما در حال ورود به حالت نمایش (Demo) هستید. در این حالت، هیچ‌کدام از تغییرات شما ذخیره نخواهد شد. آیا ادامه می‌دهید؟",()=>{gs(),Ht(),me()},{confirmText:"تایید",confirmClass:"btn-warning",onCancel:me}))});const zn=document.getElementById("exit-demo-btn");zn&&zn.addEventListener("click",()=>{Ee&&Jn()}),vt.addEventListener("click",()=>{if(Ee){C("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است."),me();return}me(),ht()}),bt.addEventListener("click",()=>{if(Ee){C("⚠️ بازیابی اطلاعات در حالت نمایش (Demo) غیرفعال است."),me();return}Me.click(),me()}),Me.addEventListener("change",r=>{const g=r.target.files[0];if(!g)return;const f=new FileReader;f.onload=y=>{try{const E=JSON.parse(y.target.result);if(E.metadata&&E.data)_s(E);else{const B=E.classrooms||E,S=E.trashBin||[];G("آیا از بازیابی اطلاعات مطمئن هستید؟ تمام داده‌های فعلی شما بازنویسی خواهد شد.",()=>{_e(B),zt(S),at({lastRestoreTimestamp:new Date().toISOString()}),w(),ae(),T("class-management-page"),C("✅اطلاعات با موفقیت بازیابی شد.")},{confirmText:"بازیابی کن",confirmClass:"btn-warning"})}}catch(E){C("❌خطا در خواندن فایل. لطفاً فایل پشتیبان معتبر انتخاب کنید."),console.error("Restore error:",E)}},f.readAsText(g),r.target.value=null}),window.addEventListener("popstate",r=>{if(Te){P(null,!0);return}if(He(),r.state){const{pageId:g,currentClassName:f,selectedSessionNumber:y,selectedStudentId:E}=r.state;f&&(X(L[f]),y&&ce(d.getSession(y)),E&&re(d.students.find(B=>B.identity.studentId===E))),g==="session-page"?(se(),dt(g)):g==="student-profile-page"?(se(),T("session-page"),Z(D)):dt(g)}else X(null),ce(null),re(null),dt("class-management-page")}),document.addEventListener("keydown",r=>{var y;const g=document.activeElement;if(!["INPUT","TEXTAREA","SELECT"].includes(g.tagName)){if(r.key.toLowerCase()==="o"&&r.shiftKey&&ks.classList.contains("active")&&(r.preventDefault(),xs.click()),r.key==="Escape"){if(Ae.classList.contains("visible")){He();return}if(Te){P();return}switch((y=document.querySelector(".page.active"))==null?void 0:y.id){case"csv-preview-page":case"column-mapping-page":T("settings-page");break;case"student-profile-page":re(null),T(h?"student-page":"session-page");break;case"attendance-page":T("student-page");break;case"student-page":ce(null),se(),T("session-page");break;case"settings-page":case"session-page":X(null),T("class-management-page");break}return}if(h){const E=r.key.toLowerCase();switch(" ascfg".includes(E)&&r.preventDefault(),E){case" ":Q.click();break;case"a":$.classList.contains("active")?history.back():(Ye(),T("attendance-page"));break;case"s":document.getElementById("session-page").classList.contains("active")?history.back():a.click();break;case"c":document.querySelector(".back-to-classes-btn").click();break;case"f":const B=document.querySelector(".action-column .search-icon");B&&B.click();break;case"g":if(studentProfilePage.classList.contains("active"))history.back();else{const S=h.lastSelectedWinnerId;if(S){const x=d.students.find(W=>W.identity.studentId===S);x&&(re(x),(void 0)(),T("student-profile-page"))}else C("⚠️ابتدا یک نفر را انتخاب کنید تا پروفایل او نمایش داده شود.")}break;case"arrowleft":{const S=document.querySelector('button[title="برنده قبلی"]');S&&!S.disabled&&(r.preventDefault(),S.click());break}case"arrowright":{const S=document.querySelector('button[title="برنده بعدی"]');S&&!S.disabled&&(r.preventDefault(),S.click());break}}}}});function me(){z.style.width="0",ee.classList.add("modal-closing"),setTimeout(()=>{ee.classList.remove("modal-visible","modal-closing")},300)}function Jn(){G("آیا از خروج از حالت نمایش (Demo) مطمئن هستید؟ با خروج، تمام تغییرات آزمایشی شما حذف شده و داده‌های اصلی شما بازیابی خواهند شد.",()=>{hs(),X(null),ce(null),re(null),ae(),T("class-management-page"),Ht(),me()},{confirmText:"خروج",confirmClass:"btn-success"})}Gn(".global-search-container .animated-search-container",Ot),Gn(".action-column-header .animated-search-container",ot),[H,$s,ge,Bs].forEach(r=>{r&&Gs(r)});function Kn(r,g){const f=U(g.students).filter(F=>F.identity.studentId!==r.identity.studentId);if(f.length===0)return;const y=f.reduce((F,Y)=>Y.statusCounters.totalSelections>F.statusCounters.totalSelections?Y:F,f[0]);if(!y||y.statusCounters.totalSelections===0)return;r.categoryCounts=JSON.parse(JSON.stringify(y.categoryCounts)),r.statusCounters.totalSelections=y.statusCounters.totalSelections;const E=f.reduce((F,Y)=>F+Y.statusCounters.totalSelections,0),B=f.reduce((F,Y)=>F+(Y.statusCounters.missedChances||0),0),S=E>0?B/E:0;r.statusCounters.missedChances=Math.round(r.statusCounters.totalSelections*S);const x=U(g.categories),W={};x.forEach(F=>{const Y=f.reduce((tn,nn)=>tn+(nn.categoryCounts[F.name]||0),0),en=f.reduce((tn,nn)=>tn+(nn.categoryIssues[F.name]||0),0);W[F.name]=Y>0?en/Y:0}),x.forEach(F=>{const Y=r.categoryCounts[F.name]||0,en=W[F.name]||0;r.categoryIssues[F.name]=Math.round(Y*en)});const q=g.liveSession;q?r.onboardingSession=q.sessionNumber:r.onboardingSession=g.sessions.length+1;const te=U(g.sessions).filter(F=>F.isFinished&&!F.isCancelled),et="📝 یادداشت خودکار سیستم",go=`این دانش‌آموز  از جلسه شماره ${te.length} به کلاس اضافه شد. آمار مشارکت او بر اساس فعال‌ترین دانش‌آموز و آمار «فرصت از دست رفته» او بر اساس میانگین کلاس ثبت گردید:`,qe=[];r.statusCounters.totalSelections>0&&qe.push(`کل انتخاب‌ها: ${r.statusCounters.totalSelections}`),r.statusCounters.missedChances>0&&qe.push(`فرصت‌های از دست رفته: ${r.statusCounters.missedChances}`);for(const F in r.categoryCounts){const Y=r.categoryCounts[F];Y>0&&qe.push(`انتخاب در «${F}»: ${Y}`)}for(const F in r.categoryIssues){const Y=r.categoryIssues[F];Y>0&&qe.push(`مشکل در «${F}»: ${Y}`)}if(qe.length>0){const F=`${et}
${go}

- ${qe.join(`
- `)}`;r.addNote(F)}}function Qn(r){const f=`چون این کلاس جلسات برگزار شده دارد، برای ${r>1?"دانش‌آموزان جدید":"دانش‌آموز جدید"} آمار پایه‌ای (متناسب با سایر دانش‌آموزان) ثبت شد تا در فرایند انتخاب اختلالی ایجاد نشود.`;G(f,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}const io="9.1.0";document.getElementById("app-version").textContent=`نسخه ${io}`;function co(){console.log("Starting universal backfill for writing scores...");let r=0;for(const g in L){const f=L[g];if(f.isDeleted)continue;let y=0;U(f.students).forEach(B=>{const S=B.logs.scores;if(!(S&&S.writing&&S.writing.length>0)){let W=-1;for(const q in S)q!=="writing"&&S[q].forEach(te=>{te.value>W&&(W=te.value)});if(W>-1){const q=`Automatically assigned based on the highest score (${W}) from other skills.`;B.addScore("Writing",W,q),y++}}}),y>0&&(console.log(`Updated ${y} student(s) in class: ${f.info.name}.`),r+=y)}r>0?(w(),console.log(`Update complete. A total of ${r} student(s) were updated across all classes. Data saved.`),document.getElementById("student-page").classList.contains("active")&&ne()):console.log("No students needed updating in any class.")}window.backfillWritingScoresForAll=co;function lo(){console.log("Starting backfill for 'outOfClassCount' and 'wasOutOfClass' properties...");let r=0,g=0;const f=localStorage.getItem("teacherAssistantData_v2");if(!f){console.log("No data found in localStorage. Nothing to do.");return}const y=JSON.parse(f);for(const E in y){const B=y[E];B.students&&B.students.forEach(S=>{S.statusCounters&&typeof S.statusCounters.outOfClassCount>"u"&&(S.statusCounters.outOfClassCount=0,r++)}),B.sessions&&B.sessions.forEach(S=>{if(S.studentRecords)for(const x in S.studentRecords){const W=S.studentRecords[x];typeof W.wasOutOfClass>"u"&&(W.wasOutOfClass=!1,g++)}})}localStorage.setItem("teacherAssistantData_v2",JSON.stringify(y)),console.log(`Backfill complete. Updated ${r} students and ${g} session records. Data saved.`),qt(),d&&ne()}window.backfillExitCounters=lo;function ro(){console.log("🧹 Starting orphaned data cleanup...");let r=0;for(const g in L){const f=L[g];if(f.isDeleted)continue;let y=!1;const E=new Set(f.students.filter(x=>!x.isDeleted).map(x=>x.identity.studentId)),B=new Map(f.students.map(x=>[x.identity.studentId,x.identity.name])),S=[];f.sessions.forEach(x=>{if(x.isDeleted)return;const W=[];for(const q in x.studentRecords)if(!E.has(q)){const te=B.get(q)||"Unknown/Deleted";W.push(`  - Removed student record for: ${te} (ID: ${q})`),delete x.studentRecords[q],r++,y=!0}for(const q in x.lastWinnerByCategory){const te=x.lastWinnerByCategory[q];if(!E.has(te)){const et=B.get(te)||"Unknown/Deleted";W.push(`  - Removed '${q}' last winner: ${et} (ID: ${te})`),delete x.lastWinnerByCategory[q],r++,y=!0}}if(x.lastSelectedWinnerId&&!E.has(x.lastSelectedWinnerId)){const q=x.lastSelectedWinnerId,te=B.get(q)||"Unknown/Deleted";W.push(`  - Cleared 'lastSelectedWinnerId': ${te} (ID: ${q})`),x.lastSelectedWinnerId=null,r++,y=!0}if(W.length>0){const te=ye(f).get(x.sessionNumber)||`(#${x.sessionNumber})`;S.push({sessionDisplayNumber:te,logs:W})}}),y&&(console.group(`➡️ Class: ${g}`),S.forEach(x=>{console.groupCollapsed(`  Session ${x.sessionDisplayNumber}`),x.logs.forEach(W=>console.warn(W)),console.groupEnd()}),console.groupEnd())}r>0?(w(),console.log(`✅ Cleanup complete! Found and removed ${r} orphaned references. Data saved.`)):console.log("✅ No orphaned data found. Your data is clean!")}window.cleanupOrphanedData=ro;function uo(r){if(!r||!r.classroomName)return;const g=L[r.classroomName];if(!g){C("⚠️ کلاس مربوط به این گزارش یافت نشد.");return}X(g),P(),setTimeout(()=>{switch(r.type){case"VIEW_STUDENT_PROFILE":{const f=g.students.find(y=>y.identity.studentId===r.studentId);f?Z(f):C("⚠️ دانش‌آموز مورد نظر یافت نشد.");break}case"VIEW_TRASH":yt(),T("trash-page");break;case"VIEW_SESSIONS":se(),T("session-page");break;case"VIEW_CLASS_NOTE":Fn(g);break;case"VIEW_CLASS_SETTINGS":Un(g);break}},300)}Ys.addEventListener("click",()=>{Us()}),Xs.addEventListener("click",()=>{P()}),Zs.addEventListener("click",()=>{const r=eo.value.trim(),g=to.checked;if(!r){An.style.display==="flex"?G("کادر یادداشت خالی است. آیا مطمئنید که می‌خواهید یادداشت‌های قبلی دانش‌آموزان انتخاب‌شده را پاک کنید؟",()=>{P(),vn("",!1)},{confirmText:"پاک کردن",confirmClass:"btn-warning"}):C("⚠️ لطفاً متن یادداشت را وارد کنید.");return}P(()=>{vn(r,g)})});const $e=document.getElementById("screen-saver-overlay"),Yn=document.getElementById("screen-saver-toggle");let Zt;const mo=2*60*1e3,Xn=["mousemove","keypress","scroll","click","touchstart"];function fo(){$e.classList.add("visible")}function Zn(){$e.classList.contains("visible")&&$e.classList.remove("visible")}function St(){Zn(),clearTimeout(Zt),Zt=setTimeout(fo,mo)}function Lt(r){r.preventDefault(),r.stopPropagation(),setTimeout(St,0)}function es(){St(),Xn.forEach(g=>window.addEventListener(g,St)),$e.addEventListener("click",Lt),$e.addEventListener("touchstart",Lt);const r="9.1.0";{const g=document.getElementById("screen-saver-version");g&&(g.textContent=`v${r}`)}}function po(){clearTimeout(Zt),Zn(),Xn.forEach(r=>window.removeEventListener(r,St)),$e.removeEventListener("click",Lt),$e.removeEventListener("touchstart",Lt)}Yn.checked=he.isScreenSaverEnabled,he.isScreenSaverEnabled&&es(),Yn.addEventListener("change",r=>{r.target.checked?(at({isScreenSaverEnabled:!0}),es()):(me(),r.preventDefault(),G(`نکته:
محافظ صفحه در تلفن های همراه جدید کمک می کند که دستگاه باطری کمتری مصرف کند و به دلیل ثابت ماندن صفحه نمایش در گوشی های قدیمی تر، صفحه نمایش دچار ماندگی رد پیکسل نگردد. آیا مطمئن هستید که می خواهید این ویژگی را غیر فعال کنید؟`,()=>{r.target.checked=!1,at({isScreenSaverEnabled:!1}),po(),C("توصیه می شود زمان خاموش شدن صفحه نمایش گوشی خود را به حداقل دو دقیقه تغییر دهید تا در استفاده های طولانی مدت صفحه نمایش گوشی اصطحلاک کمتری را تجربه کند",7e3)},{confirmText:"بله، غیرفعال کن",cancelText:"لغو",onCancel:()=>{r.target.checked=!0}}))})});function Pa(e,t){if(!h||h.isFinished){C("⚠️ امکان لغو انتخاب در جلسه خاتمه یافته وجود ندارد.");return}const n=h.winnerHistory;if(!(pe===n.length-1)||n.length===0){C("⚠️ فقط آخرین انتخاب قابل لغو است.");return}if(n[n.length-1].winner.identity.studentId!==e.identity.studentId){console.error("Undo mismatch!");return}G(`آیا از لغو انتخاب «${e.identity.name}» برای «${t}» مطمئن هستید؟ آمار این انتخاب بازگردانی خواهد شد.`,()=>{const a=h.winnerHistory,s=a.pop();if(!s)return;const i=s.winner,l=s.categoryName,c=i.identity.studentId;i.statusCounters.totalSelections=Math.max(0,i.statusCounters.totalSelections-1),i.categoryCounts[l]&&(i.categoryCounts[l]=Math.max(0,i.categoryCounts[l]-1));const m=h.studentRecords[c];m&&m.selections[l]&&(m.selections[l]=Math.max(0,m.selections[l]-1));let p=null;for(let I=a.length-1;I>=0;I--)if(a[I].categoryName===l){p=a[I].winner.identity.studentId;break}p?h.lastWinnerByCategory[l]=p:delete h.lastWinnerByCategory[l],De(a.length-1),ne(),fe(),w(),C(`✅ انتخاب «${i.identity.name}» لغو شد.`)},{confirmText:"لغو انتخاب",confirmClass:"btn-warning"})}
