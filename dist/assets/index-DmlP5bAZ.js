(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function n(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(a){if(a.ep)return;a.ep=!0;const o=n(a);fetch(a.href,o)}})();class st{constructor(t){this.identity={name:t.name,studentId:t.studentId||`id_${new Date().getTime()}_${Math.random()}`,branchName:t.branchName||null,ageGroup:t.ageGroup||"adult",level:t.level||null,contact:{social:t.socialContact||null,parent:t.parentContact||null}},this.isDeleted=!1,this.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0,outOfClassCount:0},this.categoryCounts={},this.categoryIssues={},this.logs={parentContacts:[],scores:{},discipline:{},sessionHistory:{}},this.profile={notes:[],tags:[]},this.finalClassActivityScore=null}addScore(t,n,s){if(n>100||n<0){console.log("نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}const a=t.toLowerCase();this.logs.scores[a]||(this.logs.scores[a]=[]);const o=new Bs(t,n,s);this.logs.scores[a].push(o)}addNote(t,n=null){const s=new Ts(t,n);this.profile.notes.push(s)}getOverallAverageScore(){let t=0,n=0;for(const a in this.logs.scores)this.logs.scores[a].forEach(o=>{o.isDeleted||(t+=o.value,n++)});if(n===0)return null;const s=t/n;return Math.round(s*100)/100}}class Bs{constructor(t,n,s=""){this.id=`score_${new Date().getTime()}`,this.skill=t,this.value=n,this.timestamp=new Date,this.comment=s,this.isDeleted=!1}}class Ts{constructor(t,n=null){this.id=`note_${new Date().getTime()}`,this.timestamp=new Date,this.content=t,this.isDeleted=!1,this.source=n}}class Mt{constructor(t="complete",n=""){this.status=t,this.comment=n,this.timestamp=new Date}}class In{constructor(t){this.sessionNumber=t,this.startTime=new Date,this.note="",this.isDeleted=!1,this.endTime=null,this.isFinished=!1,this.isMakeup=!1,this.isCancelled=!1,this.studentRecords={},this.lastWinnerByCategory={},this.lastUsedCategoryId=null,this.lastSelectedWinnerId=null,this.winnerHistory=[]}end(){this.isFinished=!0,this.endTime=new Date}markAsMakeup(){this.isMakeup=!this.isMakeup}initializeStudentRecord(t){this.studentRecords[t]||(this.studentRecords[t]={attendance:"present",homework:new Mt,selections:{},hadIssue:!1,wasOutOfClass:!1})}setAttendance(t,n){this.initializeStudentRecord(t),this.studentRecords[t].attendance=n}setHomeworkStatus(t,n){this.initializeStudentRecord(t),this.studentRecords[t].homework.status=n}selectNextWinner(t,n,s){if(!n||n.length===0)return console.log("هیچ دانش‌آموزی در کلاس برای انتخاب وجود ندارد."),null;const a=this.lastWinnerByCategory[t];let o=n.filter(r=>r.identity.studentId!==a);if(o.length===0&&(o=n),o.length===0)return null;const c=(r,f)=>r.categoryCounts[f]||0,u=Math.min(...o.map(r=>c(r,t))),d=o.filter(r=>c(r,t)===u);let y;if(d.length===1)y=d[0];else if(d.length>1){const r=s.filter(k=>!k.isDeleted&&k.name!==t).map(k=>k.name),f=d.map(k=>{const M=r.reduce((R,T)=>R+c(k,T),0);return{student:k,otherCategoriesTotal:M}}),b=Math.min(...f.map(k=>k.otherCategoriesTotal)),I=f.filter(k=>k.otherCategoriesTotal===b).map(k=>k.student);I.length===1?y=I[0]:y=I[Math.floor(Math.random()*I.length)]}else y=o[Math.floor(Math.random()*o.length)];const v=y.identity.studentId;this.initializeStudentRecord(v);const S=(this.studentRecords[v].selections[t]||0)+1;return this.studentRecords[v].selections[t]=S,y.statusCounters.totalSelections++,y.categoryCounts[t]=(y.categoryCounts[t]||0)+1,this.lastWinnerByCategory[t]=v,y}}class $t{constructor(t){this.info={name:t.name||"NotNamed",scheduleCode:t.scheduleCode||`code_${new Date().getTime()}`,teacherName:t.teacherName||null,type:t.type||"in-person",term:t.term||null,scheduleText:t.scheduleText||null,level:t.level||null,creationDate:t.creationDate?new Date(t.creationDate):new Date},this.students=[],this.sessions=[],this.note="",this.isDeleted=!1,this.categories=[new be("Vocabulary","Questions about words and meanings."),new be("Grammar","Questions about sentence structure and rules."),new be("Listening",void 0,!0),new be("Speaking",void 0,!0),new be("Reading",void 0,!0),new be("Writing",void 0,!0)],this.futurePlans={}}addStudent(t){this.students.push(t)}removeStudent(t){this.students=this.students.filter(n=>n.identity.studentId!==t)}startNewSession(){const t=this.sessions.length+1,n=new In(t);return this.sessions.push(n),n}endSpecificSession(t){const n=this.getSession(t);return n&&!n.isFinished?(n.end(),!0):!1}getSession(t){return this.sessions.find(n=>n.sessionNumber===t)}markAsMakeup(t){const n=this.getSession(t);n&&n.markAsMakeup()}planForSession(t,n){this.futurePlans[t]=n}hasSessionToday(){const t=new Date().toDateString();return this.sessions.some(n=>!n.isDeleted&&n.startTime.toDateString()===t)}selectNextWinner(t,n){return n?n.selectNextWinner(t,this.students,this.categories):null}get liveSession(){for(let t=this.sessions.length-1;t>=0;t--)if(!this.sessions[t].isFinished)return this.sessions[t];return null}endLiveSession(){const t=this.liveSession;return t?(t.end(),!0):!1}calculateFinalStudentScore(t){const n=t.logs.scores,s=["reading","writing"];for(const r of s)if(!n[r]||n[r].length===0)return null;const a=n.listening&&n.listening.length>0,o=n.speaking&&n.speaking.length>0;if(!a&&!o)return null;const c=r=>n[r].reduce((b,I)=>b+I.value,0)/n[r].length;let u;a&&o?u=(c("listening")+c("speaking"))/2:a?u=c("listening"):u=c("speaking");const d=c("reading"),y=c("writing"),S=(u*3+d*2+y*1)/6;return Math.trunc(S*10)/10}assignAllFinalScores(){let t=0,n=[];console.log("شروع عملیات محاسبه نمره نهایی برای تمام دانش‌آموزان..."),this.students.forEach(a=>{const o=this.calculateFinalStudentScore(a);o!==null?(a.finalClassActivityScore=o,t++):(a.finalClassActivityScore=null,n.push(a.identity.name))});const s=n.length;console.log(`عملیات پایان یافت. تعداد نمرات موفق: ${t} | تعداد ناموفق (نمرات ناقص): ${s}`),s>0&&(console.log("اسامی دانش‌آموزانی که نمراتشان ناقص است:"),n.forEach(a=>console.log(`- ${a}`)))}}class be{constructor(t,n="",s=!1){this.id=`cat_${new Date().getTime()}_${Math.random()}`,this.name=t,this.description=n,this.isDeleted=!1,this.isGradedCategory=s,this.isDeleted=!1}}let w={},l=null,jt=null,h=null,O=null,ze=null,wt=null,Jt=[],pt=null,zt=null,le=null,gt=0,Kt=0,ht=0,Qt=0,Xt=null,Yt=null,yt=null,Ie=null,ue=-1,Ct=null,vt=null,Sn=null,Ln=null,fe=!1,$=[];function B(){if(fe)return;const e={classrooms:w,trashBin:$};localStorage.setItem("teacherAssistantData_v2",JSON.stringify(e))}function kn(){const t=JSON.stringify({classrooms:w,trashBin:$},null,2),s=`SP-${new Date().toLocaleDateString("fa-IR-u-nu-latn").replace(/\//g,"-")}.txt`;return new File([t],s,{type:"text/plain"})}function Et(){const e=localStorage.getItem("teacherAssistantData_v2");if(!e)return;const t=JSON.parse(e);t.classrooms?(Ke(t.classrooms),$=t.trashBin||[]):(Ke(t),Ds())}function Ds(){const e=[];Object.values(w).forEach(t=>{t.isDeleted?e.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:t.info.creationDate,type:"classroom",description:`کلاس «${t.info.name}»`,restoreData:{name:t.info.name}}):t.students.forEach(n=>{n.isDeleted&&e.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:n.identity.studentId.split("_")[1],type:"student",description:`دانش‌آموز «${n.identity.name}»`,restoreData:{studentId:n.identity.studentId,classroomName:t.info.name}})})}),$.length===0&&e.length>0&&($=e,console.log(`Migrated ${e.length} previously deleted item(s) to the new trash bin.`),B())}function Ke(e){w={};for(const t in e){const n=e[t],s=new $t(n.info);s.isDeleted=n.isDeleted,s.note=n.note||"",s.students=n.students.map(a=>{const o=new st(a.identity);return o.isDeleted=a.isDeleted,o.statusCounters=a.statusCounters,o.logs=a.logs,o.logs.scores||(o.logs.scores={}),o.profile=a.profile,o.finalClassActivityScore=a.finalClassActivityScore,o.categoryCounts=a.categoryCounts||{},o.categoryIssues=a.categoryIssues||{},o}),s.sessions=n.sessions.map(a=>{const o=new In(a.sessionNumber);o.isDeleted=a.isDeleted,o.note=a.note||"",o.startTime=new Date(a.startTime),o.endTime=a.endTime?new Date(a.endTime):null,o.isFinished=a.isFinished,o.isMakeup=a.isMakeup,o.isCancelled=a.isCancelled||!1,o.studentRecords=a.studentRecords;for(const u in o.studentRecords){const d=o.studentRecords[u];d.homework&&!(d.homework instanceof Mt)&&(o.studentRecords[u].homework=new Mt(d.homework.status,d.homework.comment))}o.lastWinnerByCategory=a.lastWinnerByCategory,o.lastUsedCategoryId=a.lastUsedCategoryId,o.lastSelectedWinnerId=a.lastSelectedWinnerId;const c=a.winnerHistory||[];return o.winnerHistory=c.map(u=>({winner:s.students.find(y=>y.identity.studentId===u.winner.identity.studentId),categoryName:u.categoryName})),o}),s.categories=n.categories.map(a=>{const o=new be(a.name,a.description,a.isGradedCategory);return o.id=a.id,o.isDeleted=a.isDeleted,o}),s.futurePlans=n.futurePlans,w[t]=s}}function wn(e,t){if(w[t])return{success:!1,message:"کلاسی با این نام از قبل وجود دارد."};const n=w[e];return n?(n.info.name=t,w[t]=n,delete w[e],l===n&&z(n),{success:!0}):{success:!1,message:"کلاس مورد نظر یافت نشد."}}function Nn(e,t,n){if(q(n.students).some(c=>c.identity.name.toLowerCase()===e.identity.name.toLowerCase()))return{success:!1,message:`دانش‌آموزی با نام «${e.identity.name}» از قبل در کلاس «${n.info.name}» وجود دارد.`};const a=JSON.parse(JSON.stringify(e));n.addStudent(a);const o=t.students.find(c=>c.identity.studentId===e.identity.studentId);return o&&(o.isDeleted=!0),{success:!0}}function z(e){l=e}function Qe(e){jt=e}function Q(e){h=e}function G(e){O=e}function bt(e){ze=e}function Bn(e){wt=e}function Ue(e){Jt=e}function at(e){pt=e}function Tn(e){zt=e}function Zt(e){le=e}function ot(e){gt=e}function Dn(e){Kt=e}function it(e){ht=e}function xn(e){Qt=e}function en(e){Xt=e}function tn(e){Yt=e}function Xe(e){yt=e}function nn(e){Ie=e}function It(e){vt=e}function Mn(e){Sn=e}function $n(e){Ln=e}function xs(e){$=e}function On(){for(const e in w){const t=w[e];t.students.forEach(n=>{n.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0},n.categoryCounts={},n.categoryIssues={},t.sessions.forEach(s=>{const a=n.identity.studentId;s.studentRecords[a]&&(s.studentRecords[a].attendance="present")})})}B()}function q(e){return Array.isArray(e)?e.filter(t=>!t.isDeleted):[]}function ve(e){const t=new Map;return e&&q(e.sessions).filter(s=>!s.isCancelled).sort((s,a)=>s.sessionNumber-a.sessionNumber).forEach((s,a)=>{t.set(s.sessionNumber,a+1)}),t}function Be(e){ue=e}function pe(e){Ct=e}function St(e,t){if(!e||!t)return;const n=e.identity.studentId,s=t.students.findIndex(a=>a.identity.studentId===n);s>-1&&t.students.splice(s,1),t.sessions.forEach(a=>{a.studentRecords[n]&&delete a.studentRecords[n]})}function An(e,t){const n=w[e];if(!n)return;const s=n.sessions.findIndex(a=>a.sessionNumber===t);s>-1&&n.sessions.splice(s,1)}function Hn(e,t){const n=w[e];if(!n)return;const s=n.categories.findIndex(u=>u.id===t);if(s===-1)return;const o=n.categories[s].name,c=o.toLowerCase();n.students.forEach(u=>{u.categoryCounts&&delete u.categoryCounts[o],u.categoryIssues&&delete u.categoryIssues[o],u.logs.scores&&delete u.logs.scores[c]}),n.categories.splice(s,1)}function Rn(e,t,n,s){const a=w[e];if(!a)return;const o=a.students.find(d=>d.identity.studentId===t);if(!o||!o.logs.scores[n.toLowerCase()])return;const c=o.logs.scores[n.toLowerCase()],u=c.findIndex(d=>d.id===s);u>-1&&c.splice(u,1)}function _n(e,t,n){const s=w[e];if(!s)return;const a=s.students.find(c=>c.identity.studentId===t);if(!a||!a.profile.notes)return;const o=a.profile.notes.findIndex(c=>c.id===n);o>-1&&a.profile.notes.splice(o,1)}function Pn(){JSON.parse(JSON.stringify({classrooms:w,trashBin:$})),fe=!0}function Wn(){fe=!1,Et()}const Ms=Object.freeze(Object.defineProperty({__proto__:null,get activeModal(){return Ie},get cancelCallback(){return Yt},get classrooms(){return w},get confirmCallback(){return Xt},get currentClassroom(){return l},get easterEggClickCount(){return gt},get easterEggLastClickTime(){return Kt},enterDemoMode:Pn,exitDemoMode:Wn,getActiveItems:q,getSessionDisplayMap:ve,get importedFileContent(){return pt},get isDemoMode(){return fe},get liveSession(){return jt},loadData:Et,get manualSelection(){return vt},moveStudent:Nn,get namesToImport(){return Jt},get notificationTimeout(){return zt},permanentlyDeleteCategory:Hn,permanentlyDeleteNote:_n,permanentlyDeleteScore:Rn,permanentlyDeleteSession:An,permanentlyDeleteStudent:St,prepareBackupData:kn,get previousState(){return ze},rehydrateData:Ke,renameClassroom:wn,resetAllStudentCounters:On,get resetEasterEggClickCount(){return ht},get resetEasterEggLastClickTime(){return Qt},saveData:B,get saveNoteCallback(){return Ct},get secureConfirmCallback(){return yt},get selectedCategory(){return le},get selectedSession(){return h},get selectedStudentForProfile(){return O},setActiveModal:nn,setCancelCallback:tn,setConfirmCallback:en,setCurrentClassroom:z,setEasterEggClickCount:ot,setEasterEggLastClickTime:Dn,setImportedFileContent:at,setLiveSession:Qe,setManualSelection:It,setNamesToImport:Ue,setNotificationTimeout:Tn,setPreviousState:bt,setResetEasterEggClickCount:it,setResetEasterEggLastClickTime:xn,setSaveNoteCallback:pe,setSecureConfirmCallback:Xe,setSelectedCategory:Zt,setSelectedSession:Q,setSelectedStudentForProfile:G,setSourceClassForMove:$n,setStudentToMove:Mn,setTrashBin:xs,setUndoTimeout:Bn,setWinnerHistoryIndex:Be,get sourceClassForMove(){return Ln},get studentToMove(){return Sn},get trashBin(){return $},get undoTimeout(){return wt},get winnerHistoryIndex(){return ue}},Symbol.toStringTag,{value:"Module"}));function $e(e){return typeof e!="string"?"":e.replace(/ي/g,"ی").replace(/ك/g,"ک")}function Ye(e){return typeof e!="string"||e.length===0?"ltr":/[\u0590-\u07FF]/.test(e)?"rtl":"ltr"}function Fn(e){return!e||!e.trim()?"":e.split(`
`).map(s=>`<div dir="${Ye(s)}">${s||"&nbsp;"}</div>`).join("")}function En(e){if(typeof e!="string")return"";const t={q:"ض",w:"ص",e:"ث",r:"ق",t:"ف",y:"غ",u:"ع",i:"ه",o:"خ",p:"ح","[":"ج","]":"چ",a:"ش",s:"س",d:"ی",f:"ب",g:"ل",h:"ا",j:"ت",k:"ن",l:"م",";":"ک","'":"گ",z:"ظ",x:"ط",c:"ز",v:"ر",b:"ذ",n:"د",m:"پ",",":"و"};let n="";for(let s=0;s<e.length;s++){const a=e[s].toLowerCase();n+=t[a]||e[s]}return n}const qn="teacherAssistantLogs_v2",$s=100;function sn(){try{const e=localStorage.getItem(qn);return e?JSON.parse(e):{}}catch(e){return console.error("Error reading logs from localStorage:",e),{}}}function Un(e){try{localStorage.setItem(qn,JSON.stringify(e))}catch(t){console.error("Error saving logs to localStorage:",t)}}function F(e,t,n=null){if(!e)return;const s=sn();s[e]||(s[e]=[]);const a={timestamp:new Date().toISOString(),message:t,action:n,classroomName:e};s[e].unshift(a),s[e].length>$s&&s[e].pop(),Un(s)}function Os(e){return sn()[e]||[]}function As(e,t){const n=sn();n[e]&&!n[t]&&(n[t]=n[e],delete n[e],Un(n))}const Vn=document.getElementById("class-management-page"),Hs=document.getElementById("new-class-name"),Rs=document.getElementById("add-class-btn"),Ot=document.getElementById("class-list"),Lt=document.getElementById("undo-toast"),Gn=document.getElementById("undo-message"),_s=document.getElementById("undo-btn"),Ps=document.getElementById("settings-page"),an=document.getElementById("settings-class-name-header"),At=document.getElementById("settings-student-list"),Ht=document.getElementById("category-list"),Ws=document.getElementById("back-to-sessions-btn"),Fs=document.getElementById("new-student-name"),qs=document.getElementById("add-student-btn"),jn=document.getElementById("paste-area"),Us=document.getElementById("process-paste-btn"),Vs=document.getElementById("csv-preview-page"),Rt=document.getElementById("csv-preview-list"),Gs=document.getElementById("csv-confirm-btn"),js=document.getElementById("csv-cancel-btn"),Js=document.getElementById("import-csv-btn"),zs=document.getElementById("csv-file-input"),Ks=document.getElementById("column-mapping-page"),_t=document.getElementById("column-select-dropdown"),Qs=document.getElementById("confirm-column-btn"),Xs=document.getElementById("cancel-import-btn"),Ys=document.getElementById("new-category-name"),Zs=document.getElementById("add-category-btn"),Pt=document.querySelector(".app-header"),Se=document.getElementById("select-student-btn"),Ze=document.getElementById("select-student-btn-wrapper"),ea=document.getElementById("attendance-page"),ct=document.getElementById("attendance-list"),ta=document.getElementById("finish-attendance-btn"),na=document.getElementById("back-to-sessions-from-attendance-btn"),sa=document.getElementById("back-to-attendance-btn"),aa=document.querySelector("#class-management-page h2"),Wt=document.getElementById("student-stats-header"),oa=document.getElementById("hamburger-menu-btn"),ia=document.getElementById("side-nav-menu"),ca=document.getElementById("close-nav-btn"),ra=document.getElementById("overlay"),la=document.getElementById("backup-data-btn"),da=document.getElementById("restore-data-btn"),Jn=document.getElementById("restore-file-input"),ua=document.getElementById("custom-confirm-modal"),zn=document.getElementById("confirm-modal-message"),Ft=document.getElementById("confirm-modal-cancel-btn"),Ve=document.getElementById("confirm-modal-confirm-btn"),ma=document.getElementById("secure-confirm-modal"),Kn=document.getElementById("secure-confirm-message"),Qn=document.getElementById("secure-confirm-code"),Oe=document.getElementById("secure-confirm-input"),fa=document.getElementById("secure-confirm-cancel-btn"),rt=document.getElementById("secure-confirm-confirm-btn"),pa=document.getElementById("add-note-modal"),H=document.getElementById("new-note-content"),ga=document.getElementById("class-save-note-btn"),ha=document.getElementById("cancel-note-btn"),qt=document.getElementById("student-search-input"),Ee=document.getElementById("student-search-results"),ya=document.getElementById("student-profile-page"),Xn=document.getElementById("profile-student-name-header"),Ca=document.getElementById("back-to-student-page-btn"),Ae=document.getElementById("graded-category-pills-container"),Ut=document.getElementById("new-score-value"),on=document.getElementById("new-score-comment"),va=document.getElementById("add-score-btn"),Ge=document.getElementById("profile-stats-summary"),lt=document.getElementById("profile-scores-list"),dt=document.getElementById("global-student-search-input"),he=document.getElementById("global-student-search-results"),Ea=document.getElementById("is-graded-checkbox"),ba=document.getElementById("trashed-classes-list"),Ia=document.getElementById("trashed-students-list"),Sa=document.getElementById("trashed-sessions-list"),La=document.getElementById("trashed-categories-list"),ka=document.getElementById("trashed-notes-list"),wa=document.getElementById("trashed-scores-list"),kt=document.getElementById("quick-grade-form-wrapper"),ye=document.getElementById("quick-score-input"),me=document.getElementById("quick-note-textarea"),_e=document.getElementById("quick-grade-submit-btn"),cn=document.getElementById("category-selection-container"),Yn=document.getElementById("selected-student-result"),Te=document.getElementById("custom-context-menu"),He=document.getElementById("breadcrumb-container");function Na(e){clearTimeout(wt),ze||bt(JSON.stringify(w)),Gn.textContent=e,Lt.classList.add("show"),Bn(setTimeout(()=>{Lt.classList.remove("show"),bt(null)},5e3))}function Zn(){if(ze){const e=l?l.info.name:null,t=JSON.parse(ze);Ke(t),e&&w[e]?z(w[e]):z(null),l?(Ce(),Pe(),J()):ae(),Lt.classList.remove("show"),clearTimeout(wt),bt(null)}}function C(e,t=3e3){const n=document.getElementById("notification-toast");n&&(n.textContent=e,n.classList.add("show"),clearTimeout(zt),Tn(setTimeout(()=>{n.classList.remove("show")},t)))}function V(e,t,n={}){const{confirmText:s="تایید",cancelText:a="لغو",confirmClass:o="btn-success",onCancel:c=()=>{},isDelete:u=!1}=n,d=u?()=>es(e,t):t;zn.textContent=e,Ve.textContent=s,Ft.textContent=a,Ve.className="modal-action-btn",Ve.classList.add(o),en(d),tn(c);const y=Ve.parentElement;Ft.style.display=c===null?"none":"inline-block",y.style.justifyContent=c===null?"center":"space-between",te("custom-confirm-modal")}function es(e,t){const n=Math.floor(1e4+Math.random()*9e4).toString();Kn.textContent=e,Qn.textContent=n,Oe.value="",rt.disabled=!0,Xe(t),te("secure-confirm-modal"),Oe.focus();const s=()=>{Oe.value===n?rt.disabled=!1:rt.disabled=!0};return Oe.addEventListener("input",s),()=>{Oe.removeEventListener("input",s)}}function ts(e,t){const n=Object.values(w).filter(c=>!c.isDeleted&&c.info.name!==t.info.name),s=document.getElementById("move-student-modal-title"),a=document.getElementById("move-student-class-select"),o=document.getElementById("move-student-confirm-btn");s.textContent=`انتقال دانش‌آموز: ${e.identity.name}`,a.innerHTML="",n.length===0?(a.innerHTML='<option value="">کلاس دیگری برای انتقال وجود ندارد</option>',o.disabled=!0):(n.forEach(c=>{const u=document.createElement("option");u.value=c.info.name,u.textContent=c.info.name,a.appendChild(u)}),o.disabled=!1),Mn(e),$n(t),te("move-student-modal")}function rn(e,t){if(!e||!t)return;const n=e.identity.name,s=document.getElementById("add-note-modal-title");s.textContent="تغییر نام دانش‌آموز",H.value=n,H.rows=1,H.dispatchEvent(new Event("input",{bubbles:!0})),pe(a=>{const o=a.trim();o&&o!==n&&(q(t.students).some(u=>u.identity.studentId!==e.identity.studentId&&u.identity.name.toLowerCase()===o.toLowerCase())?C("دانش‌آموزی با این نام از قبل در این کلاس وجود دارد."):(e.identity.name=o,F(t.info.name,`نام دانش‌آموز «${n}» به «${o}» تغییر یافت.`,{type:"VIEW_STUDENT_PROFILE",studentId:e.identity.studentId}),B(),Ce(),de(),O&&O.identity.studentId===e.identity.studentId&&X(),C(`✅نام دانش‌آموز به «${o}» تغییر یافت.`))),s.textContent="ثبت یادداشت جدید",H.rows=4}),te("add-note-modal"),H.focus(),H.select()}function te(e){const t=document.getElementById(e);if(t){if(Ie)return;t.classList.add("modal-visible"),nn(e),history.pushState(null,"",location.href)}}function ee(e){if(!Ie)return;const t=document.getElementById(Ie),n=Ie;nn(null),history.back(),t&&(t.classList.add("modal-closing"),setTimeout(()=>{t.classList.remove("modal-visible"),t.classList.remove("modal-closing"),n==="custom-confirm-modal"&&(en(null),tn(null)),n==="secure-confirm-modal"&&Xe(null),n==="add-note-modal"&&pe(null),typeof e=="function"&&e()},300))}function ln(e){H.value=e.note||"",pe(t=>{e.note=t,B(),F(e.info.name,"یادداشت کلاس ذخیره شد.",{type:"VIEW_CLASS_NOTE"}),ae(),C("✅ یادداشت کلاس ذخیره شد.")}),te("add-note-modal"),H.focus()}function dn(e){z(e),an.textContent=`تنظیمات کلاس: ${e.info.name}`,Ce(),Pe(),L("settings-page")}function ns(e){const t=document.getElementById("log-modal-title"),n=document.getElementById("log-list");t.textContent=`گزارش فعالیت‌های کلاس: ${e}`,n.innerHTML="";const s=Os(e);s.length===0?n.innerHTML='<li class="no-content-message">هنوز فعالیتی برای این کلاس ثبت نشده است.</li>':s.forEach(a=>{const o=document.createElement("li");o.className="log-entry";const c=new Date(a.timestamp),u=`${c.toLocaleDateString("fa-IR")} - ${c.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}`,d=document.createElement("span");d.className="log-timestamp",d.textContent=u;const y=document.createElement("span");y.className="log-message",y.textContent=a.message,a.action&&(y.classList.add("log-action-link"),y.dataset.action=JSON.stringify({...a.action,classroomName:a.classroomName})),o.appendChild(d),o.appendChild(y),n.appendChild(o)}),te("log-modal")}document.getElementById("log-modal-close-btn").addEventListener("click",()=>{ee()});function Vt(e){const t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download=e.name,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t)}async function un(){const e=kn();if(("ontouchstart"in window||navigator.maxTouchPoints>0)&&navigator.share&&navigator.canShare&&navigator.canShare({files:[e]}))try{await navigator.share({title:"پشتیبان دستیار معلم",text:"فایل پشتیبان داده‌های برنامه",files:[e]})}catch(n){n.name!=="AbortError"&&(console.error("Error sharing file:",n),Vt(e),C("⚠️اشتراک‌گذاری با خطا مواجه شد. فایل در حال دانلود است."))}else Vt(e),C("✅پشتیبان‌گیری با موفقیت انجام شد.")}function Nt(e,t){e.preventDefault(),we(),setTimeout(()=>{const n=Te,s=n.querySelector("ul");s.innerHTML="",t.forEach(v=>{const S=document.createElement("li");v.isSeparator?S.className="separator":(S.innerHTML=`
                    <span class="icon">${v.icon||""}</span>
                    <span class="label">${v.label}</span>
                `,v.className&&S.classList.add(v.className),S.addEventListener("click",()=>{v.action(),we()})),s.appendChild(S)});const{clientX:a,clientY:o}=e,{innerWidth:c,innerHeight:u}=window;n.style.top=`${o}px`,n.style.left=`${a}px`,n.classList.add("visible");const{offsetWidth:d,offsetHeight:y}=n;a+d>c&&(n.style.left=`${c-d-5}px`),o+y>u&&(n.style.top=`${u-y-5}px`)},50)}function we(){Te.classList.contains("visible")&&Te.classList.remove("visible")}function ss(){var t,n;He.innerHTML="";const e=[];if(e.push({label:"کلاس‌ها",handler:()=>{z(null),Q(null),G(null),L("class-management-page")}}),l){if(e.push({label:l.info.name,handler:()=>{Q(null),G(null),J(),L("session-page")}}),((t=document.querySelector(".page.active"))==null?void 0:t.id)==="settings-page")e.push({label:"تنظیمات"});else if(h){const o=ve(l).get(h.sessionNumber)||` (#${h.sessionNumber})`;e.push({label:`جلسه ${o}`,handler:()=>{G(null),L("student-page")}});const c=(n=document.querySelector(".page.active"))==null?void 0:n.id;O?e.push({label:`پروفایل: ${O.identity.name}`}):c==="attendance-page"&&e.push({label:"حضور و غیاب"})}}if(e.length<=1){He.style.display="none";return}He.style.display="flex",e.forEach((s,a)=>{const o=document.createElement("a");if(o.textContent=s.label,o.className="breadcrumb-item",a===e.length-1||!s.handler?o.classList.add("active"):o.addEventListener("click",s.handler),He.appendChild(o),a<e.length-1){const c=document.createElement("span");c.className="breadcrumb-separator",c.textContent="/",He.appendChild(c)}})}function bn(e,t,n){n.innerHTML="";const s=l.sessions.filter(a=>{var o;return!a.isDeleted&&!a.isCancelled&&((o=a.studentRecords[e.identity.studentId])==null?void 0:o.attendance)==="absent"}).map(a=>({number:t.get(a.sessionNumber),isMakeup:a.isMakeup})).filter(a=>a.number!==void 0);s.length>0?(n.appendChild(document.createTextNode("جلسات غایب: ")),s.forEach((a,o)=>{const c=document.createElement("span");c.textContent=a.number,a.isMakeup&&c.classList.add("makeup-absence"),n.appendChild(c),o<s.length-1&&n.appendChild(document.createTextNode("، "))})):n.textContent="جلسات غایب: بدون غیبت"}function ut(e,t,n,s={}){const{includePrefix:a=!0}=s;n.innerHTML="";const o=l.sessions.filter(c=>{if(c.isDeleted||c.isCancelled)return!1;const u=c.studentRecords[e.identity.studentId];return u&&u.homework&&(u.homework.status==="incomplete"||u.homework.status==="none")}).map(c=>({number:t.get(c.sessionNumber),status:c.studentRecords[e.identity.studentId].homework.status})).filter(c=>c.number!==void 0);o.length>0?(a&&n.appendChild(document.createTextNode("تکالیف ناقص: ")),o.forEach((c,u)=>{const d=document.createElement("span");d.textContent=c.number,c.status==="incomplete"&&d.classList.add("incomplete-homework"),n.appendChild(d),u<o.length-1&&n.appendChild(document.createTextNode("،"))})):a?n.textContent="تکالیف ناقص: ندارد":n.textContent="ندارد"}function Ba(e,t){var k,M,R;const n=document.createElement("li");n.className="attendance-list-item";const s={none:"بدون تکلیف",complete:"تکلیف کامل",incomplete:"تکلیف ناقص"},a=document.createElement("div");a.className="student-info";const o=document.createElement("span");o.className="student-name",o.textContent=e.identity.name,o.addEventListener("click",()=>{G(e),X(),L("student-profile-page")});const c=document.createElement("span");c.className="absence-info";const u=document.createElement("span");u.className="homework-info",bn(e,t,c),ut(e,t,u),a.appendChild(o),a.appendChild(c),a.appendChild(u);const d=document.createElement("div");d.className="homework-controls";const y=document.createElement("button"),v=((k=h.studentRecords[e.identity.studentId])==null?void 0:k.homework.status)||"none";y.className=`homework-status-btn ${v}`,y.title=s[v],y.addEventListener("click",()=>{const T=h.studentRecords[e.identity.studentId].homework,_={none:"incomplete",incomplete:"complete",complete:"none"}[T.status];y.title=s[_],h.setHomeworkStatus(e.identity.studentId,_),B(),y.className=`homework-status-btn ${_}`,ut(e,t,u)});const S=document.createElement("button");S.className="btn-icon",S.innerHTML="📝",S.title="افزودن یادداشت برای تکلیف",((M=h.studentRecords[e.identity.studentId])==null?void 0:M.homework.comment)||(S.style.opacity="0.3"),S.addEventListener("click",()=>{const T=h.studentRecords[e.identity.studentId].homework;H.value=T.comment||"",H.dispatchEvent(new Event("input",{bubbles:!0})),pe(A=>{T.comment=A;const _=ve(l),oe=_.get(h.sessionNumber),Y={type:"fromAttendance",sessionNumber:h.sessionNumber},ge=`یادداشت حضور-غیاب ${oe}: `,j=e.profile.notes.find(ie=>!ie.isDeleted&&ie.source&&ie.source.type==="fromAttendance"&&ie.source.sessionNumber===Y.sessionNumber);j?A?j.content=ge+A:j.isDeleted=!0:A&&e.addNote(ge+A,Y),B(),F(l.info.name,`یادداشت تکلیف جلسه ${oe} برای دانش‌آموز «${e.identity.name}» ذخیره شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:e.identity.studentId}),C("✅یادداشت تکلیف ذخیره شد."),S.style.opacity=A?"1":"0.3",ut(e,_,u)}),te("add-note-modal"),H.focus()}),d.appendChild(y),d.appendChild(S);const f=document.createElement("button"),b=((R=h.studentRecords[e.identity.studentId])==null?void 0:R.attendance)||"present",I=T=>{T==="present"?(f.textContent="حاضر",f.className="attendance-status-btn present active"):(f.textContent="غایب",f.className="attendance-status-btn absent active")};return I(b),f.addEventListener("click",()=>{var _;const A=(((_=h.studentRecords[e.identity.studentId])==null?void 0:_.attendance)||"present")==="present"?"absent":"present";h.setAttendance(e.identity.studentId,A),A==="absent"&&(h.studentRecords[e.identity.studentId].hadIssue=!1),B(),I(A),bn(e,t,c),cs()}),n.appendChild(a),n.appendChild(d),n.appendChild(f),n}function Ta(){return ve(l).get(h.sessionNumber)}function Re(){if(!l||!h)return;const e=ve(l);Pa(),ct.innerHTML="";const t=document.createElement("li");t.className="attendance-list-header",t.innerHTML=`
    <span class="header-label-spacer"></span>
    <span class="header-label">تکلیف</span>
    <span class="header-label">حضور</span>
`,ct.appendChild(t),q(l.students).forEach(n=>{const s=Ba(n,e);ct.appendChild(s)}),Wa(),cs()}function de(){const e=document.getElementById("student-stats-table-container");if(!e||(e.innerHTML="",!l))return;q(l.students).length,Wt.textContent="آمار عملکرد";const t=["نام"],n=["کل انتخاب ها","غیبت","خروج","فرصت ازدست‌رفته","مشکل","میانگین","نمره کلاسی (کانون)"],s=l.categories.filter(f=>f.isGradedCategory&&!f.isDeleted).map(f=>f.name),a=[...t,...s,...n],o=document.createElement("table");o.className="student-stats-table";const u=o.createTHead().insertRow();a.forEach((f,b)=>{const I=document.createElement("th");b===0?(I.innerHTML=`${f} <span style="opacity: 0.6;">🔗</span>`,I.title="ردیف‌های این ستون قابل کلیک هستند"):I.textContent=f,u.appendChild(I)});const d=o.createTBody(),y=q(l.students),v=f=>{let b=0;return l.sessions.forEach(I=>{if(I.isDeleted||I.isCancelled)return;const k=I.studentRecords[f.identity.studentId];k&&k.attendance==="absent"&&b++}),b};y.forEach(f=>{const b=d.insertRow();if(b.dataset.studentId=f.identity.studentId,h){const A=h.studentRecords[f.identity.studentId];A&&A.attendance==="absent"&&b.classList.add("absent-row-highlight")}const I=b.insertCell(),k=document.createElement("span");k.textContent=f.identity.name,k.className="student-name-link",k.addEventListener("click",()=>{G(f),X(),L("student-profile-page")}),I.appendChild(k),s.forEach(A=>{var ge;const _=b.insertCell(),oe=A.toLowerCase(),Y=((ge=f.logs.scores[oe])==null?void 0:ge.filter(j=>!j.isDeleted))||[];Y.length>0?Y.forEach((j,ie)=>{const ne=document.createElement("span");ne.textContent=j.value,ne.style.position="relative",j.comment&&(ne.dataset.tooltip=j.comment),_.appendChild(ne),ie<Y.length-1&&_.appendChild(document.createTextNode(","))}):_.textContent="",_.style.cursor="pointer",_.addEventListener("click",()=>{Le(f,A);const j=document.getElementById("category-selection-container");j&&j.scrollIntoView({behavior:"smooth",block:"center"})})}),b.insertCell().textContent=f.statusCounters.totalSelections||0,b.insertCell().textContent=v(f),b.insertCell().textContent=f.statusCounters.outOfClassCount||0,b.insertCell().textContent=f.statusCounters.missedChances||0;const M=Object.values(f.categoryIssues||{}).reduce((A,_)=>A+_,0);b.insertCell().textContent=M;const R=f.getOverallAverageScore();b.insertCell().textContent=R!==null?R:"-";const T=l.calculateFinalStudentScore(f);b.insertCell().textContent=T!==null?T:"-"}),q(l.students),Wt.setAttribute("data-student-count",y.length),e.appendChild(o);const S=e.querySelector(".student-stats-table"),r=S==null?void 0:S.querySelector("thead th:first-child");r&&r.addEventListener("click",()=>{S.classList.toggle("name-column-expanded")})}function Le(e=null,t=null){const n=document.getElementById("selected-student-result");n.innerHTML="",n.classList.remove("absent");let s,a;if(e&&t)s=e,a=t,It({student:e,categoryName:t}),Be(-1);else{if(It(null),!h||ue<0||!h.winnerHistory[ue])return;const P=h.winnerHistory[ue];s=P.winner,a=P.categoryName}const o=document.querySelector(".current-winner-highlight");if(o&&o.classList.remove("current-winner-highlight"),s){const P=document.querySelector(`.student-stats-table tr[data-student-id="${s.identity.studentId}"]`);P&&P.classList.add("current-winner-highlight")}const c=l.categories.find(P=>P.name===a);if(c){Zt(c);const P=document.querySelectorAll("#category-selection-container .pill");P.forEach(K=>K.classList.remove("active"));const W=Array.from(P).find(K=>K.textContent===a);W&&W.classList.add("active"),os(c)}const u=h.studentRecords[s.identity.studentId],d=(u==null?void 0:u.attendance)==="absent",y=document.createElement("div");y.className="winner-name-container";const v=document.createElement("button");v.className="btn-icon",v.innerHTML="˅",v.title="برنده قبلی";const S=!e;v.classList.toggle("is-disabled",!S||ue<=0),v.addEventListener("click",()=>{v.classList.contains("is-disabled")?(v.classList.add("shake-animation"),setTimeout(()=>v.classList.remove("shake-animation"),200)):(Be(ue-1),Le())});const r=document.createElement("div");r.className="winner-name",r.innerHTML=`✨ <strong>${s.identity.name}</strong>✨`,r.classList.add("heartbeat-animation"),d&&(r.style.textDecoration="line-through",r.style.opacity="0.6",r.style.color="var(--color-secondary)"),(u==null?void 0:u.hadIssue)&&!d&&(r.style.color="var(--color-warning)",r.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"),(u==null?void 0:u.wasOutOfClass)&&!d&&(r.style.color="var(--color-strong-warning)",r.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود");const I=document.createElement("button");I.className="btn-icon",I.innerHTML="˄",I.title="برنده بعدی",I.classList.toggle("is-disabled",!S||ue>=h.winnerHistory.length-1),I.addEventListener("click",()=>{I.classList.contains("is-disabled")?(I.classList.add("shake-animation"),setTimeout(()=>I.classList.remove("shake-animation"),200)):(Be(ue+1),Le())}),y.appendChild(I),y.appendChild(r),y.appendChild(v),n.appendChild(y),Se.disabled=S&&!I.classList.contains("is-disabled");const k=document.createElement("div");k.className="status-button-container";const M=document.createElement("button");M.textContent="غایب",M.classList.add("status-button","absent-btn"),d&&M.classList.add("active");const R=document.createElement("button");R.textContent="مشکل",R.classList.add("status-button","issue-btn"),u!=null&&u.hadIssue&&R.classList.add("active");const T=document.createElement("button");T.textContent="خروج",T.classList.add("status-button","exit-btn"),u!=null&&u.wasOutOfClass&&T.classList.add("active");const A=document.createElement("button");A.textContent="پروفایل",A.className="status-button profile-btn",M.addEventListener("click",()=>{const P=M.classList.contains("active");T.classList.contains("active")&&(T.classList.remove("active"),u.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),P?(M.classList.remove("active"),h.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),r.style.textDecoration="",r.style.opacity="",r.style.color=""):(R.classList.contains("active")&&(R.classList.remove("active"),u.hadIssue=!1,s.statusCounters.otherIssues=Math.max(0,s.statusCounters.otherIssues-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),M.classList.add("active"),h.setAttendance(s.identity.studentId,"absent"),s.statusCounters.missedChances++,r.style.textDecoration="line-through",r.style.opacity="0.6",r.style.color="var(--color-secondary)",r.title=""),de(),B()}),R.addEventListener("click",()=>{const P=R.classList.contains("active");if(T.classList.contains("active")&&(T.classList.remove("active"),u.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),P){R.classList.remove("active"),u.hadIssue=!1;const W=le.name;s.categoryIssues[W]&&(s.categoryIssues[W]=Math.max(0,s.categoryIssues[W]-1)),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),r.style.color="",r.title=""}else{M.classList.contains("active")&&(M.classList.remove("active"),h.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),R.classList.add("active"),u.hadIssue=!0;const W=le.name;s.categoryIssues[W]=(s.categoryIssues[W]||0)+1,s.statusCounters.missedChances++,r.style.textDecoration="",r.style.opacity="",r.style.color="var(--color-warning)",r.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"}de(),B()}),T.addEventListener("click",()=>{if(T.classList.contains("active"))T.classList.remove("active"),u.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),r.style.color="",r.title="";else{if(M.classList.contains("active")&&(M.classList.remove("active"),h.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),R.classList.contains("active")){R.classList.remove("active"),u.hadIssue=!1;const W=le.name;s.categoryIssues[W]&&(s.categoryIssues[W]=Math.max(0,s.categoryIssues[W]-1)),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)}T.classList.add("active"),u.wasOutOfClass=!0,s.statusCounters.outOfClassCount=(s.statusCounters.outOfClassCount||0)+1,s.statusCounters.missedChances++,r.style.textDecoration="",r.style.opacity="",r.style.color="var(--color-strong-warning)",r.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود"}de(),B()}),A.addEventListener("click",()=>{G(s),X(),L("student-profile-page")}),k.appendChild(M),k.appendChild(T),k.appendChild(R),k.appendChild(A),n.appendChild(k);const _=document.createElement("div");_.className="student-details-container";const oe=document.createElement("div");oe.className="student-details-scores",oe.innerHTML="<h4>آخرین نمرات</h4>";const Y=document.createElement("ul");Y.className="scores-list";const ge=["Reading","Writing","Speaking","Listening"];let j=!1;const ie=s.logs.scores||{};ge.forEach(P=>{const W=document.createElement("li"),K=document.createElement("span");K.className="skill-name",K.textContent=`${P}:`;const ke=document.createElement("span");ke.className="skill-scores";const Bt=P.toLowerCase(),We=ie[Bt];We&&We.length>0?(j=!0,ke.textContent=We.slice(-3).map(Tt=>Tt.value).join(",")):ke.textContent="none",W.appendChild(K),W.appendChild(ke),Y.appendChild(W)}),!j&&Object.keys(ie).length===0&&(Y.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>'),oe.appendChild(Y),_.appendChild(oe);const ne=document.createElement("div");ne.className="student-details-notes",ne.innerHTML="<h4>یادداشت‌ها</h4>";const De=document.createElement("ul");De.className="notes-list",s.profile.notes&&s.profile.notes.length>0?[...s.profile.notes].sort((W,K)=>new Date(K.timestamp)-new Date(W.timestamp)).forEach(W=>{const K=document.createElement("li");K.dir=Ye(W.content),K.textContent=W.content,De.appendChild(K)}):De.innerHTML='<div class="no-content-message">یادداشتی وجود ندارد.</div>',ne.appendChild(De),_.appendChild(ne),n.appendChild(_)}function as(e){e.addEventListener("input",()=>{const t=e.value,n=Ye(t);e.setAttribute("dir",n)})}function Da(){cn.innerHTML="",Yn.innerHTML="",kt.classList.add("tooltip-container"),ye.disabled=!0,me.disabled=!0,_e.disabled=!0,ye.value="",me.value="",Ze.classList.add("disabled-wrapper"),Se.disabled=!0}function xa(){l.categories.filter(t=>!t.isDeleted).forEach(t=>{const n=document.createElement("span");n.className="pill",n.textContent=t.name,n.dataset.categoryId=t.id,t.description&&(n.dataset.tooltip=t.description),n.addEventListener("click",()=>{document.querySelectorAll(".pill").forEach(a=>a.classList.remove("active")),n.classList.add("active"),Zt(t),os(t),Ze.classList.remove("disabled-wrapper"),Se.disabled=!1;const s=h.lastWinnerByCategory[t.name];if(s){const a=l.students.find(o=>o.identity.studentId===s);a&&Le(a,t.name)}else{Yn.innerHTML="",It(null),Be(-1),Se.disabled=!1;const a=document.querySelector(".current-winner-highlight");a&&a.classList.remove("current-winner-highlight")}}),cn.appendChild(n)})}function Ma(){if(h.lastUsedCategoryId){const e=cn.querySelector(`.pill[data-category-id="${h.lastUsedCategoryId}"]`);e&&e.click()}h.winnerHistory&&h.winnerHistory.length>0&&(Be(h.winnerHistory.length-1),Le())}function os(e){e&&(e.isGradedCategory?(ye.disabled=!1,me.disabled=!1,_e.disabled=!1,kt.removeAttribute("data-tooltip")):(ye.disabled=!0,me.disabled=!0,_e.disabled=!0,kt.setAttribute("data-tooltip","برای این دسته‌بندی قابلیت نمره دهی تعریف نشده است")))}function Ne(){if(!l||!h){L("class-management-page");return}Da(),xa(),Ma(),L("student-page"),de()}function X(){if(!O)return;const e=O;Xn.textContent=`پروفایل: ${e.identity.name}`;const t=l.sessions.reduce((r,f)=>{const b=f.studentRecords[e.identity.studentId];return r+(b&&b.attendance==="absent"?1:0)},0),n=Object.values(e.categoryIssues||{}).reduce((r,f)=>r+f,0);Ge.innerHTML=`
    <p><strong>کل انتخاب:</strong> ${e.statusCounters.totalSelections}</p>
    <p><strong>غیبت:</strong> ${t}</p>
    <p><strong>فرصت از دست رفته:</strong> ${e.statusCounters.missedChances||0}</p>
    <p><strong>مشکل:</strong> ${n}</p>`;const s=q(l.categories),a=document.createElement("div");if(a.className="stats-breakdown",s.length>0){s.forEach(f=>{var M;const b=f.name,I=((M=e.categoryCounts)==null?void 0:M[b])||0,k=document.createElement("p");k.className="stats-breakdown-item",k.innerHTML=`<strong>${b}:</strong> ${I}`,a.appendChild(k)});const r=Ge.querySelector("p:first-child");r&&r.after(a)}const o=document.createElement("div");o.className="stats-breakdown",s.length>0&&(s.forEach(r=>{var k;const f=r.name,b=((k=e.categoryIssues)==null?void 0:k[f])||0,I=document.createElement("p");I.className="stats-breakdown-item",I.innerHTML=`<strong>${f}:</strong> ${b}`,o.appendChild(I)}),Ge.appendChild(o));const c=document.createElement("p"),u=document.createElement("strong");u.textContent="تکالیف ناقص:";const d=document.createElement("span");d.style.marginRight="5px";const y=ve(l);ut(e,y,d,{includePrefix:!1}),c.appendChild(u),c.appendChild(d),Ge.appendChild(c);const v=l.categories.filter(r=>r.isGradedCategory&&!r.isDeleted);Ae.innerHTML="",v.forEach(r=>{const f=document.createElement("span");f.className="pill",f.textContent=r.name,f.dataset.skillName=r.name,r.description&&(f.dataset.tooltip=r.description),Ae.appendChild(f),f.addEventListener("click",()=>{Ae.querySelectorAll(".pill").forEach(b=>b.classList.remove("active")),f.classList.add("active"),Ut.focus()})}),lt.innerHTML="";const S=[];for(const r in e.logs.scores)e.logs.scores[r].forEach(f=>{f.isDeleted||S.push(f)});S.sort((r,f)=>new Date(f.timestamp)-new Date(r.timestamp)),S.length===0?lt.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>':S.forEach(r=>{const f=document.createElement("li");f.className="score-history-item";const b=document.createElement("div");b.className="item-content";const I=document.createElement("div");if(I.className="score-info",I.innerHTML=`
        <span class="score-date">${new Date(r.timestamp).toLocaleDateString("fa-IR")}</span>
        <span class="score-value">نمره: <strong>${r.value}</strong></span>
        <span class="score-skill-badge">${r.skill}</span>
    `,b.appendChild(I),r.comment){const M=`توضیحات: ${r.comment}`,R=Ye(M);Ye(r.comment);const T=document.createElement("p");T.className="score-comment",T.dir=R,T.innerHTML=`<strong>توضیحات:</strong> <div>${Fn(r.comment)}</div>`,T.addEventListener("click",()=>{H.value=r.comment,H.dispatchEvent(new Event("input",{bubbles:!0})),pe(A=>{r.comment=A,B(),X(),C("✅ توضیحات نمره ویرایش شد.")}),te("add-note-modal"),H.focus()}),b.appendChild(T)}const k=document.createElement("button");k.className="btn-icon delete-item-btn",k.innerHTML="🗑️",k.title="حذف این نمره",k.addEventListener("click",()=>{V(`آیا از حذف نمره ${r.value} برای مهارت ${r.skill} مطمئن هستید؟`,()=>{const M={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"score",description:`نمره ${r.value} (${r.skill}) برای دانش‌آموز «${e.identity.name}»`,restoreData:{scoreId:r.id,skill:r.skill,studentId:e.identity.studentId,classroomName:l.info.name}};$.unshift(M),$.length>50&&$.pop(),r.isDeleted=!0,F(l.info.name,`نمره ${r.value} در ${r.skill} برای «${e.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),B(),X(),C("✅ نمره به سطل زباله منتقل شد.")},{confirmText:"تایید حذف",confirmClass:"btn-warning"})}),f.appendChild(b),f.appendChild(k),lt.appendChild(f)}),Ut.value="",on.value="",Ae.querySelector(".pill.active")&&Ae.querySelector(".pill.active").classList.remove("active"),et()}function et(){const e=document.getElementById("profile-notes-list");if(e.innerHTML="",!O||!O.profile.notes||O.profile.notes.length===0){e.innerHTML='<div class="no-content-message">هنوز یادداشتی ثبت نشده است.</div>';return}[...O.profile.notes].filter(n=>!n.isDeleted).sort((n,s)=>new Date(s.timestamp)-new Date(n.timestamp)).forEach(n=>{const s=document.createElement("li");s.className="note-history-item";const a=document.createElement("div");a.className="item-content";const o=document.createElement("div");o.className="note-info";const c=document.createElement("span");c.className="note-date",c.textContent=new Date(n.timestamp).toLocaleDateString("fa-IR");const u=document.createElement("button");u.className="btn-icon delete-item-btn",u.innerHTML="🗑️",u.title="حذف این یادداشت",u.addEventListener("click",()=>{V("آیا از حذف این یادداشت مطمئن هستید؟",()=>{const y={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"note",description:`یادداشت برای دانش‌آموز «${O.identity.name}»`,restoreData:{noteId:n.id,studentId:O.identity.studentId,classroomName:l.info.name}};$.unshift(y),$.length>50&&$.pop(),n.isDeleted=!0,F(l.info.name,`یادداشت دانش‌آموز «${O.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),B(),et(),C("✅ یادداشت به سطل زباله منتقل شد.")},{confirmText:"تایید حذف",confirmClass:"btn-warning"})}),o.appendChild(c),o.appendChild(u);const d=document.createElement("p");d.className="note-content",d.innerHTML=Fn(n.content),d.addEventListener("click",()=>{H.value=n.content,H.dispatchEvent(new Event("input",{bubbles:!0})),pe(y=>{n.content=y,B(),F(l.info.name,`یادداشت دانش‌آموز «${O.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:O.identity.studentId}),et(),C("✅یادداشت با موفقیت ویرایش شد.")}),te("add-note-modal"),H.focus()}),a.appendChild(o),a.appendChild(d),s.appendChild(a),e.appendChild(s)})}function is(e){_t.innerHTML="",e.forEach((t,n)=>{const s=document.createElement("option");s.value=n,s.textContent=t.trim(),_t.appendChild(s)})}function Gt(){Rt.innerHTML="",Jt.forEach(e=>{const t=document.createElement("li");t.className="preview-item";const n=document.createElement("input");n.type="checkbox",n.checked=!0,n.dataset.name=e;const s=document.createElement("label");s.textContent=e,t.appendChild(n),t.appendChild(s),Rt.appendChild(t)})}function $a(e){const t=document.createElement("div");t.className="list-item-buttons";const n=document.createElement("button");return n.className="btn-icon",n.innerHTML="📝",n.title="افزودن/ویرایش یادداشت کلاس",n.style.borderBottom="solid",e.note||(n.style.opacity="0.5",n.style.borderBottom="none"),n.addEventListener("click",s=>{s.stopPropagation(),ln(e)}),t.appendChild(n),t}function Oa(e){const t=document.createElement("div");t.style.flexGrow="1",t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="flex-start";const n=document.createElement("span");n.textContent=e.info.name,n.classList.add("class-name-display"),t.appendChild(n);const s=q(e.students).length,a=q(e.sessions).filter(d=>d.isFinished).length,o=document.createElement("div");o.classList.add("class-stats-row");const c=document.createElement("span");c.textContent=`${s} نفر`,c.classList.add("student-count-badge"),o.appendChild(c);const u=document.createElement("span");return u.textContent=`${a} جلسه`,u.classList.add("session-count-badge"),o.appendChild(u),t.appendChild(o),t.addEventListener("click",()=>{z(e),Q(null),Qe(l.liveSession),J(),L("session-page")}),t}function Aa(e){const t=document.createElement("li"),n=Oa(e);t.appendChild(n);const s=document.createElement("div");if(s.className="list-item-badges",e.liveSession&&!e.liveSession.isCancelled&&!e.liveSession.isDeleted){const c=document.createElement("span");c.className="warning-badge",c.textContent="جلسه باز",s.appendChild(c),t.classList.add("has-unfinished-session")}const a=document.createElement("span");a.className=`type-badge ${e.info.type}`,a.textContent=e.info.type==="online"?"آنلاین":"حضوری",a.title="نوع کلاس",s.appendChild(a),t.appendChild(s);const o=$a(e);return t.appendChild(o),t.addEventListener("contextmenu",c=>{Nt(c,[{label:"تنظیمات کلاس",icon:"⚙️",action:()=>{dn(e)}},{label:"گزارش فعالیت‌ها",icon:"📋",action:()=>{ns(e.info.name)}},{label:"تغییر نام",icon:"✏️",action:()=>{const d=e.info.name,y=document.getElementById("add-note-modal-title");y.textContent="تغییر نام کلاس",H.value=d,H.rows=1,pe(v=>{const S=v.trim();if(S&&S!==d){const r=wn(d,S);r.success?(As(d,S),F(S,`نام کلاس از «${d}» به «${S}» تغییر یافت.`,{type:"VIEW_SESSIONS"}),B(),ae(),C(`✅نام کلاس به «${S}» تغییر یافت.`)):C(r.message)}y.textContent="ثبت یادداشت جدید",H.rows=4}),te("add-note-modal"),H.focus(),H.select()}},{label:"حذف کلاس",icon:"🗑️",className:"danger",action:()=>{V(`آیا از انتقال کلاس «${e.info.name}» به سطل زباله مطمئن هستید؟`,()=>{const d={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"classroom",description:`کلاس «${e.info.name}»`,restoreData:{name:e.info.name}};$.unshift(d),$.length>50&&$.pop(),e.isDeleted=!0,B(),ae(),C(`✅ کلاس «${e.info.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}])}),t}function ae(){Ot.innerHTML="",Object.values(w).sort((t,n)=>new Date(t.info.creationDate)-new Date(n.info.creationDate)).forEach(t=>{if(t.isDeleted)return;const n=Aa(t);Ot.appendChild(n)})}function Ce(){At.innerHTML="",l&&q(l.students).forEach(e=>{const t=document.createElement("li"),n=document.createElement("span");n.textContent=e.identity.name,n.style.flexGrow="1",n.className="student-name-link",n.addEventListener("click",()=>{G(e),X(),L("student-profile-page")}),t.appendChild(n),t.addEventListener("contextmenu",s=>{Nt(s,[{label:"تغییر نام",icon:"✏️",action:()=>{rn(e,l)}},{label:"انتقال دانش‌آموز",icon:"➡️",action:()=>{ts(e,l)}},{label:"حذف دانش‌آموز",icon:"🗑️",className:"danger",action:()=>{V(`آیا از انتقال دانش‌آموز «${e.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const o={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${e.identity.name}» از کلاس «${l.info.name}»`,restoreData:{studentId:e.identity.studentId,classroomName:l.info.name}};$.unshift(o),$.length>50&&$.pop(),e.isDeleted=!0,F(l.info.name,`دانش‌آموز «${e.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),B(),Ce(),C(`✅ دانش‌آموز «${e.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}])}),At.appendChild(t)})}function Pe(){if(Ht.innerHTML="",!l)return;l.categories.filter(t=>!t.isDeleted).forEach(t=>{const n=document.createElement("li"),s=document.createElement("div");s.className="name-and-badge-container";const a=document.createElement("span");if(a.textContent=t.name,s.appendChild(a),t.isGradedCategory){const c=document.createElement("span");c.className="category-badge",c.textContent="قابل نمره‌دهی",s.appendChild(c)}const o=document.createElement("button");o.className="btn-icon",o.innerHTML="🗑️",o.style.color="var(--color-warning)",o.addEventListener("click",()=>{V(`آیا از انتقال دسته‌بندی «${t.name}» به سطل زباله مطمئن هستید؟`,()=>{const c={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${t.name}» از کلاس «${l.info.name}»`,restoreData:{categoryId:t.id,classroomName:l.info.name}};$.unshift(c),$.length>50&&$.pop(),t.isDeleted=!0,F(l.info.name,`دسته‌بندی «${t.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),B(),Pe(),C(`✅ دسته‌بندی «${t.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}),n.appendChild(s),n.appendChild(o),Ht.appendChild(n)})}function Je(e){document.querySelectorAll(".page").forEach(n=>{n.classList.remove("active")});const t=document.getElementById(e);t&&t.classList.add("active"),e==="class-management-page"?(ae(),Pt.style.display="flex"):Pt.style.display="none",ss()}function L(e){const t={pageId:e,currentClassName:l?l.info.name:null,selectedSessionNumber:h?h.sessionNumber:null,selectedStudentId:O?O.identity.studentId:null};let n=`#${e}`;const s=new URLSearchParams;l&&s.set("class",l.info.name),h&&s.set("session",h.sessionNumber),O&&s.set("student",O.identity.studentId);const a=s.toString();a&&(n+=`?${a}`),window.location.hash!==n&&history.pushState(t,"",n),Je(e)}function Ha(e,t){const n=document.createElement("div");n.className="list-item-buttons";const s=document.createElement("button");if(s.className="btn-icon",s.innerHTML="📝",s.title="افزودن/ویرایش یادداشت جلسه",s.style.borderBottom="solid",e.note||(s.style.opacity="0.5",s.style.borderBottom="none"),s.addEventListener("click",a=>{a.stopPropagation(),H.value=e.note||"",pe(o=>{e.note=o,B(),F(l.info.name,`یادداشت جلسه ${t} ذخیره شد.`,{type:"VIEW_SESSIONS"}),J(),C("✅یادداشت جلسه ذخیره شد.")}),te("add-note-modal"),H.focus()}),n.appendChild(s),!e.isFinished&&!e.isCancelled){const a=document.createElement("button");a.className="btn-icon",a.innerHTML="✅",a.title="خاتمه جلسه",a.addEventListener("click",o=>{o.stopPropagation(),V(`جلسه شماره ${t} خاتمه پیدا خواهد کرد!`,()=>{l.endSpecificSession(e.sessionNumber),B(),F(l.info.name,`جلسه ${t} خاتمه یافت.`,{type:"VIEW_SESSIONS"}),J(),V("جلسه با موفقیت خاتمه یافت. آیا مایل به ایجاد فایل پشتیبان هستید؟",()=>{if(fe){C("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است.");return}un(),C("✅فایل پشتیبان با موفقیت ایجاد شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}),n.appendChild(a)}return n}function Ra(e,t){const n=document.createElement("div");n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="flex-start",n.style.flexGrow="1";const s=new Date(e.startTime).toLocaleDateString("fa-IR"),a=document.createElement("span"),o=document.createElement("div");o.style.display="flex",o.style.gap="5px",o.style.marginTop="5px";const c=new Date(e.startTime).toLocaleDateString("fa-IR",{weekday:"long"}),u=document.createElement("span");if(u.className="type-badge day-badge",u.textContent=c,o.appendChild(u),e.isCancelled){a.textContent=`✅جلسه لغو شده - تاریخ: ${s}`,n.style.cursor="default";const d=document.createElement("span");d.className="type-badge cancelled-badge",d.textContent="لغو شده",o.appendChild(d)}else a.textContent=`جلسه ${t} - تاریخ: ${s}`,n.style.cursor="pointer",n.addEventListener("click",()=>{Q(e),Ne()});if(n.appendChild(a),e.isFinished){const d=document.createElement("span");d.className="type-badge",d.textContent="خاتمه یافته",d.style.backgroundColor="var(--color-secondary)",o.appendChild(d)}if(e.isMakeup){const d=document.createElement("span");d.className="type-badge",d.textContent="جبرانی",d.style.backgroundColor="var(--color-warning)",d.style.color="var(--color-text-dark)",o.appendChild(d)}return n.appendChild(o),n}function _a(e,t){const n=document.createElement("li"),s=t.get(e.sessionNumber),a=Ra(e,s);n.appendChild(a);const o=Ha(e,s);return n.appendChild(o),n.addEventListener("contextmenu",c=>{const u=[{label:e.isCancelled?"بازگردانی جلسه":"لغو جلسه",icon:"❌",action:()=>{const d=e.isCancelled?"بازگردانی جلسه":"لغو جلسه",y=e.isCancelled?"آیا از بازگردانی این جلسه مطمئن هستید؟":"آیا از لغو این جلسه مطمئن هستید؟ جلسه لغو شده در آمار تاثیری ندارد اما قابل بازگردانی است.";V(y,()=>{e.isCancelled=!e.isCancelled;const v=e.isCancelled?`جلسه ${s} لغو شد.`:`جلسه لغو شده (تاریخ: ${new Date(e.startTime).toLocaleDateString("fa-IR")}) بازگردانی شد.`;F(l.info.name,v,{type:"VIEW_SESSIONS"}),B(),J(),C(e.isCancelled?"✅جلسه لغو شد.":"✅جلسه بازگردانی شد.")},{confirmText:d,confirmClass:"btn-warning"})}},{label:"تغییر وضعیت جبرانی",icon:"🔄",action:()=>{l.markAsMakeup(e.sessionNumber),B();const d=e.isMakeup?`جلسه ${s} به عنوان جبرانی علامت‌گذاری شد.`:`جلسه ${s} از حالت جبرانی خارج شد.`;F(l.info.name,d,{type:"VIEW_SESSIONS"}),J()}},{label:"حذف جلسه",icon:"🗑️",className:"danger",action:()=>{const d=e.isCancelled?"لغو شده":s;V(`آیا از انتقال جلسه ${d} به سطل زباله مطمئن هستید؟`,()=>{const y={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"session",description:`جلسه ${d} از کلاس «${l.info.name}»`,restoreData:{sessionNumber:e.sessionNumber,classroomName:l.info.name}};$.unshift(y),$.length>50&&$.pop(),e.isDeleted=!0,F(l.info.name,`جلسه ${d} به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),B(),J(),C(`✅ جلسه ${d} به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}];Nt(c,u)}),n}function J(){const e=document.getElementById("session-list");if(!l)return;if(e.innerHTML="",l.sessions.length===0){e.innerHTML="<li>هنوز جلسه‌ای شروع نشده است.</li>";return}const t=ve(l);[...q(l.sessions)].reverse().forEach(s=>{const a=_a(s,t);e.appendChild(a)})}function je(e){if(Ee.innerHTML="",e.length>0)e.forEach(t=>{const n=document.createElement("div");n.textContent=t.identity.name,n.addEventListener("click",()=>{G(t),X(),L("student-profile-page"),Ee.style.display="none",qt.value=""}),Ee.appendChild(n)}),Ee.style.display="block";else if(qt.value.trim()!==""){const t=document.createElement("div");t.className="no-results",t.textContent="پیدا نشد",Ee.appendChild(t),Ee.style.display="block"}else Ee.style.display="none"}function mt(e){if(he.innerHTML="",e.length>0)e.forEach(t=>{const n=document.createElement("div");n.className="global-search-result";const s=document.createElement("span");s.className="student-name",s.textContent=t.student.identity.name;const a=document.createElement("span");a.className="class-name",a.textContent=`کلاس: ${t.classroom.info.name}`,n.addEventListener("click",()=>{z(t.classroom),G(t.student),X(),L("student-profile-page"),he.style.display="none",dt.value=""}),a.addEventListener("click",o=>{o.stopPropagation(),z(t.classroom),Q(null),Qe(t.classroom.liveSession),J(),L("session-page"),he.style.display="none",dt.value=""}),n.appendChild(s),n.appendChild(a),he.appendChild(n)}),he.style.display="block";else if(dt.value.trim()!==""){const t=document.createElement("div");t.className="no-results",t.textContent="پیدا نشد",he.appendChild(t),he.style.display="block"}else he.style.display="none"}function tt(){const e=document.getElementById("trashed-items-list");if(e.innerHTML="",$.length===0){e.innerHTML='<li style="text-align: center; padding: 20px;">سطل زباله خالی است.</li>';return}$.forEach((t,n)=>{const s=document.createElement("li"),a=document.createElement("span");a.textContent=t.description,a.style.flexGrow="1";const o=document.createElement("div");o.className="list-item-buttons";const c=document.createElement("button");c.className="btn-icon",c.innerHTML="🔄",c.title="بازیابی",c.addEventListener("click",()=>{var S;let d=!1,y=null;const v=t.restoreData;switch(t.type){case"classroom":{const r=w[v.name];r&&!r.isDeleted?y=`کلاسی با نام «${v.name}» از قبل فعال است.`:r&&r.isDeleted&&(r.isDeleted=!1,d=!0);break}case"student":{const r=w[v.classroomName],f=r==null?void 0:r.students.find(b=>b.identity.studentId===v.studentId);f&&(f.isDeleted=!1,d=!0);break}case"session":{const r=w[v.classroomName],f=r==null?void 0:r.sessions.find(b=>b.sessionNumber===v.sessionNumber);f&&(f.isDeleted=!1,d=!0);break}case"category":{const r=w[v.classroomName],f=r==null?void 0:r.categories.find(b=>b.id===v.categoryId);f&&(f.isDeleted=!1,d=!0);break}case"score":{const r=w[v.classroomName],f=r==null?void 0:r.students.find(I=>I.identity.studentId===v.studentId),b=(S=f==null?void 0:f.logs.scores[v.skill.toLowerCase()])==null?void 0:S.find(I=>I.id===v.scoreId);b&&(b.isDeleted=!1,d=!0);break}case"note":{const r=w[v.classroomName],f=r==null?void 0:r.students.find(I=>I.identity.studentId===v.studentId),b=f==null?void 0:f.profile.notes.find(I=>I.id===v.noteId);b&&(b.isDeleted=!1,d=!0);break}}d?($.splice(n,1),B(),tt(),t.type==="classroom"&&ae(),C("✅ آیتم با موفقیت بازیابی شد.")):C(y?`⚠️ ${y}`:"⚠️ آیتم اصلی برای بازیابی یافت نشد.")});const u=document.createElement("button");u.className="btn-icon",u.innerHTML="🔥",u.title="حذف دائمی",u.addEventListener("click",()=>{V("آیا از حذف دائمی این آیتم مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{const d=t.restoreData;switch(t.type){case"classroom":delete w[d.name];break;case"student":St({identity:{studentId:d.studentId}},w[d.classroomName]);break;case"session":An(d.classroomName,d.sessionNumber);break;case"category":Hn(d.classroomName,d.categoryId);break;case"score":Rn(d.classroomName,d.studentId,d.skill,d.scoreId);break;case"note":_n(d.classroomName,d.studentId,d.noteId);break}$.splice(n,1),B(),tt(),C("✅ آیتم برای همیشه حذف شد.")},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),o.appendChild(c),o.appendChild(u),s.appendChild(a),s.appendChild(o),e.appendChild(s)})}function Pa(){const e=document.getElementById("absentees-summary-container");e&&(e.innerHTML=`
        <div id="absentees-summary-box" class="absentees-summary">
            <div class="absentees-summary-header">
                <h4>لیست غایبین جلسه شماره <span id="absentee-summary-session-number"></span></h4>
                <button id="copy-absentees-btn" class="btn-icon" title="کپی لیست غایبین">📋</button>
            </div>
            <div id="absentees-summary-list" class="summary-list"></div>
        </div>
    `)}function cs(){const e=document.getElementById("absentees-summary-box"),t=document.getElementById("absentees-summary-list"),n=document.getElementById("absentee-summary-session-number");if(!e||!t||!n){console.error("Could not find all absentee summary elements.");return}if(!l||!h){e.classList.remove("visible");return}const s=q(l.students).filter(o=>{const c=h.studentRecords[o.identity.studentId];return c&&c.attendance==="absent"}),a=ve(l);n.textContent=a.get(h.sessionNumber),s.length>0?e.classList.add("visible"):e.classList.remove("visible"),t.innerHTML="",s.forEach(o=>{const u=(y=>l.sessions.reduce((v,S)=>{if(S.isDeleted||S.isCancelled)return v;const r=S.studentRecords[y.identity.studentId];return v+(r&&r.attendance==="absent"?1:0)},0))(o),d=document.createElement("span");d.className="summary-name",d.textContent=`${o.identity.name} (غیبت: ${u})`,d.addEventListener("click",()=>{d.classList.add("fading-out"),setTimeout(()=>{h.setAttendance(o.identity.studentId,"present"),B(),Re()},200)}),t.appendChild(d)})}function Wa(){const e=document.getElementById("copy-absentees-btn");if(!e){console.error("Could not find the copy absentees button to attach listener.");return}e.addEventListener("click",()=>{if(!l||!h)return;const t=q(l.students).filter(a=>{const o=h.studentRecords[a.identity.studentId];return o&&o.attendance==="absent"});if(t.length===0){C("⚠️لیست غایبین خالی است.");return}const n=a=>l.sessions.reduce((o,c)=>{if(c.isDeleted||c.isCancelled)return o;const u=c.studentRecords[a.identity.studentId];return o+(u&&u.attendance==="absent"?1:0)},0);let s=`لیست غایبین جلسه شماره ${Ta()}:

`;t.forEach(a=>{const o=n(a);s+=`- ${a.identity.name} (تعداد غیبت‌ها: ${o})
`}),navigator.clipboard.writeText(s).then(()=>{C("✅لیست غایبین با موفقیت کپی شد.")}).catch(a=>{console.error("Failed to copy text: ",a),C("❌خطا در کپی کردن لیست.")})})}function ft(){const e=document.getElementById("demo-mode-banner");e&&(fe?(e.classList.add("visible"),document.body.classList.add("demo-mode-active")):(e.classList.remove("visible"),document.body.classList.remove("demo-mode-active")))}const Fa=Object.freeze(Object.defineProperty({__proto__:null,_internalShowPage:Je,addCategoryBtn:Zs,addClassBtn:Rs,addNoteModal:pa,addScoreBtn:va,addStudentBtn:qs,appHeader:Pt,attendanceListUl:ct,attendancePage:ea,backToAttendanceBtn:sa,backToSessionsBtn:Ws,backToSessionsFromAttendanceBtn:na,backToStudentPageBtn:Ca,backupDataBtn:la,breadcrumbContainer:He,cancelImportBtn:Xs,cancelNoteBtn:ha,categoryListUl:Ht,classListHeader:aa,classListUl:Ot,classManagementPage:Vn,classSaveNoteBtn:ga,closeActiveModal:ee,closeContextMenu:we,closeNavBtn:ca,columnMappingPage:Ks,columnSelectDropdown:_t,confirmColumnBtn:Qs,confirmModalCancelBtn:Ft,confirmModalConfirmBtn:Ve,confirmModalMessage:zn,contextMenu:Te,csvCancelBtn:js,csvConfirmBtn:Gs,csvFileInput:zs,csvPreviewList:Rt,csvPreviewPage:Vs,customConfirmModal:ua,displayWinner:Le,finishAttendanceBtn:ta,globalStudentSearchInput:dt,globalStudentSearchResultsDiv:he,gradedCategoryPillsContainer:Ae,hamburgerMenuBtn:oa,handleUndo:Zn,importCsvBtn:Js,initiateBackupProcess:un,isGradedCheckbox:Ea,newCategoryNameInput:Ys,newClassNameInput:Hs,newNoteContent:H,newScoreCommentTextarea:on,newScoreValueInput:Ut,newStudentNameInput:Fs,openContextMenu:Nt,openModal:te,overlay:ra,pasteArea:jn,processPasteBtn:Us,profileScoresListUl:lt,profileStatsSummaryDiv:Ge,profileStudentNameHeader:Xn,quickGradeFormWrapper:kt,quickGradeSubmitBtn:_e,quickNoteTextarea:me,quickScoreInput:ye,renderAttendancePage:Re,renderBreadcrumbs:ss,renderClassList:ae,renderColumnSelector:is,renderGlobalSearchResults:mt,renderImportPreview:Gt,renderLogModal:ns,renderSearchResults:je,renderSessions:J,renderSettingsCategories:Pe,renderSettingsStudentList:Ce,renderStudentNotes:et,renderStudentPage:Ne,renderStudentProfilePage:X,renderStudentStatsList:de,renderTrashPage:tt,restoreDataBtn:da,restoreFileInput:Jn,secureConfirmCancelBtn:fa,secureConfirmCode:Qn,secureConfirmConfirmBtn:rt,secureConfirmInput:Oe,secureConfirmMessage:Kn,secureConfirmModal:ma,selectStudentBtn:Se,selectStudentBtnWrapper:Ze,setAutoDirectionOnInput:as,settingsClassNameHeader:an,settingsPage:Ps,settingsStudentListUl:At,showClassNoteModal:ln,showCustomConfirm:V,showMoveStudentModal:ts,showNotification:C,showPage:L,showRenameStudentModal:rn,showSecureConfirm:es,showSettingsPage:dn,showUndoToast:Na,sideNavMenu:ia,studentProfilePage:ya,studentSearchInput:qt,studentSearchResultsDiv:Ee,studentStatsHeader:Wt,trashedCategoriesList:La,trashedClassesList:ba,trashedNotesList:ka,trashedScoresList:wa,trashedSessionsList:Sa,trashedStudentsList:Ia,triggerFileDownload:Vt,undoBtn:_s,undoMessage:Gn,undoToast:Lt,updateDemoModeBanner:ft},Symbol.toStringTag,{value:"Module"}));function qa(){const e=window.location.hash;if(!e||e==="#")return!1;const[t,n]=e.split("?"),s=t.substring(1),a=new URLSearchParams(n),o=a.get("class"),c=parseInt(a.get("session"),10),u=a.get("student");if(o&&w[o])z(w[o]),c&&l.getSession(c)&&Q(l.getSession(c)),u&&l.students.find(d=>d.identity.studentId===u)&&G(l.students.find(d=>d.identity.studentId===u));else return!1;switch(s){case"session-page":J(),L("session-page");break;case"student-page":Ne();break;case"attendance-page":Re(),L("attendance-page");break;case"settings-page":an.textContent=`تنظیمات کلاس: ${l.info.name}`,Ce(),Pe(),L("settings-page");break;case"student-profile-page":X(),L("student-profile-page");break;default:return!1}return!0}document.addEventListener("DOMContentLoaded",()=>{const{globalStudentSearchInput:e,newClassNameInput:t,addClassBtn:n,undoBtn:s,backToSessionsBtn:a,newStudentNameInput:o,addStudentBtn:c,pasteArea:u,processPasteBtn:d,csvPreviewList:y,csvConfirmBtn:v,csvCancelBtn:S,importCsvBtn:r,csvFileInput:f,columnSelectDropdown:b,confirmColumnBtn:I,cancelImportBtn:k,newCategoryNameInput:M,addCategoryBtn:R,selectStudentBtn:T,attendancePage:A,finishAttendanceBtn:_,backToSessionsFromAttendanceBtn:oe,backToAttendanceBtn:Y,classListHeader:ge,studentStatsHeader:j,hamburgerMenuBtn:ie,sideNavMenu:ne,closeNavBtn:De,overlay:P,backupDataBtn:W,restoreDataBtn:K,restoreFileInput:ke,confirmModalCancelBtn:Bt,confirmModalConfirmBtn:We,secureConfirmCancelBtn:Tt,secureConfirmConfirmBtn:rs,newNoteContent:nt,classSaveNoteBtn:ls,cancelNoteBtn:ds,studentSearchInput:Fe,studentSearchResultsDiv:us,studentProfilePage:ms,profileStudentNameHeader:fs,backToStudentPageBtn:ps,gradedCategoryPillsContainer:gs,newScoreValueInput:hs,newScoreCommentTextarea:ys,addScoreBtn:Cs,isGradedCheckbox:mn}=Fa,vs=document.getElementById("trash-nav-btn");document.querySelector(".global-search-container .search-icon"),Et(),ft(),qa()||(ae(),L("class-management-page"));function fn(i,p){const m=document.querySelector(i);if(!m)return;const g=m.querySelector(".search-icon"),E=m.querySelector(".animated-search-input");!g||!E||(g.addEventListener("mousedown",D=>{D.preventDefault()}),g.addEventListener("click",()=>{m.classList.contains("search-active")||(m.classList.add("search-active"),E.focus())}),E.addEventListener("blur",()=>{setTimeout(()=>{m.classList.remove("search-active"),E.value="",p&&p([])},150)}))}window.addEventListener("scroll",we),document.addEventListener("click",i=>{Te.classList.contains("visible")&&!Te.contains(i.target)&&we(),Fe.contains(i.target)||(us.style.display="none");const p=i.target.closest(".log-action-link");if(p&&p.dataset.action)try{const m=JSON.parse(p.dataset.action);ws(m)}catch(m){console.error("Could not parse log action:",m)}}),Ze.addEventListener("click",()=>{(Ze.classList.contains("disabled-wrapper")||Se.disabled)&&(Se.classList.add("shake-animation"),setTimeout(()=>{Se.classList.remove("shake-animation")},200))}),j.addEventListener("click",()=>{const i=new Date().getTime();i-Qt>500?it(1):it(ht+1),xn(i),ht===5&&(it(0),V("آیا از صفر کردن تمام شمارنده‌های دانش‌آموزان مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{On(),de(),C("تمام آمارها صفر شدند ✅.")},{confirmText:"بله",confirmClass:"btn-warning"}))}),ge.addEventListener("click",()=>{const i=new Date().getTime();i-Kt>500?ot(1):ot(gt+1),Dn(i),gt===5&&(ot(0),V("آیا از ساخت یک کلاس تستی تصادفی مطمئن هستید؟",()=>{function p(){const m=`کلاس تستی ${Object.keys(w).length+1}`,g=new $t({name:m,type:"online"});["علی رضایی","مریم حسینی","زهرا احمدی","رضا محمدی","فاطمه کریمی"].forEach(D=>g.addStudent(new st({name:D}))),w[m]=g,B(),ae()}p(),C("کلاس تستی با موفقیت ساخته شد ✅!")},{confirmText:"بساز",confirmClass:"btn-success"}))}),Tt.addEventListener("click",()=>{ee(),Xe(null)}),rs.addEventListener("click",()=>{typeof yt=="function"&&yt(),ee(),Xe(null)}),Bt.addEventListener("click",()=>{ee(Yt)}),We.addEventListener("click",()=>{ee(Xt)}),Y.addEventListener("click",()=>{l&&h&&(Re(),L("attendance-page"))}),T.addEventListener("click",()=>{if(ye.value.trim()!==""||me.value.trim()!==""){C("⚠️لطفاً ابتدا با دکمه «ثبت»، تغییرات را ذخیره کنید و یا نمره و یادداشت را پاک کنید.");return}if(!l||!h||!le)return;const i=l.selectNextWinner(le.name,h);if(i){const p=h.studentRecords[i.identity.studentId];if(p&&p.attendance==="absent"&&i.statusCounters.missedChances++,p&&p.hadIssue){i.statusCounters.missedChances++;const g=le.name;i.categoryIssues[g]=(i.categoryIssues[g]||0)+1}const m={winner:i,categoryName:le.name};h.winnerHistory.push(m),h.winnerHistory.length>10&&h.winnerHistory.shift(),Be(h.winnerHistory.length-1),h.lastUsedCategoryId=le.id,h.lastSelectedWinnerId=i.identity.studentId,de(),Le(),B()}else C("❌دانش‌آموز واجد شرایطی برای انتخاب یافت نشد.")}),R.addEventListener("click",()=>{if(!l)return;const i=M.value.trim(),p=mn.checked;if(!i){alert("⚠️لطفاً نام دسته‌بندی را وارد کنید.");return}const m=l.categories.find(E=>E.name.toLowerCase()===i.toLowerCase());if(m)if(m.isDeleted){const E=l.categories.findIndex(D=>D===m);E>-1&&l.categories.splice(E,1)}else{alert("⚠️این دسته‌بندی از قبل وجود دارد.");return}const g=new be(i,"",p);l.categories.push(g),B(),F(l.info.name,`دسته‌بندی جدید «${i}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),Pe(),M.value="",mn.checked=!1}),M.addEventListener("keyup",i=>{i.key==="Enter"&&R.click()}),I.addEventListener("click",()=>{if(!pt){alert("❌خطایی رخ داده است. لطفاً فایل را دوباره انتخاب کنید."),L("settings-page");return}const i=parseInt(b.value,10),g=pt.split(`
`).slice(1).map(E=>{var N;return(N=E.split(",")[i])==null?void 0:N.trim()}).filter(E=>E&&E.length>0);g.length>0?(Ue(g),Gt(),L("csv-preview-page")):alert("هیچ نامی در ستون انتخاب شده پیدا نشد. لطفاً ستون دیگری را امتحان کنید یا فایل خود را بررسی کنید."),at(null)}),r.addEventListener("click",()=>{f.click()}),f.addEventListener("change",i=>{const p=i.target.files[0];if(!p)return;const m=new FileReader;m.onload=g=>{const E=g.target.result;at(E);const N=E.split(`
`)[0].split(",");is(N),L("column-mapping-page")},m.readAsText(p),i.target.value=null}),k.addEventListener("click",()=>{at(null),L("settings-page")}),v.addEventListener("click",()=>{const i=y.querySelectorAll('input[type="checkbox"]:checked');let p=!1;i.forEach(m=>{const g=m.dataset.name,E=l.students.find(N=>N.identity.name.toLowerCase()===g.toLowerCase());if(E)if(E.isDeleted)St(E,l);else{console.log(`دانش‌آموز «${g}» به دلیل تکراری بودن اضافه نشد.`);return}const D=new st({name:g});l.addStudent(D),l.sessions.length>0&&(yn(D,l),p=!0)}),B(),F(l.info.name,`${i.length} دانش‌آموز جدید از لیست ورودی به کلاس اضافه شدند.`,{type:"VIEW_SESSIONS"}),Ce(),p&&Cn(i.length),L("settings-page"),u.value="",Ue([])}),S.addEventListener("click",()=>{Ue([]),L("settings-page")}),d.addEventListener("click",()=>{const i=u.value.trim();if(!i){alert("کادر متنی خالی است. لطفاً اسامی را وارد کنید.");return}const p=i.split(`
`).map(m=>m.trim()).filter(m=>m.length>0);p.length>0?(Ue(p),Gt(),L("csv-preview-page")):alert("هیچ نام معتبری برای ورود پیدا نشد.")}),o.addEventListener("keyup",i=>{i.key==="Enter"&&c.click()}),c.addEventListener("click",()=>{if(!l)return;const i=o.value.trim();if(!i){alert("لطفاً نام دانش‌آموز را وارد کنید.");return}const p=l.students.find(g=>g.identity.name.toLowerCase()===i.toLowerCase());if(p)if(p.isDeleted)St(p,l);else{alert("❌دانش‌آموزی با این نام از قبل در این کلاس وجود دارد.");return}const m=new st({name:i});l.addStudent(m),l.sessions.length>0&&(yn(m,l),Cn(1)),B(),F(l.info.name,`دانش‌آموز «${i}» به کلاس اضافه شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:m.identity.studentId}),Ce(),o.value="",o.focus()}),a.addEventListener("click",()=>{J(),L("session-page")}),document.getElementById("new-session-btn").addEventListener("click",()=>{if(l){const i=l.sessions.find(m=>!m.isFinished&&!m.isCancelled&&!m.isDeleted);if(i){C(`⚠️ جلسه ${i.sessionNumber} هنوز تمام نشده است. لطفاً ابتدا با دکمه ✅ آن را خاتمه دهید.`);return}const p=()=>{const m=g=>{const E=l.startNewSession();Qe(E),Q(E),l.students.forEach(Z=>{jt.setAttendance(Z.identity.studentId,"present")}),B();const N=ve(l).get(E.sessionNumber);F(l.info.name,`جلسه ${N} شروع شد.`,{type:"VIEW_SESSIONS"}),g?(Re(),L("attendance-page")):Ne()};V("آیا تمایل به انجام فرآیند حضور و غیاب دارید؟",()=>m(!0),{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success",onCancel:()=>m(!1)})};l.hasSessionToday()?V("شما امروز یک جلسه برای این کلاس ثبت کرده‌اید. آیا از شروع یک جلسه جدید دیگر مطمئن هستید؟",p,{confirmText:"بله",confirmClass:"btn-warning"}):p()}}),n.addEventListener("click",()=>{const i=t.value.trim(),p=document.querySelector('input[name="class-type"]:checked');if(!i&&!p){C("⚠️لطفاً نام و نوع کلاس را مشخص کنید.");return}if(!i){C("⚠️لطفاً نام کلاس را وارد کنید.");return}if(!p){C("⚠️لطفاً نوع کلاس را انتخاب کنید.");return}if(w[i]){w[i].isDeleted?C("⚠️ کلاسی با این نام در سطل زباله است. ابتدا آن را بازیابی کنید و یا آن را پاک کنید."):C("⚠️کلاسی با این نام از قبل وجود دارد.");return}const m=p.value,g=new $t({name:i,type:m});w[i]=g,B(),F(i,`کلاس «${i}» ایجاد شد.`,{type:"VIEW_SESSIONS"}),ae(),C(`✅ کلاس «${i}» با موفقیت ایجاد شد.`),t.value="",p.checked=!1}),e.addEventListener("input",i=>{const p=i.target.value;if(p.length<2){mt([]);return}const m=p.toLowerCase(),g=En(m),E=[];for(const D in w){const N=w[D];if(N.isDeleted)continue;q(N.students).filter(U=>{const se=$e(U.identity.name.toLowerCase()),xe=se.includes($e(m)),vn=se.includes($e(g));return xe||vn}).forEach(U=>{E.push({student:U,classroom:N})})}mt(E)}),t.addEventListener("keyup",i=>{i.key==="Enter"&&n.click()}),s.addEventListener("click",Zn),document.querySelectorAll(".back-to-classes-btn").forEach(i=>{i.addEventListener("click",()=>{z(null),Q(null),Qe(null),L("class-management-page")})}),_.addEventListener("click",()=>{Ne()}),oe.addEventListener("click",()=>{J(),L("session-page")}),ps.addEventListener("click",()=>{if(G(null),!h&&l&&l.sessions.length>0){const i=q(l.sessions).filter(p=>!p.isCancelled);if(i.length>0){const p=i[i.length-1];Q(p)}else{J(),L("session-page");return}}Ne()}),Fe.addEventListener("input",i=>{const p=i.target.value;if(!p){je([]);return}const m=p.toLowerCase(),g=En(m),D=q(l.students).filter(N=>{const Z=$e(N.identity.name.toLowerCase()),U=Z.includes($e(m)),se=Z.includes($e(g));return U||se});je(D)}),Fe.addEventListener("focus",()=>{Fe.value&&je(Fe.value)}),_e.addEventListener("click",()=>{const i=ye.value,p=me.value.trim();let m;if(vt)m=vt.student;else{const E=h==null?void 0:h.winnerHistory[ue];m=E==null?void 0:E.winner}if(!m){C("❌خطا: دانش‌آموز معتبری برای ثبت نمره یافت نشد.");return}const g=le;if(!m||!g){C("⚠️لطفاً ابتدا یک دانش‌آموز و یک دسته‌بندی را انتخاب کنید.");return}if(!i){C("⚠️لطفاً مقدار نمره را وارد کنید.");return}if(i>100||i<0){C("❌نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}m&&(m.addScore(g.name,parseFloat(i),p),F(l.info.name,`نمره ${i} در ${g.name} برای «${m.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:m.identity.studentId}),B(),de(),C(`✅نمره برای ${m.identity.name} در مهارت ${g.name} ثبت شد.`),ye.value="",me.value="",Le(m,g.name))});const pn=i=>{i.key==="Enter"&&i.ctrlKey&&(i.preventDefault(),_e.click())};ye.addEventListener("keydown",pn),me.addEventListener("keydown",pn),Cs.addEventListener("click",()=>{const i=gs.querySelector(".pill.active");if(!i){C("⚠️لطفاً یک مهارت را برای نمره‌دهی انتخاب کنید.");return}const p=i.dataset.skillName,m=hs.value,g=ys.value.trim();if(!m){C("لطفاً مقدار نمره را وارد کنید.");return}O.addScore(p,parseFloat(m),g),B(),F(l.info.name,`نمره ${m} در ${p} برای «${O.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:O.identity.studentId}),X(),C(`✅نمره برای مهارت ${p} با موفقیت ثبت شد.`)}),document.getElementById("add-note-btn").addEventListener("click",()=>{O&&(nt.value="",nt.dispatchEvent(new Event("input",{bubbles:!0})),pe(i=>{i&&(O.addNote(i),B(),F(l.info.name,`یادداشت جدیدی برای دانش‌آموز «${O.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:O.identity.studentId}),et())}),te("add-note-modal"),nt.focus())}),ds.addEventListener("click",()=>{ee()}),ls.addEventListener("click",()=>{const i=nt.value.trim();typeof Ct=="function"&&(Ct(i),ee())});const Es=document.getElementById("move-student-confirm-btn"),bs=document.getElementById("move-student-cancel-btn"),Is=document.getElementById("move-student-class-select");bs.addEventListener("click",()=>{ee()}),Es.addEventListener("click",()=>{const i=Is.value,p=w[i],{studentToMove:m,sourceClassForMove:g}=Ms;if(!m||!g||!p){C("خطایی رخ داد. لطفاً دوباره امتحان کنید⚠️.","error"),ee();return}const E=Nn(m,g,p);E.success?(F(g.info.name,`دانش‌آموز «${m.identity.name}» به کلاس «${i}» منتقل شد.`,{type:"VIEW_SESSIONS"}),F(i,`دانش‌آموز «${m.identity.name}» از کلاس «${g.info.name}» به این کلاس منتقل شد.`,{type:"VIEW_SESSIONS"}),B(),Ce(),C(`دانش‌آموز «${m.identity.name}» با موفقیت به کلاس «${i}» منتقل شد✅.`)):C(E.message,"error"),ee()}),ie.addEventListener("click",()=>{ne.style.width="250px",P.classList.add("modal-visible")}),De.addEventListener("click",ce),P.addEventListener("click",ce),vs.addEventListener("click",()=>{tt(),L("trash-page"),ce()}),document.getElementById("demo-mode-btn").addEventListener("click",()=>{fe?hn():(ce(),V("شما در حال ورود به حالت نمایش (Demo) هستید. در این حالت، هیچ‌کدام از تغییرات شما ذخیره نخواهد شد. آیا ادامه می‌دهید؟",()=>{Pn(),ft(),ce()},{confirmText:"تایید",confirmClass:"btn-warning",onCancel:ce}))});const gn=document.getElementById("exit-demo-btn");gn&&gn.addEventListener("click",()=>{fe&&hn()}),W.addEventListener("click",()=>{if(fe){C("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است."),ce();return}ce(),un()}),K.addEventListener("click",()=>{if(fe){C("⚠️ بازیابی اطلاعات در حالت نمایش (Demo) غیرفعال است."),ce();return}ke.click(),ce()}),ke.addEventListener("change",i=>{const p=i.target.files[0];if(!p)return;const m=new FileReader;m.onload=g=>{try{const E=JSON.parse(g.target.result);V("آیا از بازیابی اطلاعات مطمئن هستید؟ تمام داده‌های فعلی شما بازنویسی خواهد شد.",()=>{Ke(E),B(),ae(),L("class-management-page"),C("✅اطلاعات با موفقیت بازیابی شد.")},{confirmText:"بازیابی کن",confirmClass:"btn-warning"})}catch{C("❌خطا در خواندن فایل. لطفاً فایل پشتیبان معتبر انتخاب کنید.")}},m.readAsText(p),i.target.value=null}),window.addEventListener("popstate",i=>{if(Ie&&history.pushState(null,"",location.href),we(),i.state){const{pageId:p,currentClassName:m,selectedSessionNumber:g,selectedStudentId:E}=i.state;m&&(z(w[m]),g&&Q(l.getSession(g)),E&&G(l.students.find(D=>D.identity.studentId===E))),p==="student-page"?Ne():(p==="session-page"&&J(),Je(p))}else z(null),Q(null),G(null),Je("class-management-page")}),document.addEventListener("keydown",i=>{var g;const p=document.activeElement;if(!["INPUT","TEXTAREA","SELECT"].includes(p.tagName)){if(i.key.toLowerCase()==="o"&&i.shiftKey&&Vn.classList.contains("active")&&(i.preventDefault(),Jn.click()),i.key==="Escape"){if(Te.classList.contains("visible")){we();return}if(Ie){ee();return}switch((g=document.querySelector(".page.active"))==null?void 0:g.id){case"csv-preview-page":case"column-mapping-page":L("settings-page");break;case"student-profile-page":G(null),L(h?"student-page":"session-page");break;case"attendance-page":L("student-page");break;case"student-page":Q(null),J(),L("session-page");break;case"settings-page":case"session-page":z(null),L("class-management-page");break}return}if(h){const E=i.key.toLowerCase();switch(" ascfg".includes(E)&&i.preventDefault(),E){case" ":T.click();break;case"a":A.classList.contains("active")?history.back():(Re(),L("attendance-page"));break;case"s":document.getElementById("session-page").classList.contains("active")?history.back():a.click();break;case"c":document.querySelector(".back-to-classes-btn").click();break;case"f":const D=document.querySelector(".action-column .search-icon");D&&D.click();break;case"g":if(ms.classList.contains("active"))history.back();else{const N=h.lastSelectedWinnerId;if(N){const Z=l.students.find(U=>U.identity.studentId===N);Z&&(G(Z),X(),L("student-profile-page"))}else C("⚠️ابتدا یک نفر را انتخاب کنید تا پروفایل او نمایش داده شود.")}break;case"arrowleft":{const N=document.querySelector('button[title="برنده قبلی"]');N&&!N.disabled&&(i.preventDefault(),N.click());break}case"arrowright":{const N=document.querySelector('button[title="برنده بعدی"]');N&&!N.disabled&&(i.preventDefault(),N.click());break}}}}});function ce(){ne.style.width="0",P.classList.add("modal-closing"),setTimeout(()=>{P.classList.remove("modal-visible","modal-closing")},300)}function hn(){V("آیا از خروج از حالت نمایش (Demo) مطمئن هستید؟ با خروج، تمام تغییرات آزمایشی شما حذف شده و داده‌های اصلی شما بازیابی خواهند شد.",()=>{Wn(),z(null),Q(null),G(null),ae(),L("class-management-page"),ft(),ce()},{confirmText:"خروج",confirmClass:"btn-success"})}fn(".global-search-container .animated-search-container",mt),fn(".action-column-header .animated-search-container",je),[H,on,me,jn].forEach(i=>{i&&as(i)}),fs.addEventListener("click",()=>{rn(O,l)});function yn(i,p){const m=q(p.students).filter(x=>x.identity.studentId!==i.identity.studentId);if(m.length===0)return;let g=0;const E=q(p.categories);E.forEach(x=>{const re=Math.max(0,...m.map(qe=>qe.categoryCounts[x.name]||0));i.categoryCounts[x.name]=re,g+=re}),i.statusCounters.totalSelections=g;const D=m.reduce((x,re)=>x+re.statusCounters.totalSelections,0),N=m.reduce((x,re)=>x+(re.statusCounters.missedChances||0),0),Z=D>0?N/D:0,U={};E.forEach(x=>{const re=m.reduce((Dt,xt)=>Dt+(xt.categoryCounts[x.name]||0),0),qe=m.reduce((Dt,xt)=>Dt+(xt.categoryIssues[x.name]||0),0);U[x.name]=re>0?qe/re:0}),i.statusCounters.missedChances=Math.round(i.statusCounters.totalSelections*Z),E.forEach(x=>{const re=i.categoryCounts[x.name]||0,qe=U[x.name]||0;i.categoryIssues[x.name]=Math.round(re*qe)});const se=q(p.sessions).filter(x=>!x.isCancelled&&x.isFinished);se.forEach(x=>{x.setAttendance(i.identity.studentId,"absent")});const xe="📝 یادداشت خودکار سیستم",Ns=`این دانش‌آموز پس از جلسه شماره ${se.length} به کلاس اضافه شد. آمار پایه‌ای زیر برای حفظ تعادل الگوریتم انتخاب برای او ثبت گردید:`,Me=[];i.statusCounters.totalSelections>0&&Me.push(`کل انتخاب‌ها: ${i.statusCounters.totalSelections}`),i.statusCounters.missedChances>0&&Me.push(`فرصت‌های از دست رفته: ${i.statusCounters.missedChances}`);for(const x in i.categoryCounts)i.categoryCounts[x]>0&&Me.push(`انتخاب در «${x}»: ${i.categoryCounts[x]}`);for(const x in i.categoryIssues)i.categoryIssues[x]>0&&Me.push(`مشکل در «${x}»: ${i.categoryIssues[x]}`);if(Me.length>0){const x=`${xe}
${Ns}

- ${Me.join(`
- `)}`;i.addNote(x)}}function Cn(i){const m=`چون این کلاس جلسات برگزار شده دارد، برای ${i>1?"دانش‌آموزان جدید":"دانش‌آموز جدید"} آمار پایه‌ای (متناسب با سایر دانش‌آموزان) ثبت شد تا در فرایند انتخاب اختلالی ایجاد نشود.`;V(m,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}const Ss="5.1.1";document.getElementById("app-version").textContent=`نسخه ${Ss}`;function Ls(){console.log("Starting universal backfill for writing scores...");let i=0;for(const p in w){const m=w[p];if(m.isDeleted)continue;let g=0;q(m.students).forEach(D=>{const N=D.logs.scores;if(!(N&&N.writing&&N.writing.length>0)){let U=-1;for(const se in N)se!=="writing"&&N[se].forEach(xe=>{xe.value>U&&(U=xe.value)});if(U>-1){const se=`Automatically assigned based on the highest score (${U}) from other skills.`;D.addScore("Writing",U,se),g++}}}),g>0&&(console.log(`Updated ${g} student(s) in class: ${m.info.name}.`),i+=g)}i>0?(B(),console.log(`Update complete. A total of ${i} student(s) were updated across all classes. Data saved.`),document.getElementById("student-page").classList.contains("active")&&de()):console.log("No students needed updating in any class.")}window.backfillWritingScoresForAll=Ls;function ks(){console.log("Starting backfill for 'outOfClassCount' and 'wasOutOfClass' properties...");let i=0,p=0;const m=localStorage.getItem("teacherAssistantData_v2");if(!m){console.log("No data found in localStorage. Nothing to do.");return}const g=JSON.parse(m);for(const E in g){const D=g[E];D.students&&D.students.forEach(N=>{N.statusCounters&&typeof N.statusCounters.outOfClassCount>"u"&&(N.statusCounters.outOfClassCount=0,i++)}),D.sessions&&D.sessions.forEach(N=>{if(N.studentRecords)for(const Z in N.studentRecords){const U=N.studentRecords[Z];typeof U.wasOutOfClass>"u"&&(U.wasOutOfClass=!1,p++)}})}localStorage.setItem("teacherAssistantData_v2",JSON.stringify(g)),console.log(`Backfill complete. Updated ${i} students and ${p} session records. Data saved.`),Et(),l&&de()}window.backfillExitCounters=ks;function ws(i){if(!i||!i.classroomName)return;const p=w[i.classroomName];if(!p){C("⚠️ کلاس مربوط به این گزارش یافت نشد.");return}z(p),ee(),setTimeout(()=>{switch(i.type){case"VIEW_STUDENT_PROFILE":{const m=p.students.find(g=>g.identity.studentId===i.studentId);m?(G(m),X(),L("student-profile-page")):C("⚠️ دانش‌آموز مورد نظر یافت نشد.");break}case"VIEW_TRASH":tt(),L("trash-page");break;case"VIEW_SESSIONS":J(),L("session-page");break;case"VIEW_CLASS_NOTE":ln(p);break;case"VIEW_CLASS_SETTINGS":dn(p);break}},300)}});
