(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))l(r);new MutationObserver(r=>{for(const t of r)if(t.type==="childList")for(const a of t.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&l(a)}).observe(document,{childList:!0,subtree:!0});function e(r){const t={};return r.integrity&&(t.integrity=r.integrity),r.referrerPolicy&&(t.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?t.credentials="include":r.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function l(r){if(r.ep)return;r.ep=!0;const t=e(r);fetch(r.href,t)}})();class pn{constructor(o){this.identity={name:o.name,studentId:o.studentId||`id_${new Date().getTime()}_${Math.random()}`,branchName:o.branchName||null,ageGroup:o.ageGroup||"adult",level:o.level||null,contact:{social:o.socialContact||null,parent:o.parentContact||null}},this.isDeleted=!1,this.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0,outOfClassCount:0},this.categoryCounts={},this.categoryIssues={},this.logs={parentContacts:[],scores:{},discipline:{},sessionHistory:{}},this.profile={notes:[],tags:[]},this.finalClassActivityScore=null,this.onboardingSession=null}addScore(o,e,l){if(e>100||e<0){console.log("نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}const r=o.toLowerCase();this.logs.scores[r]||(this.logs.scores[r]=[]);const t=new Zi(o,e,l);this.logs.scores[r].push(t)}addNote(o,e=null){const l=new qi(o,e);this.profile.notes.push(l)}getOverallAverageScore(){let o=0,e=0;for(const r in this.logs.scores)this.logs.scores[r].forEach(t=>{t.isDeleted||(o+=t.value,e++)});if(e===0)return null;const l=o/e;return Math.round(l*100)/100}}class Zi{constructor(o,e,l=""){this.id=`score_${new Date().getTime()}`,this.skill=o,this.value=e,this.timestamp=new Date,this.comment=l,this.isDeleted=!1}}class qi{constructor(o,e=null){this.id=`note_${new Date().getTime()}`,this.timestamp=new Date,this.content=o,this.isDeleted=!1,this.source=e}}class Gn{constructor(o="complete",e=""){this.status=o,this.comment=e,this.timestamp=new Date}}class Ws{constructor(o){this.sessionNumber=o,this.startTime=new Date,this.note="",this.isDeleted=!1,this.endTime=null,this.isFinished=!1,this.isMakeup=!1,this.isCancelled=!1,this.studentRecords={},this.lastWinnerByCategory={},this.lastUsedCategoryId=null,this.lastSelectedWinnerId=null,this.winnerHistory=[]}end(){this.isFinished=!0,this.endTime=new Date}markAsMakeup(){this.isMakeup=!this.isMakeup}initializeStudentRecord(o){this.studentRecords[o]||(this.studentRecords[o]={attendance:"present",homework:new Gn,selections:{},hadIssue:!1,wasOutOfClass:!1})}setAttendance(o,e){this.initializeStudentRecord(o),this.studentRecords[o].attendance=e}setHomeworkStatus(o,e){this.initializeStudentRecord(o),this.studentRecords[o].homework.status=e}selectNextWinner(o,e,l){if(!e||e.length===0)return console.log("هیچ دانش‌آموزی در کلاس برای انتخاب وجود ندارد."),null;const r=this.lastWinnerByCategory[o];let t=e.filter(p=>p.identity.studentId!==r&&!p.isDeleted);if(t.length===0&&(t=e),t.length===0)return null;const a=(p,u)=>p.categoryCounts[u]||0,s=Math.min(...t.map(p=>a(p,o))),i=t.filter(p=>a(p,o)===s);let c;if(i.length===1)c=i[0];else if(i.length>1){const p=l.filter(v=>!v.isDeleted&&v.name!==o).map(v=>v.name),u=i.map(v=>{const g=p.reduce((C,E)=>C+a(v,E),0);return{student:v,otherCategoriesTotal:g}}),b=Math.min(...u.map(v=>v.otherCategoriesTotal)),f=u.filter(v=>v.otherCategoriesTotal===b).map(v=>v.student);f.length===1?c=f[0]:c=f[Math.floor(Math.random()*f.length)]}else c=t[Math.floor(Math.random()*t.length)];const h=c.identity.studentId;this.initializeStudentRecord(h);const y=(this.studentRecords[h].selections[o]||0)+1;return this.studentRecords[h].selections[o]=y,c.statusCounters.totalSelections++,c.categoryCounts[o]=(c.categoryCounts[o]||0)+1,this.lastWinnerByCategory[o]=h,c}}class Vn{constructor(o){this.info={name:o.name||"NotNamed",teacherName:o.teacherName||null,type:o.type||"in-person",term:o.term||null,scheduleText:o.scheduleText||null,level:o.level||null,creationDate:o.creationDate?new Date(o.creationDate):new Date,scheduleCode:o.scheduleCode||`code_${new Date().getTime()}`,scheduleDays:o.scheduleDays||[],scheduleStartTime:o.scheduleStartTime||null,scheduleEndTime:o.scheduleEndTime||null},this.students=[],this.sessions=[],this.note="",this.isDeleted=!1,this.categories=[new ut("Vocabulary","Questions about words and meanings."),new ut("Grammar","Questions about sentence structure and rules."),new ut("Listening",void 0,!0),new ut("Speaking",void 0,!0),new ut("Reading",void 0,!0),new ut("Writing",void 0,!0)],this.futurePlans={}}addStudent(o){this.students.push(o)}removeStudent(o){this.students=this.students.filter(e=>e.identity.studentId!==o)}startNewSession(){const o=this.sessions.length+1,e=new Ws(o);return this.sessions.push(e),e}endSpecificSession(o){const e=this.getSession(o);return e&&!e.isFinished?(e.end(),!0):!1}getSession(o){return this.sessions.find(e=>e.sessionNumber===o)}markAsMakeup(o){const e=this.getSession(o);e&&e.markAsMakeup()}planForSession(o,e){this.futurePlans[o]=e}hasSessionToday(){const o=new Date().toDateString();return this.sessions.some(e=>!e.isDeleted&&e.startTime.toDateString()===o)}selectNextWinner(o,e){return e?e.selectNextWinner(o,this.students,this.categories):null}get liveSession(){for(let o=this.sessions.length-1;o>=0;o--)if(!this.sessions[o].isFinished)return this.sessions[o];return null}endLiveSession(){const o=this.liveSession;return o?(o.end(),!0):!1}calculateFinalStudentScore(o){const e=o.logs.scores,l=["reading","writing"];for(const p of l)if(!e[p]||e[p].length===0)return null;const r=e.listening&&e.listening.length>0,t=e.speaking&&e.speaking.length>0;if(!r&&!t)return null;const a=p=>e[p].reduce((b,f)=>b+f.value,0)/e[p].length;let s;r&&t?s=(a("listening")+a("speaking"))/2:r?s=a("listening"):s=a("speaking");const i=a("reading"),c=a("writing"),y=(s*3+i*2+c*1)/6;return Math.trunc(y*10)/10}assignAllFinalScores(){let o=0,e=[];console.log("شروع عملیات محاسبه نمره نهایی برای تمام دانش‌آموزان..."),this.students.forEach(r=>{const t=this.calculateFinalStudentScore(r);t!==null?(r.finalClassActivityScore=t,o++):(r.finalClassActivityScore=null,e.push(r.identity.name))});const l=e.length;console.log(`عملیات پایان یافت. تعداد نمرات موفق: ${o} | تعداد ناموفق (نمرات ناقص): ${l}`),l>0&&(console.log("اسامی دانش‌آموزانی که نمراتشان ناقص است:"),e.forEach(r=>console.log(`- ${r}`)))}}class ut{constructor(o,e="",l=!1){this.id=`cat_${new Date().getTime()}_${Math.random()}`,this.name=o,this.description=e,this.isDeleted=!1,this.isGradedCategory=l,this.isDeleted=!1}}var mn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Us(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}function hn(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var js={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/(function(n,o){(function(e){n.exports=e()})(function(){return function e(l,r,t){function a(c,h){if(!r[c]){if(!l[c]){var y=typeof hn=="function"&&hn;if(!h&&y)return y(c,!0);if(s)return s(c,!0);var p=new Error("Cannot find module '"+c+"'");throw p.code="MODULE_NOT_FOUND",p}var u=r[c]={exports:{}};l[c][0].call(u.exports,function(b){var f=l[c][1][b];return a(f||b)},u,u.exports,e,l,r,t)}return r[c].exports}for(var s=typeof hn=="function"&&hn,i=0;i<t.length;i++)a(t[i]);return a}({1:[function(e,l,r){var t=e("./utils"),a=e("./support"),s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";r.encode=function(i){for(var c,h,y,p,u,b,f,v=[],g=0,C=i.length,E=C,S=t.getTypeOf(i)!=="string";g<i.length;)E=C-g,y=S?(c=i[g++],h=g<C?i[g++]:0,g<C?i[g++]:0):(c=i.charCodeAt(g++),h=g<C?i.charCodeAt(g++):0,g<C?i.charCodeAt(g++):0),p=c>>2,u=(3&c)<<4|h>>4,b=1<E?(15&h)<<2|y>>6:64,f=2<E?63&y:64,v.push(s.charAt(p)+s.charAt(u)+s.charAt(b)+s.charAt(f));return v.join("")},r.decode=function(i){var c,h,y,p,u,b,f=0,v=0,g="data:";if(i.substr(0,g.length)===g)throw new Error("Invalid base64 input, it looks like a data url.");var C,E=3*(i=i.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(i.charAt(i.length-1)===s.charAt(64)&&E--,i.charAt(i.length-2)===s.charAt(64)&&E--,E%1!=0)throw new Error("Invalid base64 input, bad content length.");for(C=a.uint8array?new Uint8Array(0|E):new Array(0|E);f<i.length;)c=s.indexOf(i.charAt(f++))<<2|(p=s.indexOf(i.charAt(f++)))>>4,h=(15&p)<<4|(u=s.indexOf(i.charAt(f++)))>>2,y=(3&u)<<6|(b=s.indexOf(i.charAt(f++))),C[v++]=c,u!==64&&(C[v++]=h),b!==64&&(C[v++]=y);return C}},{"./support":30,"./utils":32}],2:[function(e,l,r){var t=e("./external"),a=e("./stream/DataWorker"),s=e("./stream/Crc32Probe"),i=e("./stream/DataLengthProbe");function c(h,y,p,u,b){this.compressedSize=h,this.uncompressedSize=y,this.crc32=p,this.compression=u,this.compressedContent=b}c.prototype={getContentWorker:function(){var h=new a(t.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new i("data_length")),y=this;return h.on("end",function(){if(this.streamInfo.data_length!==y.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),h},getCompressedWorker:function(){return new a(t.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},c.createWorkerFrom=function(h,y,p){return h.pipe(new s).pipe(new i("uncompressedSize")).pipe(y.compressWorker(p)).pipe(new i("compressedSize")).withStreamInfo("compression",y)},l.exports=c},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,l,r){var t=e("./stream/GenericWorker");r.STORE={magic:"\0\0",compressWorker:function(){return new t("STORE compression")},uncompressWorker:function(){return new t("STORE decompression")}},r.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,l,r){var t=e("./utils"),a=function(){for(var s,i=[],c=0;c<256;c++){s=c;for(var h=0;h<8;h++)s=1&s?3988292384^s>>>1:s>>>1;i[c]=s}return i}();l.exports=function(s,i){return s!==void 0&&s.length?t.getTypeOf(s)!=="string"?function(c,h,y,p){var u=a,b=p+y;c^=-1;for(var f=p;f<b;f++)c=c>>>8^u[255&(c^h[f])];return-1^c}(0|i,s,s.length,0):function(c,h,y,p){var u=a,b=p+y;c^=-1;for(var f=p;f<b;f++)c=c>>>8^u[255&(c^h.charCodeAt(f))];return-1^c}(0|i,s,s.length,0):0}},{"./utils":32}],5:[function(e,l,r){r.base64=!1,r.binary=!1,r.dir=!1,r.createFolders=!0,r.date=null,r.compression=null,r.compressionOptions=null,r.comment=null,r.unixPermissions=null,r.dosPermissions=null},{}],6:[function(e,l,r){var t=null;t=typeof Promise<"u"?Promise:e("lie"),l.exports={Promise:t}},{lie:37}],7:[function(e,l,r){var t=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",a=e("pako"),s=e("./utils"),i=e("./stream/GenericWorker"),c=t?"uint8array":"array";function h(y,p){i.call(this,"FlateWorker/"+y),this._pako=null,this._pakoAction=y,this._pakoOptions=p,this.meta={}}r.magic="\b\0",s.inherits(h,i),h.prototype.processChunk=function(y){this.meta=y.meta,this._pako===null&&this._createPako(),this._pako.push(s.transformTo(c,y.data),!1)},h.prototype.flush=function(){i.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},h.prototype.cleanUp=function(){i.prototype.cleanUp.call(this),this._pako=null},h.prototype._createPako=function(){this._pako=new a[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var y=this;this._pako.onData=function(p){y.push({data:p,meta:y.meta})}},r.compressWorker=function(y){return new h("Deflate",y)},r.uncompressWorker=function(){return new h("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(e,l,r){function t(u,b){var f,v="";for(f=0;f<b;f++)v+=String.fromCharCode(255&u),u>>>=8;return v}function a(u,b,f,v,g,C){var E,S,I=u.file,x=u.compression,L=C!==c.utf8encode,N=s.transformTo("string",C(I.name)),R=s.transformTo("string",c.utf8encode(I.name)),P=I.comment,Q=s.transformTo("string",C(P)),k=s.transformTo("string",c.utf8encode(P)),z=R.length!==I.name.length,m=k.length!==P.length,H="",ue="",Z="",fe=I.dir,F=I.date,ne={crc32:0,compressedSize:0,uncompressedSize:0};b&&!f||(ne.crc32=u.crc32,ne.compressedSize=u.compressedSize,ne.uncompressedSize=u.uncompressedSize);var A=0;b&&(A|=8),L||!z&&!m||(A|=2048);var M=0,oe=0;fe&&(M|=16),g==="UNIX"?(oe=798,M|=function(Y,Be){var Ne=Y;return Y||(Ne=Be?16893:33204),(65535&Ne)<<16}(I.unixPermissions,fe)):(oe=20,M|=function(Y){return 63&(Y||0)}(I.dosPermissions)),E=F.getUTCHours(),E<<=6,E|=F.getUTCMinutes(),E<<=5,E|=F.getUTCSeconds()/2,S=F.getUTCFullYear()-1980,S<<=4,S|=F.getUTCMonth()+1,S<<=5,S|=F.getUTCDate(),z&&(ue=t(1,1)+t(h(N),4)+R,H+="up"+t(ue.length,2)+ue),m&&(Z=t(1,1)+t(h(Q),4)+k,H+="uc"+t(Z.length,2)+Z);var te="";return te+=`
\0`,te+=t(A,2),te+=x.magic,te+=t(E,2),te+=t(S,2),te+=t(ne.crc32,4),te+=t(ne.compressedSize,4),te+=t(ne.uncompressedSize,4),te+=t(N.length,2),te+=t(H.length,2),{fileRecord:y.LOCAL_FILE_HEADER+te+N+H,dirRecord:y.CENTRAL_FILE_HEADER+t(oe,2)+te+t(Q.length,2)+"\0\0\0\0"+t(M,4)+t(v,4)+N+H+Q}}var s=e("../utils"),i=e("../stream/GenericWorker"),c=e("../utf8"),h=e("../crc32"),y=e("../signature");function p(u,b,f,v){i.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=b,this.zipPlatform=f,this.encodeFileName=v,this.streamFiles=u,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}s.inherits(p,i),p.prototype.push=function(u){var b=u.meta.percent||0,f=this.entriesCount,v=this._sources.length;this.accumulate?this.contentBuffer.push(u):(this.bytesWritten+=u.data.length,i.prototype.push.call(this,{data:u.data,meta:{currentFile:this.currentFile,percent:f?(b+100*(f-v-1))/f:100}}))},p.prototype.openedSource=function(u){this.currentSourceOffset=this.bytesWritten,this.currentFile=u.file.name;var b=this.streamFiles&&!u.file.dir;if(b){var f=a(u,b,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:f.fileRecord,meta:{percent:0}})}else this.accumulate=!0},p.prototype.closedSource=function(u){this.accumulate=!1;var b=this.streamFiles&&!u.file.dir,f=a(u,b,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(f.dirRecord),b)this.push({data:function(v){return y.DATA_DESCRIPTOR+t(v.crc32,4)+t(v.compressedSize,4)+t(v.uncompressedSize,4)}(u),meta:{percent:100}});else for(this.push({data:f.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},p.prototype.flush=function(){for(var u=this.bytesWritten,b=0;b<this.dirRecords.length;b++)this.push({data:this.dirRecords[b],meta:{percent:100}});var f=this.bytesWritten-u,v=function(g,C,E,S,I){var x=s.transformTo("string",I(S));return y.CENTRAL_DIRECTORY_END+"\0\0\0\0"+t(g,2)+t(g,2)+t(C,4)+t(E,4)+t(x.length,2)+x}(this.dirRecords.length,f,u,this.zipComment,this.encodeFileName);this.push({data:v,meta:{percent:100}})},p.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},p.prototype.registerPrevious=function(u){this._sources.push(u);var b=this;return u.on("data",function(f){b.processChunk(f)}),u.on("end",function(){b.closedSource(b.previous.streamInfo),b._sources.length?b.prepareNextSource():b.end()}),u.on("error",function(f){b.error(f)}),this},p.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},p.prototype.error=function(u){var b=this._sources;if(!i.prototype.error.call(this,u))return!1;for(var f=0;f<b.length;f++)try{b[f].error(u)}catch{}return!0},p.prototype.lock=function(){i.prototype.lock.call(this);for(var u=this._sources,b=0;b<u.length;b++)u[b].lock()},l.exports=p},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,l,r){var t=e("../compressions"),a=e("./ZipFileWorker");r.generateWorker=function(s,i,c){var h=new a(i.streamFiles,c,i.platform,i.encodeFileName),y=0;try{s.forEach(function(p,u){y++;var b=function(C,E){var S=C||E,I=t[S];if(!I)throw new Error(S+" is not a valid compression method !");return I}(u.options.compression,i.compression),f=u.options.compressionOptions||i.compressionOptions||{},v=u.dir,g=u.date;u._compressWorker(b,f).withStreamInfo("file",{name:p,dir:v,date:g,comment:u.comment||"",unixPermissions:u.unixPermissions,dosPermissions:u.dosPermissions}).pipe(h)}),h.entriesCount=y}catch(p){h.error(p)}return h}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,l,r){function t(){if(!(this instanceof t))return new t;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var a=new t;for(var s in this)typeof this[s]!="function"&&(a[s]=this[s]);return a}}(t.prototype=e("./object")).loadAsync=e("./load"),t.support=e("./support"),t.defaults=e("./defaults"),t.version="3.10.1",t.loadAsync=function(a,s){return new t().loadAsync(a,s)},t.external=e("./external"),l.exports=t},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,l,r){var t=e("./utils"),a=e("./external"),s=e("./utf8"),i=e("./zipEntries"),c=e("./stream/Crc32Probe"),h=e("./nodejsUtils");function y(p){return new a.Promise(function(u,b){var f=p.decompressed.getContentWorker().pipe(new c);f.on("error",function(v){b(v)}).on("end",function(){f.streamInfo.crc32!==p.decompressed.crc32?b(new Error("Corrupted zip : CRC32 mismatch")):u()}).resume()})}l.exports=function(p,u){var b=this;return u=t.extend(u||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:s.utf8decode}),h.isNode&&h.isStream(p)?a.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):t.prepareContent("the loaded zip file",p,!0,u.optimizedBinaryString,u.base64).then(function(f){var v=new i(u);return v.load(f),v}).then(function(f){var v=[a.Promise.resolve(f)],g=f.files;if(u.checkCRC32)for(var C=0;C<g.length;C++)v.push(y(g[C]));return a.Promise.all(v)}).then(function(f){for(var v=f.shift(),g=v.files,C=0;C<g.length;C++){var E=g[C],S=E.fileNameStr,I=t.resolve(E.fileNameStr);b.file(I,E.decompressed,{binary:!0,optimizedBinaryString:!0,date:E.date,dir:E.dir,comment:E.fileCommentStr.length?E.fileCommentStr:null,unixPermissions:E.unixPermissions,dosPermissions:E.dosPermissions,createFolders:u.createFolders}),E.dir||(b.file(I).unsafeOriginalName=S)}return v.zipComment.length&&(b.comment=v.zipComment),b})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,l,r){var t=e("../utils"),a=e("../stream/GenericWorker");function s(i,c){a.call(this,"Nodejs stream input adapter for "+i),this._upstreamEnded=!1,this._bindStream(c)}t.inherits(s,a),s.prototype._bindStream=function(i){var c=this;(this._stream=i).pause(),i.on("data",function(h){c.push({data:h,meta:{percent:0}})}).on("error",function(h){c.isPaused?this.generatedError=h:c.error(h)}).on("end",function(){c.isPaused?c._upstreamEnded=!0:c.end()})},s.prototype.pause=function(){return!!a.prototype.pause.call(this)&&(this._stream.pause(),!0)},s.prototype.resume=function(){return!!a.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},l.exports=s},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,l,r){var t=e("readable-stream").Readable;function a(s,i,c){t.call(this,i),this._helper=s;var h=this;s.on("data",function(y,p){h.push(y)||h._helper.pause(),c&&c(p)}).on("error",function(y){h.emit("error",y)}).on("end",function(){h.push(null)})}e("../utils").inherits(a,t),a.prototype._read=function(){this._helper.resume()},l.exports=a},{"../utils":32,"readable-stream":16}],14:[function(e,l,r){l.exports={isNode:typeof Buffer<"u",newBufferFrom:function(t,a){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(t,a);if(typeof t=="number")throw new Error('The "data" argument must not be a number');return new Buffer(t,a)},allocBuffer:function(t){if(Buffer.alloc)return Buffer.alloc(t);var a=new Buffer(t);return a.fill(0),a},isBuffer:function(t){return Buffer.isBuffer(t)},isStream:function(t){return t&&typeof t.on=="function"&&typeof t.pause=="function"&&typeof t.resume=="function"}}},{}],15:[function(e,l,r){function t(I,x,L){var N,R=s.getTypeOf(x),P=s.extend(L||{},h);P.date=P.date||new Date,P.compression!==null&&(P.compression=P.compression.toUpperCase()),typeof P.unixPermissions=="string"&&(P.unixPermissions=parseInt(P.unixPermissions,8)),P.unixPermissions&&16384&P.unixPermissions&&(P.dir=!0),P.dosPermissions&&16&P.dosPermissions&&(P.dir=!0),P.dir&&(I=g(I)),P.createFolders&&(N=v(I))&&C.call(this,N,!0);var Q=R==="string"&&P.binary===!1&&P.base64===!1;L&&L.binary!==void 0||(P.binary=!Q),(x instanceof y&&x.uncompressedSize===0||P.dir||!x||x.length===0)&&(P.base64=!1,P.binary=!0,x="",P.compression="STORE",R="string");var k=null;k=x instanceof y||x instanceof i?x:b.isNode&&b.isStream(x)?new f(I,x):s.prepareContent(I,x,P.binary,P.optimizedBinaryString,P.base64);var z=new p(I,k,P);this.files[I]=z}var a=e("./utf8"),s=e("./utils"),i=e("./stream/GenericWorker"),c=e("./stream/StreamHelper"),h=e("./defaults"),y=e("./compressedObject"),p=e("./zipObject"),u=e("./generate"),b=e("./nodejsUtils"),f=e("./nodejs/NodejsStreamInputAdapter"),v=function(I){I.slice(-1)==="/"&&(I=I.substring(0,I.length-1));var x=I.lastIndexOf("/");return 0<x?I.substring(0,x):""},g=function(I){return I.slice(-1)!=="/"&&(I+="/"),I},C=function(I,x){return x=x!==void 0?x:h.createFolders,I=g(I),this.files[I]||t.call(this,I,null,{dir:!0,createFolders:x}),this.files[I]};function E(I){return Object.prototype.toString.call(I)==="[object RegExp]"}var S={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(I){var x,L,N;for(x in this.files)N=this.files[x],(L=x.slice(this.root.length,x.length))&&x.slice(0,this.root.length)===this.root&&I(L,N)},filter:function(I){var x=[];return this.forEach(function(L,N){I(L,N)&&x.push(N)}),x},file:function(I,x,L){if(arguments.length!==1)return I=this.root+I,t.call(this,I,x,L),this;if(E(I)){var N=I;return this.filter(function(P,Q){return!Q.dir&&N.test(P)})}var R=this.files[this.root+I];return R&&!R.dir?R:null},folder:function(I){if(!I)return this;if(E(I))return this.filter(function(R,P){return P.dir&&I.test(R)});var x=this.root+I,L=C.call(this,x),N=this.clone();return N.root=L.name,N},remove:function(I){I=this.root+I;var x=this.files[I];if(x||(I.slice(-1)!=="/"&&(I+="/"),x=this.files[I]),x&&!x.dir)delete this.files[I];else for(var L=this.filter(function(R,P){return P.name.slice(0,I.length)===I}),N=0;N<L.length;N++)delete this.files[L[N].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(I){var x,L={};try{if((L=s.extend(I||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:a.utf8encode})).type=L.type.toLowerCase(),L.compression=L.compression.toUpperCase(),L.type==="binarystring"&&(L.type="string"),!L.type)throw new Error("No output type specified.");s.checkSupport(L.type),L.platform!=="darwin"&&L.platform!=="freebsd"&&L.platform!=="linux"&&L.platform!=="sunos"||(L.platform="UNIX"),L.platform==="win32"&&(L.platform="DOS");var N=L.comment||this.comment||"";x=u.generateWorker(this,L,N)}catch(R){(x=new i("error")).error(R)}return new c(x,L.type||"string",L.mimeType)},generateAsync:function(I,x){return this.generateInternalStream(I).accumulate(x)},generateNodeStream:function(I,x){return(I=I||{}).type||(I.type="nodebuffer"),this.generateInternalStream(I).toNodejsStream(x)}};l.exports=S},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,l,r){l.exports=e("stream")},{stream:void 0}],17:[function(e,l,r){var t=e("./DataReader");function a(s){t.call(this,s);for(var i=0;i<this.data.length;i++)s[i]=255&s[i]}e("../utils").inherits(a,t),a.prototype.byteAt=function(s){return this.data[this.zero+s]},a.prototype.lastIndexOfSignature=function(s){for(var i=s.charCodeAt(0),c=s.charCodeAt(1),h=s.charCodeAt(2),y=s.charCodeAt(3),p=this.length-4;0<=p;--p)if(this.data[p]===i&&this.data[p+1]===c&&this.data[p+2]===h&&this.data[p+3]===y)return p-this.zero;return-1},a.prototype.readAndCheckSignature=function(s){var i=s.charCodeAt(0),c=s.charCodeAt(1),h=s.charCodeAt(2),y=s.charCodeAt(3),p=this.readData(4);return i===p[0]&&c===p[1]&&h===p[2]&&y===p[3]},a.prototype.readData=function(s){if(this.checkOffset(s),s===0)return[];var i=this.data.slice(this.zero+this.index,this.zero+this.index+s);return this.index+=s,i},l.exports=a},{"../utils":32,"./DataReader":18}],18:[function(e,l,r){var t=e("../utils");function a(s){this.data=s,this.length=s.length,this.index=0,this.zero=0}a.prototype={checkOffset:function(s){this.checkIndex(this.index+s)},checkIndex:function(s){if(this.length<this.zero+s||s<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+s+"). Corrupted zip ?")},setIndex:function(s){this.checkIndex(s),this.index=s},skip:function(s){this.setIndex(this.index+s)},byteAt:function(){},readInt:function(s){var i,c=0;for(this.checkOffset(s),i=this.index+s-1;i>=this.index;i--)c=(c<<8)+this.byteAt(i);return this.index+=s,c},readString:function(s){return t.transformTo("string",this.readData(s))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var s=this.readInt(4);return new Date(Date.UTC(1980+(s>>25&127),(s>>21&15)-1,s>>16&31,s>>11&31,s>>5&63,(31&s)<<1))}},l.exports=a},{"../utils":32}],19:[function(e,l,r){var t=e("./Uint8ArrayReader");function a(s){t.call(this,s)}e("../utils").inherits(a,t),a.prototype.readData=function(s){this.checkOffset(s);var i=this.data.slice(this.zero+this.index,this.zero+this.index+s);return this.index+=s,i},l.exports=a},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,l,r){var t=e("./DataReader");function a(s){t.call(this,s)}e("../utils").inherits(a,t),a.prototype.byteAt=function(s){return this.data.charCodeAt(this.zero+s)},a.prototype.lastIndexOfSignature=function(s){return this.data.lastIndexOf(s)-this.zero},a.prototype.readAndCheckSignature=function(s){return s===this.readData(4)},a.prototype.readData=function(s){this.checkOffset(s);var i=this.data.slice(this.zero+this.index,this.zero+this.index+s);return this.index+=s,i},l.exports=a},{"../utils":32,"./DataReader":18}],21:[function(e,l,r){var t=e("./ArrayReader");function a(s){t.call(this,s)}e("../utils").inherits(a,t),a.prototype.readData=function(s){if(this.checkOffset(s),s===0)return new Uint8Array(0);var i=this.data.subarray(this.zero+this.index,this.zero+this.index+s);return this.index+=s,i},l.exports=a},{"../utils":32,"./ArrayReader":17}],22:[function(e,l,r){var t=e("../utils"),a=e("../support"),s=e("./ArrayReader"),i=e("./StringReader"),c=e("./NodeBufferReader"),h=e("./Uint8ArrayReader");l.exports=function(y){var p=t.getTypeOf(y);return t.checkSupport(p),p!=="string"||a.uint8array?p==="nodebuffer"?new c(y):a.uint8array?new h(t.transformTo("uint8array",y)):new s(t.transformTo("array",y)):new i(y)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,l,r){r.LOCAL_FILE_HEADER="PK",r.CENTRAL_FILE_HEADER="PK",r.CENTRAL_DIRECTORY_END="PK",r.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",r.ZIP64_CENTRAL_DIRECTORY_END="PK",r.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(e,l,r){var t=e("./GenericWorker"),a=e("../utils");function s(i){t.call(this,"ConvertWorker to "+i),this.destType=i}a.inherits(s,t),s.prototype.processChunk=function(i){this.push({data:a.transformTo(this.destType,i.data),meta:i.meta})},l.exports=s},{"../utils":32,"./GenericWorker":28}],25:[function(e,l,r){var t=e("./GenericWorker"),a=e("../crc32");function s(){t.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}e("../utils").inherits(s,t),s.prototype.processChunk=function(i){this.streamInfo.crc32=a(i.data,this.streamInfo.crc32||0),this.push(i)},l.exports=s},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,l,r){var t=e("../utils"),a=e("./GenericWorker");function s(i){a.call(this,"DataLengthProbe for "+i),this.propName=i,this.withStreamInfo(i,0)}t.inherits(s,a),s.prototype.processChunk=function(i){if(i){var c=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=c+i.data.length}a.prototype.processChunk.call(this,i)},l.exports=s},{"../utils":32,"./GenericWorker":28}],27:[function(e,l,r){var t=e("../utils"),a=e("./GenericWorker");function s(i){a.call(this,"DataWorker");var c=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,i.then(function(h){c.dataIsReady=!0,c.data=h,c.max=h&&h.length||0,c.type=t.getTypeOf(h),c.isPaused||c._tickAndRepeat()},function(h){c.error(h)})}t.inherits(s,a),s.prototype.cleanUp=function(){a.prototype.cleanUp.call(this),this.data=null},s.prototype.resume=function(){return!!a.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,t.delay(this._tickAndRepeat,[],this)),!0)},s.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(t.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},s.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var i=null,c=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":i=this.data.substring(this.index,c);break;case"uint8array":i=this.data.subarray(this.index,c);break;case"array":case"nodebuffer":i=this.data.slice(this.index,c)}return this.index=c,this.push({data:i,meta:{percent:this.max?this.index/this.max*100:0}})},l.exports=s},{"../utils":32,"./GenericWorker":28}],28:[function(e,l,r){function t(a){this.name=a||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}t.prototype={push:function(a){this.emit("data",a)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(a){this.emit("error",a)}return!0},error:function(a){return!this.isFinished&&(this.isPaused?this.generatedError=a:(this.isFinished=!0,this.emit("error",a),this.previous&&this.previous.error(a),this.cleanUp()),!0)},on:function(a,s){return this._listeners[a].push(s),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(a,s){if(this._listeners[a])for(var i=0;i<this._listeners[a].length;i++)this._listeners[a][i].call(this,s)},pipe:function(a){return a.registerPrevious(this)},registerPrevious:function(a){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=a.streamInfo,this.mergeStreamInfo(),this.previous=a;var s=this;return a.on("data",function(i){s.processChunk(i)}),a.on("end",function(){s.end()}),a.on("error",function(i){s.error(i)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var a=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),a=!0),this.previous&&this.previous.resume(),!a},flush:function(){},processChunk:function(a){this.push(a)},withStreamInfo:function(a,s){return this.extraStreamInfo[a]=s,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var a in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,a)&&(this.streamInfo[a]=this.extraStreamInfo[a])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var a="Worker "+this.name;return this.previous?this.previous+" -> "+a:a}},l.exports=t},{}],29:[function(e,l,r){var t=e("../utils"),a=e("./ConvertWorker"),s=e("./GenericWorker"),i=e("../base64"),c=e("../support"),h=e("../external"),y=null;if(c.nodestream)try{y=e("../nodejs/NodejsStreamOutputAdapter")}catch{}function p(b,f){return new h.Promise(function(v,g){var C=[],E=b._internalType,S=b._outputType,I=b._mimeType;b.on("data",function(x,L){C.push(x),f&&f(L)}).on("error",function(x){C=[],g(x)}).on("end",function(){try{var x=function(L,N,R){switch(L){case"blob":return t.newBlob(t.transformTo("arraybuffer",N),R);case"base64":return i.encode(N);default:return t.transformTo(L,N)}}(S,function(L,N){var R,P=0,Q=null,k=0;for(R=0;R<N.length;R++)k+=N[R].length;switch(L){case"string":return N.join("");case"array":return Array.prototype.concat.apply([],N);case"uint8array":for(Q=new Uint8Array(k),R=0;R<N.length;R++)Q.set(N[R],P),P+=N[R].length;return Q;case"nodebuffer":return Buffer.concat(N);default:throw new Error("concat : unsupported type '"+L+"'")}}(E,C),I);v(x)}catch(L){g(L)}C=[]}).resume()})}function u(b,f,v){var g=f;switch(f){case"blob":case"arraybuffer":g="uint8array";break;case"base64":g="string"}try{this._internalType=g,this._outputType=f,this._mimeType=v,t.checkSupport(g),this._worker=b.pipe(new a(g)),b.lock()}catch(C){this._worker=new s("error"),this._worker.error(C)}}u.prototype={accumulate:function(b){return p(this,b)},on:function(b,f){var v=this;return b==="data"?this._worker.on(b,function(g){f.call(v,g.data,g.meta)}):this._worker.on(b,function(){t.delay(f,arguments,v)}),this},resume:function(){return t.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(b){if(t.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new y(this,{objectMode:this._outputType!=="nodebuffer"},b)}},l.exports=u},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,l,r){if(r.base64=!0,r.array=!0,r.string=!0,r.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",r.nodebuffer=typeof Buffer<"u",r.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")r.blob=!1;else{var t=new ArrayBuffer(0);try{r.blob=new Blob([t],{type:"application/zip"}).size===0}catch{try{var a=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);a.append(t),r.blob=a.getBlob("application/zip").size===0}catch{r.blob=!1}}}try{r.nodestream=!!e("readable-stream").Readable}catch{r.nodestream=!1}},{"readable-stream":16}],31:[function(e,l,r){for(var t=e("./utils"),a=e("./support"),s=e("./nodejsUtils"),i=e("./stream/GenericWorker"),c=new Array(256),h=0;h<256;h++)c[h]=252<=h?6:248<=h?5:240<=h?4:224<=h?3:192<=h?2:1;c[254]=c[254]=1;function y(){i.call(this,"utf-8 decode"),this.leftOver=null}function p(){i.call(this,"utf-8 encode")}r.utf8encode=function(u){return a.nodebuffer?s.newBufferFrom(u,"utf-8"):function(b){var f,v,g,C,E,S=b.length,I=0;for(C=0;C<S;C++)(64512&(v=b.charCodeAt(C)))==55296&&C+1<S&&(64512&(g=b.charCodeAt(C+1)))==56320&&(v=65536+(v-55296<<10)+(g-56320),C++),I+=v<128?1:v<2048?2:v<65536?3:4;for(f=a.uint8array?new Uint8Array(I):new Array(I),C=E=0;E<I;C++)(64512&(v=b.charCodeAt(C)))==55296&&C+1<S&&(64512&(g=b.charCodeAt(C+1)))==56320&&(v=65536+(v-55296<<10)+(g-56320),C++),v<128?f[E++]=v:(v<2048?f[E++]=192|v>>>6:(v<65536?f[E++]=224|v>>>12:(f[E++]=240|v>>>18,f[E++]=128|v>>>12&63),f[E++]=128|v>>>6&63),f[E++]=128|63&v);return f}(u)},r.utf8decode=function(u){return a.nodebuffer?t.transformTo("nodebuffer",u).toString("utf-8"):function(b){var f,v,g,C,E=b.length,S=new Array(2*E);for(f=v=0;f<E;)if((g=b[f++])<128)S[v++]=g;else if(4<(C=c[g]))S[v++]=65533,f+=C-1;else{for(g&=C===2?31:C===3?15:7;1<C&&f<E;)g=g<<6|63&b[f++],C--;1<C?S[v++]=65533:g<65536?S[v++]=g:(g-=65536,S[v++]=55296|g>>10&1023,S[v++]=56320|1023&g)}return S.length!==v&&(S.subarray?S=S.subarray(0,v):S.length=v),t.applyFromCharCode(S)}(u=t.transformTo(a.uint8array?"uint8array":"array",u))},t.inherits(y,i),y.prototype.processChunk=function(u){var b=t.transformTo(a.uint8array?"uint8array":"array",u.data);if(this.leftOver&&this.leftOver.length){if(a.uint8array){var f=b;(b=new Uint8Array(f.length+this.leftOver.length)).set(this.leftOver,0),b.set(f,this.leftOver.length)}else b=this.leftOver.concat(b);this.leftOver=null}var v=function(C,E){var S;for((E=E||C.length)>C.length&&(E=C.length),S=E-1;0<=S&&(192&C[S])==128;)S--;return S<0||S===0?E:S+c[C[S]]>E?S:E}(b),g=b;v!==b.length&&(a.uint8array?(g=b.subarray(0,v),this.leftOver=b.subarray(v,b.length)):(g=b.slice(0,v),this.leftOver=b.slice(v,b.length))),this.push({data:r.utf8decode(g),meta:u.meta})},y.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:r.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},r.Utf8DecodeWorker=y,t.inherits(p,i),p.prototype.processChunk=function(u){this.push({data:r.utf8encode(u.data),meta:u.meta})},r.Utf8EncodeWorker=p},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,l,r){var t=e("./support"),a=e("./base64"),s=e("./nodejsUtils"),i=e("./external");function c(f){return f}function h(f,v){for(var g=0;g<f.length;++g)v[g]=255&f.charCodeAt(g);return v}e("setimmediate"),r.newBlob=function(f,v){r.checkSupport("blob");try{return new Blob([f],{type:v})}catch{try{var g=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return g.append(f),g.getBlob(v)}catch{throw new Error("Bug : can't construct the Blob.")}}};var y={stringifyByChunk:function(f,v,g){var C=[],E=0,S=f.length;if(S<=g)return String.fromCharCode.apply(null,f);for(;E<S;)v==="array"||v==="nodebuffer"?C.push(String.fromCharCode.apply(null,f.slice(E,Math.min(E+g,S)))):C.push(String.fromCharCode.apply(null,f.subarray(E,Math.min(E+g,S)))),E+=g;return C.join("")},stringifyByChar:function(f){for(var v="",g=0;g<f.length;g++)v+=String.fromCharCode(f[g]);return v},applyCanBeUsed:{uint8array:function(){try{return t.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}}(),nodebuffer:function(){try{return t.nodebuffer&&String.fromCharCode.apply(null,s.allocBuffer(1)).length===1}catch{return!1}}()}};function p(f){var v=65536,g=r.getTypeOf(f),C=!0;if(g==="uint8array"?C=y.applyCanBeUsed.uint8array:g==="nodebuffer"&&(C=y.applyCanBeUsed.nodebuffer),C)for(;1<v;)try{return y.stringifyByChunk(f,g,v)}catch{v=Math.floor(v/2)}return y.stringifyByChar(f)}function u(f,v){for(var g=0;g<f.length;g++)v[g]=f[g];return v}r.applyFromCharCode=p;var b={};b.string={string:c,array:function(f){return h(f,new Array(f.length))},arraybuffer:function(f){return b.string.uint8array(f).buffer},uint8array:function(f){return h(f,new Uint8Array(f.length))},nodebuffer:function(f){return h(f,s.allocBuffer(f.length))}},b.array={string:p,array:c,arraybuffer:function(f){return new Uint8Array(f).buffer},uint8array:function(f){return new Uint8Array(f)},nodebuffer:function(f){return s.newBufferFrom(f)}},b.arraybuffer={string:function(f){return p(new Uint8Array(f))},array:function(f){return u(new Uint8Array(f),new Array(f.byteLength))},arraybuffer:c,uint8array:function(f){return new Uint8Array(f)},nodebuffer:function(f){return s.newBufferFrom(new Uint8Array(f))}},b.uint8array={string:p,array:function(f){return u(f,new Array(f.length))},arraybuffer:function(f){return f.buffer},uint8array:c,nodebuffer:function(f){return s.newBufferFrom(f)}},b.nodebuffer={string:p,array:function(f){return u(f,new Array(f.length))},arraybuffer:function(f){return b.nodebuffer.uint8array(f).buffer},uint8array:function(f){return u(f,new Uint8Array(f.length))},nodebuffer:c},r.transformTo=function(f,v){if(v=v||"",!f)return v;r.checkSupport(f);var g=r.getTypeOf(v);return b[g][f](v)},r.resolve=function(f){for(var v=f.split("/"),g=[],C=0;C<v.length;C++){var E=v[C];E==="."||E===""&&C!==0&&C!==v.length-1||(E===".."?g.pop():g.push(E))}return g.join("/")},r.getTypeOf=function(f){return typeof f=="string"?"string":Object.prototype.toString.call(f)==="[object Array]"?"array":t.nodebuffer&&s.isBuffer(f)?"nodebuffer":t.uint8array&&f instanceof Uint8Array?"uint8array":t.arraybuffer&&f instanceof ArrayBuffer?"arraybuffer":void 0},r.checkSupport=function(f){if(!t[f.toLowerCase()])throw new Error(f+" is not supported by this platform")},r.MAX_VALUE_16BITS=65535,r.MAX_VALUE_32BITS=-1,r.pretty=function(f){var v,g,C="";for(g=0;g<(f||"").length;g++)C+="\\x"+((v=f.charCodeAt(g))<16?"0":"")+v.toString(16).toUpperCase();return C},r.delay=function(f,v,g){setImmediate(function(){f.apply(g||null,v||[])})},r.inherits=function(f,v){function g(){}g.prototype=v.prototype,f.prototype=new g},r.extend=function(){var f,v,g={};for(f=0;f<arguments.length;f++)for(v in arguments[f])Object.prototype.hasOwnProperty.call(arguments[f],v)&&g[v]===void 0&&(g[v]=arguments[f][v]);return g},r.prepareContent=function(f,v,g,C,E){return i.Promise.resolve(v).then(function(S){return t.blob&&(S instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(S))!==-1)&&typeof FileReader<"u"?new i.Promise(function(I,x){var L=new FileReader;L.onload=function(N){I(N.target.result)},L.onerror=function(N){x(N.target.error)},L.readAsArrayBuffer(S)}):S}).then(function(S){var I=r.getTypeOf(S);return I?(I==="arraybuffer"?S=r.transformTo("uint8array",S):I==="string"&&(E?S=a.decode(S):g&&C!==!0&&(S=function(x){return h(x,t.uint8array?new Uint8Array(x.length):new Array(x.length))}(S))),S):i.Promise.reject(new Error("Can't read the data of '"+f+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(e,l,r){var t=e("./reader/readerFor"),a=e("./utils"),s=e("./signature"),i=e("./zipEntry"),c=e("./support");function h(y){this.files=[],this.loadOptions=y}h.prototype={checkSignature:function(y){if(!this.reader.readAndCheckSignature(y)){this.reader.index-=4;var p=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+a.pretty(p)+", expected "+a.pretty(y)+")")}},isSignature:function(y,p){var u=this.reader.index;this.reader.setIndex(y);var b=this.reader.readString(4)===p;return this.reader.setIndex(u),b},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var y=this.reader.readData(this.zipCommentLength),p=c.uint8array?"uint8array":"array",u=a.transformTo(p,y);this.zipComment=this.loadOptions.decodeFileName(u)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var y,p,u,b=this.zip64EndOfCentralSize-44;0<b;)y=this.reader.readInt(2),p=this.reader.readInt(4),u=this.reader.readData(p),this.zip64ExtensibleData[y]={id:y,length:p,value:u}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var y,p;for(y=0;y<this.files.length;y++)p=this.files[y],this.reader.setIndex(p.localHeaderOffset),this.checkSignature(s.LOCAL_FILE_HEADER),p.readLocalPart(this.reader),p.handleUTF8(),p.processAttributes()},readCentralDir:function(){var y;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(s.CENTRAL_FILE_HEADER);)(y=new i({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(y);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var y=this.reader.lastIndexOfSignature(s.CENTRAL_DIRECTORY_END);if(y<0)throw this.isSignature(0,s.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(y);var p=y;if(this.checkSignature(s.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===a.MAX_VALUE_16BITS||this.diskWithCentralDirStart===a.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===a.MAX_VALUE_16BITS||this.centralDirRecords===a.MAX_VALUE_16BITS||this.centralDirSize===a.MAX_VALUE_32BITS||this.centralDirOffset===a.MAX_VALUE_32BITS){if(this.zip64=!0,(y=this.reader.lastIndexOfSignature(s.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(y),this.checkSignature(s.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,s.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(s.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(s.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var u=this.centralDirOffset+this.centralDirSize;this.zip64&&(u+=20,u+=12+this.zip64EndOfCentralSize);var b=p-u;if(0<b)this.isSignature(p,s.CENTRAL_FILE_HEADER)||(this.reader.zero=b);else if(b<0)throw new Error("Corrupted zip: missing "+Math.abs(b)+" bytes.")},prepareReader:function(y){this.reader=t(y)},load:function(y){this.prepareReader(y),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},l.exports=h},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(e,l,r){var t=e("./reader/readerFor"),a=e("./utils"),s=e("./compressedObject"),i=e("./crc32"),c=e("./utf8"),h=e("./compressions"),y=e("./support");function p(u,b){this.options=u,this.loadOptions=b}p.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(u){var b,f;if(u.skip(22),this.fileNameLength=u.readInt(2),f=u.readInt(2),this.fileName=u.readData(this.fileNameLength),u.skip(f),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((b=function(v){for(var g in h)if(Object.prototype.hasOwnProperty.call(h,g)&&h[g].magic===v)return h[g];return null}(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+a.pretty(this.compressionMethod)+" unknown (inner file : "+a.transformTo("string",this.fileName)+")");this.decompressed=new s(this.compressedSize,this.uncompressedSize,this.crc32,b,u.readData(this.compressedSize))},readCentralPart:function(u){this.versionMadeBy=u.readInt(2),u.skip(2),this.bitFlag=u.readInt(2),this.compressionMethod=u.readString(2),this.date=u.readDate(),this.crc32=u.readInt(4),this.compressedSize=u.readInt(4),this.uncompressedSize=u.readInt(4);var b=u.readInt(2);if(this.extraFieldsLength=u.readInt(2),this.fileCommentLength=u.readInt(2),this.diskNumberStart=u.readInt(2),this.internalFileAttributes=u.readInt(2),this.externalFileAttributes=u.readInt(4),this.localHeaderOffset=u.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");u.skip(b),this.readExtraFields(u),this.parseZIP64ExtraField(u),this.fileComment=u.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var u=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),u==0&&(this.dosPermissions=63&this.externalFileAttributes),u==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var u=t(this.extraFields[1].value);this.uncompressedSize===a.MAX_VALUE_32BITS&&(this.uncompressedSize=u.readInt(8)),this.compressedSize===a.MAX_VALUE_32BITS&&(this.compressedSize=u.readInt(8)),this.localHeaderOffset===a.MAX_VALUE_32BITS&&(this.localHeaderOffset=u.readInt(8)),this.diskNumberStart===a.MAX_VALUE_32BITS&&(this.diskNumberStart=u.readInt(4))}},readExtraFields:function(u){var b,f,v,g=u.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});u.index+4<g;)b=u.readInt(2),f=u.readInt(2),v=u.readData(f),this.extraFields[b]={id:b,length:f,value:v};u.setIndex(g)},handleUTF8:function(){var u=y.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=c.utf8decode(this.fileName),this.fileCommentStr=c.utf8decode(this.fileComment);else{var b=this.findExtraFieldUnicodePath();if(b!==null)this.fileNameStr=b;else{var f=a.transformTo(u,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(f)}var v=this.findExtraFieldUnicodeComment();if(v!==null)this.fileCommentStr=v;else{var g=a.transformTo(u,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(g)}}},findExtraFieldUnicodePath:function(){var u=this.extraFields[28789];if(u){var b=t(u.value);return b.readInt(1)!==1||i(this.fileName)!==b.readInt(4)?null:c.utf8decode(b.readData(u.length-5))}return null},findExtraFieldUnicodeComment:function(){var u=this.extraFields[25461];if(u){var b=t(u.value);return b.readInt(1)!==1||i(this.fileComment)!==b.readInt(4)?null:c.utf8decode(b.readData(u.length-5))}return null}},l.exports=p},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(e,l,r){function t(b,f,v){this.name=b,this.dir=v.dir,this.date=v.date,this.comment=v.comment,this.unixPermissions=v.unixPermissions,this.dosPermissions=v.dosPermissions,this._data=f,this._dataBinary=v.binary,this.options={compression:v.compression,compressionOptions:v.compressionOptions}}var a=e("./stream/StreamHelper"),s=e("./stream/DataWorker"),i=e("./utf8"),c=e("./compressedObject"),h=e("./stream/GenericWorker");t.prototype={internalStream:function(b){var f=null,v="string";try{if(!b)throw new Error("No output type specified.");var g=(v=b.toLowerCase())==="string"||v==="text";v!=="binarystring"&&v!=="text"||(v="string"),f=this._decompressWorker();var C=!this._dataBinary;C&&!g&&(f=f.pipe(new i.Utf8EncodeWorker)),!C&&g&&(f=f.pipe(new i.Utf8DecodeWorker))}catch(E){(f=new h("error")).error(E)}return new a(f,v,"")},async:function(b,f){return this.internalStream(b).accumulate(f)},nodeStream:function(b,f){return this.internalStream(b||"nodebuffer").toNodejsStream(f)},_compressWorker:function(b,f){if(this._data instanceof c&&this._data.compression.magic===b.magic)return this._data.getCompressedWorker();var v=this._decompressWorker();return this._dataBinary||(v=v.pipe(new i.Utf8EncodeWorker)),c.createWorkerFrom(v,b,f)},_decompressWorker:function(){return this._data instanceof c?this._data.getContentWorker():this._data instanceof h?this._data:new s(this._data)}};for(var y=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],p=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},u=0;u<y.length;u++)t.prototype[y[u]]=p;l.exports=t},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(e,l,r){(function(t){var a,s,i=t.MutationObserver||t.WebKitMutationObserver;if(i){var c=0,h=new i(b),y=t.document.createTextNode("");h.observe(y,{characterData:!0}),a=function(){y.data=c=++c%2}}else if(t.setImmediate||t.MessageChannel===void 0)a="document"in t&&"onreadystatechange"in t.document.createElement("script")?function(){var f=t.document.createElement("script");f.onreadystatechange=function(){b(),f.onreadystatechange=null,f.parentNode.removeChild(f),f=null},t.document.documentElement.appendChild(f)}:function(){setTimeout(b,0)};else{var p=new t.MessageChannel;p.port1.onmessage=b,a=function(){p.port2.postMessage(0)}}var u=[];function b(){var f,v;s=!0;for(var g=u.length;g;){for(v=u,u=[],f=-1;++f<g;)v[f]();g=u.length}s=!1}l.exports=function(f){u.push(f)!==1||s||a()}}).call(this,typeof mn<"u"?mn:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(e,l,r){var t=e("immediate");function a(){}var s={},i=["REJECTED"],c=["FULFILLED"],h=["PENDING"];function y(g){if(typeof g!="function")throw new TypeError("resolver must be a function");this.state=h,this.queue=[],this.outcome=void 0,g!==a&&f(this,g)}function p(g,C,E){this.promise=g,typeof C=="function"&&(this.onFulfilled=C,this.callFulfilled=this.otherCallFulfilled),typeof E=="function"&&(this.onRejected=E,this.callRejected=this.otherCallRejected)}function u(g,C,E){t(function(){var S;try{S=C(E)}catch(I){return s.reject(g,I)}S===g?s.reject(g,new TypeError("Cannot resolve promise with itself")):s.resolve(g,S)})}function b(g){var C=g&&g.then;if(g&&(typeof g=="object"||typeof g=="function")&&typeof C=="function")return function(){C.apply(g,arguments)}}function f(g,C){var E=!1;function S(L){E||(E=!0,s.reject(g,L))}function I(L){E||(E=!0,s.resolve(g,L))}var x=v(function(){C(I,S)});x.status==="error"&&S(x.value)}function v(g,C){var E={};try{E.value=g(C),E.status="success"}catch(S){E.status="error",E.value=S}return E}(l.exports=y).prototype.finally=function(g){if(typeof g!="function")return this;var C=this.constructor;return this.then(function(E){return C.resolve(g()).then(function(){return E})},function(E){return C.resolve(g()).then(function(){throw E})})},y.prototype.catch=function(g){return this.then(null,g)},y.prototype.then=function(g,C){if(typeof g!="function"&&this.state===c||typeof C!="function"&&this.state===i)return this;var E=new this.constructor(a);return this.state!==h?u(E,this.state===c?g:C,this.outcome):this.queue.push(new p(E,g,C)),E},p.prototype.callFulfilled=function(g){s.resolve(this.promise,g)},p.prototype.otherCallFulfilled=function(g){u(this.promise,this.onFulfilled,g)},p.prototype.callRejected=function(g){s.reject(this.promise,g)},p.prototype.otherCallRejected=function(g){u(this.promise,this.onRejected,g)},s.resolve=function(g,C){var E=v(b,C);if(E.status==="error")return s.reject(g,E.value);var S=E.value;if(S)f(g,S);else{g.state=c,g.outcome=C;for(var I=-1,x=g.queue.length;++I<x;)g.queue[I].callFulfilled(C)}return g},s.reject=function(g,C){g.state=i,g.outcome=C;for(var E=-1,S=g.queue.length;++E<S;)g.queue[E].callRejected(C);return g},y.resolve=function(g){return g instanceof this?g:s.resolve(new this(a),g)},y.reject=function(g){var C=new this(a);return s.reject(C,g)},y.all=function(g){var C=this;if(Object.prototype.toString.call(g)!=="[object Array]")return this.reject(new TypeError("must be an array"));var E=g.length,S=!1;if(!E)return this.resolve([]);for(var I=new Array(E),x=0,L=-1,N=new this(a);++L<E;)R(g[L],L);return N;function R(P,Q){C.resolve(P).then(function(k){I[Q]=k,++x!==E||S||(S=!0,s.resolve(N,I))},function(k){S||(S=!0,s.reject(N,k))})}},y.race=function(g){var C=this;if(Object.prototype.toString.call(g)!=="[object Array]")return this.reject(new TypeError("must be an array"));var E=g.length,S=!1;if(!E)return this.resolve([]);for(var I=-1,x=new this(a);++I<E;)L=g[I],C.resolve(L).then(function(N){S||(S=!0,s.resolve(x,N))},function(N){S||(S=!0,s.reject(x,N))});var L;return x}},{immediate:36}],38:[function(e,l,r){var t={};(0,e("./lib/utils/common").assign)(t,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),l.exports=t},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(e,l,r){var t=e("./zlib/deflate"),a=e("./utils/common"),s=e("./utils/strings"),i=e("./zlib/messages"),c=e("./zlib/zstream"),h=Object.prototype.toString,y=0,p=-1,u=0,b=8;function f(g){if(!(this instanceof f))return new f(g);this.options=a.assign({level:p,method:b,chunkSize:16384,windowBits:15,memLevel:8,strategy:u,to:""},g||{});var C=this.options;C.raw&&0<C.windowBits?C.windowBits=-C.windowBits:C.gzip&&0<C.windowBits&&C.windowBits<16&&(C.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new c,this.strm.avail_out=0;var E=t.deflateInit2(this.strm,C.level,C.method,C.windowBits,C.memLevel,C.strategy);if(E!==y)throw new Error(i[E]);if(C.header&&t.deflateSetHeader(this.strm,C.header),C.dictionary){var S;if(S=typeof C.dictionary=="string"?s.string2buf(C.dictionary):h.call(C.dictionary)==="[object ArrayBuffer]"?new Uint8Array(C.dictionary):C.dictionary,(E=t.deflateSetDictionary(this.strm,S))!==y)throw new Error(i[E]);this._dict_set=!0}}function v(g,C){var E=new f(C);if(E.push(g,!0),E.err)throw E.msg||i[E.err];return E.result}f.prototype.push=function(g,C){var E,S,I=this.strm,x=this.options.chunkSize;if(this.ended)return!1;S=C===~~C?C:C===!0?4:0,typeof g=="string"?I.input=s.string2buf(g):h.call(g)==="[object ArrayBuffer]"?I.input=new Uint8Array(g):I.input=g,I.next_in=0,I.avail_in=I.input.length;do{if(I.avail_out===0&&(I.output=new a.Buf8(x),I.next_out=0,I.avail_out=x),(E=t.deflate(I,S))!==1&&E!==y)return this.onEnd(E),!(this.ended=!0);I.avail_out!==0&&(I.avail_in!==0||S!==4&&S!==2)||(this.options.to==="string"?this.onData(s.buf2binstring(a.shrinkBuf(I.output,I.next_out))):this.onData(a.shrinkBuf(I.output,I.next_out)))}while((0<I.avail_in||I.avail_out===0)&&E!==1);return S===4?(E=t.deflateEnd(this.strm),this.onEnd(E),this.ended=!0,E===y):S!==2||(this.onEnd(y),!(I.avail_out=0))},f.prototype.onData=function(g){this.chunks.push(g)},f.prototype.onEnd=function(g){g===y&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=a.flattenChunks(this.chunks)),this.chunks=[],this.err=g,this.msg=this.strm.msg},r.Deflate=f,r.deflate=v,r.deflateRaw=function(g,C){return(C=C||{}).raw=!0,v(g,C)},r.gzip=function(g,C){return(C=C||{}).gzip=!0,v(g,C)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(e,l,r){var t=e("./zlib/inflate"),a=e("./utils/common"),s=e("./utils/strings"),i=e("./zlib/constants"),c=e("./zlib/messages"),h=e("./zlib/zstream"),y=e("./zlib/gzheader"),p=Object.prototype.toString;function u(f){if(!(this instanceof u))return new u(f);this.options=a.assign({chunkSize:16384,windowBits:0,to:""},f||{});var v=this.options;v.raw&&0<=v.windowBits&&v.windowBits<16&&(v.windowBits=-v.windowBits,v.windowBits===0&&(v.windowBits=-15)),!(0<=v.windowBits&&v.windowBits<16)||f&&f.windowBits||(v.windowBits+=32),15<v.windowBits&&v.windowBits<48&&!(15&v.windowBits)&&(v.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new h,this.strm.avail_out=0;var g=t.inflateInit2(this.strm,v.windowBits);if(g!==i.Z_OK)throw new Error(c[g]);this.header=new y,t.inflateGetHeader(this.strm,this.header)}function b(f,v){var g=new u(v);if(g.push(f,!0),g.err)throw g.msg||c[g.err];return g.result}u.prototype.push=function(f,v){var g,C,E,S,I,x,L=this.strm,N=this.options.chunkSize,R=this.options.dictionary,P=!1;if(this.ended)return!1;C=v===~~v?v:v===!0?i.Z_FINISH:i.Z_NO_FLUSH,typeof f=="string"?L.input=s.binstring2buf(f):p.call(f)==="[object ArrayBuffer]"?L.input=new Uint8Array(f):L.input=f,L.next_in=0,L.avail_in=L.input.length;do{if(L.avail_out===0&&(L.output=new a.Buf8(N),L.next_out=0,L.avail_out=N),(g=t.inflate(L,i.Z_NO_FLUSH))===i.Z_NEED_DICT&&R&&(x=typeof R=="string"?s.string2buf(R):p.call(R)==="[object ArrayBuffer]"?new Uint8Array(R):R,g=t.inflateSetDictionary(this.strm,x)),g===i.Z_BUF_ERROR&&P===!0&&(g=i.Z_OK,P=!1),g!==i.Z_STREAM_END&&g!==i.Z_OK)return this.onEnd(g),!(this.ended=!0);L.next_out&&(L.avail_out!==0&&g!==i.Z_STREAM_END&&(L.avail_in!==0||C!==i.Z_FINISH&&C!==i.Z_SYNC_FLUSH)||(this.options.to==="string"?(E=s.utf8border(L.output,L.next_out),S=L.next_out-E,I=s.buf2string(L.output,E),L.next_out=S,L.avail_out=N-S,S&&a.arraySet(L.output,L.output,E,S,0),this.onData(I)):this.onData(a.shrinkBuf(L.output,L.next_out)))),L.avail_in===0&&L.avail_out===0&&(P=!0)}while((0<L.avail_in||L.avail_out===0)&&g!==i.Z_STREAM_END);return g===i.Z_STREAM_END&&(C=i.Z_FINISH),C===i.Z_FINISH?(g=t.inflateEnd(this.strm),this.onEnd(g),this.ended=!0,g===i.Z_OK):C!==i.Z_SYNC_FLUSH||(this.onEnd(i.Z_OK),!(L.avail_out=0))},u.prototype.onData=function(f){this.chunks.push(f)},u.prototype.onEnd=function(f){f===i.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=a.flattenChunks(this.chunks)),this.chunks=[],this.err=f,this.msg=this.strm.msg},r.Inflate=u,r.inflate=b,r.inflateRaw=function(f,v){return(v=v||{}).raw=!0,b(f,v)},r.ungzip=b},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(e,l,r){var t=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";r.assign=function(i){for(var c=Array.prototype.slice.call(arguments,1);c.length;){var h=c.shift();if(h){if(typeof h!="object")throw new TypeError(h+"must be non-object");for(var y in h)h.hasOwnProperty(y)&&(i[y]=h[y])}}return i},r.shrinkBuf=function(i,c){return i.length===c?i:i.subarray?i.subarray(0,c):(i.length=c,i)};var a={arraySet:function(i,c,h,y,p){if(c.subarray&&i.subarray)i.set(c.subarray(h,h+y),p);else for(var u=0;u<y;u++)i[p+u]=c[h+u]},flattenChunks:function(i){var c,h,y,p,u,b;for(c=y=0,h=i.length;c<h;c++)y+=i[c].length;for(b=new Uint8Array(y),c=p=0,h=i.length;c<h;c++)u=i[c],b.set(u,p),p+=u.length;return b}},s={arraySet:function(i,c,h,y,p){for(var u=0;u<y;u++)i[p+u]=c[h+u]},flattenChunks:function(i){return[].concat.apply([],i)}};r.setTyped=function(i){i?(r.Buf8=Uint8Array,r.Buf16=Uint16Array,r.Buf32=Int32Array,r.assign(r,a)):(r.Buf8=Array,r.Buf16=Array,r.Buf32=Array,r.assign(r,s))},r.setTyped(t)},{}],42:[function(e,l,r){var t=e("./common"),a=!0,s=!0;try{String.fromCharCode.apply(null,[0])}catch{a=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{s=!1}for(var i=new t.Buf8(256),c=0;c<256;c++)i[c]=252<=c?6:248<=c?5:240<=c?4:224<=c?3:192<=c?2:1;function h(y,p){if(p<65537&&(y.subarray&&s||!y.subarray&&a))return String.fromCharCode.apply(null,t.shrinkBuf(y,p));for(var u="",b=0;b<p;b++)u+=String.fromCharCode(y[b]);return u}i[254]=i[254]=1,r.string2buf=function(y){var p,u,b,f,v,g=y.length,C=0;for(f=0;f<g;f++)(64512&(u=y.charCodeAt(f)))==55296&&f+1<g&&(64512&(b=y.charCodeAt(f+1)))==56320&&(u=65536+(u-55296<<10)+(b-56320),f++),C+=u<128?1:u<2048?2:u<65536?3:4;for(p=new t.Buf8(C),f=v=0;v<C;f++)(64512&(u=y.charCodeAt(f)))==55296&&f+1<g&&(64512&(b=y.charCodeAt(f+1)))==56320&&(u=65536+(u-55296<<10)+(b-56320),f++),u<128?p[v++]=u:(u<2048?p[v++]=192|u>>>6:(u<65536?p[v++]=224|u>>>12:(p[v++]=240|u>>>18,p[v++]=128|u>>>12&63),p[v++]=128|u>>>6&63),p[v++]=128|63&u);return p},r.buf2binstring=function(y){return h(y,y.length)},r.binstring2buf=function(y){for(var p=new t.Buf8(y.length),u=0,b=p.length;u<b;u++)p[u]=y.charCodeAt(u);return p},r.buf2string=function(y,p){var u,b,f,v,g=p||y.length,C=new Array(2*g);for(u=b=0;u<g;)if((f=y[u++])<128)C[b++]=f;else if(4<(v=i[f]))C[b++]=65533,u+=v-1;else{for(f&=v===2?31:v===3?15:7;1<v&&u<g;)f=f<<6|63&y[u++],v--;1<v?C[b++]=65533:f<65536?C[b++]=f:(f-=65536,C[b++]=55296|f>>10&1023,C[b++]=56320|1023&f)}return h(C,b)},r.utf8border=function(y,p){var u;for((p=p||y.length)>y.length&&(p=y.length),u=p-1;0<=u&&(192&y[u])==128;)u--;return u<0||u===0?p:u+i[y[u]]>p?u:p}},{"./common":41}],43:[function(e,l,r){l.exports=function(t,a,s,i){for(var c=65535&t|0,h=t>>>16&65535|0,y=0;s!==0;){for(s-=y=2e3<s?2e3:s;h=h+(c=c+a[i++]|0)|0,--y;);c%=65521,h%=65521}return c|h<<16|0}},{}],44:[function(e,l,r){l.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(e,l,r){var t=function(){for(var a,s=[],i=0;i<256;i++){a=i;for(var c=0;c<8;c++)a=1&a?3988292384^a>>>1:a>>>1;s[i]=a}return s}();l.exports=function(a,s,i,c){var h=t,y=c+i;a^=-1;for(var p=c;p<y;p++)a=a>>>8^h[255&(a^s[p])];return-1^a}},{}],46:[function(e,l,r){var t,a=e("../utils/common"),s=e("./trees"),i=e("./adler32"),c=e("./crc32"),h=e("./messages"),y=0,p=4,u=0,b=-2,f=-1,v=4,g=2,C=8,E=9,S=286,I=30,x=19,L=2*S+1,N=15,R=3,P=258,Q=P+R+1,k=42,z=113,m=1,H=2,ue=3,Z=4;function fe(d,W){return d.msg=h[W],W}function F(d){return(d<<1)-(4<d?9:0)}function ne(d){for(var W=d.length;0<=--W;)d[W]=0}function A(d){var W=d.state,$=W.pending;$>d.avail_out&&($=d.avail_out),$!==0&&(a.arraySet(d.output,W.pending_buf,W.pending_out,$,d.next_out),d.next_out+=$,W.pending_out+=$,d.total_out+=$,d.avail_out-=$,W.pending-=$,W.pending===0&&(W.pending_out=0))}function M(d,W){s._tr_flush_block(d,0<=d.block_start?d.block_start:-1,d.strstart-d.block_start,W),d.block_start=d.strstart,A(d.strm)}function oe(d,W){d.pending_buf[d.pending++]=W}function te(d,W){d.pending_buf[d.pending++]=W>>>8&255,d.pending_buf[d.pending++]=255&W}function Y(d,W){var $,_,w=d.max_chain_length,T=d.strstart,j=d.prev_length,q=d.nice_match,O=d.strstart>d.w_size-Q?d.strstart-(d.w_size-Q):0,V=d.window,se=d.w_mask,J=d.prev,le=d.strstart+P,Ie=V[T+j-1],me=V[T+j];d.prev_length>=d.good_match&&(w>>=2),q>d.lookahead&&(q=d.lookahead);do if(V[($=W)+j]===me&&V[$+j-1]===Ie&&V[$]===V[T]&&V[++$]===V[T+1]){T+=2,$++;do;while(V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&T<le);if(_=P-(le-T),T=le-P,j<_){if(d.match_start=W,q<=(j=_))break;Ie=V[T+j-1],me=V[T+j]}}while((W=J[W&se])>O&&--w!=0);return j<=d.lookahead?j:d.lookahead}function Be(d){var W,$,_,w,T,j,q,O,V,se,J=d.w_size;do{if(w=d.window_size-d.lookahead-d.strstart,d.strstart>=J+(J-Q)){for(a.arraySet(d.window,d.window,J,J,0),d.match_start-=J,d.strstart-=J,d.block_start-=J,W=$=d.hash_size;_=d.head[--W],d.head[W]=J<=_?_-J:0,--$;);for(W=$=J;_=d.prev[--W],d.prev[W]=J<=_?_-J:0,--$;);w+=J}if(d.strm.avail_in===0)break;if(j=d.strm,q=d.window,O=d.strstart+d.lookahead,V=w,se=void 0,se=j.avail_in,V<se&&(se=V),$=se===0?0:(j.avail_in-=se,a.arraySet(q,j.input,j.next_in,se,O),j.state.wrap===1?j.adler=i(j.adler,q,se,O):j.state.wrap===2&&(j.adler=c(j.adler,q,se,O)),j.next_in+=se,j.total_in+=se,se),d.lookahead+=$,d.lookahead+d.insert>=R)for(T=d.strstart-d.insert,d.ins_h=d.window[T],d.ins_h=(d.ins_h<<d.hash_shift^d.window[T+1])&d.hash_mask;d.insert&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[T+R-1])&d.hash_mask,d.prev[T&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=T,T++,d.insert--,!(d.lookahead+d.insert<R)););}while(d.lookahead<Q&&d.strm.avail_in!==0)}function Ne(d,W){for(var $,_;;){if(d.lookahead<Q){if(Be(d),d.lookahead<Q&&W===y)return m;if(d.lookahead===0)break}if($=0,d.lookahead>=R&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),$!==0&&d.strstart-$<=d.w_size-Q&&(d.match_length=Y(d,$)),d.match_length>=R)if(_=s._tr_tally(d,d.strstart-d.match_start,d.match_length-R),d.lookahead-=d.match_length,d.match_length<=d.max_lazy_match&&d.lookahead>=R){for(d.match_length--;d.strstart++,d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart,--d.match_length!=0;);d.strstart++}else d.strstart+=d.match_length,d.match_length=0,d.ins_h=d.window[d.strstart],d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+1])&d.hash_mask;else _=s._tr_tally(d,0,d.window[d.strstart]),d.lookahead--,d.strstart++;if(_&&(M(d,!1),d.strm.avail_out===0))return m}return d.insert=d.strstart<R-1?d.strstart:R-1,W===p?(M(d,!0),d.strm.avail_out===0?ue:Z):d.last_lit&&(M(d,!1),d.strm.avail_out===0)?m:H}function pe(d,W){for(var $,_,w;;){if(d.lookahead<Q){if(Be(d),d.lookahead<Q&&W===y)return m;if(d.lookahead===0)break}if($=0,d.lookahead>=R&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),d.prev_length=d.match_length,d.prev_match=d.match_start,d.match_length=R-1,$!==0&&d.prev_length<d.max_lazy_match&&d.strstart-$<=d.w_size-Q&&(d.match_length=Y(d,$),d.match_length<=5&&(d.strategy===1||d.match_length===R&&4096<d.strstart-d.match_start)&&(d.match_length=R-1)),d.prev_length>=R&&d.match_length<=d.prev_length){for(w=d.strstart+d.lookahead-R,_=s._tr_tally(d,d.strstart-1-d.prev_match,d.prev_length-R),d.lookahead-=d.prev_length-1,d.prev_length-=2;++d.strstart<=w&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+R-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),--d.prev_length!=0;);if(d.match_available=0,d.match_length=R-1,d.strstart++,_&&(M(d,!1),d.strm.avail_out===0))return m}else if(d.match_available){if((_=s._tr_tally(d,0,d.window[d.strstart-1]))&&M(d,!1),d.strstart++,d.lookahead--,d.strm.avail_out===0)return m}else d.match_available=1,d.strstart++,d.lookahead--}return d.match_available&&(_=s._tr_tally(d,0,d.window[d.strstart-1]),d.match_available=0),d.insert=d.strstart<R-1?d.strstart:R-1,W===p?(M(d,!0),d.strm.avail_out===0?ue:Z):d.last_lit&&(M(d,!1),d.strm.avail_out===0)?m:H}function ve(d,W,$,_,w){this.good_length=d,this.max_lazy=W,this.nice_length=$,this.max_chain=_,this.func=w}function Le(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=C,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new a.Buf16(2*L),this.dyn_dtree=new a.Buf16(2*(2*I+1)),this.bl_tree=new a.Buf16(2*(2*x+1)),ne(this.dyn_ltree),ne(this.dyn_dtree),ne(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new a.Buf16(N+1),this.heap=new a.Buf16(2*S+1),ne(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new a.Buf16(2*S+1),ne(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function De(d){var W;return d&&d.state?(d.total_in=d.total_out=0,d.data_type=g,(W=d.state).pending=0,W.pending_out=0,W.wrap<0&&(W.wrap=-W.wrap),W.status=W.wrap?k:z,d.adler=W.wrap===2?0:1,W.last_flush=y,s._tr_init(W),u):fe(d,b)}function Je(d){var W=De(d);return W===u&&function($){$.window_size=2*$.w_size,ne($.head),$.max_lazy_match=t[$.level].max_lazy,$.good_match=t[$.level].good_length,$.nice_match=t[$.level].nice_length,$.max_chain_length=t[$.level].max_chain,$.strstart=0,$.block_start=0,$.lookahead=0,$.insert=0,$.match_length=$.prev_length=R-1,$.match_available=0,$.ins_h=0}(d.state),W}function Ye(d,W,$,_,w,T){if(!d)return b;var j=1;if(W===f&&(W=6),_<0?(j=0,_=-_):15<_&&(j=2,_-=16),w<1||E<w||$!==C||_<8||15<_||W<0||9<W||T<0||v<T)return fe(d,b);_===8&&(_=9);var q=new Le;return(d.state=q).strm=d,q.wrap=j,q.gzhead=null,q.w_bits=_,q.w_size=1<<q.w_bits,q.w_mask=q.w_size-1,q.hash_bits=w+7,q.hash_size=1<<q.hash_bits,q.hash_mask=q.hash_size-1,q.hash_shift=~~((q.hash_bits+R-1)/R),q.window=new a.Buf8(2*q.w_size),q.head=new a.Buf16(q.hash_size),q.prev=new a.Buf16(q.w_size),q.lit_bufsize=1<<w+6,q.pending_buf_size=4*q.lit_bufsize,q.pending_buf=new a.Buf8(q.pending_buf_size),q.d_buf=1*q.lit_bufsize,q.l_buf=3*q.lit_bufsize,q.level=W,q.strategy=T,q.method=$,Je(d)}t=[new ve(0,0,0,0,function(d,W){var $=65535;for($>d.pending_buf_size-5&&($=d.pending_buf_size-5);;){if(d.lookahead<=1){if(Be(d),d.lookahead===0&&W===y)return m;if(d.lookahead===0)break}d.strstart+=d.lookahead,d.lookahead=0;var _=d.block_start+$;if((d.strstart===0||d.strstart>=_)&&(d.lookahead=d.strstart-_,d.strstart=_,M(d,!1),d.strm.avail_out===0)||d.strstart-d.block_start>=d.w_size-Q&&(M(d,!1),d.strm.avail_out===0))return m}return d.insert=0,W===p?(M(d,!0),d.strm.avail_out===0?ue:Z):(d.strstart>d.block_start&&(M(d,!1),d.strm.avail_out),m)}),new ve(4,4,8,4,Ne),new ve(4,5,16,8,Ne),new ve(4,6,32,32,Ne),new ve(4,4,16,16,pe),new ve(8,16,32,32,pe),new ve(8,16,128,128,pe),new ve(8,32,128,256,pe),new ve(32,128,258,1024,pe),new ve(32,258,258,4096,pe)],r.deflateInit=function(d,W){return Ye(d,W,C,15,8,0)},r.deflateInit2=Ye,r.deflateReset=Je,r.deflateResetKeep=De,r.deflateSetHeader=function(d,W){return d&&d.state?d.state.wrap!==2?b:(d.state.gzhead=W,u):b},r.deflate=function(d,W){var $,_,w,T;if(!d||!d.state||5<W||W<0)return d?fe(d,b):b;if(_=d.state,!d.output||!d.input&&d.avail_in!==0||_.status===666&&W!==p)return fe(d,d.avail_out===0?-5:b);if(_.strm=d,$=_.last_flush,_.last_flush=W,_.status===k)if(_.wrap===2)d.adler=0,oe(_,31),oe(_,139),oe(_,8),_.gzhead?(oe(_,(_.gzhead.text?1:0)+(_.gzhead.hcrc?2:0)+(_.gzhead.extra?4:0)+(_.gzhead.name?8:0)+(_.gzhead.comment?16:0)),oe(_,255&_.gzhead.time),oe(_,_.gzhead.time>>8&255),oe(_,_.gzhead.time>>16&255),oe(_,_.gzhead.time>>24&255),oe(_,_.level===9?2:2<=_.strategy||_.level<2?4:0),oe(_,255&_.gzhead.os),_.gzhead.extra&&_.gzhead.extra.length&&(oe(_,255&_.gzhead.extra.length),oe(_,_.gzhead.extra.length>>8&255)),_.gzhead.hcrc&&(d.adler=c(d.adler,_.pending_buf,_.pending,0)),_.gzindex=0,_.status=69):(oe(_,0),oe(_,0),oe(_,0),oe(_,0),oe(_,0),oe(_,_.level===9?2:2<=_.strategy||_.level<2?4:0),oe(_,3),_.status=z);else{var j=C+(_.w_bits-8<<4)<<8;j|=(2<=_.strategy||_.level<2?0:_.level<6?1:_.level===6?2:3)<<6,_.strstart!==0&&(j|=32),j+=31-j%31,_.status=z,te(_,j),_.strstart!==0&&(te(_,d.adler>>>16),te(_,65535&d.adler)),d.adler=1}if(_.status===69)if(_.gzhead.extra){for(w=_.pending;_.gzindex<(65535&_.gzhead.extra.length)&&(_.pending!==_.pending_buf_size||(_.gzhead.hcrc&&_.pending>w&&(d.adler=c(d.adler,_.pending_buf,_.pending-w,w)),A(d),w=_.pending,_.pending!==_.pending_buf_size));)oe(_,255&_.gzhead.extra[_.gzindex]),_.gzindex++;_.gzhead.hcrc&&_.pending>w&&(d.adler=c(d.adler,_.pending_buf,_.pending-w,w)),_.gzindex===_.gzhead.extra.length&&(_.gzindex=0,_.status=73)}else _.status=73;if(_.status===73)if(_.gzhead.name){w=_.pending;do{if(_.pending===_.pending_buf_size&&(_.gzhead.hcrc&&_.pending>w&&(d.adler=c(d.adler,_.pending_buf,_.pending-w,w)),A(d),w=_.pending,_.pending===_.pending_buf_size)){T=1;break}T=_.gzindex<_.gzhead.name.length?255&_.gzhead.name.charCodeAt(_.gzindex++):0,oe(_,T)}while(T!==0);_.gzhead.hcrc&&_.pending>w&&(d.adler=c(d.adler,_.pending_buf,_.pending-w,w)),T===0&&(_.gzindex=0,_.status=91)}else _.status=91;if(_.status===91)if(_.gzhead.comment){w=_.pending;do{if(_.pending===_.pending_buf_size&&(_.gzhead.hcrc&&_.pending>w&&(d.adler=c(d.adler,_.pending_buf,_.pending-w,w)),A(d),w=_.pending,_.pending===_.pending_buf_size)){T=1;break}T=_.gzindex<_.gzhead.comment.length?255&_.gzhead.comment.charCodeAt(_.gzindex++):0,oe(_,T)}while(T!==0);_.gzhead.hcrc&&_.pending>w&&(d.adler=c(d.adler,_.pending_buf,_.pending-w,w)),T===0&&(_.status=103)}else _.status=103;if(_.status===103&&(_.gzhead.hcrc?(_.pending+2>_.pending_buf_size&&A(d),_.pending+2<=_.pending_buf_size&&(oe(_,255&d.adler),oe(_,d.adler>>8&255),d.adler=0,_.status=z)):_.status=z),_.pending!==0){if(A(d),d.avail_out===0)return _.last_flush=-1,u}else if(d.avail_in===0&&F(W)<=F($)&&W!==p)return fe(d,-5);if(_.status===666&&d.avail_in!==0)return fe(d,-5);if(d.avail_in!==0||_.lookahead!==0||W!==y&&_.status!==666){var q=_.strategy===2?function(O,V){for(var se;;){if(O.lookahead===0&&(Be(O),O.lookahead===0)){if(V===y)return m;break}if(O.match_length=0,se=s._tr_tally(O,0,O.window[O.strstart]),O.lookahead--,O.strstart++,se&&(M(O,!1),O.strm.avail_out===0))return m}return O.insert=0,V===p?(M(O,!0),O.strm.avail_out===0?ue:Z):O.last_lit&&(M(O,!1),O.strm.avail_out===0)?m:H}(_,W):_.strategy===3?function(O,V){for(var se,J,le,Ie,me=O.window;;){if(O.lookahead<=P){if(Be(O),O.lookahead<=P&&V===y)return m;if(O.lookahead===0)break}if(O.match_length=0,O.lookahead>=R&&0<O.strstart&&(J=me[le=O.strstart-1])===me[++le]&&J===me[++le]&&J===me[++le]){Ie=O.strstart+P;do;while(J===me[++le]&&J===me[++le]&&J===me[++le]&&J===me[++le]&&J===me[++le]&&J===me[++le]&&J===me[++le]&&J===me[++le]&&le<Ie);O.match_length=P-(Ie-le),O.match_length>O.lookahead&&(O.match_length=O.lookahead)}if(O.match_length>=R?(se=s._tr_tally(O,1,O.match_length-R),O.lookahead-=O.match_length,O.strstart+=O.match_length,O.match_length=0):(se=s._tr_tally(O,0,O.window[O.strstart]),O.lookahead--,O.strstart++),se&&(M(O,!1),O.strm.avail_out===0))return m}return O.insert=0,V===p?(M(O,!0),O.strm.avail_out===0?ue:Z):O.last_lit&&(M(O,!1),O.strm.avail_out===0)?m:H}(_,W):t[_.level].func(_,W);if(q!==ue&&q!==Z||(_.status=666),q===m||q===ue)return d.avail_out===0&&(_.last_flush=-1),u;if(q===H&&(W===1?s._tr_align(_):W!==5&&(s._tr_stored_block(_,0,0,!1),W===3&&(ne(_.head),_.lookahead===0&&(_.strstart=0,_.block_start=0,_.insert=0))),A(d),d.avail_out===0))return _.last_flush=-1,u}return W!==p?u:_.wrap<=0?1:(_.wrap===2?(oe(_,255&d.adler),oe(_,d.adler>>8&255),oe(_,d.adler>>16&255),oe(_,d.adler>>24&255),oe(_,255&d.total_in),oe(_,d.total_in>>8&255),oe(_,d.total_in>>16&255),oe(_,d.total_in>>24&255)):(te(_,d.adler>>>16),te(_,65535&d.adler)),A(d),0<_.wrap&&(_.wrap=-_.wrap),_.pending!==0?u:1)},r.deflateEnd=function(d){var W;return d&&d.state?(W=d.state.status)!==k&&W!==69&&W!==73&&W!==91&&W!==103&&W!==z&&W!==666?fe(d,b):(d.state=null,W===z?fe(d,-3):u):b},r.deflateSetDictionary=function(d,W){var $,_,w,T,j,q,O,V,se=W.length;if(!d||!d.state||(T=($=d.state).wrap)===2||T===1&&$.status!==k||$.lookahead)return b;for(T===1&&(d.adler=i(d.adler,W,se,0)),$.wrap=0,se>=$.w_size&&(T===0&&(ne($.head),$.strstart=0,$.block_start=0,$.insert=0),V=new a.Buf8($.w_size),a.arraySet(V,W,se-$.w_size,$.w_size,0),W=V,se=$.w_size),j=d.avail_in,q=d.next_in,O=d.input,d.avail_in=se,d.next_in=0,d.input=W,Be($);$.lookahead>=R;){for(_=$.strstart,w=$.lookahead-(R-1);$.ins_h=($.ins_h<<$.hash_shift^$.window[_+R-1])&$.hash_mask,$.prev[_&$.w_mask]=$.head[$.ins_h],$.head[$.ins_h]=_,_++,--w;);$.strstart=_,$.lookahead=R-1,Be($)}return $.strstart+=$.lookahead,$.block_start=$.strstart,$.insert=$.lookahead,$.lookahead=0,$.match_length=$.prev_length=R-1,$.match_available=0,d.next_in=q,d.input=O,d.avail_in=j,$.wrap=T,u},r.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(e,l,r){l.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(e,l,r){l.exports=function(t,a){var s,i,c,h,y,p,u,b,f,v,g,C,E,S,I,x,L,N,R,P,Q,k,z,m,H;s=t.state,i=t.next_in,m=t.input,c=i+(t.avail_in-5),h=t.next_out,H=t.output,y=h-(a-t.avail_out),p=h+(t.avail_out-257),u=s.dmax,b=s.wsize,f=s.whave,v=s.wnext,g=s.window,C=s.hold,E=s.bits,S=s.lencode,I=s.distcode,x=(1<<s.lenbits)-1,L=(1<<s.distbits)-1;e:do{E<15&&(C+=m[i++]<<E,E+=8,C+=m[i++]<<E,E+=8),N=S[C&x];t:for(;;){if(C>>>=R=N>>>24,E-=R,(R=N>>>16&255)===0)H[h++]=65535&N;else{if(!(16&R)){if(!(64&R)){N=S[(65535&N)+(C&(1<<R)-1)];continue t}if(32&R){s.mode=12;break e}t.msg="invalid literal/length code",s.mode=30;break e}P=65535&N,(R&=15)&&(E<R&&(C+=m[i++]<<E,E+=8),P+=C&(1<<R)-1,C>>>=R,E-=R),E<15&&(C+=m[i++]<<E,E+=8,C+=m[i++]<<E,E+=8),N=I[C&L];n:for(;;){if(C>>>=R=N>>>24,E-=R,!(16&(R=N>>>16&255))){if(!(64&R)){N=I[(65535&N)+(C&(1<<R)-1)];continue n}t.msg="invalid distance code",s.mode=30;break e}if(Q=65535&N,E<(R&=15)&&(C+=m[i++]<<E,(E+=8)<R&&(C+=m[i++]<<E,E+=8)),u<(Q+=C&(1<<R)-1)){t.msg="invalid distance too far back",s.mode=30;break e}if(C>>>=R,E-=R,(R=h-y)<Q){if(f<(R=Q-R)&&s.sane){t.msg="invalid distance too far back",s.mode=30;break e}if(z=g,(k=0)===v){if(k+=b-R,R<P){for(P-=R;H[h++]=g[k++],--R;);k=h-Q,z=H}}else if(v<R){if(k+=b+v-R,(R-=v)<P){for(P-=R;H[h++]=g[k++],--R;);if(k=0,v<P){for(P-=R=v;H[h++]=g[k++],--R;);k=h-Q,z=H}}}else if(k+=v-R,R<P){for(P-=R;H[h++]=g[k++],--R;);k=h-Q,z=H}for(;2<P;)H[h++]=z[k++],H[h++]=z[k++],H[h++]=z[k++],P-=3;P&&(H[h++]=z[k++],1<P&&(H[h++]=z[k++]))}else{for(k=h-Q;H[h++]=H[k++],H[h++]=H[k++],H[h++]=H[k++],2<(P-=3););P&&(H[h++]=H[k++],1<P&&(H[h++]=H[k++]))}break}}break}}while(i<c&&h<p);i-=P=E>>3,C&=(1<<(E-=P<<3))-1,t.next_in=i,t.next_out=h,t.avail_in=i<c?c-i+5:5-(i-c),t.avail_out=h<p?p-h+257:257-(h-p),s.hold=C,s.bits=E}},{}],49:[function(e,l,r){var t=e("../utils/common"),a=e("./adler32"),s=e("./crc32"),i=e("./inffast"),c=e("./inftrees"),h=1,y=2,p=0,u=-2,b=1,f=852,v=592;function g(k){return(k>>>24&255)+(k>>>8&65280)+((65280&k)<<8)+((255&k)<<24)}function C(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new t.Buf16(320),this.work=new t.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function E(k){var z;return k&&k.state?(z=k.state,k.total_in=k.total_out=z.total=0,k.msg="",z.wrap&&(k.adler=1&z.wrap),z.mode=b,z.last=0,z.havedict=0,z.dmax=32768,z.head=null,z.hold=0,z.bits=0,z.lencode=z.lendyn=new t.Buf32(f),z.distcode=z.distdyn=new t.Buf32(v),z.sane=1,z.back=-1,p):u}function S(k){var z;return k&&k.state?((z=k.state).wsize=0,z.whave=0,z.wnext=0,E(k)):u}function I(k,z){var m,H;return k&&k.state?(H=k.state,z<0?(m=0,z=-z):(m=1+(z>>4),z<48&&(z&=15)),z&&(z<8||15<z)?u:(H.window!==null&&H.wbits!==z&&(H.window=null),H.wrap=m,H.wbits=z,S(k))):u}function x(k,z){var m,H;return k?(H=new C,(k.state=H).window=null,(m=I(k,z))!==p&&(k.state=null),m):u}var L,N,R=!0;function P(k){if(R){var z;for(L=new t.Buf32(512),N=new t.Buf32(32),z=0;z<144;)k.lens[z++]=8;for(;z<256;)k.lens[z++]=9;for(;z<280;)k.lens[z++]=7;for(;z<288;)k.lens[z++]=8;for(c(h,k.lens,0,288,L,0,k.work,{bits:9}),z=0;z<32;)k.lens[z++]=5;c(y,k.lens,0,32,N,0,k.work,{bits:5}),R=!1}k.lencode=L,k.lenbits=9,k.distcode=N,k.distbits=5}function Q(k,z,m,H){var ue,Z=k.state;return Z.window===null&&(Z.wsize=1<<Z.wbits,Z.wnext=0,Z.whave=0,Z.window=new t.Buf8(Z.wsize)),H>=Z.wsize?(t.arraySet(Z.window,z,m-Z.wsize,Z.wsize,0),Z.wnext=0,Z.whave=Z.wsize):(H<(ue=Z.wsize-Z.wnext)&&(ue=H),t.arraySet(Z.window,z,m-H,ue,Z.wnext),(H-=ue)?(t.arraySet(Z.window,z,m-H,H,0),Z.wnext=H,Z.whave=Z.wsize):(Z.wnext+=ue,Z.wnext===Z.wsize&&(Z.wnext=0),Z.whave<Z.wsize&&(Z.whave+=ue))),0}r.inflateReset=S,r.inflateReset2=I,r.inflateResetKeep=E,r.inflateInit=function(k){return x(k,15)},r.inflateInit2=x,r.inflate=function(k,z){var m,H,ue,Z,fe,F,ne,A,M,oe,te,Y,Be,Ne,pe,ve,Le,De,Je,Ye,d,W,$,_,w=0,T=new t.Buf8(4),j=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!k||!k.state||!k.output||!k.input&&k.avail_in!==0)return u;(m=k.state).mode===12&&(m.mode=13),fe=k.next_out,ue=k.output,ne=k.avail_out,Z=k.next_in,H=k.input,F=k.avail_in,A=m.hold,M=m.bits,oe=F,te=ne,W=p;e:for(;;)switch(m.mode){case b:if(m.wrap===0){m.mode=13;break}for(;M<16;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}if(2&m.wrap&&A===35615){T[m.check=0]=255&A,T[1]=A>>>8&255,m.check=s(m.check,T,2,0),M=A=0,m.mode=2;break}if(m.flags=0,m.head&&(m.head.done=!1),!(1&m.wrap)||(((255&A)<<8)+(A>>8))%31){k.msg="incorrect header check",m.mode=30;break}if((15&A)!=8){k.msg="unknown compression method",m.mode=30;break}if(M-=4,d=8+(15&(A>>>=4)),m.wbits===0)m.wbits=d;else if(d>m.wbits){k.msg="invalid window size",m.mode=30;break}m.dmax=1<<d,k.adler=m.check=1,m.mode=512&A?10:12,M=A=0;break;case 2:for(;M<16;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}if(m.flags=A,(255&m.flags)!=8){k.msg="unknown compression method",m.mode=30;break}if(57344&m.flags){k.msg="unknown header flags set",m.mode=30;break}m.head&&(m.head.text=A>>8&1),512&m.flags&&(T[0]=255&A,T[1]=A>>>8&255,m.check=s(m.check,T,2,0)),M=A=0,m.mode=3;case 3:for(;M<32;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}m.head&&(m.head.time=A),512&m.flags&&(T[0]=255&A,T[1]=A>>>8&255,T[2]=A>>>16&255,T[3]=A>>>24&255,m.check=s(m.check,T,4,0)),M=A=0,m.mode=4;case 4:for(;M<16;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}m.head&&(m.head.xflags=255&A,m.head.os=A>>8),512&m.flags&&(T[0]=255&A,T[1]=A>>>8&255,m.check=s(m.check,T,2,0)),M=A=0,m.mode=5;case 5:if(1024&m.flags){for(;M<16;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}m.length=A,m.head&&(m.head.extra_len=A),512&m.flags&&(T[0]=255&A,T[1]=A>>>8&255,m.check=s(m.check,T,2,0)),M=A=0}else m.head&&(m.head.extra=null);m.mode=6;case 6:if(1024&m.flags&&(F<(Y=m.length)&&(Y=F),Y&&(m.head&&(d=m.head.extra_len-m.length,m.head.extra||(m.head.extra=new Array(m.head.extra_len)),t.arraySet(m.head.extra,H,Z,Y,d)),512&m.flags&&(m.check=s(m.check,H,Y,Z)),F-=Y,Z+=Y,m.length-=Y),m.length))break e;m.length=0,m.mode=7;case 7:if(2048&m.flags){if(F===0)break e;for(Y=0;d=H[Z+Y++],m.head&&d&&m.length<65536&&(m.head.name+=String.fromCharCode(d)),d&&Y<F;);if(512&m.flags&&(m.check=s(m.check,H,Y,Z)),F-=Y,Z+=Y,d)break e}else m.head&&(m.head.name=null);m.length=0,m.mode=8;case 8:if(4096&m.flags){if(F===0)break e;for(Y=0;d=H[Z+Y++],m.head&&d&&m.length<65536&&(m.head.comment+=String.fromCharCode(d)),d&&Y<F;);if(512&m.flags&&(m.check=s(m.check,H,Y,Z)),F-=Y,Z+=Y,d)break e}else m.head&&(m.head.comment=null);m.mode=9;case 9:if(512&m.flags){for(;M<16;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}if(A!==(65535&m.check)){k.msg="header crc mismatch",m.mode=30;break}M=A=0}m.head&&(m.head.hcrc=m.flags>>9&1,m.head.done=!0),k.adler=m.check=0,m.mode=12;break;case 10:for(;M<32;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}k.adler=m.check=g(A),M=A=0,m.mode=11;case 11:if(m.havedict===0)return k.next_out=fe,k.avail_out=ne,k.next_in=Z,k.avail_in=F,m.hold=A,m.bits=M,2;k.adler=m.check=1,m.mode=12;case 12:if(z===5||z===6)break e;case 13:if(m.last){A>>>=7&M,M-=7&M,m.mode=27;break}for(;M<3;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}switch(m.last=1&A,M-=1,3&(A>>>=1)){case 0:m.mode=14;break;case 1:if(P(m),m.mode=20,z!==6)break;A>>>=2,M-=2;break e;case 2:m.mode=17;break;case 3:k.msg="invalid block type",m.mode=30}A>>>=2,M-=2;break;case 14:for(A>>>=7&M,M-=7&M;M<32;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}if((65535&A)!=(A>>>16^65535)){k.msg="invalid stored block lengths",m.mode=30;break}if(m.length=65535&A,M=A=0,m.mode=15,z===6)break e;case 15:m.mode=16;case 16:if(Y=m.length){if(F<Y&&(Y=F),ne<Y&&(Y=ne),Y===0)break e;t.arraySet(ue,H,Z,Y,fe),F-=Y,Z+=Y,ne-=Y,fe+=Y,m.length-=Y;break}m.mode=12;break;case 17:for(;M<14;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}if(m.nlen=257+(31&A),A>>>=5,M-=5,m.ndist=1+(31&A),A>>>=5,M-=5,m.ncode=4+(15&A),A>>>=4,M-=4,286<m.nlen||30<m.ndist){k.msg="too many length or distance symbols",m.mode=30;break}m.have=0,m.mode=18;case 18:for(;m.have<m.ncode;){for(;M<3;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}m.lens[j[m.have++]]=7&A,A>>>=3,M-=3}for(;m.have<19;)m.lens[j[m.have++]]=0;if(m.lencode=m.lendyn,m.lenbits=7,$={bits:m.lenbits},W=c(0,m.lens,0,19,m.lencode,0,m.work,$),m.lenbits=$.bits,W){k.msg="invalid code lengths set",m.mode=30;break}m.have=0,m.mode=19;case 19:for(;m.have<m.nlen+m.ndist;){for(;ve=(w=m.lencode[A&(1<<m.lenbits)-1])>>>16&255,Le=65535&w,!((pe=w>>>24)<=M);){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}if(Le<16)A>>>=pe,M-=pe,m.lens[m.have++]=Le;else{if(Le===16){for(_=pe+2;M<_;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}if(A>>>=pe,M-=pe,m.have===0){k.msg="invalid bit length repeat",m.mode=30;break}d=m.lens[m.have-1],Y=3+(3&A),A>>>=2,M-=2}else if(Le===17){for(_=pe+3;M<_;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}M-=pe,d=0,Y=3+(7&(A>>>=pe)),A>>>=3,M-=3}else{for(_=pe+7;M<_;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}M-=pe,d=0,Y=11+(127&(A>>>=pe)),A>>>=7,M-=7}if(m.have+Y>m.nlen+m.ndist){k.msg="invalid bit length repeat",m.mode=30;break}for(;Y--;)m.lens[m.have++]=d}}if(m.mode===30)break;if(m.lens[256]===0){k.msg="invalid code -- missing end-of-block",m.mode=30;break}if(m.lenbits=9,$={bits:m.lenbits},W=c(h,m.lens,0,m.nlen,m.lencode,0,m.work,$),m.lenbits=$.bits,W){k.msg="invalid literal/lengths set",m.mode=30;break}if(m.distbits=6,m.distcode=m.distdyn,$={bits:m.distbits},W=c(y,m.lens,m.nlen,m.ndist,m.distcode,0,m.work,$),m.distbits=$.bits,W){k.msg="invalid distances set",m.mode=30;break}if(m.mode=20,z===6)break e;case 20:m.mode=21;case 21:if(6<=F&&258<=ne){k.next_out=fe,k.avail_out=ne,k.next_in=Z,k.avail_in=F,m.hold=A,m.bits=M,i(k,te),fe=k.next_out,ue=k.output,ne=k.avail_out,Z=k.next_in,H=k.input,F=k.avail_in,A=m.hold,M=m.bits,m.mode===12&&(m.back=-1);break}for(m.back=0;ve=(w=m.lencode[A&(1<<m.lenbits)-1])>>>16&255,Le=65535&w,!((pe=w>>>24)<=M);){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}if(ve&&!(240&ve)){for(De=pe,Je=ve,Ye=Le;ve=(w=m.lencode[Ye+((A&(1<<De+Je)-1)>>De)])>>>16&255,Le=65535&w,!(De+(pe=w>>>24)<=M);){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}A>>>=De,M-=De,m.back+=De}if(A>>>=pe,M-=pe,m.back+=pe,m.length=Le,ve===0){m.mode=26;break}if(32&ve){m.back=-1,m.mode=12;break}if(64&ve){k.msg="invalid literal/length code",m.mode=30;break}m.extra=15&ve,m.mode=22;case 22:if(m.extra){for(_=m.extra;M<_;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}m.length+=A&(1<<m.extra)-1,A>>>=m.extra,M-=m.extra,m.back+=m.extra}m.was=m.length,m.mode=23;case 23:for(;ve=(w=m.distcode[A&(1<<m.distbits)-1])>>>16&255,Le=65535&w,!((pe=w>>>24)<=M);){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}if(!(240&ve)){for(De=pe,Je=ve,Ye=Le;ve=(w=m.distcode[Ye+((A&(1<<De+Je)-1)>>De)])>>>16&255,Le=65535&w,!(De+(pe=w>>>24)<=M);){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}A>>>=De,M-=De,m.back+=De}if(A>>>=pe,M-=pe,m.back+=pe,64&ve){k.msg="invalid distance code",m.mode=30;break}m.offset=Le,m.extra=15&ve,m.mode=24;case 24:if(m.extra){for(_=m.extra;M<_;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}m.offset+=A&(1<<m.extra)-1,A>>>=m.extra,M-=m.extra,m.back+=m.extra}if(m.offset>m.dmax){k.msg="invalid distance too far back",m.mode=30;break}m.mode=25;case 25:if(ne===0)break e;if(Y=te-ne,m.offset>Y){if((Y=m.offset-Y)>m.whave&&m.sane){k.msg="invalid distance too far back",m.mode=30;break}Be=Y>m.wnext?(Y-=m.wnext,m.wsize-Y):m.wnext-Y,Y>m.length&&(Y=m.length),Ne=m.window}else Ne=ue,Be=fe-m.offset,Y=m.length;for(ne<Y&&(Y=ne),ne-=Y,m.length-=Y;ue[fe++]=Ne[Be++],--Y;);m.length===0&&(m.mode=21);break;case 26:if(ne===0)break e;ue[fe++]=m.length,ne--,m.mode=21;break;case 27:if(m.wrap){for(;M<32;){if(F===0)break e;F--,A|=H[Z++]<<M,M+=8}if(te-=ne,k.total_out+=te,m.total+=te,te&&(k.adler=m.check=m.flags?s(m.check,ue,te,fe-te):a(m.check,ue,te,fe-te)),te=ne,(m.flags?A:g(A))!==m.check){k.msg="incorrect data check",m.mode=30;break}M=A=0}m.mode=28;case 28:if(m.wrap&&m.flags){for(;M<32;){if(F===0)break e;F--,A+=H[Z++]<<M,M+=8}if(A!==(4294967295&m.total)){k.msg="incorrect length check",m.mode=30;break}M=A=0}m.mode=29;case 29:W=1;break e;case 30:W=-3;break e;case 31:return-4;case 32:default:return u}return k.next_out=fe,k.avail_out=ne,k.next_in=Z,k.avail_in=F,m.hold=A,m.bits=M,(m.wsize||te!==k.avail_out&&m.mode<30&&(m.mode<27||z!==4))&&Q(k,k.output,k.next_out,te-k.avail_out)?(m.mode=31,-4):(oe-=k.avail_in,te-=k.avail_out,k.total_in+=oe,k.total_out+=te,m.total+=te,m.wrap&&te&&(k.adler=m.check=m.flags?s(m.check,ue,te,k.next_out-te):a(m.check,ue,te,k.next_out-te)),k.data_type=m.bits+(m.last?64:0)+(m.mode===12?128:0)+(m.mode===20||m.mode===15?256:0),(oe==0&&te===0||z===4)&&W===p&&(W=-5),W)},r.inflateEnd=function(k){if(!k||!k.state)return u;var z=k.state;return z.window&&(z.window=null),k.state=null,p},r.inflateGetHeader=function(k,z){var m;return k&&k.state&&2&(m=k.state).wrap?((m.head=z).done=!1,p):u},r.inflateSetDictionary=function(k,z){var m,H=z.length;return k&&k.state?(m=k.state).wrap!==0&&m.mode!==11?u:m.mode===11&&a(1,z,H,0)!==m.check?-3:Q(k,z,H,H)?(m.mode=31,-4):(m.havedict=1,p):u},r.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(e,l,r){var t=e("../utils/common"),a=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],s=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],i=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],c=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];l.exports=function(h,y,p,u,b,f,v,g){var C,E,S,I,x,L,N,R,P,Q=g.bits,k=0,z=0,m=0,H=0,ue=0,Z=0,fe=0,F=0,ne=0,A=0,M=null,oe=0,te=new t.Buf16(16),Y=new t.Buf16(16),Be=null,Ne=0;for(k=0;k<=15;k++)te[k]=0;for(z=0;z<u;z++)te[y[p+z]]++;for(ue=Q,H=15;1<=H&&te[H]===0;H--);if(H<ue&&(ue=H),H===0)return b[f++]=20971520,b[f++]=20971520,g.bits=1,0;for(m=1;m<H&&te[m]===0;m++);for(ue<m&&(ue=m),k=F=1;k<=15;k++)if(F<<=1,(F-=te[k])<0)return-1;if(0<F&&(h===0||H!==1))return-1;for(Y[1]=0,k=1;k<15;k++)Y[k+1]=Y[k]+te[k];for(z=0;z<u;z++)y[p+z]!==0&&(v[Y[y[p+z]]++]=z);if(L=h===0?(M=Be=v,19):h===1?(M=a,oe-=257,Be=s,Ne-=257,256):(M=i,Be=c,-1),k=m,x=f,fe=z=A=0,S=-1,I=(ne=1<<(Z=ue))-1,h===1&&852<ne||h===2&&592<ne)return 1;for(;;){for(N=k-fe,P=v[z]<L?(R=0,v[z]):v[z]>L?(R=Be[Ne+v[z]],M[oe+v[z]]):(R=96,0),C=1<<k-fe,m=E=1<<Z;b[x+(A>>fe)+(E-=C)]=N<<24|R<<16|P|0,E!==0;);for(C=1<<k-1;A&C;)C>>=1;if(C!==0?(A&=C-1,A+=C):A=0,z++,--te[k]==0){if(k===H)break;k=y[p+v[z]]}if(ue<k&&(A&I)!==S){for(fe===0&&(fe=ue),x+=m,F=1<<(Z=k-fe);Z+fe<H&&!((F-=te[Z+fe])<=0);)Z++,F<<=1;if(ne+=1<<Z,h===1&&852<ne||h===2&&592<ne)return 1;b[S=A&I]=ue<<24|Z<<16|x-f|0}}return A!==0&&(b[x+A]=k-fe<<24|64<<16|0),g.bits=ue,0}},{"../utils/common":41}],51:[function(e,l,r){l.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(e,l,r){var t=e("../utils/common"),a=0,s=1;function i(w){for(var T=w.length;0<=--T;)w[T]=0}var c=0,h=29,y=256,p=y+1+h,u=30,b=19,f=2*p+1,v=15,g=16,C=7,E=256,S=16,I=17,x=18,L=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],N=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],R=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],P=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Q=new Array(2*(p+2));i(Q);var k=new Array(2*u);i(k);var z=new Array(512);i(z);var m=new Array(256);i(m);var H=new Array(h);i(H);var ue,Z,fe,F=new Array(u);function ne(w,T,j,q,O){this.static_tree=w,this.extra_bits=T,this.extra_base=j,this.elems=q,this.max_length=O,this.has_stree=w&&w.length}function A(w,T){this.dyn_tree=w,this.max_code=0,this.stat_desc=T}function M(w){return w<256?z[w]:z[256+(w>>>7)]}function oe(w,T){w.pending_buf[w.pending++]=255&T,w.pending_buf[w.pending++]=T>>>8&255}function te(w,T,j){w.bi_valid>g-j?(w.bi_buf|=T<<w.bi_valid&65535,oe(w,w.bi_buf),w.bi_buf=T>>g-w.bi_valid,w.bi_valid+=j-g):(w.bi_buf|=T<<w.bi_valid&65535,w.bi_valid+=j)}function Y(w,T,j){te(w,j[2*T],j[2*T+1])}function Be(w,T){for(var j=0;j|=1&w,w>>>=1,j<<=1,0<--T;);return j>>>1}function Ne(w,T,j){var q,O,V=new Array(v+1),se=0;for(q=1;q<=v;q++)V[q]=se=se+j[q-1]<<1;for(O=0;O<=T;O++){var J=w[2*O+1];J!==0&&(w[2*O]=Be(V[J]++,J))}}function pe(w){var T;for(T=0;T<p;T++)w.dyn_ltree[2*T]=0;for(T=0;T<u;T++)w.dyn_dtree[2*T]=0;for(T=0;T<b;T++)w.bl_tree[2*T]=0;w.dyn_ltree[2*E]=1,w.opt_len=w.static_len=0,w.last_lit=w.matches=0}function ve(w){8<w.bi_valid?oe(w,w.bi_buf):0<w.bi_valid&&(w.pending_buf[w.pending++]=w.bi_buf),w.bi_buf=0,w.bi_valid=0}function Le(w,T,j,q){var O=2*T,V=2*j;return w[O]<w[V]||w[O]===w[V]&&q[T]<=q[j]}function De(w,T,j){for(var q=w.heap[j],O=j<<1;O<=w.heap_len&&(O<w.heap_len&&Le(T,w.heap[O+1],w.heap[O],w.depth)&&O++,!Le(T,q,w.heap[O],w.depth));)w.heap[j]=w.heap[O],j=O,O<<=1;w.heap[j]=q}function Je(w,T,j){var q,O,V,se,J=0;if(w.last_lit!==0)for(;q=w.pending_buf[w.d_buf+2*J]<<8|w.pending_buf[w.d_buf+2*J+1],O=w.pending_buf[w.l_buf+J],J++,q===0?Y(w,O,T):(Y(w,(V=m[O])+y+1,T),(se=L[V])!==0&&te(w,O-=H[V],se),Y(w,V=M(--q),j),(se=N[V])!==0&&te(w,q-=F[V],se)),J<w.last_lit;);Y(w,E,T)}function Ye(w,T){var j,q,O,V=T.dyn_tree,se=T.stat_desc.static_tree,J=T.stat_desc.has_stree,le=T.stat_desc.elems,Ie=-1;for(w.heap_len=0,w.heap_max=f,j=0;j<le;j++)V[2*j]!==0?(w.heap[++w.heap_len]=Ie=j,w.depth[j]=0):V[2*j+1]=0;for(;w.heap_len<2;)V[2*(O=w.heap[++w.heap_len]=Ie<2?++Ie:0)]=1,w.depth[O]=0,w.opt_len--,J&&(w.static_len-=se[2*O+1]);for(T.max_code=Ie,j=w.heap_len>>1;1<=j;j--)De(w,V,j);for(O=le;j=w.heap[1],w.heap[1]=w.heap[w.heap_len--],De(w,V,1),q=w.heap[1],w.heap[--w.heap_max]=j,w.heap[--w.heap_max]=q,V[2*O]=V[2*j]+V[2*q],w.depth[O]=(w.depth[j]>=w.depth[q]?w.depth[j]:w.depth[q])+1,V[2*j+1]=V[2*q+1]=O,w.heap[1]=O++,De(w,V,1),2<=w.heap_len;);w.heap[--w.heap_max]=w.heap[1],function(me,Ue){var St,Ge,ft,Ae,It,Pt,et=Ue.dyn_tree,ln=Ue.max_code,Wn=Ue.stat_desc.static_tree,dt=Ue.stat_desc.has_stree,dn=Ue.stat_desc.extra_bits,xt=Ue.stat_desc.extra_base,yt=Ue.stat_desc.max_length,vt=0;for(Ae=0;Ae<=v;Ae++)me.bl_count[Ae]=0;for(et[2*me.heap[me.heap_max]+1]=0,St=me.heap_max+1;St<f;St++)yt<(Ae=et[2*et[2*(Ge=me.heap[St])+1]+1]+1)&&(Ae=yt,vt++),et[2*Ge+1]=Ae,ln<Ge||(me.bl_count[Ae]++,It=0,xt<=Ge&&(It=dn[Ge-xt]),Pt=et[2*Ge],me.opt_len+=Pt*(Ae+It),dt&&(me.static_len+=Pt*(Wn[2*Ge+1]+It)));if(vt!==0){do{for(Ae=yt-1;me.bl_count[Ae]===0;)Ae--;me.bl_count[Ae]--,me.bl_count[Ae+1]+=2,me.bl_count[yt]--,vt-=2}while(0<vt);for(Ae=yt;Ae!==0;Ae--)for(Ge=me.bl_count[Ae];Ge!==0;)ln<(ft=me.heap[--St])||(et[2*ft+1]!==Ae&&(me.opt_len+=(Ae-et[2*ft+1])*et[2*ft],et[2*ft+1]=Ae),Ge--)}}(w,T),Ne(V,Ie,w.bl_count)}function d(w,T,j){var q,O,V=-1,se=T[1],J=0,le=7,Ie=4;for(se===0&&(le=138,Ie=3),T[2*(j+1)+1]=65535,q=0;q<=j;q++)O=se,se=T[2*(q+1)+1],++J<le&&O===se||(J<Ie?w.bl_tree[2*O]+=J:O!==0?(O!==V&&w.bl_tree[2*O]++,w.bl_tree[2*S]++):J<=10?w.bl_tree[2*I]++:w.bl_tree[2*x]++,V=O,Ie=(J=0)===se?(le=138,3):O===se?(le=6,3):(le=7,4))}function W(w,T,j){var q,O,V=-1,se=T[1],J=0,le=7,Ie=4;for(se===0&&(le=138,Ie=3),q=0;q<=j;q++)if(O=se,se=T[2*(q+1)+1],!(++J<le&&O===se)){if(J<Ie)for(;Y(w,O,w.bl_tree),--J!=0;);else O!==0?(O!==V&&(Y(w,O,w.bl_tree),J--),Y(w,S,w.bl_tree),te(w,J-3,2)):J<=10?(Y(w,I,w.bl_tree),te(w,J-3,3)):(Y(w,x,w.bl_tree),te(w,J-11,7));V=O,Ie=(J=0)===se?(le=138,3):O===se?(le=6,3):(le=7,4)}}i(F);var $=!1;function _(w,T,j,q){te(w,(c<<1)+(q?1:0),3),function(O,V,se,J){ve(O),oe(O,se),oe(O,~se),t.arraySet(O.pending_buf,O.window,V,se,O.pending),O.pending+=se}(w,T,j)}r._tr_init=function(w){$||(function(){var T,j,q,O,V,se=new Array(v+1);for(O=q=0;O<h-1;O++)for(H[O]=q,T=0;T<1<<L[O];T++)m[q++]=O;for(m[q-1]=O,O=V=0;O<16;O++)for(F[O]=V,T=0;T<1<<N[O];T++)z[V++]=O;for(V>>=7;O<u;O++)for(F[O]=V<<7,T=0;T<1<<N[O]-7;T++)z[256+V++]=O;for(j=0;j<=v;j++)se[j]=0;for(T=0;T<=143;)Q[2*T+1]=8,T++,se[8]++;for(;T<=255;)Q[2*T+1]=9,T++,se[9]++;for(;T<=279;)Q[2*T+1]=7,T++,se[7]++;for(;T<=287;)Q[2*T+1]=8,T++,se[8]++;for(Ne(Q,p+1,se),T=0;T<u;T++)k[2*T+1]=5,k[2*T]=Be(T,5);ue=new ne(Q,L,y+1,p,v),Z=new ne(k,N,0,u,v),fe=new ne(new Array(0),R,0,b,C)}(),$=!0),w.l_desc=new A(w.dyn_ltree,ue),w.d_desc=new A(w.dyn_dtree,Z),w.bl_desc=new A(w.bl_tree,fe),w.bi_buf=0,w.bi_valid=0,pe(w)},r._tr_stored_block=_,r._tr_flush_block=function(w,T,j,q){var O,V,se=0;0<w.level?(w.strm.data_type===2&&(w.strm.data_type=function(J){var le,Ie=4093624447;for(le=0;le<=31;le++,Ie>>>=1)if(1&Ie&&J.dyn_ltree[2*le]!==0)return a;if(J.dyn_ltree[18]!==0||J.dyn_ltree[20]!==0||J.dyn_ltree[26]!==0)return s;for(le=32;le<y;le++)if(J.dyn_ltree[2*le]!==0)return s;return a}(w)),Ye(w,w.l_desc),Ye(w,w.d_desc),se=function(J){var le;for(d(J,J.dyn_ltree,J.l_desc.max_code),d(J,J.dyn_dtree,J.d_desc.max_code),Ye(J,J.bl_desc),le=b-1;3<=le&&J.bl_tree[2*P[le]+1]===0;le--);return J.opt_len+=3*(le+1)+5+5+4,le}(w),O=w.opt_len+3+7>>>3,(V=w.static_len+3+7>>>3)<=O&&(O=V)):O=V=j+5,j+4<=O&&T!==-1?_(w,T,j,q):w.strategy===4||V===O?(te(w,2+(q?1:0),3),Je(w,Q,k)):(te(w,4+(q?1:0),3),function(J,le,Ie,me){var Ue;for(te(J,le-257,5),te(J,Ie-1,5),te(J,me-4,4),Ue=0;Ue<me;Ue++)te(J,J.bl_tree[2*P[Ue]+1],3);W(J,J.dyn_ltree,le-1),W(J,J.dyn_dtree,Ie-1)}(w,w.l_desc.max_code+1,w.d_desc.max_code+1,se+1),Je(w,w.dyn_ltree,w.dyn_dtree)),pe(w),q&&ve(w)},r._tr_tally=function(w,T,j){return w.pending_buf[w.d_buf+2*w.last_lit]=T>>>8&255,w.pending_buf[w.d_buf+2*w.last_lit+1]=255&T,w.pending_buf[w.l_buf+w.last_lit]=255&j,w.last_lit++,T===0?w.dyn_ltree[2*j]++:(w.matches++,T--,w.dyn_ltree[2*(m[j]+y+1)]++,w.dyn_dtree[2*M(T)]++),w.last_lit===w.lit_bufsize-1},r._tr_align=function(w){te(w,2,3),Y(w,E,Q),function(T){T.bi_valid===16?(oe(T,T.bi_buf),T.bi_buf=0,T.bi_valid=0):8<=T.bi_valid&&(T.pending_buf[T.pending++]=255&T.bi_buf,T.bi_buf>>=8,T.bi_valid-=8)}(w)}},{"../utils/common":41}],53:[function(e,l,r){l.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(e,l,r){(function(t){(function(a,s){if(!a.setImmediate){var i,c,h,y,p=1,u={},b=!1,f=a.document,v=Object.getPrototypeOf&&Object.getPrototypeOf(a);v=v&&v.setTimeout?v:a,i={}.toString.call(a.process)==="[object process]"?function(S){process.nextTick(function(){C(S)})}:function(){if(a.postMessage&&!a.importScripts){var S=!0,I=a.onmessage;return a.onmessage=function(){S=!1},a.postMessage("","*"),a.onmessage=I,S}}()?(y="setImmediate$"+Math.random()+"$",a.addEventListener?a.addEventListener("message",E,!1):a.attachEvent("onmessage",E),function(S){a.postMessage(y+S,"*")}):a.MessageChannel?((h=new MessageChannel).port1.onmessage=function(S){C(S.data)},function(S){h.port2.postMessage(S)}):f&&"onreadystatechange"in f.createElement("script")?(c=f.documentElement,function(S){var I=f.createElement("script");I.onreadystatechange=function(){C(S),I.onreadystatechange=null,c.removeChild(I),I=null},c.appendChild(I)}):function(S){setTimeout(C,0,S)},v.setImmediate=function(S){typeof S!="function"&&(S=new Function(""+S));for(var I=new Array(arguments.length-1),x=0;x<I.length;x++)I[x]=arguments[x+1];var L={callback:S,args:I};return u[p]=L,i(p),p++},v.clearImmediate=g}function g(S){delete u[S]}function C(S){if(b)setTimeout(C,0,S);else{var I=u[S];if(I){b=!0;try{(function(x){var L=x.callback,N=x.args;switch(N.length){case 0:L();break;case 1:L(N[0]);break;case 2:L(N[0],N[1]);break;case 3:L(N[0],N[1],N[2]);break;default:L.apply(s,N)}})(I)}finally{g(S),b=!1}}}}function E(S){S.source===a&&typeof S.data=="string"&&S.data.indexOf(y)===0&&C(+S.data.slice(y.length))}})(typeof self>"u"?t===void 0?this:t:self)}).call(this,typeof mn<"u"?mn:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(js);var Gi=js.exports;const ms=Us(Gi);var Zs={exports:{}};(function(n){var o=function(){var e=String.fromCharCode,l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",t={};function a(i,c){if(!t[i]){t[i]={};for(var h=0;h<i.length;h++)t[i][i.charAt(h)]=h}return t[i][c]}var s={compressToBase64:function(i){if(i==null)return"";var c=s._compress(i,6,function(h){return l.charAt(h)});switch(c.length%4){default:case 0:return c;case 1:return c+"===";case 2:return c+"==";case 3:return c+"="}},decompressFromBase64:function(i){return i==null?"":i==""?null:s._decompress(i.length,32,function(c){return a(l,i.charAt(c))})},compressToUTF16:function(i){return i==null?"":s._compress(i,15,function(c){return e(c+32)})+" "},decompressFromUTF16:function(i){return i==null?"":i==""?null:s._decompress(i.length,16384,function(c){return i.charCodeAt(c)-32})},compressToUint8Array:function(i){for(var c=s.compress(i),h=new Uint8Array(c.length*2),y=0,p=c.length;y<p;y++){var u=c.charCodeAt(y);h[y*2]=u>>>8,h[y*2+1]=u%256}return h},decompressFromUint8Array:function(i){if(i==null)return s.decompress(i);for(var c=new Array(i.length/2),h=0,y=c.length;h<y;h++)c[h]=i[h*2]*256+i[h*2+1];var p=[];return c.forEach(function(u){p.push(e(u))}),s.decompress(p.join(""))},compressToEncodedURIComponent:function(i){return i==null?"":s._compress(i,6,function(c){return r.charAt(c)})},decompressFromEncodedURIComponent:function(i){return i==null?"":i==""?null:(i=i.replace(/ /g,"+"),s._decompress(i.length,32,function(c){return a(r,i.charAt(c))}))},compress:function(i){return s._compress(i,16,function(c){return e(c)})},_compress:function(i,c,h){if(i==null)return"";var y,p,u={},b={},f="",v="",g="",C=2,E=3,S=2,I=[],x=0,L=0,N;for(N=0;N<i.length;N+=1)if(f=i.charAt(N),Object.prototype.hasOwnProperty.call(u,f)||(u[f]=E++,b[f]=!0),v=g+f,Object.prototype.hasOwnProperty.call(u,v))g=v;else{if(Object.prototype.hasOwnProperty.call(b,g)){if(g.charCodeAt(0)<256){for(y=0;y<S;y++)x=x<<1,L==c-1?(L=0,I.push(h(x)),x=0):L++;for(p=g.charCodeAt(0),y=0;y<8;y++)x=x<<1|p&1,L==c-1?(L=0,I.push(h(x)),x=0):L++,p=p>>1}else{for(p=1,y=0;y<S;y++)x=x<<1|p,L==c-1?(L=0,I.push(h(x)),x=0):L++,p=0;for(p=g.charCodeAt(0),y=0;y<16;y++)x=x<<1|p&1,L==c-1?(L=0,I.push(h(x)),x=0):L++,p=p>>1}C--,C==0&&(C=Math.pow(2,S),S++),delete b[g]}else for(p=u[g],y=0;y<S;y++)x=x<<1|p&1,L==c-1?(L=0,I.push(h(x)),x=0):L++,p=p>>1;C--,C==0&&(C=Math.pow(2,S),S++),u[v]=E++,g=String(f)}if(g!==""){if(Object.prototype.hasOwnProperty.call(b,g)){if(g.charCodeAt(0)<256){for(y=0;y<S;y++)x=x<<1,L==c-1?(L=0,I.push(h(x)),x=0):L++;for(p=g.charCodeAt(0),y=0;y<8;y++)x=x<<1|p&1,L==c-1?(L=0,I.push(h(x)),x=0):L++,p=p>>1}else{for(p=1,y=0;y<S;y++)x=x<<1|p,L==c-1?(L=0,I.push(h(x)),x=0):L++,p=0;for(p=g.charCodeAt(0),y=0;y<16;y++)x=x<<1|p&1,L==c-1?(L=0,I.push(h(x)),x=0):L++,p=p>>1}C--,C==0&&(C=Math.pow(2,S),S++),delete b[g]}else for(p=u[g],y=0;y<S;y++)x=x<<1|p&1,L==c-1?(L=0,I.push(h(x)),x=0):L++,p=p>>1;C--,C==0&&(C=Math.pow(2,S),S++)}for(p=2,y=0;y<S;y++)x=x<<1|p&1,L==c-1?(L=0,I.push(h(x)),x=0):L++,p=p>>1;for(;;)if(x=x<<1,L==c-1){I.push(h(x));break}else L++;return I.join("")},decompress:function(i){return i==null?"":i==""?null:s._decompress(i.length,32768,function(c){return i.charCodeAt(c)})},_decompress:function(i,c,h){var y=[],p=4,u=4,b=3,f="",v=[],g,C,E,S,I,x,L,N={val:h(0),position:c,index:1};for(g=0;g<3;g+=1)y[g]=g;for(E=0,I=Math.pow(2,2),x=1;x!=I;)S=N.val&N.position,N.position>>=1,N.position==0&&(N.position=c,N.val=h(N.index++)),E|=(S>0?1:0)*x,x<<=1;switch(E){case 0:for(E=0,I=Math.pow(2,8),x=1;x!=I;)S=N.val&N.position,N.position>>=1,N.position==0&&(N.position=c,N.val=h(N.index++)),E|=(S>0?1:0)*x,x<<=1;L=e(E);break;case 1:for(E=0,I=Math.pow(2,16),x=1;x!=I;)S=N.val&N.position,N.position>>=1,N.position==0&&(N.position=c,N.val=h(N.index++)),E|=(S>0?1:0)*x,x<<=1;L=e(E);break;case 2:return""}for(y[3]=L,C=L,v.push(L);;){if(N.index>i)return"";for(E=0,I=Math.pow(2,b),x=1;x!=I;)S=N.val&N.position,N.position>>=1,N.position==0&&(N.position=c,N.val=h(N.index++)),E|=(S>0?1:0)*x,x<<=1;switch(L=E){case 0:for(E=0,I=Math.pow(2,8),x=1;x!=I;)S=N.val&N.position,N.position>>=1,N.position==0&&(N.position=c,N.val=h(N.index++)),E|=(S>0?1:0)*x,x<<=1;y[u++]=e(E),L=u-1,p--;break;case 1:for(E=0,I=Math.pow(2,16),x=1;x!=I;)S=N.val&N.position,N.position>>=1,N.position==0&&(N.position=c,N.val=h(N.index++)),E|=(S>0?1:0)*x,x<<=1;y[u++]=e(E),L=u-1,p--;break;case 2:return v.join("")}if(p==0&&(p=Math.pow(2,b),b++),y[L])f=y[L];else if(L===u)f=C+C.charAt(0);else return null;v.push(f),y[u++]=C+f.charAt(0),p--,C=f,p==0&&(p=Math.pow(2,b),b++)}}};return s}();n!=null?n.exports=o:typeof angular<"u"&&angular!=null&&angular.module("LZString",[]).factory("LZString",function(){return o})})(Zs);var Vi=Zs.exports;const qs=Us(Vi);function Ki(n){return new Worker("/assets/compression.worker-B3kqe_bR.js",{name:n==null?void 0:n.name})}let re={},D=null,hs=null,K=null,_e=null,en=null,$n=null,ps=[],Sn=null,gs=null,Ve=null,In=0,ys=0,xn=0,vs=0,bs=null,Cs=null,Ln=null,pt=null,je=-1,ws=null,Tn=null,Bn=null,Gs=null,Vs=null,ot=!1,ge=[],rt=[],Et=[],qe={isScreenSaverEnabled:!0,lastRestoreTimestamp:null,lastBackupTimestamp:null},Tt=null;const _s=new Ki;_s.onmessage=n=>{const o=n.data;try{localStorage.setItem("teacherAssistantData_v2",o),console.log("Background save complete.")}catch(e){console.error("Background storage failed:",e)}};_s.onerror=n=>{console.error("❌ Worker Communication Error:",n.message,n)};function ce(n=!1){if(ot)return;const e=JSON.stringify({classrooms:re,trashBin:ge,userSettings:qe});if(n){Tt&&clearTimeout(Tt);try{const l=qs.compressToUTF16(e);localStorage.setItem("teacherAssistantData_v2",l),console.log("Immediate save complete.")}catch(l){console.error("Immediate save failed:",l)}return}Tt&&clearTimeout(Tt),Tt=setTimeout(()=>{_s.postMessage(e),Tt=null},500)}function Ji(n){return new Promise((o,e)=>{const l=new FileReader;l.onerror=e,l.onload=()=>{o(l.result.split(",")[1])},l.readAsDataURL(n)})}async function Ks(n=[]){const o={};if(n.length>0)n.forEach(c=>{re[c]&&(o[c]=re[c])});else for(const c in re)re[c].isDeleted||(o[c]=re[c]);const e={metadata:{version:"2.0-b64",createdAt:new Date().toISOString()},data:{classrooms:o,trashBin:ge}},l=JSON.stringify(e),r=new Date,t=new Intl.DateTimeFormat("fa-IR-u-nu-latn",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(r).reduce((c,h)=>(c[h.type]=h.value,c),{}),s=`${t.year.slice(-2)}-${t.month}-${t.day}_${t.hour}-${t.minute}`;let i;n.length===0?i=`SP_Full_${s}.txt`:n.length===1?i=`SP_${n[0].replace(/[<>:"/\\|?*]/g,"").replace(/\s+/g,"_")}_${s}.txt`:i=`SP_Selected-${n.length}_${s}.txt`;try{const c=new ms;c.file("backup.json",l);const h=await c.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:9}}),y=await Ji(h);return new File([y],i,{type:"text/plain"})}catch(c){return console.error("Error creating base64 backup file:",c),null}}function Dn(){const n=localStorage.getItem("teacherAssistantData_v2");if(!n)return;let o;try{const e=qs.decompressFromUTF16(n);e?o=JSON.parse(e):o=JSON.parse(n)}catch{console.log("Migration: Parsing legacy uncompressed data..."),o=JSON.parse(n)}o.classrooms!==void 0&&o.trashBin!==void 0?(kt(o.classrooms),ge=o.trashBin||[],qe={...qe,...o.userSettings}):(kt(o),Yi())}function Yi(){const n=[];Object.values(re).forEach(o=>{o.isDeleted?n.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:o.info.creationDate,type:"classroom",description:`کلاس «${o.info.name}»`,restoreData:{name:o.info.name}}):o.students.forEach(e=>{e.isDeleted&&n.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:e.identity.studentId.split("_")[1],type:"student",description:`دانش‌آموز «${e.identity.name}»`,restoreData:{studentId:e.identity.studentId,classroomName:o.info.name}})})}),ge.length===0&&n.length>0&&(ge=n,console.log(`Migrated ${n.length} previously deleted item(s) to the new trash bin.`),ce())}function Js(n){const o=new pn(n.identity);return o.isDeleted=n.isDeleted,o.statusCounters=n.statusCounters,o.logs=n.logs,o.logs.scores||(o.logs.scores={}),o.profile=n.profile,o.finalClassActivityScore=n.finalClassActivityScore,o.categoryCounts=n.categoryCounts||{},o.categoryIssues=n.categoryIssues||{},o.onboardingSession=n.onboardingSession||null,o}function kt(n){re={};for(const o in n){const e=n[o];let l;e.info?l=e.info:l={...e,name:o};const r=new Vn(l);r.isDeleted=e.isDeleted,r.note=e.note||"",r.students=(e.students||[]).map(Js),r.sessions=(e.sessions||[]).map(t=>{const a=new Ws(t.sessionNumber);a.isDeleted=t.isDeleted,a.note=t.note||"",a.startTime=new Date(t.startTime),a.endTime=t.endTime?new Date(t.endTime):null,a.isFinished=t.isFinished,a.isMakeup=t.isMakeup,a.isCancelled=t.isCancelled||!1,a.studentRecords=t.studentRecords;for(const i in a.studentRecords){const c=a.studentRecords[i];c.homework&&!(c.homework instanceof Gn)&&(a.studentRecords[i].homework=new Gn(c.homework.status,c.homework.comment))}a.lastWinnerByCategory=t.lastWinnerByCategory,a.lastUsedCategoryId=t.lastUsedCategoryId,a.lastSelectedWinnerId=t.lastSelectedWinnerId;const s=t.winnerHistory||[];return a.winnerHistory=s.filter(i=>i&&i.winner).map(i=>({winner:r.students.find(h=>h.identity.studentId===i.winner.identity.studentId),categoryName:i.categoryName})).filter(i=>i.winner),a}),r.categories=(e.categories||[]).map(t=>{const a=new ut(t.name,t.description,t.isGradedCategory);return a.id=t.id,a.isDeleted=t.isDeleted,a}),r.futurePlans=e.futurePlans,re[o]=r}}function Ys(n,o){if(o)kt(n.data.classrooms),Is(n.data.trashBin||[]);else{const e=n.data.classrooms,l=n.data.trashBin||[],r=new Map;for(const a in re){const s=re[a];s.info&&s.info.scheduleCode&&r.set(s.info.scheduleCode,a)}for(const a in e){const s=e[a],i=s.info.scheduleCode;if(r.has(i)){const c=r.get(i);c!==s.info.name&&delete re[c],re[s.info.name]=s}else{let c=s.info.name;for(;re[c];)c=`${c} (Imported)`;c!==s.info.name&&(s.info.name=c),re[c]=s}}const t=new Set(ge.map(a=>a.id));l.forEach(a=>{t.has(a.id)||ge.push(a)}),kt(re)}Vt({lastRestoreTimestamp:new Date().toISOString()}),ce()}function Xs(n,o){if(re[o])return{success:!1,message:"کلاسی با این نام از قبل وجود دارد."};const e=re[n];return e?(e.info.name=o,re[o]=e,delete re[n],D===e&&Pe(e),{success:!0}):{success:!1,message:"کلاس مورد نظر یافت نشد."}}function Qs(n,o,e){const l=e.trim();if(!l)return{success:!1,message:"نام دسته‌بندی نمی‌تواند خالی باشد."};if(n.categories.some(i=>i.id!==o.id&&!i.isDeleted&&i.name.toLowerCase()===l.toLowerCase()))return{success:!1,message:"دسته‌بندی دیگری با این نام وجود دارد."};const t=o.name,a=t.toLowerCase(),s=l.toLowerCase();return o.name=l,n.students.forEach(i=>{i.categoryCounts&&i.categoryCounts[t]!==void 0&&(i.categoryCounts[l]=i.categoryCounts[t],delete i.categoryCounts[t]),i.categoryIssues&&i.categoryIssues[t]!==void 0&&(i.categoryIssues[l]=i.categoryIssues[t],delete i.categoryIssues[t]),i.logs.scores&&i.logs.scores[a]&&(i.logs.scores[a].forEach(c=>c.skill=l),a!==s&&(i.logs.scores[s]=i.logs.scores[a],delete i.logs.scores[a]))}),n.sessions.forEach(i=>{i.lastWinnerByCategory&&i.lastWinnerByCategory[t]&&(i.lastWinnerByCategory[l]=i.lastWinnerByCategory[t],delete i.lastWinnerByCategory[t]),i.winnerHistory&&i.winnerHistory.forEach(c=>{c.categoryName===t&&(c.categoryName=l)})}),{success:!0}}function ei(n,o,e){if(Se(e.students).some(c=>c.identity.name.toLowerCase()===n.identity.name.toLowerCase()))return{success:!1,message:`دانش‌آموزی با نام «${n.identity.name}» از قبل در کلاس «${e.info.name}» وجود دارد.`};const r=JSON.parse(JSON.stringify(n)),t=Js(r),a=new Map;o.sessions.forEach(c=>{const h=c.studentRecords[n.identity.studentId];h&&a.set(c.sessionNumber,JSON.parse(JSON.stringify(h)))}),e.addStudent(t);try{const c=Se(e.sessions).filter(v=>!v.isCancelled).sort((v,g)=>g.sessionNumber-v.sessionNumber),h=c.length>0?c[0]:null;let y="؟",p={type:"system",description:"Student Move"};h&&(y=Qe(e).get(h.sessionNumber)||h.sessionNumber,p={type:"fromSession",sessionNumber:h.sessionNumber});const u=new Date().toLocaleDateString("fa-IR"),b=o.info.name,f=`این دانش آموز در جلسه ${y} و در تاریخ ${u} از کلاس «${b}» به این کلاس انتقال پیدا کرد`;t.addNote(f,p)}catch(c){console.error("Failed to add automated move note:",c)}a.size>0&&e.sessions.forEach(c=>{const h=a.get(c.sessionNumber);h&&!c.isDeleted&&!c.isCancelled&&(c.studentRecords[t.identity.studentId]=h)});const s={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`(انتقال) دانش‌آموز «${n.identity.name}» از کلاس «${o.info.name}»`,restoreData:{studentId:n.identity.studentId,classId:o.info.scheduleCode}};ge.unshift(s),ge.length>50&&ge.pop();const i=o.students.find(c=>c.identity.studentId===n.identity.studentId);return i&&(i.isDeleted=!0),{success:!0}}function ti(){for(const n in re){const o=re[n];o.students.forEach(e=>{e.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0},e.categoryCounts={},e.categoryIssues={},o.sessions.forEach(l=>{const r=e.identity.studentId;l.studentRecords[r]&&(l.studentRecords[r].attendance="present")})})}ce()}function Se(n){return Array.isArray(n)?n.filter(o=>!o.isDeleted):[]}function Qe(n){const o=new Map;return n&&Se(n.sessions).filter(l=>!l.isCancelled).sort((l,r)=>l.sessionNumber-r.sessionNumber).forEach((l,r)=>{o.set(l.sessionNumber,r+1)}),o}function gt(n){je=n}function it(n){ws=n}function Nn(n,o){if(!n||!o)return;const e=n.identity.studentId,l=o.students.findIndex(r=>r.identity.studentId===e);l>-1&&o.students.splice(l,1),o.sessions.forEach(r=>{r.studentRecords[e]&&delete r.studentRecords[e];for(const t in r.lastWinnerByCategory)r.lastWinnerByCategory[t]===e&&delete r.lastWinnerByCategory[t];r.lastSelectedWinnerId===e&&(r.lastSelectedWinnerId=null),r.winnerHistory=r.winnerHistory.filter(t=>t.winner&&t.winner.identity.studentId!==e)})}function ni(n,o){const e=re[n];if(!e)return;const l=e.sessions.findIndex(r=>r.sessionNumber===o);l>-1&&(e.students.forEach(r=>{r.profile.notes&&r.profile.notes.length>0&&(r.profile.notes=r.profile.notes.filter(t=>!t.source||t.source.type!=="fromAttendance"||t.source.sessionNumber!==o)),r.onboardingSession===o&&(r.onboardingSession=null)}),e.sessions.splice(l,1))}function si(n,o){const e=re[n];if(!e)return;const l=e.categories.findIndex(s=>s.id===o);if(l===-1)return;const t=e.categories[l].name,a=t.toLowerCase();e.students.forEach(s=>{s.categoryCounts&&delete s.categoryCounts[t],s.categoryIssues&&delete s.categoryIssues[t],s.logs.scores&&delete s.logs.scores[a]}),e.sessions.forEach(s=>{s.lastWinnerByCategory[t]&&delete s.lastWinnerByCategory[t],s.winnerHistory=s.winnerHistory.filter(i=>i.categoryName!==t)}),e.categories.splice(l,1)}function ii(n,o,e,l){const r=re[n];if(!r)return;const t=r.students.find(i=>i.identity.studentId===o);if(!t||!t.logs.scores[e.toLowerCase()])return;const a=t.logs.scores[e.toLowerCase()],s=a.findIndex(i=>i.id===l);s>-1&&a.splice(s,1)}function ai(n,o,e){const l=re[n];if(!l)return;const r=l.students.find(a=>a.identity.studentId===o);if(!r||!r.profile.notes)return;const t=r.profile.notes.findIndex(a=>a.id===e);t>-1&&r.profile.notes.splice(t,1)}function ri(){JSON.parse(JSON.stringify({classrooms:re,trashBin:ge})),ot=!0}function oi(){ot=!1,Dn()}function Pe(n){D=n}function tn(n){hs=n}function Ze(n){K=n}function Ke(n){_e=n}function An(n){en=n}function ci(n){$n=n}function Ut(n){ps=n}function gn(n){Sn=n}function li(n){gs=n}function On(n){Ve=n}function yn(n){In=n}function di(n){ys=n}function vn(n){xn=n}function ui(n){vs=n}function Es(n){bs=n}function ks(n){Cs=n}function nn(n){Ln=n}function Ss(n){pt=n}function Mn(n){Bn=n}function fi(n){Gs=n}function mi(n){Vs=n}function Is(n){ge=n}function Fn(n){Tn=n}function sn(n){Et=n}function Vt(n){qe={...qe,...n},ce()}function Kn(n){rt=n}function xs(){qe.lastBackupTimestamp=new Date().toISOString(),ce()}const Xi=Object.freeze(Object.defineProperty({__proto__:null,get activeModal(){return pt},get cancelCallback(){return Cs},get classrooms(){return re},get confirmCallback(){return bs},get currentClassroom(){return D},get easterEggClickCount(){return In},get easterEggLastClickTime(){return ys},enterDemoMode:ri,exitDemoMode:oi,getActiveItems:Se,getSessionDisplayMap:Qe,get importedFileContent(){return Sn},get isDemoMode(){return ot},get liveSession(){return hs},loadData:Dn,get manualSelection(){return Bn},moveStudent:ei,get namesToImport(){return ps},get notificationTimeout(){return gs},permanentlyDeleteCategory:si,permanentlyDeleteNote:ai,permanentlyDeleteScore:ii,permanentlyDeleteSession:ni,permanentlyDeleteStudent:Nn,prepareBackupData:Ks,get previousState(){return en},processRestore:Ys,rehydrateData:kt,renameCategory:Qs,renameClassroom:Xs,resetAllStudentCounters:ti,get resetEasterEggClickCount(){return xn},get resetEasterEggLastClickTime(){return vs},get saveCategoryCallback(){return Tn},saveData:ce,get saveNoteCallback(){return ws},get secureConfirmCallback(){return Ln},get selectedCategory(){return Ve},get selectedClassIds(){return rt},get selectedSession(){return K},get selectedStudentForProfile(){return _e},get selectedStudentsForMassComment(){return Et},setActiveModal:Ss,setCancelCallback:ks,setConfirmCallback:Es,setCurrentClassroom:Pe,setEasterEggClickCount:yn,setEasterEggLastClickTime:di,setImportedFileContent:gn,setLastBackupTimestamp:xs,setLiveSession:tn,setManualSelection:Mn,setNamesToImport:Ut,setNotificationTimeout:li,setPreviousState:An,setResetEasterEggClickCount:vn,setResetEasterEggLastClickTime:ui,setSaveCategoryCallback:Fn,setSaveNoteCallback:it,setSecureConfirmCallback:nn,setSelectedCategory:On,setSelectedClassIds:Kn,setSelectedSession:Ze,setSelectedStudentForProfile:Ke,setSelectedStudentsForMassComment:sn,setSourceClassForMove:mi,setStudentToMove:fi,setTrashBin:Is,setUndoTimeout:ci,setUserSettings:Vt,setWinnerHistoryIndex:gt,get sourceClassForMove(){return Vs},get studentToMove(){return Gs},get trashBin(){return ge},get undoTimeout(){return $n},get userSettings(){return qe},get winnerHistoryIndex(){return je}},Symbol.toStringTag,{value:"Module"})),Qi="TeacherAssistantDB",ea=1,ht="backups";function hi(){return new Promise((n,o)=>{const e=indexedDB.open(Qi,ea);e.onupgradeneeded=l=>{const r=l.target.result;r.objectStoreNames.contains(ht)||r.createObjectStore(ht,{keyPath:"id"})},e.onsuccess=l=>n(l.target.result),e.onerror=l=>o(l.target.error)})}async function ta(n,o){const e=await hi(),l=e.transaction(ht,"readwrite"),r=l.objectStore(ht),t={id:Date.now(),file:n,metadata:o,timestamp:new Date().toISOString()};r.add(t),l.oncomplete=()=>{const s=e.transaction(ht,"readwrite").objectStore(ht),i=s.count();i.onsuccess=()=>{if(i.result>3){const c=s.getAllKeys();c.onsuccess=()=>{const h=c.result;for(;h.length>3;){const y=h.shift();s.delete(y),console.log(`♻️ Auto-deleted old backup snapshot: ${y}`)}}}}}}async function na(){const n=await hi();return new Promise((o,e)=>{const t=n.transaction(ht,"readonly").objectStore(ht).getAll();t.onsuccess=()=>{const a=t.result.sort((s,i)=>i.id-s.id);o(a)},t.onerror=()=>e(t.error)})}function Xe(n){return typeof n!="string"?"":n.replace(/ي/g,"ی").replace(/ك/g,"ک").replace(/[\s\u200c]/g,"")}function Ls(n){return typeof n!="string"||n.length===0?"ltr":/[\u0590-\u07FF]/.test(n)?"rtl":"ltr"}function pi(n){return!n||!n.trim()?"":n.split(`
`).map(l=>`<div dir="${Ls(l)}">${l||"&nbsp;"}</div>`).join("")}function qn(n){if(typeof n!="string")return"";const o={q:"ض",w:"ص",e:"ث",r:"ق",t:"ف",y:"غ",u:"ع",i:"ه",o:"خ",p:"ح","[":"ج","]":"چ",a:"ش",s:"س",d:"ی",f:"ب",g:"ل",h:"ا",j:"ت",k:"ن",l:"م",";":"ک","'":"گ",z:"ظ",x:"ط",c:"ز",v:"ر",b:"ذ",n:"د",m:"پ",",":"و"};let e="";for(let l=0;l<n.length;l++){const r=n[l].toLowerCase();e+=o[r]||n[l]}return e}const gi="teacherAssistantLogs_v2",sa=100;function Ts(){try{const n=localStorage.getItem(gi);return n?JSON.parse(n):{}}catch(n){return console.error("Error reading logs from localStorage:",n),{}}}function yi(n){try{localStorage.setItem(gi,JSON.stringify(n))}catch(o){console.error("Error saving logs to localStorage:",o)}}function ke(n,o,e=null){if(!n)return;const l=Ts();l[n]||(l[n]=[]);const r={timestamp:new Date().toISOString(),message:o,action:e,classroomName:n};l[n].unshift(r),l[n].length>sa&&l[n].pop(),yi(l)}function ia(n){return Ts()[n]||[]}function aa(n,o){const e=Ts();e[n]&&!e[o]&&(e[o]=e[n],delete e[n],yi(e))}const vi=document.getElementById("class-management-page"),ra=document.getElementById("new-class-name"),oa=document.getElementById("add-class-btn"),At=document.getElementById("class-list"),Rn=document.getElementById("undo-toast"),bi=document.getElementById("undo-message"),ca=document.getElementById("undo-btn"),la=document.getElementById("settings-page"),Bs=document.getElementById("settings-class-name-header"),Jn=document.getElementById("settings-student-list"),Yn=document.getElementById("category-list"),da=document.getElementById("back-to-sessions-btn"),ua=document.getElementById("new-student-name"),fa=document.getElementById("add-student-btn"),Ci=document.getElementById("paste-area"),ma=document.getElementById("process-paste-btn"),ha=document.getElementById("csv-preview-page"),Xn=document.getElementById("csv-preview-list"),pa=document.getElementById("csv-confirm-btn"),ga=document.getElementById("csv-cancel-btn"),ya=document.getElementById("import-csv-btn"),va=document.getElementById("csv-file-input"),ba=document.getElementById("column-mapping-page"),Qn=document.getElementById("column-select-dropdown"),Ca=document.getElementById("confirm-column-btn"),wa=document.getElementById("cancel-import-btn"),_a=document.getElementById("new-category-name"),Ea=document.getElementById("add-category-btn"),es=document.querySelector(".app-header"),nt=document.getElementById("select-student-btn"),Rt=document.getElementById("select-student-btn-wrapper"),ka=document.getElementById("attendance-page"),Kt=document.getElementById("attendance-list"),Sa=document.getElementById("finish-attendance-btn"),Ia=document.querySelector("#class-management-page h2"),ts=document.getElementById("student-stats-header"),xa=document.getElementById("hamburger-menu-btn"),La=document.getElementById("side-nav-menu"),Ta=document.getElementById("close-nav-btn"),Ba=document.getElementById("overlay"),Da=document.getElementById("backup-data-btn"),Na=document.getElementById("restore-data-btn"),wi=document.getElementById("restore-file-input"),Aa=document.getElementById("custom-confirm-modal"),_i=document.getElementById("confirm-modal-message"),ns=document.getElementById("confirm-modal-cancel-btn"),jt=document.getElementById("confirm-modal-confirm-btn"),Oa=document.getElementById("secure-confirm-modal"),Ei=document.getElementById("secure-confirm-message"),ki=document.getElementById("secure-confirm-code"),Bt=document.getElementById("secure-confirm-input"),Ma=document.getElementById("secure-confirm-cancel-btn"),bn=document.getElementById("secure-confirm-confirm-btn"),Ra=document.getElementById("add-note-modal"),we=document.getElementById("new-note-content"),za=document.getElementById("class-save-note-btn"),$a=document.getElementById("cancel-note-btn"),ss=document.getElementById("student-search-input"),mt=document.getElementById("student-search-results"),Fa=document.getElementById("back-to-student-page-btn"),Pa=document.getElementById("graded-category-pills-container"),Ha=document.getElementById("new-score-value"),Si=document.getElementById("new-score-comment"),Wa=document.getElementById("add-score-btn"),Ua=document.getElementById("profile-stats-summary"),ja=document.getElementById("profile-scores-list"),Zt=document.getElementById("global-student-search-input"),at=document.getElementById("global-student-search-results"),Za=document.getElementById("is-graded-checkbox"),qa=document.getElementById("trashed-classes-list"),Ga=document.getElementById("trashed-students-list"),Va=document.getElementById("trashed-sessions-list"),Ka=document.getElementById("trashed-categories-list"),Ja=document.getElementById("trashed-notes-list"),Ya=document.getElementById("trashed-scores-list"),Nt=document.getElementById("quick-grade-form-wrapper"),ct=document.getElementById("quick-score-input"),tt=document.getElementById("quick-note-textarea"),wt=document.getElementById("quick-grade-submit-btn"),Jt=document.getElementById("category-selection-container"),is=document.getElementById("selected-student-result"),_t=document.getElementById("custom-context-menu"),Dt=document.getElementById("breadcrumb-container");let Wt=null,Ot=null;const Xa=document.getElementById("category-modal"),Ii=document.getElementById("category-modal-title"),Yt=document.getElementById("new-category-modal-name"),Ds=document.getElementById("new-category-modal-is-graded"),Qa=document.getElementById("category-modal-cancel-btn"),xi=document.getElementById("category-modal-save-btn"),er=document.getElementById("mass-comment-modal"),tr=document.getElementById("mass-comment-modal-title"),Li=document.getElementById("mass-comment-student-count-message"),Xt=document.getElementById("mass-comment-content"),Ns=document.getElementById("mass-comment-append-checkbox"),nr=document.getElementById("mass-comment-cancel-btn"),sr=document.getElementById("mass-comment-save-btn"),as=document.getElementById("mass-comment-btn"),Cn=document.getElementById("attendance-mass-actions-container"),bt=document.createElement("input"),ir=document.getElementById("session-dashboard-page"),zt=document.getElementById("attendance-pane");function qt(n,o){let e;const r=a=>{e=setTimeout(()=>{navigator.vibrate&&navigator.vibrate(50),o(a)},800)},t=()=>{clearTimeout(e)};n.addEventListener("touchstart",r,{passive:!0}),n.addEventListener("touchend",t),n.addEventListener("touchmove",t),n.addEventListener("mousedown",r),n.addEventListener("mouseup",t),n.addEventListener("mouseleave",t)}function $t(n="selector"){if(!D||!K){ye("class-management-page");return}lr(),_n(),Re(),st(),ye("session-dashboard-page",{tab:n}),Ti(),an(n),dr()}function an(n){const o=document.getElementById("selector-tab-btn"),e=document.getElementById("attendance-tab-btn"),l=document.getElementById("selector-pane"),r=n==="selector";o.classList.toggle("active",r),e.classList.toggle("active",!r),l.classList.toggle("active",r),zt.classList.toggle("active",!r)}function Ti(){const n=document.getElementById("selector-tab-btn"),o=document.getElementById("attendance-tab-btn"),e=document.getElementById("selector-pane");n.addEventListener("click",()=>{Re(),Me(),n.classList.add("active"),o.classList.remove("active"),e.classList.add("active"),zt.classList.remove("active"),ye("session-dashboard-page",{tab:"selector"})}),o.addEventListener("click",()=>{st(),o.classList.add("active"),n.classList.remove("active"),zt.classList.add("active"),e.classList.remove("active"),ye("session-dashboard-page",{tab:"attendance"})})}function ar(n){clearTimeout($n),en||An(JSON.stringify(re)),bi.textContent=n,Rn.classList.add("show"),ci(setTimeout(()=>{Rn.classList.remove("show"),An(null)},5e3))}function Bi(){if(en){const n=D?D.info.name:null,o=JSON.parse(en);kt(o),n&&re[n]?Pe(re[n]):Pe(null),D?(lt(),Ft(),We()):He(),Rn.classList.remove("show"),clearTimeout($n),An(null)}}function ee(n,o=3e3){const e=document.getElementById("notification-toast");e&&(e.textContent=n,e.classList.add("show"),clearTimeout(gs),li(setTimeout(()=>{e.classList.remove("show")},o)))}function zn(n){var v;const o=document.getElementById("restore-confirm-modal"),e=document.getElementById("restore-modal-message"),l=document.getElementById("restore-append-checkbox"),r=document.querySelector('label[for="restore-append-checkbox"]'),t=document.getElementById("restore-confirm-cancel-btn"),a=document.getElementById("restore-confirm-confirm-btn"),s=document.getElementById("restore-modal-warning");s.style.display="none";const i=((v=n.metadata)==null?void 0:v.createdAt)||0;if(qe.lastRestoreTimestamp&&i<qe.lastRestoreTimestamp){const g=new Date(i).toLocaleDateString("fa-IR"),C=new Date(qe.lastRestoreTimestamp).toLocaleDateString("fa-IR");s.textContent=`⚠️ هشدار: این فایل پشتیبان (${g}) قدیمی‌تر از آخرین بازیابی شما (${C}) است.`,s.style.display="block"}const c=n.data.classrooms||{},h=Object.values(c).map(g=>g.info.name),y=h.length,p="کلاس",u=h.map(g=>`<li style="margin-bottom: 4px;">🔹 ${g}</li>`).join("");e.innerHTML=`
        <div style="margin-bottom: 10px;">
            فایل پشتیبان شامل <strong>${y} ${p}</strong> زیر است:
        </div>
        <ul style="
            margin: 0; 
            padding: 10px; 
            background-color: #f8f9fa; 
            border-radius: 5px; 
            border: 1px solid #e9ecef;
            list-style: none; 
            max-height: 150px; 
            overflow-y: auto;
            text-align: right;
        ">
            ${u}
        </ul>
        <div style="margin-top: 15px;">
            لطفاً نحوه بازیابی را مشخص کنید.
        </div>
    `,l.checked=!1,r&&(r.textContent="جایگزینی کامل (حذف داده‌های فعلی)");const b=()=>{const g=l.checked;Ys(n,g),a.onclick=null,t.onclick=null,o.removeEventListener("click",b),Ee(),He(),ye("class-management-page"),ee(`✅ اطلاعات با موفقیت بازیابی شد (${g?"پاک‌سازی و بازیابی":"همگام‌سازی هوشمند"}).`)},f=()=>{a.onclick=null,t.onclick=null,Ee()};a.onclick=b,t.onclick=f,$e("restore-confirm-modal")}function Ce(n,o,e={}){const{confirmText:l="تایید",cancelText:r="لغو",confirmClass:t="btn-success",onCancel:a=()=>{},isDelete:s=!1}=e,i=s?()=>Di(n,o):o;_i.textContent=n,jt.textContent=l,ns.textContent=r,jt.className="modal-action-btn",jt.classList.add(t),Es(i),ks(a);const c=jt.parentElement;ns.style.display=a===null?"none":"inline-block",c.style.justifyContent=a===null?"center":"space-between",$e("custom-confirm-modal")}function Di(n,o){const e=Math.floor(1e4+Math.random()*9e4).toString();Ei.textContent=n,ki.textContent=e,Bt.value="",bn.disabled=!0,nn(o),$e("secure-confirm-modal"),Bt.focus();const l=()=>{Bt.value===e?bn.disabled=!1:bn.disabled=!0};return Bt.addEventListener("input",l),()=>{Bt.removeEventListener("input",l)}}function rs(n,o={}){const{title:e="ایجاد دسته‌بندی جدید",initialName:l="",initialIsGraded:r=!1,saveButtonText:t="ذخیره"}=o;Ii.textContent=e,Yt.value=l,Ds.checked=r,xi.textContent=t,Fn((a,s)=>{if(!a){ee("⚠️ لطفاً نام دسته‌بندی را وارد کنید.");return}n(a,s),Ee()}),$e("category-modal"),Yt.focus(),l&&Yt.select()}function As(n,o){const e=Object.values(re).filter(a=>!a.isDeleted&&a.info.name!==o.info.name),l=document.getElementById("move-student-modal-title"),r=document.getElementById("move-student-class-select"),t=document.getElementById("move-student-confirm-btn");l.textContent=`انتقال دانش‌آموز: ${n.identity.name}`,r.innerHTML="",e.length===0?(r.innerHTML='<option value="">کلاس دیگری برای انتقال وجود ندارد</option>',t.disabled=!0):(e.forEach(a=>{const s=document.createElement("option");s.value=a.info.name,s.textContent=a.info.name,r.appendChild(s)}),t.disabled=!1),fi(n),mi(o),$e("move-student-modal")}function Os(n,o){if(!n||!o)return;const e=n.identity.name,l=document.getElementById("add-note-modal-title");l.textContent="تغییر نام دانش‌آموز",we.value=e,we.rows=1,we.dispatchEvent(new Event("input",{bubbles:!0})),it(r=>{const t=r.trim();t&&t!==e&&(Se(o.students).some(s=>s.identity.studentId!==n.identity.studentId&&s.identity.name.toLowerCase()===t.toLowerCase())?ee("دانش‌آموزی با این نام از قبل در این کلاس وجود دارد."):(n.identity.name=t,ke(o.info.name,`نام دانش‌آموز «${e}» به «${t}» تغییر یافت.`,{type:"VIEW_STUDENT_PROFILE",studentId:n.identity.studentId}),ce(),lt(),Re(),st(),Me(),_e&&_e.identity.studentId===n.identity.studentId&&ze(n),ee(`✅نام دانش‌آموز به «${t}» تغییر یافت.`))),l.textContent="ثبت یادداشت جدید",we.rows=4}),$e("add-note-modal"),we.focus(),we.select()}function $e(n){const o=document.getElementById(n);if(o){if(pt)return;document.body.classList.add("modal-active"),o.classList.add("modal-visible"),Ss(n),history.pushState(null,"",location.href)}}function Ee(n,o=!1){if(!pt)return;const e=document.getElementById(pt),l=pt;Ss(null),l==="student-profile-modal"&&Ke(null),o||history.back(),e&&(e.classList.add("modal-closing"),setTimeout(()=>{e.classList.remove("modal-visible"),e.classList.remove("modal-closing"),document.body.classList.remove("modal-active"),l==="custom-confirm-modal"&&(Es(null),ks(null)),l==="secure-confirm-modal"&&nn(null),l==="category-modal"&&Fn(null),l==="mass-comment-modal"&&(Xt.value=""),l==="add-note-modal"&&it(null),typeof n=="function"&&n()},300))}function Ms(){if(!zt||!zt.classList.contains("active")){Cn.style.display="none";return}const n=Et.length;n<1?Cn.style.display="none":Cn.style.display="block",as.disabled=n<1,as.textContent=`📝 ثبت یادداشت گروهی (${n} نفر)`}function Rs(){const n=Et,o=n.length;let e=!1;o>0&&(e=n.some(r=>{var t;return(t=K.studentRecords[r])==null?void 0:t.homework.comment})),Li.textContent=`یادداشت برای ${o} دانش‌آموز ثبت خواهد شد.`,Xt.value="",Xt.dispatchEvent(new Event("input",{bubbles:!0})),Ns.checked=!0;const l=document.querySelector("#mass-comment-modal .modal-options");l.style.display=e?"flex":"none",$e("mass-comment-modal"),Xt.focus()}function os(n,o){if(!D||!K)return;let e=0;const l=Et,r=K;l.forEach(t=>{const a=r.studentRecords[t];if(a&&a.homework){const s=a.homework.comment||"";let i=n;o&&s.length>0?i=s+`
---
`+n:i=n,a.homework.comment=i.trim();const c=D.students.find(h=>h.identity.studentId===t);c&&rr(c,r,i.trim()),e++}}),sn([]),ce(),st(),ke(D.info.name,`${e} دانش‌آموز به صورت گروهی یادداشت تکلیف گرفتند.`,{type:"VIEW_SESSIONS"}),ee(`✅ یادداشت برای ${e} دانش‌آموز ثبت شد.`)}function rr(n,o,e){const r=Qe(D).get(o.sessionNumber),t={type:"fromAttendance",sessionNumber:o.sessionNumber},a=`یادداشت مربوط به جلسه ${r}: `,s=n.profile.notes.find(i=>!i.isDeleted&&i.source&&i.source.type==="fromAttendance"&&i.source.sessionNumber===t.sessionNumber);s?e?(s.content=a+e,s.isDeleted=!1):s.isDeleted=!0:e&&n.addNote(a+e,t)}function Pn(n){we.value=n.note||"",it(o=>{n.note=o,ce(),ke(n.info.name,"یادداشت کلاس ذخیره شد.",{type:"VIEW_CLASS_NOTE"}),He(),ee("✅ یادداشت کلاس ذخیره شد.")}),$e("add-note-modal"),we.focus()}function zs(n,o){we.value=n.note||"",we.dispatchEvent(new Event("input",{bubbles:!0})),it(e=>{n.note=e,ce(),ke(D.info.name,`یادداشت جلسه ${o} ذخیره شد.`,{type:"VIEW_SESSIONS"}),We(),ee("✅یادداشت جلسه ذخیره شد.")}),$e("add-note-modal"),we.focus()}function Mt(n){Pe(n),Bs.textContent=`تنظیمات کلاس: ${n.info.name}`,lt(),Ft(),Fi(),ye("settings-page")}function Ni(n){const o=document.getElementById("log-modal-title"),e=document.getElementById("log-list");o.textContent=`گزارش فعالیت‌های کلاس: ${n}`,e.innerHTML="";const l=ia(n);l.length===0?e.innerHTML='<li class="no-content-message">هنوز فعالیتی برای این کلاس ثبت نشده است.</li>':l.forEach(r=>{const t=document.createElement("li");t.className="log-entry";const a=new Date(r.timestamp),s=`${a.toLocaleDateString("fa-IR")} - ${a.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}`,i=document.createElement("span");i.className="log-timestamp",i.textContent=s;const c=document.createElement("span");c.className="log-message",c.textContent=r.message,r.action&&(c.classList.add("log-action-link"),c.dataset.action=JSON.stringify({...r.action,classroomName:r.classroomName})),t.appendChild(i),t.appendChild(c),e.appendChild(t)}),$e("log-modal")}document.getElementById("log-modal-close-btn").addEventListener("click",()=>{Ee()});function cs(n){const o=URL.createObjectURL(n),e=document.createElement("a");e.href=o,e.download=n.name,document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(o),setTimeout(()=>{Ce("آیا فایل پشتیبان با موفقیت ذخیره شد؟",()=>{xs(),Hn(),ee("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله، ذخیره شد",cancelText:"خیر",confirmClass:"btn-success"})},500)}async function rn(n=[]){const o=await Ks(n);if(!o){ee("❌ خطا در ایجاد فایل پشتیبان.");return}let e="پشتیبان کامل سیستم";if(n.length>0){const r=n.join("، ");e=`${n.length===1?"پشتیبان کلاس:":"پشتیبان کلاس‌های:"} ${r}`}ta(o,{name:o.name,description:e,version:"2.0-b64"}).catch(r=>console.error("Failed to save local snapshot:",r)),("ontouchstart"in window||navigator.maxTouchPoints>0)&&navigator.share&&navigator.canShare&&navigator.canShare({files:[o]})?Ce("فایل پشتیبان شما آماده است. آیا مایل به اشتراک‌گذاری آن هستید؟",()=>{try{navigator.share({title:o.name,text:"فایل پشتیبان داده‌های برنامه",files:[o]}).then(()=>{Ce("آیا فایل پشتیبان با موفقیت ارسال/ذخیره شد؟",()=>{xs(),Hn(),ee("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}catch(r){console.error("Error during sharing process:",r),cs(o),ee("⚠️خطا در فرآیند اشتراک‌گذاری. فایل در حال دانلود است.")}},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"}):(cs(o),ee("✅پشتیبان‌گیری با موفقیت انجام شد."))}function cn(n,o){n.preventDefault(),Ct(),Ot=n.target.closest("li"),Ot&&Ot.classList.add("context-menu-target"),setTimeout(()=>{const e=_t,l=e.querySelector("ul");l.innerHTML="",o.forEach(c=>{const h=document.createElement("li");c.isSeparator?h.className="separator":(h.innerHTML=`
                    <span class="icon">${c.icon||""}</span>
                    <span class="label">${c.label}</span>
                `,c.className&&h.classList.add(c.className),h.addEventListener("click",()=>{c.action(),Ct()})),l.appendChild(h)}),e.classList.add("visible");const{offsetWidth:r,offsetHeight:t}=e,{innerHeight:a}=window,s=document.body.getBoundingClientRect();e.style.top=`${(a-t)/2}px`;const i=s.left+s.width/2;e.style.left=`${i-r/2}px`},50)}function Ct(){_t.classList.contains("visible")&&_t.classList.remove("visible"),Ot&&(Ot.classList.remove("context-menu-target"),Ot=null)}function Ai(){var e;Dt.innerHTML="";const n=document.getElementById("header-settings-btn");if(!n)return;const o=[];if(o.push({label:"کلاس‌ها",handler:()=>{Pe(null),Ze(null),Ke(null),ye("class-management-page")}}),D){o.push({label:D.info.name,handler:()=>{Ze(null),Ke(null),We(),ye("session-page")}});const l=(e=document.querySelector(".page.active"))==null?void 0:e.id;if(l==="session-page"?n.style.visibility="visible":n.style.visibility="hidden",l==="settings-page")o.push({label:"تنظیمات"});else if(K){const t=Qe(D).get(K.sessionNumber)||` (#${K.sessionNumber})`;o.push({label:`جلسه ${t}`,handler:()=>{Ke(null),$t("selector")}}),_e?o.push({label:`پروفایل: ${_e.identity.name}`}):l==="session-dashboard-page"&&(document.getElementById("attendance-tab-btn").classList.contains("active")?o.push({label:"حضور و غیاب"}):o.push({label:"انتخابگر"}))}}else n.style.visibility="hidden";if(o.length<=1){Dt.style.display="none";return}Dt.style.display="flex",o.forEach((l,r)=>{const t=document.createElement("a");if(t.textContent=l.label,t.className="breadcrumb-item",r===o.length-1||!l.handler?t.classList.add("active"):t.addEventListener("click",l.handler),Dt.appendChild(t),r<o.length-1){const a=document.createElement("span");a.className="breadcrumb-separator",a.textContent="/",Dt.appendChild(a)}})}function Hs(n,o,e){e.innerHTML="";const l=D.sessions.filter(r=>{var t;return!r.isDeleted&&!r.isCancelled&&((t=r.studentRecords[n.identity.studentId])==null?void 0:t.attendance)==="absent"}).map(r=>({number:o.get(r.sessionNumber),isMakeup:r.isMakeup})).filter(r=>r.number!==void 0);l.length>0?(e.appendChild(document.createTextNode("جلسات غایب: ")),l.forEach((r,t)=>{const a=document.createElement("span");a.textContent=r.number,r.isMakeup&&a.classList.add("makeup-absence"),e.appendChild(a),t<l.length-1&&e.appendChild(document.createTextNode("، "))})):e.textContent="جلسات غایب: بدون غیبت"}function wn(n,o,e,l={}){const{includePrefix:r=!0}=l;e.innerHTML="";const t=D.sessions.filter(a=>{if(a.isDeleted||a.isCancelled)return!1;const s=a.studentRecords[n.identity.studentId];return s&&s.homework&&(s.homework.status==="incomplete"||s.homework.status==="none")}).map(a=>({number:o.get(a.sessionNumber),status:a.studentRecords[n.identity.studentId].homework.status})).filter(a=>a.number!==void 0);t.length>0?(r&&e.appendChild(document.createTextNode("تکالیف ناقص: ")),t.forEach((a,s)=>{const i=document.createElement("span");i.textContent=a.number,a.status==="incomplete"&&i.classList.add("incomplete-homework"),e.appendChild(i),s<t.length-1&&e.appendChild(document.createTextNode("،"))})):r?e.textContent="تکالیف ناقص: ندارد":e.textContent="ندارد"}function or(n,o){var L,N,R;const e=document.createElement("li");e.className="attendance-list-item";const l=document.createElement("span");l.className="absence-info";const r=document.createElement("span");r.className="homework-info";const t=document.createElement("div");t.className="att-row-1";let a=!1;t.addEventListener("mousedown",()=>a=!1),t.addEventListener("touchstart",()=>a=!1,{passive:!0});const s=document.createElement("input");s.type="checkbox",s.className="mass-comment-checkbox",s.checked=Et.includes(n.identity.studentId),s.addEventListener("change",()=>{const P=n.identity.studentId,Q=Et;if(s.checked)Q.includes(P)||Q.push(P);else{const z=Q.indexOf(P);z>-1&&Q.splice(z,1)}Ms();const k=document.getElementById("attendance-list");Q.length===0&&k.classList.contains("selection-mode-active")&&k.classList.remove("selection-mode-active")});const i=document.createElement("span");i.className="student-name",i.textContent=n.identity.name,i.addEventListener("click",P=>{if(a){P.stopPropagation(),P.preventDefault(),a=!1;return}ze(n)}),qt(t,P=>{a=!0;const Q=document.getElementById("attendance-list");Q.classList.contains("selection-mode-active")||Q.classList.add("selection-mode-active"),s.checked||(s.checked=!0,s.dispatchEvent(new Event("change")))}),t.appendChild(s),t.appendChild(i);const c=document.createElement("div");c.className="att-row-2";const h=document.createElement("button");let y=!1;h.addEventListener("mousedown",()=>y=!1),h.addEventListener("touchstart",()=>y=!1,{passive:!0});const p=((L=K.studentRecords[n.identity.studentId])==null?void 0:L.attendance)||"present",u=P=>{P==="present"?(h.textContent="حاضر",h.className="attendance-status-btn present active"):(h.textContent="غایب",h.className="attendance-status-btn absent active")};u(p),h.addEventListener("click",P=>{var z;if(y){P.stopPropagation();return}const k=(((z=K.studentRecords[n.identity.studentId])==null?void 0:z.attendance)||"present")==="present"?"absent":"present";K.setAttendance(n.identity.studentId,k),k==="absent"&&(K.studentRecords[n.identity.studentId].hadIssue=!1),ce(),u(k),Hs(n,o,l),Re(),Pi()}),qt(h,()=>{y=!0;const P=p==="present"?"absent":"present",Q=P==="present"?"حاضر":"غایب";Ce(`آیا مطمئن هستید که می‌خواهید وضعیت حضور تمام دانش‌آموزان را به «${Q}» تغییر دهید؟`,()=>{Se(D.students).forEach(k=>{K.setAttendance(k.identity.studentId,P),P==="absent"&&(K.studentRecords[k.identity.studentId].hadIssue=!1)}),ce(),st(),ee(`✅ وضعیت تمام دانش‌آموزان به «${Q}» تغییر یافت.`)},{confirmText:"بله، اعمال کن",confirmClass:"btn-warning"})});const b=document.createElement("div");b.className="homework-controls";const f={none:"بدون تکلیف",complete:"تکلیف کامل",incomplete:"تکلیف ناقص"},v=document.createElement("button");let g=!1;v.addEventListener("mousedown",()=>g=!1),v.addEventListener("touchstart",()=>g=!1,{passive:!0});const C=((N=K.studentRecords[n.identity.studentId])==null?void 0:N.homework.status)||"none";v.className=`homework-status-btn ${C}`,v.title=f[C],v.addEventListener("click",P=>{if(g){P.stopPropagation();return}const Q=K.studentRecords[n.identity.studentId].homework,z={none:"incomplete",incomplete:"complete",complete:"none"}[Q.status];K.setHomeworkStatus(n.identity.studentId,z),ce(),v.className=`homework-status-btn ${z}`,v.title=f[z],wn(n,o,r)}),qt(v,()=>{g=!0;const Q={none:"incomplete",incomplete:"complete",complete:"none"}[C],k=f[Q];Ce(`آیا از تغییر وضعیت تکلیف تمام دانش‌آموزان به «${k}» مطمئن هستید؟`,()=>{Se(D.students).forEach(z=>{K.setHomeworkStatus(z.identity.studentId,Q)}),ce(),st(),ee(`✅ وضعیت تکلیف همه به «${k}» تغییر یافت.`)},{confirmText:"بله",confirmClass:"btn-warning"})});const E=document.createElement("button");let S=!1;E.addEventListener("mousedown",()=>S=!1),E.addEventListener("touchstart",()=>S=!1,{passive:!0}),E.className="btn-icon",E.innerHTML="📝",E.title="افزودن یادداشت برای تکلیف",((R=K.studentRecords[n.identity.studentId])==null?void 0:R.homework.comment)||(E.style.opacity="0.3"),E.addEventListener("click",P=>{if(S){P.stopPropagation();return}const Q=K.studentRecords[n.identity.studentId].homework;we.value=Q.comment||"",we.dispatchEvent(new Event("input",{bubbles:!0})),it(k=>{Q.comment=k;const z=Qe(D),m=z.get(K.sessionNumber),H={type:"fromAttendance",sessionNumber:K.sessionNumber},ue=`یادداشت مربوط به جلسه ${m}: `,Z=n.profile.notes.find(fe=>!fe.isDeleted&&fe.source&&fe.source.type==="fromAttendance"&&fe.source.sessionNumber===H.sessionNumber);Z?k?Z.content=ue+k:Z.isDeleted=!0:k&&n.addNote(ue+k,H),ce(),ee("✅یادداشت تکلیف ذخیره شد."),E.style.opacity=k?"1":"0.3",wn(n,z,r)}),$e("add-note-modal"),we.focus()}),qt(E,()=>{S=!0,Ce("آیا می‌خواهید برای **تمام** دانش‌آموزان کلاس یادداشت تکلیف ثبت کنید؟",()=>{const P=Se(D.students).map(Q=>Q.identity.studentId);sn(P),Rs()},{confirmText:"بله",confirmClass:"btn-primary"})}),c.appendChild(h),b.appendChild(E),b.appendChild(v),c.appendChild(b);const x=document.createElement("div");return x.className="att-row-3",Hs(n,o,l),wn(n,o,r),x.appendChild(l),x.appendChild(r),e.appendChild(t),e.appendChild(c),e.appendChild(x),e}function cr(){return Qe(D).get(K.sessionNumber)}function st(){if(!D||!K)return;Se(D.students).forEach(r=>{K.initializeStudentRecord(r.identity.studentId)}),sn([]);const n=Qe(D);br(),Kt.innerHTML="";const o=document.createElement("li");o.className="attendance-list-header",bt.id="attendance-search-input",bt.type="text",bt.className="inline-search-input",bt.placeholder="جستجو...",bt.value="";const e=document.createElement("div");e.className="student-search-container",e.appendChild(bt);const l=document.createElement("div");l.className="header-labels-container",l.innerHTML=`
    <span class="header-label">تکلیف</span>
    <span class="header-label">حضور</span>
`,o.appendChild(e),o.appendChild(l),Kt.appendChild(o),Se(D.students).forEach(r=>{const t=or(r,n);Kt.appendChild(t)}),sn([]),Ms(),Cr(),Pi()}function Re(){const n=document.getElementById("student-stats-table-container");if(!n||(n.innerHTML="",!D))return;Se(D.students).length,ts.textContent="آمار عملکرد";const o=["نام"],e=["کل انتخاب ها","غیبت","خروج","فرصت ازدست‌رفته","مشکل","میانگین","نمره کلاسی (کانون)"],l=D.categories.filter(u=>u.isGradedCategory&&!u.isDeleted).map(u=>u.name),r=[...o,...l,...e],t=document.createElement("table");t.className="student-stats-table";const s=t.createTHead().insertRow();r.forEach((u,b)=>{const f=document.createElement("th");b===0?(f.innerHTML=`${u} <span style="opacity: 0.6;">🔗</span>`,f.title="ردیف‌های این ستون قابل کلیک هستند"):f.textContent=u,s.appendChild(f)});const i=t.createTBody(),c=Se(D.students),h=u=>{let b=0;return D.sessions.forEach(f=>{if(f.isDeleted||f.isCancelled)return;const v=f.studentRecords[u.identity.studentId];v&&v.attendance==="absent"&&b++}),b};c.forEach(u=>{const b=i.insertRow();if(b.dataset.studentId=u.identity.studentId,K){const S=K.studentRecords[u.identity.studentId];S&&S.attendance==="absent"&&b.classList.add("absent-row-highlight")}const f=b.insertCell(),v=document.createElement("span");v.textContent=u.identity.name,v.className="student-name-link",v.addEventListener("click",()=>{ze(u)}),f.appendChild(v),l.forEach(S=>{var N;const I=b.insertCell();I.style.direction="ltr";const x=S.toLowerCase(),L=((N=u.logs.scores[x])==null?void 0:N.filter(R=>!R.isDeleted))||[];L.length>0?L.forEach((R,P)=>{const Q=document.createElement("span");Q.textContent=R.value+(R.comment?"'":""),Q.style.position="relative",R.comment&&(Q.dataset.tooltip=R.comment),I.appendChild(Q),P<L.length-1&&I.appendChild(document.createTextNode(","))}):I.textContent="",I.style.cursor="pointer",I.addEventListener("click",()=>{Me(u,S);const R=document.getElementById("category-selection-container");R&&R.scrollIntoView({behavior:"smooth",block:"center"})})}),b.insertCell().textContent=u.statusCounters.totalSelections||0,b.insertCell().textContent=h(u),b.insertCell().textContent=u.statusCounters.outOfClassCount||0,b.insertCell().textContent=u.statusCounters.missedChances||0;const g=Object.values(u.categoryIssues||{}).reduce((S,I)=>S+I,0);b.insertCell().textContent=g;const C=u.getOverallAverageScore();b.insertCell().textContent=C!==null?C:"-";const E=D.calculateFinalStudentScore(u);b.insertCell().textContent=E!==null?E:"-"}),Se(D.students),ts.setAttribute("data-student-count",c.length),n.appendChild(t);const y=n.querySelector(".student-stats-table"),p=y==null?void 0:y.querySelector("thead th:first-child");p&&p.addEventListener("click",()=>{y.classList.toggle("name-column-expanded")})}function Me(n=null,o=null){const e=document.getElementById("selected-student-result");e.innerHTML="",e.classList.remove("absent");let l,r;if(n&&o)l=n,r=o,Mn({student:n,categoryName:o}),gt(-1);else{if(Mn(null),!K||je<0||!K.winnerHistory[je])return;const F=K.winnerHistory[je];l=F.winner,r=F.categoryName}const t=document.querySelector(".current-winner-highlight");if(t&&t.classList.remove("current-winner-highlight"),l){const F=document.querySelector(`.student-stats-table tr[data-student-id="${l.identity.studentId}"]`);F&&F.classList.add("current-winner-highlight")}const a=D.categories.find(F=>F.name===r);if(a){On(a),$s(a);const F=document.querySelectorAll("#category-selection-container .pill");F.forEach(A=>A.classList.remove("active"));const ne=Array.from(F).find(A=>A.textContent===r);ne&&ne.classList.add("active"),ls(a),ds(a.name)}const s=K.studentRecords[l.identity.studentId],i=(s==null?void 0:s.attendance)==="absent",c=document.createElement("div");c.className="winner-name-container";const h=document.createElement("button");h.className="btn-icon",h.innerHTML="˅",h.title="برنده قبلی";const y=!n;h.classList.toggle("is-disabled",!y||je<=0),h.addEventListener("click",()=>{h.classList.contains("is-disabled")?(h.classList.add("shake-animation"),setTimeout(()=>h.classList.remove("shake-animation"),200)):(gt(je-1),Me())});const p=document.createElement("div");p.className="winner-name",p.innerHTML=`✨ <strong>${l.identity.name}</strong>✨`,p.classList.add("heartbeat-animation"),i&&(p.style.textDecoration="line-through",p.style.opacity="0.6",p.style.color="var(--color-secondary)"),(s==null?void 0:s.hadIssue)&&!i&&(p.style.color="var(--color-warning)",p.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"),(s==null?void 0:s.wasOutOfClass)&&!i&&(p.style.color="var(--color-strong-warning)",p.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود");const f=1e3,v=F=>{Wt=setTimeout(()=>{Sr(l,r),Wt=null},f)},g=()=>{Wt&&(clearTimeout(Wt),Wt=null)};p.addEventListener("mousedown",v),p.addEventListener("mouseup",g),p.addEventListener("mouseout",g),p.addEventListener("touchstart",v),p.addEventListener("touchmove",g),p.addEventListener("touchend",g),p.addEventListener("touchcancel",g);const C=document.createElement("button");if(C.className="btn-icon",C.innerHTML="˄",C.title="برنده بعدی",C.classList.toggle("is-disabled",!y||je>=K.winnerHistory.length-1),C.addEventListener("click",()=>{C.classList.contains("is-disabled")?(C.classList.add("shake-animation"),setTimeout(()=>C.classList.remove("shake-animation"),200)):(gt(je+1),Me())}),c.appendChild(C),c.appendChild(p),l.onboardingSession===K.sessionNumber){const F=document.createElement("div");F.className="new-student-badge",F.textContent="دانش آموز جدید",c.appendChild(F)}c.appendChild(h),e.appendChild(c),nt.disabled=y&&!C.classList.contains("is-disabled");const E=document.createElement("div");E.className="status-button-container";const S=document.createElement("button");S.textContent="غایب",S.classList.add("status-button","absent-btn"),i&&S.classList.add("active");const I=document.createElement("button");I.textContent="مشکل",I.classList.add("status-button","issue-btn"),s!=null&&s.hadIssue&&I.classList.add("active");const x=document.createElement("button");x.textContent="خروج",x.classList.add("status-button","exit-btn"),s!=null&&s.wasOutOfClass&&x.classList.add("active");const L=document.createElement("button");L.textContent="پروفایل",L.className="status-button profile-btn",K.isFinished?S.disabled=!0:S.addEventListener("click",()=>{const F=S.classList.contains("active");x.classList.contains("active")&&(x.classList.remove("active"),s.wasOutOfClass=!1,l.statusCounters.outOfClassCount=Math.max(0,(l.statusCounters.outOfClassCount||0)-1),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)),F?(S.classList.remove("active"),K.setAttendance(l.identity.studentId,"present"),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1),p.style.textDecoration="",p.style.opacity="",p.style.color=""):(I.classList.contains("active")&&(I.classList.remove("active"),s.hadIssue=!1,l.statusCounters.otherIssues=Math.max(0,l.statusCounters.otherIssues-1),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)),S.classList.add("active"),K.setAttendance(l.identity.studentId,"absent"),l.statusCounters.missedChances++,p.style.textDecoration="line-through",p.style.opacity="0.6",p.style.color="var(--color-secondary)",p.title=""),Re(),setTimeout(()=>{je!==-1?Me():Me(l,r)},0),ce()}),K.isFinished?I.disabled=!0:I.addEventListener("click",()=>{const F=I.classList.contains("active");if(x.classList.contains("active")&&(x.classList.remove("active"),s.wasOutOfClass=!1,l.statusCounters.outOfClassCount=Math.max(0,(l.statusCounters.outOfClassCount||0)-1),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)),F){I.classList.remove("active"),s.hadIssue=!1;const ne=Ve.name;l.categoryIssues[ne]&&(l.categoryIssues[ne]=Math.max(0,l.categoryIssues[ne]-1)),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1),p.style.color="",p.title=""}else{S.classList.contains("active")&&(S.classList.remove("active"),K.setAttendance(l.identity.studentId,"present"),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)),I.classList.add("active"),s.hadIssue=!0;const ne=Ve.name;l.categoryIssues[ne]=(l.categoryIssues[ne]||0)+1,l.statusCounters.missedChances++,p.style.textDecoration="",p.style.opacity="",p.style.color="var(--color-warning)",p.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"}Re(),setTimeout(()=>{je!==-1?Me():Me(l,r)},0),ce()}),K.isFinished?x.disabled=!0:x.addEventListener("click",()=>{if(x.classList.contains("active"))x.classList.remove("active"),s.wasOutOfClass=!1,l.statusCounters.outOfClassCount=Math.max(0,(l.statusCounters.outOfClassCount||0)-1),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1),p.style.color="",p.title="";else{if(S.classList.contains("active")&&(S.classList.remove("active"),K.setAttendance(l.identity.studentId,"present"),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)),I.classList.contains("active")){I.classList.remove("active"),s.hadIssue=!1;const ne=Ve.name;l.categoryIssues[ne]&&(l.categoryIssues[ne]=Math.max(0,l.categoryIssues[ne]-1)),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)}x.classList.add("active"),s.wasOutOfClass=!0,l.statusCounters.outOfClassCount=(l.statusCounters.outOfClassCount||0)+1,l.statusCounters.missedChances++,p.style.textDecoration="",p.style.opacity="",p.style.color="var(--color-strong-warning)",p.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود"}Re(),setTimeout(()=>{je!==-1?Me():Me(l,r)},0),ce()}),K.isFinished?L.disabled=!0:L.addEventListener("click",()=>{ze(l)}),E.appendChild(S),E.appendChild(x),E.appendChild(I),E.appendChild(L),e.appendChild(E);const N=document.createElement("div");N.className="student-details-container";const R=document.createElement("div");R.className="student-details-scores",R.innerHTML="<h4>آخرین نمرات</h4>";const P=document.createElement("ul");P.className="scores-list";const Q=D.categories.filter(F=>F.isGradedCategory&&!F.isDeleted);let k=!1;const z=l.logs.scores||{};Q.forEach(F=>{var Be;const ne=F.name,A=ne.toLowerCase(),M=document.createElement("li"),oe=document.createElement("span");oe.className="skill-name",oe.textContent=`${ne}:`;const te=document.createElement("span");te.className="skill-scores";const Y=(Be=z[A])==null?void 0:Be.filter(Ne=>!Ne.isDeleted);if(Y&&Y.length>0){k=!0;const Ne=Y.slice(-3);Ne.forEach((pe,ve)=>{const Le=document.createElement("span");Le.textContent=pe.value+(pe.comment?"'":""),pe.comment&&(Le.dataset.tooltip=pe.comment,Le.style.position="relative",Le.style.cursor="help",Le.classList.add("tooltip-container")),te.appendChild(Le),ve<Ne.length-1&&te.appendChild(document.createTextNode(","))})}else te.textContent="none";M.appendChild(oe),M.appendChild(te),P.appendChild(M)}),k||(P.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>'),R.appendChild(P),N.appendChild(R);const m=document.createElement("div");m.className="student-details-notes";const H=document.createElement("div");H.className="history-section-header";const ue=document.createElement("h4");ue.textContent="یادداشت‌ها";const Z=document.createElement("button");Z.className="btn-icon",Z.innerHTML="📝",Z.title="افزودن یادداشت جدید",K.isFinished?Z.disabled=!0:Z.addEventListener("click",()=>{we.value="",we.dispatchEvent(new Event("input",{bubbles:!0})),it(F=>{F&&(l.addNote(F),ce(),Me(),ee("✅ یادداشت با موفقیت ثبت شد."))}),$e("add-note-modal"),we.focus()}),H.appendChild(ue),H.appendChild(Z),m.appendChild(H);const fe=document.createElement("ul");fe.className="notes-list",l.profile.notes&&l.profile.notes.length>0?[...l.profile.notes].sort((ne,A)=>new Date(A.timestamp)-new Date(ne.timestamp)).forEach(ne=>{const A=document.createElement("li");A.dir=Ls(ne.content),A.textContent=ne.content,fe.appendChild(A)}):fe.innerHTML='<div class="no-content-message">یادداشتی وجود ندارد.</div>',m.appendChild(fe),N.appendChild(m),e.appendChild(N)}function Oi(n){n.addEventListener("input",()=>{const o=n.value,e=Ls(o);n.setAttribute("dir",e)})}function lr(){$s(null),Jt.innerHTML="",is.innerHTML="",Nt.classList.add("tooltip-container"),ct.disabled=!0,tt.disabled=!0,wt.disabled=!0,ct.value="",tt.value="",Rt.classList.add("disabled-wrapper"),nt.disabled=!0}function _n(){Jt.innerHTML="",D.categories.filter(e=>!e.isDeleted).forEach(e=>{const l=document.createElement("span");l.className="pill",l.textContent=e.name,l.dataset.categoryId=e.id,e.description&&(l.dataset.tooltip=e.description),K.isFinished?l.classList.add("disabled"):l.addEventListener("click",()=>{document.querySelectorAll("#category-selection-container .pill").forEach(t=>t.classList.remove("active")),l.classList.add("active"),On(e),$s(e),ls(e),ds(e.name),Rt.classList.remove("disabled-wrapper"),nt.disabled=K.isFinished;const r=K.lastWinnerByCategory[e.name];if(r){const t=D.students.find(a=>a.identity.studentId===r);t&&Me(t,e.name)}else{is.innerHTML="",Mn(null),gt(-1),nt.disabled=!1;const t=document.querySelector(".current-winner-highlight");t&&t.classList.remove("current-winner-highlight")}}),K.isFinished||l.addEventListener("contextmenu",r=>{cn(r,[{label:"تغییر نام",icon:"✏️",action:()=>{rs((a,s)=>{const i=Qs(D,e,a);i.success?(e.isGradedCategory=s,ce(),ke(D.info.name,`نام دسته‌بندی «${e.name}» به «${a}» تغییر یافت.`),_n(),Re(),ee(`✅ نام دسته‌بندی به «${a}» تغییر یافت.`)):ee(`⚠️ ${i.message}`)},{title:"ویرایش دسته‌بندی",initialName:e.name,initialIsGraded:e.isGradedCategory,saveButtonText:"ذخیره تغییرات"})}},{label:"حذف دسته‌بندی",icon:"🗑️",className:"danger",action:()=>{Ce(`آیا از انتقال دسته‌بندی «${e.name}» به سطل زباله مطمئن هستید؟`,()=>{const a={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${e.name}» از کلاس «${D.info.name}»`,restoreData:{categoryId:e.id,classId:D.info.scheduleCode}};ge.unshift(a),ge.length>50&&ge.pop();const s=e.name.toLowerCase();if(D.students.forEach(i=>{i.logs.scores&&i.logs.scores[s]&&i.logs.scores[s].forEach(c=>{c.isDeleted=!0})}),Ve&&Ve.id===e.id){On(null),is.innerHTML="",ls(null),ds(null),Rt.classList.add("disabled-wrapper"),nt.disabled=!0;const i=document.querySelector(".current-winner-highlight");i&&i.classList.remove("current-winner-highlight")}e.isDeleted=!0,ke(D.info.name,`دسته‌بندی «${e.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),_n(),Re(),ee(`✅ دسته‌بندی «${e.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}}])}),Jt.appendChild(l)});const o=document.createElement("span");o.className="pill add-category-pill",o.textContent="+",o.title="افزودن دسته‌بندی جدید",K.isFinished?o.classList.add("disabled"):o.addEventListener("click",()=>{rs((e,l)=>{if(D.categories.find(a=>a.name.toLowerCase()===e.toLowerCase()&&!a.isDeleted)){ee("⚠️ این دسته‌بندی از قبل وجود دارد.");return}const t=new ut(e,"",l);D.categories.push(t),ce(),ke(D.info.name,`دسته‌بندی جدید «${e}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),_n(),ee(`✅ دسته‌بندی «${e}» اضافه شد.`)})}),Jt.appendChild(o)}function dr(){if(K.lastUsedCategoryId){if(K.isFinished)return;const n=Jt.querySelector(`.pill[data-category-id="${K.lastUsedCategoryId}"]`);n&&n.click()}K.winnerHistory&&K.winnerHistory.length>0&&(gt(K.winnerHistory.length-1),Me())}function $s(n){n?nt.textContent=`نفر بعدی در ${n.name}`:nt.textContent="نفر بعدی"}function ls(n){if(K.isFinished){ct.disabled=!0,tt.disabled=!0,wt.disabled=!0,Nt.setAttribute("title","جلسه خاتمه یافته است");return}n&&n.isGradedCategory?(ct.disabled=!1,tt.disabled=!1,wt.disabled=!1,Nt.removeAttribute("title")):(ct.disabled=!0,tt.disabled=!0,wt.disabled=!0,n?Nt.setAttribute("title","برای این دسته‌بندی قابلیت نمره دهی تعریف نشده است"):Nt.setAttribute("title","ابتدا یک دسته‌بندی را انتخاب کنید"))}function ds(n){const o=document.querySelector(".student-stats-table");if(!o||(o.querySelectorAll(".current-category-highlight").forEach(a=>{a.classList.remove("current-category-highlight")}),!n))return;let l=-1;const r=o.querySelectorAll("thead th");if(r.forEach((a,s)=>{a.textContent.trim()===n&&(l=s)}),l===-1)return;r[l].classList.add("current-category-highlight"),o.querySelectorAll("tbody tr").forEach(a=>{const s=a.cells[l];s&&s.classList.add("current-category-highlight")})}function ze(n){Ke(n);const o=document.getElementById("student-profile-modal"),e=document.getElementById("modal-profile-student-name"),l=document.getElementById("modal-profile-content-container"),r=document.getElementById("modal-profile-close-btn");if(!o||!e||!l||!r)return;e.textContent=`پروفایل: ${n.identity.name}`,e.style.cursor="pointer",e.onclick=()=>{const c=_e,h=D;Ee(()=>{Os(c,h)})},l.innerHTML="";const t=document.createElement("div");t.className="profile-header-actions";const a=document.createElement("button");a.className="btn-icon btn-icon-label",a.title="انتقال دانش‌آموز",a.innerHTML="<span>➡️</span><span>انتقال</span>",a.addEventListener("click",()=>{const c=_e,h=D;Ee(()=>{As(c,h)})});const s=document.createElement("button");s.className="btn-icon btn-icon-label",s.title="حذف دانش‌آموز",s.innerHTML="<span>🗑️</span><span>حذف</span>",s.style.color="var(--color-strong-warning)",s.addEventListener("click",()=>{const c=_e,h=D;Ee(()=>{Ce(`آیا از انتقال دانش‌آموز «${c.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const y={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${c.identity.name}» از کلاس «${h.info.name}»`,restoreData:{studentId:c.identity.studentId,classId:h.info.scheduleCode}};ge.unshift(y),ge.length>50&&ge.pop(),c.isDeleted=!0,ke(h.info.name,`دانش‌آموز «${c.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),lt(),Re(),st(),ee(`✅ دانش‌آموز «${c.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0,onCancel:()=>{ze(c)}})})});const i=document.createElement("button");i.className="btn-icon btn-icon-label",i.title="افزودن یادداشت جدید",i.innerHTML="<span>📝</span><span>یادداشت</span>",i.addEventListener("click",()=>{const c=_e;we.value="",we.dispatchEvent(new Event("input",{bubbles:!0})),it(h=>{h&&(c.addNote(h),ce(),ke(D.info.name,`یادداشت جدیدی برای دانش‌آموز «${c.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:c.identity.studentId}),Me(),ee("✅ یادداشت با موفقیت ثبت شد.")),ze(c)}),Ee(()=>{$e("add-note-modal"),we.focus()})}),t.appendChild(a),t.appendChild(s),t.appendChild(i),l.appendChild(t),ur(l),Mi(l),r.onclick=()=>Ee(),$e("student-profile-modal")}function ur(n){if(!_e||!D)return;const o=document.createElement("div");o.className="scoring-section",o.innerHTML=`
        <h3>ثبت نمره جدید</h3>
        <div id="modal-graded-pills" class="category-pills"></div>
        <div class="input-group centered-input-group" style="margin-top: 15px;">
            <input type="number" id="modal-new-score-value" placeholder="نمره (مثلا: 85)">
        </div>
        <textarea id="modal-new-score-comment" placeholder="توضیحات این نمره (اختیاری)..." style="margin-top: 10px;"></textarea>
        <button id="modal-add-score-btn" class="btn-success" style="width: 100%; margin-top: 10px;">ثبت نمره</button>
    `;const e=o.querySelector("#modal-graded-pills");Se(D.categories).filter(t=>t.isGradedCategory).forEach(t=>{const a=document.createElement("span");a.className="pill",a.textContent=t.name,a.dataset.skillName=t.name,a.addEventListener("click",()=>{e.querySelectorAll(".pill").forEach(s=>s.classList.remove("active")),a.classList.add("active")}),e.appendChild(a)}),o.querySelector("#modal-add-score-btn").addEventListener("click",()=>{const t=e.querySelector(".pill.active");if(!t){ee("⚠️لطفاً یک مهارت را برای نمره‌دهی انتخاب کنید.");return}const a=t.dataset.skillName,s=o.querySelector("#modal-new-score-value"),i=o.querySelector("#modal-new-score-comment"),c=s.value,h=i.value.trim();if(!c){ee("لطفاً مقدار نمره را وارد کنید.");return}_e.addScore(a,parseFloat(c),h),ce(),ke(D.info.name,`نمره ${c} در ${a} برای «${_e.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:_e.identity.studentId}),Re(),Me(),s.value="",i.value="";const y=document.getElementById("modal-profile-content-container"),p=y.querySelector(".history-section");p&&p.remove(),Mi(y),ee(`✅ نمره برای مهارت ${a} با موفقیت ثبت شد.`)}),n.appendChild(o)}function Mi(n){if(!_e)return;const o=document.createElement("div");o.className="history-section";const e=document.createElement("div");e.className="history-section-header";const l=document.createElement("h3");l.textContent="سوابق دانش‌آموز",e.appendChild(l),o.appendChild(e),fr(o),Ri(o),zi(o),n.appendChild(o)}function fr(n){if(!_e)return;const o=_e,e=D.sessions.reduce((u,b)=>{const f=b.studentRecords[o.identity.studentId];return u+(f&&f.attendance==="absent"?1:0)},0),l=Object.values(o.categoryIssues||{}).reduce((u,b)=>u+b,0),r=document.createElement("div");r.className="stats-summary-box",r.innerHTML=`
        <p><strong>کل انتخاب:</strong> ${o.statusCounters.totalSelections}</p>
        <p><strong>غیبت:</strong> ${e}</p>
        <p><strong>فرصت از دست رفته:</strong> ${o.statusCounters.missedChances||0}</p>
        <p><strong>مشکل:</strong> ${l}</p>
    `,n.appendChild(r),r.querySelector("p:nth-child(1)");const t=r.querySelector("p:nth-child(4)"),a=Se(D.categories),s=document.createElement("div");if(s.className="stats-breakdown",a.length>0){a.forEach(b=>{var C;const f=b.name,v=((C=o.categoryCounts)==null?void 0:C[f])||0,g=document.createElement("p");g.className="stats-breakdown-item",g.innerHTML=`<strong>${f}:</strong> ${v}`,s.appendChild(g)});const u=r.querySelector("p:first-child");u&&(u.classList.add("collapsible-toggle"),u.onclick=()=>{s.classList.toggle("open"),u.classList.toggle("open")},u.after(s))}const i=document.createElement("div");i.className="stats-breakdown",a.length>0&&(a.forEach(u=>{var g;const b=u.name,f=((g=o.categoryIssues)==null?void 0:g[b])||0,v=document.createElement("p");v.className="stats-breakdown-item",v.innerHTML=`<strong>${b}:</strong> ${f}`,i.appendChild(v)}),t&&(t.classList.add("collapsible-toggle"),t.onclick=()=>{i.classList.toggle("open"),t.classList.toggle("open")},r.appendChild(i)));const c=document.createElement("p"),h=document.createElement("strong");h.textContent="تکالیف ناقص:";const y=document.createElement("span");y.style.marginRight="5px";const p=Qe(D);wn(o,p,y,{includePrefix:!1}),c.appendChild(h),c.appendChild(y),r.appendChild(c)}function Ri(n){if(!_e)return;const o=_e,e=document.createElement("h4");e.textContent="تاریخچه نمرات:",e.style.marginTop="20px";const l=document.createElement("ul");l.className="list-container";const r=Object.values(o.logs.scores||{}).flat().filter(t=>!t.isDeleted).sort((t,a)=>new Date(a.timestamp)-new Date(t.timestamp));r.length===0?l.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>':r.forEach(t=>{const a=document.createElement("li");a.className="score-history-item";const s=document.createElement("div");s.className="item-content";const i=document.createElement("div");i.className="score-info";const c=document.createElement("span");c.className="score-skill-badge",c.textContent=t.skill;const h=document.createElement("span");h.className="score-value",h.textContent=`نمره: ${t.value}`;const y=document.createElement("span");if(y.className="score-date",y.textContent=new Date(t.timestamp).toLocaleDateString("fa-IR"),i.appendChild(c),i.appendChild(h),i.appendChild(y),s.appendChild(i),t.comment){const u=document.createElement("p");u.className="score-comment",u.innerHTML=pi(t.comment),u.addEventListener("click",()=>{we.value=t.comment,we.dispatchEvent(new Event("input",{bubbles:!0})),it(b=>{t.comment=b,ce(),ke(D.info.name,`توضیحات نمره ${t.value} (${t.skill}) برای دانش‌آموز «${o.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:o.identity.studentId}),ze(o),ee("✅ توضیحات نمره با موفقیت ویرایش شد.")}),Ee(()=>{$e("add-note-modal"),we.focus()})}),s.appendChild(u)}const p=document.createElement("button");p.className="btn-icon delete-item-btn",p.innerHTML="🗑️",p.title="حذف این نمره",p.addEventListener("click",()=>{Ee(()=>{Ce(`آیا از انتقال نمره ${t.value} در مهارت «${t.skill}» به سطل زباله مطمئن هستید؟`,()=>{const u={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"score",description:`نمره ${t.value} (${t.skill}) برای «${o.identity.name}»`,restoreData:{scoreId:t.id,skill:t.skill,studentId:o.identity.studentId,classId:D.info.scheduleCode}};ge.unshift(u),ge.length>50&&ge.pop(),t.isDeleted=!0,ce(),ke(D.info.name,`نمره ${t.value} (${t.skill}) دانش‌آموز «${o.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ze(o),ee("✅ نمره به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{ze(o)}})})}),a.appendChild(s),a.appendChild(p),l.appendChild(a)}),n.appendChild(e),n.appendChild(l)}function zi(n){if(!_e)return;const o=document.createElement("h4");o.textContent="تاریخچه یادداشت‌ها:",o.style.marginTop="20px";const e=document.createElement("ul");e.className="list-container",!_e.profile.notes||_e.profile.notes.length===0?e.innerHTML='<div class="no-content-message">هنوز یادداشتی ثبت نشده است.</div>':[..._e.profile.notes].filter(r=>!r.isDeleted).sort((r,t)=>new Date(t.timestamp)-new Date(r.timestamp)).forEach(r=>{const t=document.createElement("li");t.className="note-history-item";const a=document.createElement("div");a.className="item-content";const s=document.createElement("div");s.className="note-info";const i=document.createElement("span");i.className="note-date",i.textContent=new Date(r.timestamp).toLocaleDateString("fa-IR");const c=document.createElement("button");c.className="btn-icon delete-item-btn",c.innerHTML="🗑️",c.title="حذف این یادداشت",c.addEventListener("click",()=>{const y=_e;Ee(()=>{Ce("آیا از انتقال این یادداشت به سطل زباله مطمئن هستید؟",()=>{const p={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"note",description:`یادداشت برای دانش‌آموز «${y.identity.name}»`,restoreData:{noteId:r.id,studentId:y.identity.studentId,classId:D.info.scheduleCode}};ge.unshift(p),ge.length>50&&ge.pop(),r.isDeleted=!0,ke(D.info.name,`یادداشت دانش‌آموز «${y.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),ze(y),ee("✅ یادداشت به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{ze(y)}})})}),s.appendChild(i),s.appendChild(c);const h=document.createElement("p");h.className="note-content",h.innerHTML=pi(r.content),h.addEventListener("click",()=>{const y=_e;we.value=r.content,we.dispatchEvent(new Event("input",{bubbles:!0})),it(p=>{r.content=p,ce(),ke(D.info.name,`یادداشت دانش‌آموز «${y.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:y.identity.studentId}),ze(y),ee("✅یادداشت با موفقیت ویرایش شد.")}),Ee(()=>{$e("add-note-modal"),we.focus()})}),a.appendChild(s),a.appendChild(h),t.appendChild(a),e.appendChild(t)}),n.appendChild(o),n.appendChild(e)}function $i(n){Qn.innerHTML="",n.forEach((o,e)=>{const l=document.createElement("option");l.value=e,l.textContent=o.trim(),Qn.appendChild(l)})}function us(){Xn.innerHTML="",ps.forEach(n=>{const o=document.createElement("li");o.className="preview-item";const e=document.createElement("input");e.type="checkbox",e.checked=!0,e.dataset.name=n;const l=document.createElement("label");l.textContent=n,o.appendChild(e),o.appendChild(l),Xn.appendChild(o)})}function mr(n){const o=document.createElement("div");o.className="list-item-buttons";const e=document.createElement("button");return e.className="btn-icon",e.innerHTML="📝",e.title="ویرایش یادداشت کلاس",n.note||(e.style.display="none"),e.addEventListener("click",l=>{l.stopPropagation(),Pn(n)}),o.appendChild(e),o}function hr(n){const o=document.createElement("div");o.style.flexGrow="1",o.style.display="flex",o.style.flexDirection="column",o.style.alignItems="flex-start";const e=document.createElement("span");e.textContent=n.info.name,e.classList.add("class-name-display"),o.appendChild(e);const l=Se(n.students).length,r=Se(n.sessions).filter(c=>c.isFinished).length,t=_r(n.info.scheduleDays),a=document.createElement("div");a.classList.add("class-stats-row");const s=document.createElement("span");s.textContent=`${l} نفر`,s.classList.add("student-count-badge"),a.appendChild(s);const i=document.createElement("span");if(i.textContent=`${r} جلسه`,i.classList.add("session-count-badge"),a.appendChild(i),t){const c=document.createElement("span");c.textContent=t,c.classList.add("schedule-days-badge"),a.appendChild(c)}return o.appendChild(a),o.addEventListener("click",()=>{Pe(n),Ze(null),tn(D.liveSession),We(),ye("session-page")}),o}function pr(n){const o=document.createElement("li"),e=document.createElement("input");e.type="checkbox",e.className="mass-selection-checkbox",e.checked=rt.includes(n.info.name),e.addEventListener("click",c=>{c.stopPropagation()}),e.addEventListener("change",()=>{const c=n.info.name;if(e.checked)rt.includes(c)||rt.push(c);else{const h=rt.indexOf(c);h>-1&&rt.splice(h,1)}}),o.appendChild(e);const l=hr(n);o.appendChild(l);const r=document.createElement("div");r.style.display="flex",r.style.flexDirection="column",r.style.gap="5px",r.style.alignItems="flex-end",r.style.marginLeft="10px";const t=document.createElement("div");if(t.className="list-item-badges",n.liveSession&&!n.liveSession.isCancelled&&!n.liveSession.isDeleted){const c=document.createElement("span");c.className="warning-badge",c.textContent="جلسه باز",t.appendChild(c),o.classList.add("has-unfinished-session")}const a=document.createElement("span");if(a.className=`type-badge ${n.info.type}`,a.textContent=n.info.type==="online"?"آنلاین":"حضوری",a.title="نوع کلاس",t.appendChild(a),fs(n).type==="incomplete"){const c=document.createElement("span");c.className="type-badge cancelled-badge",c.textContent="زمان‌بندی ناقص",c.style.cursor="pointer",c.title="برای تکمیل زمان‌بندی کلیک کنید",c.addEventListener("click",h=>{h.stopPropagation(),Ce("زمان‌بندی این کلاس کامل نیست. برای نمایش صحیح در لیست، لطفاً روزها و ساعت برگزاری را مشخص کنید.",()=>{Mt(n)},{confirmText:"تنظیمات",confirmClass:"btn-primary"})}),t.appendChild(c)}else{const c=wr(n,re);if(c){const h=document.createElement("span");h.className="type-badge conflict-badge",h.textContent="تداخل زمانی",h.style.cursor="pointer",h.title=`تداخل با کلاس: ${c}`,h.addEventListener("click",y=>{y.stopPropagation(),Ce(`زمان برگزاری این کلاس با کلاس «${c}» تداخل دارد. لطفاً زمان‌بندی را بررسی کنید.`,()=>{Mt(n)},{confirmText:"تنظیمات",confirmClass:"btn-primary"})}),t.appendChild(h)}}r.appendChild(t);const i=mr(n);return r.appendChild(i),o.appendChild(r),o.addEventListener("contextmenu",c=>{const h={label:"پشتیبان‌گیری از این کلاس",icon:"📤",action:()=>{rn([n.info.name])}},y=rt.length;y>1&&rt.includes(n.info.name)&&(h.label=`پشتیبان‌گیری از ${y} کلاس`,h.action=()=>{rn(rt),Kn([]),He()});const p=[{label:At.classList.contains("selection-mode-active")?"لغو انتخاب":"انتخاب چند کلاس",icon:"✔️",action:()=>{const u=At.classList.contains("selection-mode-active");At.classList.toggle("selection-mode-active"),u&&(Kn([]),He())}},h,{label:"یادداشت کلاس",icon:"📝",action:()=>{Pn(n)}},{label:"تنظیمات کلاس",icon:"⚙️",action:()=>{Mt(n)}},{label:"گزارش فعالیت‌ها",icon:"📋",action:()=>{Ni(n.info.name)}},{label:"تغییر نام",icon:"✏️",action:()=>{const u=n.info.name,b=document.getElementById("add-note-modal-title");b.textContent="تغییر نام کلاس",we.value=u,we.rows=1,it(f=>{const v=f.trim();if(v&&v!==u){const g=Xs(u,v);g.success?(aa(u,v),ke(v,`نام کلاس از «${u}» به «${v}» تغییر یافت.`,{type:"VIEW_SESSIONS"}),ce(),He(),ee(`✅نام کلاس به «${v}» تغییر یافت.`)):ee(g.message)}b.textContent="ثبت یادداشت جدید",we.rows=4}),$e("add-note-modal"),we.focus(),we.select()}},{label:"حذف کلاس",icon:"🗑️",className:"danger",action:()=>{Ce(`آیا از انتقال کلاس «${n.info.name}» به سطل زباله مطمئن هستید؟`,()=>{const u={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"classroom",description:`کلاس «${n.info.name}»`,restoreData:{name:n.info.name}};ge.unshift(u),ge.length>50&&ge.pop(),n.isDeleted=!0,ce(),He(),ee(`✅ کلاس «${n.info.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}];cn(c,p)}),o}function Hn(){const n=document.getElementById("class-management-stats");if(!n)return;const o=Object.values(re).filter(t=>!t.isDeleted),e=o.length,l=o.reduce((t,a)=>t+Se(a.students).length,0);let r="";qe.lastBackupTimestamp&&(r=`
            <div class="stats-row backup-stat">
                <span>آخرین پشتیبان: <strong>${new Date(qe.lastBackupTimestamp).toLocaleString("fa-IR",{year:"numeric",month:"numeric",day:"numeric",weekday:"long",hour:"2-digit",minute:"2-digit"})}</strong></span>
            </div>
        `),n.innerHTML=`
        <div class="stats-row main-stats">
            <span>کل کلاس‌ها: <strong>${e}</strong></span>
            <span>|</span>
            <span>کل دانش‌آموزان: <strong>${l}</strong></span>
        </div>
        ${r} 
    `}function He(){Hn(),At.innerHTML="",Object.values(re).sort((o,e)=>{const l=fs(o),r=fs(e);return l.sortIndex!==r.sortIndex?l.sortIndex-r.sortIndex:l.type==="upcoming"?l.nextTimestamp-r.nextTimestamp:new Date(o.info.creationDate)-new Date(e.info.creationDate)}).forEach(o=>{if(o.isDeleted)return;const e=pr(o);At.appendChild(e)})}function lt(){Jn.innerHTML="",D&&Se(D.students).forEach(n=>{const o=document.createElement("li"),e=document.createElement("span");e.textContent=n.identity.name,e.style.flexGrow="1",e.className="student-name-link",e.addEventListener("click",()=>{ze(n)}),o.appendChild(e),o.addEventListener("contextmenu",l=>{cn(l,[{label:"تغییر نام",icon:"✏️",action:()=>{Os(n,D)}},{label:"انتقال دانش‌آموز",icon:"➡️",action:()=>{As(n,D)}},{label:"حذف دانش‌آموز",icon:"🗑️",className:"danger",action:()=>{Ce(`آیا از انتقال دانش‌آموز «${n.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const t={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${n.identity.name}» از کلاس «${D.info.name}»`,restoreData:{studentId:n.identity.studentId,classId:D.info.scheduleCode}};ge.unshift(t),ge.length>50&&ge.pop(),n.isDeleted=!0,ke(D.info.name,`دانش‌آموز «${n.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),lt(),ee(`✅ دانش‌آموز «${n.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}])}),Jn.appendChild(o)})}function Ft(){if(Yn.innerHTML="",!D)return;D.categories.filter(o=>!o.isDeleted).forEach(o=>{const e=document.createElement("li"),l=document.createElement("div");l.className="name-and-badge-container";const r=document.createElement("span");if(r.textContent=o.name,l.appendChild(r),o.isGradedCategory){const a=document.createElement("span");a.className="category-badge",a.textContent="نمره‌دار",l.appendChild(a)}const t=document.createElement("button");t.className="btn-icon",t.innerHTML="🗑️",t.style.color="var(--color-warning)",t.addEventListener("click",()=>{Ce(`آیا از انتقال دسته‌بندی «${o.name}» به سطل زباله مطمئن هستید؟`,()=>{const a={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${o.name}» از کلاس «${D.info.name}»`,restoreData:{categoryId:o.id,classId:D.info.scheduleCode}};ge.unshift(a),ge.length>50&&ge.pop(),o.isDeleted=!0,ke(D.info.name,`دسته‌بندی «${o.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),Ft(),ee(`✅ دسته‌بندی «${o.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}),e.appendChild(l),e.appendChild(t),Yn.appendChild(e)})}function Fi(){if(!D)return;const n=D.info.type||"in-person",o=document.querySelector(`#settings-page input[name="class-type-setting"][value="${n}"]`);o&&(o.checked=!0);const e=D.info.scheduleDays||[];document.querySelectorAll('input[name="schedule-day"]').forEach(l=>{l.checked=e.includes(parseInt(l.value))}),document.getElementById("settings-schedule-start").value=D.info.scheduleStartTime||"",document.getElementById("settings-schedule-end").value=D.info.scheduleEndTime||""}function Qt(n){document.querySelectorAll(".page").forEach(e=>{e.classList.remove("active")});const o=document.getElementById(n);o&&o.classList.add("active"),n==="class-management-page"?(Pe(null),Ze(null),Ke(null),He(),es.style.display="flex"):es.style.display="none",Ai()}function ye(n,o={}){const{tab:e}=o,l={pageId:n,currentClassName:D?D.info.name:null,selectedSessionNumber:K?K.sessionNumber:null,selectedStudentId:_e?_e.identity.studentId:null};let r=`#${n}`;const t=new URLSearchParams(window.location.hash.split("?")[1]||"");D?t.set("class",D.info.name):t.delete("class"),K?t.set("session",K.sessionNumber):t.delete("session"),_e?t.set("student",_e.identity.studentId):t.delete("student"),n==="session-dashboard-page"&&e?t.set("tab",e):n!=="session-dashboard-page"&&t.delete("tab");const a=t.toString();a&&(r+=`?${a}`),window.location.hash!==r&&history.pushState(l,"",r),Qt(n)}function gr(n,o){const e=document.createElement("div");e.className="list-item-buttons",e.style.gap="10px";const l=document.createElement("button");if(l.className="btn-icon",l.innerHTML="📝",l.title="ویرایش یادداشت جلسه",n.note||(l.style.display="none"),l.addEventListener("click",r=>{r.stopPropagation(),zs(n,o)}),!n.isFinished&&!n.isCancelled){const r=document.createElement("button");r.className="btn-success",r.textContent="پایان جلسه",r.style.fontSize="12px",r.style.padding="4px 10px",r.style.whiteSpace="nowrap",r.addEventListener("click",t=>{t.stopPropagation(),Ce(`جلسه شماره ${o} خاتمه پیدا خواهد کرد!`,()=>{D.endSpecificSession(n.sessionNumber),ce(),ke(D.info.name,`جلسه ${o} خاتمه یافت.`,{type:"VIEW_SESSIONS"}),We(),Ce("جلسه با موفقیت خاتمه یافت. آیا مایل به ایجاد فایل پشتیبان هستید؟",()=>{if(ot){ee("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است.");return}rn(),ee("✅فایل پشتیبان با موفقیت ایجاد شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}),e.appendChild(r)}return e.appendChild(l),e}function yr(n,o){const e=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="flex-start",e.style.flexGrow="1";const l=new Date(n.startTime).toLocaleDateString("fa-IR"),r=document.createElement("span");r.className="session-list-title";const t=document.createElement("div");t.style.display="flex",t.style.gap="5px",t.style.marginTop="5px";const a=new Date(n.startTime).toLocaleDateString("fa-IR",{weekday:"long"}),s=document.createElement("span");if(s.className="type-badge day-badge",s.textContent=a,t.appendChild(s),n.isCancelled){r.textContent=`لغو شده - تاریخ: ${l}`,e.style.cursor="default";const i=document.createElement("span");i.className="type-badge cancelled-badge",i.textContent="لغو شده",t.appendChild(i)}else r.textContent=`جلسه ${o} - تاریخ: ${l}`,e.style.cursor="pointer",e.addEventListener("click",()=>{Ze(n),$t()});if(e.appendChild(r),n.isFinished){const i=document.createElement("span");i.className="type-badge finished-badge",i.textContent="خاتمه یافته",t.appendChild(i)}if(n.isMakeup){const i=document.createElement("span");i.className="type-badge makeup-badge",i.textContent="جبرانی",t.appendChild(i)}return e.appendChild(t),e}function vr(n,o){const e=document.createElement("li"),l=o.get(n.sessionNumber),r=yr(n,l);e.appendChild(r);const t=gr(n,l);return e.appendChild(t),e.addEventListener("contextmenu",a=>{const s=[{label:"یادداشت جلسه",icon:"📝",action:()=>{zs(n,l)}},{label:n.isCancelled?"بازگردانی جلسه":"لغو جلسه",icon:"❌",action:()=>{const i=n.isCancelled?"بازگردانی جلسه":"لغو جلسه",c=n.isCancelled?"آیا از بازگردانی این جلسه مطمئن هستید؟":"آیا از لغو این جلسه مطمئن هستید؟ جلسه لغو شده در آمار تاثیری ندارد اما قابل بازگردانی است.";Ce(c,()=>{n.isCancelled=!n.isCancelled;const h=n.isCancelled?`جلسه ${l} لغو شد.`:`جلسه لغو شده (تاریخ: ${new Date(n.startTime).toLocaleDateString("fa-IR")}) بازگردانی شد.`;ke(D.info.name,h,{type:"VIEW_SESSIONS"}),ce(),We(),ee(n.isCancelled?"✅جلسه لغو شد.":"✅جلسه بازگردانی شد.")},{confirmText:i,confirmClass:"btn-warning"})}},{label:"تغییر وضعیت جبرانی",icon:"🔄",action:()=>{D.markAsMakeup(n.sessionNumber),ce();const i=n.isMakeup?`جلسه ${l} به عنوان جبرانی علامت‌گذاری شد.`:`جلسه ${l} از حالت جبرانی خارج شد.`;ke(D.info.name,i,{type:"VIEW_SESSIONS"}),We()}},{label:"حذف جلسه",icon:"🗑️",className:"danger",action:()=>{const i=n.isCancelled?"لغو شده":l;Ce(`آیا از انتقال جلسه ${i} به سطل زباله مطمئن هستید؟`,()=>{const c={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"session",description:`جلسه ${i} از کلاس «${D.info.name}»`,restoreData:{sessionNumber:n.sessionNumber,classId:D.info.scheduleCode}};ge.unshift(c),ge.length>50&&ge.pop(),n.isDeleted=!0,ke(D.info.name,`جلسه ${i} به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),We(),ee(`✅ جلسه ${i} به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}];cn(a,s)}),e}function We(){const n=document.getElementById("session-list");if(!D)return;if(n.innerHTML="",D.sessions.length===0){n.innerHTML="<li>هنوز جلسه‌ای شروع نشده است.</li>";return}const o=Qe(D);[...Se(D.sessions)].reverse().forEach(l=>{const r=vr(l,o);n.appendChild(r)})}function Gt(n){if(mt.innerHTML="",n.length>0)n.forEach(o=>{const e=document.createElement("div");e.textContent=o.identity.name,e.addEventListener("click",()=>{ze(o),mt.style.display="none",ss.value=""}),mt.appendChild(e)}),mt.style.display="block";else if(ss.value.trim()!==""){const o=document.createElement("div");o.className="no-results",o.textContent="پیدا نشد",mt.appendChild(o),mt.style.display="block"}else mt.style.display="none"}function En(n){if(at.innerHTML="",n.length>0)n.forEach(o=>{const e=document.createElement("div");if(e.className="global-search-result",o.type==="student"){const l=document.createElement("span");l.className="student-name",l.textContent=o.student.identity.name;const r=document.createElement("span");r.className="class-name",r.textContent=`کلاس: ${o.classroom.info.name}`,e.addEventListener("click",()=>{Pe(o.classroom),ze(o.student),at.style.display="none",Zt.value=""}),r.addEventListener("click",t=>{t.stopPropagation(),Pe(o.classroom),Ze(null),tn(o.classroom.liveSession),We(),ye("session-page"),at.style.display="none",Zt.value=""}),e.appendChild(l),e.appendChild(r)}else if(o.type==="classroom"){const l=document.createElement("span");l.className="student-name",l.textContent=`[کلاس] ${o.classroom.info.name}`,e.addEventListener("click",()=>{Pe(o.classroom),Ze(null),tn(o.classroom.liveSession),We(),ye("session-page"),at.style.display="none",Zt.value=""}),e.appendChild(l)}at.appendChild(e)}),at.style.display="block";else if(Zt.value.trim()!==""){const o=document.createElement("div");o.className="no-results",o.textContent="پیدا نشد",at.appendChild(o),at.style.display="block"}else at.style.display="none"}function on(){const n=document.getElementById("trashed-items-list");if(n.innerHTML="",ge.length===0){n.innerHTML='<li style="text-align: center; padding: 20px;">سطل زباله خالی است.</li>';return}ge.forEach((o,e)=>{const l=document.createElement("li"),r=document.createElement("span");r.textContent=o.description,r.style.flexGrow="1";const t=document.createElement("div");t.className="list-item-buttons";const a=document.createElement("button");a.className="btn-icon",a.innerHTML="🔄",a.title="بازیابی",a.addEventListener("click",()=>{var y;let i=!1,c=null;const h=o.restoreData;switch(o.type){case"classroom":{const p=re[h.name];p&&!p.isDeleted?c=`کلاسی با نام «${h.name}» از قبل فعال است.`:p&&p.isDeleted&&(p.isDeleted=!1,i=!0);break}case"student":{const p=Object.values(re).find(b=>b.info.scheduleCode===h.classId),u=p==null?void 0:p.students.find(b=>b.identity.studentId===h.studentId);u&&(u.isDeleted=!1,i=!0);break}case"session":{const p=Object.values(re).find(b=>b.info.scheduleCode===h.classId),u=p==null?void 0:p.sessions.find(b=>b.sessionNumber===h.sessionNumber);u&&(u.isDeleted=!1,i=!0);break}case"category":{const p=Object.values(re).find(b=>b.info.scheduleCode===h.classId),u=p==null?void 0:p.categories.find(b=>b.id===h.categoryId);u&&(u.isDeleted=!1,i=!0);break}case"score":{const p=Object.values(re).find(f=>f.info.scheduleCode===h.classId),u=p==null?void 0:p.students.find(f=>f.identity.studentId===h.studentId),b=(y=u==null?void 0:u.logs.scores[h.skill.toLowerCase()])==null?void 0:y.find(f=>f.id===h.scoreId);b&&(b.isDeleted=!1,i=!0);break}case"note":{const p=Object.values(re).find(f=>f.info.scheduleCode===h.classId),u=p==null?void 0:p.students.find(f=>f.identity.studentId===h.studentId),b=u==null?void 0:u.profile.notes.find(f=>f.id===h.noteId);b&&(b.isDeleted=!1,i=!0);break}}i?(ge.splice(e,1),ce(),on(),o.type==="classroom"&&He(),ee("✅ آیتم با موفقیت بازیابی شد.")):ee(c?`⚠️ ${c}`:"⚠️ آیتم اصلی برای بازیابی یافت نشد.")});const s=document.createElement("button");s.className="btn-icon",s.innerHTML="🔥",s.title="حذف دائمی",s.addEventListener("click",()=>{Ce("آیا از حذف دائمی این آیتم مطمئن هستید؟ این عمل غیرقابل بازgشت است.",()=>{const i=o.restoreData,c=y=>Object.values(re).find(p=>p.info.scheduleCode===y);let h;switch(o.type){case"classroom":delete re[i.name];break;case"student":h=c(i.classId),Nn({identity:{studentId:i.studentId}},h);break;case"session":h=c(i.classId),h&&ni(h.info.name,i.sessionNumber);break;case"category":h=c(i.classId),h&&si(h.info.name,i.categoryId);break;case"score":h=c(i.classId),h&&ii(h.info.name,i.studentId,i.skill,i.scoreId);break;case"note":h=c(i.classId),h&&ai(h.info.name,i.studentId,i.noteId);break}ge.splice(e,1),ce(),on(),ee("✅ آیتم برای همیشه حذف شد.")},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),t.appendChild(a),t.appendChild(s),l.appendChild(r),l.appendChild(t),n.appendChild(l)})}function br(){const n=document.getElementById("absentees-summary-container");n&&(n.innerHTML=`
        <div id="absentees-summary-box" class="absentees-summary">
            <div class="absentees-summary-header">
                <h4>لیست غایبین جلسه شماره <span id="absentee-summary-session-number"></span></h4>
                <button id="copy-absentees-btn" class="btn-icon" title="کپی لیست غایبین">📋</button>
            </div>
            <div id="absentees-summary-list" class="summary-list"></div>
        </div>
    `)}function Pi(){const n=document.getElementById("absentees-summary-box"),o=document.getElementById("absentees-summary-list"),e=document.getElementById("absentee-summary-session-number");if(!n||!o||!e){console.error("Could not find all absentee summary elements.");return}if(!D||!K){n.classList.remove("visible");return}const l=Se(D.students).filter(t=>{const a=K.studentRecords[t.identity.studentId];return a&&a.attendance==="absent"}),r=Qe(D);e.textContent=r.get(K.sessionNumber),l.length>0?n.classList.add("visible"):n.classList.remove("visible"),o.innerHTML="",l.forEach(t=>{const s=(c=>D.sessions.reduce((h,y)=>{if(y.isDeleted||y.isCancelled)return h;const p=y.studentRecords[c.identity.studentId];return h+(p&&p.attendance==="absent"?1:0)},0))(t),i=document.createElement("span");i.className="summary-name",i.textContent=`${t.identity.name} (غیبت: ${s})`,i.addEventListener("click",()=>{i.classList.add("fading-out"),setTimeout(()=>{K.setAttendance(t.identity.studentId,"present"),ce(),st()},200)}),o.appendChild(i)})}function Cr(){const n=document.getElementById("copy-absentees-btn");if(!n){console.error("Could not find the copy absentees button to attach listener.");return}n.addEventListener("click",()=>{if(!D||!K)return;const o=Se(D.students).filter(r=>{const t=K.studentRecords[r.identity.studentId];return t&&t.attendance==="absent"});if(o.length===0){ee("⚠️لیست غایبین خالی است.");return}const e=r=>D.sessions.reduce((t,a)=>{if(a.isDeleted||a.isCancelled)return t;const s=a.studentRecords[r.identity.studentId];return t+(s&&s.attendance==="absent"?1:0)},0);let l=`لیست غایبین جلسه شماره ${cr()}:

`;o.forEach(r=>{const t=e(r);l+=`- ${r.identity.name} (تعداد غیبت‌ها: ${t})
`}),navigator.clipboard.writeText(l).then(()=>{ee("✅لیست غایبین با موفقیت کپی شد.")}).catch(r=>{console.error("Failed to copy text: ",r),ee("❌خطا در کپی کردن لیست.")})})}function kn(){const n=document.getElementById("demo-mode-banner");n&&(ot?(n.classList.add("visible"),document.body.classList.add("demo-mode-active")):(n.classList.remove("visible"),document.body.classList.remove("demo-mode-active")))}function fs(n){const{scheduleDays:o,scheduleStartTime:e,scheduleEndTime:l}=n.info,r=o&&o.length>0,t=e&&l;if(!r&&!t)return{type:"unscheduled",sortIndex:3};if(!r||!t)return{type:"incomplete",sortIndex:2};const a=new Date,s=a.getDay(),i=a.getHours()*60+a.getMinutes(),[c,h]=e.split(":").map(Number),[y,p]=l.split(":").map(Number),u=c*60+h,b=y*60+p;if(o.includes(s)&&i>=u&&i<b)return{type:"active",sortIndex:0};for(let f=0;f<=7;f++){const v=(s+f)%7;if(o.includes(v)){if(f===0&&i>=u)continue;const g=new Date(a);return g.setDate(a.getDate()+f),g.setHours(c,h,0,0),{type:"upcoming",sortIndex:1,nextTimestamp:g.getTime()}}}return{type:"upcoming",sortIndex:1,nextTimestamp:9999999999999}}function wr(n,o){const{scheduleDays:e,scheduleStartTime:l,scheduleEndTime:r}=n.info;if(!e||!e.length||!l||!r)return null;const[t,a]=l.split(":").map(Number),[s,i]=r.split(":").map(Number),c=t*60+a,h=s*60+i;for(const y of Object.values(o)){if(y===n||y.isDeleted||y.info.name===n.info.name)continue;const p=y.info;if(!p.scheduleDays||!p.scheduleDays.length||!p.scheduleStartTime||!p.scheduleEndTime||!e.some(S=>p.scheduleDays.includes(S)))continue;const[b,f]=p.scheduleStartTime.split(":").map(Number),[v,g]=p.scheduleEndTime.split(":").map(Number),C=b*60+f,E=v*60+g;if(c<E&&h>C)return y.info.name}return null}function _r(n){if(!n||n.length===0)return"";const o={6:"شنبه",0:"۱شنبه",1:"۲شنبه",2:"۳شنبه",3:"۴شنبه",4:"۵شنبه",5:"جمعه"};return[...n].sort((l,r)=>{const t={6:0,0:1,1:2,2:3,3:4,4:5,5:6};return t[l]-t[r]}).map(l=>o[l]).join("، ")}async function Hi(){const n=document.getElementById("restore-points-list");n.innerHTML='<li style="text-align:center; padding:20px;">در حال بارگذاری...</li>';try{const o=await na();if(o.length===0){n.innerHTML='<li style="text-align:center; padding:20px;">هیچ فایل پشتیبانی یافت نشد.</li>';return}n.innerHTML="",o.forEach(e=>{const l=document.createElement("li");l.className="restore-point-card";const r=new Date(e.timestamp).toLocaleString("fa-IR"),t=(e.file.size/1024).toFixed(1)+" KB";l.innerHTML=`
                <div class="restore-card-header">
                    <span class="restore-date">${r}</span>
                    <span class="restore-size">${t}</span>
                </div>
                <div class="restore-desc">${e.metadata.description||"بدون توضیحات"}</div>
                <div class="restore-actions">
                    <button class="btn-restore-action">بازگردانی</button>
                </div>
            `,l.querySelector(".btn-restore-action").addEventListener("click",async()=>{try{const s=await e.file.text(),h=(await new ms().loadAsync(s,{base64:!0})).file("backup.json");if(!h)throw new Error("فایل backup.json یافت نشد.");const y=await h.async("string"),p=JSON.parse(y);zn(p)}catch(s){console.error("Restore failed:",s),ee("❌ فایل پشتیبان معتبر نیست.")}}),n.appendChild(l)})}catch(o){console.error("Failed to load snapshots:",o),n.innerHTML='<li style="text-align:center; color:red;">خطا در بارگذاری اطلاعات.</li>'}}const Er=Object.freeze(Object.defineProperty({__proto__:null,_internalShowPage:Qt,addCategoryBtn:Ea,addClassBtn:oa,addNoteModal:Ra,addScoreBtn:Wa,addStudentBtn:fa,appHeader:es,attendanceListUl:Kt,attendanceMassActionsContainer:Cn,attendancePage:ka,attendancePane:zt,attendanceSearchInput:bt,backToSessionsBtn:da,backToStudentPageBtn:Fa,backupDataBtn:Da,breadcrumbContainer:Dt,cancelImportBtn:wa,cancelNoteBtn:$a,categoryListUl:Yn,categoryModal:Xa,categoryModalCancelBtn:Qa,categoryModalSaveBtn:xi,categoryModalTitle:Ii,classListHeader:Ia,classListUl:At,classManagementPage:vi,classSaveNoteBtn:za,closeActiveModal:Ee,closeContextMenu:Ct,closeNavBtn:Ta,columnMappingPage:ba,columnSelectDropdown:Qn,confirmColumnBtn:Ca,confirmModalCancelBtn:ns,confirmModalConfirmBtn:jt,confirmModalMessage:_i,contextMenu:_t,csvCancelBtn:ga,csvConfirmBtn:pa,csvFileInput:va,csvPreviewList:Xn,csvPreviewPage:ha,customConfirmModal:Aa,displayWinner:Me,finishAttendanceBtn:Sa,globalStudentSearchInput:Zt,globalStudentSearchResultsDiv:at,gradedCategoryPillsContainer:Pa,hamburgerMenuBtn:xa,handleUndo:Bi,importCsvBtn:ya,initiateBackupProcess:rn,isGradedCheckbox:Za,massCommentAppendCheckbox:Ns,massCommentBtn:as,massCommentCancelBtn:nr,massCommentContent:Xt,massCommentModal:er,massCommentModalTitle:tr,massCommentSaveBtn:sr,massCommentStudentCountMessage:Li,newCategoryModalIsGradedCheckbox:Ds,newCategoryModalNameInput:Yt,newCategoryNameInput:_a,newClassNameInput:ra,newNoteContent:we,newScoreCommentTextarea:Si,newScoreValueInput:Ha,newStudentNameInput:ua,openContextMenu:cn,openModal:$e,overlay:Ba,pasteArea:Ci,processMassHomeworkComment:os,processPasteBtn:ma,profileScoresListUl:ja,profileStatsSummaryDiv:Ua,quickGradeFormWrapper:Nt,quickGradeSubmitBtn:wt,quickNoteTextarea:tt,quickScoreInput:ct,renderAttendancePage:st,renderBreadcrumbs:Ai,renderClassList:He,renderClassManagementStats:Hn,renderColumnSelector:$i,renderGlobalSearchResults:En,renderImportPreview:us,renderLogModal:Ni,renderMassCommentControls:Ms,renderRestorePointsPage:Hi,renderScoresHistory:Ri,renderSearchResults:Gt,renderSessionDashboard:$t,renderSessions:We,renderSettingsCategories:Ft,renderSettingsOther:Fi,renderSettingsStudentList:lt,renderStudentNotes:zi,renderStudentStatsList:Re,renderTrashPage:on,restoreDataBtn:Na,restoreFileInput:wi,secureConfirmCancelBtn:Ma,secureConfirmCode:ki,secureConfirmConfirmBtn:bn,secureConfirmInput:Bt,secureConfirmMessage:Ei,secureConfirmModal:Oa,selectStudentBtn:nt,selectStudentBtnWrapper:Rt,sessionDashboardPage:ir,setAutoDirectionOnInput:Oi,settingsClassNameHeader:Bs,settingsPage:la,settingsStudentListUl:Jn,setupDashboardTabs:Ti,setupLongPress:qt,showCategoryModal:rs,showClassNoteModal:Pn,showCustomConfirm:Ce,showMassCommentModal:Rs,showMoveStudentModal:As,showNotification:ee,showPage:ye,showRenameStudentModal:Os,showRestoreConfirmModal:zn,showSecureConfirm:Di,showSessionNoteModal:zs,showSettingsPage:Mt,showStudentProfile:ze,showUndoToast:ar,sideNavMenu:La,studentSearchInput:ss,studentSearchResultsDiv:mt,studentStatsHeader:ts,switchDashboardTab:an,trashedCategoriesList:Ka,trashedClassesList:qa,trashedNotesList:Ja,trashedScoresList:Ya,trashedSessionsList:Va,trashedStudentsList:Ga,triggerFileDownload:cs,undoBtn:ca,undoMessage:bi,undoToast:Rn,updateDemoModeBanner:kn},Symbol.toStringTag,{value:"Module"}));function kr(){const n=window.location.hash;if(!n||n==="#")return!1;const[o,e]=n.split("?"),l=o.substring(1),r=new URLSearchParams(e),t=r.get("class"),a=parseInt(r.get("session"),10),s=r.get("student"),i=r.get("tab")||"selector";if(t&&re[t])Pe(re[t]),a&&D.getSession(a)&&Ze(D.getSession(a)),s&&D.students.find(c=>c.identity.studentId===s)&&Ke(D.students.find(c=>c.identity.studentId===s));else return!1;switch(l){case"session-page":We(),ye("session-page");break;case"session-dashboard-page":$t(l==="attendance-page"?"attendance":i);break;case"settings-page":Bs.textContent=`تنظیمات کلاس: ${D.info.name}`,lt(),Ft(),ye("settings-page");break;case"student-profile-page":$t(i),ze(_e);break;default:return!1}return!0}document.addEventListener("DOMContentLoaded",()=>{const{globalStudentSearchInput:n,newClassNameInput:o,addClassBtn:e,undoBtn:l,newStudentNameInput:r,addStudentBtn:t,pasteArea:a,processPasteBtn:s,csvPreviewList:i,csvConfirmBtn:c,csvCancelBtn:h,importCsvBtn:y,csvFileInput:p,columnSelectDropdown:u,confirmColumnBtn:b,cancelImportBtn:f,newCategoryNameInput:v,addCategoryBtn:g,selectStudentBtn:C,attendancePage:E,finishAttendanceBtn:S,classListHeader:I,studentStatsHeader:x,hamburgerMenuBtn:L,sideNavMenu:N,closeNavBtn:R,overlay:P,backupDataBtn:Q,restoreDataBtn:k,restoreFileInput:z,confirmModalCancelBtn:m,confirmModalConfirmBtn:H,secureConfirmCancelBtn:ue,secureConfirmConfirmBtn:Z,newNoteContent:fe,classSaveNoteBtn:F,cancelNoteBtn:ne,studentSearchInput:A,studentSearchResultsDiv:M,isGradedCheckbox:oe,categoryModalSaveBtn:te,categoryModalCancelBtn:Y,massCommentBtn:Be,massCommentCancelBtn:Ne,massCommentSaveBtn:pe,massCommentContent:ve,massCommentAppendCheckbox:Le,attendanceSearchInput:De}=Er,Je=document.getElementById("trash-nav-btn");document.querySelector(".global-search-container .search-icon"),Dn(),kn(),kr()||(He(),ye("class-management-page"));function d(B,G){const U=document.querySelector(B);if(!U)return;const X=U.querySelector(".search-icon"),ae=U.querySelector(".animated-search-input");!X||!ae||(X.addEventListener("mousedown",de=>{de.preventDefault()}),X.addEventListener("click",()=>{U.classList.contains("search-active")||(U.classList.add("search-active"),ae.focus())}),ae.addEventListener("blur",()=>{setTimeout(()=>{U.classList.remove("search-active"),ae.value="",G&&G([])},150)}))}De.addEventListener("input",()=>{const B=De.value.toLowerCase().trim(),G=qn(B);Kt.querySelectorAll(".attendance-list-item").forEach(X=>{const ae=X.querySelector(".student-name");if(ae){const de=ae.textContent,ie=Xe(de.toLowerCase()),he=ie.includes(Xe(B)),be=ie.includes(Xe(G));he||be?X.style.display="flex":X.style.display="none"}})}),Y.addEventListener("click",()=>{Ee(),Fn(null)}),te.addEventListener("click",()=>{const B=Yt.value.trim(),G=Ds.checked;typeof Tn=="function"&&Tn(B,G)}),window.addEventListener("scroll",Ct),document.addEventListener("click",B=>{_t.classList.contains("visible")&&!_t.contains(B.target)&&Ct(),A.contains(B.target)||(M.style.display="none");const G=B.target.closest(".log-action-link");if(G&&G.dataset.action)try{const U=JSON.parse(G.dataset.action);Wn(U)}catch(U){console.error("Could not parse log action:",U)}}),Rt.addEventListener("click",()=>{(Rt.classList.contains("disabled-wrapper")||nt.disabled)&&(nt.classList.add("shake-animation"),setTimeout(()=>{nt.classList.remove("shake-animation")},200))}),x.addEventListener("click",()=>{const B=new Date().getTime();B-vs>500?vn(1):vn(xn+1),ui(B),xn===5&&(vn(0),Ce("آیا از صفر کردن تمام شمارنده‌های دانش‌آموزان مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{ti(),Re(),ee("تمام آمارها صفر شدند ✅.")},{confirmText:"بله",confirmClass:"btn-warning"}))}),I.addEventListener("click",()=>{const B=new Date().getTime();B-ys>500?yn(1):yn(In+1),di(B),In===5&&(yn(0),Ce("آیا از ساخت یک کلاس تستی تصادفی مطمئن هستید؟",()=>{function G(){const U=`کلاس تستی ${Object.keys(re).length+1}`,X=new Vn({name:U,type:"online"});["علی رضایی","مریم حسینی","زهرا احمدی","رضا محمدی","فاطمه کریمی"].forEach(de=>X.addStudent(new pn({name:de}))),re[U]=X,ce(),He()}G(),ee("کلاس تستی با موفقیت ساخته شد ✅!")},{confirmText:"بساز",confirmClass:"btn-success"}))}),ue.addEventListener("click",()=>{Ee(),nn(null)}),Z.addEventListener("click",()=>{typeof Ln=="function"&&Ln(),Ee(),nn(null)}),m.addEventListener("click",()=>{Ee(Cs)}),H.addEventListener("click",()=>{Ee(bs)}),C.addEventListener("click",()=>{if(ct.value.trim()!==""||tt.value.trim()!==""){ee("⚠️لطفاً ابتدا با دکمه «ثبت»، تغییرات را ذخیره کنید و یا نمره و یادداشت را پاک کنید.");return}if(!D||!K||!Ve)return;const B=D.selectNextWinner(Ve.name,K);if(B){const G=K.studentRecords[B.identity.studentId];if(G&&G.attendance==="absent"&&B.statusCounters.missedChances++,G&&G.hadIssue){B.statusCounters.missedChances++;const X=Ve.name;B.categoryIssues[X]=(B.categoryIssues[X]||0)+1}G&&G.wasOutOfClass&&(B.statusCounters.outOfClassCount=(B.statusCounters.outOfClassCount||0)+1,B.statusCounters.missedChances++);const U={winner:B,categoryName:Ve.name};K.winnerHistory.push(U),K.winnerHistory.length>10&&K.winnerHistory.shift(),gt(K.winnerHistory.length-1),K.lastUsedCategoryId=Ve.id,K.lastSelectedWinnerId=B.identity.studentId,Re(),setTimeout(()=>Me(),0),ce()}else ee("❌دانش‌آموز واجد شرایطی برای انتخاب یافت نشد.")}),g.addEventListener("click",()=>{if(!D)return;const B=v.value.trim(),G=oe.checked;if(!B){alert("⚠️لطفاً نام دسته‌بندی را وارد کنید.");return}const U=D.categories.find(ae=>ae.name.toLowerCase()===B.toLowerCase());if(U)if(U.isDeleted){const ae=D.categories.findIndex(de=>de===U);ae>-1&&D.categories.splice(ae,1)}else{alert("⚠️این دسته‌بندی از قبل وجود دارد.");return}const X=new ut(B,"",G);D.categories.push(X),ce(),ke(D.info.name,`دسته‌بندی جدید «${B}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),Ft(),v.value="",oe.checked=!1}),document.querySelectorAll('#settings-page input[name="class-type-setting"]').forEach(B=>{B.addEventListener("change",()=>{if(!D)return;const G=B.value,U=D.info.type||"in-person";if(G===U)return;const X=ie=>ie==="online"?"آنلاین":"حضوری",ae=X(U),de=X(G);Ce(`آیا از تغییر نوع کلاس از «${ae}» به «${de}» مطمئن هستید؟`,()=>{D.info.type=G,ce(),ke(D.info.name,`نوع کلاس به «${de}» تغییر یافت.`,{type:"VIEW_CLASS_SETTINGS"}),He(),ee(`✅ نوع کلاس به «${de}» تغییر یافت.`)},{confirmText:"بله",confirmClass:"btn-warning",onCancel:()=>{const ie=document.querySelector(`#settings-page input[name="class-type-setting"][value="${U}"]`);ie&&(ie.checked=!0)}})})});const $=document.querySelectorAll('input[name="schedule-day"]'),_=document.getElementById("settings-schedule-start"),w=document.getElementById("settings-schedule-end");$.forEach(B=>{B.addEventListener("change",()=>{if(!D)return;const G=Array.from($).filter(U=>U.checked).map(U=>parseInt(U.value));D.info.scheduleDays=G,ce()})});const T=()=>{D&&(D.info.scheduleStartTime=_.value,D.info.scheduleEndTime=w.value,ce())};_.addEventListener("change",T),w.addEventListener("change",T),v.addEventListener("keyup",B=>{B.key==="Enter"&&g.click()}),b.addEventListener("click",()=>{if(!Sn){alert("❌خطایی رخ داده است. لطفاً فایل را دوباره انتخاب کنید."),ye("settings-page");return}const B=parseInt(u.value,10),X=Sn.split(`
`).slice(1).map(ae=>{var ie;return(ie=ae.split(",")[B])==null?void 0:ie.trim()}).filter(ae=>ae&&ae.length>0);X.length>0?(Ut(X),us(),ye("csv-preview-page")):alert("هیچ نامی در ستون انتخاب شده پیدا نشد. لطفاً ستون دیگری را امتحان کنید یا فایل خود را بررسی کنید."),gn(null)}),y.addEventListener("click",()=>{p.click()}),p.addEventListener("change",B=>{const G=B.target.files[0];if(!G)return;const U=new FileReader;U.onload=X=>{const ae=X.target.result;gn(ae);const ie=ae.split(`
`)[0].split(",");$i(ie),ye("column-mapping-page")},U.readAsText(G),B.target.value=null}),f.addEventListener("click",()=>{gn(null),ye("settings-page")}),c.addEventListener("click",()=>{const B=i.querySelectorAll('input[type="checkbox"]:checked');let G=!1;B.forEach(U=>{const X=U.dataset.name,ae=D.students.find(ie=>ie.identity.name.toLowerCase()===X.toLowerCase());if(ae)if(ae.isDeleted)Nn(ae,D);else{console.log(`دانش‌آموز «${X}» به دلیل تکراری بودن اضافه نشد.`);return}const de=new pn({name:X});D.addStudent(de),D.sessions.length>0&&(Se(D.sessions).filter(ie=>ie.isFinished&&!ie.isCancelled).forEach(ie=>{ie.setAttendance(de.identity.studentId,"absent")}),Ge(de,D),G=!0)}),ce(),ke(D.info.name,`${B.length} دانش‌آموز جدید از لیست ورودی به کلاس اضافه شدند.`,{type:"VIEW_SESSIONS"}),lt(),G&&ft(B.length),ye("settings-page"),a.value="",Ut([])}),h.addEventListener("click",()=>{Ut([]),ye("settings-page")}),s.addEventListener("click",()=>{const B=a.value.trim();if(!B){alert("کادر متنی خالی است. لطفاً اسامی را وارد کنید.");return}const G=B.split(`
`).map(U=>U.trim()).filter(U=>U.length>0);G.length>0?(Ut(G),us(),ye("csv-preview-page")):alert("هیچ نام معتبری برای ورود پیدا نشد.")}),r.addEventListener("keyup",B=>{B.key==="Enter"&&t.click()}),t.addEventListener("click",()=>{if(!D)return;const B=r.value.trim();if(!B){alert("لطفاً نام دانش‌آموز را وارد کنید.");return}const G=D.students.find(X=>X.identity.name.toLowerCase()===B.toLowerCase());if(G)if(G.isDeleted)Nn(G,D);else{alert("❌دانش‌آموزی با این نام از قبل در این کلاس وجود دارد.");return}const U=new pn({name:B});D.addStudent(U),D.sessions.length>0&&(Se(D.sessions).filter(X=>X.isFinished&&!X.isCancelled).forEach(X=>{X.setAttendance(U.identity.studentId,"absent")}),Ge(U,D),ft(1)),ce(),ke(D.info.name,`دانش‌آموز «${B}» به کلاس اضافه شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:U.identity.studentId}),lt(),Re(),r.value="",r.focus()}),document.getElementById("new-session-btn").addEventListener("click",()=>{if(D){const B=D.sessions.find(U=>!U.isFinished&&!U.isCancelled&&!U.isDeleted);if(B){ee(`⚠️ جلسه ${B.sessionNumber} هنوز تمام نشده است. لطفاً ابتدا با دکمه ✅ آن را خاتمه دهید.`);return}const G=()=>{const U=X=>{const ae=D.startNewSession();tn(ae),Ze(ae),D.students.forEach(he=>{hs.setAttendance(he.identity.studentId,"present")}),ce();const ie=Qe(D).get(ae.sessionNumber);ke(D.info.name,`جلسه ${ie} شروع شد.`,{type:"VIEW_SESSIONS"}),$t(X?"attendance":"selector")};Ce("آیا تمایل به انجام فرآیند حضور و غیاب دارید؟",()=>U(!0),{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success",onCancel:()=>U(!1)})};D.hasSessionToday()?Ce("شما امروز یک جلسه برای این کلاس ثبت کرده‌اید. آیا از شروع یک جلسه جدید دیگر مطمئن هستید؟",G,{confirmText:"بله",confirmClass:"btn-warning"}):G()}}),e.addEventListener("click",()=>{const B=o.value.trim(),G=document.querySelector('input[name="class-type"]:checked');if(!B&&!G){ee("⚠️لطفاً نام و نوع کلاس را مشخص کنید.");return}if(!B){ee("⚠️لطفاً نام کلاس را وارد کنید.");return}if(!G){ee("⚠️لطفاً نوع کلاس را انتخاب کنید.");return}if(re[B]){re[B].isDeleted?ee("⚠️ کلاسی با این نام در سطل زباله است. ابتدا آن را بازیابی کنید و یا آن را پاک کنید."):ee("⚠️کلاسی با این نام از قبل وجود دارد.");return}const U=G.value,X=new Vn({name:B,type:U});re[B]=X,ce(),ke(B,`کلاس «${B}» ایجاد شد.`,{type:"VIEW_SESSIONS"}),He(),ee(`✅ کلاس «${B}» با موفقیت ایجاد شد.`),o.value="",G.checked=!1}),n.addEventListener("input",B=>{const G=B.target.value;if(G.length<2){En([]);return}const U=G.toLowerCase(),X=qn(U),ae=[];for(const de in re){const ie=re[de];if(ie.isDeleted)continue;const he=Xe(de.toLowerCase()),be=he.includes(Xe(U)),xe=he.includes(Xe(X));(be||xe)&&ae.push({type:"classroom",classroom:ie})}for(const de in re){const ie=re[de];if(ie.isDeleted)continue;Se(ie.students).filter(be=>{const xe=Xe(be.identity.name.toLowerCase()),Oe=xe.includes(Xe(U)),Ht=xe.includes(Xe(X));return Oe||Ht}).forEach(be=>{ae.push({type:"student",student:be,classroom:ie})})}En(ae)}),o.addEventListener("keyup",B=>{B.key==="Enter"&&e.click()}),l.addEventListener("click",Bi),S.addEventListener("click",()=>{an("selector")}),A.addEventListener("input",B=>{const G=B.target.value;if(!G){Gt([]);return}const U=G.toLowerCase(),X=qn(U),de=Se(D.students).filter(ie=>{const he=Xe(ie.identity.name.toLowerCase()),be=he.includes(Xe(U)),xe=he.includes(Xe(X));return be||xe});Gt(de)}),A.addEventListener("focus",()=>{A.value&&Gt(A.value)}),wt.addEventListener("click",()=>{const B=ct.value,G=tt.value.trim();let U;if(Bn)U=Bn.student;else{const ae=K==null?void 0:K.winnerHistory[je];U=ae==null?void 0:ae.winner}if(!U){ee("❌خطا: دانش‌آموز معتبری برای ثبت نمره یافت نشد.");return}const X=Ve;if(!U||!X){ee("⚠️لطفاً ابتدا یک دانش‌آموز و یک دسته‌بندی را انتخاب کنید.");return}if(!B){ee("⚠️لطفاً مقدار نمره را وارد کنید.");return}if(B>100||B<0){ee("❌نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}U&&(U.addScore(X.name,parseFloat(B),G),ke(D.info.name,`نمره ${B} در ${X.name} برای «${U.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:U.identity.studentId}),ce(),Re(),ee(`✅نمره برای ${U.identity.name} در مهارت ${X.name} ثبت شد.`),ct.value="",tt.value="",Me())});const j=B=>{B.key==="Enter"&&B.ctrlKey&&(B.preventDefault(),wt.click())};ct.addEventListener("keydown",j),tt.addEventListener("keydown",j),ne.addEventListener("click",()=>{Ee()}),F.addEventListener("click",()=>{const B=fe.value.trim(),G=ws;Ee(()=>{typeof G=="function"&&G(B)})});const q=document.getElementById("move-student-confirm-btn"),O=document.getElementById("move-student-cancel-btn"),V=document.getElementById("move-student-class-select");O.addEventListener("click",()=>{Ee()}),q.addEventListener("click",()=>{const B=V.value,G=re[B],{studentToMove:U,sourceClassForMove:X}=Xi;if(!U||!X||!G){ee("خطایی رخ داد. لطفاً دوباره امتحان کنید⚠️.","error"),Ee();return}const ae=ei(U,X,G);ae.success?(ke(X.info.name,`دانش‌آموز «${U.identity.name}» به کلاس «${B}» منتقل شد.`,{type:"VIEW_SESSIONS"}),ke(B,`دانش‌آموز «${U.identity.name}» از کلاس «${X.info.name}» به این کلاس منتقل شد.`,{type:"VIEW_SESSIONS"}),ce(),lt(),Re(),st(),ee(`دانش‌آموز «${U.identity.name}» با موفقیت به کلاس «${B}» منتقل شد✅.`)):ee(ae.message,"error"),Ee()}),L.addEventListener("click",()=>{N.style.width="300px",P.classList.add("modal-visible")}),L.addEventListener("click",()=>{N.style.width="300px",P.classList.add("modal-visible")});const se=document.getElementById("header-settings-btn");se&&se.addEventListener("click",()=>{D&&Mt(D)}),R.addEventListener("click",me),R.addEventListener("click",me),P.addEventListener("click",me),Je.addEventListener("click",()=>{on(),ye("trash-page"),me()});const J=document.getElementById("restore-points-nav-btn");J&&J.addEventListener("click",()=>{Hi(),ye("restore-points-page"),me()}),document.getElementById("demo-mode-btn").addEventListener("click",()=>{ot?Ue():(me(),Ce("شما در حال ورود به حالت نمایش (Demo) هستید. در این حالت، هیچ‌کدام از تغییرات شما ذخیره نخواهد شد. آیا ادامه می‌دهید؟",()=>{ri(),kn(),me()},{confirmText:"تایید",confirmClass:"btn-warning",onCancel:me}))});const Ie=document.getElementById("exit-demo-btn");Ie&&Ie.addEventListener("click",()=>{ot&&Ue()}),Q.addEventListener("click",()=>{if(ot){ee("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است."),me();return}me(),rn()}),k.addEventListener("click",()=>{if(ot){ee("⚠️ بازیابی اطلاعات در حالت نمایش (Demo) غیرفعال است."),me();return}z.click(),me()}),z.addEventListener("change",B=>{const G=B.target.files[0];if(!G)return;const U=new FileReader;U.onload=async X=>{const ae=X.target.result;try{const de=JSON.parse(ae);if(de.metadata&&de.data)zn(de);else{const ie=de.classrooms||de,he=de.trashBin||[];Ce("آیا از بازیابی اطلاعات مطمئن هستید؟ تمام داده‌های فعلی شما بازنویسی خواهد شد.",()=>{kt(ie),Is(he),Vt({lastRestoreTimestamp:new Date().toISOString()}),ce(),He(),ye("class-management-page"),ee("✅اطلاعات با موفقیت بازیابی شد.")},{confirmText:"بازیابی کن",confirmClass:"btn-warning"})}}catch{try{const be=(await new ms().loadAsync(ae,{base64:!0})).file("backup.json");if(!be)throw new Error("فایل backup.json در فایل پشتیبان یافت نشد.");const xe=await be.async("string"),Oe=JSON.parse(xe);if(Oe.metadata&&Oe.metadata.version==="2.0-b64")zn(Oe);else throw new Error("فایل پشتیبان معتبر نیست (نسخه نامشخص).")}catch(ie){ee("❌خطا در خواندن فایل. لطفاً فایل پشتیبان معتبر انتخاب کنید."),console.error("Restore error (zip/base64):",ie)}}},U.readAsText(G),B.target.value=null}),window.addEventListener("popstate",B=>{if(pt){Ee(null,!0);return}if(Ct(),B.state){const{pageId:G,currentClassName:U,selectedSessionNumber:X,selectedStudentId:ae}=B.state;U&&(Pe(re[U]),X&&Ze(D.getSession(X)),ae&&Ke(D.students.find(de=>de.identity.studentId===ae))),G==="session-page"?(We(),Qt(G)):G==="student-profile-page"?(We(),ye("session-page"),ze(_e)):Qt(G)}else Pe(null),Ze(null),Ke(null),Qt("class-management-page")}),document.addEventListener("keydown",B=>{var X;const G=document.activeElement;if(!["INPUT","TEXTAREA","SELECT"].includes(G.tagName)){if(B.key.toLowerCase()==="o"&&B.shiftKey&&vi.classList.contains("active")&&(B.preventDefault(),wi.click()),B.key==="Escape"){if(_t.classList.contains("visible")){Ct();return}if(pt){Ee();return}switch((X=document.querySelector(".page.active"))==null?void 0:X.id){case"csv-preview-page":case"column-mapping-page":ye("settings-page");break;case"student-profile-page":Ke(null),ye(K?"student-page":"session-page");break;case"attendance-page":ye("student-page");break;case"student-page":Ze(null),We(),ye("session-page");break;case"settings-page":case"session-page":Pe(null),ye("class-management-page");break}return}if(K){const ae=B.key.toLowerCase();switch(" ascfg".includes(ae)&&B.preventDefault(),ae){case" ":C.click();break;case"a":E.classList.contains("active")?history.back():(st(),ye("attendance-page"));break;case"s":document.getElementById("session-page").classList.contains("active")&&history.back();break;case"c":document.querySelector(".back-to-classes-btn").click();break;case"f":const de=document.querySelector(".action-column .search-icon");de&&de.click();break;case"g":if(studentProfilePage.classList.contains("active"))history.back();else{const ie=K.lastSelectedWinnerId;if(ie){const he=D.students.find(be=>be.identity.studentId===ie);he&&(Ke(he),(void 0)(),ye("student-profile-page"))}else ee("⚠️ابتدا یک نفر را انتخاب کنید تا پروفایل او نمایش داده شود.")}break;case"arrowleft":{const ie=document.querySelector('button[title="برنده قبلی"]');ie&&!ie.disabled&&(B.preventDefault(),ie.click());break}case"arrowright":{const ie=document.querySelector('button[title="برنده بعدی"]');ie&&!ie.disabled&&(B.preventDefault(),ie.click());break}}}}});function me(){N.style.width="0",P.classList.add("modal-closing"),setTimeout(()=>{P.classList.remove("modal-visible","modal-closing")},300)}function Ue(){Ce("آیا از خروج از حالت نمایش (Demo) مطمئن هستید؟ با خروج، تمام تغییرات آزمایشی شما حذف شده و داده‌های اصلی شما بازیابی خواهند شد.",()=>{oi(),Pe(null),Ze(null),Ke(null),He(),ye("class-management-page"),kn(),me()},{confirmText:"خروج",confirmClass:"btn-success"})}d(".global-search-container .animated-search-container",En),d(".action-column-header .animated-search-container",Gt),Ir(),[we,Si,tt,Ci].forEach(B=>{B&&Oi(B)});function Ge(B,G){const U=Se(G.students).filter(Te=>Te.identity.studentId!==B.identity.studentId);if(U.length===0)return;const X=U.reduce((Te,Fe)=>Fe.statusCounters.totalSelections>Te.statusCounters.totalSelections?Fe:Te,U[0]);if(!X||X.statusCounters.totalSelections===0)return;B.categoryCounts=JSON.parse(JSON.stringify(X.categoryCounts)),B.statusCounters.totalSelections=X.statusCounters.totalSelections;const ae=U.reduce((Te,Fe)=>Te+Fe.statusCounters.totalSelections,0),de=U.reduce((Te,Fe)=>Te+(Fe.statusCounters.missedChances||0),0),ie=ae>0?de/ae:0;B.statusCounters.missedChances=Math.round(B.statusCounters.totalSelections*ie);const he=Se(G.categories),be={};he.forEach(Te=>{const Fe=U.reduce((jn,Zn)=>jn+(Zn.categoryCounts[Te.name]||0),0),Un=U.reduce((jn,Zn)=>jn+(Zn.categoryIssues[Te.name]||0),0);be[Te.name]=Fe>0?Un/Fe:0}),he.forEach(Te=>{const Fe=B.categoryCounts[Te.name]||0,Un=be[Te.name]||0;B.categoryIssues[Te.name]=Math.round(Fe*Un)});const xe=G.liveSession;xe?B.onboardingSession=xe.sessionNumber:B.onboardingSession=G.sessions.length+1;const Oe=Se(G.sessions).filter(Te=>Te.isFinished&&!Te.isCancelled),Ht="📝 یادداشت خودکار سیستم",ji=`این دانش‌آموز  از جلسه شماره ${Oe.length} به کلاس اضافه شد. آمار مشارکت او بر اساس فعال‌ترین دانش‌آموز و آمار «فرصت از دست رفته» او بر اساس میانگین کلاس ثبت گردید:`,Lt=[];B.statusCounters.totalSelections>0&&Lt.push(`کل انتخاب‌ها: ${B.statusCounters.totalSelections}`),B.statusCounters.missedChances>0&&Lt.push(`فرصت‌های از دست رفته: ${B.statusCounters.missedChances}`);for(const Te in B.categoryCounts){const Fe=B.categoryCounts[Te];Fe>0&&Lt.push(`انتخاب در «${Te}»: ${Fe}`)}for(const Te in B.categoryIssues){const Fe=B.categoryIssues[Te];Fe>0&&Lt.push(`مشکل در «${Te}»: ${Fe}`)}if(Lt.length>0){const Te=`${Ht}
${ji}

- ${Lt.join(`
- `)}`;B.addNote(Te)}}function ft(B){const U=`چون این کلاس جلسات برگزار شده دارد، برای ${B>1?"دانش‌آموزان جدید":"دانش‌آموز جدید"} آمار پایه‌ای (متناسب با سایر دانش‌آموزان) ثبت شد تا در فرایند انتخاب اختلالی ایجاد نشود.`;Ce(U,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}const Ae="13.2.0",It="751";{const B=` (ساخت ${It})`;document.getElementById("app-version").textContent=`نسخه ${Ae}${B}`}function Pt(){console.log("Starting universal backfill for writing scores...");let B=0;for(const G in re){const U=re[G];if(U.isDeleted)continue;let X=0;Se(U.students).forEach(de=>{const ie=de.logs.scores;if(!(ie&&ie.writing&&ie.writing.length>0)){let be=-1;for(const xe in ie)xe!=="writing"&&ie[xe].forEach(Oe=>{Oe.value>be&&(be=Oe.value)});if(be>-1){const xe=`Automatically assigned based on the highest score (${be}) from other skills.`;de.addScore("Writing",be,xe),X++}}}),X>0&&(console.log(`Updated ${X} student(s) in class: ${U.info.name}.`),B+=X)}B>0?(ce(),console.log(`Update complete. A total of ${B} student(s) were updated across all classes. Data saved.`),document.getElementById("student-page").classList.contains("active")&&Re()):console.log("No students needed updating in any class.")}window.backfillWritingScoresForAll=Pt;function et(){console.log("Starting backfill for 'outOfClassCount' and 'wasOutOfClass' properties...");let B=0,G=0;const U=localStorage.getItem("teacherAssistantData_v2");if(!U){console.log("No data found in localStorage. Nothing to do.");return}const X=JSON.parse(U);for(const ae in X){const de=X[ae];de.students&&de.students.forEach(ie=>{ie.statusCounters&&typeof ie.statusCounters.outOfClassCount>"u"&&(ie.statusCounters.outOfClassCount=0,B++)}),de.sessions&&de.sessions.forEach(ie=>{if(ie.studentRecords)for(const he in ie.studentRecords){const be=ie.studentRecords[he];typeof be.wasOutOfClass>"u"&&(be.wasOutOfClass=!1,G++)}})}localStorage.setItem("teacherAssistantData_v2",JSON.stringify(X)),console.log(`Backfill complete. Updated ${B} students and ${G} session records. Data saved.`),Dn(),D&&Re()}window.backfillExitCounters=et;function ln(){console.log("🧹 Starting orphaned data cleanup...");let B=0;for(const G in re){const U=re[G];if(U.isDeleted)continue;let X=!1;const ae=new Set(U.students.filter(he=>!he.isDeleted).map(he=>he.identity.studentId)),de=new Map(U.students.map(he=>[he.identity.studentId,he.identity.name])),ie=[];U.sessions.forEach(he=>{if(he.isDeleted)return;const be=[];for(const xe in he.studentRecords)if(!ae.has(xe)){const Oe=de.get(xe)||"Unknown/Deleted";be.push(`  - Removed student record for: ${Oe} (ID: ${xe})`),delete he.studentRecords[xe],B++,X=!0}for(const xe in he.lastWinnerByCategory){const Oe=he.lastWinnerByCategory[xe];if(!ae.has(Oe)){const Ht=de.get(Oe)||"Unknown/Deleted";be.push(`  - Removed '${xe}' last winner: ${Ht} (ID: ${Oe})`),delete he.lastWinnerByCategory[xe],B++,X=!0}}if(he.lastSelectedWinnerId&&!ae.has(he.lastSelectedWinnerId)){const xe=he.lastSelectedWinnerId,Oe=de.get(xe)||"Unknown/Deleted";be.push(`  - Cleared 'lastSelectedWinnerId': ${Oe} (ID: ${xe})`),he.lastSelectedWinnerId=null,B++,X=!0}if(be.length>0){const Oe=Qe(U).get(he.sessionNumber)||`(#${he.sessionNumber})`;ie.push({sessionDisplayNumber:Oe,logs:be})}}),X&&(console.group(`➡️ Class: ${G}`),ie.forEach(he=>{console.groupCollapsed(`  Session ${he.sessionDisplayNumber}`),he.logs.forEach(be=>console.warn(be)),console.groupEnd()}),console.groupEnd())}B>0?(ce(),console.log(`✅ Cleanup complete! Found and removed ${B} orphaned references. Data saved.`)):console.log("✅ No orphaned data found. Your data is clean!")}window.cleanupOrphanedData=ln;function Wn(B){if(!B||!B.classroomName)return;const G=re[B.classroomName];if(!G){ee("⚠️ کلاس مربوط به این گزارش یافت نشد.");return}Pe(G),Ee(),setTimeout(()=>{switch(B.type){case"VIEW_STUDENT_PROFILE":{const U=G.students.find(X=>X.identity.studentId===B.studentId);U?ze(U):ee("⚠️ دانش‌آموز مورد نظر یافت نشد.");break}case"VIEW_TRASH":on(),ye("trash-page");break;case"VIEW_SESSIONS":We(),ye("session-page");break;case"VIEW_CLASS_NOTE":Pn(G);break;case"VIEW_CLASS_SETTINGS":Mt(G);break}},300)}Be.addEventListener("click",()=>{Rs()}),Ne.addEventListener("click",()=>{Ee()}),pe.addEventListener("click",()=>{const B=ve.value.trim(),G=Le.checked;if(!B){Ns.style.display==="flex"?Ce("کادر یادداشت خالی است. آیا مطمئنید که می‌خواهید یادداشت‌های قبلی دانش‌آموزان انتخاب‌شده را پاک کنید؟",()=>{Ee(),os("",!1)},{confirmText:"پاک کردن",confirmClass:"btn-warning"}):ee("⚠️ لطفاً متن یادداشت را وارد کنید.");return}Ee(()=>{os(B,G)})});const dt=document.getElementById("screen-saver-overlay"),dn=document.getElementById("screen-saver-toggle");let xt;const yt=2*60*1e3,vt=["mousemove","keypress","scroll","click","touchstart"];function Wi(){dt.classList.add("visible")}function Fs(){dt.classList.contains("visible")&&dt.classList.remove("visible")}function un(){Fs(),clearTimeout(xt),xt=setTimeout(Wi,yt)}function fn(B){B.preventDefault(),B.stopPropagation(),setTimeout(un,0)}function Ps(){un(),vt.forEach(G=>window.addEventListener(G,un)),dt.addEventListener("click",fn),dt.addEventListener("touchstart",fn);const B="13.2.0";{const G=document.getElementById("screen-saver-version");G&&(G.textContent=`v${B}`)}}function Ui(){clearTimeout(xt),Fs(),vt.forEach(B=>window.removeEventListener(B,un)),dt.removeEventListener("click",fn),dt.removeEventListener("touchstart",fn)}dn.checked=qe.isScreenSaverEnabled,qe.isScreenSaverEnabled&&Ps(),dn.addEventListener("change",B=>{B.target.checked?(Vt({isScreenSaverEnabled:!0}),Ps()):(me(),B.preventDefault(),Ce(`نکته:
محافظ صفحه در تلفن های همراه جدید کمک می کند که دستگاه باطری کمتری مصرف کند و به دلیل ثابت ماندن صفحه نمایش در گوشی های قدیمی تر، صفحه نمایش دچار ماندگی رد پیکسل نگردد. آیا مطمئن هستید که می خواهید این ویژگی را غیر فعال کنید؟`,()=>{B.target.checked=!1,Vt({isScreenSaverEnabled:!1}),Ui(),ee("توصیه می شود زمان خاموش شدن صفحه نمایش گوشی خود را به حداقل دو دقیقه تغییر دهید تا در استفاده های طولانی مدت صفحه نمایش گوشی اصطحلاک کمتری را تجربه کند",7e3)},{confirmText:"بله، غیرفعال کن",cancelText:"لغو",onCancel:()=>{B.target.checked=!0}}))})});function Sr(n,o){if(!K||K.isFinished){ee("⚠️ امکان لغو انتخاب در جلسه خاتمه یافته وجود ندارد.");return}const e=K.winnerHistory;if(!(je===e.length-1)||e.length===0){ee("⚠️ فقط آخرین انتخاب قابل لغو است.");return}if(e[e.length-1].winner.identity.studentId!==n.identity.studentId){console.error("Undo mismatch!");return}Ce(`آیا از حذف انتخاب «${n.identity.name}» برای «${o}» مطمئن هستید؟ آمار این انتخاب بازگردانی خواهد شد.`,()=>{const r=K.winnerHistory,t=r.pop();if(!t)return;const a=t.winner,s=t.categoryName,i=a.identity.studentId;a.statusCounters.totalSelections=Math.max(0,a.statusCounters.totalSelections-1),a.categoryCounts[s]&&(a.categoryCounts[s]=Math.max(0,a.categoryCounts[s]-1));const c=K.studentRecords[i];c&&c.selections[s]&&(c.selections[s]=Math.max(0,c.selections[s]-1));let h=null;for(let y=r.length-1;y>=0;y--)if(r[y].categoryName===s){h=r[y].winner.identity.studentId;break}h?K.lastWinnerByCategory[s]=h:delete K.lastWinnerByCategory[s],gt(r.length-1),Re(),Me(),ce(),ee(`✅ انتخاب «${a.identity.name}» لغو شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}function Ir(){const n=document.getElementById("session-dashboard-page"),o=document.getElementById("student-stats-table-container");if(!n)return;let e=0,l=0;n.addEventListener("touchstart",t=>{if(o&&o.contains(t.target)){const a=t.target.closest("td, th");a&&a.parentElement.firstElementChild===a?e=t.changedTouches[0].screenX:e=0}else e=t.changedTouches[0].screenX},{passive:!0}),n.addEventListener("touchend",t=>{e!==0&&(l=t.changedTouches[0].screenX,r())});function r(){const a=e-l;Math.abs(a)>150&&(document.getElementById("selector-tab-btn").classList.contains("active")?(ye("session-dashboard-page",{tab:"attendance"}),an("attendance")):(ye("session-dashboard-page",{tab:"selector"}),an("selector"))),e=0,l=0}}
