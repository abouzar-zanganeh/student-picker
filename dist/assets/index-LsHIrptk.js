(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))l(a);new MutationObserver(a=>{for(const t of a)if(t.type==="childList")for(const n of t.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&l(n)}).observe(document,{childList:!0,subtree:!0});function e(a){const t={};return a.integrity&&(t.integrity=a.integrity),a.referrerPolicy&&(t.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?t.credentials="include":a.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function l(a){if(a.ep)return;a.ep=!0;const t=e(a);fetch(a.href,t)}})();class hn{constructor(o){this.identity={name:o.name,studentId:o.studentId||`id_${new Date().getTime()}_${Math.random()}`,branchName:o.branchName||null,ageGroup:o.ageGroup||"adult",level:o.level||null,contact:{social:o.socialContact||null,parent:o.parentContact||null}},this.isDeleted=!1,this.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0,outOfClassCount:0},this.categoryCounts={},this.categoryIssues={},this.logs={parentContacts:[],scores:{},discipline:{},sessionHistory:{}},this.profile={notes:[],tags:[]},this.finalClassActivityScore=null,this.onboardingSession=null}addScore(o,e,l){if(e>100||e<0){console.log("نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}const a=o.toLowerCase();this.logs.scores[a]||(this.logs.scores[a]=[]);const t=new Mi(o,e,l);this.logs.scores[a].push(t)}addNote(o,e=null){const l=new zi(o,e);this.profile.notes.push(l)}getOverallAverageScore(){let o=0,e=0;for(const a in this.logs.scores)this.logs.scores[a].forEach(t=>{t.isDeleted||(o+=t.value,e++)});if(e===0)return null;const l=o/e;return Math.round(l*100)/100}}class Mi{constructor(o,e,l=""){this.id=`score_${new Date().getTime()}`,this.skill=o,this.value=e,this.timestamp=new Date,this.comment=l,this.isDeleted=!1}}class zi{constructor(o,e=null){this.id=`note_${new Date().getTime()}`,this.timestamp=new Date,this.content=o,this.isDeleted=!1,this.source=e}}class Zn{constructor(o="complete",e=""){this.status=o,this.comment=e,this.timestamp=new Date}}class $s{constructor(o){this.sessionNumber=o,this.startTime=new Date,this.note="",this.isDeleted=!1,this.endTime=null,this.isFinished=!1,this.isMakeup=!1,this.isCancelled=!1,this.studentRecords={},this.lastWinnerByCategory={},this.lastUsedCategoryId=null,this.lastSelectedWinnerId=null,this.winnerHistory=[]}end(){this.isFinished=!0,this.endTime=new Date}markAsMakeup(){this.isMakeup=!this.isMakeup}initializeStudentRecord(o){this.studentRecords[o]||(this.studentRecords[o]={attendance:"present",homework:new Zn,selections:{},hadIssue:!1,wasOutOfClass:!1})}setAttendance(o,e){this.initializeStudentRecord(o),this.studentRecords[o].attendance=e}setHomeworkStatus(o,e){this.initializeStudentRecord(o),this.studentRecords[o].homework.status=e}selectNextWinner(o,e,l){if(!e||e.length===0)return console.log("هیچ دانش‌آموزی در کلاس برای انتخاب وجود ندارد."),null;const a=this.lastWinnerByCategory[o];let t=e.filter(p=>p.identity.studentId!==a&&!p.isDeleted);if(t.length===0&&(t=e),t.length===0)return null;const n=(p,d)=>p.categoryCounts[d]||0,i=Math.min(...t.map(p=>n(p,o))),r=t.filter(p=>n(p,o)===i);let u;if(r.length===1)u=r[0];else if(r.length>1){const p=l.filter(g=>!g.isDeleted&&g.name!==o).map(g=>g.name),d=r.map(g=>{const y=p.reduce((w,k)=>w+n(g,k),0);return{student:g,otherCategoriesTotal:y}}),b=Math.min(...d.map(g=>g.otherCategoriesTotal)),m=d.filter(g=>g.otherCategoriesTotal===b).map(g=>g.student);m.length===1?u=m[0]:u=m[Math.floor(Math.random()*m.length)]}else u=t[Math.floor(Math.random()*t.length)];const h=u.identity.studentId;this.initializeStudentRecord(h);const v=(this.studentRecords[h].selections[o]||0)+1;return this.studentRecords[h].selections[o]=v,u.statusCounters.totalSelections++,u.categoryCounts[o]=(u.categoryCounts[o]||0)+1,this.lastWinnerByCategory[o]=h,u}}class qn{constructor(o){this.info={name:o.name||"NotNamed",teacherName:o.teacherName||null,type:o.type||"in-person",term:o.term||null,scheduleText:o.scheduleText||null,level:o.level||null,creationDate:o.creationDate?new Date(o.creationDate):new Date,scheduleCode:o.scheduleCode||`code_${new Date().getTime()}`,scheduleDays:o.scheduleDays||[],scheduleStartTime:o.scheduleStartTime||null,scheduleEndTime:o.scheduleEndTime||null},this.students=[],this.sessions=[],this.note="",this.isDeleted=!1,this.categories=[new ut("Vocabulary","Questions about words and meanings."),new ut("Grammar","Questions about sentence structure and rules."),new ut("Listening",void 0,!0),new ut("Speaking",void 0,!0),new ut("Reading",void 0,!0),new ut("Writing",void 0,!0)],this.futurePlans={}}addStudent(o){this.students.push(o)}removeStudent(o){this.students=this.students.filter(e=>e.identity.studentId!==o)}startNewSession(){const o=this.sessions.length+1,e=new $s(o);return this.sessions.push(e),e}endSpecificSession(o){const e=this.getSession(o);return e&&!e.isFinished?(e.end(),!0):!1}getSession(o){return this.sessions.find(e=>e.sessionNumber===o)}markAsMakeup(o){const e=this.getSession(o);e&&e.markAsMakeup()}planForSession(o,e){this.futurePlans[o]=e}hasSessionToday(){const o=new Date().toDateString();return this.sessions.some(e=>!e.isDeleted&&e.startTime.toDateString()===o)}selectNextWinner(o,e){return e?e.selectNextWinner(o,this.students,this.categories):null}get liveSession(){for(let o=this.sessions.length-1;o>=0;o--)if(!this.sessions[o].isFinished)return this.sessions[o];return null}endLiveSession(){const o=this.liveSession;return o?(o.end(),!0):!1}calculateFinalStudentScore(o){const e=o.logs.scores,l=["reading","writing"];for(const p of l)if(!e[p]||e[p].length===0)return null;const a=e.listening&&e.listening.length>0,t=e.speaking&&e.speaking.length>0;if(!a&&!t)return null;const n=p=>e[p].reduce((b,m)=>b+m.value,0)/e[p].length;let i;a&&t?i=(n("listening")+n("speaking"))/2:a?i=n("listening"):i=n("speaking");const r=n("reading"),u=n("writing"),v=(i*3+r*2+u*1)/6;return Math.trunc(v*10)/10}assignAllFinalScores(){let o=0,e=[];console.log("شروع عملیات محاسبه نمره نهایی برای تمام دانش‌آموزان..."),this.students.forEach(a=>{const t=this.calculateFinalStudentScore(a);t!==null?(a.finalClassActivityScore=t,o++):(a.finalClassActivityScore=null,e.push(a.identity.name))});const l=e.length;console.log(`عملیات پایان یافت. تعداد نمرات موفق: ${o} | تعداد ناموفق (نمرات ناقص): ${l}`),l>0&&(console.log("اسامی دانش‌آموزانی که نمراتشان ناقص است:"),e.forEach(a=>console.log(`- ${a}`)))}}class ut{constructor(o,e="",l=!1){this.id=`cat_${new Date().getTime()}_${Math.random()}`,this.name=o,this.description=e,this.isDeleted=!1,this.isGradedCategory=l,this.isDeleted=!1}}var fn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function $i(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}function mn(s){throw new Error('Could not dynamically require "'+s+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Fs={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/(function(s,o){(function(e){s.exports=e()})(function(){return function e(l,a,t){function n(u,h){if(!a[u]){if(!l[u]){var v=typeof mn=="function"&&mn;if(!h&&v)return v(u,!0);if(i)return i(u,!0);var p=new Error("Cannot find module '"+u+"'");throw p.code="MODULE_NOT_FOUND",p}var d=a[u]={exports:{}};l[u][0].call(d.exports,function(b){var m=l[u][1][b];return n(m||b)},d,d.exports,e,l,a,t)}return a[u].exports}for(var i=typeof mn=="function"&&mn,r=0;r<t.length;r++)n(t[r]);return n}({1:[function(e,l,a){var t=e("./utils"),n=e("./support"),i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";a.encode=function(r){for(var u,h,v,p,d,b,m,g=[],y=0,w=r.length,k=w,S=t.getTypeOf(r)!=="string";y<r.length;)k=w-y,v=S?(u=r[y++],h=y<w?r[y++]:0,y<w?r[y++]:0):(u=r.charCodeAt(y++),h=y<w?r.charCodeAt(y++):0,y<w?r.charCodeAt(y++):0),p=u>>2,d=(3&u)<<4|h>>4,b=1<k?(15&h)<<2|v>>6:64,m=2<k?63&v:64,g.push(i.charAt(p)+i.charAt(d)+i.charAt(b)+i.charAt(m));return g.join("")},a.decode=function(r){var u,h,v,p,d,b,m=0,g=0,y="data:";if(r.substr(0,y.length)===y)throw new Error("Invalid base64 input, it looks like a data url.");var w,k=3*(r=r.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(r.charAt(r.length-1)===i.charAt(64)&&k--,r.charAt(r.length-2)===i.charAt(64)&&k--,k%1!=0)throw new Error("Invalid base64 input, bad content length.");for(w=n.uint8array?new Uint8Array(0|k):new Array(0|k);m<r.length;)u=i.indexOf(r.charAt(m++))<<2|(p=i.indexOf(r.charAt(m++)))>>4,h=(15&p)<<4|(d=i.indexOf(r.charAt(m++)))>>2,v=(3&d)<<6|(b=i.indexOf(r.charAt(m++))),w[g++]=u,d!==64&&(w[g++]=h),b!==64&&(w[g++]=v);return w}},{"./support":30,"./utils":32}],2:[function(e,l,a){var t=e("./external"),n=e("./stream/DataWorker"),i=e("./stream/Crc32Probe"),r=e("./stream/DataLengthProbe");function u(h,v,p,d,b){this.compressedSize=h,this.uncompressedSize=v,this.crc32=p,this.compression=d,this.compressedContent=b}u.prototype={getContentWorker:function(){var h=new n(t.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new r("data_length")),v=this;return h.on("end",function(){if(this.streamInfo.data_length!==v.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),h},getCompressedWorker:function(){return new n(t.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},u.createWorkerFrom=function(h,v,p){return h.pipe(new i).pipe(new r("uncompressedSize")).pipe(v.compressWorker(p)).pipe(new r("compressedSize")).withStreamInfo("compression",v)},l.exports=u},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,l,a){var t=e("./stream/GenericWorker");a.STORE={magic:"\0\0",compressWorker:function(){return new t("STORE compression")},uncompressWorker:function(){return new t("STORE decompression")}},a.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,l,a){var t=e("./utils"),n=function(){for(var i,r=[],u=0;u<256;u++){i=u;for(var h=0;h<8;h++)i=1&i?3988292384^i>>>1:i>>>1;r[u]=i}return r}();l.exports=function(i,r){return i!==void 0&&i.length?t.getTypeOf(i)!=="string"?function(u,h,v,p){var d=n,b=p+v;u^=-1;for(var m=p;m<b;m++)u=u>>>8^d[255&(u^h[m])];return-1^u}(0|r,i,i.length,0):function(u,h,v,p){var d=n,b=p+v;u^=-1;for(var m=p;m<b;m++)u=u>>>8^d[255&(u^h.charCodeAt(m))];return-1^u}(0|r,i,i.length,0):0}},{"./utils":32}],5:[function(e,l,a){a.base64=!1,a.binary=!1,a.dir=!1,a.createFolders=!0,a.date=null,a.compression=null,a.compressionOptions=null,a.comment=null,a.unixPermissions=null,a.dosPermissions=null},{}],6:[function(e,l,a){var t=null;t=typeof Promise<"u"?Promise:e("lie"),l.exports={Promise:t}},{lie:37}],7:[function(e,l,a){var t=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",n=e("pako"),i=e("./utils"),r=e("./stream/GenericWorker"),u=t?"uint8array":"array";function h(v,p){r.call(this,"FlateWorker/"+v),this._pako=null,this._pakoAction=v,this._pakoOptions=p,this.meta={}}a.magic="\b\0",i.inherits(h,r),h.prototype.processChunk=function(v){this.meta=v.meta,this._pako===null&&this._createPako(),this._pako.push(i.transformTo(u,v.data),!1)},h.prototype.flush=function(){r.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},h.prototype.cleanUp=function(){r.prototype.cleanUp.call(this),this._pako=null},h.prototype._createPako=function(){this._pako=new n[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var v=this;this._pako.onData=function(p){v.push({data:p,meta:v.meta})}},a.compressWorker=function(v){return new h("Deflate",v)},a.uncompressWorker=function(){return new h("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(e,l,a){function t(d,b){var m,g="";for(m=0;m<b;m++)g+=String.fromCharCode(255&d),d>>>=8;return g}function n(d,b,m,g,y,w){var k,S,I=d.file,z=d.compression,M=w!==u.utf8encode,j=i.transformTo("string",w(I.name)),A=i.transformTo("string",u.utf8encode(I.name)),F=I.comment,Q=i.transformTo("string",w(F)),_=i.transformTo("string",u.utf8encode(F)),O=A.length!==I.name.length,f=_.length!==F.length,P="",ue="",Z="",fe=I.dir,$=I.date,ne={crc32:0,compressedSize:0,uncompressedSize:0};b&&!m||(ne.crc32=d.crc32,ne.compressedSize=d.compressedSize,ne.uncompressedSize=d.uncompressedSize);var B=0;b&&(B|=8),M||!O&&!f||(B|=2048);var D=0,re=0;fe&&(D|=16),y==="UNIX"?(re=798,D|=function(Y,Te){var Ne=Y;return Y||(Ne=Te?16893:33204),(65535&Ne)<<16}(I.unixPermissions,fe)):(re=20,D|=function(Y){return 63&(Y||0)}(I.dosPermissions)),k=$.getUTCHours(),k<<=6,k|=$.getUTCMinutes(),k<<=5,k|=$.getUTCSeconds()/2,S=$.getUTCFullYear()-1980,S<<=4,S|=$.getUTCMonth()+1,S<<=5,S|=$.getUTCDate(),O&&(ue=t(1,1)+t(h(j),4)+A,P+="up"+t(ue.length,2)+ue),f&&(Z=t(1,1)+t(h(Q),4)+_,P+="uc"+t(Z.length,2)+Z);var te="";return te+=`
\0`,te+=t(B,2),te+=z.magic,te+=t(k,2),te+=t(S,2),te+=t(ne.crc32,4),te+=t(ne.compressedSize,4),te+=t(ne.uncompressedSize,4),te+=t(j.length,2),te+=t(P.length,2),{fileRecord:v.LOCAL_FILE_HEADER+te+j+P,dirRecord:v.CENTRAL_FILE_HEADER+t(re,2)+te+t(Q.length,2)+"\0\0\0\0"+t(D,4)+t(g,4)+j+P+Q}}var i=e("../utils"),r=e("../stream/GenericWorker"),u=e("../utf8"),h=e("../crc32"),v=e("../signature");function p(d,b,m,g){r.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=b,this.zipPlatform=m,this.encodeFileName=g,this.streamFiles=d,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}i.inherits(p,r),p.prototype.push=function(d){var b=d.meta.percent||0,m=this.entriesCount,g=this._sources.length;this.accumulate?this.contentBuffer.push(d):(this.bytesWritten+=d.data.length,r.prototype.push.call(this,{data:d.data,meta:{currentFile:this.currentFile,percent:m?(b+100*(m-g-1))/m:100}}))},p.prototype.openedSource=function(d){this.currentSourceOffset=this.bytesWritten,this.currentFile=d.file.name;var b=this.streamFiles&&!d.file.dir;if(b){var m=n(d,b,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:m.fileRecord,meta:{percent:0}})}else this.accumulate=!0},p.prototype.closedSource=function(d){this.accumulate=!1;var b=this.streamFiles&&!d.file.dir,m=n(d,b,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(m.dirRecord),b)this.push({data:function(g){return v.DATA_DESCRIPTOR+t(g.crc32,4)+t(g.compressedSize,4)+t(g.uncompressedSize,4)}(d),meta:{percent:100}});else for(this.push({data:m.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},p.prototype.flush=function(){for(var d=this.bytesWritten,b=0;b<this.dirRecords.length;b++)this.push({data:this.dirRecords[b],meta:{percent:100}});var m=this.bytesWritten-d,g=function(y,w,k,S,I){var z=i.transformTo("string",I(S));return v.CENTRAL_DIRECTORY_END+"\0\0\0\0"+t(y,2)+t(y,2)+t(w,4)+t(k,4)+t(z.length,2)+z}(this.dirRecords.length,m,d,this.zipComment,this.encodeFileName);this.push({data:g,meta:{percent:100}})},p.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},p.prototype.registerPrevious=function(d){this._sources.push(d);var b=this;return d.on("data",function(m){b.processChunk(m)}),d.on("end",function(){b.closedSource(b.previous.streamInfo),b._sources.length?b.prepareNextSource():b.end()}),d.on("error",function(m){b.error(m)}),this},p.prototype.resume=function(){return!!r.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},p.prototype.error=function(d){var b=this._sources;if(!r.prototype.error.call(this,d))return!1;for(var m=0;m<b.length;m++)try{b[m].error(d)}catch{}return!0},p.prototype.lock=function(){r.prototype.lock.call(this);for(var d=this._sources,b=0;b<d.length;b++)d[b].lock()},l.exports=p},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,l,a){var t=e("../compressions"),n=e("./ZipFileWorker");a.generateWorker=function(i,r,u){var h=new n(r.streamFiles,u,r.platform,r.encodeFileName),v=0;try{i.forEach(function(p,d){v++;var b=function(w,k){var S=w||k,I=t[S];if(!I)throw new Error(S+" is not a valid compression method !");return I}(d.options.compression,r.compression),m=d.options.compressionOptions||r.compressionOptions||{},g=d.dir,y=d.date;d._compressWorker(b,m).withStreamInfo("file",{name:p,dir:g,date:y,comment:d.comment||"",unixPermissions:d.unixPermissions,dosPermissions:d.dosPermissions}).pipe(h)}),h.entriesCount=v}catch(p){h.error(p)}return h}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,l,a){function t(){if(!(this instanceof t))return new t;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var n=new t;for(var i in this)typeof this[i]!="function"&&(n[i]=this[i]);return n}}(t.prototype=e("./object")).loadAsync=e("./load"),t.support=e("./support"),t.defaults=e("./defaults"),t.version="3.10.1",t.loadAsync=function(n,i){return new t().loadAsync(n,i)},t.external=e("./external"),l.exports=t},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,l,a){var t=e("./utils"),n=e("./external"),i=e("./utf8"),r=e("./zipEntries"),u=e("./stream/Crc32Probe"),h=e("./nodejsUtils");function v(p){return new n.Promise(function(d,b){var m=p.decompressed.getContentWorker().pipe(new u);m.on("error",function(g){b(g)}).on("end",function(){m.streamInfo.crc32!==p.decompressed.crc32?b(new Error("Corrupted zip : CRC32 mismatch")):d()}).resume()})}l.exports=function(p,d){var b=this;return d=t.extend(d||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:i.utf8decode}),h.isNode&&h.isStream(p)?n.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):t.prepareContent("the loaded zip file",p,!0,d.optimizedBinaryString,d.base64).then(function(m){var g=new r(d);return g.load(m),g}).then(function(m){var g=[n.Promise.resolve(m)],y=m.files;if(d.checkCRC32)for(var w=0;w<y.length;w++)g.push(v(y[w]));return n.Promise.all(g)}).then(function(m){for(var g=m.shift(),y=g.files,w=0;w<y.length;w++){var k=y[w],S=k.fileNameStr,I=t.resolve(k.fileNameStr);b.file(I,k.decompressed,{binary:!0,optimizedBinaryString:!0,date:k.date,dir:k.dir,comment:k.fileCommentStr.length?k.fileCommentStr:null,unixPermissions:k.unixPermissions,dosPermissions:k.dosPermissions,createFolders:d.createFolders}),k.dir||(b.file(I).unsafeOriginalName=S)}return g.zipComment.length&&(b.comment=g.zipComment),b})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,l,a){var t=e("../utils"),n=e("../stream/GenericWorker");function i(r,u){n.call(this,"Nodejs stream input adapter for "+r),this._upstreamEnded=!1,this._bindStream(u)}t.inherits(i,n),i.prototype._bindStream=function(r){var u=this;(this._stream=r).pause(),r.on("data",function(h){u.push({data:h,meta:{percent:0}})}).on("error",function(h){u.isPaused?this.generatedError=h:u.error(h)}).on("end",function(){u.isPaused?u._upstreamEnded=!0:u.end()})},i.prototype.pause=function(){return!!n.prototype.pause.call(this)&&(this._stream.pause(),!0)},i.prototype.resume=function(){return!!n.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},l.exports=i},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,l,a){var t=e("readable-stream").Readable;function n(i,r,u){t.call(this,r),this._helper=i;var h=this;i.on("data",function(v,p){h.push(v)||h._helper.pause(),u&&u(p)}).on("error",function(v){h.emit("error",v)}).on("end",function(){h.push(null)})}e("../utils").inherits(n,t),n.prototype._read=function(){this._helper.resume()},l.exports=n},{"../utils":32,"readable-stream":16}],14:[function(e,l,a){l.exports={isNode:typeof Buffer<"u",newBufferFrom:function(t,n){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(t,n);if(typeof t=="number")throw new Error('The "data" argument must not be a number');return new Buffer(t,n)},allocBuffer:function(t){if(Buffer.alloc)return Buffer.alloc(t);var n=new Buffer(t);return n.fill(0),n},isBuffer:function(t){return Buffer.isBuffer(t)},isStream:function(t){return t&&typeof t.on=="function"&&typeof t.pause=="function"&&typeof t.resume=="function"}}},{}],15:[function(e,l,a){function t(I,z,M){var j,A=i.getTypeOf(z),F=i.extend(M||{},h);F.date=F.date||new Date,F.compression!==null&&(F.compression=F.compression.toUpperCase()),typeof F.unixPermissions=="string"&&(F.unixPermissions=parseInt(F.unixPermissions,8)),F.unixPermissions&&16384&F.unixPermissions&&(F.dir=!0),F.dosPermissions&&16&F.dosPermissions&&(F.dir=!0),F.dir&&(I=y(I)),F.createFolders&&(j=g(I))&&w.call(this,j,!0);var Q=A==="string"&&F.binary===!1&&F.base64===!1;M&&M.binary!==void 0||(F.binary=!Q),(z instanceof v&&z.uncompressedSize===0||F.dir||!z||z.length===0)&&(F.base64=!1,F.binary=!0,z="",F.compression="STORE",A="string");var _=null;_=z instanceof v||z instanceof r?z:b.isNode&&b.isStream(z)?new m(I,z):i.prepareContent(I,z,F.binary,F.optimizedBinaryString,F.base64);var O=new p(I,_,F);this.files[I]=O}var n=e("./utf8"),i=e("./utils"),r=e("./stream/GenericWorker"),u=e("./stream/StreamHelper"),h=e("./defaults"),v=e("./compressedObject"),p=e("./zipObject"),d=e("./generate"),b=e("./nodejsUtils"),m=e("./nodejs/NodejsStreamInputAdapter"),g=function(I){I.slice(-1)==="/"&&(I=I.substring(0,I.length-1));var z=I.lastIndexOf("/");return 0<z?I.substring(0,z):""},y=function(I){return I.slice(-1)!=="/"&&(I+="/"),I},w=function(I,z){return z=z!==void 0?z:h.createFolders,I=y(I),this.files[I]||t.call(this,I,null,{dir:!0,createFolders:z}),this.files[I]};function k(I){return Object.prototype.toString.call(I)==="[object RegExp]"}var S={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(I){var z,M,j;for(z in this.files)j=this.files[z],(M=z.slice(this.root.length,z.length))&&z.slice(0,this.root.length)===this.root&&I(M,j)},filter:function(I){var z=[];return this.forEach(function(M,j){I(M,j)&&z.push(j)}),z},file:function(I,z,M){if(arguments.length!==1)return I=this.root+I,t.call(this,I,z,M),this;if(k(I)){var j=I;return this.filter(function(F,Q){return!Q.dir&&j.test(F)})}var A=this.files[this.root+I];return A&&!A.dir?A:null},folder:function(I){if(!I)return this;if(k(I))return this.filter(function(A,F){return F.dir&&I.test(A)});var z=this.root+I,M=w.call(this,z),j=this.clone();return j.root=M.name,j},remove:function(I){I=this.root+I;var z=this.files[I];if(z||(I.slice(-1)!=="/"&&(I+="/"),z=this.files[I]),z&&!z.dir)delete this.files[I];else for(var M=this.filter(function(A,F){return F.name.slice(0,I.length)===I}),j=0;j<M.length;j++)delete this.files[M[j].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(I){var z,M={};try{if((M=i.extend(I||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:n.utf8encode})).type=M.type.toLowerCase(),M.compression=M.compression.toUpperCase(),M.type==="binarystring"&&(M.type="string"),!M.type)throw new Error("No output type specified.");i.checkSupport(M.type),M.platform!=="darwin"&&M.platform!=="freebsd"&&M.platform!=="linux"&&M.platform!=="sunos"||(M.platform="UNIX"),M.platform==="win32"&&(M.platform="DOS");var j=M.comment||this.comment||"";z=d.generateWorker(this,M,j)}catch(A){(z=new r("error")).error(A)}return new u(z,M.type||"string",M.mimeType)},generateAsync:function(I,z){return this.generateInternalStream(I).accumulate(z)},generateNodeStream:function(I,z){return(I=I||{}).type||(I.type="nodebuffer"),this.generateInternalStream(I).toNodejsStream(z)}};l.exports=S},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,l,a){l.exports=e("stream")},{stream:void 0}],17:[function(e,l,a){var t=e("./DataReader");function n(i){t.call(this,i);for(var r=0;r<this.data.length;r++)i[r]=255&i[r]}e("../utils").inherits(n,t),n.prototype.byteAt=function(i){return this.data[this.zero+i]},n.prototype.lastIndexOfSignature=function(i){for(var r=i.charCodeAt(0),u=i.charCodeAt(1),h=i.charCodeAt(2),v=i.charCodeAt(3),p=this.length-4;0<=p;--p)if(this.data[p]===r&&this.data[p+1]===u&&this.data[p+2]===h&&this.data[p+3]===v)return p-this.zero;return-1},n.prototype.readAndCheckSignature=function(i){var r=i.charCodeAt(0),u=i.charCodeAt(1),h=i.charCodeAt(2),v=i.charCodeAt(3),p=this.readData(4);return r===p[0]&&u===p[1]&&h===p[2]&&v===p[3]},n.prototype.readData=function(i){if(this.checkOffset(i),i===0)return[];var r=this.data.slice(this.zero+this.index,this.zero+this.index+i);return this.index+=i,r},l.exports=n},{"../utils":32,"./DataReader":18}],18:[function(e,l,a){var t=e("../utils");function n(i){this.data=i,this.length=i.length,this.index=0,this.zero=0}n.prototype={checkOffset:function(i){this.checkIndex(this.index+i)},checkIndex:function(i){if(this.length<this.zero+i||i<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+i+"). Corrupted zip ?")},setIndex:function(i){this.checkIndex(i),this.index=i},skip:function(i){this.setIndex(this.index+i)},byteAt:function(){},readInt:function(i){var r,u=0;for(this.checkOffset(i),r=this.index+i-1;r>=this.index;r--)u=(u<<8)+this.byteAt(r);return this.index+=i,u},readString:function(i){return t.transformTo("string",this.readData(i))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var i=this.readInt(4);return new Date(Date.UTC(1980+(i>>25&127),(i>>21&15)-1,i>>16&31,i>>11&31,i>>5&63,(31&i)<<1))}},l.exports=n},{"../utils":32}],19:[function(e,l,a){var t=e("./Uint8ArrayReader");function n(i){t.call(this,i)}e("../utils").inherits(n,t),n.prototype.readData=function(i){this.checkOffset(i);var r=this.data.slice(this.zero+this.index,this.zero+this.index+i);return this.index+=i,r},l.exports=n},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,l,a){var t=e("./DataReader");function n(i){t.call(this,i)}e("../utils").inherits(n,t),n.prototype.byteAt=function(i){return this.data.charCodeAt(this.zero+i)},n.prototype.lastIndexOfSignature=function(i){return this.data.lastIndexOf(i)-this.zero},n.prototype.readAndCheckSignature=function(i){return i===this.readData(4)},n.prototype.readData=function(i){this.checkOffset(i);var r=this.data.slice(this.zero+this.index,this.zero+this.index+i);return this.index+=i,r},l.exports=n},{"../utils":32,"./DataReader":18}],21:[function(e,l,a){var t=e("./ArrayReader");function n(i){t.call(this,i)}e("../utils").inherits(n,t),n.prototype.readData=function(i){if(this.checkOffset(i),i===0)return new Uint8Array(0);var r=this.data.subarray(this.zero+this.index,this.zero+this.index+i);return this.index+=i,r},l.exports=n},{"../utils":32,"./ArrayReader":17}],22:[function(e,l,a){var t=e("../utils"),n=e("../support"),i=e("./ArrayReader"),r=e("./StringReader"),u=e("./NodeBufferReader"),h=e("./Uint8ArrayReader");l.exports=function(v){var p=t.getTypeOf(v);return t.checkSupport(p),p!=="string"||n.uint8array?p==="nodebuffer"?new u(v):n.uint8array?new h(t.transformTo("uint8array",v)):new i(t.transformTo("array",v)):new r(v)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,l,a){a.LOCAL_FILE_HEADER="PK",a.CENTRAL_FILE_HEADER="PK",a.CENTRAL_DIRECTORY_END="PK",a.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",a.ZIP64_CENTRAL_DIRECTORY_END="PK",a.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(e,l,a){var t=e("./GenericWorker"),n=e("../utils");function i(r){t.call(this,"ConvertWorker to "+r),this.destType=r}n.inherits(i,t),i.prototype.processChunk=function(r){this.push({data:n.transformTo(this.destType,r.data),meta:r.meta})},l.exports=i},{"../utils":32,"./GenericWorker":28}],25:[function(e,l,a){var t=e("./GenericWorker"),n=e("../crc32");function i(){t.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}e("../utils").inherits(i,t),i.prototype.processChunk=function(r){this.streamInfo.crc32=n(r.data,this.streamInfo.crc32||0),this.push(r)},l.exports=i},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,l,a){var t=e("../utils"),n=e("./GenericWorker");function i(r){n.call(this,"DataLengthProbe for "+r),this.propName=r,this.withStreamInfo(r,0)}t.inherits(i,n),i.prototype.processChunk=function(r){if(r){var u=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=u+r.data.length}n.prototype.processChunk.call(this,r)},l.exports=i},{"../utils":32,"./GenericWorker":28}],27:[function(e,l,a){var t=e("../utils"),n=e("./GenericWorker");function i(r){n.call(this,"DataWorker");var u=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,r.then(function(h){u.dataIsReady=!0,u.data=h,u.max=h&&h.length||0,u.type=t.getTypeOf(h),u.isPaused||u._tickAndRepeat()},function(h){u.error(h)})}t.inherits(i,n),i.prototype.cleanUp=function(){n.prototype.cleanUp.call(this),this.data=null},i.prototype.resume=function(){return!!n.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,t.delay(this._tickAndRepeat,[],this)),!0)},i.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(t.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},i.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var r=null,u=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":r=this.data.substring(this.index,u);break;case"uint8array":r=this.data.subarray(this.index,u);break;case"array":case"nodebuffer":r=this.data.slice(this.index,u)}return this.index=u,this.push({data:r,meta:{percent:this.max?this.index/this.max*100:0}})},l.exports=i},{"../utils":32,"./GenericWorker":28}],28:[function(e,l,a){function t(n){this.name=n||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}t.prototype={push:function(n){this.emit("data",n)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(n){this.emit("error",n)}return!0},error:function(n){return!this.isFinished&&(this.isPaused?this.generatedError=n:(this.isFinished=!0,this.emit("error",n),this.previous&&this.previous.error(n),this.cleanUp()),!0)},on:function(n,i){return this._listeners[n].push(i),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(n,i){if(this._listeners[n])for(var r=0;r<this._listeners[n].length;r++)this._listeners[n][r].call(this,i)},pipe:function(n){return n.registerPrevious(this)},registerPrevious:function(n){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=n.streamInfo,this.mergeStreamInfo(),this.previous=n;var i=this;return n.on("data",function(r){i.processChunk(r)}),n.on("end",function(){i.end()}),n.on("error",function(r){i.error(r)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var n=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),n=!0),this.previous&&this.previous.resume(),!n},flush:function(){},processChunk:function(n){this.push(n)},withStreamInfo:function(n,i){return this.extraStreamInfo[n]=i,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var n in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,n)&&(this.streamInfo[n]=this.extraStreamInfo[n])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var n="Worker "+this.name;return this.previous?this.previous+" -> "+n:n}},l.exports=t},{}],29:[function(e,l,a){var t=e("../utils"),n=e("./ConvertWorker"),i=e("./GenericWorker"),r=e("../base64"),u=e("../support"),h=e("../external"),v=null;if(u.nodestream)try{v=e("../nodejs/NodejsStreamOutputAdapter")}catch{}function p(b,m){return new h.Promise(function(g,y){var w=[],k=b._internalType,S=b._outputType,I=b._mimeType;b.on("data",function(z,M){w.push(z),m&&m(M)}).on("error",function(z){w=[],y(z)}).on("end",function(){try{var z=function(M,j,A){switch(M){case"blob":return t.newBlob(t.transformTo("arraybuffer",j),A);case"base64":return r.encode(j);default:return t.transformTo(M,j)}}(S,function(M,j){var A,F=0,Q=null,_=0;for(A=0;A<j.length;A++)_+=j[A].length;switch(M){case"string":return j.join("");case"array":return Array.prototype.concat.apply([],j);case"uint8array":for(Q=new Uint8Array(_),A=0;A<j.length;A++)Q.set(j[A],F),F+=j[A].length;return Q;case"nodebuffer":return Buffer.concat(j);default:throw new Error("concat : unsupported type '"+M+"'")}}(k,w),I);g(z)}catch(M){y(M)}w=[]}).resume()})}function d(b,m,g){var y=m;switch(m){case"blob":case"arraybuffer":y="uint8array";break;case"base64":y="string"}try{this._internalType=y,this._outputType=m,this._mimeType=g,t.checkSupport(y),this._worker=b.pipe(new n(y)),b.lock()}catch(w){this._worker=new i("error"),this._worker.error(w)}}d.prototype={accumulate:function(b){return p(this,b)},on:function(b,m){var g=this;return b==="data"?this._worker.on(b,function(y){m.call(g,y.data,y.meta)}):this._worker.on(b,function(){t.delay(m,arguments,g)}),this},resume:function(){return t.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(b){if(t.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new v(this,{objectMode:this._outputType!=="nodebuffer"},b)}},l.exports=d},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,l,a){if(a.base64=!0,a.array=!0,a.string=!0,a.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",a.nodebuffer=typeof Buffer<"u",a.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")a.blob=!1;else{var t=new ArrayBuffer(0);try{a.blob=new Blob([t],{type:"application/zip"}).size===0}catch{try{var n=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);n.append(t),a.blob=n.getBlob("application/zip").size===0}catch{a.blob=!1}}}try{a.nodestream=!!e("readable-stream").Readable}catch{a.nodestream=!1}},{"readable-stream":16}],31:[function(e,l,a){for(var t=e("./utils"),n=e("./support"),i=e("./nodejsUtils"),r=e("./stream/GenericWorker"),u=new Array(256),h=0;h<256;h++)u[h]=252<=h?6:248<=h?5:240<=h?4:224<=h?3:192<=h?2:1;u[254]=u[254]=1;function v(){r.call(this,"utf-8 decode"),this.leftOver=null}function p(){r.call(this,"utf-8 encode")}a.utf8encode=function(d){return n.nodebuffer?i.newBufferFrom(d,"utf-8"):function(b){var m,g,y,w,k,S=b.length,I=0;for(w=0;w<S;w++)(64512&(g=b.charCodeAt(w)))==55296&&w+1<S&&(64512&(y=b.charCodeAt(w+1)))==56320&&(g=65536+(g-55296<<10)+(y-56320),w++),I+=g<128?1:g<2048?2:g<65536?3:4;for(m=n.uint8array?new Uint8Array(I):new Array(I),w=k=0;k<I;w++)(64512&(g=b.charCodeAt(w)))==55296&&w+1<S&&(64512&(y=b.charCodeAt(w+1)))==56320&&(g=65536+(g-55296<<10)+(y-56320),w++),g<128?m[k++]=g:(g<2048?m[k++]=192|g>>>6:(g<65536?m[k++]=224|g>>>12:(m[k++]=240|g>>>18,m[k++]=128|g>>>12&63),m[k++]=128|g>>>6&63),m[k++]=128|63&g);return m}(d)},a.utf8decode=function(d){return n.nodebuffer?t.transformTo("nodebuffer",d).toString("utf-8"):function(b){var m,g,y,w,k=b.length,S=new Array(2*k);for(m=g=0;m<k;)if((y=b[m++])<128)S[g++]=y;else if(4<(w=u[y]))S[g++]=65533,m+=w-1;else{for(y&=w===2?31:w===3?15:7;1<w&&m<k;)y=y<<6|63&b[m++],w--;1<w?S[g++]=65533:y<65536?S[g++]=y:(y-=65536,S[g++]=55296|y>>10&1023,S[g++]=56320|1023&y)}return S.length!==g&&(S.subarray?S=S.subarray(0,g):S.length=g),t.applyFromCharCode(S)}(d=t.transformTo(n.uint8array?"uint8array":"array",d))},t.inherits(v,r),v.prototype.processChunk=function(d){var b=t.transformTo(n.uint8array?"uint8array":"array",d.data);if(this.leftOver&&this.leftOver.length){if(n.uint8array){var m=b;(b=new Uint8Array(m.length+this.leftOver.length)).set(this.leftOver,0),b.set(m,this.leftOver.length)}else b=this.leftOver.concat(b);this.leftOver=null}var g=function(w,k){var S;for((k=k||w.length)>w.length&&(k=w.length),S=k-1;0<=S&&(192&w[S])==128;)S--;return S<0||S===0?k:S+u[w[S]]>k?S:k}(b),y=b;g!==b.length&&(n.uint8array?(y=b.subarray(0,g),this.leftOver=b.subarray(g,b.length)):(y=b.slice(0,g),this.leftOver=b.slice(g,b.length))),this.push({data:a.utf8decode(y),meta:d.meta})},v.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:a.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},a.Utf8DecodeWorker=v,t.inherits(p,r),p.prototype.processChunk=function(d){this.push({data:a.utf8encode(d.data),meta:d.meta})},a.Utf8EncodeWorker=p},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,l,a){var t=e("./support"),n=e("./base64"),i=e("./nodejsUtils"),r=e("./external");function u(m){return m}function h(m,g){for(var y=0;y<m.length;++y)g[y]=255&m.charCodeAt(y);return g}e("setimmediate"),a.newBlob=function(m,g){a.checkSupport("blob");try{return new Blob([m],{type:g})}catch{try{var y=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return y.append(m),y.getBlob(g)}catch{throw new Error("Bug : can't construct the Blob.")}}};var v={stringifyByChunk:function(m,g,y){var w=[],k=0,S=m.length;if(S<=y)return String.fromCharCode.apply(null,m);for(;k<S;)g==="array"||g==="nodebuffer"?w.push(String.fromCharCode.apply(null,m.slice(k,Math.min(k+y,S)))):w.push(String.fromCharCode.apply(null,m.subarray(k,Math.min(k+y,S)))),k+=y;return w.join("")},stringifyByChar:function(m){for(var g="",y=0;y<m.length;y++)g+=String.fromCharCode(m[y]);return g},applyCanBeUsed:{uint8array:function(){try{return t.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}}(),nodebuffer:function(){try{return t.nodebuffer&&String.fromCharCode.apply(null,i.allocBuffer(1)).length===1}catch{return!1}}()}};function p(m){var g=65536,y=a.getTypeOf(m),w=!0;if(y==="uint8array"?w=v.applyCanBeUsed.uint8array:y==="nodebuffer"&&(w=v.applyCanBeUsed.nodebuffer),w)for(;1<g;)try{return v.stringifyByChunk(m,y,g)}catch{g=Math.floor(g/2)}return v.stringifyByChar(m)}function d(m,g){for(var y=0;y<m.length;y++)g[y]=m[y];return g}a.applyFromCharCode=p;var b={};b.string={string:u,array:function(m){return h(m,new Array(m.length))},arraybuffer:function(m){return b.string.uint8array(m).buffer},uint8array:function(m){return h(m,new Uint8Array(m.length))},nodebuffer:function(m){return h(m,i.allocBuffer(m.length))}},b.array={string:p,array:u,arraybuffer:function(m){return new Uint8Array(m).buffer},uint8array:function(m){return new Uint8Array(m)},nodebuffer:function(m){return i.newBufferFrom(m)}},b.arraybuffer={string:function(m){return p(new Uint8Array(m))},array:function(m){return d(new Uint8Array(m),new Array(m.byteLength))},arraybuffer:u,uint8array:function(m){return new Uint8Array(m)},nodebuffer:function(m){return i.newBufferFrom(new Uint8Array(m))}},b.uint8array={string:p,array:function(m){return d(m,new Array(m.length))},arraybuffer:function(m){return m.buffer},uint8array:u,nodebuffer:function(m){return i.newBufferFrom(m)}},b.nodebuffer={string:p,array:function(m){return d(m,new Array(m.length))},arraybuffer:function(m){return b.nodebuffer.uint8array(m).buffer},uint8array:function(m){return d(m,new Uint8Array(m.length))},nodebuffer:u},a.transformTo=function(m,g){if(g=g||"",!m)return g;a.checkSupport(m);var y=a.getTypeOf(g);return b[y][m](g)},a.resolve=function(m){for(var g=m.split("/"),y=[],w=0;w<g.length;w++){var k=g[w];k==="."||k===""&&w!==0&&w!==g.length-1||(k===".."?y.pop():y.push(k))}return y.join("/")},a.getTypeOf=function(m){return typeof m=="string"?"string":Object.prototype.toString.call(m)==="[object Array]"?"array":t.nodebuffer&&i.isBuffer(m)?"nodebuffer":t.uint8array&&m instanceof Uint8Array?"uint8array":t.arraybuffer&&m instanceof ArrayBuffer?"arraybuffer":void 0},a.checkSupport=function(m){if(!t[m.toLowerCase()])throw new Error(m+" is not supported by this platform")},a.MAX_VALUE_16BITS=65535,a.MAX_VALUE_32BITS=-1,a.pretty=function(m){var g,y,w="";for(y=0;y<(m||"").length;y++)w+="\\x"+((g=m.charCodeAt(y))<16?"0":"")+g.toString(16).toUpperCase();return w},a.delay=function(m,g,y){setImmediate(function(){m.apply(y||null,g||[])})},a.inherits=function(m,g){function y(){}y.prototype=g.prototype,m.prototype=new y},a.extend=function(){var m,g,y={};for(m=0;m<arguments.length;m++)for(g in arguments[m])Object.prototype.hasOwnProperty.call(arguments[m],g)&&y[g]===void 0&&(y[g]=arguments[m][g]);return y},a.prepareContent=function(m,g,y,w,k){return r.Promise.resolve(g).then(function(S){return t.blob&&(S instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(S))!==-1)&&typeof FileReader<"u"?new r.Promise(function(I,z){var M=new FileReader;M.onload=function(j){I(j.target.result)},M.onerror=function(j){z(j.target.error)},M.readAsArrayBuffer(S)}):S}).then(function(S){var I=a.getTypeOf(S);return I?(I==="arraybuffer"?S=a.transformTo("uint8array",S):I==="string"&&(k?S=n.decode(S):y&&w!==!0&&(S=function(z){return h(z,t.uint8array?new Uint8Array(z.length):new Array(z.length))}(S))),S):r.Promise.reject(new Error("Can't read the data of '"+m+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(e,l,a){var t=e("./reader/readerFor"),n=e("./utils"),i=e("./signature"),r=e("./zipEntry"),u=e("./support");function h(v){this.files=[],this.loadOptions=v}h.prototype={checkSignature:function(v){if(!this.reader.readAndCheckSignature(v)){this.reader.index-=4;var p=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+n.pretty(p)+", expected "+n.pretty(v)+")")}},isSignature:function(v,p){var d=this.reader.index;this.reader.setIndex(v);var b=this.reader.readString(4)===p;return this.reader.setIndex(d),b},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var v=this.reader.readData(this.zipCommentLength),p=u.uint8array?"uint8array":"array",d=n.transformTo(p,v);this.zipComment=this.loadOptions.decodeFileName(d)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var v,p,d,b=this.zip64EndOfCentralSize-44;0<b;)v=this.reader.readInt(2),p=this.reader.readInt(4),d=this.reader.readData(p),this.zip64ExtensibleData[v]={id:v,length:p,value:d}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var v,p;for(v=0;v<this.files.length;v++)p=this.files[v],this.reader.setIndex(p.localHeaderOffset),this.checkSignature(i.LOCAL_FILE_HEADER),p.readLocalPart(this.reader),p.handleUTF8(),p.processAttributes()},readCentralDir:function(){var v;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(i.CENTRAL_FILE_HEADER);)(v=new r({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(v);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var v=this.reader.lastIndexOfSignature(i.CENTRAL_DIRECTORY_END);if(v<0)throw this.isSignature(0,i.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(v);var p=v;if(this.checkSignature(i.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===n.MAX_VALUE_16BITS||this.diskWithCentralDirStart===n.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===n.MAX_VALUE_16BITS||this.centralDirRecords===n.MAX_VALUE_16BITS||this.centralDirSize===n.MAX_VALUE_32BITS||this.centralDirOffset===n.MAX_VALUE_32BITS){if(this.zip64=!0,(v=this.reader.lastIndexOfSignature(i.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(v),this.checkSignature(i.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,i.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(i.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(i.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var d=this.centralDirOffset+this.centralDirSize;this.zip64&&(d+=20,d+=12+this.zip64EndOfCentralSize);var b=p-d;if(0<b)this.isSignature(p,i.CENTRAL_FILE_HEADER)||(this.reader.zero=b);else if(b<0)throw new Error("Corrupted zip: missing "+Math.abs(b)+" bytes.")},prepareReader:function(v){this.reader=t(v)},load:function(v){this.prepareReader(v),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},l.exports=h},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(e,l,a){var t=e("./reader/readerFor"),n=e("./utils"),i=e("./compressedObject"),r=e("./crc32"),u=e("./utf8"),h=e("./compressions"),v=e("./support");function p(d,b){this.options=d,this.loadOptions=b}p.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(d){var b,m;if(d.skip(22),this.fileNameLength=d.readInt(2),m=d.readInt(2),this.fileName=d.readData(this.fileNameLength),d.skip(m),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((b=function(g){for(var y in h)if(Object.prototype.hasOwnProperty.call(h,y)&&h[y].magic===g)return h[y];return null}(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+n.pretty(this.compressionMethod)+" unknown (inner file : "+n.transformTo("string",this.fileName)+")");this.decompressed=new i(this.compressedSize,this.uncompressedSize,this.crc32,b,d.readData(this.compressedSize))},readCentralPart:function(d){this.versionMadeBy=d.readInt(2),d.skip(2),this.bitFlag=d.readInt(2),this.compressionMethod=d.readString(2),this.date=d.readDate(),this.crc32=d.readInt(4),this.compressedSize=d.readInt(4),this.uncompressedSize=d.readInt(4);var b=d.readInt(2);if(this.extraFieldsLength=d.readInt(2),this.fileCommentLength=d.readInt(2),this.diskNumberStart=d.readInt(2),this.internalFileAttributes=d.readInt(2),this.externalFileAttributes=d.readInt(4),this.localHeaderOffset=d.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");d.skip(b),this.readExtraFields(d),this.parseZIP64ExtraField(d),this.fileComment=d.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var d=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),d==0&&(this.dosPermissions=63&this.externalFileAttributes),d==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var d=t(this.extraFields[1].value);this.uncompressedSize===n.MAX_VALUE_32BITS&&(this.uncompressedSize=d.readInt(8)),this.compressedSize===n.MAX_VALUE_32BITS&&(this.compressedSize=d.readInt(8)),this.localHeaderOffset===n.MAX_VALUE_32BITS&&(this.localHeaderOffset=d.readInt(8)),this.diskNumberStart===n.MAX_VALUE_32BITS&&(this.diskNumberStart=d.readInt(4))}},readExtraFields:function(d){var b,m,g,y=d.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});d.index+4<y;)b=d.readInt(2),m=d.readInt(2),g=d.readData(m),this.extraFields[b]={id:b,length:m,value:g};d.setIndex(y)},handleUTF8:function(){var d=v.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=u.utf8decode(this.fileName),this.fileCommentStr=u.utf8decode(this.fileComment);else{var b=this.findExtraFieldUnicodePath();if(b!==null)this.fileNameStr=b;else{var m=n.transformTo(d,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(m)}var g=this.findExtraFieldUnicodeComment();if(g!==null)this.fileCommentStr=g;else{var y=n.transformTo(d,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(y)}}},findExtraFieldUnicodePath:function(){var d=this.extraFields[28789];if(d){var b=t(d.value);return b.readInt(1)!==1||r(this.fileName)!==b.readInt(4)?null:u.utf8decode(b.readData(d.length-5))}return null},findExtraFieldUnicodeComment:function(){var d=this.extraFields[25461];if(d){var b=t(d.value);return b.readInt(1)!==1||r(this.fileComment)!==b.readInt(4)?null:u.utf8decode(b.readData(d.length-5))}return null}},l.exports=p},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(e,l,a){function t(b,m,g){this.name=b,this.dir=g.dir,this.date=g.date,this.comment=g.comment,this.unixPermissions=g.unixPermissions,this.dosPermissions=g.dosPermissions,this._data=m,this._dataBinary=g.binary,this.options={compression:g.compression,compressionOptions:g.compressionOptions}}var n=e("./stream/StreamHelper"),i=e("./stream/DataWorker"),r=e("./utf8"),u=e("./compressedObject"),h=e("./stream/GenericWorker");t.prototype={internalStream:function(b){var m=null,g="string";try{if(!b)throw new Error("No output type specified.");var y=(g=b.toLowerCase())==="string"||g==="text";g!=="binarystring"&&g!=="text"||(g="string"),m=this._decompressWorker();var w=!this._dataBinary;w&&!y&&(m=m.pipe(new r.Utf8EncodeWorker)),!w&&y&&(m=m.pipe(new r.Utf8DecodeWorker))}catch(k){(m=new h("error")).error(k)}return new n(m,g,"")},async:function(b,m){return this.internalStream(b).accumulate(m)},nodeStream:function(b,m){return this.internalStream(b||"nodebuffer").toNodejsStream(m)},_compressWorker:function(b,m){if(this._data instanceof u&&this._data.compression.magic===b.magic)return this._data.getCompressedWorker();var g=this._decompressWorker();return this._dataBinary||(g=g.pipe(new r.Utf8EncodeWorker)),u.createWorkerFrom(g,b,m)},_decompressWorker:function(){return this._data instanceof u?this._data.getContentWorker():this._data instanceof h?this._data:new i(this._data)}};for(var v=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],p=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},d=0;d<v.length;d++)t.prototype[v[d]]=p;l.exports=t},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(e,l,a){(function(t){var n,i,r=t.MutationObserver||t.WebKitMutationObserver;if(r){var u=0,h=new r(b),v=t.document.createTextNode("");h.observe(v,{characterData:!0}),n=function(){v.data=u=++u%2}}else if(t.setImmediate||t.MessageChannel===void 0)n="document"in t&&"onreadystatechange"in t.document.createElement("script")?function(){var m=t.document.createElement("script");m.onreadystatechange=function(){b(),m.onreadystatechange=null,m.parentNode.removeChild(m),m=null},t.document.documentElement.appendChild(m)}:function(){setTimeout(b,0)};else{var p=new t.MessageChannel;p.port1.onmessage=b,n=function(){p.port2.postMessage(0)}}var d=[];function b(){var m,g;i=!0;for(var y=d.length;y;){for(g=d,d=[],m=-1;++m<y;)g[m]();y=d.length}i=!1}l.exports=function(m){d.push(m)!==1||i||n()}}).call(this,typeof fn<"u"?fn:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(e,l,a){var t=e("immediate");function n(){}var i={},r=["REJECTED"],u=["FULFILLED"],h=["PENDING"];function v(y){if(typeof y!="function")throw new TypeError("resolver must be a function");this.state=h,this.queue=[],this.outcome=void 0,y!==n&&m(this,y)}function p(y,w,k){this.promise=y,typeof w=="function"&&(this.onFulfilled=w,this.callFulfilled=this.otherCallFulfilled),typeof k=="function"&&(this.onRejected=k,this.callRejected=this.otherCallRejected)}function d(y,w,k){t(function(){var S;try{S=w(k)}catch(I){return i.reject(y,I)}S===y?i.reject(y,new TypeError("Cannot resolve promise with itself")):i.resolve(y,S)})}function b(y){var w=y&&y.then;if(y&&(typeof y=="object"||typeof y=="function")&&typeof w=="function")return function(){w.apply(y,arguments)}}function m(y,w){var k=!1;function S(M){k||(k=!0,i.reject(y,M))}function I(M){k||(k=!0,i.resolve(y,M))}var z=g(function(){w(I,S)});z.status==="error"&&S(z.value)}function g(y,w){var k={};try{k.value=y(w),k.status="success"}catch(S){k.status="error",k.value=S}return k}(l.exports=v).prototype.finally=function(y){if(typeof y!="function")return this;var w=this.constructor;return this.then(function(k){return w.resolve(y()).then(function(){return k})},function(k){return w.resolve(y()).then(function(){throw k})})},v.prototype.catch=function(y){return this.then(null,y)},v.prototype.then=function(y,w){if(typeof y!="function"&&this.state===u||typeof w!="function"&&this.state===r)return this;var k=new this.constructor(n);return this.state!==h?d(k,this.state===u?y:w,this.outcome):this.queue.push(new p(k,y,w)),k},p.prototype.callFulfilled=function(y){i.resolve(this.promise,y)},p.prototype.otherCallFulfilled=function(y){d(this.promise,this.onFulfilled,y)},p.prototype.callRejected=function(y){i.reject(this.promise,y)},p.prototype.otherCallRejected=function(y){d(this.promise,this.onRejected,y)},i.resolve=function(y,w){var k=g(b,w);if(k.status==="error")return i.reject(y,k.value);var S=k.value;if(S)m(y,S);else{y.state=u,y.outcome=w;for(var I=-1,z=y.queue.length;++I<z;)y.queue[I].callFulfilled(w)}return y},i.reject=function(y,w){y.state=r,y.outcome=w;for(var k=-1,S=y.queue.length;++k<S;)y.queue[k].callRejected(w);return y},v.resolve=function(y){return y instanceof this?y:i.resolve(new this(n),y)},v.reject=function(y){var w=new this(n);return i.reject(w,y)},v.all=function(y){var w=this;if(Object.prototype.toString.call(y)!=="[object Array]")return this.reject(new TypeError("must be an array"));var k=y.length,S=!1;if(!k)return this.resolve([]);for(var I=new Array(k),z=0,M=-1,j=new this(n);++M<k;)A(y[M],M);return j;function A(F,Q){w.resolve(F).then(function(_){I[Q]=_,++z!==k||S||(S=!0,i.resolve(j,I))},function(_){S||(S=!0,i.reject(j,_))})}},v.race=function(y){var w=this;if(Object.prototype.toString.call(y)!=="[object Array]")return this.reject(new TypeError("must be an array"));var k=y.length,S=!1;if(!k)return this.resolve([]);for(var I=-1,z=new this(n);++I<k;)M=y[I],w.resolve(M).then(function(j){S||(S=!0,i.resolve(z,j))},function(j){S||(S=!0,i.reject(z,j))});var M;return z}},{immediate:36}],38:[function(e,l,a){var t={};(0,e("./lib/utils/common").assign)(t,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),l.exports=t},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(e,l,a){var t=e("./zlib/deflate"),n=e("./utils/common"),i=e("./utils/strings"),r=e("./zlib/messages"),u=e("./zlib/zstream"),h=Object.prototype.toString,v=0,p=-1,d=0,b=8;function m(y){if(!(this instanceof m))return new m(y);this.options=n.assign({level:p,method:b,chunkSize:16384,windowBits:15,memLevel:8,strategy:d,to:""},y||{});var w=this.options;w.raw&&0<w.windowBits?w.windowBits=-w.windowBits:w.gzip&&0<w.windowBits&&w.windowBits<16&&(w.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new u,this.strm.avail_out=0;var k=t.deflateInit2(this.strm,w.level,w.method,w.windowBits,w.memLevel,w.strategy);if(k!==v)throw new Error(r[k]);if(w.header&&t.deflateSetHeader(this.strm,w.header),w.dictionary){var S;if(S=typeof w.dictionary=="string"?i.string2buf(w.dictionary):h.call(w.dictionary)==="[object ArrayBuffer]"?new Uint8Array(w.dictionary):w.dictionary,(k=t.deflateSetDictionary(this.strm,S))!==v)throw new Error(r[k]);this._dict_set=!0}}function g(y,w){var k=new m(w);if(k.push(y,!0),k.err)throw k.msg||r[k.err];return k.result}m.prototype.push=function(y,w){var k,S,I=this.strm,z=this.options.chunkSize;if(this.ended)return!1;S=w===~~w?w:w===!0?4:0,typeof y=="string"?I.input=i.string2buf(y):h.call(y)==="[object ArrayBuffer]"?I.input=new Uint8Array(y):I.input=y,I.next_in=0,I.avail_in=I.input.length;do{if(I.avail_out===0&&(I.output=new n.Buf8(z),I.next_out=0,I.avail_out=z),(k=t.deflate(I,S))!==1&&k!==v)return this.onEnd(k),!(this.ended=!0);I.avail_out!==0&&(I.avail_in!==0||S!==4&&S!==2)||(this.options.to==="string"?this.onData(i.buf2binstring(n.shrinkBuf(I.output,I.next_out))):this.onData(n.shrinkBuf(I.output,I.next_out)))}while((0<I.avail_in||I.avail_out===0)&&k!==1);return S===4?(k=t.deflateEnd(this.strm),this.onEnd(k),this.ended=!0,k===v):S!==2||(this.onEnd(v),!(I.avail_out=0))},m.prototype.onData=function(y){this.chunks.push(y)},m.prototype.onEnd=function(y){y===v&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=y,this.msg=this.strm.msg},a.Deflate=m,a.deflate=g,a.deflateRaw=function(y,w){return(w=w||{}).raw=!0,g(y,w)},a.gzip=function(y,w){return(w=w||{}).gzip=!0,g(y,w)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(e,l,a){var t=e("./zlib/inflate"),n=e("./utils/common"),i=e("./utils/strings"),r=e("./zlib/constants"),u=e("./zlib/messages"),h=e("./zlib/zstream"),v=e("./zlib/gzheader"),p=Object.prototype.toString;function d(m){if(!(this instanceof d))return new d(m);this.options=n.assign({chunkSize:16384,windowBits:0,to:""},m||{});var g=this.options;g.raw&&0<=g.windowBits&&g.windowBits<16&&(g.windowBits=-g.windowBits,g.windowBits===0&&(g.windowBits=-15)),!(0<=g.windowBits&&g.windowBits<16)||m&&m.windowBits||(g.windowBits+=32),15<g.windowBits&&g.windowBits<48&&!(15&g.windowBits)&&(g.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new h,this.strm.avail_out=0;var y=t.inflateInit2(this.strm,g.windowBits);if(y!==r.Z_OK)throw new Error(u[y]);this.header=new v,t.inflateGetHeader(this.strm,this.header)}function b(m,g){var y=new d(g);if(y.push(m,!0),y.err)throw y.msg||u[y.err];return y.result}d.prototype.push=function(m,g){var y,w,k,S,I,z,M=this.strm,j=this.options.chunkSize,A=this.options.dictionary,F=!1;if(this.ended)return!1;w=g===~~g?g:g===!0?r.Z_FINISH:r.Z_NO_FLUSH,typeof m=="string"?M.input=i.binstring2buf(m):p.call(m)==="[object ArrayBuffer]"?M.input=new Uint8Array(m):M.input=m,M.next_in=0,M.avail_in=M.input.length;do{if(M.avail_out===0&&(M.output=new n.Buf8(j),M.next_out=0,M.avail_out=j),(y=t.inflate(M,r.Z_NO_FLUSH))===r.Z_NEED_DICT&&A&&(z=typeof A=="string"?i.string2buf(A):p.call(A)==="[object ArrayBuffer]"?new Uint8Array(A):A,y=t.inflateSetDictionary(this.strm,z)),y===r.Z_BUF_ERROR&&F===!0&&(y=r.Z_OK,F=!1),y!==r.Z_STREAM_END&&y!==r.Z_OK)return this.onEnd(y),!(this.ended=!0);M.next_out&&(M.avail_out!==0&&y!==r.Z_STREAM_END&&(M.avail_in!==0||w!==r.Z_FINISH&&w!==r.Z_SYNC_FLUSH)||(this.options.to==="string"?(k=i.utf8border(M.output,M.next_out),S=M.next_out-k,I=i.buf2string(M.output,k),M.next_out=S,M.avail_out=j-S,S&&n.arraySet(M.output,M.output,k,S,0),this.onData(I)):this.onData(n.shrinkBuf(M.output,M.next_out)))),M.avail_in===0&&M.avail_out===0&&(F=!0)}while((0<M.avail_in||M.avail_out===0)&&y!==r.Z_STREAM_END);return y===r.Z_STREAM_END&&(w=r.Z_FINISH),w===r.Z_FINISH?(y=t.inflateEnd(this.strm),this.onEnd(y),this.ended=!0,y===r.Z_OK):w!==r.Z_SYNC_FLUSH||(this.onEnd(r.Z_OK),!(M.avail_out=0))},d.prototype.onData=function(m){this.chunks.push(m)},d.prototype.onEnd=function(m){m===r.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=m,this.msg=this.strm.msg},a.Inflate=d,a.inflate=b,a.inflateRaw=function(m,g){return(g=g||{}).raw=!0,b(m,g)},a.ungzip=b},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(e,l,a){var t=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";a.assign=function(r){for(var u=Array.prototype.slice.call(arguments,1);u.length;){var h=u.shift();if(h){if(typeof h!="object")throw new TypeError(h+"must be non-object");for(var v in h)h.hasOwnProperty(v)&&(r[v]=h[v])}}return r},a.shrinkBuf=function(r,u){return r.length===u?r:r.subarray?r.subarray(0,u):(r.length=u,r)};var n={arraySet:function(r,u,h,v,p){if(u.subarray&&r.subarray)r.set(u.subarray(h,h+v),p);else for(var d=0;d<v;d++)r[p+d]=u[h+d]},flattenChunks:function(r){var u,h,v,p,d,b;for(u=v=0,h=r.length;u<h;u++)v+=r[u].length;for(b=new Uint8Array(v),u=p=0,h=r.length;u<h;u++)d=r[u],b.set(d,p),p+=d.length;return b}},i={arraySet:function(r,u,h,v,p){for(var d=0;d<v;d++)r[p+d]=u[h+d]},flattenChunks:function(r){return[].concat.apply([],r)}};a.setTyped=function(r){r?(a.Buf8=Uint8Array,a.Buf16=Uint16Array,a.Buf32=Int32Array,a.assign(a,n)):(a.Buf8=Array,a.Buf16=Array,a.Buf32=Array,a.assign(a,i))},a.setTyped(t)},{}],42:[function(e,l,a){var t=e("./common"),n=!0,i=!0;try{String.fromCharCode.apply(null,[0])}catch{n=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{i=!1}for(var r=new t.Buf8(256),u=0;u<256;u++)r[u]=252<=u?6:248<=u?5:240<=u?4:224<=u?3:192<=u?2:1;function h(v,p){if(p<65537&&(v.subarray&&i||!v.subarray&&n))return String.fromCharCode.apply(null,t.shrinkBuf(v,p));for(var d="",b=0;b<p;b++)d+=String.fromCharCode(v[b]);return d}r[254]=r[254]=1,a.string2buf=function(v){var p,d,b,m,g,y=v.length,w=0;for(m=0;m<y;m++)(64512&(d=v.charCodeAt(m)))==55296&&m+1<y&&(64512&(b=v.charCodeAt(m+1)))==56320&&(d=65536+(d-55296<<10)+(b-56320),m++),w+=d<128?1:d<2048?2:d<65536?3:4;for(p=new t.Buf8(w),m=g=0;g<w;m++)(64512&(d=v.charCodeAt(m)))==55296&&m+1<y&&(64512&(b=v.charCodeAt(m+1)))==56320&&(d=65536+(d-55296<<10)+(b-56320),m++),d<128?p[g++]=d:(d<2048?p[g++]=192|d>>>6:(d<65536?p[g++]=224|d>>>12:(p[g++]=240|d>>>18,p[g++]=128|d>>>12&63),p[g++]=128|d>>>6&63),p[g++]=128|63&d);return p},a.buf2binstring=function(v){return h(v,v.length)},a.binstring2buf=function(v){for(var p=new t.Buf8(v.length),d=0,b=p.length;d<b;d++)p[d]=v.charCodeAt(d);return p},a.buf2string=function(v,p){var d,b,m,g,y=p||v.length,w=new Array(2*y);for(d=b=0;d<y;)if((m=v[d++])<128)w[b++]=m;else if(4<(g=r[m]))w[b++]=65533,d+=g-1;else{for(m&=g===2?31:g===3?15:7;1<g&&d<y;)m=m<<6|63&v[d++],g--;1<g?w[b++]=65533:m<65536?w[b++]=m:(m-=65536,w[b++]=55296|m>>10&1023,w[b++]=56320|1023&m)}return h(w,b)},a.utf8border=function(v,p){var d;for((p=p||v.length)>v.length&&(p=v.length),d=p-1;0<=d&&(192&v[d])==128;)d--;return d<0||d===0?p:d+r[v[d]]>p?d:p}},{"./common":41}],43:[function(e,l,a){l.exports=function(t,n,i,r){for(var u=65535&t|0,h=t>>>16&65535|0,v=0;i!==0;){for(i-=v=2e3<i?2e3:i;h=h+(u=u+n[r++]|0)|0,--v;);u%=65521,h%=65521}return u|h<<16|0}},{}],44:[function(e,l,a){l.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(e,l,a){var t=function(){for(var n,i=[],r=0;r<256;r++){n=r;for(var u=0;u<8;u++)n=1&n?3988292384^n>>>1:n>>>1;i[r]=n}return i}();l.exports=function(n,i,r,u){var h=t,v=u+r;n^=-1;for(var p=u;p<v;p++)n=n>>>8^h[255&(n^i[p])];return-1^n}},{}],46:[function(e,l,a){var t,n=e("../utils/common"),i=e("./trees"),r=e("./adler32"),u=e("./crc32"),h=e("./messages"),v=0,p=4,d=0,b=-2,m=-1,g=4,y=2,w=8,k=9,S=286,I=30,z=19,M=2*S+1,j=15,A=3,F=258,Q=F+A+1,_=42,O=113,f=1,P=2,ue=3,Z=4;function fe(c,H){return c.msg=h[H],H}function $(c){return(c<<1)-(4<c?9:0)}function ne(c){for(var H=c.length;0<=--H;)c[H]=0}function B(c){var H=c.state,R=H.pending;R>c.avail_out&&(R=c.avail_out),R!==0&&(n.arraySet(c.output,H.pending_buf,H.pending_out,R,c.next_out),c.next_out+=R,H.pending_out+=R,c.total_out+=R,c.avail_out-=R,H.pending-=R,H.pending===0&&(H.pending_out=0))}function D(c,H){i._tr_flush_block(c,0<=c.block_start?c.block_start:-1,c.strstart-c.block_start,H),c.block_start=c.strstart,B(c.strm)}function re(c,H){c.pending_buf[c.pending++]=H}function te(c,H){c.pending_buf[c.pending++]=H>>>8&255,c.pending_buf[c.pending++]=255&H}function Y(c,H){var R,E,C=c.max_chain_length,x=c.strstart,U=c.prev_length,q=c.nice_match,N=c.strstart>c.w_size-Q?c.strstart-(c.w_size-Q):0,V=c.window,se=c.w_mask,J=c.prev,le=c.strstart+F,he=V[x+U-1],ye=V[x+U];c.prev_length>=c.good_match&&(C>>=2),q>c.lookahead&&(q=c.lookahead);do if(V[(R=H)+U]===ye&&V[R+U-1]===he&&V[R]===V[x]&&V[++R]===V[x+1]){x+=2,R++;do;while(V[++x]===V[++R]&&V[++x]===V[++R]&&V[++x]===V[++R]&&V[++x]===V[++R]&&V[++x]===V[++R]&&V[++x]===V[++R]&&V[++x]===V[++R]&&V[++x]===V[++R]&&x<le);if(E=F-(le-x),x=le-F,U<E){if(c.match_start=H,q<=(U=E))break;he=V[x+U-1],ye=V[x+U]}}while((H=J[H&se])>N&&--C!=0);return U<=c.lookahead?U:c.lookahead}function Te(c){var H,R,E,C,x,U,q,N,V,se,J=c.w_size;do{if(C=c.window_size-c.lookahead-c.strstart,c.strstart>=J+(J-Q)){for(n.arraySet(c.window,c.window,J,J,0),c.match_start-=J,c.strstart-=J,c.block_start-=J,H=R=c.hash_size;E=c.head[--H],c.head[H]=J<=E?E-J:0,--R;);for(H=R=J;E=c.prev[--H],c.prev[H]=J<=E?E-J:0,--R;);C+=J}if(c.strm.avail_in===0)break;if(U=c.strm,q=c.window,N=c.strstart+c.lookahead,V=C,se=void 0,se=U.avail_in,V<se&&(se=V),R=se===0?0:(U.avail_in-=se,n.arraySet(q,U.input,U.next_in,se,N),U.state.wrap===1?U.adler=r(U.adler,q,se,N):U.state.wrap===2&&(U.adler=u(U.adler,q,se,N)),U.next_in+=se,U.total_in+=se,se),c.lookahead+=R,c.lookahead+c.insert>=A)for(x=c.strstart-c.insert,c.ins_h=c.window[x],c.ins_h=(c.ins_h<<c.hash_shift^c.window[x+1])&c.hash_mask;c.insert&&(c.ins_h=(c.ins_h<<c.hash_shift^c.window[x+A-1])&c.hash_mask,c.prev[x&c.w_mask]=c.head[c.ins_h],c.head[c.ins_h]=x,x++,c.insert--,!(c.lookahead+c.insert<A)););}while(c.lookahead<Q&&c.strm.avail_in!==0)}function Ne(c,H){for(var R,E;;){if(c.lookahead<Q){if(Te(c),c.lookahead<Q&&H===v)return f;if(c.lookahead===0)break}if(R=0,c.lookahead>=A&&(c.ins_h=(c.ins_h<<c.hash_shift^c.window[c.strstart+A-1])&c.hash_mask,R=c.prev[c.strstart&c.w_mask]=c.head[c.ins_h],c.head[c.ins_h]=c.strstart),R!==0&&c.strstart-R<=c.w_size-Q&&(c.match_length=Y(c,R)),c.match_length>=A)if(E=i._tr_tally(c,c.strstart-c.match_start,c.match_length-A),c.lookahead-=c.match_length,c.match_length<=c.max_lazy_match&&c.lookahead>=A){for(c.match_length--;c.strstart++,c.ins_h=(c.ins_h<<c.hash_shift^c.window[c.strstart+A-1])&c.hash_mask,R=c.prev[c.strstart&c.w_mask]=c.head[c.ins_h],c.head[c.ins_h]=c.strstart,--c.match_length!=0;);c.strstart++}else c.strstart+=c.match_length,c.match_length=0,c.ins_h=c.window[c.strstart],c.ins_h=(c.ins_h<<c.hash_shift^c.window[c.strstart+1])&c.hash_mask;else E=i._tr_tally(c,0,c.window[c.strstart]),c.lookahead--,c.strstart++;if(E&&(D(c,!1),c.strm.avail_out===0))return f}return c.insert=c.strstart<A-1?c.strstart:A-1,H===p?(D(c,!0),c.strm.avail_out===0?ue:Z):c.last_lit&&(D(c,!1),c.strm.avail_out===0)?f:P}function be(c,H){for(var R,E,C;;){if(c.lookahead<Q){if(Te(c),c.lookahead<Q&&H===v)return f;if(c.lookahead===0)break}if(R=0,c.lookahead>=A&&(c.ins_h=(c.ins_h<<c.hash_shift^c.window[c.strstart+A-1])&c.hash_mask,R=c.prev[c.strstart&c.w_mask]=c.head[c.ins_h],c.head[c.ins_h]=c.strstart),c.prev_length=c.match_length,c.prev_match=c.match_start,c.match_length=A-1,R!==0&&c.prev_length<c.max_lazy_match&&c.strstart-R<=c.w_size-Q&&(c.match_length=Y(c,R),c.match_length<=5&&(c.strategy===1||c.match_length===A&&4096<c.strstart-c.match_start)&&(c.match_length=A-1)),c.prev_length>=A&&c.match_length<=c.prev_length){for(C=c.strstart+c.lookahead-A,E=i._tr_tally(c,c.strstart-1-c.prev_match,c.prev_length-A),c.lookahead-=c.prev_length-1,c.prev_length-=2;++c.strstart<=C&&(c.ins_h=(c.ins_h<<c.hash_shift^c.window[c.strstart+A-1])&c.hash_mask,R=c.prev[c.strstart&c.w_mask]=c.head[c.ins_h],c.head[c.ins_h]=c.strstart),--c.prev_length!=0;);if(c.match_available=0,c.match_length=A-1,c.strstart++,E&&(D(c,!1),c.strm.avail_out===0))return f}else if(c.match_available){if((E=i._tr_tally(c,0,c.window[c.strstart-1]))&&D(c,!1),c.strstart++,c.lookahead--,c.strm.avail_out===0)return f}else c.match_available=1,c.strstart++,c.lookahead--}return c.match_available&&(E=i._tr_tally(c,0,c.window[c.strstart-1]),c.match_available=0),c.insert=c.strstart<A-1?c.strstart:A-1,H===p?(D(c,!0),c.strm.avail_out===0?ue:Z):c.last_lit&&(D(c,!1),c.strm.avail_out===0)?f:P}function Ee(c,H,R,E,C){this.good_length=c,this.max_lazy=H,this.nice_length=R,this.max_chain=E,this.func=C}function Ae(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=w,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new n.Buf16(2*M),this.dyn_dtree=new n.Buf16(2*(2*I+1)),this.bl_tree=new n.Buf16(2*(2*z+1)),ne(this.dyn_ltree),ne(this.dyn_dtree),ne(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new n.Buf16(j+1),this.heap=new n.Buf16(2*S+1),ne(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new n.Buf16(2*S+1),ne(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function Be(c){var H;return c&&c.state?(c.total_in=c.total_out=0,c.data_type=y,(H=c.state).pending=0,H.pending_out=0,H.wrap<0&&(H.wrap=-H.wrap),H.status=H.wrap?_:O,c.adler=H.wrap===2?0:1,H.last_flush=v,i._tr_init(H),d):fe(c,b)}function Ke(c){var H=Be(c);return H===d&&function(R){R.window_size=2*R.w_size,ne(R.head),R.max_lazy_match=t[R.level].max_lazy,R.good_match=t[R.level].good_length,R.nice_match=t[R.level].nice_length,R.max_chain_length=t[R.level].max_chain,R.strstart=0,R.block_start=0,R.lookahead=0,R.insert=0,R.match_length=R.prev_length=A-1,R.match_available=0,R.ins_h=0}(c.state),H}function Je(c,H,R,E,C,x){if(!c)return b;var U=1;if(H===m&&(H=6),E<0?(U=0,E=-E):15<E&&(U=2,E-=16),C<1||k<C||R!==w||E<8||15<E||H<0||9<H||x<0||g<x)return fe(c,b);E===8&&(E=9);var q=new Ae;return(c.state=q).strm=c,q.wrap=U,q.gzhead=null,q.w_bits=E,q.w_size=1<<q.w_bits,q.w_mask=q.w_size-1,q.hash_bits=C+7,q.hash_size=1<<q.hash_bits,q.hash_mask=q.hash_size-1,q.hash_shift=~~((q.hash_bits+A-1)/A),q.window=new n.Buf8(2*q.w_size),q.head=new n.Buf16(q.hash_size),q.prev=new n.Buf16(q.w_size),q.lit_bufsize=1<<C+6,q.pending_buf_size=4*q.lit_bufsize,q.pending_buf=new n.Buf8(q.pending_buf_size),q.d_buf=1*q.lit_bufsize,q.l_buf=3*q.lit_bufsize,q.level=H,q.strategy=x,q.method=R,Ke(c)}t=[new Ee(0,0,0,0,function(c,H){var R=65535;for(R>c.pending_buf_size-5&&(R=c.pending_buf_size-5);;){if(c.lookahead<=1){if(Te(c),c.lookahead===0&&H===v)return f;if(c.lookahead===0)break}c.strstart+=c.lookahead,c.lookahead=0;var E=c.block_start+R;if((c.strstart===0||c.strstart>=E)&&(c.lookahead=c.strstart-E,c.strstart=E,D(c,!1),c.strm.avail_out===0)||c.strstart-c.block_start>=c.w_size-Q&&(D(c,!1),c.strm.avail_out===0))return f}return c.insert=0,H===p?(D(c,!0),c.strm.avail_out===0?ue:Z):(c.strstart>c.block_start&&(D(c,!1),c.strm.avail_out),f)}),new Ee(4,4,8,4,Ne),new Ee(4,5,16,8,Ne),new Ee(4,6,32,32,Ne),new Ee(4,4,16,16,be),new Ee(8,16,32,32,be),new Ee(8,16,128,128,be),new Ee(8,32,128,256,be),new Ee(32,128,258,1024,be),new Ee(32,258,258,4096,be)],a.deflateInit=function(c,H){return Je(c,H,w,15,8,0)},a.deflateInit2=Je,a.deflateReset=Ke,a.deflateResetKeep=Be,a.deflateSetHeader=function(c,H){return c&&c.state?c.state.wrap!==2?b:(c.state.gzhead=H,d):b},a.deflate=function(c,H){var R,E,C,x;if(!c||!c.state||5<H||H<0)return c?fe(c,b):b;if(E=c.state,!c.output||!c.input&&c.avail_in!==0||E.status===666&&H!==p)return fe(c,c.avail_out===0?-5:b);if(E.strm=c,R=E.last_flush,E.last_flush=H,E.status===_)if(E.wrap===2)c.adler=0,re(E,31),re(E,139),re(E,8),E.gzhead?(re(E,(E.gzhead.text?1:0)+(E.gzhead.hcrc?2:0)+(E.gzhead.extra?4:0)+(E.gzhead.name?8:0)+(E.gzhead.comment?16:0)),re(E,255&E.gzhead.time),re(E,E.gzhead.time>>8&255),re(E,E.gzhead.time>>16&255),re(E,E.gzhead.time>>24&255),re(E,E.level===9?2:2<=E.strategy||E.level<2?4:0),re(E,255&E.gzhead.os),E.gzhead.extra&&E.gzhead.extra.length&&(re(E,255&E.gzhead.extra.length),re(E,E.gzhead.extra.length>>8&255)),E.gzhead.hcrc&&(c.adler=u(c.adler,E.pending_buf,E.pending,0)),E.gzindex=0,E.status=69):(re(E,0),re(E,0),re(E,0),re(E,0),re(E,0),re(E,E.level===9?2:2<=E.strategy||E.level<2?4:0),re(E,3),E.status=O);else{var U=w+(E.w_bits-8<<4)<<8;U|=(2<=E.strategy||E.level<2?0:E.level<6?1:E.level===6?2:3)<<6,E.strstart!==0&&(U|=32),U+=31-U%31,E.status=O,te(E,U),E.strstart!==0&&(te(E,c.adler>>>16),te(E,65535&c.adler)),c.adler=1}if(E.status===69)if(E.gzhead.extra){for(C=E.pending;E.gzindex<(65535&E.gzhead.extra.length)&&(E.pending!==E.pending_buf_size||(E.gzhead.hcrc&&E.pending>C&&(c.adler=u(c.adler,E.pending_buf,E.pending-C,C)),B(c),C=E.pending,E.pending!==E.pending_buf_size));)re(E,255&E.gzhead.extra[E.gzindex]),E.gzindex++;E.gzhead.hcrc&&E.pending>C&&(c.adler=u(c.adler,E.pending_buf,E.pending-C,C)),E.gzindex===E.gzhead.extra.length&&(E.gzindex=0,E.status=73)}else E.status=73;if(E.status===73)if(E.gzhead.name){C=E.pending;do{if(E.pending===E.pending_buf_size&&(E.gzhead.hcrc&&E.pending>C&&(c.adler=u(c.adler,E.pending_buf,E.pending-C,C)),B(c),C=E.pending,E.pending===E.pending_buf_size)){x=1;break}x=E.gzindex<E.gzhead.name.length?255&E.gzhead.name.charCodeAt(E.gzindex++):0,re(E,x)}while(x!==0);E.gzhead.hcrc&&E.pending>C&&(c.adler=u(c.adler,E.pending_buf,E.pending-C,C)),x===0&&(E.gzindex=0,E.status=91)}else E.status=91;if(E.status===91)if(E.gzhead.comment){C=E.pending;do{if(E.pending===E.pending_buf_size&&(E.gzhead.hcrc&&E.pending>C&&(c.adler=u(c.adler,E.pending_buf,E.pending-C,C)),B(c),C=E.pending,E.pending===E.pending_buf_size)){x=1;break}x=E.gzindex<E.gzhead.comment.length?255&E.gzhead.comment.charCodeAt(E.gzindex++):0,re(E,x)}while(x!==0);E.gzhead.hcrc&&E.pending>C&&(c.adler=u(c.adler,E.pending_buf,E.pending-C,C)),x===0&&(E.status=103)}else E.status=103;if(E.status===103&&(E.gzhead.hcrc?(E.pending+2>E.pending_buf_size&&B(c),E.pending+2<=E.pending_buf_size&&(re(E,255&c.adler),re(E,c.adler>>8&255),c.adler=0,E.status=O)):E.status=O),E.pending!==0){if(B(c),c.avail_out===0)return E.last_flush=-1,d}else if(c.avail_in===0&&$(H)<=$(R)&&H!==p)return fe(c,-5);if(E.status===666&&c.avail_in!==0)return fe(c,-5);if(c.avail_in!==0||E.lookahead!==0||H!==v&&E.status!==666){var q=E.strategy===2?function(N,V){for(var se;;){if(N.lookahead===0&&(Te(N),N.lookahead===0)){if(V===v)return f;break}if(N.match_length=0,se=i._tr_tally(N,0,N.window[N.strstart]),N.lookahead--,N.strstart++,se&&(D(N,!1),N.strm.avail_out===0))return f}return N.insert=0,V===p?(D(N,!0),N.strm.avail_out===0?ue:Z):N.last_lit&&(D(N,!1),N.strm.avail_out===0)?f:P}(E,H):E.strategy===3?function(N,V){for(var se,J,le,he,ye=N.window;;){if(N.lookahead<=F){if(Te(N),N.lookahead<=F&&V===v)return f;if(N.lookahead===0)break}if(N.match_length=0,N.lookahead>=A&&0<N.strstart&&(J=ye[le=N.strstart-1])===ye[++le]&&J===ye[++le]&&J===ye[++le]){he=N.strstart+F;do;while(J===ye[++le]&&J===ye[++le]&&J===ye[++le]&&J===ye[++le]&&J===ye[++le]&&J===ye[++le]&&J===ye[++le]&&J===ye[++le]&&le<he);N.match_length=F-(he-le),N.match_length>N.lookahead&&(N.match_length=N.lookahead)}if(N.match_length>=A?(se=i._tr_tally(N,1,N.match_length-A),N.lookahead-=N.match_length,N.strstart+=N.match_length,N.match_length=0):(se=i._tr_tally(N,0,N.window[N.strstart]),N.lookahead--,N.strstart++),se&&(D(N,!1),N.strm.avail_out===0))return f}return N.insert=0,V===p?(D(N,!0),N.strm.avail_out===0?ue:Z):N.last_lit&&(D(N,!1),N.strm.avail_out===0)?f:P}(E,H):t[E.level].func(E,H);if(q!==ue&&q!==Z||(E.status=666),q===f||q===ue)return c.avail_out===0&&(E.last_flush=-1),d;if(q===P&&(H===1?i._tr_align(E):H!==5&&(i._tr_stored_block(E,0,0,!1),H===3&&(ne(E.head),E.lookahead===0&&(E.strstart=0,E.block_start=0,E.insert=0))),B(c),c.avail_out===0))return E.last_flush=-1,d}return H!==p?d:E.wrap<=0?1:(E.wrap===2?(re(E,255&c.adler),re(E,c.adler>>8&255),re(E,c.adler>>16&255),re(E,c.adler>>24&255),re(E,255&c.total_in),re(E,c.total_in>>8&255),re(E,c.total_in>>16&255),re(E,c.total_in>>24&255)):(te(E,c.adler>>>16),te(E,65535&c.adler)),B(c),0<E.wrap&&(E.wrap=-E.wrap),E.pending!==0?d:1)},a.deflateEnd=function(c){var H;return c&&c.state?(H=c.state.status)!==_&&H!==69&&H!==73&&H!==91&&H!==103&&H!==O&&H!==666?fe(c,b):(c.state=null,H===O?fe(c,-3):d):b},a.deflateSetDictionary=function(c,H){var R,E,C,x,U,q,N,V,se=H.length;if(!c||!c.state||(x=(R=c.state).wrap)===2||x===1&&R.status!==_||R.lookahead)return b;for(x===1&&(c.adler=r(c.adler,H,se,0)),R.wrap=0,se>=R.w_size&&(x===0&&(ne(R.head),R.strstart=0,R.block_start=0,R.insert=0),V=new n.Buf8(R.w_size),n.arraySet(V,H,se-R.w_size,R.w_size,0),H=V,se=R.w_size),U=c.avail_in,q=c.next_in,N=c.input,c.avail_in=se,c.next_in=0,c.input=H,Te(R);R.lookahead>=A;){for(E=R.strstart,C=R.lookahead-(A-1);R.ins_h=(R.ins_h<<R.hash_shift^R.window[E+A-1])&R.hash_mask,R.prev[E&R.w_mask]=R.head[R.ins_h],R.head[R.ins_h]=E,E++,--C;);R.strstart=E,R.lookahead=A-1,Te(R)}return R.strstart+=R.lookahead,R.block_start=R.strstart,R.insert=R.lookahead,R.lookahead=0,R.match_length=R.prev_length=A-1,R.match_available=0,c.next_in=q,c.input=N,c.avail_in=U,R.wrap=x,d},a.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(e,l,a){l.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(e,l,a){l.exports=function(t,n){var i,r,u,h,v,p,d,b,m,g,y,w,k,S,I,z,M,j,A,F,Q,_,O,f,P;i=t.state,r=t.next_in,f=t.input,u=r+(t.avail_in-5),h=t.next_out,P=t.output,v=h-(n-t.avail_out),p=h+(t.avail_out-257),d=i.dmax,b=i.wsize,m=i.whave,g=i.wnext,y=i.window,w=i.hold,k=i.bits,S=i.lencode,I=i.distcode,z=(1<<i.lenbits)-1,M=(1<<i.distbits)-1;e:do{k<15&&(w+=f[r++]<<k,k+=8,w+=f[r++]<<k,k+=8),j=S[w&z];t:for(;;){if(w>>>=A=j>>>24,k-=A,(A=j>>>16&255)===0)P[h++]=65535&j;else{if(!(16&A)){if(!(64&A)){j=S[(65535&j)+(w&(1<<A)-1)];continue t}if(32&A){i.mode=12;break e}t.msg="invalid literal/length code",i.mode=30;break e}F=65535&j,(A&=15)&&(k<A&&(w+=f[r++]<<k,k+=8),F+=w&(1<<A)-1,w>>>=A,k-=A),k<15&&(w+=f[r++]<<k,k+=8,w+=f[r++]<<k,k+=8),j=I[w&M];n:for(;;){if(w>>>=A=j>>>24,k-=A,!(16&(A=j>>>16&255))){if(!(64&A)){j=I[(65535&j)+(w&(1<<A)-1)];continue n}t.msg="invalid distance code",i.mode=30;break e}if(Q=65535&j,k<(A&=15)&&(w+=f[r++]<<k,(k+=8)<A&&(w+=f[r++]<<k,k+=8)),d<(Q+=w&(1<<A)-1)){t.msg="invalid distance too far back",i.mode=30;break e}if(w>>>=A,k-=A,(A=h-v)<Q){if(m<(A=Q-A)&&i.sane){t.msg="invalid distance too far back",i.mode=30;break e}if(O=y,(_=0)===g){if(_+=b-A,A<F){for(F-=A;P[h++]=y[_++],--A;);_=h-Q,O=P}}else if(g<A){if(_+=b+g-A,(A-=g)<F){for(F-=A;P[h++]=y[_++],--A;);if(_=0,g<F){for(F-=A=g;P[h++]=y[_++],--A;);_=h-Q,O=P}}}else if(_+=g-A,A<F){for(F-=A;P[h++]=y[_++],--A;);_=h-Q,O=P}for(;2<F;)P[h++]=O[_++],P[h++]=O[_++],P[h++]=O[_++],F-=3;F&&(P[h++]=O[_++],1<F&&(P[h++]=O[_++]))}else{for(_=h-Q;P[h++]=P[_++],P[h++]=P[_++],P[h++]=P[_++],2<(F-=3););F&&(P[h++]=P[_++],1<F&&(P[h++]=P[_++]))}break}}break}}while(r<u&&h<p);r-=F=k>>3,w&=(1<<(k-=F<<3))-1,t.next_in=r,t.next_out=h,t.avail_in=r<u?u-r+5:5-(r-u),t.avail_out=h<p?p-h+257:257-(h-p),i.hold=w,i.bits=k}},{}],49:[function(e,l,a){var t=e("../utils/common"),n=e("./adler32"),i=e("./crc32"),r=e("./inffast"),u=e("./inftrees"),h=1,v=2,p=0,d=-2,b=1,m=852,g=592;function y(_){return(_>>>24&255)+(_>>>8&65280)+((65280&_)<<8)+((255&_)<<24)}function w(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new t.Buf16(320),this.work=new t.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function k(_){var O;return _&&_.state?(O=_.state,_.total_in=_.total_out=O.total=0,_.msg="",O.wrap&&(_.adler=1&O.wrap),O.mode=b,O.last=0,O.havedict=0,O.dmax=32768,O.head=null,O.hold=0,O.bits=0,O.lencode=O.lendyn=new t.Buf32(m),O.distcode=O.distdyn=new t.Buf32(g),O.sane=1,O.back=-1,p):d}function S(_){var O;return _&&_.state?((O=_.state).wsize=0,O.whave=0,O.wnext=0,k(_)):d}function I(_,O){var f,P;return _&&_.state?(P=_.state,O<0?(f=0,O=-O):(f=1+(O>>4),O<48&&(O&=15)),O&&(O<8||15<O)?d:(P.window!==null&&P.wbits!==O&&(P.window=null),P.wrap=f,P.wbits=O,S(_))):d}function z(_,O){var f,P;return _?(P=new w,(_.state=P).window=null,(f=I(_,O))!==p&&(_.state=null),f):d}var M,j,A=!0;function F(_){if(A){var O;for(M=new t.Buf32(512),j=new t.Buf32(32),O=0;O<144;)_.lens[O++]=8;for(;O<256;)_.lens[O++]=9;for(;O<280;)_.lens[O++]=7;for(;O<288;)_.lens[O++]=8;for(u(h,_.lens,0,288,M,0,_.work,{bits:9}),O=0;O<32;)_.lens[O++]=5;u(v,_.lens,0,32,j,0,_.work,{bits:5}),A=!1}_.lencode=M,_.lenbits=9,_.distcode=j,_.distbits=5}function Q(_,O,f,P){var ue,Z=_.state;return Z.window===null&&(Z.wsize=1<<Z.wbits,Z.wnext=0,Z.whave=0,Z.window=new t.Buf8(Z.wsize)),P>=Z.wsize?(t.arraySet(Z.window,O,f-Z.wsize,Z.wsize,0),Z.wnext=0,Z.whave=Z.wsize):(P<(ue=Z.wsize-Z.wnext)&&(ue=P),t.arraySet(Z.window,O,f-P,ue,Z.wnext),(P-=ue)?(t.arraySet(Z.window,O,f-P,P,0),Z.wnext=P,Z.whave=Z.wsize):(Z.wnext+=ue,Z.wnext===Z.wsize&&(Z.wnext=0),Z.whave<Z.wsize&&(Z.whave+=ue))),0}a.inflateReset=S,a.inflateReset2=I,a.inflateResetKeep=k,a.inflateInit=function(_){return z(_,15)},a.inflateInit2=z,a.inflate=function(_,O){var f,P,ue,Z,fe,$,ne,B,D,re,te,Y,Te,Ne,be,Ee,Ae,Be,Ke,Je,c,H,R,E,C=0,x=new t.Buf8(4),U=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!_||!_.state||!_.output||!_.input&&_.avail_in!==0)return d;(f=_.state).mode===12&&(f.mode=13),fe=_.next_out,ue=_.output,ne=_.avail_out,Z=_.next_in,P=_.input,$=_.avail_in,B=f.hold,D=f.bits,re=$,te=ne,H=p;e:for(;;)switch(f.mode){case b:if(f.wrap===0){f.mode=13;break}for(;D<16;){if($===0)break e;$--,B+=P[Z++]<<D,D+=8}if(2&f.wrap&&B===35615){x[f.check=0]=255&B,x[1]=B>>>8&255,f.check=i(f.check,x,2,0),D=B=0,f.mode=2;break}if(f.flags=0,f.head&&(f.head.done=!1),!(1&f.wrap)||(((255&B)<<8)+(B>>8))%31){_.msg="incorrect header check",f.mode=30;break}if((15&B)!=8){_.msg="unknown compression method",f.mode=30;break}if(D-=4,c=8+(15&(B>>>=4)),f.wbits===0)f.wbits=c;else if(c>f.wbits){_.msg="invalid window size",f.mode=30;break}f.dmax=1<<c,_.adler=f.check=1,f.mode=512&B?10:12,D=B=0;break;case 2:for(;D<16;){if($===0)break e;$--,B+=P[Z++]<<D,D+=8}if(f.flags=B,(255&f.flags)!=8){_.msg="unknown compression method",f.mode=30;break}if(57344&f.flags){_.msg="unknown header flags set",f.mode=30;break}f.head&&(f.head.text=B>>8&1),512&f.flags&&(x[0]=255&B,x[1]=B>>>8&255,f.check=i(f.check,x,2,0)),D=B=0,f.mode=3;case 3:for(;D<32;){if($===0)break e;$--,B+=P[Z++]<<D,D+=8}f.head&&(f.head.time=B),512&f.flags&&(x[0]=255&B,x[1]=B>>>8&255,x[2]=B>>>16&255,x[3]=B>>>24&255,f.check=i(f.check,x,4,0)),D=B=0,f.mode=4;case 4:for(;D<16;){if($===0)break e;$--,B+=P[Z++]<<D,D+=8}f.head&&(f.head.xflags=255&B,f.head.os=B>>8),512&f.flags&&(x[0]=255&B,x[1]=B>>>8&255,f.check=i(f.check,x,2,0)),D=B=0,f.mode=5;case 5:if(1024&f.flags){for(;D<16;){if($===0)break e;$--,B+=P[Z++]<<D,D+=8}f.length=B,f.head&&(f.head.extra_len=B),512&f.flags&&(x[0]=255&B,x[1]=B>>>8&255,f.check=i(f.check,x,2,0)),D=B=0}else f.head&&(f.head.extra=null);f.mode=6;case 6:if(1024&f.flags&&($<(Y=f.length)&&(Y=$),Y&&(f.head&&(c=f.head.extra_len-f.length,f.head.extra||(f.head.extra=new Array(f.head.extra_len)),t.arraySet(f.head.extra,P,Z,Y,c)),512&f.flags&&(f.check=i(f.check,P,Y,Z)),$-=Y,Z+=Y,f.length-=Y),f.length))break e;f.length=0,f.mode=7;case 7:if(2048&f.flags){if($===0)break e;for(Y=0;c=P[Z+Y++],f.head&&c&&f.length<65536&&(f.head.name+=String.fromCharCode(c)),c&&Y<$;);if(512&f.flags&&(f.check=i(f.check,P,Y,Z)),$-=Y,Z+=Y,c)break e}else f.head&&(f.head.name=null);f.length=0,f.mode=8;case 8:if(4096&f.flags){if($===0)break e;for(Y=0;c=P[Z+Y++],f.head&&c&&f.length<65536&&(f.head.comment+=String.fromCharCode(c)),c&&Y<$;);if(512&f.flags&&(f.check=i(f.check,P,Y,Z)),$-=Y,Z+=Y,c)break e}else f.head&&(f.head.comment=null);f.mode=9;case 9:if(512&f.flags){for(;D<16;){if($===0)break e;$--,B+=P[Z++]<<D,D+=8}if(B!==(65535&f.check)){_.msg="header crc mismatch",f.mode=30;break}D=B=0}f.head&&(f.head.hcrc=f.flags>>9&1,f.head.done=!0),_.adler=f.check=0,f.mode=12;break;case 10:for(;D<32;){if($===0)break e;$--,B+=P[Z++]<<D,D+=8}_.adler=f.check=y(B),D=B=0,f.mode=11;case 11:if(f.havedict===0)return _.next_out=fe,_.avail_out=ne,_.next_in=Z,_.avail_in=$,f.hold=B,f.bits=D,2;_.adler=f.check=1,f.mode=12;case 12:if(O===5||O===6)break e;case 13:if(f.last){B>>>=7&D,D-=7&D,f.mode=27;break}for(;D<3;){if($===0)break e;$--,B+=P[Z++]<<D,D+=8}switch(f.last=1&B,D-=1,3&(B>>>=1)){case 0:f.mode=14;break;case 1:if(F(f),f.mode=20,O!==6)break;B>>>=2,D-=2;break e;case 2:f.mode=17;break;case 3:_.msg="invalid block type",f.mode=30}B>>>=2,D-=2;break;case 14:for(B>>>=7&D,D-=7&D;D<32;){if($===0)break e;$--,B+=P[Z++]<<D,D+=8}if((65535&B)!=(B>>>16^65535)){_.msg="invalid stored block lengths",f.mode=30;break}if(f.length=65535&B,D=B=0,f.mode=15,O===6)break e;case 15:f.mode=16;case 16:if(Y=f.length){if($<Y&&(Y=$),ne<Y&&(Y=ne),Y===0)break e;t.arraySet(ue,P,Z,Y,fe),$-=Y,Z+=Y,ne-=Y,fe+=Y,f.length-=Y;break}f.mode=12;break;case 17:for(;D<14;){if($===0)break e;$--,B+=P[Z++]<<D,D+=8}if(f.nlen=257+(31&B),B>>>=5,D-=5,f.ndist=1+(31&B),B>>>=5,D-=5,f.ncode=4+(15&B),B>>>=4,D-=4,286<f.nlen||30<f.ndist){_.msg="too many length or distance symbols",f.mode=30;break}f.have=0,f.mode=18;case 18:for(;f.have<f.ncode;){for(;D<3;){if($===0)break e;$--,B+=P[Z++]<<D,D+=8}f.lens[U[f.have++]]=7&B,B>>>=3,D-=3}for(;f.have<19;)f.lens[U[f.have++]]=0;if(f.lencode=f.lendyn,f.lenbits=7,R={bits:f.lenbits},H=u(0,f.lens,0,19,f.lencode,0,f.work,R),f.lenbits=R.bits,H){_.msg="invalid code lengths set",f.mode=30;break}f.have=0,f.mode=19;case 19:for(;f.have<f.nlen+f.ndist;){for(;Ee=(C=f.lencode[B&(1<<f.lenbits)-1])>>>16&255,Ae=65535&C,!((be=C>>>24)<=D);){if($===0)break e;$--,B+=P[Z++]<<D,D+=8}if(Ae<16)B>>>=be,D-=be,f.lens[f.have++]=Ae;else{if(Ae===16){for(E=be+2;D<E;){if($===0)break e;$--,B+=P[Z++]<<D,D+=8}if(B>>>=be,D-=be,f.have===0){_.msg="invalid bit length repeat",f.mode=30;break}c=f.lens[f.have-1],Y=3+(3&B),B>>>=2,D-=2}else if(Ae===17){for(E=be+3;D<E;){if($===0)break e;$--,B+=P[Z++]<<D,D+=8}D-=be,c=0,Y=3+(7&(B>>>=be)),B>>>=3,D-=3}else{for(E=be+7;D<E;){if($===0)break e;$--,B+=P[Z++]<<D,D+=8}D-=be,c=0,Y=11+(127&(B>>>=be)),B>>>=7,D-=7}if(f.have+Y>f.nlen+f.ndist){_.msg="invalid bit length repeat",f.mode=30;break}for(;Y--;)f.lens[f.have++]=c}}if(f.mode===30)break;if(f.lens[256]===0){_.msg="invalid code -- missing end-of-block",f.mode=30;break}if(f.lenbits=9,R={bits:f.lenbits},H=u(h,f.lens,0,f.nlen,f.lencode,0,f.work,R),f.lenbits=R.bits,H){_.msg="invalid literal/lengths set",f.mode=30;break}if(f.distbits=6,f.distcode=f.distdyn,R={bits:f.distbits},H=u(v,f.lens,f.nlen,f.ndist,f.distcode,0,f.work,R),f.distbits=R.bits,H){_.msg="invalid distances set",f.mode=30;break}if(f.mode=20,O===6)break e;case 20:f.mode=21;case 21:if(6<=$&&258<=ne){_.next_out=fe,_.avail_out=ne,_.next_in=Z,_.avail_in=$,f.hold=B,f.bits=D,r(_,te),fe=_.next_out,ue=_.output,ne=_.avail_out,Z=_.next_in,P=_.input,$=_.avail_in,B=f.hold,D=f.bits,f.mode===12&&(f.back=-1);break}for(f.back=0;Ee=(C=f.lencode[B&(1<<f.lenbits)-1])>>>16&255,Ae=65535&C,!((be=C>>>24)<=D);){if($===0)break e;$--,B+=P[Z++]<<D,D+=8}if(Ee&&!(240&Ee)){for(Be=be,Ke=Ee,Je=Ae;Ee=(C=f.lencode[Je+((B&(1<<Be+Ke)-1)>>Be)])>>>16&255,Ae=65535&C,!(Be+(be=C>>>24)<=D);){if($===0)break e;$--,B+=P[Z++]<<D,D+=8}B>>>=Be,D-=Be,f.back+=Be}if(B>>>=be,D-=be,f.back+=be,f.length=Ae,Ee===0){f.mode=26;break}if(32&Ee){f.back=-1,f.mode=12;break}if(64&Ee){_.msg="invalid literal/length code",f.mode=30;break}f.extra=15&Ee,f.mode=22;case 22:if(f.extra){for(E=f.extra;D<E;){if($===0)break e;$--,B+=P[Z++]<<D,D+=8}f.length+=B&(1<<f.extra)-1,B>>>=f.extra,D-=f.extra,f.back+=f.extra}f.was=f.length,f.mode=23;case 23:for(;Ee=(C=f.distcode[B&(1<<f.distbits)-1])>>>16&255,Ae=65535&C,!((be=C>>>24)<=D);){if($===0)break e;$--,B+=P[Z++]<<D,D+=8}if(!(240&Ee)){for(Be=be,Ke=Ee,Je=Ae;Ee=(C=f.distcode[Je+((B&(1<<Be+Ke)-1)>>Be)])>>>16&255,Ae=65535&C,!(Be+(be=C>>>24)<=D);){if($===0)break e;$--,B+=P[Z++]<<D,D+=8}B>>>=Be,D-=Be,f.back+=Be}if(B>>>=be,D-=be,f.back+=be,64&Ee){_.msg="invalid distance code",f.mode=30;break}f.offset=Ae,f.extra=15&Ee,f.mode=24;case 24:if(f.extra){for(E=f.extra;D<E;){if($===0)break e;$--,B+=P[Z++]<<D,D+=8}f.offset+=B&(1<<f.extra)-1,B>>>=f.extra,D-=f.extra,f.back+=f.extra}if(f.offset>f.dmax){_.msg="invalid distance too far back",f.mode=30;break}f.mode=25;case 25:if(ne===0)break e;if(Y=te-ne,f.offset>Y){if((Y=f.offset-Y)>f.whave&&f.sane){_.msg="invalid distance too far back",f.mode=30;break}Te=Y>f.wnext?(Y-=f.wnext,f.wsize-Y):f.wnext-Y,Y>f.length&&(Y=f.length),Ne=f.window}else Ne=ue,Te=fe-f.offset,Y=f.length;for(ne<Y&&(Y=ne),ne-=Y,f.length-=Y;ue[fe++]=Ne[Te++],--Y;);f.length===0&&(f.mode=21);break;case 26:if(ne===0)break e;ue[fe++]=f.length,ne--,f.mode=21;break;case 27:if(f.wrap){for(;D<32;){if($===0)break e;$--,B|=P[Z++]<<D,D+=8}if(te-=ne,_.total_out+=te,f.total+=te,te&&(_.adler=f.check=f.flags?i(f.check,ue,te,fe-te):n(f.check,ue,te,fe-te)),te=ne,(f.flags?B:y(B))!==f.check){_.msg="incorrect data check",f.mode=30;break}D=B=0}f.mode=28;case 28:if(f.wrap&&f.flags){for(;D<32;){if($===0)break e;$--,B+=P[Z++]<<D,D+=8}if(B!==(4294967295&f.total)){_.msg="incorrect length check",f.mode=30;break}D=B=0}f.mode=29;case 29:H=1;break e;case 30:H=-3;break e;case 31:return-4;case 32:default:return d}return _.next_out=fe,_.avail_out=ne,_.next_in=Z,_.avail_in=$,f.hold=B,f.bits=D,(f.wsize||te!==_.avail_out&&f.mode<30&&(f.mode<27||O!==4))&&Q(_,_.output,_.next_out,te-_.avail_out)?(f.mode=31,-4):(re-=_.avail_in,te-=_.avail_out,_.total_in+=re,_.total_out+=te,f.total+=te,f.wrap&&te&&(_.adler=f.check=f.flags?i(f.check,ue,te,_.next_out-te):n(f.check,ue,te,_.next_out-te)),_.data_type=f.bits+(f.last?64:0)+(f.mode===12?128:0)+(f.mode===20||f.mode===15?256:0),(re==0&&te===0||O===4)&&H===p&&(H=-5),H)},a.inflateEnd=function(_){if(!_||!_.state)return d;var O=_.state;return O.window&&(O.window=null),_.state=null,p},a.inflateGetHeader=function(_,O){var f;return _&&_.state&&2&(f=_.state).wrap?((f.head=O).done=!1,p):d},a.inflateSetDictionary=function(_,O){var f,P=O.length;return _&&_.state?(f=_.state).wrap!==0&&f.mode!==11?d:f.mode===11&&n(1,O,P,0)!==f.check?-3:Q(_,O,P,P)?(f.mode=31,-4):(f.havedict=1,p):d},a.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(e,l,a){var t=e("../utils/common"),n=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],i=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],r=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],u=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];l.exports=function(h,v,p,d,b,m,g,y){var w,k,S,I,z,M,j,A,F,Q=y.bits,_=0,O=0,f=0,P=0,ue=0,Z=0,fe=0,$=0,ne=0,B=0,D=null,re=0,te=new t.Buf16(16),Y=new t.Buf16(16),Te=null,Ne=0;for(_=0;_<=15;_++)te[_]=0;for(O=0;O<d;O++)te[v[p+O]]++;for(ue=Q,P=15;1<=P&&te[P]===0;P--);if(P<ue&&(ue=P),P===0)return b[m++]=20971520,b[m++]=20971520,y.bits=1,0;for(f=1;f<P&&te[f]===0;f++);for(ue<f&&(ue=f),_=$=1;_<=15;_++)if($<<=1,($-=te[_])<0)return-1;if(0<$&&(h===0||P!==1))return-1;for(Y[1]=0,_=1;_<15;_++)Y[_+1]=Y[_]+te[_];for(O=0;O<d;O++)v[p+O]!==0&&(g[Y[v[p+O]]++]=O);if(M=h===0?(D=Te=g,19):h===1?(D=n,re-=257,Te=i,Ne-=257,256):(D=r,Te=u,-1),_=f,z=m,fe=O=B=0,S=-1,I=(ne=1<<(Z=ue))-1,h===1&&852<ne||h===2&&592<ne)return 1;for(;;){for(j=_-fe,F=g[O]<M?(A=0,g[O]):g[O]>M?(A=Te[Ne+g[O]],D[re+g[O]]):(A=96,0),w=1<<_-fe,f=k=1<<Z;b[z+(B>>fe)+(k-=w)]=j<<24|A<<16|F|0,k!==0;);for(w=1<<_-1;B&w;)w>>=1;if(w!==0?(B&=w-1,B+=w):B=0,O++,--te[_]==0){if(_===P)break;_=v[p+g[O]]}if(ue<_&&(B&I)!==S){for(fe===0&&(fe=ue),z+=f,$=1<<(Z=_-fe);Z+fe<P&&!(($-=te[Z+fe])<=0);)Z++,$<<=1;if(ne+=1<<Z,h===1&&852<ne||h===2&&592<ne)return 1;b[S=B&I]=ue<<24|Z<<16|z-m|0}}return B!==0&&(b[z+B]=_-fe<<24|64<<16|0),y.bits=ue,0}},{"../utils/common":41}],51:[function(e,l,a){l.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(e,l,a){var t=e("../utils/common"),n=0,i=1;function r(C){for(var x=C.length;0<=--x;)C[x]=0}var u=0,h=29,v=256,p=v+1+h,d=30,b=19,m=2*p+1,g=15,y=16,w=7,k=256,S=16,I=17,z=18,M=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],j=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],A=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],F=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Q=new Array(2*(p+2));r(Q);var _=new Array(2*d);r(_);var O=new Array(512);r(O);var f=new Array(256);r(f);var P=new Array(h);r(P);var ue,Z,fe,$=new Array(d);function ne(C,x,U,q,N){this.static_tree=C,this.extra_bits=x,this.extra_base=U,this.elems=q,this.max_length=N,this.has_stree=C&&C.length}function B(C,x){this.dyn_tree=C,this.max_code=0,this.stat_desc=x}function D(C){return C<256?O[C]:O[256+(C>>>7)]}function re(C,x){C.pending_buf[C.pending++]=255&x,C.pending_buf[C.pending++]=x>>>8&255}function te(C,x,U){C.bi_valid>y-U?(C.bi_buf|=x<<C.bi_valid&65535,re(C,C.bi_buf),C.bi_buf=x>>y-C.bi_valid,C.bi_valid+=U-y):(C.bi_buf|=x<<C.bi_valid&65535,C.bi_valid+=U)}function Y(C,x,U){te(C,U[2*x],U[2*x+1])}function Te(C,x){for(var U=0;U|=1&C,C>>>=1,U<<=1,0<--x;);return U>>>1}function Ne(C,x,U){var q,N,V=new Array(g+1),se=0;for(q=1;q<=g;q++)V[q]=se=se+U[q-1]<<1;for(N=0;N<=x;N++){var J=C[2*N+1];J!==0&&(C[2*N]=Te(V[J]++,J))}}function be(C){var x;for(x=0;x<p;x++)C.dyn_ltree[2*x]=0;for(x=0;x<d;x++)C.dyn_dtree[2*x]=0;for(x=0;x<b;x++)C.bl_tree[2*x]=0;C.dyn_ltree[2*k]=1,C.opt_len=C.static_len=0,C.last_lit=C.matches=0}function Ee(C){8<C.bi_valid?re(C,C.bi_buf):0<C.bi_valid&&(C.pending_buf[C.pending++]=C.bi_buf),C.bi_buf=0,C.bi_valid=0}function Ae(C,x,U,q){var N=2*x,V=2*U;return C[N]<C[V]||C[N]===C[V]&&q[x]<=q[U]}function Be(C,x,U){for(var q=C.heap[U],N=U<<1;N<=C.heap_len&&(N<C.heap_len&&Ae(x,C.heap[N+1],C.heap[N],C.depth)&&N++,!Ae(x,q,C.heap[N],C.depth));)C.heap[U]=C.heap[N],U=N,N<<=1;C.heap[U]=q}function Ke(C,x,U){var q,N,V,se,J=0;if(C.last_lit!==0)for(;q=C.pending_buf[C.d_buf+2*J]<<8|C.pending_buf[C.d_buf+2*J+1],N=C.pending_buf[C.l_buf+J],J++,q===0?Y(C,N,x):(Y(C,(V=f[N])+v+1,x),(se=M[V])!==0&&te(C,N-=P[V],se),Y(C,V=D(--q),U),(se=j[V])!==0&&te(C,q-=$[V],se)),J<C.last_lit;);Y(C,k,x)}function Je(C,x){var U,q,N,V=x.dyn_tree,se=x.stat_desc.static_tree,J=x.stat_desc.has_stree,le=x.stat_desc.elems,he=-1;for(C.heap_len=0,C.heap_max=m,U=0;U<le;U++)V[2*U]!==0?(C.heap[++C.heap_len]=he=U,C.depth[U]=0):V[2*U+1]=0;for(;C.heap_len<2;)V[2*(N=C.heap[++C.heap_len]=he<2?++he:0)]=1,C.depth[N]=0,C.opt_len--,J&&(C.static_len-=se[2*N+1]);for(x.max_code=he,U=C.heap_len>>1;1<=U;U--)Be(C,V,U);for(N=le;U=C.heap[1],C.heap[1]=C.heap[C.heap_len--],Be(C,V,1),q=C.heap[1],C.heap[--C.heap_max]=U,C.heap[--C.heap_max]=q,V[2*N]=V[2*U]+V[2*q],C.depth[N]=(C.depth[U]>=C.depth[q]?C.depth[U]:C.depth[q])+1,V[2*U+1]=V[2*q+1]=N,C.heap[1]=N++,Be(C,V,1),2<=C.heap_len;);C.heap[--C.heap_max]=C.heap[1],function(ye,Ze){var ft,qe,yt,De,kt,zt,Qe=Ze.dyn_tree,on=Ze.max_code,dt=Ze.stat_desc.static_tree,cn=Ze.stat_desc.has_stree,$t=Ze.stat_desc.extra_bits,ln=Ze.stat_desc.extra_base,mt=Ze.stat_desc.max_length,St=0;for(De=0;De<=g;De++)ye.bl_count[De]=0;for(Qe[2*ye.heap[ye.heap_max]+1]=0,ft=ye.heap_max+1;ft<m;ft++)mt<(De=Qe[2*Qe[2*(qe=ye.heap[ft])+1]+1]+1)&&(De=mt,St++),Qe[2*qe+1]=De,on<qe||(ye.bl_count[De]++,kt=0,ln<=qe&&(kt=$t[qe-ln]),zt=Qe[2*qe],ye.opt_len+=zt*(De+kt),cn&&(ye.static_len+=zt*(dt[2*qe+1]+kt)));if(St!==0){do{for(De=mt-1;ye.bl_count[De]===0;)De--;ye.bl_count[De]--,ye.bl_count[De+1]+=2,ye.bl_count[mt]--,St-=2}while(0<St);for(De=mt;De!==0;De--)for(qe=ye.bl_count[De];qe!==0;)on<(yt=ye.heap[--ft])||(Qe[2*yt+1]!==De&&(ye.opt_len+=(De-Qe[2*yt+1])*Qe[2*yt],Qe[2*yt+1]=De),qe--)}}(C,x),Ne(V,he,C.bl_count)}function c(C,x,U){var q,N,V=-1,se=x[1],J=0,le=7,he=4;for(se===0&&(le=138,he=3),x[2*(U+1)+1]=65535,q=0;q<=U;q++)N=se,se=x[2*(q+1)+1],++J<le&&N===se||(J<he?C.bl_tree[2*N]+=J:N!==0?(N!==V&&C.bl_tree[2*N]++,C.bl_tree[2*S]++):J<=10?C.bl_tree[2*I]++:C.bl_tree[2*z]++,V=N,he=(J=0)===se?(le=138,3):N===se?(le=6,3):(le=7,4))}function H(C,x,U){var q,N,V=-1,se=x[1],J=0,le=7,he=4;for(se===0&&(le=138,he=3),q=0;q<=U;q++)if(N=se,se=x[2*(q+1)+1],!(++J<le&&N===se)){if(J<he)for(;Y(C,N,C.bl_tree),--J!=0;);else N!==0?(N!==V&&(Y(C,N,C.bl_tree),J--),Y(C,S,C.bl_tree),te(C,J-3,2)):J<=10?(Y(C,I,C.bl_tree),te(C,J-3,3)):(Y(C,z,C.bl_tree),te(C,J-11,7));V=N,he=(J=0)===se?(le=138,3):N===se?(le=6,3):(le=7,4)}}r($);var R=!1;function E(C,x,U,q){te(C,(u<<1)+(q?1:0),3),function(N,V,se,J){Ee(N),re(N,se),re(N,~se),t.arraySet(N.pending_buf,N.window,V,se,N.pending),N.pending+=se}(C,x,U)}a._tr_init=function(C){R||(function(){var x,U,q,N,V,se=new Array(g+1);for(N=q=0;N<h-1;N++)for(P[N]=q,x=0;x<1<<M[N];x++)f[q++]=N;for(f[q-1]=N,N=V=0;N<16;N++)for($[N]=V,x=0;x<1<<j[N];x++)O[V++]=N;for(V>>=7;N<d;N++)for($[N]=V<<7,x=0;x<1<<j[N]-7;x++)O[256+V++]=N;for(U=0;U<=g;U++)se[U]=0;for(x=0;x<=143;)Q[2*x+1]=8,x++,se[8]++;for(;x<=255;)Q[2*x+1]=9,x++,se[9]++;for(;x<=279;)Q[2*x+1]=7,x++,se[7]++;for(;x<=287;)Q[2*x+1]=8,x++,se[8]++;for(Ne(Q,p+1,se),x=0;x<d;x++)_[2*x+1]=5,_[2*x]=Te(x,5);ue=new ne(Q,M,v+1,p,g),Z=new ne(_,j,0,d,g),fe=new ne(new Array(0),A,0,b,w)}(),R=!0),C.l_desc=new B(C.dyn_ltree,ue),C.d_desc=new B(C.dyn_dtree,Z),C.bl_desc=new B(C.bl_tree,fe),C.bi_buf=0,C.bi_valid=0,be(C)},a._tr_stored_block=E,a._tr_flush_block=function(C,x,U,q){var N,V,se=0;0<C.level?(C.strm.data_type===2&&(C.strm.data_type=function(J){var le,he=4093624447;for(le=0;le<=31;le++,he>>>=1)if(1&he&&J.dyn_ltree[2*le]!==0)return n;if(J.dyn_ltree[18]!==0||J.dyn_ltree[20]!==0||J.dyn_ltree[26]!==0)return i;for(le=32;le<v;le++)if(J.dyn_ltree[2*le]!==0)return i;return n}(C)),Je(C,C.l_desc),Je(C,C.d_desc),se=function(J){var le;for(c(J,J.dyn_ltree,J.l_desc.max_code),c(J,J.dyn_dtree,J.d_desc.max_code),Je(J,J.bl_desc),le=b-1;3<=le&&J.bl_tree[2*F[le]+1]===0;le--);return J.opt_len+=3*(le+1)+5+5+4,le}(C),N=C.opt_len+3+7>>>3,(V=C.static_len+3+7>>>3)<=N&&(N=V)):N=V=U+5,U+4<=N&&x!==-1?E(C,x,U,q):C.strategy===4||V===N?(te(C,2+(q?1:0),3),Ke(C,Q,_)):(te(C,4+(q?1:0),3),function(J,le,he,ye){var Ze;for(te(J,le-257,5),te(J,he-1,5),te(J,ye-4,4),Ze=0;Ze<ye;Ze++)te(J,J.bl_tree[2*F[Ze]+1],3);H(J,J.dyn_ltree,le-1),H(J,J.dyn_dtree,he-1)}(C,C.l_desc.max_code+1,C.d_desc.max_code+1,se+1),Ke(C,C.dyn_ltree,C.dyn_dtree)),be(C),q&&Ee(C)},a._tr_tally=function(C,x,U){return C.pending_buf[C.d_buf+2*C.last_lit]=x>>>8&255,C.pending_buf[C.d_buf+2*C.last_lit+1]=255&x,C.pending_buf[C.l_buf+C.last_lit]=255&U,C.last_lit++,x===0?C.dyn_ltree[2*U]++:(C.matches++,x--,C.dyn_ltree[2*(f[U]+v+1)]++,C.dyn_dtree[2*D(x)]++),C.last_lit===C.lit_bufsize-1},a._tr_align=function(C){te(C,2,3),Y(C,k,Q),function(x){x.bi_valid===16?(re(x,x.bi_buf),x.bi_buf=0,x.bi_valid=0):8<=x.bi_valid&&(x.pending_buf[x.pending++]=255&x.bi_buf,x.bi_buf>>=8,x.bi_valid-=8)}(C)}},{"../utils/common":41}],53:[function(e,l,a){l.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(e,l,a){(function(t){(function(n,i){if(!n.setImmediate){var r,u,h,v,p=1,d={},b=!1,m=n.document,g=Object.getPrototypeOf&&Object.getPrototypeOf(n);g=g&&g.setTimeout?g:n,r={}.toString.call(n.process)==="[object process]"?function(S){process.nextTick(function(){w(S)})}:function(){if(n.postMessage&&!n.importScripts){var S=!0,I=n.onmessage;return n.onmessage=function(){S=!1},n.postMessage("","*"),n.onmessage=I,S}}()?(v="setImmediate$"+Math.random()+"$",n.addEventListener?n.addEventListener("message",k,!1):n.attachEvent("onmessage",k),function(S){n.postMessage(v+S,"*")}):n.MessageChannel?((h=new MessageChannel).port1.onmessage=function(S){w(S.data)},function(S){h.port2.postMessage(S)}):m&&"onreadystatechange"in m.createElement("script")?(u=m.documentElement,function(S){var I=m.createElement("script");I.onreadystatechange=function(){w(S),I.onreadystatechange=null,u.removeChild(I),I=null},u.appendChild(I)}):function(S){setTimeout(w,0,S)},g.setImmediate=function(S){typeof S!="function"&&(S=new Function(""+S));for(var I=new Array(arguments.length-1),z=0;z<I.length;z++)I[z]=arguments[z+1];var M={callback:S,args:I};return d[p]=M,r(p),p++},g.clearImmediate=y}function y(S){delete d[S]}function w(S){if(b)setTimeout(w,0,S);else{var I=d[S];if(I){b=!0;try{(function(z){var M=z.callback,j=z.args;switch(j.length){case 0:M();break;case 1:M(j[0]);break;case 2:M(j[0],j[1]);break;case 3:M(j[0],j[1],j[2]);break;default:M.apply(i,j)}})(I)}finally{y(S),b=!1}}}}function k(S){S.source===n&&typeof S.data=="string"&&S.data.indexOf(v)===0&&w(+S.data.slice(v.length))}})(typeof self>"u"?t===void 0?this:t:self)}).call(this,typeof fn<"u"?fn:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(Fs);var Fi=Fs.exports;const Ps=$i(Fi);let oe={},T=null,fs=null,K=null,_e=null,Xt=null,zn=null,ms=[],kn=null,hs=null,Ge=null,Sn=0,ps=0,In=0,gs=0,ys=null,bs=null,xn=null,pt=null,et=-1,vs=null,Ln=null,Tn=null,Hs=null,Ws=null,ot=!1,pe=[],rt=[],Et=[],je={isScreenSaverEnabled:!0,lastRestoreTimestamp:null,lastBackupTimestamp:null};function ce(){if(ot)return;const s={classrooms:oe,trashBin:pe,userSettings:je};localStorage.setItem("teacherAssistantData_v2",JSON.stringify(s))}function Pi(s){return new Promise((o,e)=>{const l=new FileReader;l.onerror=e,l.onload=()=>{o(l.result.split(",")[1])},l.readAsDataURL(s)})}async function Us(s=[]){const o={};if(s.length>0)s.forEach(r=>{oe[r]&&(o[r]=oe[r])});else for(const r in oe)oe[r].isDeleted||(o[r]=oe[r]);const e={metadata:{version:"2.0-b64",createdAt:new Date().toISOString()},data:{classrooms:o,trashBin:pe}},l=JSON.stringify(e),a=new Date,t=new Intl.DateTimeFormat("fa-IR-u-nu-latn",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(a).reduce((r,u)=>(r[u.type]=u.value,r),{}),i=`SP_${t.year.slice(-2)}-${t.month}-${t.day}_${t.hour}-${t.minute}.txt`;try{const r=new Ps;r.file("backup.json",l);const u=await r.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:9}}),h=await Pi(u);return new File([h],i,{type:"text/plain"})}catch(r){return console.error("Error creating base64 backup file:",r),null}}function Bn(){const s=localStorage.getItem("teacherAssistantData_v2");if(!s)return;const o=JSON.parse(s);o.classrooms!==void 0&&o.trashBin!==void 0?(_t(o.classrooms),pe=o.trashBin||[],je={...je,...o.userSettings}):(_t(o),Hi())}function Hi(){const s=[];Object.values(oe).forEach(o=>{o.isDeleted?s.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:o.info.creationDate,type:"classroom",description:`کلاس «${o.info.name}»`,restoreData:{name:o.info.name}}):o.students.forEach(e=>{e.isDeleted&&s.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:e.identity.studentId.split("_")[1],type:"student",description:`دانش‌آموز «${e.identity.name}»`,restoreData:{studentId:e.identity.studentId,classroomName:o.info.name}})})}),pe.length===0&&s.length>0&&(pe=s,console.log(`Migrated ${s.length} previously deleted item(s) to the new trash bin.`),ce())}function js(s){const o=new hn(s.identity);return o.isDeleted=s.isDeleted,o.statusCounters=s.statusCounters,o.logs=s.logs,o.logs.scores||(o.logs.scores={}),o.profile=s.profile,o.finalClassActivityScore=s.finalClassActivityScore,o.categoryCounts=s.categoryCounts||{},o.categoryIssues=s.categoryIssues||{},o.onboardingSession=s.onboardingSession||null,o}function _t(s){oe={};for(const o in s){const e=s[o];let l;e.info?l=e.info:l={...e,name:o};const a=new qn(l);a.isDeleted=e.isDeleted,a.note=e.note||"",a.students=(e.students||[]).map(js),a.sessions=(e.sessions||[]).map(t=>{const n=new $s(t.sessionNumber);n.isDeleted=t.isDeleted,n.note=t.note||"",n.startTime=new Date(t.startTime),n.endTime=t.endTime?new Date(t.endTime):null,n.isFinished=t.isFinished,n.isMakeup=t.isMakeup,n.isCancelled=t.isCancelled||!1,n.studentRecords=t.studentRecords;for(const r in n.studentRecords){const u=n.studentRecords[r];u.homework&&!(u.homework instanceof Zn)&&(n.studentRecords[r].homework=new Zn(u.homework.status,u.homework.comment))}n.lastWinnerByCategory=t.lastWinnerByCategory,n.lastUsedCategoryId=t.lastUsedCategoryId,n.lastSelectedWinnerId=t.lastSelectedWinnerId;const i=t.winnerHistory||[];return n.winnerHistory=i.filter(r=>r&&r.winner).map(r=>({winner:a.students.find(h=>h.identity.studentId===r.winner.identity.studentId),categoryName:r.categoryName})).filter(r=>r.winner),n}),a.categories=(e.categories||[]).map(t=>{const n=new ut(t.name,t.description,t.isGradedCategory);return n.id=t.id,n.isDeleted=t.isDeleted,n}),a.futurePlans=e.futurePlans,oe[o]=a}}function Zs(s,o){if(o){const e=s.data.classrooms;for(let l in e){let a=l;const t=e[l];for(;oe[a];)a=`${a} (Restored)`;a!==l&&(t.info.name=a),oe[a]=t}if(s.data.trashBin){const l=[...pe,...s.data.trashBin],a=[...new Map(l.map(t=>[t.id,t])).values()];Rn(a)}_t(oe)}else _t(s.data.classrooms),Rn(s.data.trashBin||[]);qt({lastRestoreTimestamp:new Date().toISOString()}),ce()}function qs(s,o){if(oe[o])return{success:!1,message:"کلاسی با این نام از قبل وجود دارد."};const e=oe[s];return e?(e.info.name=o,oe[o]=e,delete oe[s],T===e&&Pe(e),{success:!0}):{success:!1,message:"کلاس مورد نظر یافت نشد."}}function Gs(s,o,e){const l=e.trim();if(!l)return{success:!1,message:"نام دسته‌بندی نمی‌تواند خالی باشد."};if(s.categories.some(r=>r.id!==o.id&&!r.isDeleted&&r.name.toLowerCase()===l.toLowerCase()))return{success:!1,message:"دسته‌بندی دیگری با این نام وجود دارد."};const t=o.name,n=t.toLowerCase(),i=l.toLowerCase();return o.name=l,s.students.forEach(r=>{r.categoryCounts&&r.categoryCounts[t]!==void 0&&(r.categoryCounts[l]=r.categoryCounts[t],delete r.categoryCounts[t]),r.categoryIssues&&r.categoryIssues[t]!==void 0&&(r.categoryIssues[l]=r.categoryIssues[t],delete r.categoryIssues[t]),r.logs.scores&&r.logs.scores[n]&&(r.logs.scores[n].forEach(u=>u.skill=l),n!==i&&(r.logs.scores[i]=r.logs.scores[n],delete r.logs.scores[n]))}),s.sessions.forEach(r=>{r.lastWinnerByCategory&&r.lastWinnerByCategory[t]&&(r.lastWinnerByCategory[l]=r.lastWinnerByCategory[t],delete r.lastWinnerByCategory[t]),r.winnerHistory&&r.winnerHistory.forEach(u=>{u.categoryName===t&&(u.categoryName=l)})}),{success:!0}}function Vs(s,o,e){if(Ie(e.students).some(u=>u.identity.name.toLowerCase()===s.identity.name.toLowerCase()))return{success:!1,message:`دانش‌آموزی با نام «${s.identity.name}» از قبل در کلاس «${e.info.name}» وجود دارد.`};const a=JSON.parse(JSON.stringify(s)),t=js(a),n=new Map;o.sessions.forEach(u=>{const h=u.studentRecords[s.identity.studentId];h&&n.set(u.sessionNumber,JSON.parse(JSON.stringify(h)))}),e.addStudent(t);try{const u=Ie(e.sessions).filter(g=>!g.isCancelled).sort((g,y)=>y.sessionNumber-g.sessionNumber),h=u.length>0?u[0]:null;let v="؟",p={type:"system",description:"Student Move"};h&&(v=Xe(e).get(h.sessionNumber)||h.sessionNumber,p={type:"fromSession",sessionNumber:h.sessionNumber});const d=new Date().toLocaleDateString("fa-IR"),b=o.info.name,m=`این دانش آموز در جلسه ${v} و در تاریخ ${d} از کلاس «${b}» به این کلاس انتقال پیدا کرد`;t.addNote(m,p)}catch(u){console.error("Failed to add automated move note:",u)}n.size>0&&e.sessions.forEach(u=>{const h=n.get(u.sessionNumber);h&&!u.isDeleted&&!u.isCancelled&&(u.studentRecords[t.identity.studentId]=h)});const i={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`(انتقال) دانش‌آموز «${s.identity.name}» از کلاس «${o.info.name}»`,restoreData:{studentId:s.identity.studentId,classId:o.info.scheduleCode}};pe.unshift(i),pe.length>50&&pe.pop();const r=o.students.find(u=>u.identity.studentId===s.identity.studentId);return r&&(r.isDeleted=!0),{success:!0}}function Ks(){for(const s in oe){const o=oe[s];o.students.forEach(e=>{e.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0},e.categoryCounts={},e.categoryIssues={},o.sessions.forEach(l=>{const a=e.identity.studentId;l.studentRecords[a]&&(l.studentRecords[a].attendance="present")})})}ce()}function Ie(s){return Array.isArray(s)?s.filter(o=>!o.isDeleted):[]}function Xe(s){const o=new Map;return s&&Ie(s.sessions).filter(l=>!l.isCancelled).sort((l,a)=>l.sessionNumber-a.sessionNumber).forEach((l,a)=>{o.set(l.sessionNumber,a+1)}),o}function gt(s){et=s}function it(s){vs=s}function Nn(s,o){if(!s||!o)return;const e=s.identity.studentId,l=o.students.findIndex(a=>a.identity.studentId===e);l>-1&&o.students.splice(l,1),o.sessions.forEach(a=>{a.studentRecords[e]&&delete a.studentRecords[e];for(const t in a.lastWinnerByCategory)a.lastWinnerByCategory[t]===e&&delete a.lastWinnerByCategory[t];a.lastSelectedWinnerId===e&&(a.lastSelectedWinnerId=null),a.winnerHistory=a.winnerHistory.filter(t=>t.winner&&t.winner.identity.studentId!==e)})}function Js(s,o){const e=oe[s];if(!e)return;const l=e.sessions.findIndex(a=>a.sessionNumber===o);l>-1&&(e.students.forEach(a=>{a.profile.notes&&a.profile.notes.length>0&&(a.profile.notes=a.profile.notes.filter(t=>!t.source||t.source.type!=="fromAttendance"||t.source.sessionNumber!==o)),a.onboardingSession===o&&(a.onboardingSession=null)}),e.sessions.splice(l,1))}function Ys(s,o){const e=oe[s];if(!e)return;const l=e.categories.findIndex(i=>i.id===o);if(l===-1)return;const t=e.categories[l].name,n=t.toLowerCase();e.students.forEach(i=>{i.categoryCounts&&delete i.categoryCounts[t],i.categoryIssues&&delete i.categoryIssues[t],i.logs.scores&&delete i.logs.scores[n]}),e.sessions.forEach(i=>{i.lastWinnerByCategory[t]&&delete i.lastWinnerByCategory[t],i.winnerHistory=i.winnerHistory.filter(r=>r.categoryName!==t)}),e.categories.splice(l,1)}function Xs(s,o,e,l){const a=oe[s];if(!a)return;const t=a.students.find(r=>r.identity.studentId===o);if(!t||!t.logs.scores[e.toLowerCase()])return;const n=t.logs.scores[e.toLowerCase()],i=n.findIndex(r=>r.id===l);i>-1&&n.splice(i,1)}function Qs(s,o,e){const l=oe[s];if(!l)return;const a=l.students.find(n=>n.identity.studentId===o);if(!a||!a.profile.notes)return;const t=a.profile.notes.findIndex(n=>n.id===e);t>-1&&a.profile.notes.splice(t,1)}function ei(){JSON.parse(JSON.stringify({classrooms:oe,trashBin:pe})),ot=!0}function ti(){ot=!1,Bn()}function Pe(s){T=s}function Qt(s){fs=s}function Ue(s){K=s}function Ve(s){_e=s}function Dn(s){Xt=s}function ni(s){zn=s}function Ht(s){ms=s}function pn(s){kn=s}function si(s){hs=s}function An(s){Ge=s}function gn(s){Sn=s}function ii(s){ps=s}function yn(s){In=s}function ai(s){gs=s}function Cs(s){ys=s}function ws(s){bs=s}function en(s){xn=s}function Es(s){pt=s}function On(s){Tn=s}function ri(s){Hs=s}function oi(s){Ws=s}function Rn(s){pe=s}function $n(s){Ln=s}function tn(s){Et=s}function qt(s){je={...je,...s},ce()}function Gn(s){rt=s}function _s(){je.lastBackupTimestamp=new Date().toISOString(),ce()}const Wi=Object.freeze(Object.defineProperty({__proto__:null,get activeModal(){return pt},get cancelCallback(){return bs},get classrooms(){return oe},get confirmCallback(){return ys},get currentClassroom(){return T},get easterEggClickCount(){return Sn},get easterEggLastClickTime(){return ps},enterDemoMode:ei,exitDemoMode:ti,getActiveItems:Ie,getSessionDisplayMap:Xe,get importedFileContent(){return kn},get isDemoMode(){return ot},get liveSession(){return fs},loadData:Bn,get manualSelection(){return Tn},moveStudent:Vs,get namesToImport(){return ms},get notificationTimeout(){return hs},permanentlyDeleteCategory:Ys,permanentlyDeleteNote:Qs,permanentlyDeleteScore:Xs,permanentlyDeleteSession:Js,permanentlyDeleteStudent:Nn,prepareBackupData:Us,get previousState(){return Xt},processRestore:Zs,rehydrateData:_t,renameCategory:Gs,renameClassroom:qs,resetAllStudentCounters:Ks,get resetEasterEggClickCount(){return In},get resetEasterEggLastClickTime(){return gs},get saveCategoryCallback(){return Ln},saveData:ce,get saveNoteCallback(){return vs},get secureConfirmCallback(){return xn},get selectedCategory(){return Ge},get selectedClassIds(){return rt},get selectedSession(){return K},get selectedStudentForProfile(){return _e},get selectedStudentsForMassComment(){return Et},setActiveModal:Es,setCancelCallback:ws,setConfirmCallback:Cs,setCurrentClassroom:Pe,setEasterEggClickCount:gn,setEasterEggLastClickTime:ii,setImportedFileContent:pn,setLastBackupTimestamp:_s,setLiveSession:Qt,setManualSelection:On,setNamesToImport:Ht,setNotificationTimeout:si,setPreviousState:Dn,setResetEasterEggClickCount:yn,setResetEasterEggLastClickTime:ai,setSaveCategoryCallback:$n,setSaveNoteCallback:it,setSecureConfirmCallback:en,setSelectedCategory:An,setSelectedClassIds:Gn,setSelectedSession:Ue,setSelectedStudentForProfile:Ve,setSelectedStudentsForMassComment:tn,setSourceClassForMove:oi,setStudentToMove:ri,setTrashBin:Rn,setUndoTimeout:ni,setUserSettings:qt,setWinnerHistoryIndex:gt,get sourceClassForMove(){return Ws},get studentToMove(){return Hs},get trashBin(){return pe},get undoTimeout(){return zn},get userSettings(){return je},get winnerHistoryIndex(){return et}},Symbol.toStringTag,{value:"Module"}));function Ye(s){return typeof s!="string"?"":s.replace(/ي/g,"ی").replace(/ك/g,"ک").replace(/[\s\u200c]/g,"")}function ks(s){return typeof s!="string"||s.length===0?"ltr":/[\u0590-\u07FF]/.test(s)?"rtl":"ltr"}function ci(s){return!s||!s.trim()?"":s.split(`
`).map(l=>`<div dir="${ks(l)}">${l||"&nbsp;"}</div>`).join("")}function jn(s){if(typeof s!="string")return"";const o={q:"ض",w:"ص",e:"ث",r:"ق",t:"ف",y:"غ",u:"ع",i:"ه",o:"خ",p:"ح","[":"ج","]":"چ",a:"ش",s:"س",d:"ی",f:"ب",g:"ل",h:"ا",j:"ت",k:"ن",l:"م",";":"ک","'":"گ",z:"ظ",x:"ط",c:"ز",v:"ر",b:"ذ",n:"د",m:"پ",",":"و"};let e="";for(let l=0;l<s.length;l++){const a=s[l].toLowerCase();e+=o[a]||s[l]}return e}const li="teacherAssistantLogs_v2",Ui=100;function Ss(){try{const s=localStorage.getItem(li);return s?JSON.parse(s):{}}catch(s){return console.error("Error reading logs from localStorage:",s),{}}}function di(s){try{localStorage.setItem(li,JSON.stringify(s))}catch(o){console.error("Error saving logs to localStorage:",o)}}function Se(s,o,e=null){if(!s)return;const l=Ss();l[s]||(l[s]=[]);const a={timestamp:new Date().toISOString(),message:o,action:e,classroomName:s};l[s].unshift(a),l[s].length>Ui&&l[s].pop(),di(l)}function ji(s){return Ss()[s]||[]}function Zi(s,o){const e=Ss();e[s]&&!e[o]&&(e[o]=e[s],delete e[s],di(e))}const ui=document.getElementById("class-management-page"),qi=document.getElementById("new-class-name"),Gi=document.getElementById("add-class-btn"),Bt=document.getElementById("class-list"),Mn=document.getElementById("undo-toast"),fi=document.getElementById("undo-message"),Vi=document.getElementById("undo-btn"),Ki=document.getElementById("settings-page"),Is=document.getElementById("settings-class-name-header"),Vn=document.getElementById("settings-student-list"),Kn=document.getElementById("category-list"),Ji=document.getElementById("back-to-sessions-btn"),Yi=document.getElementById("new-student-name"),Xi=document.getElementById("add-student-btn"),mi=document.getElementById("paste-area"),Qi=document.getElementById("process-paste-btn"),ea=document.getElementById("csv-preview-page"),Jn=document.getElementById("csv-preview-list"),ta=document.getElementById("csv-confirm-btn"),na=document.getElementById("csv-cancel-btn"),sa=document.getElementById("import-csv-btn"),ia=document.getElementById("csv-file-input"),aa=document.getElementById("column-mapping-page"),Yn=document.getElementById("column-select-dropdown"),ra=document.getElementById("confirm-column-btn"),oa=document.getElementById("cancel-import-btn"),ca=document.getElementById("new-category-name"),la=document.getElementById("add-category-btn"),Xn=document.querySelector(".app-header"),nt=document.getElementById("select-student-btn"),At=document.getElementById("select-student-btn-wrapper"),da=document.getElementById("attendance-page"),Gt=document.getElementById("attendance-list"),ua=document.getElementById("finish-attendance-btn"),fa=document.querySelector("#class-management-page h2"),Qn=document.getElementById("student-stats-header"),ma=document.getElementById("hamburger-menu-btn"),ha=document.getElementById("side-nav-menu"),pa=document.getElementById("close-nav-btn"),ga=document.getElementById("overlay"),ya=document.getElementById("backup-data-btn"),ba=document.getElementById("restore-data-btn"),hi=document.getElementById("restore-file-input"),va=document.getElementById("custom-confirm-modal"),pi=document.getElementById("confirm-modal-message"),es=document.getElementById("confirm-modal-cancel-btn"),Wt=document.getElementById("confirm-modal-confirm-btn"),Ca=document.getElementById("secure-confirm-modal"),gi=document.getElementById("secure-confirm-message"),yi=document.getElementById("secure-confirm-code"),xt=document.getElementById("secure-confirm-input"),wa=document.getElementById("secure-confirm-cancel-btn"),bn=document.getElementById("secure-confirm-confirm-btn"),Ea=document.getElementById("add-note-modal"),we=document.getElementById("new-note-content"),_a=document.getElementById("class-save-note-btn"),ka=document.getElementById("cancel-note-btn"),ts=document.getElementById("student-search-input"),ht=document.getElementById("student-search-results"),Sa=document.getElementById("back-to-student-page-btn"),Ia=document.getElementById("graded-category-pills-container"),xa=document.getElementById("new-score-value"),bi=document.getElementById("new-score-comment"),La=document.getElementById("add-score-btn"),Ta=document.getElementById("profile-stats-summary"),Ba=document.getElementById("profile-scores-list"),Ut=document.getElementById("global-student-search-input"),at=document.getElementById("global-student-search-results"),Na=document.getElementById("is-graded-checkbox"),Da=document.getElementById("trashed-classes-list"),Aa=document.getElementById("trashed-students-list"),Oa=document.getElementById("trashed-sessions-list"),Ra=document.getElementById("trashed-categories-list"),Ma=document.getElementById("trashed-notes-list"),za=document.getElementById("trashed-scores-list"),Tt=document.getElementById("quick-grade-form-wrapper"),ct=document.getElementById("quick-score-input"),tt=document.getElementById("quick-note-textarea"),Ct=document.getElementById("quick-grade-submit-btn"),Vt=document.getElementById("category-selection-container"),ns=document.getElementById("selected-student-result"),wt=document.getElementById("custom-context-menu"),Lt=document.getElementById("breadcrumb-container");let Pt=null,Nt=null;const $a=document.getElementById("category-modal"),vi=document.getElementById("category-modal-title"),Kt=document.getElementById("new-category-modal-name"),xs=document.getElementById("new-category-modal-is-graded"),Fa=document.getElementById("category-modal-cancel-btn"),Ci=document.getElementById("category-modal-save-btn"),Pa=document.getElementById("mass-comment-modal"),Ha=document.getElementById("mass-comment-modal-title"),wi=document.getElementById("mass-comment-student-count-message"),Jt=document.getElementById("mass-comment-content"),Ls=document.getElementById("mass-comment-append-checkbox"),Wa=document.getElementById("mass-comment-cancel-btn"),Ua=document.getElementById("mass-comment-save-btn"),ss=document.getElementById("mass-comment-btn"),vn=document.getElementById("attendance-mass-actions-container"),bt=document.createElement("input"),ja=document.getElementById("session-dashboard-page"),Ot=document.getElementById("attendance-pane");function jt(s,o){let e;const a=n=>{e=setTimeout(()=>{navigator.vibrate&&navigator.vibrate(50),o(n)},800)},t=()=>{clearTimeout(e)};s.addEventListener("touchstart",a,{passive:!0}),s.addEventListener("touchend",t),s.addEventListener("touchmove",t),s.addEventListener("mousedown",a),s.addEventListener("mouseup",t),s.addEventListener("mouseleave",t)}function Rt(s="selector"){if(!T||!K){ge("class-management-page");return}Ka(),wn(),Re(),st(),ge("session-dashboard-page",{tab:s}),Ei(),nn(s),Ja()}function nn(s){const o=document.getElementById("selector-tab-btn"),e=document.getElementById("attendance-tab-btn"),l=document.getElementById("selector-pane"),a=s==="selector";o.classList.toggle("active",a),e.classList.toggle("active",!a),l.classList.toggle("active",a),Ot.classList.toggle("active",!a)}function Ei(){const s=document.getElementById("selector-tab-btn"),o=document.getElementById("attendance-tab-btn"),e=document.getElementById("selector-pane");s.addEventListener("click",()=>{Re(),Fe(),s.classList.add("active"),o.classList.remove("active"),e.classList.add("active"),Ot.classList.remove("active"),ge("session-dashboard-page",{tab:"selector"})}),o.addEventListener("click",()=>{st(),o.classList.add("active"),s.classList.remove("active"),Ot.classList.add("active"),e.classList.remove("active"),ge("session-dashboard-page",{tab:"attendance"})})}function Za(s){clearTimeout(zn),Xt||Dn(JSON.stringify(oe)),fi.textContent=s,Mn.classList.add("show"),ni(setTimeout(()=>{Mn.classList.remove("show"),Dn(null)},5e3))}function _i(){if(Xt){const s=T?T.info.name:null,o=JSON.parse(Xt);_t(o),s&&oe[s]?Pe(oe[s]):Pe(null),T?(lt(),Mt(),We()):He(),Mn.classList.remove("show"),clearTimeout(zn),Dn(null)}}function ee(s,o=3e3){const e=document.getElementById("notification-toast");e&&(e.textContent=s,e.classList.add("show"),clearTimeout(hs),si(setTimeout(()=>{e.classList.remove("show")},o)))}function is(s){const o=document.getElementById("restore-confirm-modal"),e=document.getElementById("restore-modal-message"),l=document.getElementById("restore-append-checkbox"),a=document.getElementById("restore-confirm-cancel-btn"),t=document.getElementById("restore-confirm-confirm-btn"),n=document.getElementById("restore-modal-warning");n.style.display="none";const i=s.metadata.createdAt;if(je.lastRestoreTimestamp&&i<je.lastRestoreTimestamp){const p=new Date(i).toLocaleDateString("fa-IR"),d=new Date(je.lastRestoreTimestamp).toLocaleDateString("fa-IR");n.textContent=`⚠️ هشدار: این فایل پشتیبان (${p}) قدیمی‌تر از آخرین بازیابی شما (${d}) است.`,n.style.display="block"}const r=Object.keys(s.data.classrooms).length,u="کلاس";e.textContent=`فایل پشتیبان شما حاوی ${r} ${u} است. لطفاً نحوه بازیابی را مشخص کنید.`,l.checked=!0;const h=()=>{const p=l.checked;Zs(s,p),o.removeEventListener("click",h),ke(),He(),ge("class-management-page"),ee("✅ اطلاعات با موفقیت بازیابی شد.")},v=()=>{ke()};t.onclick=h,a.onclick=v,ze("restore-confirm-modal")}function Ce(s,o,e={}){const{confirmText:l="تایید",cancelText:a="لغو",confirmClass:t="btn-success",onCancel:n=()=>{},isDelete:i=!1}=e,r=i?()=>ki(s,o):o;pi.textContent=s,Wt.textContent=l,es.textContent=a,Wt.className="modal-action-btn",Wt.classList.add(t),Cs(r),ws(n);const u=Wt.parentElement;es.style.display=n===null?"none":"inline-block",u.style.justifyContent=n===null?"center":"space-between",ze("custom-confirm-modal")}function ki(s,o){const e=Math.floor(1e4+Math.random()*9e4).toString();gi.textContent=s,yi.textContent=e,xt.value="",bn.disabled=!0,en(o),ze("secure-confirm-modal"),xt.focus();const l=()=>{xt.value===e?bn.disabled=!1:bn.disabled=!0};return xt.addEventListener("input",l),()=>{xt.removeEventListener("input",l)}}function as(s,o={}){const{title:e="ایجاد دسته‌بندی جدید",initialName:l="",initialIsGraded:a=!1,saveButtonText:t="ذخیره"}=o;vi.textContent=e,Kt.value=l,xs.checked=a,Ci.textContent=t,$n((n,i)=>{if(!n){ee("⚠️ لطفاً نام دسته‌بندی را وارد کنید.");return}s(n,i),ke()}),ze("category-modal"),Kt.focus(),l&&Kt.select()}function Ts(s,o){const e=Object.values(oe).filter(n=>!n.isDeleted&&n.info.name!==o.info.name),l=document.getElementById("move-student-modal-title"),a=document.getElementById("move-student-class-select"),t=document.getElementById("move-student-confirm-btn");l.textContent=`انتقال دانش‌آموز: ${s.identity.name}`,a.innerHTML="",e.length===0?(a.innerHTML='<option value="">کلاس دیگری برای انتقال وجود ندارد</option>',t.disabled=!0):(e.forEach(n=>{const i=document.createElement("option");i.value=n.info.name,i.textContent=n.info.name,a.appendChild(i)}),t.disabled=!1),ri(s),oi(o),ze("move-student-modal")}function Bs(s,o){if(!s||!o)return;const e=s.identity.name,l=document.getElementById("add-note-modal-title");l.textContent="تغییر نام دانش‌آموز",we.value=e,we.rows=1,we.dispatchEvent(new Event("input",{bubbles:!0})),it(a=>{const t=a.trim();t&&t!==e&&(Ie(o.students).some(i=>i.identity.studentId!==s.identity.studentId&&i.identity.name.toLowerCase()===t.toLowerCase())?ee("دانش‌آموزی با این نام از قبل در این کلاس وجود دارد."):(s.identity.name=t,Se(o.info.name,`نام دانش‌آموز «${e}» به «${t}» تغییر یافت.`,{type:"VIEW_STUDENT_PROFILE",studentId:s.identity.studentId}),ce(),lt(),Re(),st(),Fe(),_e&&_e.identity.studentId===s.identity.studentId&&Me(s),ee(`✅نام دانش‌آموز به «${t}» تغییر یافت.`))),l.textContent="ثبت یادداشت جدید",we.rows=4}),ze("add-note-modal"),we.focus(),we.select()}function ze(s){const o=document.getElementById(s);if(o){if(pt)return;document.body.classList.add("modal-active"),o.classList.add("modal-visible"),Es(s),history.pushState(null,"",location.href)}}function ke(s,o=!1){if(!pt)return;const e=document.getElementById(pt),l=pt;Es(null),l==="student-profile-modal"&&Ve(null),o||history.back(),e&&(e.classList.add("modal-closing"),setTimeout(()=>{e.classList.remove("modal-visible"),e.classList.remove("modal-closing"),document.body.classList.remove("modal-active"),l==="custom-confirm-modal"&&(Cs(null),ws(null)),l==="secure-confirm-modal"&&en(null),l==="category-modal"&&$n(null),l==="mass-comment-modal"&&(Jt.value=""),l==="add-note-modal"&&it(null),typeof s=="function"&&s()},300))}function Ns(){if(!Ot||!Ot.classList.contains("active")){vn.style.display="none";return}const s=Et.length;s<1?vn.style.display="none":vn.style.display="block",ss.disabled=s<1,ss.textContent=`📝 ثبت یادداشت گروهی (${s} نفر)`}function Ds(){const s=Et,o=s.length;let e=!1;o>0&&(e=s.some(a=>{var t;return(t=K.studentRecords[a])==null?void 0:t.homework.comment})),wi.textContent=`یادداشت برای ${o} دانش‌آموز ثبت خواهد شد.`,Jt.value="",Jt.dispatchEvent(new Event("input",{bubbles:!0})),Ls.checked=!0;const l=document.querySelector("#mass-comment-modal .modal-options");l.style.display=e?"flex":"none",ze("mass-comment-modal"),Jt.focus()}function rs(s,o){if(!T||!K)return;let e=0;const l=Et,a=K;l.forEach(t=>{const n=a.studentRecords[t];if(n&&n.homework){const i=n.homework.comment||"";let r=s;o&&i.length>0?r=i+`
---
`+s:r=s,n.homework.comment=r.trim();const u=T.students.find(h=>h.identity.studentId===t);u&&qa(u,a,r.trim()),e++}}),tn([]),ce(),st(),Se(T.info.name,`${e} دانش‌آموز به صورت گروهی یادداشت تکلیف گرفتند.`,{type:"VIEW_SESSIONS"}),ee(`✅ یادداشت برای ${e} دانش‌آموز ثبت شد.`)}function qa(s,o,e){const a=Xe(T).get(o.sessionNumber),t={type:"fromAttendance",sessionNumber:o.sessionNumber},n=`یادداشت مربوط به جلسه ${a}: `,i=s.profile.notes.find(r=>!r.isDeleted&&r.source&&r.source.type==="fromAttendance"&&r.source.sessionNumber===t.sessionNumber);i?e?(i.content=n+e,i.isDeleted=!1):i.isDeleted=!0:e&&s.addNote(n+e,t)}function Fn(s){we.value=s.note||"",it(o=>{s.note=o,ce(),Se(s.info.name,"یادداشت کلاس ذخیره شد.",{type:"VIEW_CLASS_NOTE"}),He(),ee("✅ یادداشت کلاس ذخیره شد.")}),ze("add-note-modal"),we.focus()}function As(s,o){we.value=s.note||"",we.dispatchEvent(new Event("input",{bubbles:!0})),it(e=>{s.note=e,ce(),Se(T.info.name,`یادداشت جلسه ${o} ذخیره شد.`,{type:"VIEW_SESSIONS"}),We(),ee("✅یادداشت جلسه ذخیره شد.")}),ze("add-note-modal"),we.focus()}function Dt(s){Pe(s),Is.textContent=`تنظیمات کلاس: ${s.info.name}`,lt(),Mt(),Di(),ge("settings-page")}function Si(s){const o=document.getElementById("log-modal-title"),e=document.getElementById("log-list");o.textContent=`گزارش فعالیت‌های کلاس: ${s}`,e.innerHTML="";const l=ji(s);l.length===0?e.innerHTML='<li class="no-content-message">هنوز فعالیتی برای این کلاس ثبت نشده است.</li>':l.forEach(a=>{const t=document.createElement("li");t.className="log-entry";const n=new Date(a.timestamp),i=`${n.toLocaleDateString("fa-IR")} - ${n.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}`,r=document.createElement("span");r.className="log-timestamp",r.textContent=i;const u=document.createElement("span");u.className="log-message",u.textContent=a.message,a.action&&(u.classList.add("log-action-link"),u.dataset.action=JSON.stringify({...a.action,classroomName:a.classroomName})),t.appendChild(r),t.appendChild(u),e.appendChild(t)}),ze("log-modal")}document.getElementById("log-modal-close-btn").addEventListener("click",()=>{ke()});function os(s){const o=URL.createObjectURL(s),e=document.createElement("a");e.href=o,e.download=s.name,document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(o),setTimeout(()=>{Ce("آیا فایل پشتیبان با موفقیت ذخیره شد؟",()=>{_s(),Pn(),ee("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله، ذخیره شد",cancelText:"خیر",confirmClass:"btn-success"})},500)}async function sn(s=[]){const o=await Us(s);if(!o){ee("❌ خطا در ایجاد فایل پشتیبان.");return}("ontouchstart"in window||navigator.maxTouchPoints>0)&&navigator.share&&navigator.canShare&&navigator.canShare({files:[o]})?Ce("فایل پشتیبان شما آماده است. آیا مایل به اشتراک‌گذاری آن هستید؟",()=>{try{navigator.share({title:o.name,text:"فایل پشتیبان داده‌های برنامه",files:[o]}).then(()=>{Ce("آیا فایل پشتیبان با موفقیت ارسال/ذخیره شد؟",()=>{_s(),Pn(),ee("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}catch(l){console.error("Error during sharing process:",l),os(o),ee("⚠️خطا در فرآیند اشتراک‌گذاری. فایل در حال دانلود است.")}},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"}):(os(o),ee("✅پشتیبان‌گیری با موفقیت انجام شد."))}function rn(s,o){s.preventDefault(),vt(),Nt=s.target.closest("li"),Nt&&Nt.classList.add("context-menu-target"),setTimeout(()=>{const e=wt,l=e.querySelector("ul");l.innerHTML="",o.forEach(u=>{const h=document.createElement("li");u.isSeparator?h.className="separator":(h.innerHTML=`
                    <span class="icon">${u.icon||""}</span>
                    <span class="label">${u.label}</span>
                `,u.className&&h.classList.add(u.className),h.addEventListener("click",()=>{u.action(),vt()})),l.appendChild(h)}),e.classList.add("visible");const{offsetWidth:a,offsetHeight:t}=e,{innerHeight:n}=window,i=document.body.getBoundingClientRect();e.style.top=`${(n-t)/2}px`;const r=i.left+i.width/2;e.style.left=`${r-a/2}px`},50)}function vt(){wt.classList.contains("visible")&&wt.classList.remove("visible"),Nt&&(Nt.classList.remove("context-menu-target"),Nt=null)}function Ii(){var e;Lt.innerHTML="";const s=document.getElementById("header-settings-btn");if(!s)return;const o=[];if(o.push({label:"کلاس‌ها",handler:()=>{Pe(null),Ue(null),Ve(null),ge("class-management-page")}}),T){o.push({label:T.info.name,handler:()=>{Ue(null),Ve(null),We(),ge("session-page")}});const l=(e=document.querySelector(".page.active"))==null?void 0:e.id;if(l==="session-page"?s.style.visibility="visible":s.style.visibility="hidden",l==="settings-page")o.push({label:"تنظیمات"});else if(K){const t=Xe(T).get(K.sessionNumber)||` (#${K.sessionNumber})`;o.push({label:`جلسه ${t}`,handler:()=>{Ve(null),Rt("selector")}}),_e?o.push({label:`پروفایل: ${_e.identity.name}`}):l==="session-dashboard-page"&&(document.getElementById("attendance-tab-btn").classList.contains("active")?o.push({label:"حضور و غیاب"}):o.push({label:"انتخابگر"}))}}else s.style.visibility="hidden";if(o.length<=1){Lt.style.display="none";return}Lt.style.display="flex",o.forEach((l,a)=>{const t=document.createElement("a");if(t.textContent=l.label,t.className="breadcrumb-item",a===o.length-1||!l.handler?t.classList.add("active"):t.addEventListener("click",l.handler),Lt.appendChild(t),a<o.length-1){const n=document.createElement("span");n.className="breadcrumb-separator",n.textContent="/",Lt.appendChild(n)}})}function zs(s,o,e){e.innerHTML="";const l=T.sessions.filter(a=>{var t;return!a.isDeleted&&!a.isCancelled&&((t=a.studentRecords[s.identity.studentId])==null?void 0:t.attendance)==="absent"}).map(a=>({number:o.get(a.sessionNumber),isMakeup:a.isMakeup})).filter(a=>a.number!==void 0);l.length>0?(e.appendChild(document.createTextNode("جلسات غایب: ")),l.forEach((a,t)=>{const n=document.createElement("span");n.textContent=a.number,a.isMakeup&&n.classList.add("makeup-absence"),e.appendChild(n),t<l.length-1&&e.appendChild(document.createTextNode("، "))})):e.textContent="جلسات غایب: بدون غیبت"}function Cn(s,o,e,l={}){const{includePrefix:a=!0}=l;e.innerHTML="";const t=T.sessions.filter(n=>{if(n.isDeleted||n.isCancelled)return!1;const i=n.studentRecords[s.identity.studentId];return i&&i.homework&&(i.homework.status==="incomplete"||i.homework.status==="none")}).map(n=>({number:o.get(n.sessionNumber),status:n.studentRecords[s.identity.studentId].homework.status})).filter(n=>n.number!==void 0);t.length>0?(a&&e.appendChild(document.createTextNode("تکالیف ناقص: ")),t.forEach((n,i)=>{const r=document.createElement("span");r.textContent=n.number,n.status==="incomplete"&&r.classList.add("incomplete-homework"),e.appendChild(r),i<t.length-1&&e.appendChild(document.createTextNode("،"))})):a?e.textContent="تکالیف ناقص: ندارد":e.textContent="ندارد"}function Ga(s,o){var M,j,A;const e=document.createElement("li");e.className="attendance-list-item";const l=document.createElement("span");l.className="absence-info";const a=document.createElement("span");a.className="homework-info";const t=document.createElement("div");t.className="att-row-1";let n=!1;t.addEventListener("mousedown",()=>n=!1),t.addEventListener("touchstart",()=>n=!1,{passive:!0});const i=document.createElement("input");i.type="checkbox",i.className="mass-comment-checkbox",i.checked=Et.includes(s.identity.studentId),i.addEventListener("change",()=>{const F=s.identity.studentId,Q=Et;if(i.checked)Q.includes(F)||Q.push(F);else{const O=Q.indexOf(F);O>-1&&Q.splice(O,1)}Ns();const _=document.getElementById("attendance-list");Q.length===0&&_.classList.contains("selection-mode-active")&&_.classList.remove("selection-mode-active")});const r=document.createElement("span");r.className="student-name",r.textContent=s.identity.name,r.addEventListener("click",F=>{if(n){F.stopPropagation(),F.preventDefault(),n=!1;return}Me(s)}),jt(t,F=>{n=!0;const Q=document.getElementById("attendance-list");Q.classList.contains("selection-mode-active")||Q.classList.add("selection-mode-active"),i.checked||(i.checked=!0,i.dispatchEvent(new Event("change")))}),t.appendChild(i),t.appendChild(r);const u=document.createElement("div");u.className="att-row-2";const h=document.createElement("button");let v=!1;h.addEventListener("mousedown",()=>v=!1),h.addEventListener("touchstart",()=>v=!1,{passive:!0});const p=((M=K.studentRecords[s.identity.studentId])==null?void 0:M.attendance)||"present",d=F=>{F==="present"?(h.textContent="حاضر",h.className="attendance-status-btn present active"):(h.textContent="غایب",h.className="attendance-status-btn absent active")};d(p),h.addEventListener("click",F=>{var O;if(v){F.stopPropagation();return}const _=(((O=K.studentRecords[s.identity.studentId])==null?void 0:O.attendance)||"present")==="present"?"absent":"present";K.setAttendance(s.identity.studentId,_),_==="absent"&&(K.studentRecords[s.identity.studentId].hadIssue=!1),ce(),d(_),zs(s,o,l),Re(),Ai()}),jt(h,()=>{v=!0;const F=p==="present"?"absent":"present",Q=F==="present"?"حاضر":"غایب";Ce(`آیا مطمئن هستید که می‌خواهید وضعیت حضور تمام دانش‌آموزان را به «${Q}» تغییر دهید؟`,()=>{Ie(T.students).forEach(_=>{K.setAttendance(_.identity.studentId,F),F==="absent"&&(K.studentRecords[_.identity.studentId].hadIssue=!1)}),ce(),st(),ee(`✅ وضعیت تمام دانش‌آموزان به «${Q}» تغییر یافت.`)},{confirmText:"بله، اعمال کن",confirmClass:"btn-warning"})});const b=document.createElement("div");b.className="homework-controls";const m={none:"بدون تکلیف",complete:"تکلیف کامل",incomplete:"تکلیف ناقص"},g=document.createElement("button");let y=!1;g.addEventListener("mousedown",()=>y=!1),g.addEventListener("touchstart",()=>y=!1,{passive:!0});const w=((j=K.studentRecords[s.identity.studentId])==null?void 0:j.homework.status)||"none";g.className=`homework-status-btn ${w}`,g.title=m[w],g.addEventListener("click",F=>{if(y){F.stopPropagation();return}const Q=K.studentRecords[s.identity.studentId].homework,O={none:"incomplete",incomplete:"complete",complete:"none"}[Q.status];K.setHomeworkStatus(s.identity.studentId,O),ce(),g.className=`homework-status-btn ${O}`,g.title=m[O],Cn(s,o,a)}),jt(g,()=>{y=!0;const Q={none:"incomplete",incomplete:"complete",complete:"none"}[w],_=m[Q];Ce(`آیا از تغییر وضعیت تکلیف تمام دانش‌آموزان به «${_}» مطمئن هستید؟`,()=>{Ie(T.students).forEach(O=>{K.setHomeworkStatus(O.identity.studentId,Q)}),ce(),st(),ee(`✅ وضعیت تکلیف همه به «${_}» تغییر یافت.`)},{confirmText:"بله",confirmClass:"btn-warning"})});const k=document.createElement("button");let S=!1;k.addEventListener("mousedown",()=>S=!1),k.addEventListener("touchstart",()=>S=!1,{passive:!0}),k.className="btn-icon",k.innerHTML="📝",k.title="افزودن یادداشت برای تکلیف",((A=K.studentRecords[s.identity.studentId])==null?void 0:A.homework.comment)||(k.style.opacity="0.3"),k.addEventListener("click",F=>{if(S){F.stopPropagation();return}const Q=K.studentRecords[s.identity.studentId].homework;we.value=Q.comment||"",we.dispatchEvent(new Event("input",{bubbles:!0})),it(_=>{Q.comment=_;const O=Xe(T),f=O.get(K.sessionNumber),P={type:"fromAttendance",sessionNumber:K.sessionNumber},ue=`یادداشت مربوط به جلسه ${f}: `,Z=s.profile.notes.find(fe=>!fe.isDeleted&&fe.source&&fe.source.type==="fromAttendance"&&fe.source.sessionNumber===P.sessionNumber);Z?_?Z.content=ue+_:Z.isDeleted=!0:_&&s.addNote(ue+_,P),ce(),ee("✅یادداشت تکلیف ذخیره شد."),k.style.opacity=_?"1":"0.3",Cn(s,O,a)}),ze("add-note-modal"),we.focus()}),jt(k,()=>{S=!0,Ce("آیا می‌خواهید برای **تمام** دانش‌آموزان کلاس یادداشت تکلیف ثبت کنید؟",()=>{const F=Ie(T.students).map(Q=>Q.identity.studentId);tn(F),Ds()},{confirmText:"بله",confirmClass:"btn-primary"})}),u.appendChild(h),b.appendChild(k),b.appendChild(g),u.appendChild(b);const z=document.createElement("div");return z.className="att-row-3",zs(s,o,l),Cn(s,o,a),z.appendChild(l),z.appendChild(a),e.appendChild(t),e.appendChild(u),e.appendChild(z),e}function Va(){return Xe(T).get(K.sessionNumber)}function st(){if(!T||!K)return;Ie(T.students).forEach(a=>{K.initializeStudentRecord(a.identity.studentId)}),tn([]);const s=Xe(T);ar(),Gt.innerHTML="";const o=document.createElement("li");o.className="attendance-list-header",bt.id="attendance-search-input",bt.type="text",bt.className="inline-search-input",bt.placeholder="جستجو...",bt.value="";const e=document.createElement("div");e.className="student-search-container",e.appendChild(bt);const l=document.createElement("div");l.className="header-labels-container",l.innerHTML=`
    <span class="header-label">تکلیف</span>
    <span class="header-label">حضور</span>
`,o.appendChild(e),o.appendChild(l),Gt.appendChild(o),Ie(T.students).forEach(a=>{const t=Ga(a,s);Gt.appendChild(t)}),tn([]),Ns(),rr(),Ai()}function Re(){const s=document.getElementById("student-stats-table-container");if(!s||(s.innerHTML="",!T))return;Ie(T.students).length,Qn.textContent="آمار عملکرد";const o=["نام"],e=["کل انتخاب ها","غیبت","خروج","فرصت ازدست‌رفته","مشکل","میانگین","نمره کلاسی (کانون)"],l=T.categories.filter(d=>d.isGradedCategory&&!d.isDeleted).map(d=>d.name),a=[...o,...l,...e],t=document.createElement("table");t.className="student-stats-table";const i=t.createTHead().insertRow();a.forEach((d,b)=>{const m=document.createElement("th");b===0?(m.innerHTML=`${d} <span style="opacity: 0.6;">🔗</span>`,m.title="ردیف‌های این ستون قابل کلیک هستند"):m.textContent=d,i.appendChild(m)});const r=t.createTBody(),u=Ie(T.students),h=d=>{let b=0;return T.sessions.forEach(m=>{if(m.isDeleted||m.isCancelled)return;const g=m.studentRecords[d.identity.studentId];g&&g.attendance==="absent"&&b++}),b};u.forEach(d=>{const b=r.insertRow();if(b.dataset.studentId=d.identity.studentId,K){const S=K.studentRecords[d.identity.studentId];S&&S.attendance==="absent"&&b.classList.add("absent-row-highlight")}const m=b.insertCell(),g=document.createElement("span");g.textContent=d.identity.name,g.className="student-name-link",g.addEventListener("click",()=>{Me(d)}),m.appendChild(g),l.forEach(S=>{var j;const I=b.insertCell();I.style.direction="ltr";const z=S.toLowerCase(),M=((j=d.logs.scores[z])==null?void 0:j.filter(A=>!A.isDeleted))||[];M.length>0?M.forEach((A,F)=>{const Q=document.createElement("span");Q.textContent=A.value+(A.comment?"'":""),Q.style.position="relative",A.comment&&(Q.dataset.tooltip=A.comment),I.appendChild(Q),F<M.length-1&&I.appendChild(document.createTextNode(","))}):I.textContent="",I.style.cursor="pointer",I.addEventListener("click",()=>{Fe(d,S);const A=document.getElementById("category-selection-container");A&&A.scrollIntoView({behavior:"smooth",block:"center"})})}),b.insertCell().textContent=d.statusCounters.totalSelections||0,b.insertCell().textContent=h(d),b.insertCell().textContent=d.statusCounters.outOfClassCount||0,b.insertCell().textContent=d.statusCounters.missedChances||0;const y=Object.values(d.categoryIssues||{}).reduce((S,I)=>S+I,0);b.insertCell().textContent=y;const w=d.getOverallAverageScore();b.insertCell().textContent=w!==null?w:"-";const k=T.calculateFinalStudentScore(d);b.insertCell().textContent=k!==null?k:"-"}),Ie(T.students),Qn.setAttribute("data-student-count",u.length),s.appendChild(t);const v=s.querySelector(".student-stats-table"),p=v==null?void 0:v.querySelector("thead th:first-child");p&&p.addEventListener("click",()=>{v.classList.toggle("name-column-expanded")})}function Fe(s=null,o=null){const e=document.getElementById("selected-student-result");e.innerHTML="",e.classList.remove("absent");let l,a;if(s&&o)l=s,a=o,On({student:s,categoryName:o}),gt(-1);else{if(On(null),!K||et<0||!K.winnerHistory[et])return;const $=K.winnerHistory[et];l=$.winner,a=$.categoryName}const t=document.querySelector(".current-winner-highlight");if(t&&t.classList.remove("current-winner-highlight"),l){const $=document.querySelector(`.student-stats-table tr[data-student-id="${l.identity.studentId}"]`);$&&$.classList.add("current-winner-highlight")}const n=T.categories.find($=>$.name===a);if(n){An(n),Os(n);const $=document.querySelectorAll("#category-selection-container .pill");$.forEach(B=>B.classList.remove("active"));const ne=Array.from($).find(B=>B.textContent===a);ne&&ne.classList.add("active"),cs(n),ls(n.name)}const i=K.studentRecords[l.identity.studentId],r=(i==null?void 0:i.attendance)==="absent",u=document.createElement("div");u.className="winner-name-container";const h=document.createElement("button");h.className="btn-icon",h.innerHTML="˅",h.title="برنده قبلی";const v=!s;h.classList.toggle("is-disabled",!v||et<=0),h.addEventListener("click",()=>{h.classList.contains("is-disabled")?(h.classList.add("shake-animation"),setTimeout(()=>h.classList.remove("shake-animation"),200)):(gt(et-1),Fe())});const p=document.createElement("div");p.className="winner-name",p.innerHTML=`✨ <strong>${l.identity.name}</strong>✨`,p.classList.add("heartbeat-animation"),r&&(p.style.textDecoration="line-through",p.style.opacity="0.6",p.style.color="var(--color-secondary)"),(i==null?void 0:i.hadIssue)&&!r&&(p.style.color="var(--color-warning)",p.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"),(i==null?void 0:i.wasOutOfClass)&&!r&&(p.style.color="var(--color-strong-warning)",p.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود");const m=1e3,g=$=>{Pt=setTimeout(()=>{ur(l,a),Pt=null},m)},y=()=>{Pt&&(clearTimeout(Pt),Pt=null)};p.addEventListener("mousedown",g),p.addEventListener("mouseup",y),p.addEventListener("mouseout",y),p.addEventListener("touchstart",g),p.addEventListener("touchmove",y),p.addEventListener("touchend",y),p.addEventListener("touchcancel",y);const w=document.createElement("button");if(w.className="btn-icon",w.innerHTML="˄",w.title="برنده بعدی",w.classList.toggle("is-disabled",!v||et>=K.winnerHistory.length-1),w.addEventListener("click",()=>{w.classList.contains("is-disabled")?(w.classList.add("shake-animation"),setTimeout(()=>w.classList.remove("shake-animation"),200)):(gt(et+1),Fe())}),u.appendChild(w),u.appendChild(p),l.onboardingSession===K.sessionNumber){const $=document.createElement("div");$.className="new-student-badge",$.textContent="دانش آموز جدید",u.appendChild($)}u.appendChild(h),e.appendChild(u),nt.disabled=v&&!w.classList.contains("is-disabled");const k=document.createElement("div");k.className="status-button-container";const S=document.createElement("button");S.textContent="غایب",S.classList.add("status-button","absent-btn"),r&&S.classList.add("active");const I=document.createElement("button");I.textContent="مشکل",I.classList.add("status-button","issue-btn"),i!=null&&i.hadIssue&&I.classList.add("active");const z=document.createElement("button");z.textContent="خروج",z.classList.add("status-button","exit-btn"),i!=null&&i.wasOutOfClass&&z.classList.add("active");const M=document.createElement("button");M.textContent="پروفایل",M.className="status-button profile-btn",K.isFinished?S.disabled=!0:S.addEventListener("click",()=>{const $=S.classList.contains("active");z.classList.contains("active")&&(z.classList.remove("active"),i.wasOutOfClass=!1,l.statusCounters.outOfClassCount=Math.max(0,(l.statusCounters.outOfClassCount||0)-1),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)),$?(S.classList.remove("active"),K.setAttendance(l.identity.studentId,"present"),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1),p.style.textDecoration="",p.style.opacity="",p.style.color=""):(I.classList.contains("active")&&(I.classList.remove("active"),i.hadIssue=!1,l.statusCounters.otherIssues=Math.max(0,l.statusCounters.otherIssues-1),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)),S.classList.add("active"),K.setAttendance(l.identity.studentId,"absent"),l.statusCounters.missedChances++,p.style.textDecoration="line-through",p.style.opacity="0.6",p.style.color="var(--color-secondary)",p.title=""),Re(),setTimeout(()=>Fe(l,a),0),ce()}),K.isFinished?I.disabled=!0:I.addEventListener("click",()=>{const $=I.classList.contains("active");if(z.classList.contains("active")&&(z.classList.remove("active"),i.wasOutOfClass=!1,l.statusCounters.outOfClassCount=Math.max(0,(l.statusCounters.outOfClassCount||0)-1),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)),$){I.classList.remove("active"),i.hadIssue=!1;const ne=Ge.name;l.categoryIssues[ne]&&(l.categoryIssues[ne]=Math.max(0,l.categoryIssues[ne]-1)),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1),p.style.color="",p.title=""}else{S.classList.contains("active")&&(S.classList.remove("active"),K.setAttendance(l.identity.studentId,"present"),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)),I.classList.add("active"),i.hadIssue=!0;const ne=Ge.name;l.categoryIssues[ne]=(l.categoryIssues[ne]||0)+1,l.statusCounters.missedChances++,p.style.textDecoration="",p.style.opacity="",p.style.color="var(--color-warning)",p.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"}Re(),setTimeout(()=>Fe(l,a),0),ce()}),K.isFinished?z.disabled=!0:z.addEventListener("click",()=>{if(z.classList.contains("active"))z.classList.remove("active"),i.wasOutOfClass=!1,p.style.color="",p.title="";else{if(S.classList.contains("active")&&(S.classList.remove("active"),K.setAttendance(l.identity.studentId,"present"),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)),I.classList.contains("active")){I.classList.remove("active"),i.hadIssue=!1;const ne=Ge.name;l.categoryIssues[ne]&&(l.categoryIssues[ne]=Math.max(0,l.categoryIssues[ne]-1)),l.statusCounters.missedChances=Math.max(0,l.statusCounters.missedChances-1)}z.classList.add("active"),i.wasOutOfClass=!0,p.style.textDecoration="",p.style.opacity="",p.style.color="var(--color-strong-warning)",p.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود"}Re(),setTimeout(()=>Fe(l,a),0),ce()}),K.isFinished?M.disabled=!0:M.addEventListener("click",()=>{Me(l)}),k.appendChild(S),k.appendChild(z),k.appendChild(I),k.appendChild(M),e.appendChild(k);const j=document.createElement("div");j.className="student-details-container";const A=document.createElement("div");A.className="student-details-scores",A.innerHTML="<h4>آخرین نمرات</h4>";const F=document.createElement("ul");F.className="scores-list";const Q=T.categories.filter($=>$.isGradedCategory&&!$.isDeleted);let _=!1;const O=l.logs.scores||{};Q.forEach($=>{var Te;const ne=$.name,B=ne.toLowerCase(),D=document.createElement("li"),re=document.createElement("span");re.className="skill-name",re.textContent=`${ne}:`;const te=document.createElement("span");te.className="skill-scores";const Y=(Te=O[B])==null?void 0:Te.filter(Ne=>!Ne.isDeleted);Y&&Y.length>0?(_=!0,te.textContent=Y.slice(-3).map(Ne=>Ne.value+(Ne.comment?"'":"")).join(" , ")):te.textContent="none",D.appendChild(re),D.appendChild(te),F.appendChild(D)}),_||(F.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>'),A.appendChild(F),j.appendChild(A);const f=document.createElement("div");f.className="student-details-notes";const P=document.createElement("div");P.className="history-section-header";const ue=document.createElement("h4");ue.textContent="یادداشت‌ها";const Z=document.createElement("button");Z.className="btn-icon",Z.innerHTML="📝",Z.title="افزودن یادداشت جدید",K.isFinished?Z.disabled=!0:Z.addEventListener("click",()=>{we.value="",we.dispatchEvent(new Event("input",{bubbles:!0})),it($=>{$&&(l.addNote($),ce(),Fe(),ee("✅ یادداشت با موفقیت ثبت شد."))}),ze("add-note-modal"),we.focus()}),P.appendChild(ue),P.appendChild(Z),f.appendChild(P);const fe=document.createElement("ul");fe.className="notes-list",l.profile.notes&&l.profile.notes.length>0?[...l.profile.notes].sort((ne,B)=>new Date(B.timestamp)-new Date(ne.timestamp)).forEach(ne=>{const B=document.createElement("li");B.dir=ks(ne.content),B.textContent=ne.content,fe.appendChild(B)}):fe.innerHTML='<div class="no-content-message">یادداشتی وجود ندارد.</div>',f.appendChild(fe),j.appendChild(f),e.appendChild(j)}function xi(s){s.addEventListener("input",()=>{const o=s.value,e=ks(o);s.setAttribute("dir",e)})}function Ka(){Os(null),Vt.innerHTML="",ns.innerHTML="",Tt.classList.add("tooltip-container"),ct.disabled=!0,tt.disabled=!0,Ct.disabled=!0,ct.value="",tt.value="",At.classList.add("disabled-wrapper"),nt.disabled=!0}function wn(){Vt.innerHTML="",T.categories.filter(e=>!e.isDeleted).forEach(e=>{const l=document.createElement("span");l.className="pill",l.textContent=e.name,l.dataset.categoryId=e.id,e.description&&(l.dataset.tooltip=e.description),K.isFinished?l.classList.add("disabled"):l.addEventListener("click",()=>{document.querySelectorAll("#category-selection-container .pill").forEach(t=>t.classList.remove("active")),l.classList.add("active"),An(e),Os(e),cs(e),ls(e.name),At.classList.remove("disabled-wrapper"),nt.disabled=K.isFinished;const a=K.lastWinnerByCategory[e.name];if(a){const t=T.students.find(n=>n.identity.studentId===a);t&&Fe(t,e.name)}else{ns.innerHTML="",On(null),gt(-1),nt.disabled=!1;const t=document.querySelector(".current-winner-highlight");t&&t.classList.remove("current-winner-highlight")}}),K.isFinished||l.addEventListener("contextmenu",a=>{rn(a,[{label:"تغییر نام",icon:"✏️",action:()=>{as((n,i)=>{const r=Gs(T,e,n);r.success?(e.isGradedCategory=i,ce(),Se(T.info.name,`نام دسته‌بندی «${e.name}» به «${n}» تغییر یافت.`),wn(),Re(),ee(`✅ نام دسته‌بندی به «${n}» تغییر یافت.`)):ee(`⚠️ ${r.message}`)},{title:"ویرایش دسته‌بندی",initialName:e.name,initialIsGraded:e.isGradedCategory,saveButtonText:"ذخیره تغییرات"})}},{label:"حذف دسته‌بندی",icon:"🗑️",className:"danger",action:()=>{Ce(`آیا از انتقال دسته‌بندی «${e.name}» به سطل زباله مطمئن هستید؟`,()=>{const n={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${e.name}» از کلاس «${T.info.name}»`,restoreData:{categoryId:e.id,classId:T.info.scheduleCode}};pe.unshift(n),pe.length>50&&pe.pop();const i=e.name.toLowerCase();if(T.students.forEach(r=>{r.logs.scores&&r.logs.scores[i]&&r.logs.scores[i].forEach(u=>{u.isDeleted=!0})}),Ge&&Ge.id===e.id){An(null),ns.innerHTML="",cs(null),ls(null),At.classList.add("disabled-wrapper"),nt.disabled=!0;const r=document.querySelector(".current-winner-highlight");r&&r.classList.remove("current-winner-highlight")}e.isDeleted=!0,Se(T.info.name,`دسته‌بندی «${e.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),wn(),Re(),ee(`✅ دسته‌بندی «${e.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}}])}),Vt.appendChild(l)});const o=document.createElement("span");o.className="pill add-category-pill",o.textContent="+",o.title="افزودن دسته‌بندی جدید",K.isFinished?o.classList.add("disabled"):o.addEventListener("click",()=>{as((e,l)=>{if(T.categories.find(n=>n.name.toLowerCase()===e.toLowerCase()&&!n.isDeleted)){ee("⚠️ این دسته‌بندی از قبل وجود دارد.");return}const t=new ut(e,"",l);T.categories.push(t),ce(),Se(T.info.name,`دسته‌بندی جدید «${e}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),wn(),ee(`✅ دسته‌بندی «${e}» اضافه شد.`)})}),Vt.appendChild(o)}function Ja(){if(K.lastUsedCategoryId){if(K.isFinished)return;const s=Vt.querySelector(`.pill[data-category-id="${K.lastUsedCategoryId}"]`);s&&s.click()}K.winnerHistory&&K.winnerHistory.length>0&&(gt(K.winnerHistory.length-1),Fe())}function Os(s){s?nt.textContent=`نفر بعدی در ${s.name}`:nt.textContent="نفر بعدی"}function cs(s){if(K.isFinished){ct.disabled=!0,tt.disabled=!0,Ct.disabled=!0,Tt.setAttribute("title","جلسه خاتمه یافته است");return}s&&s.isGradedCategory?(ct.disabled=!1,tt.disabled=!1,Ct.disabled=!1,Tt.removeAttribute("title")):(ct.disabled=!0,tt.disabled=!0,Ct.disabled=!0,s?Tt.setAttribute("title","برای این دسته‌بندی قابلیت نمره دهی تعریف نشده است"):Tt.setAttribute("title","ابتدا یک دسته‌بندی را انتخاب کنید"))}function ls(s){const o=document.querySelector(".student-stats-table");if(!o||(o.querySelectorAll(".current-category-highlight").forEach(n=>{n.classList.remove("current-category-highlight")}),!s))return;let l=-1;const a=o.querySelectorAll("thead th");if(a.forEach((n,i)=>{n.textContent.trim()===s&&(l=i)}),l===-1)return;a[l].classList.add("current-category-highlight"),o.querySelectorAll("tbody tr").forEach(n=>{const i=n.cells[l];i&&i.classList.add("current-category-highlight")})}function Me(s){Ve(s);const o=document.getElementById("student-profile-modal"),e=document.getElementById("modal-profile-student-name"),l=document.getElementById("modal-profile-content-container"),a=document.getElementById("modal-profile-close-btn");if(!o||!e||!l||!a)return;e.textContent=`پروفایل: ${s.identity.name}`,e.style.cursor="pointer",e.onclick=()=>{const u=_e,h=T;ke(()=>{Bs(u,h)})},l.innerHTML="";const t=document.createElement("div");t.className="profile-header-actions";const n=document.createElement("button");n.className="btn-icon btn-icon-label",n.title="انتقال دانش‌آموز",n.innerHTML="<span>➡️</span><span>انتقال</span>",n.addEventListener("click",()=>{const u=_e,h=T;ke(()=>{Ts(u,h)})});const i=document.createElement("button");i.className="btn-icon btn-icon-label",i.title="حذف دانش‌آموز",i.innerHTML="<span>🗑️</span><span>حذف</span>",i.style.color="var(--color-strong-warning)",i.addEventListener("click",()=>{const u=_e,h=T;ke(()=>{Ce(`آیا از انتقال دانش‌آموز «${u.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const v={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${u.identity.name}» از کلاس «${h.info.name}»`,restoreData:{studentId:u.identity.studentId,classId:h.info.scheduleCode}};pe.unshift(v),pe.length>50&&pe.pop(),u.isDeleted=!0,Se(h.info.name,`دانش‌آموز «${u.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),lt(),Re(),st(),ee(`✅ دانش‌آموز «${u.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0,onCancel:()=>{Me(u)}})})});const r=document.createElement("button");r.className="btn-icon btn-icon-label",r.title="افزودن یادداشت جدید",r.innerHTML="<span>📝</span><span>یادداشت</span>",r.addEventListener("click",()=>{const u=_e;we.value="",we.dispatchEvent(new Event("input",{bubbles:!0})),it(h=>{h&&(u.addNote(h),ce(),Se(T.info.name,`یادداشت جدیدی برای دانش‌آموز «${u.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:u.identity.studentId}),Fe(),ee("✅ یادداشت با موفقیت ثبت شد.")),Me(u)}),ke(()=>{ze("add-note-modal"),we.focus()})}),t.appendChild(n),t.appendChild(i),t.appendChild(r),l.appendChild(t),Ya(l),Li(l),a.onclick=()=>ke(),ze("student-profile-modal")}function Ya(s){if(!_e||!T)return;const o=document.createElement("div");o.className="scoring-section",o.innerHTML=`
        <h3>ثبت نمره جدید</h3>
        <div id="modal-graded-pills" class="category-pills"></div>
        <div class="input-group centered-input-group" style="margin-top: 15px;">
            <input type="number" id="modal-new-score-value" placeholder="نمره (مثلا: 85)">
        </div>
        <textarea id="modal-new-score-comment" placeholder="توضیحات این نمره (اختیاری)..." style="margin-top: 10px;"></textarea>
        <button id="modal-add-score-btn" class="btn-success" style="width: 100%; margin-top: 10px;">ثبت نمره</button>
    `;const e=o.querySelector("#modal-graded-pills");Ie(T.categories).filter(t=>t.isGradedCategory).forEach(t=>{const n=document.createElement("span");n.className="pill",n.textContent=t.name,n.dataset.skillName=t.name,n.addEventListener("click",()=>{e.querySelectorAll(".pill").forEach(i=>i.classList.remove("active")),n.classList.add("active")}),e.appendChild(n)}),o.querySelector("#modal-add-score-btn").addEventListener("click",()=>{const t=e.querySelector(".pill.active");if(!t){ee("⚠️لطفاً یک مهارت را برای نمره‌دهی انتخاب کنید.");return}const n=t.dataset.skillName,i=o.querySelector("#modal-new-score-value"),r=o.querySelector("#modal-new-score-comment"),u=i.value,h=r.value.trim();if(!u){ee("لطفاً مقدار نمره را وارد کنید.");return}_e.addScore(n,parseFloat(u),h),ce(),Se(T.info.name,`نمره ${u} در ${n} برای «${_e.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:_e.identity.studentId}),Re(),Fe(),i.value="",r.value="";const v=document.getElementById("modal-profile-content-container"),p=v.querySelector(".history-section");p&&p.remove(),Li(v),ee(`✅ نمره برای مهارت ${n} با موفقیت ثبت شد.`)}),s.appendChild(o)}function Li(s){if(!_e)return;const o=document.createElement("div");o.className="history-section";const e=document.createElement("div");e.className="history-section-header";const l=document.createElement("h3");l.textContent="سوابق دانش‌آموز",e.appendChild(l),o.appendChild(e),Xa(o),Ti(o),Bi(o),s.appendChild(o)}function Xa(s){if(!_e)return;const o=_e,e=T.sessions.reduce((d,b)=>{const m=b.studentRecords[o.identity.studentId];return d+(m&&m.attendance==="absent"?1:0)},0),l=Object.values(o.categoryIssues||{}).reduce((d,b)=>d+b,0),a=document.createElement("div");a.className="stats-summary-box",a.innerHTML=`
        <p><strong>کل انتخاب:</strong> ${o.statusCounters.totalSelections}</p>
        <p><strong>غیبت:</strong> ${e}</p>
        <p><strong>فرصت از دست رفته:</strong> ${o.statusCounters.missedChances||0}</p>
        <p><strong>مشکل:</strong> ${l}</p>
    `,s.appendChild(a),a.querySelector("p:nth-child(1)");const t=a.querySelector("p:nth-child(4)"),n=Ie(T.categories),i=document.createElement("div");if(i.className="stats-breakdown",n.length>0){n.forEach(b=>{var w;const m=b.name,g=((w=o.categoryCounts)==null?void 0:w[m])||0,y=document.createElement("p");y.className="stats-breakdown-item",y.innerHTML=`<strong>${m}:</strong> ${g}`,i.appendChild(y)});const d=a.querySelector("p:first-child");d&&(d.classList.add("collapsible-toggle"),d.onclick=()=>{i.classList.toggle("open"),d.classList.toggle("open")},d.after(i))}const r=document.createElement("div");r.className="stats-breakdown",n.length>0&&(n.forEach(d=>{var y;const b=d.name,m=((y=o.categoryIssues)==null?void 0:y[b])||0,g=document.createElement("p");g.className="stats-breakdown-item",g.innerHTML=`<strong>${b}:</strong> ${m}`,r.appendChild(g)}),t&&(t.classList.add("collapsible-toggle"),t.onclick=()=>{r.classList.toggle("open"),t.classList.toggle("open")},a.appendChild(r)));const u=document.createElement("p"),h=document.createElement("strong");h.textContent="تکالیف ناقص:";const v=document.createElement("span");v.style.marginRight="5px";const p=Xe(T);Cn(o,p,v,{includePrefix:!1}),u.appendChild(h),u.appendChild(v),a.appendChild(u)}function Ti(s){if(!_e)return;const o=_e,e=document.createElement("h4");e.textContent="تاریخچه نمرات:",e.style.marginTop="20px";const l=document.createElement("ul");l.className="list-container";const a=Object.values(o.logs.scores||{}).flat().filter(t=>!t.isDeleted).sort((t,n)=>new Date(n.timestamp)-new Date(t.timestamp));a.length===0?l.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>':a.forEach(t=>{const n=document.createElement("li");n.className="score-history-item";const i=document.createElement("div");i.className="item-content";const r=document.createElement("div");r.className="score-info";const u=document.createElement("span");u.className="score-skill-badge",u.textContent=t.skill;const h=document.createElement("span");h.className="score-value",h.textContent=`نمره: ${t.value}`;const v=document.createElement("span");if(v.className="score-date",v.textContent=new Date(t.timestamp).toLocaleDateString("fa-IR"),r.appendChild(u),r.appendChild(h),r.appendChild(v),i.appendChild(r),t.comment){const d=document.createElement("p");d.className="score-comment",d.innerHTML=ci(t.comment),d.addEventListener("click",()=>{we.value=t.comment,we.dispatchEvent(new Event("input",{bubbles:!0})),it(b=>{t.comment=b,ce(),Se(T.info.name,`توضیحات نمره ${t.value} (${t.skill}) برای دانش‌آموز «${o.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:o.identity.studentId}),Me(o),ee("✅ توضیحات نمره با موفقیت ویرایش شد.")}),ke(()=>{ze("add-note-modal"),we.focus()})}),i.appendChild(d)}const p=document.createElement("button");p.className="btn-icon delete-item-btn",p.innerHTML="🗑️",p.title="حذف این نمره",p.addEventListener("click",()=>{ke(()=>{Ce(`آیا از انتقال نمره ${t.value} در مهارت «${t.skill}» به سطل زباله مطمئن هستید؟`,()=>{const d={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"score",description:`نمره ${t.value} (${t.skill}) برای «${o.identity.name}»`,restoreData:{scoreId:t.id,skill:t.skill,studentId:o.identity.studentId,classId:T.info.scheduleCode}};pe.unshift(d),pe.length>50&&pe.pop(),t.isDeleted=!0,ce(),Se(T.info.name,`نمره ${t.value} (${t.skill}) دانش‌آموز «${o.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),Me(o),ee("✅ نمره به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{Me(o)}})})}),n.appendChild(i),n.appendChild(p),l.appendChild(n)}),s.appendChild(e),s.appendChild(l)}function Bi(s){if(!_e)return;const o=document.createElement("h4");o.textContent="تاریخچه یادداشت‌ها:",o.style.marginTop="20px";const e=document.createElement("ul");e.className="list-container",!_e.profile.notes||_e.profile.notes.length===0?e.innerHTML='<div class="no-content-message">هنوز یادداشتی ثبت نشده است.</div>':[..._e.profile.notes].filter(a=>!a.isDeleted).sort((a,t)=>new Date(t.timestamp)-new Date(a.timestamp)).forEach(a=>{const t=document.createElement("li");t.className="note-history-item";const n=document.createElement("div");n.className="item-content";const i=document.createElement("div");i.className="note-info";const r=document.createElement("span");r.className="note-date",r.textContent=new Date(a.timestamp).toLocaleDateString("fa-IR");const u=document.createElement("button");u.className="btn-icon delete-item-btn",u.innerHTML="🗑️",u.title="حذف این یادداشت",u.addEventListener("click",()=>{const v=_e;ke(()=>{Ce("آیا از انتقال این یادداشت به سطل زباله مطمئن هستید؟",()=>{const p={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"note",description:`یادداشت برای دانش‌آموز «${v.identity.name}»`,restoreData:{noteId:a.id,studentId:v.identity.studentId,classId:T.info.scheduleCode}};pe.unshift(p),pe.length>50&&pe.pop(),a.isDeleted=!0,Se(T.info.name,`یادداشت دانش‌آموز «${v.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),Me(v),ee("✅ یادداشت به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{Me(v)}})})}),i.appendChild(r),i.appendChild(u);const h=document.createElement("p");h.className="note-content",h.innerHTML=ci(a.content),h.addEventListener("click",()=>{const v=_e;we.value=a.content,we.dispatchEvent(new Event("input",{bubbles:!0})),it(p=>{a.content=p,ce(),Se(T.info.name,`یادداشت دانش‌آموز «${v.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:v.identity.studentId}),Me(v),ee("✅یادداشت با موفقیت ویرایش شد.")}),ke(()=>{ze("add-note-modal"),we.focus()})}),n.appendChild(i),n.appendChild(h),t.appendChild(n),e.appendChild(t)}),s.appendChild(o),s.appendChild(e)}function Ni(s){Yn.innerHTML="",s.forEach((o,e)=>{const l=document.createElement("option");l.value=e,l.textContent=o.trim(),Yn.appendChild(l)})}function ds(){Jn.innerHTML="",ms.forEach(s=>{const o=document.createElement("li");o.className="preview-item";const e=document.createElement("input");e.type="checkbox",e.checked=!0,e.dataset.name=s;const l=document.createElement("label");l.textContent=s,o.appendChild(e),o.appendChild(l),Jn.appendChild(o)})}function Qa(s){const o=document.createElement("div");o.className="list-item-buttons";const e=document.createElement("button");return e.className="btn-icon",e.innerHTML="📝",e.title="ویرایش یادداشت کلاس",s.note||(e.style.display="none"),e.addEventListener("click",l=>{l.stopPropagation(),Fn(s)}),o.appendChild(e),o}function er(s){const o=document.createElement("div");o.style.flexGrow="1",o.style.display="flex",o.style.flexDirection="column",o.style.alignItems="flex-start";const e=document.createElement("span");e.textContent=s.info.name,e.classList.add("class-name-display"),o.appendChild(e);const l=Ie(s.students).length,a=Ie(s.sessions).filter(u=>u.isFinished).length,t=cr(s.info.scheduleDays),n=document.createElement("div");n.classList.add("class-stats-row");const i=document.createElement("span");i.textContent=`${l} نفر`,i.classList.add("student-count-badge"),n.appendChild(i);const r=document.createElement("span");if(r.textContent=`${a} جلسه`,r.classList.add("session-count-badge"),n.appendChild(r),t){const u=document.createElement("span");u.textContent=t,u.classList.add("schedule-days-badge"),n.appendChild(u)}return o.appendChild(n),o.addEventListener("click",()=>{Pe(s),Ue(null),Qt(T.liveSession),We(),ge("session-page")}),o}function tr(s){const o=document.createElement("li"),e=document.createElement("input");e.type="checkbox",e.className="mass-selection-checkbox",e.checked=rt.includes(s.info.name),e.addEventListener("click",u=>{u.stopPropagation()}),e.addEventListener("change",()=>{const u=s.info.name;if(e.checked)rt.includes(u)||rt.push(u);else{const h=rt.indexOf(u);h>-1&&rt.splice(h,1)}}),o.appendChild(e);const l=er(s);o.appendChild(l);const a=document.createElement("div");a.style.display="flex",a.style.flexDirection="column",a.style.gap="5px",a.style.alignItems="flex-end",a.style.marginLeft="10px";const t=document.createElement("div");if(t.className="list-item-badges",s.liveSession&&!s.liveSession.isCancelled&&!s.liveSession.isDeleted){const u=document.createElement("span");u.className="warning-badge",u.textContent="جلسه باز",t.appendChild(u),o.classList.add("has-unfinished-session")}const n=document.createElement("span");if(n.className=`type-badge ${s.info.type}`,n.textContent=s.info.type==="online"?"آنلاین":"حضوری",n.title="نوع کلاس",t.appendChild(n),us(s).type==="incomplete"){const u=document.createElement("span");u.className="type-badge cancelled-badge",u.textContent="زمان‌بندی ناقص",u.style.cursor="pointer",u.title="برای تکمیل زمان‌بندی کلیک کنید",u.addEventListener("click",h=>{h.stopPropagation(),Ce("زمان‌بندی این کلاس کامل نیست. برای نمایش صحیح در لیست، لطفاً روزها و ساعت برگزاری را مشخص کنید.",()=>{Dt(s)},{confirmText:"تنظیمات",confirmClass:"btn-primary"})}),t.appendChild(u)}else{const u=or(s,oe);if(u){const h=document.createElement("span");h.className="type-badge conflict-badge",h.textContent="تداخل زمانی",h.style.cursor="pointer",h.title=`تداخل با کلاس: ${u}`,h.addEventListener("click",v=>{v.stopPropagation(),Ce(`زمان برگزاری این کلاس با کلاس «${u}» تداخل دارد. لطفاً زمان‌بندی را بررسی کنید.`,()=>{Dt(s)},{confirmText:"تنظیمات",confirmClass:"btn-primary"})}),t.appendChild(h)}}a.appendChild(t);const r=Qa(s);return a.appendChild(r),o.appendChild(a),o.addEventListener("contextmenu",u=>{const h={label:"پشتیبان‌گیری از این کلاس",icon:"📤",action:()=>{sn([s.info.name])}},v=rt.length;v>1&&rt.includes(s.info.name)&&(h.label=`پشتیبان‌گیری از ${v} کلاس`,h.action=()=>{sn(rt),Gn([]),He()});const p=[{label:Bt.classList.contains("selection-mode-active")?"لغو انتخاب":"انتخاب چند کلاس",icon:"✔️",action:()=>{const d=Bt.classList.contains("selection-mode-active");Bt.classList.toggle("selection-mode-active"),d&&(Gn([]),He())}},h,{label:"یادداشت کلاس",icon:"📝",action:()=>{Fn(s)}},{label:"تنظیمات کلاس",icon:"⚙️",action:()=>{Dt(s)}},{label:"گزارش فعالیت‌ها",icon:"📋",action:()=>{Si(s.info.name)}},{label:"تغییر نام",icon:"✏️",action:()=>{const d=s.info.name,b=document.getElementById("add-note-modal-title");b.textContent="تغییر نام کلاس",we.value=d,we.rows=1,it(m=>{const g=m.trim();if(g&&g!==d){const y=qs(d,g);y.success?(Zi(d,g),Se(g,`نام کلاس از «${d}» به «${g}» تغییر یافت.`,{type:"VIEW_SESSIONS"}),ce(),He(),ee(`✅نام کلاس به «${g}» تغییر یافت.`)):ee(y.message)}b.textContent="ثبت یادداشت جدید",we.rows=4}),ze("add-note-modal"),we.focus(),we.select()}},{label:"حذف کلاس",icon:"🗑️",className:"danger",action:()=>{Ce(`آیا از انتقال کلاس «${s.info.name}» به سطل زباله مطمئن هستید؟`,()=>{const d={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"classroom",description:`کلاس «${s.info.name}»`,restoreData:{name:s.info.name}};pe.unshift(d),pe.length>50&&pe.pop(),s.isDeleted=!0,ce(),He(),ee(`✅ کلاس «${s.info.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}];rn(u,p)}),o}function Pn(){const s=document.getElementById("class-management-stats");if(!s)return;const o=Object.values(oe).filter(t=>!t.isDeleted),e=o.length,l=o.reduce((t,n)=>t+Ie(n.students).length,0);let a="";je.lastBackupTimestamp&&(a=`
            <div class="stats-row backup-stat">
                <span>آخرین پشتیبان: <strong>${new Date(je.lastBackupTimestamp).toLocaleString("fa-IR",{year:"numeric",month:"numeric",day:"numeric",weekday:"long",hour:"2-digit",minute:"2-digit"})}</strong></span>
            </div>
        `),s.innerHTML=`
        <div class="stats-row main-stats">
            <span>کل کلاس‌ها: <strong>${e}</strong></span>
            <span>|</span>
            <span>کل دانش‌آموزان: <strong>${l}</strong></span>
        </div>
        ${a} 
    `}function He(){Pn(),Bt.innerHTML="",Object.values(oe).sort((o,e)=>{const l=us(o),a=us(e);return l.sortIndex!==a.sortIndex?l.sortIndex-a.sortIndex:l.type==="upcoming"?l.nextTimestamp-a.nextTimestamp:new Date(o.info.creationDate)-new Date(e.info.creationDate)}).forEach(o=>{if(o.isDeleted)return;const e=tr(o);Bt.appendChild(e)})}function lt(){Vn.innerHTML="",T&&Ie(T.students).forEach(s=>{const o=document.createElement("li"),e=document.createElement("span");e.textContent=s.identity.name,e.style.flexGrow="1",e.className="student-name-link",e.addEventListener("click",()=>{Me(s)}),o.appendChild(e),o.addEventListener("contextmenu",l=>{rn(l,[{label:"تغییر نام",icon:"✏️",action:()=>{Bs(s,T)}},{label:"انتقال دانش‌آموز",icon:"➡️",action:()=>{Ts(s,T)}},{label:"حذف دانش‌آموز",icon:"🗑️",className:"danger",action:()=>{Ce(`آیا از انتقال دانش‌آموز «${s.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const t={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${s.identity.name}» از کلاس «${T.info.name}»`,restoreData:{studentId:s.identity.studentId,classId:T.info.scheduleCode}};pe.unshift(t),pe.length>50&&pe.pop(),s.isDeleted=!0,Se(T.info.name,`دانش‌آموز «${s.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),lt(),ee(`✅ دانش‌آموز «${s.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}])}),Vn.appendChild(o)})}function Mt(){if(Kn.innerHTML="",!T)return;T.categories.filter(o=>!o.isDeleted).forEach(o=>{const e=document.createElement("li"),l=document.createElement("div");l.className="name-and-badge-container";const a=document.createElement("span");if(a.textContent=o.name,l.appendChild(a),o.isGradedCategory){const n=document.createElement("span");n.className="category-badge",n.textContent="نمره‌دار",l.appendChild(n)}const t=document.createElement("button");t.className="btn-icon",t.innerHTML="🗑️",t.style.color="var(--color-warning)",t.addEventListener("click",()=>{Ce(`آیا از انتقال دسته‌بندی «${o.name}» به سطل زباله مطمئن هستید؟`,()=>{const n={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${o.name}» از کلاس «${T.info.name}»`,restoreData:{categoryId:o.id,classId:T.info.scheduleCode}};pe.unshift(n),pe.length>50&&pe.pop(),o.isDeleted=!0,Se(T.info.name,`دسته‌بندی «${o.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),Mt(),ee(`✅ دسته‌بندی «${o.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}),e.appendChild(l),e.appendChild(t),Kn.appendChild(e)})}function Di(){if(!T)return;const s=T.info.type||"in-person",o=document.querySelector(`#settings-page input[name="class-type-setting"][value="${s}"]`);o&&(o.checked=!0);const e=T.info.scheduleDays||[];document.querySelectorAll('input[name="schedule-day"]').forEach(l=>{l.checked=e.includes(parseInt(l.value))}),document.getElementById("settings-schedule-start").value=T.info.scheduleStartTime||"",document.getElementById("settings-schedule-end").value=T.info.scheduleEndTime||""}function Yt(s){document.querySelectorAll(".page").forEach(e=>{e.classList.remove("active")});const o=document.getElementById(s);o&&o.classList.add("active"),s==="class-management-page"?(Pe(null),Ue(null),Ve(null),He(),Xn.style.display="flex"):Xn.style.display="none",Ii()}function ge(s,o={}){const{tab:e}=o,l={pageId:s,currentClassName:T?T.info.name:null,selectedSessionNumber:K?K.sessionNumber:null,selectedStudentId:_e?_e.identity.studentId:null};let a=`#${s}`;const t=new URLSearchParams(window.location.hash.split("?")[1]||"");T?t.set("class",T.info.name):t.delete("class"),K?t.set("session",K.sessionNumber):t.delete("session"),_e?t.set("student",_e.identity.studentId):t.delete("student"),s==="session-dashboard-page"&&e?t.set("tab",e):s!=="session-dashboard-page"&&t.delete("tab");const n=t.toString();n&&(a+=`?${n}`),window.location.hash!==a&&history.pushState(l,"",a),Yt(s)}function nr(s,o){const e=document.createElement("div");e.className="list-item-buttons",e.style.gap="10px";const l=document.createElement("button");if(l.className="btn-icon",l.innerHTML="📝",l.title="ویرایش یادداشت جلسه",s.note||(l.style.display="none"),l.addEventListener("click",a=>{a.stopPropagation(),As(s,o)}),!s.isFinished&&!s.isCancelled){const a=document.createElement("button");a.className="btn-success",a.textContent="پایان جلسه",a.style.fontSize="12px",a.style.padding="4px 10px",a.style.whiteSpace="nowrap",a.addEventListener("click",t=>{t.stopPropagation(),Ce(`جلسه شماره ${o} خاتمه پیدا خواهد کرد!`,()=>{T.endSpecificSession(s.sessionNumber),ce(),Se(T.info.name,`جلسه ${o} خاتمه یافت.`,{type:"VIEW_SESSIONS"}),We(),Ce("جلسه با موفقیت خاتمه یافت. آیا مایل به ایجاد فایل پشتیبان هستید؟",()=>{if(ot){ee("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است.");return}sn(),ee("✅فایل پشتیبان با موفقیت ایجاد شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}),e.appendChild(a)}return e.appendChild(l),e}function sr(s,o){const e=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="flex-start",e.style.flexGrow="1";const l=new Date(s.startTime).toLocaleDateString("fa-IR"),a=document.createElement("span");a.className="session-list-title";const t=document.createElement("div");t.style.display="flex",t.style.gap="5px",t.style.marginTop="5px";const n=new Date(s.startTime).toLocaleDateString("fa-IR",{weekday:"long"}),i=document.createElement("span");if(i.className="type-badge day-badge",i.textContent=n,t.appendChild(i),s.isCancelled){a.textContent=`لغو شده - تاریخ: ${l}`,e.style.cursor="default";const r=document.createElement("span");r.className="type-badge cancelled-badge",r.textContent="لغو شده",t.appendChild(r)}else a.textContent=`جلسه ${o} - تاریخ: ${l}`,e.style.cursor="pointer",e.addEventListener("click",()=>{Ue(s),Rt()});if(e.appendChild(a),s.isFinished){const r=document.createElement("span");r.className="type-badge finished-badge",r.textContent="خاتمه یافته",t.appendChild(r)}if(s.isMakeup){const r=document.createElement("span");r.className="type-badge makeup-badge",r.textContent="جبرانی",t.appendChild(r)}return e.appendChild(t),e}function ir(s,o){const e=document.createElement("li"),l=o.get(s.sessionNumber),a=sr(s,l);e.appendChild(a);const t=nr(s,l);return e.appendChild(t),e.addEventListener("contextmenu",n=>{const i=[{label:"یادداشت جلسه",icon:"📝",action:()=>{As(s,l)}},{label:s.isCancelled?"بازگردانی جلسه":"لغو جلسه",icon:"❌",action:()=>{const r=s.isCancelled?"بازگردانی جلسه":"لغو جلسه",u=s.isCancelled?"آیا از بازگردانی این جلسه مطمئن هستید؟":"آیا از لغو این جلسه مطمئن هستید؟ جلسه لغو شده در آمار تاثیری ندارد اما قابل بازگردانی است.";Ce(u,()=>{s.isCancelled=!s.isCancelled;const h=s.isCancelled?`جلسه ${l} لغو شد.`:`جلسه لغو شده (تاریخ: ${new Date(s.startTime).toLocaleDateString("fa-IR")}) بازگردانی شد.`;Se(T.info.name,h,{type:"VIEW_SESSIONS"}),ce(),We(),ee(s.isCancelled?"✅جلسه لغو شد.":"✅جلسه بازگردانی شد.")},{confirmText:r,confirmClass:"btn-warning"})}},{label:"تغییر وضعیت جبرانی",icon:"🔄",action:()=>{T.markAsMakeup(s.sessionNumber),ce();const r=s.isMakeup?`جلسه ${l} به عنوان جبرانی علامت‌گذاری شد.`:`جلسه ${l} از حالت جبرانی خارج شد.`;Se(T.info.name,r,{type:"VIEW_SESSIONS"}),We()}},{label:"حذف جلسه",icon:"🗑️",className:"danger",action:()=>{const r=s.isCancelled?"لغو شده":l;Ce(`آیا از انتقال جلسه ${r} به سطل زباله مطمئن هستید؟`,()=>{const u={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"session",description:`جلسه ${r} از کلاس «${T.info.name}»`,restoreData:{sessionNumber:s.sessionNumber,classId:T.info.scheduleCode}};pe.unshift(u),pe.length>50&&pe.pop(),s.isDeleted=!0,Se(T.info.name,`جلسه ${r} به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),We(),ee(`✅ جلسه ${r} به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}];rn(n,i)}),e}function We(){const s=document.getElementById("session-list");if(!T)return;if(s.innerHTML="",T.sessions.length===0){s.innerHTML="<li>هنوز جلسه‌ای شروع نشده است.</li>";return}const o=Xe(T);[...Ie(T.sessions)].reverse().forEach(l=>{const a=ir(l,o);s.appendChild(a)})}function Zt(s){if(ht.innerHTML="",s.length>0)s.forEach(o=>{const e=document.createElement("div");e.textContent=o.identity.name,e.addEventListener("click",()=>{Me(o),ht.style.display="none",ts.value=""}),ht.appendChild(e)}),ht.style.display="block";else if(ts.value.trim()!==""){const o=document.createElement("div");o.className="no-results",o.textContent="پیدا نشد",ht.appendChild(o),ht.style.display="block"}else ht.style.display="none"}function En(s){if(at.innerHTML="",s.length>0)s.forEach(o=>{const e=document.createElement("div");if(e.className="global-search-result",o.type==="student"){const l=document.createElement("span");l.className="student-name",l.textContent=o.student.identity.name;const a=document.createElement("span");a.className="class-name",a.textContent=`کلاس: ${o.classroom.info.name}`,e.addEventListener("click",()=>{Pe(o.classroom),Me(o.student),at.style.display="none",Ut.value=""}),a.addEventListener("click",t=>{t.stopPropagation(),Pe(o.classroom),Ue(null),Qt(o.classroom.liveSession),We(),ge("session-page"),at.style.display="none",Ut.value=""}),e.appendChild(l),e.appendChild(a)}else if(o.type==="classroom"){const l=document.createElement("span");l.className="student-name",l.textContent=`[کلاس] ${o.classroom.info.name}`,e.addEventListener("click",()=>{Pe(o.classroom),Ue(null),Qt(o.classroom.liveSession),We(),ge("session-page"),at.style.display="none",Ut.value=""}),e.appendChild(l)}at.appendChild(e)}),at.style.display="block";else if(Ut.value.trim()!==""){const o=document.createElement("div");o.className="no-results",o.textContent="پیدا نشد",at.appendChild(o),at.style.display="block"}else at.style.display="none"}function an(){const s=document.getElementById("trashed-items-list");if(s.innerHTML="",pe.length===0){s.innerHTML='<li style="text-align: center; padding: 20px;">سطل زباله خالی است.</li>';return}pe.forEach((o,e)=>{const l=document.createElement("li"),a=document.createElement("span");a.textContent=o.description,a.style.flexGrow="1";const t=document.createElement("div");t.className="list-item-buttons";const n=document.createElement("button");n.className="btn-icon",n.innerHTML="🔄",n.title="بازیابی",n.addEventListener("click",()=>{var v;let r=!1,u=null;const h=o.restoreData;switch(o.type){case"classroom":{const p=oe[h.name];p&&!p.isDeleted?u=`کلاسی با نام «${h.name}» از قبل فعال است.`:p&&p.isDeleted&&(p.isDeleted=!1,r=!0);break}case"student":{const p=Object.values(oe).find(b=>b.info.scheduleCode===h.classId),d=p==null?void 0:p.students.find(b=>b.identity.studentId===h.studentId);d&&(d.isDeleted=!1,r=!0);break}case"session":{const p=Object.values(oe).find(b=>b.info.scheduleCode===h.classId),d=p==null?void 0:p.sessions.find(b=>b.sessionNumber===h.sessionNumber);d&&(d.isDeleted=!1,r=!0);break}case"category":{const p=Object.values(oe).find(b=>b.info.scheduleCode===h.classId),d=p==null?void 0:p.categories.find(b=>b.id===h.categoryId);d&&(d.isDeleted=!1,r=!0);break}case"score":{const p=Object.values(oe).find(m=>m.info.scheduleCode===h.classId),d=p==null?void 0:p.students.find(m=>m.identity.studentId===h.studentId),b=(v=d==null?void 0:d.logs.scores[h.skill.toLowerCase()])==null?void 0:v.find(m=>m.id===h.scoreId);b&&(b.isDeleted=!1,r=!0);break}case"note":{const p=Object.values(oe).find(m=>m.info.scheduleCode===h.classId),d=p==null?void 0:p.students.find(m=>m.identity.studentId===h.studentId),b=d==null?void 0:d.profile.notes.find(m=>m.id===h.noteId);b&&(b.isDeleted=!1,r=!0);break}}r?(pe.splice(e,1),ce(),an(),o.type==="classroom"&&He(),ee("✅ آیتم با موفقیت بازیابی شد.")):ee(u?`⚠️ ${u}`:"⚠️ آیتم اصلی برای بازیابی یافت نشد.")});const i=document.createElement("button");i.className="btn-icon",i.innerHTML="🔥",i.title="حذف دائمی",i.addEventListener("click",()=>{Ce("آیا از حذف دائمی این آیتم مطمئن هستید؟ این عمل غیرقابل بازgشت است.",()=>{const r=o.restoreData,u=v=>Object.values(oe).find(p=>p.info.scheduleCode===v);let h;switch(o.type){case"classroom":delete oe[r.name];break;case"student":h=u(r.classId),Nn({identity:{studentId:r.studentId}},h);break;case"session":h=u(r.classId),h&&Js(h.info.name,r.sessionNumber);break;case"category":h=u(r.classId),h&&Ys(h.info.name,r.categoryId);break;case"score":h=u(r.classId),h&&Xs(h.info.name,r.studentId,r.skill,r.scoreId);break;case"note":h=u(r.classId),h&&Qs(h.info.name,r.studentId,r.noteId);break}pe.splice(e,1),ce(),an(),ee("✅ آیتم برای همیشه حذف شد.")},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),t.appendChild(n),t.appendChild(i),l.appendChild(a),l.appendChild(t),s.appendChild(l)})}function ar(){const s=document.getElementById("absentees-summary-container");s&&(s.innerHTML=`
        <div id="absentees-summary-box" class="absentees-summary">
            <div class="absentees-summary-header">
                <h4>لیست غایبین جلسه شماره <span id="absentee-summary-session-number"></span></h4>
                <button id="copy-absentees-btn" class="btn-icon" title="کپی لیست غایبین">📋</button>
            </div>
            <div id="absentees-summary-list" class="summary-list"></div>
        </div>
    `)}function Ai(){const s=document.getElementById("absentees-summary-box"),o=document.getElementById("absentees-summary-list"),e=document.getElementById("absentee-summary-session-number");if(!s||!o||!e){console.error("Could not find all absentee summary elements.");return}if(!T||!K){s.classList.remove("visible");return}const l=Ie(T.students).filter(t=>{const n=K.studentRecords[t.identity.studentId];return n&&n.attendance==="absent"}),a=Xe(T);e.textContent=a.get(K.sessionNumber),l.length>0?s.classList.add("visible"):s.classList.remove("visible"),o.innerHTML="",l.forEach(t=>{const i=(u=>T.sessions.reduce((h,v)=>{if(v.isDeleted||v.isCancelled)return h;const p=v.studentRecords[u.identity.studentId];return h+(p&&p.attendance==="absent"?1:0)},0))(t),r=document.createElement("span");r.className="summary-name",r.textContent=`${t.identity.name} (غیبت: ${i})`,r.addEventListener("click",()=>{r.classList.add("fading-out"),setTimeout(()=>{K.setAttendance(t.identity.studentId,"present"),ce(),st()},200)}),o.appendChild(r)})}function rr(){const s=document.getElementById("copy-absentees-btn");if(!s){console.error("Could not find the copy absentees button to attach listener.");return}s.addEventListener("click",()=>{if(!T||!K)return;const o=Ie(T.students).filter(a=>{const t=K.studentRecords[a.identity.studentId];return t&&t.attendance==="absent"});if(o.length===0){ee("⚠️لیست غایبین خالی است.");return}const e=a=>T.sessions.reduce((t,n)=>{if(n.isDeleted||n.isCancelled)return t;const i=n.studentRecords[a.identity.studentId];return t+(i&&i.attendance==="absent"?1:0)},0);let l=`لیست غایبین جلسه شماره ${Va()}:

`;o.forEach(a=>{const t=e(a);l+=`- ${a.identity.name} (تعداد غیبت‌ها: ${t})
`}),navigator.clipboard.writeText(l).then(()=>{ee("✅لیست غایبین با موفقیت کپی شد.")}).catch(a=>{console.error("Failed to copy text: ",a),ee("❌خطا در کپی کردن لیست.")})})}function _n(){const s=document.getElementById("demo-mode-banner");s&&(ot?(s.classList.add("visible"),document.body.classList.add("demo-mode-active")):(s.classList.remove("visible"),document.body.classList.remove("demo-mode-active")))}function us(s){const{scheduleDays:o,scheduleStartTime:e,scheduleEndTime:l}=s.info,a=o&&o.length>0,t=e&&l;if(!a&&!t)return{type:"unscheduled",sortIndex:3};if(!a||!t)return{type:"incomplete",sortIndex:2};const n=new Date,i=n.getDay(),r=n.getHours()*60+n.getMinutes(),[u,h]=e.split(":").map(Number),[v,p]=l.split(":").map(Number),d=u*60+h,b=v*60+p;if(o.includes(i)&&r>=d&&r<b)return{type:"active",sortIndex:0};for(let m=0;m<=7;m++){const g=(i+m)%7;if(o.includes(g)){if(m===0&&r>=d)continue;const y=new Date(n);return y.setDate(n.getDate()+m),y.setHours(u,h,0,0),{type:"upcoming",sortIndex:1,nextTimestamp:y.getTime()}}}return{type:"upcoming",sortIndex:1,nextTimestamp:9999999999999}}function or(s,o){const{scheduleDays:e,scheduleStartTime:l,scheduleEndTime:a}=s.info;if(!e||!e.length||!l||!a)return null;const[t,n]=l.split(":").map(Number),[i,r]=a.split(":").map(Number),u=t*60+n,h=i*60+r;for(const v of Object.values(o)){if(v===s||v.isDeleted||v.info.name===s.info.name)continue;const p=v.info;if(!p.scheduleDays||!p.scheduleDays.length||!p.scheduleStartTime||!p.scheduleEndTime||!e.some(S=>p.scheduleDays.includes(S)))continue;const[b,m]=p.scheduleStartTime.split(":").map(Number),[g,y]=p.scheduleEndTime.split(":").map(Number),w=b*60+m,k=g*60+y;if(u<k&&h>w)return v.info.name}return null}function cr(s){if(!s||s.length===0)return"";const o={6:"شنبه",0:"۱شنبه",1:"۲شنبه",2:"۳شنبه",3:"۴شنبه",4:"۵شنبه",5:"جمعه"};return[...s].sort((l,a)=>{const t={6:0,0:1,1:2,2:3,3:4,4:5,5:6};return t[l]-t[a]}).map(l=>o[l]).join("، ")}const lr=Object.freeze(Object.defineProperty({__proto__:null,_internalShowPage:Yt,addCategoryBtn:la,addClassBtn:Gi,addNoteModal:Ea,addScoreBtn:La,addStudentBtn:Xi,appHeader:Xn,attendanceListUl:Gt,attendanceMassActionsContainer:vn,attendancePage:da,attendancePane:Ot,attendanceSearchInput:bt,backToSessionsBtn:Ji,backToStudentPageBtn:Sa,backupDataBtn:ya,breadcrumbContainer:Lt,cancelImportBtn:oa,cancelNoteBtn:ka,categoryListUl:Kn,categoryModal:$a,categoryModalCancelBtn:Fa,categoryModalSaveBtn:Ci,categoryModalTitle:vi,classListHeader:fa,classListUl:Bt,classManagementPage:ui,classSaveNoteBtn:_a,closeActiveModal:ke,closeContextMenu:vt,closeNavBtn:pa,columnMappingPage:aa,columnSelectDropdown:Yn,confirmColumnBtn:ra,confirmModalCancelBtn:es,confirmModalConfirmBtn:Wt,confirmModalMessage:pi,contextMenu:wt,csvCancelBtn:na,csvConfirmBtn:ta,csvFileInput:ia,csvPreviewList:Jn,csvPreviewPage:ea,customConfirmModal:va,displayWinner:Fe,finishAttendanceBtn:ua,globalStudentSearchInput:Ut,globalStudentSearchResultsDiv:at,gradedCategoryPillsContainer:Ia,hamburgerMenuBtn:ma,handleUndo:_i,importCsvBtn:sa,initiateBackupProcess:sn,isGradedCheckbox:Na,massCommentAppendCheckbox:Ls,massCommentBtn:ss,massCommentCancelBtn:Wa,massCommentContent:Jt,massCommentModal:Pa,massCommentModalTitle:Ha,massCommentSaveBtn:Ua,massCommentStudentCountMessage:wi,newCategoryModalIsGradedCheckbox:xs,newCategoryModalNameInput:Kt,newCategoryNameInput:ca,newClassNameInput:qi,newNoteContent:we,newScoreCommentTextarea:bi,newScoreValueInput:xa,newStudentNameInput:Yi,openContextMenu:rn,openModal:ze,overlay:ga,pasteArea:mi,processMassHomeworkComment:rs,processPasteBtn:Qi,profileScoresListUl:Ba,profileStatsSummaryDiv:Ta,quickGradeFormWrapper:Tt,quickGradeSubmitBtn:Ct,quickNoteTextarea:tt,quickScoreInput:ct,renderAttendancePage:st,renderBreadcrumbs:Ii,renderClassList:He,renderClassManagementStats:Pn,renderColumnSelector:Ni,renderGlobalSearchResults:En,renderImportPreview:ds,renderLogModal:Si,renderMassCommentControls:Ns,renderScoresHistory:Ti,renderSearchResults:Zt,renderSessionDashboard:Rt,renderSessions:We,renderSettingsCategories:Mt,renderSettingsOther:Di,renderSettingsStudentList:lt,renderStudentNotes:Bi,renderStudentStatsList:Re,renderTrashPage:an,restoreDataBtn:ba,restoreFileInput:hi,secureConfirmCancelBtn:wa,secureConfirmCode:yi,secureConfirmConfirmBtn:bn,secureConfirmInput:xt,secureConfirmMessage:gi,secureConfirmModal:Ca,selectStudentBtn:nt,selectStudentBtnWrapper:At,sessionDashboardPage:ja,setAutoDirectionOnInput:xi,settingsClassNameHeader:Is,settingsPage:Ki,settingsStudentListUl:Vn,setupDashboardTabs:Ei,setupLongPress:jt,showCategoryModal:as,showClassNoteModal:Fn,showCustomConfirm:Ce,showMassCommentModal:Ds,showMoveStudentModal:Ts,showNotification:ee,showPage:ge,showRenameStudentModal:Bs,showRestoreConfirmModal:is,showSecureConfirm:ki,showSessionNoteModal:As,showSettingsPage:Dt,showStudentProfile:Me,showUndoToast:Za,sideNavMenu:ha,studentSearchInput:ts,studentSearchResultsDiv:ht,studentStatsHeader:Qn,switchDashboardTab:nn,trashedCategoriesList:Ra,trashedClassesList:Da,trashedNotesList:Ma,trashedScoresList:za,trashedSessionsList:Oa,trashedStudentsList:Aa,triggerFileDownload:os,undoBtn:Vi,undoMessage:fi,undoToast:Mn,updateDemoModeBanner:_n},Symbol.toStringTag,{value:"Module"}));function dr(){const s=window.location.hash;if(!s||s==="#")return!1;const[o,e]=s.split("?"),l=o.substring(1),a=new URLSearchParams(e),t=a.get("class"),n=parseInt(a.get("session"),10),i=a.get("student"),r=a.get("tab")||"selector";if(t&&oe[t])Pe(oe[t]),n&&T.getSession(n)&&Ue(T.getSession(n)),i&&T.students.find(u=>u.identity.studentId===i)&&Ve(T.students.find(u=>u.identity.studentId===i));else return!1;switch(l){case"session-page":We(),ge("session-page");break;case"session-dashboard-page":Rt(l==="attendance-page"?"attendance":r);break;case"settings-page":Is.textContent=`تنظیمات کلاس: ${T.info.name}`,lt(),Mt(),ge("settings-page");break;case"student-profile-page":Rt(r),Me(_e);break;default:return!1}return!0}document.addEventListener("DOMContentLoaded",()=>{const{globalStudentSearchInput:s,newClassNameInput:o,addClassBtn:e,undoBtn:l,newStudentNameInput:a,addStudentBtn:t,pasteArea:n,processPasteBtn:i,csvPreviewList:r,csvConfirmBtn:u,csvCancelBtn:h,importCsvBtn:v,csvFileInput:p,columnSelectDropdown:d,confirmColumnBtn:b,cancelImportBtn:m,newCategoryNameInput:g,addCategoryBtn:y,selectStudentBtn:w,attendancePage:k,finishAttendanceBtn:S,classListHeader:I,studentStatsHeader:z,hamburgerMenuBtn:M,sideNavMenu:j,closeNavBtn:A,overlay:F,backupDataBtn:Q,restoreDataBtn:_,restoreFileInput:O,confirmModalCancelBtn:f,confirmModalConfirmBtn:P,secureConfirmCancelBtn:ue,secureConfirmConfirmBtn:Z,newNoteContent:fe,classSaveNoteBtn:$,cancelNoteBtn:ne,studentSearchInput:B,studentSearchResultsDiv:D,isGradedCheckbox:re,categoryModalSaveBtn:te,categoryModalCancelBtn:Y,massCommentBtn:Te,massCommentCancelBtn:Ne,massCommentSaveBtn:be,massCommentContent:Ee,massCommentAppendCheckbox:Ae,attendanceSearchInput:Be}=lr,Ke=document.getElementById("trash-nav-btn");document.querySelector(".global-search-container .search-icon"),Bn(),_n(),dr()||(He(),ge("class-management-page"));function c(L,G){const W=document.querySelector(L);if(!W)return;const X=W.querySelector(".search-icon"),ae=W.querySelector(".animated-search-input");!X||!ae||(X.addEventListener("mousedown",de=>{de.preventDefault()}),X.addEventListener("click",()=>{W.classList.contains("search-active")||(W.classList.add("search-active"),ae.focus())}),ae.addEventListener("blur",()=>{setTimeout(()=>{W.classList.remove("search-active"),ae.value="",G&&G([])},150)}))}Be.addEventListener("input",()=>{const L=Be.value.toLowerCase().trim(),G=jn(L);Gt.querySelectorAll(".attendance-list-item").forEach(X=>{const ae=X.querySelector(".student-name");if(ae){const de=ae.textContent,ie=Ye(de.toLowerCase()),me=ie.includes(Ye(L)),ve=ie.includes(Ye(G));me||ve?X.style.display="flex":X.style.display="none"}})}),Y.addEventListener("click",()=>{ke(),$n(null)}),te.addEventListener("click",()=>{const L=Kt.value.trim(),G=xs.checked;typeof Ln=="function"&&Ln(L,G)}),window.addEventListener("scroll",vt),document.addEventListener("click",L=>{wt.classList.contains("visible")&&!wt.contains(L.target)&&vt(),B.contains(L.target)||(D.style.display="none");const G=L.target.closest(".log-action-link");if(G&&G.dataset.action)try{const W=JSON.parse(G.dataset.action);on(W)}catch(W){console.error("Could not parse log action:",W)}}),At.addEventListener("click",()=>{(At.classList.contains("disabled-wrapper")||nt.disabled)&&(nt.classList.add("shake-animation"),setTimeout(()=>{nt.classList.remove("shake-animation")},200))}),z.addEventListener("click",()=>{const L=new Date().getTime();L-gs>500?yn(1):yn(In+1),ai(L),In===5&&(yn(0),Ce("آیا از صفر کردن تمام شمارنده‌های دانش‌آموزان مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{Ks(),Re(),ee("تمام آمارها صفر شدند ✅.")},{confirmText:"بله",confirmClass:"btn-warning"}))}),I.addEventListener("click",()=>{const L=new Date().getTime();L-ps>500?gn(1):gn(Sn+1),ii(L),Sn===5&&(gn(0),Ce("آیا از ساخت یک کلاس تستی تصادفی مطمئن هستید؟",()=>{function G(){const W=`کلاس تستی ${Object.keys(oe).length+1}`,X=new qn({name:W,type:"online"});["علی رضایی","مریم حسینی","زهرا احمدی","رضا محمدی","فاطمه کریمی"].forEach(de=>X.addStudent(new hn({name:de}))),oe[W]=X,ce(),He()}G(),ee("کلاس تستی با موفقیت ساخته شد ✅!")},{confirmText:"بساز",confirmClass:"btn-success"}))}),ue.addEventListener("click",()=>{ke(),en(null)}),Z.addEventListener("click",()=>{typeof xn=="function"&&xn(),ke(),en(null)}),f.addEventListener("click",()=>{ke(bs)}),P.addEventListener("click",()=>{ke(ys)}),w.addEventListener("click",()=>{if(ct.value.trim()!==""||tt.value.trim()!==""){ee("⚠️لطفاً ابتدا با دکمه «ثبت»، تغییرات را ذخیره کنید و یا نمره و یادداشت را پاک کنید.");return}if(!T||!K||!Ge)return;const L=T.selectNextWinner(Ge.name,K);if(L){const G=K.studentRecords[L.identity.studentId];if(G&&G.attendance==="absent"&&L.statusCounters.missedChances++,G&&G.hadIssue){L.statusCounters.missedChances++;const X=Ge.name;L.categoryIssues[X]=(L.categoryIssues[X]||0)+1}G&&G.wasOutOfClass&&(L.statusCounters.outOfClassCount=(L.statusCounters.outOfClassCount||0)+1,L.statusCounters.missedChances++);const W={winner:L,categoryName:Ge.name};K.winnerHistory.push(W),K.winnerHistory.length>10&&K.winnerHistory.shift(),gt(K.winnerHistory.length-1),K.lastUsedCategoryId=Ge.id,K.lastSelectedWinnerId=L.identity.studentId,Re(),setTimeout(()=>Fe(),0),ce()}else ee("❌دانش‌آموز واجد شرایطی برای انتخاب یافت نشد.")}),y.addEventListener("click",()=>{if(!T)return;const L=g.value.trim(),G=re.checked;if(!L){alert("⚠️لطفاً نام دسته‌بندی را وارد کنید.");return}const W=T.categories.find(ae=>ae.name.toLowerCase()===L.toLowerCase());if(W)if(W.isDeleted){const ae=T.categories.findIndex(de=>de===W);ae>-1&&T.categories.splice(ae,1)}else{alert("⚠️این دسته‌بندی از قبل وجود دارد.");return}const X=new ut(L,"",G);T.categories.push(X),ce(),Se(T.info.name,`دسته‌بندی جدید «${L}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),Mt(),g.value="",re.checked=!1}),document.querySelectorAll('#settings-page input[name="class-type-setting"]').forEach(L=>{L.addEventListener("change",()=>{if(!T)return;const G=L.value,W=T.info.type||"in-person";if(G===W)return;const X=ie=>ie==="online"?"آنلاین":"حضوری",ae=X(W),de=X(G);Ce(`آیا از تغییر نوع کلاس از «${ae}» به «${de}» مطمئن هستید؟`,()=>{T.info.type=G,ce(),Se(T.info.name,`نوع کلاس به «${de}» تغییر یافت.`,{type:"VIEW_CLASS_SETTINGS"}),He(),ee(`✅ نوع کلاس به «${de}» تغییر یافت.`)},{confirmText:"بله",confirmClass:"btn-warning",onCancel:()=>{const ie=document.querySelector(`#settings-page input[name="class-type-setting"][value="${W}"]`);ie&&(ie.checked=!0)}})})});const R=document.querySelectorAll('input[name="schedule-day"]'),E=document.getElementById("settings-schedule-start"),C=document.getElementById("settings-schedule-end");R.forEach(L=>{L.addEventListener("change",()=>{if(!T)return;const G=Array.from(R).filter(W=>W.checked).map(W=>parseInt(W.value));T.info.scheduleDays=G,ce()})});const x=()=>{T&&(T.info.scheduleStartTime=E.value,T.info.scheduleEndTime=C.value,ce())};E.addEventListener("change",x),C.addEventListener("change",x),g.addEventListener("keyup",L=>{L.key==="Enter"&&y.click()}),b.addEventListener("click",()=>{if(!kn){alert("❌خطایی رخ داده است. لطفاً فایل را دوباره انتخاب کنید."),ge("settings-page");return}const L=parseInt(d.value,10),X=kn.split(`
`).slice(1).map(ae=>{var ie;return(ie=ae.split(",")[L])==null?void 0:ie.trim()}).filter(ae=>ae&&ae.length>0);X.length>0?(Ht(X),ds(),ge("csv-preview-page")):alert("هیچ نامی در ستون انتخاب شده پیدا نشد. لطفاً ستون دیگری را امتحان کنید یا فایل خود را بررسی کنید."),pn(null)}),v.addEventListener("click",()=>{p.click()}),p.addEventListener("change",L=>{const G=L.target.files[0];if(!G)return;const W=new FileReader;W.onload=X=>{const ae=X.target.result;pn(ae);const ie=ae.split(`
`)[0].split(",");Ni(ie),ge("column-mapping-page")},W.readAsText(G),L.target.value=null}),m.addEventListener("click",()=>{pn(null),ge("settings-page")}),u.addEventListener("click",()=>{const L=r.querySelectorAll('input[type="checkbox"]:checked');let G=!1;L.forEach(W=>{const X=W.dataset.name,ae=T.students.find(ie=>ie.identity.name.toLowerCase()===X.toLowerCase());if(ae)if(ae.isDeleted)Nn(ae,T);else{console.log(`دانش‌آموز «${X}» به دلیل تکراری بودن اضافه نشد.`);return}const de=new hn({name:X});T.addStudent(de),T.sessions.length>0&&(Ie(T.sessions).filter(ie=>ie.isFinished&&!ie.isCancelled).forEach(ie=>{ie.setAttendance(de.identity.studentId,"absent")}),ft(de,T),G=!0)}),ce(),Se(T.info.name,`${L.length} دانش‌آموز جدید از لیست ورودی به کلاس اضافه شدند.`,{type:"VIEW_SESSIONS"}),lt(),G&&qe(L.length),ge("settings-page"),n.value="",Ht([])}),h.addEventListener("click",()=>{Ht([]),ge("settings-page")}),i.addEventListener("click",()=>{const L=n.value.trim();if(!L){alert("کادر متنی خالی است. لطفاً اسامی را وارد کنید.");return}const G=L.split(`
`).map(W=>W.trim()).filter(W=>W.length>0);G.length>0?(Ht(G),ds(),ge("csv-preview-page")):alert("هیچ نام معتبری برای ورود پیدا نشد.")}),a.addEventListener("keyup",L=>{L.key==="Enter"&&t.click()}),t.addEventListener("click",()=>{if(!T)return;const L=a.value.trim();if(!L){alert("لطفاً نام دانش‌آموز را وارد کنید.");return}const G=T.students.find(X=>X.identity.name.toLowerCase()===L.toLowerCase());if(G)if(G.isDeleted)Nn(G,T);else{alert("❌دانش‌آموزی با این نام از قبل در این کلاس وجود دارد.");return}const W=new hn({name:L});T.addStudent(W),T.sessions.length>0&&(Ie(T.sessions).filter(X=>X.isFinished&&!X.isCancelled).forEach(X=>{X.setAttendance(W.identity.studentId,"absent")}),ft(W,T),qe(1)),ce(),Se(T.info.name,`دانش‌آموز «${L}» به کلاس اضافه شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:W.identity.studentId}),lt(),Re(),a.value="",a.focus()}),document.getElementById("new-session-btn").addEventListener("click",()=>{if(T){const L=T.sessions.find(W=>!W.isFinished&&!W.isCancelled&&!W.isDeleted);if(L){ee(`⚠️ جلسه ${L.sessionNumber} هنوز تمام نشده است. لطفاً ابتدا با دکمه ✅ آن را خاتمه دهید.`);return}const G=()=>{const W=X=>{const ae=T.startNewSession();Qt(ae),Ue(ae),T.students.forEach(me=>{fs.setAttendance(me.identity.studentId,"present")}),ce();const ie=Xe(T).get(ae.sessionNumber);Se(T.info.name,`جلسه ${ie} شروع شد.`,{type:"VIEW_SESSIONS"}),Rt(X?"attendance":"selector")};Ce("آیا تمایل به انجام فرآیند حضور و غیاب دارید؟",()=>W(!0),{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success",onCancel:()=>W(!1)})};T.hasSessionToday()?Ce("شما امروز یک جلسه برای این کلاس ثبت کرده‌اید. آیا از شروع یک جلسه جدید دیگر مطمئن هستید؟",G,{confirmText:"بله",confirmClass:"btn-warning"}):G()}}),e.addEventListener("click",()=>{const L=o.value.trim(),G=document.querySelector('input[name="class-type"]:checked');if(!L&&!G){ee("⚠️لطفاً نام و نوع کلاس را مشخص کنید.");return}if(!L){ee("⚠️لطفاً نام کلاس را وارد کنید.");return}if(!G){ee("⚠️لطفاً نوع کلاس را انتخاب کنید.");return}if(oe[L]){oe[L].isDeleted?ee("⚠️ کلاسی با این نام در سطل زباله است. ابتدا آن را بازیابی کنید و یا آن را پاک کنید."):ee("⚠️کلاسی با این نام از قبل وجود دارد.");return}const W=G.value,X=new qn({name:L,type:W});oe[L]=X,ce(),Se(L,`کلاس «${L}» ایجاد شد.`,{type:"VIEW_SESSIONS"}),He(),ee(`✅ کلاس «${L}» با موفقیت ایجاد شد.`),o.value="",G.checked=!1}),s.addEventListener("input",L=>{const G=L.target.value;if(G.length<2){En([]);return}const W=G.toLowerCase(),X=jn(W),ae=[];for(const de in oe){const ie=oe[de];if(ie.isDeleted)continue;const me=Ye(de.toLowerCase()),ve=me.includes(Ye(W)),xe=me.includes(Ye(X));(ve||xe)&&ae.push({type:"classroom",classroom:ie})}for(const de in oe){const ie=oe[de];if(ie.isDeleted)continue;Ie(ie.students).filter(ve=>{const xe=Ye(ve.identity.name.toLowerCase()),Oe=xe.includes(Ye(W)),Ft=xe.includes(Ye(X));return Oe||Ft}).forEach(ve=>{ae.push({type:"student",student:ve,classroom:ie})})}En(ae)}),o.addEventListener("keyup",L=>{L.key==="Enter"&&e.click()}),l.addEventListener("click",_i),S.addEventListener("click",()=>{nn("selector")}),B.addEventListener("input",L=>{const G=L.target.value;if(!G){Zt([]);return}const W=G.toLowerCase(),X=jn(W),de=Ie(T.students).filter(ie=>{const me=Ye(ie.identity.name.toLowerCase()),ve=me.includes(Ye(W)),xe=me.includes(Ye(X));return ve||xe});Zt(de)}),B.addEventListener("focus",()=>{B.value&&Zt(B.value)}),Ct.addEventListener("click",()=>{const L=ct.value,G=tt.value.trim();let W;if(Tn)W=Tn.student;else{const ae=K==null?void 0:K.winnerHistory[et];W=ae==null?void 0:ae.winner}if(!W){ee("❌خطا: دانش‌آموز معتبری برای ثبت نمره یافت نشد.");return}const X=Ge;if(!W||!X){ee("⚠️لطفاً ابتدا یک دانش‌آموز و یک دسته‌بندی را انتخاب کنید.");return}if(!L){ee("⚠️لطفاً مقدار نمره را وارد کنید.");return}if(L>100||L<0){ee("❌نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}W&&(W.addScore(X.name,parseFloat(L),G),Se(T.info.name,`نمره ${L} در ${X.name} برای «${W.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:W.identity.studentId}),ce(),Re(),ee(`✅نمره برای ${W.identity.name} در مهارت ${X.name} ثبت شد.`),ct.value="",tt.value="",Fe())});const U=L=>{L.key==="Enter"&&L.ctrlKey&&(L.preventDefault(),Ct.click())};ct.addEventListener("keydown",U),tt.addEventListener("keydown",U),ne.addEventListener("click",()=>{ke()}),$.addEventListener("click",()=>{const L=fe.value.trim(),G=vs;ke(()=>{typeof G=="function"&&G(L)})});const q=document.getElementById("move-student-confirm-btn"),N=document.getElementById("move-student-cancel-btn"),V=document.getElementById("move-student-class-select");N.addEventListener("click",()=>{ke()}),q.addEventListener("click",()=>{const L=V.value,G=oe[L],{studentToMove:W,sourceClassForMove:X}=Wi;if(!W||!X||!G){ee("خطایی رخ داد. لطفاً دوباره امتحان کنید⚠️.","error"),ke();return}const ae=Vs(W,X,G);ae.success?(Se(X.info.name,`دانش‌آموز «${W.identity.name}» به کلاس «${L}» منتقل شد.`,{type:"VIEW_SESSIONS"}),Se(L,`دانش‌آموز «${W.identity.name}» از کلاس «${X.info.name}» به این کلاس منتقل شد.`,{type:"VIEW_SESSIONS"}),ce(),lt(),Re(),st(),ee(`دانش‌آموز «${W.identity.name}» با موفقیت به کلاس «${L}» منتقل شد✅.`)):ee(ae.message,"error"),ke()}),M.addEventListener("click",()=>{j.style.width="300px",F.classList.add("modal-visible")}),M.addEventListener("click",()=>{j.style.width="300px",F.classList.add("modal-visible")});const se=document.getElementById("header-settings-btn");se&&se.addEventListener("click",()=>{T&&Dt(T)}),A.addEventListener("click",he),A.addEventListener("click",he),F.addEventListener("click",he),Ke.addEventListener("click",()=>{an(),ge("trash-page"),he()}),document.getElementById("demo-mode-btn").addEventListener("click",()=>{ot?ye():(he(),Ce("شما در حال ورود به حالت نمایش (Demo) هستید. در این حالت، هیچ‌کدام از تغییرات شما ذخیره نخواهد شد. آیا ادامه می‌دهید؟",()=>{ei(),_n(),he()},{confirmText:"تایید",confirmClass:"btn-warning",onCancel:he}))});const le=document.getElementById("exit-demo-btn");le&&le.addEventListener("click",()=>{ot&&ye()}),Q.addEventListener("click",()=>{if(ot){ee("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است."),he();return}he(),sn()}),_.addEventListener("click",()=>{if(ot){ee("⚠️ بازیابی اطلاعات در حالت نمایش (Demo) غیرفعال است."),he();return}O.click(),he()}),O.addEventListener("change",L=>{const G=L.target.files[0];if(!G)return;const W=new FileReader;W.onload=async X=>{const ae=X.target.result;try{const de=JSON.parse(ae);if(de.metadata&&de.data)is(de);else{const ie=de.classrooms||de,me=de.trashBin||[];Ce("آیا از بازیابی اطلاعات مطمئن هستید؟ تمام داده‌های فعلی شما بازنویسی خواهد شد.",()=>{_t(ie),Rn(me),qt({lastRestoreTimestamp:new Date().toISOString()}),ce(),He(),ge("class-management-page"),ee("✅اطلاعات با موفقیت بازیابی شد.")},{confirmText:"بازیابی کن",confirmClass:"btn-warning"})}}catch{try{const ve=(await new Ps().loadAsync(ae,{base64:!0})).file("backup.json");if(!ve)throw new Error("فایل backup.json در فایل پشتیبان یافت نشد.");const xe=await ve.async("string"),Oe=JSON.parse(xe);if(Oe.metadata&&Oe.metadata.version==="2.0-b64")is(Oe);else throw new Error("فایل پشتیبان معتبر نیست (نسخه نامشخص).")}catch(ie){ee("❌خطا در خواندن فایل. لطفاً فایل پشتیبان معتبر انتخاب کنید."),console.error("Restore error (zip/base64):",ie)}}},W.readAsText(G),L.target.value=null}),window.addEventListener("popstate",L=>{if(pt){ke(null,!0);return}if(vt(),L.state){const{pageId:G,currentClassName:W,selectedSessionNumber:X,selectedStudentId:ae}=L.state;W&&(Pe(oe[W]),X&&Ue(T.getSession(X)),ae&&Ve(T.students.find(de=>de.identity.studentId===ae))),G==="session-page"?(We(),Yt(G)):G==="student-profile-page"?(We(),ge("session-page"),Me(_e)):Yt(G)}else Pe(null),Ue(null),Ve(null),Yt("class-management-page")}),document.addEventListener("keydown",L=>{var X;const G=document.activeElement;if(!["INPUT","TEXTAREA","SELECT"].includes(G.tagName)){if(L.key.toLowerCase()==="o"&&L.shiftKey&&ui.classList.contains("active")&&(L.preventDefault(),hi.click()),L.key==="Escape"){if(wt.classList.contains("visible")){vt();return}if(pt){ke();return}switch((X=document.querySelector(".page.active"))==null?void 0:X.id){case"csv-preview-page":case"column-mapping-page":ge("settings-page");break;case"student-profile-page":Ve(null),ge(K?"student-page":"session-page");break;case"attendance-page":ge("student-page");break;case"student-page":Ue(null),We(),ge("session-page");break;case"settings-page":case"session-page":Pe(null),ge("class-management-page");break}return}if(K){const ae=L.key.toLowerCase();switch(" ascfg".includes(ae)&&L.preventDefault(),ae){case" ":w.click();break;case"a":k.classList.contains("active")?history.back():(st(),ge("attendance-page"));break;case"s":document.getElementById("session-page").classList.contains("active")&&history.back();break;case"c":document.querySelector(".back-to-classes-btn").click();break;case"f":const de=document.querySelector(".action-column .search-icon");de&&de.click();break;case"g":if(studentProfilePage.classList.contains("active"))history.back();else{const ie=K.lastSelectedWinnerId;if(ie){const me=T.students.find(ve=>ve.identity.studentId===ie);me&&(Ve(me),(void 0)(),ge("student-profile-page"))}else ee("⚠️ابتدا یک نفر را انتخاب کنید تا پروفایل او نمایش داده شود.")}break;case"arrowleft":{const ie=document.querySelector('button[title="برنده قبلی"]');ie&&!ie.disabled&&(L.preventDefault(),ie.click());break}case"arrowright":{const ie=document.querySelector('button[title="برنده بعدی"]');ie&&!ie.disabled&&(L.preventDefault(),ie.click());break}}}}});function he(){j.style.width="0",F.classList.add("modal-closing"),setTimeout(()=>{F.classList.remove("modal-visible","modal-closing")},300)}function ye(){Ce("آیا از خروج از حالت نمایش (Demo) مطمئن هستید؟ با خروج، تمام تغییرات آزمایشی شما حذف شده و داده‌های اصلی شما بازیابی خواهند شد.",()=>{ti(),Pe(null),Ue(null),Ve(null),He(),ge("class-management-page"),_n(),he()},{confirmText:"خروج",confirmClass:"btn-success"})}c(".global-search-container .animated-search-container",En),c(".action-column-header .animated-search-container",Zt),fr(),[we,bi,tt,mi].forEach(L=>{L&&xi(L)});function ft(L,G){const W=Ie(G.students).filter(Le=>Le.identity.studentId!==L.identity.studentId);if(W.length===0)return;const X=W.reduce((Le,$e)=>$e.statusCounters.totalSelections>Le.statusCounters.totalSelections?$e:Le,W[0]);if(!X||X.statusCounters.totalSelections===0)return;L.categoryCounts=JSON.parse(JSON.stringify(X.categoryCounts)),L.statusCounters.totalSelections=X.statusCounters.totalSelections;const ae=W.reduce((Le,$e)=>Le+$e.statusCounters.totalSelections,0),de=W.reduce((Le,$e)=>Le+($e.statusCounters.missedChances||0),0),ie=ae>0?de/ae:0;L.statusCounters.missedChances=Math.round(L.statusCounters.totalSelections*ie);const me=Ie(G.categories),ve={};me.forEach(Le=>{const $e=W.reduce((Wn,Un)=>Wn+(Un.categoryCounts[Le.name]||0),0),Hn=W.reduce((Wn,Un)=>Wn+(Un.categoryIssues[Le.name]||0),0);ve[Le.name]=$e>0?Hn/$e:0}),me.forEach(Le=>{const $e=L.categoryCounts[Le.name]||0,Hn=ve[Le.name]||0;L.categoryIssues[Le.name]=Math.round($e*Hn)});const xe=G.liveSession;xe?L.onboardingSession=xe.sessionNumber:L.onboardingSession=G.sessions.length+1;const Oe=Ie(G.sessions).filter(Le=>Le.isFinished&&!Le.isCancelled),Ft="📝 یادداشت خودکار سیستم",Ri=`این دانش‌آموز  از جلسه شماره ${Oe.length} به کلاس اضافه شد. آمار مشارکت او بر اساس فعال‌ترین دانش‌آموز و آمار «فرصت از دست رفته» او بر اساس میانگین کلاس ثبت گردید:`,It=[];L.statusCounters.totalSelections>0&&It.push(`کل انتخاب‌ها: ${L.statusCounters.totalSelections}`),L.statusCounters.missedChances>0&&It.push(`فرصت‌های از دست رفته: ${L.statusCounters.missedChances}`);for(const Le in L.categoryCounts){const $e=L.categoryCounts[Le];$e>0&&It.push(`انتخاب در «${Le}»: ${$e}`)}for(const Le in L.categoryIssues){const $e=L.categoryIssues[Le];$e>0&&It.push(`مشکل در «${Le}»: ${$e}`)}if(It.length>0){const Le=`${Ft}
${Ri}

- ${It.join(`
- `)}`;L.addNote(Le)}}function qe(L){const W=`چون این کلاس جلسات برگزار شده دارد، برای ${L>1?"دانش‌آموزان جدید":"دانش‌آموز جدید"} آمار پایه‌ای (متناسب با سایر دانش‌آموزان) ثبت شد تا در فرایند انتخاب اختلالی ایجاد نشود.`;Ce(W,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}const yt="11.7.0",De="729";{const L=` (ساخت ${De})`;document.getElementById("app-version").textContent=`نسخه ${yt}${L}`}function kt(){console.log("Starting universal backfill for writing scores...");let L=0;for(const G in oe){const W=oe[G];if(W.isDeleted)continue;let X=0;Ie(W.students).forEach(de=>{const ie=de.logs.scores;if(!(ie&&ie.writing&&ie.writing.length>0)){let ve=-1;for(const xe in ie)xe!=="writing"&&ie[xe].forEach(Oe=>{Oe.value>ve&&(ve=Oe.value)});if(ve>-1){const xe=`Automatically assigned based on the highest score (${ve}) from other skills.`;de.addScore("Writing",ve,xe),X++}}}),X>0&&(console.log(`Updated ${X} student(s) in class: ${W.info.name}.`),L+=X)}L>0?(ce(),console.log(`Update complete. A total of ${L} student(s) were updated across all classes. Data saved.`),document.getElementById("student-page").classList.contains("active")&&Re()):console.log("No students needed updating in any class.")}window.backfillWritingScoresForAll=kt;function zt(){console.log("Starting backfill for 'outOfClassCount' and 'wasOutOfClass' properties...");let L=0,G=0;const W=localStorage.getItem("teacherAssistantData_v2");if(!W){console.log("No data found in localStorage. Nothing to do.");return}const X=JSON.parse(W);for(const ae in X){const de=X[ae];de.students&&de.students.forEach(ie=>{ie.statusCounters&&typeof ie.statusCounters.outOfClassCount>"u"&&(ie.statusCounters.outOfClassCount=0,L++)}),de.sessions&&de.sessions.forEach(ie=>{if(ie.studentRecords)for(const me in ie.studentRecords){const ve=ie.studentRecords[me];typeof ve.wasOutOfClass>"u"&&(ve.wasOutOfClass=!1,G++)}})}localStorage.setItem("teacherAssistantData_v2",JSON.stringify(X)),console.log(`Backfill complete. Updated ${L} students and ${G} session records. Data saved.`),Bn(),T&&Re()}window.backfillExitCounters=zt;function Qe(){console.log("🧹 Starting orphaned data cleanup...");let L=0;for(const G in oe){const W=oe[G];if(W.isDeleted)continue;let X=!1;const ae=new Set(W.students.filter(me=>!me.isDeleted).map(me=>me.identity.studentId)),de=new Map(W.students.map(me=>[me.identity.studentId,me.identity.name])),ie=[];W.sessions.forEach(me=>{if(me.isDeleted)return;const ve=[];for(const xe in me.studentRecords)if(!ae.has(xe)){const Oe=de.get(xe)||"Unknown/Deleted";ve.push(`  - Removed student record for: ${Oe} (ID: ${xe})`),delete me.studentRecords[xe],L++,X=!0}for(const xe in me.lastWinnerByCategory){const Oe=me.lastWinnerByCategory[xe];if(!ae.has(Oe)){const Ft=de.get(Oe)||"Unknown/Deleted";ve.push(`  - Removed '${xe}' last winner: ${Ft} (ID: ${Oe})`),delete me.lastWinnerByCategory[xe],L++,X=!0}}if(me.lastSelectedWinnerId&&!ae.has(me.lastSelectedWinnerId)){const xe=me.lastSelectedWinnerId,Oe=de.get(xe)||"Unknown/Deleted";ve.push(`  - Cleared 'lastSelectedWinnerId': ${Oe} (ID: ${xe})`),me.lastSelectedWinnerId=null,L++,X=!0}if(ve.length>0){const Oe=Xe(W).get(me.sessionNumber)||`(#${me.sessionNumber})`;ie.push({sessionDisplayNumber:Oe,logs:ve})}}),X&&(console.group(`➡️ Class: ${G}`),ie.forEach(me=>{console.groupCollapsed(`  Session ${me.sessionDisplayNumber}`),me.logs.forEach(ve=>console.warn(ve)),console.groupEnd()}),console.groupEnd())}L>0?(ce(),console.log(`✅ Cleanup complete! Found and removed ${L} orphaned references. Data saved.`)):console.log("✅ No orphaned data found. Your data is clean!")}window.cleanupOrphanedData=Qe;function on(L){if(!L||!L.classroomName)return;const G=oe[L.classroomName];if(!G){ee("⚠️ کلاس مربوط به این گزارش یافت نشد.");return}Pe(G),ke(),setTimeout(()=>{switch(L.type){case"VIEW_STUDENT_PROFILE":{const W=G.students.find(X=>X.identity.studentId===L.studentId);W?Me(W):ee("⚠️ دانش‌آموز مورد نظر یافت نشد.");break}case"VIEW_TRASH":an(),ge("trash-page");break;case"VIEW_SESSIONS":We(),ge("session-page");break;case"VIEW_CLASS_NOTE":Fn(G);break;case"VIEW_CLASS_SETTINGS":Dt(G);break}},300)}Te.addEventListener("click",()=>{Ds()}),Ne.addEventListener("click",()=>{ke()}),be.addEventListener("click",()=>{const L=Ee.value.trim(),G=Ae.checked;if(!L){Ls.style.display==="flex"?Ce("کادر یادداشت خالی است. آیا مطمئنید که می‌خواهید یادداشت‌های قبلی دانش‌آموزان انتخاب‌شده را پاک کنید؟",()=>{ke(),rs("",!1)},{confirmText:"پاک کردن",confirmClass:"btn-warning"}):ee("⚠️ لطفاً متن یادداشت را وارد کنید.");return}ke(()=>{rs(L,G)})});const dt=document.getElementById("screen-saver-overlay"),cn=document.getElementById("screen-saver-toggle");let $t;const ln=2*60*1e3,mt=["mousemove","keypress","scroll","click","touchstart"];function St(){dt.classList.add("visible")}function Rs(){dt.classList.contains("visible")&&dt.classList.remove("visible")}function dn(){Rs(),clearTimeout($t),$t=setTimeout(St,ln)}function un(L){L.preventDefault(),L.stopPropagation(),setTimeout(dn,0)}function Ms(){dn(),mt.forEach(G=>window.addEventListener(G,dn)),dt.addEventListener("click",un),dt.addEventListener("touchstart",un);const L="11.7.0";{const G=document.getElementById("screen-saver-version");G&&(G.textContent=`v${L}`)}}function Oi(){clearTimeout($t),Rs(),mt.forEach(L=>window.removeEventListener(L,dn)),dt.removeEventListener("click",un),dt.removeEventListener("touchstart",un)}cn.checked=je.isScreenSaverEnabled,je.isScreenSaverEnabled&&Ms(),cn.addEventListener("change",L=>{L.target.checked?(qt({isScreenSaverEnabled:!0}),Ms()):(he(),L.preventDefault(),Ce(`نکته:
محافظ صفحه در تلفن های همراه جدید کمک می کند که دستگاه باطری کمتری مصرف کند و به دلیل ثابت ماندن صفحه نمایش در گوشی های قدیمی تر، صفحه نمایش دچار ماندگی رد پیکسل نگردد. آیا مطمئن هستید که می خواهید این ویژگی را غیر فعال کنید؟`,()=>{L.target.checked=!1,qt({isScreenSaverEnabled:!1}),Oi(),ee("توصیه می شود زمان خاموش شدن صفحه نمایش گوشی خود را به حداقل دو دقیقه تغییر دهید تا در استفاده های طولانی مدت صفحه نمایش گوشی اصطحلاک کمتری را تجربه کند",7e3)},{confirmText:"بله، غیرفعال کن",cancelText:"لغو",onCancel:()=>{L.target.checked=!0}}))})});function ur(s,o){if(!K||K.isFinished){ee("⚠️ امکان لغو انتخاب در جلسه خاتمه یافته وجود ندارد.");return}const e=K.winnerHistory;if(!(et===e.length-1)||e.length===0){ee("⚠️ فقط آخرین انتخاب قابل لغو است.");return}if(e[e.length-1].winner.identity.studentId!==s.identity.studentId){console.error("Undo mismatch!");return}Ce(`آیا از حذف انتخاب «${s.identity.name}» برای «${o}» مطمئن هستید؟ آمار این انتخاب بازگردانی خواهد شد.`,()=>{const a=K.winnerHistory,t=a.pop();if(!t)return;const n=t.winner,i=t.categoryName,r=n.identity.studentId;n.statusCounters.totalSelections=Math.max(0,n.statusCounters.totalSelections-1),n.categoryCounts[i]&&(n.categoryCounts[i]=Math.max(0,n.categoryCounts[i]-1));const u=K.studentRecords[r];u&&u.selections[i]&&(u.selections[i]=Math.max(0,u.selections[i]-1));let h=null;for(let v=a.length-1;v>=0;v--)if(a[v].categoryName===i){h=a[v].winner.identity.studentId;break}h?K.lastWinnerByCategory[i]=h:delete K.lastWinnerByCategory[i],gt(a.length-1),Re(),Fe(),ce(),ee(`✅ انتخاب «${n.identity.name}» لغو شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}function fr(){const s=document.getElementById("session-dashboard-page"),o=document.getElementById("student-stats-table-container");if(!s)return;let e=0,l=0;s.addEventListener("touchstart",t=>{if(o&&o.contains(t.target)){const n=t.target.closest("td, th");n&&n.parentElement.firstElementChild===n?e=t.changedTouches[0].screenX:e=0}else e=t.changedTouches[0].screenX},{passive:!0}),s.addEventListener("touchend",t=>{e!==0&&(l=t.changedTouches[0].screenX,a())});function a(){const n=e-l;Math.abs(n)>150&&(document.getElementById("selector-tab-btn").classList.contains("active")?(ge("session-dashboard-page",{tab:"attendance"}),nn("attendance")):(ge("session-dashboard-page",{tab:"selector"}),nn("selector"))),e=0,l=0}}
