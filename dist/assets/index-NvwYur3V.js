(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))c(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&c(i)}).observe(document,{childList:!0,subtree:!0});function t(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function c(o){if(o.ep)return;o.ep=!0;const n=t(o);fetch(o.href,n)}})();const Ra={ili:{id:"ili",label:"کانون زبان ایران",levels:["Primer 1","Primer 2","Step Up 1","Step Up 2","Step Up 3","Step Up 4","Move Up 1","Move Up 2","Move Up 3","Move Up 4","Jump Up 1","Jump Up 2","Jump Up 3","Jump Up 4","Start 1","Run 1","Run 2","Run 3","Run 4","Race 1","Race 2","Race 3","Reach 1","Reach 2","Reach 3","Reach 4","Basic 1","Basic 2","Basic 3","Elementary 1","Elementary 2","Elementary 3","Pre-intermediate 1","Pre-intermediate 2","Pre-intermediate 3","Intermediate 1","Intermediate 2","Intermediate 3","High-intermediate 1","High-intermediate 2","High-intermediate 3","Advanced 1","Advanced 2","Advanced 3"]},school:{id:"school",label:"آموزش و پرورش",levels:["کلاس اول","کلاس دوم","کلاس سوم","کلاس چهارم","کلاس پنجم","کلاس ششم","کلاس هفتم","کلاس هشتم","کلاس نهم","کلاس دهم","کلاس یازدهم","کلاس دوازدهم"]},custom:{id:"custom",label:"سایر / آزاد",levels:[]}};class Bn{constructor(a){this.identity={name:a.name,firstName:a.firstName||null,lastName:a.lastName||null,studentId:a.studentId||`id_${new Date().getTime()}_${Math.random()}`,branchName:a.branchName||null,ageGroup:a.ageGroup||"adult",level:a.level||null,contact:{social:a.socialContact||null,parent:a.parentContact||null}},this.isDeleted=!1,this.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0,outOfClassCount:0},this.categoryCounts={},this.categoryIssues={},this.qualitativeStats={},this.logs={parentContacts:[],scores:{},discipline:{},sessionHistory:{}},this.profile={notes:[],tags:[]},this.finalClassActivityScore=null,this.onboardingSession=null}addScore(a,t,c){if(t>100||t<0){console.log("نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}const o=a.toLowerCase();this.logs.scores[o]||(this.logs.scores[o]=[]);const n=new lo(a,t,c);this.logs.scores[o].push(n)}addNote(a,t=null){const c=new uo(a,t);this.profile.notes.push(c)}getOverallAverageScore(){let a=0,t=0;for(const o in this.logs.scores)this.logs.scores[o].forEach(n=>{n.isDeleted||(a+=n.value,t++)});if(t===0)return null;const c=a/t;return Math.trunc(c*10)/10}}class lo{constructor(a,t,c=""){this.id=`score_${new Date().getTime()}`,this.skill=a,this.value=t,this.timestamp=new Date,this.comment=c,this.isDeleted=!1}}class uo{constructor(a,t=null){this.id=`note_${new Date().getTime()}`,this.timestamp=new Date,this.content=a,this.isDeleted=!1,this.source=t}}class xs{constructor(a="complete",t=""){this.status=a,this.comment=t,this.timestamp=new Date}}class ja{constructor(a){this.sessionNumber=a,this.startTime=new Date,this.createdAt=new Date,this.note="",this.isDeleted=!1,this.endTime=null,this.isFinished=!1,this.isMakeup=!1,this.isCancelled=!1,this.studentRecords={},this.lastWinnerByCategory={},this.lastUsedCategoryId=null,this.lastSelectedWinnerId=null,this.winnerHistory=[]}end(){this.isFinished=!0,this.endTime=new Date}markAsMakeup(){this.isMakeup=!this.isMakeup}initializeStudentRecord(a){this.studentRecords[a]||(this.studentRecords[a]={attendance:"present",homework:new xs,selections:{},hadIssue:!1,wasOutOfClass:!1,performanceRatings:{}})}setAttendance(a,t){this.initializeStudentRecord(a),this.studentRecords[a].attendance=t}setHomeworkStatus(a,t){this.initializeStudentRecord(a),this.studentRecords[a].homework.status=t}selectNextWinner(a,t,c){if(!t||t.length===0)return console.log("هیچ دانش‌آموزی در کلاس برای انتخاب وجود ندارد."),null;const o=this.lastWinnerByCategory[a];let n=t.filter(h=>h.identity.studentId!==o&&!h.isDeleted);if(n.length===0&&(n=t),n.length===0)return null;const i=(h,m)=>h.categoryCounts[m]||0,s=Math.min(...n.map(h=>i(h,a))),r=n.filter(h=>i(h,a)===s);let l;if(r.length===1)l=r[0];else if(r.length>1){const h=c.filter(v=>!v.isDeleted&&v.name!==a).map(v=>v.name),m=r.map(v=>{const b=h.reduce((C,S)=>C+i(v,S),0);return{student:v,otherCategoriesTotal:b}}),y=Math.min(...m.map(v=>v.otherCategoriesTotal)),u=m.filter(v=>v.otherCategoriesTotal===y).map(v=>v.student);u.length===1?l=u[0]:l=u[Math.floor(Math.random()*u.length)]}else l=n[Math.floor(Math.random()*n.length)];const f=l.identity.studentId;this.initializeStudentRecord(f);const p=(this.studentRecords[f].selections[a]||0)+1;return this.studentRecords[f].selections[a]=p,l.statusCounters.totalSelections++,l.categoryCounts[a]=(l.categoryCounts[a]||0)+1,this.lastWinnerByCategory[a]=f,l}}class Ls{constructor(a){this.info={name:a.name||"NotNamed",teacherName:a.teacherName||null,type:a.type||"in-person",educationalSystem:a.educationalSystem||"custom",term:a.term||null,scheduleText:a.scheduleText||null,level:a.level||null,creationDate:a.creationDate?new Date(a.creationDate):new Date,scheduleCode:a.scheduleCode||`code_${new Date().getTime()}`,scheduleDays:a.scheduleDays||[],scheduleStartTime:a.scheduleStartTime||null,scheduleEndTime:a.scheduleEndTime||null},this.students=[],this.sessions=[],this.note="",this.isDeleted=!1,this.categories=[new yt("Vocabulary","Questions about words and meanings."),new yt("Grammar","Questions about sentence structure and rules."),new yt("Listening",void 0,!0),new yt("Speaking",void 0,!0),new yt("Reading",void 0,!0),new yt("Writing",void 0,!0)],this.futurePlans={}}addStudent(a){this.students.push(a)}startNewSession(){const t=this.sessions.reduce((o,n)=>Math.max(o,n.sessionNumber),0)+1,c=new ja(t);return this.sessions.push(c),c}endSpecificSession(a){const t=this.getSession(a);return t&&!t.isFinished?(t.end(),!0):!1}getSession(a){return this.sessions.find(t=>t.sessionNumber===a)}markAsMakeup(a){const t=this.getSession(a);t&&t.markAsMakeup()}planForSession(a,t){this.futurePlans[a]=t}hasSessionToday(){const a=new Date().toDateString();return this.sessions.some(t=>!t.isDeleted&&t.startTime.toDateString()===a)}selectNextWinner(a,t){return t?t.selectNextWinner(a,this.students,this.categories):null}get liveSession(){for(let a=this.sessions.length-1;a>=0;a--)if(!this.sessions[a].isFinished)return this.sessions[a];return null}calculateFinalStudentScore(a){var i;const t=this.categories.filter(s=>s.isGradedCategory&&!s.isDeleted);if(t.length===0)return null;let c=0,o=0;for(const s of t){const r=s.name.toLowerCase(),l=((i=a.logs.scores[r])==null?void 0:i.filter(p=>!p.isDeleted))||[];if(l.length===0)return null;const f=l.reduce((p,h)=>p+h.value,0)/l.length;c+=f*(s.weight||1),o+=s.weight||1}if(o===0)return null;const n=c/o;return Math.trunc(n*10)/10}}class yt{constructor(a,t="",c=!1,o=1){this.id=`cat_${new Date().getTime()}_${Math.random()}`,this.name=a,this.description=t,this.isDeleted=!1,this.isGradedCategory=c,this.weight=o,this.isDeleted=!1}}var Ln=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function qa(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function Tn(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Za={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/(function(e,a){(function(t){e.exports=t()})(function(){return function t(c,o,n){function i(l,f){if(!o[l]){if(!c[l]){var p=typeof Tn=="function"&&Tn;if(!f&&p)return p(l,!0);if(s)return s(l,!0);var h=new Error("Cannot find module '"+l+"'");throw h.code="MODULE_NOT_FOUND",h}var m=o[l]={exports:{}};c[l][0].call(m.exports,function(y){var u=c[l][1][y];return i(u||y)},m,m.exports,t,c,o,n)}return o[l].exports}for(var s=typeof Tn=="function"&&Tn,r=0;r<n.length;r++)i(n[r]);return i}({1:[function(t,c,o){var n=t("./utils"),i=t("./support"),s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";o.encode=function(r){for(var l,f,p,h,m,y,u,v=[],b=0,C=r.length,S=C,k=n.getTypeOf(r)!=="string";b<r.length;)S=C-b,p=k?(l=r[b++],f=b<C?r[b++]:0,b<C?r[b++]:0):(l=r.charCodeAt(b++),f=b<C?r.charCodeAt(b++):0,b<C?r.charCodeAt(b++):0),h=l>>2,m=(3&l)<<4|f>>4,y=1<S?(15&f)<<2|p>>6:64,u=2<S?63&p:64,v.push(s.charAt(h)+s.charAt(m)+s.charAt(y)+s.charAt(u));return v.join("")},o.decode=function(r){var l,f,p,h,m,y,u=0,v=0,b="data:";if(r.substr(0,b.length)===b)throw new Error("Invalid base64 input, it looks like a data url.");var C,S=3*(r=r.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(r.charAt(r.length-1)===s.charAt(64)&&S--,r.charAt(r.length-2)===s.charAt(64)&&S--,S%1!=0)throw new Error("Invalid base64 input, bad content length.");for(C=i.uint8array?new Uint8Array(0|S):new Array(0|S);u<r.length;)l=s.indexOf(r.charAt(u++))<<2|(h=s.indexOf(r.charAt(u++)))>>4,f=(15&h)<<4|(m=s.indexOf(r.charAt(u++)))>>2,p=(3&m)<<6|(y=s.indexOf(r.charAt(u++))),C[v++]=l,m!==64&&(C[v++]=f),y!==64&&(C[v++]=p);return C}},{"./support":30,"./utils":32}],2:[function(t,c,o){var n=t("./external"),i=t("./stream/DataWorker"),s=t("./stream/Crc32Probe"),r=t("./stream/DataLengthProbe");function l(f,p,h,m,y){this.compressedSize=f,this.uncompressedSize=p,this.crc32=h,this.compression=m,this.compressedContent=y}l.prototype={getContentWorker:function(){var f=new i(n.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new r("data_length")),p=this;return f.on("end",function(){if(this.streamInfo.data_length!==p.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),f},getCompressedWorker:function(){return new i(n.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},l.createWorkerFrom=function(f,p,h){return f.pipe(new s).pipe(new r("uncompressedSize")).pipe(p.compressWorker(h)).pipe(new r("compressedSize")).withStreamInfo("compression",p)},c.exports=l},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(t,c,o){var n=t("./stream/GenericWorker");o.STORE={magic:"\0\0",compressWorker:function(){return new n("STORE compression")},uncompressWorker:function(){return new n("STORE decompression")}},o.DEFLATE=t("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(t,c,o){var n=t("./utils"),i=function(){for(var s,r=[],l=0;l<256;l++){s=l;for(var f=0;f<8;f++)s=1&s?3988292384^s>>>1:s>>>1;r[l]=s}return r}();c.exports=function(s,r){return s!==void 0&&s.length?n.getTypeOf(s)!=="string"?function(l,f,p,h){var m=i,y=h+p;l^=-1;for(var u=h;u<y;u++)l=l>>>8^m[255&(l^f[u])];return-1^l}(0|r,s,s.length,0):function(l,f,p,h){var m=i,y=h+p;l^=-1;for(var u=h;u<y;u++)l=l>>>8^m[255&(l^f.charCodeAt(u))];return-1^l}(0|r,s,s.length,0):0}},{"./utils":32}],5:[function(t,c,o){o.base64=!1,o.binary=!1,o.dir=!1,o.createFolders=!0,o.date=null,o.compression=null,o.compressionOptions=null,o.comment=null,o.unixPermissions=null,o.dosPermissions=null},{}],6:[function(t,c,o){var n=null;n=typeof Promise<"u"?Promise:t("lie"),c.exports={Promise:n}},{lie:37}],7:[function(t,c,o){var n=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",i=t("pako"),s=t("./utils"),r=t("./stream/GenericWorker"),l=n?"uint8array":"array";function f(p,h){r.call(this,"FlateWorker/"+p),this._pako=null,this._pakoAction=p,this._pakoOptions=h,this.meta={}}o.magic="\b\0",s.inherits(f,r),f.prototype.processChunk=function(p){this.meta=p.meta,this._pako===null&&this._createPako(),this._pako.push(s.transformTo(l,p.data),!1)},f.prototype.flush=function(){r.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},f.prototype.cleanUp=function(){r.prototype.cleanUp.call(this),this._pako=null},f.prototype._createPako=function(){this._pako=new i[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var p=this;this._pako.onData=function(h){p.push({data:h,meta:p.meta})}},o.compressWorker=function(p){return new f("Deflate",p)},o.uncompressWorker=function(){return new f("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(t,c,o){function n(m,y){var u,v="";for(u=0;u<y;u++)v+=String.fromCharCode(255&m),m>>>=8;return v}function i(m,y,u,v,b,C){var S,k,_=m.file,x=m.compression,L=C!==l.utf8encode,D=s.transformTo("string",C(_.name)),M=s.transformTo("string",l.utf8encode(_.name)),U=_.comment,Q=s.transformTo("string",C(U)),I=s.transformTo("string",l.utf8encode(U)),z=M.length!==_.name.length,g=I.length!==U.length,W="",ue="",q="",me=_.dir,V=_.date,fe={crc32:0,compressedSize:0,uncompressedSize:0};y&&!u||(fe.crc32=m.crc32,fe.compressedSize=m.compressedSize,fe.uncompressedSize=m.uncompressedSize);var R=0;y&&(R|=8),L||!z&&!g||(R|=2048);var O=0,de=0;me&&(O|=16),b==="UNIX"?(de=798,O|=function(ee,Be){var He=ee;return ee||(He=Be?16893:33204),(65535&He)<<16}(_.unixPermissions,me)):(de=20,O|=function(ee){return 63&(ee||0)}(_.dosPermissions)),S=V.getUTCHours(),S<<=6,S|=V.getUTCMinutes(),S<<=5,S|=V.getUTCSeconds()/2,k=V.getUTCFullYear()-1980,k<<=4,k|=V.getUTCMonth()+1,k<<=5,k|=V.getUTCDate(),z&&(ue=n(1,1)+n(f(D),4)+M,W+="up"+n(ue.length,2)+ue),g&&(q=n(1,1)+n(f(Q),4)+I,W+="uc"+n(q.length,2)+q);var se="";return se+=`
\0`,se+=n(R,2),se+=x.magic,se+=n(S,2),se+=n(k,2),se+=n(fe.crc32,4),se+=n(fe.compressedSize,4),se+=n(fe.uncompressedSize,4),se+=n(D.length,2),se+=n(W.length,2),{fileRecord:p.LOCAL_FILE_HEADER+se+D+W,dirRecord:p.CENTRAL_FILE_HEADER+n(de,2)+se+n(Q.length,2)+"\0\0\0\0"+n(O,4)+n(v,4)+D+W+Q}}var s=t("../utils"),r=t("../stream/GenericWorker"),l=t("../utf8"),f=t("../crc32"),p=t("../signature");function h(m,y,u,v){r.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=y,this.zipPlatform=u,this.encodeFileName=v,this.streamFiles=m,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}s.inherits(h,r),h.prototype.push=function(m){var y=m.meta.percent||0,u=this.entriesCount,v=this._sources.length;this.accumulate?this.contentBuffer.push(m):(this.bytesWritten+=m.data.length,r.prototype.push.call(this,{data:m.data,meta:{currentFile:this.currentFile,percent:u?(y+100*(u-v-1))/u:100}}))},h.prototype.openedSource=function(m){this.currentSourceOffset=this.bytesWritten,this.currentFile=m.file.name;var y=this.streamFiles&&!m.file.dir;if(y){var u=i(m,y,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:u.fileRecord,meta:{percent:0}})}else this.accumulate=!0},h.prototype.closedSource=function(m){this.accumulate=!1;var y=this.streamFiles&&!m.file.dir,u=i(m,y,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(u.dirRecord),y)this.push({data:function(v){return p.DATA_DESCRIPTOR+n(v.crc32,4)+n(v.compressedSize,4)+n(v.uncompressedSize,4)}(m),meta:{percent:100}});else for(this.push({data:u.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},h.prototype.flush=function(){for(var m=this.bytesWritten,y=0;y<this.dirRecords.length;y++)this.push({data:this.dirRecords[y],meta:{percent:100}});var u=this.bytesWritten-m,v=function(b,C,S,k,_){var x=s.transformTo("string",_(k));return p.CENTRAL_DIRECTORY_END+"\0\0\0\0"+n(b,2)+n(b,2)+n(C,4)+n(S,4)+n(x.length,2)+x}(this.dirRecords.length,u,m,this.zipComment,this.encodeFileName);this.push({data:v,meta:{percent:100}})},h.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},h.prototype.registerPrevious=function(m){this._sources.push(m);var y=this;return m.on("data",function(u){y.processChunk(u)}),m.on("end",function(){y.closedSource(y.previous.streamInfo),y._sources.length?y.prepareNextSource():y.end()}),m.on("error",function(u){y.error(u)}),this},h.prototype.resume=function(){return!!r.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},h.prototype.error=function(m){var y=this._sources;if(!r.prototype.error.call(this,m))return!1;for(var u=0;u<y.length;u++)try{y[u].error(m)}catch{}return!0},h.prototype.lock=function(){r.prototype.lock.call(this);for(var m=this._sources,y=0;y<m.length;y++)m[y].lock()},c.exports=h},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(t,c,o){var n=t("../compressions"),i=t("./ZipFileWorker");o.generateWorker=function(s,r,l){var f=new i(r.streamFiles,l,r.platform,r.encodeFileName),p=0;try{s.forEach(function(h,m){p++;var y=function(C,S){var k=C||S,_=n[k];if(!_)throw new Error(k+" is not a valid compression method !");return _}(m.options.compression,r.compression),u=m.options.compressionOptions||r.compressionOptions||{},v=m.dir,b=m.date;m._compressWorker(y,u).withStreamInfo("file",{name:h,dir:v,date:b,comment:m.comment||"",unixPermissions:m.unixPermissions,dosPermissions:m.dosPermissions}).pipe(f)}),f.entriesCount=p}catch(h){f.error(h)}return f}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(t,c,o){function n(){if(!(this instanceof n))return new n;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var i=new n;for(var s in this)typeof this[s]!="function"&&(i[s]=this[s]);return i}}(n.prototype=t("./object")).loadAsync=t("./load"),n.support=t("./support"),n.defaults=t("./defaults"),n.version="3.10.1",n.loadAsync=function(i,s){return new n().loadAsync(i,s)},n.external=t("./external"),c.exports=n},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(t,c,o){var n=t("./utils"),i=t("./external"),s=t("./utf8"),r=t("./zipEntries"),l=t("./stream/Crc32Probe"),f=t("./nodejsUtils");function p(h){return new i.Promise(function(m,y){var u=h.decompressed.getContentWorker().pipe(new l);u.on("error",function(v){y(v)}).on("end",function(){u.streamInfo.crc32!==h.decompressed.crc32?y(new Error("Corrupted zip : CRC32 mismatch")):m()}).resume()})}c.exports=function(h,m){var y=this;return m=n.extend(m||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:s.utf8decode}),f.isNode&&f.isStream(h)?i.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):n.prepareContent("the loaded zip file",h,!0,m.optimizedBinaryString,m.base64).then(function(u){var v=new r(m);return v.load(u),v}).then(function(u){var v=[i.Promise.resolve(u)],b=u.files;if(m.checkCRC32)for(var C=0;C<b.length;C++)v.push(p(b[C]));return i.Promise.all(v)}).then(function(u){for(var v=u.shift(),b=v.files,C=0;C<b.length;C++){var S=b[C],k=S.fileNameStr,_=n.resolve(S.fileNameStr);y.file(_,S.decompressed,{binary:!0,optimizedBinaryString:!0,date:S.date,dir:S.dir,comment:S.fileCommentStr.length?S.fileCommentStr:null,unixPermissions:S.unixPermissions,dosPermissions:S.dosPermissions,createFolders:m.createFolders}),S.dir||(y.file(_).unsafeOriginalName=k)}return v.zipComment.length&&(y.comment=v.zipComment),y})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(t,c,o){var n=t("../utils"),i=t("../stream/GenericWorker");function s(r,l){i.call(this,"Nodejs stream input adapter for "+r),this._upstreamEnded=!1,this._bindStream(l)}n.inherits(s,i),s.prototype._bindStream=function(r){var l=this;(this._stream=r).pause(),r.on("data",function(f){l.push({data:f,meta:{percent:0}})}).on("error",function(f){l.isPaused?this.generatedError=f:l.error(f)}).on("end",function(){l.isPaused?l._upstreamEnded=!0:l.end()})},s.prototype.pause=function(){return!!i.prototype.pause.call(this)&&(this._stream.pause(),!0)},s.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},c.exports=s},{"../stream/GenericWorker":28,"../utils":32}],13:[function(t,c,o){var n=t("readable-stream").Readable;function i(s,r,l){n.call(this,r),this._helper=s;var f=this;s.on("data",function(p,h){f.push(p)||f._helper.pause(),l&&l(h)}).on("error",function(p){f.emit("error",p)}).on("end",function(){f.push(null)})}t("../utils").inherits(i,n),i.prototype._read=function(){this._helper.resume()},c.exports=i},{"../utils":32,"readable-stream":16}],14:[function(t,c,o){c.exports={isNode:typeof Buffer<"u",newBufferFrom:function(n,i){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(n,i);if(typeof n=="number")throw new Error('The "data" argument must not be a number');return new Buffer(n,i)},allocBuffer:function(n){if(Buffer.alloc)return Buffer.alloc(n);var i=new Buffer(n);return i.fill(0),i},isBuffer:function(n){return Buffer.isBuffer(n)},isStream:function(n){return n&&typeof n.on=="function"&&typeof n.pause=="function"&&typeof n.resume=="function"}}},{}],15:[function(t,c,o){function n(_,x,L){var D,M=s.getTypeOf(x),U=s.extend(L||{},f);U.date=U.date||new Date,U.compression!==null&&(U.compression=U.compression.toUpperCase()),typeof U.unixPermissions=="string"&&(U.unixPermissions=parseInt(U.unixPermissions,8)),U.unixPermissions&&16384&U.unixPermissions&&(U.dir=!0),U.dosPermissions&&16&U.dosPermissions&&(U.dir=!0),U.dir&&(_=b(_)),U.createFolders&&(D=v(_))&&C.call(this,D,!0);var Q=M==="string"&&U.binary===!1&&U.base64===!1;L&&L.binary!==void 0||(U.binary=!Q),(x instanceof p&&x.uncompressedSize===0||U.dir||!x||x.length===0)&&(U.base64=!1,U.binary=!0,x="",U.compression="STORE",M="string");var I=null;I=x instanceof p||x instanceof r?x:y.isNode&&y.isStream(x)?new u(_,x):s.prepareContent(_,x,U.binary,U.optimizedBinaryString,U.base64);var z=new h(_,I,U);this.files[_]=z}var i=t("./utf8"),s=t("./utils"),r=t("./stream/GenericWorker"),l=t("./stream/StreamHelper"),f=t("./defaults"),p=t("./compressedObject"),h=t("./zipObject"),m=t("./generate"),y=t("./nodejsUtils"),u=t("./nodejs/NodejsStreamInputAdapter"),v=function(_){_.slice(-1)==="/"&&(_=_.substring(0,_.length-1));var x=_.lastIndexOf("/");return 0<x?_.substring(0,x):""},b=function(_){return _.slice(-1)!=="/"&&(_+="/"),_},C=function(_,x){return x=x!==void 0?x:f.createFolders,_=b(_),this.files[_]||n.call(this,_,null,{dir:!0,createFolders:x}),this.files[_]};function S(_){return Object.prototype.toString.call(_)==="[object RegExp]"}var k={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(_){var x,L,D;for(x in this.files)D=this.files[x],(L=x.slice(this.root.length,x.length))&&x.slice(0,this.root.length)===this.root&&_(L,D)},filter:function(_){var x=[];return this.forEach(function(L,D){_(L,D)&&x.push(D)}),x},file:function(_,x,L){if(arguments.length!==1)return _=this.root+_,n.call(this,_,x,L),this;if(S(_)){var D=_;return this.filter(function(U,Q){return!Q.dir&&D.test(U)})}var M=this.files[this.root+_];return M&&!M.dir?M:null},folder:function(_){if(!_)return this;if(S(_))return this.filter(function(M,U){return U.dir&&_.test(M)});var x=this.root+_,L=C.call(this,x),D=this.clone();return D.root=L.name,D},remove:function(_){_=this.root+_;var x=this.files[_];if(x||(_.slice(-1)!=="/"&&(_+="/"),x=this.files[_]),x&&!x.dir)delete this.files[_];else for(var L=this.filter(function(M,U){return U.name.slice(0,_.length)===_}),D=0;D<L.length;D++)delete this.files[L[D].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(_){var x,L={};try{if((L=s.extend(_||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:i.utf8encode})).type=L.type.toLowerCase(),L.compression=L.compression.toUpperCase(),L.type==="binarystring"&&(L.type="string"),!L.type)throw new Error("No output type specified.");s.checkSupport(L.type),L.platform!=="darwin"&&L.platform!=="freebsd"&&L.platform!=="linux"&&L.platform!=="sunos"||(L.platform="UNIX"),L.platform==="win32"&&(L.platform="DOS");var D=L.comment||this.comment||"";x=m.generateWorker(this,L,D)}catch(M){(x=new r("error")).error(M)}return new l(x,L.type||"string",L.mimeType)},generateAsync:function(_,x){return this.generateInternalStream(_).accumulate(x)},generateNodeStream:function(_,x){return(_=_||{}).type||(_.type="nodebuffer"),this.generateInternalStream(_).toNodejsStream(x)}};c.exports=k},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(t,c,o){c.exports=t("stream")},{stream:void 0}],17:[function(t,c,o){var n=t("./DataReader");function i(s){n.call(this,s);for(var r=0;r<this.data.length;r++)s[r]=255&s[r]}t("../utils").inherits(i,n),i.prototype.byteAt=function(s){return this.data[this.zero+s]},i.prototype.lastIndexOfSignature=function(s){for(var r=s.charCodeAt(0),l=s.charCodeAt(1),f=s.charCodeAt(2),p=s.charCodeAt(3),h=this.length-4;0<=h;--h)if(this.data[h]===r&&this.data[h+1]===l&&this.data[h+2]===f&&this.data[h+3]===p)return h-this.zero;return-1},i.prototype.readAndCheckSignature=function(s){var r=s.charCodeAt(0),l=s.charCodeAt(1),f=s.charCodeAt(2),p=s.charCodeAt(3),h=this.readData(4);return r===h[0]&&l===h[1]&&f===h[2]&&p===h[3]},i.prototype.readData=function(s){if(this.checkOffset(s),s===0)return[];var r=this.data.slice(this.zero+this.index,this.zero+this.index+s);return this.index+=s,r},c.exports=i},{"../utils":32,"./DataReader":18}],18:[function(t,c,o){var n=t("../utils");function i(s){this.data=s,this.length=s.length,this.index=0,this.zero=0}i.prototype={checkOffset:function(s){this.checkIndex(this.index+s)},checkIndex:function(s){if(this.length<this.zero+s||s<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+s+"). Corrupted zip ?")},setIndex:function(s){this.checkIndex(s),this.index=s},skip:function(s){this.setIndex(this.index+s)},byteAt:function(){},readInt:function(s){var r,l=0;for(this.checkOffset(s),r=this.index+s-1;r>=this.index;r--)l=(l<<8)+this.byteAt(r);return this.index+=s,l},readString:function(s){return n.transformTo("string",this.readData(s))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var s=this.readInt(4);return new Date(Date.UTC(1980+(s>>25&127),(s>>21&15)-1,s>>16&31,s>>11&31,s>>5&63,(31&s)<<1))}},c.exports=i},{"../utils":32}],19:[function(t,c,o){var n=t("./Uint8ArrayReader");function i(s){n.call(this,s)}t("../utils").inherits(i,n),i.prototype.readData=function(s){this.checkOffset(s);var r=this.data.slice(this.zero+this.index,this.zero+this.index+s);return this.index+=s,r},c.exports=i},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(t,c,o){var n=t("./DataReader");function i(s){n.call(this,s)}t("../utils").inherits(i,n),i.prototype.byteAt=function(s){return this.data.charCodeAt(this.zero+s)},i.prototype.lastIndexOfSignature=function(s){return this.data.lastIndexOf(s)-this.zero},i.prototype.readAndCheckSignature=function(s){return s===this.readData(4)},i.prototype.readData=function(s){this.checkOffset(s);var r=this.data.slice(this.zero+this.index,this.zero+this.index+s);return this.index+=s,r},c.exports=i},{"../utils":32,"./DataReader":18}],21:[function(t,c,o){var n=t("./ArrayReader");function i(s){n.call(this,s)}t("../utils").inherits(i,n),i.prototype.readData=function(s){if(this.checkOffset(s),s===0)return new Uint8Array(0);var r=this.data.subarray(this.zero+this.index,this.zero+this.index+s);return this.index+=s,r},c.exports=i},{"../utils":32,"./ArrayReader":17}],22:[function(t,c,o){var n=t("../utils"),i=t("../support"),s=t("./ArrayReader"),r=t("./StringReader"),l=t("./NodeBufferReader"),f=t("./Uint8ArrayReader");c.exports=function(p){var h=n.getTypeOf(p);return n.checkSupport(h),h!=="string"||i.uint8array?h==="nodebuffer"?new l(p):i.uint8array?new f(n.transformTo("uint8array",p)):new s(n.transformTo("array",p)):new r(p)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(t,c,o){o.LOCAL_FILE_HEADER="PK",o.CENTRAL_FILE_HEADER="PK",o.CENTRAL_DIRECTORY_END="PK",o.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",o.ZIP64_CENTRAL_DIRECTORY_END="PK",o.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(t,c,o){var n=t("./GenericWorker"),i=t("../utils");function s(r){n.call(this,"ConvertWorker to "+r),this.destType=r}i.inherits(s,n),s.prototype.processChunk=function(r){this.push({data:i.transformTo(this.destType,r.data),meta:r.meta})},c.exports=s},{"../utils":32,"./GenericWorker":28}],25:[function(t,c,o){var n=t("./GenericWorker"),i=t("../crc32");function s(){n.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}t("../utils").inherits(s,n),s.prototype.processChunk=function(r){this.streamInfo.crc32=i(r.data,this.streamInfo.crc32||0),this.push(r)},c.exports=s},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(t,c,o){var n=t("../utils"),i=t("./GenericWorker");function s(r){i.call(this,"DataLengthProbe for "+r),this.propName=r,this.withStreamInfo(r,0)}n.inherits(s,i),s.prototype.processChunk=function(r){if(r){var l=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=l+r.data.length}i.prototype.processChunk.call(this,r)},c.exports=s},{"../utils":32,"./GenericWorker":28}],27:[function(t,c,o){var n=t("../utils"),i=t("./GenericWorker");function s(r){i.call(this,"DataWorker");var l=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,r.then(function(f){l.dataIsReady=!0,l.data=f,l.max=f&&f.length||0,l.type=n.getTypeOf(f),l.isPaused||l._tickAndRepeat()},function(f){l.error(f)})}n.inherits(s,i),s.prototype.cleanUp=function(){i.prototype.cleanUp.call(this),this.data=null},s.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,n.delay(this._tickAndRepeat,[],this)),!0)},s.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(n.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},s.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var r=null,l=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":r=this.data.substring(this.index,l);break;case"uint8array":r=this.data.subarray(this.index,l);break;case"array":case"nodebuffer":r=this.data.slice(this.index,l)}return this.index=l,this.push({data:r,meta:{percent:this.max?this.index/this.max*100:0}})},c.exports=s},{"../utils":32,"./GenericWorker":28}],28:[function(t,c,o){function n(i){this.name=i||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}n.prototype={push:function(i){this.emit("data",i)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(i){this.emit("error",i)}return!0},error:function(i){return!this.isFinished&&(this.isPaused?this.generatedError=i:(this.isFinished=!0,this.emit("error",i),this.previous&&this.previous.error(i),this.cleanUp()),!0)},on:function(i,s){return this._listeners[i].push(s),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(i,s){if(this._listeners[i])for(var r=0;r<this._listeners[i].length;r++)this._listeners[i][r].call(this,s)},pipe:function(i){return i.registerPrevious(this)},registerPrevious:function(i){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=i.streamInfo,this.mergeStreamInfo(),this.previous=i;var s=this;return i.on("data",function(r){s.processChunk(r)}),i.on("end",function(){s.end()}),i.on("error",function(r){s.error(r)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var i=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),i=!0),this.previous&&this.previous.resume(),!i},flush:function(){},processChunk:function(i){this.push(i)},withStreamInfo:function(i,s){return this.extraStreamInfo[i]=s,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var i in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,i)&&(this.streamInfo[i]=this.extraStreamInfo[i])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var i="Worker "+this.name;return this.previous?this.previous+" -> "+i:i}},c.exports=n},{}],29:[function(t,c,o){var n=t("../utils"),i=t("./ConvertWorker"),s=t("./GenericWorker"),r=t("../base64"),l=t("../support"),f=t("../external"),p=null;if(l.nodestream)try{p=t("../nodejs/NodejsStreamOutputAdapter")}catch{}function h(y,u){return new f.Promise(function(v,b){var C=[],S=y._internalType,k=y._outputType,_=y._mimeType;y.on("data",function(x,L){C.push(x),u&&u(L)}).on("error",function(x){C=[],b(x)}).on("end",function(){try{var x=function(L,D,M){switch(L){case"blob":return n.newBlob(n.transformTo("arraybuffer",D),M);case"base64":return r.encode(D);default:return n.transformTo(L,D)}}(k,function(L,D){var M,U=0,Q=null,I=0;for(M=0;M<D.length;M++)I+=D[M].length;switch(L){case"string":return D.join("");case"array":return Array.prototype.concat.apply([],D);case"uint8array":for(Q=new Uint8Array(I),M=0;M<D.length;M++)Q.set(D[M],U),U+=D[M].length;return Q;case"nodebuffer":return Buffer.concat(D);default:throw new Error("concat : unsupported type '"+L+"'")}}(S,C),_);v(x)}catch(L){b(L)}C=[]}).resume()})}function m(y,u,v){var b=u;switch(u){case"blob":case"arraybuffer":b="uint8array";break;case"base64":b="string"}try{this._internalType=b,this._outputType=u,this._mimeType=v,n.checkSupport(b),this._worker=y.pipe(new i(b)),y.lock()}catch(C){this._worker=new s("error"),this._worker.error(C)}}m.prototype={accumulate:function(y){return h(this,y)},on:function(y,u){var v=this;return y==="data"?this._worker.on(y,function(b){u.call(v,b.data,b.meta)}):this._worker.on(y,function(){n.delay(u,arguments,v)}),this},resume:function(){return n.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(y){if(n.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new p(this,{objectMode:this._outputType!=="nodebuffer"},y)}},c.exports=m},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(t,c,o){if(o.base64=!0,o.array=!0,o.string=!0,o.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",o.nodebuffer=typeof Buffer<"u",o.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")o.blob=!1;else{var n=new ArrayBuffer(0);try{o.blob=new Blob([n],{type:"application/zip"}).size===0}catch{try{var i=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);i.append(n),o.blob=i.getBlob("application/zip").size===0}catch{o.blob=!1}}}try{o.nodestream=!!t("readable-stream").Readable}catch{o.nodestream=!1}},{"readable-stream":16}],31:[function(t,c,o){for(var n=t("./utils"),i=t("./support"),s=t("./nodejsUtils"),r=t("./stream/GenericWorker"),l=new Array(256),f=0;f<256;f++)l[f]=252<=f?6:248<=f?5:240<=f?4:224<=f?3:192<=f?2:1;l[254]=l[254]=1;function p(){r.call(this,"utf-8 decode"),this.leftOver=null}function h(){r.call(this,"utf-8 encode")}o.utf8encode=function(m){return i.nodebuffer?s.newBufferFrom(m,"utf-8"):function(y){var u,v,b,C,S,k=y.length,_=0;for(C=0;C<k;C++)(64512&(v=y.charCodeAt(C)))==55296&&C+1<k&&(64512&(b=y.charCodeAt(C+1)))==56320&&(v=65536+(v-55296<<10)+(b-56320),C++),_+=v<128?1:v<2048?2:v<65536?3:4;for(u=i.uint8array?new Uint8Array(_):new Array(_),C=S=0;S<_;C++)(64512&(v=y.charCodeAt(C)))==55296&&C+1<k&&(64512&(b=y.charCodeAt(C+1)))==56320&&(v=65536+(v-55296<<10)+(b-56320),C++),v<128?u[S++]=v:(v<2048?u[S++]=192|v>>>6:(v<65536?u[S++]=224|v>>>12:(u[S++]=240|v>>>18,u[S++]=128|v>>>12&63),u[S++]=128|v>>>6&63),u[S++]=128|63&v);return u}(m)},o.utf8decode=function(m){return i.nodebuffer?n.transformTo("nodebuffer",m).toString("utf-8"):function(y){var u,v,b,C,S=y.length,k=new Array(2*S);for(u=v=0;u<S;)if((b=y[u++])<128)k[v++]=b;else if(4<(C=l[b]))k[v++]=65533,u+=C-1;else{for(b&=C===2?31:C===3?15:7;1<C&&u<S;)b=b<<6|63&y[u++],C--;1<C?k[v++]=65533:b<65536?k[v++]=b:(b-=65536,k[v++]=55296|b>>10&1023,k[v++]=56320|1023&b)}return k.length!==v&&(k.subarray?k=k.subarray(0,v):k.length=v),n.applyFromCharCode(k)}(m=n.transformTo(i.uint8array?"uint8array":"array",m))},n.inherits(p,r),p.prototype.processChunk=function(m){var y=n.transformTo(i.uint8array?"uint8array":"array",m.data);if(this.leftOver&&this.leftOver.length){if(i.uint8array){var u=y;(y=new Uint8Array(u.length+this.leftOver.length)).set(this.leftOver,0),y.set(u,this.leftOver.length)}else y=this.leftOver.concat(y);this.leftOver=null}var v=function(C,S){var k;for((S=S||C.length)>C.length&&(S=C.length),k=S-1;0<=k&&(192&C[k])==128;)k--;return k<0||k===0?S:k+l[C[k]]>S?k:S}(y),b=y;v!==y.length&&(i.uint8array?(b=y.subarray(0,v),this.leftOver=y.subarray(v,y.length)):(b=y.slice(0,v),this.leftOver=y.slice(v,y.length))),this.push({data:o.utf8decode(b),meta:m.meta})},p.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:o.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},o.Utf8DecodeWorker=p,n.inherits(h,r),h.prototype.processChunk=function(m){this.push({data:o.utf8encode(m.data),meta:m.meta})},o.Utf8EncodeWorker=h},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(t,c,o){var n=t("./support"),i=t("./base64"),s=t("./nodejsUtils"),r=t("./external");function l(u){return u}function f(u,v){for(var b=0;b<u.length;++b)v[b]=255&u.charCodeAt(b);return v}t("setimmediate"),o.newBlob=function(u,v){o.checkSupport("blob");try{return new Blob([u],{type:v})}catch{try{var b=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return b.append(u),b.getBlob(v)}catch{throw new Error("Bug : can't construct the Blob.")}}};var p={stringifyByChunk:function(u,v,b){var C=[],S=0,k=u.length;if(k<=b)return String.fromCharCode.apply(null,u);for(;S<k;)v==="array"||v==="nodebuffer"?C.push(String.fromCharCode.apply(null,u.slice(S,Math.min(S+b,k)))):C.push(String.fromCharCode.apply(null,u.subarray(S,Math.min(S+b,k)))),S+=b;return C.join("")},stringifyByChar:function(u){for(var v="",b=0;b<u.length;b++)v+=String.fromCharCode(u[b]);return v},applyCanBeUsed:{uint8array:function(){try{return n.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}}(),nodebuffer:function(){try{return n.nodebuffer&&String.fromCharCode.apply(null,s.allocBuffer(1)).length===1}catch{return!1}}()}};function h(u){var v=65536,b=o.getTypeOf(u),C=!0;if(b==="uint8array"?C=p.applyCanBeUsed.uint8array:b==="nodebuffer"&&(C=p.applyCanBeUsed.nodebuffer),C)for(;1<v;)try{return p.stringifyByChunk(u,b,v)}catch{v=Math.floor(v/2)}return p.stringifyByChar(u)}function m(u,v){for(var b=0;b<u.length;b++)v[b]=u[b];return v}o.applyFromCharCode=h;var y={};y.string={string:l,array:function(u){return f(u,new Array(u.length))},arraybuffer:function(u){return y.string.uint8array(u).buffer},uint8array:function(u){return f(u,new Uint8Array(u.length))},nodebuffer:function(u){return f(u,s.allocBuffer(u.length))}},y.array={string:h,array:l,arraybuffer:function(u){return new Uint8Array(u).buffer},uint8array:function(u){return new Uint8Array(u)},nodebuffer:function(u){return s.newBufferFrom(u)}},y.arraybuffer={string:function(u){return h(new Uint8Array(u))},array:function(u){return m(new Uint8Array(u),new Array(u.byteLength))},arraybuffer:l,uint8array:function(u){return new Uint8Array(u)},nodebuffer:function(u){return s.newBufferFrom(new Uint8Array(u))}},y.uint8array={string:h,array:function(u){return m(u,new Array(u.length))},arraybuffer:function(u){return u.buffer},uint8array:l,nodebuffer:function(u){return s.newBufferFrom(u)}},y.nodebuffer={string:h,array:function(u){return m(u,new Array(u.length))},arraybuffer:function(u){return y.nodebuffer.uint8array(u).buffer},uint8array:function(u){return m(u,new Uint8Array(u.length))},nodebuffer:l},o.transformTo=function(u,v){if(v=v||"",!u)return v;o.checkSupport(u);var b=o.getTypeOf(v);return y[b][u](v)},o.resolve=function(u){for(var v=u.split("/"),b=[],C=0;C<v.length;C++){var S=v[C];S==="."||S===""&&C!==0&&C!==v.length-1||(S===".."?b.pop():b.push(S))}return b.join("/")},o.getTypeOf=function(u){return typeof u=="string"?"string":Object.prototype.toString.call(u)==="[object Array]"?"array":n.nodebuffer&&s.isBuffer(u)?"nodebuffer":n.uint8array&&u instanceof Uint8Array?"uint8array":n.arraybuffer&&u instanceof ArrayBuffer?"arraybuffer":void 0},o.checkSupport=function(u){if(!n[u.toLowerCase()])throw new Error(u+" is not supported by this platform")},o.MAX_VALUE_16BITS=65535,o.MAX_VALUE_32BITS=-1,o.pretty=function(u){var v,b,C="";for(b=0;b<(u||"").length;b++)C+="\\x"+((v=u.charCodeAt(b))<16?"0":"")+v.toString(16).toUpperCase();return C},o.delay=function(u,v,b){setImmediate(function(){u.apply(b||null,v||[])})},o.inherits=function(u,v){function b(){}b.prototype=v.prototype,u.prototype=new b},o.extend=function(){var u,v,b={};for(u=0;u<arguments.length;u++)for(v in arguments[u])Object.prototype.hasOwnProperty.call(arguments[u],v)&&b[v]===void 0&&(b[v]=arguments[u][v]);return b},o.prepareContent=function(u,v,b,C,S){return r.Promise.resolve(v).then(function(k){return n.blob&&(k instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(k))!==-1)&&typeof FileReader<"u"?new r.Promise(function(_,x){var L=new FileReader;L.onload=function(D){_(D.target.result)},L.onerror=function(D){x(D.target.error)},L.readAsArrayBuffer(k)}):k}).then(function(k){var _=o.getTypeOf(k);return _?(_==="arraybuffer"?k=o.transformTo("uint8array",k):_==="string"&&(S?k=i.decode(k):b&&C!==!0&&(k=function(x){return f(x,n.uint8array?new Uint8Array(x.length):new Array(x.length))}(k))),k):r.Promise.reject(new Error("Can't read the data of '"+u+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(t,c,o){var n=t("./reader/readerFor"),i=t("./utils"),s=t("./signature"),r=t("./zipEntry"),l=t("./support");function f(p){this.files=[],this.loadOptions=p}f.prototype={checkSignature:function(p){if(!this.reader.readAndCheckSignature(p)){this.reader.index-=4;var h=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+i.pretty(h)+", expected "+i.pretty(p)+")")}},isSignature:function(p,h){var m=this.reader.index;this.reader.setIndex(p);var y=this.reader.readString(4)===h;return this.reader.setIndex(m),y},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var p=this.reader.readData(this.zipCommentLength),h=l.uint8array?"uint8array":"array",m=i.transformTo(h,p);this.zipComment=this.loadOptions.decodeFileName(m)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var p,h,m,y=this.zip64EndOfCentralSize-44;0<y;)p=this.reader.readInt(2),h=this.reader.readInt(4),m=this.reader.readData(h),this.zip64ExtensibleData[p]={id:p,length:h,value:m}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var p,h;for(p=0;p<this.files.length;p++)h=this.files[p],this.reader.setIndex(h.localHeaderOffset),this.checkSignature(s.LOCAL_FILE_HEADER),h.readLocalPart(this.reader),h.handleUTF8(),h.processAttributes()},readCentralDir:function(){var p;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(s.CENTRAL_FILE_HEADER);)(p=new r({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(p);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var p=this.reader.lastIndexOfSignature(s.CENTRAL_DIRECTORY_END);if(p<0)throw this.isSignature(0,s.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(p);var h=p;if(this.checkSignature(s.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===i.MAX_VALUE_16BITS||this.diskWithCentralDirStart===i.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===i.MAX_VALUE_16BITS||this.centralDirRecords===i.MAX_VALUE_16BITS||this.centralDirSize===i.MAX_VALUE_32BITS||this.centralDirOffset===i.MAX_VALUE_32BITS){if(this.zip64=!0,(p=this.reader.lastIndexOfSignature(s.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(p),this.checkSignature(s.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,s.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(s.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(s.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var m=this.centralDirOffset+this.centralDirSize;this.zip64&&(m+=20,m+=12+this.zip64EndOfCentralSize);var y=h-m;if(0<y)this.isSignature(h,s.CENTRAL_FILE_HEADER)||(this.reader.zero=y);else if(y<0)throw new Error("Corrupted zip: missing "+Math.abs(y)+" bytes.")},prepareReader:function(p){this.reader=n(p)},load:function(p){this.prepareReader(p),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},c.exports=f},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(t,c,o){var n=t("./reader/readerFor"),i=t("./utils"),s=t("./compressedObject"),r=t("./crc32"),l=t("./utf8"),f=t("./compressions"),p=t("./support");function h(m,y){this.options=m,this.loadOptions=y}h.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(m){var y,u;if(m.skip(22),this.fileNameLength=m.readInt(2),u=m.readInt(2),this.fileName=m.readData(this.fileNameLength),m.skip(u),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((y=function(v){for(var b in f)if(Object.prototype.hasOwnProperty.call(f,b)&&f[b].magic===v)return f[b];return null}(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+i.pretty(this.compressionMethod)+" unknown (inner file : "+i.transformTo("string",this.fileName)+")");this.decompressed=new s(this.compressedSize,this.uncompressedSize,this.crc32,y,m.readData(this.compressedSize))},readCentralPart:function(m){this.versionMadeBy=m.readInt(2),m.skip(2),this.bitFlag=m.readInt(2),this.compressionMethod=m.readString(2),this.date=m.readDate(),this.crc32=m.readInt(4),this.compressedSize=m.readInt(4),this.uncompressedSize=m.readInt(4);var y=m.readInt(2);if(this.extraFieldsLength=m.readInt(2),this.fileCommentLength=m.readInt(2),this.diskNumberStart=m.readInt(2),this.internalFileAttributes=m.readInt(2),this.externalFileAttributes=m.readInt(4),this.localHeaderOffset=m.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");m.skip(y),this.readExtraFields(m),this.parseZIP64ExtraField(m),this.fileComment=m.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var m=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),m==0&&(this.dosPermissions=63&this.externalFileAttributes),m==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var m=n(this.extraFields[1].value);this.uncompressedSize===i.MAX_VALUE_32BITS&&(this.uncompressedSize=m.readInt(8)),this.compressedSize===i.MAX_VALUE_32BITS&&(this.compressedSize=m.readInt(8)),this.localHeaderOffset===i.MAX_VALUE_32BITS&&(this.localHeaderOffset=m.readInt(8)),this.diskNumberStart===i.MAX_VALUE_32BITS&&(this.diskNumberStart=m.readInt(4))}},readExtraFields:function(m){var y,u,v,b=m.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});m.index+4<b;)y=m.readInt(2),u=m.readInt(2),v=m.readData(u),this.extraFields[y]={id:y,length:u,value:v};m.setIndex(b)},handleUTF8:function(){var m=p.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=l.utf8decode(this.fileName),this.fileCommentStr=l.utf8decode(this.fileComment);else{var y=this.findExtraFieldUnicodePath();if(y!==null)this.fileNameStr=y;else{var u=i.transformTo(m,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(u)}var v=this.findExtraFieldUnicodeComment();if(v!==null)this.fileCommentStr=v;else{var b=i.transformTo(m,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(b)}}},findExtraFieldUnicodePath:function(){var m=this.extraFields[28789];if(m){var y=n(m.value);return y.readInt(1)!==1||r(this.fileName)!==y.readInt(4)?null:l.utf8decode(y.readData(m.length-5))}return null},findExtraFieldUnicodeComment:function(){var m=this.extraFields[25461];if(m){var y=n(m.value);return y.readInt(1)!==1||r(this.fileComment)!==y.readInt(4)?null:l.utf8decode(y.readData(m.length-5))}return null}},c.exports=h},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(t,c,o){function n(y,u,v){this.name=y,this.dir=v.dir,this.date=v.date,this.comment=v.comment,this.unixPermissions=v.unixPermissions,this.dosPermissions=v.dosPermissions,this._data=u,this._dataBinary=v.binary,this.options={compression:v.compression,compressionOptions:v.compressionOptions}}var i=t("./stream/StreamHelper"),s=t("./stream/DataWorker"),r=t("./utf8"),l=t("./compressedObject"),f=t("./stream/GenericWorker");n.prototype={internalStream:function(y){var u=null,v="string";try{if(!y)throw new Error("No output type specified.");var b=(v=y.toLowerCase())==="string"||v==="text";v!=="binarystring"&&v!=="text"||(v="string"),u=this._decompressWorker();var C=!this._dataBinary;C&&!b&&(u=u.pipe(new r.Utf8EncodeWorker)),!C&&b&&(u=u.pipe(new r.Utf8DecodeWorker))}catch(S){(u=new f("error")).error(S)}return new i(u,v,"")},async:function(y,u){return this.internalStream(y).accumulate(u)},nodeStream:function(y,u){return this.internalStream(y||"nodebuffer").toNodejsStream(u)},_compressWorker:function(y,u){if(this._data instanceof l&&this._data.compression.magic===y.magic)return this._data.getCompressedWorker();var v=this._decompressWorker();return this._dataBinary||(v=v.pipe(new r.Utf8EncodeWorker)),l.createWorkerFrom(v,y,u)},_decompressWorker:function(){return this._data instanceof l?this._data.getContentWorker():this._data instanceof f?this._data:new s(this._data)}};for(var p=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],h=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},m=0;m<p.length;m++)n.prototype[p[m]]=h;c.exports=n},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(t,c,o){(function(n){var i,s,r=n.MutationObserver||n.WebKitMutationObserver;if(r){var l=0,f=new r(y),p=n.document.createTextNode("");f.observe(p,{characterData:!0}),i=function(){p.data=l=++l%2}}else if(n.setImmediate||n.MessageChannel===void 0)i="document"in n&&"onreadystatechange"in n.document.createElement("script")?function(){var u=n.document.createElement("script");u.onreadystatechange=function(){y(),u.onreadystatechange=null,u.parentNode.removeChild(u),u=null},n.document.documentElement.appendChild(u)}:function(){setTimeout(y,0)};else{var h=new n.MessageChannel;h.port1.onmessage=y,i=function(){h.port2.postMessage(0)}}var m=[];function y(){var u,v;s=!0;for(var b=m.length;b;){for(v=m,m=[],u=-1;++u<b;)v[u]();b=m.length}s=!1}c.exports=function(u){m.push(u)!==1||s||i()}}).call(this,typeof Ln<"u"?Ln:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(t,c,o){var n=t("immediate");function i(){}var s={},r=["REJECTED"],l=["FULFILLED"],f=["PENDING"];function p(b){if(typeof b!="function")throw new TypeError("resolver must be a function");this.state=f,this.queue=[],this.outcome=void 0,b!==i&&u(this,b)}function h(b,C,S){this.promise=b,typeof C=="function"&&(this.onFulfilled=C,this.callFulfilled=this.otherCallFulfilled),typeof S=="function"&&(this.onRejected=S,this.callRejected=this.otherCallRejected)}function m(b,C,S){n(function(){var k;try{k=C(S)}catch(_){return s.reject(b,_)}k===b?s.reject(b,new TypeError("Cannot resolve promise with itself")):s.resolve(b,k)})}function y(b){var C=b&&b.then;if(b&&(typeof b=="object"||typeof b=="function")&&typeof C=="function")return function(){C.apply(b,arguments)}}function u(b,C){var S=!1;function k(L){S||(S=!0,s.reject(b,L))}function _(L){S||(S=!0,s.resolve(b,L))}var x=v(function(){C(_,k)});x.status==="error"&&k(x.value)}function v(b,C){var S={};try{S.value=b(C),S.status="success"}catch(k){S.status="error",S.value=k}return S}(c.exports=p).prototype.finally=function(b){if(typeof b!="function")return this;var C=this.constructor;return this.then(function(S){return C.resolve(b()).then(function(){return S})},function(S){return C.resolve(b()).then(function(){throw S})})},p.prototype.catch=function(b){return this.then(null,b)},p.prototype.then=function(b,C){if(typeof b!="function"&&this.state===l||typeof C!="function"&&this.state===r)return this;var S=new this.constructor(i);return this.state!==f?m(S,this.state===l?b:C,this.outcome):this.queue.push(new h(S,b,C)),S},h.prototype.callFulfilled=function(b){s.resolve(this.promise,b)},h.prototype.otherCallFulfilled=function(b){m(this.promise,this.onFulfilled,b)},h.prototype.callRejected=function(b){s.reject(this.promise,b)},h.prototype.otherCallRejected=function(b){m(this.promise,this.onRejected,b)},s.resolve=function(b,C){var S=v(y,C);if(S.status==="error")return s.reject(b,S.value);var k=S.value;if(k)u(b,k);else{b.state=l,b.outcome=C;for(var _=-1,x=b.queue.length;++_<x;)b.queue[_].callFulfilled(C)}return b},s.reject=function(b,C){b.state=r,b.outcome=C;for(var S=-1,k=b.queue.length;++S<k;)b.queue[S].callRejected(C);return b},p.resolve=function(b){return b instanceof this?b:s.resolve(new this(i),b)},p.reject=function(b){var C=new this(i);return s.reject(C,b)},p.all=function(b){var C=this;if(Object.prototype.toString.call(b)!=="[object Array]")return this.reject(new TypeError("must be an array"));var S=b.length,k=!1;if(!S)return this.resolve([]);for(var _=new Array(S),x=0,L=-1,D=new this(i);++L<S;)M(b[L],L);return D;function M(U,Q){C.resolve(U).then(function(I){_[Q]=I,++x!==S||k||(k=!0,s.resolve(D,_))},function(I){k||(k=!0,s.reject(D,I))})}},p.race=function(b){var C=this;if(Object.prototype.toString.call(b)!=="[object Array]")return this.reject(new TypeError("must be an array"));var S=b.length,k=!1;if(!S)return this.resolve([]);for(var _=-1,x=new this(i);++_<S;)L=b[_],C.resolve(L).then(function(D){k||(k=!0,s.resolve(x,D))},function(D){k||(k=!0,s.reject(x,D))});var L;return x}},{immediate:36}],38:[function(t,c,o){var n={};(0,t("./lib/utils/common").assign)(n,t("./lib/deflate"),t("./lib/inflate"),t("./lib/zlib/constants")),c.exports=n},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(t,c,o){var n=t("./zlib/deflate"),i=t("./utils/common"),s=t("./utils/strings"),r=t("./zlib/messages"),l=t("./zlib/zstream"),f=Object.prototype.toString,p=0,h=-1,m=0,y=8;function u(b){if(!(this instanceof u))return new u(b);this.options=i.assign({level:h,method:y,chunkSize:16384,windowBits:15,memLevel:8,strategy:m,to:""},b||{});var C=this.options;C.raw&&0<C.windowBits?C.windowBits=-C.windowBits:C.gzip&&0<C.windowBits&&C.windowBits<16&&(C.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new l,this.strm.avail_out=0;var S=n.deflateInit2(this.strm,C.level,C.method,C.windowBits,C.memLevel,C.strategy);if(S!==p)throw new Error(r[S]);if(C.header&&n.deflateSetHeader(this.strm,C.header),C.dictionary){var k;if(k=typeof C.dictionary=="string"?s.string2buf(C.dictionary):f.call(C.dictionary)==="[object ArrayBuffer]"?new Uint8Array(C.dictionary):C.dictionary,(S=n.deflateSetDictionary(this.strm,k))!==p)throw new Error(r[S]);this._dict_set=!0}}function v(b,C){var S=new u(C);if(S.push(b,!0),S.err)throw S.msg||r[S.err];return S.result}u.prototype.push=function(b,C){var S,k,_=this.strm,x=this.options.chunkSize;if(this.ended)return!1;k=C===~~C?C:C===!0?4:0,typeof b=="string"?_.input=s.string2buf(b):f.call(b)==="[object ArrayBuffer]"?_.input=new Uint8Array(b):_.input=b,_.next_in=0,_.avail_in=_.input.length;do{if(_.avail_out===0&&(_.output=new i.Buf8(x),_.next_out=0,_.avail_out=x),(S=n.deflate(_,k))!==1&&S!==p)return this.onEnd(S),!(this.ended=!0);_.avail_out!==0&&(_.avail_in!==0||k!==4&&k!==2)||(this.options.to==="string"?this.onData(s.buf2binstring(i.shrinkBuf(_.output,_.next_out))):this.onData(i.shrinkBuf(_.output,_.next_out)))}while((0<_.avail_in||_.avail_out===0)&&S!==1);return k===4?(S=n.deflateEnd(this.strm),this.onEnd(S),this.ended=!0,S===p):k!==2||(this.onEnd(p),!(_.avail_out=0))},u.prototype.onData=function(b){this.chunks.push(b)},u.prototype.onEnd=function(b){b===p&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=i.flattenChunks(this.chunks)),this.chunks=[],this.err=b,this.msg=this.strm.msg},o.Deflate=u,o.deflate=v,o.deflateRaw=function(b,C){return(C=C||{}).raw=!0,v(b,C)},o.gzip=function(b,C){return(C=C||{}).gzip=!0,v(b,C)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(t,c,o){var n=t("./zlib/inflate"),i=t("./utils/common"),s=t("./utils/strings"),r=t("./zlib/constants"),l=t("./zlib/messages"),f=t("./zlib/zstream"),p=t("./zlib/gzheader"),h=Object.prototype.toString;function m(u){if(!(this instanceof m))return new m(u);this.options=i.assign({chunkSize:16384,windowBits:0,to:""},u||{});var v=this.options;v.raw&&0<=v.windowBits&&v.windowBits<16&&(v.windowBits=-v.windowBits,v.windowBits===0&&(v.windowBits=-15)),!(0<=v.windowBits&&v.windowBits<16)||u&&u.windowBits||(v.windowBits+=32),15<v.windowBits&&v.windowBits<48&&!(15&v.windowBits)&&(v.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new f,this.strm.avail_out=0;var b=n.inflateInit2(this.strm,v.windowBits);if(b!==r.Z_OK)throw new Error(l[b]);this.header=new p,n.inflateGetHeader(this.strm,this.header)}function y(u,v){var b=new m(v);if(b.push(u,!0),b.err)throw b.msg||l[b.err];return b.result}m.prototype.push=function(u,v){var b,C,S,k,_,x,L=this.strm,D=this.options.chunkSize,M=this.options.dictionary,U=!1;if(this.ended)return!1;C=v===~~v?v:v===!0?r.Z_FINISH:r.Z_NO_FLUSH,typeof u=="string"?L.input=s.binstring2buf(u):h.call(u)==="[object ArrayBuffer]"?L.input=new Uint8Array(u):L.input=u,L.next_in=0,L.avail_in=L.input.length;do{if(L.avail_out===0&&(L.output=new i.Buf8(D),L.next_out=0,L.avail_out=D),(b=n.inflate(L,r.Z_NO_FLUSH))===r.Z_NEED_DICT&&M&&(x=typeof M=="string"?s.string2buf(M):h.call(M)==="[object ArrayBuffer]"?new Uint8Array(M):M,b=n.inflateSetDictionary(this.strm,x)),b===r.Z_BUF_ERROR&&U===!0&&(b=r.Z_OK,U=!1),b!==r.Z_STREAM_END&&b!==r.Z_OK)return this.onEnd(b),!(this.ended=!0);L.next_out&&(L.avail_out!==0&&b!==r.Z_STREAM_END&&(L.avail_in!==0||C!==r.Z_FINISH&&C!==r.Z_SYNC_FLUSH)||(this.options.to==="string"?(S=s.utf8border(L.output,L.next_out),k=L.next_out-S,_=s.buf2string(L.output,S),L.next_out=k,L.avail_out=D-k,k&&i.arraySet(L.output,L.output,S,k,0),this.onData(_)):this.onData(i.shrinkBuf(L.output,L.next_out)))),L.avail_in===0&&L.avail_out===0&&(U=!0)}while((0<L.avail_in||L.avail_out===0)&&b!==r.Z_STREAM_END);return b===r.Z_STREAM_END&&(C=r.Z_FINISH),C===r.Z_FINISH?(b=n.inflateEnd(this.strm),this.onEnd(b),this.ended=!0,b===r.Z_OK):C!==r.Z_SYNC_FLUSH||(this.onEnd(r.Z_OK),!(L.avail_out=0))},m.prototype.onData=function(u){this.chunks.push(u)},m.prototype.onEnd=function(u){u===r.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=i.flattenChunks(this.chunks)),this.chunks=[],this.err=u,this.msg=this.strm.msg},o.Inflate=m,o.inflate=y,o.inflateRaw=function(u,v){return(v=v||{}).raw=!0,y(u,v)},o.ungzip=y},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(t,c,o){var n=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";o.assign=function(r){for(var l=Array.prototype.slice.call(arguments,1);l.length;){var f=l.shift();if(f){if(typeof f!="object")throw new TypeError(f+"must be non-object");for(var p in f)f.hasOwnProperty(p)&&(r[p]=f[p])}}return r},o.shrinkBuf=function(r,l){return r.length===l?r:r.subarray?r.subarray(0,l):(r.length=l,r)};var i={arraySet:function(r,l,f,p,h){if(l.subarray&&r.subarray)r.set(l.subarray(f,f+p),h);else for(var m=0;m<p;m++)r[h+m]=l[f+m]},flattenChunks:function(r){var l,f,p,h,m,y;for(l=p=0,f=r.length;l<f;l++)p+=r[l].length;for(y=new Uint8Array(p),l=h=0,f=r.length;l<f;l++)m=r[l],y.set(m,h),h+=m.length;return y}},s={arraySet:function(r,l,f,p,h){for(var m=0;m<p;m++)r[h+m]=l[f+m]},flattenChunks:function(r){return[].concat.apply([],r)}};o.setTyped=function(r){r?(o.Buf8=Uint8Array,o.Buf16=Uint16Array,o.Buf32=Int32Array,o.assign(o,i)):(o.Buf8=Array,o.Buf16=Array,o.Buf32=Array,o.assign(o,s))},o.setTyped(n)},{}],42:[function(t,c,o){var n=t("./common"),i=!0,s=!0;try{String.fromCharCode.apply(null,[0])}catch{i=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{s=!1}for(var r=new n.Buf8(256),l=0;l<256;l++)r[l]=252<=l?6:248<=l?5:240<=l?4:224<=l?3:192<=l?2:1;function f(p,h){if(h<65537&&(p.subarray&&s||!p.subarray&&i))return String.fromCharCode.apply(null,n.shrinkBuf(p,h));for(var m="",y=0;y<h;y++)m+=String.fromCharCode(p[y]);return m}r[254]=r[254]=1,o.string2buf=function(p){var h,m,y,u,v,b=p.length,C=0;for(u=0;u<b;u++)(64512&(m=p.charCodeAt(u)))==55296&&u+1<b&&(64512&(y=p.charCodeAt(u+1)))==56320&&(m=65536+(m-55296<<10)+(y-56320),u++),C+=m<128?1:m<2048?2:m<65536?3:4;for(h=new n.Buf8(C),u=v=0;v<C;u++)(64512&(m=p.charCodeAt(u)))==55296&&u+1<b&&(64512&(y=p.charCodeAt(u+1)))==56320&&(m=65536+(m-55296<<10)+(y-56320),u++),m<128?h[v++]=m:(m<2048?h[v++]=192|m>>>6:(m<65536?h[v++]=224|m>>>12:(h[v++]=240|m>>>18,h[v++]=128|m>>>12&63),h[v++]=128|m>>>6&63),h[v++]=128|63&m);return h},o.buf2binstring=function(p){return f(p,p.length)},o.binstring2buf=function(p){for(var h=new n.Buf8(p.length),m=0,y=h.length;m<y;m++)h[m]=p.charCodeAt(m);return h},o.buf2string=function(p,h){var m,y,u,v,b=h||p.length,C=new Array(2*b);for(m=y=0;m<b;)if((u=p[m++])<128)C[y++]=u;else if(4<(v=r[u]))C[y++]=65533,m+=v-1;else{for(u&=v===2?31:v===3?15:7;1<v&&m<b;)u=u<<6|63&p[m++],v--;1<v?C[y++]=65533:u<65536?C[y++]=u:(u-=65536,C[y++]=55296|u>>10&1023,C[y++]=56320|1023&u)}return f(C,y)},o.utf8border=function(p,h){var m;for((h=h||p.length)>p.length&&(h=p.length),m=h-1;0<=m&&(192&p[m])==128;)m--;return m<0||m===0?h:m+r[p[m]]>h?m:h}},{"./common":41}],43:[function(t,c,o){c.exports=function(n,i,s,r){for(var l=65535&n|0,f=n>>>16&65535|0,p=0;s!==0;){for(s-=p=2e3<s?2e3:s;f=f+(l=l+i[r++]|0)|0,--p;);l%=65521,f%=65521}return l|f<<16|0}},{}],44:[function(t,c,o){c.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(t,c,o){var n=function(){for(var i,s=[],r=0;r<256;r++){i=r;for(var l=0;l<8;l++)i=1&i?3988292384^i>>>1:i>>>1;s[r]=i}return s}();c.exports=function(i,s,r,l){var f=n,p=l+r;i^=-1;for(var h=l;h<p;h++)i=i>>>8^f[255&(i^s[h])];return-1^i}},{}],46:[function(t,c,o){var n,i=t("../utils/common"),s=t("./trees"),r=t("./adler32"),l=t("./crc32"),f=t("./messages"),p=0,h=4,m=0,y=-2,u=-1,v=4,b=2,C=8,S=9,k=286,_=30,x=19,L=2*k+1,D=15,M=3,U=258,Q=U+M+1,I=42,z=113,g=1,W=2,ue=3,q=4;function me(d,H){return d.msg=f[H],H}function V(d){return(d<<1)-(4<d?9:0)}function fe(d){for(var H=d.length;0<=--H;)d[H]=0}function R(d){var H=d.state,$=H.pending;$>d.avail_out&&($=d.avail_out),$!==0&&(i.arraySet(d.output,H.pending_buf,H.pending_out,$,d.next_out),d.next_out+=$,H.pending_out+=$,d.total_out+=$,d.avail_out-=$,H.pending-=$,H.pending===0&&(H.pending_out=0))}function O(d,H){s._tr_flush_block(d,0<=d.block_start?d.block_start:-1,d.strstart-d.block_start,H),d.block_start=d.strstart,R(d.strm)}function de(d,H){d.pending_buf[d.pending++]=H}function se(d,H){d.pending_buf[d.pending++]=H>>>8&255,d.pending_buf[d.pending++]=255&H}function ee(d,H){var $,E,w=d.max_chain_length,T=d.strstart,j=d.prev_length,Z=d.nice_match,N=d.strstart>d.w_size-Q?d.strstart-(d.w_size-Q):0,K=d.window,ne=d.w_mask,X=d.prev,le=d.strstart+U,xe=K[T+j-1],ve=K[T+j];d.prev_length>=d.good_match&&(w>>=2),Z>d.lookahead&&(Z=d.lookahead);do if(K[($=H)+j]===ve&&K[$+j-1]===xe&&K[$]===K[T]&&K[++$]===K[T+1]){T+=2,$++;do;while(K[++T]===K[++$]&&K[++T]===K[++$]&&K[++T]===K[++$]&&K[++T]===K[++$]&&K[++T]===K[++$]&&K[++T]===K[++$]&&K[++T]===K[++$]&&K[++T]===K[++$]&&T<le);if(E=U-(le-T),T=le-U,j<E){if(d.match_start=H,Z<=(j=E))break;xe=K[T+j-1],ve=K[T+j]}}while((H=X[H&ne])>N&&--w!=0);return j<=d.lookahead?j:d.lookahead}function Be(d){var H,$,E,w,T,j,Z,N,K,ne,X=d.w_size;do{if(w=d.window_size-d.lookahead-d.strstart,d.strstart>=X+(X-Q)){for(i.arraySet(d.window,d.window,X,X,0),d.match_start-=X,d.strstart-=X,d.block_start-=X,H=$=d.hash_size;E=d.head[--H],d.head[H]=X<=E?E-X:0,--$;);for(H=$=X;E=d.prev[--H],d.prev[H]=X<=E?E-X:0,--$;);w+=X}if(d.strm.avail_in===0)break;if(j=d.strm,Z=d.window,N=d.strstart+d.lookahead,K=w,ne=void 0,ne=j.avail_in,K<ne&&(ne=K),$=ne===0?0:(j.avail_in-=ne,i.arraySet(Z,j.input,j.next_in,ne,N),j.state.wrap===1?j.adler=r(j.adler,Z,ne,N):j.state.wrap===2&&(j.adler=l(j.adler,Z,ne,N)),j.next_in+=ne,j.total_in+=ne,ne),d.lookahead+=$,d.lookahead+d.insert>=M)for(T=d.strstart-d.insert,d.ins_h=d.window[T],d.ins_h=(d.ins_h<<d.hash_shift^d.window[T+1])&d.hash_mask;d.insert&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[T+M-1])&d.hash_mask,d.prev[T&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=T,T++,d.insert--,!(d.lookahead+d.insert<M)););}while(d.lookahead<Q&&d.strm.avail_in!==0)}function He(d,H){for(var $,E;;){if(d.lookahead<Q){if(Be(d),d.lookahead<Q&&H===p)return g;if(d.lookahead===0)break}if($=0,d.lookahead>=M&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+M-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),$!==0&&d.strstart-$<=d.w_size-Q&&(d.match_length=ee(d,$)),d.match_length>=M)if(E=s._tr_tally(d,d.strstart-d.match_start,d.match_length-M),d.lookahead-=d.match_length,d.match_length<=d.max_lazy_match&&d.lookahead>=M){for(d.match_length--;d.strstart++,d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+M-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart,--d.match_length!=0;);d.strstart++}else d.strstart+=d.match_length,d.match_length=0,d.ins_h=d.window[d.strstart],d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+1])&d.hash_mask;else E=s._tr_tally(d,0,d.window[d.strstart]),d.lookahead--,d.strstart++;if(E&&(O(d,!1),d.strm.avail_out===0))return g}return d.insert=d.strstart<M-1?d.strstart:M-1,H===h?(O(d,!0),d.strm.avail_out===0?ue:q):d.last_lit&&(O(d,!1),d.strm.avail_out===0)?g:W}function he(d,H){for(var $,E,w;;){if(d.lookahead<Q){if(Be(d),d.lookahead<Q&&H===p)return g;if(d.lookahead===0)break}if($=0,d.lookahead>=M&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+M-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),d.prev_length=d.match_length,d.prev_match=d.match_start,d.match_length=M-1,$!==0&&d.prev_length<d.max_lazy_match&&d.strstart-$<=d.w_size-Q&&(d.match_length=ee(d,$),d.match_length<=5&&(d.strategy===1||d.match_length===M&&4096<d.strstart-d.match_start)&&(d.match_length=M-1)),d.prev_length>=M&&d.match_length<=d.prev_length){for(w=d.strstart+d.lookahead-M,E=s._tr_tally(d,d.strstart-1-d.prev_match,d.prev_length-M),d.lookahead-=d.prev_length-1,d.prev_length-=2;++d.strstart<=w&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+M-1])&d.hash_mask,$=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),--d.prev_length!=0;);if(d.match_available=0,d.match_length=M-1,d.strstart++,E&&(O(d,!1),d.strm.avail_out===0))return g}else if(d.match_available){if((E=s._tr_tally(d,0,d.window[d.strstart-1]))&&O(d,!1),d.strstart++,d.lookahead--,d.strm.avail_out===0)return g}else d.match_available=1,d.strstart++,d.lookahead--}return d.match_available&&(E=s._tr_tally(d,0,d.window[d.strstart-1]),d.match_available=0),d.insert=d.strstart<M-1?d.strstart:M-1,H===h?(O(d,!0),d.strm.avail_out===0?ue:q):d.last_lit&&(O(d,!1),d.strm.avail_out===0)?g:W}function Se(d,H,$,E,w){this.good_length=d,this.max_lazy=H,this.nice_length=$,this.max_chain=E,this.func=w}function Me(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=C,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new i.Buf16(2*L),this.dyn_dtree=new i.Buf16(2*(2*_+1)),this.bl_tree=new i.Buf16(2*(2*x+1)),fe(this.dyn_ltree),fe(this.dyn_dtree),fe(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new i.Buf16(D+1),this.heap=new i.Buf16(2*k+1),fe(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new i.Buf16(2*k+1),fe(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function Ne(d){var H;return d&&d.state?(d.total_in=d.total_out=0,d.data_type=b,(H=d.state).pending=0,H.pending_out=0,H.wrap<0&&(H.wrap=-H.wrap),H.status=H.wrap?I:z,d.adler=H.wrap===2?0:1,H.last_flush=p,s._tr_init(H),m):me(d,y)}function st(d){var H=Ne(d);return H===m&&function($){$.window_size=2*$.w_size,fe($.head),$.max_lazy_match=n[$.level].max_lazy,$.good_match=n[$.level].good_length,$.nice_match=n[$.level].nice_length,$.max_chain_length=n[$.level].max_chain,$.strstart=0,$.block_start=0,$.lookahead=0,$.insert=0,$.match_length=$.prev_length=M-1,$.match_available=0,$.ins_h=0}(d.state),H}function at(d,H,$,E,w,T){if(!d)return y;var j=1;if(H===u&&(H=6),E<0?(j=0,E=-E):15<E&&(j=2,E-=16),w<1||S<w||$!==C||E<8||15<E||H<0||9<H||T<0||v<T)return me(d,y);E===8&&(E=9);var Z=new Me;return(d.state=Z).strm=d,Z.wrap=j,Z.gzhead=null,Z.w_bits=E,Z.w_size=1<<Z.w_bits,Z.w_mask=Z.w_size-1,Z.hash_bits=w+7,Z.hash_size=1<<Z.hash_bits,Z.hash_mask=Z.hash_size-1,Z.hash_shift=~~((Z.hash_bits+M-1)/M),Z.window=new i.Buf8(2*Z.w_size),Z.head=new i.Buf16(Z.hash_size),Z.prev=new i.Buf16(Z.w_size),Z.lit_bufsize=1<<w+6,Z.pending_buf_size=4*Z.lit_bufsize,Z.pending_buf=new i.Buf8(Z.pending_buf_size),Z.d_buf=1*Z.lit_bufsize,Z.l_buf=3*Z.lit_bufsize,Z.level=H,Z.strategy=T,Z.method=$,st(d)}n=[new Se(0,0,0,0,function(d,H){var $=65535;for($>d.pending_buf_size-5&&($=d.pending_buf_size-5);;){if(d.lookahead<=1){if(Be(d),d.lookahead===0&&H===p)return g;if(d.lookahead===0)break}d.strstart+=d.lookahead,d.lookahead=0;var E=d.block_start+$;if((d.strstart===0||d.strstart>=E)&&(d.lookahead=d.strstart-E,d.strstart=E,O(d,!1),d.strm.avail_out===0)||d.strstart-d.block_start>=d.w_size-Q&&(O(d,!1),d.strm.avail_out===0))return g}return d.insert=0,H===h?(O(d,!0),d.strm.avail_out===0?ue:q):(d.strstart>d.block_start&&(O(d,!1),d.strm.avail_out),g)}),new Se(4,4,8,4,He),new Se(4,5,16,8,He),new Se(4,6,32,32,He),new Se(4,4,16,16,he),new Se(8,16,32,32,he),new Se(8,16,128,128,he),new Se(8,32,128,256,he),new Se(32,128,258,1024,he),new Se(32,258,258,4096,he)],o.deflateInit=function(d,H){return at(d,H,C,15,8,0)},o.deflateInit2=at,o.deflateReset=st,o.deflateResetKeep=Ne,o.deflateSetHeader=function(d,H){return d&&d.state?d.state.wrap!==2?y:(d.state.gzhead=H,m):y},o.deflate=function(d,H){var $,E,w,T;if(!d||!d.state||5<H||H<0)return d?me(d,y):y;if(E=d.state,!d.output||!d.input&&d.avail_in!==0||E.status===666&&H!==h)return me(d,d.avail_out===0?-5:y);if(E.strm=d,$=E.last_flush,E.last_flush=H,E.status===I)if(E.wrap===2)d.adler=0,de(E,31),de(E,139),de(E,8),E.gzhead?(de(E,(E.gzhead.text?1:0)+(E.gzhead.hcrc?2:0)+(E.gzhead.extra?4:0)+(E.gzhead.name?8:0)+(E.gzhead.comment?16:0)),de(E,255&E.gzhead.time),de(E,E.gzhead.time>>8&255),de(E,E.gzhead.time>>16&255),de(E,E.gzhead.time>>24&255),de(E,E.level===9?2:2<=E.strategy||E.level<2?4:0),de(E,255&E.gzhead.os),E.gzhead.extra&&E.gzhead.extra.length&&(de(E,255&E.gzhead.extra.length),de(E,E.gzhead.extra.length>>8&255)),E.gzhead.hcrc&&(d.adler=l(d.adler,E.pending_buf,E.pending,0)),E.gzindex=0,E.status=69):(de(E,0),de(E,0),de(E,0),de(E,0),de(E,0),de(E,E.level===9?2:2<=E.strategy||E.level<2?4:0),de(E,3),E.status=z);else{var j=C+(E.w_bits-8<<4)<<8;j|=(2<=E.strategy||E.level<2?0:E.level<6?1:E.level===6?2:3)<<6,E.strstart!==0&&(j|=32),j+=31-j%31,E.status=z,se(E,j),E.strstart!==0&&(se(E,d.adler>>>16),se(E,65535&d.adler)),d.adler=1}if(E.status===69)if(E.gzhead.extra){for(w=E.pending;E.gzindex<(65535&E.gzhead.extra.length)&&(E.pending!==E.pending_buf_size||(E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),R(d),w=E.pending,E.pending!==E.pending_buf_size));)de(E,255&E.gzhead.extra[E.gzindex]),E.gzindex++;E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),E.gzindex===E.gzhead.extra.length&&(E.gzindex=0,E.status=73)}else E.status=73;if(E.status===73)if(E.gzhead.name){w=E.pending;do{if(E.pending===E.pending_buf_size&&(E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),R(d),w=E.pending,E.pending===E.pending_buf_size)){T=1;break}T=E.gzindex<E.gzhead.name.length?255&E.gzhead.name.charCodeAt(E.gzindex++):0,de(E,T)}while(T!==0);E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),T===0&&(E.gzindex=0,E.status=91)}else E.status=91;if(E.status===91)if(E.gzhead.comment){w=E.pending;do{if(E.pending===E.pending_buf_size&&(E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),R(d),w=E.pending,E.pending===E.pending_buf_size)){T=1;break}T=E.gzindex<E.gzhead.comment.length?255&E.gzhead.comment.charCodeAt(E.gzindex++):0,de(E,T)}while(T!==0);E.gzhead.hcrc&&E.pending>w&&(d.adler=l(d.adler,E.pending_buf,E.pending-w,w)),T===0&&(E.status=103)}else E.status=103;if(E.status===103&&(E.gzhead.hcrc?(E.pending+2>E.pending_buf_size&&R(d),E.pending+2<=E.pending_buf_size&&(de(E,255&d.adler),de(E,d.adler>>8&255),d.adler=0,E.status=z)):E.status=z),E.pending!==0){if(R(d),d.avail_out===0)return E.last_flush=-1,m}else if(d.avail_in===0&&V(H)<=V($)&&H!==h)return me(d,-5);if(E.status===666&&d.avail_in!==0)return me(d,-5);if(d.avail_in!==0||E.lookahead!==0||H!==p&&E.status!==666){var Z=E.strategy===2?function(N,K){for(var ne;;){if(N.lookahead===0&&(Be(N),N.lookahead===0)){if(K===p)return g;break}if(N.match_length=0,ne=s._tr_tally(N,0,N.window[N.strstart]),N.lookahead--,N.strstart++,ne&&(O(N,!1),N.strm.avail_out===0))return g}return N.insert=0,K===h?(O(N,!0),N.strm.avail_out===0?ue:q):N.last_lit&&(O(N,!1),N.strm.avail_out===0)?g:W}(E,H):E.strategy===3?function(N,K){for(var ne,X,le,xe,ve=N.window;;){if(N.lookahead<=U){if(Be(N),N.lookahead<=U&&K===p)return g;if(N.lookahead===0)break}if(N.match_length=0,N.lookahead>=M&&0<N.strstart&&(X=ve[le=N.strstart-1])===ve[++le]&&X===ve[++le]&&X===ve[++le]){xe=N.strstart+U;do;while(X===ve[++le]&&X===ve[++le]&&X===ve[++le]&&X===ve[++le]&&X===ve[++le]&&X===ve[++le]&&X===ve[++le]&&X===ve[++le]&&le<xe);N.match_length=U-(xe-le),N.match_length>N.lookahead&&(N.match_length=N.lookahead)}if(N.match_length>=M?(ne=s._tr_tally(N,1,N.match_length-M),N.lookahead-=N.match_length,N.strstart+=N.match_length,N.match_length=0):(ne=s._tr_tally(N,0,N.window[N.strstart]),N.lookahead--,N.strstart++),ne&&(O(N,!1),N.strm.avail_out===0))return g}return N.insert=0,K===h?(O(N,!0),N.strm.avail_out===0?ue:q):N.last_lit&&(O(N,!1),N.strm.avail_out===0)?g:W}(E,H):n[E.level].func(E,H);if(Z!==ue&&Z!==q||(E.status=666),Z===g||Z===ue)return d.avail_out===0&&(E.last_flush=-1),m;if(Z===W&&(H===1?s._tr_align(E):H!==5&&(s._tr_stored_block(E,0,0,!1),H===3&&(fe(E.head),E.lookahead===0&&(E.strstart=0,E.block_start=0,E.insert=0))),R(d),d.avail_out===0))return E.last_flush=-1,m}return H!==h?m:E.wrap<=0?1:(E.wrap===2?(de(E,255&d.adler),de(E,d.adler>>8&255),de(E,d.adler>>16&255),de(E,d.adler>>24&255),de(E,255&d.total_in),de(E,d.total_in>>8&255),de(E,d.total_in>>16&255),de(E,d.total_in>>24&255)):(se(E,d.adler>>>16),se(E,65535&d.adler)),R(d),0<E.wrap&&(E.wrap=-E.wrap),E.pending!==0?m:1)},o.deflateEnd=function(d){var H;return d&&d.state?(H=d.state.status)!==I&&H!==69&&H!==73&&H!==91&&H!==103&&H!==z&&H!==666?me(d,y):(d.state=null,H===z?me(d,-3):m):y},o.deflateSetDictionary=function(d,H){var $,E,w,T,j,Z,N,K,ne=H.length;if(!d||!d.state||(T=($=d.state).wrap)===2||T===1&&$.status!==I||$.lookahead)return y;for(T===1&&(d.adler=r(d.adler,H,ne,0)),$.wrap=0,ne>=$.w_size&&(T===0&&(fe($.head),$.strstart=0,$.block_start=0,$.insert=0),K=new i.Buf8($.w_size),i.arraySet(K,H,ne-$.w_size,$.w_size,0),H=K,ne=$.w_size),j=d.avail_in,Z=d.next_in,N=d.input,d.avail_in=ne,d.next_in=0,d.input=H,Be($);$.lookahead>=M;){for(E=$.strstart,w=$.lookahead-(M-1);$.ins_h=($.ins_h<<$.hash_shift^$.window[E+M-1])&$.hash_mask,$.prev[E&$.w_mask]=$.head[$.ins_h],$.head[$.ins_h]=E,E++,--w;);$.strstart=E,$.lookahead=M-1,Be($)}return $.strstart+=$.lookahead,$.block_start=$.strstart,$.insert=$.lookahead,$.lookahead=0,$.match_length=$.prev_length=M-1,$.match_available=0,d.next_in=Z,d.input=N,d.avail_in=j,$.wrap=T,m},o.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(t,c,o){c.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(t,c,o){c.exports=function(n,i){var s,r,l,f,p,h,m,y,u,v,b,C,S,k,_,x,L,D,M,U,Q,I,z,g,W;s=n.state,r=n.next_in,g=n.input,l=r+(n.avail_in-5),f=n.next_out,W=n.output,p=f-(i-n.avail_out),h=f+(n.avail_out-257),m=s.dmax,y=s.wsize,u=s.whave,v=s.wnext,b=s.window,C=s.hold,S=s.bits,k=s.lencode,_=s.distcode,x=(1<<s.lenbits)-1,L=(1<<s.distbits)-1;e:do{S<15&&(C+=g[r++]<<S,S+=8,C+=g[r++]<<S,S+=8),D=k[C&x];t:for(;;){if(C>>>=M=D>>>24,S-=M,(M=D>>>16&255)===0)W[f++]=65535&D;else{if(!(16&M)){if(!(64&M)){D=k[(65535&D)+(C&(1<<M)-1)];continue t}if(32&M){s.mode=12;break e}n.msg="invalid literal/length code",s.mode=30;break e}U=65535&D,(M&=15)&&(S<M&&(C+=g[r++]<<S,S+=8),U+=C&(1<<M)-1,C>>>=M,S-=M),S<15&&(C+=g[r++]<<S,S+=8,C+=g[r++]<<S,S+=8),D=_[C&L];n:for(;;){if(C>>>=M=D>>>24,S-=M,!(16&(M=D>>>16&255))){if(!(64&M)){D=_[(65535&D)+(C&(1<<M)-1)];continue n}n.msg="invalid distance code",s.mode=30;break e}if(Q=65535&D,S<(M&=15)&&(C+=g[r++]<<S,(S+=8)<M&&(C+=g[r++]<<S,S+=8)),m<(Q+=C&(1<<M)-1)){n.msg="invalid distance too far back",s.mode=30;break e}if(C>>>=M,S-=M,(M=f-p)<Q){if(u<(M=Q-M)&&s.sane){n.msg="invalid distance too far back",s.mode=30;break e}if(z=b,(I=0)===v){if(I+=y-M,M<U){for(U-=M;W[f++]=b[I++],--M;);I=f-Q,z=W}}else if(v<M){if(I+=y+v-M,(M-=v)<U){for(U-=M;W[f++]=b[I++],--M;);if(I=0,v<U){for(U-=M=v;W[f++]=b[I++],--M;);I=f-Q,z=W}}}else if(I+=v-M,M<U){for(U-=M;W[f++]=b[I++],--M;);I=f-Q,z=W}for(;2<U;)W[f++]=z[I++],W[f++]=z[I++],W[f++]=z[I++],U-=3;U&&(W[f++]=z[I++],1<U&&(W[f++]=z[I++]))}else{for(I=f-Q;W[f++]=W[I++],W[f++]=W[I++],W[f++]=W[I++],2<(U-=3););U&&(W[f++]=W[I++],1<U&&(W[f++]=W[I++]))}break}}break}}while(r<l&&f<h);r-=U=S>>3,C&=(1<<(S-=U<<3))-1,n.next_in=r,n.next_out=f,n.avail_in=r<l?l-r+5:5-(r-l),n.avail_out=f<h?h-f+257:257-(f-h),s.hold=C,s.bits=S}},{}],49:[function(t,c,o){var n=t("../utils/common"),i=t("./adler32"),s=t("./crc32"),r=t("./inffast"),l=t("./inftrees"),f=1,p=2,h=0,m=-2,y=1,u=852,v=592;function b(I){return(I>>>24&255)+(I>>>8&65280)+((65280&I)<<8)+((255&I)<<24)}function C(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new n.Buf16(320),this.work=new n.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function S(I){var z;return I&&I.state?(z=I.state,I.total_in=I.total_out=z.total=0,I.msg="",z.wrap&&(I.adler=1&z.wrap),z.mode=y,z.last=0,z.havedict=0,z.dmax=32768,z.head=null,z.hold=0,z.bits=0,z.lencode=z.lendyn=new n.Buf32(u),z.distcode=z.distdyn=new n.Buf32(v),z.sane=1,z.back=-1,h):m}function k(I){var z;return I&&I.state?((z=I.state).wsize=0,z.whave=0,z.wnext=0,S(I)):m}function _(I,z){var g,W;return I&&I.state?(W=I.state,z<0?(g=0,z=-z):(g=1+(z>>4),z<48&&(z&=15)),z&&(z<8||15<z)?m:(W.window!==null&&W.wbits!==z&&(W.window=null),W.wrap=g,W.wbits=z,k(I))):m}function x(I,z){var g,W;return I?(W=new C,(I.state=W).window=null,(g=_(I,z))!==h&&(I.state=null),g):m}var L,D,M=!0;function U(I){if(M){var z;for(L=new n.Buf32(512),D=new n.Buf32(32),z=0;z<144;)I.lens[z++]=8;for(;z<256;)I.lens[z++]=9;for(;z<280;)I.lens[z++]=7;for(;z<288;)I.lens[z++]=8;for(l(f,I.lens,0,288,L,0,I.work,{bits:9}),z=0;z<32;)I.lens[z++]=5;l(p,I.lens,0,32,D,0,I.work,{bits:5}),M=!1}I.lencode=L,I.lenbits=9,I.distcode=D,I.distbits=5}function Q(I,z,g,W){var ue,q=I.state;return q.window===null&&(q.wsize=1<<q.wbits,q.wnext=0,q.whave=0,q.window=new n.Buf8(q.wsize)),W>=q.wsize?(n.arraySet(q.window,z,g-q.wsize,q.wsize,0),q.wnext=0,q.whave=q.wsize):(W<(ue=q.wsize-q.wnext)&&(ue=W),n.arraySet(q.window,z,g-W,ue,q.wnext),(W-=ue)?(n.arraySet(q.window,z,g-W,W,0),q.wnext=W,q.whave=q.wsize):(q.wnext+=ue,q.wnext===q.wsize&&(q.wnext=0),q.whave<q.wsize&&(q.whave+=ue))),0}o.inflateReset=k,o.inflateReset2=_,o.inflateResetKeep=S,o.inflateInit=function(I){return x(I,15)},o.inflateInit2=x,o.inflate=function(I,z){var g,W,ue,q,me,V,fe,R,O,de,se,ee,Be,He,he,Se,Me,Ne,st,at,d,H,$,E,w=0,T=new n.Buf8(4),j=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!I||!I.state||!I.output||!I.input&&I.avail_in!==0)return m;(g=I.state).mode===12&&(g.mode=13),me=I.next_out,ue=I.output,fe=I.avail_out,q=I.next_in,W=I.input,V=I.avail_in,R=g.hold,O=g.bits,de=V,se=fe,H=h;e:for(;;)switch(g.mode){case y:if(g.wrap===0){g.mode=13;break}for(;O<16;){if(V===0)break e;V--,R+=W[q++]<<O,O+=8}if(2&g.wrap&&R===35615){T[g.check=0]=255&R,T[1]=R>>>8&255,g.check=s(g.check,T,2,0),O=R=0,g.mode=2;break}if(g.flags=0,g.head&&(g.head.done=!1),!(1&g.wrap)||(((255&R)<<8)+(R>>8))%31){I.msg="incorrect header check",g.mode=30;break}if((15&R)!=8){I.msg="unknown compression method",g.mode=30;break}if(O-=4,d=8+(15&(R>>>=4)),g.wbits===0)g.wbits=d;else if(d>g.wbits){I.msg="invalid window size",g.mode=30;break}g.dmax=1<<d,I.adler=g.check=1,g.mode=512&R?10:12,O=R=0;break;case 2:for(;O<16;){if(V===0)break e;V--,R+=W[q++]<<O,O+=8}if(g.flags=R,(255&g.flags)!=8){I.msg="unknown compression method",g.mode=30;break}if(57344&g.flags){I.msg="unknown header flags set",g.mode=30;break}g.head&&(g.head.text=R>>8&1),512&g.flags&&(T[0]=255&R,T[1]=R>>>8&255,g.check=s(g.check,T,2,0)),O=R=0,g.mode=3;case 3:for(;O<32;){if(V===0)break e;V--,R+=W[q++]<<O,O+=8}g.head&&(g.head.time=R),512&g.flags&&(T[0]=255&R,T[1]=R>>>8&255,T[2]=R>>>16&255,T[3]=R>>>24&255,g.check=s(g.check,T,4,0)),O=R=0,g.mode=4;case 4:for(;O<16;){if(V===0)break e;V--,R+=W[q++]<<O,O+=8}g.head&&(g.head.xflags=255&R,g.head.os=R>>8),512&g.flags&&(T[0]=255&R,T[1]=R>>>8&255,g.check=s(g.check,T,2,0)),O=R=0,g.mode=5;case 5:if(1024&g.flags){for(;O<16;){if(V===0)break e;V--,R+=W[q++]<<O,O+=8}g.length=R,g.head&&(g.head.extra_len=R),512&g.flags&&(T[0]=255&R,T[1]=R>>>8&255,g.check=s(g.check,T,2,0)),O=R=0}else g.head&&(g.head.extra=null);g.mode=6;case 6:if(1024&g.flags&&(V<(ee=g.length)&&(ee=V),ee&&(g.head&&(d=g.head.extra_len-g.length,g.head.extra||(g.head.extra=new Array(g.head.extra_len)),n.arraySet(g.head.extra,W,q,ee,d)),512&g.flags&&(g.check=s(g.check,W,ee,q)),V-=ee,q+=ee,g.length-=ee),g.length))break e;g.length=0,g.mode=7;case 7:if(2048&g.flags){if(V===0)break e;for(ee=0;d=W[q+ee++],g.head&&d&&g.length<65536&&(g.head.name+=String.fromCharCode(d)),d&&ee<V;);if(512&g.flags&&(g.check=s(g.check,W,ee,q)),V-=ee,q+=ee,d)break e}else g.head&&(g.head.name=null);g.length=0,g.mode=8;case 8:if(4096&g.flags){if(V===0)break e;for(ee=0;d=W[q+ee++],g.head&&d&&g.length<65536&&(g.head.comment+=String.fromCharCode(d)),d&&ee<V;);if(512&g.flags&&(g.check=s(g.check,W,ee,q)),V-=ee,q+=ee,d)break e}else g.head&&(g.head.comment=null);g.mode=9;case 9:if(512&g.flags){for(;O<16;){if(V===0)break e;V--,R+=W[q++]<<O,O+=8}if(R!==(65535&g.check)){I.msg="header crc mismatch",g.mode=30;break}O=R=0}g.head&&(g.head.hcrc=g.flags>>9&1,g.head.done=!0),I.adler=g.check=0,g.mode=12;break;case 10:for(;O<32;){if(V===0)break e;V--,R+=W[q++]<<O,O+=8}I.adler=g.check=b(R),O=R=0,g.mode=11;case 11:if(g.havedict===0)return I.next_out=me,I.avail_out=fe,I.next_in=q,I.avail_in=V,g.hold=R,g.bits=O,2;I.adler=g.check=1,g.mode=12;case 12:if(z===5||z===6)break e;case 13:if(g.last){R>>>=7&O,O-=7&O,g.mode=27;break}for(;O<3;){if(V===0)break e;V--,R+=W[q++]<<O,O+=8}switch(g.last=1&R,O-=1,3&(R>>>=1)){case 0:g.mode=14;break;case 1:if(U(g),g.mode=20,z!==6)break;R>>>=2,O-=2;break e;case 2:g.mode=17;break;case 3:I.msg="invalid block type",g.mode=30}R>>>=2,O-=2;break;case 14:for(R>>>=7&O,O-=7&O;O<32;){if(V===0)break e;V--,R+=W[q++]<<O,O+=8}if((65535&R)!=(R>>>16^65535)){I.msg="invalid stored block lengths",g.mode=30;break}if(g.length=65535&R,O=R=0,g.mode=15,z===6)break e;case 15:g.mode=16;case 16:if(ee=g.length){if(V<ee&&(ee=V),fe<ee&&(ee=fe),ee===0)break e;n.arraySet(ue,W,q,ee,me),V-=ee,q+=ee,fe-=ee,me+=ee,g.length-=ee;break}g.mode=12;break;case 17:for(;O<14;){if(V===0)break e;V--,R+=W[q++]<<O,O+=8}if(g.nlen=257+(31&R),R>>>=5,O-=5,g.ndist=1+(31&R),R>>>=5,O-=5,g.ncode=4+(15&R),R>>>=4,O-=4,286<g.nlen||30<g.ndist){I.msg="too many length or distance symbols",g.mode=30;break}g.have=0,g.mode=18;case 18:for(;g.have<g.ncode;){for(;O<3;){if(V===0)break e;V--,R+=W[q++]<<O,O+=8}g.lens[j[g.have++]]=7&R,R>>>=3,O-=3}for(;g.have<19;)g.lens[j[g.have++]]=0;if(g.lencode=g.lendyn,g.lenbits=7,$={bits:g.lenbits},H=l(0,g.lens,0,19,g.lencode,0,g.work,$),g.lenbits=$.bits,H){I.msg="invalid code lengths set",g.mode=30;break}g.have=0,g.mode=19;case 19:for(;g.have<g.nlen+g.ndist;){for(;Se=(w=g.lencode[R&(1<<g.lenbits)-1])>>>16&255,Me=65535&w,!((he=w>>>24)<=O);){if(V===0)break e;V--,R+=W[q++]<<O,O+=8}if(Me<16)R>>>=he,O-=he,g.lens[g.have++]=Me;else{if(Me===16){for(E=he+2;O<E;){if(V===0)break e;V--,R+=W[q++]<<O,O+=8}if(R>>>=he,O-=he,g.have===0){I.msg="invalid bit length repeat",g.mode=30;break}d=g.lens[g.have-1],ee=3+(3&R),R>>>=2,O-=2}else if(Me===17){for(E=he+3;O<E;){if(V===0)break e;V--,R+=W[q++]<<O,O+=8}O-=he,d=0,ee=3+(7&(R>>>=he)),R>>>=3,O-=3}else{for(E=he+7;O<E;){if(V===0)break e;V--,R+=W[q++]<<O,O+=8}O-=he,d=0,ee=11+(127&(R>>>=he)),R>>>=7,O-=7}if(g.have+ee>g.nlen+g.ndist){I.msg="invalid bit length repeat",g.mode=30;break}for(;ee--;)g.lens[g.have++]=d}}if(g.mode===30)break;if(g.lens[256]===0){I.msg="invalid code -- missing end-of-block",g.mode=30;break}if(g.lenbits=9,$={bits:g.lenbits},H=l(f,g.lens,0,g.nlen,g.lencode,0,g.work,$),g.lenbits=$.bits,H){I.msg="invalid literal/lengths set",g.mode=30;break}if(g.distbits=6,g.distcode=g.distdyn,$={bits:g.distbits},H=l(p,g.lens,g.nlen,g.ndist,g.distcode,0,g.work,$),g.distbits=$.bits,H){I.msg="invalid distances set",g.mode=30;break}if(g.mode=20,z===6)break e;case 20:g.mode=21;case 21:if(6<=V&&258<=fe){I.next_out=me,I.avail_out=fe,I.next_in=q,I.avail_in=V,g.hold=R,g.bits=O,r(I,se),me=I.next_out,ue=I.output,fe=I.avail_out,q=I.next_in,W=I.input,V=I.avail_in,R=g.hold,O=g.bits,g.mode===12&&(g.back=-1);break}for(g.back=0;Se=(w=g.lencode[R&(1<<g.lenbits)-1])>>>16&255,Me=65535&w,!((he=w>>>24)<=O);){if(V===0)break e;V--,R+=W[q++]<<O,O+=8}if(Se&&!(240&Se)){for(Ne=he,st=Se,at=Me;Se=(w=g.lencode[at+((R&(1<<Ne+st)-1)>>Ne)])>>>16&255,Me=65535&w,!(Ne+(he=w>>>24)<=O);){if(V===0)break e;V--,R+=W[q++]<<O,O+=8}R>>>=Ne,O-=Ne,g.back+=Ne}if(R>>>=he,O-=he,g.back+=he,g.length=Me,Se===0){g.mode=26;break}if(32&Se){g.back=-1,g.mode=12;break}if(64&Se){I.msg="invalid literal/length code",g.mode=30;break}g.extra=15&Se,g.mode=22;case 22:if(g.extra){for(E=g.extra;O<E;){if(V===0)break e;V--,R+=W[q++]<<O,O+=8}g.length+=R&(1<<g.extra)-1,R>>>=g.extra,O-=g.extra,g.back+=g.extra}g.was=g.length,g.mode=23;case 23:for(;Se=(w=g.distcode[R&(1<<g.distbits)-1])>>>16&255,Me=65535&w,!((he=w>>>24)<=O);){if(V===0)break e;V--,R+=W[q++]<<O,O+=8}if(!(240&Se)){for(Ne=he,st=Se,at=Me;Se=(w=g.distcode[at+((R&(1<<Ne+st)-1)>>Ne)])>>>16&255,Me=65535&w,!(Ne+(he=w>>>24)<=O);){if(V===0)break e;V--,R+=W[q++]<<O,O+=8}R>>>=Ne,O-=Ne,g.back+=Ne}if(R>>>=he,O-=he,g.back+=he,64&Se){I.msg="invalid distance code",g.mode=30;break}g.offset=Me,g.extra=15&Se,g.mode=24;case 24:if(g.extra){for(E=g.extra;O<E;){if(V===0)break e;V--,R+=W[q++]<<O,O+=8}g.offset+=R&(1<<g.extra)-1,R>>>=g.extra,O-=g.extra,g.back+=g.extra}if(g.offset>g.dmax){I.msg="invalid distance too far back",g.mode=30;break}g.mode=25;case 25:if(fe===0)break e;if(ee=se-fe,g.offset>ee){if((ee=g.offset-ee)>g.whave&&g.sane){I.msg="invalid distance too far back",g.mode=30;break}Be=ee>g.wnext?(ee-=g.wnext,g.wsize-ee):g.wnext-ee,ee>g.length&&(ee=g.length),He=g.window}else He=ue,Be=me-g.offset,ee=g.length;for(fe<ee&&(ee=fe),fe-=ee,g.length-=ee;ue[me++]=He[Be++],--ee;);g.length===0&&(g.mode=21);break;case 26:if(fe===0)break e;ue[me++]=g.length,fe--,g.mode=21;break;case 27:if(g.wrap){for(;O<32;){if(V===0)break e;V--,R|=W[q++]<<O,O+=8}if(se-=fe,I.total_out+=se,g.total+=se,se&&(I.adler=g.check=g.flags?s(g.check,ue,se,me-se):i(g.check,ue,se,me-se)),se=fe,(g.flags?R:b(R))!==g.check){I.msg="incorrect data check",g.mode=30;break}O=R=0}g.mode=28;case 28:if(g.wrap&&g.flags){for(;O<32;){if(V===0)break e;V--,R+=W[q++]<<O,O+=8}if(R!==(4294967295&g.total)){I.msg="incorrect length check",g.mode=30;break}O=R=0}g.mode=29;case 29:H=1;break e;case 30:H=-3;break e;case 31:return-4;case 32:default:return m}return I.next_out=me,I.avail_out=fe,I.next_in=q,I.avail_in=V,g.hold=R,g.bits=O,(g.wsize||se!==I.avail_out&&g.mode<30&&(g.mode<27||z!==4))&&Q(I,I.output,I.next_out,se-I.avail_out)?(g.mode=31,-4):(de-=I.avail_in,se-=I.avail_out,I.total_in+=de,I.total_out+=se,g.total+=se,g.wrap&&se&&(I.adler=g.check=g.flags?s(g.check,ue,se,I.next_out-se):i(g.check,ue,se,I.next_out-se)),I.data_type=g.bits+(g.last?64:0)+(g.mode===12?128:0)+(g.mode===20||g.mode===15?256:0),(de==0&&se===0||z===4)&&H===h&&(H=-5),H)},o.inflateEnd=function(I){if(!I||!I.state)return m;var z=I.state;return z.window&&(z.window=null),I.state=null,h},o.inflateGetHeader=function(I,z){var g;return I&&I.state&&2&(g=I.state).wrap?((g.head=z).done=!1,h):m},o.inflateSetDictionary=function(I,z){var g,W=z.length;return I&&I.state?(g=I.state).wrap!==0&&g.mode!==11?m:g.mode===11&&i(1,z,W,0)!==g.check?-3:Q(I,z,W,W)?(g.mode=31,-4):(g.havedict=1,h):m},o.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(t,c,o){var n=t("../utils/common"),i=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],s=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],r=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],l=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];c.exports=function(f,p,h,m,y,u,v,b){var C,S,k,_,x,L,D,M,U,Q=b.bits,I=0,z=0,g=0,W=0,ue=0,q=0,me=0,V=0,fe=0,R=0,O=null,de=0,se=new n.Buf16(16),ee=new n.Buf16(16),Be=null,He=0;for(I=0;I<=15;I++)se[I]=0;for(z=0;z<m;z++)se[p[h+z]]++;for(ue=Q,W=15;1<=W&&se[W]===0;W--);if(W<ue&&(ue=W),W===0)return y[u++]=20971520,y[u++]=20971520,b.bits=1,0;for(g=1;g<W&&se[g]===0;g++);for(ue<g&&(ue=g),I=V=1;I<=15;I++)if(V<<=1,(V-=se[I])<0)return-1;if(0<V&&(f===0||W!==1))return-1;for(ee[1]=0,I=1;I<15;I++)ee[I+1]=ee[I]+se[I];for(z=0;z<m;z++)p[h+z]!==0&&(v[ee[p[h+z]]++]=z);if(L=f===0?(O=Be=v,19):f===1?(O=i,de-=257,Be=s,He-=257,256):(O=r,Be=l,-1),I=g,x=u,me=z=R=0,k=-1,_=(fe=1<<(q=ue))-1,f===1&&852<fe||f===2&&592<fe)return 1;for(;;){for(D=I-me,U=v[z]<L?(M=0,v[z]):v[z]>L?(M=Be[He+v[z]],O[de+v[z]]):(M=96,0),C=1<<I-me,g=S=1<<q;y[x+(R>>me)+(S-=C)]=D<<24|M<<16|U|0,S!==0;);for(C=1<<I-1;R&C;)C>>=1;if(C!==0?(R&=C-1,R+=C):R=0,z++,--se[I]==0){if(I===W)break;I=p[h+v[z]]}if(ue<I&&(R&_)!==k){for(me===0&&(me=ue),x+=g,V=1<<(q=I-me);q+me<W&&!((V-=se[q+me])<=0);)q++,V<<=1;if(fe+=1<<q,f===1&&852<fe||f===2&&592<fe)return 1;y[k=R&_]=ue<<24|q<<16|x-u|0}}return R!==0&&(y[x+R]=I-me<<24|64<<16|0),b.bits=ue,0}},{"../utils/common":41}],51:[function(t,c,o){c.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(t,c,o){var n=t("../utils/common"),i=0,s=1;function r(w){for(var T=w.length;0<=--T;)w[T]=0}var l=0,f=29,p=256,h=p+1+f,m=30,y=19,u=2*h+1,v=15,b=16,C=7,S=256,k=16,_=17,x=18,L=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],D=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],M=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],U=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Q=new Array(2*(h+2));r(Q);var I=new Array(2*m);r(I);var z=new Array(512);r(z);var g=new Array(256);r(g);var W=new Array(f);r(W);var ue,q,me,V=new Array(m);function fe(w,T,j,Z,N){this.static_tree=w,this.extra_bits=T,this.extra_base=j,this.elems=Z,this.max_length=N,this.has_stree=w&&w.length}function R(w,T){this.dyn_tree=w,this.max_code=0,this.stat_desc=T}function O(w){return w<256?z[w]:z[256+(w>>>7)]}function de(w,T){w.pending_buf[w.pending++]=255&T,w.pending_buf[w.pending++]=T>>>8&255}function se(w,T,j){w.bi_valid>b-j?(w.bi_buf|=T<<w.bi_valid&65535,de(w,w.bi_buf),w.bi_buf=T>>b-w.bi_valid,w.bi_valid+=j-b):(w.bi_buf|=T<<w.bi_valid&65535,w.bi_valid+=j)}function ee(w,T,j){se(w,j[2*T],j[2*T+1])}function Be(w,T){for(var j=0;j|=1&w,w>>>=1,j<<=1,0<--T;);return j>>>1}function He(w,T,j){var Z,N,K=new Array(v+1),ne=0;for(Z=1;Z<=v;Z++)K[Z]=ne=ne+j[Z-1]<<1;for(N=0;N<=T;N++){var X=w[2*N+1];X!==0&&(w[2*N]=Be(K[X]++,X))}}function he(w){var T;for(T=0;T<h;T++)w.dyn_ltree[2*T]=0;for(T=0;T<m;T++)w.dyn_dtree[2*T]=0;for(T=0;T<y;T++)w.bl_tree[2*T]=0;w.dyn_ltree[2*S]=1,w.opt_len=w.static_len=0,w.last_lit=w.matches=0}function Se(w){8<w.bi_valid?de(w,w.bi_buf):0<w.bi_valid&&(w.pending_buf[w.pending++]=w.bi_buf),w.bi_buf=0,w.bi_valid=0}function Me(w,T,j,Z){var N=2*T,K=2*j;return w[N]<w[K]||w[N]===w[K]&&Z[T]<=Z[j]}function Ne(w,T,j){for(var Z=w.heap[j],N=j<<1;N<=w.heap_len&&(N<w.heap_len&&Me(T,w.heap[N+1],w.heap[N],w.depth)&&N++,!Me(T,Z,w.heap[N],w.depth));)w.heap[j]=w.heap[N],j=N,N<<=1;w.heap[j]=Z}function st(w,T,j){var Z,N,K,ne,X=0;if(w.last_lit!==0)for(;Z=w.pending_buf[w.d_buf+2*X]<<8|w.pending_buf[w.d_buf+2*X+1],N=w.pending_buf[w.l_buf+X],X++,Z===0?ee(w,N,T):(ee(w,(K=g[N])+p+1,T),(ne=L[K])!==0&&se(w,N-=W[K],ne),ee(w,K=O(--Z),j),(ne=D[K])!==0&&se(w,Z-=V[K],ne)),X<w.last_lit;);ee(w,S,T)}function at(w,T){var j,Z,N,K=T.dyn_tree,ne=T.stat_desc.static_tree,X=T.stat_desc.has_stree,le=T.stat_desc.elems,xe=-1;for(w.heap_len=0,w.heap_max=u,j=0;j<le;j++)K[2*j]!==0?(w.heap[++w.heap_len]=xe=j,w.depth[j]=0):K[2*j+1]=0;for(;w.heap_len<2;)K[2*(N=w.heap[++w.heap_len]=xe<2?++xe:0)]=1,w.depth[N]=0,w.opt_len--,X&&(w.static_len-=ne[2*N+1]);for(T.max_code=xe,j=w.heap_len>>1;1<=j;j--)Ne(w,K,j);for(N=le;j=w.heap[1],w.heap[1]=w.heap[w.heap_len--],Ne(w,K,1),Z=w.heap[1],w.heap[--w.heap_max]=j,w.heap[--w.heap_max]=Z,K[2*N]=K[2*j]+K[2*Z],w.depth[N]=(w.depth[j]>=w.depth[Z]?w.depth[j]:w.depth[Z])+1,K[2*j+1]=K[2*Z+1]=N,w.heap[1]=N++,Ne(w,K,1),2<=w.heap_len;);w.heap[--w.heap_max]=w.heap[1],function(ve,Ve){var bt,Ye,$t,De,ze,zt,ut=Ve.dyn_tree,en=Ve.max_code,kn=Ve.stat_desc.static_tree,gs=Ve.stat_desc.has_stree,ys=Ve.stat_desc.extra_bits,_n=Ve.stat_desc.extra_base,It=Ve.stat_desc.max_length,Pt=0;for(De=0;De<=v;De++)ve.bl_count[De]=0;for(ut[2*ve.heap[ve.heap_max]+1]=0,bt=ve.heap_max+1;bt<u;bt++)It<(De=ut[2*ut[2*(Ye=ve.heap[bt])+1]+1]+1)&&(De=It,Pt++),ut[2*Ye+1]=De,en<Ye||(ve.bl_count[De]++,ze=0,_n<=Ye&&(ze=ys[Ye-_n]),zt=ut[2*Ye],ve.opt_len+=zt*(De+ze),gs&&(ve.static_len+=zt*(kn[2*Ye+1]+ze)));if(Pt!==0){do{for(De=It-1;ve.bl_count[De]===0;)De--;ve.bl_count[De]--,ve.bl_count[De+1]+=2,ve.bl_count[It]--,Pt-=2}while(0<Pt);for(De=It;De!==0;De--)for(Ye=ve.bl_count[De];Ye!==0;)en<($t=ve.heap[--bt])||(ut[2*$t+1]!==De&&(ve.opt_len+=(De-ut[2*$t+1])*ut[2*$t],ut[2*$t+1]=De),Ye--)}}(w,T),He(K,xe,w.bl_count)}function d(w,T,j){var Z,N,K=-1,ne=T[1],X=0,le=7,xe=4;for(ne===0&&(le=138,xe=3),T[2*(j+1)+1]=65535,Z=0;Z<=j;Z++)N=ne,ne=T[2*(Z+1)+1],++X<le&&N===ne||(X<xe?w.bl_tree[2*N]+=X:N!==0?(N!==K&&w.bl_tree[2*N]++,w.bl_tree[2*k]++):X<=10?w.bl_tree[2*_]++:w.bl_tree[2*x]++,K=N,xe=(X=0)===ne?(le=138,3):N===ne?(le=6,3):(le=7,4))}function H(w,T,j){var Z,N,K=-1,ne=T[1],X=0,le=7,xe=4;for(ne===0&&(le=138,xe=3),Z=0;Z<=j;Z++)if(N=ne,ne=T[2*(Z+1)+1],!(++X<le&&N===ne)){if(X<xe)for(;ee(w,N,w.bl_tree),--X!=0;);else N!==0?(N!==K&&(ee(w,N,w.bl_tree),X--),ee(w,k,w.bl_tree),se(w,X-3,2)):X<=10?(ee(w,_,w.bl_tree),se(w,X-3,3)):(ee(w,x,w.bl_tree),se(w,X-11,7));K=N,xe=(X=0)===ne?(le=138,3):N===ne?(le=6,3):(le=7,4)}}r(V);var $=!1;function E(w,T,j,Z){se(w,(l<<1)+(Z?1:0),3),function(N,K,ne,X){Se(N),de(N,ne),de(N,~ne),n.arraySet(N.pending_buf,N.window,K,ne,N.pending),N.pending+=ne}(w,T,j)}o._tr_init=function(w){$||(function(){var T,j,Z,N,K,ne=new Array(v+1);for(N=Z=0;N<f-1;N++)for(W[N]=Z,T=0;T<1<<L[N];T++)g[Z++]=N;for(g[Z-1]=N,N=K=0;N<16;N++)for(V[N]=K,T=0;T<1<<D[N];T++)z[K++]=N;for(K>>=7;N<m;N++)for(V[N]=K<<7,T=0;T<1<<D[N]-7;T++)z[256+K++]=N;for(j=0;j<=v;j++)ne[j]=0;for(T=0;T<=143;)Q[2*T+1]=8,T++,ne[8]++;for(;T<=255;)Q[2*T+1]=9,T++,ne[9]++;for(;T<=279;)Q[2*T+1]=7,T++,ne[7]++;for(;T<=287;)Q[2*T+1]=8,T++,ne[8]++;for(He(Q,h+1,ne),T=0;T<m;T++)I[2*T+1]=5,I[2*T]=Be(T,5);ue=new fe(Q,L,p+1,h,v),q=new fe(I,D,0,m,v),me=new fe(new Array(0),M,0,y,C)}(),$=!0),w.l_desc=new R(w.dyn_ltree,ue),w.d_desc=new R(w.dyn_dtree,q),w.bl_desc=new R(w.bl_tree,me),w.bi_buf=0,w.bi_valid=0,he(w)},o._tr_stored_block=E,o._tr_flush_block=function(w,T,j,Z){var N,K,ne=0;0<w.level?(w.strm.data_type===2&&(w.strm.data_type=function(X){var le,xe=4093624447;for(le=0;le<=31;le++,xe>>>=1)if(1&xe&&X.dyn_ltree[2*le]!==0)return i;if(X.dyn_ltree[18]!==0||X.dyn_ltree[20]!==0||X.dyn_ltree[26]!==0)return s;for(le=32;le<p;le++)if(X.dyn_ltree[2*le]!==0)return s;return i}(w)),at(w,w.l_desc),at(w,w.d_desc),ne=function(X){var le;for(d(X,X.dyn_ltree,X.l_desc.max_code),d(X,X.dyn_dtree,X.d_desc.max_code),at(X,X.bl_desc),le=y-1;3<=le&&X.bl_tree[2*U[le]+1]===0;le--);return X.opt_len+=3*(le+1)+5+5+4,le}(w),N=w.opt_len+3+7>>>3,(K=w.static_len+3+7>>>3)<=N&&(N=K)):N=K=j+5,j+4<=N&&T!==-1?E(w,T,j,Z):w.strategy===4||K===N?(se(w,2+(Z?1:0),3),st(w,Q,I)):(se(w,4+(Z?1:0),3),function(X,le,xe,ve){var Ve;for(se(X,le-257,5),se(X,xe-1,5),se(X,ve-4,4),Ve=0;Ve<ve;Ve++)se(X,X.bl_tree[2*U[Ve]+1],3);H(X,X.dyn_ltree,le-1),H(X,X.dyn_dtree,xe-1)}(w,w.l_desc.max_code+1,w.d_desc.max_code+1,ne+1),st(w,w.dyn_ltree,w.dyn_dtree)),he(w),Z&&Se(w)},o._tr_tally=function(w,T,j){return w.pending_buf[w.d_buf+2*w.last_lit]=T>>>8&255,w.pending_buf[w.d_buf+2*w.last_lit+1]=255&T,w.pending_buf[w.l_buf+w.last_lit]=255&j,w.last_lit++,T===0?w.dyn_ltree[2*j]++:(w.matches++,T--,w.dyn_ltree[2*(g[j]+p+1)]++,w.dyn_dtree[2*O(T)]++),w.last_lit===w.lit_bufsize-1},o._tr_align=function(w){se(w,2,3),ee(w,S,Q),function(T){T.bi_valid===16?(de(T,T.bi_buf),T.bi_buf=0,T.bi_valid=0):8<=T.bi_valid&&(T.pending_buf[T.pending++]=255&T.bi_buf,T.bi_buf>>=8,T.bi_valid-=8)}(w)}},{"../utils/common":41}],53:[function(t,c,o){c.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(t,c,o){(function(n){(function(i,s){if(!i.setImmediate){var r,l,f,p,h=1,m={},y=!1,u=i.document,v=Object.getPrototypeOf&&Object.getPrototypeOf(i);v=v&&v.setTimeout?v:i,r={}.toString.call(i.process)==="[object process]"?function(k){process.nextTick(function(){C(k)})}:function(){if(i.postMessage&&!i.importScripts){var k=!0,_=i.onmessage;return i.onmessage=function(){k=!1},i.postMessage("","*"),i.onmessage=_,k}}()?(p="setImmediate$"+Math.random()+"$",i.addEventListener?i.addEventListener("message",S,!1):i.attachEvent("onmessage",S),function(k){i.postMessage(p+k,"*")}):i.MessageChannel?((f=new MessageChannel).port1.onmessage=function(k){C(k.data)},function(k){f.port2.postMessage(k)}):u&&"onreadystatechange"in u.createElement("script")?(l=u.documentElement,function(k){var _=u.createElement("script");_.onreadystatechange=function(){C(k),_.onreadystatechange=null,l.removeChild(_),_=null},l.appendChild(_)}):function(k){setTimeout(C,0,k)},v.setImmediate=function(k){typeof k!="function"&&(k=new Function(""+k));for(var _=new Array(arguments.length-1),x=0;x<_.length;x++)_[x]=arguments[x+1];var L={callback:k,args:_};return m[h]=L,r(h),h++},v.clearImmediate=b}function b(k){delete m[k]}function C(k){if(y)setTimeout(C,0,k);else{var _=m[k];if(_){y=!0;try{(function(x){var L=x.callback,D=x.args;switch(D.length){case 0:L();break;case 1:L(D[0]);break;case 2:L(D[0],D[1]);break;case 3:L(D[0],D[1],D[2]);break;default:L.apply(s,D)}})(_)}finally{b(k),y=!1}}}}function S(k){k.source===i&&typeof k.data=="string"&&k.data.indexOf(p)===0&&C(+k.data.slice(p.length))}})(typeof self>"u"?n===void 0?this:n:self)}).call(this,typeof Ln<"u"?Ln:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(Za);var fo=Za.exports;const Gs=qa(fo);var Ga={exports:{}};(function(e){var a=function(){var t=String.fromCharCode,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",n={};function i(r,l){if(!n[r]){n[r]={};for(var f=0;f<r.length;f++)n[r][r.charAt(f)]=f}return n[r][l]}var s={compressToBase64:function(r){if(r==null)return"";var l=s._compress(r,6,function(f){return c.charAt(f)});switch(l.length%4){default:case 0:return l;case 1:return l+"===";case 2:return l+"==";case 3:return l+"="}},decompressFromBase64:function(r){return r==null?"":r==""?null:s._decompress(r.length,32,function(l){return i(c,r.charAt(l))})},compressToUTF16:function(r){return r==null?"":s._compress(r,15,function(l){return t(l+32)})+" "},decompressFromUTF16:function(r){return r==null?"":r==""?null:s._decompress(r.length,16384,function(l){return r.charCodeAt(l)-32})},compressToUint8Array:function(r){for(var l=s.compress(r),f=new Uint8Array(l.length*2),p=0,h=l.length;p<h;p++){var m=l.charCodeAt(p);f[p*2]=m>>>8,f[p*2+1]=m%256}return f},decompressFromUint8Array:function(r){if(r==null)return s.decompress(r);for(var l=new Array(r.length/2),f=0,p=l.length;f<p;f++)l[f]=r[f*2]*256+r[f*2+1];var h=[];return l.forEach(function(m){h.push(t(m))}),s.decompress(h.join(""))},compressToEncodedURIComponent:function(r){return r==null?"":s._compress(r,6,function(l){return o.charAt(l)})},decompressFromEncodedURIComponent:function(r){return r==null?"":r==""?null:(r=r.replace(/ /g,"+"),s._decompress(r.length,32,function(l){return i(o,r.charAt(l))}))},compress:function(r){return s._compress(r,16,function(l){return t(l)})},_compress:function(r,l,f){if(r==null)return"";var p,h,m={},y={},u="",v="",b="",C=2,S=3,k=2,_=[],x=0,L=0,D;for(D=0;D<r.length;D+=1)if(u=r.charAt(D),Object.prototype.hasOwnProperty.call(m,u)||(m[u]=S++,y[u]=!0),v=b+u,Object.prototype.hasOwnProperty.call(m,v))b=v;else{if(Object.prototype.hasOwnProperty.call(y,b)){if(b.charCodeAt(0)<256){for(p=0;p<k;p++)x=x<<1,L==l-1?(L=0,_.push(f(x)),x=0):L++;for(h=b.charCodeAt(0),p=0;p<8;p++)x=x<<1|h&1,L==l-1?(L=0,_.push(f(x)),x=0):L++,h=h>>1}else{for(h=1,p=0;p<k;p++)x=x<<1|h,L==l-1?(L=0,_.push(f(x)),x=0):L++,h=0;for(h=b.charCodeAt(0),p=0;p<16;p++)x=x<<1|h&1,L==l-1?(L=0,_.push(f(x)),x=0):L++,h=h>>1}C--,C==0&&(C=Math.pow(2,k),k++),delete y[b]}else for(h=m[b],p=0;p<k;p++)x=x<<1|h&1,L==l-1?(L=0,_.push(f(x)),x=0):L++,h=h>>1;C--,C==0&&(C=Math.pow(2,k),k++),m[v]=S++,b=String(u)}if(b!==""){if(Object.prototype.hasOwnProperty.call(y,b)){if(b.charCodeAt(0)<256){for(p=0;p<k;p++)x=x<<1,L==l-1?(L=0,_.push(f(x)),x=0):L++;for(h=b.charCodeAt(0),p=0;p<8;p++)x=x<<1|h&1,L==l-1?(L=0,_.push(f(x)),x=0):L++,h=h>>1}else{for(h=1,p=0;p<k;p++)x=x<<1|h,L==l-1?(L=0,_.push(f(x)),x=0):L++,h=0;for(h=b.charCodeAt(0),p=0;p<16;p++)x=x<<1|h&1,L==l-1?(L=0,_.push(f(x)),x=0):L++,h=h>>1}C--,C==0&&(C=Math.pow(2,k),k++),delete y[b]}else for(h=m[b],p=0;p<k;p++)x=x<<1|h&1,L==l-1?(L=0,_.push(f(x)),x=0):L++,h=h>>1;C--,C==0&&(C=Math.pow(2,k),k++)}for(h=2,p=0;p<k;p++)x=x<<1|h&1,L==l-1?(L=0,_.push(f(x)),x=0):L++,h=h>>1;for(;;)if(x=x<<1,L==l-1){_.push(f(x));break}else L++;return _.join("")},decompress:function(r){return r==null?"":r==""?null:s._decompress(r.length,32768,function(l){return r.charCodeAt(l)})},_decompress:function(r,l,f){var p=[],h=4,m=4,y=3,u="",v=[],b,C,S,k,_,x,L,D={val:f(0),position:l,index:1};for(b=0;b<3;b+=1)p[b]=b;for(S=0,_=Math.pow(2,2),x=1;x!=_;)k=D.val&D.position,D.position>>=1,D.position==0&&(D.position=l,D.val=f(D.index++)),S|=(k>0?1:0)*x,x<<=1;switch(S){case 0:for(S=0,_=Math.pow(2,8),x=1;x!=_;)k=D.val&D.position,D.position>>=1,D.position==0&&(D.position=l,D.val=f(D.index++)),S|=(k>0?1:0)*x,x<<=1;L=t(S);break;case 1:for(S=0,_=Math.pow(2,16),x=1;x!=_;)k=D.val&D.position,D.position>>=1,D.position==0&&(D.position=l,D.val=f(D.index++)),S|=(k>0?1:0)*x,x<<=1;L=t(S);break;case 2:return""}for(p[3]=L,C=L,v.push(L);;){if(D.index>r)return"";for(S=0,_=Math.pow(2,y),x=1;x!=_;)k=D.val&D.position,D.position>>=1,D.position==0&&(D.position=l,D.val=f(D.index++)),S|=(k>0?1:0)*x,x<<=1;switch(L=S){case 0:for(S=0,_=Math.pow(2,8),x=1;x!=_;)k=D.val&D.position,D.position>>=1,D.position==0&&(D.position=l,D.val=f(D.index++)),S|=(k>0?1:0)*x,x<<=1;p[m++]=t(S),L=m-1,h--;break;case 1:for(S=0,_=Math.pow(2,16),x=1;x!=_;)k=D.val&D.position,D.position>>=1,D.position==0&&(D.position=l,D.val=f(D.index++)),S|=(k>0?1:0)*x,x<<=1;p[m++]=t(S),L=m-1,h--;break;case 2:return v.join("")}if(h==0&&(h=Math.pow(2,y),y++),p[L])u=p[L];else if(L===m)u=C+C.charAt(0);else return null;v.push(u),p[m++]=C+u.charAt(0),h--,C=u,h==0&&(h=Math.pow(2,y),y++)}}};return s}();e!=null?e.exports=a:typeof angular<"u"&&angular!=null&&angular.module("LZString",[]).factory("LZString",function(){return a})})(Ga);var mo=Ga.exports;const Va=qa(mo);function ho(e){return new Worker("/assets/compression.worker-B3kqe_bR.js",{name:e==null?void 0:e.name})}let ie={},A=null,Vs=null,Y=null,_e=null,mn=null,ls=null,Js=[],jn=null,Ks=null,Re=null,ot={},qn=0,Ys=0,Zn=0,Xs=0,Qs=null,ea=null,Gn=null,St=null,tt=-1,ta=null,Vn=null,Jn=null,Kn=null,Ja=null,Ka=null,mt=!1,Ze=[],it=[],Mt=[],Pe={isScreenSaverEnabled:!0,isSoundEnabled:!0,isVibrationEnabled:!0,lastRestoreTimestamp:null,lastBackupTimestamp:null},Ya=new Set,Tt=!1;function Xa(e){Tt=e}let Ft=null;const na=new ho;na.onmessage=e=>{const a=e.data;try{localStorage.setItem("teacherAssistantData_v2",a),console.log("Background save complete.")}catch(t){console.error("Background storage failed:",t)}};na.onerror=e=>{console.error("❌ Worker Communication Error:",e.message,e)};function oe(e=!1){if(mt)return;const t=JSON.stringify({classrooms:ie,trashBin:Ze,userSettings:Pe});if(e){Ft&&clearTimeout(Ft);try{const c=Va.compressToUTF16(t);localStorage.setItem("teacherAssistantData_v2",c),console.log("Immediate save complete.")}catch(c){console.error("Immediate save failed:",c)}return}Ft&&clearTimeout(Ft),Ft=setTimeout(()=>{na.postMessage(t),Ft=null},500)}function po(e){return new Promise((a,t)=>{const c=new FileReader;c.onerror=t,c.onload=()=>{a(c.result.split(",")[1])},c.readAsDataURL(e)})}async function Qa(e=[]){const a={};if(e.length>0)e.forEach(l=>{ie[l]&&(a[l]=ie[l])});else for(const l in ie)ie[l].isDeleted||(a[l]=ie[l]);const t={metadata:{version:"2.0-b64",createdAt:new Date().toISOString()},data:{classrooms:a,trashBin:Ze,userSettings:Pe}},c=JSON.stringify(t),o=new Date,n=new Intl.DateTimeFormat("fa-IR-u-nu-latn",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(o).reduce((l,f)=>(l[f.type]=f.value,l),{}),s=`${n.year.slice(-2)}-${n.month}-${n.day}_${n.hour}-${n.minute}`;let r;e.length===0?r=`SP_Full_${s}.txt`:e.length===1?r=`SP_${e[0].replace(/[<>:"/\\|?*]/g,"").replace(/\s+/g,"_")}_${s}.txt`:r=`SP_Selected-${e.length}_${s}.txt`;try{const l=new Gs;l.file("backup.json",c);const f=await l.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:9}}),p=await po(f);return new File([p],r,{type:"text/plain"})}catch(l){return console.error("Error creating base64 backup file:",l),null}}function Yn(){const e=localStorage.getItem("teacherAssistantData_v2");if(!e)return;let a;try{const t=Va.decompressFromUTF16(e);t?a=JSON.parse(t):a=JSON.parse(e)}catch{console.log("Migration: Parsing legacy uncompressed data..."),a=JSON.parse(e)}a.classrooms!==void 0&&a.trashBin!==void 0?(Rt(a.classrooms),Ze=a.trashBin||[],Pe={...Pe,...a.userSettings}):(Rt(a),go())}function go(){const e=[];Object.values(ie).forEach(a=>{a.isDeleted?e.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:a.info.creationDate,type:"classroom",description:`کلاس «${a.info.name}»`,restoreData:{name:a.info.name}}):a.students.forEach(t=>{t.isDeleted&&e.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:t.identity.studentId.split("_")[1],type:"student",description:`دانش‌آموز «${t.identity.name}»`,restoreData:{studentId:t.identity.studentId,classroomName:a.info.name}})})}),Ze.length===0&&e.length>0&&(Ze=e,console.log(`Migrated ${e.length} previously deleted item(s) to the new trash bin.`),oe())}function ei(e){const a=new Bn(e.identity);return a.isDeleted=e.isDeleted,a.statusCounters=e.statusCounters,a.logs=e.logs,a.logs.scores||(a.logs.scores={}),a.profile=e.profile,a.finalClassActivityScore=e.finalClassActivityScore,a.categoryCounts=e.categoryCounts||{},a.categoryIssues=e.categoryIssues||{},a.qualitativeStats=e.qualitativeStats||{},a.onboardingSession=e.onboardingSession||null,a}function Rt(e){ie={};for(const a in e){const t=e[a];let c;t.info?c=t.info:c={...t,name:a};const o=new Ls(c);o.isDeleted=t.isDeleted,o.note=t.note||"",o.students=(t.students||[]).map(ei),o.sessions=(t.sessions||[]).map(n=>{const i=new ja(n.sessionNumber);i.isDeleted=n.isDeleted,i.note=n.note||"",i.startTime=new Date(n.startTime),i.createdAt=n.createdAt?new Date(n.createdAt):new Date(n.startTime),i.endTime=n.endTime?new Date(n.endTime):null,i.isFinished=n.isFinished,i.isMakeup=n.isMakeup,i.isCancelled=n.isCancelled||!1,i.studentRecords=n.studentRecords;for(const r in i.studentRecords){const l=i.studentRecords[r];l.homework&&!(l.homework instanceof xs)&&(i.studentRecords[r].homework=new xs(l.homework.status,l.homework.comment))}i.lastWinnerByCategory=n.lastWinnerByCategory,i.lastUsedCategoryId=n.lastUsedCategoryId,i.lastSelectedWinnerId=n.lastSelectedWinnerId;const s=n.winnerHistory||[];return i.winnerHistory=s.filter(r=>r&&r.winner).map(r=>({winner:o.students.find(f=>f.identity.studentId===r.winner.identity.studentId),categoryName:r.categoryName,rating:r.rating||null})).filter(r=>r.winner),i}),o.categories=(t.categories||[]).map(n=>{const i=new yt(n.name,n.description,n.isGradedCategory,n.weight||1);return i.id=n.id,i.isDeleted=n.isDeleted,i}),o.futurePlans=t.futurePlans,ie[a]=o}}function ti(e,a){if(a)Rt(e.data.classrooms),da(e.data.trashBin||[]);else{const t=e.data.classrooms,c=e.data.trashBin||[],o=new Map;for(const i in ie){const s=ie[i];s.info&&s.info.scheduleCode&&o.set(s.info.scheduleCode,i)}for(const i in t){const s=t[i],r=s.info.scheduleCode;if(o.has(r)){const l=o.get(r);l!==s.info.name&&delete ie[l],ie[s.info.name]=s}else{let l=s.info.name;for(;ie[l];)l=`${l} (Imported)`;l!==s.info.name&&(s.info.name=l),ie[l]=s}}const n=new Set(Ze.map(i=>i.id));c.forEach(i=>{n.has(i.id)||Ze.push(i)}),Rt(ie)}e.data.userSettings&&wt(e.data.userSettings),wt({lastRestoreTimestamp:new Date().toISOString()}),oe()}function ni(e,a){if(ie[a])return{success:!1,message:"کلاسی با این نام از قبل وجود دارد."};const t=ie[e];return t?(t.info.name=a,ie[a]=t,delete ie[e],A===t&&qe(t),{success:!0}):{success:!1,message:"کلاس مورد نظر یافت نشد."}}function si(e,a,t){const c=t.trim();if(!c)return{success:!1,message:"نام دسته‌بندی نمی‌تواند خالی باشد."};if(e.categories.some(r=>r.id!==a.id&&!r.isDeleted&&r.name.toLowerCase()===c.toLowerCase()))return{success:!1,message:"دسته‌بندی دیگری با این نام وجود دارد."};const n=a.name,i=n.toLowerCase(),s=c.toLowerCase();return a.name=c,e.students.forEach(r=>{r.categoryCounts&&r.categoryCounts[n]!==void 0&&(r.categoryCounts[c]=r.categoryCounts[n],delete r.categoryCounts[n]),r.categoryIssues&&r.categoryIssues[n]!==void 0&&(r.categoryIssues[c]=r.categoryIssues[n],delete r.categoryIssues[n]),r.logs.scores&&r.logs.scores[i]&&(r.logs.scores[i].forEach(l=>l.skill=c),i!==s&&(r.logs.scores[s]=r.logs.scores[i],delete r.logs.scores[i]))}),e.sessions.forEach(r=>{r.lastWinnerByCategory&&r.lastWinnerByCategory[n]&&(r.lastWinnerByCategory[c]=r.lastWinnerByCategory[n],delete r.lastWinnerByCategory[n]),r.winnerHistory&&r.winnerHistory.forEach(l=>{l.categoryName===n&&(l.categoryName=c)})}),{success:!0}}function ai(e,a,t){if(we(t.students).some(l=>l.identity.name.toLowerCase()===e.identity.name.toLowerCase()))return{success:!1,message:`دانش‌آموزی با نام «${e.identity.name}» از قبل در کلاس «${t.info.name}» وجود دارد.`};const o=JSON.parse(JSON.stringify(e)),n=ei(o),i=new Map;a.sessions.forEach(l=>{const f=l.studentRecords[e.identity.studentId];f&&i.set(l.sessionNumber,JSON.parse(JSON.stringify(f)))}),t.addStudent(n);try{const l=we(t.sessions).filter(v=>!v.isCancelled).sort((v,b)=>b.sessionNumber-v.sessionNumber),f=l.length>0?l[0]:null;let p="؟",h={type:"system",description:"Student Move"};f&&(p=rt(t).get(f.sessionNumber)||f.sessionNumber,h={type:"fromSession",sessionNumber:f.sessionNumber});const m=new Date().toLocaleDateString("fa-IR"),y=a.info.name,u=`این دانش آموز در جلسه ${p} و در تاریخ ${m} از کلاس «${y}» به این کلاس انتقال پیدا کرد`;n.addNote(u,h)}catch(l){console.error("Failed to add automated move note:",l)}i.size>0&&t.sessions.forEach(l=>{const f=i.get(l.sessionNumber);f&&!l.isDeleted&&!l.isCancelled&&(l.studentRecords[n.identity.studentId]=f)});const s={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`(انتقال) دانش‌آموز «${e.identity.name}» از کلاس «${a.info.name}»`,restoreData:{studentId:e.identity.studentId,classId:a.info.scheduleCode}};lt(s);const r=a.students.find(l=>l.identity.studentId===e.identity.studentId);return r&&(r.isDeleted=!0),{success:!0}}function ii(){for(const e in ie){const a=ie[e];a.students.forEach(t=>{t.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0},t.categoryCounts={},t.categoryIssues={},a.sessions.forEach(c=>{const o=t.identity.studentId;c.studentRecords[o]&&(c.studentRecords[o].attendance="present")})})}oe()}function we(e){return Array.isArray(e)?e.filter(a=>!a.isDeleted):[]}function rt(e){const a=new Map;return e&&we(e.sessions).filter(c=>!c.isCancelled).sort((c,o)=>c.sessionNumber-o.sessionNumber).forEach((c,o)=>{a.set(c.sessionNumber,o+1)}),a}function vt(e){tt=e}function dt(e){ta=e}function ds(e,a){if(!e||!a)return;const t=e.identity.studentId,c=a.students.findIndex(o=>o.identity.studentId===t);c>-1&&a.students.splice(c,1),a.sessions.forEach(o=>{o.studentRecords[t]&&delete o.studentRecords[t];for(const n in o.lastWinnerByCategory)o.lastWinnerByCategory[n]===t&&delete o.lastWinnerByCategory[n];o.lastSelectedWinnerId===t&&(o.lastSelectedWinnerId=null),o.winnerHistory=o.winnerHistory.filter(n=>n.winner&&n.winner.identity.studentId!==t)})}function sa(e,a){const t=ie[e];if(!t)return;const c=t.sessions.findIndex(o=>o.sessionNumber===a);c>-1&&(t.students.forEach(o=>{o.profile.notes&&o.profile.notes.length>0&&(o.profile.notes=o.profile.notes.filter(n=>!n.source||n.source.type!=="fromAttendance"||n.source.sessionNumber!==a)),o.onboardingSession===a&&(o.onboardingSession=null)}),t.sessions.splice(c,1))}function aa(e,a){const t=ie[e];if(!t)return;const c=t.categories.findIndex(s=>s.id===a);if(c===-1)return;const n=t.categories[c].name,i=n.toLowerCase();t.students.forEach(s=>{s.categoryCounts&&delete s.categoryCounts[n],s.categoryIssues&&delete s.categoryIssues[n],s.logs.scores&&delete s.logs.scores[i]}),t.sessions.forEach(s=>{s.lastWinnerByCategory[n]&&delete s.lastWinnerByCategory[n],s.winnerHistory=s.winnerHistory.filter(r=>r.categoryName!==n)}),t.categories.splice(c,1)}function ia(e,a,t,c){const o=ie[e];if(!o)return;const n=o.students.find(r=>r.identity.studentId===a);if(!n||!n.logs.scores[t.toLowerCase()])return;const i=n.logs.scores[t.toLowerCase()],s=i.findIndex(r=>r.id===c);s>-1&&i.splice(s,1)}function oa(e,a,t){const c=ie[e];if(!c)return;const o=c.students.find(i=>i.identity.studentId===a);if(!o||!o.profile.notes)return;const n=o.profile.notes.findIndex(i=>i.id===t);n>-1&&o.profile.notes.splice(n,1)}function oi(){JSON.parse(JSON.stringify({classrooms:ie,trashBin:Ze})),mt=!0}function ri(){mt=!1,Yn()}function lt(e){for(Ze.unshift(e);Ze.length>50;){const a=Ze.pop();ci(a)}oe()}function ci(e){var a;if(!(!e||!e.restoreData))switch(console.log(`🗑️ Auto-cleaning overflow item: ${e.description}`),e.type){case"classroom":e.restoreData.name&&ie[e.restoreData.name]&&delete ie[e.restoreData.name];break;case"student":(a=e.restoreData.identity)!=null&&a.studentId&&ds(e.restoreData.identity.studentId);break;case"session":e.restoreData.id&&sa(e.restoreData.id);break;case"category":e.restoreData.id&&aa(e.restoreData.id);break;case"score":ia(e.restoreData);break;case"note":e.restoreData.id&&oa(e.restoreData.id);break}}function qe(e){A=e}function hn(e){Vs=e}function Ke(e){Y=e}function Qe(e){_e=e}function Xn(e){mn=e}function li(e){ls=e}function nn(e){Js=e}function Dn(e){jn=e}function di(e){Ks=e}function Qn(e){Re=e}function Nn(e){qn=e}function ui(e){Ys=e}function An(e){Zn=e}function fi(e){Xs=e}function ra(e){Qs=e}function ca(e){ea=e}function pn(e){Gn=e}function la(e){St=e}function Vt(e){Jn=e}function mi(e){Ja=e}function hi(e){Ka=e}function da(e){Ze=e}function gn(e){Vn=e}function yn(e){Mt=e}function wt(e){Pe={...Pe,...e},oe()}function On(e){it=e}function ua(){Pe.lastBackupTimestamp=new Date().toISOString(),oe()}function es(e){Kn=e}function yo(){Ya.clear()}function vo(e){ot=e}function bo(){ot={}}function fa(e,a){ot[e]||(ot[e]={toBeScored:[],scoredThisSession:[]}),ot[e].scoredThisSession.includes(a)||ot[e].scoredThisSession.push(a)}const $a=Object.freeze(Object.defineProperty({__proto__:null,get activeModal(){return St},addToTrashBin:lt,get assessmentPools(){return ot},assessmentSessionExclusions:Ya,get cancelCallback(){return ea},get classrooms(){return ie},get confirmCallback(){return Qs},get currentClassroom(){return A},get datePickerCallback(){return Kn},get easterEggClickCount(){return qn},get easterEggLastClickTime(){return Ys},enterDemoMode:oi,exitDemoMode:ri,getActiveItems:we,getSessionDisplayMap:rt,get importedFileContent(){return jn},get isAssessmentModeActive(){return Tt},get isDemoMode(){return mt},get liveSession(){return Vs},loadData:Yn,get manualSelection(){return Jn},markStudentAsScoredInSession:fa,moveStudent:ai,get namesToImport(){return Js},get notificationTimeout(){return Ks},permanentlyDeleteCategory:aa,permanentlyDeleteFromTrash:ci,permanentlyDeleteNote:oa,permanentlyDeleteScore:ia,permanentlyDeleteSession:sa,permanentlyDeleteStudent:ds,prepareBackupData:Qa,get previousState(){return mn},processRestore:ti,rehydrateData:Rt,renameCategory:si,renameClassroom:ni,resetAllStudentCounters:ii,resetAssessmentExclusions:yo,resetAssessmentPools:bo,get resetEasterEggClickCount(){return Zn},get resetEasterEggLastClickTime(){return Xs},get saveCategoryCallback(){return Vn},saveData:oe,get saveNoteCallback(){return ta},get secureConfirmCallback(){return Gn},get selectedCategory(){return Re},get selectedClassIds(){return it},get selectedSession(){return Y},get selectedStudentForProfile(){return _e},get selectedStudentsForMassComment(){return Mt},setActiveModal:la,setAssessmentPools:vo,setCancelCallback:ca,setConfirmCallback:ra,setCurrentClassroom:qe,setDatePickerCallback:es,setEasterEggClickCount:Nn,setEasterEggLastClickTime:ui,setImportedFileContent:Dn,setIsAssessmentModeActive:Xa,setLastBackupTimestamp:ua,setLiveSession:hn,setManualSelection:Vt,setNamesToImport:nn,setNotificationTimeout:di,setPreviousState:Xn,setResetEasterEggClickCount:An,setResetEasterEggLastClickTime:fi,setSaveCategoryCallback:gn,setSaveNoteCallback:dt,setSecureConfirmCallback:pn,setSelectedCategory:Qn,setSelectedClassIds:On,setSelectedSession:Ke,setSelectedStudentForProfile:Qe,setSelectedStudentsForMassComment:yn,setSourceClassForMove:hi,setStudentToMove:mi,setTrashBin:da,setUndoTimeout:li,setUserSettings:wt,setWinnerHistoryIndex:vt,get sourceClassForMove(){return Ka},get studentToMove(){return Ja},get trashBin(){return Ze},get undoTimeout(){return ls},get userSettings(){return Pe},get winnerHistoryIndex(){return tt}},Symbol.toStringTag,{value:"Module"})),Co="TeacherAssistantDB",wo=1,ht="backups";function ma(){return new Promise((e,a)=>{const t=indexedDB.open(Co,wo);t.onupgradeneeded=c=>{const o=c.target.result;o.objectStoreNames.contains(ht)||o.createObjectStore(ht,{keyPath:"id"})},t.onsuccess=c=>e(c.target.result),t.onerror=c=>a(c.target.error)})}async function pi(e,a){const t=await ma(),c=t.transaction(ht,"readwrite"),o=c.objectStore(ht),n={id:Date.now(),file:e,metadata:a,timestamp:new Date().toISOString()};o.add(n),c.oncomplete=()=>{const s=t.transaction(ht,"readwrite").objectStore(ht),r=s.count();r.onsuccess=()=>{if(r.result>10){const l=s.getAllKeys();l.onsuccess=()=>{const f=l.result;for(;f.length>10;){const p=f.shift();s.delete(p),console.log(`♻️ Auto-deleted old backup snapshot: ${p}`)}}}}}}async function gi(){const e=await ma();return new Promise((a,t)=>{const n=e.transaction(ht,"readonly").objectStore(ht).getAll();n.onsuccess=()=>{const i=n.result.sort((s,r)=>r.id-s.id);a(i)},n.onerror=()=>t(n.error)})}async function Eo(e){(await ma()).transaction(ht,"readwrite").objectStore(ht).delete(e)}const So=Object.freeze(Object.defineProperty({__proto__:null,addBackupSnapshot:pi,deleteBackupSnapshot:Eo,getBackupSnapshots:gi},Symbol.toStringTag,{value:"Module"}));function je(e){return typeof e!="string"?"":e.replace(/ي/g,"ی").replace(/ك/g,"ک").replace(/[\s\u200c]/g,"")}function us(e){return typeof e!="string"||e.length===0?"ltr":/[\u0590-\u07FF]/.test(e)?"rtl":"ltr"}function ha(e){return!e||!e.trim()?"":e.split(`
`).map(c=>`<div dir="${us(c)}">${c||"&nbsp;"}</div>`).join("")}function Mn(e){if(typeof e!="string")return"";const a={q:"ض",w:"ص",e:"ث",r:"ق",t:"ف",y:"غ",u:"ع",i:"ه",o:"خ",p:"ح","[":"ج","]":"چ",a:"ش",s:"س",d:"ی",f:"ب",g:"ل",h:"ا",j:"ت",k:"ن",l:"م",";":"ک","'":"گ",z:"ظ",x:"ط",c:"ز",v:"ر",b:"ذ",n:"د",m:"پ",",":"و"};let t="";for(let c=0;c<e.length;c++){const o=e[c].toLowerCase();t+=a[o]||e[c]}return t}function Ut(e){if(!e||typeof e!="string")return{name:"",firstName:"",lastName:""};const a=e.split(".").map(t=>t.trim());if(a.length>1){const t=a[0],c=a.slice(1).join(" ");return{firstName:t,lastName:c,name:`${t} ${c}`.trim()}}return{name:e.trim(),firstName:"",lastName:""}}let _s=null;function Ts(){if(!Pe.isSoundEnabled)return;const e=window.AudioContext||window.webkitAudioContext;if(!e)return;_s||(_s=new e);const a=_s,t=()=>{const c=a.createOscillator(),o=a.createGain();c.connect(o),o.connect(a.destination),c.type="sine";const n=a.currentTime;c.frequency.setValueAtTime(450,n),o.gain.setValueAtTime(0,n),o.gain.linearRampToValueAtTime(.3,n+.002),o.gain.exponentialRampToValueAtTime(.001,n+.025),o.gain.linearRampToValueAtTime(0,n+.03),c.start(n),c.stop(n+.04)};a.state==="suspended"?a.resume().then(()=>{t()}).catch(c=>console.error("Audio resume failed:",c)):t()}function En(e){const a=e.filter(o=>o.identity.firstName&&o.identity.lastName),t=e.filter(o=>(!o.identity.firstName||!o.identity.lastName)&&typeof o.identity.name=="string"),c=e.filter(o=>(!o.identity.firstName||!o.identity.lastName)&&!o.identity.name);return a.sort((o,n)=>{const i=o.identity.lastName.localeCompare(n.identity.lastName,"fa");return i!==0?i:o.identity.firstName.localeCompare(n.identity.firstName,"fa")}),t.sort((o,n)=>o.identity.name.localeCompare(n.identity.name,"fa")),[...a,...t,...c]}function yi(e,a){let t=0;e.addEventListener("dblclick",a),e.addEventListener("touchend",c=>{const o=new Date().getTime(),n=o-t;n<400&&n>0&&(c.preventDefault(),a(c)),t=o})}const ko=Object.freeze(Object.defineProperty({__proto__:null,detectTextDirection:us,normalizeKeyboard:Mn,normalizeText:je,parseStudentName:Ut,playSuccessSound:Ts,renderMultiLineText:ha,setupDoubleAction:yi,sortStudents:En},Symbol.toStringTag,{value:"Module"})),vi="teacherAssistantLogs_v2",_o=100;function pa(){try{const e=localStorage.getItem(vi);return e?JSON.parse(e):{}}catch(e){return console.error("Error reading logs from localStorage:",e),{}}}function bi(e){try{localStorage.setItem(vi,JSON.stringify(e))}catch(a){console.error("Error saving logs to localStorage:",a)}}function ke(e,a,t=null){if(!e)return;const c=pa();c[e]||(c[e]=[]);const o={timestamp:new Date().toISOString(),message:a,action:t,classroomName:e};c[e].unshift(o),c[e].length>_o&&c[e].pop(),bi(c)}function Io(e){return pa()[e]||[]}function xo(e,a){const t=pa();t[e]&&!t[a]&&(t[a]=t[e],delete t[e],bi(t))}var za={toJalaali:Lo,toGregorian:Ci,isValidJalaaliDate:To,isLeapJalaaliYear:wi,jalaaliMonthLength:Ei,jalCal:ga,j2d:ts,d2j:ns,g2d:fs,d2g:ya,jalaaliToDateObject:Si,jalaaliWeek:Do},Et=[-61,9,38,199,426,686,756,818,1111,1181,1210,1635,2060,2097,2192,2262,2324,2394,2456,3178];function Lo(e,a,t){return Object.prototype.toString.call(e)==="[object Date]"&&(t=e.getDate(),a=e.getMonth()+1,e=e.getFullYear()),ns(fs(e,a,t))}function Ci(e,a,t){return ya(ts(e,a,t))}function To(e,a,t){return e>=-61&&e<=3177&&a>=1&&a<=12&&t>=1&&t<=Ei(e,a)}function wi(e){return Bo(e)===0}function Ei(e,a){return a<=6?31:a<=11||wi(e)?30:29}function Bo(e){var a=Et.length,t=Et[0],c,o,n,i,s;if(e<t||e>=Et[a-1])throw new Error("Invalid Jalaali year "+e);for(s=1;s<a&&(c=Et[s],o=c-t,!(e<c));s+=1)t=c;return i=e-t,o-i<6&&(i=i-o+Te(o+4,33)*33),n=et(et(i+1,33)-1,4),n===-1&&(n=4),n}function ga(e,a){var t=Et.length,c=e+621,o=-14,n=Et[0],i,s,r,l,f,p,h;if(e<n||e>=Et[t-1])throw new Error("Invalid Jalaali year "+e);for(h=1;h<t&&(i=Et[h],s=i-n,!(e<i));h+=1)o=o+Te(s,33)*8+Te(et(s,33),4),n=i;return p=e-n,o=o+Te(p,33)*8+Te(et(p,33)+3,4),et(s,33)===4&&s-p===4&&(o+=1),l=Te(c,4)-Te((Te(c,100)+1)*3,4)-150,f=20+o-l,a?{gy:c,march:f}:(s-p<6&&(p=p-s+Te(s+4,33)*33),r=et(et(p+1,33)-1,4),r===-1&&(r=4),{leap:r,gy:c,march:f})}function ts(e,a,t){var c=ga(e,!0);return fs(c.gy,3,c.march)+(a-1)*31-Te(a,7)*(a-7)+t-1}function ns(e){var a=ya(e).gy,t=a-621,c=ga(t,!1),o=fs(a,3,c.march),n,i,s;if(s=e-o,s>=0){if(s<=185)return i=1+Te(s,31),n=et(s,31)+1,{jy:t,jm:i,jd:n};s-=186}else t-=1,s+=179,c.leap===1&&(s+=1);return i=7+Te(s,30),n=et(s,30)+1,{jy:t,jm:i,jd:n}}function fs(e,a,t){var c=Te((e+Te(a-8,6)+100100)*1461,4)+Te(153*et(a+9,12)+2,5)+t-34840408;return c=c-Te(Te(e+100100+Te(a-8,6),100)*3,4)+752,c}function ya(e){var a,t,c,o,n;return a=4*e+139361631,a=a+Te(Te(4*e+183187720,146097)*3,4)*4-3908,t=Te(et(a,1461),4)*5+308,c=Te(et(t,153),5)+1,o=et(Te(t,153),12)+1,n=Te(a,1461)-100100+Te(8-o,6),{gy:n,gm:o,gd:c}}function Do(e,a,t){var c=Si(e,a,t).getDay(),o=c==6?0:-(c+1),n=6+o;return{saturday:ns(ts(e,a,t+o)),friday:ns(ts(e,a,t+n))}}function Si(e,a,t,c,o,n,i){var s=Ci(e,a,t);return new Date(s.gy,s.gm-1,s.gd,c||0,o||0,n||0,i||0)}function Te(e,a){return~~(e/a)}function et(e,a){return e-~~(e/a)*a}const ki=document.getElementById("class-management-page"),No=document.getElementById("open-add-class-modal-btn"),Ao=document.getElementById("add-class-modal"),vn=document.getElementById("modal-new-class-name"),ss=document.getElementById("modal-add-class-system"),va=document.getElementById("modal-add-class-level"),Bs=document.getElementById("confirm-add-class-btn"),Ds=document.getElementById("cancel-add-class-btn"),Dt=document.getElementById("class-list"),as=document.getElementById("undo-toast"),_i=document.getElementById("undo-message"),Oo=document.getElementById("undo-btn"),Mo=document.getElementById("settings-page"),Ii=document.getElementById("settings-class-name-header"),Ns=document.getElementById("settings-student-list"),As=document.getElementById("category-list"),Ro=document.getElementById("back-to-sessions-btn"),$o=document.getElementById("new-student-name"),zo=document.getElementById("add-student-btn"),xi=document.getElementById("paste-area"),Po=document.getElementById("process-paste-btn"),Fo=document.getElementById("csv-preview-page"),Os=document.getElementById("csv-preview-list"),Ho=document.getElementById("csv-confirm-btn"),Wo=document.getElementById("csv-cancel-btn"),Uo=document.getElementById("import-csv-btn"),jo=document.getElementById("csv-file-input"),qo=document.getElementById("column-mapping-page"),Ms=document.getElementById("column-select-dropdown"),Zo=document.getElementById("confirm-column-btn"),Go=document.getElementById("cancel-import-btn"),Rs=document.querySelector(".app-header"),Xe=document.getElementById("select-student-btn"),Nt=document.getElementById("select-student-btn-wrapper"),Vo=document.getElementById("assessment-mode-label"),Rn=document.getElementById("category-weight-label"),Jo=document.getElementById("attendance-page"),ln=document.getElementById("attendance-list"),Ko=document.getElementById("finish-attendance-btn"),Yo=document.querySelector("#class-management-page h2"),$s=document.getElementById("student-stats-header"),Xo=document.getElementById("hamburger-menu-btn"),Qo=document.getElementById("side-nav-menu"),er=document.getElementById("close-nav-btn"),tr=document.getElementById("overlay"),nr=document.getElementById("backup-data-btn"),sr=document.getElementById("restore-data-btn"),Li=document.getElementById("restore-file-input"),ar=document.getElementById("custom-confirm-modal"),Ti=document.getElementById("confirm-modal-message"),zs=document.getElementById("confirm-modal-cancel-btn"),sn=document.getElementById("confirm-modal-confirm-btn"),ir=document.getElementById("secure-confirm-modal"),Bi=document.getElementById("secure-confirm-message"),Di=document.getElementById("secure-confirm-code"),Ht=document.getElementById("secure-confirm-input"),or=document.getElementById("secure-confirm-cancel-btn"),$n=document.getElementById("secure-confirm-confirm-btn"),rr=document.getElementById("add-note-modal"),Ee=document.getElementById("new-note-content"),cr=document.getElementById("class-save-note-btn"),lr=document.getElementById("cancel-note-btn"),Ps=document.getElementById("student-search-input"),Ct=document.getElementById("student-search-results"),dr=document.getElementById("back-to-student-page-btn"),ur=document.getElementById("graded-category-pills-container"),fr=document.getElementById("new-score-value"),Ni=document.getElementById("new-score-comment"),mr=document.getElementById("add-score-btn"),hr=document.getElementById("profile-stats-summary"),pr=document.getElementById("profile-scores-list"),an=document.getElementById("global-student-search-input"),ft=document.getElementById("global-student-search-results"),gr=document.getElementById("trashed-classes-list"),yr=document.getElementById("trashed-students-list"),vr=document.getElementById("trashed-sessions-list"),br=document.getElementById("trashed-categories-list"),Cr=document.getElementById("trashed-notes-list"),wr=document.getElementById("trashed-scores-list"),jt=document.getElementById("quick-grade-form-wrapper"),pt=document.getElementById("quick-score-input"),ct=document.getElementById("quick-note-textarea"),At=document.getElementById("quick-grade-submit-btn"),dn=document.getElementById("category-selection-container"),Fs=document.getElementById("selected-student-result"),Ot=document.getElementById("custom-context-menu"),Wt=document.getElementById("breadcrumb-container"),Er=document.getElementById("report-config-modal"),Ai=document.getElementById("report-columns-container"),Oi=document.getElementById("report-print-btn"),Mi=document.getElementById("report-cancel-btn");let tn=null,Zt=null;const Sr=document.getElementById("category-modal"),Ri=document.getElementById("category-modal-title"),Gt=document.getElementById("new-category-modal-name"),ms=document.getElementById("new-category-modal-is-graded"),kr=document.getElementById("category-modal-cancel-btn"),$i=document.getElementById("category-modal-save-btn"),_r=document.getElementById("mass-comment-modal"),Ir=document.getElementById("mass-comment-modal-title"),zi=document.getElementById("mass-comment-student-count-message"),un=document.getElementById("mass-comment-content"),ba=document.getElementById("mass-comment-append-checkbox"),xr=document.getElementById("mass-comment-cancel-btn"),Lr=document.getElementById("mass-comment-save-btn"),Hs=document.getElementById("mass-comment-btn"),zn=document.getElementById("attendance-mass-actions-container"),Lt=document.createElement("input"),Tr=document.getElementById("session-dashboard-page"),Jt=document.getElementById("attendance-pane"),Pn=document.getElementById("settings-edu-system"),on=document.getElementById("settings-level"),Pi=document.getElementById("modal-schedule-text"),is=document.getElementById("modal-schedule-days"),Fi=document.getElementById("modal-schedule-start-time"),Hi=document.getElementById("modal-schedule-end-time"),rn=document.getElementById("modal-schedule-toggle"),Wi=document.getElementById("modal-schedule-content"),os=document.getElementById("new-category-modal-weight"),Br=document.getElementById("category-modal"),Ui=document.getElementById("new-category-modal-weight-group"),Dr=document.getElementById("open-add-category-btn");function qt(e,a,t=800){let c,o=t;const n=s=>{c=setTimeout(()=>{Pe.isVibrationEnabled&&navigator.vibrate&&navigator.vibrate(50),a(s)},o)},i=()=>{clearTimeout(c)};e.addEventListener("touchstart",n,{passive:!0}),e.addEventListener("touchend",i),e.addEventListener("touchmove",i),e.addEventListener("mousedown",n),e.addEventListener("mouseup",i),e.addEventListener("mouseleave",i)}function Kt(e="selector"){if(!A||!Y){ye("class-management-page");return}Rr(),Hn(),Oe(),nt(),ye("session-dashboard-page",{tab:e}),ji(),Yt(e),$r()}function Yt(e){const a=document.getElementById("selector-tab-btn"),t=document.getElementById("attendance-tab-btn"),c=document.getElementById("selector-pane"),o=e==="selector";a.classList.toggle("active",o),t.classList.toggle("active",!o),c.classList.toggle("active",o),Jt.classList.toggle("active",!o)}function ji(){const e=document.getElementById("selector-tab-btn"),a=document.getElementById("attendance-tab-btn"),t=document.getElementById("selector-pane");e.addEventListener("click",()=>{Oe(),$e(),e.classList.add("active"),a.classList.remove("active"),t.classList.add("active"),Jt.classList.remove("active"),ye("session-dashboard-page",{tab:"selector"})}),a.addEventListener("click",()=>{nt(),a.classList.add("active"),e.classList.remove("active"),Jt.classList.add("active"),t.classList.remove("active"),ye("session-dashboard-page",{tab:"attendance"})}),yi(a,c=>{Yt("attendance"),nt(),setTimeout(()=>{const o=document.getElementById("attendance-search-input");o&&o.focus()},100)})}function Nr(e){clearTimeout(ls),mn||Xn(JSON.stringify(ie)),_i.textContent=e,as.classList.add("show"),li(setTimeout(()=>{as.classList.remove("show"),Xn(null)},5e3))}function qi(){if(mn){const e=A?A.info.name:null,a=JSON.parse(mn);Rt(a),e&&ie[e]?qe(ie[e]):qe(null),A?(_t(),Qt(),Ge()):We(),as.classList.remove("show"),clearTimeout(ls),Xn(null)}}function G(e,a=3e3){const t=document.getElementById("notification-toast");t&&(t.textContent=e,t.classList.add("show"),clearTimeout(Ks),di(setTimeout(()=>{t.classList.remove("show")},a)))}function rs(e){var v;const a=document.getElementById("restore-confirm-modal"),t=document.getElementById("restore-modal-message"),c=document.getElementById("restore-append-checkbox"),o=document.querySelector('label[for="restore-append-checkbox"]'),n=document.getElementById("restore-confirm-cancel-btn"),i=document.getElementById("restore-confirm-confirm-btn"),s=document.getElementById("restore-modal-warning");s.style.display="none";const r=((v=e.metadata)==null?void 0:v.createdAt)||0;if(Pe.lastRestoreTimestamp&&r<Pe.lastRestoreTimestamp){const b=new Date(r).toLocaleDateString("fa-IR"),C=new Date(Pe.lastRestoreTimestamp).toLocaleDateString("fa-IR");s.textContent=`⚠️ هشدار: این فایل پشتیبان (${b}) قدیمی‌تر از آخرین بازیابی شما (${C}) است.`,s.style.display="block"}const l=e.data.classrooms||{},f=Object.values(l).map(b=>b.info.name),p=f.length,h="کلاس",m=f.map(b=>`<li style="margin-bottom: 4px;">🔹 ${b}</li>`).join("");t.innerHTML=`
        <div style="margin-bottom: 10px;">
            فایل پشتیبان شامل <strong>${p} ${h}</strong> زیر است:
        </div>
        <ul style="
            margin: 0; 
            padding: 10px; 
            background-color: #f8f9fa; 
            border-radius: 5px; 
            border: 1px solid #e9ecef;
            list-style: none; 
            max-height: 150px; 
            overflow-y: auto;
            text-align: right;
        ">
            ${m}
        </ul>
        <div style="margin-top: 15px;">
            لطفاً نحوه بازیابی را مشخص کنید.
        </div>
    `,c.checked=!1,o&&(o.textContent="جایگزینی کامل (حذف داده‌های فعلی)");const y=()=>{const b=c.checked;ti(e,b),i.onclick=null,n.onclick=null,a.removeEventListener("click",y),ge(),We(),ye("class-management-page"),G(`✅ اطلاعات با موفقیت بازیابی شد (${b?"پاک‌سازی و بازیابی":"همگام‌سازی هوشمند"}).`)},u=()=>{i.onclick=null,n.onclick=null,ge()};i.onclick=y,n.onclick=u,Ae("restore-confirm-modal")}function be(e,a,t={}){const{confirmText:c="تایید",cancelText:o="لغو",confirmClass:n="btn-success",onCancel:i=()=>{},isDelete:s=!1}=t,r=s?()=>Zi(e,a):a;Ti.innerHTML=e.replace(/\n/g,"<br>"),sn.textContent=c,zs.textContent=o,sn.className="modal-action-btn",sn.classList.add(n),ra(r),ca(i);const l=sn.parentElement;zs.style.display=i===null?"none":"inline-block",l.style.justifyContent=i===null?"center":"space-between",Ae("custom-confirm-modal")}function Zi(e,a){const t=Math.floor(1e4+Math.random()*9e4).toString();Bi.textContent=e,Di.textContent=t,Ht.value="",$n.disabled=!0,pn(a),Ae("secure-confirm-modal"),Ht.focus();const c=()=>{Ht.value===t?$n.disabled=!1:$n.disabled=!0};return Ht.addEventListener("input",c),()=>{Ht.removeEventListener("input",c)}}function Ws(e,a={}){const{title:t="ایجاد دسته‌بندی جدید",initialName:c="",initialIsGraded:o=!1,initialWeight:n=1,saveButtonText:i="ذخیره"}=a;Ri.textContent=t,Gt.value=c,ms.checked=o,os.value=n,$i.textContent=i,gn((s,r)=>{const l=parseFloat(os.value)||1;if(!s){G("⚠️ لطفاً نام دسته‌بندی را وارد کنید.");return}e(s,r,l),ge()}),Ae("category-modal"),Gt.focus(),c&&Gt.select()}function Ca(e,a){const t=Object.values(ie).filter(i=>!i.isDeleted&&i.info.name!==a.info.name),c=document.getElementById("move-student-modal-title"),o=document.getElementById("move-student-class-select"),n=document.getElementById("move-student-confirm-btn");c.textContent=`انتقال دانش‌آموز: ${e.identity.name}`,o.innerHTML="",t.length===0?(o.innerHTML='<option value="">کلاس دیگری برای انتقال وجود ندارد</option>',n.disabled=!0):(t.forEach(i=>{const s=document.createElement("option");s.value=i.info.name,s.textContent=i.info.name,o.appendChild(s)}),n.disabled=!1),mi(e),hi(a),Ae("move-student-modal")}function wa(e,a){if(!e||!a)return;const t=e.identity.name,c=e.identity.firstName||"";e.identity.lastName;const o=document.getElementById("add-note-modal-title");o.textContent="تغییر نام دانش‌ آموز";const n=e.identity.firstName&&e.identity.lastName?`${e.identity.firstName} . ${e.identity.lastName}`:t;Ee.value=n,Ee.rows=1,Ee.dispatchEvent(new Event("input",{bubbles:!0})),dt(i=>{const s=i.indexOf(".");if(s<=0||s>=i.length-1)return G("لطفا نام و نام خانوادگی شخص را با یک نقطه از هم جدا کنید. مثال: علی . احمدی"),!1;const r=Ut(i),l=r.name,f=r.firstName||"";if(e.identity.firstName&&e.identity.lastName&&!r.firstName)return G("⚠️ این دانش‌آموز دارای نام و نام‌خانوادگی تفکیک شده است. لطفاً حتماً از نقطه (.) بین نام و نام‌خانوادگی استفاده کنید."),!1;if(l&&(l!==t||f!==c)){if(we(a.students).some(u=>u.identity.studentId!==e.identity.studentId&&u.identity.name.toLowerCase()===l.toLowerCase()))return G("دانش‌آموزی با این نام از قبل در این کلاس وجود دارد."),!1;{e.identity.name=l,e.identity.firstName=r.firstName,e.identity.lastName=r.lastName,ke(a.info.name,`نام دانش‌آموز «${t}» به «${l}» تغییر یافت.`,{type:"VIEW_STUDENT_PROFILE",studentId:e.identity.studentId}),oe(),_t(),Oe(),nt(),$e(),_e&&_e.identity.studentId===e.identity.studentId&&Fe(e);const u=document.querySelector(`#settings-student-list li[data-student-id="${e.identity.studentId}"]`);u&&(u.classList.add("recently-updated"),setTimeout(()=>{u&&u.classList.remove("recently-updated")},1e4),u.scrollIntoView({behavior:"smooth",block:"center"})),G(`✅ نام دانش‌آموز به «${l}» تغییر یافت.`)}}else if(!l)return G("⚠️ نام نمی‌تواند خالی باشد."),!1;const m=document.getElementById("add-note-modal-title");m.textContent="ثبت یادداشت جدید",Ee.rows=4}),Ae("add-note-modal"),Ee.focus(),Ee.select()}function Ae(e){const a=document.getElementById(e);if(a){if(St)return;a.classList.add("modal-visible"),la(e),history.pushState(null,"",location.href)}}function ge(e,a=!1){if(!St)return;const t=document.getElementById(St),c=St;la(null),c==="student-profile-modal"&&Qe(null),a||history.back(),t&&(t.classList.add("modal-closing"),setTimeout(()=>{t.classList.remove("modal-visible"),t.classList.remove("modal-closing"),c==="custom-confirm-modal"&&(ra(null),ca(null)),c==="secure-confirm-modal"&&pn(null),c==="category-modal"&&gn(null),c==="mass-comment-modal"&&(un.value=""),c==="add-note-modal"&&dt(null),typeof e=="function"&&e()},300))}function Ea(){if(!Jt||!Jt.classList.contains("active")){zn.style.display="none";return}const e=Mt.length;e<1?zn.style.display="none":zn.style.display="block",Hs.disabled=e<1,Hs.textContent=`📝 ثبت یادداشت گروهی (${e} نفر)`}function Sa(){const e=Mt,a=e.length;let t=!1;a>0&&(t=e.some(o=>{var n;return(n=Y.studentRecords[o])==null?void 0:n.homework.comment})),zi.textContent=`یادداشت برای ${a} دانش‌آموز ثبت خواهد شد.`,un.value="",un.dispatchEvent(new Event("input",{bubbles:!0})),ba.checked=!0;const c=document.querySelector("#mass-comment-modal .modal-options");c.style.display=t?"flex":"none",Ae("mass-comment-modal"),un.focus()}function Us(e,a){if(!A||!Y)return;let t=0;const c=Mt,o=Y;c.forEach(n=>{const i=o.studentRecords[n];if(i&&i.homework){const s=i.homework.comment||"";let r=e;a&&s.length>0?r=s+`
---
`+e:r=e,i.homework.comment=r.trim();const l=A.students.find(f=>f.identity.studentId===n);l&&Ar(l,o,r.trim()),t++}}),yn([]),oe(),nt(),ke(A.info.name,`${t} دانش‌آموز به صورت گروهی یادداشت تکلیف گرفتند.`,{type:"VIEW_SESSIONS"}),G(`✅ یادداشت برای ${t} دانش‌آموز ثبت شد.`)}function Ar(e,a,t){const o=rt(A).get(a.sessionNumber),n={type:"fromAttendance",sessionNumber:a.sessionNumber},i=`یادداشت جلسه ${o}:
`,s=e.profile.notes.find(r=>!r.isDeleted&&r.source&&r.source.type==="fromAttendance"&&r.source.sessionNumber===n.sessionNumber);s?t?(s.content=i+t,s.isDeleted=!1):s.isDeleted=!0:t&&e.addNote(i+t,n)}function hs(e){Ee.value=e.note||"",dt(a=>{e.note=a,oe(),ke(e.info.name,"یادداشت کلاس ذخیره شد.",{type:"VIEW_CLASS_NOTE"}),We(),G("✅ یادداشت کلاس ذخیره شد.")}),Ae("add-note-modal"),Ee.focus()}function ka(e,a){Ee.value=e.note||"",Ee.dispatchEvent(new Event("input",{bubbles:!0})),dt(t=>{e.note=t,oe(),ke(A.info.name,`یادداشت جلسه ${a} ذخیره شد.`,{type:"VIEW_SESSIONS"}),Ge(),G("✅یادداشت جلسه ذخیره شد.")}),Ae("add-note-modal"),Ee.focus()}function kt(e){qe(e),Ii.textContent=`تنظیمات کلاس: ${e.info.name}`,_t(),Qt(),eo(),ye("settings-page")}function Gi(e){const a=document.getElementById("log-modal-title"),t=document.getElementById("log-list");a.textContent=`گزارش فعالیت‌های کلاس: ${e}`,t.innerHTML="";const c=Io(e);c.length===0?t.innerHTML='<li class="no-content-message">هنوز فعالیتی برای این کلاس ثبت نشده است.</li>':c.forEach(o=>{const n=document.createElement("li");n.className="log-entry";const i=new Date(o.timestamp),s=`${i.toLocaleDateString("fa-IR")} - ${i.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}`,r=document.createElement("span");r.className="log-timestamp",r.textContent=s;const l=document.createElement("span");l.className="log-message",l.textContent=o.message,o.action&&(l.classList.add("log-action-link"),l.dataset.action=JSON.stringify({...o.action,classroomName:o.classroomName})),n.appendChild(r),n.appendChild(l),t.appendChild(n)}),Ae("log-modal")}document.getElementById("log-modal-close-btn").addEventListener("click",()=>{ge()});function js(e){const a=URL.createObjectURL(e),t=document.createElement("a");t.href=a,t.download=e.name,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(a),setTimeout(()=>{be("آیا فایل پشتیبان با موفقیت ذخیره شد؟",()=>{ua(),ps(),G("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله، ذخیره شد",cancelText:"خیر",confirmClass:"btn-success"})},500)}async function bn(e=[]){const a=await Qa(e);if(!a){G("❌ خطا در ایجاد فایل پشتیبان.");return}let t="پشتیبان کامل سیستم";if(e.length>0){const o=e.join("، ");t=`${e.length===1?"پشتیبان کلاس:":"پشتیبان کلاس‌های:"} ${o}`}pi(a,{name:a.name,description:t,version:"2.0-b64"}).catch(o=>console.error("Failed to save local snapshot:",o)),("ontouchstart"in window||navigator.maxTouchPoints>0)&&navigator.share&&navigator.canShare&&navigator.canShare({files:[a]})?be("فایل پشتیبان شما آماده است. آیا مایل به اشتراک‌گذاری آن هستید؟",()=>{try{navigator.share({title:a.name,text:"فایل پشتیبان داده‌های برنامه",files:[a]}).then(()=>{be("آیا فایل پشتیبان با موفقیت ارسال/ذخیره شد؟",()=>{ua(),ps(),G("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}catch(o){console.error("Error during sharing process:",o),js(a),G("⚠️خطا در فرآیند اشتراک‌گذاری. فایل در حال دانلود است.")}},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"}):(js(a),G("✅پشتیبان‌گیری با موفقیت انجام شد."))}function Sn(e,a){e.preventDefault(),Bt(),Zt=e.target.closest("li"),Zt&&Zt.classList.add("context-menu-target"),setTimeout(()=>{const t=Ot,c=t.querySelector("ul");c.innerHTML="",a.forEach(l=>{const f=document.createElement("li");l.isSeparator?f.className="separator":(f.innerHTML=`
                    <span class="icon">${l.icon||""}</span>
                    <span class="label">${l.label}</span>
                `,l.className&&f.classList.add(l.className),f.addEventListener("click",()=>{l.action(),Bt()})),c.appendChild(f)}),t.classList.add("visible");const{offsetWidth:o,offsetHeight:n}=t,{innerHeight:i}=window,s=document.body.getBoundingClientRect();t.style.top=`${(i-n)/2}px`;const r=s.left+s.width/2;t.style.left=`${r-o/2}px`},50)}function Bt(){Ot.classList.contains("visible")&&Ot.classList.remove("visible"),Zt&&(Zt.classList.remove("context-menu-target"),Zt=null)}function Vi(){var t;Wt.innerHTML="";const e=document.getElementById("header-settings-btn");if(!e)return;const a=[];if(a.push({label:"کلاس‌ها",handler:()=>{qe(null),Ke(null),Qe(null),ye("class-management-page")}}),A){a.push({label:A.info.name,handler:()=>{Ke(null),Qe(null),Ge(),ye("session-page")}});const c=(t=document.querySelector(".page.active"))==null?void 0:t.id;if(c==="session-page"?e.style.visibility="visible":e.style.visibility="hidden",c==="settings-page")a.push({label:"تنظیمات"});else if(Y){const n=rt(A).get(Y.sessionNumber)||` (#${Y.sessionNumber})`;a.push({label:`جلسه ${n}`,handler:()=>{Qe(null),Kt("selector")}}),_e&&a.push({label:`پروفایل: ${_e.identity.name}`})}}else e.style.visibility="hidden";if(a.length<=1){Wt.style.display="none";return}Wt.style.display="flex",a.forEach((c,o)=>{const n=document.createElement("a");if(n.textContent=c.label,n.className="breadcrumb-item",o===a.length-1||!c.handler?n.classList.add("active"):n.addEventListener("click",c.handler),Wt.appendChild(n),o<a.length-1){const i=document.createElement("span");i.className="breadcrumb-separator",i.textContent="/",Wt.appendChild(i)}})}function Pa(e,a,t){t.innerHTML="";const c=A.sessions.filter(o=>{var n;return!o.isDeleted&&!o.isCancelled&&((n=o.studentRecords[e.identity.studentId])==null?void 0:n.attendance)==="absent"}).map(o=>({number:a.get(o.sessionNumber),isMakeup:o.isMakeup})).filter(o=>o.number!==void 0);c.length>0?(t.appendChild(document.createTextNode("جلسات غایب: ")),c.forEach((o,n)=>{const i=document.createElement("span");i.textContent=o.number,o.isMakeup&&i.classList.add("makeup-absence"),t.appendChild(i),n<c.length-1&&t.appendChild(document.createTextNode("، "))})):t.textContent="جلسات غایب: بدون غیبت"}function Fn(e,a,t,c={}){const{includePrefix:o=!0}=c;t.innerHTML="";const n=A.sessions.filter(i=>{if(i.isDeleted||i.isCancelled)return!1;const s=i.studentRecords[e.identity.studentId];return s&&s.homework&&(s.homework.status==="incomplete"||s.homework.status==="none")}).map(i=>({number:a.get(i.sessionNumber),status:i.studentRecords[e.identity.studentId].homework.status})).filter(i=>i.number!==void 0);n.length>0?(o&&t.appendChild(document.createTextNode("تکالیف ناقص: ")),n.forEach((i,s)=>{const r=document.createElement("span");r.textContent=i.number,i.status==="incomplete"&&r.classList.add("incomplete-homework"),t.appendChild(r),s<n.length-1&&t.appendChild(document.createTextNode("،"))})):o?t.textContent="تکالیف ناقص: ندارد":t.textContent="ندارد"}function Or(e,a){var L,D,M;const t=document.createElement("li");t.className="attendance-list-item";const c=document.createElement("span");c.className="absence-info";const o=document.createElement("span");o.className="homework-info";const n=document.createElement("div");n.className="att-row-1";let i=!1;n.addEventListener("mousedown",()=>i=!1),n.addEventListener("touchstart",()=>i=!1,{passive:!0});const s=document.createElement("input");s.type="checkbox",s.className="mass-comment-checkbox",s.checked=Mt.includes(e.identity.studentId),s.addEventListener("change",()=>{const U=e.identity.studentId,Q=Mt;if(s.checked)Q.includes(U)||Q.push(U);else{const z=Q.indexOf(U);z>-1&&Q.splice(z,1)}Ea();const I=document.getElementById("attendance-list");Q.length===0&&I.classList.contains("selection-mode-active")&&I.classList.remove("selection-mode-active")});const r=document.createElement("span");r.className="student-name",r.textContent=e.identity.firstName&&e.identity.lastName?`${e.identity.lastName}، ${e.identity.firstName}`:e.identity.name,r.addEventListener("click",U=>{if(i){U.stopPropagation(),U.preventDefault(),i=!1;return}Fe(e)}),qt(n,U=>{i=!0;const Q=document.getElementById("attendance-list");Q.classList.contains("selection-mode-active")||Q.classList.add("selection-mode-active"),s.checked||(s.checked=!0,s.dispatchEvent(new Event("change")))}),n.appendChild(s),n.appendChild(r);const l=document.createElement("div");l.className="att-row-2";const f=document.createElement("button");let p=!1;f.addEventListener("mousedown",()=>p=!1),f.addEventListener("touchstart",()=>p=!1,{passive:!0});const h=((L=Y.studentRecords[e.identity.studentId])==null?void 0:L.attendance)||"present",m=U=>{U==="present"?(f.textContent="حاضر",f.className="attendance-status-btn present active"):(f.textContent="غایب",f.className="attendance-status-btn absent active")};m(h),f.addEventListener("click",U=>{var z;if(p){U.stopPropagation();return}const I=(((z=Y.studentRecords[e.identity.studentId])==null?void 0:z.attendance)||"present")==="present"?"absent":"present";Y.setAttendance(e.identity.studentId,I),I==="absent"&&(Y.studentRecords[e.identity.studentId].hadIssue=!1),oe(),m(I),Pa(e,a,c),Oe(),to()}),qt(f,()=>{p=!0;const U=h==="present"?"absent":"present",Q=U==="present"?"حاضر":"غایب";be(`آیا مطمئن هستید که می‌خواهید وضعیت حضور تمام دانش‌آموزان را به «${Q}» تغییر دهید؟`,()=>{we(A.students).forEach(I=>{Y.setAttendance(I.identity.studentId,U),U==="absent"&&(Y.studentRecords[I.identity.studentId].hadIssue=!1)}),oe(),nt(),G(`✅ وضعیت تمام دانش‌آموزان به «${Q}» تغییر یافت.`)},{confirmText:"بله، اعمال کن",confirmClass:"btn-warning"})});const y=document.createElement("div");y.className="homework-controls";const u={none:"بدون تکلیف",complete:"تکلیف کامل",incomplete:"تکلیف ناقص"},v=document.createElement("button");let b=!1;v.addEventListener("mousedown",()=>b=!1),v.addEventListener("touchstart",()=>b=!1,{passive:!0});const C=((D=Y.studentRecords[e.identity.studentId])==null?void 0:D.homework.status)||"none";v.className=`homework-status-btn ${C}`,v.title=u[C],v.addEventListener("click",U=>{if(b){U.stopPropagation();return}const Q=Y.studentRecords[e.identity.studentId].homework,z={none:"incomplete",incomplete:"complete",complete:"none"}[Q.status];Y.setHomeworkStatus(e.identity.studentId,z),oe(),v.className=`homework-status-btn ${z}`,v.title=u[z],Fn(e,a,o)}),qt(v,()=>{b=!0;const Q={none:"incomplete",incomplete:"complete",complete:"none"}[C],I=u[Q];be(`آیا از تغییر وضعیت تکلیف تمام دانش‌آموزان به «${I}» مطمئن هستید؟`,()=>{we(A.students).forEach(z=>{Y.setHomeworkStatus(z.identity.studentId,Q)}),oe(),nt(),G(`✅ وضعیت تکلیف همه به «${I}» تغییر یافت.`)},{confirmText:"بله",confirmClass:"btn-warning"})});const S=document.createElement("button");let k=!1;S.addEventListener("mousedown",()=>k=!1),S.addEventListener("touchstart",()=>k=!1,{passive:!0}),S.className="btn-icon",S.innerHTML="📝",S.title="افزودن یادداشت برای تکلیف",((M=Y.studentRecords[e.identity.studentId])==null?void 0:M.homework.comment)||(S.style.opacity="0.3"),S.addEventListener("click",U=>{if(k){U.stopPropagation();return}const Q=Y.studentRecords[e.identity.studentId].homework;Ee.value=Q.comment||"",Ee.dispatchEvent(new Event("input",{bubbles:!0})),dt(I=>{Q.comment=I;const z=rt(A),g=z.get(Y.sessionNumber),W={type:"fromAttendance",sessionNumber:Y.sessionNumber},ue=`یادداشت جلسه ${g}:
`,q=e.profile.notes.find(me=>!me.isDeleted&&me.source&&me.source.type==="fromAttendance"&&me.source.sessionNumber===W.sessionNumber);q?I?q.content=ue+I:q.isDeleted=!0:I&&e.addNote(ue+I,W),oe(),G("✅یادداشت تکلیف ذخیره شد."),S.style.opacity=I?"1":"0.3",Fn(e,z,o)}),Ae("add-note-modal"),Ee.focus()}),qt(S,()=>{k=!0,be("آیا می‌خواهید برای **تمام** دانش‌آموزان کلاس یادداشت تکلیف ثبت کنید؟",()=>{const U=we(A.students).map(Q=>Q.identity.studentId);yn(U),Sa()},{confirmText:"بله",confirmClass:"btn-primary"})}),l.appendChild(f),y.appendChild(S),y.appendChild(v),l.appendChild(y);const x=document.createElement("div");return x.className="att-row-3",Pa(e,a,c),Fn(e,a,o),x.appendChild(c),x.appendChild(o),t.appendChild(n),t.appendChild(l),t.appendChild(x),t}function Mr(){return rt(A).get(Y.sessionNumber)}function nt(){const e=we(A.students),a=En(e);if(!A||!Y)return;a.forEach(i=>{Y.initializeStudentRecord(i.identity.studentId)}),yn([]);const t=rt(A);Zr(),ln.innerHTML="";const c=document.createElement("li");c.className="attendance-list-header",Lt.id="attendance-search-input",Lt.type="text",Lt.className="inline-search-input",Lt.placeholder="جستجو...",Lt.value="";const o=document.createElement("div");o.className="student-search-container",o.appendChild(Lt);const n=document.createElement("div");n.className="header-labels-container",n.innerHTML=`
    <span class="header-label">تکلیف</span>
    <span class="header-label">حضور</span>
`,c.appendChild(o),c.appendChild(n),ln.appendChild(c),a.forEach(i=>{const s=Or(i,t);ln.appendChild(s)}),yn([]),Ea(),Gr(),to()}function Oe(){const e=document.getElementById("student-stats-table-container");if(!e||(e.innerHTML="",!A))return;we(A.students).length,$s.textContent="آمار عملکرد";const a=["نام"],t=["کل انتخاب ها","غیبت","خروج","فرصت ازدست‌رفته","مشکل","میانگین","نمره نهایی"],c=A.categories.filter(m=>m.isGradedCategory&&!m.isDeleted).map(m=>m.name),o=[...a,...c,...t],n=document.createElement("table");n.className="student-stats-table";const s=n.createTHead().insertRow();o.forEach((m,y)=>{const u=document.createElement("th");y===0?(u.innerHTML=`${m} <span style="opacity: 0.6;">🔗</span>`,u.title="ردیف‌های این ستون قابل کلیک هستند"):u.textContent=m,s.appendChild(u)});const r=n.createTBody(),l=En(we(A.students)),f=m=>{let y=0;return A.sessions.forEach(u=>{if(u.isDeleted||u.isCancelled)return;const v=u.studentRecords[m.identity.studentId];v&&v.attendance==="absent"&&y++}),y};l.forEach(m=>{const y=r.insertRow();if(y.dataset.studentId=m.identity.studentId,Y){const k=Y.studentRecords[m.identity.studentId];k&&k.attendance==="absent"&&y.classList.add("absent-row-highlight")}const u=y.insertCell(),v=document.createElement("span");v.textContent=`${m.identity.lastName}، ${m.identity.firstName}`,v.className="student-name-link",v.addEventListener("click",()=>{Fe(m)}),u.appendChild(v),c.forEach(k=>{var D;const _=y.insertCell();_.style.direction="ltr";const x=k.toLowerCase(),L=((D=m.logs.scores[x])==null?void 0:D.filter(M=>!M.isDeleted))||[];L.length>0?L.forEach((M,U)=>{const Q=document.createElement("span");Q.textContent=M.value+(M.comment?"'":""),Q.style.position="relative",M.comment&&(Q.dataset.tooltip=M.comment),_.appendChild(Q),U<L.length-1&&_.appendChild(document.createTextNode(","))}):_.textContent="",_.style.cursor="pointer",_.addEventListener("click",()=>{$e(m,k);const M=document.getElementById("category-selection-container");M&&M.scrollIntoView({behavior:"smooth",block:"center"})})}),y.insertCell().textContent=m.statusCounters.totalSelections||0,y.insertCell().textContent=f(m),y.insertCell().textContent=m.statusCounters.outOfClassCount||0,y.insertCell().textContent=m.statusCounters.missedChances||0;const b=Object.values(m.categoryIssues||{}).reduce((k,_)=>k+_,0);y.insertCell().textContent=b;const C=m.getOverallAverageScore();y.insertCell().textContent=C!==null?C:"-";const S=A.calculateFinalStudentScore(m);y.insertCell().textContent=S!==null?S:"-"}),we(A.students),$s.setAttribute("data-student-count",l.length),e.appendChild(n);const p=e.querySelector(".student-stats-table"),h=p==null?void 0:p.querySelector("thead th:first-child");h&&h.addEventListener("click",()=>{p.classList.toggle("name-column-expanded")})}function $e(e=null,a=null){const t=Xr(e,a);if(!t)return;const{winner:c,categoryName:o}=t;Qr(c,o);const n=document.getElementById("selected-student-result"),i=!e,s=Y.studentRecords[c.identity.studentId],{nameContainer:r}=ec(c,o,i);n.appendChild(r);const l=tc(c,s,o);if(n.appendChild(l),o&&typeof Fa=="function"){const p=Fa(c,o);p&&n.appendChild(p)}const f=nc(c);n.appendChild(f)}function _a(e){e.addEventListener("input",()=>{const a=e.value,t=us(a);e.setAttribute("dir",t)})}function Rr(){Ia(null),dn.innerHTML="",Fs.innerHTML="",jt.classList.add("tooltip-container"),pt.disabled=!0,ct.disabled=!0,At.disabled=!0,pt.value="",ct.value="",Nt.classList.add("disabled-wrapper"),Xe.disabled=!0}function Hn(){dn.innerHTML="",A.categories.filter(t=>!t.isDeleted).forEach(t=>{const c=document.createElement("span");c.className="pill",c.textContent=t.name,c.dataset.categoryId=t.id,t.description&&(c.dataset.tooltip=t.description),Y.isFinished?c.classList.add("disabled"):c.addEventListener("click",()=>{document.querySelectorAll("#category-selection-container .pill").forEach(n=>n.classList.remove("active")),c.classList.add("active"),Qn(t),Ia(t),Ji(t),Cn(t),Xt(t.name),Nt.classList.remove("disabled-wrapper"),Xe.disabled=Y.isFinished;const o=Y.lastWinnerByCategory[t.name];if(o){const n=A.students.find(i=>i.identity.studentId===o);n&&$e(n,t.name)}else{Fs.innerHTML="",Vt(null),vt(-1),Xe.disabled=!1;const n=document.querySelector(".current-winner-highlight");n&&n.classList.remove("current-winner-highlight")}}),Y.isFinished||c.addEventListener("contextmenu",o=>{Sn(o,[{label:"تغییر نام",icon:"✏️",action:()=>{Ws((i,s,r)=>{const l=si(A,t,i);l.success?(t.isGradedCategory=s,t.weight=r,oe(),ke(A.info.name,`نام دسته‌بندی «${t.name}» به «${i}» تغییر یافت.`),Hn(),Oe(),G(`✅ نام دسته‌بندی به «${i}» تغییر یافت.`)):G(`⚠️ ${l.message}`)},{title:"ویرایش دسته‌بندی",initialName:t.name,initialIsGraded:t.isGradedCategory,initialWeight:t.weight||1,saveButtonText:"ذخیره تغییرات"})}},{label:"حذف دسته‌بندی",icon:"🗑️",className:"danger",action:()=>{be(`آیا از انتقال دسته‌بندی «${t.name}» به سطل زباله مطمئن هستید؟`,()=>{const i={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${t.name}» از کلاس «${A.info.name}»`,restoreData:{categoryId:t.id,classId:A.info.scheduleCode}};lt(i);const s=t.name.toLowerCase();if(A.students.forEach(r=>{r.logs.scores&&r.logs.scores[s]&&r.logs.scores[s].forEach(l=>{l.isDeleted=!0})}),Re&&Re.id===t.id){Qn(null),Fs.innerHTML="",Cn(null),Xt(null),Nt.classList.add("disabled-wrapper"),Xe.disabled=!0;const r=document.querySelector(".current-winner-highlight");r&&r.classList.remove("current-winner-highlight")}t.isDeleted=!0,ke(A.info.name,`دسته‌بندی «${t.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),Hn(),Oe(),G(`✅ دسته‌بندی «${t.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}}])}),dn.appendChild(c)});const a=document.createElement("span");a.className="pill add-category-pill",a.textContent="+",a.title="افزودن دسته‌بندی جدید",Y.isFinished?a.classList.add("disabled"):a.addEventListener("click",()=>{ms.checked=!1,document.getElementById("new-category-modal-weight-group").style.display="none",Ws((t,c,o)=>{if(A.categories.find(s=>s.name.toLowerCase()===t.toLowerCase()&&!s.isDeleted)){G("⚠️ این دسته‌بندی از قبل وجود دارد.");return}const i=new yt(t,"",c,o);A.categories.push(i),oe(),ke(A.info.name,`دسته‌بندی جدید «${t}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),Hn(),G(`✅ دسته‌بندی «${t}» اضافه شد.`)},{initialWeight:1})}),dn.appendChild(a)}function $r(){if(Y.lastUsedCategoryId){if(Y.isFinished)return;const e=dn.querySelector(`.pill[data-category-id="${Y.lastUsedCategoryId}"]`);e&&e.click()}Y.winnerHistory&&Y.winnerHistory.length>0&&(vt(Y.winnerHistory.length-1),$e())}function Ia(e){e?Xe.textContent=`نفر بعدی در ${e.name}`:Xe.textContent="نفر بعدی"}function Ji(e){e&&e.isGradedCategory?(Rn.textContent=`ضریب: ${e.weight||1}`,Rn.style.display="block"):Rn.style.display="none"}function Cn(e){if(Y.isFinished){pt.disabled=!0,ct.disabled=!0,At.disabled=!0,jt.setAttribute("title","جلسه خاتمه یافته است");return}e&&e.isGradedCategory?(pt.disabled=!1,ct.disabled=!1,At.disabled=!1,jt.removeAttribute("title")):(pt.disabled=!0,ct.disabled=!0,At.disabled=!0,e?jt.setAttribute("title","برای این دسته‌بندی قابلیت نمره دهی تعریف نشده است"):jt.setAttribute("title","ابتدا یک دسته‌بندی را انتخاب کنید"))}function Xt(e){const a=document.querySelector(".student-stats-table");if(!a||(a.querySelectorAll(".current-category-highlight").forEach(i=>{i.classList.remove("current-category-highlight")}),!e))return;let c=-1;const o=a.querySelectorAll("thead th");if(o.forEach((i,s)=>{i.textContent.trim()===e&&(c=s)}),c===-1)return;o[c].classList.add("current-category-highlight"),a.querySelectorAll("tbody tr").forEach(i=>{const s=i.cells[c];s&&s.classList.add("current-category-highlight")})}function Fe(e){Qe(e);const a=document.getElementById("student-profile-modal"),t=document.getElementById("modal-profile-student-name"),c=document.getElementById("modal-profile-content-container"),o=document.getElementById("modal-profile-close-btn");if(!a||!t||!c||!o)return;t.textContent=`پروفایل: ${e.identity.name}`,t.style.cursor="pointer",t.onclick=()=>{const l=_e,f=A;ge(()=>{wa(l,f)})},c.innerHTML="";const n=document.createElement("div");n.className="profile-header-actions";const i=document.createElement("button");i.className="btn-icon btn-icon-label",i.title="انتقال دانش‌آموز",i.innerHTML="<span>➡️</span><span>انتقال</span>",i.addEventListener("click",()=>{const l=_e,f=A;ge(()=>{Ca(l,f)})});const s=document.createElement("button");s.className="btn-icon btn-icon-label",s.title="حذف دانش‌آموز",s.innerHTML="<span>🗑️</span><span>حذف</span>",s.style.color="var(--color-strong-warning)",s.addEventListener("click",()=>{const l=_e,f=A;ge(()=>{be(`آیا از انتقال دانش‌آموز «${l.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const p={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${l.identity.name}» از کلاس «${f.info.name}»`,restoreData:{studentId:l.identity.studentId,classId:f.info.scheduleCode}};lt(p),l.isDeleted=!0,ke(f.info.name,`دانش‌آموز «${l.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),_t(),Oe(),nt(),G(`✅ دانش‌آموز «${l.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0,onCancel:()=>{Fe(l)}})})});const r=document.createElement("button");r.className="btn-icon btn-icon-label",r.title="افزودن یادداشت جدید",r.innerHTML="<span>📝</span><span>یادداشت</span>",r.addEventListener("click",()=>{const l=_e;Ee.value="",Ee.dispatchEvent(new Event("input",{bubbles:!0})),dt(f=>{if(f)return l.addNote(f),oe(),ke(A.info.name,`یادداشت جدیدی برای دانش‌آموز «${l.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:l.identity.studentId}),$e(),G("✅ یادداشت با موفقیت ثبت شد."),()=>Fe(l)}),ge(()=>{Ae("add-note-modal"),Ee.focus()})}),n.appendChild(i),n.appendChild(s),n.appendChild(r),c.appendChild(n),zr(c),Ki(c),o.onclick=()=>ge(),Ae("student-profile-modal")}function zr(e){if(!_e||!A)return;const a=document.createElement("div");a.className="scoring-section",a.innerHTML=`
    <h3>ثبت نمره جدید</h3>
    <div id="modal-graded-pills" class="category-pills"></div>
    <div class="input-group" style="margin-top: 15px; display: flex; gap: 10px;">
        <input type="number" id="modal-new-score-value" placeholder="نمره" style="width: 70px; text-align: center;">
        <input type="text" id="modal-new-score-comment" placeholder="توضیحات (اختیاری)..." style="flex-grow: 1;">
    </div>
    <button id="modal-add-score-btn" class="btn-success" style="width: 100%; margin-top: 10px;">ثبت نمره</button>
`,_a(a.querySelector("#modal-new-score-comment"));const t=a.querySelector("#modal-graded-pills");we(A.categories).filter(n=>n.isGradedCategory).forEach(n=>{const i=document.createElement("span");i.className="pill",i.textContent=n.name,i.dataset.skillName=n.name,i.addEventListener("click",()=>{t.querySelectorAll(".pill").forEach(s=>s.classList.remove("active")),i.classList.add("active")}),t.appendChild(i)}),a.querySelector("#modal-add-score-btn").addEventListener("click",()=>{const n=t.querySelector(".pill.active");if(!n){G("⚠️لطفاً یک مهارت را برای نمره‌دهی انتخاب کنید.");return}const i=n.dataset.skillName,s=a.querySelector("#modal-new-score-value"),r=a.querySelector("#modal-new-score-comment"),l=s.value,f=r.value.trim();if(!l){G("لطفاً مقدار نمره را وارد کنید.");return}_e.addScore(i,parseFloat(l),f),oe(),ke(A.info.name,`نمره ${l} در ${i} برای «${_e.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:_e.identity.studentId}),Oe(),$e(),s.value="",r.value="";const p=document.getElementById("modal-profile-content-container"),h=p.querySelector(".history-section");h&&h.remove(),Ki(p),G(`✅ نمره برای مهارت ${i} با موفقیت ثبت شد.`)}),e.appendChild(a)}function Ki(e){if(!_e)return;const a=document.createElement("div");a.className="history-section";const t=document.createElement("div");t.className="history-section-header";const c=document.createElement("h3");c.textContent="سوابق دانش‌آموز",t.appendChild(c),a.appendChild(t),Pr(a),Yi(a),Xi(a),e.appendChild(a)}function Pr(e){if(!_e)return;const a=_e,t=A.sessions.reduce((k,_)=>{const x=_.studentRecords[a.identity.studentId];return k+(x&&x.attendance==="absent"?1:0)},0),c=Object.values(a.categoryIssues||{}).reduce((k,_)=>k+_,0);let o=0,n=0,i=0;const s=a.qualitativeStats||{};Object.values(s).forEach(k=>{o+=k.effort||0,n+=k.good||0,i+=k.excellent||0});const r=o+n+i,l=document.createElement("div");l.className="stats-summary-box",l.innerHTML=`
        <p><strong>کل انتخاب:</strong> ${a.statusCounters.totalSelections}</p>
        <p><strong>غیبت:</strong> ${t}</p>
        <p><strong>فرصت از دست رفته:</strong> ${a.statusCounters.missedChances||0}</p>
        <p><strong>مشکل:</strong> ${c}</p>
        <p><strong>عملکرد کیفی:</strong> ${r}</p>
    `,e.appendChild(l),l.querySelector("p:nth-child(1)");const f=l.querySelector("p:nth-child(4)"),p=l.querySelector("p:nth-child(5)");e.appendChild(l);const h=we(A.categories),m=document.createElement("div");if(m.className="stats-breakdown",h.length>0){h.forEach(_=>{var M;const x=_.name,L=((M=a.categoryCounts)==null?void 0:M[x])||0,D=document.createElement("p");D.className="stats-breakdown-item",D.innerHTML=`<strong>${x}:</strong> ${L}`,m.appendChild(D)});const k=l.querySelector("p:first-child");k&&(k.classList.add("collapsible-toggle"),k.onclick=()=>{m.classList.toggle("open"),k.classList.toggle("open")},k.after(m))}const y=document.createElement("div");y.className="stats-breakdown",h.length>0&&(h.forEach(k=>{var D;const _=k.name,x=((D=a.categoryIssues)==null?void 0:D[_])||0,L=document.createElement("p");L.className="stats-breakdown-item",L.innerHTML=`<strong>${_}:</strong> ${x}`,y.appendChild(L)}),f&&c>0&&(f.classList.add("collapsible-toggle"),f.onclick=()=>{y.classList.toggle("open"),f.classList.toggle("open")},f.after(y)));const u=document.createElement("div");if(u.className="stats-breakdown",r>0){for(const k in s){const _=s[k];if((_.effort||0)+(_.good||0)+(_.excellent||0)>0){const L=document.createElement("p");L.className="stats-breakdown-item",L.innerHTML=`<strong>${k}:</strong> <span style="color:var(--color-primary)">عالی:${_.excellent}</span> | <span style="color:var(--color-success)">خوب:${_.good}</span> | <span style="color:#fd7e14">تلاش:${_.effort}</span>`,u.appendChild(L)}}p&&r>0&&(p.classList.add("collapsible-toggle"),p.onclick=()=>{u.classList.toggle("open"),p.classList.toggle("open")},p.after(u))}const v=document.createElement("p"),b=document.createElement("strong");b.textContent="تکالیف ناقص:";const C=document.createElement("span");C.style.marginRight="5px";const S=rt(A);Fn(a,S,C,{includePrefix:!1}),v.appendChild(b),v.appendChild(C),l.appendChild(v)}function Yi(e){if(!_e)return;const a=_e,t=document.createElement("h4");t.textContent="تاریخچه نمرات:",t.style.marginTop="20px";const c=a.getOverallAverageScore(),o=document.createElement("span");o.className="profile-avg-badge",o.textContent=` (میانگین: ${c!==null?c:"-"})`,t.appendChild(o);const n=A.calculateFinalStudentScore(a),i=document.createElement("span");i.className="profile-avg-badge",i.textContent=` (نمره نهایی: ${n!==null?n:"-"})`,t.appendChild(i);const s=document.createElement("ul");s.className="list-container";const r=Object.values(a.logs.scores||{}).flat().filter(l=>!l.isDeleted).sort((l,f)=>new Date(f.timestamp)-new Date(l.timestamp));r.length===0?s.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>':r.forEach(l=>{const f=document.createElement("li");f.className="score-history-item";const p=document.createElement("div");p.className="item-content";const h=document.createElement("div");h.className="score-info";const m=document.createElement("span");m.className="score-skill-badge",m.textContent=l.skill;const y=document.createElement("span");y.className="score-value",y.textContent=`نمره: ${l.value}`;const u=document.createElement("span");if(u.className="score-date",u.textContent=new Date(l.timestamp).toLocaleDateString("fa-IR"),h.appendChild(m),h.appendChild(y),h.appendChild(u),p.appendChild(h),l.comment){const b=document.createElement("p");b.className="score-comment",b.innerHTML=ha(l.comment),b.addEventListener("click",()=>{Ee.value=l.comment,Ee.dispatchEvent(new Event("input",{bubbles:!0})),dt(C=>{l.comment=C,oe(),ke(A.info.name,`توضیحات نمره ${l.value} (${l.skill}) برای دانش‌آموز «${a.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:a.identity.studentId}),Fe(a),G("✅ توضیحات نمره با موفقیت ویرایش شد.")}),ge(()=>{Ae("add-note-modal"),Ee.focus()})}),p.appendChild(b)}const v=document.createElement("button");v.className="btn-icon delete-item-btn",v.innerHTML="🗑️",v.title="حذف این نمره",v.addEventListener("click",()=>{ge(()=>{be(`آیا از انتقال نمره ${l.value} در مهارت «${l.skill}» به سطل زباله مطمئن هستید؟`,()=>{const b={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"score",description:`نمره ${l.value} (${l.skill}) برای «${a.identity.name}»`,restoreData:{scoreId:l.id,skill:l.skill,studentId:a.identity.studentId,classId:A.info.scheduleCode}};lt(b),l.isDeleted=!0,oe(),ke(A.info.name,`نمره ${l.value} (${l.skill}) دانش‌آموز «${a.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),Fe(a),G("✅ نمره به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{Fe(a)}})})}),f.appendChild(p),f.appendChild(v),s.appendChild(f)}),e.appendChild(t),e.appendChild(s)}function Xi(e){if(!_e)return;const a=document.createElement("h4");a.textContent="تاریخچه یادداشت‌ها:",a.style.marginTop="20px";const t=document.createElement("ul");t.className="list-container",!_e.profile.notes||_e.profile.notes.length===0?t.innerHTML='<div class="no-content-message">هنوز یادداشتی ثبت نشده است.</div>':[..._e.profile.notes].filter(o=>!o.isDeleted).sort((o,n)=>new Date(n.timestamp)-new Date(o.timestamp)).forEach(o=>{const n=document.createElement("li");n.className="note-history-item";const i=document.createElement("div");i.className="item-content";const s=document.createElement("div");s.className="note-info";const r=document.createElement("span");r.className="note-date",r.textContent=new Date(o.timestamp).toLocaleDateString("fa-IR");const l=document.createElement("button");l.className="btn-icon delete-item-btn",l.innerHTML="🗑️",l.title="حذف این یادداشت",l.addEventListener("click",()=>{const p=_e;ge(()=>{be("آیا از انتقال این یادداشت به سطل زباله مطمئن هستید؟",()=>{const h={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"note",description:`یادداشت برای دانش‌آموز «${p.identity.name}»`,restoreData:{noteId:o.id,studentId:p.identity.studentId,classId:A.info.scheduleCode}};lt(h),o.isDeleted=!0,ke(A.info.name,`یادداشت دانش‌آموز «${p.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),Fe(p),G("✅ یادداشت به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{Fe(p)}})})}),s.appendChild(r),s.appendChild(l);const f=document.createElement("p");f.className="note-content",f.innerHTML=ha(o.content),f.addEventListener("click",()=>{const p=_e;Ee.value=o.content,Ee.dispatchEvent(new Event("input",{bubbles:!0})),dt(h=>{o.content=h,oe(),ke(A.info.name,`یادداشت دانش‌آموز «${p.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:p.identity.studentId}),Fe(p),G("✅یادداشت با موفقیت ویرایش شد.")}),ge(()=>{Ae("add-note-modal"),Ee.focus()})}),i.appendChild(s),i.appendChild(f),n.appendChild(i),t.appendChild(n)}),e.appendChild(a),e.appendChild(t)}function Qi(e){Ms.innerHTML="",e.forEach((a,t)=>{const c=document.createElement("option");c.value=t,c.textContent=a.trim(),Ms.appendChild(c)})}function qs(){Os.innerHTML="",Js.forEach(e=>{const a=document.createElement("li");a.className="preview-item";const t=document.createElement("input");t.type="checkbox",t.checked=!0,t.dataset.name=e;const c=document.createElement("label");c.textContent=e,a.appendChild(t),a.appendChild(c),Os.appendChild(a)})}function Fr(e){const a=document.createElement("div");a.className="list-item-buttons";const t=document.createElement("button");return t.className="btn-icon",t.innerHTML="📝",t.title="ویرایش یادداشت کلاس",e.note||(t.style.display="none"),t.addEventListener("click",c=>{c.stopPropagation(),hs(e)}),a.appendChild(t),a}function Hr(e){const a=document.createElement("div");a.style.flexGrow="1",a.style.display="flex",a.style.flexDirection="column",a.style.alignItems="flex-start";const t=document.createElement("span");t.textContent=e.info.name,t.classList.add("class-name-display"),a.appendChild(t);const c=we(e.students).length,o=we(e.sessions).filter(l=>l.isFinished).length,n=Jr(e.info.scheduleDays),i=document.createElement("div");i.classList.add("class-stats-row");const s=document.createElement("span");s.textContent=`${c} نفر`,s.classList.add("student-count-badge"),i.appendChild(s);const r=document.createElement("span");if(r.textContent=`${o} جلسه`,r.classList.add("session-count-badge"),i.appendChild(r),n){const l=document.createElement("span");l.textContent=n,l.classList.add("schedule-days-badge"),i.appendChild(l)}return a.appendChild(i),a.addEventListener("click",()=>{qe(e),Ke(null),hn(A.liveSession),Ge(),ye("session-page")}),a}function Wr(e){const a=document.createElement("li");cs(e).type==="active"&&(a.classList.add("active-class-card"),a.title="این کلاس هم‌اکنون در حال برگزاری است");const c=document.createElement("input");c.type="checkbox",c.className="mass-selection-checkbox",c.checked=it.includes(e.info.name),c.addEventListener("click",f=>{f.stopPropagation()}),c.addEventListener("change",()=>{const f=e.info.name;if(c.checked)it.includes(f)||it.push(f);else{const p=it.indexOf(f);p>-1&&it.splice(p,1)}}),a.appendChild(c);const o=Hr(e);a.appendChild(o);const n=document.createElement("div");n.style.display="flex",n.style.flexDirection="column",n.style.gap="5px",n.style.alignItems="flex-end",n.style.marginLeft="10px";const i=document.createElement("div");if(i.className="list-item-badges",e.liveSession&&!e.liveSession.isCancelled&&!e.liveSession.isDeleted){const f=document.createElement("span");f.className="warning-badge",f.textContent="جلسه باز",i.appendChild(f),a.classList.add("has-unfinished-session")}const s=document.createElement("span");if(s.className=`type-badge ${e.info.type}`,s.textContent=e.info.type==="online"?"آنلاین":"حضوری",s.title="نوع کلاس",i.appendChild(s),cs(e).type==="incomplete"){const f=document.createElement("span");f.className="type-badge cancelled-badge",f.textContent="زمان‌بندی ناقص",f.style.cursor="pointer",f.title="برای تکمیل زمان‌بندی کلیک کنید",f.addEventListener("click",p=>{p.stopPropagation(),be("زمان‌بندی این کلاس کامل نیست. برای نمایش صحیح در لیست، لطفاً روزها و ساعت برگزاری را مشخص کنید.",()=>{kt(e)},{confirmText:"تنظیمات",confirmClass:"btn-primary"})}),i.appendChild(f)}else{const f=Vr(e,ie);if(f){const p=document.createElement("span");p.className="type-badge conflict-badge",p.textContent="تداخل زمانی",p.style.cursor="pointer",p.title=`تداخل با کلاس: ${f}`,p.addEventListener("click",h=>{h.stopPropagation(),be(`زمان برگزاری این کلاس با کلاس «${f}» تداخل دارد. لطفاً زمان‌بندی را بررسی کنید.`,()=>{kt(e)},{confirmText:"تنظیمات",confirmClass:"btn-primary"})}),i.appendChild(p)}}n.appendChild(i);const l=Fr(e);return n.appendChild(l),a.appendChild(n),a.addEventListener("contextmenu",f=>{const p={label:"پشتیبان‌گیری از این کلاس",icon:"📤",action:()=>{bn([e.info.name])}},h=it.length;h>1&&it.includes(e.info.name)&&(p.label=`پشتیبان‌گیری از ${h} کلاس`,p.action=()=>{bn(it),On([]),We()});const m={label:"حذف کلاس",icon:"🗑️",className:"danger",action:()=>{be(`آیا از انتقال کلاس «${e.info.name}» به سطل زباله مطمئن هستید؟`,()=>{const u={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"classroom",description:`کلاس «${e.info.name}»`,restoreData:{name:e.info.name}};lt(u),e.isDeleted=!0,ke(e.info.name,`کلاس «${e.info.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),We(),G(`✅ کلاس «${e.info.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}};h>1&&it.includes(e.info.name)&&(m.label=`حذف ${h} کلاس`,m.action=()=>{be(`آیا از انتقال ${h} کلاس انتخاب شده به سطل زباله مطمئن هستید؟`,()=>{it.forEach(u=>{const v=ie[u];if(v&&!v.isDeleted){const b={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"classroom",description:`کلاس «${v.info.name}»`,restoreData:{name:v.info.name}};lt(b),v.isDeleted=!0,ke(v.info.name,`کلاس «${v.info.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"})}}),On([]),oe(),We(),G(`✅ ${h} کلاس به سطل زباله منتقل شدند.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})});const y=[{label:"چاپ گزارش کلاس",icon:"🖨️",action:()=>{Yr(e)}},{label:Dt.classList.contains("selection-mode-active")?"لغو انتخاب":"انتخاب چند کلاس",icon:"✔️",action:()=>{const u=Dt.classList.contains("selection-mode-active");Dt.classList.toggle("selection-mode-active"),u&&(On([]),We())}},p,{label:"یادداشت کلاس",icon:"📝",action:()=>{hs(e)}},{label:"تنظیمات کلاس",icon:"⚙️",action:()=>{kt(e)}},{label:"گزارش فعالیت‌ها",icon:"📋",action:()=>{Gi(e.info.name)}},{label:"تغییر نام",icon:"✏️",action:()=>{const u=e.info.name,v=document.getElementById("add-note-modal-title");v.textContent="تغییر نام کلاس",Ee.value=u,Ee.rows=1,dt(b=>{const C=b.trim();if(C&&C!==u){const S=ni(u,C);S.success?(xo(u,C),ke(C,`نام کلاس از «${u}» به «${C}» تغییر یافت.`,{type:"VIEW_SESSIONS"}),oe(),We(),G(`✅نام کلاس به «${C}» تغییر یافت.`)):G(S.message)}v.textContent="ثبت یادداشت جدید",Ee.rows=4}),Ae("add-note-modal"),Ee.focus(),Ee.select()}},m];Sn(f,y)}),a}function ps(){const e=document.getElementById("class-management-stats");if(!e)return;const a=Object.values(ie).filter(n=>!n.isDeleted),t=a.length,c=a.reduce((n,i)=>n+we(i.students).length,0);let o="";Pe.lastBackupTimestamp&&(o=`
            <div class="stats-row backup-stat">
                <span>آخرین پشتیبان: <strong>${new Date(Pe.lastBackupTimestamp).toLocaleString("fa-IR",{year:"numeric",month:"numeric",day:"numeric",weekday:"long",hour:"2-digit",minute:"2-digit"})}</strong></span>
            </div>
        `),e.innerHTML=`
        <div class="stats-row main-stats">
            <span>کل کلاس‌ها: <strong>${t}</strong></span>
            <span>|</span>
            <span>کل دانش‌آموزان: <strong>${c}</strong></span>
        </div>
        ${o} 
    `}function We(){ps(),Dt.innerHTML="";const e=Object.values(ie).filter(o=>!o.isDeleted),a=document.querySelector(".fab-container"),t=document.querySelector(".global-search-container");if(e.length===0){a&&a.classList.add("center-empty-state"),t&&(t.style.display="none"),Dt.innerHTML='<li class="no-content-message" style="text-align:center; margin-top:20px;">هنوز کلاسی ایجاد نشده است.</li>';return}else a&&a.classList.remove("center-empty-state"),t&&(t.style.display="");e.sort((o,n)=>{const i=cs(o),s=cs(n);return i.sortIndex!==s.sortIndex?i.sortIndex-s.sortIndex:i.type==="upcoming"?i.nextTimestamp-s.nextTimestamp:new Date(o.info.creationDate)-new Date(n.info.creationDate)}).forEach(o=>{const n=Wr(o);Dt.appendChild(n)})}function _t(){if(!A)return;Ns.innerHTML="";const e=we(A.students);En(e).forEach(t=>{const c=document.createElement("li");c.dataset.studentId=t.identity.studentId;const o=document.createElement("span");o.className="student-name-link",o.style.flexGrow="1",t.identity.firstName&&t.identity.lastName?o.textContent=`${t.identity.lastName}، ${t.identity.firstName}`:o.textContent=t.identity.name,o.addEventListener("click",()=>{Fe(t)}),c.addEventListener("contextmenu",n=>{Sn(n,[{label:"تغییر نام",icon:"✏️",action:()=>{wa(t,A)}},{label:"انتقال دانش‌آموز",icon:"➡️",action:()=>{Ca(t,A)}},{label:"حذف دانش‌آموز",icon:"🗑️",className:"danger",action:()=>{be(`آیا از انتقال دانش‌آموز «${t.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const s={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${t.identity.name}» از کلاس «${A.info.name}»`,restoreData:{studentId:t.identity.studentId,classId:A.info.scheduleCode}};lt(s),t.isDeleted=!0,ke(A.info.name,`دانش‌آموز «${t.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),_t(),Oe(),nt(),G(`✅ دانش‌آموز «${t.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}}])}),c.appendChild(o),Ns.appendChild(c)})}function Qt(){if(As.innerHTML="",!A)return;A.categories.filter(a=>!a.isDeleted).forEach(a=>{const t=document.createElement("li"),c=document.createElement("div");c.className="name-and-badge-container";const o=document.createElement("span");if(o.textContent=a.name,c.appendChild(o),a.isGradedCategory){const i=document.createElement("span");i.className="category-badge",i.textContent="نمره‌دار",c.appendChild(i)}if(a.isGradedCategory){const i=document.createElement("span");i.className="category-badge weight-badge",i.textContent=`ضریب: ${a.weight||1}`,c.appendChild(i)}const n=document.createElement("button");n.className="btn-icon",n.innerHTML="🗑️",n.style.color="var(--color-warning)",n.addEventListener("click",()=>{be(`آیا از انتقال دسته‌بندی «${a.name}» به سطل زباله مطمئن هستید؟`,()=>{const i={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${a.name}» از کلاس «${A.info.name}»`,restoreData:{categoryId:a.id,classId:A.info.scheduleCode}};lt(i),a.isDeleted=!0,ke(A.info.name,`دسته‌بندی «${a.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),Qt(),G(`✅ دسته‌بندی «${a.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}),t.appendChild(c),t.appendChild(n),As.appendChild(t)})}function eo(){if(!A)return;const e=A;xa(Pn,on,e.info.educationalSystem,e.info.level),Pn.addEventListener("change",()=>{e.info.educationalSystem=Pn.value,e.info.level=on.value,oe()}),on.addEventListener("change",()=>{e.info.level=on.value,oe()});const a=e.info.type||"in-person",t=document.querySelector(`#settings-page input[name="class-type-setting"][value="${a}"]`);t&&(t.checked=!0);const c=e.info.scheduleDays||[];document.querySelectorAll('input[name="schedule-day"]').forEach(o=>{o.checked=c.includes(parseInt(o.value))}),document.getElementById("settings-schedule-start").value=e.info.scheduleStartTime||"",document.getElementById("settings-schedule-end").value=e.info.scheduleEndTime||""}function fn(e){document.querySelectorAll(".page").forEach(t=>{t.classList.remove("active")});const a=document.getElementById(e);a&&a.classList.add("active"),e==="class-management-page"?(qe(null),Ke(null),Qe(null),We(),Rs.style.display="flex"):Rs.style.display="none",Vi()}function ye(e,a={}){const{tab:t}=a,c={pageId:e,currentClassName:A?A.info.name:null,selectedSessionNumber:Y?Y.sessionNumber:null,selectedStudentId:_e?_e.identity.studentId:null};let o=`#${e}`;const n=new URLSearchParams(window.location.hash.split("?")[1]||"");A?n.set("class",A.info.name):n.delete("class"),Y?n.set("session",Y.sessionNumber):n.delete("session"),_e?n.set("student",_e.identity.studentId):n.delete("student"),e==="session-dashboard-page"&&t?n.set("tab",t):e!=="session-dashboard-page"&&n.delete("tab");const i=n.toString();i&&(o+=`?${i}`),window.location.hash!==o&&history.pushState(c,"",o),fn(e)}function Ur(e,a){const t=document.createElement("div");t.className="list-item-buttons",t.style.gap="10px";const c=document.createElement("button");if(c.className="btn-icon",c.innerHTML="📝",c.title="ویرایش یادداشت جلسه",e.note||(c.style.display="none"),c.addEventListener("click",o=>{o.stopPropagation(),ka(e,a)}),!e.isFinished&&!e.isCancelled){const o=document.createElement("button");o.className="btn-success",o.textContent="پایان جلسه",o.style.fontSize="12px",o.style.padding="4px 10px",o.style.whiteSpace="nowrap",o.addEventListener("click",n=>{n.stopPropagation(),be(`جلسه شماره ${a} خاتمه پیدا خواهد کرد!`,()=>{A.endSpecificSession(e.sessionNumber),oe(),ke(A.info.name,`جلسه ${a} خاتمه یافت.`,{type:"VIEW_SESSIONS"}),Ge(),be("جلسه با موفقیت خاتمه یافت. آیا مایل به ایجاد فایل پشتیبان هستید؟",()=>{if(mt){G("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است.");return}bn(),G("✅فایل پشتیبان با موفقیت ایجاد شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}),t.appendChild(o)}return t.appendChild(c),t}function jr(e,a){const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="flex-start",t.style.flexGrow="1";const c=new Date(e.startTime).toLocaleDateString("fa-IR"),o=document.createElement("span");o.className="session-list-title";const n=document.createElement("div");n.style.display="flex",n.style.gap="5px",n.style.marginTop="5px";const i=new Date(e.startTime).toLocaleDateString("fa-IR",{weekday:"long"}),s=document.createElement("span");if(s.className="type-badge day-badge",s.textContent=i,n.appendChild(s),e.isCancelled){o.textContent=`لغو شده - تاریخ: ${c}`,t.style.cursor="default";const r=document.createElement("span");r.className="type-badge cancelled-badge",r.textContent="لغو شده",n.appendChild(r)}else o.textContent=`جلسه ${a} - تاریخ: ${c}`,t.style.cursor="pointer",t.addEventListener("click",()=>{Ke(e),Kt()});if(t.appendChild(o),e.isFinished){const r=document.createElement("span");r.className="type-badge finished-badge",r.textContent="خاتمه یافته",n.appendChild(r)}if(e.isMakeup){const r=document.createElement("span");r.className="type-badge makeup-badge",r.textContent="جبرانی",n.appendChild(r)}return t.appendChild(n),t}function qr(e,a){const t=document.createElement("li"),c=a.get(e.sessionNumber),o=jr(e,c);t.appendChild(o);const n=Ur(e,c);return t.appendChild(n),t.addEventListener("contextmenu",i=>{const s=[{label:"یادداشت جلسه",icon:"📝",action:()=>{ka(e,c)}},{label:e.isCancelled?"بازگردانی جلسه":"لغو جلسه",icon:"❌",action:()=>{const r=e.isCancelled?"بازگردانی جلسه":"لغو جلسه",l=e.isCancelled?"آیا از بازگردانی این جلسه مطمئن هستید؟":"آیا از لغو این جلسه مطمئن هستید؟ جلسه لغو شده در آمار تاثیری ندارد اما قابل بازگردانی است.";be(l,()=>{e.isCancelled=!e.isCancelled;const f=e.isCancelled?`جلسه ${c} لغو شد.`:`جلسه لغو شده (تاریخ: ${new Date(e.startTime).toLocaleDateString("fa-IR")}) بازگردانی شد.`;ke(A.info.name,f,{type:"VIEW_SESSIONS"}),oe(),Ge(),G(e.isCancelled?"✅جلسه لغو شد.":"✅جلسه بازگردانی شد.")},{confirmText:r,confirmClass:"btn-warning"})}},{label:"تغییر وضعیت جبرانی",icon:"🔄",action:()=>{A.markAsMakeup(e.sessionNumber),oe();const r=e.isMakeup?`جلسه ${c} به عنوان جبرانی علامت‌گذاری شد.`:`جلسه ${c} از حالت جبرانی خارج شد.`;ke(A.info.name,r,{type:"VIEW_SESSIONS"}),Ge()}},{label:"حذف جلسه",icon:"🗑️",className:"danger",action:()=>{const r=e.isCancelled?"لغو شده":c;be(`آیا از انتقال جلسه ${r} به سطل زباله مطمئن هستید؟`,()=>{const l={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"session",description:`جلسه ${r} از کلاس «${A.info.name}»`,restoreData:{sessionNumber:e.sessionNumber,classId:A.info.scheduleCode}};lt(l),e.isDeleted=!0,ke(A.info.name,`جلسه ${r} به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),oe(),Ge(),G(`✅ جلسه ${r} به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}},{label:"تغییر تاریخ",icon:"📅",action:()=>{const r=document.getElementById("dp-day"),l=document.getElementById("dp-month"),f=document.getElementById("dp-year"),p=za.toJalaali(e.startTime);r.innerHTML="";for(let y=1;y<=31;y++){const u=document.createElement("option");u.value=y,u.textContent=y.toLocaleString("fa-IR"),y===p.jd&&(u.selected=!0),r.appendChild(u)}const h=["فروردین","اردیبهشت","خرداد","تیر","مرداد","شهریور","مهر","آبان","آذر","دی","بهمن","اسفند"];l.innerHTML="",h.forEach((y,u)=>{const v=document.createElement("option");v.value=u+1,v.textContent=y,u+1===p.jm&&(v.selected=!0),l.appendChild(v)}),f.innerHTML="";const m=p.jy;for(let y=m-5;y<=m+5;y++){const u=document.createElement("option");u.value=y,u.textContent=y.toString().replace(/\d/g,v=>"۰۱۲۳۴۵۶۷۸۹"[v]),y===p.jy&&(u.selected=!0),f.appendChild(u)}es(y=>{if(!y)return;const u=za.toGregorian(parseInt(y.jy),parseInt(y.jm),parseInt(y.jd)),v=new Date(u.gy,u.gm-1,u.gd);v.setHours(e.startTime.getHours()),v.setMinutes(e.startTime.getMinutes()),v.setSeconds(e.startTime.getSeconds());const b=e.startTime.toLocaleDateString("fa-IR");e.startTime=v;const C=e.startTime.toLocaleDateString("fa-IR");ke(A.info.name,`تاریخ جلسه ${c} از ${b} به ${C} تغییر یافت.`,{type:"VIEW_SESSIONS"}),oe(),Ge(),G(`✅ تاریخ جلسه به ${C} تغییر یافت.`)}),Ae("date-picker-modal")}}];Sn(i,s)}),t}function Ge(){const e=document.getElementById("session-list");if(!A)return;if(e.innerHTML="",A.sessions.length===0){e.innerHTML="<li>هنوز جلسه‌ای شروع نشده است.</li>";return}const a=rt(A);[...we(A.sessions)].reverse().forEach(c=>{const o=qr(c,a);e.appendChild(o)})}function cn(e){if(Ct.innerHTML="",e.length>0)e.forEach(a=>{const t=document.createElement("div");t.textContent=a.identity.name,t.addEventListener("click",()=>{Fe(a),Ct.style.display="none",Ps.value=""}),Ct.appendChild(t)}),Ct.style.display="block";else if(Ps.value.trim()!==""){const a=document.createElement("div");a.className="no-results",a.textContent="پیدا نشد",Ct.appendChild(a),Ct.style.display="block"}else Ct.style.display="none"}function Wn(e){if(ft.innerHTML="",e.length>0)e.forEach(a=>{const t=document.createElement("div");if(t.className="global-search-result",a.type==="student"){const c=document.createElement("span");c.className="student-name",c.textContent=a.student.identity.name;const o=document.createElement("span");o.className="class-name",o.textContent=`کلاس: ${a.classroom.info.name}`,t.addEventListener("click",()=>{qe(a.classroom),Fe(a.student),ft.style.display="none",an.value=""}),o.addEventListener("click",n=>{n.stopPropagation(),qe(a.classroom),Ke(null),hn(a.classroom.liveSession),Ge(),ye("session-page"),ft.style.display="none",an.value=""}),t.appendChild(c),t.appendChild(o)}else if(a.type==="classroom"){const c=document.createElement("span");c.className="student-name",c.textContent=`[کلاس] ${a.classroom.info.name}`,t.addEventListener("click",()=>{qe(a.classroom),Ke(null),hn(a.classroom.liveSession),Ge(),ye("session-page"),ft.style.display="none",an.value=""}),t.appendChild(c)}ft.appendChild(t)}),ft.style.display="block";else if(an.value.trim()!==""){const a=document.createElement("div");a.className="no-results",a.textContent="پیدا نشد",ft.appendChild(a),ft.style.display="block"}else ft.style.display="none"}function wn(){const e=document.getElementById("trashed-items-list");if(e.innerHTML="",Ze.length===0){e.innerHTML='<li style="text-align: center; padding: 20px;">سطل زباله خالی است.</li>';return}Ze.forEach((a,t)=>{const c=document.createElement("li"),o=document.createElement("span");o.textContent=a.description,o.style.flexGrow="1";const n=document.createElement("div");n.className="list-item-buttons";const i=document.createElement("button");i.className="btn-icon",i.innerHTML="🔄",i.title="بازیابی",i.addEventListener("click",()=>{var p;let r=!1,l=null;const f=a.restoreData;switch(a.type){case"classroom":{const h=ie[f.name];h&&!h.isDeleted?l=`کلاسی با نام «${f.name}» از قبل فعال است.`:h&&h.isDeleted&&(h.isDeleted=!1,r=!0);break}case"student":{const h=Object.values(ie).find(y=>y.info.scheduleCode===f.classId),m=h==null?void 0:h.students.find(y=>y.identity.studentId===f.studentId);m&&(m.isDeleted=!1,r=!0);break}case"session":{const h=Object.values(ie).find(y=>y.info.scheduleCode===f.classId),m=h==null?void 0:h.sessions.find(y=>y.sessionNumber===f.sessionNumber);m&&(m.isDeleted=!1,r=!0);break}case"category":{const h=Object.values(ie).find(y=>y.info.scheduleCode===f.classId),m=h==null?void 0:h.categories.find(y=>y.id===f.categoryId);m&&(m.isDeleted=!1,r=!0);break}case"score":{const h=Object.values(ie).find(u=>u.info.scheduleCode===f.classId),m=h==null?void 0:h.students.find(u=>u.identity.studentId===f.studentId),y=(p=m==null?void 0:m.logs.scores[f.skill.toLowerCase()])==null?void 0:p.find(u=>u.id===f.scoreId);y&&(y.isDeleted=!1,r=!0);break}case"note":{const h=Object.values(ie).find(u=>u.info.scheduleCode===f.classId),m=h==null?void 0:h.students.find(u=>u.identity.studentId===f.studentId),y=m==null?void 0:m.profile.notes.find(u=>u.id===f.noteId);y&&(y.isDeleted=!1,r=!0);break}}r?(Ze.splice(t,1),oe(),wn(),a.type==="classroom"&&We(),G("✅ آیتم با موفقیت بازیابی شد.")):G(l?`⚠️ ${l}`:"⚠️ آیتم اصلی برای بازیابی یافت نشد.")});const s=document.createElement("button");s.className="btn-icon",s.innerHTML="🔥",s.title="حذف دائمی",s.addEventListener("click",()=>{be("آیا از حذف دائمی این آیتم مطمئن هستید؟ این عمل غیرقابل بازgشت است.",()=>{const r=a.restoreData,l=p=>Object.values(ie).find(h=>h.info.scheduleCode===p);let f;switch(a.type){case"classroom":delete ie[r.name];break;case"student":f=l(r.classId),ds({identity:{studentId:r.studentId}},f);break;case"session":f=l(r.classId),f&&sa(f.info.name,r.sessionNumber);break;case"category":f=l(r.classId),f&&aa(f.info.name,r.categoryId);break;case"score":f=l(r.classId),f&&ia(f.info.name,r.studentId,r.skill,r.scoreId);break;case"note":f=l(r.classId),f&&oa(f.info.name,r.studentId,r.noteId);break}Ze.splice(t,1),oe(),wn(),G("✅ آیتم برای همیشه حذف شد.")},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),n.appendChild(i),n.appendChild(s),c.appendChild(o),c.appendChild(n),e.appendChild(c)})}function Zr(){const e=document.getElementById("absentees-summary-container");e&&(e.innerHTML=`
        <div id="absentees-summary-box" class="absentees-summary">
            <div class="absentees-summary-header">
                <h4>لیست غایبین جلسه شماره <span id="absentee-summary-session-number"></span></h4>
                <button id="copy-absentees-btn" class="btn-icon" title="کپی لیست غایبین">📋</button>
            </div>
            <div id="absentees-summary-list" class="summary-list"></div>
            <div class="attendance-counters">
                <span>تعداد حاضرین: <strong id="present-count">0</strong></span>
                <span>تعداد غایبین: <strong id="absent-count">0</strong></span>
            </div>
        </div>
    `)}function to(){const e=document.getElementById("absentees-summary-box"),a=document.getElementById("absentees-summary-list"),t=document.getElementById("absentee-summary-session-number");if(!e||!a||!t){console.error("Could not find all absentee summary elements.");return}if(!A||!Y){e.classList.remove("visible");return}const c=we(A.students).filter(f=>{const p=Y.studentRecords[f.identity.studentId];return p&&p.attendance==="absent"}),o=we(A.students),n=c.length,i=o.length-n,s=document.getElementById("present-count"),r=document.getElementById("absent-count");s&&(s.textContent=i.toLocaleString("fa-IR")),r&&(r.textContent=n.toLocaleString("fa-IR"));const l=rt(A);t.textContent=l.get(Y.sessionNumber),c.length>0?e.classList.add("visible"):e.classList.remove("visible"),a.innerHTML="",c.forEach(f=>{const h=(y=>A.sessions.reduce((u,v)=>{if(v.isDeleted||v.isCancelled)return u;const b=v.studentRecords[y.identity.studentId];return u+(b&&b.attendance==="absent"?1:0)},0))(f),m=document.createElement("span");m.className="summary-name",m.textContent=`${f.identity.name} (غیبت: ${h})`,m.addEventListener("click",()=>{m.classList.add("fading-out"),setTimeout(()=>{Y.setAttendance(f.identity.studentId,"present"),oe(),nt()},200)}),a.appendChild(m)})}function Gr(){const e=document.getElementById("copy-absentees-btn");if(!e){console.error("Could not find the copy absentees button to attach listener.");return}e.addEventListener("click",()=>{if(!A||!Y)return;const a=we(A.students).filter(s=>{const r=Y.studentRecords[s.identity.studentId];return r&&r.attendance==="absent"});if(a.length===0){G("⚠️لیست غایبین خالی است.");return}const t=s=>A.sessions.reduce((r,l)=>{if(l.isDeleted||l.isCancelled)return r;const f=l.studentRecords[s.identity.studentId];return r+(f&&f.attendance==="absent"?1:0)},0),c=we(A.students),o=a.length,n=c.length-o;let i=`گزارش حضور و غیاب جلسه شماره ${Mr()}:
`;i+=`✅ حاضرین: ${n.toLocaleString("fa-IR")}
`,i+=`❌ غایبین: ${o.toLocaleString("fa-IR")}

`,i+=`لیست اسامی غایبین:
`,a.forEach(s=>{const r=t(s);i+=`- ${s.identity.name} (تعداد غیبت‌ها: ${r})
`}),navigator.clipboard.writeText(i).then(()=>{G("✅لیست غایبین با موفقیت کپی شد.")}).catch(s=>{console.error("Failed to copy text: ",s),G("❌خطا در کپی کردن لیست.")})})}function Un(){const e=document.getElementById("demo-mode-banner");e&&(mt?(e.classList.add("visible"),document.body.classList.add("demo-mode-active")):(e.classList.remove("visible"),document.body.classList.remove("demo-mode-active")))}function cs(e){const{scheduleDays:a,scheduleStartTime:t,scheduleEndTime:c}=e.info,o=a&&a.length>0,n=t&&c;if(!o&&!n)return{type:"unscheduled",sortIndex:3};if(!o||!n)return{type:"incomplete",sortIndex:2};const i=new Date,s=i.getDay(),r=i.getHours()*60+i.getMinutes(),[l,f]=t.split(":").map(Number),[p,h]=c.split(":").map(Number),m=l*60+f,y=p*60+h;if(a.includes(s)&&r>=m&&r<y)return{type:"active",sortIndex:0};for(let u=0;u<=7;u++){const v=(s+u)%7;if(a.includes(v)){if(u===0&&r>=m)continue;const b=new Date(i);return b.setDate(i.getDate()+u),b.setHours(l,f,0,0),{type:"upcoming",sortIndex:1,nextTimestamp:b.getTime()}}}return{type:"upcoming",sortIndex:1,nextTimestamp:9999999999999}}function Vr(e,a){const{scheduleDays:t,scheduleStartTime:c,scheduleEndTime:o}=e.info;if(!t||!t.length||!c||!o)return null;const[n,i]=c.split(":").map(Number),[s,r]=o.split(":").map(Number),l=n*60+i,f=s*60+r;for(const p of Object.values(a)){if(p===e||p.isDeleted||p.info.name===e.info.name)continue;const h=p.info;if(!h.scheduleDays||!h.scheduleDays.length||!h.scheduleStartTime||!h.scheduleEndTime||!t.some(k=>h.scheduleDays.includes(k)))continue;const[y,u]=h.scheduleStartTime.split(":").map(Number),[v,b]=h.scheduleEndTime.split(":").map(Number),C=y*60+u,S=v*60+b;if(l<S&&f>C)return p.info.name}return null}function Jr(e){if(!e||e.length===0)return"";const a={6:"شنبه",0:"۱شنبه",1:"۲شنبه",2:"۳شنبه",3:"۴شنبه",4:"۵شنبه",5:"جمعه"};return[...e].sort((c,o)=>{const n={6:0,0:1,1:2,2:3,3:4,4:5,5:6};return n[c]-n[o]}).map(c=>a[c]).join("، ")}async function no(){const e=document.getElementById("restore-points-list");e.innerHTML='<li style="text-align:center; padding:20px;">در حال بارگذاری...</li>';try{const a=await gi();if(a.length===0){e.innerHTML='<li style="text-align:center; padding:20px;">هیچ فایل پشتیبانی یافت نشد.</li>';return}e.innerHTML="",a.forEach(t=>{const c=document.createElement("li");c.className="restore-point-card";const o=new Date(t.timestamp).toLocaleString("fa-IR",{weekday:"long",year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"}),n=(t.file.size/1024).toFixed(1)+" KB";c.innerHTML=`
                <div class="restore-card-header">
                    <span class="restore-date">${o}</span>
                    <span class="restore-size">${n}</span>
                </div>
                <div class="restore-desc">${t.metadata.description||"بدون توضیحات"}</div>
                <div class="restore-actions">
                    <button class="btn-restore-action">بازگردانی</button>
                </div>
            `,c.querySelector(".btn-restore-action").addEventListener("click",async()=>{try{const s=await t.file.text(),f=(await new Gs().loadAsync(s,{base64:!0})).file("backup.json");if(!f)throw new Error("فایل backup.json یافت نشد.");const p=await f.async("string"),h=JSON.parse(p);rs(h)}catch(s){console.error("Restore failed:",s),G("❌ فایل پشتیبان معتبر نیست.")}}),e.appendChild(c)})}catch(a){console.error("Failed to load snapshots:",a),e.innerHTML='<li style="text-align:center; color:red;">خطا در بارگذاری اطلاعات.</li>'}}function Kr(e,a,t="default",c=!1){let o=[...we(e.students)];const n=new Date().toLocaleDateString("fa-IR",{year:"numeric",month:"long",day:"numeric",weekday:"long"});t==="alpha"&&(o=En(o));let i="<tr>";a.forEach(h=>{i+=`<th>${h.label}</th>`}),i+="</tr>";let s="";o.forEach((h,m)=>{s+="<tr>",a.forEach(y=>{var C;let u="-";if(y.id==="row_num")u=m+1;else if(y.id==="name")h.identity.firstName&&h.identity.lastName?u=`${h.identity.lastName}، ${h.identity.firstName}`:u=h.identity.name;else if(y.id==="total_selections")u=h.statusCounters.totalSelections;else if(y.id==="absences")u=e.sessions.reduce((S,k)=>{if(k.isDeleted||k.isCancelled)return S;const _=k.studentRecords[h.identity.studentId];return S+(_&&_.attendance==="absent"?1:0)},0);else if(y.id==="exit_count")u=h.statusCounters.outOfClassCount||0;else if(y.id==="missed_chances")u=h.statusCounters.missedChances;else if(y.id==="issues")u=Object.values(h.categoryIssues||{}).reduce((S,k)=>S+k,0);else if(y.id==="avg_score")u=h.getOverallAverageScore()||"-";else if(y.id==="final_score")u=e.calculateFinalStudentScore(h)||"-";else if(y.type==="category")u=h.categoryCounts[y.id]||0;else if(y.type==="category_scores"){const S=y.id.toLowerCase(),k=((C=h.logs.scores[S])==null?void 0:C.filter(_=>!_.isDeleted))||[];u=k.length>0?k.map(_=>_.value).join("، "):"-"}let v="text-align: center;";y.id==="name"?v="text-align: right; white-space: nowrap;":y.type==="category_scores"&&(v="text-align: center; white-space: nowrap;");const b=`style="${v}"`;s+=`<td ${b}>${u}</td>`}),s+="</tr>"});let r="";c&&(r=`
            <div class="warning-footnote">
                ⚠️ <strong>توجه:</strong> ترتیب الفبایی این لیست ممکن است دقیق نباشد. (نام خانوادگی برخی دانش‌آموزان در سیستم تفکیک نشده است)
            </div>
        `);const l=Array.from(document.querySelectorAll('link[rel="stylesheet"]')).map(h=>h.outerHTML).join(""),f=window.open("","_blank");if(!f){G("⚠️ مرورگر شما پنجره جدید را مسدود کرد. لطفاً اجازه دهید.","error");return}const p=`
        <!DOCTYPE html>
        <html lang="fa" dir="rtl">
        <head>
            <title>گزارش کلاس ${e.info.name}</title>
            ${l} <style>
                @media print {
                    @page { size: A4; margin: 10mm; }
                    /* Updated Font Family */
                    body { font-family: 'Vazirmatn', 'Vazir', Tahoma, sans-serif; color: #000; }
                }
                /* Updated Font Family */
                body { font-family: 'Vazirmatn', 'Vazir', Tahoma, sans-serif; padding: 20px; direction: rtl; }
                h1 { text-align: center; margin-bottom: 5px; font-size: 24px; }
                .meta { text-align: center; margin-bottom: 30px; font-size: 14px; color: #444; }
                table { width: 100%; border-collapse: collapse; font-size: 12px; }
                th, td { border: 1px solid #333; padding: 6px 8px; text-align: center; }
                th { background-color: #eee; font-weight: bold; }
                tr:nth-child(even) { background-color: #f9f9f9; }
                .signature { margin-top: 50px; display: flex; justify-content: space-between; padding: 0 50px; }
                
                .warning-footnote {
                    margin-top: 20px;
                    font-size: 11px;
                    color: #555;
                    font-style: italic;
                    border-top: 1px solid #ccc;
                    padding-top: 10px;
                }
            </style>
        </head>
        <body>
            <h1>گزارش وضعیت کلاس ${e.info.name}</h1>
            <div class="meta">
                تاریخ گزارش: ${n} | تعداد دانش‌آموزان: ${o.length}
            </div>
            <table>
                <thead>${i}</thead>
                <tbody>${s}</tbody>
            </table>
            ${r}
            <div class="signature">
                <div>امضای معلم</div>
                <div>مهر و امضای مدرسه</div>
            </div>
            <script>
                window.onload = function() { window.print(); }
            <\/script>
        </body>
        </html>
    `;f.document.write(p),f.document.close()}function Yr(e){const a=Ai;a.innerHTML="";const c=we(e.students).filter(h=>!h.identity.lastName).length,o=[{id:"row_num",label:"ردیف",checked:!0},{id:"name",label:"نام دانش‌آموز",checked:!0},{id:"total_selections",label:"کل انتخاب‌ها",checked:!0},{id:"absences",label:"تعداد غیبت",checked:!0},{id:"exit_count",label:"تعداد خروج",checked:!1},{id:"missed_chances",label:"فرصت سوخته",checked:!1},{id:"issues",label:"مشکل‌پاسخگویی",checked:!1},{id:"avg_score",label:"میانگین نمرات",checked:!0},{id:"final_score",label:"نمره نهایی (کانون)",checked:!0}];e.categories.forEach(h=>{h.isDeleted||(o.push({id:h.name,label:`تعداد ${h.name}`,type:"category",checked:!1}),h.isGradedCategory&&o.push({id:h.name,label:`نمرات ${h.name}`,type:"category_scores",checked:!1}))}),o.forEach(h=>{const m=document.createElement("label");m.className="report-column-item";const y=document.createElement("input");y.type="checkbox",y.checked=h.checked,y.dataset.colId=h.id,y.dataset.colLabel=h.label,h.type&&(y.dataset.colType=h.type);const u=document.createElement("span");u.textContent=h.label,m.appendChild(y),m.appendChild(u),a.appendChild(m)});const n=a.parentElement,i=n.querySelector("#report-sort-options");i&&i.remove();const s=document.createElement("div");s.id="report-sort-options",s.style.marginTop="20px",s.style.padding="15px",s.style.backgroundColor="#f8f9fa",s.style.borderRadius="5px",s.style.border="1px solid #e9ecef",s.innerHTML=`
        <div style="margin-bottom: 10px; font-weight: bold; color: #333;">ترتیب نمایش لیست:</div>
        
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <label style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <input type="radio" name="report-sort" value="alpha" checked style="accent-color: var(--color-primary);">
                <span>بر اساس نام خانوادگی</span>
            </label>

            <label style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <input type="radio" name="report-sort" value="default" style="accent-color: var(--color-primary);">
                <span>بر اساس زمان ورود به کلاس</span>
            </label>
        </div>

        <div id="sort-warning" style="
            display: none; 
            margin-top: 12px; 
            background-color: #fff3cd; 
            color: #856404; 
            padding: 10px; 
            border-radius: 4px; 
            font-size: 13px; 
            border: 1px solid #ffeeba;
            line-height: 1.5;
        ">
            ⚠️ <strong>توجه:</strong> نام خانوادگی ${c} دانش‌آموز هنوز تفکیک نشده است. مرتب‌سازی این موارد ممکن است کاملاً دقیق نباشد.
        </div>
    `;const r=n.querySelector(".modal-actions");n.insertBefore(s,r);const l=s.querySelectorAll('input[name="report-sort"]'),f=s.querySelector("#sort-warning"),p=()=>{const h=s.querySelector('input[value="alpha"]').checked;f.style.display=h&&c>0?"block":"none"};l.forEach(h=>h.addEventListener("change",p)),p(),Oi.onclick=()=>{const h=[];if(a.querySelectorAll('input[type="checkbox"]:checked').forEach(v=>{h.push({id:v.dataset.colId,label:v.dataset.colLabel,type:v.dataset.colType})}),h.length===0){G("⚠️ لطفاً حداقل یک ستون را انتخاب کنید.");return}const y=s.querySelector('input[name="report-sort"]:checked').value,u=y==="alpha"&&c>0;ge(),Kr(e,h,y,u)},Mi.onclick=()=>{ge()},Ae("report-config-modal")}function Fa(e,a){const t=document.createElement("div");t.className="qualitative-button-container";const c=tt,o=c!==-1&&Y.winnerHistory[c],n=o?Y.winnerHistory[c]:null,i=Y.studentRecords[e.identity.studentId];e.qualitativeStats||(e.qualitativeStats={}),e.qualitativeStats[a]||(e.qualitativeStats[a]={effort:0,good:0,excellent:0}),i.performanceRatings||(i.performanceRatings={});const s=o?n.rating:i.performanceRatings[a],r=Y.isFinished||i.attendance==="absent"||i.hadIssue||i.wasOutOfClass;return[{key:"effort",label:"تلاش",className:"effort-btn"},{key:"good",label:"خوب",className:"good-btn"},{key:"excellent",label:"عالی",className:"excellent-btn"}].forEach(f=>{const p=document.createElement("button");p.className=`qualitative-btn ${f.className}`,p.textContent=f.label,p.disabled=r,s===f.key&&p.classList.add("active"),p.addEventListener("click",()=>{const h=f.key;s&&e.qualitativeStats[a][s]>0&&e.qualitativeStats[a][s]--,s!==h&&(e.qualitativeStats[a][h]=(e.qualitativeStats[a][h]||0)+1);const m=s===h?null:h;o?n.rating=m:m?i.performanceRatings[a]=m:delete i.performanceRatings[a],oe(),$e()}),t.appendChild(p)}),t}function xa(e,a,t="custom",c=null){e.innerHTML="",Object.values(Ra).forEach(n=>{const i=document.createElement("option");i.value=n.id,i.textContent=n.label,e.appendChild(i)}),e.value=t;const o=n=>{a.innerHTML="";const i=Ra[n];if(i&&i.levels.length>0)i.levels.forEach(s=>{const r=document.createElement("option");r.value=s,r.textContent=s,a.appendChild(r)}),a.disabled=!1;else{const s=document.createElement("option");s.value="",s.textContent="---",a.appendChild(s),a.disabled=!0}};o(t),c&&(a.value=c),e.onchange=()=>{o(e.value),a.dispatchEvent(new Event("change"))}}function so(){vn.value="",xa(ss,va,"custom"),Ae("add-class-modal");const e=[{label:"شنبه",value:6},{label:"یکشنبه",value:0},{label:"دوشنبه",value:1},{label:"سه‌شنبه",value:2},{label:"چهارشنبه",value:3},{label:"پنج‌شنبه",value:4},{label:"جمعه",value:5}];is.innerHTML="",e.forEach(a=>{const t=document.createElement("label"),c=document.createElement("input");c.type="checkbox",c.value=a.value,t.appendChild(c),t.appendChild(document.createTextNode(a.label)),is.appendChild(t)}),rn.addEventListener("click",()=>{rn.classList.toggle("open"),Wi.classList.toggle("open");const a=rn.querySelector(".arrow");a.textContent=rn.classList.contains("open")?"▼":"▶"}),vn.focus()}function ao(){Gt.value="",ms.checked=!1,os.value=1,Ui.style.display="none",Ae("category-modal"),Gt.focus()}function Zs(){ge()}function Xr(e,a){let t,c;if(e&&a)t=e,c=a,Vt({student:e,categoryName:a}),vt(-1);else{if(Vt(null),Xt(null),!Y||tt<0||!Y.winnerHistory[tt])return null;const o=Y.winnerHistory[tt];t=o.winner,c=o.categoryName}return{winner:t,categoryName:c}}function Qr(e,a){const t=document.getElementById("selected-student-result");t.innerHTML="",t.classList.remove("absent");const c=document.querySelector(".current-winner-highlight");if(c&&c.classList.remove("current-winner-highlight"),e){const n=document.querySelector(`.student-stats-table tr[data-student-id="${e.identity.studentId}"]`);n&&n.classList.add("current-winner-highlight")}const o=A.categories.find(n=>n.name===a);if(o){Qn(o),Ia(o),Ji(o),Cn(o),Xt(o.name);const n=document.querySelectorAll("#category-selection-container .pill");n.forEach(s=>s.classList.remove("active"));const i=Array.from(n).find(s=>s.textContent===a);i&&i.classList.add("active")}}function ec(e,a,t){const c=document.createElement("div");c.className="winner-name-container";const o=document.createElement("button");o.className="btn-icon",o.innerHTML="˅",o.title="برنده قبلی",o.classList.toggle("is-disabled",!t||tt<=0),o.addEventListener("click",()=>{o.classList.contains("is-disabled")?(o.classList.add("shake-animation"),setTimeout(()=>o.classList.remove("shake-animation"),200)):(vt(tt-1),$e())});const n=Y.studentRecords[e.identity.studentId],i=(n==null?void 0:n.attendance)==="absent",s=document.createElement("div");s.className="winner-name",s.innerHTML=`✨ <strong>${e.identity.name}</strong>✨`,s.classList.add("heartbeat-animation"),i?(s.style.textDecoration="line-through",s.style.opacity="0.6",s.style.color="var(--color-secondary)"):n!=null&&n.hadIssue?(s.style.color="var(--color-warning)",s.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"):n!=null&&n.wasOutOfClass&&(s.style.color="var(--color-strong-warning)",s.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود");const r=()=>{tn=setTimeout(()=>{ac(e,a),tn=null},1e3)},l=()=>{tn&&(clearTimeout(tn),tn=null)};["mousedown","touchstart"].forEach(h=>s.addEventListener(h,r)),["mouseup","mouseout","touchend","touchcancel","touchmove"].forEach(h=>s.addEventListener(h,l));const f=document.createElement("button");if(f.className="btn-icon",f.innerHTML="˄",f.title="برنده بعدی",f.classList.toggle("is-disabled",!t||tt>=Y.winnerHistory.length-1),f.addEventListener("click",()=>{f.classList.contains("is-disabled")?(f.classList.add("shake-animation"),setTimeout(()=>f.classList.remove("shake-animation"),200)):(vt(tt+1),$e())}),c.appendChild(f),c.appendChild(s),e.onboardingSession===Y.sessionNumber){const h=document.createElement("div");h.className="new-student-badge",h.textContent="دانش آموز جدید",c.appendChild(h)}c.appendChild(o);const p=document.getElementById("select-student-btn");return p&&(p.disabled=t&&!f.classList.contains("is-disabled")),{nameContainer:c,winnerNameEl:s}}function tc(e,a,t){const c=document.createElement("div");c.className="status-button-container";const o=document.createElement("button");o.textContent="غایب",o.classList.add("status-button","absent-btn"),(a==null?void 0:a.attendance)==="absent"&&o.classList.add("active");const n=document.createElement("button");n.textContent="مشکل",n.classList.add("status-button","issue-btn"),a!=null&&a.hadIssue&&n.classList.add("active");const i=document.createElement("button");i.textContent="خروج",i.classList.add("status-button","exit-btn"),a!=null&&a.wasOutOfClass&&i.classList.add("active");const s=document.createElement("button");s.textContent="پروفایل",s.className="status-button profile-btn";const r=()=>{Oe(),setTimeout(()=>{tt!==-1?$e():$e(e,t)},0),oe()};return Y.isFinished?[o,n,i,s].forEach(l=>l.disabled=!0):(o.addEventListener("click",()=>{const l=o.classList.contains("active");i.classList.contains("active")&&(i.classList.remove("active"),a.wasOutOfClass=!1,e.statusCounters.outOfClassCount=Math.max(0,(e.statusCounters.outOfClassCount||0)-1),e.statusCounters.missedChances=Math.max(0,e.statusCounters.missedChances-1)),l?(o.classList.remove("active"),Y.setAttendance(e.identity.studentId,"present"),e.statusCounters.missedChances=Math.max(0,e.statusCounters.missedChances-1)):(n.classList.contains("active")&&(n.classList.remove("active"),a.hadIssue=!1,e.statusCounters.otherIssues=Math.max(0,e.statusCounters.otherIssues-1),e.statusCounters.missedChances=Math.max(0,e.statusCounters.missedChances-1)),o.classList.add("active"),Y.setAttendance(e.identity.studentId,"absent"),e.statusCounters.missedChances++),r()}),n.addEventListener("click",()=>{const l=n.classList.contains("active");i.classList.contains("active")&&(i.classList.remove("active"),a.wasOutOfClass=!1,e.statusCounters.outOfClassCount=Math.max(0,(e.statusCounters.outOfClassCount||0)-1),e.statusCounters.missedChances=Math.max(0,e.statusCounters.missedChances-1)),l?(n.classList.remove("active"),a.hadIssue=!1,e.categoryIssues[t]&&(e.categoryIssues[t]=Math.max(0,e.categoryIssues[t]-1)),e.statusCounters.missedChances=Math.max(0,e.statusCounters.missedChances-1)):(o.classList.contains("active")&&(o.classList.remove("active"),Y.setAttendance(e.identity.studentId,"present"),e.statusCounters.missedChances=Math.max(0,e.statusCounters.missedChances-1)),n.classList.add("active"),a.hadIssue=!0,e.categoryIssues[t]=(e.categoryIssues[t]||0)+1,e.statusCounters.missedChances++),r()}),i.addEventListener("click",()=>{i.classList.contains("active")?(i.classList.remove("active"),a.wasOutOfClass=!1,e.statusCounters.outOfClassCount=Math.max(0,(e.statusCounters.outOfClassCount||0)-1),e.statusCounters.missedChances=Math.max(0,e.statusCounters.missedChances-1)):(o.classList.contains("active")&&(o.classList.remove("active"),Y.setAttendance(e.identity.studentId,"present"),e.statusCounters.missedChances=Math.max(0,e.statusCounters.missedChances-1)),n.classList.contains("active")&&(n.classList.remove("active"),a.hadIssue=!1,e.categoryIssues[t]&&(e.categoryIssues[t]=Math.max(0,e.categoryIssues[t]-1)),e.statusCounters.missedChances=Math.max(0,e.statusCounters.missedChances-1)),i.classList.add("active"),a.wasOutOfClass=!0,e.statusCounters.outOfClassCount=(e.statusCounters.outOfClassCount||0)+1,e.statusCounters.missedChances++),r()}),s.addEventListener("click",()=>{Fe(e)})),c.appendChild(o),c.appendChild(i),c.appendChild(n),c.appendChild(s),c}function nc(e,a){const t=document.createElement("div");t.className="student-details-container";const c=document.createElement("div");c.className="student-details-scores",c.innerHTML="<h4>آخرین نمرات</h4>";const o=document.createElement("ul");o.className="scores-list";const n=A.categories.filter(m=>m.isGradedCategory&&!m.isDeleted);let i=!1;const s=e.logs.scores||{};n.forEach(m=>{var k;const y=m.name,u=y.toLowerCase(),v=(k=s[u])==null?void 0:k.filter(_=>!_.isDeleted),b=document.createElement("li"),C=document.createElement("span");C.className="skill-name",C.textContent=`${y}:`;const S=document.createElement("span");if(S.className="skill-scores",v&&v.length>0){i=!0;const _=v.slice(-3);_.forEach((x,L)=>{const D=document.createElement("span");D.textContent=x.value+(x.comment?"'":""),x.comment&&(D.dataset.tooltip=x.comment,D.style.position="relative",D.style.cursor="help",D.classList.add("tooltip-container")),S.appendChild(D),L<_.length-1&&S.appendChild(document.createTextNode(","))})}else S.textContent="none";b.appendChild(C),b.appendChild(S),o.appendChild(b)}),i||(o.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>'),c.appendChild(o),t.appendChild(c);const r=document.createElement("div");r.className="student-details-notes";const l=document.createElement("div");l.className="history-section-header";const f=document.createElement("h4");f.textContent="یادداشت‌ها";const p=document.createElement("button");p.className="btn-icon",p.innerHTML="📝",p.title="افزودن یادداشت جدید",Y.isFinished?p.disabled=!0:p.addEventListener("click",()=>{Ee.value="",Ee.dispatchEvent(new Event("input",{bubbles:!0})),dt(m=>{m&&(e.addNote(m),oe(),$e(),G("✅ یادداشت با موفقیت ثبت شد."))}),Ae("add-note-modal"),Ee.focus()}),l.appendChild(f),l.appendChild(p),r.appendChild(l);const h=document.createElement("ul");return h.className="notes-list",e.profile.notes&&e.profile.notes.length>0?[...e.profile.notes].sort((y,u)=>new Date(u.timestamp)-new Date(y.timestamp)).forEach(y=>{const u=document.createElement("li");u.dir=us(y.content),u.textContent=y.content,h.appendChild(u)}):h.innerHTML='<div class="no-content-message">یادداشتی وجود ندارد.</div>',r.appendChild(h),t.appendChild(r),t}const Ha=Object.freeze(Object.defineProperty({__proto__:null,_internalShowPage:fn,addClassModal:Ao,addNoteModal:rr,addScoreBtn:mr,addStudentBtn:zo,appHeader:Rs,assessmentModeLabel:Vo,attendanceListUl:ln,attendanceMassActionsContainer:zn,attendancePage:Jo,attendancePane:Jt,attendanceSearchInput:Lt,backToSessionsBtn:Ro,backToStudentPageBtn:dr,backupDataBtn:nr,breadcrumbContainer:Wt,cancelAddClassBtn:Ds,cancelImportBtn:Go,cancelNoteBtn:lr,categoryListUl:As,categoryModal:Sr,categoryModalCancelBtn:kr,categoryModalSaveBtn:$i,categoryModalTitle:Ri,categoryWeightLabel:Rn,classListHeader:Yo,classListUl:Dt,classManagementPage:ki,classSaveNoteBtn:cr,closeActiveModal:ge,closeAddClassModal:Zs,closeContextMenu:Bt,closeNavBtn:er,columnMappingPage:qo,columnSelectDropdown:Ms,confirmAddClassBtn:Bs,confirmColumnBtn:Zo,confirmModalCancelBtn:zs,confirmModalConfirmBtn:sn,confirmModalMessage:Ti,contextMenu:Ot,csvCancelBtn:Wo,csvConfirmBtn:Ho,csvFileInput:jo,csvPreviewList:Os,csvPreviewPage:Fo,customConfirmModal:ar,displayWinner:$e,finishAttendanceBtn:Ko,globalStudentSearchInput:an,globalStudentSearchResultsDiv:ft,gradedCategoryPillsContainer:ur,hamburgerMenuBtn:Xo,handleUndo:qi,importCsvBtn:Uo,initiateBackupProcess:bn,massCommentAppendCheckbox:ba,massCommentBtn:Hs,massCommentCancelBtn:xr,massCommentContent:un,massCommentModal:_r,massCommentModalTitle:Ir,massCommentSaveBtn:Lr,massCommentStudentCountMessage:zi,modalAddClassLevelSelect:va,modalAddClassSystemSelect:ss,modalNewClassNameInput:vn,modalScheduleContent:Wi,modalScheduleDaysContainer:is,modalScheduleEndTimeInput:Hi,modalScheduleStartTimeInput:Fi,modalScheduleTextInput:Pi,modalScheduleToggle:rn,newCategoryModal:Br,newCategoryModalIsGradedCheckbox:ms,newCategoryModalNameInput:Gt,newCategoryModalWeightGroup:Ui,newCategoryModalWeightInput:os,newNoteContent:Ee,newScoreCommentTextarea:Ni,newScoreValueInput:fr,newStudentNameInput:$o,openAddCategoryBtn:Dr,openAddCategoryModal:ao,openAddClassModal:so,openAddClassModalBtn:No,openContextMenu:Sn,openModal:Ae,overlay:tr,pasteArea:xi,populateSystemLevelSelects:xa,processMassHomeworkComment:Us,processPasteBtn:Po,profileScoresListUl:pr,profileStatsSummaryDiv:hr,quickGradeFormWrapper:jt,quickGradeSubmitBtn:At,quickNoteTextarea:ct,quickScoreInput:pt,renderAttendancePage:nt,renderBreadcrumbs:Vi,renderClassList:We,renderClassManagementStats:ps,renderColumnSelector:Qi,renderGlobalSearchResults:Wn,renderImportPreview:qs,renderLogModal:Gi,renderMassCommentControls:Ea,renderRestorePointsPage:no,renderScoresHistory:Yi,renderSearchResults:cn,renderSessionDashboard:Kt,renderSessions:Ge,renderSettingsCategories:Qt,renderSettingsOther:eo,renderSettingsStudentList:_t,renderStudentNotes:Xi,renderStudentStatsList:Oe,renderTrashPage:wn,reportCancelBtn:Mi,reportColumnsContainer:Ai,reportConfigModal:Er,reportPrintBtn:Oi,restoreDataBtn:sr,restoreFileInput:Li,secureConfirmCancelBtn:or,secureConfirmCode:Di,secureConfirmConfirmBtn:$n,secureConfirmInput:Ht,secureConfirmMessage:Bi,secureConfirmModal:ir,selectStudentBtn:Xe,selectStudentBtnWrapper:Nt,sessionDashboardPage:Tr,setAutoDirectionOnInput:_a,settingsClassNameHeader:Ii,settingsEduSystemSelect:Pn,settingsLevelSelect:on,settingsPage:Mo,settingsStudentListUl:Ns,setupDashboardTabs:ji,setupLongPress:qt,showCategoryModal:Ws,showClassNoteModal:hs,showCustomConfirm:be,showMassCommentModal:Sa,showMoveStudentModal:Ca,showNotification:G,showPage:ye,showRenameStudentModal:wa,showRestoreConfirmModal:rs,showSecureConfirm:Zi,showSessionNoteModal:ka,showSettingsPage:kt,showStudentProfile:Fe,showUndoToast:Nr,sideNavMenu:Qo,studentSearchInput:Ps,studentSearchResultsDiv:Ct,studentStatsHeader:$s,switchDashboardTab:Yt,trashedCategoriesList:br,trashedClassesList:gr,trashedNotesList:Cr,trashedScoresList:wr,trashedSessionsList:vr,trashedStudentsList:yr,triggerFileDownload:js,undoBtn:Oo,undoMessage:_i,undoToast:as,updateCategoryColumnHighlight:Xt,updateDemoModeBanner:Un,updateQuickGradeUIForCategory:Cn},Symbol.toStringTag,{value:"Module"}));let Wa=0,Is=!1;function sc(){const e=window.location.hash;if(!e||e==="#")return!1;const[a,t]=e.split("?"),c=a.substring(1),o=new URLSearchParams(t),n=o.get("class"),i=parseInt(o.get("session"),10),s=o.get("student"),r=o.get("tab")||"selector";if(n&&ie[n])qe(ie[n]),i&&A.getSession(i)&&Ke(A.getSession(i)),s&&A.students.find(l=>l.identity.studentId===s)&&Qe(A.students.find(l=>l.identity.studentId===s));else return!1;switch(c){case"session-page":Ge(),ye("session-page");break;case"session-dashboard-page":Kt(c==="attendance-page"?"attendance":r);break;case"settings-page":kt(A);break;case"student-profile-page":Kt(r),Fe(_e);break;default:return!1}return!0}document.addEventListener("DOMContentLoaded",()=>{const{globalStudentSearchInput:e,undoBtn:a,newStudentNameInput:t,addStudentBtn:c,pasteArea:o,processPasteBtn:n,csvPreviewList:i,csvConfirmBtn:s,csvCancelBtn:r,importCsvBtn:l,csvFileInput:f,columnSelectDropdown:p,confirmColumnBtn:h,cancelImportBtn:m,selectStudentBtn:y,attendancePage:u,finishAttendanceBtn:v,classListHeader:b,studentStatsHeader:C,hamburgerMenuBtn:S,sideNavMenu:k,closeNavBtn:_,overlay:x,backupDataBtn:L,restoreDataBtn:D,restoreFileInput:M,confirmModalCancelBtn:U,confirmModalConfirmBtn:Q,secureConfirmCancelBtn:I,secureConfirmConfirmBtn:z,newNoteContent:g,classSaveNoteBtn:W,cancelNoteBtn:ue,studentSearchInput:q,studentSearchResultsDiv:me,categoryModalSaveBtn:V,categoryModalCancelBtn:fe,massCommentBtn:R,massCommentCancelBtn:O,massCommentSaveBtn:de,massCommentContent:se,massCommentAppendCheckbox:ee,attendanceSearchInput:Be,newCategoryModalNameInput:He,newCategoryModalIsGradedCheckbox:he,newCategoryModalWeightInput:Se,newCategoryModalWeightGroup:Me,openAddCategoryBtn:Ne}=Ha,st=document.getElementById("trash-nav-btn");document.querySelector(".global-search-container .search-icon"),Yn(),Un(),sc()||(We(),ye("class-management-page"));function d(B,P){const F=document.querySelector(B);if(!F)return;const J=F.querySelector(".search-icon"),ae=F.querySelector(".animated-search-input");!J||!ae||(J.addEventListener("mousedown",ce=>{ce.preventDefault()}),J.addEventListener("click",()=>{F.classList.contains("search-active")||(F.classList.add("search-active"),ae.focus())}),ae.addEventListener("blur",()=>{setTimeout(()=>{F.classList.remove("search-active"),ae.value="",P&&P([])},150)}))}Be.addEventListener("input",()=>{const B=Be.value.toLowerCase().trim(),P=Mn(B);ln.querySelectorAll(".attendance-list-item").forEach(J=>{const ae=J.querySelector(".student-name");if(ae){const ce=ae.textContent,te=je(ce.toLowerCase()),re=te.includes(je(B)),pe=te.includes(je(P));re||pe?J.style.display="flex":J.style.display="none"}})}),fe.addEventListener("click",()=>{ge(),gn(null)}),V.addEventListener("click",()=>{const B=He.value.trim(),P=he.checked,F=parseInt(Se.value,10)||1;if(!B){G("⚠️ نام دسته‌بندی نمی‌تواند خالی باشد.");return}typeof Vn=="function"&&Vn(B,P,F),ge(),G(`✅ دسته‌بندی جدید ${B} با موفقیت اضافه شد.`),Qt()}),window.addEventListener("scroll",Bt),document.addEventListener("click",B=>{Ot.classList.contains("visible")&&!Ot.contains(B.target)&&Bt(),q.contains(B.target)||(me.style.display="none");const P=B.target.closest(".log-action-link");if(P&&P.dataset.action)try{const F=JSON.parse(P.dataset.action);io(F)}catch(F){console.error("Could not parse log action:",F)}}),Nt.addEventListener("click",()=>{(Nt.classList.contains("disabled-wrapper")||Xe.disabled)&&(Xe.classList.add("shake-animation"),setTimeout(()=>{Xe.classList.remove("shake-animation")},200))}),C.addEventListener("click",()=>{const B=new Date().getTime();B-Xs>500?An(1):An(Zn+1),fi(B),Zn===5&&(An(0),be("آیا از صفر کردن تمام شمارنده‌های دانش‌آموزان مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{ii(),Oe(),G("تمام آمارها صفر شدند ✅.")},{confirmText:"بله",confirmClass:"btn-warning"}))}),b.addEventListener("click",()=>{const B=new Date().getTime();B-Ys>500?Nn(1):Nn(qn+1),ui(B),qn===5&&(Nn(0),be("آیا از ساخت یک کلاس تستی تصادفی مطمئن هستید؟",()=>{function P(){const F=`کلاس تستی ${Object.keys(ie).length+1}`,J=new Ls({name:F,type:"online"});["علی . رضایی","مریم . حسینی","زهرا . احمدی","رضا . محمدی","فاطمه . کریمی"].forEach(ce=>J.addStudent(new Bn(Ut(ce)))),ie[F]=J,oe(),We()}P(),G("کلاس تستی با موفقیت ساخته شد ✅!")},{confirmText:"بساز",confirmClass:"btn-success"}))}),document.querySelector(".app-header h1").addEventListener("click",()=>{Wa++,Wa===10&&(window.dev={state:$a,ui:Ha,utils:ko,db:So},console.log("🛠️ Developer Mode Activated! Access modules via the 'dev' object (e.g., dev.state.currentClassroom)"),G("🛠️ حالت توسعه‌دهنده فعال شد."),document.querySelector(".app-header h1").style.color="var(--color-primary)",document.querySelector(".app-header h1").classList.add("dev-mode-tilt"))}),I.addEventListener("click",()=>{ge(),pn(null)});const H=document.getElementById("date-picker-confirm-btn"),$=document.getElementById("date-picker-cancel-btn"),E=document.getElementById("dp-day"),w=document.getElementById("dp-month"),T=document.getElementById("dp-year");H.addEventListener("click",()=>{const B=T.value,P=w.value,F=E.value;B&&P&&F&&typeof Kn=="function"?(Kn({jy:B,jm:P,jd:F}),ge()):G("⚠️ خطا در انتخاب تاریخ."),es(null)}),$&&$.addEventListener("click",()=>{ge(),es(null)}),z.addEventListener("click",()=>{typeof Gn=="function"&&Gn(),ge(),pn(null)}),U.addEventListener("click",()=>{ge(ea)}),Q.addEventListener("click",()=>{ge(Qs)}),Xe.addEventListener("click",()=>{if(Is){Is=!1;return}if(pt.value.trim()!==""||ct.value.trim()!==""){G("⚠️لطفاً ابتدا با دکمه «ثبت»، تغییرات را ذخیره کنید و یا نمره و یادداشت را پاک کنید.");return}if(Tt){const B=rc(A,Re);B?(Oe(),$e(B,Re.name),Xt(Re.name),oe()):be("برای تمام دانش‌آموزان در این جلسه یک بار فرصت نمره‌گیری فراهم شده؛ آیا می‌خواهید برای بار دوم این کار را تکرار کنید؟",()=>{const P=Re.id;ot[P].scoredThisSession=[],Xe.click()},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})}else{if(!A||!Y||!Re)return;const B=A.selectNextWinner(Re.name,Y);if(B){Ts();const P=Y.studentRecords[B.identity.studentId];(P==null?void 0:P.attendance)==="absent"&&B.statusCounters.missedChances++,P!=null&&P.hadIssue&&(B.statusCounters.missedChances++,B.categoryIssues[Re.name]=(B.categoryIssues[Re.name]||0)+1),P!=null&&P.wasOutOfClass&&(B.statusCounters.outOfClassCount=(B.statusCounters.outOfClassCount||0)+1,B.statusCounters.missedChances++);const F={winner:B,categoryName:Re.name};Y.winnerHistory.push(F),Y.winnerHistory.length>10&&Y.winnerHistory.shift(),vt(Y.winnerHistory.length-1),Y.lastUsedCategoryId=Re.id,Y.lastSelectedWinnerId=B.identity.studentId,Oe(),setTimeout(()=>$e(),0),oe()}else G("❌دانش‌آموز واجد شرایطی برای انتخاب یافت نشد.")}}),document.querySelectorAll('#settings-page input[name="class-type-setting"]').forEach(B=>{B.addEventListener("change",()=>{if(!A)return;const P=B.value,F=A.info.type||"in-person";if(P===F)return;const J=te=>te==="online"?"آنلاین":"حضوری",ae=J(F),ce=J(P);be(`آیا از تغییر نوع کلاس از «${ae}» به «${ce}» مطمئن هستید؟`,()=>{A.info.type=P,oe(),ke(A.info.name,`نوع کلاس به «${ce}» تغییر یافت.`,{type:"VIEW_CLASS_SETTINGS"}),We(),G(`✅ نوع کلاس به «${ce}» تغییر یافت.`)},{confirmText:"بله",confirmClass:"btn-warning",onCancel:()=>{const te=document.querySelector(`#settings-page input[name="class-type-setting"][value="${F}"]`);te&&(te.checked=!0)}})})});const Z=document.querySelectorAll('input[name="schedule-day"]'),N=document.getElementById("settings-schedule-start"),K=document.getElementById("settings-schedule-end");Z.forEach(B=>{B.addEventListener("change",()=>{if(!A)return;const P=Array.from(Z).filter(F=>F.checked).map(F=>parseInt(F.value));A.info.scheduleDays=P,oe()})});const ne=()=>{A&&(A.info.scheduleStartTime=N.value,A.info.scheduleEndTime=K.value,oe())};N.addEventListener("change",ne),K.addEventListener("change",ne),h.addEventListener("click",()=>{if(!jn){alert("❌خطایی رخ داده است. لطفاً فایل را دوباره انتخاب کنید."),ye("settings-page");return}const B=parseInt(p.value,10),J=jn.split(`
`).slice(1).map(ae=>{var te;return(te=ae.split(",")[B])==null?void 0:te.trim()}).filter(ae=>ae&&ae.length>0);J.length>0?(nn(J),qs(),ye("csv-preview-page")):alert("هیچ نامی در ستون انتخاب شده پیدا نشد. لطفاً ستون دیگری را امتحان کنید یا فایل خود را بررسی کنید."),Dn(null)}),l.addEventListener("click",()=>{f.click()}),f.addEventListener("change",B=>{const P=B.target.files[0];if(!P)return;const F=new FileReader;F.onload=J=>{const ae=J.target.result;Dn(ae);const te=ae.split(`
`)[0].split(",");Qi(te),ye("column-mapping-page")},F.readAsText(P),B.target.value=null}),m.addEventListener("click",()=>{Dn(null),ye("settings-page")}),s.addEventListener("click",()=>{const B=i.querySelectorAll('input[type="checkbox"]:checked');let P=0,F=[],J=!1;B.forEach(ce=>{const te=ce.dataset.name,re=Ut(te),pe=je(re.name),Ce=A.students.find(Je=>je(Je.identity.name)===pe&&pe!=="");if(Ce)if(Ce.isDeleted)ds(Ce,A);else{F.push(re.name);return}const Le=new Bn(re);A.addStudent(Le),A.sessions.length>0&&(we(A.sessions).filter(Je=>Je.isFinished&&!Je.isCancelled).forEach(Je=>{Je.setAttendance(Le.identity.studentId,"absent")}),en(Le,A),J=!0),P++}),oe(),P>0&&ke(A.info.name,`${P} دانش‌آموز جدید از لیست ورودی به کلاس اضافه شدند.`,{type:"VIEW_SESSIONS"}),kt(A);let ae=F.length>0?`⚠️ موارد زیر به دلیل تکراری بودن نادیده گرفته شدند:
- ${F.join(`
- `)}`:"";if(J)kn(P,ae);else if(F.length>0||P>0){const ce=P>0?`✅ ${P} دانش‌آموز با موفقیت اضافه شدند.
${ae}`:ae;be(ce,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}o.value="",nn([])}),r.addEventListener("click",()=>{nn([]),ye("settings-page")}),o.addEventListener("keydown",B=>{if(B.key==="Enter"){const P=o.value,F=o.selectionStart,J=P.lastIndexOf(`
`,F-1),ae=P.substring(J+1,F).trim(),ce=ae.indexOf(".");ae&&(ce<=0||ce>=ae.length-1)&&(B.preventDefault(),G("لطفا یک نقطه بین نام و نام خانوادگی قرار دهید. مثال: علی . احمدی"))}}),n.addEventListener("click",()=>{const B=o.value.trim();if(!B){G("کادر متنی خالی است. لطفاً اسامی را وارد کنید.");return}const P=B.split(`
`).map(J=>J.trim()).filter(J=>J.length>0),F=P.find(J=>{const ae=J.indexOf(".");return ae<=0||ae>=J.length-1});if(F){G(`فرمت نام «${F}» صحیح نیست. لطفا نام و نام خانوادگی را با نقطه جدا کنید.`);return}P.length>0?(nn(P),qs(),ye("csv-preview-page")):G("هیچ نام معتبری برای ورود پیدا نشد.")}),t.addEventListener("keyup",B=>{B.key==="Enter"&&c.click()}),c.addEventListener("click",()=>{if(!A)return;const B=t.value.trim();if(!B){alert("لطفاً نام دانش‌آموز را وارد کنید.");return}const P=B.indexOf(".");if(P<=0||P>=B.length-1){G("لطفا یک نقطه بین نام و نام خانوادگی قرار دهید. مثال: علی . احمدی");return}const F=Ut(t.value),J=je(F.name);if(we(A.students).some(re=>je(re.identity.name)===J)){alert(`دانش‌آموز «${F.name}» قبلاً در لیست وجود دارد.`);return}const ce=Ut(B),te=new Bn(ce);A.addStudent(te),A.sessions.length>0&&(we(A.sessions).filter(re=>re.isFinished&&!re.isCancelled).forEach(re=>{re.setAttendance(te.identity.studentId,"absent")}),en(te,A),kn(1)),oe(),ke(A.info.name,`دانش‌آموز «${B}» به کلاس اضافه شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:te.identity.studentId}),_t(),Oe(),t.value="",t.focus()}),document.getElementById("new-session-btn").addEventListener("click",()=>{if(A){const B=A.sessions.find(F=>!F.isFinished&&!F.isCancelled&&!F.isDeleted);if(B){G(`⚠️ جلسه ${B.sessionNumber} هنوز تمام نشده است. لطفاً ابتدا با دکمه ✅ آن را خاتمه دهید.`);return}const P=()=>{const F=J=>{const ae=A.startNewSession();hn(ae),Ke(ae),A.students.forEach(re=>{Vs.setAttendance(re.identity.studentId,"present")}),oe();const te=rt(A).get(ae.sessionNumber);ke(A.info.name,`جلسه ${te} شروع شد.`,{type:"VIEW_SESSIONS"}),Kt(J?"attendance":"selector")};be("آیا تمایل به انجام فرآیند حضور و غیاب دارید؟",()=>F(!0),{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success",onCancel:()=>F(!1)})};A.hasSessionToday()?be("شما امروز یک جلسه برای این کلاس ثبت کرده‌اید. آیا از شروع یک جلسه جدید دیگر مطمئن هستید؟",P,{confirmText:"بله",confirmClass:"btn-warning"}):P()}});const X=document.getElementById("open-add-class-modal-btn");X&&X.addEventListener("click",()=>{so()}),Ds&&Ds.addEventListener("click",()=>{Zs()}),Bs?Bs.addEventListener("click",()=>{var F;const B=vn;if(!B){console.error("❌ DEBUG: Name Input element is missing!");return}const P=B.value.trim();if(!P){alert("لطفاً نام کلاس را وارد کنید.");return}if(ie[P]){alert("کلاسی با این نام قبلاً ایجاد شده است.");return}try{const J=document.querySelector('input[name="modal-class-type"]:checked');if(!J){console.error("❌ DEBUG: Class Type radio not selected or found!");return}const ae=J.value,ce=ss.value,te=vn.value.trim();if(!te){G("⚠️ لطفاً نام کلاس را وارد کنید.");return}if(ie[te]){G("⚠️ کلاسی با این نام وجود دارد.");return}const re=((F=document.querySelector('input[name="modal-class-type"]:checked'))==null?void 0:F.value)||"in-person",pe=ss.value,Ce=va.value||null,Le=Pi.value.trim()||null,Je=Array.from(is.querySelectorAll("input:checked")).map(Ie=>parseInt(Ie.value,10)),Cs=Fi.value||null,ws=Hi.value||null,gt=new Ls({name:te,type:re,educationalSystem:pe,level:Ce,scheduleText:Le,scheduleDays:Je,scheduleStartTime:Cs,scheduleEndTime:ws});ie[te]=gt,oe(),ge(),We(),G(`✅ کلاس «${te}» ایجاد شد.`),ie[P]=gt,oe(),We(),Zs()}catch(J){console.error("❌ CRASH ERROR:",J),alert("خطایی رخ داد: "+J.message)}}):console.error("❌ DEBUG: Create Button (ui.confirmAddClassBtn) is NOT found!"),e.addEventListener("input",B=>{const P=B.target.value;if(P.length<2){Wn([]);return}const F=P.toLowerCase(),J=Mn(F),ae=[];for(const ce in ie){const te=ie[ce];if(te.isDeleted)continue;const re=je(ce.toLowerCase()),pe=re.includes(je(F)),Ce=re.includes(je(J));(pe||Ce)&&ae.push({type:"classroom",classroom:te})}for(const ce in ie){const te=ie[ce];if(te.isDeleted)continue;we(te.students).filter(pe=>{const Ce=je(pe.identity.name.toLowerCase()),Le=Ce.includes(je(F)),Je=Ce.includes(je(J));return Le||Je}).forEach(pe=>{ae.push({type:"student",student:pe,classroom:te})})}Wn(ae)}),a.addEventListener("click",qi),v.addEventListener("click",()=>{Yt("selector")}),q.addEventListener("input",B=>{const P=B.target.value;if(!P){cn([]);return}const F=P.toLowerCase(),J=Mn(F),ce=we(A.students).filter(te=>{const re=je(te.identity.name.toLowerCase()),pe=re.includes(je(F)),Ce=re.includes(je(J));return pe||Ce});cn(ce)}),q.addEventListener("focus",()=>{q.value&&cn(q.value)}),At.addEventListener("click",()=>{const B=pt.value,P=ct.value.trim();let F;if(Jn)F=Jn.student;else{const ae=Y==null?void 0:Y.winnerHistory[tt];F=ae==null?void 0:ae.winner}if(!F){G("❌خطا: دانش‌آموز معتبری برای ثبت نمره یافت نشد.");return}const J=Re;if(!F||!J){G("⚠️لطفاً ابتدا یک دانش‌آموز و یک دسته‌بندی را انتخاب کنید.");return}if(!B){G("⚠️لطفاً مقدار نمره را وارد کنید.");return}if(B>100||B<0){G("❌نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}F&&(F.addScore(J.name,parseFloat(B),P),ke(A.info.name,`نمره ${B} در ${J.name} برای «${F.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:F.identity.studentId}),oe(),Oe(),G(`✅نمره برای ${F.identity.name} در مهارت ${J.name} ثبت شد.`),fa(Re.id,F.identity.studentId),pt.value="",ct.value="",$e())});const le=B=>{B.key==="Enter"&&B.ctrlKey&&(B.preventDefault(),At.click())};pt.addEventListener("keydown",le),ct.addEventListener("keydown",le),ue.addEventListener("click",()=>{ge()}),W.addEventListener("click",()=>{const B=g.value.trim(),P=ta;if(typeof P=="function"){const F=P(B);if(F===!1)return;ge(()=>{typeof F=="function"&&F()})}else ge()});const xe=document.getElementById("move-student-confirm-btn"),ve=document.getElementById("move-student-cancel-btn"),Ve=document.getElementById("move-student-class-select");ve.addEventListener("click",()=>{ge()}),xe.addEventListener("click",()=>{const B=Ve.value,P=ie[B],{studentToMove:F,sourceClassForMove:J}=$a;if(!F||!J||!P){G("خطایی رخ داد. لطفاً دوباره امتحان کنید⚠️.","error"),ge();return}const ae=ai(F,J,P);ae.success?(ke(J.info.name,`دانش‌آموز «${F.identity.name}» به کلاس «${B}» منتقل شد.`,{type:"VIEW_SESSIONS"}),ke(B,`دانش‌آموز «${F.identity.name}» از کلاس «${J.info.name}» به این کلاس منتقل شد.`,{type:"VIEW_SESSIONS"}),oe(),_t(),Oe(),nt(),G(`دانش‌آموز «${F.identity.name}» با موفقیت به کلاس «${B}» منتقل شد✅.`)):G(ae.message,"error"),ge()}),S.addEventListener("click",()=>{k.style.width="300px",x.classList.add("modal-visible")}),S.addEventListener("click",()=>{k.style.width="300px",x.classList.add("modal-visible")});const bt=document.getElementById("header-settings-btn");bt&&bt.addEventListener("click",()=>{A&&kt(A)}),_.addEventListener("click",ze),_.addEventListener("click",ze),x.addEventListener("click",ze),st.addEventListener("click",()=>{wn(),ye("trash-page"),ze()});const Ye=document.getElementById("restore-points-nav-btn");Ye&&Ye.addEventListener("click",()=>{no(),ye("restore-points-page"),ze()}),document.getElementById("demo-mode-btn").addEventListener("click",()=>{mt?zt():(ze(),be("شما در حال ورود به حالت نمایش (Demo) هستید. در این حالت، هیچ‌کدام از تغییرات شما ذخیره نخواهد شد. آیا ادامه می‌دهید؟",()=>{oi(),Un(),ze()},{confirmText:"تایید",confirmClass:"btn-warning",onCancel:ze}))});const De=document.getElementById("exit-demo-btn");De&&De.addEventListener("click",()=>{mt&&zt()}),L.addEventListener("click",()=>{if(mt){G("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است."),ze();return}ze(),bn()}),D.addEventListener("click",()=>{if(mt){G("⚠️ بازیابی اطلاعات در حالت نمایش (Demo) غیرفعال است."),ze();return}M.click(),ze()}),M.addEventListener("change",B=>{const P=B.target.files[0];if(!P)return;const F=new FileReader;F.onload=async J=>{const ae=J.target.result;try{const ce=JSON.parse(ae);if(ce.metadata&&ce.data)rs(ce);else{const te=ce.classrooms||ce,re=ce.trashBin||[];be("آیا از بازیابی اطلاعات مطمئن هستید؟ تمام داده‌های فعلی شما بازنویسی خواهد شد.",()=>{Rt(te),da(re),wt({lastRestoreTimestamp:new Date().toISOString()}),oe(),We(),ye("class-management-page"),G("✅اطلاعات با موفقیت بازیابی شد.")},{confirmText:"بازیابی کن",confirmClass:"btn-warning"})}}catch{try{const pe=(await new Gs().loadAsync(ae,{base64:!0})).file("backup.json");if(!pe)throw new Error("فایل backup.json در فایل پشتیبان یافت نشد.");const Ce=await pe.async("string"),Le=JSON.parse(Ce);if(Le.metadata&&Le.metadata.version==="2.0-b64")rs(Le);else throw new Error("فایل پشتیبان معتبر نیست (نسخه نامشخص).")}catch(te){G("❌خطا در خواندن فایل. لطفاً فایل پشتیبان معتبر انتخاب کنید."),console.error("Restore error (zip/base64):",te)}}},F.readAsText(P),B.target.value=null}),window.addEventListener("popstate",B=>{if(St){ge(null,!0);return}if(Bt(),B.state){const{pageId:P,currentClassName:F,selectedSessionNumber:J,selectedStudentId:ae}=B.state;F&&(qe(ie[F]),J&&Ke(A.getSession(J)),ae&&Qe(A.students.find(ce=>ce.identity.studentId===ae))),P==="session-page"?(Ge(),fn(P)):P==="student-profile-page"?(Ge(),ye("session-page"),Fe(_e)):fn(P)}else qe(null),Ke(null),Qe(null),fn("class-management-page")}),document.addEventListener("keydown",B=>{var J;const P=document.activeElement;if(!["INPUT","TEXTAREA","SELECT"].includes(P.tagName)){if(B.key.toLowerCase()==="o"&&B.shiftKey&&ki.classList.contains("active")&&(B.preventDefault(),Li.click()),B.key==="Escape"){if(Ot.classList.contains("visible")){Bt();return}if(St){ge();return}switch((J=document.querySelector(".page.active"))==null?void 0:J.id){case"csv-preview-page":case"column-mapping-page":ye("settings-page");break;case"student-profile-page":Qe(null),ye(Y?"student-page":"session-page");break;case"attendance-page":ye("student-page");break;case"student-page":Ke(null),Ge(),ye("session-page");break;case"settings-page":case"session-page":qe(null),ye("class-management-page");break}return}if(Y){const ae=B.key.toLowerCase();switch(" ascfg".includes(ae)&&B.preventDefault(),ae){case" ":y.click();break;case"a":u.classList.contains("active")?history.back():(nt(),ye("attendance-page"));break;case"s":document.getElementById("session-page").classList.contains("active")&&history.back();break;case"c":document.querySelector(".back-to-classes-btn").click();break;case"f":const ce=document.querySelector(".action-column .search-icon");ce&&ce.click();break;case"g":if(studentProfilePage.classList.contains("active"))history.back();else{const te=Y.lastSelectedWinnerId;if(te){const re=A.students.find(pe=>pe.identity.studentId===te);re&&(Qe(re),(void 0)(),ye("student-profile-page"))}else G("⚠️ابتدا یک نفر را انتخاب کنید تا پروفایل او نمایش داده شود.")}break;case"arrowleft":{const te=document.querySelector('button[title="برنده قبلی"]');te&&!te.disabled&&(B.preventDefault(),te.click());break}case"arrowright":{const te=document.querySelector('button[title="برنده بعدی"]');te&&!te.disabled&&(B.preventDefault(),te.click());break}}}}});function ze(){k.style.width="0",x.classList.add("modal-closing"),setTimeout(()=>{x.classList.remove("modal-visible","modal-closing")},300)}function zt(){be("آیا از خروج از حالت نمایش (Demo) مطمئن هستید؟ با خروج، تمام تغییرات آزمایشی شما حذف شده و داده‌های اصلی شما بازیابی خواهند شد.",()=>{ri(),qe(null),Ke(null),Qe(null),We(),ye("class-management-page"),Un(),ze()},{confirmText:"خروج",confirmClass:"btn-success"})}d(".global-search-container .animated-search-container",Wn),d(".action-column-header .animated-search-container",cn),ic(),[Ee,Ni,ct,xi].forEach(B=>{B&&_a(B)});function en(B,P){const F=we(P.students).filter(Ie=>Ie.identity.studentId!==B.identity.studentId);if(F.length===0)return;const J=F.reduce((Ie,Ue)=>Ue.statusCounters.totalSelections>Ie.statusCounters.totalSelections?Ue:Ie,F[0]);if(!J||J.statusCounters.totalSelections===0)return;B.categoryCounts=JSON.parse(JSON.stringify(J.categoryCounts)),B.statusCounters.totalSelections=J.statusCounters.totalSelections;const ae=F.reduce((Ie,Ue)=>Ie+Ue.statusCounters.totalSelections,0),ce=F.reduce((Ie,Ue)=>Ie+(Ue.statusCounters.missedChances||0),0),te=ae>0?ce/ae:0;B.statusCounters.missedChances=Math.round(B.statusCounters.totalSelections*te);const re=we(P.categories),pe={};re.forEach(Ie=>{const Ue=F.reduce((Ss,ks)=>Ss+(ks.categoryCounts[Ie.name]||0),0),Es=F.reduce((Ss,ks)=>Ss+(ks.categoryIssues[Ie.name]||0),0);pe[Ie.name]=Ue>0?Es/Ue:0}),re.forEach(Ie=>{const Ue=B.categoryCounts[Ie.name]||0,Es=pe[Ie.name]||0;B.categoryIssues[Ie.name]=Math.round(Ue*Es)});const Ce=P.liveSession;Ce?B.onboardingSession=Ce.sessionNumber:B.onboardingSession=P.sessions.length+1;const Le=we(P.sessions).filter(Ie=>Ie.isFinished&&!Ie.isCancelled),Je="📝 یادداشت خودکار سیستم",ws=`این دانش‌آموز  از جلسه شماره ${Le.length} به کلاس اضافه شد. آمار مشارکت او بر اساس فعال‌ترین دانش‌آموز و آمار «فرصت از دست رفته» او بر اساس میانگین کلاس ثبت گردید:`,gt=[];B.statusCounters.totalSelections>0&&gt.push(`کل انتخاب‌ها: ${B.statusCounters.totalSelections}`),B.statusCounters.missedChances>0&&gt.push(`فرصت‌های از دست رفته: ${B.statusCounters.missedChances}`);for(const Ie in B.categoryCounts){const Ue=B.categoryCounts[Ie];Ue>0&&gt.push(`انتخاب در «${Ie}»: ${Ue}`)}for(const Ie in B.categoryIssues){const Ue=B.categoryIssues[Ie];Ue>0&&gt.push(`مشکل در «${Ie}»: ${Ue}`)}if(gt.length>0){const Ie=`${Je}
${ws}

- ${gt.join(`
- `)}`;B.addNote(Ie)}}function kn(B,P=""){const F=B>1?"دانش‌آموزان جدید":"دانش‌آموز جدید";let J=`✅ ${B} ${F} با موفقیت اضافه شدند.
`;J+="💡 چون این کلاس جلسات برگزار شده دارد، برای این افراد آمار پایه‌ای (متناسب با کلاس) ثبت شد تا در فرایند انتخاب اختلالی ایجاد نشود.",P&&(J+=`
${P}`),be(J,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}const gs="22.3.0",ys="921";{const B=` (ساخت ${ys})`;document.getElementById("app-version").textContent=`نسخه ${gs}${B}`}function _n(){console.log("Starting universal backfill for writing scores...");let B=0;for(const P in ie){const F=ie[P];if(F.isDeleted)continue;let J=0;we(F.students).forEach(ce=>{const te=ce.logs.scores;if(!(te&&te.writing&&te.writing.length>0)){let pe=-1;for(const Ce in te)Ce!=="writing"&&te[Ce].forEach(Le=>{Le.value>pe&&(pe=Le.value)});if(pe>-1){const Ce=`Automatically assigned based on the highest score (${pe}) from other skills.`;ce.addScore("Writing",pe,Ce),J++}}}),J>0&&(console.log(`Updated ${J} student(s) in class: ${F.info.name}.`),B+=J)}B>0?(oe(),console.log(`Update complete. A total of ${B} student(s) were updated across all classes. Data saved.`),document.getElementById("student-page").classList.contains("active")&&Oe()):console.log("No students needed updating in any class.")}window.backfillWritingScoresForAll=_n;function It(){console.log("Starting backfill for 'outOfClassCount' and 'wasOutOfClass' properties...");let B=0,P=0;const F=localStorage.getItem("teacherAssistantData_v2");if(!F){console.log("No data found in localStorage. Nothing to do.");return}const J=JSON.parse(F);for(const ae in J){const ce=J[ae];ce.students&&ce.students.forEach(te=>{te.statusCounters&&typeof te.statusCounters.outOfClassCount>"u"&&(te.statusCounters.outOfClassCount=0,B++)}),ce.sessions&&ce.sessions.forEach(te=>{if(te.studentRecords)for(const re in te.studentRecords){const pe=te.studentRecords[re];typeof pe.wasOutOfClass>"u"&&(pe.wasOutOfClass=!1,P++)}})}localStorage.setItem("teacherAssistantData_v2",JSON.stringify(J)),console.log(`Backfill complete. Updated ${B} students and ${P} session records. Data saved.`),Yn(),A&&Oe()}window.backfillExitCounters=It;function Pt(){console.log("🧹 Starting orphaned data cleanup...");let B=0;for(const P in ie){const F=ie[P];if(F.isDeleted)continue;let J=!1;const ae=new Set(F.students.filter(re=>!re.isDeleted).map(re=>re.identity.studentId)),ce=new Map(F.students.map(re=>[re.identity.studentId,re.identity.name])),te=[];F.sessions.forEach(re=>{if(re.isDeleted)return;const pe=[];for(const Ce in re.studentRecords)if(!ae.has(Ce)){const Le=ce.get(Ce)||"Unknown/Deleted";pe.push(`  - Removed student record for: ${Le} (ID: ${Ce})`),delete re.studentRecords[Ce],B++,J=!0}for(const Ce in re.lastWinnerByCategory){const Le=re.lastWinnerByCategory[Ce];if(!ae.has(Le)){const Je=ce.get(Le)||"Unknown/Deleted";pe.push(`  - Removed '${Ce}' last winner: ${Je} (ID: ${Le})`),delete re.lastWinnerByCategory[Ce],B++,J=!0}}if(re.lastSelectedWinnerId&&!ae.has(re.lastSelectedWinnerId)){const Ce=re.lastSelectedWinnerId,Le=ce.get(Ce)||"Unknown/Deleted";pe.push(`  - Cleared 'lastSelectedWinnerId': ${Le} (ID: ${Ce})`),re.lastSelectedWinnerId=null,B++,J=!0}if(pe.length>0){const Le=rt(F).get(re.sessionNumber)||`(#${re.sessionNumber})`;te.push({sessionDisplayNumber:Le,logs:pe})}}),J&&(console.group(`➡️ Class: ${P}`),te.forEach(re=>{console.groupCollapsed(`  Session ${re.sessionDisplayNumber}`),re.logs.forEach(pe=>console.warn(pe)),console.groupEnd()}),console.groupEnd())}B>0?(oe(),console.log(`✅ Cleanup complete! Found and removed ${B} orphaned references. Data saved.`)):console.log("✅ No orphaned data found. Your data is clean!")}window.cleanupOrphanedData=Pt;function io(B){if(!B||!B.classroomName)return;const P=ie[B.classroomName];if(!P){G("⚠️ کلاس مربوط به این گزارش یافت نشد.");return}qe(P),ge(),setTimeout(()=>{switch(B.type){case"VIEW_STUDENT_PROFILE":{const F=P.students.find(J=>J.identity.studentId===B.studentId);F?Fe(F):G("⚠️ دانش‌آموز مورد نظر یافت نشد.");break}case"VIEW_TRASH":wn(),ye("trash-page");break;case"VIEW_SESSIONS":Ge(),ye("session-page");break;case"VIEW_CLASS_NOTE":hs(P);break;case"VIEW_CLASS_SETTINGS":kt(P);break}},300)}R.addEventListener("click",()=>{Sa()}),O.addEventListener("click",()=>{ge()}),de.addEventListener("click",()=>{const B=se.value.trim(),P=ee.checked;if(!B){ba.style.display==="flex"?be("کادر یادداشت خالی است. آیا مطمئنید که می‌خواهید یادداشت‌های قبلی دانش‌آموزان انتخاب‌شده را پاک کنید؟",()=>{ge(),Us("",!1)},{confirmText:"پاک کردن",confirmClass:"btn-warning"}):G("⚠️ لطفاً متن یادداشت را وارد کنید.");return}ge(()=>{Us(B,P)})});const xt=document.getElementById("screen-saver-overlay");let vs;const oo=2*60*1e3,La=["mousemove","keypress","scroll","click","touchstart"];function ro(){xt.classList.add("visible")}function Ta(){xt.classList.contains("visible")&&xt.classList.remove("visible")}function In(){Ta(),clearTimeout(vs),vs=setTimeout(ro,oo)}function xn(B){B.preventDefault(),B.stopPropagation(),setTimeout(In,0)}function Ba(){In(),La.forEach(P=>window.addEventListener(P,In)),xt.addEventListener("click",xn),xt.addEventListener("touchstart",xn);const B="22.3.0";{const P=document.getElementById("screen-saver-version");P&&(P.textContent=`v${B}`)}}function co(){clearTimeout(vs),Ta(),La.forEach(B=>window.removeEventListener(B,In)),xt.removeEventListener("click",xn),xt.removeEventListener("touchstart",xn)}document.getElementById("app-settings-modal");const Da=document.getElementById("app-settings-nav-btn"),Na=document.getElementById("close-settings-btn"),Aa=document.getElementById("setting-sound-toggle"),Oa=document.getElementById("setting-vibration-toggle"),Ma=document.getElementById("setting-screensaver-toggle");Da&&Da.addEventListener("click",()=>{ze(),Aa.checked=Pe.isSoundEnabled,Oa.checked=Pe.isVibrationEnabled,Ma.checked=Pe.isScreenSaverEnabled,Ae("app-settings-modal")}),Na&&Na.addEventListener("click",()=>{ge()}),Aa.addEventListener("change",B=>{wt({isSoundEnabled:B.target.checked}),B.target.checked&&Ts()}),Oa.addEventListener("change",B=>{wt({isVibrationEnabled:B.target.checked}),B.target.checked&&navigator.vibrate&&navigator.vibrate(50)}),Pe.isScreenSaverEnabled&&Ba(),Ma.addEventListener("change",B=>{B.target.checked?(wt({isScreenSaverEnabled:!0}),Ba()):(wt({isScreenSaverEnabled:!1}),co())}),qt(Xe,()=>{if(Is=!0,!Re){G("⚠️ ابتدا یک دسته‌بندی انتخاب کنید.");return}if(!Re.isGradedCategory){G("⚠️ این دسته‌بندی نمره‌دار نیست.");return}Xa(!Tt),vt(-1),Vt(null),$e(),Cn(Re),Nt.classList.toggle("assessment-mode-active",Tt),G(Tt?"حالت انتخاب برای نمره‌دهی فعال شد.":"حالت انتخاب معمولی فعال شد.")});const bs=document.getElementById("new-category-modal-weight-group");if(he&&bs){he.addEventListener("change",P=>{bs.style.display=P.target.checked?"flex":"none"});const B=he.checked;bs.style.display=B?"flex":"none"}Ne.addEventListener("click",()=>{gn((B,P,F)=>{if(B){if(A.categories.some(J=>J.name.toLowerCase()===B.toLowerCase())){G("⚠️ این دسته‌بندی قبلاً اضافه شده است.");return}A.categories.push(new yt(B,"",P,F)),oe(),Qt()}}),ao()}),he.addEventListener("change",B=>{Me.style.display=B.target.checked?"flex":"none"})});function ac(e,a){if(!Y||Y.isFinished){G("⚠️ امکان لغو انتخاب در جلسه خاتمه یافته وجود ندارد.");return}if(Tt){be(`آیا از لغو وضعیت نمره‌دهی «${e.identity.name}» مطمئن هستید؟ این دانش‌آموز به لیست انتظار بازمی‌گردد.`,()=>{const o=Re.id,n=ot[o];n&&(n.scoredThisSession=n.scoredThisSession.filter(i=>i!==e.identity.studentId)),Vt(null),Oe(),$e(),oe(),G(`✅ «${e.identity.name}» به لیست انتظار نمره بازگشت.`)});return}const t=Y.winnerHistory;if(!(tt===t.length-1)||t.length===0){G("⚠️ فقط آخرین انتخاب قابل لغو است.");return}if(t[t.length-1].winner.identity.studentId!==e.identity.studentId){console.error("Undo mismatch!");return}be(`آیا از حذف انتخاب «${e.identity.name}» برای «${a}» مطمئن هستید؟ آمار این انتخاب بازگردانی خواهد شد.`,()=>{const o=Y.winnerHistory,n=o.pop();if(!n)return;const i=n.winner,s=n.categoryName,r=i.identity.studentId;i.statusCounters.totalSelections=Math.max(0,i.statusCounters.totalSelections-1),i.categoryCounts[s]&&(i.categoryCounts[s]=Math.max(0,i.categoryCounts[s]-1));const l=Y.studentRecords[r];if(l&&l.selections[s]&&(l.selections[s]=Math.max(0,l.selections[s]-1)),n.rating){const p=n.rating;i.qualitativeStats&&i.qualitativeStats[s]&&i.qualitativeStats[s][p]>0&&i.qualitativeStats[s][p]--}let f=null;for(let p=o.length-1;p>=0;p--)if(o[p].categoryName===s){f=o[p].winner.identity.studentId;break}f?Y.lastWinnerByCategory[s]=f:delete Y.lastWinnerByCategory[s],vt(o.length-1),Oe(),$e(),oe(),G(`✅ انتخاب «${i.identity.name}» لغو شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}function ic(){const e=document.getElementById("session-dashboard-page"),a=document.getElementById("student-stats-table-container");if(!e)return;let t=0,c=0;e.addEventListener("touchstart",n=>{if(a&&a.contains(n.target)){const i=n.target.closest("td, th");i&&i.parentElement.firstElementChild===i?t=n.changedTouches[0].screenX:t=0}else t=n.changedTouches[0].screenX},{passive:!0}),e.addEventListener("touchend",n=>{t!==0&&(c=n.changedTouches[0].screenX,o())});function o(){const i=t-c;Math.abs(i)>150&&(document.getElementById("selector-tab-btn").classList.contains("active")?(ye("session-dashboard-page",{tab:"attendance"}),Yt("attendance")):(ye("session-dashboard-page",{tab:"selector"}),Yt("selector"))),t=0,c=0}}function Ua(e,a){const t=a.toLowerCase();return(e.logs.scores[t]||[]).filter(o=>!o.isDeleted).length}function oc(e,a){const t=a.id;ot[t]||(ot[t]={toBeScored:[],scoredThisSession:[]});const c=ot[t],n=we(e.students).filter(r=>!c.scoredThisSession.includes(r.identity.studentId));if(n.length===0)return c.toBeScored=[],[];const i=n.map(r=>Ua(r,a.name)),s=Math.min(...i);return c.toBeScored=n.filter(r=>Ua(r,a.name)===s).map(r=>r.identity.studentId),c.toBeScored}function rc(e,a){const t=oc(e,a);if(t.length===0)return null;const c=Math.floor(Math.random()*t.length),o=t[c];return fa(a.id,o),e.students.find(n=>n.identity.studentId===o)}
