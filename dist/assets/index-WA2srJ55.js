(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))c(o);new MutationObserver(o=>{for(const t of o)if(t.type==="childList")for(const i of t.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&c(i)}).observe(document,{childList:!0,subtree:!0});function e(o){const t={};return o.integrity&&(t.integrity=o.integrity),o.referrerPolicy&&(t.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?t.credentials="include":o.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function c(o){if(o.ep)return;o.ep=!0;const t=e(o);fetch(o.href,t)}})();class yn{constructor(a){this.identity={name:a.name,firstName:a.firstName||null,lastName:a.lastName||null,studentId:a.studentId||`id_${new Date().getTime()}_${Math.random()}`,branchName:a.branchName||null,ageGroup:a.ageGroup||"adult",level:a.level||null,contact:{social:a.socialContact||null,parent:a.parentContact||null}},this.isDeleted=!1,this.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0,outOfClassCount:0},this.categoryCounts={},this.categoryIssues={},this.logs={parentContacts:[],scores:{},discipline:{},sessionHistory:{}},this.profile={notes:[],tags:[]},this.finalClassActivityScore=null,this.onboardingSession=null}addScore(a,e,c){if(e>100||e<0){console.log("نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}const o=a.toLowerCase();this.logs.scores[o]||(this.logs.scores[o]=[]);const t=new fa(a,e,c);this.logs.scores[o].push(t)}addNote(a,e=null){const c=new ma(a,e);this.profile.notes.push(c)}getOverallAverageScore(){let a=0,e=0;for(const o in this.logs.scores)this.logs.scores[o].forEach(t=>{t.isDeleted||(a+=t.value,e++)});if(e===0)return null;const c=a/e;return Math.round(c*100)/100}}class fa{constructor(a,e,c=""){this.id=`score_${new Date().getTime()}`,this.skill=a,this.value=e,this.timestamp=new Date,this.comment=c,this.isDeleted=!1}}class ma{constructor(a,e=null){this.id=`note_${new Date().getTime()}`,this.timestamp=new Date,this.content=a,this.isDeleted=!1,this.source=e}}class is{constructor(a="complete",e=""){this.status=a,this.comment=e,this.timestamp=new Date}}class ii{constructor(a){this.sessionNumber=a,this.startTime=new Date,this.createdAt=new Date,this.note="",this.isDeleted=!1,this.endTime=null,this.isFinished=!1,this.isMakeup=!1,this.isCancelled=!1,this.studentRecords={},this.lastWinnerByCategory={},this.lastUsedCategoryId=null,this.lastSelectedWinnerId=null,this.winnerHistory=[]}end(){this.isFinished=!0,this.endTime=new Date}markAsMakeup(){this.isMakeup=!this.isMakeup}initializeStudentRecord(a){this.studentRecords[a]||(this.studentRecords[a]={attendance:"present",homework:new is,selections:{},hadIssue:!1,wasOutOfClass:!1})}setAttendance(a,e){this.initializeStudentRecord(a),this.studentRecords[a].attendance=e}setHomeworkStatus(a,e){this.initializeStudentRecord(a),this.studentRecords[a].homework.status=e}selectNextWinner(a,e,c){if(!e||e.length===0)return console.log("هیچ دانش‌آموزی در کلاس برای انتخاب وجود ندارد."),null;const o=this.lastWinnerByCategory[a];let t=e.filter(h=>h.identity.studentId!==o&&!h.isDeleted);if(t.length===0&&(t=e),t.length===0)return null;const i=(h,f)=>h.categoryCounts[f]||0,s=Math.min(...t.map(h=>i(h,a))),r=t.filter(h=>i(h,a)===s);let d;if(r.length===1)d=r[0];else if(r.length>1){const h=c.filter(b=>!b.isDeleted&&b.name!==a).map(b=>b.name),f=r.map(b=>{const y=h.reduce((C,_)=>C+i(b,_),0);return{student:b,otherCategoriesTotal:y}}),v=Math.min(...f.map(b=>b.otherCategoriesTotal)),u=f.filter(b=>b.otherCategoriesTotal===v).map(b=>b.student);u.length===1?d=u[0]:d=u[Math.floor(Math.random()*u.length)]}else d=t[Math.floor(Math.random()*t.length)];const m=d.identity.studentId;this.initializeStudentRecord(m);const g=(this.studentRecords[m].selections[a]||0)+1;return this.studentRecords[m].selections[a]=g,d.statusCounters.totalSelections++,d.categoryCounts[a]=(d.categoryCounts[a]||0)+1,this.lastWinnerByCategory[a]=m,d}}class as{constructor(a){this.info={name:a.name||"NotNamed",teacherName:a.teacherName||null,type:a.type||"in-person",term:a.term||null,scheduleText:a.scheduleText||null,level:a.level||null,creationDate:a.creationDate?new Date(a.creationDate):new Date,scheduleCode:a.scheduleCode||`code_${new Date().getTime()}`,scheduleDays:a.scheduleDays||[],scheduleStartTime:a.scheduleStartTime||null,scheduleEndTime:a.scheduleEndTime||null},this.students=[],this.sessions=[],this.note="",this.isDeleted=!1,this.categories=[new ft("Vocabulary","Questions about words and meanings."),new ft("Grammar","Questions about sentence structure and rules."),new ft("Listening",void 0,!0),new ft("Speaking",void 0,!0),new ft("Reading",void 0,!0),new ft("Writing",void 0,!0)],this.futurePlans={}}addStudent(a){this.students.push(a)}removeStudent(a){this.students=this.students.filter(e=>e.identity.studentId!==a)}startNewSession(){const a=this.sessions.length+1,e=new ii(a);return this.sessions.push(e),e}endSpecificSession(a){const e=this.getSession(a);return e&&!e.isFinished?(e.end(),!0):!1}getSession(a){return this.sessions.find(e=>e.sessionNumber===a)}markAsMakeup(a){const e=this.getSession(a);e&&e.markAsMakeup()}planForSession(a,e){this.futurePlans[a]=e}hasSessionToday(){const a=new Date().toDateString();return this.sessions.some(e=>!e.isDeleted&&e.startTime.toDateString()===a)}selectNextWinner(a,e){return e?e.selectNextWinner(a,this.students,this.categories):null}get liveSession(){for(let a=this.sessions.length-1;a>=0;a--)if(!this.sessions[a].isFinished)return this.sessions[a];return null}endLiveSession(){const a=this.liveSession;return a?(a.end(),!0):!1}calculateFinalStudentScore(a){const e=a.logs.scores,c=["reading","writing"];for(const h of c)if(!e[h]||e[h].length===0)return null;const o=e.listening&&e.listening.length>0,t=e.speaking&&e.speaking.length>0;if(!o&&!t)return null;const i=h=>e[h].reduce((v,u)=>v+u.value,0)/e[h].length;let s;o&&t?s=(i("listening")+i("speaking"))/2:o?s=i("listening"):s=i("speaking");const r=i("reading"),d=i("writing"),g=(s*3+r*2+d*1)/6;return Math.trunc(g*10)/10}assignAllFinalScores(){let a=0,e=[];console.log("شروع عملیات محاسبه نمره نهایی برای تمام دانش‌آموزان..."),this.students.forEach(o=>{const t=this.calculateFinalStudentScore(o);t!==null?(o.finalClassActivityScore=t,a++):(o.finalClassActivityScore=null,e.push(o.identity.name))});const c=e.length;console.log(`عملیات پایان یافت. تعداد نمرات موفق: ${a} | تعداد ناموفق (نمرات ناقص): ${c}`),c>0&&(console.log("اسامی دانش‌آموزانی که نمراتشان ناقص است:"),e.forEach(o=>console.log(`- ${o}`)))}}class ft{constructor(a,e="",c=!1){this.id=`cat_${new Date().getTime()}_${Math.random()}`,this.name=a,this.description=e,this.isDeleted=!1,this.isGradedCategory=c,this.isDeleted=!1}}var pn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ai(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}function gn(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var ri={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/(function(n,a){(function(e){n.exports=e()})(function(){return function e(c,o,t){function i(d,m){if(!o[d]){if(!c[d]){var g=typeof gn=="function"&&gn;if(!m&&g)return g(d,!0);if(s)return s(d,!0);var h=new Error("Cannot find module '"+d+"'");throw h.code="MODULE_NOT_FOUND",h}var f=o[d]={exports:{}};c[d][0].call(f.exports,function(v){var u=c[d][1][v];return i(u||v)},f,f.exports,e,c,o,t)}return o[d].exports}for(var s=typeof gn=="function"&&gn,r=0;r<t.length;r++)i(t[r]);return i}({1:[function(e,c,o){var t=e("./utils"),i=e("./support"),s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";o.encode=function(r){for(var d,m,g,h,f,v,u,b=[],y=0,C=r.length,_=C,S=t.getTypeOf(r)!=="string";y<r.length;)_=C-y,g=S?(d=r[y++],m=y<C?r[y++]:0,y<C?r[y++]:0):(d=r.charCodeAt(y++),m=y<C?r.charCodeAt(y++):0,y<C?r.charCodeAt(y++):0),h=d>>2,f=(3&d)<<4|m>>4,v=1<_?(15&m)<<2|g>>6:64,u=2<_?63&g:64,b.push(s.charAt(h)+s.charAt(f)+s.charAt(v)+s.charAt(u));return b.join("")},o.decode=function(r){var d,m,g,h,f,v,u=0,b=0,y="data:";if(r.substr(0,y.length)===y)throw new Error("Invalid base64 input, it looks like a data url.");var C,_=3*(r=r.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(r.charAt(r.length-1)===s.charAt(64)&&_--,r.charAt(r.length-2)===s.charAt(64)&&_--,_%1!=0)throw new Error("Invalid base64 input, bad content length.");for(C=i.uint8array?new Uint8Array(0|_):new Array(0|_);u<r.length;)d=s.indexOf(r.charAt(u++))<<2|(h=s.indexOf(r.charAt(u++)))>>4,m=(15&h)<<4|(f=s.indexOf(r.charAt(u++)))>>2,g=(3&f)<<6|(v=s.indexOf(r.charAt(u++))),C[b++]=d,f!==64&&(C[b++]=m),v!==64&&(C[b++]=g);return C}},{"./support":30,"./utils":32}],2:[function(e,c,o){var t=e("./external"),i=e("./stream/DataWorker"),s=e("./stream/Crc32Probe"),r=e("./stream/DataLengthProbe");function d(m,g,h,f,v){this.compressedSize=m,this.uncompressedSize=g,this.crc32=h,this.compression=f,this.compressedContent=v}d.prototype={getContentWorker:function(){var m=new i(t.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new r("data_length")),g=this;return m.on("end",function(){if(this.streamInfo.data_length!==g.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),m},getCompressedWorker:function(){return new i(t.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},d.createWorkerFrom=function(m,g,h){return m.pipe(new s).pipe(new r("uncompressedSize")).pipe(g.compressWorker(h)).pipe(new r("compressedSize")).withStreamInfo("compression",g)},c.exports=d},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,c,o){var t=e("./stream/GenericWorker");o.STORE={magic:"\0\0",compressWorker:function(){return new t("STORE compression")},uncompressWorker:function(){return new t("STORE decompression")}},o.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,c,o){var t=e("./utils"),i=function(){for(var s,r=[],d=0;d<256;d++){s=d;for(var m=0;m<8;m++)s=1&s?3988292384^s>>>1:s>>>1;r[d]=s}return r}();c.exports=function(s,r){return s!==void 0&&s.length?t.getTypeOf(s)!=="string"?function(d,m,g,h){var f=i,v=h+g;d^=-1;for(var u=h;u<v;u++)d=d>>>8^f[255&(d^m[u])];return-1^d}(0|r,s,s.length,0):function(d,m,g,h){var f=i,v=h+g;d^=-1;for(var u=h;u<v;u++)d=d>>>8^f[255&(d^m.charCodeAt(u))];return-1^d}(0|r,s,s.length,0):0}},{"./utils":32}],5:[function(e,c,o){o.base64=!1,o.binary=!1,o.dir=!1,o.createFolders=!0,o.date=null,o.compression=null,o.compressionOptions=null,o.comment=null,o.unixPermissions=null,o.dosPermissions=null},{}],6:[function(e,c,o){var t=null;t=typeof Promise<"u"?Promise:e("lie"),c.exports={Promise:t}},{lie:37}],7:[function(e,c,o){var t=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",i=e("pako"),s=e("./utils"),r=e("./stream/GenericWorker"),d=t?"uint8array":"array";function m(g,h){r.call(this,"FlateWorker/"+g),this._pako=null,this._pakoAction=g,this._pakoOptions=h,this.meta={}}o.magic="\b\0",s.inherits(m,r),m.prototype.processChunk=function(g){this.meta=g.meta,this._pako===null&&this._createPako(),this._pako.push(s.transformTo(d,g.data),!1)},m.prototype.flush=function(){r.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},m.prototype.cleanUp=function(){r.prototype.cleanUp.call(this),this._pako=null},m.prototype._createPako=function(){this._pako=new i[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var g=this;this._pako.onData=function(h){g.push({data:h,meta:g.meta})}},o.compressWorker=function(g){return new m("Deflate",g)},o.uncompressWorker=function(){return new m("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(e,c,o){function t(f,v){var u,b="";for(u=0;u<v;u++)b+=String.fromCharCode(255&f),f>>>=8;return b}function i(f,v,u,b,y,C){var _,S,I=f.file,x=f.compression,L=C!==d.utf8encode,N=s.transformTo("string",C(I.name)),R=s.transformTo("string",d.utf8encode(I.name)),P=I.comment,Q=s.transformTo("string",C(P)),k=s.transformTo("string",d.utf8encode(P)),z=R.length!==I.name.length,p=k.length!==P.length,H="",ue="",j="",fe=I.dir,F=I.date,ne={crc32:0,compressedSize:0,uncompressedSize:0};v&&!u||(ne.crc32=f.crc32,ne.compressedSize=f.compressedSize,ne.uncompressedSize=f.uncompressedSize);var O=0;v&&(O|=8),L||!z&&!p||(O|=2048);var M=0,oe=0;fe&&(M|=16),y==="UNIX"?(oe=798,M|=function(X,De){var Oe=X;return X||(Oe=De?16893:33204),(65535&Oe)<<16}(I.unixPermissions,fe)):(oe=20,M|=function(X){return 63&(X||0)}(I.dosPermissions)),_=F.getUTCHours(),_<<=6,_|=F.getUTCMinutes(),_<<=5,_|=F.getUTCSeconds()/2,S=F.getUTCFullYear()-1980,S<<=4,S|=F.getUTCMonth()+1,S<<=5,S|=F.getUTCDate(),z&&(ue=t(1,1)+t(m(N),4)+R,H+="up"+t(ue.length,2)+ue),p&&(j=t(1,1)+t(m(Q),4)+k,H+="uc"+t(j.length,2)+j);var te="";return te+=`
\0`,te+=t(O,2),te+=x.magic,te+=t(_,2),te+=t(S,2),te+=t(ne.crc32,4),te+=t(ne.compressedSize,4),te+=t(ne.uncompressedSize,4),te+=t(N.length,2),te+=t(H.length,2),{fileRecord:g.LOCAL_FILE_HEADER+te+N+H,dirRecord:g.CENTRAL_FILE_HEADER+t(oe,2)+te+t(Q.length,2)+"\0\0\0\0"+t(M,4)+t(b,4)+N+H+Q}}var s=e("../utils"),r=e("../stream/GenericWorker"),d=e("../utf8"),m=e("../crc32"),g=e("../signature");function h(f,v,u,b){r.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=v,this.zipPlatform=u,this.encodeFileName=b,this.streamFiles=f,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}s.inherits(h,r),h.prototype.push=function(f){var v=f.meta.percent||0,u=this.entriesCount,b=this._sources.length;this.accumulate?this.contentBuffer.push(f):(this.bytesWritten+=f.data.length,r.prototype.push.call(this,{data:f.data,meta:{currentFile:this.currentFile,percent:u?(v+100*(u-b-1))/u:100}}))},h.prototype.openedSource=function(f){this.currentSourceOffset=this.bytesWritten,this.currentFile=f.file.name;var v=this.streamFiles&&!f.file.dir;if(v){var u=i(f,v,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:u.fileRecord,meta:{percent:0}})}else this.accumulate=!0},h.prototype.closedSource=function(f){this.accumulate=!1;var v=this.streamFiles&&!f.file.dir,u=i(f,v,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(u.dirRecord),v)this.push({data:function(b){return g.DATA_DESCRIPTOR+t(b.crc32,4)+t(b.compressedSize,4)+t(b.uncompressedSize,4)}(f),meta:{percent:100}});else for(this.push({data:u.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},h.prototype.flush=function(){for(var f=this.bytesWritten,v=0;v<this.dirRecords.length;v++)this.push({data:this.dirRecords[v],meta:{percent:100}});var u=this.bytesWritten-f,b=function(y,C,_,S,I){var x=s.transformTo("string",I(S));return g.CENTRAL_DIRECTORY_END+"\0\0\0\0"+t(y,2)+t(y,2)+t(C,4)+t(_,4)+t(x.length,2)+x}(this.dirRecords.length,u,f,this.zipComment,this.encodeFileName);this.push({data:b,meta:{percent:100}})},h.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},h.prototype.registerPrevious=function(f){this._sources.push(f);var v=this;return f.on("data",function(u){v.processChunk(u)}),f.on("end",function(){v.closedSource(v.previous.streamInfo),v._sources.length?v.prepareNextSource():v.end()}),f.on("error",function(u){v.error(u)}),this},h.prototype.resume=function(){return!!r.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},h.prototype.error=function(f){var v=this._sources;if(!r.prototype.error.call(this,f))return!1;for(var u=0;u<v.length;u++)try{v[u].error(f)}catch{}return!0},h.prototype.lock=function(){r.prototype.lock.call(this);for(var f=this._sources,v=0;v<f.length;v++)f[v].lock()},c.exports=h},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,c,o){var t=e("../compressions"),i=e("./ZipFileWorker");o.generateWorker=function(s,r,d){var m=new i(r.streamFiles,d,r.platform,r.encodeFileName),g=0;try{s.forEach(function(h,f){g++;var v=function(C,_){var S=C||_,I=t[S];if(!I)throw new Error(S+" is not a valid compression method !");return I}(f.options.compression,r.compression),u=f.options.compressionOptions||r.compressionOptions||{},b=f.dir,y=f.date;f._compressWorker(v,u).withStreamInfo("file",{name:h,dir:b,date:y,comment:f.comment||"",unixPermissions:f.unixPermissions,dosPermissions:f.dosPermissions}).pipe(m)}),m.entriesCount=g}catch(h){m.error(h)}return m}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,c,o){function t(){if(!(this instanceof t))return new t;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var i=new t;for(var s in this)typeof this[s]!="function"&&(i[s]=this[s]);return i}}(t.prototype=e("./object")).loadAsync=e("./load"),t.support=e("./support"),t.defaults=e("./defaults"),t.version="3.10.1",t.loadAsync=function(i,s){return new t().loadAsync(i,s)},t.external=e("./external"),c.exports=t},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,c,o){var t=e("./utils"),i=e("./external"),s=e("./utf8"),r=e("./zipEntries"),d=e("./stream/Crc32Probe"),m=e("./nodejsUtils");function g(h){return new i.Promise(function(f,v){var u=h.decompressed.getContentWorker().pipe(new d);u.on("error",function(b){v(b)}).on("end",function(){u.streamInfo.crc32!==h.decompressed.crc32?v(new Error("Corrupted zip : CRC32 mismatch")):f()}).resume()})}c.exports=function(h,f){var v=this;return f=t.extend(f||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:s.utf8decode}),m.isNode&&m.isStream(h)?i.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):t.prepareContent("the loaded zip file",h,!0,f.optimizedBinaryString,f.base64).then(function(u){var b=new r(f);return b.load(u),b}).then(function(u){var b=[i.Promise.resolve(u)],y=u.files;if(f.checkCRC32)for(var C=0;C<y.length;C++)b.push(g(y[C]));return i.Promise.all(b)}).then(function(u){for(var b=u.shift(),y=b.files,C=0;C<y.length;C++){var _=y[C],S=_.fileNameStr,I=t.resolve(_.fileNameStr);v.file(I,_.decompressed,{binary:!0,optimizedBinaryString:!0,date:_.date,dir:_.dir,comment:_.fileCommentStr.length?_.fileCommentStr:null,unixPermissions:_.unixPermissions,dosPermissions:_.dosPermissions,createFolders:f.createFolders}),_.dir||(v.file(I).unsafeOriginalName=S)}return b.zipComment.length&&(v.comment=b.zipComment),v})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,c,o){var t=e("../utils"),i=e("../stream/GenericWorker");function s(r,d){i.call(this,"Nodejs stream input adapter for "+r),this._upstreamEnded=!1,this._bindStream(d)}t.inherits(s,i),s.prototype._bindStream=function(r){var d=this;(this._stream=r).pause(),r.on("data",function(m){d.push({data:m,meta:{percent:0}})}).on("error",function(m){d.isPaused?this.generatedError=m:d.error(m)}).on("end",function(){d.isPaused?d._upstreamEnded=!0:d.end()})},s.prototype.pause=function(){return!!i.prototype.pause.call(this)&&(this._stream.pause(),!0)},s.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},c.exports=s},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,c,o){var t=e("readable-stream").Readable;function i(s,r,d){t.call(this,r),this._helper=s;var m=this;s.on("data",function(g,h){m.push(g)||m._helper.pause(),d&&d(h)}).on("error",function(g){m.emit("error",g)}).on("end",function(){m.push(null)})}e("../utils").inherits(i,t),i.prototype._read=function(){this._helper.resume()},c.exports=i},{"../utils":32,"readable-stream":16}],14:[function(e,c,o){c.exports={isNode:typeof Buffer<"u",newBufferFrom:function(t,i){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(t,i);if(typeof t=="number")throw new Error('The "data" argument must not be a number');return new Buffer(t,i)},allocBuffer:function(t){if(Buffer.alloc)return Buffer.alloc(t);var i=new Buffer(t);return i.fill(0),i},isBuffer:function(t){return Buffer.isBuffer(t)},isStream:function(t){return t&&typeof t.on=="function"&&typeof t.pause=="function"&&typeof t.resume=="function"}}},{}],15:[function(e,c,o){function t(I,x,L){var N,R=s.getTypeOf(x),P=s.extend(L||{},m);P.date=P.date||new Date,P.compression!==null&&(P.compression=P.compression.toUpperCase()),typeof P.unixPermissions=="string"&&(P.unixPermissions=parseInt(P.unixPermissions,8)),P.unixPermissions&&16384&P.unixPermissions&&(P.dir=!0),P.dosPermissions&&16&P.dosPermissions&&(P.dir=!0),P.dir&&(I=y(I)),P.createFolders&&(N=b(I))&&C.call(this,N,!0);var Q=R==="string"&&P.binary===!1&&P.base64===!1;L&&L.binary!==void 0||(P.binary=!Q),(x instanceof g&&x.uncompressedSize===0||P.dir||!x||x.length===0)&&(P.base64=!1,P.binary=!0,x="",P.compression="STORE",R="string");var k=null;k=x instanceof g||x instanceof r?x:v.isNode&&v.isStream(x)?new u(I,x):s.prepareContent(I,x,P.binary,P.optimizedBinaryString,P.base64);var z=new h(I,k,P);this.files[I]=z}var i=e("./utf8"),s=e("./utils"),r=e("./stream/GenericWorker"),d=e("./stream/StreamHelper"),m=e("./defaults"),g=e("./compressedObject"),h=e("./zipObject"),f=e("./generate"),v=e("./nodejsUtils"),u=e("./nodejs/NodejsStreamInputAdapter"),b=function(I){I.slice(-1)==="/"&&(I=I.substring(0,I.length-1));var x=I.lastIndexOf("/");return 0<x?I.substring(0,x):""},y=function(I){return I.slice(-1)!=="/"&&(I+="/"),I},C=function(I,x){return x=x!==void 0?x:m.createFolders,I=y(I),this.files[I]||t.call(this,I,null,{dir:!0,createFolders:x}),this.files[I]};function _(I){return Object.prototype.toString.call(I)==="[object RegExp]"}var S={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(I){var x,L,N;for(x in this.files)N=this.files[x],(L=x.slice(this.root.length,x.length))&&x.slice(0,this.root.length)===this.root&&I(L,N)},filter:function(I){var x=[];return this.forEach(function(L,N){I(L,N)&&x.push(N)}),x},file:function(I,x,L){if(arguments.length!==1)return I=this.root+I,t.call(this,I,x,L),this;if(_(I)){var N=I;return this.filter(function(P,Q){return!Q.dir&&N.test(P)})}var R=this.files[this.root+I];return R&&!R.dir?R:null},folder:function(I){if(!I)return this;if(_(I))return this.filter(function(R,P){return P.dir&&I.test(R)});var x=this.root+I,L=C.call(this,x),N=this.clone();return N.root=L.name,N},remove:function(I){I=this.root+I;var x=this.files[I];if(x||(I.slice(-1)!=="/"&&(I+="/"),x=this.files[I]),x&&!x.dir)delete this.files[I];else for(var L=this.filter(function(R,P){return P.name.slice(0,I.length)===I}),N=0;N<L.length;N++)delete this.files[L[N].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(I){var x,L={};try{if((L=s.extend(I||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:i.utf8encode})).type=L.type.toLowerCase(),L.compression=L.compression.toUpperCase(),L.type==="binarystring"&&(L.type="string"),!L.type)throw new Error("No output type specified.");s.checkSupport(L.type),L.platform!=="darwin"&&L.platform!=="freebsd"&&L.platform!=="linux"&&L.platform!=="sunos"||(L.platform="UNIX"),L.platform==="win32"&&(L.platform="DOS");var N=L.comment||this.comment||"";x=f.generateWorker(this,L,N)}catch(R){(x=new r("error")).error(R)}return new d(x,L.type||"string",L.mimeType)},generateAsync:function(I,x){return this.generateInternalStream(I).accumulate(x)},generateNodeStream:function(I,x){return(I=I||{}).type||(I.type="nodebuffer"),this.generateInternalStream(I).toNodejsStream(x)}};c.exports=S},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,c,o){c.exports=e("stream")},{stream:void 0}],17:[function(e,c,o){var t=e("./DataReader");function i(s){t.call(this,s);for(var r=0;r<this.data.length;r++)s[r]=255&s[r]}e("../utils").inherits(i,t),i.prototype.byteAt=function(s){return this.data[this.zero+s]},i.prototype.lastIndexOfSignature=function(s){for(var r=s.charCodeAt(0),d=s.charCodeAt(1),m=s.charCodeAt(2),g=s.charCodeAt(3),h=this.length-4;0<=h;--h)if(this.data[h]===r&&this.data[h+1]===d&&this.data[h+2]===m&&this.data[h+3]===g)return h-this.zero;return-1},i.prototype.readAndCheckSignature=function(s){var r=s.charCodeAt(0),d=s.charCodeAt(1),m=s.charCodeAt(2),g=s.charCodeAt(3),h=this.readData(4);return r===h[0]&&d===h[1]&&m===h[2]&&g===h[3]},i.prototype.readData=function(s){if(this.checkOffset(s),s===0)return[];var r=this.data.slice(this.zero+this.index,this.zero+this.index+s);return this.index+=s,r},c.exports=i},{"../utils":32,"./DataReader":18}],18:[function(e,c,o){var t=e("../utils");function i(s){this.data=s,this.length=s.length,this.index=0,this.zero=0}i.prototype={checkOffset:function(s){this.checkIndex(this.index+s)},checkIndex:function(s){if(this.length<this.zero+s||s<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+s+"). Corrupted zip ?")},setIndex:function(s){this.checkIndex(s),this.index=s},skip:function(s){this.setIndex(this.index+s)},byteAt:function(){},readInt:function(s){var r,d=0;for(this.checkOffset(s),r=this.index+s-1;r>=this.index;r--)d=(d<<8)+this.byteAt(r);return this.index+=s,d},readString:function(s){return t.transformTo("string",this.readData(s))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var s=this.readInt(4);return new Date(Date.UTC(1980+(s>>25&127),(s>>21&15)-1,s>>16&31,s>>11&31,s>>5&63,(31&s)<<1))}},c.exports=i},{"../utils":32}],19:[function(e,c,o){var t=e("./Uint8ArrayReader");function i(s){t.call(this,s)}e("../utils").inherits(i,t),i.prototype.readData=function(s){this.checkOffset(s);var r=this.data.slice(this.zero+this.index,this.zero+this.index+s);return this.index+=s,r},c.exports=i},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,c,o){var t=e("./DataReader");function i(s){t.call(this,s)}e("../utils").inherits(i,t),i.prototype.byteAt=function(s){return this.data.charCodeAt(this.zero+s)},i.prototype.lastIndexOfSignature=function(s){return this.data.lastIndexOf(s)-this.zero},i.prototype.readAndCheckSignature=function(s){return s===this.readData(4)},i.prototype.readData=function(s){this.checkOffset(s);var r=this.data.slice(this.zero+this.index,this.zero+this.index+s);return this.index+=s,r},c.exports=i},{"../utils":32,"./DataReader":18}],21:[function(e,c,o){var t=e("./ArrayReader");function i(s){t.call(this,s)}e("../utils").inherits(i,t),i.prototype.readData=function(s){if(this.checkOffset(s),s===0)return new Uint8Array(0);var r=this.data.subarray(this.zero+this.index,this.zero+this.index+s);return this.index+=s,r},c.exports=i},{"../utils":32,"./ArrayReader":17}],22:[function(e,c,o){var t=e("../utils"),i=e("../support"),s=e("./ArrayReader"),r=e("./StringReader"),d=e("./NodeBufferReader"),m=e("./Uint8ArrayReader");c.exports=function(g){var h=t.getTypeOf(g);return t.checkSupport(h),h!=="string"||i.uint8array?h==="nodebuffer"?new d(g):i.uint8array?new m(t.transformTo("uint8array",g)):new s(t.transformTo("array",g)):new r(g)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,c,o){o.LOCAL_FILE_HEADER="PK",o.CENTRAL_FILE_HEADER="PK",o.CENTRAL_DIRECTORY_END="PK",o.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",o.ZIP64_CENTRAL_DIRECTORY_END="PK",o.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(e,c,o){var t=e("./GenericWorker"),i=e("../utils");function s(r){t.call(this,"ConvertWorker to "+r),this.destType=r}i.inherits(s,t),s.prototype.processChunk=function(r){this.push({data:i.transformTo(this.destType,r.data),meta:r.meta})},c.exports=s},{"../utils":32,"./GenericWorker":28}],25:[function(e,c,o){var t=e("./GenericWorker"),i=e("../crc32");function s(){t.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}e("../utils").inherits(s,t),s.prototype.processChunk=function(r){this.streamInfo.crc32=i(r.data,this.streamInfo.crc32||0),this.push(r)},c.exports=s},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,c,o){var t=e("../utils"),i=e("./GenericWorker");function s(r){i.call(this,"DataLengthProbe for "+r),this.propName=r,this.withStreamInfo(r,0)}t.inherits(s,i),s.prototype.processChunk=function(r){if(r){var d=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=d+r.data.length}i.prototype.processChunk.call(this,r)},c.exports=s},{"../utils":32,"./GenericWorker":28}],27:[function(e,c,o){var t=e("../utils"),i=e("./GenericWorker");function s(r){i.call(this,"DataWorker");var d=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,r.then(function(m){d.dataIsReady=!0,d.data=m,d.max=m&&m.length||0,d.type=t.getTypeOf(m),d.isPaused||d._tickAndRepeat()},function(m){d.error(m)})}t.inherits(s,i),s.prototype.cleanUp=function(){i.prototype.cleanUp.call(this),this.data=null},s.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,t.delay(this._tickAndRepeat,[],this)),!0)},s.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(t.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},s.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var r=null,d=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":r=this.data.substring(this.index,d);break;case"uint8array":r=this.data.subarray(this.index,d);break;case"array":case"nodebuffer":r=this.data.slice(this.index,d)}return this.index=d,this.push({data:r,meta:{percent:this.max?this.index/this.max*100:0}})},c.exports=s},{"../utils":32,"./GenericWorker":28}],28:[function(e,c,o){function t(i){this.name=i||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}t.prototype={push:function(i){this.emit("data",i)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(i){this.emit("error",i)}return!0},error:function(i){return!this.isFinished&&(this.isPaused?this.generatedError=i:(this.isFinished=!0,this.emit("error",i),this.previous&&this.previous.error(i),this.cleanUp()),!0)},on:function(i,s){return this._listeners[i].push(s),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(i,s){if(this._listeners[i])for(var r=0;r<this._listeners[i].length;r++)this._listeners[i][r].call(this,s)},pipe:function(i){return i.registerPrevious(this)},registerPrevious:function(i){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=i.streamInfo,this.mergeStreamInfo(),this.previous=i;var s=this;return i.on("data",function(r){s.processChunk(r)}),i.on("end",function(){s.end()}),i.on("error",function(r){s.error(r)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var i=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),i=!0),this.previous&&this.previous.resume(),!i},flush:function(){},processChunk:function(i){this.push(i)},withStreamInfo:function(i,s){return this.extraStreamInfo[i]=s,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var i in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,i)&&(this.streamInfo[i]=this.extraStreamInfo[i])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var i="Worker "+this.name;return this.previous?this.previous+" -> "+i:i}},c.exports=t},{}],29:[function(e,c,o){var t=e("../utils"),i=e("./ConvertWorker"),s=e("./GenericWorker"),r=e("../base64"),d=e("../support"),m=e("../external"),g=null;if(d.nodestream)try{g=e("../nodejs/NodejsStreamOutputAdapter")}catch{}function h(v,u){return new m.Promise(function(b,y){var C=[],_=v._internalType,S=v._outputType,I=v._mimeType;v.on("data",function(x,L){C.push(x),u&&u(L)}).on("error",function(x){C=[],y(x)}).on("end",function(){try{var x=function(L,N,R){switch(L){case"blob":return t.newBlob(t.transformTo("arraybuffer",N),R);case"base64":return r.encode(N);default:return t.transformTo(L,N)}}(S,function(L,N){var R,P=0,Q=null,k=0;for(R=0;R<N.length;R++)k+=N[R].length;switch(L){case"string":return N.join("");case"array":return Array.prototype.concat.apply([],N);case"uint8array":for(Q=new Uint8Array(k),R=0;R<N.length;R++)Q.set(N[R],P),P+=N[R].length;return Q;case"nodebuffer":return Buffer.concat(N);default:throw new Error("concat : unsupported type '"+L+"'")}}(_,C),I);b(x)}catch(L){y(L)}C=[]}).resume()})}function f(v,u,b){var y=u;switch(u){case"blob":case"arraybuffer":y="uint8array";break;case"base64":y="string"}try{this._internalType=y,this._outputType=u,this._mimeType=b,t.checkSupport(y),this._worker=v.pipe(new i(y)),v.lock()}catch(C){this._worker=new s("error"),this._worker.error(C)}}f.prototype={accumulate:function(v){return h(this,v)},on:function(v,u){var b=this;return v==="data"?this._worker.on(v,function(y){u.call(b,y.data,y.meta)}):this._worker.on(v,function(){t.delay(u,arguments,b)}),this},resume:function(){return t.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(v){if(t.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new g(this,{objectMode:this._outputType!=="nodebuffer"},v)}},c.exports=f},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,c,o){if(o.base64=!0,o.array=!0,o.string=!0,o.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",o.nodebuffer=typeof Buffer<"u",o.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")o.blob=!1;else{var t=new ArrayBuffer(0);try{o.blob=new Blob([t],{type:"application/zip"}).size===0}catch{try{var i=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);i.append(t),o.blob=i.getBlob("application/zip").size===0}catch{o.blob=!1}}}try{o.nodestream=!!e("readable-stream").Readable}catch{o.nodestream=!1}},{"readable-stream":16}],31:[function(e,c,o){for(var t=e("./utils"),i=e("./support"),s=e("./nodejsUtils"),r=e("./stream/GenericWorker"),d=new Array(256),m=0;m<256;m++)d[m]=252<=m?6:248<=m?5:240<=m?4:224<=m?3:192<=m?2:1;d[254]=d[254]=1;function g(){r.call(this,"utf-8 decode"),this.leftOver=null}function h(){r.call(this,"utf-8 encode")}o.utf8encode=function(f){return i.nodebuffer?s.newBufferFrom(f,"utf-8"):function(v){var u,b,y,C,_,S=v.length,I=0;for(C=0;C<S;C++)(64512&(b=v.charCodeAt(C)))==55296&&C+1<S&&(64512&(y=v.charCodeAt(C+1)))==56320&&(b=65536+(b-55296<<10)+(y-56320),C++),I+=b<128?1:b<2048?2:b<65536?3:4;for(u=i.uint8array?new Uint8Array(I):new Array(I),C=_=0;_<I;C++)(64512&(b=v.charCodeAt(C)))==55296&&C+1<S&&(64512&(y=v.charCodeAt(C+1)))==56320&&(b=65536+(b-55296<<10)+(y-56320),C++),b<128?u[_++]=b:(b<2048?u[_++]=192|b>>>6:(b<65536?u[_++]=224|b>>>12:(u[_++]=240|b>>>18,u[_++]=128|b>>>12&63),u[_++]=128|b>>>6&63),u[_++]=128|63&b);return u}(f)},o.utf8decode=function(f){return i.nodebuffer?t.transformTo("nodebuffer",f).toString("utf-8"):function(v){var u,b,y,C,_=v.length,S=new Array(2*_);for(u=b=0;u<_;)if((y=v[u++])<128)S[b++]=y;else if(4<(C=d[y]))S[b++]=65533,u+=C-1;else{for(y&=C===2?31:C===3?15:7;1<C&&u<_;)y=y<<6|63&v[u++],C--;1<C?S[b++]=65533:y<65536?S[b++]=y:(y-=65536,S[b++]=55296|y>>10&1023,S[b++]=56320|1023&y)}return S.length!==b&&(S.subarray?S=S.subarray(0,b):S.length=b),t.applyFromCharCode(S)}(f=t.transformTo(i.uint8array?"uint8array":"array",f))},t.inherits(g,r),g.prototype.processChunk=function(f){var v=t.transformTo(i.uint8array?"uint8array":"array",f.data);if(this.leftOver&&this.leftOver.length){if(i.uint8array){var u=v;(v=new Uint8Array(u.length+this.leftOver.length)).set(this.leftOver,0),v.set(u,this.leftOver.length)}else v=this.leftOver.concat(v);this.leftOver=null}var b=function(C,_){var S;for((_=_||C.length)>C.length&&(_=C.length),S=_-1;0<=S&&(192&C[S])==128;)S--;return S<0||S===0?_:S+d[C[S]]>_?S:_}(v),y=v;b!==v.length&&(i.uint8array?(y=v.subarray(0,b),this.leftOver=v.subarray(b,v.length)):(y=v.slice(0,b),this.leftOver=v.slice(b,v.length))),this.push({data:o.utf8decode(y),meta:f.meta})},g.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:o.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},o.Utf8DecodeWorker=g,t.inherits(h,r),h.prototype.processChunk=function(f){this.push({data:o.utf8encode(f.data),meta:f.meta})},o.Utf8EncodeWorker=h},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,c,o){var t=e("./support"),i=e("./base64"),s=e("./nodejsUtils"),r=e("./external");function d(u){return u}function m(u,b){for(var y=0;y<u.length;++y)b[y]=255&u.charCodeAt(y);return b}e("setimmediate"),o.newBlob=function(u,b){o.checkSupport("blob");try{return new Blob([u],{type:b})}catch{try{var y=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return y.append(u),y.getBlob(b)}catch{throw new Error("Bug : can't construct the Blob.")}}};var g={stringifyByChunk:function(u,b,y){var C=[],_=0,S=u.length;if(S<=y)return String.fromCharCode.apply(null,u);for(;_<S;)b==="array"||b==="nodebuffer"?C.push(String.fromCharCode.apply(null,u.slice(_,Math.min(_+y,S)))):C.push(String.fromCharCode.apply(null,u.subarray(_,Math.min(_+y,S)))),_+=y;return C.join("")},stringifyByChar:function(u){for(var b="",y=0;y<u.length;y++)b+=String.fromCharCode(u[y]);return b},applyCanBeUsed:{uint8array:function(){try{return t.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}}(),nodebuffer:function(){try{return t.nodebuffer&&String.fromCharCode.apply(null,s.allocBuffer(1)).length===1}catch{return!1}}()}};function h(u){var b=65536,y=o.getTypeOf(u),C=!0;if(y==="uint8array"?C=g.applyCanBeUsed.uint8array:y==="nodebuffer"&&(C=g.applyCanBeUsed.nodebuffer),C)for(;1<b;)try{return g.stringifyByChunk(u,y,b)}catch{b=Math.floor(b/2)}return g.stringifyByChar(u)}function f(u,b){for(var y=0;y<u.length;y++)b[y]=u[y];return b}o.applyFromCharCode=h;var v={};v.string={string:d,array:function(u){return m(u,new Array(u.length))},arraybuffer:function(u){return v.string.uint8array(u).buffer},uint8array:function(u){return m(u,new Uint8Array(u.length))},nodebuffer:function(u){return m(u,s.allocBuffer(u.length))}},v.array={string:h,array:d,arraybuffer:function(u){return new Uint8Array(u).buffer},uint8array:function(u){return new Uint8Array(u)},nodebuffer:function(u){return s.newBufferFrom(u)}},v.arraybuffer={string:function(u){return h(new Uint8Array(u))},array:function(u){return f(new Uint8Array(u),new Array(u.byteLength))},arraybuffer:d,uint8array:function(u){return new Uint8Array(u)},nodebuffer:function(u){return s.newBufferFrom(new Uint8Array(u))}},v.uint8array={string:h,array:function(u){return f(u,new Array(u.length))},arraybuffer:function(u){return u.buffer},uint8array:d,nodebuffer:function(u){return s.newBufferFrom(u)}},v.nodebuffer={string:h,array:function(u){return f(u,new Array(u.length))},arraybuffer:function(u){return v.nodebuffer.uint8array(u).buffer},uint8array:function(u){return f(u,new Uint8Array(u.length))},nodebuffer:d},o.transformTo=function(u,b){if(b=b||"",!u)return b;o.checkSupport(u);var y=o.getTypeOf(b);return v[y][u](b)},o.resolve=function(u){for(var b=u.split("/"),y=[],C=0;C<b.length;C++){var _=b[C];_==="."||_===""&&C!==0&&C!==b.length-1||(_===".."?y.pop():y.push(_))}return y.join("/")},o.getTypeOf=function(u){return typeof u=="string"?"string":Object.prototype.toString.call(u)==="[object Array]"?"array":t.nodebuffer&&s.isBuffer(u)?"nodebuffer":t.uint8array&&u instanceof Uint8Array?"uint8array":t.arraybuffer&&u instanceof ArrayBuffer?"arraybuffer":void 0},o.checkSupport=function(u){if(!t[u.toLowerCase()])throw new Error(u+" is not supported by this platform")},o.MAX_VALUE_16BITS=65535,o.MAX_VALUE_32BITS=-1,o.pretty=function(u){var b,y,C="";for(y=0;y<(u||"").length;y++)C+="\\x"+((b=u.charCodeAt(y))<16?"0":"")+b.toString(16).toUpperCase();return C},o.delay=function(u,b,y){setImmediate(function(){u.apply(y||null,b||[])})},o.inherits=function(u,b){function y(){}y.prototype=b.prototype,u.prototype=new y},o.extend=function(){var u,b,y={};for(u=0;u<arguments.length;u++)for(b in arguments[u])Object.prototype.hasOwnProperty.call(arguments[u],b)&&y[b]===void 0&&(y[b]=arguments[u][b]);return y},o.prepareContent=function(u,b,y,C,_){return r.Promise.resolve(b).then(function(S){return t.blob&&(S instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(S))!==-1)&&typeof FileReader<"u"?new r.Promise(function(I,x){var L=new FileReader;L.onload=function(N){I(N.target.result)},L.onerror=function(N){x(N.target.error)},L.readAsArrayBuffer(S)}):S}).then(function(S){var I=o.getTypeOf(S);return I?(I==="arraybuffer"?S=o.transformTo("uint8array",S):I==="string"&&(_?S=i.decode(S):y&&C!==!0&&(S=function(x){return m(x,t.uint8array?new Uint8Array(x.length):new Array(x.length))}(S))),S):r.Promise.reject(new Error("Can't read the data of '"+u+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(e,c,o){var t=e("./reader/readerFor"),i=e("./utils"),s=e("./signature"),r=e("./zipEntry"),d=e("./support");function m(g){this.files=[],this.loadOptions=g}m.prototype={checkSignature:function(g){if(!this.reader.readAndCheckSignature(g)){this.reader.index-=4;var h=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+i.pretty(h)+", expected "+i.pretty(g)+")")}},isSignature:function(g,h){var f=this.reader.index;this.reader.setIndex(g);var v=this.reader.readString(4)===h;return this.reader.setIndex(f),v},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var g=this.reader.readData(this.zipCommentLength),h=d.uint8array?"uint8array":"array",f=i.transformTo(h,g);this.zipComment=this.loadOptions.decodeFileName(f)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var g,h,f,v=this.zip64EndOfCentralSize-44;0<v;)g=this.reader.readInt(2),h=this.reader.readInt(4),f=this.reader.readData(h),this.zip64ExtensibleData[g]={id:g,length:h,value:f}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var g,h;for(g=0;g<this.files.length;g++)h=this.files[g],this.reader.setIndex(h.localHeaderOffset),this.checkSignature(s.LOCAL_FILE_HEADER),h.readLocalPart(this.reader),h.handleUTF8(),h.processAttributes()},readCentralDir:function(){var g;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(s.CENTRAL_FILE_HEADER);)(g=new r({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(g);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var g=this.reader.lastIndexOfSignature(s.CENTRAL_DIRECTORY_END);if(g<0)throw this.isSignature(0,s.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(g);var h=g;if(this.checkSignature(s.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===i.MAX_VALUE_16BITS||this.diskWithCentralDirStart===i.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===i.MAX_VALUE_16BITS||this.centralDirRecords===i.MAX_VALUE_16BITS||this.centralDirSize===i.MAX_VALUE_32BITS||this.centralDirOffset===i.MAX_VALUE_32BITS){if(this.zip64=!0,(g=this.reader.lastIndexOfSignature(s.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(g),this.checkSignature(s.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,s.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(s.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(s.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var f=this.centralDirOffset+this.centralDirSize;this.zip64&&(f+=20,f+=12+this.zip64EndOfCentralSize);var v=h-f;if(0<v)this.isSignature(h,s.CENTRAL_FILE_HEADER)||(this.reader.zero=v);else if(v<0)throw new Error("Corrupted zip: missing "+Math.abs(v)+" bytes.")},prepareReader:function(g){this.reader=t(g)},load:function(g){this.prepareReader(g),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},c.exports=m},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(e,c,o){var t=e("./reader/readerFor"),i=e("./utils"),s=e("./compressedObject"),r=e("./crc32"),d=e("./utf8"),m=e("./compressions"),g=e("./support");function h(f,v){this.options=f,this.loadOptions=v}h.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(f){var v,u;if(f.skip(22),this.fileNameLength=f.readInt(2),u=f.readInt(2),this.fileName=f.readData(this.fileNameLength),f.skip(u),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((v=function(b){for(var y in m)if(Object.prototype.hasOwnProperty.call(m,y)&&m[y].magic===b)return m[y];return null}(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+i.pretty(this.compressionMethod)+" unknown (inner file : "+i.transformTo("string",this.fileName)+")");this.decompressed=new s(this.compressedSize,this.uncompressedSize,this.crc32,v,f.readData(this.compressedSize))},readCentralPart:function(f){this.versionMadeBy=f.readInt(2),f.skip(2),this.bitFlag=f.readInt(2),this.compressionMethod=f.readString(2),this.date=f.readDate(),this.crc32=f.readInt(4),this.compressedSize=f.readInt(4),this.uncompressedSize=f.readInt(4);var v=f.readInt(2);if(this.extraFieldsLength=f.readInt(2),this.fileCommentLength=f.readInt(2),this.diskNumberStart=f.readInt(2),this.internalFileAttributes=f.readInt(2),this.externalFileAttributes=f.readInt(4),this.localHeaderOffset=f.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");f.skip(v),this.readExtraFields(f),this.parseZIP64ExtraField(f),this.fileComment=f.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var f=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),f==0&&(this.dosPermissions=63&this.externalFileAttributes),f==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var f=t(this.extraFields[1].value);this.uncompressedSize===i.MAX_VALUE_32BITS&&(this.uncompressedSize=f.readInt(8)),this.compressedSize===i.MAX_VALUE_32BITS&&(this.compressedSize=f.readInt(8)),this.localHeaderOffset===i.MAX_VALUE_32BITS&&(this.localHeaderOffset=f.readInt(8)),this.diskNumberStart===i.MAX_VALUE_32BITS&&(this.diskNumberStart=f.readInt(4))}},readExtraFields:function(f){var v,u,b,y=f.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});f.index+4<y;)v=f.readInt(2),u=f.readInt(2),b=f.readData(u),this.extraFields[v]={id:v,length:u,value:b};f.setIndex(y)},handleUTF8:function(){var f=g.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=d.utf8decode(this.fileName),this.fileCommentStr=d.utf8decode(this.fileComment);else{var v=this.findExtraFieldUnicodePath();if(v!==null)this.fileNameStr=v;else{var u=i.transformTo(f,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(u)}var b=this.findExtraFieldUnicodeComment();if(b!==null)this.fileCommentStr=b;else{var y=i.transformTo(f,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(y)}}},findExtraFieldUnicodePath:function(){var f=this.extraFields[28789];if(f){var v=t(f.value);return v.readInt(1)!==1||r(this.fileName)!==v.readInt(4)?null:d.utf8decode(v.readData(f.length-5))}return null},findExtraFieldUnicodeComment:function(){var f=this.extraFields[25461];if(f){var v=t(f.value);return v.readInt(1)!==1||r(this.fileComment)!==v.readInt(4)?null:d.utf8decode(v.readData(f.length-5))}return null}},c.exports=h},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(e,c,o){function t(v,u,b){this.name=v,this.dir=b.dir,this.date=b.date,this.comment=b.comment,this.unixPermissions=b.unixPermissions,this.dosPermissions=b.dosPermissions,this._data=u,this._dataBinary=b.binary,this.options={compression:b.compression,compressionOptions:b.compressionOptions}}var i=e("./stream/StreamHelper"),s=e("./stream/DataWorker"),r=e("./utf8"),d=e("./compressedObject"),m=e("./stream/GenericWorker");t.prototype={internalStream:function(v){var u=null,b="string";try{if(!v)throw new Error("No output type specified.");var y=(b=v.toLowerCase())==="string"||b==="text";b!=="binarystring"&&b!=="text"||(b="string"),u=this._decompressWorker();var C=!this._dataBinary;C&&!y&&(u=u.pipe(new r.Utf8EncodeWorker)),!C&&y&&(u=u.pipe(new r.Utf8DecodeWorker))}catch(_){(u=new m("error")).error(_)}return new i(u,b,"")},async:function(v,u){return this.internalStream(v).accumulate(u)},nodeStream:function(v,u){return this.internalStream(v||"nodebuffer").toNodejsStream(u)},_compressWorker:function(v,u){if(this._data instanceof d&&this._data.compression.magic===v.magic)return this._data.getCompressedWorker();var b=this._decompressWorker();return this._dataBinary||(b=b.pipe(new r.Utf8EncodeWorker)),d.createWorkerFrom(b,v,u)},_decompressWorker:function(){return this._data instanceof d?this._data.getContentWorker():this._data instanceof m?this._data:new s(this._data)}};for(var g=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],h=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},f=0;f<g.length;f++)t.prototype[g[f]]=h;c.exports=t},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(e,c,o){(function(t){var i,s,r=t.MutationObserver||t.WebKitMutationObserver;if(r){var d=0,m=new r(v),g=t.document.createTextNode("");m.observe(g,{characterData:!0}),i=function(){g.data=d=++d%2}}else if(t.setImmediate||t.MessageChannel===void 0)i="document"in t&&"onreadystatechange"in t.document.createElement("script")?function(){var u=t.document.createElement("script");u.onreadystatechange=function(){v(),u.onreadystatechange=null,u.parentNode.removeChild(u),u=null},t.document.documentElement.appendChild(u)}:function(){setTimeout(v,0)};else{var h=new t.MessageChannel;h.port1.onmessage=v,i=function(){h.port2.postMessage(0)}}var f=[];function v(){var u,b;s=!0;for(var y=f.length;y;){for(b=f,f=[],u=-1;++u<y;)b[u]();y=f.length}s=!1}c.exports=function(u){f.push(u)!==1||s||i()}}).call(this,typeof pn<"u"?pn:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(e,c,o){var t=e("immediate");function i(){}var s={},r=["REJECTED"],d=["FULFILLED"],m=["PENDING"];function g(y){if(typeof y!="function")throw new TypeError("resolver must be a function");this.state=m,this.queue=[],this.outcome=void 0,y!==i&&u(this,y)}function h(y,C,_){this.promise=y,typeof C=="function"&&(this.onFulfilled=C,this.callFulfilled=this.otherCallFulfilled),typeof _=="function"&&(this.onRejected=_,this.callRejected=this.otherCallRejected)}function f(y,C,_){t(function(){var S;try{S=C(_)}catch(I){return s.reject(y,I)}S===y?s.reject(y,new TypeError("Cannot resolve promise with itself")):s.resolve(y,S)})}function v(y){var C=y&&y.then;if(y&&(typeof y=="object"||typeof y=="function")&&typeof C=="function")return function(){C.apply(y,arguments)}}function u(y,C){var _=!1;function S(L){_||(_=!0,s.reject(y,L))}function I(L){_||(_=!0,s.resolve(y,L))}var x=b(function(){C(I,S)});x.status==="error"&&S(x.value)}function b(y,C){var _={};try{_.value=y(C),_.status="success"}catch(S){_.status="error",_.value=S}return _}(c.exports=g).prototype.finally=function(y){if(typeof y!="function")return this;var C=this.constructor;return this.then(function(_){return C.resolve(y()).then(function(){return _})},function(_){return C.resolve(y()).then(function(){throw _})})},g.prototype.catch=function(y){return this.then(null,y)},g.prototype.then=function(y,C){if(typeof y!="function"&&this.state===d||typeof C!="function"&&this.state===r)return this;var _=new this.constructor(i);return this.state!==m?f(_,this.state===d?y:C,this.outcome):this.queue.push(new h(_,y,C)),_},h.prototype.callFulfilled=function(y){s.resolve(this.promise,y)},h.prototype.otherCallFulfilled=function(y){f(this.promise,this.onFulfilled,y)},h.prototype.callRejected=function(y){s.reject(this.promise,y)},h.prototype.otherCallRejected=function(y){f(this.promise,this.onRejected,y)},s.resolve=function(y,C){var _=b(v,C);if(_.status==="error")return s.reject(y,_.value);var S=_.value;if(S)u(y,S);else{y.state=d,y.outcome=C;for(var I=-1,x=y.queue.length;++I<x;)y.queue[I].callFulfilled(C)}return y},s.reject=function(y,C){y.state=r,y.outcome=C;for(var _=-1,S=y.queue.length;++_<S;)y.queue[_].callRejected(C);return y},g.resolve=function(y){return y instanceof this?y:s.resolve(new this(i),y)},g.reject=function(y){var C=new this(i);return s.reject(C,y)},g.all=function(y){var C=this;if(Object.prototype.toString.call(y)!=="[object Array]")return this.reject(new TypeError("must be an array"));var _=y.length,S=!1;if(!_)return this.resolve([]);for(var I=new Array(_),x=0,L=-1,N=new this(i);++L<_;)R(y[L],L);return N;function R(P,Q){C.resolve(P).then(function(k){I[Q]=k,++x!==_||S||(S=!0,s.resolve(N,I))},function(k){S||(S=!0,s.reject(N,k))})}},g.race=function(y){var C=this;if(Object.prototype.toString.call(y)!=="[object Array]")return this.reject(new TypeError("must be an array"));var _=y.length,S=!1;if(!_)return this.resolve([]);for(var I=-1,x=new this(i);++I<_;)L=y[I],C.resolve(L).then(function(N){S||(S=!0,s.resolve(x,N))},function(N){S||(S=!0,s.reject(x,N))});var L;return x}},{immediate:36}],38:[function(e,c,o){var t={};(0,e("./lib/utils/common").assign)(t,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),c.exports=t},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(e,c,o){var t=e("./zlib/deflate"),i=e("./utils/common"),s=e("./utils/strings"),r=e("./zlib/messages"),d=e("./zlib/zstream"),m=Object.prototype.toString,g=0,h=-1,f=0,v=8;function u(y){if(!(this instanceof u))return new u(y);this.options=i.assign({level:h,method:v,chunkSize:16384,windowBits:15,memLevel:8,strategy:f,to:""},y||{});var C=this.options;C.raw&&0<C.windowBits?C.windowBits=-C.windowBits:C.gzip&&0<C.windowBits&&C.windowBits<16&&(C.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new d,this.strm.avail_out=0;var _=t.deflateInit2(this.strm,C.level,C.method,C.windowBits,C.memLevel,C.strategy);if(_!==g)throw new Error(r[_]);if(C.header&&t.deflateSetHeader(this.strm,C.header),C.dictionary){var S;if(S=typeof C.dictionary=="string"?s.string2buf(C.dictionary):m.call(C.dictionary)==="[object ArrayBuffer]"?new Uint8Array(C.dictionary):C.dictionary,(_=t.deflateSetDictionary(this.strm,S))!==g)throw new Error(r[_]);this._dict_set=!0}}function b(y,C){var _=new u(C);if(_.push(y,!0),_.err)throw _.msg||r[_.err];return _.result}u.prototype.push=function(y,C){var _,S,I=this.strm,x=this.options.chunkSize;if(this.ended)return!1;S=C===~~C?C:C===!0?4:0,typeof y=="string"?I.input=s.string2buf(y):m.call(y)==="[object ArrayBuffer]"?I.input=new Uint8Array(y):I.input=y,I.next_in=0,I.avail_in=I.input.length;do{if(I.avail_out===0&&(I.output=new i.Buf8(x),I.next_out=0,I.avail_out=x),(_=t.deflate(I,S))!==1&&_!==g)return this.onEnd(_),!(this.ended=!0);I.avail_out!==0&&(I.avail_in!==0||S!==4&&S!==2)||(this.options.to==="string"?this.onData(s.buf2binstring(i.shrinkBuf(I.output,I.next_out))):this.onData(i.shrinkBuf(I.output,I.next_out)))}while((0<I.avail_in||I.avail_out===0)&&_!==1);return S===4?(_=t.deflateEnd(this.strm),this.onEnd(_),this.ended=!0,_===g):S!==2||(this.onEnd(g),!(I.avail_out=0))},u.prototype.onData=function(y){this.chunks.push(y)},u.prototype.onEnd=function(y){y===g&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=i.flattenChunks(this.chunks)),this.chunks=[],this.err=y,this.msg=this.strm.msg},o.Deflate=u,o.deflate=b,o.deflateRaw=function(y,C){return(C=C||{}).raw=!0,b(y,C)},o.gzip=function(y,C){return(C=C||{}).gzip=!0,b(y,C)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(e,c,o){var t=e("./zlib/inflate"),i=e("./utils/common"),s=e("./utils/strings"),r=e("./zlib/constants"),d=e("./zlib/messages"),m=e("./zlib/zstream"),g=e("./zlib/gzheader"),h=Object.prototype.toString;function f(u){if(!(this instanceof f))return new f(u);this.options=i.assign({chunkSize:16384,windowBits:0,to:""},u||{});var b=this.options;b.raw&&0<=b.windowBits&&b.windowBits<16&&(b.windowBits=-b.windowBits,b.windowBits===0&&(b.windowBits=-15)),!(0<=b.windowBits&&b.windowBits<16)||u&&u.windowBits||(b.windowBits+=32),15<b.windowBits&&b.windowBits<48&&!(15&b.windowBits)&&(b.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new m,this.strm.avail_out=0;var y=t.inflateInit2(this.strm,b.windowBits);if(y!==r.Z_OK)throw new Error(d[y]);this.header=new g,t.inflateGetHeader(this.strm,this.header)}function v(u,b){var y=new f(b);if(y.push(u,!0),y.err)throw y.msg||d[y.err];return y.result}f.prototype.push=function(u,b){var y,C,_,S,I,x,L=this.strm,N=this.options.chunkSize,R=this.options.dictionary,P=!1;if(this.ended)return!1;C=b===~~b?b:b===!0?r.Z_FINISH:r.Z_NO_FLUSH,typeof u=="string"?L.input=s.binstring2buf(u):h.call(u)==="[object ArrayBuffer]"?L.input=new Uint8Array(u):L.input=u,L.next_in=0,L.avail_in=L.input.length;do{if(L.avail_out===0&&(L.output=new i.Buf8(N),L.next_out=0,L.avail_out=N),(y=t.inflate(L,r.Z_NO_FLUSH))===r.Z_NEED_DICT&&R&&(x=typeof R=="string"?s.string2buf(R):h.call(R)==="[object ArrayBuffer]"?new Uint8Array(R):R,y=t.inflateSetDictionary(this.strm,x)),y===r.Z_BUF_ERROR&&P===!0&&(y=r.Z_OK,P=!1),y!==r.Z_STREAM_END&&y!==r.Z_OK)return this.onEnd(y),!(this.ended=!0);L.next_out&&(L.avail_out!==0&&y!==r.Z_STREAM_END&&(L.avail_in!==0||C!==r.Z_FINISH&&C!==r.Z_SYNC_FLUSH)||(this.options.to==="string"?(_=s.utf8border(L.output,L.next_out),S=L.next_out-_,I=s.buf2string(L.output,_),L.next_out=S,L.avail_out=N-S,S&&i.arraySet(L.output,L.output,_,S,0),this.onData(I)):this.onData(i.shrinkBuf(L.output,L.next_out)))),L.avail_in===0&&L.avail_out===0&&(P=!0)}while((0<L.avail_in||L.avail_out===0)&&y!==r.Z_STREAM_END);return y===r.Z_STREAM_END&&(C=r.Z_FINISH),C===r.Z_FINISH?(y=t.inflateEnd(this.strm),this.onEnd(y),this.ended=!0,y===r.Z_OK):C!==r.Z_SYNC_FLUSH||(this.onEnd(r.Z_OK),!(L.avail_out=0))},f.prototype.onData=function(u){this.chunks.push(u)},f.prototype.onEnd=function(u){u===r.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=i.flattenChunks(this.chunks)),this.chunks=[],this.err=u,this.msg=this.strm.msg},o.Inflate=f,o.inflate=v,o.inflateRaw=function(u,b){return(b=b||{}).raw=!0,v(u,b)},o.ungzip=v},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(e,c,o){var t=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";o.assign=function(r){for(var d=Array.prototype.slice.call(arguments,1);d.length;){var m=d.shift();if(m){if(typeof m!="object")throw new TypeError(m+"must be non-object");for(var g in m)m.hasOwnProperty(g)&&(r[g]=m[g])}}return r},o.shrinkBuf=function(r,d){return r.length===d?r:r.subarray?r.subarray(0,d):(r.length=d,r)};var i={arraySet:function(r,d,m,g,h){if(d.subarray&&r.subarray)r.set(d.subarray(m,m+g),h);else for(var f=0;f<g;f++)r[h+f]=d[m+f]},flattenChunks:function(r){var d,m,g,h,f,v;for(d=g=0,m=r.length;d<m;d++)g+=r[d].length;for(v=new Uint8Array(g),d=h=0,m=r.length;d<m;d++)f=r[d],v.set(f,h),h+=f.length;return v}},s={arraySet:function(r,d,m,g,h){for(var f=0;f<g;f++)r[h+f]=d[m+f]},flattenChunks:function(r){return[].concat.apply([],r)}};o.setTyped=function(r){r?(o.Buf8=Uint8Array,o.Buf16=Uint16Array,o.Buf32=Int32Array,o.assign(o,i)):(o.Buf8=Array,o.Buf16=Array,o.Buf32=Array,o.assign(o,s))},o.setTyped(t)},{}],42:[function(e,c,o){var t=e("./common"),i=!0,s=!0;try{String.fromCharCode.apply(null,[0])}catch{i=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{s=!1}for(var r=new t.Buf8(256),d=0;d<256;d++)r[d]=252<=d?6:248<=d?5:240<=d?4:224<=d?3:192<=d?2:1;function m(g,h){if(h<65537&&(g.subarray&&s||!g.subarray&&i))return String.fromCharCode.apply(null,t.shrinkBuf(g,h));for(var f="",v=0;v<h;v++)f+=String.fromCharCode(g[v]);return f}r[254]=r[254]=1,o.string2buf=function(g){var h,f,v,u,b,y=g.length,C=0;for(u=0;u<y;u++)(64512&(f=g.charCodeAt(u)))==55296&&u+1<y&&(64512&(v=g.charCodeAt(u+1)))==56320&&(f=65536+(f-55296<<10)+(v-56320),u++),C+=f<128?1:f<2048?2:f<65536?3:4;for(h=new t.Buf8(C),u=b=0;b<C;u++)(64512&(f=g.charCodeAt(u)))==55296&&u+1<y&&(64512&(v=g.charCodeAt(u+1)))==56320&&(f=65536+(f-55296<<10)+(v-56320),u++),f<128?h[b++]=f:(f<2048?h[b++]=192|f>>>6:(f<65536?h[b++]=224|f>>>12:(h[b++]=240|f>>>18,h[b++]=128|f>>>12&63),h[b++]=128|f>>>6&63),h[b++]=128|63&f);return h},o.buf2binstring=function(g){return m(g,g.length)},o.binstring2buf=function(g){for(var h=new t.Buf8(g.length),f=0,v=h.length;f<v;f++)h[f]=g.charCodeAt(f);return h},o.buf2string=function(g,h){var f,v,u,b,y=h||g.length,C=new Array(2*y);for(f=v=0;f<y;)if((u=g[f++])<128)C[v++]=u;else if(4<(b=r[u]))C[v++]=65533,f+=b-1;else{for(u&=b===2?31:b===3?15:7;1<b&&f<y;)u=u<<6|63&g[f++],b--;1<b?C[v++]=65533:u<65536?C[v++]=u:(u-=65536,C[v++]=55296|u>>10&1023,C[v++]=56320|1023&u)}return m(C,v)},o.utf8border=function(g,h){var f;for((h=h||g.length)>g.length&&(h=g.length),f=h-1;0<=f&&(192&g[f])==128;)f--;return f<0||f===0?h:f+r[g[f]]>h?f:h}},{"./common":41}],43:[function(e,c,o){c.exports=function(t,i,s,r){for(var d=65535&t|0,m=t>>>16&65535|0,g=0;s!==0;){for(s-=g=2e3<s?2e3:s;m=m+(d=d+i[r++]|0)|0,--g;);d%=65521,m%=65521}return d|m<<16|0}},{}],44:[function(e,c,o){c.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(e,c,o){var t=function(){for(var i,s=[],r=0;r<256;r++){i=r;for(var d=0;d<8;d++)i=1&i?3988292384^i>>>1:i>>>1;s[r]=i}return s}();c.exports=function(i,s,r,d){var m=t,g=d+r;i^=-1;for(var h=d;h<g;h++)i=i>>>8^m[255&(i^s[h])];return-1^i}},{}],46:[function(e,c,o){var t,i=e("../utils/common"),s=e("./trees"),r=e("./adler32"),d=e("./crc32"),m=e("./messages"),g=0,h=4,f=0,v=-2,u=-1,b=4,y=2,C=8,_=9,S=286,I=30,x=19,L=2*S+1,N=15,R=3,P=258,Q=P+R+1,k=42,z=113,p=1,H=2,ue=3,j=4;function fe(l,W){return l.msg=m[W],W}function F(l){return(l<<1)-(4<l?9:0)}function ne(l){for(var W=l.length;0<=--W;)l[W]=0}function O(l){var W=l.state,$=W.pending;$>l.avail_out&&($=l.avail_out),$!==0&&(i.arraySet(l.output,W.pending_buf,W.pending_out,$,l.next_out),l.next_out+=$,W.pending_out+=$,l.total_out+=$,l.avail_out-=$,W.pending-=$,W.pending===0&&(W.pending_out=0))}function M(l,W){s._tr_flush_block(l,0<=l.block_start?l.block_start:-1,l.strstart-l.block_start,W),l.block_start=l.strstart,O(l.strm)}function oe(l,W){l.pending_buf[l.pending++]=W}function te(l,W){l.pending_buf[l.pending++]=W>>>8&255,l.pending_buf[l.pending++]=255&W}function X(l,W){var $,E,w=l.max_chain_length,T=l.strstart,Z=l.prev_length,G=l.nice_match,A=l.strstart>l.w_size-Q?l.strstart-(l.w_size-Q):0,V=l.window,ie=l.w_mask,K=l.prev,le=l.strstart+P,Le=V[T+Z-1],ye=V[T+Z];l.prev_length>=l.good_match&&(w>>=2),G>l.lookahead&&(G=l.lookahead);do if(V[($=W)+Z]===ye&&V[$+Z-1]===Le&&V[$]===V[T]&&V[++$]===V[T+1]){T+=2,$++;do;while(V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&V[++T]===V[++$]&&T<le);if(E=P-(le-T),T=le-P,Z<E){if(l.match_start=W,G<=(Z=E))break;Le=V[T+Z-1],ye=V[T+Z]}}while((W=K[W&ie])>A&&--w!=0);return Z<=l.lookahead?Z:l.lookahead}function De(l){var W,$,E,w,T,Z,G,A,V,ie,K=l.w_size;do{if(w=l.window_size-l.lookahead-l.strstart,l.strstart>=K+(K-Q)){for(i.arraySet(l.window,l.window,K,K,0),l.match_start-=K,l.strstart-=K,l.block_start-=K,W=$=l.hash_size;E=l.head[--W],l.head[W]=K<=E?E-K:0,--$;);for(W=$=K;E=l.prev[--W],l.prev[W]=K<=E?E-K:0,--$;);w+=K}if(l.strm.avail_in===0)break;if(Z=l.strm,G=l.window,A=l.strstart+l.lookahead,V=w,ie=void 0,ie=Z.avail_in,V<ie&&(ie=V),$=ie===0?0:(Z.avail_in-=ie,i.arraySet(G,Z.input,Z.next_in,ie,A),Z.state.wrap===1?Z.adler=r(Z.adler,G,ie,A):Z.state.wrap===2&&(Z.adler=d(Z.adler,G,ie,A)),Z.next_in+=ie,Z.total_in+=ie,ie),l.lookahead+=$,l.lookahead+l.insert>=R)for(T=l.strstart-l.insert,l.ins_h=l.window[T],l.ins_h=(l.ins_h<<l.hash_shift^l.window[T+1])&l.hash_mask;l.insert&&(l.ins_h=(l.ins_h<<l.hash_shift^l.window[T+R-1])&l.hash_mask,l.prev[T&l.w_mask]=l.head[l.ins_h],l.head[l.ins_h]=T,T++,l.insert--,!(l.lookahead+l.insert<R)););}while(l.lookahead<Q&&l.strm.avail_in!==0)}function Oe(l,W){for(var $,E;;){if(l.lookahead<Q){if(De(l),l.lookahead<Q&&W===g)return p;if(l.lookahead===0)break}if($=0,l.lookahead>=R&&(l.ins_h=(l.ins_h<<l.hash_shift^l.window[l.strstart+R-1])&l.hash_mask,$=l.prev[l.strstart&l.w_mask]=l.head[l.ins_h],l.head[l.ins_h]=l.strstart),$!==0&&l.strstart-$<=l.w_size-Q&&(l.match_length=X(l,$)),l.match_length>=R)if(E=s._tr_tally(l,l.strstart-l.match_start,l.match_length-R),l.lookahead-=l.match_length,l.match_length<=l.max_lazy_match&&l.lookahead>=R){for(l.match_length--;l.strstart++,l.ins_h=(l.ins_h<<l.hash_shift^l.window[l.strstart+R-1])&l.hash_mask,$=l.prev[l.strstart&l.w_mask]=l.head[l.ins_h],l.head[l.ins_h]=l.strstart,--l.match_length!=0;);l.strstart++}else l.strstart+=l.match_length,l.match_length=0,l.ins_h=l.window[l.strstart],l.ins_h=(l.ins_h<<l.hash_shift^l.window[l.strstart+1])&l.hash_mask;else E=s._tr_tally(l,0,l.window[l.strstart]),l.lookahead--,l.strstart++;if(E&&(M(l,!1),l.strm.avail_out===0))return p}return l.insert=l.strstart<R-1?l.strstart:R-1,W===h?(M(l,!0),l.strm.avail_out===0?ue:j):l.last_lit&&(M(l,!1),l.strm.avail_out===0)?p:H}function he(l,W){for(var $,E,w;;){if(l.lookahead<Q){if(De(l),l.lookahead<Q&&W===g)return p;if(l.lookahead===0)break}if($=0,l.lookahead>=R&&(l.ins_h=(l.ins_h<<l.hash_shift^l.window[l.strstart+R-1])&l.hash_mask,$=l.prev[l.strstart&l.w_mask]=l.head[l.ins_h],l.head[l.ins_h]=l.strstart),l.prev_length=l.match_length,l.prev_match=l.match_start,l.match_length=R-1,$!==0&&l.prev_length<l.max_lazy_match&&l.strstart-$<=l.w_size-Q&&(l.match_length=X(l,$),l.match_length<=5&&(l.strategy===1||l.match_length===R&&4096<l.strstart-l.match_start)&&(l.match_length=R-1)),l.prev_length>=R&&l.match_length<=l.prev_length){for(w=l.strstart+l.lookahead-R,E=s._tr_tally(l,l.strstart-1-l.prev_match,l.prev_length-R),l.lookahead-=l.prev_length-1,l.prev_length-=2;++l.strstart<=w&&(l.ins_h=(l.ins_h<<l.hash_shift^l.window[l.strstart+R-1])&l.hash_mask,$=l.prev[l.strstart&l.w_mask]=l.head[l.ins_h],l.head[l.ins_h]=l.strstart),--l.prev_length!=0;);if(l.match_available=0,l.match_length=R-1,l.strstart++,E&&(M(l,!1),l.strm.avail_out===0))return p}else if(l.match_available){if((E=s._tr_tally(l,0,l.window[l.strstart-1]))&&M(l,!1),l.strstart++,l.lookahead--,l.strm.avail_out===0)return p}else l.match_available=1,l.strstart++,l.lookahead--}return l.match_available&&(E=s._tr_tally(l,0,l.window[l.strstart-1]),l.match_available=0),l.insert=l.strstart<R-1?l.strstart:R-1,W===h?(M(l,!0),l.strm.avail_out===0?ue:j):l.last_lit&&(M(l,!1),l.strm.avail_out===0)?p:H}function be(l,W,$,E,w){this.good_length=l,this.max_lazy=W,this.nice_length=$,this.max_chain=E,this.func=w}function Te(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=C,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new i.Buf16(2*L),this.dyn_dtree=new i.Buf16(2*(2*I+1)),this.bl_tree=new i.Buf16(2*(2*x+1)),ne(this.dyn_ltree),ne(this.dyn_dtree),ne(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new i.Buf16(N+1),this.heap=new i.Buf16(2*S+1),ne(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new i.Buf16(2*S+1),ne(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function Ae(l){var W;return l&&l.state?(l.total_in=l.total_out=0,l.data_type=y,(W=l.state).pending=0,W.pending_out=0,W.wrap<0&&(W.wrap=-W.wrap),W.status=W.wrap?k:z,l.adler=W.wrap===2?0:1,W.last_flush=g,s._tr_init(W),f):fe(l,v)}function Ye(l){var W=Ae(l);return W===f&&function($){$.window_size=2*$.w_size,ne($.head),$.max_lazy_match=t[$.level].max_lazy,$.good_match=t[$.level].good_length,$.nice_match=t[$.level].nice_length,$.max_chain_length=t[$.level].max_chain,$.strstart=0,$.block_start=0,$.lookahead=0,$.insert=0,$.match_length=$.prev_length=R-1,$.match_available=0,$.ins_h=0}(l.state),W}function Xe(l,W,$,E,w,T){if(!l)return v;var Z=1;if(W===u&&(W=6),E<0?(Z=0,E=-E):15<E&&(Z=2,E-=16),w<1||_<w||$!==C||E<8||15<E||W<0||9<W||T<0||b<T)return fe(l,v);E===8&&(E=9);var G=new Te;return(l.state=G).strm=l,G.wrap=Z,G.gzhead=null,G.w_bits=E,G.w_size=1<<G.w_bits,G.w_mask=G.w_size-1,G.hash_bits=w+7,G.hash_size=1<<G.hash_bits,G.hash_mask=G.hash_size-1,G.hash_shift=~~((G.hash_bits+R-1)/R),G.window=new i.Buf8(2*G.w_size),G.head=new i.Buf16(G.hash_size),G.prev=new i.Buf16(G.w_size),G.lit_bufsize=1<<w+6,G.pending_buf_size=4*G.lit_bufsize,G.pending_buf=new i.Buf8(G.pending_buf_size),G.d_buf=1*G.lit_bufsize,G.l_buf=3*G.lit_bufsize,G.level=W,G.strategy=T,G.method=$,Ye(l)}t=[new be(0,0,0,0,function(l,W){var $=65535;for($>l.pending_buf_size-5&&($=l.pending_buf_size-5);;){if(l.lookahead<=1){if(De(l),l.lookahead===0&&W===g)return p;if(l.lookahead===0)break}l.strstart+=l.lookahead,l.lookahead=0;var E=l.block_start+$;if((l.strstart===0||l.strstart>=E)&&(l.lookahead=l.strstart-E,l.strstart=E,M(l,!1),l.strm.avail_out===0)||l.strstart-l.block_start>=l.w_size-Q&&(M(l,!1),l.strm.avail_out===0))return p}return l.insert=0,W===h?(M(l,!0),l.strm.avail_out===0?ue:j):(l.strstart>l.block_start&&(M(l,!1),l.strm.avail_out),p)}),new be(4,4,8,4,Oe),new be(4,5,16,8,Oe),new be(4,6,32,32,Oe),new be(4,4,16,16,he),new be(8,16,32,32,he),new be(8,16,128,128,he),new be(8,32,128,256,he),new be(32,128,258,1024,he),new be(32,258,258,4096,he)],o.deflateInit=function(l,W){return Xe(l,W,C,15,8,0)},o.deflateInit2=Xe,o.deflateReset=Ye,o.deflateResetKeep=Ae,o.deflateSetHeader=function(l,W){return l&&l.state?l.state.wrap!==2?v:(l.state.gzhead=W,f):v},o.deflate=function(l,W){var $,E,w,T;if(!l||!l.state||5<W||W<0)return l?fe(l,v):v;if(E=l.state,!l.output||!l.input&&l.avail_in!==0||E.status===666&&W!==h)return fe(l,l.avail_out===0?-5:v);if(E.strm=l,$=E.last_flush,E.last_flush=W,E.status===k)if(E.wrap===2)l.adler=0,oe(E,31),oe(E,139),oe(E,8),E.gzhead?(oe(E,(E.gzhead.text?1:0)+(E.gzhead.hcrc?2:0)+(E.gzhead.extra?4:0)+(E.gzhead.name?8:0)+(E.gzhead.comment?16:0)),oe(E,255&E.gzhead.time),oe(E,E.gzhead.time>>8&255),oe(E,E.gzhead.time>>16&255),oe(E,E.gzhead.time>>24&255),oe(E,E.level===9?2:2<=E.strategy||E.level<2?4:0),oe(E,255&E.gzhead.os),E.gzhead.extra&&E.gzhead.extra.length&&(oe(E,255&E.gzhead.extra.length),oe(E,E.gzhead.extra.length>>8&255)),E.gzhead.hcrc&&(l.adler=d(l.adler,E.pending_buf,E.pending,0)),E.gzindex=0,E.status=69):(oe(E,0),oe(E,0),oe(E,0),oe(E,0),oe(E,0),oe(E,E.level===9?2:2<=E.strategy||E.level<2?4:0),oe(E,3),E.status=z);else{var Z=C+(E.w_bits-8<<4)<<8;Z|=(2<=E.strategy||E.level<2?0:E.level<6?1:E.level===6?2:3)<<6,E.strstart!==0&&(Z|=32),Z+=31-Z%31,E.status=z,te(E,Z),E.strstart!==0&&(te(E,l.adler>>>16),te(E,65535&l.adler)),l.adler=1}if(E.status===69)if(E.gzhead.extra){for(w=E.pending;E.gzindex<(65535&E.gzhead.extra.length)&&(E.pending!==E.pending_buf_size||(E.gzhead.hcrc&&E.pending>w&&(l.adler=d(l.adler,E.pending_buf,E.pending-w,w)),O(l),w=E.pending,E.pending!==E.pending_buf_size));)oe(E,255&E.gzhead.extra[E.gzindex]),E.gzindex++;E.gzhead.hcrc&&E.pending>w&&(l.adler=d(l.adler,E.pending_buf,E.pending-w,w)),E.gzindex===E.gzhead.extra.length&&(E.gzindex=0,E.status=73)}else E.status=73;if(E.status===73)if(E.gzhead.name){w=E.pending;do{if(E.pending===E.pending_buf_size&&(E.gzhead.hcrc&&E.pending>w&&(l.adler=d(l.adler,E.pending_buf,E.pending-w,w)),O(l),w=E.pending,E.pending===E.pending_buf_size)){T=1;break}T=E.gzindex<E.gzhead.name.length?255&E.gzhead.name.charCodeAt(E.gzindex++):0,oe(E,T)}while(T!==0);E.gzhead.hcrc&&E.pending>w&&(l.adler=d(l.adler,E.pending_buf,E.pending-w,w)),T===0&&(E.gzindex=0,E.status=91)}else E.status=91;if(E.status===91)if(E.gzhead.comment){w=E.pending;do{if(E.pending===E.pending_buf_size&&(E.gzhead.hcrc&&E.pending>w&&(l.adler=d(l.adler,E.pending_buf,E.pending-w,w)),O(l),w=E.pending,E.pending===E.pending_buf_size)){T=1;break}T=E.gzindex<E.gzhead.comment.length?255&E.gzhead.comment.charCodeAt(E.gzindex++):0,oe(E,T)}while(T!==0);E.gzhead.hcrc&&E.pending>w&&(l.adler=d(l.adler,E.pending_buf,E.pending-w,w)),T===0&&(E.status=103)}else E.status=103;if(E.status===103&&(E.gzhead.hcrc?(E.pending+2>E.pending_buf_size&&O(l),E.pending+2<=E.pending_buf_size&&(oe(E,255&l.adler),oe(E,l.adler>>8&255),l.adler=0,E.status=z)):E.status=z),E.pending!==0){if(O(l),l.avail_out===0)return E.last_flush=-1,f}else if(l.avail_in===0&&F(W)<=F($)&&W!==h)return fe(l,-5);if(E.status===666&&l.avail_in!==0)return fe(l,-5);if(l.avail_in!==0||E.lookahead!==0||W!==g&&E.status!==666){var G=E.strategy===2?function(A,V){for(var ie;;){if(A.lookahead===0&&(De(A),A.lookahead===0)){if(V===g)return p;break}if(A.match_length=0,ie=s._tr_tally(A,0,A.window[A.strstart]),A.lookahead--,A.strstart++,ie&&(M(A,!1),A.strm.avail_out===0))return p}return A.insert=0,V===h?(M(A,!0),A.strm.avail_out===0?ue:j):A.last_lit&&(M(A,!1),A.strm.avail_out===0)?p:H}(E,W):E.strategy===3?function(A,V){for(var ie,K,le,Le,ye=A.window;;){if(A.lookahead<=P){if(De(A),A.lookahead<=P&&V===g)return p;if(A.lookahead===0)break}if(A.match_length=0,A.lookahead>=R&&0<A.strstart&&(K=ye[le=A.strstart-1])===ye[++le]&&K===ye[++le]&&K===ye[++le]){Le=A.strstart+P;do;while(K===ye[++le]&&K===ye[++le]&&K===ye[++le]&&K===ye[++le]&&K===ye[++le]&&K===ye[++le]&&K===ye[++le]&&K===ye[++le]&&le<Le);A.match_length=P-(Le-le),A.match_length>A.lookahead&&(A.match_length=A.lookahead)}if(A.match_length>=R?(ie=s._tr_tally(A,1,A.match_length-R),A.lookahead-=A.match_length,A.strstart+=A.match_length,A.match_length=0):(ie=s._tr_tally(A,0,A.window[A.strstart]),A.lookahead--,A.strstart++),ie&&(M(A,!1),A.strm.avail_out===0))return p}return A.insert=0,V===h?(M(A,!0),A.strm.avail_out===0?ue:j):A.last_lit&&(M(A,!1),A.strm.avail_out===0)?p:H}(E,W):t[E.level].func(E,W);if(G!==ue&&G!==j||(E.status=666),G===p||G===ue)return l.avail_out===0&&(E.last_flush=-1),f;if(G===H&&(W===1?s._tr_align(E):W!==5&&(s._tr_stored_block(E,0,0,!1),W===3&&(ne(E.head),E.lookahead===0&&(E.strstart=0,E.block_start=0,E.insert=0))),O(l),l.avail_out===0))return E.last_flush=-1,f}return W!==h?f:E.wrap<=0?1:(E.wrap===2?(oe(E,255&l.adler),oe(E,l.adler>>8&255),oe(E,l.adler>>16&255),oe(E,l.adler>>24&255),oe(E,255&l.total_in),oe(E,l.total_in>>8&255),oe(E,l.total_in>>16&255),oe(E,l.total_in>>24&255)):(te(E,l.adler>>>16),te(E,65535&l.adler)),O(l),0<E.wrap&&(E.wrap=-E.wrap),E.pending!==0?f:1)},o.deflateEnd=function(l){var W;return l&&l.state?(W=l.state.status)!==k&&W!==69&&W!==73&&W!==91&&W!==103&&W!==z&&W!==666?fe(l,v):(l.state=null,W===z?fe(l,-3):f):v},o.deflateSetDictionary=function(l,W){var $,E,w,T,Z,G,A,V,ie=W.length;if(!l||!l.state||(T=($=l.state).wrap)===2||T===1&&$.status!==k||$.lookahead)return v;for(T===1&&(l.adler=r(l.adler,W,ie,0)),$.wrap=0,ie>=$.w_size&&(T===0&&(ne($.head),$.strstart=0,$.block_start=0,$.insert=0),V=new i.Buf8($.w_size),i.arraySet(V,W,ie-$.w_size,$.w_size,0),W=V,ie=$.w_size),Z=l.avail_in,G=l.next_in,A=l.input,l.avail_in=ie,l.next_in=0,l.input=W,De($);$.lookahead>=R;){for(E=$.strstart,w=$.lookahead-(R-1);$.ins_h=($.ins_h<<$.hash_shift^$.window[E+R-1])&$.hash_mask,$.prev[E&$.w_mask]=$.head[$.ins_h],$.head[$.ins_h]=E,E++,--w;);$.strstart=E,$.lookahead=R-1,De($)}return $.strstart+=$.lookahead,$.block_start=$.strstart,$.insert=$.lookahead,$.lookahead=0,$.match_length=$.prev_length=R-1,$.match_available=0,l.next_in=G,l.input=A,l.avail_in=Z,$.wrap=T,f},o.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(e,c,o){c.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(e,c,o){c.exports=function(t,i){var s,r,d,m,g,h,f,v,u,b,y,C,_,S,I,x,L,N,R,P,Q,k,z,p,H;s=t.state,r=t.next_in,p=t.input,d=r+(t.avail_in-5),m=t.next_out,H=t.output,g=m-(i-t.avail_out),h=m+(t.avail_out-257),f=s.dmax,v=s.wsize,u=s.whave,b=s.wnext,y=s.window,C=s.hold,_=s.bits,S=s.lencode,I=s.distcode,x=(1<<s.lenbits)-1,L=(1<<s.distbits)-1;e:do{_<15&&(C+=p[r++]<<_,_+=8,C+=p[r++]<<_,_+=8),N=S[C&x];t:for(;;){if(C>>>=R=N>>>24,_-=R,(R=N>>>16&255)===0)H[m++]=65535&N;else{if(!(16&R)){if(!(64&R)){N=S[(65535&N)+(C&(1<<R)-1)];continue t}if(32&R){s.mode=12;break e}t.msg="invalid literal/length code",s.mode=30;break e}P=65535&N,(R&=15)&&(_<R&&(C+=p[r++]<<_,_+=8),P+=C&(1<<R)-1,C>>>=R,_-=R),_<15&&(C+=p[r++]<<_,_+=8,C+=p[r++]<<_,_+=8),N=I[C&L];n:for(;;){if(C>>>=R=N>>>24,_-=R,!(16&(R=N>>>16&255))){if(!(64&R)){N=I[(65535&N)+(C&(1<<R)-1)];continue n}t.msg="invalid distance code",s.mode=30;break e}if(Q=65535&N,_<(R&=15)&&(C+=p[r++]<<_,(_+=8)<R&&(C+=p[r++]<<_,_+=8)),f<(Q+=C&(1<<R)-1)){t.msg="invalid distance too far back",s.mode=30;break e}if(C>>>=R,_-=R,(R=m-g)<Q){if(u<(R=Q-R)&&s.sane){t.msg="invalid distance too far back",s.mode=30;break e}if(z=y,(k=0)===b){if(k+=v-R,R<P){for(P-=R;H[m++]=y[k++],--R;);k=m-Q,z=H}}else if(b<R){if(k+=v+b-R,(R-=b)<P){for(P-=R;H[m++]=y[k++],--R;);if(k=0,b<P){for(P-=R=b;H[m++]=y[k++],--R;);k=m-Q,z=H}}}else if(k+=b-R,R<P){for(P-=R;H[m++]=y[k++],--R;);k=m-Q,z=H}for(;2<P;)H[m++]=z[k++],H[m++]=z[k++],H[m++]=z[k++],P-=3;P&&(H[m++]=z[k++],1<P&&(H[m++]=z[k++]))}else{for(k=m-Q;H[m++]=H[k++],H[m++]=H[k++],H[m++]=H[k++],2<(P-=3););P&&(H[m++]=H[k++],1<P&&(H[m++]=H[k++]))}break}}break}}while(r<d&&m<h);r-=P=_>>3,C&=(1<<(_-=P<<3))-1,t.next_in=r,t.next_out=m,t.avail_in=r<d?d-r+5:5-(r-d),t.avail_out=m<h?h-m+257:257-(m-h),s.hold=C,s.bits=_}},{}],49:[function(e,c,o){var t=e("../utils/common"),i=e("./adler32"),s=e("./crc32"),r=e("./inffast"),d=e("./inftrees"),m=1,g=2,h=0,f=-2,v=1,u=852,b=592;function y(k){return(k>>>24&255)+(k>>>8&65280)+((65280&k)<<8)+((255&k)<<24)}function C(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new t.Buf16(320),this.work=new t.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function _(k){var z;return k&&k.state?(z=k.state,k.total_in=k.total_out=z.total=0,k.msg="",z.wrap&&(k.adler=1&z.wrap),z.mode=v,z.last=0,z.havedict=0,z.dmax=32768,z.head=null,z.hold=0,z.bits=0,z.lencode=z.lendyn=new t.Buf32(u),z.distcode=z.distdyn=new t.Buf32(b),z.sane=1,z.back=-1,h):f}function S(k){var z;return k&&k.state?((z=k.state).wsize=0,z.whave=0,z.wnext=0,_(k)):f}function I(k,z){var p,H;return k&&k.state?(H=k.state,z<0?(p=0,z=-z):(p=1+(z>>4),z<48&&(z&=15)),z&&(z<8||15<z)?f:(H.window!==null&&H.wbits!==z&&(H.window=null),H.wrap=p,H.wbits=z,S(k))):f}function x(k,z){var p,H;return k?(H=new C,(k.state=H).window=null,(p=I(k,z))!==h&&(k.state=null),p):f}var L,N,R=!0;function P(k){if(R){var z;for(L=new t.Buf32(512),N=new t.Buf32(32),z=0;z<144;)k.lens[z++]=8;for(;z<256;)k.lens[z++]=9;for(;z<280;)k.lens[z++]=7;for(;z<288;)k.lens[z++]=8;for(d(m,k.lens,0,288,L,0,k.work,{bits:9}),z=0;z<32;)k.lens[z++]=5;d(g,k.lens,0,32,N,0,k.work,{bits:5}),R=!1}k.lencode=L,k.lenbits=9,k.distcode=N,k.distbits=5}function Q(k,z,p,H){var ue,j=k.state;return j.window===null&&(j.wsize=1<<j.wbits,j.wnext=0,j.whave=0,j.window=new t.Buf8(j.wsize)),H>=j.wsize?(t.arraySet(j.window,z,p-j.wsize,j.wsize,0),j.wnext=0,j.whave=j.wsize):(H<(ue=j.wsize-j.wnext)&&(ue=H),t.arraySet(j.window,z,p-H,ue,j.wnext),(H-=ue)?(t.arraySet(j.window,z,p-H,H,0),j.wnext=H,j.whave=j.wsize):(j.wnext+=ue,j.wnext===j.wsize&&(j.wnext=0),j.whave<j.wsize&&(j.whave+=ue))),0}o.inflateReset=S,o.inflateReset2=I,o.inflateResetKeep=_,o.inflateInit=function(k){return x(k,15)},o.inflateInit2=x,o.inflate=function(k,z){var p,H,ue,j,fe,F,ne,O,M,oe,te,X,De,Oe,he,be,Te,Ae,Ye,Xe,l,W,$,E,w=0,T=new t.Buf8(4),Z=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!k||!k.state||!k.output||!k.input&&k.avail_in!==0)return f;(p=k.state).mode===12&&(p.mode=13),fe=k.next_out,ue=k.output,ne=k.avail_out,j=k.next_in,H=k.input,F=k.avail_in,O=p.hold,M=p.bits,oe=F,te=ne,W=h;e:for(;;)switch(p.mode){case v:if(p.wrap===0){p.mode=13;break}for(;M<16;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(2&p.wrap&&O===35615){T[p.check=0]=255&O,T[1]=O>>>8&255,p.check=s(p.check,T,2,0),M=O=0,p.mode=2;break}if(p.flags=0,p.head&&(p.head.done=!1),!(1&p.wrap)||(((255&O)<<8)+(O>>8))%31){k.msg="incorrect header check",p.mode=30;break}if((15&O)!=8){k.msg="unknown compression method",p.mode=30;break}if(M-=4,l=8+(15&(O>>>=4)),p.wbits===0)p.wbits=l;else if(l>p.wbits){k.msg="invalid window size",p.mode=30;break}p.dmax=1<<l,k.adler=p.check=1,p.mode=512&O?10:12,M=O=0;break;case 2:for(;M<16;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(p.flags=O,(255&p.flags)!=8){k.msg="unknown compression method",p.mode=30;break}if(57344&p.flags){k.msg="unknown header flags set",p.mode=30;break}p.head&&(p.head.text=O>>8&1),512&p.flags&&(T[0]=255&O,T[1]=O>>>8&255,p.check=s(p.check,T,2,0)),M=O=0,p.mode=3;case 3:for(;M<32;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}p.head&&(p.head.time=O),512&p.flags&&(T[0]=255&O,T[1]=O>>>8&255,T[2]=O>>>16&255,T[3]=O>>>24&255,p.check=s(p.check,T,4,0)),M=O=0,p.mode=4;case 4:for(;M<16;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}p.head&&(p.head.xflags=255&O,p.head.os=O>>8),512&p.flags&&(T[0]=255&O,T[1]=O>>>8&255,p.check=s(p.check,T,2,0)),M=O=0,p.mode=5;case 5:if(1024&p.flags){for(;M<16;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}p.length=O,p.head&&(p.head.extra_len=O),512&p.flags&&(T[0]=255&O,T[1]=O>>>8&255,p.check=s(p.check,T,2,0)),M=O=0}else p.head&&(p.head.extra=null);p.mode=6;case 6:if(1024&p.flags&&(F<(X=p.length)&&(X=F),X&&(p.head&&(l=p.head.extra_len-p.length,p.head.extra||(p.head.extra=new Array(p.head.extra_len)),t.arraySet(p.head.extra,H,j,X,l)),512&p.flags&&(p.check=s(p.check,H,X,j)),F-=X,j+=X,p.length-=X),p.length))break e;p.length=0,p.mode=7;case 7:if(2048&p.flags){if(F===0)break e;for(X=0;l=H[j+X++],p.head&&l&&p.length<65536&&(p.head.name+=String.fromCharCode(l)),l&&X<F;);if(512&p.flags&&(p.check=s(p.check,H,X,j)),F-=X,j+=X,l)break e}else p.head&&(p.head.name=null);p.length=0,p.mode=8;case 8:if(4096&p.flags){if(F===0)break e;for(X=0;l=H[j+X++],p.head&&l&&p.length<65536&&(p.head.comment+=String.fromCharCode(l)),l&&X<F;);if(512&p.flags&&(p.check=s(p.check,H,X,j)),F-=X,j+=X,l)break e}else p.head&&(p.head.comment=null);p.mode=9;case 9:if(512&p.flags){for(;M<16;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(O!==(65535&p.check)){k.msg="header crc mismatch",p.mode=30;break}M=O=0}p.head&&(p.head.hcrc=p.flags>>9&1,p.head.done=!0),k.adler=p.check=0,p.mode=12;break;case 10:for(;M<32;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}k.adler=p.check=y(O),M=O=0,p.mode=11;case 11:if(p.havedict===0)return k.next_out=fe,k.avail_out=ne,k.next_in=j,k.avail_in=F,p.hold=O,p.bits=M,2;k.adler=p.check=1,p.mode=12;case 12:if(z===5||z===6)break e;case 13:if(p.last){O>>>=7&M,M-=7&M,p.mode=27;break}for(;M<3;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}switch(p.last=1&O,M-=1,3&(O>>>=1)){case 0:p.mode=14;break;case 1:if(P(p),p.mode=20,z!==6)break;O>>>=2,M-=2;break e;case 2:p.mode=17;break;case 3:k.msg="invalid block type",p.mode=30}O>>>=2,M-=2;break;case 14:for(O>>>=7&M,M-=7&M;M<32;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if((65535&O)!=(O>>>16^65535)){k.msg="invalid stored block lengths",p.mode=30;break}if(p.length=65535&O,M=O=0,p.mode=15,z===6)break e;case 15:p.mode=16;case 16:if(X=p.length){if(F<X&&(X=F),ne<X&&(X=ne),X===0)break e;t.arraySet(ue,H,j,X,fe),F-=X,j+=X,ne-=X,fe+=X,p.length-=X;break}p.mode=12;break;case 17:for(;M<14;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(p.nlen=257+(31&O),O>>>=5,M-=5,p.ndist=1+(31&O),O>>>=5,M-=5,p.ncode=4+(15&O),O>>>=4,M-=4,286<p.nlen||30<p.ndist){k.msg="too many length or distance symbols",p.mode=30;break}p.have=0,p.mode=18;case 18:for(;p.have<p.ncode;){for(;M<3;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}p.lens[Z[p.have++]]=7&O,O>>>=3,M-=3}for(;p.have<19;)p.lens[Z[p.have++]]=0;if(p.lencode=p.lendyn,p.lenbits=7,$={bits:p.lenbits},W=d(0,p.lens,0,19,p.lencode,0,p.work,$),p.lenbits=$.bits,W){k.msg="invalid code lengths set",p.mode=30;break}p.have=0,p.mode=19;case 19:for(;p.have<p.nlen+p.ndist;){for(;be=(w=p.lencode[O&(1<<p.lenbits)-1])>>>16&255,Te=65535&w,!((he=w>>>24)<=M);){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(Te<16)O>>>=he,M-=he,p.lens[p.have++]=Te;else{if(Te===16){for(E=he+2;M<E;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(O>>>=he,M-=he,p.have===0){k.msg="invalid bit length repeat",p.mode=30;break}l=p.lens[p.have-1],X=3+(3&O),O>>>=2,M-=2}else if(Te===17){for(E=he+3;M<E;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}M-=he,l=0,X=3+(7&(O>>>=he)),O>>>=3,M-=3}else{for(E=he+7;M<E;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}M-=he,l=0,X=11+(127&(O>>>=he)),O>>>=7,M-=7}if(p.have+X>p.nlen+p.ndist){k.msg="invalid bit length repeat",p.mode=30;break}for(;X--;)p.lens[p.have++]=l}}if(p.mode===30)break;if(p.lens[256]===0){k.msg="invalid code -- missing end-of-block",p.mode=30;break}if(p.lenbits=9,$={bits:p.lenbits},W=d(m,p.lens,0,p.nlen,p.lencode,0,p.work,$),p.lenbits=$.bits,W){k.msg="invalid literal/lengths set",p.mode=30;break}if(p.distbits=6,p.distcode=p.distdyn,$={bits:p.distbits},W=d(g,p.lens,p.nlen,p.ndist,p.distcode,0,p.work,$),p.distbits=$.bits,W){k.msg="invalid distances set",p.mode=30;break}if(p.mode=20,z===6)break e;case 20:p.mode=21;case 21:if(6<=F&&258<=ne){k.next_out=fe,k.avail_out=ne,k.next_in=j,k.avail_in=F,p.hold=O,p.bits=M,r(k,te),fe=k.next_out,ue=k.output,ne=k.avail_out,j=k.next_in,H=k.input,F=k.avail_in,O=p.hold,M=p.bits,p.mode===12&&(p.back=-1);break}for(p.back=0;be=(w=p.lencode[O&(1<<p.lenbits)-1])>>>16&255,Te=65535&w,!((he=w>>>24)<=M);){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(be&&!(240&be)){for(Ae=he,Ye=be,Xe=Te;be=(w=p.lencode[Xe+((O&(1<<Ae+Ye)-1)>>Ae)])>>>16&255,Te=65535&w,!(Ae+(he=w>>>24)<=M);){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}O>>>=Ae,M-=Ae,p.back+=Ae}if(O>>>=he,M-=he,p.back+=he,p.length=Te,be===0){p.mode=26;break}if(32&be){p.back=-1,p.mode=12;break}if(64&be){k.msg="invalid literal/length code",p.mode=30;break}p.extra=15&be,p.mode=22;case 22:if(p.extra){for(E=p.extra;M<E;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}p.length+=O&(1<<p.extra)-1,O>>>=p.extra,M-=p.extra,p.back+=p.extra}p.was=p.length,p.mode=23;case 23:for(;be=(w=p.distcode[O&(1<<p.distbits)-1])>>>16&255,Te=65535&w,!((he=w>>>24)<=M);){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(!(240&be)){for(Ae=he,Ye=be,Xe=Te;be=(w=p.distcode[Xe+((O&(1<<Ae+Ye)-1)>>Ae)])>>>16&255,Te=65535&w,!(Ae+(he=w>>>24)<=M);){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}O>>>=Ae,M-=Ae,p.back+=Ae}if(O>>>=he,M-=he,p.back+=he,64&be){k.msg="invalid distance code",p.mode=30;break}p.offset=Te,p.extra=15&be,p.mode=24;case 24:if(p.extra){for(E=p.extra;M<E;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}p.offset+=O&(1<<p.extra)-1,O>>>=p.extra,M-=p.extra,p.back+=p.extra}if(p.offset>p.dmax){k.msg="invalid distance too far back",p.mode=30;break}p.mode=25;case 25:if(ne===0)break e;if(X=te-ne,p.offset>X){if((X=p.offset-X)>p.whave&&p.sane){k.msg="invalid distance too far back",p.mode=30;break}De=X>p.wnext?(X-=p.wnext,p.wsize-X):p.wnext-X,X>p.length&&(X=p.length),Oe=p.window}else Oe=ue,De=fe-p.offset,X=p.length;for(ne<X&&(X=ne),ne-=X,p.length-=X;ue[fe++]=Oe[De++],--X;);p.length===0&&(p.mode=21);break;case 26:if(ne===0)break e;ue[fe++]=p.length,ne--,p.mode=21;break;case 27:if(p.wrap){for(;M<32;){if(F===0)break e;F--,O|=H[j++]<<M,M+=8}if(te-=ne,k.total_out+=te,p.total+=te,te&&(k.adler=p.check=p.flags?s(p.check,ue,te,fe-te):i(p.check,ue,te,fe-te)),te=ne,(p.flags?O:y(O))!==p.check){k.msg="incorrect data check",p.mode=30;break}M=O=0}p.mode=28;case 28:if(p.wrap&&p.flags){for(;M<32;){if(F===0)break e;F--,O+=H[j++]<<M,M+=8}if(O!==(4294967295&p.total)){k.msg="incorrect length check",p.mode=30;break}M=O=0}p.mode=29;case 29:W=1;break e;case 30:W=-3;break e;case 31:return-4;case 32:default:return f}return k.next_out=fe,k.avail_out=ne,k.next_in=j,k.avail_in=F,p.hold=O,p.bits=M,(p.wsize||te!==k.avail_out&&p.mode<30&&(p.mode<27||z!==4))&&Q(k,k.output,k.next_out,te-k.avail_out)?(p.mode=31,-4):(oe-=k.avail_in,te-=k.avail_out,k.total_in+=oe,k.total_out+=te,p.total+=te,p.wrap&&te&&(k.adler=p.check=p.flags?s(p.check,ue,te,k.next_out-te):i(p.check,ue,te,k.next_out-te)),k.data_type=p.bits+(p.last?64:0)+(p.mode===12?128:0)+(p.mode===20||p.mode===15?256:0),(oe==0&&te===0||z===4)&&W===h&&(W=-5),W)},o.inflateEnd=function(k){if(!k||!k.state)return f;var z=k.state;return z.window&&(z.window=null),k.state=null,h},o.inflateGetHeader=function(k,z){var p;return k&&k.state&&2&(p=k.state).wrap?((p.head=z).done=!1,h):f},o.inflateSetDictionary=function(k,z){var p,H=z.length;return k&&k.state?(p=k.state).wrap!==0&&p.mode!==11?f:p.mode===11&&i(1,z,H,0)!==p.check?-3:Q(k,z,H,H)?(p.mode=31,-4):(p.havedict=1,h):f},o.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(e,c,o){var t=e("../utils/common"),i=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],s=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],r=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],d=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];c.exports=function(m,g,h,f,v,u,b,y){var C,_,S,I,x,L,N,R,P,Q=y.bits,k=0,z=0,p=0,H=0,ue=0,j=0,fe=0,F=0,ne=0,O=0,M=null,oe=0,te=new t.Buf16(16),X=new t.Buf16(16),De=null,Oe=0;for(k=0;k<=15;k++)te[k]=0;for(z=0;z<f;z++)te[g[h+z]]++;for(ue=Q,H=15;1<=H&&te[H]===0;H--);if(H<ue&&(ue=H),H===0)return v[u++]=20971520,v[u++]=20971520,y.bits=1,0;for(p=1;p<H&&te[p]===0;p++);for(ue<p&&(ue=p),k=F=1;k<=15;k++)if(F<<=1,(F-=te[k])<0)return-1;if(0<F&&(m===0||H!==1))return-1;for(X[1]=0,k=1;k<15;k++)X[k+1]=X[k]+te[k];for(z=0;z<f;z++)g[h+z]!==0&&(b[X[g[h+z]]++]=z);if(L=m===0?(M=De=b,19):m===1?(M=i,oe-=257,De=s,Oe-=257,256):(M=r,De=d,-1),k=p,x=u,fe=z=O=0,S=-1,I=(ne=1<<(j=ue))-1,m===1&&852<ne||m===2&&592<ne)return 1;for(;;){for(N=k-fe,P=b[z]<L?(R=0,b[z]):b[z]>L?(R=De[Oe+b[z]],M[oe+b[z]]):(R=96,0),C=1<<k-fe,p=_=1<<j;v[x+(O>>fe)+(_-=C)]=N<<24|R<<16|P|0,_!==0;);for(C=1<<k-1;O&C;)C>>=1;if(C!==0?(O&=C-1,O+=C):O=0,z++,--te[k]==0){if(k===H)break;k=g[h+b[z]]}if(ue<k&&(O&I)!==S){for(fe===0&&(fe=ue),x+=p,F=1<<(j=k-fe);j+fe<H&&!((F-=te[j+fe])<=0);)j++,F<<=1;if(ne+=1<<j,m===1&&852<ne||m===2&&592<ne)return 1;v[S=O&I]=ue<<24|j<<16|x-u|0}}return O!==0&&(v[x+O]=k-fe<<24|64<<16|0),y.bits=ue,0}},{"../utils/common":41}],51:[function(e,c,o){c.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(e,c,o){var t=e("../utils/common"),i=0,s=1;function r(w){for(var T=w.length;0<=--T;)w[T]=0}var d=0,m=29,g=256,h=g+1+m,f=30,v=19,u=2*h+1,b=15,y=16,C=7,_=256,S=16,I=17,x=18,L=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],N=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],R=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],P=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Q=new Array(2*(h+2));r(Q);var k=new Array(2*f);r(k);var z=new Array(512);r(z);var p=new Array(256);r(p);var H=new Array(m);r(H);var ue,j,fe,F=new Array(f);function ne(w,T,Z,G,A){this.static_tree=w,this.extra_bits=T,this.extra_base=Z,this.elems=G,this.max_length=A,this.has_stree=w&&w.length}function O(w,T){this.dyn_tree=w,this.max_code=0,this.stat_desc=T}function M(w){return w<256?z[w]:z[256+(w>>>7)]}function oe(w,T){w.pending_buf[w.pending++]=255&T,w.pending_buf[w.pending++]=T>>>8&255}function te(w,T,Z){w.bi_valid>y-Z?(w.bi_buf|=T<<w.bi_valid&65535,oe(w,w.bi_buf),w.bi_buf=T>>y-w.bi_valid,w.bi_valid+=Z-y):(w.bi_buf|=T<<w.bi_valid&65535,w.bi_valid+=Z)}function X(w,T,Z){te(w,Z[2*T],Z[2*T+1])}function De(w,T){for(var Z=0;Z|=1&w,w>>>=1,Z<<=1,0<--T;);return Z>>>1}function Oe(w,T,Z){var G,A,V=new Array(b+1),ie=0;for(G=1;G<=b;G++)V[G]=ie=ie+Z[G-1]<<1;for(A=0;A<=T;A++){var K=w[2*A+1];K!==0&&(w[2*A]=De(V[K]++,K))}}function he(w){var T;for(T=0;T<h;T++)w.dyn_ltree[2*T]=0;for(T=0;T<f;T++)w.dyn_dtree[2*T]=0;for(T=0;T<v;T++)w.bl_tree[2*T]=0;w.dyn_ltree[2*_]=1,w.opt_len=w.static_len=0,w.last_lit=w.matches=0}function be(w){8<w.bi_valid?oe(w,w.bi_buf):0<w.bi_valid&&(w.pending_buf[w.pending++]=w.bi_buf),w.bi_buf=0,w.bi_valid=0}function Te(w,T,Z,G){var A=2*T,V=2*Z;return w[A]<w[V]||w[A]===w[V]&&G[T]<=G[Z]}function Ae(w,T,Z){for(var G=w.heap[Z],A=Z<<1;A<=w.heap_len&&(A<w.heap_len&&Te(T,w.heap[A+1],w.heap[A],w.depth)&&A++,!Te(T,G,w.heap[A],w.depth));)w.heap[Z]=w.heap[A],Z=A,A<<=1;w.heap[Z]=G}function Ye(w,T,Z){var G,A,V,ie,K=0;if(w.last_lit!==0)for(;G=w.pending_buf[w.d_buf+2*K]<<8|w.pending_buf[w.d_buf+2*K+1],A=w.pending_buf[w.l_buf+K],K++,G===0?X(w,A,T):(X(w,(V=p[A])+g+1,T),(ie=L[V])!==0&&te(w,A-=H[V],ie),X(w,V=M(--G),Z),(ie=N[V])!==0&&te(w,G-=F[V],ie)),K<w.last_lit;);X(w,_,T)}function Xe(w,T){var Z,G,A,V=T.dyn_tree,ie=T.stat_desc.static_tree,K=T.stat_desc.has_stree,le=T.stat_desc.elems,Le=-1;for(w.heap_len=0,w.heap_max=u,Z=0;Z<le;Z++)V[2*Z]!==0?(w.heap[++w.heap_len]=Le=Z,w.depth[Z]=0):V[2*Z+1]=0;for(;w.heap_len<2;)V[2*(A=w.heap[++w.heap_len]=Le<2?++Le:0)]=1,w.depth[A]=0,w.opt_len--,K&&(w.static_len-=ie[2*A+1]);for(T.max_code=Le,Z=w.heap_len>>1;1<=Z;Z--)Ae(w,V,Z);for(A=le;Z=w.heap[1],w.heap[1]=w.heap[w.heap_len--],Ae(w,V,1),G=w.heap[1],w.heap[--w.heap_max]=Z,w.heap[--w.heap_max]=G,V[2*A]=V[2*Z]+V[2*G],w.depth[A]=(w.depth[Z]>=w.depth[G]?w.depth[Z]:w.depth[G])+1,V[2*Z+1]=V[2*G+1]=A,w.heap[1]=A++,Ae(w,V,1),2<=w.heap_len;);w.heap[--w.heap_max]=w.heap[1],function(ye,je){var mt,nt,ht,ve,Ct,un,Qe=je.dyn_tree,Wt=je.max_code,Kn=je.stat_desc.static_tree,Yn=je.stat_desc.has_stree,Xn=je.stat_desc.extra_bits,fn=je.stat_desc.extra_base,wt=je.stat_desc.max_length,Tt=0;for(ve=0;ve<=b;ve++)ye.bl_count[ve]=0;for(Qe[2*ye.heap[ye.heap_max]+1]=0,mt=ye.heap_max+1;mt<u;mt++)wt<(ve=Qe[2*Qe[2*(nt=ye.heap[mt])+1]+1]+1)&&(ve=wt,Tt++),Qe[2*nt+1]=ve,Wt<nt||(ye.bl_count[ve]++,Ct=0,fn<=nt&&(Ct=Xn[nt-fn]),un=Qe[2*nt],ye.opt_len+=un*(ve+Ct),Yn&&(ye.static_len+=un*(Kn[2*nt+1]+Ct)));if(Tt!==0){do{for(ve=wt-1;ye.bl_count[ve]===0;)ve--;ye.bl_count[ve]--,ye.bl_count[ve+1]+=2,ye.bl_count[wt]--,Tt-=2}while(0<Tt);for(ve=wt;ve!==0;ve--)for(nt=ye.bl_count[ve];nt!==0;)Wt<(ht=ye.heap[--mt])||(Qe[2*ht+1]!==ve&&(ye.opt_len+=(ve-Qe[2*ht+1])*Qe[2*ht],Qe[2*ht+1]=ve),nt--)}}(w,T),Oe(V,Le,w.bl_count)}function l(w,T,Z){var G,A,V=-1,ie=T[1],K=0,le=7,Le=4;for(ie===0&&(le=138,Le=3),T[2*(Z+1)+1]=65535,G=0;G<=Z;G++)A=ie,ie=T[2*(G+1)+1],++K<le&&A===ie||(K<Le?w.bl_tree[2*A]+=K:A!==0?(A!==V&&w.bl_tree[2*A]++,w.bl_tree[2*S]++):K<=10?w.bl_tree[2*I]++:w.bl_tree[2*x]++,V=A,Le=(K=0)===ie?(le=138,3):A===ie?(le=6,3):(le=7,4))}function W(w,T,Z){var G,A,V=-1,ie=T[1],K=0,le=7,Le=4;for(ie===0&&(le=138,Le=3),G=0;G<=Z;G++)if(A=ie,ie=T[2*(G+1)+1],!(++K<le&&A===ie)){if(K<Le)for(;X(w,A,w.bl_tree),--K!=0;);else A!==0?(A!==V&&(X(w,A,w.bl_tree),K--),X(w,S,w.bl_tree),te(w,K-3,2)):K<=10?(X(w,I,w.bl_tree),te(w,K-3,3)):(X(w,x,w.bl_tree),te(w,K-11,7));V=A,Le=(K=0)===ie?(le=138,3):A===ie?(le=6,3):(le=7,4)}}r(F);var $=!1;function E(w,T,Z,G){te(w,(d<<1)+(G?1:0),3),function(A,V,ie,K){be(A),oe(A,ie),oe(A,~ie),t.arraySet(A.pending_buf,A.window,V,ie,A.pending),A.pending+=ie}(w,T,Z)}o._tr_init=function(w){$||(function(){var T,Z,G,A,V,ie=new Array(b+1);for(A=G=0;A<m-1;A++)for(H[A]=G,T=0;T<1<<L[A];T++)p[G++]=A;for(p[G-1]=A,A=V=0;A<16;A++)for(F[A]=V,T=0;T<1<<N[A];T++)z[V++]=A;for(V>>=7;A<f;A++)for(F[A]=V<<7,T=0;T<1<<N[A]-7;T++)z[256+V++]=A;for(Z=0;Z<=b;Z++)ie[Z]=0;for(T=0;T<=143;)Q[2*T+1]=8,T++,ie[8]++;for(;T<=255;)Q[2*T+1]=9,T++,ie[9]++;for(;T<=279;)Q[2*T+1]=7,T++,ie[7]++;for(;T<=287;)Q[2*T+1]=8,T++,ie[8]++;for(Oe(Q,h+1,ie),T=0;T<f;T++)k[2*T+1]=5,k[2*T]=De(T,5);ue=new ne(Q,L,g+1,h,b),j=new ne(k,N,0,f,b),fe=new ne(new Array(0),R,0,v,C)}(),$=!0),w.l_desc=new O(w.dyn_ltree,ue),w.d_desc=new O(w.dyn_dtree,j),w.bl_desc=new O(w.bl_tree,fe),w.bi_buf=0,w.bi_valid=0,he(w)},o._tr_stored_block=E,o._tr_flush_block=function(w,T,Z,G){var A,V,ie=0;0<w.level?(w.strm.data_type===2&&(w.strm.data_type=function(K){var le,Le=4093624447;for(le=0;le<=31;le++,Le>>>=1)if(1&Le&&K.dyn_ltree[2*le]!==0)return i;if(K.dyn_ltree[18]!==0||K.dyn_ltree[20]!==0||K.dyn_ltree[26]!==0)return s;for(le=32;le<g;le++)if(K.dyn_ltree[2*le]!==0)return s;return i}(w)),Xe(w,w.l_desc),Xe(w,w.d_desc),ie=function(K){var le;for(l(K,K.dyn_ltree,K.l_desc.max_code),l(K,K.dyn_dtree,K.d_desc.max_code),Xe(K,K.bl_desc),le=v-1;3<=le&&K.bl_tree[2*P[le]+1]===0;le--);return K.opt_len+=3*(le+1)+5+5+4,le}(w),A=w.opt_len+3+7>>>3,(V=w.static_len+3+7>>>3)<=A&&(A=V)):A=V=Z+5,Z+4<=A&&T!==-1?E(w,T,Z,G):w.strategy===4||V===A?(te(w,2+(G?1:0),3),Ye(w,Q,k)):(te(w,4+(G?1:0),3),function(K,le,Le,ye){var je;for(te(K,le-257,5),te(K,Le-1,5),te(K,ye-4,4),je=0;je<ye;je++)te(K,K.bl_tree[2*P[je]+1],3);W(K,K.dyn_ltree,le-1),W(K,K.dyn_dtree,Le-1)}(w,w.l_desc.max_code+1,w.d_desc.max_code+1,ie+1),Ye(w,w.dyn_ltree,w.dyn_dtree)),he(w),G&&be(w)},o._tr_tally=function(w,T,Z){return w.pending_buf[w.d_buf+2*w.last_lit]=T>>>8&255,w.pending_buf[w.d_buf+2*w.last_lit+1]=255&T,w.pending_buf[w.l_buf+w.last_lit]=255&Z,w.last_lit++,T===0?w.dyn_ltree[2*Z]++:(w.matches++,T--,w.dyn_ltree[2*(p[Z]+g+1)]++,w.dyn_dtree[2*M(T)]++),w.last_lit===w.lit_bufsize-1},o._tr_align=function(w){te(w,2,3),X(w,_,Q),function(T){T.bi_valid===16?(oe(T,T.bi_buf),T.bi_buf=0,T.bi_valid=0):8<=T.bi_valid&&(T.pending_buf[T.pending++]=255&T.bi_buf,T.bi_buf>>=8,T.bi_valid-=8)}(w)}},{"../utils/common":41}],53:[function(e,c,o){c.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(e,c,o){(function(t){(function(i,s){if(!i.setImmediate){var r,d,m,g,h=1,f={},v=!1,u=i.document,b=Object.getPrototypeOf&&Object.getPrototypeOf(i);b=b&&b.setTimeout?b:i,r={}.toString.call(i.process)==="[object process]"?function(S){process.nextTick(function(){C(S)})}:function(){if(i.postMessage&&!i.importScripts){var S=!0,I=i.onmessage;return i.onmessage=function(){S=!1},i.postMessage("","*"),i.onmessage=I,S}}()?(g="setImmediate$"+Math.random()+"$",i.addEventListener?i.addEventListener("message",_,!1):i.attachEvent("onmessage",_),function(S){i.postMessage(g+S,"*")}):i.MessageChannel?((m=new MessageChannel).port1.onmessage=function(S){C(S.data)},function(S){m.port2.postMessage(S)}):u&&"onreadystatechange"in u.createElement("script")?(d=u.documentElement,function(S){var I=u.createElement("script");I.onreadystatechange=function(){C(S),I.onreadystatechange=null,d.removeChild(I),I=null},d.appendChild(I)}):function(S){setTimeout(C,0,S)},b.setImmediate=function(S){typeof S!="function"&&(S=new Function(""+S));for(var I=new Array(arguments.length-1),x=0;x<I.length;x++)I[x]=arguments[x+1];var L={callback:S,args:I};return f[h]=L,r(h),h++},b.clearImmediate=y}function y(S){delete f[S]}function C(S){if(v)setTimeout(C,0,S);else{var I=f[S];if(I){v=!0;try{(function(x){var L=x.callback,N=x.args;switch(N.length){case 0:L();break;case 1:L(N[0]);break;case 2:L(N[0],N[1]);break;case 3:L(N[0],N[1],N[2]);break;default:L.apply(s,N)}})(I)}finally{y(S),v=!1}}}}function _(S){S.source===i&&typeof S.data=="string"&&S.data.indexOf(g)===0&&C(+S.data.slice(g.length))}})(typeof self>"u"?t===void 0?this:t:self)}).call(this,typeof pn<"u"?pn:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(ri);var ha=ri.exports;const ks=ai(ha);var oi={exports:{}};(function(n){var a=function(){var e=String.fromCharCode,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",t={};function i(r,d){if(!t[r]){t[r]={};for(var m=0;m<r.length;m++)t[r][r.charAt(m)]=m}return t[r][d]}var s={compressToBase64:function(r){if(r==null)return"";var d=s._compress(r,6,function(m){return c.charAt(m)});switch(d.length%4){default:case 0:return d;case 1:return d+"===";case 2:return d+"==";case 3:return d+"="}},decompressFromBase64:function(r){return r==null?"":r==""?null:s._decompress(r.length,32,function(d){return i(c,r.charAt(d))})},compressToUTF16:function(r){return r==null?"":s._compress(r,15,function(d){return e(d+32)})+" "},decompressFromUTF16:function(r){return r==null?"":r==""?null:s._decompress(r.length,16384,function(d){return r.charCodeAt(d)-32})},compressToUint8Array:function(r){for(var d=s.compress(r),m=new Uint8Array(d.length*2),g=0,h=d.length;g<h;g++){var f=d.charCodeAt(g);m[g*2]=f>>>8,m[g*2+1]=f%256}return m},decompressFromUint8Array:function(r){if(r==null)return s.decompress(r);for(var d=new Array(r.length/2),m=0,g=d.length;m<g;m++)d[m]=r[m*2]*256+r[m*2+1];var h=[];return d.forEach(function(f){h.push(e(f))}),s.decompress(h.join(""))},compressToEncodedURIComponent:function(r){return r==null?"":s._compress(r,6,function(d){return o.charAt(d)})},decompressFromEncodedURIComponent:function(r){return r==null?"":r==""?null:(r=r.replace(/ /g,"+"),s._decompress(r.length,32,function(d){return i(o,r.charAt(d))}))},compress:function(r){return s._compress(r,16,function(d){return e(d)})},_compress:function(r,d,m){if(r==null)return"";var g,h,f={},v={},u="",b="",y="",C=2,_=3,S=2,I=[],x=0,L=0,N;for(N=0;N<r.length;N+=1)if(u=r.charAt(N),Object.prototype.hasOwnProperty.call(f,u)||(f[u]=_++,v[u]=!0),b=y+u,Object.prototype.hasOwnProperty.call(f,b))y=b;else{if(Object.prototype.hasOwnProperty.call(v,y)){if(y.charCodeAt(0)<256){for(g=0;g<S;g++)x=x<<1,L==d-1?(L=0,I.push(m(x)),x=0):L++;for(h=y.charCodeAt(0),g=0;g<8;g++)x=x<<1|h&1,L==d-1?(L=0,I.push(m(x)),x=0):L++,h=h>>1}else{for(h=1,g=0;g<S;g++)x=x<<1|h,L==d-1?(L=0,I.push(m(x)),x=0):L++,h=0;for(h=y.charCodeAt(0),g=0;g<16;g++)x=x<<1|h&1,L==d-1?(L=0,I.push(m(x)),x=0):L++,h=h>>1}C--,C==0&&(C=Math.pow(2,S),S++),delete v[y]}else for(h=f[y],g=0;g<S;g++)x=x<<1|h&1,L==d-1?(L=0,I.push(m(x)),x=0):L++,h=h>>1;C--,C==0&&(C=Math.pow(2,S),S++),f[b]=_++,y=String(u)}if(y!==""){if(Object.prototype.hasOwnProperty.call(v,y)){if(y.charCodeAt(0)<256){for(g=0;g<S;g++)x=x<<1,L==d-1?(L=0,I.push(m(x)),x=0):L++;for(h=y.charCodeAt(0),g=0;g<8;g++)x=x<<1|h&1,L==d-1?(L=0,I.push(m(x)),x=0):L++,h=h>>1}else{for(h=1,g=0;g<S;g++)x=x<<1|h,L==d-1?(L=0,I.push(m(x)),x=0):L++,h=0;for(h=y.charCodeAt(0),g=0;g<16;g++)x=x<<1|h&1,L==d-1?(L=0,I.push(m(x)),x=0):L++,h=h>>1}C--,C==0&&(C=Math.pow(2,S),S++),delete v[y]}else for(h=f[y],g=0;g<S;g++)x=x<<1|h&1,L==d-1?(L=0,I.push(m(x)),x=0):L++,h=h>>1;C--,C==0&&(C=Math.pow(2,S),S++)}for(h=2,g=0;g<S;g++)x=x<<1|h&1,L==d-1?(L=0,I.push(m(x)),x=0):L++,h=h>>1;for(;;)if(x=x<<1,L==d-1){I.push(m(x));break}else L++;return I.join("")},decompress:function(r){return r==null?"":r==""?null:s._decompress(r.length,32768,function(d){return r.charCodeAt(d)})},_decompress:function(r,d,m){var g=[],h=4,f=4,v=3,u="",b=[],y,C,_,S,I,x,L,N={val:m(0),position:d,index:1};for(y=0;y<3;y+=1)g[y]=y;for(_=0,I=Math.pow(2,2),x=1;x!=I;)S=N.val&N.position,N.position>>=1,N.position==0&&(N.position=d,N.val=m(N.index++)),_|=(S>0?1:0)*x,x<<=1;switch(_){case 0:for(_=0,I=Math.pow(2,8),x=1;x!=I;)S=N.val&N.position,N.position>>=1,N.position==0&&(N.position=d,N.val=m(N.index++)),_|=(S>0?1:0)*x,x<<=1;L=e(_);break;case 1:for(_=0,I=Math.pow(2,16),x=1;x!=I;)S=N.val&N.position,N.position>>=1,N.position==0&&(N.position=d,N.val=m(N.index++)),_|=(S>0?1:0)*x,x<<=1;L=e(_);break;case 2:return""}for(g[3]=L,C=L,b.push(L);;){if(N.index>r)return"";for(_=0,I=Math.pow(2,v),x=1;x!=I;)S=N.val&N.position,N.position>>=1,N.position==0&&(N.position=d,N.val=m(N.index++)),_|=(S>0?1:0)*x,x<<=1;switch(L=_){case 0:for(_=0,I=Math.pow(2,8),x=1;x!=I;)S=N.val&N.position,N.position>>=1,N.position==0&&(N.position=d,N.val=m(N.index++)),_|=(S>0?1:0)*x,x<<=1;g[f++]=e(_),L=f-1,h--;break;case 1:for(_=0,I=Math.pow(2,16),x=1;x!=I;)S=N.val&N.position,N.position>>=1,N.position==0&&(N.position=d,N.val=m(N.index++)),_|=(S>0?1:0)*x,x<<=1;g[f++]=e(_),L=f-1,h--;break;case 2:return b.join("")}if(h==0&&(h=Math.pow(2,v),v++),g[L])u=g[L];else if(L===f)u=C+C.charAt(0);else return null;b.push(u),g[f++]=C+u.charAt(0),h--,C=u,h==0&&(h=Math.pow(2,v),v++)}}};return s}();n!=null?n.exports=a:typeof angular<"u"&&angular!=null&&angular.module("LZString",[]).factory("LZString",function(){return a})})(oi);var pa=oi.exports;const ci=ai(pa);function ga(n){return new Worker("/assets/compression.worker-B3kqe_bR.js",{name:n==null?void 0:n.name})}let re={},D=null,Ss=null,J=null,Se=null,nn=null,Zn=null,Is=[],xn=null,xs=null,Ve=null,Ln=0,Ls=0,Tn=0,Ts=0,Bs=null,Ds=null,Bn=null,vt=null,Ze=-1,Ns=null,Dn=null,Nn=null,An=null,li=null,di=null,lt=!1,pe=[],ct=[],xt=[],Ge={isScreenSaverEnabled:!0,lastRestoreTimestamp:null,lastBackupTimestamp:null},Dt=null;const As=new ga;As.onmessage=n=>{const a=n.data;try{localStorage.setItem("teacherAssistantData_v2",a),console.log("Background save complete.")}catch(e){console.error("Background storage failed:",e)}};As.onerror=n=>{console.error("❌ Worker Communication Error:",n.message,n)};function ce(n=!1){if(lt)return;const e=JSON.stringify({classrooms:re,trashBin:pe,userSettings:Ge});if(n){Dt&&clearTimeout(Dt);try{const c=ci.compressToUTF16(e);localStorage.setItem("teacherAssistantData_v2",c),console.log("Immediate save complete.")}catch(c){console.error("Immediate save failed:",c)}return}Dt&&clearTimeout(Dt),Dt=setTimeout(()=>{As.postMessage(e),Dt=null},500)}function ya(n){return new Promise((a,e)=>{const c=new FileReader;c.onerror=e,c.onload=()=>{a(c.result.split(",")[1])},c.readAsDataURL(n)})}async function ui(n=[]){const a={};if(n.length>0)n.forEach(d=>{re[d]&&(a[d]=re[d])});else for(const d in re)re[d].isDeleted||(a[d]=re[d]);const e={metadata:{version:"2.0-b64",createdAt:new Date().toISOString()},data:{classrooms:a,trashBin:pe}},c=JSON.stringify(e),o=new Date,t=new Intl.DateTimeFormat("fa-IR-u-nu-latn",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(o).reduce((d,m)=>(d[m.type]=m.value,d),{}),s=`${t.year.slice(-2)}-${t.month}-${t.day}_${t.hour}-${t.minute}`;let r;n.length===0?r=`SP_Full_${s}.txt`:n.length===1?r=`SP_${n[0].replace(/[<>:"/\\|?*]/g,"").replace(/\s+/g,"_")}_${s}.txt`:r=`SP_Selected-${n.length}_${s}.txt`;try{const d=new ks;d.file("backup.json",c);const m=await d.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:9}}),g=await ya(m);return new File([g],r,{type:"text/plain"})}catch(d){return console.error("Error creating base64 backup file:",d),null}}function On(){const n=localStorage.getItem("teacherAssistantData_v2");if(!n)return;let a;try{const e=ci.decompressFromUTF16(n);e?a=JSON.parse(e):a=JSON.parse(n)}catch{console.log("Migration: Parsing legacy uncompressed data..."),a=JSON.parse(n)}a.classrooms!==void 0&&a.trashBin!==void 0?(Lt(a.classrooms),pe=a.trashBin||[],Ge={...Ge,...a.userSettings}):(Lt(a),va())}function va(){const n=[];Object.values(re).forEach(a=>{a.isDeleted?n.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:a.info.creationDate,type:"classroom",description:`کلاس «${a.info.name}»`,restoreData:{name:a.info.name}}):a.students.forEach(e=>{e.isDeleted&&n.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:e.identity.studentId.split("_")[1],type:"student",description:`دانش‌آموز «${e.identity.name}»`,restoreData:{studentId:e.identity.studentId,classroomName:a.info.name}})})}),pe.length===0&&n.length>0&&(pe=n,console.log(`Migrated ${n.length} previously deleted item(s) to the new trash bin.`),ce())}function fi(n){const a=new yn(n.identity);return a.isDeleted=n.isDeleted,a.statusCounters=n.statusCounters,a.logs=n.logs,a.logs.scores||(a.logs.scores={}),a.profile=n.profile,a.finalClassActivityScore=n.finalClassActivityScore,a.categoryCounts=n.categoryCounts||{},a.categoryIssues=n.categoryIssues||{},a.onboardingSession=n.onboardingSession||null,a}function Lt(n){re={};for(const a in n){const e=n[a];let c;e.info?c=e.info:c={...e,name:a};const o=new as(c);o.isDeleted=e.isDeleted,o.note=e.note||"",o.students=(e.students||[]).map(fi),o.sessions=(e.sessions||[]).map(t=>{const i=new ii(t.sessionNumber);i.isDeleted=t.isDeleted,i.note=t.note||"",i.startTime=new Date(t.startTime),i.createdAt=t.createdAt?new Date(t.createdAt):new Date(t.startTime),i.endTime=t.endTime?new Date(t.endTime):null,i.isFinished=t.isFinished,i.isMakeup=t.isMakeup,i.isCancelled=t.isCancelled||!1,i.studentRecords=t.studentRecords;for(const r in i.studentRecords){const d=i.studentRecords[r];d.homework&&!(d.homework instanceof is)&&(i.studentRecords[r].homework=new is(d.homework.status,d.homework.comment))}i.lastWinnerByCategory=t.lastWinnerByCategory,i.lastUsedCategoryId=t.lastUsedCategoryId,i.lastSelectedWinnerId=t.lastSelectedWinnerId;const s=t.winnerHistory||[];return i.winnerHistory=s.filter(r=>r&&r.winner).map(r=>({winner:o.students.find(m=>m.identity.studentId===r.winner.identity.studentId),categoryName:r.categoryName})).filter(r=>r.winner),i}),o.categories=(e.categories||[]).map(t=>{const i=new ft(t.name,t.description,t.isGradedCategory);return i.id=t.id,i.isDeleted=t.isDeleted,i}),o.futurePlans=e.futurePlans,re[a]=o}}function mi(n,a){if(a)Lt(n.data.classrooms),zs(n.data.trashBin||[]);else{const e=n.data.classrooms,c=n.data.trashBin||[],o=new Map;for(const i in re){const s=re[i];s.info&&s.info.scheduleCode&&o.set(s.info.scheduleCode,i)}for(const i in e){const s=e[i],r=s.info.scheduleCode;if(o.has(r)){const d=o.get(r);d!==s.info.name&&delete re[d],re[s.info.name]=s}else{let d=s.info.name;for(;re[d];)d=`${d} (Imported)`;d!==s.info.name&&(s.info.name=d),re[d]=s}}const t=new Set(pe.map(i=>i.id));c.forEach(i=>{t.has(i.id)||pe.push(i)}),Lt(re)}Kt({lastRestoreTimestamp:new Date().toISOString()}),ce()}function hi(n,a){if(re[a])return{success:!1,message:"کلاسی با این نام از قبل وجود دارد."};const e=re[n];return e?(e.info.name=a,re[a]=e,delete re[n],D===e&&He(e),{success:!0}):{success:!1,message:"کلاس مورد نظر یافت نشد."}}function pi(n,a,e){const c=e.trim();if(!c)return{success:!1,message:"نام دسته‌بندی نمی‌تواند خالی باشد."};if(n.categories.some(r=>r.id!==a.id&&!r.isDeleted&&r.name.toLowerCase()===c.toLowerCase()))return{success:!1,message:"دسته‌بندی دیگری با این نام وجود دارد."};const t=a.name,i=t.toLowerCase(),s=c.toLowerCase();return a.name=c,n.students.forEach(r=>{r.categoryCounts&&r.categoryCounts[t]!==void 0&&(r.categoryCounts[c]=r.categoryCounts[t],delete r.categoryCounts[t]),r.categoryIssues&&r.categoryIssues[t]!==void 0&&(r.categoryIssues[c]=r.categoryIssues[t],delete r.categoryIssues[t]),r.logs.scores&&r.logs.scores[i]&&(r.logs.scores[i].forEach(d=>d.skill=c),i!==s&&(r.logs.scores[s]=r.logs.scores[i],delete r.logs.scores[i]))}),n.sessions.forEach(r=>{r.lastWinnerByCategory&&r.lastWinnerByCategory[t]&&(r.lastWinnerByCategory[c]=r.lastWinnerByCategory[t],delete r.lastWinnerByCategory[t]),r.winnerHistory&&r.winnerHistory.forEach(d=>{d.categoryName===t&&(d.categoryName=c)})}),{success:!0}}function gi(n,a,e){if(Ie(e.students).some(d=>d.identity.name.toLowerCase()===n.identity.name.toLowerCase()))return{success:!1,message:`دانش‌آموزی با نام «${n.identity.name}» از قبل در کلاس «${e.info.name}» وجود دارد.`};const o=JSON.parse(JSON.stringify(n)),t=fi(o),i=new Map;a.sessions.forEach(d=>{const m=d.studentRecords[n.identity.studentId];m&&i.set(d.sessionNumber,JSON.parse(JSON.stringify(m)))}),e.addStudent(t);try{const d=Ie(e.sessions).filter(b=>!b.isCancelled).sort((b,y)=>y.sessionNumber-b.sessionNumber),m=d.length>0?d[0]:null;let g="؟",h={type:"system",description:"Student Move"};m&&(g=tt(e).get(m.sessionNumber)||m.sessionNumber,h={type:"fromSession",sessionNumber:m.sessionNumber});const f=new Date().toLocaleDateString("fa-IR"),v=a.info.name,u=`این دانش آموز در جلسه ${g} و در تاریخ ${f} از کلاس «${v}» به این کلاس انتقال پیدا کرد`;t.addNote(u,h)}catch(d){console.error("Failed to add automated move note:",d)}i.size>0&&e.sessions.forEach(d=>{const m=i.get(d.sessionNumber);m&&!d.isDeleted&&!d.isCancelled&&(d.studentRecords[t.identity.studentId]=m)});const s={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`(انتقال) دانش‌آموز «${n.identity.name}» از کلاس «${a.info.name}»`,restoreData:{studentId:n.identity.studentId,classId:a.info.scheduleCode}};pe.unshift(s),pe.length>50&&pe.pop();const r=a.students.find(d=>d.identity.studentId===n.identity.studentId);return r&&(r.isDeleted=!0),{success:!0}}function yi(){for(const n in re){const a=re[n];a.students.forEach(e=>{e.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0},e.categoryCounts={},e.categoryIssues={},a.sessions.forEach(c=>{const o=e.identity.studentId;c.studentRecords[o]&&(c.studentRecords[o].attendance="present")})})}ce()}function Ie(n){return Array.isArray(n)?n.filter(a=>!a.isDeleted):[]}function tt(n){const a=new Map;return n&&Ie(n.sessions).filter(c=>!c.isCancelled).sort((c,o)=>c.sessionNumber-o.sessionNumber).forEach((c,o)=>{a.set(c.sessionNumber,o+1)}),a}function bt(n){Ze=n}function rt(n){Ns=n}function Mn(n,a){if(!n||!a)return;const e=n.identity.studentId,c=a.students.findIndex(o=>o.identity.studentId===e);c>-1&&a.students.splice(c,1),a.sessions.forEach(o=>{o.studentRecords[e]&&delete o.studentRecords[e];for(const t in o.lastWinnerByCategory)o.lastWinnerByCategory[t]===e&&delete o.lastWinnerByCategory[t];o.lastSelectedWinnerId===e&&(o.lastSelectedWinnerId=null),o.winnerHistory=o.winnerHistory.filter(t=>t.winner&&t.winner.identity.studentId!==e)})}function vi(n,a){const e=re[n];if(!e)return;const c=e.sessions.findIndex(o=>o.sessionNumber===a);c>-1&&(e.students.forEach(o=>{o.profile.notes&&o.profile.notes.length>0&&(o.profile.notes=o.profile.notes.filter(t=>!t.source||t.source.type!=="fromAttendance"||t.source.sessionNumber!==a)),o.onboardingSession===a&&(o.onboardingSession=null)}),e.sessions.splice(c,1))}function bi(n,a){const e=re[n];if(!e)return;const c=e.categories.findIndex(s=>s.id===a);if(c===-1)return;const t=e.categories[c].name,i=t.toLowerCase();e.students.forEach(s=>{s.categoryCounts&&delete s.categoryCounts[t],s.categoryIssues&&delete s.categoryIssues[t],s.logs.scores&&delete s.logs.scores[i]}),e.sessions.forEach(s=>{s.lastWinnerByCategory[t]&&delete s.lastWinnerByCategory[t],s.winnerHistory=s.winnerHistory.filter(r=>r.categoryName!==t)}),e.categories.splice(c,1)}function Ci(n,a,e,c){const o=re[n];if(!o)return;const t=o.students.find(r=>r.identity.studentId===a);if(!t||!t.logs.scores[e.toLowerCase()])return;const i=t.logs.scores[e.toLowerCase()],s=i.findIndex(r=>r.id===c);s>-1&&i.splice(s,1)}function wi(n,a,e){const c=re[n];if(!c)return;const o=c.students.find(i=>i.identity.studentId===a);if(!o||!o.profile.notes)return;const t=o.profile.notes.findIndex(i=>i.id===e);t>-1&&o.profile.notes.splice(t,1)}function Ei(){JSON.parse(JSON.stringify({classrooms:re,trashBin:pe})),lt=!0}function _i(){lt=!1,On()}function He(n){D=n}function sn(n){Ss=n}function qe(n){J=n}function Je(n){Se=n}function Rn(n){nn=n}function ki(n){Zn=n}function Zt(n){Is=n}function vn(n){xn=n}function Si(n){xs=n}function zn(n){Ve=n}function bn(n){Ln=n}function Ii(n){Ls=n}function Cn(n){Tn=n}function xi(n){Ts=n}function Os(n){Bs=n}function Ms(n){Ds=n}function an(n){Bn=n}function Rs(n){vt=n}function $n(n){Nn=n}function Li(n){li=n}function Ti(n){di=n}function zs(n){pe=n}function qn(n){Dn=n}function rn(n){xt=n}function Kt(n){Ge={...Ge,...n},ce()}function rs(n){ct=n}function $s(){Ge.lastBackupTimestamp=new Date().toISOString(),ce()}function Fn(n){An=n}const ba=Object.freeze(Object.defineProperty({__proto__:null,get activeModal(){return vt},get cancelCallback(){return Ds},get classrooms(){return re},get confirmCallback(){return Bs},get currentClassroom(){return D},get datePickerCallback(){return An},get easterEggClickCount(){return Ln},get easterEggLastClickTime(){return Ls},enterDemoMode:Ei,exitDemoMode:_i,getActiveItems:Ie,getSessionDisplayMap:tt,get importedFileContent(){return xn},get isDemoMode(){return lt},get liveSession(){return Ss},loadData:On,get manualSelection(){return Nn},moveStudent:gi,get namesToImport(){return Is},get notificationTimeout(){return xs},permanentlyDeleteCategory:bi,permanentlyDeleteNote:wi,permanentlyDeleteScore:Ci,permanentlyDeleteSession:vi,permanentlyDeleteStudent:Mn,prepareBackupData:ui,get previousState(){return nn},processRestore:mi,rehydrateData:Lt,renameCategory:pi,renameClassroom:hi,resetAllStudentCounters:yi,get resetEasterEggClickCount(){return Tn},get resetEasterEggLastClickTime(){return Ts},get saveCategoryCallback(){return Dn},saveData:ce,get saveNoteCallback(){return Ns},get secureConfirmCallback(){return Bn},get selectedCategory(){return Ve},get selectedClassIds(){return ct},get selectedSession(){return J},get selectedStudentForProfile(){return Se},get selectedStudentsForMassComment(){return xt},setActiveModal:Rs,setCancelCallback:Ms,setConfirmCallback:Os,setCurrentClassroom:He,setDatePickerCallback:Fn,setEasterEggClickCount:bn,setEasterEggLastClickTime:Ii,setImportedFileContent:vn,setLastBackupTimestamp:$s,setLiveSession:sn,setManualSelection:$n,setNamesToImport:Zt,setNotificationTimeout:Si,setPreviousState:Rn,setResetEasterEggClickCount:Cn,setResetEasterEggLastClickTime:xi,setSaveCategoryCallback:qn,setSaveNoteCallback:rt,setSecureConfirmCallback:an,setSelectedCategory:zn,setSelectedClassIds:rs,setSelectedSession:qe,setSelectedStudentForProfile:Je,setSelectedStudentsForMassComment:rn,setSourceClassForMove:Ti,setStudentToMove:Li,setTrashBin:zs,setUndoTimeout:ki,setUserSettings:Kt,setWinnerHistoryIndex:bt,get sourceClassForMove(){return di},get studentToMove(){return li},get trashBin(){return pe},get undoTimeout(){return Zn},get userSettings(){return Ge},get winnerHistoryIndex(){return Ze}},Symbol.toStringTag,{value:"Module"})),Ca="TeacherAssistantDB",wa=1,gt="backups";function Bi(){return new Promise((n,a)=>{const e=indexedDB.open(Ca,wa);e.onupgradeneeded=c=>{const o=c.target.result;o.objectStoreNames.contains(gt)||o.createObjectStore(gt,{keyPath:"id"})},e.onsuccess=c=>n(c.target.result),e.onerror=c=>a(c.target.error)})}async function Ea(n,a){const e=await Bi(),c=e.transaction(gt,"readwrite"),o=c.objectStore(gt),t={id:Date.now(),file:n,metadata:a,timestamp:new Date().toISOString()};o.add(t),c.oncomplete=()=>{const s=e.transaction(gt,"readwrite").objectStore(gt),r=s.count();r.onsuccess=()=>{if(r.result>10){const d=s.getAllKeys();d.onsuccess=()=>{const m=d.result;for(;m.length>10;){const g=m.shift();s.delete(g),console.log(`♻️ Auto-deleted old backup snapshot: ${g}`)}}}}}}async function _a(){const n=await Bi();return new Promise((a,e)=>{const t=n.transaction(gt,"readonly").objectStore(gt).getAll();t.onsuccess=()=>{const i=t.result.sort((s,r)=>r.id-s.id);a(i)},t.onerror=()=>e(t.error)})}function et(n){return typeof n!="string"?"":n.replace(/ي/g,"ی").replace(/ك/g,"ک").replace(/[\s\u200c]/g,"")}function Fs(n){return typeof n!="string"||n.length===0?"ltr":/[\u0590-\u07FF]/.test(n)?"rtl":"ltr"}function Di(n){return!n||!n.trim()?"":n.split(`
`).map(c=>`<div dir="${Fs(c)}">${c||"&nbsp;"}</div>`).join("")}function ss(n){if(typeof n!="string")return"";const a={q:"ض",w:"ص",e:"ث",r:"ق",t:"ف",y:"غ",u:"ع",i:"ه",o:"خ",p:"ح","[":"ج","]":"چ",a:"ش",s:"س",d:"ی",f:"ب",g:"ل",h:"ا",j:"ت",k:"ن",l:"م",";":"ک","'":"گ",z:"ظ",x:"ط",c:"ز",v:"ر",b:"ذ",n:"د",m:"پ",",":"و"};let e="";for(let c=0;c<n.length;c++){const o=n[c].toLowerCase();e+=a[o]||n[c]}return e}function os(n){if(!n||typeof n!="string")return{name:"",firstName:null,lastName:null};const a=n.indexOf(".");if(a>0&&a<n.length-1){const e=n.substring(0,a).trim(),c=n.substring(a+1).trim();return{name:`${e} ${c}`,firstName:e,lastName:c}}return{name:n.trim(),firstName:null,lastName:null}}const Ni="teacherAssistantLogs_v2",ka=100;function Ps(){try{const n=localStorage.getItem(Ni);return n?JSON.parse(n):{}}catch(n){return console.error("Error reading logs from localStorage:",n),{}}}function Ai(n){try{localStorage.setItem(Ni,JSON.stringify(n))}catch(a){console.error("Error saving logs to localStorage:",a)}}function ke(n,a,e=null){if(!n)return;const c=Ps();c[n]||(c[n]=[]);const o={timestamp:new Date().toISOString(),message:a,action:e,classroomName:n};c[n].unshift(o),c[n].length>ka&&c[n].pop(),Ai(c)}function Sa(n){return Ps()[n]||[]}function Ia(n,a){const e=Ps();e[n]&&!e[a]&&(e[a]=e[n],delete e[n],Ai(e))}var ni={toJalaali:xa,toGregorian:Oi,isValidJalaaliDate:La,isLeapJalaaliYear:Mi,jalaaliMonthLength:Ri,jalCal:Hs,j2d:Pn,d2j:Hn,g2d:Gn,d2g:Ws,jalaaliToDateObject:zi,jalaaliWeek:Ba},yt=[-61,9,38,199,426,686,756,818,1111,1181,1210,1635,2060,2097,2192,2262,2324,2394,2456,3178];function xa(n,a,e){return Object.prototype.toString.call(n)==="[object Date]"&&(e=n.getDate(),a=n.getMonth()+1,n=n.getFullYear()),Hn(Gn(n,a,e))}function Oi(n,a,e){return Ws(Pn(n,a,e))}function La(n,a,e){return n>=-61&&n<=3177&&a>=1&&a<=12&&e>=1&&e<=Ri(n,a)}function Mi(n){return Ta(n)===0}function Ri(n,a){return a<=6?31:a<=11||Mi(n)?30:29}function Ta(n){var a=yt.length,e=yt[0],c,o,t,i,s;if(n<e||n>=yt[a-1])throw new Error("Invalid Jalaali year "+n);for(s=1;s<a&&(c=yt[s],o=c-e,!(n<c));s+=1)e=c;return i=n-e,o-i<6&&(i=i-o+Ne(o+4,33)*33),t=Ke(Ke(i+1,33)-1,4),t===-1&&(t=4),t}function Hs(n,a){var e=yt.length,c=n+621,o=-14,t=yt[0],i,s,r,d,m,g,h;if(n<t||n>=yt[e-1])throw new Error("Invalid Jalaali year "+n);for(h=1;h<e&&(i=yt[h],s=i-t,!(n<i));h+=1)o=o+Ne(s,33)*8+Ne(Ke(s,33),4),t=i;return g=n-t,o=o+Ne(g,33)*8+Ne(Ke(g,33)+3,4),Ke(s,33)===4&&s-g===4&&(o+=1),d=Ne(c,4)-Ne((Ne(c,100)+1)*3,4)-150,m=20+o-d,a?{gy:c,march:m}:(s-g<6&&(g=g-s+Ne(s+4,33)*33),r=Ke(Ke(g+1,33)-1,4),r===-1&&(r=4),{leap:r,gy:c,march:m})}function Pn(n,a,e){var c=Hs(n,!0);return Gn(c.gy,3,c.march)+(a-1)*31-Ne(a,7)*(a-7)+e-1}function Hn(n){var a=Ws(n).gy,e=a-621,c=Hs(e,!1),o=Gn(a,3,c.march),t,i,s;if(s=n-o,s>=0){if(s<=185)return i=1+Ne(s,31),t=Ke(s,31)+1,{jy:e,jm:i,jd:t};s-=186}else e-=1,s+=179,c.leap===1&&(s+=1);return i=7+Ne(s,30),t=Ke(s,30)+1,{jy:e,jm:i,jd:t}}function Gn(n,a,e){var c=Ne((n+Ne(a-8,6)+100100)*1461,4)+Ne(153*Ke(a+9,12)+2,5)+e-34840408;return c=c-Ne(Ne(n+100100+Ne(a-8,6),100)*3,4)+752,c}function Ws(n){var a,e,c,o,t;return a=4*n+139361631,a=a+Ne(Ne(4*n+183187720,146097)*3,4)*4-3908,e=Ne(Ke(a,1461),4)*5+308,c=Ne(Ke(e,153),5)+1,o=Ke(Ne(e,153),12)+1,t=Ne(a,1461)-100100+Ne(8-o,6),{gy:t,gm:o,gd:c}}function Ba(n,a,e){var c=zi(n,a,e).getDay(),o=c==6?0:-(c+1),t=6+o;return{saturday:Hn(Pn(n,a,e+o)),friday:Hn(Pn(n,a,e+t))}}function zi(n,a,e,c,o,t,i){var s=Oi(n,a,e);return new Date(s.gy,s.gm-1,s.gd,c||0,o||0,t||0,i||0)}function Ne(n,a){return~~(n/a)}function Ke(n,a){return n-~~(n/a)*a}const $i=document.getElementById("class-management-page"),Da=document.getElementById("new-class-name"),Na=document.getElementById("add-class-btn"),Mt=document.getElementById("class-list"),Wn=document.getElementById("undo-toast"),Fi=document.getElementById("undo-message"),Aa=document.getElementById("undo-btn"),Oa=document.getElementById("settings-page"),Us=document.getElementById("settings-class-name-header"),cs=document.getElementById("settings-student-list"),ls=document.getElementById("category-list"),Ma=document.getElementById("back-to-sessions-btn"),Ra=document.getElementById("new-student-name"),za=document.getElementById("add-student-btn"),Pi=document.getElementById("paste-area"),$a=document.getElementById("process-paste-btn"),Fa=document.getElementById("csv-preview-page"),ds=document.getElementById("csv-preview-list"),Pa=document.getElementById("csv-confirm-btn"),Ha=document.getElementById("csv-cancel-btn"),Wa=document.getElementById("import-csv-btn"),Ua=document.getElementById("csv-file-input"),ja=document.getElementById("column-mapping-page"),us=document.getElementById("column-select-dropdown"),Za=document.getElementById("confirm-column-btn"),qa=document.getElementById("cancel-import-btn"),Ga=document.getElementById("new-category-name"),Va=document.getElementById("add-category-btn"),fs=document.querySelector(".app-header"),it=document.getElementById("select-student-btn"),$t=document.getElementById("select-student-btn-wrapper"),Ja=document.getElementById("attendance-page"),Yt=document.getElementById("attendance-list"),Ka=document.getElementById("finish-attendance-btn"),Ya=document.querySelector("#class-management-page h2"),ms=document.getElementById("student-stats-header"),Xa=document.getElementById("hamburger-menu-btn"),Qa=document.getElementById("side-nav-menu"),er=document.getElementById("close-nav-btn"),tr=document.getElementById("overlay"),nr=document.getElementById("backup-data-btn"),sr=document.getElementById("restore-data-btn"),Hi=document.getElementById("restore-file-input"),ir=document.getElementById("custom-confirm-modal"),Wi=document.getElementById("confirm-modal-message"),hs=document.getElementById("confirm-modal-cancel-btn"),qt=document.getElementById("confirm-modal-confirm-btn"),ar=document.getElementById("secure-confirm-modal"),Ui=document.getElementById("secure-confirm-message"),ji=document.getElementById("secure-confirm-code"),Nt=document.getElementById("secure-confirm-input"),rr=document.getElementById("secure-confirm-cancel-btn"),wn=document.getElementById("secure-confirm-confirm-btn"),or=document.getElementById("add-note-modal"),_e=document.getElementById("new-note-content"),cr=document.getElementById("class-save-note-btn"),lr=document.getElementById("cancel-note-btn"),ps=document.getElementById("student-search-input"),pt=document.getElementById("student-search-results"),dr=document.getElementById("back-to-student-page-btn"),ur=document.getElementById("graded-category-pills-container"),fr=document.getElementById("new-score-value"),Zi=document.getElementById("new-score-comment"),mr=document.getElementById("add-score-btn"),hr=document.getElementById("profile-stats-summary"),pr=document.getElementById("profile-scores-list"),Gt=document.getElementById("global-student-search-input"),ot=document.getElementById("global-student-search-results"),gr=document.getElementById("is-graded-checkbox"),yr=document.getElementById("trashed-classes-list"),vr=document.getElementById("trashed-students-list"),br=document.getElementById("trashed-sessions-list"),Cr=document.getElementById("trashed-categories-list"),wr=document.getElementById("trashed-notes-list"),Er=document.getElementById("trashed-scores-list"),Ot=document.getElementById("quick-grade-form-wrapper"),dt=document.getElementById("quick-score-input"),st=document.getElementById("quick-note-textarea"),St=document.getElementById("quick-grade-submit-btn"),Xt=document.getElementById("category-selection-container"),gs=document.getElementById("selected-student-result"),It=document.getElementById("custom-context-menu"),At=document.getElementById("breadcrumb-container");let jt=null,Rt=null;const _r=document.getElementById("category-modal"),qi=document.getElementById("category-modal-title"),Qt=document.getElementById("new-category-modal-name"),js=document.getElementById("new-category-modal-is-graded"),kr=document.getElementById("category-modal-cancel-btn"),Gi=document.getElementById("category-modal-save-btn"),Sr=document.getElementById("mass-comment-modal"),Ir=document.getElementById("mass-comment-modal-title"),Vi=document.getElementById("mass-comment-student-count-message"),en=document.getElementById("mass-comment-content"),Zs=document.getElementById("mass-comment-append-checkbox"),xr=document.getElementById("mass-comment-cancel-btn"),Lr=document.getElementById("mass-comment-save-btn"),ys=document.getElementById("mass-comment-btn"),En=document.getElementById("attendance-mass-actions-container"),_t=document.createElement("input"),Tr=document.getElementById("session-dashboard-page"),Ft=document.getElementById("attendance-pane");function Vt(n,a){let e;const o=i=>{e=setTimeout(()=>{navigator.vibrate&&navigator.vibrate(50),a(i)},800)},t=()=>{clearTimeout(e)};n.addEventListener("touchstart",o,{passive:!0}),n.addEventListener("touchend",t),n.addEventListener("touchmove",t),n.addEventListener("mousedown",o),n.addEventListener("mouseup",t),n.addEventListener("mouseleave",t)}function Pt(n="selector"){if(!D||!J){ge("class-management-page");return}Or(),kn(),ze(),at(),ge("session-dashboard-page",{tab:n}),Ji(),on(n),Mr()}function on(n){const a=document.getElementById("selector-tab-btn"),e=document.getElementById("attendance-tab-btn"),c=document.getElementById("selector-pane"),o=n==="selector";a.classList.toggle("active",o),e.classList.toggle("active",!o),c.classList.toggle("active",o),Ft.classList.toggle("active",!o)}function Ji(){const n=document.getElementById("selector-tab-btn"),a=document.getElementById("attendance-tab-btn"),e=document.getElementById("selector-pane");n.addEventListener("click",()=>{ze(),Re(),n.classList.add("active"),a.classList.remove("active"),e.classList.add("active"),Ft.classList.remove("active"),ge("session-dashboard-page",{tab:"selector"})}),a.addEventListener("click",()=>{at(),a.classList.add("active"),n.classList.remove("active"),Ft.classList.add("active"),e.classList.remove("active"),ge("session-dashboard-page",{tab:"attendance"})})}function Br(n){clearTimeout(Zn),nn||Rn(JSON.stringify(re)),Fi.textContent=n,Wn.classList.add("show"),ki(setTimeout(()=>{Wn.classList.remove("show"),Rn(null)},5e3))}function Ki(){if(nn){const n=D?D.info.name:null,a=JSON.parse(nn);Lt(a),n&&re[n]?He(re[n]):He(null),D?(ut(),Ht(),We()):Ue(),Wn.classList.remove("show"),clearTimeout(Zn),Rn(null)}}function Y(n,a=3e3){const e=document.getElementById("notification-toast");e&&(e.textContent=n,e.classList.add("show"),clearTimeout(xs),Si(setTimeout(()=>{e.classList.remove("show")},a)))}function Un(n){var b;const a=document.getElementById("restore-confirm-modal"),e=document.getElementById("restore-modal-message"),c=document.getElementById("restore-append-checkbox"),o=document.querySelector('label[for="restore-append-checkbox"]'),t=document.getElementById("restore-confirm-cancel-btn"),i=document.getElementById("restore-confirm-confirm-btn"),s=document.getElementById("restore-modal-warning");s.style.display="none";const r=((b=n.metadata)==null?void 0:b.createdAt)||0;if(Ge.lastRestoreTimestamp&&r<Ge.lastRestoreTimestamp){const y=new Date(r).toLocaleDateString("fa-IR"),C=new Date(Ge.lastRestoreTimestamp).toLocaleDateString("fa-IR");s.textContent=`⚠️ هشدار: این فایل پشتیبان (${y}) قدیمی‌تر از آخرین بازیابی شما (${C}) است.`,s.style.display="block"}const d=n.data.classrooms||{},m=Object.values(d).map(y=>y.info.name),g=m.length,h="کلاس",f=m.map(y=>`<li style="margin-bottom: 4px;">🔹 ${y}</li>`).join("");e.innerHTML=`
        <div style="margin-bottom: 10px;">
            فایل پشتیبان شامل <strong>${g} ${h}</strong> زیر است:
        </div>
        <ul style="
            margin: 0; 
            padding: 10px; 
            background-color: #f8f9fa; 
            border-radius: 5px; 
            border: 1px solid #e9ecef;
            list-style: none; 
            max-height: 150px; 
            overflow-y: auto;
            text-align: right;
        ">
            ${f}
        </ul>
        <div style="margin-top: 15px;">
            لطفاً نحوه بازیابی را مشخص کنید.
        </div>
    `,c.checked=!1,o&&(o.textContent="جایگزینی کامل (حذف داده‌های فعلی)");const v=()=>{const y=c.checked;mi(n,y),i.onclick=null,t.onclick=null,a.removeEventListener("click",v),we(),Ue(),ge("class-management-page"),Y(`✅ اطلاعات با موفقیت بازیابی شد (${y?"پاک‌سازی و بازیابی":"همگام‌سازی هوشمند"}).`)},u=()=>{i.onclick=null,t.onclick=null,we()};i.onclick=v,t.onclick=u,Fe("restore-confirm-modal")}function Ee(n,a,e={}){const{confirmText:c="تایید",cancelText:o="لغو",confirmClass:t="btn-success",onCancel:i=()=>{},isDelete:s=!1}=e,r=s?()=>Yi(n,a):a;Wi.textContent=n,qt.textContent=c,hs.textContent=o,qt.className="modal-action-btn",qt.classList.add(t),Os(r),Ms(i);const d=qt.parentElement;hs.style.display=i===null?"none":"inline-block",d.style.justifyContent=i===null?"center":"space-between",Fe("custom-confirm-modal")}function Yi(n,a){const e=Math.floor(1e4+Math.random()*9e4).toString();Ui.textContent=n,ji.textContent=e,Nt.value="",wn.disabled=!0,an(a),Fe("secure-confirm-modal"),Nt.focus();const c=()=>{Nt.value===e?wn.disabled=!1:wn.disabled=!0};return Nt.addEventListener("input",c),()=>{Nt.removeEventListener("input",c)}}function vs(n,a={}){const{title:e="ایجاد دسته‌بندی جدید",initialName:c="",initialIsGraded:o=!1,saveButtonText:t="ذخیره"}=a;qi.textContent=e,Qt.value=c,js.checked=o,Gi.textContent=t,qn((i,s)=>{if(!i){Y("⚠️ لطفاً نام دسته‌بندی را وارد کنید.");return}n(i,s),we()}),Fe("category-modal"),Qt.focus(),c&&Qt.select()}function qs(n,a){const e=Object.values(re).filter(i=>!i.isDeleted&&i.info.name!==a.info.name),c=document.getElementById("move-student-modal-title"),o=document.getElementById("move-student-class-select"),t=document.getElementById("move-student-confirm-btn");c.textContent=`انتقال دانش‌آموز: ${n.identity.name}`,o.innerHTML="",e.length===0?(o.innerHTML='<option value="">کلاس دیگری برای انتقال وجود ندارد</option>',t.disabled=!0):(e.forEach(i=>{const s=document.createElement("option");s.value=i.info.name,s.textContent=i.info.name,o.appendChild(s)}),t.disabled=!1),Li(n),Ti(a),Fe("move-student-modal")}function Gs(n,a){if(!n||!a)return;const e=n.identity.name,c=document.getElementById("add-note-modal-title");c.textContent="تغییر نام دانش‌آموز";const o=n.identity.firstName&&n.identity.lastName?`${n.identity.firstName} . ${n.identity.lastName}`:e;_e.value=o,_e.rows=1,_e.dispatchEvent(new Event("input",{bubbles:!0})),rt(t=>{const i=os(t),s=i.name;if(n.identity.firstName&&n.identity.lastName&&!i.firstName)return Y("⚠️ این دانش‌آموز دارای نام و نام‌خانوادگی تفکیک شده است. لطفاً حتماً از نقطه (.) بین نام و نام‌خانوادگی استفاده کنید."),!1;const r=!n.identity.firstName&&i.firstName;if(s&&(s!==e||r)){if(Ie(a.students).some(g=>g.identity.studentId!==n.identity.studentId&&g.identity.name.toLowerCase()===s.toLowerCase()))return Y("دانش‌آموزی با این نام از قبل در این کلاس وجود دارد."),!1;n.identity.name=s,n.identity.firstName=i.firstName,n.identity.lastName=i.lastName,ke(a.info.name,`نام دانش‌آموز «${e}» به «${s}» تغییر یافت.`,{type:"VIEW_STUDENT_PROFILE",studentId:n.identity.studentId}),ce(),ut(),ze(),at(),Re(),Se&&Se.identity.studentId===n.identity.studentId&&$e(n),Y(`✅ نام دانش‌آموز به «${s}» تغییر یافت.`)}else if(!s)return Y("⚠️ نام نمی‌تواند خالی باشد."),!1;const d=document.getElementById("add-note-modal-title");d.textContent="ثبت یادداشت جدید",_e.rows=4}),Fe("add-note-modal"),_e.focus(),_e.select()}function Fe(n){const a=document.getElementById(n);if(a){if(vt)return;document.body.classList.add("modal-active"),a.classList.add("modal-visible"),Rs(n),history.pushState(null,"",location.href)}}function we(n,a=!1){if(!vt)return;const e=document.getElementById(vt),c=vt;Rs(null),c==="student-profile-modal"&&Je(null),a||history.back(),e&&(e.classList.add("modal-closing"),setTimeout(()=>{e.classList.remove("modal-visible"),e.classList.remove("modal-closing"),document.body.classList.remove("modal-active"),c==="custom-confirm-modal"&&(Os(null),Ms(null)),c==="secure-confirm-modal"&&an(null),c==="category-modal"&&qn(null),c==="mass-comment-modal"&&(en.value=""),c==="add-note-modal"&&rt(null),typeof n=="function"&&n()},300))}function Vs(){if(!Ft||!Ft.classList.contains("active")){En.style.display="none";return}const n=xt.length;n<1?En.style.display="none":En.style.display="block",ys.disabled=n<1,ys.textContent=`📝 ثبت یادداشت گروهی (${n} نفر)`}function Js(){const n=xt,a=n.length;let e=!1;a>0&&(e=n.some(o=>{var t;return(t=J.studentRecords[o])==null?void 0:t.homework.comment})),Vi.textContent=`یادداشت برای ${a} دانش‌آموز ثبت خواهد شد.`,en.value="",en.dispatchEvent(new Event("input",{bubbles:!0})),Zs.checked=!0;const c=document.querySelector("#mass-comment-modal .modal-options");c.style.display=e?"flex":"none",Fe("mass-comment-modal"),en.focus()}function bs(n,a){if(!D||!J)return;let e=0;const c=xt,o=J;c.forEach(t=>{const i=o.studentRecords[t];if(i&&i.homework){const s=i.homework.comment||"";let r=n;a&&s.length>0?r=s+`
---
`+n:r=n,i.homework.comment=r.trim();const d=D.students.find(m=>m.identity.studentId===t);d&&Dr(d,o,r.trim()),e++}}),rn([]),ce(),at(),ke(D.info.name,`${e} دانش‌آموز به صورت گروهی یادداشت تکلیف گرفتند.`,{type:"VIEW_SESSIONS"}),Y(`✅ یادداشت برای ${e} دانش‌آموز ثبت شد.`)}function Dr(n,a,e){const o=tt(D).get(a.sessionNumber),t={type:"fromAttendance",sessionNumber:a.sessionNumber},i=`یادداشت جلسه ${o}:
`,s=n.profile.notes.find(r=>!r.isDeleted&&r.source&&r.source.type==="fromAttendance"&&r.source.sessionNumber===t.sessionNumber);s?e?(s.content=i+e,s.isDeleted=!1):s.isDeleted=!0:e&&n.addNote(i+e,t)}function Vn(n){_e.value=n.note||"",rt(a=>{n.note=a,ce(),ke(n.info.name,"یادداشت کلاس ذخیره شد.",{type:"VIEW_CLASS_NOTE"}),Ue(),Y("✅ یادداشت کلاس ذخیره شد.")}),Fe("add-note-modal"),_e.focus()}function Ks(n,a){_e.value=n.note||"",_e.dispatchEvent(new Event("input",{bubbles:!0})),rt(e=>{n.note=e,ce(),ke(D.info.name,`یادداشت جلسه ${a} ذخیره شد.`,{type:"VIEW_SESSIONS"}),We(),Y("✅یادداشت جلسه ذخیره شد.")}),Fe("add-note-modal"),_e.focus()}function zt(n){He(n),Us.textContent=`تنظیمات کلاس: ${n.info.name}`,ut(),Ht(),aa(),ge("settings-page")}function Xi(n){const a=document.getElementById("log-modal-title"),e=document.getElementById("log-list");a.textContent=`گزارش فعالیت‌های کلاس: ${n}`,e.innerHTML="";const c=Sa(n);c.length===0?e.innerHTML='<li class="no-content-message">هنوز فعالیتی برای این کلاس ثبت نشده است.</li>':c.forEach(o=>{const t=document.createElement("li");t.className="log-entry";const i=new Date(o.timestamp),s=`${i.toLocaleDateString("fa-IR")} - ${i.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}`,r=document.createElement("span");r.className="log-timestamp",r.textContent=s;const d=document.createElement("span");d.className="log-message",d.textContent=o.message,o.action&&(d.classList.add("log-action-link"),d.dataset.action=JSON.stringify({...o.action,classroomName:o.classroomName})),t.appendChild(r),t.appendChild(d),e.appendChild(t)}),Fe("log-modal")}document.getElementById("log-modal-close-btn").addEventListener("click",()=>{we()});function Cs(n){const a=URL.createObjectURL(n),e=document.createElement("a");e.href=a,e.download=n.name,document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(a),setTimeout(()=>{Ee("آیا فایل پشتیبان با موفقیت ذخیره شد؟",()=>{$s(),Jn(),Y("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله، ذخیره شد",cancelText:"خیر",confirmClass:"btn-success"})},500)}async function cn(n=[]){const a=await ui(n);if(!a){Y("❌ خطا در ایجاد فایل پشتیبان.");return}let e="پشتیبان کامل سیستم";if(n.length>0){const o=n.join("، ");e=`${n.length===1?"پشتیبان کلاس:":"پشتیبان کلاس‌های:"} ${o}`}Ea(a,{name:a.name,description:e,version:"2.0-b64"}).catch(o=>console.error("Failed to save local snapshot:",o)),("ontouchstart"in window||navigator.maxTouchPoints>0)&&navigator.share&&navigator.canShare&&navigator.canShare({files:[a]})?Ee("فایل پشتیبان شما آماده است. آیا مایل به اشتراک‌گذاری آن هستید؟",()=>{try{navigator.share({title:a.name,text:"فایل پشتیبان داده‌های برنامه",files:[a]}).then(()=>{Ee("آیا فایل پشتیبان با موفقیت ارسال/ذخیره شد؟",()=>{$s(),Jn(),Y("✅ تاریخ پشتیبان ثبت شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}catch(o){console.error("Error during sharing process:",o),Cs(a),Y("⚠️خطا در فرآیند اشتراک‌گذاری. فایل در حال دانلود است.")}},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"}):(Cs(a),Y("✅پشتیبان‌گیری با موفقیت انجام شد."))}function dn(n,a){n.preventDefault(),kt(),Rt=n.target.closest("li"),Rt&&Rt.classList.add("context-menu-target"),setTimeout(()=>{const e=It,c=e.querySelector("ul");c.innerHTML="",a.forEach(d=>{const m=document.createElement("li");d.isSeparator?m.className="separator":(m.innerHTML=`
                    <span class="icon">${d.icon||""}</span>
                    <span class="label">${d.label}</span>
                `,d.className&&m.classList.add(d.className),m.addEventListener("click",()=>{d.action(),kt()})),c.appendChild(m)}),e.classList.add("visible");const{offsetWidth:o,offsetHeight:t}=e,{innerHeight:i}=window,s=document.body.getBoundingClientRect();e.style.top=`${(i-t)/2}px`;const r=s.left+s.width/2;e.style.left=`${r-o/2}px`},50)}function kt(){It.classList.contains("visible")&&It.classList.remove("visible"),Rt&&(Rt.classList.remove("context-menu-target"),Rt=null)}function Qi(){var e;At.innerHTML="";const n=document.getElementById("header-settings-btn");if(!n)return;const a=[];if(a.push({label:"کلاس‌ها",handler:()=>{He(null),qe(null),Je(null),ge("class-management-page")}}),D){a.push({label:D.info.name,handler:()=>{qe(null),Je(null),We(),ge("session-page")}});const c=(e=document.querySelector(".page.active"))==null?void 0:e.id;if(c==="session-page"?n.style.visibility="visible":n.style.visibility="hidden",c==="settings-page")a.push({label:"تنظیمات"});else if(J){const t=tt(D).get(J.sessionNumber)||` (#${J.sessionNumber})`;a.push({label:`جلسه ${t}`,handler:()=>{Je(null),Pt("selector")}}),Se?a.push({label:`پروفایل: ${Se.identity.name}`}):c==="session-dashboard-page"&&(document.getElementById("attendance-tab-btn").classList.contains("active")?a.push({label:"حضور و غیاب"}):a.push({label:"انتخابگر"}))}}else n.style.visibility="hidden";if(a.length<=1){At.style.display="none";return}At.style.display="flex",a.forEach((c,o)=>{const t=document.createElement("a");if(t.textContent=c.label,t.className="breadcrumb-item",o===a.length-1||!c.handler?t.classList.add("active"):t.addEventListener("click",c.handler),At.appendChild(t),o<a.length-1){const i=document.createElement("span");i.className="breadcrumb-separator",i.textContent="/",At.appendChild(i)}})}function si(n,a,e){e.innerHTML="";const c=D.sessions.filter(o=>{var t;return!o.isDeleted&&!o.isCancelled&&((t=o.studentRecords[n.identity.studentId])==null?void 0:t.attendance)==="absent"}).map(o=>({number:a.get(o.sessionNumber),isMakeup:o.isMakeup})).filter(o=>o.number!==void 0);c.length>0?(e.appendChild(document.createTextNode("جلسات غایب: ")),c.forEach((o,t)=>{const i=document.createElement("span");i.textContent=o.number,o.isMakeup&&i.classList.add("makeup-absence"),e.appendChild(i),t<c.length-1&&e.appendChild(document.createTextNode("، "))})):e.textContent="جلسات غایب: بدون غیبت"}function _n(n,a,e,c={}){const{includePrefix:o=!0}=c;e.innerHTML="";const t=D.sessions.filter(i=>{if(i.isDeleted||i.isCancelled)return!1;const s=i.studentRecords[n.identity.studentId];return s&&s.homework&&(s.homework.status==="incomplete"||s.homework.status==="none")}).map(i=>({number:a.get(i.sessionNumber),status:i.studentRecords[n.identity.studentId].homework.status})).filter(i=>i.number!==void 0);t.length>0?(o&&e.appendChild(document.createTextNode("تکالیف ناقص: ")),t.forEach((i,s)=>{const r=document.createElement("span");r.textContent=i.number,i.status==="incomplete"&&r.classList.add("incomplete-homework"),e.appendChild(r),s<t.length-1&&e.appendChild(document.createTextNode("،"))})):o?e.textContent="تکالیف ناقص: ندارد":e.textContent="ندارد"}function Nr(n,a){var L,N,R;const e=document.createElement("li");e.className="attendance-list-item";const c=document.createElement("span");c.className="absence-info";const o=document.createElement("span");o.className="homework-info";const t=document.createElement("div");t.className="att-row-1";let i=!1;t.addEventListener("mousedown",()=>i=!1),t.addEventListener("touchstart",()=>i=!1,{passive:!0});const s=document.createElement("input");s.type="checkbox",s.className="mass-comment-checkbox",s.checked=xt.includes(n.identity.studentId),s.addEventListener("change",()=>{const P=n.identity.studentId,Q=xt;if(s.checked)Q.includes(P)||Q.push(P);else{const z=Q.indexOf(P);z>-1&&Q.splice(z,1)}Vs();const k=document.getElementById("attendance-list");Q.length===0&&k.classList.contains("selection-mode-active")&&k.classList.remove("selection-mode-active")});const r=document.createElement("span");r.className="student-name",r.textContent=n.identity.name,r.addEventListener("click",P=>{if(i){P.stopPropagation(),P.preventDefault(),i=!1;return}$e(n)}),Vt(t,P=>{i=!0;const Q=document.getElementById("attendance-list");Q.classList.contains("selection-mode-active")||Q.classList.add("selection-mode-active"),s.checked||(s.checked=!0,s.dispatchEvent(new Event("change")))}),t.appendChild(s),t.appendChild(r);const d=document.createElement("div");d.className="att-row-2";const m=document.createElement("button");let g=!1;m.addEventListener("mousedown",()=>g=!1),m.addEventListener("touchstart",()=>g=!1,{passive:!0});const h=((L=J.studentRecords[n.identity.studentId])==null?void 0:L.attendance)||"present",f=P=>{P==="present"?(m.textContent="حاضر",m.className="attendance-status-btn present active"):(m.textContent="غایب",m.className="attendance-status-btn absent active")};f(h),m.addEventListener("click",P=>{var z;if(g){P.stopPropagation();return}const k=(((z=J.studentRecords[n.identity.studentId])==null?void 0:z.attendance)||"present")==="present"?"absent":"present";J.setAttendance(n.identity.studentId,k),k==="absent"&&(J.studentRecords[n.identity.studentId].hadIssue=!1),ce(),f(k),si(n,a,c),ze(),ra()}),Vt(m,()=>{g=!0;const P=h==="present"?"absent":"present",Q=P==="present"?"حاضر":"غایب";Ee(`آیا مطمئن هستید که می‌خواهید وضعیت حضور تمام دانش‌آموزان را به «${Q}» تغییر دهید؟`,()=>{Ie(D.students).forEach(k=>{J.setAttendance(k.identity.studentId,P),P==="absent"&&(J.studentRecords[k.identity.studentId].hadIssue=!1)}),ce(),at(),Y(`✅ وضعیت تمام دانش‌آموزان به «${Q}» تغییر یافت.`)},{confirmText:"بله، اعمال کن",confirmClass:"btn-warning"})});const v=document.createElement("div");v.className="homework-controls";const u={none:"بدون تکلیف",complete:"تکلیف کامل",incomplete:"تکلیف ناقص"},b=document.createElement("button");let y=!1;b.addEventListener("mousedown",()=>y=!1),b.addEventListener("touchstart",()=>y=!1,{passive:!0});const C=((N=J.studentRecords[n.identity.studentId])==null?void 0:N.homework.status)||"none";b.className=`homework-status-btn ${C}`,b.title=u[C],b.addEventListener("click",P=>{if(y){P.stopPropagation();return}const Q=J.studentRecords[n.identity.studentId].homework,z={none:"incomplete",incomplete:"complete",complete:"none"}[Q.status];J.setHomeworkStatus(n.identity.studentId,z),ce(),b.className=`homework-status-btn ${z}`,b.title=u[z],_n(n,a,o)}),Vt(b,()=>{y=!0;const Q={none:"incomplete",incomplete:"complete",complete:"none"}[C],k=u[Q];Ee(`آیا از تغییر وضعیت تکلیف تمام دانش‌آموزان به «${k}» مطمئن هستید؟`,()=>{Ie(D.students).forEach(z=>{J.setHomeworkStatus(z.identity.studentId,Q)}),ce(),at(),Y(`✅ وضعیت تکلیف همه به «${k}» تغییر یافت.`)},{confirmText:"بله",confirmClass:"btn-warning"})});const _=document.createElement("button");let S=!1;_.addEventListener("mousedown",()=>S=!1),_.addEventListener("touchstart",()=>S=!1,{passive:!0}),_.className="btn-icon",_.innerHTML="📝",_.title="افزودن یادداشت برای تکلیف",((R=J.studentRecords[n.identity.studentId])==null?void 0:R.homework.comment)||(_.style.opacity="0.3"),_.addEventListener("click",P=>{if(S){P.stopPropagation();return}const Q=J.studentRecords[n.identity.studentId].homework;_e.value=Q.comment||"",_e.dispatchEvent(new Event("input",{bubbles:!0})),rt(k=>{Q.comment=k;const z=tt(D),p=z.get(J.sessionNumber),H={type:"fromAttendance",sessionNumber:J.sessionNumber},ue=`یادداشت جلسه ${p}:
`,j=n.profile.notes.find(fe=>!fe.isDeleted&&fe.source&&fe.source.type==="fromAttendance"&&fe.source.sessionNumber===H.sessionNumber);j?k?j.content=ue+k:j.isDeleted=!0:k&&n.addNote(ue+k,H),ce(),Y("✅یادداشت تکلیف ذخیره شد."),_.style.opacity=k?"1":"0.3",_n(n,z,o)}),Fe("add-note-modal"),_e.focus()}),Vt(_,()=>{S=!0,Ee("آیا می‌خواهید برای **تمام** دانش‌آموزان کلاس یادداشت تکلیف ثبت کنید؟",()=>{const P=Ie(D.students).map(Q=>Q.identity.studentId);rn(P),Js()},{confirmText:"بله",confirmClass:"btn-primary"})}),d.appendChild(m),v.appendChild(_),v.appendChild(b),d.appendChild(v);const x=document.createElement("div");return x.className="att-row-3",si(n,a,c),_n(n,a,o),x.appendChild(c),x.appendChild(o),e.appendChild(t),e.appendChild(d),e.appendChild(x),e}function Ar(){return tt(D).get(J.sessionNumber)}function at(){if(!D||!J)return;Ie(D.students).forEach(o=>{J.initializeStudentRecord(o.identity.studentId)}),rn([]);const n=tt(D);jr(),Yt.innerHTML="";const a=document.createElement("li");a.className="attendance-list-header",_t.id="attendance-search-input",_t.type="text",_t.className="inline-search-input",_t.placeholder="جستجو...",_t.value="";const e=document.createElement("div");e.className="student-search-container",e.appendChild(_t);const c=document.createElement("div");c.className="header-labels-container",c.innerHTML=`
    <span class="header-label">تکلیف</span>
    <span class="header-label">حضور</span>
`,a.appendChild(e),a.appendChild(c),Yt.appendChild(a),Ie(D.students).forEach(o=>{const t=Nr(o,n);Yt.appendChild(t)}),rn([]),Vs(),Zr(),ra()}function ze(){const n=document.getElementById("student-stats-table-container");if(!n||(n.innerHTML="",!D))return;Ie(D.students).length,ms.textContent="آمار عملکرد";const a=["نام"],e=["کل انتخاب ها","غیبت","خروج","فرصت ازدست‌رفته","مشکل","میانگین","نمره کلاسی (کانون)"],c=D.categories.filter(f=>f.isGradedCategory&&!f.isDeleted).map(f=>f.name),o=[...a,...c,...e],t=document.createElement("table");t.className="student-stats-table";const s=t.createTHead().insertRow();o.forEach((f,v)=>{const u=document.createElement("th");v===0?(u.innerHTML=`${f} <span style="opacity: 0.6;">🔗</span>`,u.title="ردیف‌های این ستون قابل کلیک هستند"):u.textContent=f,s.appendChild(u)});const r=t.createTBody(),d=Ie(D.students),m=f=>{let v=0;return D.sessions.forEach(u=>{if(u.isDeleted||u.isCancelled)return;const b=u.studentRecords[f.identity.studentId];b&&b.attendance==="absent"&&v++}),v};d.forEach(f=>{const v=r.insertRow();if(v.dataset.studentId=f.identity.studentId,J){const S=J.studentRecords[f.identity.studentId];S&&S.attendance==="absent"&&v.classList.add("absent-row-highlight")}const u=v.insertCell(),b=document.createElement("span");b.textContent=f.identity.name,b.className="student-name-link",b.addEventListener("click",()=>{$e(f)}),u.appendChild(b),c.forEach(S=>{var N;const I=v.insertCell();I.style.direction="ltr";const x=S.toLowerCase(),L=((N=f.logs.scores[x])==null?void 0:N.filter(R=>!R.isDeleted))||[];L.length>0?L.forEach((R,P)=>{const Q=document.createElement("span");Q.textContent=R.value+(R.comment?"'":""),Q.style.position="relative",R.comment&&(Q.dataset.tooltip=R.comment),I.appendChild(Q),P<L.length-1&&I.appendChild(document.createTextNode(","))}):I.textContent="",I.style.cursor="pointer",I.addEventListener("click",()=>{Re(f,S);const R=document.getElementById("category-selection-container");R&&R.scrollIntoView({behavior:"smooth",block:"center"})})}),v.insertCell().textContent=f.statusCounters.totalSelections||0,v.insertCell().textContent=m(f),v.insertCell().textContent=f.statusCounters.outOfClassCount||0,v.insertCell().textContent=f.statusCounters.missedChances||0;const y=Object.values(f.categoryIssues||{}).reduce((S,I)=>S+I,0);v.insertCell().textContent=y;const C=f.getOverallAverageScore();v.insertCell().textContent=C!==null?C:"-";const _=D.calculateFinalStudentScore(f);v.insertCell().textContent=_!==null?_:"-"}),Ie(D.students),ms.setAttribute("data-student-count",d.length),n.appendChild(t);const g=n.querySelector(".student-stats-table"),h=g==null?void 0:g.querySelector("thead th:first-child");h&&h.addEventListener("click",()=>{g.classList.toggle("name-column-expanded")})}function Re(n=null,a=null){const e=document.getElementById("selected-student-result");e.innerHTML="",e.classList.remove("absent");let c,o;if(n&&a)c=n,o=a,$n({student:n,categoryName:a}),bt(-1);else{if($n(null),!J||Ze<0||!J.winnerHistory[Ze])return;const F=J.winnerHistory[Ze];c=F.winner,o=F.categoryName}const t=document.querySelector(".current-winner-highlight");if(t&&t.classList.remove("current-winner-highlight"),c){const F=document.querySelector(`.student-stats-table tr[data-student-id="${c.identity.studentId}"]`);F&&F.classList.add("current-winner-highlight")}const i=D.categories.find(F=>F.name===o);if(i){zn(i),Ys(i);const F=document.querySelectorAll("#category-selection-container .pill");F.forEach(O=>O.classList.remove("active"));const ne=Array.from(F).find(O=>O.textContent===o);ne&&ne.classList.add("active"),ws(i),Es(i.name)}const s=J.studentRecords[c.identity.studentId],r=(s==null?void 0:s.attendance)==="absent",d=document.createElement("div");d.className="winner-name-container";const m=document.createElement("button");m.className="btn-icon",m.innerHTML="˅",m.title="برنده قبلی";const g=!n;m.classList.toggle("is-disabled",!g||Ze<=0),m.addEventListener("click",()=>{m.classList.contains("is-disabled")?(m.classList.add("shake-animation"),setTimeout(()=>m.classList.remove("shake-animation"),200)):(bt(Ze-1),Re())});const h=document.createElement("div");h.className="winner-name",h.innerHTML=`✨ <strong>${c.identity.name}</strong>✨`,h.classList.add("heartbeat-animation"),r&&(h.style.textDecoration="line-through",h.style.opacity="0.6",h.style.color="var(--color-secondary)"),(s==null?void 0:s.hadIssue)&&!r&&(h.style.color="var(--color-warning)",h.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"),(s==null?void 0:s.wasOutOfClass)&&!r&&(h.style.color="var(--color-strong-warning)",h.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود");const u=1e3,b=F=>{jt=setTimeout(()=>{Kr(c,o),jt=null},u)},y=()=>{jt&&(clearTimeout(jt),jt=null)};h.addEventListener("mousedown",b),h.addEventListener("mouseup",y),h.addEventListener("mouseout",y),h.addEventListener("touchstart",b),h.addEventListener("touchmove",y),h.addEventListener("touchend",y),h.addEventListener("touchcancel",y);const C=document.createElement("button");if(C.className="btn-icon",C.innerHTML="˄",C.title="برنده بعدی",C.classList.toggle("is-disabled",!g||Ze>=J.winnerHistory.length-1),C.addEventListener("click",()=>{C.classList.contains("is-disabled")?(C.classList.add("shake-animation"),setTimeout(()=>C.classList.remove("shake-animation"),200)):(bt(Ze+1),Re())}),d.appendChild(C),d.appendChild(h),c.onboardingSession===J.sessionNumber){const F=document.createElement("div");F.className="new-student-badge",F.textContent="دانش آموز جدید",d.appendChild(F)}d.appendChild(m),e.appendChild(d),it.disabled=g&&!C.classList.contains("is-disabled");const _=document.createElement("div");_.className="status-button-container";const S=document.createElement("button");S.textContent="غایب",S.classList.add("status-button","absent-btn"),r&&S.classList.add("active");const I=document.createElement("button");I.textContent="مشکل",I.classList.add("status-button","issue-btn"),s!=null&&s.hadIssue&&I.classList.add("active");const x=document.createElement("button");x.textContent="خروج",x.classList.add("status-button","exit-btn"),s!=null&&s.wasOutOfClass&&x.classList.add("active");const L=document.createElement("button");L.textContent="پروفایل",L.className="status-button profile-btn",J.isFinished?S.disabled=!0:S.addEventListener("click",()=>{const F=S.classList.contains("active");x.classList.contains("active")&&(x.classList.remove("active"),s.wasOutOfClass=!1,c.statusCounters.outOfClassCount=Math.max(0,(c.statusCounters.outOfClassCount||0)-1),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)),F?(S.classList.remove("active"),J.setAttendance(c.identity.studentId,"present"),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1),h.style.textDecoration="",h.style.opacity="",h.style.color=""):(I.classList.contains("active")&&(I.classList.remove("active"),s.hadIssue=!1,c.statusCounters.otherIssues=Math.max(0,c.statusCounters.otherIssues-1),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)),S.classList.add("active"),J.setAttendance(c.identity.studentId,"absent"),c.statusCounters.missedChances++,h.style.textDecoration="line-through",h.style.opacity="0.6",h.style.color="var(--color-secondary)",h.title=""),ze(),setTimeout(()=>{Ze!==-1?Re():Re(c,o)},0),ce()}),J.isFinished?I.disabled=!0:I.addEventListener("click",()=>{const F=I.classList.contains("active");if(x.classList.contains("active")&&(x.classList.remove("active"),s.wasOutOfClass=!1,c.statusCounters.outOfClassCount=Math.max(0,(c.statusCounters.outOfClassCount||0)-1),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)),F){I.classList.remove("active"),s.hadIssue=!1;const ne=Ve.name;c.categoryIssues[ne]&&(c.categoryIssues[ne]=Math.max(0,c.categoryIssues[ne]-1)),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1),h.style.color="",h.title=""}else{S.classList.contains("active")&&(S.classList.remove("active"),J.setAttendance(c.identity.studentId,"present"),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)),I.classList.add("active"),s.hadIssue=!0;const ne=Ve.name;c.categoryIssues[ne]=(c.categoryIssues[ne]||0)+1,c.statusCounters.missedChances++,h.style.textDecoration="",h.style.opacity="",h.style.color="var(--color-warning)",h.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"}ze(),setTimeout(()=>{Ze!==-1?Re():Re(c,o)},0),ce()}),J.isFinished?x.disabled=!0:x.addEventListener("click",()=>{if(x.classList.contains("active"))x.classList.remove("active"),s.wasOutOfClass=!1,c.statusCounters.outOfClassCount=Math.max(0,(c.statusCounters.outOfClassCount||0)-1),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1),h.style.color="",h.title="";else{if(S.classList.contains("active")&&(S.classList.remove("active"),J.setAttendance(c.identity.studentId,"present"),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)),I.classList.contains("active")){I.classList.remove("active"),s.hadIssue=!1;const ne=Ve.name;c.categoryIssues[ne]&&(c.categoryIssues[ne]=Math.max(0,c.categoryIssues[ne]-1)),c.statusCounters.missedChances=Math.max(0,c.statusCounters.missedChances-1)}x.classList.add("active"),s.wasOutOfClass=!0,c.statusCounters.outOfClassCount=(c.statusCounters.outOfClassCount||0)+1,c.statusCounters.missedChances++,h.style.textDecoration="",h.style.opacity="",h.style.color="var(--color-strong-warning)",h.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود"}ze(),setTimeout(()=>{Ze!==-1?Re():Re(c,o)},0),ce()}),J.isFinished?L.disabled=!0:L.addEventListener("click",()=>{$e(c)}),_.appendChild(S),_.appendChild(x),_.appendChild(I),_.appendChild(L),e.appendChild(_);const N=document.createElement("div");N.className="student-details-container";const R=document.createElement("div");R.className="student-details-scores",R.innerHTML="<h4>آخرین نمرات</h4>";const P=document.createElement("ul");P.className="scores-list";const Q=D.categories.filter(F=>F.isGradedCategory&&!F.isDeleted);let k=!1;const z=c.logs.scores||{};Q.forEach(F=>{var De;const ne=F.name,O=ne.toLowerCase(),M=document.createElement("li"),oe=document.createElement("span");oe.className="skill-name",oe.textContent=`${ne}:`;const te=document.createElement("span");te.className="skill-scores";const X=(De=z[O])==null?void 0:De.filter(Oe=>!Oe.isDeleted);if(X&&X.length>0){k=!0;const Oe=X.slice(-3);Oe.forEach((he,be)=>{const Te=document.createElement("span");Te.textContent=he.value+(he.comment?"'":""),he.comment&&(Te.dataset.tooltip=he.comment,Te.style.position="relative",Te.style.cursor="help",Te.classList.add("tooltip-container")),te.appendChild(Te),be<Oe.length-1&&te.appendChild(document.createTextNode(","))})}else te.textContent="none";M.appendChild(oe),M.appendChild(te),P.appendChild(M)}),k||(P.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>'),R.appendChild(P),N.appendChild(R);const p=document.createElement("div");p.className="student-details-notes";const H=document.createElement("div");H.className="history-section-header";const ue=document.createElement("h4");ue.textContent="یادداشت‌ها";const j=document.createElement("button");j.className="btn-icon",j.innerHTML="📝",j.title="افزودن یادداشت جدید",J.isFinished?j.disabled=!0:j.addEventListener("click",()=>{_e.value="",_e.dispatchEvent(new Event("input",{bubbles:!0})),rt(F=>{F&&(c.addNote(F),ce(),Re(),Y("✅ یادداشت با موفقیت ثبت شد."))}),Fe("add-note-modal"),_e.focus()}),H.appendChild(ue),H.appendChild(j),p.appendChild(H);const fe=document.createElement("ul");fe.className="notes-list",c.profile.notes&&c.profile.notes.length>0?[...c.profile.notes].sort((ne,O)=>new Date(O.timestamp)-new Date(ne.timestamp)).forEach(ne=>{const O=document.createElement("li");O.dir=Fs(ne.content),O.textContent=ne.content,fe.appendChild(O)}):fe.innerHTML='<div class="no-content-message">یادداشتی وجود ندارد.</div>',p.appendChild(fe),N.appendChild(p),e.appendChild(N)}function ea(n){n.addEventListener("input",()=>{const a=n.value,e=Fs(a);n.setAttribute("dir",e)})}function Or(){Ys(null),Xt.innerHTML="",gs.innerHTML="",Ot.classList.add("tooltip-container"),dt.disabled=!0,st.disabled=!0,St.disabled=!0,dt.value="",st.value="",$t.classList.add("disabled-wrapper"),it.disabled=!0}function kn(){Xt.innerHTML="",D.categories.filter(e=>!e.isDeleted).forEach(e=>{const c=document.createElement("span");c.className="pill",c.textContent=e.name,c.dataset.categoryId=e.id,e.description&&(c.dataset.tooltip=e.description),J.isFinished?c.classList.add("disabled"):c.addEventListener("click",()=>{document.querySelectorAll("#category-selection-container .pill").forEach(t=>t.classList.remove("active")),c.classList.add("active"),zn(e),Ys(e),ws(e),Es(e.name),$t.classList.remove("disabled-wrapper"),it.disabled=J.isFinished;const o=J.lastWinnerByCategory[e.name];if(o){const t=D.students.find(i=>i.identity.studentId===o);t&&Re(t,e.name)}else{gs.innerHTML="",$n(null),bt(-1),it.disabled=!1;const t=document.querySelector(".current-winner-highlight");t&&t.classList.remove("current-winner-highlight")}}),J.isFinished||c.addEventListener("contextmenu",o=>{dn(o,[{label:"تغییر نام",icon:"✏️",action:()=>{vs((i,s)=>{const r=pi(D,e,i);r.success?(e.isGradedCategory=s,ce(),ke(D.info.name,`نام دسته‌بندی «${e.name}» به «${i}» تغییر یافت.`),kn(),ze(),Y(`✅ نام دسته‌بندی به «${i}» تغییر یافت.`)):Y(`⚠️ ${r.message}`)},{title:"ویرایش دسته‌بندی",initialName:e.name,initialIsGraded:e.isGradedCategory,saveButtonText:"ذخیره تغییرات"})}},{label:"حذف دسته‌بندی",icon:"🗑️",className:"danger",action:()=>{Ee(`آیا از انتقال دسته‌بندی «${e.name}» به سطل زباله مطمئن هستید؟`,()=>{const i={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${e.name}» از کلاس «${D.info.name}»`,restoreData:{categoryId:e.id,classId:D.info.scheduleCode}};pe.unshift(i),pe.length>50&&pe.pop();const s=e.name.toLowerCase();if(D.students.forEach(r=>{r.logs.scores&&r.logs.scores[s]&&r.logs.scores[s].forEach(d=>{d.isDeleted=!0})}),Ve&&Ve.id===e.id){zn(null),gs.innerHTML="",ws(null),Es(null),$t.classList.add("disabled-wrapper"),it.disabled=!0;const r=document.querySelector(".current-winner-highlight");r&&r.classList.remove("current-winner-highlight")}e.isDeleted=!0,ke(D.info.name,`دسته‌بندی «${e.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),kn(),ze(),Y(`✅ دسته‌بندی «${e.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}}])}),Xt.appendChild(c)});const a=document.createElement("span");a.className="pill add-category-pill",a.textContent="+",a.title="افزودن دسته‌بندی جدید",J.isFinished?a.classList.add("disabled"):a.addEventListener("click",()=>{vs((e,c)=>{if(D.categories.find(i=>i.name.toLowerCase()===e.toLowerCase()&&!i.isDeleted)){Y("⚠️ این دسته‌بندی از قبل وجود دارد.");return}const t=new ft(e,"",c);D.categories.push(t),ce(),ke(D.info.name,`دسته‌بندی جدید «${e}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),kn(),Y(`✅ دسته‌بندی «${e}» اضافه شد.`)})}),Xt.appendChild(a)}function Mr(){if(J.lastUsedCategoryId){if(J.isFinished)return;const n=Xt.querySelector(`.pill[data-category-id="${J.lastUsedCategoryId}"]`);n&&n.click()}J.winnerHistory&&J.winnerHistory.length>0&&(bt(J.winnerHistory.length-1),Re())}function Ys(n){n?it.textContent=`نفر بعدی در ${n.name}`:it.textContent="نفر بعدی"}function ws(n){if(J.isFinished){dt.disabled=!0,st.disabled=!0,St.disabled=!0,Ot.setAttribute("title","جلسه خاتمه یافته است");return}n&&n.isGradedCategory?(dt.disabled=!1,st.disabled=!1,St.disabled=!1,Ot.removeAttribute("title")):(dt.disabled=!0,st.disabled=!0,St.disabled=!0,n?Ot.setAttribute("title","برای این دسته‌بندی قابلیت نمره دهی تعریف نشده است"):Ot.setAttribute("title","ابتدا یک دسته‌بندی را انتخاب کنید"))}function Es(n){const a=document.querySelector(".student-stats-table");if(!a||(a.querySelectorAll(".current-category-highlight").forEach(i=>{i.classList.remove("current-category-highlight")}),!n))return;let c=-1;const o=a.querySelectorAll("thead th");if(o.forEach((i,s)=>{i.textContent.trim()===n&&(c=s)}),c===-1)return;o[c].classList.add("current-category-highlight"),a.querySelectorAll("tbody tr").forEach(i=>{const s=i.cells[c];s&&s.classList.add("current-category-highlight")})}function $e(n){Je(n);const a=document.getElementById("student-profile-modal"),e=document.getElementById("modal-profile-student-name"),c=document.getElementById("modal-profile-content-container"),o=document.getElementById("modal-profile-close-btn");if(!a||!e||!c||!o)return;e.textContent=`پروفایل: ${n.identity.name}`,e.style.cursor="pointer",e.onclick=()=>{const d=Se,m=D;we(()=>{Gs(d,m)})},c.innerHTML="";const t=document.createElement("div");t.className="profile-header-actions";const i=document.createElement("button");i.className="btn-icon btn-icon-label",i.title="انتقال دانش‌آموز",i.innerHTML="<span>➡️</span><span>انتقال</span>",i.addEventListener("click",()=>{const d=Se,m=D;we(()=>{qs(d,m)})});const s=document.createElement("button");s.className="btn-icon btn-icon-label",s.title="حذف دانش‌آموز",s.innerHTML="<span>🗑️</span><span>حذف</span>",s.style.color="var(--color-strong-warning)",s.addEventListener("click",()=>{const d=Se,m=D;we(()=>{Ee(`آیا از انتقال دانش‌آموز «${d.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const g={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${d.identity.name}» از کلاس «${m.info.name}»`,restoreData:{studentId:d.identity.studentId,classId:m.info.scheduleCode}};pe.unshift(g),pe.length>50&&pe.pop(),d.isDeleted=!0,ke(m.info.name,`دانش‌آموز «${d.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),ut(),ze(),at(),Y(`✅ دانش‌آموز «${d.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0,onCancel:()=>{$e(d)}})})});const r=document.createElement("button");r.className="btn-icon btn-icon-label",r.title="افزودن یادداشت جدید",r.innerHTML="<span>📝</span><span>یادداشت</span>",r.addEventListener("click",()=>{const d=Se;_e.value="",_e.dispatchEvent(new Event("input",{bubbles:!0})),rt(m=>{if(m)return d.addNote(m),ce(),ke(D.info.name,`یادداشت جدیدی برای دانش‌آموز «${d.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:d.identity.studentId}),Re(),Y("✅ یادداشت با موفقیت ثبت شد."),()=>$e(d)}),we(()=>{Fe("add-note-modal"),_e.focus()})}),t.appendChild(i),t.appendChild(s),t.appendChild(r),c.appendChild(t),Rr(c),ta(c),o.onclick=()=>we(),Fe("student-profile-modal")}function Rr(n){if(!Se||!D)return;const a=document.createElement("div");a.className="scoring-section",a.innerHTML=`
        <h3>ثبت نمره جدید</h3>
        <div id="modal-graded-pills" class="category-pills"></div>
        <div class="input-group centered-input-group" style="margin-top: 15px;">
            <input type="number" id="modal-new-score-value" placeholder="نمره (مثلا: 85)">
        </div>
        <textarea id="modal-new-score-comment" placeholder="توضیحات این نمره (اختیاری)..." style="margin-top: 10px;"></textarea>
        <button id="modal-add-score-btn" class="btn-success" style="width: 100%; margin-top: 10px;">ثبت نمره</button>
    `;const e=a.querySelector("#modal-graded-pills");Ie(D.categories).filter(t=>t.isGradedCategory).forEach(t=>{const i=document.createElement("span");i.className="pill",i.textContent=t.name,i.dataset.skillName=t.name,i.addEventListener("click",()=>{e.querySelectorAll(".pill").forEach(s=>s.classList.remove("active")),i.classList.add("active")}),e.appendChild(i)}),a.querySelector("#modal-add-score-btn").addEventListener("click",()=>{const t=e.querySelector(".pill.active");if(!t){Y("⚠️لطفاً یک مهارت را برای نمره‌دهی انتخاب کنید.");return}const i=t.dataset.skillName,s=a.querySelector("#modal-new-score-value"),r=a.querySelector("#modal-new-score-comment"),d=s.value,m=r.value.trim();if(!d){Y("لطفاً مقدار نمره را وارد کنید.");return}Se.addScore(i,parseFloat(d),m),ce(),ke(D.info.name,`نمره ${d} در ${i} برای «${Se.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:Se.identity.studentId}),ze(),Re(),s.value="",r.value="";const g=document.getElementById("modal-profile-content-container"),h=g.querySelector(".history-section");h&&h.remove(),ta(g),Y(`✅ نمره برای مهارت ${i} با موفقیت ثبت شد.`)}),n.appendChild(a)}function ta(n){if(!Se)return;const a=document.createElement("div");a.className="history-section";const e=document.createElement("div");e.className="history-section-header";const c=document.createElement("h3");c.textContent="سوابق دانش‌آموز",e.appendChild(c),a.appendChild(e),zr(a),na(a),sa(a),n.appendChild(a)}function zr(n){if(!Se)return;const a=Se,e=D.sessions.reduce((f,v)=>{const u=v.studentRecords[a.identity.studentId];return f+(u&&u.attendance==="absent"?1:0)},0),c=Object.values(a.categoryIssues||{}).reduce((f,v)=>f+v,0),o=document.createElement("div");o.className="stats-summary-box",o.innerHTML=`
        <p><strong>کل انتخاب:</strong> ${a.statusCounters.totalSelections}</p>
        <p><strong>غیبت:</strong> ${e}</p>
        <p><strong>فرصت از دست رفته:</strong> ${a.statusCounters.missedChances||0}</p>
        <p><strong>مشکل:</strong> ${c}</p>
    `,n.appendChild(o),o.querySelector("p:nth-child(1)");const t=o.querySelector("p:nth-child(4)"),i=Ie(D.categories),s=document.createElement("div");if(s.className="stats-breakdown",i.length>0){i.forEach(v=>{var C;const u=v.name,b=((C=a.categoryCounts)==null?void 0:C[u])||0,y=document.createElement("p");y.className="stats-breakdown-item",y.innerHTML=`<strong>${u}:</strong> ${b}`,s.appendChild(y)});const f=o.querySelector("p:first-child");f&&(f.classList.add("collapsible-toggle"),f.onclick=()=>{s.classList.toggle("open"),f.classList.toggle("open")},f.after(s))}const r=document.createElement("div");r.className="stats-breakdown",i.length>0&&(i.forEach(f=>{var y;const v=f.name,u=((y=a.categoryIssues)==null?void 0:y[v])||0,b=document.createElement("p");b.className="stats-breakdown-item",b.innerHTML=`<strong>${v}:</strong> ${u}`,r.appendChild(b)}),t&&(t.classList.add("collapsible-toggle"),t.onclick=()=>{r.classList.toggle("open"),t.classList.toggle("open")},o.appendChild(r)));const d=document.createElement("p"),m=document.createElement("strong");m.textContent="تکالیف ناقص:";const g=document.createElement("span");g.style.marginRight="5px";const h=tt(D);_n(a,h,g,{includePrefix:!1}),d.appendChild(m),d.appendChild(g),o.appendChild(d)}function na(n){if(!Se)return;const a=Se,e=document.createElement("h4");e.textContent="تاریخچه نمرات:",e.style.marginTop="20px";const c=document.createElement("ul");c.className="list-container";const o=Object.values(a.logs.scores||{}).flat().filter(t=>!t.isDeleted).sort((t,i)=>new Date(i.timestamp)-new Date(t.timestamp));o.length===0?c.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>':o.forEach(t=>{const i=document.createElement("li");i.className="score-history-item";const s=document.createElement("div");s.className="item-content";const r=document.createElement("div");r.className="score-info";const d=document.createElement("span");d.className="score-skill-badge",d.textContent=t.skill;const m=document.createElement("span");m.className="score-value",m.textContent=`نمره: ${t.value}`;const g=document.createElement("span");if(g.className="score-date",g.textContent=new Date(t.timestamp).toLocaleDateString("fa-IR"),r.appendChild(d),r.appendChild(m),r.appendChild(g),s.appendChild(r),t.comment){const f=document.createElement("p");f.className="score-comment",f.innerHTML=Di(t.comment),f.addEventListener("click",()=>{_e.value=t.comment,_e.dispatchEvent(new Event("input",{bubbles:!0})),rt(v=>{t.comment=v,ce(),ke(D.info.name,`توضیحات نمره ${t.value} (${t.skill}) برای دانش‌آموز «${a.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:a.identity.studentId}),$e(a),Y("✅ توضیحات نمره با موفقیت ویرایش شد.")}),we(()=>{Fe("add-note-modal"),_e.focus()})}),s.appendChild(f)}const h=document.createElement("button");h.className="btn-icon delete-item-btn",h.innerHTML="🗑️",h.title="حذف این نمره",h.addEventListener("click",()=>{we(()=>{Ee(`آیا از انتقال نمره ${t.value} در مهارت «${t.skill}» به سطل زباله مطمئن هستید؟`,()=>{const f={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"score",description:`نمره ${t.value} (${t.skill}) برای «${a.identity.name}»`,restoreData:{scoreId:t.id,skill:t.skill,studentId:a.identity.studentId,classId:D.info.scheduleCode}};pe.unshift(f),pe.length>50&&pe.pop(),t.isDeleted=!0,ce(),ke(D.info.name,`نمره ${t.value} (${t.skill}) دانش‌آموز «${a.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),$e(a),Y("✅ نمره به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{$e(a)}})})}),i.appendChild(s),i.appendChild(h),c.appendChild(i)}),n.appendChild(e),n.appendChild(c)}function sa(n){if(!Se)return;const a=document.createElement("h4");a.textContent="تاریخچه یادداشت‌ها:",a.style.marginTop="20px";const e=document.createElement("ul");e.className="list-container",!Se.profile.notes||Se.profile.notes.length===0?e.innerHTML='<div class="no-content-message">هنوز یادداشتی ثبت نشده است.</div>':[...Se.profile.notes].filter(o=>!o.isDeleted).sort((o,t)=>new Date(t.timestamp)-new Date(o.timestamp)).forEach(o=>{const t=document.createElement("li");t.className="note-history-item";const i=document.createElement("div");i.className="item-content";const s=document.createElement("div");s.className="note-info";const r=document.createElement("span");r.className="note-date",r.textContent=new Date(o.timestamp).toLocaleDateString("fa-IR");const d=document.createElement("button");d.className="btn-icon delete-item-btn",d.innerHTML="🗑️",d.title="حذف این یادداشت",d.addEventListener("click",()=>{const g=Se;we(()=>{Ee("آیا از انتقال این یادداشت به سطل زباله مطمئن هستید؟",()=>{const h={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"note",description:`یادداشت برای دانش‌آموز «${g.identity.name}»`,restoreData:{noteId:o.id,studentId:g.identity.studentId,classId:D.info.scheduleCode}};pe.unshift(h),pe.length>50&&pe.pop(),o.isDeleted=!0,ke(D.info.name,`یادداشت دانش‌آموز «${g.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),$e(g),Y("✅ یادداشت به سطل زباله منتقل شد.")},{confirmText:"تایید انتقال",confirmClass:"btn-warning",onCancel:()=>{$e(g)}})})}),s.appendChild(r),s.appendChild(d);const m=document.createElement("p");m.className="note-content",m.innerHTML=Di(o.content),m.addEventListener("click",()=>{const g=Se;_e.value=o.content,_e.dispatchEvent(new Event("input",{bubbles:!0})),rt(h=>{o.content=h,ce(),ke(D.info.name,`یادداشت دانش‌آموز «${g.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:g.identity.studentId}),$e(g),Y("✅یادداشت با موفقیت ویرایش شد.")}),we(()=>{Fe("add-note-modal"),_e.focus()})}),i.appendChild(s),i.appendChild(m),t.appendChild(i),e.appendChild(t)}),n.appendChild(a),n.appendChild(e)}function ia(n){us.innerHTML="",n.forEach((a,e)=>{const c=document.createElement("option");c.value=e,c.textContent=a.trim(),us.appendChild(c)})}function _s(){ds.innerHTML="",Is.forEach(n=>{const a=document.createElement("li");a.className="preview-item";const e=document.createElement("input");e.type="checkbox",e.checked=!0,e.dataset.name=n;const c=document.createElement("label");c.textContent=n,a.appendChild(e),a.appendChild(c),ds.appendChild(a)})}function $r(n){const a=document.createElement("div");a.className="list-item-buttons";const e=document.createElement("button");return e.className="btn-icon",e.innerHTML="📝",e.title="ویرایش یادداشت کلاس",n.note||(e.style.display="none"),e.addEventListener("click",c=>{c.stopPropagation(),Vn(n)}),a.appendChild(e),a}function Fr(n){const a=document.createElement("div");a.style.flexGrow="1",a.style.display="flex",a.style.flexDirection="column",a.style.alignItems="flex-start";const e=document.createElement("span");e.textContent=n.info.name,e.classList.add("class-name-display"),a.appendChild(e);const c=Ie(n.students).length,o=Ie(n.sessions).filter(d=>d.isFinished).length,t=Gr(n.info.scheduleDays),i=document.createElement("div");i.classList.add("class-stats-row");const s=document.createElement("span");s.textContent=`${c} نفر`,s.classList.add("student-count-badge"),i.appendChild(s);const r=document.createElement("span");if(r.textContent=`${o} جلسه`,r.classList.add("session-count-badge"),i.appendChild(r),t){const d=document.createElement("span");d.textContent=t,d.classList.add("schedule-days-badge"),i.appendChild(d)}return a.appendChild(i),a.addEventListener("click",()=>{He(n),qe(null),sn(D.liveSession),We(),ge("session-page")}),a}function Pr(n){const a=document.createElement("li");jn(n).type==="active"&&(a.classList.add("active-class-card"),a.title="این کلاس هم‌اکنون در حال برگزاری است");const c=document.createElement("input");c.type="checkbox",c.className="mass-selection-checkbox",c.checked=ct.includes(n.info.name),c.addEventListener("click",m=>{m.stopPropagation()}),c.addEventListener("change",()=>{const m=n.info.name;if(c.checked)ct.includes(m)||ct.push(m);else{const g=ct.indexOf(m);g>-1&&ct.splice(g,1)}}),a.appendChild(c);const o=Fr(n);a.appendChild(o);const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.gap="5px",t.style.alignItems="flex-end",t.style.marginLeft="10px";const i=document.createElement("div");if(i.className="list-item-badges",n.liveSession&&!n.liveSession.isCancelled&&!n.liveSession.isDeleted){const m=document.createElement("span");m.className="warning-badge",m.textContent="جلسه باز",i.appendChild(m),a.classList.add("has-unfinished-session")}const s=document.createElement("span");if(s.className=`type-badge ${n.info.type}`,s.textContent=n.info.type==="online"?"آنلاین":"حضوری",s.title="نوع کلاس",i.appendChild(s),jn(n).type==="incomplete"){const m=document.createElement("span");m.className="type-badge cancelled-badge",m.textContent="زمان‌بندی ناقص",m.style.cursor="pointer",m.title="برای تکمیل زمان‌بندی کلیک کنید",m.addEventListener("click",g=>{g.stopPropagation(),Ee("زمان‌بندی این کلاس کامل نیست. برای نمایش صحیح در لیست، لطفاً روزها و ساعت برگزاری را مشخص کنید.",()=>{zt(n)},{confirmText:"تنظیمات",confirmClass:"btn-primary"})}),i.appendChild(m)}else{const m=qr(n,re);if(m){const g=document.createElement("span");g.className="type-badge conflict-badge",g.textContent="تداخل زمانی",g.style.cursor="pointer",g.title=`تداخل با کلاس: ${m}`,g.addEventListener("click",h=>{h.stopPropagation(),Ee(`زمان برگزاری این کلاس با کلاس «${m}» تداخل دارد. لطفاً زمان‌بندی را بررسی کنید.`,()=>{zt(n)},{confirmText:"تنظیمات",confirmClass:"btn-primary"})}),i.appendChild(g)}}t.appendChild(i);const d=$r(n);return t.appendChild(d),a.appendChild(t),a.addEventListener("contextmenu",m=>{const g={label:"پشتیبان‌گیری از این کلاس",icon:"📤",action:()=>{cn([n.info.name])}},h=ct.length;h>1&&ct.includes(n.info.name)&&(g.label=`پشتیبان‌گیری از ${h} کلاس`,g.action=()=>{cn(ct),rs([]),Ue()});const f=[{label:Mt.classList.contains("selection-mode-active")?"لغو انتخاب":"انتخاب چند کلاس",icon:"✔️",action:()=>{const v=Mt.classList.contains("selection-mode-active");Mt.classList.toggle("selection-mode-active"),v&&(rs([]),Ue())}},g,{label:"یادداشت کلاس",icon:"📝",action:()=>{Vn(n)}},{label:"تنظیمات کلاس",icon:"⚙️",action:()=>{zt(n)}},{label:"گزارش فعالیت‌ها",icon:"📋",action:()=>{Xi(n.info.name)}},{label:"تغییر نام",icon:"✏️",action:()=>{const v=n.info.name,u=document.getElementById("add-note-modal-title");u.textContent="تغییر نام کلاس",_e.value=v,_e.rows=1,rt(b=>{const y=b.trim();if(y&&y!==v){const C=hi(v,y);C.success?(Ia(v,y),ke(y,`نام کلاس از «${v}» به «${y}» تغییر یافت.`,{type:"VIEW_SESSIONS"}),ce(),Ue(),Y(`✅نام کلاس به «${y}» تغییر یافت.`)):Y(C.message)}u.textContent="ثبت یادداشت جدید",_e.rows=4}),Fe("add-note-modal"),_e.focus(),_e.select()}},{label:"حذف کلاس",icon:"🗑️",className:"danger",action:()=>{Ee(`آیا از انتقال کلاس «${n.info.name}» به سطل زباله مطمئن هستید؟`,()=>{const v={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"classroom",description:`کلاس «${n.info.name}»`,restoreData:{name:n.info.name}};pe.unshift(v),pe.length>50&&pe.pop(),n.isDeleted=!0,ce(),Ue(),Y(`✅ کلاس «${n.info.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}];dn(m,f)}),a}function Jn(){const n=document.getElementById("class-management-stats");if(!n)return;const a=Object.values(re).filter(t=>!t.isDeleted),e=a.length,c=a.reduce((t,i)=>t+Ie(i.students).length,0);let o="";Ge.lastBackupTimestamp&&(o=`
            <div class="stats-row backup-stat">
                <span>آخرین پشتیبان: <strong>${new Date(Ge.lastBackupTimestamp).toLocaleString("fa-IR",{year:"numeric",month:"numeric",day:"numeric",weekday:"long",hour:"2-digit",minute:"2-digit"})}</strong></span>
            </div>
        `),n.innerHTML=`
        <div class="stats-row main-stats">
            <span>کل کلاس‌ها: <strong>${e}</strong></span>
            <span>|</span>
            <span>کل دانش‌آموزان: <strong>${c}</strong></span>
        </div>
        ${o} 
    `}function Ue(){Jn(),Mt.innerHTML="",Object.values(re).sort((a,e)=>{const c=jn(a),o=jn(e);return c.sortIndex!==o.sortIndex?c.sortIndex-o.sortIndex:c.type==="upcoming"?c.nextTimestamp-o.nextTimestamp:new Date(a.info.creationDate)-new Date(e.info.creationDate)}).forEach(a=>{if(a.isDeleted)return;const e=Pr(a);Mt.appendChild(e)})}function ut(){cs.innerHTML="",D&&Ie(D.students).forEach(n=>{const a=document.createElement("li"),e=document.createElement("span");e.textContent=n.identity.name,e.style.flexGrow="1",e.className="student-name-link",e.addEventListener("click",()=>{$e(n)}),a.appendChild(e),a.addEventListener("contextmenu",c=>{dn(c,[{label:"تغییر نام",icon:"✏️",action:()=>{Gs(n,D)}},{label:"انتقال دانش‌آموز",icon:"➡️",action:()=>{qs(n,D)}},{label:"حذف دانش‌آموز",icon:"🗑️",className:"danger",action:()=>{Ee(`آیا از انتقال دانش‌آموز «${n.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const t={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${n.identity.name}» از کلاس «${D.info.name}»`,restoreData:{studentId:n.identity.studentId,classId:D.info.scheduleCode}};pe.unshift(t),pe.length>50&&pe.pop(),n.isDeleted=!0,ke(D.info.name,`دانش‌آموز «${n.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),ut(),Y(`✅ دانش‌آموز «${n.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}])}),cs.appendChild(a)})}function Ht(){if(ls.innerHTML="",!D)return;D.categories.filter(a=>!a.isDeleted).forEach(a=>{const e=document.createElement("li"),c=document.createElement("div");c.className="name-and-badge-container";const o=document.createElement("span");if(o.textContent=a.name,c.appendChild(o),a.isGradedCategory){const i=document.createElement("span");i.className="category-badge",i.textContent="نمره‌دار",c.appendChild(i)}const t=document.createElement("button");t.className="btn-icon",t.innerHTML="🗑️",t.style.color="var(--color-warning)",t.addEventListener("click",()=>{Ee(`آیا از انتقال دسته‌بندی «${a.name}» به سطل زباله مطمئن هستید؟`,()=>{const i={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${a.name}» از کلاس «${D.info.name}»`,restoreData:{categoryId:a.id,classId:D.info.scheduleCode}};pe.unshift(i),pe.length>50&&pe.pop(),a.isDeleted=!0,ke(D.info.name,`دسته‌بندی «${a.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),Ht(),Y(`✅ دسته‌بندی «${a.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}),e.appendChild(c),e.appendChild(t),ls.appendChild(e)})}function aa(){if(!D)return;const n=D.info.type||"in-person",a=document.querySelector(`#settings-page input[name="class-type-setting"][value="${n}"]`);a&&(a.checked=!0);const e=D.info.scheduleDays||[];document.querySelectorAll('input[name="schedule-day"]').forEach(c=>{c.checked=e.includes(parseInt(c.value))}),document.getElementById("settings-schedule-start").value=D.info.scheduleStartTime||"",document.getElementById("settings-schedule-end").value=D.info.scheduleEndTime||""}function tn(n){document.querySelectorAll(".page").forEach(e=>{e.classList.remove("active")});const a=document.getElementById(n);a&&a.classList.add("active"),n==="class-management-page"?(He(null),qe(null),Je(null),Ue(),fs.style.display="flex"):fs.style.display="none",Qi()}function ge(n,a={}){const{tab:e}=a,c={pageId:n,currentClassName:D?D.info.name:null,selectedSessionNumber:J?J.sessionNumber:null,selectedStudentId:Se?Se.identity.studentId:null};let o=`#${n}`;const t=new URLSearchParams(window.location.hash.split("?")[1]||"");D?t.set("class",D.info.name):t.delete("class"),J?t.set("session",J.sessionNumber):t.delete("session"),Se?t.set("student",Se.identity.studentId):t.delete("student"),n==="session-dashboard-page"&&e?t.set("tab",e):n!=="session-dashboard-page"&&t.delete("tab");const i=t.toString();i&&(o+=`?${i}`),window.location.hash!==o&&history.pushState(c,"",o),tn(n)}function Hr(n,a){const e=document.createElement("div");e.className="list-item-buttons",e.style.gap="10px";const c=document.createElement("button");if(c.className="btn-icon",c.innerHTML="📝",c.title="ویرایش یادداشت جلسه",n.note||(c.style.display="none"),c.addEventListener("click",o=>{o.stopPropagation(),Ks(n,a)}),!n.isFinished&&!n.isCancelled){const o=document.createElement("button");o.className="btn-success",o.textContent="پایان جلسه",o.style.fontSize="12px",o.style.padding="4px 10px",o.style.whiteSpace="nowrap",o.addEventListener("click",t=>{t.stopPropagation(),Ee(`جلسه شماره ${a} خاتمه پیدا خواهد کرد!`,()=>{D.endSpecificSession(n.sessionNumber),ce(),ke(D.info.name,`جلسه ${a} خاتمه یافت.`,{type:"VIEW_SESSIONS"}),We(),Ee("جلسه با موفقیت خاتمه یافت. آیا مایل به ایجاد فایل پشتیبان هستید؟",()=>{if(lt){Y("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است.");return}cn(),Y("✅فایل پشتیبان با موفقیت ایجاد شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}),e.appendChild(o)}return e.appendChild(c),e}function Wr(n,a){const e=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="flex-start",e.style.flexGrow="1";const c=new Date(n.startTime).toLocaleDateString("fa-IR"),o=document.createElement("span");o.className="session-list-title";const t=document.createElement("div");t.style.display="flex",t.style.gap="5px",t.style.marginTop="5px";const i=new Date(n.startTime).toLocaleDateString("fa-IR",{weekday:"long"}),s=document.createElement("span");if(s.className="type-badge day-badge",s.textContent=i,t.appendChild(s),n.isCancelled){o.textContent=`لغو شده - تاریخ: ${c}`,e.style.cursor="default";const r=document.createElement("span");r.className="type-badge cancelled-badge",r.textContent="لغو شده",t.appendChild(r)}else o.textContent=`جلسه ${a} - تاریخ: ${c}`,e.style.cursor="pointer",e.addEventListener("click",()=>{qe(n),Pt()});if(e.appendChild(o),n.isFinished){const r=document.createElement("span");r.className="type-badge finished-badge",r.textContent="خاتمه یافته",t.appendChild(r)}if(n.isMakeup){const r=document.createElement("span");r.className="type-badge makeup-badge",r.textContent="جبرانی",t.appendChild(r)}return e.appendChild(t),e}function Ur(n,a){const e=document.createElement("li"),c=a.get(n.sessionNumber),o=Wr(n,c);e.appendChild(o);const t=Hr(n,c);return e.appendChild(t),e.addEventListener("contextmenu",i=>{const s=[{label:"یادداشت جلسه",icon:"📝",action:()=>{Ks(n,c)}},{label:n.isCancelled?"بازگردانی جلسه":"لغو جلسه",icon:"❌",action:()=>{const r=n.isCancelled?"بازگردانی جلسه":"لغو جلسه",d=n.isCancelled?"آیا از بازگردانی این جلسه مطمئن هستید؟":"آیا از لغو این جلسه مطمئن هستید؟ جلسه لغو شده در آمار تاثیری ندارد اما قابل بازگردانی است.";Ee(d,()=>{n.isCancelled=!n.isCancelled;const m=n.isCancelled?`جلسه ${c} لغو شد.`:`جلسه لغو شده (تاریخ: ${new Date(n.startTime).toLocaleDateString("fa-IR")}) بازگردانی شد.`;ke(D.info.name,m,{type:"VIEW_SESSIONS"}),ce(),We(),Y(n.isCancelled?"✅جلسه لغو شد.":"✅جلسه بازگردانی شد.")},{confirmText:r,confirmClass:"btn-warning"})}},{label:"تغییر وضعیت جبرانی",icon:"🔄",action:()=>{D.markAsMakeup(n.sessionNumber),ce();const r=n.isMakeup?`جلسه ${c} به عنوان جبرانی علامت‌گذاری شد.`:`جلسه ${c} از حالت جبرانی خارج شد.`;ke(D.info.name,r,{type:"VIEW_SESSIONS"}),We()}},{label:"حذف جلسه",icon:"🗑️",className:"danger",action:()=>{const r=n.isCancelled?"لغو شده":c;Ee(`آیا از انتقال جلسه ${r} به سطل زباله مطمئن هستید؟`,()=>{const d={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"session",description:`جلسه ${r} از کلاس «${D.info.name}»`,restoreData:{sessionNumber:n.sessionNumber,classId:D.info.scheduleCode}};pe.unshift(d),pe.length>50&&pe.pop(),n.isDeleted=!0,ke(D.info.name,`جلسه ${r} به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),ce(),We(),Y(`✅ جلسه ${r} به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}},{label:"تغییر تاریخ",icon:"📅",action:()=>{const r=document.getElementById("dp-day"),d=document.getElementById("dp-month"),m=document.getElementById("dp-year"),g=ni.toJalaali(n.startTime);r.innerHTML="";for(let v=1;v<=31;v++){const u=document.createElement("option");u.value=v,u.textContent=v.toLocaleString("fa-IR"),v===g.jd&&(u.selected=!0),r.appendChild(u)}const h=["فروردین","اردیبهشت","خرداد","تیر","مرداد","شهریور","مهر","آبان","آذر","دی","بهمن","اسفند"];d.innerHTML="",h.forEach((v,u)=>{const b=document.createElement("option");b.value=u+1,b.textContent=v,u+1===g.jm&&(b.selected=!0),d.appendChild(b)}),m.innerHTML="";const f=g.jy;for(let v=f-5;v<=f+5;v++){const u=document.createElement("option");u.value=v,u.textContent=v.toString().replace(/\d/g,b=>"۰۱۲۳۴۵۶۷۸۹"[b]),v===g.jy&&(u.selected=!0),m.appendChild(u)}Fn(v=>{if(!v)return;const u=ni.toGregorian(parseInt(v.jy),parseInt(v.jm),parseInt(v.jd)),b=new Date(u.gy,u.gm-1,u.gd);b.setHours(n.startTime.getHours()),b.setMinutes(n.startTime.getMinutes()),b.setSeconds(n.startTime.getSeconds());const y=n.startTime.toLocaleDateString("fa-IR");n.startTime=b;const C=n.startTime.toLocaleDateString("fa-IR");ke(D.info.name,`تاریخ جلسه ${c} از ${y} به ${C} تغییر یافت.`,{type:"VIEW_SESSIONS"}),ce(),We(),Y(`✅ تاریخ جلسه به ${C} تغییر یافت.`)}),Fe("date-picker-modal")}}];dn(i,s)}),e}function We(){const n=document.getElementById("session-list");if(!D)return;if(n.innerHTML="",D.sessions.length===0){n.innerHTML="<li>هنوز جلسه‌ای شروع نشده است.</li>";return}const a=tt(D);[...Ie(D.sessions)].reverse().forEach(c=>{const o=Ur(c,a);n.appendChild(o)})}function Jt(n){if(pt.innerHTML="",n.length>0)n.forEach(a=>{const e=document.createElement("div");e.textContent=a.identity.name,e.addEventListener("click",()=>{$e(a),pt.style.display="none",ps.value=""}),pt.appendChild(e)}),pt.style.display="block";else if(ps.value.trim()!==""){const a=document.createElement("div");a.className="no-results",a.textContent="پیدا نشد",pt.appendChild(a),pt.style.display="block"}else pt.style.display="none"}function Sn(n){if(ot.innerHTML="",n.length>0)n.forEach(a=>{const e=document.createElement("div");if(e.className="global-search-result",a.type==="student"){const c=document.createElement("span");c.className="student-name",c.textContent=a.student.identity.name;const o=document.createElement("span");o.className="class-name",o.textContent=`کلاس: ${a.classroom.info.name}`,e.addEventListener("click",()=>{He(a.classroom),$e(a.student),ot.style.display="none",Gt.value=""}),o.addEventListener("click",t=>{t.stopPropagation(),He(a.classroom),qe(null),sn(a.classroom.liveSession),We(),ge("session-page"),ot.style.display="none",Gt.value=""}),e.appendChild(c),e.appendChild(o)}else if(a.type==="classroom"){const c=document.createElement("span");c.className="student-name",c.textContent=`[کلاس] ${a.classroom.info.name}`,e.addEventListener("click",()=>{He(a.classroom),qe(null),sn(a.classroom.liveSession),We(),ge("session-page"),ot.style.display="none",Gt.value=""}),e.appendChild(c)}ot.appendChild(e)}),ot.style.display="block";else if(Gt.value.trim()!==""){const a=document.createElement("div");a.className="no-results",a.textContent="پیدا نشد",ot.appendChild(a),ot.style.display="block"}else ot.style.display="none"}function ln(){const n=document.getElementById("trashed-items-list");if(n.innerHTML="",pe.length===0){n.innerHTML='<li style="text-align: center; padding: 20px;">سطل زباله خالی است.</li>';return}pe.forEach((a,e)=>{const c=document.createElement("li"),o=document.createElement("span");o.textContent=a.description,o.style.flexGrow="1";const t=document.createElement("div");t.className="list-item-buttons";const i=document.createElement("button");i.className="btn-icon",i.innerHTML="🔄",i.title="بازیابی",i.addEventListener("click",()=>{var g;let r=!1,d=null;const m=a.restoreData;switch(a.type){case"classroom":{const h=re[m.name];h&&!h.isDeleted?d=`کلاسی با نام «${m.name}» از قبل فعال است.`:h&&h.isDeleted&&(h.isDeleted=!1,r=!0);break}case"student":{const h=Object.values(re).find(v=>v.info.scheduleCode===m.classId),f=h==null?void 0:h.students.find(v=>v.identity.studentId===m.studentId);f&&(f.isDeleted=!1,r=!0);break}case"session":{const h=Object.values(re).find(v=>v.info.scheduleCode===m.classId),f=h==null?void 0:h.sessions.find(v=>v.sessionNumber===m.sessionNumber);f&&(f.isDeleted=!1,r=!0);break}case"category":{const h=Object.values(re).find(v=>v.info.scheduleCode===m.classId),f=h==null?void 0:h.categories.find(v=>v.id===m.categoryId);f&&(f.isDeleted=!1,r=!0);break}case"score":{const h=Object.values(re).find(u=>u.info.scheduleCode===m.classId),f=h==null?void 0:h.students.find(u=>u.identity.studentId===m.studentId),v=(g=f==null?void 0:f.logs.scores[m.skill.toLowerCase()])==null?void 0:g.find(u=>u.id===m.scoreId);v&&(v.isDeleted=!1,r=!0);break}case"note":{const h=Object.values(re).find(u=>u.info.scheduleCode===m.classId),f=h==null?void 0:h.students.find(u=>u.identity.studentId===m.studentId),v=f==null?void 0:f.profile.notes.find(u=>u.id===m.noteId);v&&(v.isDeleted=!1,r=!0);break}}r?(pe.splice(e,1),ce(),ln(),a.type==="classroom"&&Ue(),Y("✅ آیتم با موفقیت بازیابی شد.")):Y(d?`⚠️ ${d}`:"⚠️ آیتم اصلی برای بازیابی یافت نشد.")});const s=document.createElement("button");s.className="btn-icon",s.innerHTML="🔥",s.title="حذف دائمی",s.addEventListener("click",()=>{Ee("آیا از حذف دائمی این آیتم مطمئن هستید؟ این عمل غیرقابل بازgشت است.",()=>{const r=a.restoreData,d=g=>Object.values(re).find(h=>h.info.scheduleCode===g);let m;switch(a.type){case"classroom":delete re[r.name];break;case"student":m=d(r.classId),Mn({identity:{studentId:r.studentId}},m);break;case"session":m=d(r.classId),m&&vi(m.info.name,r.sessionNumber);break;case"category":m=d(r.classId),m&&bi(m.info.name,r.categoryId);break;case"score":m=d(r.classId),m&&Ci(m.info.name,r.studentId,r.skill,r.scoreId);break;case"note":m=d(r.classId),m&&wi(m.info.name,r.studentId,r.noteId);break}pe.splice(e,1),ce(),ln(),Y("✅ آیتم برای همیشه حذف شد.")},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),t.appendChild(i),t.appendChild(s),c.appendChild(o),c.appendChild(t),n.appendChild(c)})}function jr(){const n=document.getElementById("absentees-summary-container");n&&(n.innerHTML=`
        <div id="absentees-summary-box" class="absentees-summary">
            <div class="absentees-summary-header">
                <h4>لیست غایبین جلسه شماره <span id="absentee-summary-session-number"></span></h4>
                <button id="copy-absentees-btn" class="btn-icon" title="کپی لیست غایبین">📋</button>
            </div>
            <div id="absentees-summary-list" class="summary-list"></div>
        </div>
    `)}function ra(){const n=document.getElementById("absentees-summary-box"),a=document.getElementById("absentees-summary-list"),e=document.getElementById("absentee-summary-session-number");if(!n||!a||!e){console.error("Could not find all absentee summary elements.");return}if(!D||!J){n.classList.remove("visible");return}const c=Ie(D.students).filter(t=>{const i=J.studentRecords[t.identity.studentId];return i&&i.attendance==="absent"}),o=tt(D);e.textContent=o.get(J.sessionNumber),c.length>0?n.classList.add("visible"):n.classList.remove("visible"),a.innerHTML="",c.forEach(t=>{const s=(d=>D.sessions.reduce((m,g)=>{if(g.isDeleted||g.isCancelled)return m;const h=g.studentRecords[d.identity.studentId];return m+(h&&h.attendance==="absent"?1:0)},0))(t),r=document.createElement("span");r.className="summary-name",r.textContent=`${t.identity.name} (غیبت: ${s})`,r.addEventListener("click",()=>{r.classList.add("fading-out"),setTimeout(()=>{J.setAttendance(t.identity.studentId,"present"),ce(),at()},200)}),a.appendChild(r)})}function Zr(){const n=document.getElementById("copy-absentees-btn");if(!n){console.error("Could not find the copy absentees button to attach listener.");return}n.addEventListener("click",()=>{if(!D||!J)return;const a=Ie(D.students).filter(o=>{const t=J.studentRecords[o.identity.studentId];return t&&t.attendance==="absent"});if(a.length===0){Y("⚠️لیست غایبین خالی است.");return}const e=o=>D.sessions.reduce((t,i)=>{if(i.isDeleted||i.isCancelled)return t;const s=i.studentRecords[o.identity.studentId];return t+(s&&s.attendance==="absent"?1:0)},0);let c=`لیست غایبین جلسه شماره ${Ar()}:

`;a.forEach(o=>{const t=e(o);c+=`- ${o.identity.name} (تعداد غیبت‌ها: ${t})
`}),navigator.clipboard.writeText(c).then(()=>{Y("✅لیست غایبین با موفقیت کپی شد.")}).catch(o=>{console.error("Failed to copy text: ",o),Y("❌خطا در کپی کردن لیست.")})})}function In(){const n=document.getElementById("demo-mode-banner");n&&(lt?(n.classList.add("visible"),document.body.classList.add("demo-mode-active")):(n.classList.remove("visible"),document.body.classList.remove("demo-mode-active")))}function jn(n){const{scheduleDays:a,scheduleStartTime:e,scheduleEndTime:c}=n.info,o=a&&a.length>0,t=e&&c;if(!o&&!t)return{type:"unscheduled",sortIndex:3};if(!o||!t)return{type:"incomplete",sortIndex:2};const i=new Date,s=i.getDay(),r=i.getHours()*60+i.getMinutes(),[d,m]=e.split(":").map(Number),[g,h]=c.split(":").map(Number),f=d*60+m,v=g*60+h;if(a.includes(s)&&r>=f&&r<v)return{type:"active",sortIndex:0};for(let u=0;u<=7;u++){const b=(s+u)%7;if(a.includes(b)){if(u===0&&r>=f)continue;const y=new Date(i);return y.setDate(i.getDate()+u),y.setHours(d,m,0,0),{type:"upcoming",sortIndex:1,nextTimestamp:y.getTime()}}}return{type:"upcoming",sortIndex:1,nextTimestamp:9999999999999}}function qr(n,a){const{scheduleDays:e,scheduleStartTime:c,scheduleEndTime:o}=n.info;if(!e||!e.length||!c||!o)return null;const[t,i]=c.split(":").map(Number),[s,r]=o.split(":").map(Number),d=t*60+i,m=s*60+r;for(const g of Object.values(a)){if(g===n||g.isDeleted||g.info.name===n.info.name)continue;const h=g.info;if(!h.scheduleDays||!h.scheduleDays.length||!h.scheduleStartTime||!h.scheduleEndTime||!e.some(S=>h.scheduleDays.includes(S)))continue;const[v,u]=h.scheduleStartTime.split(":").map(Number),[b,y]=h.scheduleEndTime.split(":").map(Number),C=v*60+u,_=b*60+y;if(d<_&&m>C)return g.info.name}return null}function Gr(n){if(!n||n.length===0)return"";const a={6:"شنبه",0:"۱شنبه",1:"۲شنبه",2:"۳شنبه",3:"۴شنبه",4:"۵شنبه",5:"جمعه"};return[...n].sort((c,o)=>{const t={6:0,0:1,1:2,2:3,3:4,4:5,5:6};return t[c]-t[o]}).map(c=>a[c]).join("، ")}async function oa(){const n=document.getElementById("restore-points-list");n.innerHTML='<li style="text-align:center; padding:20px;">در حال بارگذاری...</li>';try{const a=await _a();if(a.length===0){n.innerHTML='<li style="text-align:center; padding:20px;">هیچ فایل پشتیبانی یافت نشد.</li>';return}n.innerHTML="",a.forEach(e=>{const c=document.createElement("li");c.className="restore-point-card";const o=new Date(e.timestamp).toLocaleString("fa-IR",{weekday:"long",year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"}),t=(e.file.size/1024).toFixed(1)+" KB";c.innerHTML=`
                <div class="restore-card-header">
                    <span class="restore-date">${o}</span>
                    <span class="restore-size">${t}</span>
                </div>
                <div class="restore-desc">${e.metadata.description||"بدون توضیحات"}</div>
                <div class="restore-actions">
                    <button class="btn-restore-action">بازگردانی</button>
                </div>
            `,c.querySelector(".btn-restore-action").addEventListener("click",async()=>{try{const s=await e.file.text(),m=(await new ks().loadAsync(s,{base64:!0})).file("backup.json");if(!m)throw new Error("فایل backup.json یافت نشد.");const g=await m.async("string"),h=JSON.parse(g);Un(h)}catch(s){console.error("Restore failed:",s),Y("❌ فایل پشتیبان معتبر نیست.")}}),n.appendChild(c)})}catch(a){console.error("Failed to load snapshots:",a),n.innerHTML='<li style="text-align:center; color:red;">خطا در بارگذاری اطلاعات.</li>'}}const Vr=Object.freeze(Object.defineProperty({__proto__:null,_internalShowPage:tn,addCategoryBtn:Va,addClassBtn:Na,addNoteModal:or,addScoreBtn:mr,addStudentBtn:za,appHeader:fs,attendanceListUl:Yt,attendanceMassActionsContainer:En,attendancePage:Ja,attendancePane:Ft,attendanceSearchInput:_t,backToSessionsBtn:Ma,backToStudentPageBtn:dr,backupDataBtn:nr,breadcrumbContainer:At,cancelImportBtn:qa,cancelNoteBtn:lr,categoryListUl:ls,categoryModal:_r,categoryModalCancelBtn:kr,categoryModalSaveBtn:Gi,categoryModalTitle:qi,classListHeader:Ya,classListUl:Mt,classManagementPage:$i,classSaveNoteBtn:cr,closeActiveModal:we,closeContextMenu:kt,closeNavBtn:er,columnMappingPage:ja,columnSelectDropdown:us,confirmColumnBtn:Za,confirmModalCancelBtn:hs,confirmModalConfirmBtn:qt,confirmModalMessage:Wi,contextMenu:It,csvCancelBtn:Ha,csvConfirmBtn:Pa,csvFileInput:Ua,csvPreviewList:ds,csvPreviewPage:Fa,customConfirmModal:ir,displayWinner:Re,finishAttendanceBtn:Ka,globalStudentSearchInput:Gt,globalStudentSearchResultsDiv:ot,gradedCategoryPillsContainer:ur,hamburgerMenuBtn:Xa,handleUndo:Ki,importCsvBtn:Wa,initiateBackupProcess:cn,isGradedCheckbox:gr,massCommentAppendCheckbox:Zs,massCommentBtn:ys,massCommentCancelBtn:xr,massCommentContent:en,massCommentModal:Sr,massCommentModalTitle:Ir,massCommentSaveBtn:Lr,massCommentStudentCountMessage:Vi,newCategoryModalIsGradedCheckbox:js,newCategoryModalNameInput:Qt,newCategoryNameInput:Ga,newClassNameInput:Da,newNoteContent:_e,newScoreCommentTextarea:Zi,newScoreValueInput:fr,newStudentNameInput:Ra,openContextMenu:dn,openModal:Fe,overlay:tr,pasteArea:Pi,processMassHomeworkComment:bs,processPasteBtn:$a,profileScoresListUl:pr,profileStatsSummaryDiv:hr,quickGradeFormWrapper:Ot,quickGradeSubmitBtn:St,quickNoteTextarea:st,quickScoreInput:dt,renderAttendancePage:at,renderBreadcrumbs:Qi,renderClassList:Ue,renderClassManagementStats:Jn,renderColumnSelector:ia,renderGlobalSearchResults:Sn,renderImportPreview:_s,renderLogModal:Xi,renderMassCommentControls:Vs,renderRestorePointsPage:oa,renderScoresHistory:na,renderSearchResults:Jt,renderSessionDashboard:Pt,renderSessions:We,renderSettingsCategories:Ht,renderSettingsOther:aa,renderSettingsStudentList:ut,renderStudentNotes:sa,renderStudentStatsList:ze,renderTrashPage:ln,restoreDataBtn:sr,restoreFileInput:Hi,secureConfirmCancelBtn:rr,secureConfirmCode:ji,secureConfirmConfirmBtn:wn,secureConfirmInput:Nt,secureConfirmMessage:Ui,secureConfirmModal:ar,selectStudentBtn:it,selectStudentBtnWrapper:$t,sessionDashboardPage:Tr,setAutoDirectionOnInput:ea,settingsClassNameHeader:Us,settingsPage:Oa,settingsStudentListUl:cs,setupDashboardTabs:Ji,setupLongPress:Vt,showCategoryModal:vs,showClassNoteModal:Vn,showCustomConfirm:Ee,showMassCommentModal:Js,showMoveStudentModal:qs,showNotification:Y,showPage:ge,showRenameStudentModal:Gs,showRestoreConfirmModal:Un,showSecureConfirm:Yi,showSessionNoteModal:Ks,showSettingsPage:zt,showStudentProfile:$e,showUndoToast:Br,sideNavMenu:Qa,studentSearchInput:ps,studentSearchResultsDiv:pt,studentStatsHeader:ms,switchDashboardTab:on,trashedCategoriesList:Cr,trashedClassesList:yr,trashedNotesList:wr,trashedScoresList:Er,trashedSessionsList:br,trashedStudentsList:vr,triggerFileDownload:Cs,undoBtn:Aa,undoMessage:Fi,undoToast:Wn,updateDemoModeBanner:In},Symbol.toStringTag,{value:"Module"}));function Jr(){const n=window.location.hash;if(!n||n==="#")return!1;const[a,e]=n.split("?"),c=a.substring(1),o=new URLSearchParams(e),t=o.get("class"),i=parseInt(o.get("session"),10),s=o.get("student"),r=o.get("tab")||"selector";if(t&&re[t])He(re[t]),i&&D.getSession(i)&&qe(D.getSession(i)),s&&D.students.find(d=>d.identity.studentId===s)&&Je(D.students.find(d=>d.identity.studentId===s));else return!1;switch(c){case"session-page":We(),ge("session-page");break;case"session-dashboard-page":Pt(c==="attendance-page"?"attendance":r);break;case"settings-page":Us.textContent=`تنظیمات کلاس: ${D.info.name}`,ut(),Ht(),ge("settings-page");break;case"student-profile-page":Pt(r),$e(Se);break;default:return!1}return!0}document.addEventListener("DOMContentLoaded",()=>{const{globalStudentSearchInput:n,newClassNameInput:a,addClassBtn:e,undoBtn:c,newStudentNameInput:o,addStudentBtn:t,pasteArea:i,processPasteBtn:s,csvPreviewList:r,csvConfirmBtn:d,csvCancelBtn:m,importCsvBtn:g,csvFileInput:h,columnSelectDropdown:f,confirmColumnBtn:v,cancelImportBtn:u,newCategoryNameInput:b,addCategoryBtn:y,selectStudentBtn:C,attendancePage:_,finishAttendanceBtn:S,classListHeader:I,studentStatsHeader:x,hamburgerMenuBtn:L,sideNavMenu:N,closeNavBtn:R,overlay:P,backupDataBtn:Q,restoreDataBtn:k,restoreFileInput:z,confirmModalCancelBtn:p,confirmModalConfirmBtn:H,secureConfirmCancelBtn:ue,secureConfirmConfirmBtn:j,newNoteContent:fe,classSaveNoteBtn:F,cancelNoteBtn:ne,studentSearchInput:O,studentSearchResultsDiv:M,isGradedCheckbox:oe,categoryModalSaveBtn:te,categoryModalCancelBtn:X,massCommentBtn:De,massCommentCancelBtn:Oe,massCommentSaveBtn:he,massCommentContent:be,massCommentAppendCheckbox:Te,attendanceSearchInput:Ae}=Vr,Ye=document.getElementById("trash-nav-btn");document.querySelector(".global-search-container .search-icon"),On(),In(),Jr()||(Ue(),ge("class-management-page"));function l(B,q){const U=document.querySelector(B);if(!U)return;const ee=U.querySelector(".search-icon"),se=U.querySelector(".animated-search-input");!ee||!se||(ee.addEventListener("mousedown",me=>{me.preventDefault()}),ee.addEventListener("click",()=>{U.classList.contains("search-active")||(U.classList.add("search-active"),se.focus())}),se.addEventListener("blur",()=>{setTimeout(()=>{U.classList.remove("search-active"),se.value="",q&&q([])},150)}))}Ae.addEventListener("input",()=>{const B=Ae.value.toLowerCase().trim(),q=ss(B);Yt.querySelectorAll(".attendance-list-item").forEach(ee=>{const se=ee.querySelector(".student-name");if(se){const me=se.textContent,ae=et(me.toLowerCase()),de=ae.includes(et(B)),Ce=ae.includes(et(q));de||Ce?ee.style.display="flex":ee.style.display="none"}})}),X.addEventListener("click",()=>{we(),qn(null)}),te.addEventListener("click",()=>{const B=Qt.value.trim(),q=js.checked;typeof Dn=="function"&&Dn(B,q)}),window.addEventListener("scroll",kt),document.addEventListener("click",B=>{It.classList.contains("visible")&&!It.contains(B.target)&&kt(),O.contains(B.target)||(M.style.display="none");const q=B.target.closest(".log-action-link");if(q&&q.dataset.action)try{const U=JSON.parse(q.dataset.action);Tt(U)}catch(U){console.error("Could not parse log action:",U)}}),$t.addEventListener("click",()=>{($t.classList.contains("disabled-wrapper")||it.disabled)&&(it.classList.add("shake-animation"),setTimeout(()=>{it.classList.remove("shake-animation")},200))}),x.addEventListener("click",()=>{const B=new Date().getTime();B-Ts>500?Cn(1):Cn(Tn+1),xi(B),Tn===5&&(Cn(0),Ee("آیا از صفر کردن تمام شمارنده‌های دانش‌آموزان مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{yi(),ze(),Y("تمام آمارها صفر شدند ✅.")},{confirmText:"بله",confirmClass:"btn-warning"}))}),I.addEventListener("click",()=>{const B=new Date().getTime();B-Ls>500?bn(1):bn(Ln+1),Ii(B),Ln===5&&(bn(0),Ee("آیا از ساخت یک کلاس تستی تصادفی مطمئن هستید؟",()=>{function q(){const U=`کلاس تستی ${Object.keys(re).length+1}`,ee=new as({name:U,type:"online"});["علی رضایی","مریم حسینی","زهرا احمدی","رضا محمدی","فاطمه کریمی"].forEach(me=>ee.addStudent(new yn({name:me}))),re[U]=ee,ce(),Ue()}q(),Y("کلاس تستی با موفقیت ساخته شد ✅!")},{confirmText:"بساز",confirmClass:"btn-success"}))}),ue.addEventListener("click",()=>{we(),an(null)});const W=document.getElementById("date-picker-confirm-btn"),$=document.getElementById("date-picker-cancel-btn"),E=document.getElementById("dp-day"),w=document.getElementById("dp-month"),T=document.getElementById("dp-year");W.addEventListener("click",()=>{const B=T.value,q=w.value,U=E.value;B&&q&&U&&typeof An=="function"?(An({jy:B,jm:q,jd:U}),we()):Y("⚠️ خطا در انتخاب تاریخ."),Fn(null)}),$&&$.addEventListener("click",()=>{we(),Fn(null)}),j.addEventListener("click",()=>{typeof Bn=="function"&&Bn(),we(),an(null)}),p.addEventListener("click",()=>{we(Ds)}),H.addEventListener("click",()=>{we(Bs)}),C.addEventListener("click",()=>{if(dt.value.trim()!==""||st.value.trim()!==""){Y("⚠️لطفاً ابتدا با دکمه «ثبت»، تغییرات را ذخیره کنید و یا نمره و یادداشت را پاک کنید.");return}if(!D||!J||!Ve)return;const B=D.selectNextWinner(Ve.name,J);if(B){const q=J.studentRecords[B.identity.studentId];if(q&&q.attendance==="absent"&&B.statusCounters.missedChances++,q&&q.hadIssue){B.statusCounters.missedChances++;const ee=Ve.name;B.categoryIssues[ee]=(B.categoryIssues[ee]||0)+1}q&&q.wasOutOfClass&&(B.statusCounters.outOfClassCount=(B.statusCounters.outOfClassCount||0)+1,B.statusCounters.missedChances++);const U={winner:B,categoryName:Ve.name};J.winnerHistory.push(U),J.winnerHistory.length>10&&J.winnerHistory.shift(),bt(J.winnerHistory.length-1),J.lastUsedCategoryId=Ve.id,J.lastSelectedWinnerId=B.identity.studentId,ze(),setTimeout(()=>Re(),0),ce()}else Y("❌دانش‌آموز واجد شرایطی برای انتخاب یافت نشد.")}),y.addEventListener("click",()=>{if(!D)return;const B=b.value.trim(),q=oe.checked;if(!B){alert("⚠️لطفاً نام دسته‌بندی را وارد کنید.");return}const U=D.categories.find(se=>se.name.toLowerCase()===B.toLowerCase());if(U)if(U.isDeleted){const se=D.categories.findIndex(me=>me===U);se>-1&&D.categories.splice(se,1)}else{alert("⚠️این دسته‌بندی از قبل وجود دارد.");return}const ee=new ft(B,"",q);D.categories.push(ee),ce(),ke(D.info.name,`دسته‌بندی جدید «${B}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),Ht(),b.value="",oe.checked=!1}),document.querySelectorAll('#settings-page input[name="class-type-setting"]').forEach(B=>{B.addEventListener("change",()=>{if(!D)return;const q=B.value,U=D.info.type||"in-person";if(q===U)return;const ee=ae=>ae==="online"?"آنلاین":"حضوری",se=ee(U),me=ee(q);Ee(`آیا از تغییر نوع کلاس از «${se}» به «${me}» مطمئن هستید؟`,()=>{D.info.type=q,ce(),ke(D.info.name,`نوع کلاس به «${me}» تغییر یافت.`,{type:"VIEW_CLASS_SETTINGS"}),Ue(),Y(`✅ نوع کلاس به «${me}» تغییر یافت.`)},{confirmText:"بله",confirmClass:"btn-warning",onCancel:()=>{const ae=document.querySelector(`#settings-page input[name="class-type-setting"][value="${U}"]`);ae&&(ae.checked=!0)}})})});const G=document.querySelectorAll('input[name="schedule-day"]'),A=document.getElementById("settings-schedule-start"),V=document.getElementById("settings-schedule-end");G.forEach(B=>{B.addEventListener("change",()=>{if(!D)return;const q=Array.from(G).filter(U=>U.checked).map(U=>parseInt(U.value));D.info.scheduleDays=q,ce()})});const ie=()=>{D&&(D.info.scheduleStartTime=A.value,D.info.scheduleEndTime=V.value,ce())};A.addEventListener("change",ie),V.addEventListener("change",ie),b.addEventListener("keyup",B=>{B.key==="Enter"&&y.click()}),v.addEventListener("click",()=>{if(!xn){alert("❌خطایی رخ داده است. لطفاً فایل را دوباره انتخاب کنید."),ge("settings-page");return}const B=parseInt(f.value,10),ee=xn.split(`
`).slice(1).map(se=>{var ae;return(ae=se.split(",")[B])==null?void 0:ae.trim()}).filter(se=>se&&se.length>0);ee.length>0?(Zt(ee),_s(),ge("csv-preview-page")):alert("هیچ نامی در ستون انتخاب شده پیدا نشد. لطفاً ستون دیگری را امتحان کنید یا فایل خود را بررسی کنید."),vn(null)}),g.addEventListener("click",()=>{h.click()}),h.addEventListener("change",B=>{const q=B.target.files[0];if(!q)return;const U=new FileReader;U.onload=ee=>{const se=ee.target.result;vn(se);const ae=se.split(`
`)[0].split(",");ia(ae),ge("column-mapping-page")},U.readAsText(q),B.target.value=null}),u.addEventListener("click",()=>{vn(null),ge("settings-page")}),d.addEventListener("click",()=>{const B=r.querySelectorAll('input[type="checkbox"]:checked');let q=!1;B.forEach(U=>{const ee=U.dataset.name,se=D.students.find(de=>de.identity.name.toLowerCase()===ee.toLowerCase());if(se)if(se.isDeleted)Mn(se,D);else{console.log(`دانش‌آموز «${ee}» به دلیل تکراری بودن اضافه نشد.`);return}const me=os(ee),ae=new yn(me);D.addStudent(ae),D.sessions.length>0&&(Ie(D.sessions).filter(de=>de.isFinished&&!de.isCancelled).forEach(de=>{de.setAttendance(ae.identity.studentId,"absent")}),Qe(ae,D),q=!0)}),ce(),ke(D.info.name,`${B.length} دانش‌آموز جدید از لیست ورودی به کلاس اضافه شدند.`,{type:"VIEW_SESSIONS"}),ut(),q&&Wt(B.length),ge("settings-page"),i.value="",Zt([])}),m.addEventListener("click",()=>{Zt([]),ge("settings-page")}),s.addEventListener("click",()=>{const B=i.value.trim();if(!B){alert("کادر متنی خالی است. لطفاً اسامی را وارد کنید.");return}const q=B.split(`
`).map(U=>U.trim()).filter(U=>U.length>0);q.length>0?(Zt(q),_s(),ge("csv-preview-page")):alert("هیچ نام معتبری برای ورود پیدا نشد.")}),o.addEventListener("keyup",B=>{B.key==="Enter"&&t.click()}),t.addEventListener("click",()=>{if(!D)return;const B=o.value.trim();if(!B){alert("لطفاً نام دانش‌آموز را وارد کنید.");return}const q=D.students.find(se=>se.identity.name.toLowerCase()===B.toLowerCase());if(q)if(q.isDeleted)Mn(q,D);else{alert("❌دانش‌آموزی با این نام از قبل در این کلاس وجود دارد.");return}const U=os(B),ee=new yn(U);D.addStudent(ee),D.sessions.length>0&&(Ie(D.sessions).filter(se=>se.isFinished&&!se.isCancelled).forEach(se=>{se.setAttendance(ee.identity.studentId,"absent")}),Qe(ee,D),Wt(1)),ce(),ke(D.info.name,`دانش‌آموز «${B}» به کلاس اضافه شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:ee.identity.studentId}),ut(),ze(),o.value="",o.focus()}),document.getElementById("new-session-btn").addEventListener("click",()=>{if(D){const B=D.sessions.find(U=>!U.isFinished&&!U.isCancelled&&!U.isDeleted);if(B){Y(`⚠️ جلسه ${B.sessionNumber} هنوز تمام نشده است. لطفاً ابتدا با دکمه ✅ آن را خاتمه دهید.`);return}const q=()=>{const U=ee=>{const se=D.startNewSession();sn(se),qe(se),D.students.forEach(de=>{Ss.setAttendance(de.identity.studentId,"present")}),ce();const ae=tt(D).get(se.sessionNumber);ke(D.info.name,`جلسه ${ae} شروع شد.`,{type:"VIEW_SESSIONS"}),Pt(ee?"attendance":"selector")};Ee("آیا تمایل به انجام فرآیند حضور و غیاب دارید؟",()=>U(!0),{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success",onCancel:()=>U(!1)})};D.hasSessionToday()?Ee("شما امروز یک جلسه برای این کلاس ثبت کرده‌اید. آیا از شروع یک جلسه جدید دیگر مطمئن هستید؟",q,{confirmText:"بله",confirmClass:"btn-warning"}):q()}}),e.addEventListener("click",()=>{const B=a.value.trim(),q=document.querySelector('input[name="class-type"]:checked');if(!B&&!q){Y("⚠️لطفاً نام و نوع کلاس را مشخص کنید.");return}if(!B){Y("⚠️لطفاً نام کلاس را وارد کنید.");return}if(!q){Y("⚠️لطفاً نوع کلاس را انتخاب کنید.");return}if(re[B]){re[B].isDeleted?Y("⚠️ کلاسی با این نام در سطل زباله است. ابتدا آن را بازیابی کنید و یا آن را پاک کنید."):Y("⚠️کلاسی با این نام از قبل وجود دارد.");return}const U=q.value,ee=new as({name:B,type:U});re[B]=ee,ce(),ke(B,`کلاس «${B}» ایجاد شد.`,{type:"VIEW_SESSIONS"}),Ue(),Y(`✅ کلاس «${B}» با موفقیت ایجاد شد.`),a.value="",q.checked=!1}),n.addEventListener("input",B=>{const q=B.target.value;if(q.length<2){Sn([]);return}const U=q.toLowerCase(),ee=ss(U),se=[];for(const me in re){const ae=re[me];if(ae.isDeleted)continue;const de=et(me.toLowerCase()),Ce=de.includes(et(U)),xe=de.includes(et(ee));(Ce||xe)&&se.push({type:"classroom",classroom:ae})}for(const me in re){const ae=re[me];if(ae.isDeleted)continue;Ie(ae.students).filter(Ce=>{const xe=et(Ce.identity.name.toLowerCase()),Me=xe.includes(et(U)),Ut=xe.includes(et(ee));return Me||Ut}).forEach(Ce=>{se.push({type:"student",student:Ce,classroom:ae})})}Sn(se)}),a.addEventListener("keyup",B=>{B.key==="Enter"&&e.click()}),c.addEventListener("click",Ki),S.addEventListener("click",()=>{on("selector")}),O.addEventListener("input",B=>{const q=B.target.value;if(!q){Jt([]);return}const U=q.toLowerCase(),ee=ss(U),me=Ie(D.students).filter(ae=>{const de=et(ae.identity.name.toLowerCase()),Ce=de.includes(et(U)),xe=de.includes(et(ee));return Ce||xe});Jt(me)}),O.addEventListener("focus",()=>{O.value&&Jt(O.value)}),St.addEventListener("click",()=>{const B=dt.value,q=st.value.trim();let U;if(Nn)U=Nn.student;else{const se=J==null?void 0:J.winnerHistory[Ze];U=se==null?void 0:se.winner}if(!U){Y("❌خطا: دانش‌آموز معتبری برای ثبت نمره یافت نشد.");return}const ee=Ve;if(!U||!ee){Y("⚠️لطفاً ابتدا یک دانش‌آموز و یک دسته‌بندی را انتخاب کنید.");return}if(!B){Y("⚠️لطفاً مقدار نمره را وارد کنید.");return}if(B>100||B<0){Y("❌نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}U&&(U.addScore(ee.name,parseFloat(B),q),ke(D.info.name,`نمره ${B} در ${ee.name} برای «${U.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:U.identity.studentId}),ce(),ze(),Y(`✅نمره برای ${U.identity.name} در مهارت ${ee.name} ثبت شد.`),dt.value="",st.value="",Re())});const K=B=>{B.key==="Enter"&&B.ctrlKey&&(B.preventDefault(),St.click())};dt.addEventListener("keydown",K),st.addEventListener("keydown",K),ne.addEventListener("click",()=>{we()}),F.addEventListener("click",()=>{const B=fe.value.trim(),q=Ns;if(typeof q=="function"){const U=q(B);if(U===!1)return;we(()=>{typeof U=="function"&&U()})}else we()});const le=document.getElementById("move-student-confirm-btn"),Le=document.getElementById("move-student-cancel-btn"),ye=document.getElementById("move-student-class-select");Le.addEventListener("click",()=>{we()}),le.addEventListener("click",()=>{const B=ye.value,q=re[B],{studentToMove:U,sourceClassForMove:ee}=ba;if(!U||!ee||!q){Y("خطایی رخ داد. لطفاً دوباره امتحان کنید⚠️.","error"),we();return}const se=gi(U,ee,q);se.success?(ke(ee.info.name,`دانش‌آموز «${U.identity.name}» به کلاس «${B}» منتقل شد.`,{type:"VIEW_SESSIONS"}),ke(B,`دانش‌آموز «${U.identity.name}» از کلاس «${ee.info.name}» به این کلاس منتقل شد.`,{type:"VIEW_SESSIONS"}),ce(),ut(),ze(),at(),Y(`دانش‌آموز «${U.identity.name}» با موفقیت به کلاس «${B}» منتقل شد✅.`)):Y(se.message,"error"),we()}),L.addEventListener("click",()=>{N.style.width="300px",P.classList.add("modal-visible")}),L.addEventListener("click",()=>{N.style.width="300px",P.classList.add("modal-visible")});const je=document.getElementById("header-settings-btn");je&&je.addEventListener("click",()=>{D&&zt(D)}),R.addEventListener("click",ve),R.addEventListener("click",ve),P.addEventListener("click",ve),Ye.addEventListener("click",()=>{ln(),ge("trash-page"),ve()});const mt=document.getElementById("restore-points-nav-btn");mt&&mt.addEventListener("click",()=>{oa(),ge("restore-points-page"),ve()}),document.getElementById("demo-mode-btn").addEventListener("click",()=>{lt?Ct():(ve(),Ee("شما در حال ورود به حالت نمایش (Demo) هستید. در این حالت، هیچ‌کدام از تغییرات شما ذخیره نخواهد شد. آیا ادامه می‌دهید؟",()=>{Ei(),In(),ve()},{confirmText:"تایید",confirmClass:"btn-warning",onCancel:ve}))});const ht=document.getElementById("exit-demo-btn");ht&&ht.addEventListener("click",()=>{lt&&Ct()}),Q.addEventListener("click",()=>{if(lt){Y("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است."),ve();return}ve(),cn()}),k.addEventListener("click",()=>{if(lt){Y("⚠️ بازیابی اطلاعات در حالت نمایش (Demo) غیرفعال است."),ve();return}z.click(),ve()}),z.addEventListener("change",B=>{const q=B.target.files[0];if(!q)return;const U=new FileReader;U.onload=async ee=>{const se=ee.target.result;try{const me=JSON.parse(se);if(me.metadata&&me.data)Un(me);else{const ae=me.classrooms||me,de=me.trashBin||[];Ee("آیا از بازیابی اطلاعات مطمئن هستید؟ تمام داده‌های فعلی شما بازنویسی خواهد شد.",()=>{Lt(ae),zs(de),Kt({lastRestoreTimestamp:new Date().toISOString()}),ce(),Ue(),ge("class-management-page"),Y("✅اطلاعات با موفقیت بازیابی شد.")},{confirmText:"بازیابی کن",confirmClass:"btn-warning"})}}catch{try{const Ce=(await new ks().loadAsync(se,{base64:!0})).file("backup.json");if(!Ce)throw new Error("فایل backup.json در فایل پشتیبان یافت نشد.");const xe=await Ce.async("string"),Me=JSON.parse(xe);if(Me.metadata&&Me.metadata.version==="2.0-b64")Un(Me);else throw new Error("فایل پشتیبان معتبر نیست (نسخه نامشخص).")}catch(ae){Y("❌خطا در خواندن فایل. لطفاً فایل پشتیبان معتبر انتخاب کنید."),console.error("Restore error (zip/base64):",ae)}}},U.readAsText(q),B.target.value=null}),window.addEventListener("popstate",B=>{if(vt){we(null,!0);return}if(kt(),B.state){const{pageId:q,currentClassName:U,selectedSessionNumber:ee,selectedStudentId:se}=B.state;U&&(He(re[U]),ee&&qe(D.getSession(ee)),se&&Je(D.students.find(me=>me.identity.studentId===se))),q==="session-page"?(We(),tn(q)):q==="student-profile-page"?(We(),ge("session-page"),$e(Se)):tn(q)}else He(null),qe(null),Je(null),tn("class-management-page")}),document.addEventListener("keydown",B=>{var ee;const q=document.activeElement;if(!["INPUT","TEXTAREA","SELECT"].includes(q.tagName)){if(B.key.toLowerCase()==="o"&&B.shiftKey&&$i.classList.contains("active")&&(B.preventDefault(),Hi.click()),B.key==="Escape"){if(It.classList.contains("visible")){kt();return}if(vt){we();return}switch((ee=document.querySelector(".page.active"))==null?void 0:ee.id){case"csv-preview-page":case"column-mapping-page":ge("settings-page");break;case"student-profile-page":Je(null),ge(J?"student-page":"session-page");break;case"attendance-page":ge("student-page");break;case"student-page":qe(null),We(),ge("session-page");break;case"settings-page":case"session-page":He(null),ge("class-management-page");break}return}if(J){const se=B.key.toLowerCase();switch(" ascfg".includes(se)&&B.preventDefault(),se){case" ":C.click();break;case"a":_.classList.contains("active")?history.back():(at(),ge("attendance-page"));break;case"s":document.getElementById("session-page").classList.contains("active")&&history.back();break;case"c":document.querySelector(".back-to-classes-btn").click();break;case"f":const me=document.querySelector(".action-column .search-icon");me&&me.click();break;case"g":if(studentProfilePage.classList.contains("active"))history.back();else{const ae=J.lastSelectedWinnerId;if(ae){const de=D.students.find(Ce=>Ce.identity.studentId===ae);de&&(Je(de),(void 0)(),ge("student-profile-page"))}else Y("⚠️ابتدا یک نفر را انتخاب کنید تا پروفایل او نمایش داده شود.")}break;case"arrowleft":{const ae=document.querySelector('button[title="برنده قبلی"]');ae&&!ae.disabled&&(B.preventDefault(),ae.click());break}case"arrowright":{const ae=document.querySelector('button[title="برنده بعدی"]');ae&&!ae.disabled&&(B.preventDefault(),ae.click());break}}}}});function ve(){N.style.width="0",P.classList.add("modal-closing"),setTimeout(()=>{P.classList.remove("modal-visible","modal-closing")},300)}function Ct(){Ee("آیا از خروج از حالت نمایش (Demo) مطمئن هستید؟ با خروج، تمام تغییرات آزمایشی شما حذف شده و داده‌های اصلی شما بازیابی خواهند شد.",()=>{_i(),He(null),qe(null),Je(null),Ue(),ge("class-management-page"),In(),ve()},{confirmText:"خروج",confirmClass:"btn-success"})}l(".global-search-container .animated-search-container",Sn),l(".action-column-header .animated-search-container",Jt),Yr(),[_e,Zi,st,Pi].forEach(B=>{B&&ea(B)});function Qe(B,q){const U=Ie(q.students).filter(Be=>Be.identity.studentId!==B.identity.studentId);if(U.length===0)return;const ee=U.reduce((Be,Pe)=>Pe.statusCounters.totalSelections>Be.statusCounters.totalSelections?Pe:Be,U[0]);if(!ee||ee.statusCounters.totalSelections===0)return;B.categoryCounts=JSON.parse(JSON.stringify(ee.categoryCounts)),B.statusCounters.totalSelections=ee.statusCounters.totalSelections;const se=U.reduce((Be,Pe)=>Be+Pe.statusCounters.totalSelections,0),me=U.reduce((Be,Pe)=>Be+(Pe.statusCounters.missedChances||0),0),ae=se>0?me/se:0;B.statusCounters.missedChances=Math.round(B.statusCounters.totalSelections*ae);const de=Ie(q.categories),Ce={};de.forEach(Be=>{const Pe=U.reduce((ts,ns)=>ts+(ns.categoryCounts[Be.name]||0),0),es=U.reduce((ts,ns)=>ts+(ns.categoryIssues[Be.name]||0),0);Ce[Be.name]=Pe>0?es/Pe:0}),de.forEach(Be=>{const Pe=B.categoryCounts[Be.name]||0,es=Ce[Be.name]||0;B.categoryIssues[Be.name]=Math.round(Pe*es)});const xe=q.liveSession;xe?B.onboardingSession=xe.sessionNumber:B.onboardingSession=q.sessions.length+1;const Me=Ie(q.sessions).filter(Be=>Be.isFinished&&!Be.isCancelled),Ut="📝 یادداشت خودکار سیستم",ua=`این دانش‌آموز  از جلسه شماره ${Me.length} به کلاس اضافه شد. آمار مشارکت او بر اساس فعال‌ترین دانش‌آموز و آمار «فرصت از دست رفته» او بر اساس میانگین کلاس ثبت گردید:`,Bt=[];B.statusCounters.totalSelections>0&&Bt.push(`کل انتخاب‌ها: ${B.statusCounters.totalSelections}`),B.statusCounters.missedChances>0&&Bt.push(`فرصت‌های از دست رفته: ${B.statusCounters.missedChances}`);for(const Be in B.categoryCounts){const Pe=B.categoryCounts[Be];Pe>0&&Bt.push(`انتخاب در «${Be}»: ${Pe}`)}for(const Be in B.categoryIssues){const Pe=B.categoryIssues[Be];Pe>0&&Bt.push(`مشکل در «${Be}»: ${Pe}`)}if(Bt.length>0){const Be=`${Ut}
${ua}

- ${Bt.join(`
- `)}`;B.addNote(Be)}}function Wt(B){const U=`چون این کلاس جلسات برگزار شده دارد، برای ${B>1?"دانش‌آموزان جدید":"دانش‌آموز جدید"} آمار پایه‌ای (متناسب با سایر دانش‌آموزان) ثبت شد تا در فرایند انتخاب اختلالی ایجاد نشود.`;Ee(U,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}const Kn="14.1.0",Yn="770";{const B=` (ساخت ${Yn})`;document.getElementById("app-version").textContent=`نسخه ${Kn}${B}`}function Xn(){console.log("Starting universal backfill for writing scores...");let B=0;for(const q in re){const U=re[q];if(U.isDeleted)continue;let ee=0;Ie(U.students).forEach(me=>{const ae=me.logs.scores;if(!(ae&&ae.writing&&ae.writing.length>0)){let Ce=-1;for(const xe in ae)xe!=="writing"&&ae[xe].forEach(Me=>{Me.value>Ce&&(Ce=Me.value)});if(Ce>-1){const xe=`Automatically assigned based on the highest score (${Ce}) from other skills.`;me.addScore("Writing",Ce,xe),ee++}}}),ee>0&&(console.log(`Updated ${ee} student(s) in class: ${U.info.name}.`),B+=ee)}B>0?(ce(),console.log(`Update complete. A total of ${B} student(s) were updated across all classes. Data saved.`),document.getElementById("student-page").classList.contains("active")&&ze()):console.log("No students needed updating in any class.")}window.backfillWritingScoresForAll=Xn;function fn(){console.log("Starting backfill for 'outOfClassCount' and 'wasOutOfClass' properties...");let B=0,q=0;const U=localStorage.getItem("teacherAssistantData_v2");if(!U){console.log("No data found in localStorage. Nothing to do.");return}const ee=JSON.parse(U);for(const se in ee){const me=ee[se];me.students&&me.students.forEach(ae=>{ae.statusCounters&&typeof ae.statusCounters.outOfClassCount>"u"&&(ae.statusCounters.outOfClassCount=0,B++)}),me.sessions&&me.sessions.forEach(ae=>{if(ae.studentRecords)for(const de in ae.studentRecords){const Ce=ae.studentRecords[de];typeof Ce.wasOutOfClass>"u"&&(Ce.wasOutOfClass=!1,q++)}})}localStorage.setItem("teacherAssistantData_v2",JSON.stringify(ee)),console.log(`Backfill complete. Updated ${B} students and ${q} session records. Data saved.`),On(),D&&ze()}window.backfillExitCounters=fn;function wt(){console.log("🧹 Starting orphaned data cleanup...");let B=0;for(const q in re){const U=re[q];if(U.isDeleted)continue;let ee=!1;const se=new Set(U.students.filter(de=>!de.isDeleted).map(de=>de.identity.studentId)),me=new Map(U.students.map(de=>[de.identity.studentId,de.identity.name])),ae=[];U.sessions.forEach(de=>{if(de.isDeleted)return;const Ce=[];for(const xe in de.studentRecords)if(!se.has(xe)){const Me=me.get(xe)||"Unknown/Deleted";Ce.push(`  - Removed student record for: ${Me} (ID: ${xe})`),delete de.studentRecords[xe],B++,ee=!0}for(const xe in de.lastWinnerByCategory){const Me=de.lastWinnerByCategory[xe];if(!se.has(Me)){const Ut=me.get(Me)||"Unknown/Deleted";Ce.push(`  - Removed '${xe}' last winner: ${Ut} (ID: ${Me})`),delete de.lastWinnerByCategory[xe],B++,ee=!0}}if(de.lastSelectedWinnerId&&!se.has(de.lastSelectedWinnerId)){const xe=de.lastSelectedWinnerId,Me=me.get(xe)||"Unknown/Deleted";Ce.push(`  - Cleared 'lastSelectedWinnerId': ${Me} (ID: ${xe})`),de.lastSelectedWinnerId=null,B++,ee=!0}if(Ce.length>0){const Me=tt(U).get(de.sessionNumber)||`(#${de.sessionNumber})`;ae.push({sessionDisplayNumber:Me,logs:Ce})}}),ee&&(console.group(`➡️ Class: ${q}`),ae.forEach(de=>{console.groupCollapsed(`  Session ${de.sessionDisplayNumber}`),de.logs.forEach(Ce=>console.warn(Ce)),console.groupEnd()}),console.groupEnd())}B>0?(ce(),console.log(`✅ Cleanup complete! Found and removed ${B} orphaned references. Data saved.`)):console.log("✅ No orphaned data found. Your data is clean!")}window.cleanupOrphanedData=wt;function Tt(B){if(!B||!B.classroomName)return;const q=re[B.classroomName];if(!q){Y("⚠️ کلاس مربوط به این گزارش یافت نشد.");return}He(q),we(),setTimeout(()=>{switch(B.type){case"VIEW_STUDENT_PROFILE":{const U=q.students.find(ee=>ee.identity.studentId===B.studentId);U?$e(U):Y("⚠️ دانش‌آموز مورد نظر یافت نشد.");break}case"VIEW_TRASH":ln(),ge("trash-page");break;case"VIEW_SESSIONS":We(),ge("session-page");break;case"VIEW_CLASS_NOTE":Vn(q);break;case"VIEW_CLASS_SETTINGS":zt(q);break}},300)}De.addEventListener("click",()=>{Js()}),Oe.addEventListener("click",()=>{we()}),he.addEventListener("click",()=>{const B=be.value.trim(),q=Te.checked;if(!B){Zs.style.display==="flex"?Ee("کادر یادداشت خالی است. آیا مطمئنید که می‌خواهید یادداشت‌های قبلی دانش‌آموزان انتخاب‌شده را پاک کنید؟",()=>{we(),bs("",!1)},{confirmText:"پاک کردن",confirmClass:"btn-warning"}):Y("⚠️ لطفاً متن یادداشت را وارد کنید.");return}we(()=>{bs(B,q)})});const Et=document.getElementById("screen-saver-overlay"),Xs=document.getElementById("screen-saver-toggle");let Qn;const ca=2*60*1e3,Qs=["mousemove","keypress","scroll","click","touchstart"];function la(){Et.classList.add("visible")}function ei(){Et.classList.contains("visible")&&Et.classList.remove("visible")}function mn(){ei(),clearTimeout(Qn),Qn=setTimeout(la,ca)}function hn(B){B.preventDefault(),B.stopPropagation(),setTimeout(mn,0)}function ti(){mn(),Qs.forEach(q=>window.addEventListener(q,mn)),Et.addEventListener("click",hn),Et.addEventListener("touchstart",hn);const B="14.1.0";{const q=document.getElementById("screen-saver-version");q&&(q.textContent=`v${B}`)}}function da(){clearTimeout(Qn),ei(),Qs.forEach(B=>window.removeEventListener(B,mn)),Et.removeEventListener("click",hn),Et.removeEventListener("touchstart",hn)}Xs.checked=Ge.isScreenSaverEnabled,Ge.isScreenSaverEnabled&&ti(),Xs.addEventListener("change",B=>{B.target.checked?(Kt({isScreenSaverEnabled:!0}),ti()):(ve(),B.preventDefault(),Ee(`نکته:
محافظ صفحه در تلفن های همراه جدید کمک می کند که دستگاه باطری کمتری مصرف کند و به دلیل ثابت ماندن صفحه نمایش در گوشی های قدیمی تر، صفحه نمایش دچار ماندگی رد پیکسل نگردد. آیا مطمئن هستید که می خواهید این ویژگی را غیر فعال کنید؟`,()=>{B.target.checked=!1,Kt({isScreenSaverEnabled:!1}),da(),Y("توصیه می شود زمان خاموش شدن صفحه نمایش گوشی خود را به حداقل دو دقیقه تغییر دهید تا در استفاده های طولانی مدت صفحه نمایش گوشی اصطحلاک کمتری را تجربه کند",7e3)},{confirmText:"بله، غیرفعال کن",cancelText:"لغو",onCancel:()=>{B.target.checked=!0}}))})});function Kr(n,a){if(!J||J.isFinished){Y("⚠️ امکان لغو انتخاب در جلسه خاتمه یافته وجود ندارد.");return}const e=J.winnerHistory;if(!(Ze===e.length-1)||e.length===0){Y("⚠️ فقط آخرین انتخاب قابل لغو است.");return}if(e[e.length-1].winner.identity.studentId!==n.identity.studentId){console.error("Undo mismatch!");return}Ee(`آیا از حذف انتخاب «${n.identity.name}» برای «${a}» مطمئن هستید؟ آمار این انتخاب بازگردانی خواهد شد.`,()=>{const o=J.winnerHistory,t=o.pop();if(!t)return;const i=t.winner,s=t.categoryName,r=i.identity.studentId;i.statusCounters.totalSelections=Math.max(0,i.statusCounters.totalSelections-1),i.categoryCounts[s]&&(i.categoryCounts[s]=Math.max(0,i.categoryCounts[s]-1));const d=J.studentRecords[r];d&&d.selections[s]&&(d.selections[s]=Math.max(0,d.selections[s]-1));let m=null;for(let g=o.length-1;g>=0;g--)if(o[g].categoryName===s){m=o[g].winner.identity.studentId;break}m?J.lastWinnerByCategory[s]=m:delete J.lastWinnerByCategory[s],bt(o.length-1),ze(),Re(),ce(),Y(`✅ انتخاب «${i.identity.name}» لغو شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}function Yr(){const n=document.getElementById("session-dashboard-page"),a=document.getElementById("student-stats-table-container");if(!n)return;let e=0,c=0;n.addEventListener("touchstart",t=>{if(a&&a.contains(t.target)){const i=t.target.closest("td, th");i&&i.parentElement.firstElementChild===i?e=t.changedTouches[0].screenX:e=0}else e=t.changedTouches[0].screenX},{passive:!0}),n.addEventListener("touchend",t=>{e!==0&&(c=t.changedTouches[0].screenX,o())});function o(){const i=e-c;Math.abs(i)>150&&(document.getElementById("selector-tab-btn").classList.contains("active")?(ge("session-dashboard-page",{tab:"attendance"}),on("attendance")):(ge("session-dashboard-page",{tab:"selector"}),on("selector"))),e=0,c=0}}
