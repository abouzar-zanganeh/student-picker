(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function t(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(a){if(a.ep)return;a.ep=!0;const o=t(a);fetch(a.href,o)}})();class dt{constructor(n){this.identity={name:n.name,studentId:n.studentId||`id_${new Date().getTime()}_${Math.random()}`,branchName:n.branchName||null,ageGroup:n.ageGroup||"adult",level:n.level||null,contact:{social:n.socialContact||null,parent:n.parentContact||null}},this.isDeleted=!1,this.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0,outOfClassCount:0},this.categoryCounts={},this.categoryIssues={},this.logs={parentContacts:[],scores:{},discipline:{},sessionHistory:{}},this.profile={notes:[],tags:[]},this.finalClassActivityScore=null,this.onboardingSession=null}addScore(n,t,s){if(t>100||t<0){console.log("نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}const a=n.toLowerCase();this.logs.scores[a]||(this.logs.scores[a]=[]);const o=new ro(n,t,s);this.logs.scores[a].push(o)}addNote(n,t=null){const s=new uo(n,t);this.profile.notes.push(s)}getOverallAverageScore(){let n=0,t=0;for(const a in this.logs.scores)this.logs.scores[a].forEach(o=>{o.isDeleted||(n+=o.value,t++)});if(t===0)return null;const s=n/t;return Math.round(s*100)/100}}class ro{constructor(n,t,s=""){this.id=`score_${new Date().getTime()}`,this.skill=n,this.value=t,this.timestamp=new Date,this.comment=s,this.isDeleted=!1}}class uo{constructor(n,t=null){this.id=`note_${new Date().getTime()}`,this.timestamp=new Date,this.content=n,this.isDeleted=!1,this.source=t}}class Gt{constructor(n="complete",t=""){this.status=n,this.comment=t,this.timestamp=new Date}}class qn{constructor(n){this.sessionNumber=n,this.startTime=new Date,this.note="",this.isDeleted=!1,this.endTime=null,this.isFinished=!1,this.isMakeup=!1,this.isCancelled=!1,this.studentRecords={},this.lastWinnerByCategory={},this.lastUsedCategoryId=null,this.lastSelectedWinnerId=null,this.winnerHistory=[]}end(){this.isFinished=!0,this.endTime=new Date}markAsMakeup(){this.isMakeup=!this.isMakeup}initializeStudentRecord(n){this.studentRecords[n]||(this.studentRecords[n]={attendance:"present",homework:new Gt,selections:{},hadIssue:!1,wasOutOfClass:!1})}setAttendance(n,t){this.initializeStudentRecord(n),this.studentRecords[n].attendance=t}setHomeworkStatus(n,t){this.initializeStudentRecord(n),this.studentRecords[n].homework.status=t}selectNextWinner(n,t,s){if(!t||t.length===0)return console.log("هیچ دانش‌آموزی در کلاس برای انتخاب وجود ندارد."),null;const a=this.lastWinnerByCategory[n];let o=t.filter(u=>u.identity.studentId!==a&&!u.isDeleted);if(o.length===0&&(o=t),o.length===0)return null;const l=(u,p)=>u.categoryCounts[p]||0,d=Math.min(...o.map(u=>l(u,n))),i=o.filter(u=>l(u,n)===d);let h;if(i.length===1)h=i[0];else if(i.length>1){const u=s.filter(k=>!k.isDeleted&&k.name!==n).map(k=>k.name),p=i.map(k=>{const M=u.reduce((W,$)=>W+l(k,$),0);return{student:k,otherCategoriesTotal:M}}),b=Math.min(...p.map(k=>k.otherCategoriesTotal)),I=p.filter(k=>k.otherCategoriesTotal===b).map(k=>k.student);I.length===1?h=I[0]:h=I[Math.floor(Math.random()*I.length)]}else h=o[Math.floor(Math.random()*o.length)];const v=h.identity.studentId;this.initializeStudentRecord(v);const B=(this.studentRecords[v].selections[n]||0)+1;return this.studentRecords[v].selections[n]=B,h.statusCounters.totalSelections++,h.categoryCounts[n]=(h.categoryCounts[n]||0)+1,this.lastWinnerByCategory[n]=v,h}}class zt{constructor(n){this.info={name:n.name||"NotNamed",scheduleCode:n.scheduleCode||`code_${new Date().getTime()}`,teacherName:n.teacherName||null,type:n.type||"in-person",term:n.term||null,scheduleText:n.scheduleText||null,level:n.level||null,creationDate:n.creationDate?new Date(n.creationDate):new Date},this.students=[],this.sessions=[],this.note="",this.isDeleted=!1,this.categories=[new ve("Vocabulary","Questions about words and meanings."),new ve("Grammar","Questions about sentence structure and rules."),new ve("Listening",void 0,!0),new ve("Speaking",void 0,!0),new ve("Reading",void 0,!0),new ve("Writing",void 0,!0)],this.futurePlans={}}addStudent(n){this.students.push(n)}removeStudent(n){this.students=this.students.filter(t=>t.identity.studentId!==n)}startNewSession(){const n=this.sessions.length+1,t=new qn(n);return this.sessions.push(t),t}endSpecificSession(n){const t=this.getSession(n);return t&&!t.isFinished?(t.end(),!0):!1}getSession(n){return this.sessions.find(t=>t.sessionNumber===n)}markAsMakeup(n){const t=this.getSession(n);t&&t.markAsMakeup()}planForSession(n,t){this.futurePlans[n]=t}hasSessionToday(){const n=new Date().toDateString();return this.sessions.some(t=>!t.isDeleted&&t.startTime.toDateString()===n)}selectNextWinner(n,t){return t?t.selectNextWinner(n,this.students,this.categories):null}get liveSession(){for(let n=this.sessions.length-1;n>=0;n--)if(!this.sessions[n].isFinished)return this.sessions[n];return null}endLiveSession(){const n=this.liveSession;return n?(n.end(),!0):!1}calculateFinalStudentScore(n){const t=n.logs.scores,s=["reading","writing"];for(const u of s)if(!t[u]||t[u].length===0)return null;const a=t.listening&&t.listening.length>0,o=t.speaking&&t.speaking.length>0;if(!a&&!o)return null;const l=u=>t[u].reduce((b,I)=>b+I.value,0)/t[u].length;let d;a&&o?d=(l("listening")+l("speaking"))/2:a?d=l("listening"):d=l("speaking");const i=l("reading"),h=l("writing"),B=(d*3+i*2+h*1)/6;return Math.trunc(B*10)/10}assignAllFinalScores(){let n=0,t=[];console.log("شروع عملیات محاسبه نمره نهایی برای تمام دانش‌آموزان..."),this.students.forEach(a=>{const o=this.calculateFinalStudentScore(a);o!==null?(a.finalClassActivityScore=o,n++):(a.finalClassActivityScore=null,t.push(a.identity.name))});const s=t.length;console.log(`عملیات پایان یافت. تعداد نمرات موفق: ${n} | تعداد ناموفق (نمرات ناقص): ${s}`),s>0&&(console.log("اسامی دانش‌آموزانی که نمراتشان ناقص است:"),t.forEach(a=>console.log(`- ${a}`)))}}class ve{constructor(n,t="",s=!1){this.id=`cat_${new Date().getTime()}_${Math.random()}`,this.name=n,this.description=t,this.isDeleted=!1,this.isGradedCategory=s,this.isDeleted=!1}}let N={},r=null,dn=null,y=null,O=null,et=null,At=null,un=[],It=null,mn=null,re=null,St=0,fn=0,Lt=0,pn=0,gn=null,hn=null,kt=null,Le=null,ue=-1,wt=null,Nt=null,Bt=null,Un=null,Vn=null,fe=!1,T=[],$e=[];function w(){if(fe)return;const e={classrooms:N,trashBin:T};localStorage.setItem("teacherAssistantData_v2",JSON.stringify(e))}function Gn(){const n=JSON.stringify({classrooms:N,trashBin:T},null,2),s=`SP-${new Date().toLocaleDateString("fa-IR-u-nu-latn").replace(/\//g,"-")}.txt`;return new File([n],s,{type:"text/plain"})}function xt(){const e=localStorage.getItem("teacherAssistantData_v2");if(!e)return;const n=JSON.parse(e);n.classrooms?(We(n.classrooms),T=n.trashBin||[]):(We(n),mo())}function mo(){const e=[];Object.values(N).forEach(n=>{n.isDeleted?e.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:n.info.creationDate,type:"classroom",description:`کلاس «${n.info.name}»`,restoreData:{name:n.info.name}}):n.students.forEach(t=>{t.isDeleted&&e.push({id:`trash_${Date.now()}_${Math.random()}`,timestamp:t.identity.studentId.split("_")[1],type:"student",description:`دانش‌آموز «${t.identity.name}»`,restoreData:{studentId:t.identity.studentId,classroomName:n.info.name}})})}),T.length===0&&e.length>0&&(T=e,console.log(`Migrated ${e.length} previously deleted item(s) to the new trash bin.`),w())}function We(e){N={};for(const n in e){const t=e[n],s=new zt(t.info);s.isDeleted=t.isDeleted,s.note=t.note||"",s.students=t.students.map(a=>{const o=new dt(a.identity);return o.isDeleted=a.isDeleted,o.statusCounters=a.statusCounters,o.logs=a.logs,o.logs.scores||(o.logs.scores={}),o.profile=a.profile,o.finalClassActivityScore=a.finalClassActivityScore,o.categoryCounts=a.categoryCounts||{},o.categoryIssues=a.categoryIssues||{},o.onboardingSession=a.onboardingSession||null,o}),s.sessions=t.sessions.map(a=>{const o=new qn(a.sessionNumber);o.isDeleted=a.isDeleted,o.note=a.note||"",o.startTime=new Date(a.startTime),o.endTime=a.endTime?new Date(a.endTime):null,o.isFinished=a.isFinished,o.isMakeup=a.isMakeup,o.isCancelled=a.isCancelled||!1,o.studentRecords=a.studentRecords;for(const d in o.studentRecords){const i=o.studentRecords[d];i.homework&&!(i.homework instanceof Gt)&&(o.studentRecords[d].homework=new Gt(i.homework.status,i.homework.comment))}o.lastWinnerByCategory=a.lastWinnerByCategory,o.lastUsedCategoryId=a.lastUsedCategoryId,o.lastSelectedWinnerId=a.lastSelectedWinnerId;const l=a.winnerHistory||[];return o.winnerHistory=l.map(d=>({winner:s.students.find(h=>h.identity.studentId===d.winner.identity.studentId),categoryName:d.categoryName})),o}),s.categories=t.categories.map(a=>{const o=new ve(a.name,a.description,a.isGradedCategory);return o.id=a.id,o.isDeleted=a.isDeleted,o}),s.futurePlans=t.futurePlans,N[n]=s}}function zn(e,n){if(N[n])return{success:!1,message:"کلاسی با این نام از قبل وجود دارد."};const t=N[e];return t?(t.info.name=n,N[n]=t,delete N[e],r===t&&Z(t),{success:!0}):{success:!1,message:"کلاس مورد نظر یافت نشد."}}function Jn(e,n,t){const s=t.trim();if(!s)return{success:!1,message:"نام دسته‌بندی نمی‌تواند خالی باشد."};if(e.categories.some(i=>i.id!==n.id&&!i.isDeleted&&i.name.toLowerCase()===s.toLowerCase()))return{success:!1,message:"دسته‌بندی دیگری با این نام وجود دارد."};const o=n.name,l=o.toLowerCase(),d=s.toLowerCase();return n.name=s,e.students.forEach(i=>{i.categoryCounts&&i.categoryCounts[o]!==void 0&&(i.categoryCounts[s]=i.categoryCounts[o],delete i.categoryCounts[o]),i.categoryIssues&&i.categoryIssues[o]!==void 0&&(i.categoryIssues[s]=i.categoryIssues[o],delete i.categoryIssues[o]),i.logs.scores&&i.logs.scores[l]&&(i.logs.scores[l].forEach(h=>h.skill=s),l!==d&&(i.logs.scores[d]=i.logs.scores[l],delete i.logs.scores[l]))}),e.sessions.forEach(i=>{i.lastWinnerByCategory&&i.lastWinnerByCategory[o]&&(i.lastWinnerByCategory[s]=i.lastWinnerByCategory[o],delete i.lastWinnerByCategory[o]),i.winnerHistory&&i.winnerHistory.forEach(h=>{h.categoryName===o&&(h.categoryName=s)})}),{success:!0}}function jn(e,n,t){if(F(t.students).some(l=>l.identity.name.toLowerCase()===e.identity.name.toLowerCase()))return{success:!1,message:`دانش‌آموزی با نام «${e.identity.name}» از قبل در کلاس «${t.info.name}» وجود دارد.`};const a=JSON.parse(JSON.stringify(e));t.addStudent(a);const o=n.students.find(l=>l.identity.studentId===e.identity.studentId);return o&&tt(o,n),{success:!0}}function Kn(){for(const e in N){const n=N[e];n.students.forEach(t=>{t.statusCounters={totalSelections:0,missedChances:0,earlyLeaves:0},t.categoryCounts={},t.categoryIssues={},n.sessions.forEach(s=>{const a=t.identity.studentId;s.studentRecords[a]&&(s.studentRecords[a].attendance="present")})})}w()}function F(e){return Array.isArray(e)?e.filter(n=>!n.isDeleted):[]}function pe(e){const n=new Map;return e&&F(e.sessions).filter(s=>!s.isCancelled).sort((s,a)=>s.sessionNumber-a.sessionNumber).forEach((s,a)=>{n.set(s.sessionNumber,a+1)}),n}function De(e){ue=e}function ge(e){wt=e}function tt(e,n){if(!e||!n)return;const t=e.identity.studentId,s=n.students.findIndex(a=>a.identity.studentId===t);s>-1&&n.students.splice(s,1),n.sessions.forEach(a=>{a.studentRecords[t]&&delete a.studentRecords[t]})}function Qn(e,n){const t=N[e];if(!t)return;const s=t.sessions.findIndex(a=>a.sessionNumber===n);s>-1&&t.sessions.splice(s,1)}function Xn(e,n){const t=N[e];if(!t)return;const s=t.categories.findIndex(d=>d.id===n);if(s===-1)return;const o=t.categories[s].name,l=o.toLowerCase();t.students.forEach(d=>{d.categoryCounts&&delete d.categoryCounts[o],d.categoryIssues&&delete d.categoryIssues[o],d.logs.scores&&delete d.logs.scores[l]}),t.categories.splice(s,1)}function Yn(e,n,t,s){const a=N[e];if(!a)return;const o=a.students.find(i=>i.identity.studentId===n);if(!o||!o.logs.scores[t.toLowerCase()])return;const l=o.logs.scores[t.toLowerCase()],d=l.findIndex(i=>i.id===s);d>-1&&l.splice(d,1)}function Zn(e,n,t){const s=N[e];if(!s)return;const a=s.students.find(l=>l.identity.studentId===n);if(!a||!a.profile.notes)return;const o=a.profile.notes.findIndex(l=>l.id===t);o>-1&&a.profile.notes.splice(o,1)}function es(){JSON.parse(JSON.stringify({classrooms:N,trashBin:T})),fe=!0}function ts(){fe=!1,xt()}function Z(e){r=e}function nt(e){dn=e}function ne(e){y=e}function J(e){O=e}function Tt(e){et=e}function ns(e){At=e}function Ge(e){un=e}function ut(e){It=e}function ss(e){mn=e}function yn(e){re=e}function mt(e){St=e}function os(e){fn=e}function ft(e){Lt=e}function as(e){pn=e}function Cn(e){gn=e}function vn(e){hn=e}function st(e){kt=e}function En(e){Le=e}function Dt(e){Bt=e}function is(e){Un=e}function cs(e){Vn=e}function Jt(e){T=e}function Ht(e){Nt=e}function Mt(e){$e=e}const fo=Object.freeze(Object.defineProperty({__proto__:null,get activeModal(){return Le},get cancelCallback(){return hn},get classrooms(){return N},get confirmCallback(){return gn},get currentClassroom(){return r},get easterEggClickCount(){return St},get easterEggLastClickTime(){return fn},enterDemoMode:es,exitDemoMode:ts,getActiveItems:F,getSessionDisplayMap:pe,get importedFileContent(){return It},get isDemoMode(){return fe},get liveSession(){return dn},loadData:xt,get manualSelection(){return Bt},moveStudent:jn,get namesToImport(){return un},get notificationTimeout(){return mn},permanentlyDeleteCategory:Xn,permanentlyDeleteNote:Zn,permanentlyDeleteScore:Yn,permanentlyDeleteSession:Qn,permanentlyDeleteStudent:tt,prepareBackupData:Gn,get previousState(){return et},rehydrateData:We,renameCategory:Jn,renameClassroom:zn,resetAllStudentCounters:Kn,get resetEasterEggClickCount(){return Lt},get resetEasterEggLastClickTime(){return pn},get saveCategoryCallback(){return Nt},saveData:w,get saveNoteCallback(){return wt},get secureConfirmCallback(){return kt},get selectedCategory(){return re},get selectedSession(){return y},get selectedStudentForProfile(){return O},get selectedStudentsForMassComment(){return $e},setActiveModal:En,setCancelCallback:vn,setConfirmCallback:Cn,setCurrentClassroom:Z,setEasterEggClickCount:mt,setEasterEggLastClickTime:os,setImportedFileContent:ut,setLiveSession:nt,setManualSelection:Dt,setNamesToImport:Ge,setNotificationTimeout:ss,setPreviousState:Tt,setResetEasterEggClickCount:ft,setResetEasterEggLastClickTime:as,setSaveCategoryCallback:Ht,setSaveNoteCallback:ge,setSecureConfirmCallback:st,setSelectedCategory:yn,setSelectedSession:ne,setSelectedStudentForProfile:J,setSelectedStudentsForMassComment:Mt,setSourceClassForMove:cs,setStudentToMove:is,setTrashBin:Jt,setUndoTimeout:ns,setWinnerHistoryIndex:De,get sourceClassForMove(){return Vn},get studentToMove(){return Un},get trashBin(){return T},get undoTimeout(){return At},get winnerHistoryIndex(){return ue}},Symbol.toStringTag,{value:"Module"}));function ye(e){return typeof e!="string"?"":e.replace(/ي/g,"ی").replace(/ك/g,"ک").replace(/[\s\u200c]/g,"")}function ot(e){return typeof e!="string"||e.length===0?"ltr":/[\u0590-\u07FF]/.test(e)?"rtl":"ltr"}function ls(e){return!e||!e.trim()?"":e.split(`
`).map(s=>`<div dir="${ot(s)}">${s||"&nbsp;"}</div>`).join("")}function Vt(e){if(typeof e!="string")return"";const n={q:"ض",w:"ص",e:"ث",r:"ق",t:"ف",y:"غ",u:"ع",i:"ه",o:"خ",p:"ح","[":"ج","]":"چ",a:"ش",s:"س",d:"ی",f:"ب",g:"ل",h:"ا",j:"ت",k:"ن",l:"م",";":"ک","'":"گ",z:"ظ",x:"ط",c:"ز",v:"ر",b:"ذ",n:"د",m:"پ",",":"و"};let t="";for(let s=0;s<e.length;s++){const a=e[s].toLowerCase();t+=n[a]||e[s]}return t}const rs="teacherAssistantLogs_v2",po=100;function bn(){try{const e=localStorage.getItem(rs);return e?JSON.parse(e):{}}catch(e){return console.error("Error reading logs from localStorage:",e),{}}}function ds(e){try{localStorage.setItem(rs,JSON.stringify(e))}catch(n){console.error("Error saving logs to localStorage:",n)}}function R(e,n,t=null){if(!e)return;const s=bn();s[e]||(s[e]=[]);const a={timestamp:new Date().toISOString(),message:n,action:t,classroomName:e};s[e].unshift(a),s[e].length>po&&s[e].pop(),ds(s)}function go(e){return bn()[e]||[]}function ho(e,n){const t=bn();t[e]&&!t[n]&&(t[n]=t[e],delete t[e],ds(t))}const us=document.getElementById("class-management-page"),yo=document.getElementById("new-class-name"),Co=document.getElementById("add-class-btn"),jt=document.getElementById("class-list"),$t=document.getElementById("undo-toast"),ms=document.getElementById("undo-message"),vo=document.getElementById("undo-btn"),Eo=document.getElementById("settings-page"),In=document.getElementById("settings-class-name-header"),Kt=document.getElementById("settings-student-list"),Qt=document.getElementById("category-list"),bo=document.getElementById("back-to-sessions-btn"),Io=document.getElementById("new-student-name"),So=document.getElementById("add-student-btn"),fs=document.getElementById("paste-area"),Lo=document.getElementById("process-paste-btn"),ko=document.getElementById("csv-preview-page"),Xt=document.getElementById("csv-preview-list"),wo=document.getElementById("csv-confirm-btn"),No=document.getElementById("csv-cancel-btn"),Bo=document.getElementById("import-csv-btn"),xo=document.getElementById("csv-file-input"),To=document.getElementById("column-mapping-page"),Yt=document.getElementById("column-select-dropdown"),Do=document.getElementById("confirm-column-btn"),Mo=document.getElementById("cancel-import-btn"),$o=document.getElementById("new-category-name"),Oo=document.getElementById("add-category-btn"),Zt=document.querySelector(".app-header"),ke=document.getElementById("select-student-btn"),at=document.getElementById("select-student-btn-wrapper"),Ao=document.getElementById("attendance-page"),Ke=document.getElementById("attendance-list"),Ho=document.getElementById("finish-attendance-btn"),Ro=document.getElementById("back-to-sessions-from-attendance-btn"),_o=document.getElementById("back-to-attendance-btn"),Po=document.querySelector("#class-management-page h2"),en=document.getElementById("student-stats-header"),Wo=document.getElementById("hamburger-menu-btn"),Fo=document.getElementById("side-nav-menu"),qo=document.getElementById("close-nav-btn"),Uo=document.getElementById("overlay"),Vo=document.getElementById("backup-data-btn"),Go=document.getElementById("restore-data-btn"),ps=document.getElementById("restore-file-input"),zo=document.getElementById("custom-confirm-modal"),gs=document.getElementById("confirm-modal-message"),tn=document.getElementById("confirm-modal-cancel-btn"),ze=document.getElementById("confirm-modal-confirm-btn"),Jo=document.getElementById("secure-confirm-modal"),hs=document.getElementById("secure-confirm-message"),ys=document.getElementById("secure-confirm-code"),Re=document.getElementById("secure-confirm-input"),jo=document.getElementById("secure-confirm-cancel-btn"),pt=document.getElementById("secure-confirm-confirm-btn"),Ko=document.getElementById("add-note-modal"),P=document.getElementById("new-note-content"),Qo=document.getElementById("class-save-note-btn"),Xo=document.getElementById("cancel-note-btn"),nn=document.getElementById("student-search-input"),Ie=document.getElementById("student-search-results"),Yo=document.getElementById("student-profile-page"),Cs=document.getElementById("profile-student-name-header"),Zo=document.getElementById("back-to-student-page-btn"),_e=document.getElementById("graded-category-pills-container"),sn=document.getElementById("new-score-value"),Sn=document.getElementById("new-score-comment"),ea=document.getElementById("add-score-btn"),Je=document.getElementById("profile-stats-summary"),gt=document.getElementById("profile-scores-list"),ht=document.getElementById("global-student-search-input"),Ce=document.getElementById("global-student-search-results"),ta=document.getElementById("is-graded-checkbox"),na=document.getElementById("trashed-classes-list"),sa=document.getElementById("trashed-students-list"),oa=document.getElementById("trashed-sessions-list"),aa=document.getElementById("trashed-categories-list"),ia=document.getElementById("trashed-notes-list"),ca=document.getElementById("trashed-scores-list"),Ot=document.getElementById("quick-grade-form-wrapper"),Ee=document.getElementById("quick-score-input"),me=document.getElementById("quick-note-textarea"),Fe=document.getElementById("quick-grade-submit-btn"),Qe=document.getElementById("category-selection-container"),vs=document.getElementById("selected-student-result"),Me=document.getElementById("custom-context-menu"),Pe=document.getElementById("breadcrumb-container"),la=document.getElementById("category-modal"),Es=document.getElementById("category-modal-title"),Xe=document.getElementById("new-category-modal-name"),Ln=document.getElementById("new-category-modal-is-graded"),ra=document.getElementById("category-modal-cancel-btn"),bs=document.getElementById("category-modal-save-btn"),da=document.getElementById("mass-comment-modal"),ua=document.getElementById("mass-comment-modal-title"),Is=document.getElementById("mass-comment-student-count-message"),Ye=document.getElementById("mass-comment-content"),kn=document.getElementById("mass-comment-append-checkbox"),ma=document.getElementById("mass-comment-cancel-btn"),fa=document.getElementById("mass-comment-save-btn"),on=document.getElementById("mass-comment-btn"),yt=document.getElementById("attendance-mass-actions-container"),Be=document.createElement("input");function pa(e){clearTimeout(At),et||Tt(JSON.stringify(N)),ms.textContent=e,$t.classList.add("show"),ns(setTimeout(()=>{$t.classList.remove("show"),Tt(null)},5e3))}function Ss(){if(et){const e=r?r.info.name:null,n=JSON.parse(et);We(n),e&&N[e]?Z(N[e]):Z(null),r?(be(),qe(),Q()):ce(),$t.classList.remove("show"),clearTimeout(At),Tt(null)}}function C(e,n=3e3){const t=document.getElementById("notification-toast");t&&(t.textContent=e,t.classList.add("show"),clearTimeout(mn),ss(setTimeout(()=>{t.classList.remove("show")},n)))}function G(e,n,t={}){const{confirmText:s="تایید",cancelText:a="لغو",confirmClass:o="btn-success",onCancel:l=()=>{},isDelete:d=!1}=t,i=d?()=>Ls(e,n):n;gs.textContent=e,ze.textContent=s,tn.textContent=a,ze.className="modal-action-btn",ze.classList.add(o),Cn(i),vn(l);const h=ze.parentElement;tn.style.display=l===null?"none":"inline-block",h.style.justifyContent=l===null?"center":"space-between",te("custom-confirm-modal")}function Ls(e,n){const t=Math.floor(1e4+Math.random()*9e4).toString();hs.textContent=e,ys.textContent=t,Re.value="",pt.disabled=!0,st(n),te("secure-confirm-modal"),Re.focus();const s=()=>{Re.value===t?pt.disabled=!1:pt.disabled=!0};return Re.addEventListener("input",s),()=>{Re.removeEventListener("input",s)}}function an(e,n={}){const{title:t="ایجاد دسته‌بندی جدید",initialName:s="",initialIsGraded:a=!1,saveButtonText:o="ذخیره"}=n;Es.textContent=t,Xe.value=s,Ln.checked=a,bs.textContent=o,Ht((l,d)=>{if(!l){C("⚠️ لطفاً نام دسته‌بندی را وارد کنید.");return}e(l,d),z()}),te("category-modal"),Xe.focus(),s&&Xe.select()}function ks(e,n){const t=Object.values(N).filter(l=>!l.isDeleted&&l.info.name!==n.info.name),s=document.getElementById("move-student-modal-title"),a=document.getElementById("move-student-class-select"),o=document.getElementById("move-student-confirm-btn");s.textContent=`انتقال دانش‌آموز: ${e.identity.name}`,a.innerHTML="",t.length===0?(a.innerHTML='<option value="">کلاس دیگری برای انتقال وجود ندارد</option>',o.disabled=!0):(t.forEach(l=>{const d=document.createElement("option");d.value=l.info.name,d.textContent=l.info.name,a.appendChild(d)}),o.disabled=!1),is(e),cs(n),te("move-student-modal")}function wn(e,n){if(!e||!n)return;const t=e.identity.name,s=document.getElementById("add-note-modal-title");s.textContent="تغییر نام دانش‌آموز",P.value=t,P.rows=1,P.dispatchEvent(new Event("input",{bubbles:!0})),ge(a=>{const o=a.trim();o&&o!==t&&(F(n.students).some(d=>d.identity.studentId!==e.identity.studentId&&d.identity.name.toLowerCase()===o.toLowerCase())?C("دانش‌آموزی با این نام از قبل در این کلاس وجود دارد."):(e.identity.name=o,R(n.info.name,`نام دانش‌آموز «${t}» به «${o}» تغییر یافت.`,{type:"VIEW_STUDENT_PROFILE",studentId:e.identity.studentId}),w(),be(),se(),O&&O.identity.studentId===e.identity.studentId&&oe(),C(`✅نام دانش‌آموز به «${o}» تغییر یافت.`))),s.textContent="ثبت یادداشت جدید",P.rows=4}),te("add-note-modal"),P.focus(),P.select()}function te(e){const n=document.getElementById(e);if(n){if(Le)return;n.classList.add("modal-visible"),En(e),history.pushState(null,"",location.href)}}function z(e){if(!Le)return;const n=document.getElementById(Le),t=Le;En(null),history.back(),n&&(n.classList.add("modal-closing"),setTimeout(()=>{n.classList.remove("modal-visible"),n.classList.remove("modal-closing"),t==="custom-confirm-modal"&&(Cn(null),vn(null)),t==="secure-confirm-modal"&&st(null),t==="category-modal"&&Ht(null),t==="mass-comment-modal"&&(Ye.value=""),t==="add-note-modal"&&ge(null),typeof e=="function"&&e()},300))}function Nn(){var n;if(((n=document.querySelector(".page.active"))==null?void 0:n.id)!=="attendance-page"){yt.style.display="none";return}const e=$e.length;e<1?yt.style.display="none":yt.style.display="block",on.disabled=e<1,on.textContent=`📝 ثبت یادداشت گروهی (${e} نفر)`}function ws(){const e=$e,n=e.length;let t=!1;n>0&&(t=e.some(a=>{var o;return(o=y.studentRecords[a])==null?void 0:o.homework.comment})),Is.textContent=`یادداشت برای ${n} دانش‌آموز ثبت خواهد شد.`,Ye.value="",Ye.dispatchEvent(new Event("input",{bubbles:!0})),kn.checked=!0;const s=document.querySelector("#mass-comment-modal .modal-options");s.style.display=t?"flex":"none",te("mass-comment-modal"),Ye.focus()}function cn(e,n){if(!r||!y)return;let t=0;const s=$e,a=y;s.forEach(o=>{const l=a.studentRecords[o];if(l&&l.homework){const d=l.homework.comment||"";let i=e;n&&d.length>0?i=d+`
---
`+e:i=e,l.homework.comment=i.trim();const h=r.students.find(v=>v.identity.studentId===o);h&&ga(h,a,i.trim()),t++}}),Mt([]),w(),Se(),R(r.info.name,`${t} دانش‌آموز به صورت گروهی یادداشت تکلیف گرفتند.`,{type:"VIEW_SESSIONS"}),C(`✅ یادداشت برای ${t} دانش‌آموز ثبت شد.`)}function ga(e,n,t){const a=pe(r).get(n.sessionNumber),o={type:"fromAttendance",sessionNumber:n.sessionNumber},l=`یادداشت مربوط به جلسه ${a}: `,d=e.profile.notes.find(i=>!i.isDeleted&&i.source&&i.source.type==="fromAttendance"&&i.source.sessionNumber===o.sessionNumber);d?t?(d.content=l+t,d.isDeleted=!1):d.isDeleted=!0:t&&e.addNote(l+t,o)}function Bn(e){P.value=e.note||"",ge(n=>{e.note=n,w(),R(e.info.name,"یادداشت کلاس ذخیره شد.",{type:"VIEW_CLASS_NOTE"}),ce(),C("✅ یادداشت کلاس ذخیره شد.")}),te("add-note-modal"),P.focus()}function xn(e){Z(e),In.textContent=`تنظیمات کلاس: ${e.info.name}`,be(),qe(),L("settings-page")}function Ns(e){const n=document.getElementById("log-modal-title"),t=document.getElementById("log-list");n.textContent=`گزارش فعالیت‌های کلاس: ${e}`,t.innerHTML="";const s=go(e);s.length===0?t.innerHTML='<li class="no-content-message">هنوز فعالیتی برای این کلاس ثبت نشده است.</li>':s.forEach(a=>{const o=document.createElement("li");o.className="log-entry";const l=new Date(a.timestamp),d=`${l.toLocaleDateString("fa-IR")} - ${l.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}`,i=document.createElement("span");i.className="log-timestamp",i.textContent=d;const h=document.createElement("span");h.className="log-message",h.textContent=a.message,a.action&&(h.classList.add("log-action-link"),h.dataset.action=JSON.stringify({...a.action,classroomName:a.classroomName})),o.appendChild(i),o.appendChild(h),t.appendChild(o)}),te("log-modal")}document.getElementById("log-modal-close-btn").addEventListener("click",()=>{z()});function ln(e){const n=URL.createObjectURL(e),t=document.createElement("a");t.href=n,t.download=e.name,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(n)}async function Tn(){const e=Gn();if(("ontouchstart"in window||navigator.maxTouchPoints>0)&&navigator.share&&navigator.canShare&&navigator.canShare({files:[e]}))try{await navigator.share({title:"پشتیبان دستیار معلم",text:"فایل پشتیبان داده‌های برنامه",files:[e]})}catch(t){t.name!=="AbortError"&&(console.error("Error sharing file:",t),ln(e),C("⚠️اشتراک‌گذاری با خطا مواجه شد. فایل در حال دانلود است."))}else ln(e),C("✅پشتیبان‌گیری با موفقیت انجام شد.")}function lt(e,n){e.preventDefault(),xe(),setTimeout(()=>{const t=Me,s=t.querySelector("ul");s.innerHTML="",n.forEach(v=>{const B=document.createElement("li");v.isSeparator?B.className="separator":(B.innerHTML=`
                    <span class="icon">${v.icon||""}</span>
                    <span class="label">${v.label}</span>
                `,v.className&&B.classList.add(v.className),B.addEventListener("click",()=>{v.action(),xe()})),s.appendChild(B)});const{clientX:a,clientY:o}=e,{innerWidth:l,innerHeight:d}=window;t.style.top=`${o}px`,t.style.left=`${a}px`,t.classList.add("visible");const{offsetWidth:i,offsetHeight:h}=t;a+i>l&&(t.style.left=`${l-i-5}px`),o+h>d&&(t.style.top=`${d-h-5}px`)},50)}function xe(){Me.classList.contains("visible")&&Me.classList.remove("visible")}function Bs(){var n,t;Pe.innerHTML="";const e=[];if(e.push({label:"کلاس‌ها",handler:()=>{Z(null),ne(null),J(null),L("class-management-page")}}),r){if(e.push({label:r.info.name,handler:()=>{ne(null),J(null),Q(),L("session-page")}}),((n=document.querySelector(".page.active"))==null?void 0:n.id)==="settings-page")e.push({label:"تنظیمات"});else if(y){const o=pe(r).get(y.sessionNumber)||` (#${y.sessionNumber})`;e.push({label:`جلسه ${o}`,handler:()=>{J(null),L("student-page")}});const l=(t=document.querySelector(".page.active"))==null?void 0:t.id;O?e.push({label:`پروفایل: ${O.identity.name}`}):l==="attendance-page"&&e.push({label:"حضور و غیاب"})}}if(e.length<=1){Pe.style.display="none";return}Pe.style.display="flex",e.forEach((s,a)=>{const o=document.createElement("a");if(o.textContent=s.label,o.className="breadcrumb-item",a===e.length-1||!s.handler?o.classList.add("active"):o.addEventListener("click",s.handler),Pe.appendChild(o),a<e.length-1){const l=document.createElement("span");l.className="breadcrumb-separator",l.textContent="/",Pe.appendChild(l)}})}function Fn(e,n,t){t.innerHTML="";const s=r.sessions.filter(a=>{var o;return!a.isDeleted&&!a.isCancelled&&((o=a.studentRecords[e.identity.studentId])==null?void 0:o.attendance)==="absent"}).map(a=>({number:n.get(a.sessionNumber),isMakeup:a.isMakeup})).filter(a=>a.number!==void 0);s.length>0?(t.appendChild(document.createTextNode("جلسات غایب: ")),s.forEach((a,o)=>{const l=document.createElement("span");l.textContent=a.number,a.isMakeup&&l.classList.add("makeup-absence"),t.appendChild(l),o<s.length-1&&t.appendChild(document.createTextNode("، "))})):t.textContent="جلسات غایب: بدون غیبت"}function Ct(e,n,t,s={}){const{includePrefix:a=!0}=s;t.innerHTML="";const o=r.sessions.filter(l=>{if(l.isDeleted||l.isCancelled)return!1;const d=l.studentRecords[e.identity.studentId];return d&&d.homework&&(d.homework.status==="incomplete"||d.homework.status==="none")}).map(l=>({number:n.get(l.sessionNumber),status:l.studentRecords[e.identity.studentId].homework.status})).filter(l=>l.number!==void 0);o.length>0?(a&&t.appendChild(document.createTextNode("تکالیف ناقص: ")),o.forEach((l,d)=>{const i=document.createElement("span");i.textContent=l.number,l.status==="incomplete"&&i.classList.add("incomplete-homework"),t.appendChild(i),d<o.length-1&&t.appendChild(document.createTextNode("،"))})):a?t.textContent="تکالیف ناقص: ندارد":t.textContent="ندارد"}function ha(e,n){var M,W,$;const t=document.createElement("li");t.className="attendance-list-item";const s=document.createElement("input");s.type="checkbox",s.className="mass-comment-checkbox",s.checked=$e.includes(e.identity.studentId),s.addEventListener("change",()=>{const A=e.identity.studentId,D=$e;if(s.checked)D.includes(A)||D.push(A);else{const U=D.indexOf(A);U>-1&&D.splice(U,1)}Nn()}),t.appendChild(s);const a={none:"بدون تکلیف",complete:"تکلیف کامل",incomplete:"تکلیف ناقص"},o=document.createElement("div");o.className="student-info";const l=document.createElement("span");l.className="student-name",l.textContent=e.identity.name,l.addEventListener("click",()=>{J(e),oe(),L("student-profile-page")});const d=document.createElement("span");d.className="absence-info";const i=document.createElement("span");i.className="homework-info",Fn(e,n,d),Ct(e,n,i),o.appendChild(l),o.appendChild(d),o.appendChild(i);const h=document.createElement("div");h.className="homework-controls";const v=document.createElement("button"),B=((M=y.studentRecords[e.identity.studentId])==null?void 0:M.homework.status)||"none";v.className=`homework-status-btn ${B}`,v.title=a[B],v.addEventListener("click",()=>{const A=y.studentRecords[e.identity.studentId].homework,U={none:"incomplete",incomplete:"complete",complete:"none"}[A.status];v.title=a[U],y.setHomeworkStatus(e.identity.studentId,U),w(),v.className=`homework-status-btn ${U}`,Ct(e,n,i)});const u=document.createElement("button");u.className="btn-icon",u.innerHTML="📝",u.title="افزودن یادداشت برای تکلیف",((W=y.studentRecords[e.identity.studentId])==null?void 0:W.homework.comment)||(u.style.opacity="0.3"),u.addEventListener("click",()=>{const A=y.studentRecords[e.identity.studentId].homework;P.value=A.comment||"",P.dispatchEvent(new Event("input",{bubbles:!0})),ge(D=>{A.comment=D;const U=pe(r),ae=U.get(y.sessionNumber),he={type:"fromAttendance",sessionNumber:y.sessionNumber},X=`یادداشت مربوط به جلسه ${ae}: `,de=e.profile.notes.find(j=>!j.isDeleted&&j.source&&j.source.type==="fromAttendance"&&j.source.sessionNumber===he.sessionNumber);de?D?de.content=X+D:de.isDeleted=!0:D&&e.addNote(X+D,he),w(),R(r.info.name,`یادداشت تکلیف جلسه ${ae} برای دانش‌آموز «${e.identity.name}» ذخیره شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:e.identity.studentId}),C("✅یادداشت تکلیف ذخیره شد."),u.style.opacity=D?"1":"0.3",Ct(e,U,i)}),te("add-note-modal"),P.focus()}),h.appendChild(v),h.appendChild(u);const b=document.createElement("button"),I=(($=y.studentRecords[e.identity.studentId])==null?void 0:$.attendance)||"present",k=A=>{A==="present"?(b.textContent="حاضر",b.className="attendance-status-btn present active"):(b.textContent="غایب",b.className="attendance-status-btn absent active")};return k(I),b.addEventListener("click",()=>{var U;const D=(((U=y.studentRecords[e.identity.studentId])==null?void 0:U.attendance)||"present")==="present"?"absent":"present";y.setAttendance(e.identity.studentId,D),D==="absent"&&(y.studentRecords[e.identity.studentId].hadIssue=!1),w(),k(D),Fn(e,n,d),Ms()}),t.appendChild(o),t.appendChild(h),t.appendChild(b),t}function ya(){return pe(r).get(y.sessionNumber)}function Se(){if(!r||!y)return;F(r.students).forEach(a=>{y.initializeStudentRecord(a.identity.studentId)}),Mt([]);const e=pe(r);wa(),Ke.innerHTML="";const n=document.createElement("li");n.className="attendance-list-header",Be.id="attendance-search-input",Be.type="text",Be.className="inline-search-input",Be.placeholder="جستجو...",Be.value="";const t=document.createElement("div");t.className="student-search-container",t.appendChild(Be);const s=document.createElement("div");s.className="header-labels-container",s.innerHTML=`
    <span class="header-label">تکلیف</span>
    <span class="header-label">حضور</span>
`,n.appendChild(t),n.appendChild(s),Ke.appendChild(n),F(r.students).forEach(a=>{const o=ha(a,e);Ke.appendChild(o)}),Mt([]),Nn(),Na(),Ms()}function se(){const e=document.getElementById("student-stats-table-container");if(!e||(e.innerHTML="",!r))return;F(r.students).length,en.textContent="آمار عملکرد";const n=["نام"],t=["کل انتخاب ها","غیبت","خروج","فرصت ازدست‌رفته","مشکل","میانگین","نمره کلاسی (کانون)"],s=r.categories.filter(p=>p.isGradedCategory&&!p.isDeleted).map(p=>p.name),a=[...n,...s,...t],o=document.createElement("table");o.className="student-stats-table";const d=o.createTHead().insertRow();a.forEach((p,b)=>{const I=document.createElement("th");b===0?(I.innerHTML=`${p} <span style="opacity: 0.6;">🔗</span>`,I.title="ردیف‌های این ستون قابل کلیک هستند"):I.textContent=p,d.appendChild(I)});const i=o.createTBody(),h=F(r.students),v=p=>{let b=0;return r.sessions.forEach(I=>{if(I.isDeleted||I.isCancelled)return;const k=I.studentRecords[p.identity.studentId];k&&k.attendance==="absent"&&b++}),b};h.forEach(p=>{const b=i.insertRow();if(b.dataset.studentId=p.identity.studentId,y){const A=y.studentRecords[p.identity.studentId];A&&A.attendance==="absent"&&b.classList.add("absent-row-highlight")}const I=b.insertCell(),k=document.createElement("span");k.textContent=p.identity.name,k.className="student-name-link",k.addEventListener("click",()=>{J(p),oe(),L("student-profile-page")}),I.appendChild(k),s.forEach(A=>{var he;const D=b.insertCell(),U=A.toLowerCase(),ae=((he=p.logs.scores[U])==null?void 0:he.filter(X=>!X.isDeleted))||[];ae.length>0?ae.forEach((X,de)=>{const j=document.createElement("span");j.textContent=X.value,j.style.position="relative",X.comment&&(j.dataset.tooltip=X.comment),D.appendChild(j),de<ae.length-1&&D.appendChild(document.createTextNode(","))}):D.textContent="",D.style.cursor="pointer",D.addEventListener("click",()=>{we(p,A);const X=document.getElementById("category-selection-container");X&&X.scrollIntoView({behavior:"smooth",block:"center"})})}),b.insertCell().textContent=p.statusCounters.totalSelections||0,b.insertCell().textContent=v(p),b.insertCell().textContent=p.statusCounters.outOfClassCount||0,b.insertCell().textContent=p.statusCounters.missedChances||0;const M=Object.values(p.categoryIssues||{}).reduce((A,D)=>A+D,0);b.insertCell().textContent=M;const W=p.getOverallAverageScore();b.insertCell().textContent=W!==null?W:"-";const $=r.calculateFinalStudentScore(p);b.insertCell().textContent=$!==null?$:"-"}),F(r.students),en.setAttribute("data-student-count",h.length),e.appendChild(o);const B=e.querySelector(".student-stats-table"),u=B==null?void 0:B.querySelector("thead th:first-child");u&&u.addEventListener("click",()=>{B.classList.toggle("name-column-expanded")})}function we(e=null,n=null){const t=document.getElementById("selected-student-result");t.innerHTML="",t.classList.remove("absent");let s,a;if(e&&n)s=e,a=n,Dt({student:e,categoryName:n}),De(-1);else{if(Dt(null),!y||ue<0||!y.winnerHistory[ue])return;const H=y.winnerHistory[ue];s=H.winner,a=H.categoryName}const o=document.querySelector(".current-winner-highlight");if(o&&o.classList.remove("current-winner-highlight"),s){const H=document.querySelector(`.student-stats-table tr[data-student-id="${s.identity.studentId}"]`);H&&H.classList.add("current-winner-highlight")}const l=r.categories.find(H=>H.name===a);if(l){yn(l);const H=document.querySelectorAll("#category-selection-container .pill");H.forEach(ee=>ee.classList.remove("active"));const q=Array.from(H).find(ee=>ee.textContent===a);q&&q.classList.add("active"),Ts(l)}const d=y.studentRecords[s.identity.studentId],i=(d==null?void 0:d.attendance)==="absent",h=document.createElement("div");h.className="winner-name-container";const v=document.createElement("button");v.className="btn-icon",v.innerHTML="˅",v.title="برنده قبلی";const B=!e;v.classList.toggle("is-disabled",!B||ue<=0),v.addEventListener("click",()=>{v.classList.contains("is-disabled")?(v.classList.add("shake-animation"),setTimeout(()=>v.classList.remove("shake-animation"),200)):(De(ue-1),we())});const u=document.createElement("div");u.className="winner-name",u.innerHTML=`✨ <strong>${s.identity.name}</strong>✨`,u.classList.add("heartbeat-animation"),i&&(u.style.textDecoration="line-through",u.style.opacity="0.6",u.style.color="var(--color-secondary)"),(d==null?void 0:d.hadIssue)&&!i&&(u.style.color="var(--color-warning)",u.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"),(d==null?void 0:d.wasOutOfClass)&&!i&&(u.style.color="var(--color-strong-warning)",u.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود");const I=document.createElement("button");if(I.className="btn-icon",I.innerHTML="˄",I.title="برنده بعدی",I.classList.toggle("is-disabled",!B||ue>=y.winnerHistory.length-1),I.addEventListener("click",()=>{I.classList.contains("is-disabled")?(I.classList.add("shake-animation"),setTimeout(()=>I.classList.remove("shake-animation"),200)):(De(ue+1),we())}),h.appendChild(I),h.appendChild(u),s.onboardingSession===y.sessionNumber){const H=document.createElement("div");H.className="new-student-badge",H.textContent="دانش آموز جدید",h.appendChild(H)}h.appendChild(v),t.appendChild(h),ke.disabled=B&&!I.classList.contains("is-disabled");const k=document.createElement("div");k.className="status-button-container";const M=document.createElement("button");M.textContent="غایب",M.classList.add("status-button","absent-btn"),i&&M.classList.add("active");const W=document.createElement("button");W.textContent="مشکل",W.classList.add("status-button","issue-btn"),d!=null&&d.hadIssue&&W.classList.add("active");const $=document.createElement("button");$.textContent="خروج",$.classList.add("status-button","exit-btn"),d!=null&&d.wasOutOfClass&&$.classList.add("active");const A=document.createElement("button");A.textContent="پروفایل",A.className="status-button profile-btn",M.addEventListener("click",()=>{const H=M.classList.contains("active");$.classList.contains("active")&&($.classList.remove("active"),d.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),H?(M.classList.remove("active"),y.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),u.style.textDecoration="",u.style.opacity="",u.style.color=""):(W.classList.contains("active")&&(W.classList.remove("active"),d.hadIssue=!1,s.statusCounters.otherIssues=Math.max(0,s.statusCounters.otherIssues-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),M.classList.add("active"),y.setAttendance(s.identity.studentId,"absent"),s.statusCounters.missedChances++,u.style.textDecoration="line-through",u.style.opacity="0.6",u.style.color="var(--color-secondary)",u.title=""),se(),w()}),W.addEventListener("click",()=>{const H=W.classList.contains("active");if($.classList.contains("active")&&($.classList.remove("active"),d.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),H){W.classList.remove("active"),d.hadIssue=!1;const q=re.name;s.categoryIssues[q]&&(s.categoryIssues[q]=Math.max(0,s.categoryIssues[q]-1)),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),u.style.color="",u.title=""}else{M.classList.contains("active")&&(M.classList.remove("active"),y.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),W.classList.add("active"),d.hadIssue=!0;const q=re.name;s.categoryIssues[q]=(s.categoryIssues[q]||0)+1,s.statusCounters.missedChances++,u.style.textDecoration="",u.style.opacity="",u.style.color="var(--color-warning)",u.title="این دانش‌آموز در انتخاب قبلی با مشکل مواجه شده بود"}se(),w()}),$.addEventListener("click",()=>{if($.classList.contains("active"))$.classList.remove("active"),d.wasOutOfClass=!1,s.statusCounters.outOfClassCount=Math.max(0,(s.statusCounters.outOfClassCount||0)-1),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1),u.style.color="",u.title="";else{if(M.classList.contains("active")&&(M.classList.remove("active"),y.setAttendance(s.identity.studentId,"present"),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)),W.classList.contains("active")){W.classList.remove("active"),d.hadIssue=!1;const q=re.name;s.categoryIssues[q]&&(s.categoryIssues[q]=Math.max(0,s.categoryIssues[q]-1)),s.statusCounters.missedChances=Math.max(0,s.statusCounters.missedChances-1)}$.classList.add("active"),d.wasOutOfClass=!0,s.statusCounters.outOfClassCount=(s.statusCounters.outOfClassCount||0)+1,s.statusCounters.missedChances++,u.style.textDecoration="",u.style.opacity="",u.style.color="var(--color-strong-warning)",u.title="این دانش‌آموز در زمان انتخاب خارج از کلاس بود"}se(),w()}),A.addEventListener("click",()=>{J(s),oe(),L("student-profile-page")}),k.appendChild(M),k.appendChild($),k.appendChild(W),k.appendChild(A),t.appendChild(k);const D=document.createElement("div");D.className="student-details-container";const U=document.createElement("div");U.className="student-details-scores",U.innerHTML="<h4>آخرین نمرات</h4>";const ae=document.createElement("ul");ae.className="scores-list";const he=["Reading","Writing","Speaking","Listening"];let X=!1;const de=s.logs.scores||{};he.forEach(H=>{const q=document.createElement("li"),ee=document.createElement("span");ee.className="skill-name",ee.textContent=`${H}:`;const Ne=document.createElement("span");Ne.className="skill-scores";const Rt=H.toLowerCase(),Ue=de[Rt];Ue&&Ue.length>0?(X=!0,Ne.textContent=Ue.slice(-3).map(_t=>_t.value).join(",")):Ne.textContent="none",q.appendChild(ee),q.appendChild(Ne),ae.appendChild(q)}),!X&&Object.keys(de).length===0&&(ae.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>'),U.appendChild(ae),D.appendChild(U);const j=document.createElement("div");j.className="student-details-notes",j.innerHTML="<h4>یادداشت‌ها</h4>";const Oe=document.createElement("ul");Oe.className="notes-list",s.profile.notes&&s.profile.notes.length>0?[...s.profile.notes].sort((q,ee)=>new Date(ee.timestamp)-new Date(q.timestamp)).forEach(q=>{const ee=document.createElement("li");ee.dir=ot(q.content),ee.textContent=q.content,Oe.appendChild(ee)}):Oe.innerHTML='<div class="no-content-message">یادداشتی وجود ندارد.</div>',j.appendChild(Oe),D.appendChild(j),t.appendChild(D)}function xs(e){e.addEventListener("input",()=>{const n=e.value,t=ot(n);e.setAttribute("dir",t)})}function Ca(){Qe.innerHTML="",vs.innerHTML="",Ot.classList.add("tooltip-container"),Ee.disabled=!0,me.disabled=!0,Fe.disabled=!0,Ee.value="",me.value="",at.classList.add("disabled-wrapper"),ke.disabled=!0}function vt(){Qe.innerHTML="",r.categories.filter(t=>!t.isDeleted).forEach(t=>{const s=document.createElement("span");s.className="pill",s.textContent=t.name,s.dataset.categoryId=t.id,t.description&&(s.dataset.tooltip=t.description),s.addEventListener("click",()=>{document.querySelectorAll("#category-selection-container .pill").forEach(o=>o.classList.remove("active")),s.classList.add("active"),yn(t),Ts(t),at.classList.remove("disabled-wrapper"),ke.disabled=!1;const a=y.lastWinnerByCategory[t.name];if(a){const o=r.students.find(l=>l.identity.studentId===a);o&&we(o,t.name)}else{vs.innerHTML="",Dt(null),De(-1),ke.disabled=!1;const o=document.querySelector(".current-winner-highlight");o&&o.classList.remove("current-winner-highlight")}}),s.addEventListener("contextmenu",a=>{lt(a,[{label:"تغییر نام",icon:"✏️",action:()=>{an((l,d)=>{const i=Jn(r,t,l);i.success?(t.isGradedCategory=d,w(),R(r.info.name,`نام دسته‌بندی «${t.name}» به «${l}» تغییر یافت.`),vt(),se(),C(`✅ نام دسته‌بندی به «${l}» تغییر یافت.`)):C(`⚠️ ${i.message}`)},{title:"ویرایش دسته‌بندی",initialName:t.name,initialIsGraded:t.isGradedCategory,saveButtonText:"ذخیره تغییرات"})}},{label:"حذف دسته‌بندی",icon:"🗑️",className:"danger",action:()=>{G(`آیا از انتقال دسته‌بندی «${t.name}» به سطل زباله مطمئن هستید؟`,()=>{const l={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${t.name}» از کلاس «${r.info.name}»`,restoreData:{categoryId:t.id,classroomName:r.info.name}};T.unshift(l),T.length>50&&T.pop();const d=t.name.toLowerCase();r.students.forEach(i=>{i.logs.scores&&i.logs.scores[d]&&i.logs.scores[d].forEach(h=>{h.isDeleted=!0})}),t.isDeleted=!0,R(r.info.name,`دسته‌بندی «${t.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),w(),vt(),se(),C(`✅ دسته‌بندی «${t.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}}])}),Qe.appendChild(s)});const n=document.createElement("span");n.className="pill add-category-pill",n.textContent="+",n.title="افزودن دسته‌بندی جدید",n.addEventListener("click",()=>{an((t,s)=>{if(r.categories.find(l=>l.name.toLowerCase()===t.toLowerCase()&&!l.isDeleted)){C("⚠️ این دسته‌بندی از قبل وجود دارد.");return}const o=new ve(t,"",s);r.categories.push(o),w(),R(r.info.name,`دسته‌بندی جدید «${t}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),vt(),C(`✅ دسته‌بندی «${t}» اضافه شد.`)})}),Qe.appendChild(n)}function va(){if(y.lastUsedCategoryId){const e=Qe.querySelector(`.pill[data-category-id="${y.lastUsedCategoryId}"]`);e&&e.click()}y.winnerHistory&&y.winnerHistory.length>0&&(De(y.winnerHistory.length-1),we())}function Ts(e){e&&(e.isGradedCategory?(Ee.disabled=!1,me.disabled=!1,Fe.disabled=!1,Ot.removeAttribute("title")):(Ee.disabled=!0,me.disabled=!0,Fe.disabled=!0,Ot.setAttribute("title","برای این دسته‌بندی قابلیت نمره دهی تعریف نشده است")))}function Te(){if(!r||!y){L("class-management-page");return}Ca(),vt(),va(),L("student-page"),se()}function oe(){if(!O)return;const e=O;Cs.textContent=`پروفایل: ${e.identity.name}`;const n=r.sessions.reduce((u,p)=>{const b=p.studentRecords[e.identity.studentId];return u+(b&&b.attendance==="absent"?1:0)},0),t=Object.values(e.categoryIssues||{}).reduce((u,p)=>u+p,0);Je.innerHTML=`
    <p><strong>کل انتخاب:</strong> ${e.statusCounters.totalSelections}</p>
    <p><strong>غیبت:</strong> ${n}</p>
    <p><strong>فرصت از دست رفته:</strong> ${e.statusCounters.missedChances||0}</p>
    <p><strong>مشکل:</strong> ${t}</p>`;const s=F(r.categories),a=document.createElement("div");if(a.className="stats-breakdown",s.length>0){s.forEach(p=>{var M;const b=p.name,I=((M=e.categoryCounts)==null?void 0:M[b])||0,k=document.createElement("p");k.className="stats-breakdown-item",k.innerHTML=`<strong>${b}:</strong> ${I}`,a.appendChild(k)});const u=Je.querySelector("p:first-child");u&&u.after(a)}const o=document.createElement("div");o.className="stats-breakdown",s.length>0&&(s.forEach(u=>{var k;const p=u.name,b=((k=e.categoryIssues)==null?void 0:k[p])||0,I=document.createElement("p");I.className="stats-breakdown-item",I.innerHTML=`<strong>${p}:</strong> ${b}`,o.appendChild(I)}),Je.appendChild(o));const l=document.createElement("p"),d=document.createElement("strong");d.textContent="تکالیف ناقص:";const i=document.createElement("span");i.style.marginRight="5px";const h=pe(r);Ct(e,h,i,{includePrefix:!1}),l.appendChild(d),l.appendChild(i),Je.appendChild(l);const v=r.categories.filter(u=>u.isGradedCategory&&!u.isDeleted);_e.innerHTML="",v.forEach(u=>{const p=document.createElement("span");p.className="pill",p.textContent=u.name,p.dataset.skillName=u.name,u.description&&(p.dataset.tooltip=u.description),_e.appendChild(p),p.addEventListener("click",()=>{_e.querySelectorAll(".pill").forEach(b=>b.classList.remove("active")),p.classList.add("active"),sn.focus()})}),gt.innerHTML="";const B=[];for(const u in e.logs.scores)e.logs.scores[u].forEach(p=>{p.isDeleted||B.push(p)});B.sort((u,p)=>new Date(p.timestamp)-new Date(u.timestamp)),B.length===0?gt.innerHTML='<div class="no-content-message">هنوز نمره‌ای ثبت نشده است.</div>':B.forEach(u=>{const p=document.createElement("li");p.className="score-history-item";const b=document.createElement("div");b.className="item-content";const I=document.createElement("div");if(I.className="score-info",I.innerHTML=`
        <span class="score-date">${new Date(u.timestamp).toLocaleDateString("fa-IR")}</span>
        <span class="score-value">نمره: <strong>${u.value}</strong></span>
        <span class="score-skill-badge">${u.skill}</span>
    `,b.appendChild(I),u.comment){const M=`توضیحات: ${u.comment}`,W=ot(M);ot(u.comment);const $=document.createElement("p");$.className="score-comment",$.dir=W,$.innerHTML=`<strong>توضیحات:</strong> <div>${ls(u.comment)}</div>`,$.addEventListener("click",()=>{P.value=u.comment,P.dispatchEvent(new Event("input",{bubbles:!0})),ge(A=>{u.comment=A,w(),oe(),C("✅ توضیحات نمره ویرایش شد.")}),te("add-note-modal"),P.focus()}),b.appendChild($)}const k=document.createElement("button");k.className="btn-icon delete-item-btn",k.innerHTML="🗑️",k.title="حذف این نمره",k.addEventListener("click",()=>{G(`آیا از حذف نمره ${u.value} برای مهارت ${u.skill} مطمئن هستید؟`,()=>{const M={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"score",description:`نمره ${u.value} (${u.skill}) برای دانش‌آموز «${e.identity.name}»`,restoreData:{scoreId:u.id,skill:u.skill,studentId:e.identity.studentId,classroomName:r.info.name}};T.unshift(M),T.length>50&&T.pop(),u.isDeleted=!0,R(r.info.name,`نمره ${u.value} در ${u.skill} برای «${e.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),w(),oe(),C("✅ نمره به سطل زباله منتقل شد.")},{confirmText:"تایید حذف",confirmClass:"btn-warning"})}),p.appendChild(b),p.appendChild(k),gt.appendChild(p)}),sn.value="",Sn.value="",_e.querySelector(".pill.active")&&_e.querySelector(".pill.active").classList.remove("active"),it()}function it(){const e=document.getElementById("profile-notes-list");if(e.innerHTML="",!O||!O.profile.notes||O.profile.notes.length===0){e.innerHTML='<div class="no-content-message">هنوز یادداشتی ثبت نشده است.</div>';return}[...O.profile.notes].filter(t=>!t.isDeleted).sort((t,s)=>new Date(s.timestamp)-new Date(t.timestamp)).forEach(t=>{const s=document.createElement("li");s.className="note-history-item";const a=document.createElement("div");a.className="item-content";const o=document.createElement("div");o.className="note-info";const l=document.createElement("span");l.className="note-date",l.textContent=new Date(t.timestamp).toLocaleDateString("fa-IR");const d=document.createElement("button");d.className="btn-icon delete-item-btn",d.innerHTML="🗑️",d.title="حذف این یادداشت",d.addEventListener("click",()=>{G("آیا از حذف این یادداشت مطمئن هستید؟",()=>{const h={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"note",description:`یادداشت برای دانش‌آموز «${O.identity.name}»`,restoreData:{noteId:t.id,studentId:O.identity.studentId,classroomName:r.info.name}};T.unshift(h),T.length>50&&T.pop(),t.isDeleted=!0,R(r.info.name,`یادداشت دانش‌آموز «${O.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),w(),it(),C("✅ یادداشت به سطل زباله منتقل شد.")},{confirmText:"تایید حذف",confirmClass:"btn-warning"})}),o.appendChild(l),o.appendChild(d);const i=document.createElement("p");i.className="note-content",i.innerHTML=ls(t.content),i.addEventListener("click",()=>{P.value=t.content,P.dispatchEvent(new Event("input",{bubbles:!0})),ge(h=>{t.content=h,w(),R(r.info.name,`یادداشت دانش‌آموز «${O.identity.name}» به‌روزرسانی شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:O.identity.studentId}),it(),C("✅یادداشت با موفقیت ویرایش شد.")}),te("add-note-modal"),P.focus()}),a.appendChild(o),a.appendChild(i),s.appendChild(a),e.appendChild(s)})}function Ds(e){Yt.innerHTML="",e.forEach((n,t)=>{const s=document.createElement("option");s.value=t,s.textContent=n.trim(),Yt.appendChild(s)})}function rn(){Xt.innerHTML="",un.forEach(e=>{const n=document.createElement("li");n.className="preview-item";const t=document.createElement("input");t.type="checkbox",t.checked=!0,t.dataset.name=e;const s=document.createElement("label");s.textContent=e,n.appendChild(t),n.appendChild(s),Xt.appendChild(n)})}function Ea(e){const n=document.createElement("div");n.className="list-item-buttons";const t=document.createElement("button");return t.className="btn-icon",t.innerHTML="📝",t.title="افزودن/ویرایش یادداشت کلاس",t.style.borderBottom="solid",e.note||(t.style.opacity="0.5",t.style.borderBottom="none"),t.addEventListener("click",s=>{s.stopPropagation(),Bn(e)}),n.appendChild(t),n}function ba(e){const n=document.createElement("div");n.style.flexGrow="1",n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="flex-start";const t=document.createElement("span");t.textContent=e.info.name,t.classList.add("class-name-display"),n.appendChild(t);const s=F(e.students).length,a=F(e.sessions).filter(i=>i.isFinished).length,o=document.createElement("div");o.classList.add("class-stats-row");const l=document.createElement("span");l.textContent=`${s} نفر`,l.classList.add("student-count-badge"),o.appendChild(l);const d=document.createElement("span");return d.textContent=`${a} جلسه`,d.classList.add("session-count-badge"),o.appendChild(d),n.appendChild(o),n.addEventListener("click",()=>{Z(e),ne(null),nt(r.liveSession),Q(),L("session-page")}),n}function Ia(e){const n=document.createElement("li"),t=ba(e);n.appendChild(t);const s=document.createElement("div");if(s.className="list-item-badges",e.liveSession&&!e.liveSession.isCancelled&&!e.liveSession.isDeleted){const l=document.createElement("span");l.className="warning-badge",l.textContent="جلسه باز",s.appendChild(l),n.classList.add("has-unfinished-session")}const a=document.createElement("span");a.className=`type-badge ${e.info.type}`,a.textContent=e.info.type==="online"?"آنلاین":"حضوری",a.title="نوع کلاس",s.appendChild(a),n.appendChild(s);const o=Ea(e);return n.appendChild(o),n.addEventListener("contextmenu",l=>{lt(l,[{label:"تنظیمات کلاس",icon:"⚙️",action:()=>{xn(e)}},{label:"گزارش فعالیت‌ها",icon:"📋",action:()=>{Ns(e.info.name)}},{label:"تغییر نام",icon:"✏️",action:()=>{const i=e.info.name,h=document.getElementById("add-note-modal-title");h.textContent="تغییر نام کلاس",P.value=i,P.rows=1,ge(v=>{const B=v.trim();if(B&&B!==i){const u=zn(i,B);u.success?(ho(i,B),R(B,`نام کلاس از «${i}» به «${B}» تغییر یافت.`,{type:"VIEW_SESSIONS"}),w(),ce(),C(`✅نام کلاس به «${B}» تغییر یافت.`)):C(u.message)}h.textContent="ثبت یادداشت جدید",P.rows=4}),te("add-note-modal"),P.focus(),P.select()}},{label:"حذف کلاس",icon:"🗑️",className:"danger",action:()=>{G(`آیا از انتقال کلاس «${e.info.name}» به سطل زباله مطمئن هستید؟`,()=>{const i={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"classroom",description:`کلاس «${e.info.name}»`,restoreData:{name:e.info.name}};T.unshift(i),T.length>50&&T.pop(),e.isDeleted=!0,w(),ce(),C(`✅ کلاس «${e.info.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}])}),n}function ce(){jt.innerHTML="",Object.values(N).sort((n,t)=>new Date(n.info.creationDate)-new Date(t.info.creationDate)).forEach(n=>{if(n.isDeleted)return;const t=Ia(n);jt.appendChild(t)})}function be(){Kt.innerHTML="",r&&F(r.students).forEach(e=>{const n=document.createElement("li"),t=document.createElement("span");t.textContent=e.identity.name,t.style.flexGrow="1",t.className="student-name-link",t.addEventListener("click",()=>{J(e),oe(),L("student-profile-page")}),n.appendChild(t),n.addEventListener("contextmenu",s=>{lt(s,[{label:"تغییر نام",icon:"✏️",action:()=>{wn(e,r)}},{label:"انتقال دانش‌آموز",icon:"➡️",action:()=>{ks(e,r)}},{label:"حذف دانش‌آموز",icon:"🗑️",className:"danger",action:()=>{G(`آیا از انتقال دانش‌آموز «${e.identity.name}» به سطل زباله مطمئن هستید؟`,()=>{const o={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"student",description:`دانش‌آموز «${e.identity.name}» از کلاس «${r.info.name}»`,restoreData:{studentId:e.identity.studentId,classroomName:r.info.name}};T.unshift(o),T.length>50&&T.pop(),e.isDeleted=!0,R(r.info.name,`دانش‌آموز «${e.identity.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),w(),be(),C(`✅ دانش‌آموز «${e.identity.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}])}),Kt.appendChild(n)})}function qe(){if(Qt.innerHTML="",!r)return;r.categories.filter(n=>!n.isDeleted).forEach(n=>{const t=document.createElement("li"),s=document.createElement("div");s.className="name-and-badge-container";const a=document.createElement("span");if(a.textContent=n.name,s.appendChild(a),n.isGradedCategory){const l=document.createElement("span");l.className="category-badge",l.textContent="قابل نمره‌دهی",s.appendChild(l)}const o=document.createElement("button");o.className="btn-icon",o.innerHTML="🗑️",o.style.color="var(--color-warning)",o.addEventListener("click",()=>{G(`آیا از انتقال دسته‌بندی «${n.name}» به سطل زباله مطمئن هستید؟`,()=>{const l={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"category",description:`دسته‌بندی «${n.name}» از کلاس «${r.info.name}»`,restoreData:{categoryId:n.id,classroomName:r.info.name}};T.unshift(l),T.length>50&&T.pop(),n.isDeleted=!0,R(r.info.name,`دسته‌بندی «${n.name}» به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),w(),qe(),C(`✅ دسته‌بندی «${n.name}» به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning"})}),t.appendChild(s),t.appendChild(o),Qt.appendChild(t)})}function Ze(e){document.querySelectorAll(".page").forEach(t=>{t.classList.remove("active")});const n=document.getElementById(e);n&&n.classList.add("active"),e==="class-management-page"?(ce(),Zt.style.display="flex"):Zt.style.display="none",Bs()}function L(e){const n={pageId:e,currentClassName:r?r.info.name:null,selectedSessionNumber:y?y.sessionNumber:null,selectedStudentId:O?O.identity.studentId:null};let t=`#${e}`;const s=new URLSearchParams;r&&s.set("class",r.info.name),y&&s.set("session",y.sessionNumber),O&&s.set("student",O.identity.studentId);const a=s.toString();a&&(t+=`?${a}`),window.location.hash!==t&&history.pushState(n,"",t),Ze(e)}function Sa(e,n){const t=document.createElement("div");t.className="list-item-buttons";const s=document.createElement("button");if(s.className="btn-icon",s.innerHTML="📝",s.title="افزودن/ویرایش یادداشت جلسه",s.style.borderBottom="solid",e.note||(s.style.opacity="0.5",s.style.borderBottom="none"),s.addEventListener("click",a=>{a.stopPropagation(),P.value=e.note||"",ge(o=>{e.note=o,w(),R(r.info.name,`یادداشت جلسه ${n} ذخیره شد.`,{type:"VIEW_SESSIONS"}),Q(),C("✅یادداشت جلسه ذخیره شد.")}),te("add-note-modal"),P.focus()}),t.appendChild(s),!e.isFinished&&!e.isCancelled){const a=document.createElement("button");a.className="btn-icon",a.innerHTML="✅",a.title="خاتمه جلسه",a.addEventListener("click",o=>{o.stopPropagation(),G(`جلسه شماره ${n} خاتمه پیدا خواهد کرد!`,()=>{r.endSpecificSession(e.sessionNumber),w(),R(r.info.name,`جلسه ${n} خاتمه یافت.`,{type:"VIEW_SESSIONS"}),Q(),G("جلسه با موفقیت خاتمه یافت. آیا مایل به ایجاد فایل پشتیبان هستید؟",()=>{if(fe){C("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است.");return}Tn(),C("✅فایل پشتیبان با موفقیت ایجاد شد.")},{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success"})})}),t.appendChild(a)}return t}function La(e,n){const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="flex-start",t.style.flexGrow="1";const s=new Date(e.startTime).toLocaleDateString("fa-IR"),a=document.createElement("span"),o=document.createElement("div");o.style.display="flex",o.style.gap="5px",o.style.marginTop="5px";const l=new Date(e.startTime).toLocaleDateString("fa-IR",{weekday:"long"}),d=document.createElement("span");if(d.className="type-badge day-badge",d.textContent=l,o.appendChild(d),e.isCancelled){a.textContent=`✅جلسه لغو شده - تاریخ: ${s}`,t.style.cursor="default";const i=document.createElement("span");i.className="type-badge cancelled-badge",i.textContent="لغو شده",o.appendChild(i)}else a.textContent=`جلسه ${n} - تاریخ: ${s}`,t.style.cursor="pointer",t.addEventListener("click",()=>{ne(e),Te()});if(t.appendChild(a),e.isFinished){const i=document.createElement("span");i.className="type-badge",i.textContent="خاتمه یافته",i.style.backgroundColor="var(--color-secondary)",o.appendChild(i)}if(e.isMakeup){const i=document.createElement("span");i.className="type-badge",i.textContent="جبرانی",i.style.backgroundColor="var(--color-warning)",i.style.color="var(--color-text-dark)",o.appendChild(i)}return t.appendChild(o),t}function ka(e,n){const t=document.createElement("li"),s=n.get(e.sessionNumber),a=La(e,s);t.appendChild(a);const o=Sa(e,s);return t.appendChild(o),t.addEventListener("contextmenu",l=>{const d=[{label:e.isCancelled?"بازگردانی جلسه":"لغو جلسه",icon:"❌",action:()=>{const i=e.isCancelled?"بازگردانی جلسه":"لغو جلسه",h=e.isCancelled?"آیا از بازگردانی این جلسه مطمئن هستید؟":"آیا از لغو این جلسه مطمئن هستید؟ جلسه لغو شده در آمار تاثیری ندارد اما قابل بازگردانی است.";G(h,()=>{e.isCancelled=!e.isCancelled;const v=e.isCancelled?`جلسه ${s} لغو شد.`:`جلسه لغو شده (تاریخ: ${new Date(e.startTime).toLocaleDateString("fa-IR")}) بازگردانی شد.`;R(r.info.name,v,{type:"VIEW_SESSIONS"}),w(),Q(),C(e.isCancelled?"✅جلسه لغو شد.":"✅جلسه بازگردانی شد.")},{confirmText:i,confirmClass:"btn-warning"})}},{label:"تغییر وضعیت جبرانی",icon:"🔄",action:()=>{r.markAsMakeup(e.sessionNumber),w();const i=e.isMakeup?`جلسه ${s} به عنوان جبرانی علامت‌گذاری شد.`:`جلسه ${s} از حالت جبرانی خارج شد.`;R(r.info.name,i,{type:"VIEW_SESSIONS"}),Q()}},{label:"حذف جلسه",icon:"🗑️",className:"danger",action:()=>{const i=e.isCancelled?"لغو شده":s;G(`آیا از انتقال جلسه ${i} به سطل زباله مطمئن هستید؟`,()=>{const h={id:`trash_${Date.now()}_${Math.random()}`,timestamp:new Date().toISOString(),type:"session",description:`جلسه ${i} از کلاس «${r.info.name}»`,restoreData:{sessionNumber:e.sessionNumber,classroomName:r.info.name}};T.unshift(h),T.length>50&&T.pop(),e.isDeleted=!0,R(r.info.name,`جلسه ${i} به سطل زباله منتقل شد.`,{type:"VIEW_TRASH"}),w(),Q(),C(`✅ جلسه ${i} به سطل زباله منتقل شد.`)},{confirmText:"بله",confirmClass:"btn-warning",isDelete:!0})}}];lt(l,d)}),t}function Q(){const e=document.getElementById("session-list");if(!r)return;if(e.innerHTML="",r.sessions.length===0){e.innerHTML="<li>هنوز جلسه‌ای شروع نشده است.</li>";return}const n=pe(r);[...F(r.sessions)].reverse().forEach(s=>{const a=ka(s,n);e.appendChild(a)})}function je(e){if(Ie.innerHTML="",e.length>0)e.forEach(n=>{const t=document.createElement("div");t.textContent=n.identity.name,t.addEventListener("click",()=>{J(n),oe(),L("student-profile-page"),Ie.style.display="none",nn.value=""}),Ie.appendChild(t)}),Ie.style.display="block";else if(nn.value.trim()!==""){const n=document.createElement("div");n.className="no-results",n.textContent="پیدا نشد",Ie.appendChild(n),Ie.style.display="block"}else Ie.style.display="none"}function Et(e){if(Ce.innerHTML="",e.length>0)e.forEach(n=>{const t=document.createElement("div");t.className="global-search-result";const s=document.createElement("span");s.className="student-name",s.textContent=n.student.identity.name;const a=document.createElement("span");a.className="class-name",a.textContent=`کلاس: ${n.classroom.info.name}`,t.addEventListener("click",()=>{Z(n.classroom),J(n.student),oe(),L("student-profile-page"),Ce.style.display="none",ht.value=""}),a.addEventListener("click",o=>{o.stopPropagation(),Z(n.classroom),ne(null),nt(n.classroom.liveSession),Q(),L("session-page"),Ce.style.display="none",ht.value=""}),t.appendChild(s),t.appendChild(a),Ce.appendChild(t)}),Ce.style.display="block";else if(ht.value.trim()!==""){const n=document.createElement("div");n.className="no-results",n.textContent="پیدا نشد",Ce.appendChild(n),Ce.style.display="block"}else Ce.style.display="none"}function ct(){const e=document.getElementById("trashed-items-list");if(e.innerHTML="",T.length===0){e.innerHTML='<li style="text-align: center; padding: 20px;">سطل زباله خالی است.</li>';return}T.forEach((n,t)=>{const s=document.createElement("li"),a=document.createElement("span");a.textContent=n.description,a.style.flexGrow="1";const o=document.createElement("div");o.className="list-item-buttons";const l=document.createElement("button");l.className="btn-icon",l.innerHTML="🔄",l.title="بازیابی",l.addEventListener("click",()=>{var B;let i=!1,h=null;const v=n.restoreData;switch(n.type){case"classroom":{const u=N[v.name];u&&!u.isDeleted?h=`کلاسی با نام «${v.name}» از قبل فعال است.`:u&&u.isDeleted&&(u.isDeleted=!1,i=!0);break}case"student":{const u=N[v.classroomName],p=u==null?void 0:u.students.find(b=>b.identity.studentId===v.studentId);p&&(p.isDeleted=!1,i=!0);break}case"session":{const u=N[v.classroomName],p=u==null?void 0:u.sessions.find(b=>b.sessionNumber===v.sessionNumber);p&&(p.isDeleted=!1,i=!0);break}case"category":{const u=N[v.classroomName],p=u==null?void 0:u.categories.find(b=>b.id===v.categoryId);p&&(p.isDeleted=!1,i=!0);break}case"score":{const u=N[v.classroomName],p=u==null?void 0:u.students.find(I=>I.identity.studentId===v.studentId),b=(B=p==null?void 0:p.logs.scores[v.skill.toLowerCase()])==null?void 0:B.find(I=>I.id===v.scoreId);b&&(b.isDeleted=!1,i=!0);break}case"note":{const u=N[v.classroomName],p=u==null?void 0:u.students.find(I=>I.identity.studentId===v.studentId),b=p==null?void 0:p.profile.notes.find(I=>I.id===v.noteId);b&&(b.isDeleted=!1,i=!0);break}}i?(T.splice(t,1),w(),ct(),n.type==="classroom"&&ce(),C("✅ آیتم با موفقیت بازیابی شد.")):C(h?`⚠️ ${h}`:"⚠️ آیتم اصلی برای بازیابی یافت نشد.")});const d=document.createElement("button");d.className="btn-icon",d.innerHTML="🔥",d.title="حذف دائمی",d.addEventListener("click",()=>{G("آیا از حذف دائمی این آیتم مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{const i=n.restoreData;switch(n.type){case"classroom":delete N[i.name];break;case"student":tt({identity:{studentId:i.studentId}},N[i.classroomName]);break;case"session":Qn(i.classroomName,i.sessionNumber);break;case"category":Xn(i.classroomName,i.categoryId);break;case"score":Yn(i.classroomName,i.studentId,i.skill,i.scoreId);break;case"note":Zn(i.classroomName,i.studentId,i.noteId);break}T.splice(t,1),w(),ct(),C("✅ آیتم برای همیشه حذف شد.")},{confirmText:"حذف دائمی",confirmClass:"btn-warning"})}),o.appendChild(l),o.appendChild(d),s.appendChild(a),s.appendChild(o),e.appendChild(s)})}function wa(){const e=document.getElementById("absentees-summary-container");e&&(e.innerHTML=`
        <div id="absentees-summary-box" class="absentees-summary">
            <div class="absentees-summary-header">
                <h4>لیست غایبین جلسه شماره <span id="absentee-summary-session-number"></span></h4>
                <button id="copy-absentees-btn" class="btn-icon" title="کپی لیست غایبین">📋</button>
            </div>
            <div id="absentees-summary-list" class="summary-list"></div>
        </div>
    `)}function Ms(){const e=document.getElementById("absentees-summary-box"),n=document.getElementById("absentees-summary-list"),t=document.getElementById("absentee-summary-session-number");if(!e||!n||!t){console.error("Could not find all absentee summary elements.");return}if(!r||!y){e.classList.remove("visible");return}const s=F(r.students).filter(o=>{const l=y.studentRecords[o.identity.studentId];return l&&l.attendance==="absent"}),a=pe(r);t.textContent=a.get(y.sessionNumber),s.length>0?e.classList.add("visible"):e.classList.remove("visible"),n.innerHTML="",s.forEach(o=>{const d=(h=>r.sessions.reduce((v,B)=>{if(B.isDeleted||B.isCancelled)return v;const u=B.studentRecords[h.identity.studentId];return v+(u&&u.attendance==="absent"?1:0)},0))(o),i=document.createElement("span");i.className="summary-name",i.textContent=`${o.identity.name} (غیبت: ${d})`,i.addEventListener("click",()=>{i.classList.add("fading-out"),setTimeout(()=>{y.setAttendance(o.identity.studentId,"present"),w(),Se()},200)}),n.appendChild(i)})}function Na(){const e=document.getElementById("copy-absentees-btn");if(!e){console.error("Could not find the copy absentees button to attach listener.");return}e.addEventListener("click",()=>{if(!r||!y)return;const n=F(r.students).filter(a=>{const o=y.studentRecords[a.identity.studentId];return o&&o.attendance==="absent"});if(n.length===0){C("⚠️لیست غایبین خالی است.");return}const t=a=>r.sessions.reduce((o,l)=>{if(l.isDeleted||l.isCancelled)return o;const d=l.studentRecords[a.identity.studentId];return o+(d&&d.attendance==="absent"?1:0)},0);let s=`لیست غایبین جلسه شماره ${ya()}:

`;n.forEach(a=>{const o=t(a);s+=`- ${a.identity.name} (تعداد غیبت‌ها: ${o})
`}),navigator.clipboard.writeText(s).then(()=>{C("✅لیست غایبین با موفقیت کپی شد.")}).catch(a=>{console.error("Failed to copy text: ",a),C("❌خطا در کپی کردن لیست.")})})}function bt(){const e=document.getElementById("demo-mode-banner");e&&(fe?(e.classList.add("visible"),document.body.classList.add("demo-mode-active")):(e.classList.remove("visible"),document.body.classList.remove("demo-mode-active")))}const Ba=Object.freeze(Object.defineProperty({__proto__:null,_internalShowPage:Ze,addCategoryBtn:Oo,addClassBtn:Co,addNoteModal:Ko,addScoreBtn:ea,addStudentBtn:So,appHeader:Zt,attendanceListUl:Ke,attendanceMassActionsContainer:yt,attendancePage:Ao,attendanceSearchInput:Be,backToAttendanceBtn:_o,backToSessionsBtn:bo,backToSessionsFromAttendanceBtn:Ro,backToStudentPageBtn:Zo,backupDataBtn:Vo,breadcrumbContainer:Pe,cancelImportBtn:Mo,cancelNoteBtn:Xo,categoryListUl:Qt,categoryModal:la,categoryModalCancelBtn:ra,categoryModalSaveBtn:bs,categoryModalTitle:Es,classListHeader:Po,classListUl:jt,classManagementPage:us,classSaveNoteBtn:Qo,closeActiveModal:z,closeContextMenu:xe,closeNavBtn:qo,columnMappingPage:To,columnSelectDropdown:Yt,confirmColumnBtn:Do,confirmModalCancelBtn:tn,confirmModalConfirmBtn:ze,confirmModalMessage:gs,contextMenu:Me,csvCancelBtn:No,csvConfirmBtn:wo,csvFileInput:xo,csvPreviewList:Xt,csvPreviewPage:ko,customConfirmModal:zo,displayWinner:we,finishAttendanceBtn:Ho,globalStudentSearchInput:ht,globalStudentSearchResultsDiv:Ce,gradedCategoryPillsContainer:_e,hamburgerMenuBtn:Wo,handleUndo:Ss,importCsvBtn:Bo,initiateBackupProcess:Tn,isGradedCheckbox:ta,massCommentAppendCheckbox:kn,massCommentBtn:on,massCommentCancelBtn:ma,massCommentContent:Ye,massCommentModal:da,massCommentModalTitle:ua,massCommentSaveBtn:fa,massCommentStudentCountMessage:Is,newCategoryModalIsGradedCheckbox:Ln,newCategoryModalNameInput:Xe,newCategoryNameInput:$o,newClassNameInput:yo,newNoteContent:P,newScoreCommentTextarea:Sn,newScoreValueInput:sn,newStudentNameInput:Io,openContextMenu:lt,openModal:te,overlay:Uo,pasteArea:fs,processMassHomeworkComment:cn,processPasteBtn:Lo,profileScoresListUl:gt,profileStatsSummaryDiv:Je,profileStudentNameHeader:Cs,quickGradeFormWrapper:Ot,quickGradeSubmitBtn:Fe,quickNoteTextarea:me,quickScoreInput:Ee,renderAttendancePage:Se,renderBreadcrumbs:Bs,renderClassList:ce,renderColumnSelector:Ds,renderGlobalSearchResults:Et,renderImportPreview:rn,renderLogModal:Ns,renderMassCommentControls:Nn,renderSearchResults:je,renderSessions:Q,renderSettingsCategories:qe,renderSettingsStudentList:be,renderStudentNotes:it,renderStudentPage:Te,renderStudentProfilePage:oe,renderStudentStatsList:se,renderTrashPage:ct,restoreDataBtn:Go,restoreFileInput:ps,secureConfirmCancelBtn:jo,secureConfirmCode:ys,secureConfirmConfirmBtn:pt,secureConfirmInput:Re,secureConfirmMessage:hs,secureConfirmModal:Jo,selectStudentBtn:ke,selectStudentBtnWrapper:at,setAutoDirectionOnInput:xs,settingsClassNameHeader:In,settingsPage:Eo,settingsStudentListUl:Kt,showCategoryModal:an,showClassNoteModal:Bn,showCustomConfirm:G,showMassCommentModal:ws,showMoveStudentModal:ks,showNotification:C,showPage:L,showRenameStudentModal:wn,showSecureConfirm:Ls,showSettingsPage:xn,showUndoToast:pa,sideNavMenu:Fo,studentProfilePage:Yo,studentSearchInput:nn,studentSearchResultsDiv:Ie,studentStatsHeader:en,trashedCategoriesList:aa,trashedClassesList:na,trashedNotesList:ia,trashedScoresList:ca,trashedSessionsList:oa,trashedStudentsList:sa,triggerFileDownload:ln,undoBtn:vo,undoMessage:ms,undoToast:$t,updateDemoModeBanner:bt},Symbol.toStringTag,{value:"Module"}));function xa(){const e=window.location.hash;if(!e||e==="#")return!1;const[n,t]=e.split("?"),s=n.substring(1),a=new URLSearchParams(t),o=a.get("class"),l=parseInt(a.get("session"),10),d=a.get("student");if(o&&N[o])Z(N[o]),l&&r.getSession(l)&&ne(r.getSession(l)),d&&r.students.find(i=>i.identity.studentId===d)&&J(r.students.find(i=>i.identity.studentId===d));else return!1;switch(s){case"session-page":Q(),L("session-page");break;case"student-page":Te();break;case"attendance-page":Se(),L("attendance-page");break;case"settings-page":In.textContent=`تنظیمات کلاس: ${r.info.name}`,be(),qe(),L("settings-page");break;case"student-profile-page":oe(),L("student-profile-page");break;default:return!1}return!0}document.addEventListener("DOMContentLoaded",()=>{const{globalStudentSearchInput:e,newClassNameInput:n,addClassBtn:t,undoBtn:s,backToSessionsBtn:a,newStudentNameInput:o,addStudentBtn:l,pasteArea:d,processPasteBtn:i,csvPreviewList:h,csvConfirmBtn:v,csvCancelBtn:B,importCsvBtn:u,csvFileInput:p,columnSelectDropdown:b,confirmColumnBtn:I,cancelImportBtn:k,newCategoryNameInput:M,addCategoryBtn:W,selectStudentBtn:$,attendancePage:A,finishAttendanceBtn:D,backToSessionsFromAttendanceBtn:U,backToAttendanceBtn:ae,classListHeader:he,studentStatsHeader:X,hamburgerMenuBtn:de,sideNavMenu:j,closeNavBtn:Oe,overlay:H,backupDataBtn:q,restoreDataBtn:ee,restoreFileInput:Ne,confirmModalCancelBtn:Rt,confirmModalConfirmBtn:Ue,secureConfirmCancelBtn:_t,secureConfirmConfirmBtn:$s,newNoteContent:rt,classSaveNoteBtn:Os,cancelNoteBtn:As,studentSearchInput:Ve,studentSearchResultsDiv:Hs,studentProfilePage:Rs,profileStudentNameHeader:_s,backToStudentPageBtn:Ps,gradedCategoryPillsContainer:Ws,newScoreValueInput:Fs,newScoreCommentTextarea:qs,addScoreBtn:Us,isGradedCheckbox:Dn,categoryModalSaveBtn:Vs,categoryModalCancelBtn:Gs,massCommentBtn:zs,massCommentCancelBtn:Js,massCommentSaveBtn:js,massCommentContent:Ks,massCommentAppendCheckbox:Qs,attendanceSearchInput:Mn}=Ba,Xs=document.getElementById("trash-nav-btn");document.querySelector(".global-search-container .search-icon"),xt(),bt(),xa()||(ce(),L("class-management-page"));function $n(c,f){const m=document.querySelector(c);if(!m)return;const g=m.querySelector(".search-icon"),E=m.querySelector(".animated-search-input");!g||!E||(g.addEventListener("mousedown",x=>{x.preventDefault()}),g.addEventListener("click",()=>{m.classList.contains("search-active")||(m.classList.add("search-active"),E.focus())}),E.addEventListener("blur",()=>{setTimeout(()=>{m.classList.remove("search-active"),E.value="",f&&f([])},150)}))}Mn.addEventListener("input",()=>{const c=Mn.value.toLowerCase().trim(),f=Vt(c);Ke.querySelectorAll(".attendance-list-item").forEach(g=>{const E=g.querySelector(".student-name");if(E){const x=E.textContent,S=ye(x.toLowerCase()),Y=S.includes(ye(c)),V=S.includes(ye(f));Y||V?g.style.display="flex":g.style.display="none"}})}),Gs.addEventListener("click",()=>{z(),Ht(null)}),Vs.addEventListener("click",()=>{const c=Xe.value.trim(),f=Ln.checked;typeof Nt=="function"&&Nt(c,f)}),window.addEventListener("scroll",xe),document.addEventListener("click",c=>{Me.classList.contains("visible")&&!Me.contains(c.target)&&xe(),Ve.contains(c.target)||(Hs.style.display="none");const f=c.target.closest(".log-action-link");if(f&&f.dataset.action)try{const m=JSON.parse(f.dataset.action);oo(m)}catch(m){console.error("Could not parse log action:",m)}}),at.addEventListener("click",()=>{(at.classList.contains("disabled-wrapper")||ke.disabled)&&(ke.classList.add("shake-animation"),setTimeout(()=>{ke.classList.remove("shake-animation")},200))}),X.addEventListener("click",()=>{const c=new Date().getTime();c-pn>500?ft(1):ft(Lt+1),as(c),Lt===5&&(ft(0),G("آیا از صفر کردن تمام شمارنده‌های دانش‌آموزان مطمئن هستید؟ این عمل غیرقابل بازگشت است.",()=>{Kn(),se(),C("تمام آمارها صفر شدند ✅.")},{confirmText:"بله",confirmClass:"btn-warning"}))}),he.addEventListener("click",()=>{const c=new Date().getTime();c-fn>500?mt(1):mt(St+1),os(c),St===5&&(mt(0),G("آیا از ساخت یک کلاس تستی تصادفی مطمئن هستید؟",()=>{function f(){const m=`کلاس تستی ${Object.keys(N).length+1}`,g=new zt({name:m,type:"online"});["علی رضایی","مریم حسینی","زهرا احمدی","رضا محمدی","فاطمه کریمی"].forEach(x=>g.addStudent(new dt({name:x}))),N[m]=g,w(),ce()}f(),C("کلاس تستی با موفقیت ساخته شد ✅!")},{confirmText:"بساز",confirmClass:"btn-success"}))}),_t.addEventListener("click",()=>{z(),st(null)}),$s.addEventListener("click",()=>{typeof kt=="function"&&kt(),z(),st(null)}),Rt.addEventListener("click",()=>{z(hn)}),Ue.addEventListener("click",()=>{z(gn)}),ae.addEventListener("click",()=>{r&&y&&(Se(),L("attendance-page"))}),$.addEventListener("click",()=>{if(Ee.value.trim()!==""||me.value.trim()!==""){C("⚠️لطفاً ابتدا با دکمه «ثبت»، تغییرات را ذخیره کنید و یا نمره و یادداشت را پاک کنید.");return}if(!r||!y||!re)return;const c=r.selectNextWinner(re.name,y);if(c){const f=y.studentRecords[c.identity.studentId];if(f&&f.attendance==="absent"&&c.statusCounters.missedChances++,f&&f.hadIssue){c.statusCounters.missedChances++;const g=re.name;c.categoryIssues[g]=(c.categoryIssues[g]||0)+1}const m={winner:c,categoryName:re.name};y.winnerHistory.push(m),y.winnerHistory.length>10&&y.winnerHistory.shift(),De(y.winnerHistory.length-1),y.lastUsedCategoryId=re.id,y.lastSelectedWinnerId=c.identity.studentId,se(),we(),w()}else C("❌دانش‌آموز واجد شرایطی برای انتخاب یافت نشد.")}),W.addEventListener("click",()=>{if(!r)return;const c=M.value.trim(),f=Dn.checked;if(!c){alert("⚠️لطفاً نام دسته‌بندی را وارد کنید.");return}const m=r.categories.find(E=>E.name.toLowerCase()===c.toLowerCase());if(m)if(m.isDeleted){const E=r.categories.findIndex(x=>x===m);E>-1&&r.categories.splice(E,1)}else{alert("⚠️این دسته‌بندی از قبل وجود دارد.");return}const g=new ve(c,"",f);r.categories.push(g),w(),R(r.info.name,`دسته‌بندی جدید «${c}» اضافه شد.`,{type:"VIEW_CLASS_SETTINGS"}),qe(),M.value="",Dn.checked=!1}),M.addEventListener("keyup",c=>{c.key==="Enter"&&W.click()}),I.addEventListener("click",()=>{if(!It){alert("❌خطایی رخ داده است. لطفاً فایل را دوباره انتخاب کنید."),L("settings-page");return}const c=parseInt(b.value,10),g=It.split(`
`).slice(1).map(E=>{var S;return(S=E.split(",")[c])==null?void 0:S.trim()}).filter(E=>E&&E.length>0);g.length>0?(Ge(g),rn(),L("csv-preview-page")):alert("هیچ نامی در ستون انتخاب شده پیدا نشد. لطفاً ستون دیگری را امتحان کنید یا فایل خود را بررسی کنید."),ut(null)}),u.addEventListener("click",()=>{p.click()}),p.addEventListener("change",c=>{const f=c.target.files[0];if(!f)return;const m=new FileReader;m.onload=g=>{const E=g.target.result;ut(E);const S=E.split(`
`)[0].split(",");Ds(S),L("column-mapping-page")},m.readAsText(f),c.target.value=null}),k.addEventListener("click",()=>{ut(null),L("settings-page")}),v.addEventListener("click",()=>{const c=h.querySelectorAll('input[type="checkbox"]:checked');let f=!1;c.forEach(m=>{const g=m.dataset.name,E=r.students.find(S=>S.identity.name.toLowerCase()===g.toLowerCase());if(E)if(E.isDeleted)tt(E,r);else{console.log(`دانش‌آموز «${g}» به دلیل تکراری بودن اضافه نشد.`);return}const x=new dt({name:g});r.addStudent(x),r.sessions.length>0&&(F(r.sessions).filter(S=>S.isFinished&&!S.isCancelled).forEach(S=>{S.setAttendance(x.identity.studentId,"absent")}),Rn(x,r),f=!0)}),w(),R(r.info.name,`${c.length} دانش‌آموز جدید از لیست ورودی به کلاس اضافه شدند.`,{type:"VIEW_SESSIONS"}),be(),f&&_n(c.length),L("settings-page"),d.value="",Ge([])}),B.addEventListener("click",()=>{Ge([]),L("settings-page")}),i.addEventListener("click",()=>{const c=d.value.trim();if(!c){alert("کادر متنی خالی است. لطفاً اسامی را وارد کنید.");return}const f=c.split(`
`).map(m=>m.trim()).filter(m=>m.length>0);f.length>0?(Ge(f),rn(),L("csv-preview-page")):alert("هیچ نام معتبری برای ورود پیدا نشد.")}),o.addEventListener("keyup",c=>{c.key==="Enter"&&l.click()}),l.addEventListener("click",()=>{if(!r)return;const c=o.value.trim();if(!c){alert("لطفاً نام دانش‌آموز را وارد کنید.");return}const f=r.students.find(g=>g.identity.name.toLowerCase()===c.toLowerCase());if(f)if(f.isDeleted)tt(f,r);else{alert("❌دانش‌آموزی با این نام از قبل در این کلاس وجود دارد.");return}const m=new dt({name:c});r.addStudent(m),r.sessions.length>0&&(F(r.sessions).filter(g=>g.isFinished&&!g.isCancelled).forEach(g=>{g.setAttendance(m.identity.studentId,"absent")}),Rn(m,r),_n(1)),w(),R(r.info.name,`دانش‌آموز «${c}» به کلاس اضافه شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:m.identity.studentId}),be(),se(),o.value="",o.focus()}),a.addEventListener("click",()=>{Q(),L("session-page")}),document.getElementById("new-session-btn").addEventListener("click",()=>{if(r){const c=r.sessions.find(m=>!m.isFinished&&!m.isCancelled&&!m.isDeleted);if(c){C(`⚠️ جلسه ${c.sessionNumber} هنوز تمام نشده است. لطفاً ابتدا با دکمه ✅ آن را خاتمه دهید.`);return}const f=()=>{const m=g=>{const E=r.startNewSession();nt(E),ne(E),r.students.forEach(Y=>{dn.setAttendance(Y.identity.studentId,"present")}),w();const S=pe(r).get(E.sessionNumber);R(r.info.name,`جلسه ${S} شروع شد.`,{type:"VIEW_SESSIONS"}),g?(Se(),L("attendance-page")):Te()};G("آیا تمایل به انجام فرآیند حضور و غیاب دارید؟",()=>m(!0),{confirmText:"بله",cancelText:"خیر",confirmClass:"btn-success",onCancel:()=>m(!1)})};r.hasSessionToday()?G("شما امروز یک جلسه برای این کلاس ثبت کرده‌اید. آیا از شروع یک جلسه جدید دیگر مطمئن هستید؟",f,{confirmText:"بله",confirmClass:"btn-warning"}):f()}}),t.addEventListener("click",()=>{const c=n.value.trim(),f=document.querySelector('input[name="class-type"]:checked');if(!c&&!f){C("⚠️لطفاً نام و نوع کلاس را مشخص کنید.");return}if(!c){C("⚠️لطفاً نام کلاس را وارد کنید.");return}if(!f){C("⚠️لطفاً نوع کلاس را انتخاب کنید.");return}if(N[c]){N[c].isDeleted?C("⚠️ کلاسی با این نام در سطل زباله است. ابتدا آن را بازیابی کنید و یا آن را پاک کنید."):C("⚠️کلاسی با این نام از قبل وجود دارد.");return}const m=f.value,g=new zt({name:c,type:m});N[c]=g,w(),R(c,`کلاس «${c}» ایجاد شد.`,{type:"VIEW_SESSIONS"}),ce(),C(`✅ کلاس «${c}» با موفقیت ایجاد شد.`),n.value="",f.checked=!1}),e.addEventListener("input",c=>{const f=c.target.value;if(f.length<2){Et([]);return}const m=f.toLowerCase(),g=Vt(m),E=[];for(const x in N){const S=N[x];if(S.isDeleted)continue;F(S.students).filter(V=>{const ie=ye(V.identity.name.toLowerCase()),Ae=ie.includes(ye(m)),Wt=ie.includes(ye(g));return Ae||Wt}).forEach(V=>{E.push({student:V,classroom:S})})}Et(E)}),n.addEventListener("keyup",c=>{c.key==="Enter"&&t.click()}),s.addEventListener("click",Ss),document.querySelectorAll(".back-to-classes-btn").forEach(c=>{c.addEventListener("click",()=>{Z(null),ne(null),nt(null),L("class-management-page")})}),D.addEventListener("click",()=>{Te()}),U.addEventListener("click",()=>{Q(),L("session-page")}),Ps.addEventListener("click",()=>{if(J(null),!y&&r&&r.sessions.length>0){const c=F(r.sessions).filter(f=>!f.isCancelled);if(c.length>0){const f=c[c.length-1];ne(f)}else{Q(),L("session-page");return}}Te()}),Ve.addEventListener("input",c=>{const f=c.target.value;if(!f){je([]);return}const m=f.toLowerCase(),g=Vt(m),x=F(r.students).filter(S=>{const Y=ye(S.identity.name.toLowerCase()),V=Y.includes(ye(m)),ie=Y.includes(ye(g));return V||ie});je(x)}),Ve.addEventListener("focus",()=>{Ve.value&&je(Ve.value)}),Fe.addEventListener("click",()=>{const c=Ee.value,f=me.value.trim();let m;if(Bt)m=Bt.student;else{const E=y==null?void 0:y.winnerHistory[ue];m=E==null?void 0:E.winner}if(!m){C("❌خطا: دانش‌آموز معتبری برای ثبت نمره یافت نشد.");return}const g=re;if(!m||!g){C("⚠️لطفاً ابتدا یک دانش‌آموز و یک دسته‌بندی را انتخاب کنید.");return}if(!c){C("⚠️لطفاً مقدار نمره را وارد کنید.");return}if(c>100||c<0){C("❌نمره نباید از ۱۰۰ بیشتر و از صفر کمتر باشد");return}m&&(m.addScore(g.name,parseFloat(c),f),R(r.info.name,`نمره ${c} در ${g.name} برای «${m.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:m.identity.studentId}),w(),se(),C(`✅نمره برای ${m.identity.name} در مهارت ${g.name} ثبت شد.`),Ee.value="",me.value="",we(m,g.name))});const On=c=>{c.key==="Enter"&&c.ctrlKey&&(c.preventDefault(),Fe.click())};Ee.addEventListener("keydown",On),me.addEventListener("keydown",On),Us.addEventListener("click",()=>{const c=Ws.querySelector(".pill.active");if(!c){C("⚠️لطفاً یک مهارت را برای نمره‌دهی انتخاب کنید.");return}const f=c.dataset.skillName,m=Fs.value,g=qs.value.trim();if(!m){C("لطفاً مقدار نمره را وارد کنید.");return}O.addScore(f,parseFloat(m),g),w(),R(r.info.name,`نمره ${m} در ${f} برای «${O.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:O.identity.studentId}),oe(),C(`✅نمره برای مهارت ${f} با موفقیت ثبت شد.`)}),document.getElementById("add-note-btn").addEventListener("click",()=>{O&&(rt.value="",rt.dispatchEvent(new Event("input",{bubbles:!0})),ge(c=>{c&&(O.addNote(c),w(),R(r.info.name,`یادداشت جدیدی برای دانش‌آموز «${O.identity.name}» ثبت شد.`,{type:"VIEW_STUDENT_PROFILE",studentId:O.identity.studentId}),it())}),te("add-note-modal"),rt.focus())}),As.addEventListener("click",()=>{z()}),Os.addEventListener("click",()=>{const c=rt.value.trim();typeof wt=="function"&&(wt(c),Se(),z())});const Ys=document.getElementById("move-student-confirm-btn"),Zs=document.getElementById("move-student-cancel-btn"),eo=document.getElementById("move-student-class-select");Zs.addEventListener("click",()=>{z()}),Ys.addEventListener("click",()=>{const c=eo.value,f=N[c],{studentToMove:m,sourceClassForMove:g}=fo;if(!m||!g||!f){C("خطایی رخ داد. لطفاً دوباره امتحان کنید⚠️.","error"),z();return}const E=jn(m,g,f);E.success?(R(g.info.name,`دانش‌آموز «${m.identity.name}» به کلاس «${c}» منتقل شد.`,{type:"VIEW_SESSIONS"}),R(c,`دانش‌آموز «${m.identity.name}» از کلاس «${g.info.name}» به این کلاس منتقل شد.`,{type:"VIEW_SESSIONS"}),w(),be(),C(`دانش‌آموز «${m.identity.name}» با موفقیت به کلاس «${c}» منتقل شد✅.`)):C(E.message,"error"),z()}),de.addEventListener("click",()=>{j.style.width="250px",H.classList.add("modal-visible")}),Oe.addEventListener("click",le),H.addEventListener("click",le),Xs.addEventListener("click",()=>{ct(),L("trash-page"),le()}),document.getElementById("demo-mode-btn").addEventListener("click",()=>{fe?Hn():(le(),G("شما در حال ورود به حالت نمایش (Demo) هستید. در این حالت، هیچ‌کدام از تغییرات شما ذخیره نخواهد شد. آیا ادامه می‌دهید؟",()=>{es(),bt(),le()},{confirmText:"تایید",confirmClass:"btn-warning",onCancel:le}))});const An=document.getElementById("exit-demo-btn");An&&An.addEventListener("click",()=>{fe&&Hn()}),q.addEventListener("click",()=>{if(fe){C("⚠️ پشتیبان‌گیری در حالت نمایش (Demo) غیرفعال است."),le();return}le(),Tn()}),ee.addEventListener("click",()=>{if(fe){C("⚠️ بازیابی اطلاعات در حالت نمایش (Demo) غیرفعال است."),le();return}Ne.click(),le()}),Ne.addEventListener("change",c=>{const f=c.target.files[0];if(!f)return;const m=new FileReader;m.onload=g=>{try{const E=JSON.parse(g.target.result);G("آیا از بازیابی اطلاعات مطمئن هستید؟ تمام داده‌های فعلی شما بازنویسی خواهد شد.",()=>{E.classrooms?(We(E.classrooms),Jt(E.trashBin||[])):(We(E),Jt([])),w(),ce(),L("class-management-page"),C("✅اطلاعات با موفقیت بازیابی شد.")},{confirmText:"بازیابی کن",confirmClass:"btn-warning"})}catch{C("❌خطا در خواندن فایل. لطفاً فایل پشتیبان معتبر انتخاب کنید.")}},m.readAsText(f),c.target.value=null}),window.addEventListener("popstate",c=>{if(Le&&history.pushState(null,"",location.href),xe(),c.state){const{pageId:f,currentClassName:m,selectedSessionNumber:g,selectedStudentId:E}=c.state;m&&(Z(N[m]),g&&ne(r.getSession(g)),E&&J(r.students.find(x=>x.identity.studentId===E))),f==="student-page"?Te():(f==="session-page"&&Q(),Ze(f))}else Z(null),ne(null),J(null),Ze("class-management-page")}),document.addEventListener("keydown",c=>{var g;const f=document.activeElement;if(!["INPUT","TEXTAREA","SELECT"].includes(f.tagName)){if(c.key.toLowerCase()==="o"&&c.shiftKey&&us.classList.contains("active")&&(c.preventDefault(),ps.click()),c.key==="Escape"){if(Me.classList.contains("visible")){xe();return}if(Le){z();return}switch((g=document.querySelector(".page.active"))==null?void 0:g.id){case"csv-preview-page":case"column-mapping-page":L("settings-page");break;case"student-profile-page":J(null),L(y?"student-page":"session-page");break;case"attendance-page":L("student-page");break;case"student-page":ne(null),Q(),L("session-page");break;case"settings-page":case"session-page":Z(null),L("class-management-page");break}return}if(y){const E=c.key.toLowerCase();switch(" ascfg".includes(E)&&c.preventDefault(),E){case" ":$.click();break;case"a":A.classList.contains("active")?history.back():(Se(),L("attendance-page"));break;case"s":document.getElementById("session-page").classList.contains("active")?history.back():a.click();break;case"c":document.querySelector(".back-to-classes-btn").click();break;case"f":const x=document.querySelector(".action-column .search-icon");x&&x.click();break;case"g":if(Rs.classList.contains("active"))history.back();else{const S=y.lastSelectedWinnerId;if(S){const Y=r.students.find(V=>V.identity.studentId===S);Y&&(J(Y),oe(),L("student-profile-page"))}else C("⚠️ابتدا یک نفر را انتخاب کنید تا پروفایل او نمایش داده شود.")}break;case"arrowleft":{const S=document.querySelector('button[title="برنده قبلی"]');S&&!S.disabled&&(c.preventDefault(),S.click());break}case"arrowright":{const S=document.querySelector('button[title="برنده بعدی"]');S&&!S.disabled&&(c.preventDefault(),S.click());break}}}}});function le(){j.style.width="0",H.classList.add("modal-closing"),setTimeout(()=>{H.classList.remove("modal-visible","modal-closing")},300)}function Hn(){G("آیا از خروج از حالت نمایش (Demo) مطمئن هستید؟ با خروج، تمام تغییرات آزمایشی شما حذف شده و داده‌های اصلی شما بازیابی خواهند شد.",()=>{ts(),Z(null),ne(null),J(null),ce(),L("class-management-page"),bt(),le()},{confirmText:"خروج",confirmClass:"btn-success"})}$n(".global-search-container .animated-search-container",Et),$n(".action-column-header .animated-search-container",je),[P,Sn,me,fs].forEach(c=>{c&&xs(c)}),_s.addEventListener("click",()=>{wn(O,r)});function Rn(c,f){const m=F(f.students).filter(_=>_.identity.studentId!==c.identity.studentId);if(m.length===0)return;const g=m.reduce((_,K)=>K.statusCounters.totalSelections>_.statusCounters.totalSelections?K:_,m[0]);if(!g||g.statusCounters.totalSelections===0)return;c.categoryCounts=JSON.parse(JSON.stringify(g.categoryCounts)),c.statusCounters.totalSelections=g.statusCounters.totalSelections;const E=m.reduce((_,K)=>_+K.statusCounters.totalSelections,0),x=m.reduce((_,K)=>_+(K.statusCounters.missedChances||0),0),S=E>0?x/E:0;c.statusCounters.missedChances=Math.round(c.statusCounters.totalSelections*S);const Y=F(f.categories),V={};Y.forEach(_=>{const K=m.reduce((qt,Ut)=>qt+(Ut.categoryCounts[_.name]||0),0),Ft=m.reduce((qt,Ut)=>qt+(Ut.categoryIssues[_.name]||0),0);V[_.name]=K>0?Ft/K:0}),Y.forEach(_=>{const K=c.categoryCounts[_.name]||0,Ft=V[_.name]||0;c.categoryIssues[_.name]=Math.round(K*Ft)});const ie=f.liveSession;ie?c.onboardingSession=ie.sessionNumber:c.onboardingSession=f.sessions.length+1;const Ae=F(f.sessions).filter(_=>_.isFinished&&!_.isCancelled),Wt="📝 یادداشت خودکار سیستم",lo=`این دانش‌آموز  از جلسه شماره ${Ae.length} به کلاس اضافه شد. آمار مشارکت او بر اساس فعال‌ترین دانش‌آموز و آمار «فرصت از دست رفته» او بر اساس میانگین کلاس ثبت گردید:`,He=[];c.statusCounters.totalSelections>0&&He.push(`کل انتخاب‌ها: ${c.statusCounters.totalSelections}`),c.statusCounters.missedChances>0&&He.push(`فرصت‌های از دست رفته: ${c.statusCounters.missedChances}`);for(const _ in c.categoryCounts){const K=c.categoryCounts[_];K>0&&He.push(`انتخاب در «${_}»: ${K}`)}for(const _ in c.categoryIssues){const K=c.categoryIssues[_];K>0&&He.push(`مشکل در «${_}»: ${K}`)}if(He.length>0){const _=`${Wt}
${lo}

- ${He.join(`
- `)}`;c.addNote(_)}}function _n(c){const m=`چون این کلاس جلسات برگزار شده دارد، برای ${c>1?"دانش‌آموزان جدید":"دانش‌آموز جدید"} آمار پایه‌ای (متناسب با سایر دانش‌آموزان) ثبت شد تا در فرایند انتخاب اختلالی ایجاد نشود.`;G(m,()=>{},{confirmText:"متوجه شدم",confirmClass:"btn-success",onCancel:null})}const to="7.3.1";document.getElementById("app-version").textContent=`نسخه ${to}`;function no(){console.log("Starting universal backfill for writing scores...");let c=0;for(const f in N){const m=N[f];if(m.isDeleted)continue;let g=0;F(m.students).forEach(x=>{const S=x.logs.scores;if(!(S&&S.writing&&S.writing.length>0)){let V=-1;for(const ie in S)ie!=="writing"&&S[ie].forEach(Ae=>{Ae.value>V&&(V=Ae.value)});if(V>-1){const ie=`Automatically assigned based on the highest score (${V}) from other skills.`;x.addScore("Writing",V,ie),g++}}}),g>0&&(console.log(`Updated ${g} student(s) in class: ${m.info.name}.`),c+=g)}c>0?(w(),console.log(`Update complete. A total of ${c} student(s) were updated across all classes. Data saved.`),document.getElementById("student-page").classList.contains("active")&&se()):console.log("No students needed updating in any class.")}window.backfillWritingScoresForAll=no;function so(){console.log("Starting backfill for 'outOfClassCount' and 'wasOutOfClass' properties...");let c=0,f=0;const m=localStorage.getItem("teacherAssistantData_v2");if(!m){console.log("No data found in localStorage. Nothing to do.");return}const g=JSON.parse(m);for(const E in g){const x=g[E];x.students&&x.students.forEach(S=>{S.statusCounters&&typeof S.statusCounters.outOfClassCount>"u"&&(S.statusCounters.outOfClassCount=0,c++)}),x.sessions&&x.sessions.forEach(S=>{if(S.studentRecords)for(const Y in S.studentRecords){const V=S.studentRecords[Y];typeof V.wasOutOfClass>"u"&&(V.wasOutOfClass=!1,f++)}})}localStorage.setItem("teacherAssistantData_v2",JSON.stringify(g)),console.log(`Backfill complete. Updated ${c} students and ${f} session records. Data saved.`),xt(),r&&se()}window.backfillExitCounters=so;function oo(c){if(!c||!c.classroomName)return;const f=N[c.classroomName];if(!f){C("⚠️ کلاس مربوط به این گزارش یافت نشد.");return}Z(f),z(),setTimeout(()=>{switch(c.type){case"VIEW_STUDENT_PROFILE":{const m=f.students.find(g=>g.identity.studentId===c.studentId);m?(J(m),oe(),L("student-profile-page")):C("⚠️ دانش‌آموز مورد نظر یافت نشد.");break}case"VIEW_TRASH":ct(),L("trash-page");break;case"VIEW_SESSIONS":Q(),L("session-page");break;case"VIEW_CLASS_NOTE":Bn(f);break;case"VIEW_CLASS_SETTINGS":xn(f);break}},300)}zs.addEventListener("click",()=>{ws()}),Js.addEventListener("click",()=>{z()}),js.addEventListener("click",()=>{const c=Ks.value.trim(),f=Qs.checked;if(!c){kn.style.display==="flex"?G("کادر یادداشت خالی است. آیا مطمئنید که می‌خواهید یادداشت‌های قبلی دانش‌آموزان انتخاب‌شده را پاک کنید؟",()=>{z(),cn("",!1)},{confirmText:"پاک کردن",confirmClass:"btn-warning"}):C("⚠️ لطفاً متن یادداشت را وارد کنید.");return}z(()=>{cn(c,f)})});const Pt=document.getElementById("screen-saver-overlay");let Pn;const ao=2*60*1e3;function io(){Pt.classList.add("visible")}function co(){Pt.classList.contains("visible")&&Pt.classList.remove("visible")}function Wn(){co(),clearTimeout(Pn),Pn=setTimeout(io,ao)}["mousedown","mousemove","keypress","scroll","touchstart"].forEach(c=>{window.addEventListener(c,Wn)}),Wn()});
